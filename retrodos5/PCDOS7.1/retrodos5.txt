     1                                  ; ****************************************************************************
     2                                  ; RETRODOS.SYS (PCDOS 7.1 Kernel) - RETRO DOS v5.0 by ERDOGAN TAN - 12/09/2023
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 27/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 26/12/2018 (Retro DOS 4.0), 01/10/2022 (Retro DOS 4.2)
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.15
     9                                  ; ----------------------------------------------------------------------------
    10                                  ;	   ((nasm retrodos5.s -l retrodos5.txt -o PCDOS.SYS -Z error.txt)) 
    11                                  ; ----------------------------------------------------------------------------
    12                                  
    13                                  ; 12/09/2023 - Retro DOS v5.0 Kernel -dosbios- ('ibmbio7.s')
    14                                  ; Modified from 'iosys6.s' (11/09/2023, Retro DOS v4.2 Kernel's IO.SYS) file
    15                                  ; as below:
    16                                  ;
    17                                  ;    1) Retro DOS v4.2 IO.SYS is based on disassembled source code
    18                                  ;	of MSDOS 6.21 IO.SYS, derived using MSDOS 6.0 source code.
    19                                  ;
    20                                  ;    2) Labels, names, comments, explanations and structure definitions
    21                                  ;	about procedures and code details are almost entirely taken from
    22                                  ;	the original MSDOS 6.0 source code, except for the details that
    23                                  ;	Erdogan Tan personally experienced. Some of them are incompatible
    24                                  ;	with PCDOS 7.1 code. But they have not been deleted to preserve
    25                                  ;	the originality of the descriptions.)
    26                                  ;
    27                                  ;    3)'ibmbio7.s' contains the BIOSLOADER (MSLOADER) section located in
    28                                  ;	the 1st 4 sectors of the IBMBIO.COM file on disk. This is a method
    29                                  ;	from older DOS versions (3 sectors for MSDOS 6.22).
    30                                  ;	The MSDOS/PCDOS boot sector code only reads these MSLOADER/BIOSLOADER
    31                                  ;	sectors and transfers control to the MSLOADER/BIOSLOADER code.
    32                                  ;	BUT!!! The Retro DOS v3 (& v5) boot sector code loads the entire
    33                                  ;	MSDOS.SYS/PCDOS.SYS -combined- kernel file into memory at once.
    34                                  ;	So, hence the Retro DOS boot sector code, 'retrodos5.s' file
    35                                  ;       contains slightly different IO.SYS/IBMBIO.COM INITialization code
    36                                  ;	than the original PCDOS/MSDOS. It does not include 
    37                                  ;	the MSLOADER/BIOSLOADER section. The 'retrodos5.s' and 'ibmbio7.s'
    38                                  ;	files are almost identical except their INIT codes.)
    39                                  ;
    40                                  ; ('iosys6.s' has been converted to 'ibmbio7.s' and 'retrodos42.s' has been
    41                                  ; converted to 'retrodos5.s'. 'ibmbio7.s' is IBMBIO.COM source code file
    42                                  ; while 'retrodos5.s' is source code of Retro DOS v5 kernel file 'PCDOS.SYS'.
    43                                  ; 'retrodos5.s' includes 'ibmdos7.bin' or IBMDOS.COM as binary file.)
    44                                  		
    45                                  ; ----------------------------------------------------------------------------
    46                                  
    47                                  ; 20/12/2022 - Modifications for initiating IO.SYS by Retro DOS v2 boot sector
    48                                  ;
    49                                  ;	       (Retro DOS v2 BS loads IO.SYS & MSDOS.SYS as single kernel file
    50                                  ;	       with name of 'MSDOS.SYS'. Retro DOS init code -for IO.SYS init-
    51                                  ;	       is different than original MSDOS IO.SYS LOADER and INIT code.)
    52                                  ;
    53                                  ;	       ((RETRODOS.SYS/MSDOS.SYS can be loaded by a fake IO.SYS for
    54                                  ;		using it with MSDOS 5.0 boot sector & as bootable MSDOS disk.
    55                                  ;		For that, fake IO.SYS must load 'MSDOS.SYS' at 1000h:0000h.))		-	
    56                                  ; 		
    57                                  ; 18/12/2022 - Modified MSDOS 5.0 IO.SYS (for using with MSDOS 5 boot sector)
    58                                  ; 09/12/2022 - Multisection binary file format (BIOSDATA & BIOSCODE sections)
    59                                  ; 01/10/2022 - Erdogan Tan (Istanbul)
    60                                  
    61                                  ;Note: This code is a part of Retro DOS 4.0 kernel source code
    62                                  ;     (as included binary, 'IOSYS5.BIN') 
    63                                  ;     Equivalent of MSDOS 5.0 IO.SYS, BIOSCODE and BIOSDATA and SYSINIT
    64                                  ;						        (except MSLOAD code)
    65                                        
    66                                  ;------- Retro DOS v2 (v3) boot sector loads RETRODOS.SYS (MSDOS.SYS)
    67                                  ;	 at 1000h:0000h and loader (initialization) part of RETRODOS kernel
    68                                  ;	 moves IO.SYS (DOSBIOSCODE & DOSBIOSDATA, 'IOSYS5.BIN') to 70h:0000h.
    69                                  ;	 Then SYSINIT code to the next segment (46Dh for original MSDOS 5.0)..
    70                                  ;	 SYSINIT code relocates itself and DOSBIOSCODE and MSDOS.SYS
    71                                  ;	 (MSDOS5.BIN) according to request/setting in 'config.sys' file.
    72                                  
    73                                  ; ----------------------------------------------------------------------------
    74                                  
    75                                  ;=============================================================================
    76                                  ; Modified from 'retrodos3.s', Retro DOS v3.0 Kernel (IBMBIO.COM) Source code
    77                                  ; by Erdogan Tan, 10/09/2018
    78                                  ;=============================================================================
    79                                  
    80                                  ; MSBIO (IO.SYS 6.0) source files:
    81                                  ; 	MSBIO1.ASM,MSCHAR.ASM,MSDISK.ASM,MSDIOCTL.ASM,MSINT13.ASM,MSBIO2.ASM
    82                                  ;	MSINIT.ASM,SYSINIT1.ASM,SYSCONF.ASM,SYSPRE.ASM,SYSINIT2.ASM 
    83                                  ;	SYSIMES.ASM,POWER.ASM,PTIME.ASM,MSEND.ASM
    84                                  
    85                                  ;=============================================================================
    86                                  ; MSBIO
    87                                  ;=============================================================================
    88                                  ;msbio1+mschar+msdisk+msdioctl+msint13+msbio2+
    89                                  ;msinit+sysinit1+sysconf+syspre+sysinit2+sysimes+power+ptime+
    90                                  ;msend,msbio,msbio;
    91                                  
    92                                  ;=============================================================================
    93                                  ; RETRO DOS kernel versions by Erdogan Tan (2018-2022)
    94                                  ;=============================================================================
    95                                  
    96                                  ;Retro DOS v1.0 == MSDOS 1.25 -- derived from MSDOS 1.25 source code 
    97                                  ;Retro DOS v2.0 == MSDOS 2.11 -- derived from MSDOS 2.11 source code 
    98                                  ;Retro DOS v3.0 == MSDOS 3.30 -- derived from MSDOS 3.3 & 6.0 source code 
    99                                  ;Retro DOS v4.0 == MSDOS 6.21 -- derived from MSDOS 6.0 source code (2019) (*)
   100                                  ;Retro DOS v4.0 == MSDOS 5.0+ -- derived from MSDOS 6.0 source code (2022) (**)
   101                                  ;Retro DOS v4.1 == MSDOS 5.0+ -- will be optimized -shortened- version (2023)
   102                                  ;Retro DOS v4.2 == MSDOS 6.21 -- will be MSDOS 6.21 (6.22) compatible (2023)(?)
   103                                  ;Retro DOS v5.0 == PCDOS 7.10 -- will be derived from IBM PCDOS 7.1 source code
   104                                  
   105                                  ;(*) unfinished, draft, canceled (failed in 2019)
   106                                  ;(**) MSDOS 5.0 IO.SYS & SYSINIT, MSDOS 5.0-6.22 mixed MSDOS.SYS (successed)
   107                                  ;(?) MSDOS 6.21 IO.SYS & SYSINIT, MSDOS 6.21 MSDOS.SYS except doublespace
   108                                  
   109                                  ;Disassembly: (reverse engineering via IDA Pro Free)
   110                                  
   111                                  ;Retro DOS v1.0 <-- IBM PCDOS 1.1
   112                                  ;Retro DOS v2.0 <-- IBM PCDOS 2.1 & MSDOS 2.11
   113                                  ;Retro DOS v3.0 <-- IBM PCDOS 3.3 & MSDOS 3.3
   114                                  ;Retro DOS v4.0 <-- MSDOS 6.21 ; 2018-2019 (*)
   115                                  ;Retro DOS v4.0 <-- MSDOS 5.0 ; 2022 (**)
   116                                  ;Retro DOS v5.0 <-- IBM PCDOS 7.1 
   117                                  
   118                                  ;-----------------------------------------------------------------------------
   119                                  ; MSDOS 6.21 IO.SYS (13/02/1994)
   120                                  ;-----------------------------------------------------------------------------
   121                                  
   122                                  SECTOR_SIZE     equ     0200h		; size of a sector
   123                                  PAUSE_KEY       equ     7200h		; scancode + charcode of PAUSE key
   124                                  KEYBUF_NEXT     equ     041Ah		; next character in keyboard buffer
   125                                  KEYBUF_FREE     equ     041Ch		; next free slot in keyboard buffer
   126                                  KEYBUF          equ     041Eh		; keyboard buffer data
   127                                  LOGICAL_DRIVE   equ     0504h		; linear address of logical drive byte
   128                                  ;DOS_SEGMENT	equ     00BFh ; v1.1	; segment in which DOS will run
   129                                  DOS_SEGMENT	equ     00C4h		; Retro DOS v1.0 - 13/02/2018
   130                                  BIO_SEGMENT     equ     0060h		; segment in which BIO is running
   131                                  
   132                                  ; 24/02/2018 (Retro DOS 2.0 - MSDOS 3.3 "DISKPRM.INC" - 24/07/1987)
   133                                  ; The following structure defines the disk parameter table
   134                                  ; pointed to by Interrupt vector 1EH (location 0:78H)
   135                                  
   136                                  struc	DISK_PARMS
   137 00000000 ??                      .DISK_SPECIFY_1:  resb	1
   138 00000001 ??                      .DISK_SPECIFY_2:  resb	1
   139 00000002 ??                      .DISK_MOTOR_WAIT: resb  1	; Wait till motor off
   140 00000003 ??                      .DISK_SECTOR_SIZ: resb 	1	; Bytes/Sector (2 = 512)
   141 00000004 ??                      .DISK_EOT:	  resb  1	; Sectors per track (MAX)
   142 00000005 ??                      .DISK_RW_GAP:	  resb  1	; Read Write Gap
   143 00000006 ??                      .DISK_DTL:	  resb	1
   144 00000007 ??                      .DISK_FORMT_GAP:  resb  1	; Format Gap Length
   145 00000008 ??                      .DISK_FILL:	  resb  1	; Format Fill Byte
   146 00000009 ??                      .DISK_HEAD_STTL:  resb  1	; Head Settle Time (MSec)
   147 0000000A ??                      .DISK_MOTOR_STRT: resb  1	; Motor start delay
   148                                  .size:
   149                                  endstruc
   150                                  
   151                                  ; 09/03/2019 - Retro DOS v4.0
   152                                  ; -------------------------------------------------------------------------
   153                                  ; MSEQU.INC, MSDOS 6.0, 1991
   154                                  
   155                                  ftoobig 	equ	80h
   156                                  fbig		equ	40h
   157                                  ; 12/09/2023
   158                                  fbigbig		equ	20h  ; Retro DOS 5.0 ; PCDOS 7.1 ; FAT32 FS flag
   159                                  romstatus	equ	1
   160                                  romread 	equ	2
   161                                  romwrite	equ	3
   162                                  romverify	equ	4
   163                                  romformat	equ	5
   164                                  
   165                                  ; 26/12/2018 (Retro DOS 4.0 - MSDOS 6.0 "MSBDS.INC" - 1991)
   166                                  ; -------------------------------------------------------------------------
   167                                  ; 24/02/2018 (Retro DOS 2.0 - MSDOS 3.3 "MSBDS.INC" - 24/07/1987)
   168                                  ;
   169                                  ;  BDS is the Bios Data Structure.
   170                                  ;
   171                                  ;  There is one BDS for each logical drive in the system. All the BDS's
   172                                  ;  are linked together in a list with the pointer to the first BDS being
   173                                  ;  found in START_BDS. The BDS hold various values important to the disk
   174                                  ;  drive. For example there is a field for last time accesses. As actions
   175                                  ;  take place in the system the BDS are update to reflect the actions.
   176                                  ;  For example is there is a read to a disk the last access field for the
   177                                  ;  BDS for that drive is update to the current time.
   178                                  ;
   179                                  ; Values for various flags in BDS.flags.
   180                                  ;
   181                                  
   182                                  fnon_removable	    equ     01h 	;For non-removable media
   183                                  fchangeline	    equ     02h 	;If changeline supported on drive
   184                                  return_fake_bpb     equ     04h 	; When set, don't do a build BPB
   185                                  					; just return the fake one
   186                                  good_tracklayout    equ     08h 	; The track layout has no funny sectors
   187                                  fi_am_mult	    equ     10h 	;If more than one logical for this physical
   188                                  fi_own_physical     equ     20h 	;Signify logical owner of this physical
   189                                  fchanged	    equ     40h 	;Indicates media changed
   190                                  set_dasd_true	    equ     80h 	; Set DASD before next format
   191                                  fchanged_by_format  equ    100h		;Media changed by format
   192                                  ; MSDOS 6.0
   193                                  unformatted_media   equ    200h 	;Fixed disk only
   194                                  
   195                                  ;
   196                                  ; Various form factors to describe media
   197                                  ;
   198                                  
   199                                  ff48tpi 	    equ     0
   200                                  ff96tpi 	    equ     1
   201                                  ffSmall 	    equ     2
   202                                  ffHardFile	    equ     5
   203                                  ffOther 	    equ     7
   204                                  ; MSDOS 6.0 ("MSBDS.INC", 1991)
   205                                  ff288		    equ     9	; 2.88 MB drive
   206                                  ; Retro DOS v4.0 feature only !
   207                                  ;ff144		    equ	   10	; 1.44 MB drive			
   208                                  
   209                                  ; 12/09/2023
   210                                  ; Retro DOS v4 (MDOS 5.0-6.22) BDS structure
   211                                  ; -------------------------------------------------------------------------
   212                                  ; 100 bytes
   213                                   
   214                                  %if 0
   215                                  
   216                                  ; 26/05/2019
   217                                  
   218                                  struc	BDS	; BDS_Type
   219                                  .link:		resd 1		; Link to next BDS
   220                                  .drivenum:	resb 1		; Physical drive number
   221                                  .drivelet:	resb 1		; DOS drive number
   222                                  
   223                                  	;We want to embed a BPB declaration here, but we can't initialize
   224                                  	;it properly if we do, so we duplicate the byte/word/dword architecture
   225                                  	;of the BPB declaration.
   226                                  .BPB:	
   227                                  .bytespersec:	resw 1		; bytes per sectors ; def = 512
   228                                  .secperclus:	resb 1		; sectors per cluster
   229                                  .resectors:	resw 1		; reserved sectors
   230                                  .fats:		resb 1		; number of fats
   231                                  .direntries:	resw 1		; number of root directory entries
   232                                  .totalsecs16:	resw 1		; total sectors on medium
   233                                  .media:		resb 1		; media descriptor byte ; def = 0F8h
   234                                  .fatsecs: 	resw 1		; number of fat sectors
   235                                  .secpertrack:	resw 1		; sectors per track
   236                                  .heads:		resw 1		; number of heads
   237                                  ;.hiddensecs:	resw 1		; hidden sectors
   238                                  ; MSDOS 6.0
   239                                  .hiddensecs:	resd 1		; hidden sectors	
   240                                  .totalsecs32:	resd 1		; big total sectors		
   241                                  ;
   242                                  .fatsiz:	resb 1		; flags...
   243                                  .opcnt:		resw 1		; open ref. count
   244                                  ;.volid:	resb 12		; volume ID of medium
   245                                  .formfactor:	resb 1		; form factor index
   246                                  .flags:		resw 1		; various flags ; def: 0020h
   247                                  .cylinders:	resw 1		; number of cylinders
   248                                  ;
   249                                  .R_BPB:  			; recommended BPB
   250                                  .rbytespersec:	resw 1		
   251                                  .rsecperclus:	resb 1
   252                                  .rresectors: 	resw 1
   253                                  .rfats:		resb 1
   254                                  .rdirentries:	resw 1
   255                                  .rtotalsecs16:	resw 1
   256                                  .rmedia: 	resb 1
   257                                  .rfatsecs:	resw 1
   258                                  .rsecpertrack: 	resw 1
   259                                  .rheads:	resw 1
   260                                  .rhidsecs: 	resd 1
   261                                  .rtotalsecs32: 	resd 1
   262                                  .rreserved:	resb 6		; not used (reserved)
   263                                  ;
   264                                  .track:		resb 1		; last track accessed on drive
   265                                  .bdsm_ismini:
   266                                  .tim_lo:	resw 1		; time of last access. keep
   267                                  .bdsm_hidden_trks:
   268                                  .tim_hi:	resw 1		; these contiguous.
   269                                  .volid:		resb 12		; volume id of medium
   270                                  	       ;db "NO NAME    ",0
   271                                  .vol_serial:	resd 1	; current volume serial number from boot record
   272                                  .filesys_id:	resb 9	; current file system id from boot record
   273                                  	       ;db "FAT12   ",0
   274                                  .size:			
   275                                  endstruc
   276                                  
   277                                  %endif
   278                                  
   279                                  ; 12/09/2023 - Retro DOS 5.0 - PCDOS 7.1 (FAT32 compatible) BDS structure
   280                                  ; -------------------------------------------------------------------------
   281                                  ; 150 bytes
   282                                  
   283                                  %if 1
   284                                  
   285                                  struc	BDS	; BDS_Type
   286 00000000 ????????                .link:		resd 1		; Link to next BDS
   287 00000004 ??                      .drivenum:	resb 1		; Physical drive number
   288 00000005 ??                      .drivelet:	resb 1		; DOS drive number
   289                                  
   290                                  	;We want to embed a BPB declaration here, but we can't initialize
   291                                  	;it properly if we do, so we duplicate the byte/word/dword architecture
   292                                  	;of the BPB declaration.
   293                                  .BPB:	
   294 00000006 ????                    .bytespersec:	resw 1		; bytes per sectors ; def = 512
   295 00000008 ??                      .secperclus:	resb 1		; sectors per cluster
   296 00000009 ????                    .resectors:	resw 1		; reserved sectors
   297 0000000B ??                      .fats:		resb 1		; number of fats
   298 0000000C ????                    .direntries:	resw 1		; number of root directory entries
   299 0000000E ????                    .totalsecs16:	resw 1		; total sectors on medium
   300 00000010 ??                      .media:		resb 1		; media descriptor byte ; def = 0F8h
   301 00000011 ????                    .fatsecs16: 	resw 1		; number of fat sectors
   302 00000013 ????                    .secpertrack:	resw 1		; sectors per track
   303 00000015 ????                    .heads:		resw 1		; number of heads
   304 00000017 ????????                .hiddensecs:	resd 1		; hidden sectors	
   305 0000001B ????????                .totalsecs32:	resd 1		; big total sectors
   306                                  ; ----------- FAT32 extensions to BDS ----------- Retro DOS 5.0 -----------
   307 0000001F ????????                .fatsecs32:	resd 1		; BPB_FATSz32   ; FAT32 FAT size in sectors
   308 00000023 ????                    .extflags:	resw 1		; BPB_ExtFlags  ; FAT32 Extended Flags
   309 00000025 ????                    .fsver:		resw 1		; BPB_FSVer	; FAT32 volume version number
   310 00000027 ????????                .rootdirclust:	resd 1		; BPB_RootClus  ; FAT32 root dir's 1st clust num
   311 0000002B ????                    .fsinfo:	resw 1		; BPB_FSInfo	; FAT32 FSINFO sector number
   312 0000002D ????                    .bkbootsec:	resw 1		; BPB_BkBootSec ; FAT32 backup boot sector number
   313 0000002F <res Ch>                .reserved:	resb 12		; BPB_Reserved	; FAT32 reserved field = 0, 12 bytes
   314                                  ; -----------------------------------------------		
   315 0000003B ??                      .fatsiz:	resb 1		; flags...
   316 0000003C ????                    .opcnt:		resw 1		; open ref. count
   317 0000003E ??                      .formfactor:	resb 1		; form factor index
   318 0000003F ????                    .flags:		resw 1		; various flags ; def: 0020h
   319 00000041 ????                    .cylinders:	resw 1		; number of cylinders
   320                                  ;
   321                                  .R_BPB:  			; recommended BPB
   322 00000043 ????                    .rbytespersec:	resw 1		
   323 00000045 ??                      .rsecperclus:	resb 1
   324 00000046 ????                    .rresectors: 	resw 1
   325 00000048 ??                      .rfats:		resb 1
   326 00000049 ????                    .rdirentries:	resw 1
   327 0000004B ????                    .rtotalsecs16:	resw 1
   328 0000004D ??                      .rmedia: 	resb 1
   329 0000004E ????                    .rfatsecs:	resw 1
   330 00000050 ????                    .rsecpertrack: 	resw 1
   331 00000052 ????                    .rheads:	resw 1
   332 00000054 ????????                .rhidsecs: 	resd 1
   333 00000058 ????????                .rtotalsecs32: 	resd 1
   334                                  ; ----------- FAT32 extensions to BDS ----------- Retro DOS 5.0
   335 0000005C ????????                .rfatsecs32:	resd 1		; 
   336 00000060 ????                    .rextflags:	resw 1		; 
   337 00000062 ????                    .rfsver:	resw 1		; 
   338 00000064 ????????                .rrootdirclust:	resd 1		; 
   339 00000068 ????                    .rfsinfo:	resw 1		; default/initial value = -1
   340 0000006A ????                    .rbkbootsec:	resw 1		; default/initial value = -1
   341 0000006C <res Ch>                .rreserved:	resb 12		; default value = 0
   342                                  ; -----------------------------------------------
   343                                  ;
   344 00000078 ??                      .track:		resb 1		; last track accessed on drive (def=-1)
   345                                  .bdsm_ismini:
   346 00000079 ????                    .tim_lo:	resw 1		; time of last access. keep
   347                                  .bdsm_hidden_trks:
   348 0000007B ????                    .tim_hi:	resw 1		; these contiguous.
   349 0000007D <res Ch>                .volid:		resb 12		; volume id of medium
   350                                  	       ;db "NO NAME    ",0
   351 00000089 ????????                .vol_serial:	resd 1	; current volume serial number from boot record
   352 0000008D <res 9h>                .filesys_id:	resb 9	; current file system id from boot record
   353                                  	       ;db "FAT12   ",0
   354                                  .size:			
   355                                  endstruc
   356                                  
   357                                  %endif
   358                                  ; -------------------------------------------------------------------------
   359                                  
   360                                  ;The assembler will generate bad data for "size bds_volid",
   361                                  ;so we'll define an equate here.
   362                                  
   363                                  VOLID_SIZ	equ	12
   364                                  
   365                                  ;bdsm_ismini	equ	bds_tim_lo	; overlapping bds_tim_lo
   366                                  ;bdsm_hidden_trks equ	bds_tim_hi	; overlapping bds_tim_hi
   367                                  
   368                                  max_mini_dsk_num equ 23	; max # of mini disk ibmbio can support
   369                                  
   370                                  ; 29/12/2018
   371                                  ; Retro DOS v4.0
   372                                  ;
   373                                  ; MSDOS 6.0 - BOOTFORM.INC
   374                                  
   375                                  BOOT_SIZE	    EQU	 512
   376                                  EXT_BOOT_SIGNATURE  EQU	 29h ; 41 ; Extended boot signature
   377                                  
   378                                  %define BOOT_SIGNATURE	[BOOT_SIZE-2]
   379                                  
   380                                  struc EBPB ; EXT_BPB_INFO
   381 00000000 ????                    .BYTESPERSECTOR:    resw 1
   382 00000002 ??                      .SECTORSPERCLUSTER: resb 1
   383 00000003 ????                    .RESERVEDSECTORS:   resw 1
   384 00000005 ??                      .NUMBEROFFATS:	    resb 1
   385 00000006 ????                    .ROOTENTRIES:	    resw 1
   386 00000008 ????                    .TOTALSECTORS:	    resw 1
   387 0000000A ??                      .MEDIADESCRIPTOR:   resb 1
   388 0000000B ????                    .SECTORSPERFAT:	    resw 1
   389 0000000D ????                    .SECTORSPERTRACK:   resw 1
   390 0000000F ????                    .HEADS:		    resw 1
   391 00000011 ????????                .HIDDENSECTORS:	    resd 1
   392 00000015 ????????                .BIGTOTALSECTORS:   resd 1
   393                                  .size:
   394                                  endstruc
   395                                  
   396                                  ;EXT_PHYDRV, EXT_CURHD included in the header for OS2.
   397                                  struc EXT_BOOT ; EXT_IBMBOOT_HEADER
   398 00000000 ??????                  .JUMP:		resb 3
   399 00000003 ????????????????        .OEM:		resb 8
   400 0000000B <res 19h>               .BPB:		resb EBPB.size ; 25 bytes
   401 00000024 ??                      .PHYDRV:	resb 1
   402 00000025 ??                      .CURHD:		resb 1
   403 00000026 ??                      .SIG:		resb 1
   404 00000027 ????????                .SERIAL:	resd 1
   405 0000002B <res Bh>                .VOL_LABEL:	resb 11
   406 00000036 ????????????????        .SYSTEM_ID:	resb 8
   407                                  .size:
   408                                  endstruc
   409                                  
   410                                  ; 12/09/2023
   411                                  ; ----------------------------
   412                                  ; Retro DOS v5.0 (PCDOS 7.1) - FAT32 Boot Sector Parameters
   413                                  
   414                                  struc XBPB ; FAT32_BPB_INFO ; 12/09/2023
   415 00000000 ????                    .BYTESPERSECTOR:    resw 1
   416 00000002 ??                      .SECTORSPERCLUSTER: resb 1
   417 00000003 ????                    .RESERVEDSECTORS:   resw 1
   418 00000005 ??                      .NUMBEROFFATS:	    resb 1
   419 00000006 ????                    .ROOTENTRIES:	    resw 1
   420 00000008 ????                    .TOTALSECTORS:	    resw 1
   421 0000000A ??                      .MEDIADESCRIPTOR:   resb 1
   422 0000000B ????                    .SECTORSPERFAT:	    resw 1
   423 0000000D ????                    .SECTORSPERTRACK:   resw 1
   424 0000000F ????                    .HEADS:		    resw 1
   425 00000011 ????????                .HIDDENSECTORS:	    resd 1
   426 00000015 ????????                .BIGTOTALSECTORS:   resd 1
   427                                  ;............ FAT32 ......  + 28
   428 00000019 ????????                .FATSIZE32:	    resd 1
   429 0000001D ????                    .EXTFLAGS:	    resw 1
   430 0000001F ????                    .FSVER:		    resw 1
   431 00000021 ????????                .ROOTDIRCLUSTER:    resd 1
   432 00000025 ????                    .FSINFOSECTOR:	    resw 1  ; (offset from FAT32 bs)
   433 00000027 ????                    .BACKUPBOOTSECTOR:  resw 1  ; (offset from FAT32 bs)
   434 00000029 <res Ch>                .RESERVEDBYTES:	    resb 12 ; (zero bytes)	       			
   435                                  .size:
   436                                  endstruc
   437                                  
   438                                  struc FAT32_EXT_BOOT ; FAT32_IBMBOOT_HEADER ; 12/09/2023
   439 00000000 ??????                  .JUMP:		resb 3
   440 00000003 ????????????????        .OEM:		resb 8
   441 0000000B <res 35h>               .BPB:		resb XBPB.size ; 53 bytes (25+28)
   442 00000040 ??                      .PHYDRV:	resb 1
   443 00000041 ??                      .CURHD:		resb 1
   444 00000042 ??                      .SIG:		resb 1
   445 00000043 ????????                .SERIAL:	resd 1
   446 00000047 <res Bh>                .VOL_LABEL:	resb 11
   447 00000052 ????????????????        .SYSTEM_ID:	resb 8
   448                                  .size:
   449                                  endstruc
   450                                  
   451                                  ; ----------------------------
   452                                  
   453                                  ; 23/03/2018
   454                                  
   455                                  ;STATIC REQUEST HEADER (DEVSYM.INC, MSDOS 6.0, 1991)
   456                                  STRUC SRHEAD
   457 00000000 ??                      .REQLEN:	resb 1		;LENGTH IN BYTES OF REQUEST BLOCK
   458 00000001 ??                      .REQUNIT:	resb 1		;DEVICE UNIT NUMBER
   459 00000002 ??                      .REQFUNC:	resb 1		;TYPE OF REQUEST
   460 00000003 ????                    .REQSTAT:	resw 1		;STATUS WORD
   461 00000005 ????????????????        	       	resb 8		;RESERVED FOR QUEUE LINKS
   462                                  .size:
   463                                  endstruc
   464                                  
   465                                  ; GENERIC IOCTL REQUEST STRUCTURE (DEVSYM.INC, MSDOS 6.0, 1991)
   466                                  ;	SEE THE DOS 4.0 DEVICE DRIVER SPEC FOR FURTHER ELABORATION.
   467                                  ;
   468                                  struc IOCTL_REQ
   469 00000000 <res Dh>                		resb SRHEAD.size	
   470                                  			    	;GENERIC IOCTL ADDITION.
   471 0000000D ??                      .MAJORFUNCTION:	resb 1		;FUNCTION CODE
   472 0000000E ??                      .MINORFUNCTION:	resb 1		;FUNCTION CATEGORY
   473 0000000F ????                    .REG_SI:	resw 1
   474 00000011 ????                    .REG_DI:	resw 1
   475 00000013 ????????                .GENERICIOCTL_PACKET: resd 1	; POINTER TO DATA BUFFER
   476                                  endstruc
   477                                  
   478                                  ; GENERIC IOCTL CATEGORY CODES  (IOCTL.INC, MSDOS 6.0, 1991)
   479                                  IOC_OTHER	EQU	0	; Other device control J.K. 4/29/86
   480                                  IOC_SE		EQU	1	; SERIAL DEVICE CONTROL
   481                                  IOC_TC		EQU	2	; TERMINAL CONTROL
   482                                  IOC_SC		EQU	3	; SCREEN CONTROL
   483                                  IOC_KC		EQU	4	; KEYBOARD CONTROL
   484                                  IOC_PC		EQU	5	; PRINTER CONTROL
   485                                  IOC_DC		EQU	8	; DISK CONTROL (SAME AS RAWIO)
   486                                  
   487                                  ; DEFINITIONS FOR IOCTL_REQ.MINORFUNCTION
   488                                  GEN_IOCTL_WRT_TRK   EQU   40H
   489                                  GEN_IOCTL_RD_TRK    EQU   60H
   490                                  GEN_IOCTL_FN_TST    EQU   20H	; USED TO DIFF. BET READS AND WRTS
   491                                  
   492                                  ;struc A_RETRYCOUNT  ; (IOCTL.INC, MSDOS 6.0, 1991)
   493                                  ;.RC_COUNT:	resw 	1
   494                                  ;endstruc
   495                                  
   496                                  ; 29/05/2019 - Retro DOS v4.0 (DEVSYM.INC, MSDOS 6.0, 1991)
   497                                  
   498                                  ;	THE DEVICE TABLE LIST HAS THE FORM:
   499                                  
   500                                  ;struc SYSDEV
   501                                  ; .NEXT:  resd 1	;POINTER TO NEXT DEVICE HEADER
   502                                  ; .ATT:	  resw 1	;ATTRIBUTES OF THE DEVICE
   503                                  ; .STRAT: resw 1	;STRATEGY ENTRY POINT
   504                                  ; .INT:	  resw 1	;INTERRUPT ENTRY POINT
   505                                  ; .NAME:  resb 8	;NAME OF DEVICE (ONLY FIRST BYTE USED FOR BLOCK)
   506                                  ; .size:
   507                                  ;endstruc
   508                                  
   509                                  ; 27/03/2018 - DEVSYM.INC - MSDOS 3.3 - 24/07/1987
   510                                  
   511                                  ;
   512                                  ; ATTRIBUTE BIT MASKS
   513                                  ;
   514                                  ; CHARACTER DEVICES:
   515                                  ;
   516                                  ; BIT 15 -> MUST BE 1
   517                                  ;     14 -> 1 IF THE DEVICE UNDERSTANDS IOCTL CONTROL STRINGS
   518                                  ;     13 -> 1 IF THE DEVICE SUPPORTS OUTPUT-UNTIL-BUSY
   519                                  ;     12 -> UNUSED
   520                                  ;     11 -> 1 IF THE DEVICE UNDERSTANDS OPEN/CLOSE
   521                                  ;     10 -> MUST BE 0
   522                                  ;      9 -> MUST BE 0
   523                                  ;      8 -> UNUSED
   524                                  ;      7 -> UNUSED
   525                                  ;      6 -> UNUSED
   526                                  ;      5 -> UNUSED
   527                                  ;      4 -> 1 IF DEVICE IS RECIPIENT OF INT 29H
   528                                  ;      3 -> 1 IF DEVICE IS CLOCK DEVICE
   529                                  ;      2 -> 1 IF DEVICE IS NULL DEVICE
   530                                  ;      1 -> 1 IF DEVICE IS CONSOLE OUTPUT
   531                                  ;      0 -> 1 IF DEVICE IS CONSOLE INPUT
   532                                  ;
   533                                  ; BLOCK DEVICES:
   534                                  ;
   535                                  ; BIT 15 -> MUST BE 0
   536                                  ;     14 -> 1 IF THE DEVICE UNDERSTANDS IOCTL CONTROL STRINGS
   537                                  ;     13 -> 1 IF THE DEVICE DETERMINES MEDIA BY EXAMINING THE FAT ID BYTE.
   538                                  ;	    THIS REQUIRES THE FIRST SECTOR OF THE FAT TO *ALWAYS* RESIDE IN
   539                                  ;	    THE SAME PLACE.
   540                                  ;     12 -> UNUSED
   541                                  ;     11 -> 1 IF THE DEVICE UNDERSTANDS OPEN/CLOSE/REMOVABLE MEDIA
   542                                  ;     10 -> MUST BE 0
   543                                  ;      9 -> MUST BE 0
   544                                  ;      8 -> UNUSED
   545                                  ;      7 -> UNUSED
   546                                  ;      6 -> IF DEVICE HAS SUPPORT FOR GETMAP/SETMAP OF LOGICAL DRIVES.
   547                                  ;	    IF THE DEVICE UNDERSTANDS GENERIC IOCTL FUNCTION CALLS.
   548                                  ;      5 -> UNUSED
   549                                  ;      4 -> UNUSED
   550                                  ;      3 -> UNUSED
   551                                  ;      2 -> UNUSED
   552                                  ;      1 -> UNUSED
   553                                  ;      0 -> UNUSED
   554                                  ;
   555                                  
   556                                  DEVTYP	       EQU   8000H	    ; BIT 15 - 1 IF CHAR, 0 IF BLOCK
   557                                  CHARDEV        EQU   8000H
   558                                  DEVIOCTL       EQU   4000H	    ; BIT 14 - CONTROL MODE BIT
   559                                  ISFATBYDEV     EQU   2000H	    ; BIT 13 - DEVICE USES FAT ID BYTES,
   560                                  				    ;  COMP MEDIA.
   561                                  OUTTILBUSY     EQU   2000H	    ; OUTPUT UNTIL BUSY IS ENABLED
   562                                  ISNET	       EQU   1000H	    ; BIT 12 - 1 IF A NET DEVICE, 0 IF
   563                                  				    ;  NOT.  CURRENTLY BLOCK ONLY.
   564                                  DEVOPCL        EQU   0800H	    ; BIT 11 - 1 IF THIS DEVICE HAS
   565                                  				    ;  OPEN,CLOSE AND REMOVABLE MEDIA
   566                                  				    ;  ENTRY POINTS, 0 IF NOT
   567                                  
   568                                  EXTENTBIT      EQU   0400H	    ; BIT 10 - CURRENTLY 0 ON ALL DEVS
   569                                  				    ;  THIS BIT IS RESERVED FOR FUTURE USE
   570                                  				    ;  TO EXTEND THE DEVICE HEADER BEYOND
   571                                  				    ;  ITS CURRENT FORM.
   572                                  
   573                                  ; NOTE BIT 9 IS CURRENTLY USED ON IBM SYSTEMS TO INDICATE "DRIVE IS SHARED".
   574                                  ;    SEE IOCTL FUNCTION 9. THIS USE IS NOT DOCUMENTED, IT IS USED BY SOME
   575                                  ;    OF THE UTILITIES WHICH ARE SUPPOSED TO FAIL ON SHARED DRIVES ON SERVER
   576                                  ;    MACHINES (FORMAT,CHKDSK,RECOVER,..).
   577                                  
   578                                  ; 18/03/2019 - Retro DOS v4.0
   579                                  IOQUERY	       EQU   0080H	    ;Bit 7 - Supports generic IOCtl query M017
   580                                  
   581                                  DEV320	       EQU   0040H	    ;BIT 6 - FOR BLOCK DEVICES, THIS
   582                                  				    ;DEVICE SUPPORTS SET/GET MAP OF
   583                                  				    ;LOGICAL DRIVES, AND SUPPORTS
   584                                  				    ;GENERIC IOCTL CALLS.
   585                                  				    ;FOR CHARACTER DEVICES, THIS
   586                                  				    ;DEVICE SUPPORTS GENERIC IOCTL.
   587                                  				    ;THIS IS A DOS 3.2 DEVICE DRIVER.
   588                                  ISSPEC	       EQU   0010H	    ;BIT 4 - THIS DEVICE IS SPECIAL
   589                                  ISCLOCK        EQU   0008H	    ;BIT 3 - THIS DEVICE IS THE CLOCK DEVICE.
   590                                  ISNULL	       EQU   0004H	    ;BIT 2 - THIS DEVICE IS THE NULL DEVICE.
   591                                  ISCOUT	       EQU   0002H	    ;BIT 1 - THIS DEVICE IS THE CONSOLE OUTPUT.
   592                                  ISCIN	       EQU   0001H	    ;BIT 0 - THIS DEVICE IS THE CONSOLE INPUT.
   593                                  ; 23/07/2019 - Retro DOS v4.0
   594                                  EXTDRVR	       EQU   0002h ; (MSDOS 6.0, DEVSYM.INC, 1991)
   595                                  
   596                                  ; 27/05/2018 - Retro DOS v3.0 
   597                                  ; [MSDOS 3.3, MSDISK.ASM]
   598                                  
   599                                  struc INT13FRAME
   600 00000000 ????                    .oldbp:	resw 1
   601 00000002 ????                    .oldax:	resw 1
   602 00000004 ????                    .oldbx:	resw 1
   603 00000006 ????                    .oldcx:	resw 1
   604 00000008 ????                    .olddx:	resw 1
   605 0000000A ????????                .olddd:	resd 1
   606 0000000E ????                    .oldf:	resw 1
   607                                  .size:
   608                                  endstruc
   609                                  
   610                                  ; 02/06/2018 - Retro DOS v3.0
   611                                  ; [MSDOS 3.3, BIOSTRUC.INC]
   612                                  
   613                                  struc ROMBIOS_DESC		; BIOS_SYSTEM_DESCRIPTOR						  
   614 00000000 ????                    .bios_sd_leng:		resw 1				  
   615 00000002 ??                      .bios_sd_modelbyte:	resb 1					  
   616                                  .bios_sd_scnd_modelbyte: 
   617 00000003 ??                      			resb 1					  
   618 00000004 ??                      			resb 1					  
   619 00000005 ??                      .bios_sd_featurebyte1:	resb 1					  
   620 00000006 ????????                			resb 4					  
   621                                  endstruc
   622                                  
   623                                  ;-----------------------------------------------------------------------------
   624                                  ; MSDIOCTL.ASM - MSDOS 6.0 - 1991
   625                                  ;-----------------------------------------------------------------------------
   626                                  ; 11/03/2019 - Retro DOS v4.0
   627                                  
   628                                  ; 18/03/2019
   629                                  DSK_TIMEOUT_ERR 	EQU	80h	; Time out error (no media present).
   630                                  DSK_CHANGELINE_ERR	EQU	06h	; Change line error
   631                                  DSK_ILLEGAL_COMBINATION EQU	0Ch	; Return code of ah=18h function.
   632                                  MULTI_TRK_ON		EQU	10000000b ; User specified multitrack=on,
   633                                  					  ; or system turns
   634                                  ; IOCTL.INC - MSDOS 6.0 - 1991
   635                                  ; ............................................................................
   636                                  
   637                                  ;*** J.K.
   638                                  ;General Guide -
   639                                  ;Category Code:
   640                                  ; 0... .... DOS Defined
   641                                  ; 1... .... User defined
   642                                  ; .xxx xxxx Code
   643                                  
   644                                  ;Function Code:
   645                                  ; 0... .... Return error if unsupported
   646                                  ; 1... .... Ignore if unsupported
   647                                  ; .0.. .... Intercepted by DOS
   648                                  ; .1.. .... Passed to driver
   649                                  ; ..0. .... Sends data/commands to device
   650                                  ; ..1. .... Quries data/info from device
   651                                  ; ...x .... Subfunction
   652                                  ;
   653                                  ; Note that "Sends/queries" data bit is intended only to regularize the
   654                                  ; function set.  It plays no critical role; some functions may contain both
   655                                  ; command and query elements. The convention is that such commands are
   656                                  ; defined as "sends data".
   657                                  
   658                                  ;*****************************;*
   659                                  ; BLOCK DRIVERS 	      ;*
   660                                  ;*****************************;*
   661                                  
   662                                  ; IOCTL SUB-FUNCTIONS
   663                                  IOCTL_GET_DEVICE_INFO	EQU	0
   664                                  IOCTL_SET_DEVICE_INFO	EQU	1
   665                                  IOCTL_READ_HANDLE	EQU	2
   666                                  IOCTL_WRITE_HANDLE	EQU	3
   667                                  IOCTL_READ_DRIVE	EQU	4
   668                                  IOCTL_WRITE_DRIVE	EQU	5
   669                                  IOCTL_GET_INPUT_STATUS	EQU	6
   670                                  IOCTL_GET_OUTPUT_STATUS EQU	7
   671                                  IOCTL_CHANGEABLE?	EQU	8
   672                                  IOCTL_DeviceLocOrRem?	EQU	9
   673                                  IOCTL_HandleLocOrRem?	EQU	0Ah   ;10
   674                                  IOCTL_SHARING_RETRY	EQU	0Bh   ;11
   675                                  GENERIC_IOCTL_HANDLE	EQU	0Ch   ;12
   676                                  GENERIC_IOCTL		EQU	0Dh   ;13
   677                                  IOCTL_GET_DRIVE_MAP 	EQU	0Eh   ;14
   678                                  IOCTL_SET_DRIVE_MAP	EQU	0Fh   ;15
   679                                  IOCTL_QUERY_HANDLE	EQU	10h   ;16
   680                                  IOCTL_QUERY_BLOCK	EQU	11h   ;17
   681                                  
   682                                  ; GENERIC IOCTL SUB-FUNCTIONS
   683                                  RAWIO			EQU	8
   684                                  
   685                                  ; RAWIO SUB-FUNCTIONS
   686                                  GET_DEVICE_PARAMETERS	EQU	60H
   687                                  SET_DEVICE_PARAMETERS	EQU	40H
   688                                  READ_TRACK		EQU	61H
   689                                  WRITE_TRACK		EQU	41H
   690                                  VERIFY_TRACK		EQU	62H
   691                                  FORMAT_TRACK		EQU	42H
   692                                  GET_MEDIA_ID		EQU	66h	;AN000;AN003;changed from 63h
   693                                  SET_MEDIA_ID		EQU	46h	;AN000;AN003;changed from 43h
   694                                  GET_ACCESS_FLAG 	EQU	67h	;AN002;AN003;Unpublished function.Changed from 64h
   695                                  SET_ACCESS_FLAG 	EQU	47h	;AN002;AN003;Unpublished function.Changed from 44h
   696                                  SENSE_MEDIA_TYPE	EQU	68H	;Added for 5.00
   697                                  
   698                                  
   699                                  ; SPECIAL FUNCTION FOR GET DEVICE PARAMETERS
   700                                  BUILD_DEVICE_BPB	EQU	000000001B
   701                                  
   702                                  ; SPECIAL FUNCTIONS FOR SET DEVICE PARAMETERS
   703                                  INSTALL_FAKE_BPB	EQU	000000001B
   704                                  ONLY_SET_TRACKLAYOUT	EQU	000000010B
   705                                  TRACKLAYOUT_IS_GOOD	EQU	000000100B
   706                                  
   707                                  ; SPECIAL FUNCTION FOR FORMAT TRACK
   708                                  STATUS_FOR_FORMAT	EQU	000000001B
   709                                  DO_FAST_FORMAT		EQU	000000010B ;AN001;
   710                                  ; CODES RETURNED FROM FORMAT STATUS CALL
   711                                  FORMAT_NO_ROM_SUPPORT	EQU	000000001B
   712                                  FORMAT_COMB_NOT_SUPPORTED EQU	000000010B
   713                                  
   714                                  ; DEVICETYPE VALUES
   715                                  MAX_SECTORS_IN_TRACK	EQU	63	; MAXIMUM SECTORS ON A DISK.(Was 40 in DOS 3.2)
   716                                  DEV_5INCH		EQU	0
   717                                  DEV_5INCH96TPI		EQU	1
   718                                  DEV_3INCH720KB		EQU	2
   719                                  DEV_8INCHSS		EQU	3
   720                                  DEV_8INCHDS		EQU	4
   721                                  DEV_HARDDISK		EQU	5
   722                                  DEV_OTHER		EQU	7
   723                                  ;DEV_3INCH1440KB	EQU	7
   724                                  DEV_3INCH2880KB		EQU	9
   725                                  ; Retro DOS v2.0 - 26/03/2018
   726                                  ;;DEV_TAPE		EQU	6
   727                                  ;;DEV_ERIMO		EQU	8
   728                                  ;DEV_3INCH2880KB	EQU	9
   729                                  DEV_3INCH1440KB		EQU	10
   730                                  
   731                                  ;MAX_DEV_TYPE		EQU	9	; MAXIMUM DEVICE TYPE THAT WE
   732                                  					; CURRENTLY SUPPORT.
   733                                  MAX_DEV_TYPE		EQU	10
   734                                  
   735                                  struc A_SECTORTABLE
   736 00000000 ????                    .ST_SECTORNUMBER:	resw	1
   737 00000002 ????                    .ST_SECTORSIZE:		resw	1
   738                                  .size:
   739                                  endstruc
   740                                  
   741                                  ; MSDOS 6.0 - BPB.INC - 1991
   742                                  ; ####
   743                                  ;**	BIOS PARAMETER BLOCK DEFINITION
   744                                  ;
   745                                  ;	The BPB contains information about the disk structure. It dates
   746                                  ;	back to the earliest FAT systems and so FAT information is
   747                                  ;	intermingled with physical driver information.
   748                                  ;
   749                                  ;	A boot sector contains a BPB for its device; for other disks
   750                                  ;	the driver creates a BPB. DOS keeps copies of some of this
   751                                  ;	information in the DPB.
   752                                  ;
   753                                  ;	The BDS structure contains a BPB within it.
   754                                  ;
   755                                  
   756                                  struc A_BPB
   757 00000000 ????                    .BPB_BYTESPERSECTOR:	resw	1
   758 00000002 ??                      .BPB_SECTORSPERCLUSTER:	resb	1
   759 00000003 ????                    .BPB_RESERVEDSECTORS:	resw	1
   760 00000005 ??                      .BPB_NUMBEROFFATS:	resb	1
   761 00000006 ????                    .BPB_ROOTENTRIES: 	resw	1
   762 00000008 ????                    .BPB_TOTALSECTORS:	resw	1
   763 0000000A ??                      .BPB_MEDIADESCRIPTOR:	resb	1
   764 0000000B ????                    .BPB_SECTORSPERFAT:	resw	1
   765 0000000D ????                    .BPB_SECTORSPERTRACK:	resw	1
   766 0000000F ????                    .BPB_HEADS:		resw	1
   767 00000011 ????                    .BPB_HIDDENSECTORS:	resw	1
   768 00000013 ????                    			resw	1
   769 00000015 ????                    .BPB_BIGTOTALSECTORS:	resw	1
   770 00000017 ????                    			resw	1
   771 00000019 ????????????            			resb	6	; NOTE:  many times these
   772                                  ;					; 	 6 bytes are omitted
   773                                  ;					;	 when BPB manipulations
   774                                  ;					;	 are performed!
   775                                  .size:
   776                                  endstruc
   777                                  ; ####
   778                                  
   779                                  struc A_DEVICEPARAMETERS
   780 00000000 ??                      .DP_SPECIALFUNCTIONS:	resb	1
   781 00000001 ??                      .DP_DEVICETYPE:		resb	1
   782 00000002 ????                    .DP_DEVICEATTRIBUTES:	resw	1
   783 00000004 ????                    .DP_CYLINDERS:		resw	1
   784 00000006 ??                      .DP_MEDIATYPE:		resb	1
   785 00000007 <res 1Fh>               .DP_BPB:		resb	A_BPB.size
   786 00000026 ????                    .DP_TRACKTABLEENTRIES:	resw	1
   787 00000028 <res FCh>               .DP_SECTORTABLE:	resb	MAX_SECTORS_IN_TRACK * A_SECTORTABLE.size
   788                                  endstruc
   789                                  
   790                                  struc A_TRACKREADWRITEPACKET
   791 00000000 ??                      .TRWP_SPECIALFUNCTIONS:	resb	1
   792 00000001 ????                    .TRWP_HEAD:		resw	1
   793 00000003 ????                    .TRWP_CYLINDER:		resw	1
   794 00000005 ????                    .TRWP_FIRSTSECTOR:	resw	1
   795 00000007 ????                    .TRWP_SECTORSTOREADWRITE: resw	1
   796 00000009 ????????                .TRWP_TRANSFERADDRESS:	resd	1
   797                                  endstruc
   798                                  
   799                                  ;AN001; - FP_TRACKCOUNT is only meaningful when FP_SPECIALFUNCTIONS bit 1 = 1.
   800                                  struc A_FORMATPACKET
   801 00000000 ??                      .FP_SPECIALFUNCTIONS:	resb	1  ; db ?
   802 00000001 ????                    .FP_HEAD: 		resw	1  ; dw ? 
   803 00000003 ????                    .FP_CYLINDER:		resw	1  ; dw ?
   804 00000005 ????                    .FP_TRACKCOUNT:		resw	1  ; dw 1 ; !
   805                                  endstruc
   806                                  
   807                                  struc A_VERIFYPACKET
   808 00000000 ??                      .VP_SPECIALFUNCTIONS:	resb	1
   809 00000001 ????                    .VP_HEAD: 		resw	1
   810 00000003 ????                    .VP_CYLINDER:		resw	1
   811                                  endstruc
   812                                  
   813                                  struc A_MEDIA_ID_INFO
   814 00000000 ????                    .MI_LEVEL:		resw	1  ; dw 0 ; !		;J.K. 87 Info. level
   815 00000002 ????????                .MI_SERIAL:		resd	1  ; dd ?		;J.K. 87 Serial #
   816 00000006 <res Bh>                .MI_LABEL:		resb	11 ; db 11 DUP (' ') ;!	;J.K. 87 volume label
   817 00000011 ????????????????        .MI_SYSTEM:		resb 	8  ; db 8 DUP (' ')  ;!	;J.K. 87 File system type
   818                                  endstruc
   819                                  
   820                                  struc A_DISKACCESS_CONTROL	   ;AN002; Unpublished function. Only for Hard file.
   821 00000000 ??                      .DAC_SPECIALFUNCTIONS:	resb 	1  ; db 0 ; ! ;AN002; Always 0
   822 00000001 ??                      .DAC_ACCESS_FLAG: 	resb 	1  ; db 0 ; ! 
   823                                  				   ; Non Zero - allow disk I/O to unformatted hard file
   824                                  endstruc			   ; 0 - Disallow disk I/O to unformatted hard file
   825                                  
   826                                  
   827                                  struc A_MEDIA_SENSE			; Media sense structure added 5.00
   828 00000000 ??                      .MS_ISDEFAULT:		resb	1	; If 1 type returned is drv default
   829 00000001 ??                      .MS_DEVICETYPE:		resb	1	; Drive type 
   830 00000002 ??                      .MS_RESERVED1:		resb	1	; RESERVED
   831 00000003 ??                      .MS_RESERVED2:		resb 	1	; RESERVED 
   832                                  endstruc
   833                                  
   834                                  ;********************************;*
   835                                  ; CHARACTER DEVICES (PRINTERS)	 ;*
   836                                  ;********************************;*
   837                                  
   838                                  ;RAWIO SUB-FUNCTIONS
   839                                  GET_RETRY_COUNT 	EQU	65H
   840                                  SET_RETRY_COUNT 	EQU	45H
   841                                  
   842                                  struc A_RETRYCOUNT
   843 00000000 ????                    .RC_COUNT:		resw 1
   844                                  endstruc
   845                                  
   846                                  ;********************************;*		;J.K. 4/29/86
   847                                  ; CHARACTER DEVICES (SCREEN)	 ;*
   848                                  ;********************************;*		;J.K. 4/29/86
   849                                  ;
   850                                  ;SC_MODE_INFO	 struc
   851                                  ;SC_INFO_LENGTH 	 DW	 9
   852                                  ;SC_MODE		 DB	 0
   853                                  ;SC_COLORS		 DW	 0
   854                                  ;SC_WIDTH		 DW	 0
   855                                  ;SC_LENGTH		 DW	 0
   856                                  ;SC_MODE_INFO	 ends
   857                                  ;
   858                                  ;SC_INFO_PACKET_LENGTH	 EQU	 9		 ;LENGTH OF THE INFO PACKET.
   859                                  
   860                                  ;SUBFUNCTIONS FOR CON$GENIOCTL
   861                                  ;GET_SC_MODE		 EQU	 60h
   862                                  ;SET_SC_MODE		 EQU	 40h
   863                                  ;The following subfunctions are reserved for installable CODE PAGE switch
   864                                  ;console devices. - J.K. 4/29/86
   865                                  ;Get_active_codepage	 equ	 6Ah
   866                                  ;Invoke_active_codepage  equ	 4Ah
   867                                  ;Start_designate_codepage equ	 4Ch
   868                                  ;End_designate_codepage  equ	 4Dh
   869                                  ;Get_list_of_designated_codepage equ 6Bh
   870                                  ;J.K. 4/29/86 *** End of Con$genioctl equates & structures
   871                                  
   872                                  ;-----------------------------------------------------------------------------
   873                                  ; MULT.INC - MSDOS 6.0 - 1991
   874                                  ;-----------------------------------------------------------------------------
   875                                  ; 18/03/2019
   876                                  
   877                                  ; The current set of defined multiplex channels is (* means documented):
   878                                  ;
   879                                  ;   Channel(h)  Issuer          Receiver    Function
   880                                  ;      00       server          PSPRINT     print job control
   881                                  ;     *01       print/apps      PRINT       Queueing of files
   882                                  ;      02       BIOS            REDIR       signal open/close of printers
   883                                  ;
   884                                  ;      05       command         REDIR       obtain text of net int 24 message
   885                                  ;     *06       server/assign   ASSIGN      Install check
   886                                  ;
   887                                  ;      08       external driver IBMBIO      interface to internal routines
   888                                  ;
   889                                  ;      10       sharer/server   Sharer      install check
   890                                  ;      11       DOS/server      Redir       install check/redirection funcs
   891                                  ;      12       sharer/redir    DOS         dos functions and structure maint
   892                                  ;      13       MSNET           MSNET       movement of NCBs
   893                                  ;      13       external driver IBMBIO      Reset_Int_13, allows installation
   894                                  ;                                           of alternative INT_13 drivers after
   895                                  ;                                           boot_up
   896                                  ;      14 (IBM) DOS             NLSFUNC     down load NLS country info,DOS 3.3
   897                                  ;      14 (MS)  APPS            POPUP       MSDOS 4 popup screen functions
   898                                  ;      15       APPS            MSCDEX      CD-ROM extensions interface
   899                                  ;      16       WIN386          WIN386      Windows communications
   900                                  ;      17       Clipboard       WINDOWS     Clipboard interface
   901                                  ;     *18       Applications    MS-Manger   Toggle interface to manager
   902                                  ;      19       Shell
   903                                  ;      1A       Ansi.sys
   904                                  ;      1B       Fastopen,Vdisk   IBMBIO     EMS INT 67H stub handler
   905                                  ;
   906                                  ;      40h      OS/2
   907                                  ;      41h      Lanman
   908                                  ;      42h      Lanman
   909                                  ;      43h      Himem
   910                                  ;                               AL = 20h    reserved for Mach 20 Himem support
   911                                  ;                               AL = 30h    reserved for Himem external A20 code
   912                                  ;      44h      Dosextender
   913                                  ;      45H      Windows profiler
   914                                  ;      46h      Windows/286 DOS extender
   915                                  ;      47h      Basic Compiler Vn. 7.0
   916                                  ;      48h      Doskey
   917                                  ;      49h      DOS 5.x install 
   918                                  ;      4Ah      Multi Purpose
   919                                  ;                multMULTSWPDSK         0 - Swap Disk in drive A (BIOS)
   920                                  ;                multMULTGETHMAPTR      1 - Get available HMA & ptr
   921                                  ;                multMULTALLOCHMA       2 - Allocate HMA (bx == no of bytes)
   922                                  ;                multMULTTASKSHELL      5 - Shell/switcher API
   923                                  ;                multMULTRPLTOM         6 - Top Of Memory for RPL support
   924                                  ;
   925                                  ;                multSmartdrv           10h
   926                                  ;                multMagicdrv           11h
   927                                  ;      4Bh      Task Switcher API
   928                                  ;
   929                                  ;      4Ch      APPS            APM             Advanced power management
   930                                  ;      4Dh      Kana Kanji Converter, MSKK
   931                                  ;
   932                                  ;      51h      ODI real mode support driver (for Chicago)
   933                                  ;
   934                                  ;      53h      POWER.EXE - used for broadcasting APM events    ; M036
   935                                  ;      54h      POWER.EXE - used for POWER API                  ; M036
   936                                  ;
   937                                  ;      55h      COMMAND.COM
   938                                  ;                multCOMFIRST           0 - API to determine whether 1st
   939                                  ;                                           instance of command.com
   940                                  ;                multCOMFIRSTROM        1 - API to determine whether 1st
   941                                  ;                                           instance of ROM COMMAND
   942                                  ;      56h      Sewell Development
   943                                  ;               INTERLNK
   944                                  ;
   945                                  ;      57h      Iomega Corp.
   946                                  ;
   947                                  ;      AB       Unspecified IBM use
   948                                  ;      AC       Graphics
   949                                  ;      AD       NLS (toronto)
   950                                  ;      AE
   951                                  ;      AF       Mode
   952                                  ;      B0       GRAFTABL        GRAFTABL
   953                                  ;
   954                                  ;      D7       Banyan VINES
   955                                  
   956                                  multMULT	  equ	4Ah
   957                                  
   958                                  multMULTSWPDSK	  equ	0	; Swap Disk in drive A (BIOS)
   959                                  multMULTGETHMAPTR equ	1	; Get available HMA & ptr
   960                                  multMULTALLOCHMA  equ	2	; Allocate HMA (bx == no of bytes)
   961                                  multMULTTASKSHELL equ	5	; Shell/switcher API
   962                                  multMULTRPLTOM	  equ	6	; Top Of Memory for RPL support
   963                                  
   964                                  ;-----------------------------------------------------------------------------
   965                                  ; WIN386.INC - MSDOS 6.0 - 1991
   966                                  ;-----------------------------------------------------------------------------
   967                                  ; 18/03/2019
   968                                  
   969                                  ; WIN386.INC
   970                                  ;
   971                                  ;  Symbols and structures relating to WIN386 support.
   972                                  ;
   973                                  ;  Used by files in both the DOS and the BIOS.
   974                                  ;
   975                                  ;  Created: 7-13-89 by MRW
   976                                  ;
   977                                  
   978                                  ; WIN386 broadcast int 2fh multiplex number and subfunction numbers
   979                                  
   980                                  MultWin386		equ     16h	; Int 2f multiplex number
   981                                  
   982                                  Win386_Init		equ	05h	; Win386 initialization
   983                                  Win386_Exit		equ	06h	; Win386 exit
   984                                  Win386_Devcall		equ	07h	; Win386 device call out
   985                                  Win386_InitDone		equ	08h	; Win386 initialization is complete
   986                                  
   987                                  ; ============================================================================
   988                                  
   989                                  ;-----------------------------------------------------------------------------
   990                                  ;
   991                                  ; +-------------------------------------------------------------------------+
   992                                  ; |   This file	has been generated by The Interactive Disassembler (IDA)    |
   993                                  ; |	      Copyright	(c) 2013 Hex-Rays, <support@hex-rays.com>	    |
   994                                  ; |			 Licensed to: Freeware version			    |
   995                                  ; +-------------------------------------------------------------------------+
   996                                  ;
   997                                  ;-----------------------------------------------------------------------------
   998                                  
   999                                  ;		.386
  1000                                  ;		.model flat
  1001                                  
  1002                                  ; ============================================================================
  1003                                  
  1004                                  ; 02/10/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
  1005                                  ; 10/12/2022
  1006                                  ; 09/12/2022
  1007                                  ; 21/10/2022
  1008                                  ; 19/10/2022
  1009                                  ; 17/10/2022, 18/10/2022
  1010                                  ; 15/10/2022, 16/10/2022
  1011                                  ; 03/10/2022
  1012                                  ; 02/10/2022
  1013                                  ; 01/10/2022 - Erdogan Tan
  1014                                  
  1015                                  ; [[ Most of comments here are from the original MSDOS 6.0 source code ]]
  1016                                  
  1017                                  ;-----------------------------------------------------------------------------
  1018                                  ; Start of PC-DOS 7.1 IBMBIO.COM  (IO.SYS)
  1019                                  ;-----------------------------------------------------------------------------
  1020                                  
  1021                                  		; [ORG 0]		; segment 0x0070h
  1022                                  
  1023                                  ;=============================================================================
  1024                                  ; DOS BIOS (IO.SYS) DATA SEGMENT 
  1025                                  ;=============================================================================
  1026                                  ; 09/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
  1027                                  ; 30/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
  1028                                  ; 02/10/2023 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
  1029                                  
  1030                                  section .BIOSDATA vstart=0
  1031                                  
  1032                                  ;--- DOSBIOS data segment ----------------------------------------------------
  1033                                  ;-----------------------------------------------------------------------------
  1034                                  
  1035                                  ;Bios_Data segment
  1036                                  
  1037                                  BData_start:				
  1038 00000000 E9691B                  hdrv_pat:	jmp	init		; MSBIO1.ASM, MSSBDATA.INC
  1039                                  ; ----------------------------------------------------------------------------
  1040                                  
  1041 00000003 0000                    DosDataSg:	dw 0
  1042                                  
  1043                                  ; DOS's int 2f handler will exit via a jump through here.
  1044                                  ; This is how the BIOS hooks int2f
  1045                                  
  1046                                  ;BIOSDATA:0005h: ; 10/05/2023 (Note the 'bios_i2f equ 5' in 'msdos6.s')
  1047                                  			
  1048 00000005 EA                      bios_i2f:	db 0EAh			; far jump to int_2f (segment may not be at 70h)
  1049                                  		; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  1050                                  		; PCDOS 7.1 IBMBIO.COM - BIODATA:0006h
  1051                                  		;dw int_2f
  1052                                  		;dw 70h			; BIOSDATA segment (KERNEL_SEGMENT)
  1053 00000006 [3116]                  		dw i2f_handler	
  1054                                  bios_i2f_seg:	; 10/08/2023
  1055 00000008 FF02                    		dw DOSBIOCODESEG	; 02CCh for MSDOS 6.21 IO.SYS (25Ch+070h)
  1056                                  					; 0364h PCDOS 7.1 IBMBIO.COM  (2F4h+070h)
  1057                                  
  1058 0000000A 0000                    romstartaddr:	dw 0			; The start address for the romfind routines
  1059                                  					; This is to maintain binary compatibility
  1060                                  					; with DISK based DOS 5.0
  1061                                  
  1062                                  ; This is a byte used for special key handling in the resident
  1063                                  ; console device driver. It must be here so that it can be included
  1064                                  ; in the WIN386 instance table (in INC\LMSTUB.ASM).
  1065                                  
  1066 0000000C 00                      altah:		db 0			; special key handling
  1067                                  			
  1068 0000000D 00                      inHMA:		db 0			; flag indicates we're running from HMA
  1069 0000000E 00000000                xms:		dd 0			; entry point to xms if above is true
  1070                                  
  1071                                  ; PTRSAV - pointer save
  1072                                  ;
  1073                                  ; This variable holds the pointer to the Request Header passed by a program
  1074                                  ; wishing to use a device driver. When the strategy routine is called it 
  1075                                  ; puts the address of the Request header in this variable and returns.
  1076                                  		
  1077 00000012 00000000                ptrsav:		dd 0			
  1078                                  auxbuf:		;db 4 dup(0)		; set of 1 byte buffers for com 1,2,3, and 4
  1079 00000016 00000000                		db 0, 0, 0, 0 ; 19/10/2022
  1080 0000001A 0000                    zeroseg:	dw 0			; easy way to load segment registers with zero			
  1081 0000001C 0000                    i13_ds:		dw 0			; ds register for int13 call through	
  1082 0000001E 0000                    prevoper:	dw 0			; holds int 13 request (i.e. register ax).			
  1083 00000020 00                      number_of_sec:	db 0			; holds number of secs. to read on an ecc error
  1084 00000021 0000                    auxnum:		dw 0			; which aux device was requested			
  1085                                  
  1086                                  ;-----------------------------------------------------------------------------
  1087                                  
  1088                                  res_dev_list:
  1089                                  
  1090                                  ; Device Header for the CON Device Driver
  1091                                  
  1092                                  CONHeader:				; HEADER FOR DEVICE "CON"
  1093 00000023 [3500]                  		dw auxdev2
  1094 00000025 7000                    		dw 70h	
  1095 00000027 1380                    word_727:	dw 8013h
  1096 00000029 [1506]                  		dw strategy
  1097 0000002B [2006]                  		dw con_entry
  1098 0000002D 434F4E2020202020        aCon:		db 'CON     '           
  1099 00000035 [4700]                  auxdev2:	dw prndev2		; HEADER FOR DEVICE "AUX"	
  1100 00000037 7000                    		dw 70h
  1101 00000039 0080                    		dw 8000h
  1102 0000003B [1506]                  		dw strategy
  1103 0000003D [4106]                  		dw aux0_entry
  1104 0000003F 4155582020202020        aAux:		db 'AUX     '
  1105 00000047 [5900]                  prndev2:	dw timdev		; HEADER FOR DEVICE "PRN"
  1106 00000049 7000                    		dw 70h
  1107 0000004B C0A0                    word_74B:	dw 0A0C0h
  1108 0000004D [1506]                  		dw strategy
  1109 0000004F [2506]                  		dw prn0_entry
  1110 00000051 50524E2020202020        aPrn:		db 'PRN     '		; HEADER FOR DEVICE "CLOCK$"
  1111 00000059 [6B00]                  timdev:		dw dskdev	
  1112 0000005B 7000                    		dw 70h
  1113 0000005D 0880                    		dw 8008h
  1114 0000005F [1506]                  		dw strategy
  1115 00000061 [5906]                  		dw tim_entry
  1116 00000063 434C4F434B242020        aClock:		db 'CLOCK$  '
  1117 0000006B [7B00]                  dskdev:		dw com1dev		; HEADER FOR DISK DEVICES
  1118 0000006D 7000                    		dw 70h
  1119                                  		;dw 8C2h
  1120                                  		; 02/10/2023 - Retro DOS v5.0
  1121 0000006F C248                    		dw 48C2h		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:006Fh 
  1122                                  		;dw offset strategy
  1123                                  		;dw offset dsk_entry
  1124                                  		; 19/10/2022
  1125 00000071 [1506]                  		dw strategy
  1126 00000073 [5E06]                  		dw dsk_entry
  1127                                  
  1128                                  ; maximum number of drives
  1129                                  
  1130 00000075 04                      drvmax:		db 4			
  1131 00000076 FE                      step_drv:	db 0FEh	 ; -2		; last drive accessed		
  1132 00000077 00                      fhave96:	db 0			; flag to indicate presence of
  1133                                  					; 96tpi support		
  1134 00000078 00                      single:		db 0			; used to detect single drive systems		
  1135 00000079 00                      fhavek09:	db 0			; indicates if this is a k09 or not
  1136                                  					; used by console driver.			
  1137 0000007A 00                      fsetowner:	db 0			; = 1 if we are setting the owner of a
  1138                                  					; drive. (examined by checksingle).
  1139                                  		
  1140 0000007B [8D00]                  com1dev:	dw lpt1dev		; Device Header for device "COM1"	
  1141 0000007D 7000                    		dw 70h
  1142 0000007F 0080                    		dw 8000h
  1143 00000081 [1506]                  		dw strategy
  1144 00000083 [4106]                  		dw aux0_entry
  1145 00000085 434F4D3120202020        aCom1:		db 'COM1    '
  1146 0000008D [9F00]                  lpt1dev:	dw lpt2dev		; Device Header for device LPT1	
  1147 0000008F 7000                    		dw 70h
  1148 00000091 C0A0                    		dw 0A0C0h
  1149 00000093 [1506]                  		dw strategy
  1150 00000095 [2C06]                  		dw prn1_entry
  1151 00000097 4C50543120202020        aLpt1:		db 'LPT1    '
  1152 0000009F [B800]                  lpt2dev:	dw lpt3dev		; Device Header for device LPT2	
  1153 000000A1 7000                    		dw 70h
  1154 000000A3 C0A0                    		dw 0A0C0h
  1155 000000A5 [1506]                  		dw strategy
  1156 000000A7 [3306]                  		dw prn2_entry
  1157 000000A9 4C5054322020202000-     aLpt2:		db 'LPT2    ',0,0,0
  1157 000000B2 0000               
  1158                                  
  1159                                  ;M058; Start of changes
  1160                                  ; Orig13 needs to be at offset 0B4h for the CMS floppy driver to work.
  1161                                  ;These guys patch Orig13 with their own int 13h hook and so this offset
  1162                                  ;cannot change for them to work. Even ProComm does this.
  1163                                  
  1164 000000B4 00000000                Orig13:		dd 0			; to make Orig13 offset 0B4h		
  1165                                  
  1166 000000B8 [CA00]                  lpt3dev:	dw com2dev		; Device Header for device LPT3	
  1167 000000BA 7000                    		dw 70h
  1168 000000BC C0A0                    		dw 0A0C0h
  1169 000000BE [1506]                  		dw strategy
  1170 000000C0 [3A06]                  		dw prn3_entry
  1171 000000C2 4C50543320202020        aLpt3:		db 'LPT3    '
  1172 000000CA [DC00]                  com2dev:	dw com3dev		; Device Header for device "COM2"
  1173 000000CC 7000                    		dw 70h
  1174 000000CE 0080                    		dw 8000h
  1175 000000D0 [1506]                  		dw strategy
  1176 000000D2 [4706]                  		dw aux1_entry
  1177                                  		; 19/10/2022
  1178 000000D4 434F4D3220202020        aCom2:		db 'COM2    '
  1179                                  com3dev:	;dw offset com4dev	; Device Header for device "COM3"
  1180 000000DC [EE00]                  		dw com4dev
  1181 000000DE 7000                    		dw 70h
  1182 000000E0 0080                    		dw 8000h
  1183                                  		;dw offset strategy
  1184                                  		;dw offset aux2_entry
  1185 000000E2 [1506]                  		dw strategy
  1186 000000E4 [4D06]                  		dw aux2_entry	
  1187 000000E6 434F4D3320202020        aCom3:		db 'COM3    '
  1188 000000EE FFFF                    com4dev:	dw 0FFFFh		; Device Header for device "COM4"	
  1189 000000F0 7000                    		dw 70h
  1190 000000F2 0080                    		dw 8000h
  1191 000000F4 [1506]                  		dw strategy
  1192 000000F6 [5306]                  		dw aux3_entry
  1193 000000F8 434F4D3420202020        		db 'COM4    '
  1194                                  
  1195                                  ;-----------------------------------------------------------------------------
  1196                                  
  1197 00000100 10                      RomVectors:	db 10h			
  1198 00000101 00000000                Old10:		dd 0
  1199 00000105 13                      		db 13h
  1200 00000106 00000000                Old13:		dd 0			
  1201 0000010A 15                      		db 15h
  1202 0000010B 00000000                Old15:		dd 0			
  1203 0000010F 19                      		db 19h
  1204 00000110 00000000                Old19:		dd 0
  1205 00000114 1B                      		db 1Bh
  1206 00000115 00000000                Old1B:		dd 0
  1207                                  
  1208                                  ;EndRomVectors	equ $
  1209                                  
  1210                                  ;NUMROMVECTORS	equ ((EndRomVectors - RomVectors)/5)
  1211                                  
  1212                                  ;-----------------------------------------------------------------------------
  1213                                  
  1214 00000119 [5203]                  start_bds:	dw bds1			; Start	of linked list of BDS's
  1215 0000011B 7000                    		dw 70h			; KERNEL_SEGMENT
  1216                                  
  1217                                  ; (MSDOS 3.3) NOTE:
  1218                                  ; Some floppy drives do not have changeline support. The result is a
  1219                                  ; large amount of inefficiency in the code. A media-check always returns
  1220                                  ; "I don`t know". This cause DOS to reread the FAT on every access and
  1221                                  ; always discard any cached data.
  1222                                  ;    We get around this inefficiency by implementing a "Logical Door Latch".
  1223                                  ; The following three items are used to do this. The logical door latch is
  1224                                  ; based on the premise that it is not physically possible to change floppy
  1225                                  ; disks in a drive in under two seconds (most people take about 10). The
  1226                                  ; logical door latch is implemented by saving the time of the last successful
  1227                                  ; disk operation (in the value TIM_DRV). When a new request is made the
  1228                                  ; current time is compared to the saved time. If less than two seconds have
  1229                                  ; passed then the value "No Change" is returned. If more than two seconds
  1230                                  ; have passed the value "Don't Know" is returned.
  1231                                  ;    There is one complecation to this algorithm. Some programs change the
  1232                                  ; value of the timer. In this unfortunate case we have an invalid timer.
  1233                                  ; This possibility is detected by counting the number of disk operations
  1234                                  ; which occur without any time passing. If this count exceeds the value of
  1235                                  ; "AccessMax" we assume the counter is invalid and always return "Don't
  1236                                  ; Know". The variable "AccessCount" is used to keep track of the number
  1237                                  ; of disk operation which occur without the time changing.
  1238                                  
  1239 0000011D 00                      accesscount:	db 0			
  1240 0000011E FF                      tim_drv:	db 0FFh			
  1241 0000011F 00                      medbyt:		db 0
  1242                                  wrtverify:	; 15/10/2022			
  1243 00000120 02                      rflag:		db 2			; 2 for	read, 3	for write
  1244 00000121 00                      verify:		db 0			; 1 if verify after write
  1245 00000122 0000                    seccnt:		dw 0			
  1246 00000124 00                      		db 0			; -- pad where hardnum was
  1247 00000125 01                      dsktnum:	db 1			; number of diskette drives			
  1248                                  
  1249                                  ; (MSDOS 3.3) NOTE:
  1250                                  ; Some of the older versions of the IBM rom-bios always assumed a seek would
  1251                                  ; have to be made to read the diskette. Consequently a large head settle
  1252                                  ; time was always used in the I/O operations. To get around this problem
  1253                                  ; we need to continually adjust the head settle time. The following
  1254                                  ; algorithm is used:
  1255                                  ;
  1256                                  ;   Get the current head settle value.
  1257                                  ;   If it is 1, then
  1258                                  ;	set slow = 15
  1259                                  ;   else
  1260                                  ;	set slow = value
  1261                                  ;   ...
  1262                                  ;   if we are seeking and writing then
  1263                                  ;	use slow
  1264                                  ;   else
  1265                                  ;	use fast
  1266                                  ;   ...
  1267                                  ;   restore current head settle value
  1268                                  
  1269 00000126 00                      motorstartup:	db 0			; value from table
  1270 00000127 00                      settlecurrent:	db 0			; value from table
  1271 00000128 00                      settleslow:	db 0			; slow settle value
  1272 00000129 00                      nextspeed:	db 0			; value	of speed to be used
  1273 0000012A 00                      save_head_sttl:	db 0			; used by read_sector routine
  1274 0000012B 00                      save_eot:	db 0			; saved	eot from the default DPT
  1275 0000012C 09                      eot:		db 9			
  1276 0000012D 00000000                dpt:		dd 0			; pointer to Disk Parameter Table
  1277 00000131 00                      cursec:		db 0			; current sector
  1278 00000132 00                      curhd:		db 0			; current head
  1279 00000133 0000                    curtrk:		dw 0			; current track
  1280 00000135 0000                    spsav:		dw 0			; save the stack pointer
  1281 00000137 08                      formt_eot:	db 8			; eot used for format
  1282 00000138 00                      hdnum:		db 0			; head number
  1283 00000139 0000                    trknum:		dw 0			; track	being manipulated
  1284 0000013B 50                      gap_patch:	db 50h			; format gap patched into dpt
  1285                                  
  1286                                  ;-----------------------------------------------------------------------------
  1287                                  
  1288                                  ; disk errors returned from the IBM rom
  1289                                  
  1290 0000013C CC                      errin:		db 0CCh			; write fault (hard disk)
  1291 0000013D 80                      		db 80h			; write fault (hard disk)
  1292 0000013E 40                      		db 40h			; seek failed
  1293 0000013F 10                      		db 10h			; uncorrectable CRC or ECC error on read
  1294 00000140 08                      		db 8			; dma overrun
  1295 00000141 06                      		db 6			; disk changed (floppy)
  1296 00000142 04                      		db 4			; sector not found/read error
  1297 00000143 03                      		db 3			; disk write-protected
  1298                                  		; 02/10/2023 - Retro DOS 5.0 (PCDOS 7.1 IBMBIO.COM)
  1299 00000144 01                      		db 1			; invalid function in AH or invalid parameter
  1300 00000145 B2                      		db 0B2h			; volume not removable	
  1301                                  		;
  1302 00000146 00                      lsterr:		db 0			; all other errors
  1303                                  
  1304                                  ; returned error codes corresponding to above
  1305                                  
  1306 00000147 0A                      errout:		db 10			; write	fault error
  1307 00000148 02                      		db 2			; no response (timeout)
  1308 00000149 06                      		db 6			; seek failure
  1309 0000014A 04                      		db 4			; bad crc
  1310 0000014B 04                      		db 4			; dma overrun
  1311 0000014C 0F                      		db 15			; invalid media	change
  1312 0000014D 08                      		db 8			; sector not found
  1313 0000014E 00                      		db 0			; write	attempt	to write-protect disk
  1314                                  		; 02/10/2023
  1315 0000014F 03                      		db 3			; unknown command error
  1316 00000150 03                      		db 3			; unknown command error
  1317                                  		;
  1318 00000151 0C                      		db 12			; general error
  1319                                  
  1320                                  ;-----------------------------------------------------------------------------
  1321                                  ; PCDOS 7.1 IBMBIO.COM - BIOSDATA:0152h
  1322                                  
  1323                                  ; 02/10/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
  1324                                  %if 1
  1325                                  disksector:	;times 174 db 0
  1326                                  NUM174 equ 512-$
  1327 00000152 00<rep AEh>             		times NUM174 db 0
  1328                                  JB_sign	:	;dw 424Ah		; 'BJ' (nasm) ; 'JB' (masm)
  1329 00000200 4A                      		dec	dx
  1330 00000201 42                      		inc	dx	
  1331 00000202 E9FBFD                  		jmp	BData_start	; db 0E9h, 0FBh, 0FDh
  1332                                  
  1333 00000205 402349424D3A31322E-     IBMBIOCOM$:	db '@#IBM:12.01.2003.build_1.32#@ IBMBIO.COM(USA)',0
  1333 0000020E 30312E323030332E62-
  1333 00000217 75696C645F312E3332-
  1333 00000220 23402049424D42494F-
  1333 00000229 2E434F4D2855534129-
  1333 00000232 00                 
  1334                                  		
  1335                                  		;times 287 db 0
  1336 00000233 00<rep 11Fh>            		times (disksector+512-$) db 0  ; 287
  1337                                  %endif
  1338                                  
  1339                                  ;-----------------------------------------------------------------------------
  1340                                  
  1341                                  ; 30/12/2018 - Retro DOS v4.0
  1342                                  
  1343                                  ; read in boot sector here, read done in readboot.
  1344                                  ; also read sector for dma check for hard disk.
  1345                                  ;
  1346                                  ; This buffer is word aligned because certain AMI BIOSs have a bug
  1347                                  ; in them which causes the byte after the buffer to be trashed
  1348                                  ; on floppy reads to odd-byte boundaries. Although no general effort 
  1349                                  ; is made to enforce this in the bigger picture, this one small sacrifice
  1350                                  ; makes that system more-or-less work.
  1351                                  
  1352                                  ; 02/10/2023
  1353                                  %if 0
  1354                                  
  1355                                  disksector:	;db 512 dup(0)		; read in boot sector here
  1356                                  		; 19/10/2022
  1357                                  		times 512 db 0
  1358                                  %endif
  1359                                  
  1360                                  ;-----------------------------------------------------------------------------
  1361                                  
  1362                                  ; 02/10/2023 - Retro DOS v5.0
  1363                                  ; 30/12/2018 - Retro DOS v4.0
  1364                                  ;-----------------------------------------------------------------------------
  1365                                  ; 25/05/2018 (04/04/2018)
  1366                                  ;*****************************************************************************
  1367                                  ;	"bds" contains information for each drive in the system.
  1368                                  ;	various values are patched whenever actions are performed.
  1369                                  ;	sectors/alloc. unit in bpb initially set to -1 to signify that
  1370                                  ;	the bpb has not been filled. link also set to -1 to signify end
  1371                                  ;	of list. # of cylinders in maxparms initialized to -1 to indicate
  1372                                  ;	that the parameters have not been set.
  1373                                  
  1374                                  bds1:		;dw offset bds2
  1375 00000352 [E803]                  		dw bds2	; 19/10/2022
  1376 00000354 7000                    		dw 70h			; dword	link to	next structure
  1377 00000356 00                      		db 0			; int 13h drive	number
  1378 00000357 00                      		db 0			; logical drive	letter
  1379 00000358 0002                    fdrive1:	dw 512			
  1380                                  					; physical sector size in bytes
  1381 0000035A FF                      		db 0FFh			; sectors/allocation unit
  1382 0000035B 0100                    		dw 1			; reserved sectors for dos
  1383 0000035D 02                      		db 2			; no of	file allocation	tables
  1384 0000035E 4000                    		dw 64			; number of root directory entries
  1385 00000360 6801                    		dw 360			; number sectors (at 512 bytes each)
  1386 00000362 00                      		db 0			; media	descriptor, initially 0
  1387 00000363 0200                    		dw 2			; number of fat	sectors
  1388 00000365 0900                    		dw 9			; sector limit (sectors	per track)
  1389 00000367 0100                    		dw 1			; head limit (number of	heads -	1)
  1390                                  		;
  1391                                  		; 02/10/2023
  1392                                  		; MSDOS 5.0-6.22 (& PCDOS 7.0)
  1393                                  		;dw 0			; hidden sector	count (low word)
  1394                                  		;dw 0			; hidden sector	(high)
  1395                                  		;dw 0			; number sectors (low)
  1396                                  		;dw 0			; number sectors (high)
  1397                                  		;db 0			; true => large	fats
  1398                                  		; 02/10/2023
  1399                                  		; PCDOS 7.1 (FAT32 support)
  1400 00000369 00000000                		dd 0			; hidden sector count
  1401 0000036D 00000000                		dd 0			; number of sectors (32 bit)
  1402 00000371 00000000                		dd 0			; BPB_FATSz32 ; FAT32 FAT size in sectors ; 4 bytes
  1403                                  					;   BS_DrvNum ; FAT INT 13h drive number ; 1 byte
  1404                                  					;   BS_Reserved1 ; FAT reserved byte = 0 ; 1 byte
  1405                                  					;   BS_BootSig ; FAT Extended boot signature = 29h ; 1 byte
  1406                                  					;   BS_VolID ; FAT Volume serial number ; 4 bytes
  1407 00000375 0000                    		dw 0			; BPB_ExtFlags ; FAT32 Extended Flags
  1408 00000377 0000                    		dw 0			; BPB_FSVer ; FAT32 fs/volume version
  1409 00000379 00000000                		dd 0			; BPB_RootClus ; FAT32 root directory's first cluster number
  1410 0000037D FFFF                    		dw 0FFFFh		; BPB_FSInfo ; FAT32 FSINFO sector number = -1 (initial)
  1411 0000037F FFFF                    		dw 0FFFFh		; BPB_BkBootSec ; FAT32 backup boot sector number = -1 (initial)
  1412 00000381 00<rep Ch>              		times 12 db 0		; BPB_Reserved  ; FAT32 reserved field = 0, 12 bytes
  1413 0000038D 00                      		db 0			; true => large	fats
  1414                                  		;
  1415 0000038E 0000                    		dw 0			; open ref. count
  1416 00000390 03                      		db 3			; form factor
  1417 00000391 2000                    		dw 20h			; various flags
  1418 00000393 2800                    		dw 40			; number of cylinders
  1419 00000395 0002                    recommended_bps: dw 512			; recommended bps for this drive
  1420 00000397 01                      		db 1
  1421 00000398 0100                    		dw 1
  1422 0000039A 02                      		db 2
  1423 0000039B E000                    		dw 224			; number of root directory entries
  1424 0000039D 6801                    		dw 360
  1425 0000039F F0                      		db 0F0h			; media	descriptor, initially 0F0h
  1426 000003A0 0200                    		dw 2
  1427 000003A2 0900                    		dw 9
  1428 000003A4 0200                    		dw 2
  1429                                  		;
  1430                                  		; 02/10/2023
  1431                                  		;dw 0
  1432                                  		;dw 0
  1433                                  		;dw 0
  1434                                  		;dw 0
  1435                                  		;;db 6 dup(0)
  1436                                  		;times 6 db 0		; 19/10/2022
  1437 000003A6 00000000                		dd 0
  1438 000003AA 00000000                		dd 0
  1439 000003AE 00000000                		dd 0
  1440 000003B2 0000                    		dw 0
  1441 000003B4 0000                    		dw 0
  1442 000003B6 00000000                		dd 0
  1443 000003BA FFFF                    		dw 0FFFFh
  1444 000003BC FFFF                    		dw 0FFFFh	
  1445                                  		;db 12 dup(0)
  1446 000003BE 00<rep Ch>              		times 12 db 0		; 02/10/2023
  1447                                  		;
  1448 000003CA FF                      		db 0FFh			; last track accessed on this drive
  1449 000003CB FFFF                    		dw 0FFFFh		; keep these two contiguous (?)
  1450 000003CD FFFF                    		dw 0FFFFh
  1451 000003CF 4E4F204E414D452020-     		db 'NO NAME    ',0      ; volume id for this disk
  1451 000003D8 202000             
  1452 000003DB 00000000                		dd 0			; current volume serial	from boot record
  1453 000003DF 464154313220202000      		db 'FAT12   ',0         ; current file system id from boot record
  1454                                  ; ----
  1455                                  
  1456                                  ; 02/10/2023
  1457                                  ; PCDOS 7.1
  1458                                  %if 1
  1459                                  
  1460                                  bds2:		; 02/10/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
  1461 000003E8 FFFF                    		dw 0FFFFh ; -1
  1462 000003EA 7000                    		dw 70h
  1463 000003EC 00                      		db 0
  1464 000003ED 00                      		db 0
  1465 000003EE 0002                    fdrive2:	dw 512
  1466 000003F0 FF                      		db 0FFh
  1467 000003F1 0100                    		dw 1
  1468 000003F3 02                      		db 2
  1469 000003F4 4000                    		dw 64
  1470 000003F6 6801                    		dw 360
  1471 000003F8 00                      		db 0
  1472 000003F9 0200                    		dw 2
  1473 000003FB 0900                    		dw 9
  1474 000003FD 0100                    		dw 1
  1475 000003FF 00000000<rep 5h>        		times 5 dd 0
  1476 00000413 FFFFFFFF                		dd 0FFFFFFFFh
  1477 00000417 00000000<rep 3h>        		times 3 dd 0
  1478 00000423 00                      		db 0
  1479 00000424 0000                    		dw 0
  1480 00000426 03                      		db 3
  1481 00000427 2000                    		dw 20h
  1482 00000429 2800                    		dw 40
  1483                                  recbpb2:
  1484 0000042B 0002                    		dw 512
  1485 0000042D 01                                      db 1
  1486 0000042E 0100                                    dw 1
  1487 00000430 02                                      db 2
  1488 00000431 E000                                    dw 224
  1489 00000433 6801                                    dw 360
  1490 00000435 F0                                      db 0F0h
  1491 00000436 0200                                    dw 2
  1492 00000438 0900                                    dw 9
  1493 0000043A 0200                                    dw 2
  1494 0000043C 00000000<rep 5h>        		times 5 dd 0
  1495 00000450 FFFFFFFF                		dd 0FFFFFFFFh
  1496 00000454 00000000<rep 3h>                        times 3 dd 0
  1497 00000460 FF                                      db 0FFh
  1498 00000461 FFFFFFFF                                dd 0FFFFFFFFh
  1499 00000465 4E4F204E414D452020-                     db 'NO NAME    ',0
  1499 0000046E 202000             
  1500 00000471 00000000                                dd 0
  1501 00000475 464154313220202000                      db 'FAT12   ',0
  1502                                  %endif
  1503                                  
  1504                                  ; ----
  1505                                  
  1506                                  ; 02/10/2023
  1507                                  ; MSDOS 5.0 - 6.22 (& PCDOS 7.0)
  1508                                  %if 0
  1509                                  
  1510                                  bds2:		dw bds3		
  1511                                  		dw 70h
  1512                                  		db 0
  1513                                  		db 0
  1514                                  fdrive2:	dw 512			
  1515                                  		db 0FFh, 1, 0, 2, 40h, 0, 68h, 1, 0, 2,	0, 9, 0, 1, 0
  1516                                  		db 0, 0, 0, 0, 0, 0, 0,	0, 0, 0, 0, 3, 20h, 0, 28h, 0
  1517                                  		db 0, 2, 1, 1, 0, 2, 0E0h, 0, 68h, 1, 0F0h, 2, 0, 9, 0
  1518                                  		db 2, 0, 0, 0, 0, 0, 0,	0, 0, 0, 0, 0, 0, 0, 0,	0, 0FFh
  1519                                  		db 0FFh, 0FFh, 0FFh, 0FFh, 4Eh,	4Fh, 20h, 4Eh, 41h, 4Dh
  1520                                  		db 45h,	20h, 20h, 20h, 20h, 0, 0, 0, 0,	0, 46h,	41h, 54h
  1521                                  		db 31h,	32h, 20h, 20h, 20h, 0
  1522                                  
  1523                                  bds3:		dw bds4		
  1524                                  		dw 70h
  1525                                  		db 0
  1526                                  		db 0
  1527                                  fdrive3:	dw 512			
  1528                                  		db 0FFh, 1, 0, 2, 40h, 0, 68h, 1, 0, 2,	0, 9, 0, 1, 0
  1529                                  		db 0, 0, 0, 0, 0, 0, 0,	0, 0, 0, 0, 3, 20h, 0, 28h, 0
  1530                                  		db 0, 2, 1, 1, 0, 2, 0E0h, 0, 68h, 1, 0F0h, 2, 0, 9, 0
  1531                                  		db 2, 0, 0, 0, 0, 0, 0,	0, 0, 0, 0, 0, 0, 0, 0,	0, 0FFh
  1532                                  		db 0FFh, 0FFh, 0FFh, 0FFh, 4Eh,	4Fh, 20h, 4Eh, 41h, 4Dh
  1533                                  		db 45h,	20h, 20h, 20h, 20h, 0, 0, 0, 0,	0, 46h,	41h, 54h
  1534                                  		db 31h,	32h, 20h, 20h, 20h, 0
  1535                                  ; ----
  1536                                  
  1537                                  bds4:		dw 0FFFFh		
  1538                                  		dw 70h
  1539                                  		db 0
  1540                                  		db 0
  1541                                  fdrive4:	dw 512			
  1542                                  		db 0FFh, 1, 0, 2, 40h, 0, 68h, 1, 0, 2,	0, 9, 0, 1, 0
  1543                                  		db 0, 0, 0, 0, 0, 0, 0,	0, 0, 0, 0, 3, 20h, 0, 28h, 0
  1544                                  		db 0, 2, 1, 1, 0, 2, 0E0h, 0, 68h, 1, 0F0h, 2, 0, 9, 0
  1545                                  		db 2, 0, 0, 0, 0, 0, 0,	0, 0, 0, 0, 0, 0, 0, 0,	0, 0FFh
  1546                                  		db 0FFh, 0FFh, 0FFh, 0FFh, 4Eh,	4Fh, 20h, 4Eh, 41h, 4Dh
  1547                                  		db 45h,	20h, 20h, 20h, 20h, 0, 0, 0, 0,	0, 46h,	41h, 54h
  1548                                  		db 31h,	32h, 20h, 20h, 20h, 0
  1549                                  
  1550                                  ;-----------------------------------------------------------------------------
  1551                                  
  1552                                  sm92:		db 3			; .spf
  1553                                  		db 9			; .spt
  1554                                  		db 112	; 70h		; .cdire
  1555                                  		dw 1440	; 2*9*80	; .csec
  1556                                  		db 2			; .spau
  1557                                  		db 2			; .chead
  1558                                  
  1559                                  %endif
  1560                                  
  1561 0000047E 00                      keyrd_func:	db 0			
  1562 0000047F 01                      keysts_func:	db 1			
  1563 00000480 00                      printdev:	db 0			; printer device index
  1564                                  
  1565                                  wait_count:	;dw 4 dup(50h)		; retry	counts for printers
  1566 00000481 5000<rep 4h>            		times 4 dw 50h		; 19/10/2022
  1567                                  
  1568 00000489 0000                    daycnt:		dw 0			
  1569 0000048B 00                      t_switch:	db 0			; flag for updating daycnt
  1570 0000048C 00                      havecmosclock:	db 0			
  1571 0000048D 13                      base_century:	db 19			
  1572 0000048E 50                      base_year:	db 80			
  1573                                  
  1574 0000048F 1F                      month_tab:	db 31
  1575 00000490 1C                      february:	db 28 ; 08/08/2023
  1576 00000491 1F1E1F1E1F1F1E1F1E-     		db 31, 30, 31, 30, 31, 31, 30, 31, 30, 31
  1576 0000049A 1F                 
  1577                                  
  1578                                  ; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  1579                                  %if 0  
  1580                                  bintobcd:	dw bin_to_bcd		; points to bin_to_bcd proc in msinit
  1581                                  		dw 70h ; 17/10/2022	
  1582                                  daycnttoday:	dw daycnt_to_day	; points to daycnt_to_day in msinit
  1583                                  		dw 70h ; 17/10/2022
  1584                                  %endif
  1585 0000049B 00                      set_id_flag:	db 0			; flag for getbp routine
  1586                                  
  1587                                  ; 02/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  1588                                  ;fat_12_id:	db 'FAT12   ',0         
  1589                                  ;fat_16_id:	db 'FAT16   ',0         
  1590                                  ;vol_no_name:	db 'NO NAME    ',0      
  1591                                  ;temp_h:	dw 0			; temporary for	32 bit calculation
  1592                                  
  1593 0000049C 0000                    start_sec_h:	dw 0			; starting sector number high word
  1594 0000049E 0000                    saved_word:	dw 0			; tempory saving place for a word
  1595 000004A0 0000                    multrk_flag:	dw 0			
  1596 000004A2 00                      ec35flag:	db 0			; flags	for 3.5	inch disk drives
  1597 000004A3 0000                    vretry_cnt:	dw 0			
  1598 000004A5 0000                    soft_ecc_cnt:	dw 0			
  1599 000004A7 00                      multitrk_format_flag: db 0		; multi	track format request flag
  1600 000004A8 0000                    xfer_seg:	dw 0			; temp for transfer segment
  1601                                  
  1602                                  ; variables for msdioctl.asm module
  1603                                  
  1604                                  ; tracktable contains a 4-tuples (c,h,r,n) for each sector in a track
  1605                                  ; c = cylinder number,h = head number,r = sector id,n = bytes per sector
  1606                                  ;	n	bytes per sector
  1607                                  ;      ---	----------------
  1608                                  ;	0	      128
  1609                                  ;	1	      256
  1610                                  ;	2	      512
  1611                                  ;	3	     1024
  1612                                  
  1613                                  ;max_sectors_curr_sup equ 63		; current maximum sec/trk that
  1614                                  ;					; we support (was 40 in dos 3.2)
  1615                                  
  1616 000004AA 2400                    sectorspertrack: dw 36			
  1617 000004AC 00000102                tracktable:	db 0, 0, 1, 2		
  1618 000004B0 00000202                		db 0, 0, 2, 2
  1619 000004B4 00000302                		db 0, 0, 3, 2
  1620 000004B8 00000402                		db 0, 0, 4, 2
  1621 000004BC 00000502                		db 0, 0, 5, 2
  1622 000004C0 00000602                		db 0, 0, 6, 2
  1623 000004C4 00000702                		db 0, 0, 7, 2
  1624 000004C8 00000802                		db 0, 0, 8, 2
  1625 000004CC 00000902                		db 0, 0, 9, 2
  1626 000004D0 00000A02                		db 0, 0, 10, 2
  1627 000004D4 00000B02                		db 0, 0, 11, 2
  1628 000004D8 00000C02                		db 0, 0, 12, 2
  1629 000004DC 00000D02                		db 0, 0, 13, 2
  1630 000004E0 00000E02                		db 0, 0, 14, 2
  1631 000004E4 00000F02                		db 0, 0, 15, 2
  1632 000004E8 00001002                		db 0, 0, 16, 2
  1633 000004EC 00001102                		db 0, 0, 17, 2
  1634 000004F0 00001202                		db 0, 0, 18, 2
  1635 000004F4 00001302                		db 0, 0, 19, 2
  1636 000004F8 00001402                		db 0, 0, 20, 2
  1637 000004FC 00001502                		db 0, 0, 21, 2
  1638 00000500 00001602                		db 0, 0, 22, 2
  1639 00000504 00001702                		db 0, 0, 23, 2
  1640 00000508 00001802                		db 0, 0, 24, 2
  1641 0000050C 00001902                		db 0, 0, 25, 2
  1642 00000510 00001A02                		db 0, 0, 26, 2
  1643 00000514 00001B02                		db 0, 0, 27, 2
  1644 00000518 00001C02                		db 0, 0, 28, 2
  1645 0000051C 00001D02                		db 0, 0, 29, 2
  1646 00000520 00001E02                		db 0, 0, 30, 2
  1647 00000524 00001F02                		db 0, 0, 31, 2
  1648 00000528 00002002                		db 0, 0, 32, 2
  1649 0000052C 00002102                		db 0, 0, 33, 2
  1650 00000530 00002202                		db 0, 0, 34, 2
  1651 00000534 00002302                		db 0, 0, 35, 2
  1652 00000538 00002402                		db 0, 0, 36, 2
  1653                                  
  1654                                  ; 02/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  1655                                  ; PCDOS 7.1 IBMBIO.COM - BIOSDATA:053Ch
  1656                                  
  1657                                  		;times 108 db 0		; 19/10/2022
  1658                                  		;;db 108 dup(0)		; 4*max_sectors_curr_sup - ($ -	tracktable) dup	(0)
  1659                                  					; times	((4*63)	- 144) db 0
  1660                                  dskdrvs:	
  1661 0000053C [5803]                  		dw fdrive1
  1662 0000053E [EE03]                  		dw fdrive2 
  1663                                  	
  1664                                  		;dw 52 dup(0)
  1665 00000540 00<rep 68h>             		times 104 db 0		; times (((4*63)-144)-4) db 0
  1666                                  					; 4*max_sectors_curr_sup-($-tracktable)-4 dup (0)			
  1667                                  
  1668                                  ;-----------------------------------------------------------------------------
  1669                                  
  1670                                  ; this is a real ugly place to put this
  1671                                  ; it should really go in the bds
  1672                                  
  1673 000005A8 00                      mediatype:	db 0			
  1674 000005A9 00                      media_set_for_format: db 0		; 1 if we have done an int 13h set media
  1675                                  					; type for format call
  1676 000005AA 00                      had_format_error: db 0			; 1 if the previous format operation
  1677                                  					; failed.
  1678                                  
  1679                                  ; temp disk base table. it holds the the current dpt which is then replaced by
  1680                                  ; the one passed by "new roms" before we perform a format operation. the old
  1681                                  ; dpt is restored in restoreolddpt. the first entry (disk_specify_1) is -1 if
  1682                                  ; this table does not contain the previously saved dpt.
  1683                                  		
  1684 000005AB FFFFFFFF                tempdpt:	dd 0FFFFFFFFh ; -1	; temp disk base table
  1685 000005AF FF                      model_byte:	db 0FFh			; model	byte set at init time
  1686 000005B0 00                      secondary_model_byte: db 0
  1687                                  		
  1688 000005B1 00                      int19sem:	db 0			; indicate that all int 19h
  1689                                  					; initialization is complete
  1690                                  		
  1691                                  ;; we assume the following remain contiguous and their order doesn't change
  1692                                  ;i19_lst:
  1693                                  ;	irp	aa,<02,08,09,0a,0b,0c,0d,0e,70,72,73,74,76,77>
  1694                                  ;	public	int19old&aa
  1695                                  ;		db	aa&h	; store the number as a byte
  1696                                  ;int19old&aa	dd	-1	; original hardware int. vectors for int 19h.
  1697                                  ;	endm
  1698                                  
  1699                                  ; 21/10/2022
  1700                                  
  1701 000005B2 02                      i19_lst:	db 2			
  1702                                  					; Int19old&aa
  1703 000005B3 FFFFFFFF                int19old02:	dd 0FFFFFFFFh ; -1
  1704 000005B7 08                      		db 8
  1705 000005B8 FFFFFFFF                int19old08:	dd 0FFFFFFFFh		; original hardware int. vectors for int 19h
  1706 000005BC 09                      		db 9
  1707 000005BD FFFFFFFF                int19old09:	dd 0FFFFFFFFh
  1708 000005C1 0A                      		db 0Ah
  1709 000005C2 FFFFFFFF                int19old0A:	dd 0FFFFFFFFh
  1710 000005C6 0B                      		db 0Bh
  1711 000005C7 FFFFFFFF                int19old0B:	dd 0FFFFFFFFh
  1712 000005CB 0C                      		db 0Ch
  1713 000005CC FFFFFFFF                int19old0C:	dd 0FFFFFFFFh
  1714 000005D0 0D                      		db 0Dh
  1715 000005D1 FFFFFFFF                int19old0D:	dd 0FFFFFFFFh
  1716 000005D5 0E                      		db 0Eh
  1717 000005D6 FFFFFFFF                int19old0E:	dd 0FFFFFFFFh
  1718 000005DA 70                      		db 70h
  1719 000005DB FFFFFFFF                int19old70:	dd 0FFFFFFFFh
  1720 000005DF 72                      		db 72h
  1721 000005E0 FFFFFFFF                int19old72:	dd 0FFFFFFFFh
  1722 000005E4 73                      		db 73h
  1723 000005E5 FFFFFFFF                int19old73:	dd 0FFFFFFFFh
  1724 000005E9 74                      		db 74h
  1725 000005EA FFFFFFFF                int19old74:	dd 0FFFFFFFFh
  1726 000005EE 76                      		db 76h
  1727 000005EF FFFFFFFF                int19old76:	dd 0FFFFFFFFh
  1728 000005F3 77                      		db 77h
  1729 000005F4 FFFFFFFF                int19old77:	dd 0FFFFFFFFh
  1730                                  
  1731                                  ;num_i19	equ ($ - i19_lst)/5  ; 18/03/2019
  1732                                  
  1733                                  ;-----------------------------------------------------------------------------
  1734                                  
  1735                                  ; 02/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  1736                                  ; 
  1737                                  ;dskdrvs:	dw fdrive1	
  1738                                  ;		dw fdrive2
  1739                                  ;		dw fdrive3
  1740                                  ;		dw fdrive4
  1741                                  ;
  1742                                  ;;M011 -- made all hard drive stuff variable
  1743                                  ;		;dw 22 dup(0)		; up to	26 drives for mini disks
  1744                                  ;		times 22 dw 0	; 19/10/2022
  1745                                  
  1746                                  ;-----------------------------------------------------------------------------
  1747                                  
  1748                                  ; 01/10/2022 - Retro DOS v4.0 (MSDOS v5.0 -actual-)
  1749                                  ; 30/12/2018 - Retro DOS v4.0 (MSDOS v6.21 -draft-)
  1750                                  ; 01/06/2018 - Retro DOS v3.0 (MSDOS v3.3)
  1751                                  
  1752                                  ;variables for dynamic relocatable modules
  1753                                  ;these should be stay resident.
  1754                                  
  1755 000005F8 00000000                int6c_ret_addr:	dd 0			; return address from int 6Ch
  1756                                  					; for p12 machine
  1757                                  
  1758                                  ; data structures for real-time date and time
  1759                                  			
  1760 000005FC 00000000                bin_date_time:	db 0, 0, 0, 0		; century, year, month,	day
  1761                                  
  1762                                  ; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  1763                                  %if 0
  1764                                  month_table:	dw 0			; january
  1765                                  		dw 31			; february
  1766                                  		dw 59
  1767                                  		dw 90
  1768                                  		dw 120
  1769                                  		dw 151
  1770                                  		dw 181
  1771                                  		dw 212
  1772                                  		dw 243
  1773                                  		dw 273
  1774                                  		dw 304
  1775                                  		dw 334			; december
  1776                                  %endif
  1777                                  
  1778 00000600 0000                    daycnt2:	dw 0			
  1779                                  ; 08/08/2023
  1780                                  ;feb29:		db 0			; february 29 in a leap	year flag
  1781                                  
  1782                                  ;-----------------------------------------------------------------------------
  1783                                  ;
  1784                                  ; 01/10/2022 - (New/Actual) Retro DOS v4.0 (will run as MSDOS 5.0)	
  1785                                  ; by Erdogan Tan (Istanbul) ! free source code !
  1786                                  ; 31/12/2018 - (old/draft) Retro DOS v4.0 (will/would run as MSDOS 6.21)
  1787                                  
  1788                                  ; ----------------------------------------------------------------------------
  1789                                  
  1790                                  ;************************************************************************
  1791                                  ;*									*
  1792                                  ;*	Entry points into Bios_Code routines. The segment values	*
  1793                                  ;*	  are plugged in by seg_reinit.					*
  1794                                  ;*									*
  1795                                  ;************************************************************************
  1796                                  
  1797                                  ; 01/10/2022 - Retro DOS v4.0 - IO.SYS (MSDOS v5.0)
  1798                                  ; BIOSCODE_SEGMENT equ 2C7h
  1799                                  ; BIOSDATA_SEGMENT equ 70h ; KERNEL_SEGMENT equ 70h
  1800                                  
  1801                                  ; 01/10/2022 - Erdogan Tan
  1802                                  ; (disassembled MSDOS 5.0 IO.SYS code here with fixed function/routine
  1803                                  ;  addresses, they will be changed to table labels later)
  1804                                  
  1805                                  ; 09/12/2022
  1806                                  %if 0
  1807                                  cdev:		dw 43h,	2C7h		; chardev_entry
  1808                                  					; at 2C7h:43h =	70h:25B3h
  1809                                  ttticks:	dw 396h, 2C7h		; time_to_ticks
  1810                                  					; at 2C7h:396h = 70h:2906h
  1811                                  bcode_i2f:	dw 1302h, 2C7h		; i2f_handler
  1812                                  					; at 2C7h:1302h	= 70h:3872h
  1813                                  i13x:		dw 154Bh, 2C7h		; i13z
  1814                                  					; at 2C7h:154Bh	= 70h:3ABBh
  1815                                  %endif
  1816                                  
  1817                                  ; 30/12/2022
  1818                                  ; (IOSYSCODESEG is 2CCh for MSDOS 6.21 IO.SYS)
  1819                                  
  1820                                  ; 02/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  1821                                  ; PCDOS 7.1 IBMBIO.COM - BIOSDATA:0602h
  1822                                  ; (IOSYSCODESEG is 364h for PCDOS 7.1 IBMBIO.COM)
  1823                                  
  1824                                  ; 09/12/2022
  1825 00000602 [4700]FF02              cdev:		dw chardev_entry, IOSYSCODESEG
  1826 00000606 [A003]FF02              ttticks:	dw time_to_ticks, IOSYSCODESEG
  1827                                  ; 07/08/2023
  1828                                  ;bcode_i2f:	dw i2f_handler, IOSYSCODESEG
  1829 0000060A [5D18]FF02              i13x:		dw i13z, IOSYSCODESEG
  1830                                  
  1831                                  end_BC_entries:	; 15/10/2022
  1832                                  
  1833                                  ;************************************************************************
  1834                                  ;*									*
  1835                                  ;*	cbreak - break key handling - simply set altah=3 and iret	*
  1836                                  ;*									*
  1837                                  ;************************************************************************
  1838                                  
  1839                                  cbreak:					
  1840 0000060E 2EC606[0C00]03          		mov	byte [cs:altah], 3 ; break key handling
  1841                                  					; indicate break key set
  1842                                  intret:					
  1843 00000614 CF                      		iret
  1844                                  
  1845                                  ; =============== S U B	R O U T	I N E ========================================
  1846                                  
  1847                                  
  1848                                  ;************************************************************************
  1849                                  ;*									*
  1850                                  ;*	strategy - store es:bx (device driver request packet)		*
  1851                                  ;*		     away at [ptrsav] for next driver function call	*
  1852                                  ;*									*
  1853                                  ;************************************************************************
  1854                                  
  1855                                  strategy:	; proc far		
  1856 00000615 2E891E[1200]            		mov	[cs:ptrsav], bx ; store es:bx (device driver request packet)
  1857                                  					; away at [ptrsav] for next driver function call
  1858 0000061A 2E8C06[1400]            		mov	[cs:ptrsav+2], es
  1859 0000061F CB                      		retf
  1860                                  
  1861                                  ; ----------------------------------------------------------------------------
  1862                                  
  1863                                  ;************************************************************************
  1864                                  ;*									*
  1865                                  ;*	device driver entry points. these are the initial		*
  1866                                  ;*	  'interrupt' hooks out of the device driver chain.		*
  1867                                  ;*	  in the case of our resident drivers, they'll just		*
  1868                                  ;*	  stick a fake return address on the stack which		*
  1869                                  ;*	  points to dispatch tables and possibly some unit		*
  1870                                  ;*	  numbers, and then call through a common entry point		*
  1871                                  ;*	  which can take care of a20 switching				*
  1872                                  ;*									*
  1873                                  ;************************************************************************
  1874                                  
  1875                                  ; 01/10/2022 - Erdogan Tan
  1876                                  ; (disassembled MSDOS 5.0 IO.SYS code here with fixed table
  1877                                  ;  addresses, they will be changed to table labels later)
  1878                                  
  1879                                  ; 09/12/2022
  1880                                  
  1881                                  ; 02/10/2023 - Retro DOS v5.0
  1882                                  ; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:0620h, BIOSCODE = 0364h)
  1883                                  
  1884                                  con_entry:				
  1885 00000620 E84000                  		call	cdev_entry
  1886                                  ; ----------------------------------------------------------------------------
  1887                                  		;dw 0E4h		; con_table
  1888 00000623 [E400]                  		dw con_table		; 364h:0E4h (PCDOS 7.1)
  1889                                  					; 2C7h:0E4h = 70h:2654h
  1890                                  ; ----------------------------------------------------------------------------
  1891                                  
  1892                                  prn0_entry:				
  1893 00000625 E83B00                  		call	cdev_entry
  1894                                  ; ----------------------------------------------------------------------------
  1895                                  		;dw 0FBh		; prn_table
  1896 00000628 [FB00]                  		dw prn_table
  1897                                  					; 2C7h:0FBh = 70h:266Bh
  1898 0000062A 0000                    		db 0, 0
  1899                                  ; ----------------------------------------------------------------------------
  1900                                  
  1901                                  prn1_entry:				
  1902 0000062C E83400                  		call	cdev_entry
  1903                                  ; ----------------------------------------------------------------------------
  1904                                  		;dw 0FBh		; prn_table
  1905 0000062F [FB00]                  		dw prn_table
  1906                                  					; 2C7h:0FBh = 70h:266Bh
  1907 00000631 0001                    		db 0, 1
  1908                                  ; ----------------------------------------------------------------------------
  1909                                  
  1910                                  prn2_entry:				
  1911 00000633 E82D00                  		call	cdev_entry
  1912                                  ; ----------------------------------------------------------------------------
  1913                                  		;dw 0FBh		; prn_table
  1914 00000636 [FB00]                  		dw prn_table
  1915                                  					; 2C7h:0FBh = 70h:266Bh
  1916 00000638 0102                    		db 1, 2
  1917                                  ; ----------------------------------------------------------------------------
  1918                                  
  1919                                  prn3_entry:				
  1920 0000063A E82600                  		call	cdev_entry
  1921                                  ; ----------------------------------------------------------------------------
  1922                                  		;dw 0FBh		; prn_table
  1923 0000063D [FB00]                  		dw prn_table
  1924                                  					; 2C7h:0FBh = 70h:266Bh
  1925 0000063F 0203                    		db 2, 3
  1926                                  ; ----------------------------------------------------------------------------
  1927                                  
  1928                                  aux0_entry:				
  1929 00000641 E81F00                  		call	cdev_entry
  1930                                  ; ----------------------------------------------------------------------------
  1931                                  		;dw 130h		; aux_table
  1932 00000644 [3001]                  		dw aux_table
  1933                                  					; 2C7h:130h = 70h:26A0h
  1934 00000646 00                      		db 0
  1935                                  ; ----------------------------------------------------------------------------
  1936                                  
  1937                                  aux1_entry:				
  1938 00000647 E81900                  		call	cdev_entry
  1939                                  ; ----------------------------------------------------------------------------
  1940                                  		;dw 130h		; aux_table
  1941 0000064A [3001]                  		dw aux_table		; 364h:130h = 70h:3070h (PCDOS 7.1)
  1942                                  					; 2C7h:130h = 70h:26A0h
  1943 0000064C 01                      		db 1
  1944                                  ; ----------------------------------------------------------------------------
  1945                                  
  1946                                  aux2_entry:				
  1947 0000064D E81300                  		call	cdev_entry
  1948                                  ; ----------------------------------------------------------------------------
  1949                                  		;dw 130h		; aux_table
  1950 00000650 [3001]                  		dw aux_table
  1951                                  					; 2C7h:130h = 70h:26A0h
  1952 00000652 02                      		db 2
  1953                                  ; ----------------------------------------------------------------------------
  1954                                  
  1955                                  aux3_entry:				
  1956 00000653 E80D00                  		call	cdev_entry
  1957                                  ; ----------------------------------------------------------------------------
  1958                                  		;dw 130h		; aux_table
  1959 00000656 [3001]                  		dw aux_table
  1960                                  					; 2C7h:130h = 70h:26A0h
  1961 00000658 03                      		db 3
  1962                                  ; ----------------------------------------------------------------------------
  1963                                  
  1964                                  tim_entry:				
  1965 00000659 E80700                  		call	cdev_entry
  1966                                  ; ----------------------------------------------------------------------------
  1967                                  		;dw 147h		; tim_table
  1968 0000065C [4701]                  		dw tim_table		; 364h:147h = 70h:3087h (PCDOS 7.1)
  1969                                  					; 2C7h:147h = 70h:26B7h
  1970                                  ; ----------------------------------------------------------------------------
  1971                                  
  1972                                  ; 15/10/2022
  1973                                  ;DSKTBL	equ dsktbl - DOSBIOSEG_2C7h	; dsktbl - 2C70h
  1974                                  ; 09/12/2022
  1975                                  DSKTBL equ dsktbl
  1976                                  
  1977                                  dsk_entry:				
  1978 0000065E E80200                  		call	cdev_entry
  1979                                  ; ----------------------------------------------------------------------------
  1980                                  		;dw 4A2h		; dsktbl
  1981 00000661 [6F05]                  		dw DSKTBL		; 09/12/2022
  1982                                  					; 2C7h:4A2h = 70h:2A12h
  1983                                  					; 02/10/2023 (PCDOS 7.1 IBMBIO.COM)
  1984                                  					; 364h:579h = 70h:34B9h
  1985                                  
  1986                                  ; =============== S U B	R O U T	I N E ========================================
  1987                                  
  1988                                  ;************************************************************************
  1989                                  ;*									*
  1990                                  ;*	Ensure A20 is enabled before jumping into code in HMA.		*
  1991                                  ;*	This code assumes that if Segment of Device request packet is	*
  1992                                  ;*	DOS DATA segment then the Device request came from DOS & that	*
  1993                                  ;*	A20 is already on.						*
  1994                                  ;*									*
  1995                                  ;************************************************************************
  1996                                  
  1997                                  cdev_entry:	; proc near		
  1998 00000663 2E803E[0D00]00          		cmp	byte [cs:inHMA],0
  1999 00000669 740D                    		jz	short ce_enter_codeseg
  2000                                  				; optimized for DOS in HMA
  2001 0000066B 50                      		push	ax
  2002 0000066C 2EA1[0300]              		mov	ax,[cs:DosDataSg]
  2003 00000670 2E3906[1400]            		cmp	[cs:ptrsav+2],ax
  2004 00000675 58                      		pop	ax
  2005 00000676 7505                    		jnz	short not_from_dos
  2006                                  				; jump is coded this way to fall thru
  2007                                  				; in 99.99% of the cases
  2008                                  ce_enter_codeseg:
  2009 00000678 2EFF2E[0206]            		jmp	far [cs:cdev]			
  2010                                  		;jmp	dword ptr cs:cdev
  2011                                  ;-----------------------------------------------------------------------------
  2012                                  
  2013                                  not_from_dos:				
  2014 0000067D E8AA00                  		call	EnsureA20On
  2015 00000680 EBF6                    		jmp	short ce_enter_codeseg
  2016                                  
  2017                                  ;************************************************************************
  2018                                  ;*									*
  2019                                  ;*	outchr - this is our int 29h handler. it writes the		*
  2020                                  ;*	   character in al on the display using int 10h ttywrite	*
  2021                                  ;*									*
  2022                                  ;************************************************************************
  2023                                  
  2024                                  	; 02/10/2023
  2025                                  	; PCDOS 7.1 IBMBIO.COM - BIOSDATA:0682h
  2026                                  outchr:					
  2027 00000682 50                      		push	ax		; int 29h handler
  2028 00000683 56                      		push	si
  2029 00000684 57                      		push	di
  2030 00000685 55                      		push	bp
  2031 00000686 53                      		push	bx
  2032                                  		;;;
  2033                                  		; 02/10/2023 - Retro DOS v5.0 (Modified POCDOS 7.1) 
  2034                                  		;mov	ah,0Eh
  2035                                  		;mov	bx,7
  2036                                  		;int	10h	; - VIDEO - WRITE CHARACTER AND	ADVANCE	CURSOR (TTY WRITE)
  2037                                  		;		; AL = character, BH = display page (alpha modes)
  2038                                  		;		; BL = foreground color	(graphics modes)
  2039                                  		; 02/10/2023
  2040                                  		;push	ds ; *
  2041 00000687 31DB                    		xor	bx,bx ; 0
  2042 00000689 2E381E[1208]            		cmp	[cs:IsWin386], bl ; (are we in) Windows ?
  2043 0000068E 7510                    		jnz	short win_outchr ; *
  2044 00000690 1E                      		push	ds ; *
  2045 00000691 8EDB                    		mov	ds,bx ; 0
  2046 00000693 B40E                    		mov	ah,0Eh
  2047 00000695 B307                    		mov	bl,7
  2048                                  		;jnz	short win_outchr ; Running on Windows
  2049 00000697 9C                      		pushf			; far call (simulate INT)	
  2050 00000698 FA                      		cli	; disable interrupts
  2051 00000699 FF1E4000                		call	far [40h]	; far call to INT 10h vector
  2052 0000069D 1F                      		pop	ds ; *
  2053 0000069E EB02                    		jmp	short outchr_ok
  2054                                  win_outchr:
  2055 000006A0 CD10                    		int	10h
  2056                                  outchr_ok:
  2057                                  		;pop	ds ; *
  2058                                  		;;;
  2059 000006A2 5B                      		pop	bx
  2060 000006A3 5D                      		pop	bp
  2061 000006A4 5F                      		pop	di
  2062 000006A5 5E                      		pop	si
  2063 000006A6 58                      		pop	ax
  2064 000006A7 CF                      		iret
  2065                                  
  2066                                  ;-----------------------------------------------------------------------------
  2067                                  
  2068                                  	; 02/10/2023 - Retro DOS v5.0
  2069                                  	; PCDOS 7.1 IBMBIO.COM - BIOSDATA:06A8h
  2070                                  
  2071 000006A8 50                      		db 50h ; P		; 'PCI' signature
  2072 000006A9 43                      		db 43h ; C
  2073 000006AA 49                      		db 49h ; I
  2074                                  
  2075 000006AB 00000000                Orig1A:		dd 0
  2076                                  
  2077                                  ; =============== S U B R O U T I N E =======================================
  2078                                  
  2079                                  	; 02/10/2023 - Retro DOS v5.0
  2080                                  	; PCDOS 7.1 IBMBIO.COM - BIOSDATA:06AFh
  2081                                  
  2082                                  Int1A:
  2083 000006AF 80FC04                  		cmp	ah,4		; (Y2K-fix)
  2084 000006B2 7405                    		je	short int1a_1	; Read the date from the computer's real-time clock
  2085 000006B4 2EFF2E[AB06]            		jmp	far [cs:Orig1A]
  2086                                  int1a_1:
  2087 000006B9 55                      		push	bp
  2088                                  int1a_2:
  2089 000006BA 89E5                    		mov	bp,sp
  2090 000006BC 55                      		push	bp
  2091 000006BD 9C                      		pushf
  2092 000006BE 2EFF1E[AB06]            		call	far [cs:Orig1A]
  2093 000006C3 7220                    		jc	short int1a_4
  2094                                  
  2095                                  		;cmp	cl,0		; Year (BCD)
  2096                                  		; 02/10/2023
  2097 000006C5 08C9                    		or	cl,cl
  2098 000006C7 7515                    		jnz	short int1a_3
  2099 000006C9 80FD19                  		cmp	ch,19h		; Century (BCD)
  2100 000006CC 7510                    		jne	short int1a_3
  2101 000006CE B520                    		mov	ch,20h
  2102 000006D0 B405                    		mov	ah,5		; Set the date on the computer's real-time clock
  2103 000006D2 51                        		push	cx
  2104 000006D3 52                      		push	dx		; dh = Month (BCD), dl = Day (BCD)
  2105 000006D4 9C                      		pushf
  2106 000006D5 2EFF1E[AB06]            		call	far [cs:Orig1A]
  2107 000006DA 5A                      		pop	dx
  2108 000006DB 59                      		pop	cx
  2109 000006DC 7207                    		jc	short int1a_4
  2110                                  int1a_3:
  2111 000006DE 5D                      		pop	bp
  2112 000006DF 806606FE                		and	byte [bp+6],0FEh ; clear carry flag
  2113 000006E3 EB05                                    jmp	short int1a_5
  2114                                  int1a_4:
  2115 000006E5 5D                      		pop	bp
  2116 000006E6 804E0601                		or	byte [bp+6],1	; set carry flag
  2117                                  int1a_5:
  2118 000006EA 5D                      		pop	bp
  2119 000006EB CF                      		iret
  2120                                  
  2121                                  		; 02/10/2023
  2122 000006EC 90                      		nop	; (not necessary, i have used this 'nop' to locate 'block13:'
  2123                                  			; at BIOSDATA:06EDh, just as in the original PCDOS 7.1 IBMBIO.COM)
  2124                                  	
  2125                                  ;-----------------------------------------------------------------------------
  2126                                  
  2127                                  ;************************************************************************
  2128                                  ;*									*
  2129                                  ;*	block13 - our int13 hooker					*
  2130                                  ;*									*
  2131                                  ;************************************************************************
  2132                                  
  2133                                  	; 02/10/2023 - Retro DOS v5.0
  2134                                  	; PCDOS 7.1 IBMBIO.COM - BIOSDATA:06EDh
  2135                                  
  2136                                  block13:				
  2137 000006ED 2E803E[0D00]00          		cmp	byte [cs:inHMA],0
  2138 000006F3 7403                    		jz	short skipa20
  2139                                  		
  2140                                  		;call	IsA20Off	; A20 Off?
  2141                                  		;jnz	short skipa20
  2142                                  		;call	EnableA20	; assure a20 enabled
  2143                                  		; 02/10/2023 -  Retro DOS v5.0 (Modified PCDOS 7.1)
  2144 000006F5 E83200                  		call	EnsureA20On	; assure a20 enabled
  2145                                  skipa20:				
  2146 000006F8 2E8C1E[1C00]            		mov	[cs:i13_ds],ds	; save caller's ds for call-through
  2147 000006FD 9C                      		pushf			; fake interrupt
  2148 000006FE 2EFF1E[0A06]            		call	far [cs:i13x]
  2149                                  		;call	dword ptr cs:i13x
  2150                                  					; call through Bios_Code entry table
  2151 00000703 2E8E1E[1C00]            		mov	ds,[cs:i13_ds]
  2152 00000708 CA0200                  		retf	2
  2153                                  
  2154                                  ; =============== S U B	R O U T	I N E =======================================
  2155                                  
  2156                                  ; the int13 hook calls back here to call-through to the ROM
  2157                                  ; this is necessary because some people have extended their
  2158                                  ; ROM BIOSs to use ds as a parameter/result register and
  2159                                  ; our int13 hook relies heavily on ds to access Bios_Data
  2160                                  
  2161                                  call_orig13:	; proc far		
  2162 0000070B 8E1E[1C00]              		mov	ds,[i13_ds]	; get caller's ds register
  2163 0000070F 9C                      		pushf			; simulate an int13
  2164 00000710 2EFF1E[B400]            		call	far [cs:Orig13]
  2165                                  		;call	cs:Orig13
  2166 00000715 2E8C1E[1C00]            		mov	[cs:i13_ds],ds
  2167 0000071A 0E                      		push	cs
  2168 0000071B 1F                      		pop	ds		; restore ds ->	Bios_Data before return
  2169                                  
  2170 0000071C 9C                      		pushf
  2171                                  		; 10/12/2022
  2172                                  		; ds = cs
  2173 0000071D 803E[0D00]00            		cmp	byte [inHMA],0	; 16/10/2022
  2174                                  		;cmp	byte [cs:inHMA],0
  2175 00000722 7403                    		jz	short corig13_popf_retf
  2176                                  		; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  2177                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:0725h	
  2178                                  		;call	IsA20Off
  2179                                  		;jnz	short corig13_popf_retf
  2180                                  		;call	EnableA20
  2181 00000724 E80300                  		call	EnsureA20On ; 07/08/2023
  2182                                  corig13_popf_retf:	
  2183 00000727 9D                      		popf
  2184                                  		; 20/09/2023
  2185                                  re_init:	; 07/08/2023
  2186 00000728 CB                      		retf
  2187                                  
  2188                                  		; 02/10/2023
  2189 00000729 90                      		nop	; (not necessary, i have used this 'nop' to locate 'EnsureA20On:'
  2190                                  			; at BIOSDATA:072Ah, just as in the original PCDOS 7.1 IBMBIO.COM)
  2191                                  
  2192                                  ;-----------------------------------------------------------------------------
  2193                                  
  2194                                  ; BIOSDATA:07BBh (MSDOS 6.21, IO.SYS)
  2195                                  ; BIOSDATA:07BBh (MSDOS 5.0, IO.SYS) ; 16/10/2022
  2196                                  
  2197                                  ; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  2198                                  ;HiMem:		dd 0FFFF0090h		
  2199                                  ;LoMem:		dd 80h
  2200                                  
  2201                                  ; ----------------------------------------------------------------------------			
  2202                                  
  2203                                  ; =============== S U B	R O U T	I N E ========================================
  2204                                  
  2205                                  
  2206                                  ;************************************************************************
  2207                                  ;*									*
  2208                                  ;*	EnsureA20On - ensure that a20 is enabled if we're running	*
  2209                                  ;*	  in the HMA before interrupt entry points into Bios_Code	*
  2210                                  ;*									*
  2211                                  ;************************************************************************
  2212                                  
  2213                                  EnsureA20On:	; proc near		
  2214 0000072A E80E00                  		call	IsA20Off
  2215                                  		;jz	short EnableA20
  2216                                  		;retn
  2217                                  		; 18/12/2022
  2218 0000072D 750B                    		jnz	short A20On_retn	
  2219                                  
  2220                                  ; =============== S U B	R O U T	I N E ========================================
  2221                                  
  2222                                  
  2223                                  EnableA20:	; proc near		
  2224 0000072F 50                      		push	ax
  2225 00000730 53                      		push	bx
  2226 00000731 B405                    		mov	ah,5	 ; local enable a20
  2227                                  		;call	cs:xms
  2228 00000733 2EFF1E[0E00]            		call	far [cs:xms] ; 16/10/2022
  2229 00000738 5B                      		pop	bx
  2230 00000739 58                      		pop	ax
  2231                                  A20On_retn:	; 18/12/2022	
  2232 0000073A C3                      		retn
  2233                                  
  2234                                  ; =============== S U B	R O U T	I N E ========================================
  2235                                  
  2236                                  
  2237                                  IsA20Off:	; proc near		
  2238 0000073B 1E                      		push	ds
  2239 0000073C 06                      		push	es
  2240 0000073D 51                      		push	cx
  2241 0000073E 56                      		push	si
  2242 0000073F 57                      		push	di
  2243                                  		; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  2244                                  		;lds	si,[cs:HiMem]
  2245                                  		;les	di,[cs:LoMem]
  2246                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:0740h
  2247 00000740 31FF                    		xor	di,di
  2248 00000742 8EC7                    		mov	es,di
  2249 00000744 4F                      		dec	di
  2250 00000745 BE9000                  		mov	si,90h	; 0FFFFh:0090h ; HiMem
  2251 00000748 8EDF                    		mov	ds,di
  2252 0000074A BF8000                  		mov	di,80h	; 0000h:0080h ; LoMem
  2253                                  		; 02/10/2023 - Retro DOS v5.0 IBMBIO.COM (PCDOS 7.1)
  2254                                  		; (following cpu instructions will be modified by 'SYSIN'
  2255                                  		; if the cpu is a 386/32bit, for checking A20 line faster) 
  2256                                  cpu386_cmpsd:
  2257 0000074D 90                      		nop
  2258 0000074E B90800                  		mov	cx,8
  2259 00000751 F3A7                    		repe cmpsw
  2260                                  				; zf = 0 -> A20 line is ON
  2261                                  				; zf = 1 -> A20 line is OFF
  2262 00000753 5F                      		pop	di
  2263 00000754 5E                      		pop	si
  2264 00000755 59                      		pop	cx
  2265 00000756 07                      		pop	es
  2266 00000757 1F                      		pop	ds
  2267 00000758 C3                      		retn
  2268                                  
  2269                                  ; ----------------------------------------------------------------------------
  2270                                  
  2271                                  ; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  2272                                  %if 0
  2273                                  DisableA20:
  2274                                  		push	ax
  2275                                  		push	bx
  2276                                  		mov	ah,6		; local disable A20
  2277                                  		call	far [cs:xms]
  2278                                  		;call	cs:xms
  2279                                  		pop	bx
  2280                                  		pop	ax
  2281                                  		retn
  2282                                  %endif
  2283                                  
  2284                                  ; ----------------------------------------------------------------------------
  2285                                  
  2286                                  ;************************************************************************
  2287                                  ;*									*
  2288                                  ;*	int19 - bootstrap interrupt -- we must restore a bunch of the	*
  2289                                  ;*	  interrupt vectors before resuming the original int19 code	*
  2290                                  ;*									*
  2291                                  ;************************************************************************
  2292                                  
  2293                                  		; 02/10/2023 - Retro DOS v5.0
  2294                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:0759h
  2295                                  int19:
  2296 00000759 0E                      		push	cs
  2297 0000075A 1F                      		pop	ds
  2298                                  		; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  2299                                  		;mov	es,[zeroseg]	; 16/10/2022
  2300                                  		;mov	cx,5		; NUMROMVECTORS
  2301 0000075B 31C9                    		xor	cx,cx
  2302 0000075D 8EC1                    		mov	es,cx
  2303 0000075F B105                    		mov	cl,5
  2304                                  		;mov	si,offset RomVectors
  2305 00000761 BE[0001]                		mov	si,RomVectors	; 19/10/2022
  2306                                  next_int:				
  2307 00000764 AC                      		lodsb			; get int number
  2308 00000765 98                      		cbw			; assume < 128
  2309 00000766 D1E0                    		shl	ax,1
  2310 00000768 D1E0                    		shl	ax,1		; int *	4
  2311                                  		; 07/08/2023
  2312                                  		;mov	di,ax
  2313                                  		;lodsw
  2314                                  		;stosw
  2315                                  		;lodsw
  2316                                  		;stosw			; install the saved vector
  2317                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:076Ah
  2318 0000076A 97                      		xchg	ax,di
  2319 0000076B A5                      		movsw
  2320 0000076C A5                      		movsw
  2321 0000076D E2F5                    		loop	next_int
  2322                                  		;cmp	byte [int19sem], 0 ; 19/10/2022
  2323 0000076F 380E[B105]              		cmp	[int19sem], cl ; 0 ; 07/08/2023
  2324 00000773 7419                    		jz	short doint19
  2325 00000775 BE[B205]                		mov	si,i19_lst	; stacks code has changed these hardware interrupt vectors
  2326                                  					; stkinit in sysinit1 will initialize int19oldxx values
  2327                                  		;mov	cx,14		; num_i19
  2328                                  		; 07/08/2023
  2329 00000778 B10E                    		mov	cl,14	
  2330                                  i19_restore_loop:			
  2331 0000077A AC                      		lodsb			; get interrupt	number
  2332 0000077B 98                      		cbw			; assume < 128
  2333                                  		;mov	di,ax
  2334                                  		;lodsw			; get original vector offset
  2335                                  		;mov	bx,ax		; save it
  2336                                  		;lodsw
  2337                                  		; 07/08/2023
  2338 0000077C 97                      		xchg	ax,di
  2339 0000077D AD                      		lodsw
  2340 0000077E 93                      		xchg	ax,bx
  2341 0000077F AD                      		lodsw
  2342                                  		;cmp	bx,0FFFFh	; check	for 0ffffh (unlikely segment)
  2343 00000780 43                      		inc	bx ; 07/08/2023
  2344 00000781 7409                    		jz	short i19_restor_1 ; opt no need to check selector too
  2345                                  		;cmp	ax,0FFFFh	; opt 0ffffh is	unlikely offset
  2346                                  		;jz	short i19_restor_1
  2347 00000783 4B                      		dec	bx ; 07/08/2023
  2348 00000784 01FF                    		add	di,di
  2349 00000786 01FF                    		add	di,di
  2350 00000788 93                      		xchg	ax,bx
  2351 00000789 AB                      		stosw
  2352 0000078A 93                      		xchg	ax,bx
  2353 0000078B AB                      		stosw			; put the vector back
  2354                                  
  2355                                  i19_restor_1:				
  2356 0000078C E2EC                    		loop	i19_restore_loop
  2357                                  
  2358                                  doint19:				
  2359                                  		;cmp	byte [inHMA],0	; ; Is dos running from	HMA
  2360 0000078E 380E[0D00]              		cmp	[inHMA],cl ; 0	; 07/08/2023
  2361 00000792 7403                    		jz	short SkipVDisk
  2362 00000794 E82A00                  		call	EraseVDiskHead	; Then erase our VDISK header at 1MB boundary
  2363                                  					; Some m/c's (AST 386 & HP QS/16 do not clear
  2364                                  					; the memory above 1MB during a	warm boot.
  2365                                  SkipVDisk:				
  2366 00000797 CD19                    		int	19h		; DISK BOOT
  2367                                  					; causes reboot	of disk	system
  2368                                  
  2369                                  ; =============== S U B	R O U T	I N E ========================================
  2370                                  
  2371                                  ;-----------------------------------------------------------------------------
  2372                                  ;
  2373                                  ; procedure : int15
  2374                                  ;
  2375                                  ;		Int15 handler for recognizing ctrl-alt-del seq
  2376                                  ;		If it recognizes ctrl-alt-del and if DOS was
  2377                                  ;		is running high, it Erases the VDISK header
  2378                                  ;		present at 1MB boundary
  2379                                  ;
  2380                                  ;-----------------------------------------------------------------------------
  2381                                  
  2382                                  ; 16/10/2022
  2383                                  ;DELKEY		equ	53h
  2384                                  ;ROMDATASEG	equ	40h
  2385                                  KBFLAG		equ	17h
  2386                                  ;CTRLSTATE	equ	04h
  2387                                  ;ALTSTATE	equ	08h
  2388                                  
  2389                                  		; 02/10/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  2390                                  Int15:		
  2391                                  		;cmp	ax,4F00h+DELKEY
  2392 00000799 3D534F                  		cmp	ax,4F53h	; del keystroke ?
  2393                                  		; 02/10/2023 - Retro DOS v5.0
  2394                                  		; 07/08/2023
  2395 0000079C 7405                    		jz	short int15_1
  2396                                  		;jnz	short Old15_j	; 07/08/2023 
  2397                                  Old15_j:
  2398 0000079E 2EFF2E[0B01]            		jmp	far [cs:Old15]	; 16/10/2022
  2399                                  
  2400                                  ; ----------------------------------------------------------------------------
  2401                                  int15_1:				
  2402 000007A3 1E                      		push	ds
  2403 000007A4 50                      		push	ax
  2404                                  		; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  2405                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:07A5h
  2406                                  		;mov	ax,40h		; ROMDATASEG
  2407                                  		;mov	ds,ax
  2408                                  		;;mov	al,ds:17h	; [KBFLAG]
  2409                                  		;; 16/10/2022
  2410                                  		;mov	al,[KBFLAG]
  2411 000007A5 31C0                    		xor	ax,ax
  2412 000007A7 8ED8                    		mov	ds,ax
  2413 000007A9 A01704                  		mov	al,[0417h]	; KBFLAG = 0417h (PCDOS 7.1 IBMBIO.COM)
  2414 000007AC 240C                    		and	al,0Ch		; (CTRLSTATE | ALTSTATE)
  2415 000007AE 3C0C                    		cmp	al,0Ch		; (CTRLSTATE | ALTSTATE)
  2416 000007B0 750A                    		jnz	short int15_2
  2417                                  		; 07/08/2023
  2418                                  		;push	cs
  2419                                  		;pop	ds
  2420                                  		;cmp	byte [inHMA],0	; is DOS running from HMA
  2421 000007B2 2E3826[0D00]            		cmp	byte [cs:inHMA],ah ; 0
  2422 000007B7 7403                    		jz	short int15_2
  2423 000007B9 E80500                  		call	EraseVDiskHead
  2424                                  int15_2:				
  2425 000007BC 58                      		pop	ax
  2426 000007BD 1F                      		pop	ds
  2427 000007BE F9                      		stc
  2428                                  		; 02/10/2023 - Retro DOS v5.0
  2429 000007BF EBDD                    		jmp	short Old15_j
  2430                                  
  2431                                  		; 02/10/2023
  2432                                  ;Old15_j:	; 07/08/2023
  2433                                  ;		jmp	far [cs:Old15]	; 16/10/2022
  2434                                  ;		;jmp	cs:Old15
  2435                                  	
  2436                                  ; =============== S U B	R O U T	I N E ========================================
  2437                                  
  2438                                  ;-----------------------------------------------------------------------------
  2439                                  ;
  2440                                  ; procedure : EraseVDiskHead
  2441                                  ;
  2442                                  ;		Erases the VDisk Header present in the 1MB boundary
  2443                                  ;
  2444                                  ;-----------------------------------------------------------------------------
  2445                                  
  2446                                  EraseVDiskHead:	; proc near
  2447                                  		; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  2448                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:07C1h
  2449                                  		;push	ax
  2450 000007C1 51                      		push	cx
  2451 000007C2 57                      		push	di
  2452 000007C3 06                      		push	es
  2453 000007C4 E863FF                  		call	EnsureA20On
  2454                                  		;mov	ax,0FFFFh	; HMA seg
  2455                                  		;mov	es,ax
  2456                                  		; 03/10/2023 - Retro DOS v5.0
  2457 000007C7 6AFF                    		push	0FFFFh
  2458 000007C9 07                      		pop	es
  2459 000007CA BF1000                  		mov	di,10h		; point	to VDISK header
  2460                                  		; 07/08/2023
  2461                                  		;mov	cx,10h		; size of vdisk	header
  2462 000007CD 89F9                    		mov	cx,di ; 16
  2463                                  		; 03/10/2023
  2464 000007CF 31C0                    		xor	ax,ax
  2465                                  		;inc	ax ; ax = 0
  2466 000007D1 F3AB                    		rep stosw		; clear	it
  2467 000007D3 07                      		pop	es
  2468 000007D4 5F                      		pop	di
  2469 000007D5 59                      		pop	cx
  2470                                  		;pop	ax ; 07/08/2023
  2471 000007D6 C3                      		retn
  2472                                  
  2473                                  ; ----------------------------------------------------------------------------
  2474                                  
  2475                                  ; 03/10/2023 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
  2476                                  ; 17/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
  2477                                  
  2478                                  ; 09/12/2022
  2479                                  ;SYSINITSEG	equ 46Dh  ; SYSINIT segment
  2480                                  ;DOSLOADSEG	equ 83Fh  ; MSDOS.SYS (kernel) loading segment		
  2481                                  ; (followings are in sysinit segment)
  2482                                  ;FTryToMovDOSHi	equ 0A84h ; (procedure in SYSINIT segment)
  2483                                  FTRYTOMOVDOSHI	equ FTryToMovDOSHi ; SYSINIT section
  2484                                  ;DEVICELIST	equ 273h
  2485                                  DEVICELIST	equ DEVICE_LIST	; SYSINIT section 	
  2486                                  ;MEMORYSIZE	equ 292h	
  2487                                  MEMORYSIZE	equ MEMORY_SIZE	; SYSINIT section
  2488                                  ;DEFAULTDRIVE	equ 296h
  2489                                  DEFAULTDRIVE	equ DEFAULT_DRIVE ; SYSINIT section
  2490                                  ;;currentdoslocation equ 271h
  2491                                  ;CURRENTDOSLOCATION equ 271h
  2492                                  CURRENTDOSLOCATION equ CURRENT_DOS_LOCATION  ; SYSINIT section
  2493                                  ;SYSINITSTART	equ 267h
  2494                                  SYSINITSTART	equ SYSINIT  ; SYSINIT section
  2495                                  ; 18/10/2022
  2496                                  ;toomanydrivesflag equ 3FFh 
  2497                                  TOOMANYDRIVESFLAG equ toomanydrivesflag ; SYSINIT section	
  2498                                  
  2499                                  ; ----------------------------------------------------------------------------
  2500                                  
  2501                                  ; 03/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  2502                                  ; PCDOS 7.1 IBMBIO.COM - BIOSDATA:07D7h
  2503                                  
  2504                                  %if 1
  2505                                  
  2506 000007D7 FFFF                    FreeHMAPtr:	dw 0FFFFh		
  2507                                  ;MoveDOSIntoHMA: dd 46D0A84h 		; FTryToMovDOSHi
  2508                                  					; (procedure in	SYSINIT	segment)
  2509                                  ; 17/10/2022
  2510 000007D9 [AE0A]                  MoveDOSIntoHMA:	dw FTRYTOMOVDOSHI	; 09/12/2022
  2511 000007DB D704                    		dw SYSINITSEG		; 08/08/2023
  2512                                  					; 0544h for PCDOS 7.1 IBMBIO.COM
  2513                                  					; 0473h for MSDOS 6.21 IO.SYS
  2514                                  ;SR;
  2515                                  ; A communication block has been setup between the DOS and the BIOS. All
  2516                                  ;the data starting from SysinitPresent will be part of the data block. 
  2517                                  ;Right now, this is the only data being communicated. It can be expanded 
  2518                                  ;later to add more stuff
  2519                                  
  2520 000007DD 00                      SysinitPresent:	db 0
  2521                                  
  2522                                  %endif
  2523                                  
  2524                                  ; ----------------------------------------------------------------------------
  2525                                  
  2526                                  ;************************************************************************
  2527                                  ;*									*
  2528                                  ;*	the int2f handler chains up to Bios_Code through here.		*
  2529                                  ;*	  it returns through one of the three functions that follow.	*
  2530                                  ;*	  notice that we'll assume we're being entered from DOS, so	*
  2531                                  ;*	  that we're guaranteed to be A20 enabled if needed		*
  2532                                  ;*									*
  2533                                  ;************************************************************************
  2534                                  
  2535                                  ; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  2536                                  %if 0	; 20/09/2023
  2537                                  int_2f:		
  2538                                  		jmp	far [cs:bcode_i2f] ; 16/10/2022
  2539                                  		;jmp	dword ptr cs:bcode_i2f ; far [cs:bcode_i2f]
  2540                                  
  2541                                  ; ----------------------------------------------------------------------------
  2542                                  
  2543                                  ; re-enter here to transition out of hma mode and jmp to dsk_entry
  2544                                  ; note:  is it really necessary to transiton out and then back in?
  2545                                  ;	 It's not as if this is a really speed critical function.
  2546                                  ;	 might as well do whatever's most compact.
  2547                                  
  2548                                  i2f_dskentry:
  2549                                  		jmp	dsk_entry
  2550                                  
  2551                                  ; ----------------------------------------------------------------------------
  2552                                  
  2553                                  ;************************************************************************
  2554                                  ;*									*
  2555                                  ;*	re_init - called back by sysinit after a bunch of stuff		*
  2556                                  ;*		is done. presently does nothing. affects no		*
  2557                                  ;*		registers!						*
  2558                                  ;*									*
  2559                                  ;************************************************************************
  2560                                  
  2561                                  ; 09/12/2022
  2562                                  ; re_init_:
  2563                                  re_init:				; called back by sysinit after
  2564                                  		retf			; a bunch of stuff is done.
  2565                                  					; presently does nothing
  2566                                  %endif
  2567                                  
  2568                                  ; ----------------------------------------------------------------------------
  2569                                  
  2570                                  ;SR; WIN386 support
  2571                                  
  2572                                  ; WIN386 instance data structure
  2573                                  ;
  2574                                  ; Here is a Win386 startup info structure which we set up and to which
  2575                                  ; we return a pointer when Win386 initializes.
  2576                                  
  2577 000007DE 0300                    Win386_SI:	db 3,0			; SI_Version
  2578                                  					; Startup Info for Win386
  2579 000007E0 00000000                SI_Next:	dd 0			; pointer to next info structure
  2580 000007E4 00000000                		dd 0			; a field we don't need
  2581 000007E8 00000000                		dd 0			; another field	we don't need
  2582 000007EC [F007]                  SI_Instance:	dw Instance_Table
  2583 000007EE 7000                    		dw 70h	; Bios_Data	; far pointer to instance table
  2584                                  
  2585                                  ; This table gives Win386 the instance data in the BIOS and ROM-BIOS data
  2586                                  ; areas. Note that the address and size of the hardware stacks must
  2587                                  ; be calculated and inserted at boot time.
  2588                                  
  2589 000007F0 00005000                Instance_Table:	dw 0,50h		; print	screen status...
  2590 000007F4 0200                    		dw 2			; ... 2	bytes
  2591 000007F6 0E005000                		dw 0Eh,50h		; ROM Basic data...
  2592 000007FA 1400                    		dw 14h			; ... 14H bytes
  2593 000007FC [0C00]                  		dw altah		; a con	device buffer...
  2594 000007FE 7000                    		dw 70h			; Bios_Data segment
  2595 00000800 0100                    		dw 1			; ... 1 byte
  2596                                  
  2597                                  NextStack:
  2598                                  
  2599                                  ; NOTE:  If stacks are disabled by STACKS=0,0, the following
  2600                                  ;	instance items WILL NOT be filled in by SYSINIT.
  2601                                  ;	That's just fine as long as these are the last items
  2602                                  ;	in the instance list since the first item is initialized
  2603                                  ;	to 0000 at load time.
  2604                                  
  2605 00000802 00000000                		dw 0,0			; pointer to next stack	to be used...
  2606 00000806 0200                    		dw 2			; ... 2 bytes
  2607 00000808 00000000                IT_StackLoc:	dd 0			; location of hardware stacks
  2608 0000080C 0000                    IT_StackSize:	dw 0			; size of hardware stacks
  2609 0000080E 00000000                		dd 0			; terminate the	instance table
  2610                                  
  2611                                  					;SR;
  2612 00000812 00                      IsWin386:	db 0			; Flag to indicate whether
  2613                                  					; Win386 is running or not
  2614                                  ;-----------------------------------------------------------------------------
  2615                                  
  2616                                  ;This routine was originally in BIOS_CODE but this causes a lot of problems
  2617                                  ;when we call it including checking of A20. The code being only about 
  2618                                  ;30 bytes, we might as well put it in BIOS_DATA
  2619                                  
  2620                                  V86_Crit_SetFocus:			
  2621 00000813 57                      		push	di
  2622 00000814 06                      		push	es
  2623 00000815 53                      		push	bx
  2624 00000816 50                      		push	ax
  2625 00000817 31FF                    		xor	di,di
  2626 00000819 8EC7                    		mov	es,di
  2627 0000081B BB1500                  		mov	bx,15h		; Device ID of DOSMGR device
  2628 0000081E B88416                  		mov	ax,1684h	; Get API entry	point
  2629 00000821 CD2F                    		int	2Fh		; - Multiplex -	MS WINDOWS - GET DEVICE	API ENTRY POINT
  2630                                  					; BX = virtual device (VxD) ID,	ES:DI =	0000h:0000h
  2631                                  					; Return: ES:DI	-> VxD API entry point,	or 0:0 if the VxD does not support an API
  2632 00000823 8CC0                    		mov	ax, es
  2633 00000825 09F8                    		or	ax, di
  2634 00000827 740A                    		jz	short Skip	; Here,	es:di is address of API	routine.
  2635                                  					; Set up stack frame to	simulate a call.
  2636 00000829 0E                      		push	cs
  2637                                  		;;mov	ax,offset Skip
  2638                                  		;mov	ax,Skip
  2639                                  		;push	ax
  2640                                  		; 03/10/2023 - Retro DOS v5.0
  2641 0000082A 68[3308]                		push	Skip
  2642 0000082D 06                      		push	es
  2643 0000082E 57                      		push	di		; API far call address
  2644 0000082F B80100                  		mov	ax,1		; SetFocus function number
  2645 00000832 CB                      		retf			; do the call
  2646                                  ;-----------------------------------------------------------------------------
  2647                                  
  2648                                  Skip:					
  2649 00000833 58                      		pop	ax
  2650 00000834 5B                      		pop	bx
  2651 00000835 07                      		pop	es
  2652 00000836 5F                      		pop	di
  2653 00000837 CB                      		retf
  2654                                  
  2655                                  ;End WIN386 support
  2656                                  
  2657                                  ; ----------------------------------------------------------------------------
  2658                                  
  2659                                  ; 03/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  2660                                  %if 0
  2661                                  
  2662                                  FreeHMAPtr:	dw 0FFFFh		
  2663                                  ;MoveDOSIntoHMA: dd 46D0A84h 		; FTryToMovDOSHi
  2664                                  					; (procedure in	SYSINIT	segment)
  2665                                  ; 17/10/2022
  2666                                  MoveDOSIntoHMA:	dw FTRYTOMOVDOSHI	; 09/12/2022
  2667                                  		dw SYSINITSEG		; 08/08/2023
  2668                                  					; 0544h for PCDOS 7.1 IBMBIO.COM
  2669                                  					; 0473h for MSDOS 6.21 IO.SYS
  2670                                  ;SR;
  2671                                  ; A communication block has been setup between the DOS and the BIOS. All
  2672                                  ;the data starting from SysinitPresent will be part of the data block. 
  2673                                  ;Right now, this is the only data being communicated. It can be expanded 
  2674                                  ;later to add more stuff
  2675                                  
  2676                                  SysinitPresent:	db 0
  2677                                  		
  2678                                  endfloppy:	db 0, 0
  2679                                  
  2680                                  %endif
  2681                                  	
  2682                                  	; 03/10/2023 - Retro DOS v5.0 IBMBIO.COM
  2683                                  
  2684                                  	endfloppy:
  2685 00000838 00                      		db 0
  2686                                  
  2687                                  	; 03/10/2023
  2688                                  
  2689                                  numxdiv	equ ($-BData_start)
  2690                                  numxmod	equ (numxdiv % 16)
  2691                                  
  2692                                  %if (numxmod>0) & (numxmod<16)
  2693 00000839 00<rep 7h>              		times (16-numxmod) db 0
  2694                                  %endif
  2695                                  
  2696                                  ; ----------------------------------------------------------------------------			
  2697                                  
  2698                                  ; Bios_Data ends
  2699                                  	
  2700                                  ; Possibly disposable BIOS data
  2701                                  ; This data follows the	regular	BIOS data,
  2702                                  ; and is part of the same group.
  2703                                  
  2704                                  ; 03/10/2023 - Retro DOS v5.0 IBMBIO.COM
  2705                                  ;nul_vid:	db 'NO NAME    ',0      
  2706                                  					; null volume id
  2707                                  ;tmp_vid:	db 'NO NAME    ',0      
  2708                                  					; vid scratch buffer
  2709                                  ; 03/10/2023
  2710 00000840 4E4F204E414D452020-     tmp_vid:	db 'NO NAME    '
  2710 00000849 2020               
  2711                                  
  2712 0000084B 80                      harddrv:	db 80h			
  2713                                  
  2714                                  end96tpi:
  2715                                  
  2716                                  ; 03/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  2717                                  ; PCDOS 7.1 IBMBIO.COM - BIOSDATA:084Ch ('bdss:' address)
  2718                                  
  2719                                  ;;*********************************************************************
  2720                                  ;;memory allocation for bdss
  2721                                  ;;*********************************************************************
  2722                                  ;
  2723                                  ;;max_mini_dsk_num equ 23	; max # of mini disk ibmbio can support
  2724                                  ;
  2725                                  ;;bdss	BDS_STRUC (2+max_mini_dsk_num) dup (<>)	; currently max. 25
  2726                                  ;
  2727                                  ;bdss:	times BDS.size*(2+max_mini_dsk_num) db 0
  2728                                  
  2729                                  ; 14/10/2023
  2730                                  
  2731 0000084C FFFF                    bdss:		dw 0FFFFh	; max_mini_dsk_num equ 23
  2732                                  				; BDS_STRUC (2+max_mini_dsk_num) dup (<>)
  2733                                  				; currently max. 25
  2734                                  				; (MSDOS 6 BDS structure size = 100 bytes)
  2735                                  				; (PCDOS 7.1 BDS structure size = 150 bytes)
  2736                                  				; BDS.link
  2737 0000084E 0000                    		dw 0
  2738 00000850 50                      		db 80		; BDS.drivenum
  2739 00000851 03                      		db 3		; BDS.drivelet
  2740 00000852 0002                    		dw 512		; BDS.BPB (BDS offset 6)
  2741                                  				; 53 bytes BPB for FAT32 fs
  2742                                  				; 25 bytes BPB for FAT16 and FAT12 fs
  2743                                  				; .bytespersec
  2744 00000854 01                      		db 1		; .secperclus
  2745 00000855 0100                    		dw 1		; .resectors
  2746 00000857 02                      		db 2		; .fats
  2747 00000858 1000                    		dw 16		; .direntries
  2748 0000085A 0000                    		dw 0		; .totalsec16
  2749 0000085C F8                      		db 0F8h		; .media
  2750 0000085D 0100                    		dw 1		; .fatsecs16
  2751 0000085F 0000                    		dw 0		; .secpertrack
  2752 00000861 0000                    		dw 0		; .heads
  2753 00000863 00000000                		dd 0		; .hiddensectors
  2754 00000867 00000000                		dd 0		; .totalsecs32
  2755                                  				; (End of FAT12/FAT16 BPB)
  2756                                  				;
  2757                                  				; FAT32 extensions to BDS
  2758 0000086B 00000000                		dd 0		; .fatsecs32 ; BPB_FATSz32 (BDS offset 31)
  2759 0000086F 0000                    		dw 0		; .extflags ; BPB_ExtFlags
  2760 00000871 0000                    		dw 0		; .fsver ; BPB_FSVer
  2761 00000873 00000000                		dd 0		; .rootdirclust ; BPB_RootClus (BDS offset 39)
  2762 00000877 FFFF                    		dw 0FFFFh	; .fsinfo ; BPB_FSInfo ; initialized to -1
  2763 00000879 FFFF                    		dw 0FFFFh	; .bkbootsec ; BPB_BkBootSec ; initialized to -1
  2764 0000087B 000000000000000000-     		db 12 dup(0)	; .reserved ; BPB_Reserved (12 zero bytes)
  2764 00000884 000000             
  2765 00000887 00                      		db 0		; BDS.fatsiz (BDS offset 59)
  2766 00000888 0000                    		dw 0		; BDS.opcnt
  2767 0000088A 03                      		db 3
  2768 0000088B 2000                    		dw 20h		; BDS.flags (BDS offset 63)
  2769 0000088D 2800                    		dw 40
  2770 0000088F 000000000000000000-     		db 37 dup(0)
  2770 00000898 000000000000000000-
  2770 000008A1 000000000000000000-
  2770 000008AA 000000000000000000-
  2770 000008B3 00                 
  2771 000008B4 FFFFFFFF                		dd 0FFFFFFFFh
  2772 000008B8 000000000000000000-     		db 12 dup(0)
  2772 000008C1 000000             
  2773 000008C4 FF                      		db -1		; BDS.track (BDS offset 120)
  2774 000008C5 0100                    		dw 1		; BDS.tim_lo ; BDS.bdsm_ismini
  2775 000008C7 0000                    		dw 0		; BDS.tim_hi
  2776 000008C9 4E4F204E414D452020-     		db 'NO NAME    ',0	; BDS.volid
  2776 000008D2 202000             
  2777 000008D5 00000000                		dd 0		  	; BDS.vol_serial (BDS offset 137)
  2778 000008D9 464154313220202000      		db 'FAT12   ',0		; BDS.filesys_id
  2779                                  
  2780 000008E2 FFFF                    bds_1:		dw 0FFFFh
  2781 000008E4 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2781 000008ED 0210000000F8       
  2782 000008F3 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2782 000008FC 000000000000000000 
  2783 00000905 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2783 0000090E FFFFFF0000         
  2784 00000913 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2784 0000091C 0000000003200028   
  2785 00000924 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2785 0000092D 000000000000000000 
  2786 00000936 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2786 0000093F 000000000000000000 
  2787 00000948 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2787 00000951 0000000000         
  2788 00000956 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2788 0000095F 4E4F204E41         
  2789 00000964 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2789 0000096D 00004641           
  2790 00000971 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2791                                  
  2792 00000978 FFFF                    bds_2:		dw 0FFFFh
  2793 0000097A 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2793 00000983 0210000000F8       
  2794 00000989 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2794 00000992 000000000000000000 
  2795 0000099B 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2795 000009A4 FFFFFF0000         
  2796 000009A9 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2796 000009B2 0000000003200028   
  2797 000009BA 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2797 000009C3 000000000000000000 
  2798 000009CC 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2798 000009D5 000000000000000000 
  2799 000009DE 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2799 000009E7 0000000000         
  2800 000009EC 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2800 000009F5 4E4F204E41         
  2801 000009FA 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2801 00000A03 00004641           
  2802 00000A07 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2803                                  
  2804 00000A0E FFFF                    bds_3:		dw 0FFFFh
  2805 00000A10 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2805 00000A19 0210000000F8       
  2806 00000A1F 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2806 00000A28 000000000000000000 
  2807 00000A31 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2807 00000A3A FFFFFF0000         
  2808 00000A3F 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2808 00000A48 0000000003200028   
  2809 00000A50 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2809 00000A59 000000000000000000 
  2810 00000A62 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2810 00000A6B 000000000000000000 
  2811 00000A74 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2811 00000A7D 0000000000         
  2812 00000A82 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2812 00000A8B 4E4F204E41         
  2813 00000A90 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2813 00000A99 00004641           
  2814 00000A9D 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2815                                  
  2816 00000AA4 FFFF                    bds_4:		dw 0FFFFh
  2817 00000AA6 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2817 00000AAF 0210000000F8       
  2818 00000AB5 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2818 00000ABE 000000000000000000 
  2819 00000AC7 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2819 00000AD0 FFFFFF0000         
  2820 00000AD5 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2820 00000ADE 0000000003200028   
  2821 00000AE6 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2821 00000AEF 000000000000000000 
  2822 00000AF8 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2822 00000B01 000000000000000000 
  2823 00000B0A 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2823 00000B13 0000000000         
  2824 00000B18 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2824 00000B21 4E4F204E41         
  2825 00000B26 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2825 00000B2F 00004641           
  2826 00000B33 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2827                                  
  2828 00000B3A FFFF                    		dw 0FFFFh
  2829 00000B3C 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2829 00000B45 0210000000F8       
  2830 00000B4B 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2830 00000B54 000000000000000000 
  2831 00000B5D 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2831 00000B66 FFFFFF0000         
  2832 00000B6B 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2832 00000B74 0000000003200028   
  2833 00000B7C 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2833 00000B85 000000000000000000 
  2834 00000B8E 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2834 00000B97 000000000000000000 
  2835 00000BA0 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2835 00000BA9 0000000000         
  2836 00000BAE 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2836 00000BB7 4E4F204E41         
  2837 00000BBC 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2837 00000BC5 00004641           
  2838 00000BC9 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2839                                  
  2840 00000BD0 FFFF                    		dw 0FFFFh
  2841 00000BD2 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2841 00000BDB 0210000000F8       
  2842 00000BE1 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2842 00000BEA 000000000000000000 
  2843 00000BF3 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2843 00000BFC FFFFFF0000         
  2844 00000C01 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2844 00000C0A 0000000003200028   
  2845 00000C12 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2845 00000C1B 000000000000000000 
  2846 00000C24 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2846 00000C2D 000000000000000000 
  2847 00000C36 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2847 00000C3F 0000000000         
  2848 00000C44 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2848 00000C4D 4E4F204E41         
  2849 00000C52 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2849 00000C5B 00004641           
  2850 00000C5F 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2851                                  
  2852 00000C66 FFFF                    		dw 0FFFFh
  2853 00000C68 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2853 00000C71 0210000000F8       
  2854 00000C77 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2854 00000C80 000000000000000000 
  2855 00000C89 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2855 00000C92 FFFFFF0000         
  2856 00000C97 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2856 00000CA0 0000000003200028   
  2857 00000CA8 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2857 00000CB1 000000000000000000 
  2858 00000CBA 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2858 00000CC3 000000000000000000 
  2859 00000CCC 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2859 00000CD5 0000000000         
  2860 00000CDA 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2860 00000CE3 4E4F204E41         
  2861 00000CE8 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2861 00000CF1 00004641           
  2862 00000CF5 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2863                                  
  2864 00000CFC FFFF                    		dw 0FFFFh
  2865 00000CFE 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2865 00000D07 0210000000F8       
  2866 00000D0D 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2866 00000D16 000000000000000000 
  2867 00000D1F 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2867 00000D28 FFFFFF0000         
  2868 00000D2D 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2868 00000D36 0000000003200028   
  2869 00000D3E 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2869 00000D47 000000000000000000 
  2870 00000D50 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2870 00000D59 000000000000000000 
  2871 00000D62 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2871 00000D6B 0000000000         
  2872 00000D70 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2872 00000D79 4E4F204E41         
  2873 00000D7E 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2873 00000D87 00004641           
  2874 00000D8B 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2875                                  
  2876 00000D92 FFFF                    		dw 0FFFFh
  2877 00000D94 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2877 00000D9D 0210000000F8       
  2878 00000DA3 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2878 00000DAC 000000000000000000 
  2879 00000DB5 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2879 00000DBE FFFFFF0000         
  2880 00000DC3 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2880 00000DCC 0000000003200028   
  2881 00000DD4 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2881 00000DDD 000000000000000000 
  2882 00000DE6 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2882 00000DEF 000000000000000000 
  2883 00000DF8 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2883 00000E01 0000000000         
  2884 00000E06 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2884 00000E0F 4E4F204E41         
  2885 00000E14 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2885 00000E1D 00004641           
  2886 00000E21 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2887                                  
  2888 00000E28 FFFF                    		dw 0FFFFh
  2889 00000E2A 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2889 00000E33 0210000000F8       
  2890 00000E39 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2890 00000E42 000000000000000000 
  2891 00000E4B 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2891 00000E54 FFFFFF0000         
  2892 00000E59 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2892 00000E62 0000000003200028   
  2893 00000E6A 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2893 00000E73 000000000000000000 
  2894 00000E7C 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2894 00000E85 000000000000000000 
  2895 00000E8E 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2895 00000E97 0000000000         
  2896 00000E9C 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2896 00000EA5 4E4F204E41         
  2897 00000EAA 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2897 00000EB3 00004641           
  2898 00000EB7 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2899                                  
  2900 00000EBE FFFF                    		dw 0FFFFh
  2901 00000EC0 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2901 00000EC9 0210000000F8       
  2902 00000ECF 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2902 00000ED8 000000000000000000 
  2903 00000EE1 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2903 00000EEA FFFFFF0000         
  2904 00000EEF 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2904 00000EF8 0000000003200028   
  2905 00000F00 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2905 00000F09 000000000000000000 
  2906 00000F12 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2906 00000F1B 000000000000000000 
  2907 00000F24 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2907 00000F2D 0000000000         
  2908 00000F32 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2908 00000F3B 4E4F204E41         
  2909 00000F40 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2909 00000F49 00004641           
  2910 00000F4D 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2911 00000F54 FFFF                    		dw 0FFFFh
  2912 00000F56 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2912 00000F5F 0210000000F8       
  2913 00000F65 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2913 00000F6E 000000000000000000 
  2914 00000F77 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2914 00000F80 FFFFFF0000         
  2915 00000F85 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2915 00000F8E 0000000003200028   
  2916 00000F96 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2916 00000F9F 000000000000000000 
  2917 00000FA8 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2917 00000FB1 000000000000000000 
  2918 00000FBA 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2918 00000FC3 0000000000         
  2919 00000FC8 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2919 00000FD1 4E4F204E41         
  2920 00000FD6 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2920 00000FDF 00004641           
  2921 00000FE3 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2922                                  
  2923 00000FEA FFFF                    		dw 0FFFFh
  2924 00000FEC 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2924 00000FF5 0210000000F8       
  2925 00000FFB 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2925 00001004 000000000000000000 
  2926 0000100D 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2926 00001016 FFFFFF0000         
  2927 0000101B 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2927 00001024 0000000003200028   
  2928 0000102C 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2928 00001035 000000000000000000 
  2929 0000103E 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2929 00001047 000000000000000000 
  2930 00001050 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2930 00001059 0000000000         
  2931 0000105E 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2931 00001067 4E4F204E41         
  2932 0000106C 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2932 00001075 00004641           
  2933 00001079 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2934                                  
  2935 00001080 FFFF                    		dw 0FFFFh
  2936 00001082 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2936 0000108B 0210000000F8       
  2937 00001091 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2937 0000109A 000000000000000000 
  2938 000010A3 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2938 000010AC FFFFFF0000         
  2939 000010B1 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2939 000010BA 0000000003200028   
  2940 000010C2 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2940 000010CB 000000000000000000 
  2941 000010D4 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2941 000010DD 000000000000000000 
  2942 000010E6 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2942 000010EF 0000000000         
  2943 000010F4 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2943 000010FD 4E4F204E41         
  2944 00001102 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2944 0000110B 00004641           
  2945 0000110F 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2946                                  
  2947 00001116 FFFF                    		dw 0FFFFh
  2948 00001118 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2948 00001121 0210000000F8       
  2949 00001127 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2949 00001130 000000000000000000 
  2950 00001139 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2950 00001142 FFFFFF0000         
  2951 00001147 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2951 00001150 0000000003200028   
  2952 00001158 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2952 00001161 000000000000000000 
  2953 0000116A 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2953 00001173 000000000000000000 
  2954 0000117C 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2954 00001185 0000000000         
  2955 0000118A 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2955 00001193 4E4F204E41         
  2956 00001198 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2956 000011A1 00004641           
  2957 000011A5 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2958                                  
  2959 000011AC FFFF                    		dw 0FFFFh
  2960 000011AE 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2960 000011B7 0210000000F8       
  2961 000011BD 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2961 000011C6 000000000000000000 
  2962 000011CF 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2962 000011D8 FFFFFF0000         
  2963 000011DD 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2963 000011E6 0000000003200028   
  2964 000011EE 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2964 000011F7 000000000000000000 
  2965 00001200 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2965 00001209 000000000000000000 
  2966 00001212 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2966 0000121B 0000000000         
  2967 00001220 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2967 00001229 4E4F204E41         
  2968 0000122E 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2968 00001237 00004641           
  2969 0000123B 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2970                                  
  2971 00001242 FFFF                    		dw 0FFFFh
  2972 00001244 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2972 0000124D 0210000000F8       
  2973 00001253 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2973 0000125C 000000000000000000 
  2974 00001265 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2974 0000126E FFFFFF0000         
  2975 00001273 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2975 0000127C 0000000003200028   
  2976 00001284 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2976 0000128D 000000000000000000 
  2977 00001296 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2977 0000129F 000000000000000000 
  2978 000012A8 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2978 000012B1 0000000000         
  2979 000012B6 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2979 000012BF 4E4F204E41         
  2980 000012C4 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2980 000012CD 00004641           
  2981 000012D1 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2982                                  
  2983 000012D8 FFFF                    		dw 0FFFFh
  2984 000012DA 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2984 000012E3 0210000000F8       
  2985 000012E9 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2985 000012F2 000000000000000000 
  2986 000012FB 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2986 00001304 FFFFFF0000         
  2987 00001309 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2987 00001312 0000000003200028   
  2988 0000131A 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2988 00001323 000000000000000000 
  2989 0000132C 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2989 00001335 000000000000000000 
  2990 0000133E 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2990 00001347 0000000000         
  2991 0000134C 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2991 00001355 4E4F204E41         
  2992 0000135A 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2992 00001363 00004641           
  2993 00001367 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2994                                  
  2995 0000136E FFFF                    		dw 0FFFFh
  2996 00001370 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2996 00001379 0210000000F8       
  2997 0000137F 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2997 00001388 000000000000000000 
  2998 00001391 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2998 0000139A FFFFFF0000         
  2999 0000139F 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2999 000013A8 0000000003200028   
  3000 000013B0 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3000 000013B9 000000000000000000 
  3001 000013C2 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3001 000013CB 000000000000000000 
  3002 000013D4 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  3002 000013DD 0000000000         
  3003 000013E2 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  3003 000013EB 4E4F204E41         
  3004 000013F0 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  3004 000013F9 00004641           
  3005 000013FD 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  3006                                  
  3007 00001404 FFFF                    		dw 0FFFFh
  3008 00001406 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  3008 0000140F 0210000000F8       
  3009 00001415 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3009 0000141E 000000000000000000 
  3010 00001427 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  3010 00001430 FFFFFF0000         
  3011 00001435 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  3011 0000143E 0000000003200028   
  3012 00001446 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3012 0000144F 000000000000000000 
  3013 00001458 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3013 00001461 000000000000000000 
  3014 0000146A 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  3014 00001473 0000000000         
  3015 00001478 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  3015 00001481 4E4F204E41         
  3016 00001486 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  3016 0000148F 00004641           
  3017 00001493 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  3018                                  
  3019 0000149A FFFF                    		dw 0FFFFh
  3020 0000149C 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  3020 000014A5 0210000000F8       
  3021 000014AB 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3021 000014B4 000000000000000000 
  3022 000014BD 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  3022 000014C6 FFFFFF0000         
  3023 000014CB 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  3023 000014D4 0000000003200028   
  3024 000014DC 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3024 000014E5 000000000000000000 
  3025 000014EE 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3025 000014F7 000000000000000000 
  3026 00001500 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  3026 00001509 0000000000         
  3027 0000150E 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  3027 00001517 4E4F204E41         
  3028 0000151C 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  3028 00001525 00004641           
  3029 00001529 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  3030 00001530 FFFF                    		dw 0FFFFh
  3031 00001532 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  3031 0000153B 0210000000F8       
  3032 00001541 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3032 0000154A 000000000000000000 
  3033 00001553 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  3033 0000155C FFFFFF0000         
  3034 00001561 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  3034 0000156A 0000000003200028   
  3035 00001572 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3035 0000157B 000000000000000000 
  3036 00001584 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3036 0000158D 000000000000000000 
  3037 00001596 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  3037 0000159F 0000000000         
  3038 000015A4 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  3038 000015AD 4E4F204E41         
  3039 000015B2 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  3039 000015BB 00004641           
  3040 000015BF 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  3041                                  
  3042 000015C6 FFFF                    		dw 0FFFFh
  3043 000015C8 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  3043 000015D1 0210000000F8       
  3044 000015D7 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3044 000015E0 000000000000000000 
  3045 000015E9 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  3045 000015F2 FFFFFF0000         
  3046 000015F7 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  3046 00001600 0000000003200028   
  3047 00001608 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3047 00001611 000000000000000000 
  3048 0000161A 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3048 00001623 000000000000000000 
  3049 0000162C 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  3049 00001635 0000000000         
  3050 0000163A 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  3050 00001643 4E4F204E41         
  3051 00001648 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  3051 00001651 00004641           
  3052 00001655 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  3053                                  
  3054 0000165C FFFF                    bds_24:		dw 0FFFFh
  3055 0000165E 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  3055 00001667 0210000000F8       
  3056 0000166D 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3056 00001676 000000000000000000 
  3057 0000167F 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  3057 00001688 FFFFFF0000         
  3058 0000168D 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  3058 00001696 0000000003200028   
  3059 0000169E 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3059 000016A7 000000000000000000 
  3060 000016B0 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3060 000016B9 000000000000000000 
  3061 000016C2 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  3061 000016CB 0000000000         
  3062 000016D0 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  3062 000016D9 4E4F204E41         
  3063 000016DE 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  3063 000016E7 00004641           
  3064 000016EB 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  3065                                  
  3066                                  ;---------------------------------------------------------------------------
  3067                                  ; Possibly disposable data, goes at end of data group
  3068                                  ;***************************************************************************
  3069                                  
  3070                                  ; Possibly disposable data, goes at end of data group
  3071                                  
  3072                                  ;***	ibm_disk_io - main routine, fixes at rom bug
  3073                                  ;
  3074                                  ;	entry:	(ah) = function, 02 or 0a for read.
  3075                                  ;		(dl) = drive number (80h or 81h).
  3076                                  ;		(dh) = head number.
  3077                                  ;		(ch) = cylinder number.
  3078                                  ;		(cl) = sector number (high 2 bits has cylinder number).
  3079                                  ;		(al) = number of sectors.
  3080                                  ;		(es:bx) = address of read buffer.
  3081                                  ;		for more on register contents see rom bios listing.
  3082                                  ;		stack set up for return by an iret.
  3083                                  ;
  3084                                  ;	exit:	(ah) = status of current operation.
  3085                                  ;		(cy) = 1 if failed, 0 if successful.
  3086                                  ;		for other register contents see rom bios listing.
  3087                                  ;
  3088                                  ;	uses:	
  3089                                  ;
  3090                                  ;
  3091                                  ;	warning: uses old13 vector for non-read calls.
  3092                                  ;		does direct calls to the at rom.
  3093                                  ;		does segment arithmatic.
  3094                                  ;
  3095                                  ;	effects: performs disk i/o operation.
  3096                                  
  3097                                  ; 16/10/2022
  3098                                  ; 28/05/2019
  3099                                  cmd_block equ 42h ; ROMBIOS DATA segment (40h) offset 42h ; 13/12/2022
  3100                                  
  3101                                  ;* offsets into cmd_block for registers
  3102                                  
  3103                                  pre_comp equ 0	;write pre-compensation
  3104                                  sec_cnt	 equ 1	;sector count
  3105                                  sec_num	 equ 2	;sector number
  3106                                  cyl_low	 equ 3	;cylinder number, low part
  3107                                  cyl_high equ 4	;cylinder number, high part
  3108                                  drv_head equ 5	;drive/head (bit 7 = ecc mode, bit 5 = 512 byte sectors, 
  3109                                  		;            bit 4 = drive number, bits 3-0 have head number)
  3110                                  cmd_reg  equ 6	;command register
  3111                                  
  3112                                  ; 01/10/2022
  3113                                  disk_status1	equ 74h
  3114                                  hf_num		equ 75h
  3115                                  control_byte	equ 76h
  3116                                  
  3117                                  ; 14/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  3118                                  ; PCDOS 7.1 IBMBIO.COM - BIOSDATA:16F2h
  3119                                  
  3120                                  ibm_disk_io:				
  3121 000016F2 80FA80                  		cmp	dl, 80h		; main routine,	fixes at rom bug
  3122 000016F5 720A                    		jb	short atd1	; pass through floppy disk calls. 
  3123 000016F7 80FC02                  		cmp	ah, 2
  3124 000016FA 740A                    		jz	short atd2	; intercept call 02 (read sectors).
  3125 000016FC 80FC0A                  		cmp	ah, 0Ah
  3126 000016FF 7405                    		jz	short atd2	; and call 0Ah (read long).
  3127                                  atd1:
  3128 00001701 2EFF2E[0601]            		jmp	far [cs:Old13]					
  3129                                  		;jmp	cs:Old13	; use rom int 13h handler
  3130                                  ;-----------------------------------------------------------------------------
  3131                                  
  3132                                  atd2:					
  3133 00001706 53                      		push	bx
  3134 00001707 51                      		push	cx
  3135 00001708 52                      		push	dx
  3136 00001709 57                      		push	di
  3137 0000170A 1E                      		push	ds
  3138 0000170B 06                      		push	es
  3139 0000170C 50                      		push	ax
  3140 0000170D B84000                  		mov	ax, 40h		; bioseg (rombios data segment)
  3141                                  					; establish bios segment addressing
  3142 00001710 8ED8                    		mov	ds, ax
  3143                                  		; 16/10/2022
  3144 00001712 C606740000              		mov	byte [disk_status1], 0
  3145                                  		;mov	byte ptr ds:74h, 0 ; [disk_status1]
  3146                                  					; initially no error code.
  3147 00001717 80E27F                  		and	dl, 7Fh		; mask to hard disk number
  3148 0000171A 3A167500                		cmp	dl, [hf_num]
  3149                                  		;cmp	dl, ds:75h	; [hf_num] ; 40h:75h
  3150 0000171E 7207                    		jb	short atd3	; disk number in range
  3151                                  		;mov	byte ptr ds:74h, 1 ; bad_disk
  3152 00001720 C606740001              		mov	byte [disk_status1], 1
  3153 00001725 EB20                    		jmp	short atd4	; disk number out of range error,
  3154                                  					; return
  3155                                  ; ----------------------------------------------------------------------------
  3156                                  
  3157                                  atd3:					
  3158 00001727 53                      		push	bx
  3159 00001728 8CC0                    		mov	ax, es
  3160 0000172A C1EB04                  		shr	bx, 4		; make es:bx to seg:000x form.
  3161 0000172D 01D8                    		add	ax, bx
  3162 0000172F 8EC0                    		mov	es, ax
  3163 00001731 5B                      		pop	bx
  3164 00001732 83E30F                  		and	bx, 0Fh
  3165 00001735 0E                      		push	cs
  3166 00001736 E8DF00                  		call	check_dma
  3167 00001739 720C                    		jb	short atd4	; abort if dma across segment boundary
  3168 0000173B 58                      		pop	ax
  3169 0000173C 50                      		push	ax
  3170 0000173D E81A00                  		call	setcmd		; set up command block for disk op
  3171 00001740 BAF603                  		mov	dx, 3F6h	; hf_reg_port 
  3172 00001743 EE                      		out	dx, al		; write out command modifier
  3173 00001744 E86B00                  		call	docmd		; carry out command
  3174                                  ; ----------------------------------------------------------------------------
  3175                                  
  3176                                  atd4:	
  3177                                  
  3178                                  ;  new code - let logical or clear carry and then set carry if ah!=0
  3179                                  ;	      and save a couple bytes while were at it.
  3180                                  				
  3181 00001747 58                      		pop	ax
  3182                                  		;mov	ah, ds:74h	; [disk_status1]
  3183 00001748 8A267400                		mov	ah, [disk_status1]
  3184 0000174C 08E4                    		or	ah, ah
  3185 0000174E 7401                    		jz	short atd5
  3186 00001750 F9                      		stc
  3187                                  atd5:					
  3188 00001751 07                      		pop	es
  3189 00001752 1F                      		pop	ds
  3190 00001753 5F                      		pop	di
  3191 00001754 5A                      		pop	dx
  3192 00001755 59                      		pop	cx
  3193 00001756 5B                      		pop	bx
  3194 00001757 CA0200                  		retf	2		; far return, dropping flags
  3195                                  
  3196                                  ; =============== S U B	R O U T	I N E ========================================
  3197                                  
  3198                                  ;***	setcmd - set up cmd_block for the disk operation
  3199                                  ;
  3200                                  ;	entry:	(ds) = bios data segment.
  3201                                  ;		(es:bx) in seg:000x form.
  3202                                  ;		other registers as in int 13h call
  3203                                  ;	
  3204                                  ;	exit:	cmd_block set up for disk read call.
  3205                                  ;		control_byte set up for disk operation.
  3206                                  ;		(al) = control byte modifier
  3207                                  ;
  3208                                  ;	sets the fields of cmd_block using the register contents
  3209                                  ;	and the contents of the disk parameter block for the given drive.
  3210                                  ;
  3211                                  ;	warning: (ax) destroyed.
  3212                                  ;		does direct calls to the at rom.
  3213                                  
  3214                                  setcmd:		; proc near		
  3215                                  		;mov	ds:43h,	al	; [cmd_block+sec_cnt]
  3216                                  		; 16/10/2022
  3217 0000175A A24300                  		mov	[cmd_block+sec_cnt], al
  3218                                  		;mov	byte ptr ds:48h, 20h ; [cmd_block+cmd_reg]
  3219 0000175D C606480020              		mov	byte [cmd_block+cmd_reg], 20h ; assume function 02h (read)
  3220 00001762 80FC02                  		cmp	ah, 2
  3221 00001765 7405                    		jz	short setc1	; cmd_reg = 20h	if function 02h	(read)
  3222 00001767 C606480022              		mov	byte [cmd_block+cmd_reg], 22h
  3223                                  		;mov	byte ptr ds:48h, 22h ; [cmd_block+cmd_reg]
  3224                                  					; cmd_reg = 22h	if function 0Ah	(read long)
  3225                                  setc1:					
  3226 0000176C 88C8                    		mov	al, cl
  3227 0000176E 243F                    		and	al, 3Fh		; mask sector number
  3228                                  		;mov	ds:44h,	al	; [cmd_block+sec_num]
  3229                                  		;mov	ds:45h,	ch	; [cmd_block+cyl_low]
  3230 00001770 A24400                  		mov	[cmd_block+sec_num], al ; mov [44h],al
  3231 00001773 882E4500                		mov	[cmd_block+cyl_low], ch ; mov [45h],ch
  3232 00001777 88C8                    		mov	al, cl
  3233 00001779 C0E806                  		shr	al, 6		; get two high bits of cylinder	number
  3234                                  		;mov	ds:46h,	al	; [cmd_block+cyl_high]
  3235 0000177C A24600                  		mov	[cmd_block+cyl_high], al ; mov [46h],al
  3236 0000177F 89D0                    		mov	ax, dx
  3237 00001781 C0E004                  		shl	al, 4		; drive	number
  3238 00001784 80E40F                  		and	ah, 0Fh
  3239 00001787 08E0                    		or	al, ah		; head number
  3240 00001789 0CA0                    		or	al, 0A0h	; set ecc and 512 bytes	per sector
  3241                                  		;mov	ds:47h,	al	; [cmd_block+drv_head]
  3242 0000178B A24700                  		mov	[cmd_block+drv_head], al  ; mov [47h],al 
  3243 0000178E 06                      		push	es
  3244 0000178F 53                      		push	bx
  3245 00001790 0E                      		push	cs
  3246 00001791 E85C00                  		call	get_vec
  3247 00001794 268B4705                		mov	ax, [es:bx+5]	; [es:bx+fdp_precomp]
  3248                                  			 		; write pre-comp from disk parameters
  3249 00001798 C1E802                  		shr	ax, 2
  3250                                  		;mov	ds:42h,	al	; [cmd_block+pre_comp]
  3251 0000179B A24200                  		mov	[cmd_block+pre_comp], al ; mov [42h],al
  3252                                  					; only use low part
  3253 0000179E 268A4708                		mov	al, [es:bx+8]	; [es:bx+fdp_control]
  3254                                  					; control byte modifier
  3255 000017A2 5B                      		pop	bx
  3256 000017A3 07                      		pop	es
  3257                                  		;mov	ah, ds:76h	; [control_byte]
  3258 000017A4 8A267600                		mov	ah, [control_byte] ; mov ah,[76h]
  3259 000017A8 80E4C0                  		and	ah, 0C0h	; keep disable retry bits	
  3260 000017AB 08C4                    		or	ah, al
  3261                                  		;mov	ds:76h,	ah
  3262 000017AD 88267600                		mov	[control_byte], ah ; mov [76h],al
  3263 000017B1 C3                      		retn
  3264                                  
  3265                                  ; =============== S U B	R O U T	I N E ========================================
  3266                                  
  3267                                  ;***	docmd - carry out read operation to at hard disk
  3268                                  ;
  3269                                  ;	entry:	(es:bx) = address for read in data.
  3270                                  ;		cmd_block set up for disk read.
  3271                                  ;
  3272                                  ;	exit:	buffer at (es:bx) contains data read.
  3273                                  ;		disk_status1 set to error code (0 if success).
  3274                                  ;
  3275                                  ;	
  3276                                  ;
  3277                                  ;	warning: (ax), (bl), (cx), (dx), (di) destroyed.
  3278                                  ;		no check is made for dma boundary overrun.
  3279                                  ;
  3280                                  ;	effects: programs disk controller.
  3281                                  ;		performs disk input.
  3282                                  
  3283                                  docmd:		; proc near		
  3284 000017B2 89DF                    		mov	di, bx
  3285 000017B4 0E                      		push	cs
  3286 000017B5 E84000                  		call	command
  3287 000017B8 7535                    		jnz	short doc3
  3288                                  doc1:					
  3289 000017BA 0E                      		push	cs
  3290 000017BB E84200                  		call	waitt		; wait for controller to complete read
  3291 000017BE 752F                    		jnz	short doc3
  3292 000017C0 B90001                  		mov	cx, 256		; 256 words per sector
  3293 000017C3 BAF001                  		mov	dx, 1F0h	; hf_port
  3294 000017C6 FC                      		cld			; string op goes up
  3295 000017C7 FA                      		cli			; disable interrupts
  3296                                  					; (bug was forgetting this)
  3297                                  
  3298                                  ;	M062 -- some of these old machines have intermittent failures
  3299                                  ;		when the read is done at full speed. Instead of using
  3300                                  ;		a string rep instruction, we'll use a loop. There is
  3301                                  ;		a slight performance hit, but it only affects these
  3302                                  ;		very old machines with an exact date code match, and
  3303                                  ;		it makes said machines more reliable
  3304                                  ;
  3305                                  ;M062	repz	insw		;read in sector
  3306                                  
  3307                                  rsct_loop:				
  3308 000017C8 6D                      		insw
  3309 000017C9 E2FD                    		loop	rsct_loop
  3310 000017CB FB                      		sti
  3311                                  		; 16/10/2022
  3312 000017CC F606480002              		test	byte [cmd_block+cmd_reg], 02h
  3313                                  		;test	byte ptr ds:48h, 2 ; [cmd_block+cmd_reg]
  3314                                  					; (ds =	40h)
  3315 000017D1 7410                    		jz	short doc2	; no ecc bytes to read.
  3316 000017D3 0E                      		push	cs
  3317 000017D4 E83100                  		call	wait_drq	; wait for controller to complete read
  3318 000017D7 7216                    		jb	short doc3
  3319 000017D9 B90400                  		mov	cx, 4		; 4 bytes of ecc
  3320 000017DC BAF001                  		mov	dx, 1F0h	; hf_port
  3321 000017DF FA                      		cli
  3322 000017E0 F36C                    		rep insb		; read in ecc
  3323 000017E2 FB                      		sti
  3324                                  doc2:					
  3325 000017E3 0E                      		push	cs
  3326 000017E4 E82900                  		call	check_status
  3327 000017E7 7506                    		jnz	short doc3	; operation failed
  3328                                  		;dec	byte ptr ds:43h	; [cmd_block+sec_cnt]
  3329 000017E9 FE0E4300                		dec	byte [cmd_block+sec_cnt]
  3330 000017ED 75CB                    		jnz	short doc1	; loop while more sectors to read
  3331                                  doc3:					
  3332 000017EF C3                      		retn
  3333                                  
  3334                                  ; =============== S U B	R O U T	I N E ========================================
  3335                                  
  3336                                  ;***	define where the rom routines are actually located
  3337                                  ;	   in the buggy old AT BIOS that we might need to
  3338                                  ;	   install a special level of int13 handler for
  3339                                  
  3340                                  ; 16/10/2022
  3341                                  
  3342                                  romsegment 	equ 0F000h  ; segment
  3343                                  romcommand 	equ 2E1Eh   ; offset in romsegment
  3344                                  romwait		equ 2E7Fh   ; offset in romsegment
  3345                                  romwait_drq 	equ 2EE2h   ; offset in romsegment
  3346                                  romcheck_status equ 2EF8h   ; offset in romsegment
  3347                                  romcheck_dma 	equ 2F69h   ; offset in romsegment	
  3348                                  romget_vec	equ 2F8Eh   ; offset in romsegment
  3349                                  romfret		equ 0FF65h  ; far return in rom	
  3350                                  
  3351                                  ;***	get_vec - get pointer to hard disk parameters.
  3352                                  ;
  3353                                  ;	entry:	(dl) = low bit has hard disk number (0 or 1).
  3354                                  ;
  3355                                  ;	exit:	(es:bx) = address of disk parameters table.
  3356                                  ;
  3357                                  ;	uses:	ax for segment computation.
  3358                                  ;
  3359                                  ;	loads es:bx from interrupt table in low memory, vector 46h (disk 0)
  3360                                  ;	or 70h (disk 1).
  3361                                  ;	
  3362                                  ;	warning: (ax) destroyed.
  3363                                  ;		this does a direct call to the at rom.
  3364                                  
  3365                                  get_vec:	; proc near		
  3366                                  		;push	0FF65h		; romfret ; far	return in rom
  3367                                  		;jmp	far ptr	0F000h:2F8Eh
  3368                                  		; 16/10/2022
  3369 000017F0 6865FF                  		push	romfret		; far return in rom
  3370 000017F3 EA8E2F00F0              		jmp	romsegment:romget_vec
  3371                                  
  3372                                  ; =============== S U B	R O U T	I N E ========================================
  3373                                  
  3374                                  ;***	command - send contents of cmd_block to disk controller.
  3375                                  ;
  3376                                  ;	entry:	control_byte 
  3377                                  ;		cmd_block - set up with values for hard disk controller.
  3378                                  ;
  3379                                  ;	exit:	disk_status1 = error code.
  3380                                  ;		nz if error, zr for no error.
  3381                                  ;
  3382                                  ;
  3383                                  ;	warning: (ax), (cx), (dx) destroyed.
  3384                                  ;		does a direct call to the at rom.
  3385                                  ;
  3386                                  ;	effects: programs disk controller.
  3387                                  
  3388                                  command:	; proc near		
  3389                                  		;push	0FF65h		; romfret ; far	return in rom
  3390                                  		;jmp	far ptr	0F000h:2E1Eh
  3391                                  		; 16/10/2022
  3392 000017F8 6865FF                  		push	romfret		; far return in rom
  3393 000017FB EA1E2E00F0              		jmp	romsegment:romcommand
  3394                                  
  3395                                  ; =============== S U B	R O U T	I N E ========================================
  3396                                  
  3397                                  ;***	waitt - wait for disk interrupt
  3398                                  ;
  3399                                  ;	entry:	nothing.
  3400                                  ;
  3401                                  ;	exit:	disk_status1 = error code.
  3402                                  ;		nz if error, zr if no error.
  3403                                  ;
  3404                                  ;
  3405                                  ;	warning: (ax), (bl), (cx) destroyed.
  3406                                  ;		does a direct call to the at rom.
  3407                                  ;		
  3408                                  ;	effects: calls int 15h, function 9000h.
  3409                                  
  3410                                  waitt:		; proc near		
  3411                                  		;push	0FF65h		; romfret ; far	return in rom
  3412                                  		;jmp	far ptr	0F000h:2E7Fh
  3413                                  		; 16/10/2022
  3414 00001800 6865FF                  		push	romfret		; far return in rom
  3415 00001803 EA7F2E00F0              		jmp	romsegment:romwait
  3416                                  
  3417                                  ; =============== S U B	R O U T	I N E ========================================
  3418                                  
  3419                                  ;***	wait_drq - wait for data request.
  3420                                  ;
  3421                                  ;	entry:	nothing.
  3422                                  ;
  3423                                  ;	exit:	disk_status1 = error code.
  3424                                  ;		cy if error, nc if no error.
  3425                                  ;
  3426                                  ;	warning: (al), (cx), (dx) destroyed.
  3427                                  ;		does a direct call to the at rom.
  3428                                  
  3429                                  wait_drq:	; proc near		
  3430                                  		;push	0FF65h		; romfret ; far	return in rom
  3431                                  		;jmp	far ptr	0F000h:2EE2h
  3432                                  		; 16/10/2022
  3433 00001808 6865FF                  		push	romfret		; far return in rom
  3434 0000180B EAE22E00F0              		jmp	romsegment:romwait_drq
  3435                                  
  3436                                  ; =============== S U B	R O U T	I N E ========================================
  3437                                  
  3438                                  ;***	check_status - check hard disk status.
  3439                                  ;
  3440                                  ;	entry:	nothing.
  3441                                  ;
  3442                                  ;	exit:	disk_status1 = error code.
  3443                                  ;		nz if error, zr if no error.
  3444                                  ;
  3445                                  ;	warning: (ax), (cx), (dx) destroyed.
  3446                                  ;		does a direct call to the at rom.
  3447                                  
  3448                                  check_status:	; proc near		
  3449                                  		;push	0FF65h		; romfret ; far	return in rom
  3450                                  		;jmp	far ptr	0F000h:2EF8h
  3451                                  		; 16/10/2022
  3452 00001810 6865FF                  		push	romfret		; far return in rom
  3453 00001813 EAF82E00F0              		jmp	romsegment:romcheck_status
  3454                                  
  3455                                  ; =============== S U B	R O U T	I N E ========================================
  3456                                  
  3457                                  ;***	check_dma - check for dma overrun 64k segment.
  3458                                  ;
  3459                                  ;	entry:	(es:bx) = addr. of memory buffer in seg:000x form.
  3460                                  ;		cmd_block set up for operation.
  3461                                  ;
  3462                                  ;	exit:	disk_status1 - error code.
  3463                                  ;		cy if error, nc if no error.
  3464                                  ;
  3465                                  ;	warning: does a direct call to the at rom.
  3466                                  
  3467                                  check_dma:	; proc near		
  3468                                  		;push	0FF65h		; romfret ; far	return in rom
  3469                                  		;jmp	far ptr	0F000h:2F69h
  3470                                  		; 16/10/2022
  3471 00001818 6865FF                  		push	romfret		; far return in rom
  3472 0000181B EA692F00F0              		jmp	romsegment:romcheck_dma
  3473                                  
  3474                                  ;-----------------------------------------------------------------------------
  3475                                  
  3476                                  endatrom:
  3477                                  
  3478                                  ; ----------------------------------------------------------------------------
  3479                                  
  3480                                  ;; M015 -- begin changes
  3481                                  ;;
  3482                                  ;; Certain old COMPAQ '286 machines have a bug in their ROM BIOS.
  3483                                  ;; When Int13 is done with AH > 15h and DL >= 80h, they trash
  3484                                  ;; the byte at DS:74h, assuming that DS points to ROM_DATA.
  3485                                  ;; If our init code detects this error, it will install this
  3486                                  ;; special Int13 hook through the same mechanism that was set
  3487                                  ;; up for the IBM patch above. This code is also dynamically
  3488                                  ;; relocated by MSINIT.
  3489                                  
  3490                                  compaq_disk_io:
  3491 00001820 80FC15                  		cmp	ah, 15h		; compaq_disk_io proc far
  3492                                  					;
  3493                                  					; the following	label defines the end of the at	rom patch.
  3494                                  					; this is used at configuration	time.
  3495                                  					;
  3496                                  					; warning!!!
  3497                                  					; this code will be dynamically	relocated by msinit
  3498 00001823 7705                    		ja	short mebbe_hookit ; only deal with functions > 15h
  3499                                  no_hookit:				
  3500                                  		;jmp	cs:Old13
  3501                                  		; 16/10/2022
  3502 00001825 2EFF2E[0601]            		jmp	far [cs:Old13]
  3503                                  
  3504                                  ; ----------------------------------------------------------------------------
  3505                                  
  3506                                  mebbe_hookit:
  3507 0000182A 80FA80                  		cmp	dl, 80h
  3508 0000182D 72F6                    		jb	short no_hookit
  3509 0000182F 1E                      		push	ds
  3510                                  		
  3511                                  		; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  3512                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:1830h
  3513                                  		;push	ax
  3514                                  		;mov	ax, 40h
  3515                                  		;mov	ds, ax
  3516                                  		;pop	ax
  3517 00001830 6A40                    		push	40h
  3518 00001832 1F                      		pop	ds
  3519                                  
  3520 00001833 9C                      		pushf
  3521                                  		;call	cs:Old13
  3522                                  		; 16/10/2022
  3523 00001834 2EFF1E[0601]            		call	far [cs:Old13]
  3524 00001839 1F                      		pop	ds
  3525 0000183A CA0200                  		retf	2
  3526                                  
  3527                                  ; ----------------------------------------------------------------------------
  3528                                  
  3529 0000183D 00                      end_compaq_i13hook: db 0			
  3530                                  
  3531                                  ; =============== S U B	R O U T	I N E ========================================
  3532                                  
  3533                                  ; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  3534                                  %if 0  
  3535                                  
  3536                                  ; CMOS Clock setting support routines used by MSCLOCK.		
  3537                                  ; Warning!!! This code will be dynamically relocated by MSINIT.
  3538                                  
  3539                                  daycnt_to_day:	; proc far
  3540                                  
  3541                                  ; entry: [daycnt] = number of days since 1-1-80
  3542                                  ;
  3543                                  ; return: ch - century in bcd
  3544                                  ;	  cl - year in bcd
  3545                                  ;	  dh - month in bcd
  3546                                  ;	  dl - day in bcd
  3547                                  
  3548                                  		; 16/10/2022		
  3549                                  		push	word [cs:daycnt] ; save daycnt
  3550                                  		cmp	word [cs:daycnt], 7305	; (365*20+(20/4))
  3551                                  					; # days from 1-1-1980 to 1-1-2000
  3552                                  		jnb	short century20
  3553                                  		mov	byte [cs:base_century], 19
  3554                                  		mov	byte [cs:base_year], 80
  3555                                  		jmp	short years
  3556                                  ; ----------------------------------------------------------------------------
  3557                                  		
  3558                                  century20:				
  3559                                  		mov	byte [cs:base_century], 20
  3560                                  		mov	byte [cs:base_year], 0
  3561                                  		sub	word [cs:daycnt], 7305	; (365*20+(20/4))
  3562                                  					; adjust daycnt
  3563                                  years:					
  3564                                  		xor	dx, dx
  3565                                  		mov	ax, [cs:daycnt]
  3566                                  		mov	bx, 1461	; (366+365*3)
  3567                                  					; # of days in a Leap year block
  3568                                  		div	bx		; AX = # of leap block,	DX = daycnt
  3569                                  		mov	[cs:daycnt], dx	; save daycnt left
  3570                                  		mov	bl, 4
  3571                                  		mul	bl		; AX = # of years. Less	than 100
  3572                                  		add	[cs:base_year], al ; So, ah = 0. Adjust year
  3573                                  		inc	word [cs:daycnt]	; set daycnt to	1 base
  3574                                  		cmp	word [cs:daycnt], 366	; daycnt=remainder of leap year	bk
  3575                                  		jbe	short leapyear	; within 366+355+355+355 days.
  3576                                  		inc	byte [cs:base_year]	; if daycnt <= 366, then leap year
  3577                                  		sub	word [cs:daycnt], 366	; else daycnt--, base_year++ ;
  3578                                  		mov	cx, 3		; And next three years are normal
  3579                                  regularyear:				
  3580                                  		cmp	word [cs:daycnt], 365	; for(i=1; i>3 or daycnt <=365;	i++)
  3581                                  		jbe	short yeardone	; {if (daycnt >	365)
  3582                                  		inc	byte [cs:base_year]	;   { daycnt -=	365
  3583                                  		sub	word [cs:daycnt], 365	;   }
  3584                                  		loop	regularyear	; }
  3585                                  					;
  3586                                  					; should never fall through loop
  3587                                  leapyear:				
  3588                                  		mov	byte [cs:month_tab+1], 29 ; leap year.
  3589                                  					; change month table.
  3590                                  yeardone:				
  3591                                  		xor	bx, bx
  3592                                  		xor	dx, dx
  3593                                  		mov	ax, [cs:daycnt]
  3594                                  		;mov	si, offset month_tab
  3595                                  		mov	si, month_tab	; 19/10/2022
  3596                                  		mov	cx, 12
  3597                                  months:					
  3598                                  		inc	bl
  3599                                  
  3600                                  		; !!! -- 16/10/2022 -- (if DS=CS, what for CS: prefixes are used !?)
  3601                                  		;mov	dl, [cs:si]
  3602                                  		; !!! -- 16/10/2022 -- (may be to keep code addrs as unchanged/fix!?)
  3603                                  		; ds = cs !? ((ofcourse ds must be same with cs here))
  3604                                  		;mov	dl, [si] ; 20/03/2019 (MSDOS 6.21 IO.SYS, BIOSDATA:14C0h)
  3605                                  		;mov	dl, [si] ; 16/10/2022 (MSDOS 5.0 IO.SYS, BIOSDATA:14C0h)
  3606                                  		
  3607                                  		mov	dl, [si] ; ?	; mov dl, [cs:si]
  3608                                  		cmp	ax, dx		; cmp daycnt for each month till fit
  3609                                  					; dh=0
  3610                                  		jbe	short month_done
  3611                                  		inc	si		; next month
  3612                                  		sub	ax, dx		; adjust daycnt
  3613                                  		loop	months		;
  3614                                  					; should never fall through loop
  3615                                  month_done:				
  3616                                  		mov	byte [cs:month_tab+1], 28
  3617                                  					; restore month table value
  3618                                  		mov	dl, bl
  3619                                  		mov	dh, [cs:base_year]
  3620                                  		mov	cl, [cs:base_century] ; al=day,dl=month,dh=year,cl=cntry
  3621                                  		call	far [cs:bintobcd]
  3622                                  		;call	cs:bintobcd	; convert "day"	to bcd
  3623                                  					; dl = bcd day,	al = month
  3624                                  		xchg	dl, al
  3625                                  		call	far [cs:bintobcd]
  3626                                  		;call	cs:bintobcd	; dh = bcd month, al = year
  3627                                  		xchg	dh, al
  3628                                  		call	far [cs:bintobcd]
  3629                                  		;call	cs:bintobcd	; cl = bcd year, al = century
  3630                                  		xchg	cl, al
  3631                                  		call	far [cs:bintobcd]
  3632                                  		;call	cs:bintobcd	; ch = bcd century
  3633                                  		mov	ch, al
  3634                                  		pop	word [cs:daycnt] ; restore original value
  3635                                  		retf
  3636                                  
  3637                                  enddaycnttoday:	
  3638                                  
  3639                                  %endif
  3640                                  
  3641                                  ; =============== S U B	R O U T	I N E ========================================
  3642                                  
  3643                                  ; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  3644                                  %if 0  
  3645                                  
  3646                                  bin_to_bcd:	; proc far		; real time clock support
  3647                                  
  3648                                  ;convert a binary input in al (less than 63h or 99 decimal)
  3649                                  ;into a bcd value in al. ah destroyed.	
  3650                                  		
  3651                                  		push	cx		
  3652                                  		aam			; al=high digit	bcd, ah=low digit bcd
  3653                                  		mov	cl, 4
  3654                                  		shl	ah, cl		; mov the high digit to	high nibble
  3655                                  		or	al, ah
  3656                                  		pop	cx
  3657                                  		retf
  3658                                  %endif
  3659                                  
  3660                                  ; ----------------------------------------------------------------------------
  3661                                  
  3662                                  ; the k09 requires the routines for reading the clock because of the suspend/
  3663                                  ; resume facility. the system clock needs to be reset after resume.
  3664                                  
  3665                                  ; the following routine is executed at resume time when the system
  3666                                  ; powered on after suspension. it reads the real time clock and
  3667                                  ; resets the system time and date, and then irets.
  3668                                  
  3669                                  ; warning!!! this code will be dynamically relocated by msinit.
  3670                                  
  3671                                  	; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  3672                                  	; PCDOS 7.1 IBMBIO.COM - BIOSDATA:183Eh
  3673                                  
  3674                                  	; 14/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  3675                                  int_6Ch:
  3676 0000183E 0E                      		push	cs
  3677 0000183F 1F                      		pop	ds
  3678                                  		;cmp	byte [cs:inHMA], 0  
  3679 00001840 803E[0D00]00            		cmp	byte [inHMA], 0
  3680 00001845 7405                    		jz      short int6c
  3681 00001847 BB[2A07]                		mov     bx, EnsureA20On
  3682 0000184A FFD3                    		call    bx
  3683                                  int6c:					
  3684                                  		;push	cs
  3685                                  		;pop	ds
  3686 0000184C 8F06[F805]              		pop	word [int6c_ret_addr]	; pop off return address
  3687 00001850 8F06[FA05]              		pop	word [int6c_ret_addr+2]
  3688 00001854 9D                      		popf
  3689 00001855 E81300                  		call	read_real_date	; get the date from the clock
  3690 00001858 FA                      		cli
  3691 00001859 8936[8904]              		mov	[daycnt], si	; update dos copy of date
  3692 0000185D FB                      		sti
  3693 0000185E E8B900                  		call	read_real_time	; get the time from the	rtc
  3694 00001861 FA                      		cli
  3695 00001862 B401                    		mov	ah, 1
  3696 00001864 CD1A                    		int	1Ah		; CLOCK	- SET TIME OF DAY
  3697                                  					; CX:DX	= clock	count
  3698                                  					; Return: time of day set
  3699 00001866 FB                      		sti
  3700                                  		;jmp	int6c_ret_addr	; long jump
  3701                                  		; 16/10/2022
  3702 00001867 FF2E[F805]              		jmp	far [int6c_ret_addr] ; long jump
  3703                                  
  3704                                  ; =============== S U B	R O U T	I N E ========================================
  3705                                  
  3706                                  ;   read_real_date reads real-time clock for date and returns the number
  3707                                  ;   of days elapsed since 1-1-80 in si
  3708                                  
  3709                                  read_real_date:	; proc near		
  3710 0000186B 50                      		push	ax
  3711 0000186C 51                      		push	cx
  3712 0000186D 52                      		push	dx
  3713 0000186E 30E4                    		xor	ah, ah		; throw	away clock roll	over
  3714 00001870 CD1A                    		int	1Ah		; CLOCK	- GET TIME OF DAY
  3715                                  					; Return: CX:DX	= clock	count
  3716                                  					; AL = 00h if clock was	read or	written	(via AH=0,1) since the previous
  3717                                  					; midnight
  3718                                  					; Otherwise, AL	> 0
  3719 00001872 5A                      		pop	dx
  3720 00001873 59                      		pop	cx
  3721 00001874 58                      		pop	ax
  3722 00001875 50                      		push	ax
  3723 00001876 53                      		push	bx
  3724 00001877 51                      		push	cx
  3725 00001878 52                      		push	dx
  3726                                  		;mov	word [cs:daycnt2], 1
  3727                                  		; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  3728                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:187Ah
  3729 00001879 C706[0006]0100          		mov	word [daycnt2], 1
  3730                                  					; REAL TIME CLOCK ERROR	FLAG (+1 DAY)
  3731 0000187F B404                    		mov	ah, 4
  3732 00001881 CD1A                    		int	1Ah		; CLOCK	- READ DATE FROM REAL TIME CLOCK (AT,XT286,CONV,PS)
  3733                                  					; Return: DL = day in BCD
  3734                                  					; DH = month in	BCD
  3735                                  					; CL = year in BCD
  3736                                  					; CH = century (19h or 20h)
  3737 00001883 7303                    		jnb	short read_ok
  3738 00001885 E98300                  		jmp	r_d_ret
  3739                                  ;-----------------------------------------------------------------------------
  3740                                  
  3741                                  read_ok:
  3742 00001888 882E[FC05]              		mov	[bin_date_time], ch
  3743 0000188C 880E[FD05]              		mov	[bin_date_time+1], cl
  3744 00001890 8836[FE05]              		mov	[bin_date_time+2], dh
  3745 00001894 8816[FF05]              		mov	[bin_date_time+3], dl
  3746                                  		;mov	word [cs:daycnt2], 2 ; READ OF R-T CLOCK SUCCESSFUL
  3747                                  		; 08/08/2023
  3748                                  		;mov	byte [daycnt2], 2
  3749 00001898 FE06[0006]              		inc	byte [daycnt2] ; 2
  3750 0000189C E83401                  		call	bcd_verify	; verify bcd values in range
  3751 0000189F 726A                    		jb	short r_d_ret	; some value out of range
  3752                                  		;mov	word [cs:daycnt2], 3
  3753                                  		; 08/08/2023
  3754                                  		;mov	byte [daycnt2], 3
  3755 000018A1 FE06[0006]              		inc	byte [daycnt2] ; 3
  3756 000018A5 E8DB00                  		call	date_verify
  3757 000018A8 7261                    		jb	short r_d_ret
  3758                                  		;mov	word [cs:daycnt2], 0
  3759                                  		; 08/08/2023
  3760 000018AA C606[0006]00            		mov	byte [daycnt2], 0
  3761 000018AF E8A100                  		call	in_bin
  3762 000018B2 A0[FD05]                		mov	al, [bin_date_time+1]
  3763 000018B5 98                      		cbw
  3764 000018B6 803E[FC05]14            		cmp	byte [bin_date_time], 20 ; 20th century?
  3765 000018BB 7503                    		jnz	short century_19 ; no
  3766 000018BD 83C064                  		add	ax, 100		; add in a century
  3767                                  century_19:				
  3768 000018C0 83E850                  		sub	ax, 80		; subtract off 1-1-80
  3769 000018C3 B104                    		mov	cl, 4		; leap year every 4
  3770 000018C5 F6F1                    		div	cl		; al= #	leap year blocks, ah= remainder
  3771 000018C7 88E3                    		mov	bl, ah		; save odd years
  3772 000018C9 98                      		cbw			; zero ah
  3773 000018CA B9B505                  		mov	cx, 1461	; 366+(3*365)
  3774                                  					; # of days in leap year blocks
  3775 000018CD F7E1                    		mul	cx
  3776                                  		;mov	[cs:daycnt2], ax ; SAVE COUNT OF DAYS
  3777                                  		; 08/08/2023
  3778 000018CF A3[0006]                		mov	[daycnt2], ax
  3779 000018D2 88D8                    		mov	al, bl		; get odd years	count
  3780 000018D4 98                      		cbw
  3781 000018D5 09C0                    		or	ax, ax
  3782 000018D7 740B                    		jz	short leap_year
  3783 000018D9 B96D01                  		mov	cx, 365		; days in year
  3784 000018DC F7E1                    		mul	cx
  3785                                  		;add	[cs:daycnt2], ax ; ADD ON DAYS IN ODD YEARS
  3786                                  		; 08/08/2023
  3787 000018DE 0106[0006]              		add	[daycnt2], ax
  3788 000018E2 EB07                    		jmp	short leap_adjustment ;	account	for leap year
  3789                                  					; possibly account for a leap day
  3790                                  ;-----------------------------------------------------------------------------
  3791                                  
  3792                                  leap_year:
  3793 000018E4 803E[FE05]02            		cmp	byte [bin_date_time+2], 2 ; is	month february?
  3794 000018E9 7604                    		jbe	short no_leap_adjustment ; jan or feb. no leap day yet.
  3795                                  leap_adjustment:
  3796                                  		;inc	word [cs:daycnt2] ; account for leap day
  3797                                  		; 08/08/2023
  3798 000018EB FF06[0006]              		inc	word [daycnt2]
  3799                                  no_leap_adjustment:			
  3800 000018EF 8A0E[FF05]              		mov	cl, [bin_date_time+3] ; get days of month
  3801 000018F3 30ED                    		xor	ch, ch
  3802 000018F5 49                      		dec	cx		; because of offset from day 1,	not day	0
  3803                                  		;add	[cs:daycnt2], cx ; GET DAYS IN MONTHS PRECEEDING
  3804                                  		; 08/08/2023
  3805 000018F6 010E[0006]              		add	[daycnt2], cx
  3806 000018FA 8A0E[FE05]              		mov	cl, [bin_date_time+2] ; get month
  3807                                  		; 08/08/2023
  3808                                  		;xor	ch, ch
  3809 000018FE 49                      		dec	cx		; january starts at offset 0
  3810                                  		
  3811                                  		; 08/08/2023
  3812                                  		;shl	cx, 1		; word offset
  3813                                  		;;mov	si, month_table
  3814                                  		;add	si, cx
  3815                                  		;; 16/10/2022
  3816                                  		;; ds must be same with cs here, if so..
  3817                                  		;; what for cs: prefixes are used !?)
  3818                                  		;; mov	ax, [cs:si]
  3819                                  		;; mov	ax, [si] ; 16/10/2022 (MSDOS 5.0 IO.SYS - BIOSDATA:15D5h)
  3820                                  		;mov	ax, [si]	; mov ax, [cs:si]
  3821                                  		;			; get #	days in	previous months
  3822                                  		;add	[cs:daycnt2], ax
  3823                                  
  3824                                  		; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  3825                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:1907h
  3826 000018FF B400                    		mov	ah, 0
  3827 00001901 BE[8F04]                		mov	si, month_tab
  3828                                  r_d_sum_loop:
  3829 00001904 AC                      		lodsb
  3830 00001905 0106[0006]              		add	[daycnt2], ax
  3831 00001909 E2F9                    		loop	r_d_sum_loop
  3832                                  r_d_ret:
  3833                                  		;mov	si, [cs:daycnt2]
  3834                                  		; 08/08/2023
  3835 0000190B 8B36[0006]              		mov	si, [daycnt2]
  3836 0000190F 5A                      		pop	dx
  3837 00001910 59                      		pop	cx
  3838 00001911 5B                      		pop	bx
  3839 00001912 58                      		pop	ax
  3840 00001913 C3                      		retn
  3841                                  
  3842                                  ;-----------------------------------------------------------------------------
  3843                                  r_t_retj:				
  3844 00001914 31C9                    		xor	cx, cx
  3845 00001916 31D2                    		xor	dx, dx
  3846 00001918 EB38                    		jmp	short r_t_ret
  3847                                  
  3848                                  ; =============== S U B	R O U T	I N E ========================================
  3849                                  
  3850                                  ; read_real_time reads the time from the rtc. on exit, it has the number of
  3851                                  ; ticks (at 18.2 ticks per sec.) in cx:dx.
  3852                                  
  3853                                  read_real_time:	; proc near		
  3854 0000191A B402                    		mov	ah, 2
  3855 0000191C CD1A                    		int	1Ah		; CLOCK	- READ REAL TIME CLOCK (AT,XT286,CONV,PS)
  3856                                  					; Return: CH = hours in	BCD
  3857                                  					; CL = minutes in BCD
  3858                                  					; DH = seconds in BCD
  3859 0000191E 72F4                    		jb	short r_t_retj
  3860 00001920 882E[FC05]              		mov	[bin_date_time], ch ; hours
  3861 00001924 880E[FD05]              		mov	[bin_date_time+1], cl ; minutes
  3862 00001928 8836[FE05]              		mov	[bin_date_time+2], dh ; seconds
  3863 0000192C C606[FF05]00            		mov	byte [bin_date_time+3], 0 ; unused for time
  3864 00001931 E89F00                  		call	bcd_verify
  3865 00001934 72DE                    		jb	short r_t_retj
  3866 00001936 E88500                  		call	time_verify
  3867 00001939 72D9                    		jb	short r_t_retj
  3868 0000193B E81500                  		call	in_bin		; from bcd to bin
  3869 0000193E 8A2E[FC05]              		mov	ch, [bin_date_time]
  3870 00001942 8A0E[FD05]              		mov	cl, [bin_date_time+1]
  3871 00001946 8A36[FE05]              		mov	dh, [bin_date_time+2]
  3872 0000194A 8A16[FF05]              		mov	dl, [bin_date_time+3]
  3873                                  		; 16/10/2022
  3874                                  		; 17/09/2022
  3875                                  		; 31/05/2019
  3876 0000194E FF1E[0606]              		call	far [ttticks] 
  3877                                  		;call	dword ptr ttticks ; note: indirect far call
  3878                                  					; cx:dx	= number of ticks
  3879                                  					; (at 18.2 ticks per sec.)
  3880                                  r_t_ret:				
  3881 00001952 C3                      		retn
  3882                                  
  3883                                  ; =============== S U B	R O U T	I N E =======================================
  3884                                  
  3885                                  ;   in_bin converts bin_date_time values from bcd to bin
  3886                                  
  3887                                  in_bin:		; proc near
  3888 00001953 A0[FC05]                		mov	al, [bin_date_time] ; century or hours
  3889 00001956 E81F00                  		call	bcd_to_bin
  3890 00001959 A2[FC05]                		mov	[bin_date_time], al
  3891 0000195C A0[FD05]                		mov	al, [bin_date_time+1] ; years or minutes
  3892 0000195F E81600                  		call	bcd_to_bin
  3893 00001962 A2[FD05]                		mov	[bin_date_time+1], al
  3894 00001965 A0[FE05]                		mov	al, [bin_date_time+2] ; months or seconds
  3895 00001968 E80D00                  		call	bcd_to_bin
  3896 0000196B A2[FE05]                		mov	[bin_date_time+2], al
  3897 0000196E A0[FF05]                		mov	al, [bin_date_time+3] ; days (not used for time)
  3898 00001971 E80400                  		call	bcd_to_bin
  3899 00001974 A2[FF05]                		mov	[bin_date_time+3], al
  3900 00001977 C3                      		retn
  3901                                  
  3902                                  ; =============== S U B	R O U T	I N E =======================================
  3903                                  
  3904                                  ;   bcd_to_bin converts two bcd nibbles in al (value <= 99.) to
  3905                                  ;   a binary representation in al
  3906                                  ;   ah is destroyed
  3907                                  
  3908                                  bcd_to_bin:	; proc near
  3909 00001978 88C4                    		mov	ah, al
  3910 0000197A 240F                    		and	al, 0Fh
  3911 0000197C B104                    		mov	cl, 4
  3912 0000197E D2EC                    		shr	ah, cl
  3913 00001980 D50A                    		aad
  3914 00001982 C3                      		retn
  3915                                  
  3916                                  ; =============== S U B	R O U T	I N E ========================================
  3917                                  
  3918                                  ;   date_verify loosely checks bcd date values to be in range
  3919                                  ;   in bin_date_time
  3920                                  
  3921                                  date_verify:	; proc near
  3922 00001983 803E[FC05]20            		cmp	byte [bin_date_time], 20h ; century check
  3923 00001988 7732                    		ja	short date_error
  3924 0000198A 740E                    		jz	short century_20 ; jmp in 21th century
  3925 0000198C 803E[FC05]19            		cmp	byte [bin_date_time], 19h ; century check
  3926                                  		;jb	short date_error
  3927                                  		; 12/12/2022
  3928 00001991 722A                    		jb	short date_err2
  3929 00001993 803E[FD05]80            		cmp	byte [bin_date_time+1], 80h ; year check
  3930                                  		;jb	short date_error
  3931                                  		; 12/12/2022
  3932 00001998 7223                    		jb	short date_err2
  3933                                  century_20:
  3934 0000199A 803E[FD05]99            		cmp	byte [bin_date_time+1], 99h ; year check
  3935 0000199F 771B                    		ja	short date_error
  3936 000019A1 803E[FE05]12            		cmp	byte [bin_date_time+2], 12h ; month check
  3937 000019A6 7714                    		ja	short date_error
  3938 000019A8 803E[FE05]00            		cmp	byte [bin_date_time+2], 0
  3939                                  		;jbe	short date_error
  3940 000019AD 760D                    		jna	short date_error
  3941 000019AF 803E[FF05]31            		cmp	byte [bin_date_time+3], 31h ; day check
  3942 000019B4 7706                    		ja	short date_error
  3943                                  		;cmp	byte [bin_date_time+3], 0 ; day check
  3944                                  		;;jbe	short date_error
  3945                                  		;jna	short date_error
  3946                                  		; 12/12/2022
  3947                                  		; cf=0
  3948                                  		;clc
  3949                                  		; 12/12/2022
  3950 000019B6 803E[FF05]01            		cmp	byte [bin_date_time+3], 1 ; day check
  3951 000019BB C3                      		retn
  3952                                  ;-----------------------------------------------------------------------------
  3953                                  
  3954                                  date_error:
  3955 000019BC F9                      		stc
  3956                                  date_err2:
  3957 000019BD C3                      		retn
  3958                                  
  3959                                  ; =============== S U B	R O U T	I N E ========================================
  3960                                  
  3961                                  ; time_verify very loosely checks bcd date values to be in range
  3962                                  ; in bin_date_time
  3963                                  
  3964                                  time_verify:	; proc near
  3965 000019BE 803E[FC05]24            		cmp	byte [bin_date_time], 24h ; hour check
  3966 000019C3 770C                    		ja	short time_error
  3967 000019C5 803E[FD05]59            		cmp	byte [bin_date_time+1], 59h ; minute check
  3968 000019CA 7705                    		ja	short time_error
  3969                                  		; 12/12/2022h
  3970                                  		;cmp	byte [bin_date_time+2], 59h ; second check
  3971                                  		;ja	short time_error
  3972                                  		;clc
  3973                                  		;retn
  3974                                  		; 12/12/2022
  3975 000019CC 803E[FE05]5A            		cmp	byte [bin_date_time+2], 5Ah	
  3976                                  time_error:
  3977                                  bv_error:
  3978 000019D1 F5                      		cmc	; cf=0 -> cf=1, cf=1 -> cf=0
  3979 000019D2 C3                      		retn
  3980                                  
  3981                                  ; ----------------------------------------------------------------------------
  3982                                  
  3983                                  ;time_error:				
  3984                                  		;stc
  3985                                  		;retn
  3986                                  
  3987                                  ; =============== S U B	R O U T	I N E ========================================
  3988                                  
  3989                                  ;   bcd_verify checks values in bin_date_time to be valid
  3990                                  ;   bcd numerals.  carry set if any nibble out of range
  3991                                  
  3992                                  bcd_verify:	; proc near
  3993 000019D3 B90400                  		mov	cx, 4		; 4 bytes to check
  3994 000019D6 BB[FC05]                		mov	bx, bin_date_time
  3995                                  bv_loop:
  3996 000019D9 8A07                    		mov	al, [bx]	; get a	bcd number (0..99)
  3997 000019DB 88C4                    		mov	ah, al
  3998 000019DD 250FF0                  		and	ax, 0F00Fh	; 10's place in high ah, 1's in al
  3999                                  					; is 1's place in range?
  4000 000019E0 3C0A                    		cmp	al, 10
  4001 000019E2 77ED                    		ja	short bv_error	; jmp out of range
  4002 000019E4 D0EC                    		shr	ah, 1
  4003 000019E6 D0EC                    		shr	ah, 1
  4004 000019E8 D0EC                    		shr	ah, 1
  4005 000019EA D0EC                    		shr	ah, 1
  4006 000019EC 80E40F                  		and	ah, 0Fh		; get rid of any erroneous bits
  4007 000019EF 80FC0A                  		cmp	ah, 10		; is 10's place in range
  4008 000019F2 77DD                    		ja	short bv_error	; jmp out of range
  4009 000019F4 43                      		inc	bx		; next byte
  4010 000019F5 49                      		dec	cx
  4011 000019F6 75E1                    		jnz	short bv_loop
  4012 000019F8 F8                      		clc			; set success flag
  4013 000019F9 C3                      		retn
  4014                                  ; ----------------------------------------------------------------------------
  4015                                  
  4016                                  		; 12/12/2022
  4017                                  ;bv_error:
  4018                                  		;stc			; set error flag
  4019                                  		;retn
  4020                                  
  4021                                  ; ----------------------------------------------------------------------------
  4022                                  
  4023                                  endk09:
  4024                                  
  4025                                  ; ----------------------------------------------------------------------------
  4026                                  
  4027                                  ;------------------------------------------------------------------------
  4028                                  ;									:
  4029                                  ;	System initialization						:
  4030                                  ;									:
  4031                                  ;	The entry conditions are established by the bootstrap		:
  4032                                  ;	loader and are considered unknown. The following jobs		:
  4033                                  ;	will be performed by this module:				:
  4034                                  ;									:
  4035                                  ;	1.	All device initialization is performed			:
  4036                                  ;	2.	A local stack is set up and DS:SI are set		:
  4037                                  ;		to point to an initialization table. Then		:
  4038                                  ;		an inter-segment call is made to the first		:
  4039                                  ;		byte of the dos 					:
  4040                                  ;	3.	Once the dos returns from this call the ds		:
  4041                                  ;		register has been set up to point to the start		:
  4042                                  ;		of free memory. The initialization will then		:
  4043                                  ;		load the command program into this area 		:
  4044                                  ;		beginning at 100 hex and transfer control to		:
  4045                                  ;		this program.						:
  4046                                  ;									:
  4047                                  ;------------------------------------------------------------------------
  4048                                  
  4049                                  ; 01/10/2022
  4050                                  ; 08/01/2018 - Retro DOS v4.0
  4051                                  ; 14/10/2023 - Retro DOS v5.0
  4052                                  
  4053                                  ; drvfat must be the first location of freeable space!
  4054                                  
  4055                                  align 2
  4056                                  		;db 90h
  4057                                  
  4058                                  ; 20/12/2022 - Retro DOS v4.0 (MSDOS 5.0 combined/single kernel file)
  4059                                  ; ((no need to read/load 'MSDOS.SYS', it is already loaded))
  4060                                  ; (((bios_l,bios_h,doscnt,fatloc,md_sectorsize,temp_cluster,last_fat_sec_num
  4061                                  ;   would be used to read 'MSDOS.SYS' from disk, now they are not needed)))
  4062                                  	
  4063 000019FA 0000                    drvfat:		dw 0			; drive	and fat	id of dos
  4064                                  ;First_Data_Sector:	; 14/10/2023
  4065                                  ;bios_l:	dw 0			; first	sector of data (low word)
  4066                                  ;bios_h:	dw 0			; first	sector of data (high word)
  4067                                  ;doscnt:	dw 0			; how many sectors to read
  4068 000019FC 00                      fbigfat:	db 0			; flags	for drive
  4069                                  ;fatloc:	dw 0			; seg addr of fat sector
  4070 000019FD 0000                    init_bootseg:	dw 0			; seg addr of buffer for reading boot record
  4071 000019FF 80                      rom_drv_num:	db 80h			; rom drive number
  4072                                  ;md_sectorsize:	dw 200h			; used by get_fat_sector proc.
  4073                                  ;temp_cluster:	dw 0			; used by get_fat_sector proc.
  4074                                  ;last_fat_sec_num: dw 0FFFFh		; used by get_fat_sector proc.
  4075                                  
  4076                                  ; the following two bytes are used to save the info returned by int 13, ah = 8
  4077                                  ; call to determine drive parameters.
  4078                                  
  4079 00001A00 02                      num_heads:	db 2			; number of heads returned by rom
  4080                                  		;db 0	; 08/08/2023
  4081 00001A01 09                      sec_trk:	db 9			; sec/trk returned by rom
  4082 00001A02 28                      num_cyln:	db 40			; number of cylinders returned by rom
  4083                                  		;db 0	; 08/08/2023
  4084 00001A03 00                      fakefloppydrv:	db 0			; if 1,	then no	diskette drives	in the system.
  4085                                  
  4086                                  ; 14/10/2023 - Retro DOS v5.0
  4087                                  ; PCDOS 7.1 - IBMBIO.COM - BIOSDATA:1A26h
  4088                                  
  4089                                  Orig_Int1Eh_Table:
  4090 00001A04 00000000                		dd 0
  4091                                  
  4092                                  ; ----------------------------------------------------------------------------
  4093                                  
  4094                                  
  4095                                  ; 14/10/2023 - Retro DOS v5.0
  4096                                  %if 0
  4097                                  
  4098                                  disktable:	dw 512,	0100h, 64, 0	; warning !!! old values
  4099                                  		dw 2048, 0201h, 112, 0
  4100                                  		dw 8192, 0402h, 256, 0
  4101                                  		dw 32680, 0803h, 512, 0	; warning !!! old values
  4102                                  		dw 65535, 1004h, 1024, 0
  4103                                  					; default disktable under
  4104                                  					; the assumption of total fat size <= 128 kb,
  4105                                  					; and the maximum size of fat entry = 16 bit.
  4106                                  %endif
  4107                                  
  4108                                  
  4109                                  ; 14/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  4110                                  ; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:1A2Ah)
  4111                                  
  4112                                  		; 08/08/2023
  4113                                  		; disktable.totalsectors: resd 1
  4114                                  		; disktable.shiftcount:   resb 1
  4115                                  		; disktable.secperclus:   resb 1
  4116                                  		; disktable.rdirentries:  resw 1
  4117                                  		; disktable.bigflag:      resw 1
  4118 00001A08 0000A87F0308000200-     disktable2:	dw 0, 32680, 0803h, 512, 0 ; for compatibility.
  4118 00001A11 00                 
  4119                                  					   ; (32680 sectors, 16340 KB)
  4120 00001A12 040000000204000240-     		dw 4, 0, 0402h, 512, 40h   ; covers upto 134 mb media.
  4120 00001A1B 00                 
  4121                                  					   ; fbig = 40h  ; (40000h sectors = 128 MB)
  4122 00001A1C 080000000308000240-     		dw 8, 0, 0803h, 512, 40h   ; upto 268 mb ; (80000h sectors = 256 MB)
  4122 00001A25 00                 
  4123 00001A26 100000000410000240-     		dw 16, 0, 1004h, 512, 40h  ; upto 536 mb ; (100000h sectors = 512 MB)
  4123 00001A2F 00                 
  4124 00001A30 200000000520000240-     		dw 32, 0, 2005h, 512, 40h  ; upto 1072 mb ; (200000h sectors = 1024 MB)
  4124 00001A39 00                 
  4125 00001A3A 400000000640000240-     		dw 64, 0, 4006h, 512, 40h  ; upto 2144 mb ; (400000h sectors = 2048 MB)
  4125 00001A43 00                 
  4126                                  		; 14/10/2023
  4127                                  		;dw 128, 0, 8007h, 512, 40h ; upto 4288 mb ; (800000h sectors = 4096 MB)
  4128 00001A44 FFFFFFFF0308000060-     		dw 0FFFFh, 0FFFFh, 0803h, 0, 60h
  4128 00001A4D 00                 
  4129                                  					; cluster shift 3, sec per clust = 8
  4130                                  					; > 2144 MB ; FAT32 (fbigbig = 20h)
  4131                                  					; (fbig and fbigbig flags are set)		
  4132                                  			
  4133                                  ; ----------------------------------------------------------------------------
  4134                                  
  4135                                  ;******************************************************
  4136                                  ;variables for mini disk initialization
  4137                                  ;******************************************************
  4138                                  
  4139                                  ; 01/10/2022
  4140                                  ; [ Note: Minidisk == logical dos drive (in extended dos partition) ] 
  4141                                  
  4142 00001A4E 00                      rom_minidisk_num: db 0			; temp variable	for phys unit
  4143 00001A4F 00                      hnum:		db 0			; real number of hardfiles
  4144 00001A50 [3C05]                  last_dskdrv_table: dw dskdrvs		; index	into dskdrv table
  4145 00001A52 [4C08]                  end_of_bdss:	dw bdss			; offset value of the ending address
  4146                                  					; of bds table. needed to figure out
  4147                                  					; the dosdatasg address.
  4148 00001A54 0000                    mini_hdlim:	dw 0			
  4149 00001A56 0000                    mini_seclim:	dw 0
  4150                                  
  4151                                  ; 14/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  4152                                  ; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:1A7Ah) ((ld_p_number))
  4153                                  ; ((Note: 2BADh will be overwritten in 'find_mini_partition', not used.
  4154                                  ;   PCDOS 7.1 IBMBIO.COM contains this number, may be signature))
  4155                                  
  4156                                  ; 19/12/2023
  4157                                  ;ld_p_number:	dw 2BADh     ; (logical disk partition index/sequence number)
  4158                                  
  4159                                  ;end of mini disk init variables **********************
  4160                                  
  4161                                  ; ----------------------------------------------------------------------------
  4162                                  			
  4163 00001A58 30312F31302F383400      bios_date:	db '01/10/84',0 	; used for checking at rom bios	date.
  4164                                  
  4165                                  ; 13/12/2022
  4166                                  %if 0
  4167                                  
  4168                                  ;align 2
  4169                                  		db  90h	
  4170                                  
  4171                                  ; the following are the recommended bpbs for the media that we know of so far.
  4172                                  
  4173                                  ;struc bpbx
  4174                                  ;   resw 1 ; 512
  4175                                  ;   resb 1
  4176                                  ;   resw 1 ; 1
  4177                                  ;   resb 1 ; 2
  4178                                  ;   resw 1
  4179                                  ;   resw 1
  4180                                  ;   resb 1
  4181                                  ;   resw 1
  4182                                  ;   resw 1
  4183                                  ;   resw 1 ; 2
  4184                                  ;   resw 1
  4185                                  ;   resw 1 ; hidden sector high
  4186                                  ;   resd 1 ; extended total sectors
  4187                                  ;.size:
  4188                                  ;endstruc
  4189                                  
  4190                                  ; 08/01/2019 - Retro DOS v4.0
  4191                                  
  4192                                  ; 20/04/2019
  4193                                  
  4194                                  ; 01/10/2022 - Retro DOS v4.0 (MSDOS 5.0) IO.SYS
  4195                                  
  4196                                  ; 09/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  4197                                  ; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:1A86h)
  4198                                  
  4199                                  ; 09/12/2022
  4200                                  BPB48T:
  4201                                  ;bpb48t:	; bpbx <512, 2, 1, 2, 112, 720, 0FDh, 2, 9, 2, 0, 0, 0, 0> 
  4202                                  		; 48 tpi diskettes	;
  4203                                  		dw	512		; physical sector size in bytes
  4204                                  		db	2		; sectors/allocation unit
  4205                                  		dw	1		; reserved sectors for dos
  4206                                  		db	2		; number of allocation tables
  4207                                  		dw	112		; number of directory entries
  4208                                  		dw	720 ; 2*9*40	; number of sectors (at 512 bytes each)
  4209                                  		db	0FDh		; media descriptor
  4210                                  		dw	2		; number of fat sectors
  4211                                  		dw	9		; sectors per track
  4212                                  		dw	2		; heads
  4213                                  		dw	0		; hidden sector count (low word)
  4214                                  		dw	0		; hidden sector (high)
  4215                                  		dw	0		; number of sectors (low)
  4216                                  		dw	0		; number of sectors (high)
  4217                                  		; 09/12/2023
  4218                                  		; FAT32 extensions (to BDS)
  4219                                  		times	28 db 0
  4220                                  		;
  4221                                  		db 90h
  4222                                  ;align 2
  4223                                  BPB96T:
  4224                                  ;bpb96t:	; bpbx <512, 1, 1, 2, 224, 2400, 0F9h, 7, 15, 2, 0, 0, 0, 0> 
  4225                                  		; 96 tpi diskettes	;
  4226                                  		dw	512		; physical sector size in bytes
  4227                                  		db	1		; sectors/allocation unit
  4228                                  		dw	1		; reserved sectors for dos
  4229                                  		db	2		; number of allocation tables
  4230                                  		dw	224		; number of directory entries
  4231                                  		dw	2400 ; 2*15*80	; number of sectors (at 512 bytes each)
  4232                                  		db	0F9h		; media descriptor
  4233                                  		dw	7		; number of fat sectors
  4234                                  		dw	15		; sectors per track
  4235                                  		dw	2		; heads
  4236                                  		dw	0		; hidden sector count (low word)
  4237                                  		dw	0		; hidden sector (high)
  4238                                  		dw	0		; number of sectors (low)
  4239                                  		dw	0		; number of sectors (high)
  4240                                  		; 09/12/2023
  4241                                  		; FAT32 extensions (to BDS)
  4242                                  		times	28 db 0
  4243                                  		;
  4244                                  		db 90h
  4245                                  ;align 2
  4246                                  BPB35:
  4247                                  ;bpb35:		; bpbx <512, 2, 1, 2, 112, 1440, 0F9h, 3, 9, 2, 0, 0, 0, 0> 
  4248                                  		; 3.5" diskettes - 720 KB ;		
  4249                                  		dw	512		; physical sector size in bytes
  4250                                  		db	2		; sectors/allocation unit
  4251                                  		dw	1		; reserved sectors for dos
  4252                                  		db	2		; number of allocation tables
  4253                                  		dw	112		; number of directory entries
  4254                                  		dw	1440 ; 2*9*80	; number of sectors (at 512 bytes each)
  4255                                  		db	0F9h		; media descriptor
  4256                                  		dw	3		; number of fat sectors
  4257                                  		dw	9		; sectors per track
  4258                                  		dw	2		; heads
  4259                                  		dw	0		; hidden sector count (low word)
  4260                                  		dw	0		; hidden sector (high)
  4261                                  		dw	0		; number of sectors (low)
  4262                                  		dw	0		; number of sectors (high)
  4263                                  		; 09/12/2023
  4264                                  		; FAT32 extensions (to BDS)
  4265                                  		times	28 db 0
  4266                                  		;
  4267                                  		db 90h
  4268                                  ;align 2
  4269                                  
  4270                                  ;align 2
  4271                                  ;BPB144:
  4272                                  ;bpb144:	; Retro DOS v4.0 feature only !	; 1.44MB diskettes
  4273                                  ;
  4274                                  ;		dw	512		; physical sector size in bytes
  4275                                  ;		db	1		; sectors/allocation unit
  4276                                  ;		dw	1		; reserved sectors for dos
  4277                                  ;		db	2		; number of allocation tables
  4278                                  ;		dw	224		; number of directory entries
  4279                                  ;		dw	2880 ; 2*18*80	; number of sectors (at 512 bytes each)
  4280                                  ;		db	0F0h		; media descriptor
  4281                                  ;		dw	9		; number of fat sectors
  4282                                  ;		dw	18		; sectors per track
  4283                                  ;		dw	2		; heads
  4284                                  ;		dw	0		; hidden sector count (low word)
  4285                                  ;		dw	0		; hidden sector (high)
  4286                                  ;		dw	0		; number of sectors (low)
  4287                                  ;		dw	0		; number of sectors (high)
  4288                                  ;
  4289                                  ;		db 90h
  4290                                  ;align 2
  4291                                  
  4292                                  BPB288:
  4293                                  ;bpb288:	; bpbx <512, 2, 1, 2, 240, 5760, 0F0h, 9, 36, 2, 0, 0, 0, 0>
  4294                                  		; 3.5" diskettes - 2.88 MB ;	 
  4295                                  		dw	512		; physical sector size in bytes
  4296                                  		db	2		; sectors/allocation unit
  4297                                  		dw	1		; reserved sectors for dos
  4298                                  		db	2		; number of allocation tables
  4299                                  		dw	240		; number of directory entries
  4300                                  		dw	5760 ; 2*36*80	; number of sectors (at 512 bytes each)
  4301                                  		db	0F0h		; media descriptor
  4302                                  		dw	3		; number of fat sectors
  4303                                  		dw	9		; sectors per track
  4304                                  		dw	2		; heads
  4305                                  		dw	0		; hidden sector count (low word)
  4306                                  		dw	0		; hidden sector (high)
  4307                                  		dw	0		; number of sectors (low)
  4308                                  		dw	0		; number of sectors (high)
  4309                                  		; 09/12/2023
  4310                                  		; FAT32 extensions (to BDS)
  4311                                  		times	28 db 0
  4312                                  		;
  4313                                  		db 90h
  4314                                  ;align 2
  4315                                  
  4316                                  %endif
  4317                                  
  4318                                  ; ----------------------------------------------------------------------------
  4319                                  					; align	2
  4320                                  ; 09/12/2022
  4321                                  %if 0
  4322                                  bpbtable:	dw bpb48t		; 48tpi	drives
  4323                                  		dw bpb96t		; 96tpi	drives
  4324                                  		dw bpb35		; 3.5" drives
  4325                                  		dw bpb35		; unused 8" diskette
  4326                                  		dw bpb35		; unused 8" diskette
  4327                                  		dw bpb35		; used for hard	disk
  4328                                  		dw bpb35		; used for tape	drive
  4329                                  		dw bpb35		; FFOTHER
  4330                                  		dw bpb35		; ERIMO
  4331                                  		dw bpb288		; 2.88MB drive
  4332                                  		;
  4333                                  		;dw bpb144		; 1.44MB drive - Retro DOS v4.0 feature !
  4334                                  %endif
  4335                                  
  4336                                  ; 13/12/2022
  4337                                  %if 0
  4338                                  BPBTABLE:	dw BPB48T		; 48tpi	drives
  4339                                  		dw BPB96T		; 96tpi	drives
  4340                                  		dw BPB35		; 3.5" drives
  4341                                  		dw BPB35		; unused 8" diskette
  4342                                  		dw BPB35		; unused 8" diskette
  4343                                  		dw BPB35		; used for hard	disk
  4344                                  		dw BPB35		; used for tape	drive
  4345                                  		dw BPB35		; FFOTHER
  4346                                  		dw BPB35		; ERIMO
  4347                                  		dw BPB288		; 2.88MB drive
  4348                                  		;
  4349                                  		;dw BPB144		; 1.44MB drive - Retro DOS v4.0 feature !
  4350                                  
  4351                                  %endif
  4352                                  
  4353                                  ; ----------------------------------------------------------------------------
  4354                                  
  4355                                  ;	entry point to call utility functions in Bios_Code. At this time,
  4356                                  ;	  we aren't doing any A20 switching. During MSINIT time Bios_Code
  4357                                  ;	  will not yet be moved to its final resting place, so we know
  4358                                  ;	  it'll be low.
  4359                                  ;
  4360                                  ;	to use this function, do a "push cs" and load bp with the offset of
  4361                                  ;	  the function you want to call in Bios_Code. This routine will
  4362                                  ;	  push the address of a retf in Bios_Code onto the stack which
  4363                                  ;	  will get executed when the utility function finishes. It will
  4364                                  ;	  then transfer control to Bios_Code:bp using a couple of pushes
  4365                                  ;	  and a retf
  4366                                  
  4367                                  ; 16/10/2022
  4368                                  ;BC_RETF equ bc_retf - DOSBIOSEG_2C7h
  4369                                  ; 09/12/2022
  4370                                  BC_RETF equ bc_retf
  4371                                  
  4372                                  ; 09/12/2023
  4373                                  ;PCDOS 7.1 IBMBIO.COM bc_retf offset = 0CAh (in BIOSCODE segment = 364h)
  4374                                  
  4375                                  addr_of_bcretf:	;dw 0C8h		; dw bc_retf
  4376                                  					; 2C7h:0C8h = 70h:2638h
  4377                                  					; 09/12/2023
  4378                                  					; 364h:0CAh = 70h:300Ah ; PCDOS 7.1
  4379 00001A61 [CA00]                  		dw BC_RETF		; dw 0CAh
  4380                                  
  4381                                  ; ----------------------------------------------------------------------------
  4382                                  
  4383                                  call_bios_code:	; proc far			
  4384 00001A63 2EFF36[611A]            		push	word [cs:addr_of_bcretf] 
  4385                                  					; set up near return to far return
  4386 00001A68 2EFF36[0406]            		push	word [cs:cdev+2] ; push Bios_Code segment
  4387 00001A6D 55                      		push	bp		; save offset of utility function
  4388 00001A6E CB                      		retf			; far jump to (DOS)BIOS code
  4389                                  
  4390                                  ; ----------------------------------------------------------------------------
  4391                                  		
  4392                                  ;		; 11/12/2023 - Retro DOS v5.0 IBMBIO.COM/IO.SYS
  4393                                  ;		; 20/12/2022
  4394                                  ;flp_drvs:	db 0
  4395                                  ;		; 11/12/2023
  4396                                  ;		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:1B81h)
  4397                                  ;firstcluster_hw: 
  4398                                  ;		db 0
  4399                                  ;Boot_Drv:	db 0
  4400                                  
  4401                                  ; ----------------------------------------------------------------------------
  4402                                  
  4403                                  ; 09/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  4404                                  ;-----------------------------------------------------------------------------
  4405                                  ; PCDOS 7.1 CD BOOT option code 
  4406                                  ;-----------------------------------------------------------------------------
  4407                                  ; (PCDOS 7.1 IBMBIO.COM, BIOSDATA:1B84h)
  4408                                  
  4409                                  cd_boot_option:
  4410                                  		; 10/12/2023 - Retro DOS v5.0 (combined kernel)
  4411                                  		;push	ax
  4412                                  		;push	ds
  4413                                  		;push	es
  4414 00001A6F 52                      		push	dx  ; driver number (dl), media byte (dh)
  4415                                  cdbo_1:
  4416 00001A70 B401                    		mov	ah, 1
  4417 00001A72 CD16                    		int	16h			; KEYBOARD - status
  4418 00001A74 7406                    		jz	short cdbo_2
  4419 00001A76 30E4                    		xor	ah,ah
  4420 00001A78 CD16                    		int	16h			; KEYBOARD - READ CHAR FROM BUFFER, WAIT IF EMPTY
  4421                                  						; Return: AH = scan code, AL = character
  4422 00001A7A EBF4                    		jmp	short cdbo_1
  4423                                  cdbo_2:
  4424 00001A7C 0E                      		push	cs
  4425 00001A7D 1F                      		pop	ds
  4426 00001A7E BE[411B]                		mov	si, cd_boot_msg		; "Press the ENTER key to boot from CD"...
  4427 00001A81 AC                      		lodsb
  4428                                  cdbo_3:
  4429 00001A82 BB0700                  		mov	bx, 7
  4430 00001A85 B40E                    		mov	ah, 0Eh
  4431 00001A87 CD10                    		int	10h			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
  4432                                  						; AL = character, BH = display page (alpha modes)
  4433                                  						; BL = foreground color (graphics modes)
  4434 00001A89 AC                      		lodsb
  4435 00001A8A 08C0                    		or	al, al
  4436 00001A8C 75F4                    		jnz	short cdbo_3
  4437 00001A8E B84000                  		mov	ax, 40h
  4438 00001A91 8ED8                    		mov	ds, ax
  4439                                  		;mov	bx, [6Ch]		; 0:46Ch = Daily timer counter (4 bytes)
  4440                                  		; 09/12/2023
  4441 00001A93 8B166C00                		mov	dx, [6Ch]
  4442 00001A97 8B366E00                		mov	si, [6Eh]
  4443                                  wait_for_key:
  4444                                  		;push	bx
  4445                                  		;mov	bx, 7
  4446                                  		; bx = 7
  4447 00001A9B B8080E                  		mov	ax, 0E08h
  4448 00001A9E CD10                    		int	10h			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
  4449                                  						; AL = character, BH = display page (alpha modes)
  4450                                  						; BL = foreground color (graphics modes)
  4451 00001AA0 B8200E                  		mov	ax, 0E20h
  4452 00001AA3 CD10                    		int	10h			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
  4453                                  						; AL = character, BH = display page (alpha modes)
  4454                                  						; BL = foreground color (graphics modes)
  4455 00001AA5 B8080E                  		mov	ax, 0E08h
  4456 00001AA8 CD10                    		int	10h			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
  4457                                  						; AL = character, BH = display page (alpha modes)
  4458                                  						; BL = foreground color (graphics modes)
  4459                                  		;pop	bx
  4460                                  		;add	bx, 18			; 18.2 ticks per second
  4461                                  		; 09/12/2023
  4462 00001AAA 83C212                  		add	dx, 18
  4463 00001AAD 83D600                  		adc	si, 0			; next second (if carry flag is 1)
  4464                                  continue_to_wait:
  4465 00001AB0 B401                    		mov	ah, 1
  4466 00001AB2 CD16                    		int	16h			; KEYBOARD - status
  4467 00001AB4 7418                    		jz	short cdbo_5
  4468 00001AB6 B400                    		mov	ah, 0
  4469 00001AB8 CD16                    		int	16h			; KEYBOARD - READ CHAR FROM BUFFER, WAIT IF EMPTY
  4470                                  						; Return: AH = scan code, AL = character
  4471                                  
  4472                                  		; 09/12/2023
  4473                                  		;cmp	ax, 11Bh ; ESC key
  4474                                  		;jz	short cdb0_7
  4475                                  ;cdbo_4:
  4476                                  		;push	ax ; *
  4477 00001ABA 89C2                    		mov	dx, ax ; *
  4478                                  
  4479                                  		; CRLF (next line)
  4480                                  		;mov	bx, 7
  4481                                  		; bx = 7
  4482 00001ABC B80D0E                  		mov	ax, 0E0Dh
  4483 00001ABF CD10                    		int	10h			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
  4484                                  						; AL = character, BH = display page (alpha modes)
  4485                                  						; BL = foreground color (graphics modes)
  4486 00001AC1 B80A0E                  		mov	ax, 0E0Ah
  4487 00001AC4 CD10                    		int	10h			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
  4488                                  						; AL = character, BH = display page (alpha modes)
  4489                                  						; BL = foreground color (graphics modes)
  4490                                  		; 09/12/2023
  4491                                  		;pop	ax ; *
  4492                                  			
  4493 00001AC6 81FA1B01                		cmp	dx, 11Bh
  4494                                  		;cmp	ax, 11Bh ; ESC key (to cancel CD/DVD boot)
  4495 00001ACA 7415                    		je	short cdbo_7
  4496                                  		; 10/12/2023
  4497                                  cdbo_4:
  4498 00001ACC 5A                      		pop	dx  ; driver number (dl), media byte (dh)
  4499                                  		; 10/12/2023
  4500                                  		;pop	es
  4501                                  		;pop	ds
  4502                                  		;pop	ax
  4503 00001ACD C3                      		retn
  4504                                  cdbo_5:
  4505 00001ACE 3B366E00                		cmp	si, [6Eh]
  4506 00001AD2 7504                    		jnz	short cdbo_6
  4507                                  		; 09/12/2023
  4508 00001AD4 3B166C00                		cmp	dx, [6Ch]
  4509                                  		;cmp	bx, [6Ch]
  4510                                  cdbo_6:
  4511 00001AD8 73D6                    		jnb	short continue_to_wait
  4512 00001ADA 2EFE0E[401B]            		dec	byte [cs:time_counter]
  4513 00001ADF 75BA                    		jnz	short wait_for_key
  4514                                  cdbo_7:
  4515                                  		; 09/12/2023
  4516                                  		; CRLF (next line)
  4517                                  		;
  4518                                  		;mov	bx, 7
  4519                                  		;mov	ax, 0E0Dh
  4520                                  		;int	10h			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
  4521                                  		;				; AL = character, BH = display page (alpha modes)
  4522                                  		;				; BL = foreground color (graphics modes)
  4523                                  		;mov	ax, 0E0Ah
  4524                                  		;int	10h			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
  4525                                  		;				; AL = character, BH = display page (alpha modes)
  4526                                  		;				; BL = foreground color (graphics modes)
  4527                                  		
  4528 00001AE1 0E                      		push	cs
  4529 00001AE2 1F                      		pop	ds
  4530                                  		; 09/12/2023
  4531 00001AE3 1E                      		push	ds
  4532 00001AE4 07                      		pop	es
  4533                                  		; es = ds = cs
  4534                                  
  4535 00001AE5 B8004B                  		mov	ax, 4B00h
  4536                                  		;xor	dl, dl
  4537                                  		; 09/12/2023
  4538 00001AE8 31D2                    		xor	dx, dx
  4539                                  		; dl = disk drive = 0  ; fd
  4540                                  		;mov	si, 1C93h
  4541 00001AEA BE[2D1B]                		mov	si, empty_dap_buff
  4542 00001AED CD13                    		int	13h			; DISK - Bootable CD-ROM - AL = TERMINATE DISK EMULATION
  4543                                  		; DS:SI = Specification packet filled		
  4544                                  
  4545                                  		;mov	dx, 80h
  4546                                  		;xor	ax, ax
  4547                                  		; 09/12/2023
  4548 00001AEF B81300                  		mov	ax, 19
  4549 00001AF2 89F7                    		mov	di, si	
  4550                                  		;mov	byte [si], 13h
  4551                                  		;mov	[si+1], al
  4552 00001AF4 AB                      		stosw	
  4553                                  		;mov	[si+2], dx
  4554 00001AF5 B080                    		mov	al, 80h
  4555 00001AF7 AB                      		stosw
  4556 00001AF8 89C2                    		mov	dx, ax
  4557                                  		;mov	[si+4], ax
  4558                                  		;mov	[si+6], ax
  4559                                  		;mov	[si+8], ax
  4560                                  		;mov	[si+0Ah], ax
  4561                                  		;mov	[si+0Ch], ax
  4562                                  		;mov	[si+0Eh], ax
  4563                                  		;mov	[si+10h], al
  4564                                  		;mov	[si+11h], al
  4565                                  		;mov	[si+12h], al
  4566 00001AFA B90F00                  		mov	cx, 15
  4567 00001AFD F3AA                    		rep	stosb
  4568                                  		; dl = disk drive = 80h ; hd
  4569 00001AFF B8004B                  		mov	ax, 4B00h
  4570 00001B02 CD13                    		int	13h			; DISK - Bootable CD-ROM - AL = TERMINATE DISK EMULATION
  4571 00001B04 31C0                    		xor	ax, ax
  4572                                  		; 09/12/2023
  4573                                  		;mov	dx, 80h
  4574                                  		; dx = 80h
  4575 00001B06 CD13                    		int	13h			; DISK - RESET DISK SYSTEM
  4576                                  						; DL = drive (if bit 7 is set both hard disks and floppy disks reset)
  4577                                  		; 09/12/2023
  4578                                  		;push	cs
  4579                                  		;pop	es
  4580                                  		; es = ds = cs		
  4581                                  
  4582 00001B08 B80102                  		mov	ax, 201h
  4583                                  		;mov	bx, 152h
  4584 00001B0B BB[5201]                		mov	bx, disksector
  4585                                  		;mov	cx, 1
  4586                                  		; 09/12/2023
  4587 00001B0E 41                      		inc	cx ; cx = 1
  4588                                  		;mov	dx, 80h
  4589                                  		; dx = 80h
  4590 00001B0F CD13                    		int	13h			; DISK - READ SECTORS INTO MEMORY
  4591                                  						; AL = number of sectors to read, CH = track, CL = sector
  4592                                  						; DH = head, DL = drive, ES:BX -> buffer to fill
  4593                                  						; Return: CF set on error, AH = status, AL = number of sectors read
  4594                                  		;jc	short cdbo_8
  4595                                  		; 10/12/2023
  4596 00001B11 72B9                    		jc	short cdbo_4		
  4597                                  
  4598 00001B13 2681BFFE0155AA          		cmp	word [es:bx+1FEh], 0AA55h
  4599                                  		;jz 	short cdbo_9
  4600                                  		; 10/12/2023
  4601 00001B1A 75B0                    		jnz	short cdbo_4
  4602                                  ;cdbo_8:
  4603                                  ;		; 10/12/2023
  4604                                  ;		;jmp	short cdbo_4
  4605                                  ;		pop	dx  ; boot drive number (dl), media byte (dh)	
  4606                                  ;		retn
  4607                                  ;cdbo_9:
  4608                                  		; 10/12/2023
  4609                                  		; dx = 80h
  4610                                  
  4611                                  		; 10/12/2023
  4612                                  		; (stack clearing -pop- is not necessary here, 
  4613                                  		;  Retro DOS v4-v5 boot sector will set stack pointer again)
  4614                                   
  4615                                  		;pop	ax  ; discard dx on top of stack (clear stack)
  4616                                  		;;pop	dx  ; boot drive number (dl), media byte (dh)
  4617                                  		;	    ;		
  4618                                  		;	    ; (Retro DOS v4-v5 boot sector uses DL
  4619                                  		;	    ;  by assuming it contains boot drive number
  4620                                  		;	    ;  from INT 19h.)
  4621                                  		;pop	ax  ; discard near call return address		
  4622                                  		
  4623                                  		; 09/12/2023
  4624                                  		;push	cs
  4625                                  		;pop	ds
  4626                                  		; ds = cs
  4627 00001B1C 31C0                    		xor	ax, ax	; 0
  4628 00001B1E BF007C                  		mov	di, 7C00h
  4629 00001B21 8EC0                    		mov	es, ax
  4630 00001B23 89DE                    		mov	si, bx
  4631 00001B25 06                      		push	es
  4632 00001B26 57                      		push	di
  4633 00001B27 B90001                  		mov	cx, 100h ; 256
  4634                                  		; 10/12/2023
  4635                                  		; cld is not necessary here 
  4636                                  		;	(direction flag is already cleared)
  4637                                  		;cld
  4638 00001B2A F3A5                    		rep movsw
  4639                                  		
  4640                                  		; 10/12/2023
  4641                                  		;mov	ds, ax
  4642                                  		;mov	si, 78h
  4643                                  		;mov	ax, [cs:Orig_Int1Eh_Table]
  4644                                  		;mov	[si], ax
  4645                                  		;mov	ax, [cs:Orig_Int1Eh_Table+2]
  4646                                  		;mov	[si+2], ax
  4647                                  		
  4648 00001B2C CB                      		retf
  4649                                  
  4650                                  ; ----------------------------------------------------------------------------
  4651                                  dap_buffer: ; 16/12/2023
  4652                                  
  4653 00001B2D 13                      empty_dap_buff:	db 19
  4654                                  		;db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0  ; db 18 dup(0)
  4655 00001B2E 00<rep 12h>             		times 18 db 0
  4656 00001B40 05                      time_counter:	db 5	; 5 seconds
  4657 00001B41 0D0A                    cd_boot_msg:	db 0Dh,0Ah
  4658                                  		;db 'Press the ENTER key to boot from CD or DVD......',0
  4659                                  		; 09/12/2023
  4660 00001B43 507265737320616E79-     		db 'Press any key to boot from CD or DVD ...',0
  4660 00001B4C 206B657920746F2062-
  4660 00001B55 6F6F742066726F6D20-
  4660 00001B5E 4344206F7220445644-
  4660 00001B67 202E2E2E00         
  4661                                  
  4662                                  ; ----------------------------------------------------------------------------
  4663                                  
  4664                                  ; 10/12/2023 - Retro DOS v5.0 (PCDOS 7.1)
  4665                                  
  4666                                  ; 01/10/2022 - Retro DOS v4.0 (MSDOS 5.0, classic/old MICROSOFT DOS method)
  4667                                  ; 20/12/2022 - Retro DOS v4.0 (combined kernel files, original/new method) (*)
  4668                                  ;      (*) (for using Retro DOS kernel 'MSDOS.SYS' with Retro DOS boot sector)
  4669                                  
  4670                                  ;-----------------------------------------------------------------------------
  4671                                  ; entry point from boot sector
  4672                                  ;-----------------------------------------------------------------------------
  4673                                  
  4674                                  init:		; 27/12/2018
  4675                                  		; MSDOS 6.0 (MSINIT.ASM)
  4676                                  		;=============================================================
  4677                                  		;
  4678                                  		; entry from boot sector. the register contents are:
  4679                                  		;
  4680                                  		;   dl = int 13 drive number we booted from
  4681                                  		;   ch = media byte
  4682                                  		;   bx = first data sector on disk.
  4683                                  		;   ax = first data sector (high)
  4684                                  		;   di = sectors/fat for the boot media.
  4685                                  
  4686                                  		; 10/12/2023
  4687                                  		; Retro DOS v5.0 (IBMBIO.COM)
  4688                                  		;=============================================================
  4689                                  		; PCDOS 7.1 IBMBIO.COM - registers from MSLOAD section
  4690                                                  ; DL = [BootDrive]
  4691                                  		; CH = [MediaByte]
  4692                                  		; AX:BX = First data Sector
  4693                                  		; DS:SI = Original INT 1Eh table address
  4694                                  		;
  4695                                  		; Stack: INT 1Eh vector (0:78h) !not used! (dword [sp])
  4696                                  		;	 INT 1Eh table address !not used! (dword [sp+4])
  4697                                  		; DI = 78h !not used!
  4698                                  
  4699                                  		; 07/04/2018
  4700                                  		;=============================================================
  4701                                  		; Retro DOS v2.0 - registers from FD Boot Sector 
  4702                                                  ; DL = [bsDriveNumber]
  4703                                  		; DH = [bsMedia]
  4704                                  		; AX = [bsSectors] ; Total sectors
  4705                                  		; DS = 0, SS = 0
  4706                                  		; BP = 7C00h
  4707                                  
  4708                                  		; 29/09/2023
  4709                                  		; SP = 0FFFEh (for Retro DOS v2&v3 boot sector) 
  4710                                  		;    = 07C00h (for MSDOS 5.0 boot sector)
  4711                                  
  4712                                  		; 10/12/2023 - Retro DOS v5.0
  4713                                  		; ------------------------------------------------------------
  4714                                  		; INPUT (registers from Retro DOS v4-v5 boot sector):
  4715                                  		;  DL = [bsDriveNumber]
  4716                                  		;  DH = [bsMedia]
  4717                                  		;  SS = 0
  4718                                  		;  BP = 7C00h (boot sector address)
  4719                                  		;
  4720                                  		; If the boot drive is a CD (CDROM) or DVD
  4721                                  		;    and CD boot option is enabled/requested:
  4722                                  		;    AX = 'CD'
  4723                                  		; If the boot drive is a FD or HD 
  4724                                  		;    or CD boot option is not enabled/requested:
  4725                                  		;    AX <> 'CD'
  4726                                  
  4727                                  ; 20/12/2022
  4728                                  ; Changing original MSDOS 5.0 IO.SYS init code with Retro DOS v4.0 init code.		
  4729                                  %if 0	
  4730                                  		cli
  4731                                  
  4732                                  		push	ax
  4733                                  		xor	ax, ax
  4734                                  		mov	ds, ax
  4735                                  		pop	ax
  4736                                  %endif
  4737                                  
  4738                                  ; 20/12/2022 - Retro DOS v4.0 (combined kernel)
  4739                                  ; 10/12/2023 - Retro DOS v5.0 (combined kernel)
  4740                                  
  4741                                  KERNEL_SEGMENT equ 70h	; (DOS BIOSDATA SEGMENT)
  4742                                  BSSECPERTRACK equ 18h	; boot sector offset 18h (for Retro DOS & MSDOS)	
  4743                                  
  4744                                  ;-----------------------------------------------------------------------------
  4745                                  ; initialization - stage 1
  4746                                  ;-----------------------------------------------------------------------------
  4747                                  ; 02/06/2018 - Retro DOS v3.0
  4748                                  
  4749                                  		; 10/12/2023
  4750 00001B6C FC                      		cld	; may not be necessary
  4751                                  		
  4752                                  		; 21/12/2022
  4753                                  		; Move Retro DOS v2.0 boot sector parameters to 0060h:0
  4754                                  		;mov	bx, 60h
  4755                                  		;mov	es, bx
  4756                                  		;mov	si, bp
  4757                                  		;sub	di, di
  4758                                  		;mov	cx, 35 ; 70 bytes, 35 words
  4759                                  		;;mov	cl, 35
  4760                                  		;rep	movsw
  4761                                  
  4762                                  		; 10/12/2023 - Retro DOS v5.0
  4763 00001B6D 3D4344                  		cmp	ax, 'CD' ; is CD boot option enabled or not ?
  4764 00001B70 7503                    		jne	short init0
  4765                                  
  4766 00001B72 E8FAFE                  		call	cd_boot_option
  4767                                  init0:
  4768 00001B75 0E                      		push	cs
  4769 00001B76 1F                      		pop	ds
  4770                                  
  4771                                  		; 10/12/2023 - Retro DOS v5.0 IO.SYS/IBMBIO.COM
  4772                                  		;mov	[Boot_Drv], dl
  4773                                  
  4774                                  		; 20/03/2019 - Retro DOS v4.0
  4775                                  		;cli		; turn interrupts off while manupulating stack
  4776                                  		;mov	ss, cx	; set stack segment register
  4777                                  
  4778 00001B77 BC0007                  		mov	sp, 0700h ; move stack pointer to safe place
  4779                                  
  4780                                  		;sti		; turn interrupts on
  4781                                  
  4782                                  		; 27/03/2018
  4783                                  		;mov	cx, KERNEL_SIZE	; words !
  4784                                  
  4785                                  		; 20/03/2019
  4786 00001B7A B90080                  		mov	cx, 32768 ; 65536 bytes
  4787                                  
  4788                                  		; 21/12/2022
  4789                                  		; 07/04/2018
  4790 00001B7D BB7000                  		mov	bx, KERNEL_SEGMENT ; 0070h
  4791                                  		;mov	bl, KERNEL_SEGMENT
  4792 00001B80 8EC3                    		mov	es, bx
  4793 00001B82 31FF                    		xor	di, di
  4794 00001B84 89FE                    		mov	si, di
  4795                                  		
  4796                                  		; Move KERNEL file from 1000h:0 to 0070h:0
  4797                                  		; (Retro DOS v2 BS loads 'MSDOS.SYS' at 1000h:0000h)
  4798 00001B86 F3A5                    		rep	movsw
  4799                                  
  4800                                  		; 20/03/2019 - Retro DOS v4.0
  4801 00001B88 53                      		push	bx
  4802                                  		;push	init0
  4803 00001B89 68[8D1B]                		push	init1	; 10/12/2023
  4804 00001B8C CB                      		retf
  4805                                  ;init0:
  4806                                  		; 10/12/2023 - Retro DOS 5.0	
  4807                                  init1:
  4808                                  		; 20/12/2022
  4809                                  		; (combined kernel file > 64KB)
  4810                                  
  4811                                  		; 20/03/2019
  4812 00001B8D B520                    		mov	ch, 20h
  4813 00001B8F 8ED9                    		mov	ds, cx ; 2000h
  4814                                  		;mov	cx, 1070h
  4815 00001B91 B97010                  		mov	cx, KERNEL_SEGMENT+1000h ; 20/12/2022
  4816 00001B94 8EC1                    		mov	es, cx
  4817                                  		
  4818                                  		; 21/12/2022
  4819                                  		;KERNEL_SIZE equ END_OF_KERNEL - BData_start
  4820                                  		; 28/09/2023
  4821                                  		NXWORDCOUNT equ ((KERNEL_SIZE+1)>>1)-32768
  4822                                  
  4823                                  		;mov	cx, KERNEL_SIZE - 32768
  4824                                  		; 28/09/2023 (BugFix)
  4825 00001B96 B90B1D                  		mov	cx, NXWORDCOUNT
  4826                                  		;mov	cx, NXBYTECOUNT
  4827                                  		;shr	cx, 1 ; 28/09/2023
  4828                                  		;xor	si, si
  4829                                  		;xor	di, di
  4830 00001B99 F3A5                    		rep	movsw
  4831                                  
  4832                                  		; 28/09/2023
  4833                                  		;; 17/06/2018 
  4834                                  		;mov	ds, bx
  4835                                  		;; 21/03/2019
  4836                                  		;mov	es, bx
  4837                                  ;init0:
  4838                                  ;		;push	es
  4839                                  ;		push	bx ; 20/03/2019
  4840                                  ;		push	init1 ; 07/04/2018
  4841                                  ;		retf	; jump to 0070h:init1
  4842                                  ;init:
  4843                                  ;init1:
  4844                                  		; 10/12/2023
  4845                                  init2:
  4846                                  		; 20/12/2022
  4847                                  		; Change INT 1Eh diskette parameters table and INT 1Eh address
  4848                                  		; for full MSDOS compatibility.
  4849                                  
  4850                                  		; 10/12/2023
  4851                                  		;cli	; not necessary for INT 1Eh
  4852                                  
  4853 00001B9B 8EC1                    		mov	es, cx ; 0
  4854 00001B9D 8ED9                    		mov	ds, cx ; 0
  4855                                  
  4856 00001B9F B82205                  		mov	ax, SEC9
  4857                                  
  4858                                  		;mov	bx, 1Eh*4  ; [0078h] ; INT 1Eh vector/pointer
  4859 00001BA2 B378                    		mov	bl, 1Eh*4
  4860                                  				; INT 1Eh points to diskette parms table
  4861                                  
  4862                                  		; check if the table is already at 0:SEC9 (0:0522h)
  4863                                   		; (do not move the DPT if is not original ROMBIOS table)
  4864                                  
  4865                                  		;;or	[bx+2],cx [(1Eh*4)+2] ; [007Ah] ; segment
  4866                                  		;;jnz	short mov_dpt
  4867                                  
  4868                                  		;cmp	ax, [bx]  ; [1Eh*4] = 0522h ?
  4869                                  		;je	short dont_mov_dpt
  4870                                  
  4871                                  		;mov	si, [bx] ; [1Eh*4]		
  4872                                  ;mov_dpt:
  4873                                  		;mov	ds, [bx+2] ; [(1Eh*4)+2] ; [007Ah] ; segment
  4874 00001BA4 C537                    		lds	si, [bx]
  4875                                  		
  4876                                  		; 10/12/2023 - Retro DOS v5.0
  4877                                  		;mov	[cs:Orig_Int1Eh_Table+2], ds
  4878                                  		;mov	[cs:Orig_Int1Eh_Table], si
  4879                                  
  4880 00001BA6 89C7                    		mov	di, ax  ; SEC9
  4881 00001BA8 B10B                    		mov	cl, 11
  4882                                  		;cld
  4883 00001BAA F3A4                    		rep	movsb
  4884                                  
  4885                                  		; Set INT 1Eh vector/pointer to the new DPT address
  4886 00001BAC 8ED9                    		mov	ds, cx ; 0
  4887 00001BAE 8907                    		mov	[bx], ax ; SEC9	; [007Eh] ; 1Eh*4  ; offset
  4888 00001BB0 894F02                  		mov	[bx+2], cx ; 0  ; [007Ah] ; 1Eh*4+2 ; segment
  4889                                  ;dont_mov_dpt:
  4890                                  
  4891                                  ; 20/12/2022 - Retro DOS v4.0
  4892                                  %if 0
  4893                                  		; 27/12/2018 - Retro DOS v4.0
  4894                                  		; 'Starting MS-DOS...' message
  4895                                  		; (MSDOS 6.21, IO.SYS Segment: 423h, Offset: 5673h)
  4896                                  		; (0070h:96A3h)
  4897                                  
  4898                                    	    	mov     si, SYSINIT_START+StartMsg ; 18/03/2019
  4899                                  		mov     ah, 0Eh
  4900                                  		;bh = 0
  4901                                          	mov     bl, 7		; "normal" attribute and page
  4902                                  startmsg_nxt_chr:  
  4903                                  		lodsb
  4904                                  		or	al, al
  4905                                          	jz	short startmsg_ok
  4906                                         
  4907                                  		int	10h		; video write
  4908                                          	jmp	short startmsg_nxt_chr
  4909                                  
  4910                                  ;flp_drvs:	db  0 	; 27/12/2018 - Retro DOS v4.0
  4911                                  
  4912                                  startmsg_ok:
  4913                                  
  4914                                  %endif
  4915                                  
  4916                                  ;-----------------------------------------------------------------------------
  4917                                  ; initialization - stage 2
  4918                                  ;-----------------------------------------------------------------------------
  4919                                  ; 20/12/2022 - Retro DOS v4.0 (combined kernel)
  4920                                  
  4921                                  
  4922                                  ; 19/03/2018
  4923                                  ; Retro DOS v2.0 (24/02/2018)
  4924                                  ; [REF: MSDOS 3.3, MSBIO, "MSINIT.ASM"  (24/07/1987)]
  4925                                  
  4926                                  ;------------------------------------------------------------------------
  4927                                  ;									:
  4928                                  ;	System initialization						:
  4929                                  ;									:
  4930                                  ;	The entry conditions are established by the bootstrap		:
  4931                                  ;	loader and are considered unknown. The following jobs		:
  4932                                  ;	will be performed by this module:				:
  4933                                  ;									:
  4934                                  ;	1.	All device initialization is performed			:
  4935                                  ;	2.	A local stack is set up and DS:SI are set		:
  4936                                  ;		to point to an initialization table. Then		:
  4937                                  ;		an inter-segment call is made to the first		:
  4938                                  ;		byte of the dos 					:
  4939                                  ;	3.	Once the dos returns from this call the ds		:
  4940                                  ;		register has been set up to point to the start		:
  4941                                  ;		of free memory. The initialization will then		:
  4942                                  ;		load the command program into this area 		:
  4943                                  ;		beginning at 100 hex and transfer control to		:
  4944                                  ;		this program.						:
  4945                                  ;									:
  4946                                  ;------------------------------------------------------------------------
  4947                                  		
  4948                                  		; 20/12/2022
  4949                                  		; ----------------------
  4950                                  		; Registers
  4951                                  		; ----------------------
  4952                                  		; DL = [bsDriveNumber]
  4953                                  		; DH = [bsMedia]
  4954                                  		; DS = 0, ES = 0, SS = 0
  4955                                  		; BP = 7C00h
  4956                                  		; SP = 700h
  4957                                  		; ----------------------
  4958                                  		; CX = 0				
  4959                                  
  4960                                  ; 02/10/2022 - 20/12/2022
  4961                                  ; ------------------------------------------------------------------------------
  4962                                  ; Note: Retro DOS v4.0 Kernel does not use/contain MSLOAD part of IO.SYS (5.0)
  4963                                  ; 	Because, Retro DOS v2 boot sector loads complete/entire MSDOS.SYS
  4964                                  ;	(RETRODOS.SYS) Kernel file (IO.SYS & MSDOS.SYS together).
  4965                                  ;	As result of boot sector ve init differences, Retro DOS init code (here)
  4966                                  ;	moves kernel to segment 70h at first, then sets diskette parameters
  4967                                  ;	at segment 50h (while MSDOS 5.0 boot sector and then MSLOAD sets this).
  4968                                  ; ------------------------------------------------------------------------------
  4969                                  
  4970                                  ; msload will check the extended boot record and set ax, bx accordingly.
  4971                                  ;
  4972                                  ;;	msload passes a 32 bit sector number hi word in ax and low in bx
  4973                                  ;;	save this in cs:bios_h and cs:bios_l. this is for the start of
  4974                                  ;;	data sector of the bios.
  4975                                  ;
  4976                                  ;		mov	[cs:bios_h], ax	; (start of) dos bios (IO.SYS) data sector
  4977                                  ;		mov	[cs:bios_l], bx
  4978                                  
  4979                                  ; with the following information from msload, we don't need the
  4980                                  ;     boot sector any more.-> this will solve the problem of 29 kb size
  4981                                  ;     limitation of msbio.com file.
  4982                                  
  4983                                  		; 10/12/2023
  4984                                  		; 21/12/2022
  4985                                  		;cli
  4986                                  
  4987 00001BB3 0E                      		push	cs		; Save a peck of interrupt vectors...
  4988 00001BB4 07                      		pop	es
  4989                                  		;push	cx
  4990                                  		;push	di
  4991                                  
  4992                                  		; 20/12/2022
  4993 00001BB5 B105                    		mov	cl, 5
  4994                                  		;mov	cx, 5		; NUMROMVECTORS
  4995                                  					; no. of rom vectors to	be saved
  4996                                  		;mov	si, offset RomVectors ; point to list of int vectors
  4997 00001BB7 BE[0001]                		mov	si, RomVectors
  4998                                  
  4999                                  		; 10/12/2023
  5000 00001BBA FA                      		cli
  5001                                  next_int_:		
  5002 00001BBB 2E                      		cs	; 16/10/2022
  5003 00001BBC AC                      		lodsb		
  5004                                  		;lods	byte ptr cs:[si] ; cs lodsb
  5005 00001BBD 98                      		cbw			; ax = interrupt number
  5006 00001BBE D1E0                    		shl	ax, 1
  5007 00001BC0 D1E0                    		shl	ax, 1		; int no * 4
  5008 00001BC2 89C7                    		mov	di, ax		; interrupt vector address
  5009 00001BC4 87F7                    		xchg	si, di		; rombios interrupt vector address in si
  5010                                  					; saving address in di
  5011                                  		;lodsw			; movsw
  5012                                  		;stosw
  5013                                  		;lodsw			; movsw
  5014                                  		;stosw			; save the vector
  5015                                  		; 20/12/2022
  5016 00001BC6 A5                      		movsw
  5017 00001BC7 A5                      		movsw		
  5018                                  
  5019 00001BC8 87F7                    		xchg	si, di
  5020 00001BCA E2EF                    		loop	next_int_
  5021                                  		
  5022                                  		;pop	di
  5023                                  		;pop	cx
  5024                                  
  5025                                  ; we need to save int13 in two places in case we are running on an at.
  5026                                  ; on ats we install the ibm supplied rom_bios patch which hooks
  5027                                  ; int13 ahead of orig13. since int19 must unhook int13 to point to the
  5028                                  ; rom int13 routine, we must have that rom address also stored away.
  5029                                  
  5030                                  		; 20/12/2022
  5031                                  		;mov	ax, [cs:Old13]	; save old13 in orig13 also
  5032                                  		;mov	[cs:Orig13], ax
  5033                                  		;mov	ax, [cs:Old13+2]
  5034                                  		;mov	[cs:Orig13+2], ax
  5035                                  
  5036                                  		; 10/12/2023
  5037                                  		;cli
  5038                                  
  5039                                  		; 16/10/2022
  5040 00001BCC C7064C00[ED06]          		mov	word [13h*4], block13
  5041                                  		;mov	word ptr ds:4Ch, offset	block13	; 13h*4
  5042                                  					; set up int 13	for new	action
  5043 00001BD2 8C0E4E00                		mov	[13h*4+2], cs
  5044                                  		;mov	word ptr ds:4Eh, cs ; 13h*4+2
  5045 00001BD6 C7065400[9907]          		mov	word [15h*4], Int15
  5046                                  		;mov	word ptr ds:54h, offset	Int15 ;	15h*4
  5047                                  					; set up int 15	for new	action
  5048 00001BDC 8C0E5600                		mov	[15h*4+2], cs
  5049                                  		;mov	word ptr ds:56h, cs ; 15h*4+2
  5050 00001BE0 C7066400[5907]          		mov	word [19h*4], int19
  5051                                  		;mov	word ptr ds:64h, offset	int19 ;	19h*4
  5052                                  					; set up int 19	for new	action
  5053 00001BE6 8C0E6600                		mov	[19h*4+2], cs
  5054                                  		;mov	word ptr ds:66h, cs ; 19h*4+2
  5055                                  
  5056                                  		; 10/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  5057 00001BEA A16800                  		mov	ax, [68h]	 ; 1Ah*4
  5058 00001BED 8B3E6A00                		mov	di, [6Ah]	 ; 1Ah*4+2
  5059 00001BF1 C7066800[AF06]          		mov	word [68h], Int1A
  5060 00001BF7 8C0E6A00                		mov	[6Ah], cs
  5061                                  
  5062                                  		; 20/12/2022
  5063 00001BFB 0E                      		push	cs
  5064 00001BFC 1F                      		pop	ds
  5065                                  		
  5066 00001BFD A1[0601]                		mov	ax, [Old13]	; save old13 in orig13 also
  5067 00001C00 A3[B400]                		mov	[Orig13], ax
  5068 00001C03 A1[0801]                		mov	ax, [Old13+2]
  5069 00001C06 A3[B600]                		mov	[Orig13+2], ax
  5070                                  					; ;
  5071 00001C09 FB                      		sti
  5072 00001C0A CD11                    		int	11h		; EQUIPMENT DETERMINATION
  5073                                  					; Return: AX = equipment flag bits
  5074                                  		; 10/12/2023
  5075                                  		;jmp	short chk_fd_count
  5076                                  		; (PCDOS 7.1 IBMBIO.COM, BIOSDATA:1DF7h) ; *!!*
  5077                                  		; ((signature))
  5078                                  		;push	dx		; 52h ; 'R'
  5079                                  		;push	ax		; 50h ; 'P'
  5080                                  		;push	bx		; 53h ; 'S'
  5081                                  
  5082                                  ; we have to support a system that does not have any diskette
  5083                                  ; drives but only hardfiles. this system will ipl from the hardfile.
  5084                                  ; if the equipment flag bit 0 is 1, then the system has diskette drive(s).
  5085                                  ; otherwise, the system has only hardfiles.
  5086                                  ;
  5087                                  ; important thing is that still, for compatibility reason, the drive letter
  5088                                  ; for the hardfiles start from "c".  so, we still need to allocate dummy bds
  5089                                  ; drive a and drive b. at sysinit time, we are going to set cds table entry
  5090                                  ; of dpb pointer for these drives to 0, so any user attempt to access this
  5091                                  ; drives will get "invalid drive letter ..." message. we are going to
  5092                                  ; establish "fakefloppydrv" flag. ***sysinit module should call int 11h to
  5093                                  ; determine whether there are any diskette drivers in the system or not.!!!***
  5094                                  
  5095                                  ; check the register returned by the equipment determination interrupt
  5096                                  ; we have to handle the case of no diskettes in the system by faking
  5097                                  ; two dummy drives.
  5098                                  ;
  5099                                  ; if the register indicates that we do have floppy drives we don't need
  5100                                  ; to do anything special.
  5101                                  ;
  5102                                  ; if the register indicates that we don't have any floppy drives then
  5103                                  ; what we need to do is set the fakefloppydrv variable, change the
  5104                                  ; register to say that we do have floppy drives and then go to execute
  5105                                  ; the code which starts at notsingle. this is because we can skip the
  5106                                  ; code given below which tries to find if there are one or two drives
  5107                                  ; since we already know about this.
  5108                                  
  5109                                  chk_fd_count:	; 10/12/2023
  5110                                  		;or	ax, 1	; *!!*
  5111                                  
  5112                                  		; 06/05/2019 - Retro DOS v4.0
  5113 00001C0C 88C1                    		mov	cl, al
  5114                                  
  5115                                  		; 12/12/2022
  5116 00001C0E A801                    		test	al, 1
  5117                                  		;test	ax, 1		; floppy drives	present	?
  5118 00001C10 751E                    		jnz	short normalfloppydrv ;	yes.
  5119                                  
  5120                                  ; Some ROM BIOSs lie that there are no floppy drives. Lets find out
  5121                                  ; whether it is an old ROM BIOS or a new one
  5122                                  ;
  5123                                  ; WARNING !!!
  5124                                  ;
  5125                                  ; This sequence of code is present in SYSINIT1.ASM also. Any modification
  5126                                  ; here will require an equivalent modification in SYSINIT1.ASM also
  5127                                  
  5128                                  		; 20/12/2022
  5129                                  		;push	ax
  5130                                  		;push	bx
  5131                                  		;push	cx
  5132 00001C12 52                      		push	dx
  5133                                  		;push	di
  5134 00001C13 06                      		push	es
  5135                                  
  5136 00001C14 B408                    		mov	ah, 8
  5137 00001C16 B200                    		mov	dl, 0
  5138 00001C18 CD13                    		int	13h		; DISK - DISK -	GET CURRENT DRIVE PARAMETERS (XT,AT,XT286,CONV,PS)
  5139                                  					; DL = drive number
  5140                                  					; Return: CF set on error, AH =	status code, BL	= drive	type
  5141                                  					; DL = number of consecutive drives
  5142                                  					; DH = maximum value for head number, ES:DI -> drive parameter
  5143 00001C1A 7202                    		jc	short _gdskp_error
  5144                                  		;;mov	[cs:flp_drvs], dl
  5145                                  		; 20/12/2022
  5146                                  		; ds = cs
  5147                                  		;mov	[flp_drvs], dl
  5148 00001C1C 88D1                    		mov	cl, dl
  5149                                  _gdskp_error:	
  5150                                  		; 20/12/2022			
  5151 00001C1E 07                      		pop	es
  5152                                  		;pop	di
  5153 00001C1F 5A                      		pop	dx
  5154                                  		;pop	cx
  5155                                  		;pop	bx
  5156                                  		;pop	ax
  5157                                  		
  5158 00001C20 720E                    		jc	short normalfloppydrv
  5159                                  					; if error it is an old ROM BIOS
  5160                                  					; so, lets assume that ROM BIOS lied
  5161                                  		; 20/12/2022
  5162                                  		; ds = cs
  5163                                  		;cmp	byte [flp_drvs], 0
  5164                                  		;;cmp	byte [cs:flp_drvs], 0 ; number of drvs == 0?
  5165                                  		;jz	short _set_fake_flpdrv
  5166                                  		;;mov	al, [cs:flp_drvs]
  5167                                  		;mov	al, [flp_drvs]
  5168                                  		;;dec	al		; make it zero based
  5169                                  		;; 18/12/2022
  5170                                  		;dec	ax
  5171                                  		;jmp	short got_num_flp_drvs
  5172                                  		
  5173                                  		; 20/12/2022
  5174 00001C22 08C9                    		or	cl, cl ; [flp_drvs]
  5175 00001C24 7403                    		jz	short _set_fake_flpdrv		
  5176 00001C26 49                      		dec	cx	
  5177 00001C27 EB0B                    		jmp	short got_num_flp_drvs
  5178                                  ; ----------------------------------------------------------------------------
  5179                                  
  5180                                  _set_fake_flpdrv:
  5181                                  		; 20/12/2022
  5182                                  		; ds = cs
  5183                                  		;inc	cl	; cl = 1
  5184                                  		; 10/12/2023
  5185 00001C29 41                      		inc	cx	; cl = 1
  5186 00001C2A 880E[031A]              		mov	[fakefloppydrv], cl ; 1
  5187                                  		;mov	byte [fakefloppydrv], 1		
  5188                                  		;;mov	byte [cs:fakefloppydrv], 1
  5189                                  					; we don't have any floppy drives.
  5190                                  		; 20/12/2022
  5191                                  		;mov	ax, 1
  5192 00001C2E EB0A                    		jmp	short settwodrive ; well then set it for two drives!
  5193                                  ; ----------------------------------------------------------------------------
  5194                                  
  5195                                  normalfloppydrv:			; yes, bit 0 is 1.			
  5196                                  		; 20/12/2022
  5197                                  		;rol	al, 1		; there	exist floppy drives.
  5198                                  		;rol	al, 1		; put bits 6 & 7 into bits 0 & 1
  5199 00001C30 D0C1                    		rol	cl, 1
  5200 00001C32 D0C1                    		rol	cl, 1
  5201                                  got_num_flp_drvs:			
  5202                                  		;;and	ax, 3		; only look at bits 0 &	1
  5203                                  		; 18/12/2022
  5204                                  		;and	al, 3
  5205                                  		; 20/12/2022
  5206 00001C34 80E103                  		and	cl, 3
  5207 00001C37 7505                    		jnz	short notsingle	; zero means single drive system
  5208                                  		; 20/12/2022
  5209 00001C39 41                      		inc	cx
  5210                                  		;inc	ax		; pretend it's a two drive system
  5211                                  settwodrive:				; set this to two fakedrives
  5212                                  		; 20/12/2022
  5213                                  		; ds = cs
  5214 00001C3A FE06[7800]              		inc	byte [single]
  5215                                  		;inc	byte [cs:single] ; remember this
  5216                                  notsingle:	
  5217                                  		; 20/12/2022			
  5218                                  		;inc	ax		; ax has number	of drives, 2-4
  5219                                  		;			; is also 0 indexed boot drive if we
  5220                                  		;			; booted off hard file
  5221                                  		;mov	cl, al		; ch is	fat id,	cl # floppies
  5222                                  		
  5223                                  		; 20/12/2022
  5224                                  		;inc	cl	; cl >= 2
  5225                                  		; 10/12/2023
  5226 00001C3E 41                      		inc	cx	; cl >= 2
  5227                                  
  5228                                  ; 16/10/2022
  5229                                  ; MSDOS 3.3 - "MSEQU.INC" (24/07/1987)
  5230                                  INITSPOT EQU	534h	; IBM wants 4 zeros here
  5231                                  BRKADR	 EQU	1BH * 4	; 6CH, 1BH break vector address
  5232                                  TIMADR	EQU	1CH * 4	; 70H, 1CH timer interrupt
  5233                                  DSKADR	EQU	1EH * 4	; address of ptr to disk parameters
  5234                                  SEC9	EQU	522h	; address of disk parameters
  5235                                  CHROUT	EQU	29h
  5236                                  LSTDRV	EQU     504h
  5237                                  
  5238                                  ; determine whether we booted from floppy or hard disk...
  5239                                  
  5240                                  		; 20/12/2022
  5241 00001C3F 88C8                    		mov	al, cl	; 26/05/2019
  5242                                  
  5243 00001C41 F6C280                  		test	dl, 80h		; boot from floppy ?
  5244 00001C44 7502                    		jnz	short gothrd	; no.
  5245 00001C46 31C0                    		xor	ax, ax		; indicate boot	from drive a
  5246                                  		; 10/12/2023
  5247                                  		;mov	[Boot_Drv], al
  5248                                  gothrd:					
  5249                                  
  5250                                  ; MSDOS 6.0
  5251                                  ;   ax = 0-based drive we booted from
  5252                                  ;   bios_l, bios_h set.
  5253                                  ;   cl = number of floppies including fake one
  5254                                  ;   ch = media byte
  5255                                  
  5256                                  ; Retro DOS 4.0 - 27/12/2018 
  5257                                  ;  (from Retro DOS v2.0 boot sector)
  5258                                  ;   dl = int 13 drive number we booted from
  5259                                  ;   dh = media byte
  5260                                  
  5261                                  		; 20/12/2022
  5262 00001C48 88F5                    		mov	ch, dh		; 01/07/2018
  5263                                  
  5264                                  		; cl = number of floppies
  5265                                  		; ch = media byte
  5266                                  
  5267                                  		; set up local stack
  5268                                  
  5269                                  		; 20/12/2022
  5270                                  		;xor	dx, dx		; ax = 0-based drive we	booted from
  5271                                  					; bios_l, bios_h set.
  5272                                  					; cl = number of floppies including fake one
  5273                                  					; ch = media byte
  5274                                  		; 20/12/2022
  5275                                  		; es = ds = cs
  5276                                  		; ss = 0
  5277                                  		; sp = 700h
  5278                                  
  5279                                  		; 20/12/2022
  5280                                  		;cli
  5281                                  		;mov	ss, dx		; set stack segment and stack pointer
  5282                                  		;mov	sp, 700h
  5283                                  		;sti
  5284                                  
  5285 00001C4A 51                      		push	cx ; (***) 	; save number of floppies and media byte
  5286                                  		
  5287 00001C4B 88EC                    		mov	ah, ch		; FAT ID to AH
  5288 00001C4D 50                      		push	ax ; (**)	; save boot drive number and media byte
  5289                                  		
  5290                                  ; let model_byte, secondary_model_byte be set here!!!
  5291                                  
  5292 00001C4E B4C0                    		mov	ah, 0C0h
  5293 00001C50 CD15                    		int	15h	; SYSTEM - GET CONFIGURATION (XT after 1/10/86,AT mdl 3x9,CONV,XT286,PS)
  5294 00001C52 7215                    		jb	short no_rom_system_conf ; just	use Model_Byte
  5295 00001C54 80FC00                  		cmp	ah, 0
  5296 00001C57 7510                    		jnz	short no_rom_system_conf
  5297                                  
  5298                                  ;		; 20/12/2022
  5299                                  ;		; (Programmer's Guide to the AMIBIOS, page 268)
  5300                                  ;		; (https://stanislavs.org/helppc/int_15-c0.html)
  5301                                  ;
  5302                                  ;		INT 15h, ah = C0h - Return System Configuration Parameters (PS/2 only)
  5303                                  ;
  5304                                  ;		on return:
  5305                                  ;		CF = 0 if successful
  5306                                  ;		   = 1 if error
  5307                                  ;		AH = when CF set, 80h for PC & PCjr, 86h for XT
  5308                                  ;	     	    (BIOS after 11/8/82) and AT (BIOS after 1/10/84)
  5309                                  ;
  5310                                  ;		ES:BX = pointer to system descriptor table in ROM of the format:
  5311                                  ;
  5312                                  ;		Offset Size	     Description
  5313                                  ;
  5314                                  ;		  00   word   length of descriptor (8 minimum)
  5315                                  ;		  02   byte   model byte (same as F000:FFFE, not reliable)
  5316                                  ;		  03   byte   secondary model byte
  5317                                  ;		  04   byte   BIOS revision level (zero based)
  5318                                  ;		  05   byte   feature information, see below
  5319                                  ;		  06   dword  reserved
  5320                                  
  5321                                  		; 20/12/2022
  5322                                  		; ds = cs
  5323 00001C59 268A4702                		mov	al, [es:bx+2]	; [es:bx+ROMBIOS_DESC.bios_sd_modelbyte]
  5324 00001C5D A2[AF05]                		mov	[model_byte], al
  5325                                  		;mov	[cs:model_byte], al
  5326                                  					; get/save model byte
  5327 00001C60 268A4703                		mov	al, [es:bx+3]	; [es:bx+ROMBIOS_DESC.bios_sd_scnd_modelbyte]
  5328 00001C64 A2[B005]                		mov	[secondary_model_byte], al
  5329                                  		;mov	[cs:secondary_model_byte], al
  5330                                  					; get/save secondary model byte
  5331 00001C67 EB0C                    		jmp	short turn_timer_on
  5332                                  ;-----------------------------------------------------------------------------
  5333                                  
  5334                                  no_rom_system_conf:			
  5335 00001C69 BEFFFF                  		mov	si, 0FFFFh
  5336 00001C6C 8EC6                    		mov	es, si
  5337                                  		; 20/12/2022
  5338 00001C6E 26A00E00                		mov	al, [es:0Eh]	; get model byte (from 0FFFFh:0Eh)
  5339 00001C72 A2[AF05]                		mov	[model_byte], al
  5340                                  		;mov	[cs:model_byte], al ; save model byte
  5341                                  turn_timer_on:				
  5342 00001C75 B020                    		mov	al, 20h	; ' '   ; turn on the timer
  5343 00001C77 E620                    		out	20h, al		; Interrupt controller,	8259A.
  5344                                  					; AKPORT
  5345                                  
  5346                                  ; some olivetti m24 machines have an 8530 serial communications
  5347                                  ; chip installed at io address 50h and 52h. if we're running
  5348                                  ; on one of those, we must inhibit the normal aux port initialization
  5349                                  
  5350                                  		; 20/12/2022
  5351                                  		; ds = cs
  5352 00001C79 803E[AF05]00            		cmp	byte [model_byte], 0
  5353                                  		;cmp	byte [cs:model_byte], 0 ; next to last	byte in	rom bios
  5354 00001C7E 7510                    		jnz	short not_olivetti_m24 ; skip for all other machines
  5355                                  					; (except olivetti m24)
  5356 00001C80 E466                    		in	al, 66h		; is 8530 installed?
  5357 00001C82 A820                    		test	al, 20h
  5358 00001C84 740A                    		jz	short not_olivetti_m24 ; we're done if not
  5359 00001C86 B00F                    		mov	al, 0Fh		; double check
  5360 00001C88 E650                    		out	50h, al
  5361 00001C8A E450                    		in	al, 50h
  5362 00001C8C A801                    		test	al, 1		; this test was	copied from olivetti
  5363 00001C8E 7414                    		jz	short skip_aux_port_init ; take	this branch if 8530 installed
  5364                                  
  5365                                  not_olivetti_m24:
  5366 00001C90 B003                    		mov	al, 3		; init com4
  5367 00001C92 E8D909                  		call	aux_init
  5368 00001C95 B002                    		mov	al, 2		; init com3
  5369 00001C97 E8D409                  		call	aux_init
  5370 00001C9A B001                    		mov	al, 1		; init com2
  5371 00001C9C E8CF09                  		call	aux_init
  5372 00001C9F 30C0                    		xor	al, al		; init com1
  5373 00001CA1 E8CA09                  		call	aux_init
  5374                                  
  5375                                  skip_aux_port_init:			
  5376 00001CA4 B002                    		mov	al, 2		; init lpt3
  5377 00001CA6 E8BD09                  		call	print_init
  5378 00001CA9 B001                    		mov	al, 1		; init lpt2
  5379 00001CAB E8B809                  		call	print_init
  5380 00001CAE 30C0                    		xor	al, al		; init lpt1
  5381 00001CB0 E8B309                  		call	print_init
  5382                                  
  5383                                  		; 11/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  5384                                  		;mov	di, 534h	; offset INITSPOT
  5385                                  		;;mov	di, INITSPOT	; 0534h
  5386                                  		;			; IBMDOS.COM's first cluster - high word
  5387                                  		;			; 520h (the 2nd entry of root dir) + 14h
  5388                                  		;mov	ax, [di]
  5389                                  		;mov	[firstcluster_hw], ax
  5390                                  
  5391 00001CB3 31D2                    		xor	dx, dx	; 0
  5392 00001CB5 8EDA                    		mov	ds, dx		; to initialize	print screen vector
  5393 00001CB7 8EC2                    		mov	es, dx
  5394 00001CB9 31C0                    		xor	ax, ax
  5395                                  		; 16/10/2022
  5396 00001CBB BF3405                  		mov	di, INITSPOT	; 0534h
  5397                                  		;mov	di, 534h	; INITSPOT (0000h:0534h)
  5398                                  					; IBM wants 4 zeros here
  5399 00001CBE AB                      		stosw
  5400 00001CBF AB                      		stosw
  5401 00001CC0 8CC8                    		mov	ax, cs		; fetch	segment
  5402 00001CC2 C7066C00[0E06]          		mov	word [BRKADR], cbreak
  5403                                  		;mov	word ptr ds:6Ch, offset	cbreak ; [BRKADR]
  5404                                  					; break	entry point
  5405 00001CC8 A36E00                  		mov	[BRKADR+2], ax		
  5406                                  		;mov	ds:6Eh,	ax	; vector for break
  5407 00001CCB C706A400[8206]          		mov	word [CHROUT*4], outchr
  5408                                  		;mov	word ptr ds:0A4h, offset outchr	; [CHROUT*4]
  5409 00001CD1 A3A600                  		mov	[CHROUT*4+2], ax
  5410                                  		;mov	ds:0A6h, ax	; [CHROUT*4+2]
  5411                                  
  5412 00001CD4 BF0400                  		mov	di, 4
  5413 00001CD7 BB[1406]                		mov	bx, intret ; 19/10/2022
  5414                                  		;mov	bx, offset intret ; intret (cs:intret)
  5415                                  					; will initialize rest of interrupts
  5416 00001CDA 93                      		xchg	ax, bx
  5417 00001CDB AB                      		stosw			; location 4
  5418 00001CDC 93                      		xchg	ax, bx		; cs:
  5419 00001CDD AB                      		stosw			; int 1	; location 6
  5420 00001CDE 83C704                  		add	di, 4
  5421 00001CE1 93                      		xchg	ax, bx
  5422 00001CE2 AB                      		stosw			; location 12
  5423 00001CE3 93                      		xchg	ax, bx		; cs:
  5424 00001CE4 AB                      		stosw			; int 3	; location 14
  5425 00001CE5 93                      		xchg	ax, bx
  5426 00001CE6 AB                      		stosw			; location 16
  5427 00001CE7 93                      		xchg	ax, bx		; cs:
  5428 00001CE8 AB                      		stosw			; int 4	; location 18
  5429                                  
  5430                                  ;		; 20/12/2022
  5431                                  ;		; (https://stanislavs.org/helppc/bios_data_area.html)
  5432                                  ;		Address Size	Description	(BIOS/DOS Data Area)
  5433                                  ;	
  5434                                  ;		50:00	byte	Print screen status byte
  5435                                  ;				 00 = PrtSc not active,
  5436                                  ;				 01 = PrtSc in progress
  5437                                  ;				 FF = error
  5438                                  ;		50:01  3 bytes	Used by BASIC
  5439                                  ;		50:04	byte	DOS single diskette mode flag, 0=A:, 1=B:
  5440                                  ;		50:05  10bytes	POST work area
  5441                                  ;		50:0F	byte	BASIC shell flag; set to 2 if current shell
  5442                                  ;		50:10	word	BASICs default DS value (DEF SEG)
  5443                                  ;		50:12	dword	Pointer to BASIC INT 1C interrupt handler
  5444                                  ;		50:16	dword	Pointer to BASIC INT 23 interrupt handler
  5445                                  ;		50:1A	dword	Pointer to BASIC INT 24 disk error handler
  5446                                  ;		50:20	word	DOS dynamic storage
  5447                                  ;		50:22  14bytes	DOS diskette initialization table (INT 1E)
  5448                                  ;		50:30	4bytes	MODE command
  5449                                  ;		70:00		I/O drivers from IO.SYS/IBMBIO.COM
  5450                                  
  5451 00001CE9 89160005                		mov	[0500h], dx ; 0
  5452                                  		;mov	ds:500h, dx	; set print screen & break = 0
  5453 00001CED 89160405                		mov	[LSTDRV], dx	; [0504h]
  5454                                  		;mov	ds:504h, dx	; clean	out last drive spec
  5455                                  
  5456                                  ; we need to initialize the cs:motorstartup variable from the disk
  5457                                  ; parameter table at sec9. the offsets in this table are defined in
  5458                                  ; the disk_parms struc in msdskprm.inc. 2 locs
  5459                                  
  5460 00001CF1 A02C05                  		mov	al, [SEC9+0Ah]	; 16/10/2022 
  5461                                  		;mov	al, ds:52Ch	; [SEC9+DISK_PARMS.DISK_MOTOR_STRT]
  5462                                  					; [522h+0Ah]
  5463                                  		; 20/12/2022
  5464                                  		; ds = 0
  5465                                  
  5466 00001CF4 2EA2[2601]              		mov	[cs:motorstartup], al
  5467 00001CF8 2E803E[AF05]FD          		cmp	byte [cs:model_byte], 0FDh ; is this an old rom?
  5468 00001CFE 720B                    		jb	short no_diddle	; no
  5469 00001D00 C7062B050F02            		mov	word [SEC9+09h], 20Fh
  5470                                  		;mov	word ptr ds:52Bh, 20Fh ; [SEC9+DISK_PARMS.DISK_HEAD_STTL], 0200h+NORMSETTLE
  5471                                  					; set head settle and motor start on pc-1 pc-2 pc-xt hal0
  5472 00001D06 C6062205DF              		mov	byte [SEC9+0], 0DFh
  5473                                  		;mov	byte ptr ds:522h, 0DFh ; [SEC9+DISK_PARMS.DISK_SPECIFY_1]
  5474                                  					;  set 1st specify byte	on pc-1	pc-2 pc-xt hal0
  5475                                  no_diddle:				
  5476 00001D0B CD12                    		int	12h		; MEMORY SIZE -
  5477                                  					; Return: AX = number of contiguous 1K blocks of memory
  5478 00001D0D B106                    		mov	cl, 6
  5479 00001D0F D3E0                    		shl	ax, cl		; convert memory size to 16-byte blocks	(segment no.)
  5480                                  		
  5481                                  		; 20/12/2022
  5482                                  		; 03/07/2018 - 27/12/2018
  5483                                  		;pop	cx ; (**)
  5484                                  		;mov	[cs:drvfat], cx
  5485                                  		
  5486 00001D11 50                      		push	ax ; (*)	; save real top	of memory
  5487                                  
  5488                                  		; 27/12/2018 - (MSDOS 6.0, 6.21)
  5489                                  
  5490                                  ;M068 - BEGIN
  5491                                  ;------ Check if an RPL program is present at TOM and do not tromp over it
  5492                                  
  5493                                  		; 20/12/2022
  5494                                  		; ds = 0
  5495                                  
  5496                                  		;push	ds
  5497                                  		;push	bx		; pushes not required but since this
  5498                                  					; happens to be a last minute change
  5499                                  					; & since it is only init code.
  5500                                  		;xor	bx, bx
  5501                                  		;mov	ds, bx
  5502                                  		
  5503                                  		;;mov	bx, ds:0BCh	; [2Fh*4]
  5504                                  		;mov	bx, [2Fh*4]
  5505                                  		;;mov	ds, word ptr ds:0BEh ; [2Fh*4+2]
  5506                                  		;mov	ds, [2Fh*4+2]
  5507                                  		; 29/09/2023
  5508 00001D12 C51EBC00                		lds	bx, [2Fh*4]
  5509                                  
  5510 00001D16 817F035250              		cmp	word [bx+3], 'RP' ; 'RPL'
  5511                                  		;cmp	word ptr [bx+3], 'PR' ; 'RPL'
  5512 00001D1B 750F                    		jnz	short SkipRPL
  5513 00001D1D 807F054C                		cmp	byte [bx+5], 'L'
  5514                                  		;cmp	byte ptr [bx+5], 'L'
  5515 00001D21 7509                    		jnz	short SkipRPL
  5516 00001D23 89C2                    		mov	dx, ax		; get TOM into DX
  5517 00001D25 B8064A                  		mov	ax, 4A06h	; (multMULT shl	8) + multMULTRPLTOM
  5518 00001D28 CD2F                    		int	2Fh		; Get new TOM from any RPL
  5519 00001D2A 89D0                    		mov	ax, dx
  5520                                  SkipRPL:	
  5521                                  		; 20/12/2022		
  5522                                  		;pop	bx
  5523                                  		;pop	ds
  5524                                  
  5525                                  ;M068 - END
  5526                                  		; 20/12/2022
  5527                                  		; 27/12/2018
  5528 00001D2C 0E                      		push	cs
  5529 00001D2D 1F                      		pop	ds
  5530                                  
  5531                                  		; 18/03/2019 - Retro DOS v4.0
  5532                                  		;sub	ax, 64		; room for fatloc segment. (1 kb buffer)
  5533                                  		;mov	[cs:fatloc], ax	; location to read fat
  5534                                  
  5535                                  		; 01/07/2018
  5536                                  		; 08/04/2018
  5537                                  		; 28/03/2018
  5538                                  		; MSDOS 6.0 - MSINIT.ASM, 1991
  5539 00001D2E 83E840                  		sub	ax, 64
  5540 00001D31 A3[FD19]                		mov	[init_bootseg], ax ; 20/12/2022
  5541                                  		;mov	[cs:init_bootseg], ax
  5542                                  
  5543                                  		; 27/12/2018 - Retro DOS v4.0
  5544                                  		;;pop	ax ; (*)	; get back real top of memory
  5545                                  		;pop	dx ; (*)
  5546                                  		; 29/09/2023 - Retro DOS v4.2 (BugFix)
  5547 00001D34 58                      		pop	ax ; (*)	; get back real top of memory		
  5548                                  
  5549                                  
  5550                                  		; 20/12/2022
  5551                                  		; 27/12/2018
  5552 00001D35 59                      		pop	cx ; (**)
  5553 00001D36 890E[FA19]              		mov	[drvfat], cx	; save drive to load dos, and fat id
  5554                                  
  5555                                  		; 20/12/2022
  5556                                  
  5557                                  		;mov	dx, 46Dh	; SYSINIT segment
  5558                                  		;mov	dx, 544h	; 10/12/2023 (PCDOS 7.1 IBMBIO.COM)
  5559 00001D3A BAD704                  		mov	dx, SYSINITSEG	; 17/10/2022
  5560 00001D3D 8EDA                    		mov	ds, dx
  5561                                  
  5562                                  ; set pointer to resident device driver chain
  5563                                  
  5564                                  		; 17/10/2022
  5565 00001D3F C706[7502][2300]        		mov	word [DEVICELIST], res_dev_list
  5566                                  		;mov	word [273h], res_dev_list
  5567                                  		;;mov	word ptr ds:273h, offset res_dev_list
  5568                                  					; [SYSINIT+DEVICE_LIST]
  5569 00001D45 8C0E[7702]              		mov	[DEVICELIST+2], cs		
  5570                                  		;mov	[275h], cs
  5571                                  		;;mov	word ptr ds:275h, cs ; [SYSINIT+DEVICE_LIST+2]
  5572                                  
  5573 00001D49 A3[9402]                		mov	[MEMORYSIZE], ax
  5574                                  		;mov	[292h], ax
  5575                                  		;;mov	ds:292h, ax	; [SYSINIT+MEMORY_SIZE]
  5576                                  
  5577 00001D4C FEC1                    		inc	cl
  5578 00001D4E 880E[9802]              		mov	[DEFAULTDRIVE], cl
  5579                                  		;mov	[296h], cl
  5580                                  		;;mov	ds:296h, cl	; [SYSINIT+DEFAULT_DRIVE]
  5581                                  
  5582                                  		;mov	word [CURRENTDOSLOCATION], 0AF8h ; 10/12/2023
  5583 00001D52 C706[7302]AD09          		mov	word [CURRENTDOSLOCATION], DOSLOADSEG
  5584                                  		;mov	word [271h], 83Fh ; (MSDOS.SYS segment)
  5585                                  		;;mov	word ptr ds:271h, 83Fh ; [SYSINIT+CURRENT_DOS_LOCATION]
  5586                                  					; dos_load_seg
  5587                                  
  5588                                  ; important: some old ibm hardware generates spurious int 0F's due to bogus
  5589                                  ; printer cards. we initialize this value to point to an iret only if
  5590                                  ;
  5591                                  ; 1) the original segment points to storage inside valid ram.
  5592                                  ;
  5593                                  ; 2) the original segment is 0F000:xxxx
  5594                                  
  5595                                  		;;;mov	ax, 46Dh	; SYSINIT segment
  5596                                  		;;mov	ax, 544h	; 10/12/2023
  5597                                  		;mov	ax, SYSINITSEG	; 17/10/2022
  5598                                  		;mov	es, ax
  5599                                  		; 20/12/2022
  5600                                  		;push	ds ; SYSINITSEG
  5601                                  		;pop	es
  5602 00001D58 8EC2                    		mov	es, dx ; SYSINITSEG
  5603 00001D5A 31C0                    		xor	ax, ax ; 0
  5604 00001D5C 8ED8                    		mov	ds, ax		; segment 0
  5605                                  		;mov	ax, ds:3Eh	; [0Fh*4+2]
  5606 00001D5E A13E00                  		mov	ax, [0Fh*4+2]	; segment for INT 0Fh
  5607                                  		; 18/10/2022
  5608 00001D61 263B06[9402]            		cmp	ax, [es:MEMORYSIZE] ; es:292h
  5609                                  		;cmp	ax, es:292h	; [ES:MEMORY_SIZE]  ; (condition 1)
  5610 00001D66 7605                    		jbe	short resetintf
  5611 00001D68 3D00F0                  		cmp	ax, 0F000h	; (condition 2)
  5612 00001D6B 750A                    		jnz	short keepintf
  5613                                  resetintf:	
  5614 00001D6D C7063C00[1406]          		mov	word [0Fh*4], intret			
  5615                                  		;mov	word ptr ds:3Ch, offset	intret ; [0Fh*4]
  5616 00001D73 8C0E3E00                		mov	word [0Fh*4+2], cs
  5617                                  		;mov	word ptr ds:3Eh, cs ; [0Fh*4+2]
  5618                                  keepintf:				
  5619                                  ; end important
  5620                                  
  5621                                  ; 17/10/2022
  5622                                  ; 28/12/2018 - Retro DOS v4.0
  5623                                  
  5624                                  ; (MSDOS 6.0, MSINIT.ASM, 1991)
  5625                                  ;
  5626                                  ; we will check if the system has ibm extended keyboard by
  5627                                  ; looking at a byte at 40:96. if bit 4 is set, then extended keyboard
  5628                                  ; is installed, and we are going to set keyrd_func to 10h, keysts_func to 11h
  5629                                  ; for the extended keyboard function. use cx as the temporary register.
  5630                                  
  5631                                  		; 20/12/2022
  5632                                  		; ds = 0
  5633                                  		;xor	cx, cx
  5634                                  		;mov	ds, cx
  5635                                  
  5636 00001D77 8A0E9604                		mov	cl, [496h]	; get keyboard flag
  5637                                  
  5638                                  		; 20/12/2022
  5639                                  		; 20/03/2019
  5640 00001D7B 0E                      		push	cs
  5641 00001D7C 1F                      		pop	ds
  5642                                  
  5643                                  		;test	cl, 00010000b ; 10h
  5644 00001D7D F6C110                  		test	cl, 10h		; extended keyboard ?
  5645 00001D80 740A                    		jz	short org_key	; no, original keyboard
  5646                                  
  5647                                  		; 20/12/2022
  5648                                  		;  ds = cs
  5649 00001D82 C606[7E04]10            		mov	byte [keyrd_func], 10h ; extended keyboard
  5650 00001D87 C606[7F04]11            		mov	byte [keysts_func], 11h
  5651                                  		;mov	byte [cs:keyrd_func], 10h ; extended keyboard
  5652                                  		;mov	byte [cs:keysts_func], 11h
  5653                                  					; change for extended keyboard functions
  5654                                  org_key:
  5655                                  
  5656                                  ; 02/06/2018 - Retro DOS v3.0
  5657                                  
  5658                                  ;**************************************************************
  5659                                  ;	will initialize the number of drives
  5660                                  ;	after the equipment call (int 11h) bits 6&7 will tell
  5661                                  ;	the indications are as follows:
  5662                                  ;
  5663                                  ;	bits	7	6	drives
  5664                                  ;		0	0	1
  5665                                  ;		0	1	2
  5666                                  ;		1	0	3
  5667                                  ;		1	1	4
  5668                                  ;**************************************************************
  5669                                  		
  5670                                  		; 20/12/2022
  5671                                  		; ds = cs		
  5672                                  		;push	cs
  5673                                  		;pop	ds
  5674                                  		; 21/12/2022
  5675                                  		;push	cs
  5676                                  		;pop	es
  5677                                  
  5678 00001D8C E8C00A                  		call	cmos_clock_read	; If cmos clock	exists,
  5679                                  					; then set the system time according to	that.
  5680                                  					; also,	reset the cmos clock rate.
  5681                                  		; 18/10/2022
  5682                                  		;mov	word ptr BData_start, offset harddrv ;
  5683                                  					; set up pointer to hdrive
  5684                                  		; 02/10/2022
  5685 00001D8F C706[0000][4B08]        		mov	word [hdrv_pat], harddrv 
  5686                                  		
  5687                                  		; 20/12/2022
  5688                                  		; 28/12/2018 - Retro DOS v4.0 (MSDOS 6.21)			
  5689 00001D95 58                      		pop	ax ; (***)	; number of floppies and FAT ID
  5690 00001D96 30E4                    		xor	ah, ah		; chuck	fat id byte
  5691 00001D98 A2[7500]                		mov	[drvmax], al	; remember which drive is hard disk
  5692 00001D9B A2[2501]                		mov	[dsktnum], al	; and set initial number of drives
  5693 00001D9E D1E0                    		shl	ax, 1
  5694 00001DA0 0106[501A]              		add	[last_dskdrv_table], ax
  5695                                  
  5696                                  		; 10/12/2023 - Retro DOS v5.0 IO.SYS (IBMBIO.COM)
  5697                                  		; ((MSDOS 6.22 IO.SYS & PCDOS 7.1 IBMBIO.COM))
  5698                                  		; ........
  5699 00001DA4 1E                      		push    ds
  5700 00001DA5 B800F0                  		mov     ax, 0F000h
  5701 00001DA8 8ED8                    		mov     ds, ax
  5702                                  
  5703 00001DAA 813EEAFF434F            		cmp	word [0FFEAh], 'CO' ; 'COMPAQ'
  5704 00001DB0 751F                    		jne	short skip_mode2
  5705 00001DB2 813EECFF4D50            		cmp	word [0FFECh], 'MP'
  5706 00001DB8 7517                    		jne	short skip_mode2
  5707 00001DBA 813EEEFF4151            		cmp	word [0FFEEh], 'AQ'
  5708 00001DC0 750F                    		jne	short skip_mode2
  5709                                  
  5710 00001DC2 B800E4                  		mov	ax, 0E400h	; get advanced system info (COMPAQ ROMBIOS)
  5711 00001DC5 CD15                    		int	15h
  5712 00001DC7 7208                    		jc	short skip_mode2
  5713                                  		; 10/12/2023
  5714                                  		; PCDOS 7.1 IBMBIO.COM
  5715                                  		;or	bx, 0           ; or bx,40h ; enable mode 2
  5716                                  					; (MSDOS 6.0)
  5717                                  		; MSDOS 6.22 IO.SYS
  5718 00001DC9 83CB40                  		or	bx, 40h		; enable mode 2 (dual harddisk controller)
  5719 00001DCC B880E4                  		mov	ax, 0E480h      ; set advanced system info (COMPAQ ROMBIOS)
  5720 00001DCF CD15                    		int	15h
  5721                                  skip_mode2:
  5722 00001DD1 1F                      		pop	ds
  5723                                  		; ........
  5724                                  
  5725 00001DD2 B280                    		mov	dl, 80h
  5726 00001DD4 B408                    		mov	ah, 8
  5727 00001DD6 CD13                    		int	13h		; DISK - DISK -	GET CURRENT DRIVE PARAMETERS (XT,AT,XT286,CONV,PS)
  5728                                  					; DL = drive number
  5729                                  					; Return: CF set on error, AH =	status code, BL	= drive	type
  5730                                  					; DL = number of consecutive drives
  5731                                  					; DH = maximum value for head number, ES:DI -> drive parameter
  5732 00001DD8 7204                    		jc	short enddrv
  5733 00001DDA 8816[4F1A]              		mov	[hnum], dl	; save number of hard disk drives
  5734                                  enddrv:
  5735                                  		; 21/12/2022
  5736 00001DDE 0E                      		push	cs
  5737 00001DDF 07                      		pop	es
  5738                                  
  5739                                  ; scan the list of drives to determine their type. we have three flavors of
  5740                                  ; diskette drives:
  5741                                  ;
  5742                                  ;   48tpi drives    we do nothing special for them
  5743                                  ;   96tpi drives    mark the fact that they have changeline support.
  5744                                  ;   3.5"  drives    mark changeline support and small.
  5745                                  ;
  5746                                  ; the following code uses registers for certain values:
  5747                                  ;
  5748                                  ;   dl - physical drive
  5749                                  ;   ds:di - points to current bds
  5750                                  ;   cx - flag bits for bds
  5751                                  ;   dh - form factor for the drive (1 - 48tpi, 2 - 96tpi, 3 - 3.5" medium)
  5752                                  					
  5753 00001DE0 30D2                    		xor	dl, dl
  5754                                  
  5755                                  		; 20/12/2022
  5756                                  		; ds = cs
  5757                                  		; 17/06/2018		 
  5758                                  		;push	cs
  5759                                  		;pop	ds
  5760                                  
  5761 00001DE2 C606[2C01]09            		mov	byte [eot], 9
  5762 00001DE7 BF[1901]                		mov	di, start_bds 	; if we	are faking floppy drives we need
  5763                                  					; to set aside two bdss	for the	two fake floppy	drives
  5764                                  
  5765                                  ; 02/10/2022 - Retro DOS v4.0 (MSDOS 5.0 IO.SYS)
  5766                                  ; 28/12/2018 - Retro DOS v4.0 (MSDOS 6.0, MSINIT.ASM)
  5767                                  
  5768                                  ; check to see if we are faking floppy drives. if not we don't
  5769                                  ; do anything special. if we are faking floppy drives we need
  5770                                  ; to set aside two bdss for the two fake floppy drives. we
  5771                                  ; don't need to initalise any fields though. so starting at start_bds
  5772                                  ; use the link field in the bds structure to go to the second bds
  5773                                  ; in the list and initalise it's link field to -1 to set the end of
  5774                                  ; the list. then jump to the routine at dohard to allocate/initialise
  5775                                  ; the bds for harddrives.
  5776                                  
  5777 00001DEA 803E[031A]01            		cmp	byte [fakefloppydrv], 1
  5778 00001DEF 750B                    		jnz	short loop_drive
  5779 00001DF1 8B3D                    		mov	di, [di]	; [di+BDS.link]
  5780                                  					; di <-	first bds link
  5781 00001DF3 8B3D                    		mov	di, [di]	; [di+BDS.link]
  5782                                  					; di <-	second bds link
  5783 00001DF5 C705FFFF                		mov	word [di], 0FFFFh ; -1 ; set end of link
  5784 00001DF9 E98801                  		jmp	dohard		; allocate/initialise bds for harddrives
  5785                                  ;-----------------------------------------------------------------------------
  5786                                  
  5787                                  loop_drive:				
  5788 00001DFC 3A16[7500]              		cmp	dl, [drvmax]
  5789 00001E00 7203                    		jb	short got_more
  5790 00001E02 E97B01                  		jmp	done_drives
  5791                                  ;-----------------------------------------------------------------------------
  5792                                  
  5793                                  got_more:	
  5794                                  		; 12/12/2023
  5795                                  		;xor	cx, cx		; zero all flags
  5796 00001E05 8B3D                    		mov	di, [di]	; [di+BDS.link]
  5797                                  					; get next bds
  5798                                  		; ........
  5799                                  		; 10/12/2023 - Retro DOS v5.0
  5800                                  		; (PCDOS 7.1 IBMBIO.COM BIOSDATA:2046h) 
  5801 00001E07 83FFFF                  		cmp	di, 0FFFFh      ; end of link ?
  5802 00001E0A 7516                    		jne	short not_last_bds
  5803 00001E0C 88D0                    		mov	al, dl          ; drive number (0 based)
  5804 00001E0E 98                      		cbw
  5805 00001E0F 01C0                    		add	ax, ax
  5806 00001E11 05[3C05]                		add	ax, dskdrvs
  5807 00001E14 A3[501A]                		mov	[last_dskdrv_table], ax
  5808 00001E17 8B3E[521A]              		mov	di, [end_of_bdss]
  5809 00001E1B E8FB09                  		call	xinstall_bds
  5810 00001E1E FE0E[7500]              		dec	byte [drvmax]
  5811                                  not_last_bds:
  5812                                  		; ........
  5813                                  
  5814 00001E22 B600                    		mov	dh, 0		; ff48tpi
  5815                                  					; set form factor to 48	tpi
  5816 00001E24 C606[021A]28            		mov	byte [num_cyln], 40 ; 40 tracks per side
  5817                                  		
  5818                                  		; 20/12/2022
  5819                                  		;push	ds ; 11/05/2019	
  5820 00001E29 57                      		push	di
  5821 00001E2A 52                      		push	dx
  5822                                  		;push	cx ; not necessary (10/12/2023)
  5823 00001E2B 06                      		push	es ; ((*)) ; 20/12/2022
  5824                                  
  5825                                  		; ...........
  5826                                  		; 10/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  5827                                  		;xor	bx, bx
  5828                                  		;xor	cx, cx
  5829 00001E2C 52                      		push	dx  ; dl = drive number	
  5830                                  		
  5831 00001E2D B408                    		mov	ah, 8
  5832 00001E2F CD13                    		int	13h		; DISK - DISK -	GET CURRENT DRIVE PARAMETERS (XT,AT,XT286,CONV,PS)
  5833                                  					; DL = drive number
  5834                                  					; Return: CF set on error, AH =	status code, BL	= drive	type
  5835                                  					; DL = number of consecutive drives
  5836                                  					; DH = maximum value for head number, ES:DI -> drive parameter
  5837                                  		;jc	short noparmsfromrom
  5838                                  		; 10/12/2023
  5839 00001E31 58                      		pop	ax  ; al = drive number
  5840 00001E32 7303                    		jnc	short chk_drv_type
  5841 00001E34 E9E600                  		jmp	noparmsfromrom
  5842                                  
  5843                                  chk_drv_type:
  5844                                  		; 10/12/2023
  5845                                  		; ch = low eight bits of maximum cylinder number
  5846                                  		; cl = maximum sector number (bits 5-0)
  5847                                  		;      high two bits of maximum cylinder number (bits 7-6)
  5848                                  		;
  5849 00001E37 80FB10                  		cmp	bl, 10h		; ATAPI Removable Media Device
  5850 00001E3A 7554                    		jne	short not_atapi_removable
  5851                                  		
  5852                                  		; save ds:si
  5853 00001E3C 1E                      		push	ds
  5854                                  		;push	si	; not necessary (10/12/2023)
  5855                                  		
  5856 00001E3D 88C2                    		mov	dl, al
  5857 00001E3F 83EC1A                  		sub	sp, 26
  5858 00001E42 31C0                    		xor	ax, ax ; 0
  5859 00001E44 50                      		push	ax
  5860 00001E45 B81E00                  		mov	ax, 30
  5861 00001E48 50                      		push	ax
  5862 00001E49 89E6                    		mov	si, sp		; DS:SI = segment:offset pointer to Result Buffer
  5863 00001E4B 16                      		push	ss
  5864 00001E4C 1F                      		pop	ds
  5865 00001E4D B448                    		mov	ah, 48h
  5866 00001E4F CD13                    		int	13h		; DISK - IBM/MS Extension
  5867                                  					; GET DRIVE PARAMETERS (DL - drive, DS:SI - buffer)
  5868 00001E51 7239                    		jb	short ext_gdp_err
  5869 00001E53 8B4408                  		mov	ax, [si+8]	; physical number of heads
  5870 00001E56 A3[001A]                		mov	[num_heads], ax
  5871 00001E59 8B4404                  		mov	ax, [si+4]	; physical number of cylinders
  5872 00001E5C A3[021A]                		mov	[num_cyln], ax
  5873 00001E5F 8A440C                  		mov	al, [si+0Ch]	; physical number of sectors per track
  5874 00001E62 A2[011A]                		mov	[sec_trk], al
  5875 00001E65 3A06[2C01]              		cmp	al, [eot]
  5876 00001E69 7603                    		jbe	short _eotok
  5877 00001E6B A2[2C01]                		mov	[eot], al
  5878                                  
  5879                                  _eotok:		; 10/12/2023
  5880                                  		;xor	al, al
  5881 00001E6E 31C9                    		xor	cx, cx ; 0
  5882 00001E70 F6440210                		test	byte [si+2], 10h ; information flags
  5883                                  					; bit 4 = Device has change line support
  5884 00001E74 7403                    		jz	short not_chgline_sup
  5885                                  		;or	al, 2		; change line support
  5886 00001E76 80C902                  		or	cl, 2
  5887                                  not_chgline_sup:
  5888 00001E79 83C41E                  		add	sp, 30
  5889                                  		;pop	si	; (10/12/2023)
  5890 00001E7C 1F                      		pop	ds
  5891                                  		;
  5892 00001E7D 07                      		pop	es	; es=cs=ds (21/12/2022)
  5893                                  		;pop	cx	; (10/12/2023)
  5894 00001E7E 5A                      		pop	dx
  5895 00001E7F 5F                      		pop	di
  5896                                  		;pop	ds	; (21/12/2022)
  5897                                  
  5898                                  		; 10/12/2023
  5899 00001E80 F6C102                  		test	cl, 2
  5900                                  		;test	al, 2
  5901                                  		;jz	short gotother_j
  5902 00001E83 7450                    		jz	short gotother
  5903                                  		;or	cl, al
  5904 00001E85 C606[7700]01            		mov	byte [fhave96], 1 ; Device has change line support
  5905                                  gotother_j:
  5906 00001E8A EB49                    		jmp	short gotother
  5907                                  ext_gdp_err:
  5908 00001E8C 83C41E                  		add	sp, 30
  5909                                  		;pop	si	; (10/12/2023)
  5910 00001E8F 1F                      		pop	ds
  5911                                  
  5912                                  		; 10/12/2023
  5913                                  not_atapi_removable:
  5914                                  		; ...........
  5915                                  
  5916                                  
  5917                                  ; if cmos is bad, it gives es,ax,bx,cx,dh,di=0. cy=0.
  5918                                  ; in this case, we are going to put bogus informations to bds table.
  5919                                  ; we are going to set ch=39,cl=9,dh=1 to avoid divide overflow when
  5920                                  ; they are calculated at the later time. this is just for the diagnostic
  5921                                  ; diskette which need msbio,msdos to boot up before it sets cmos.
  5922                                  ; this should only happen with drive b.
  5923                                  
  5924 00001E90 80FD00                  		cmp	ch, 0		; if ch=0, then	cl,dh=0	too.
  5925 00001E93 7505                    		jnz	short pfr_ok
  5926                                  
  5927                                  		;mov	ch, 39		; rom gave wrong info.
  5928                                  		;mov	cl, 9		; let's default to 360k.
  5929                                  		; 20/12/2022
  5930 00001E95 B90927                  		mov	cx, 2709h
  5931                                  
  5932 00001E98 B601                    		mov	dh, 1
  5933                                  pfr_ok:					
  5934                                  		;inc	dh		; make number of heads 1-based
  5935                                  		;mov	[num_heads], dh	; save parms returned by rom
  5936                                  		; 10/12/2023
  5937 00001E9A 86D6                    		xchg	dl, dh
  5938 00001E9C 30F6                    		xor	dh, dh
  5939 00001E9E 42                      		inc	dx		; make number of heads 1-based
  5940 00001E9F 8916[001A]              		mov	[num_heads], dx
  5941                                  
  5942                                  		;inc	ch		; make number of cylinders 1-based
  5943                                  		;and	cl, 3Fh
  5944                                  		;mov	[sec_trk], cl
  5945                                  		;mov	[num_cyln], ch	; assume less than 256 cylinders!!
  5946                                  		; 10/12/2023
  5947 00001EA3 88CA                    		mov	dl, cl
  5948 00001EA5 80E23F                  		and	dl, 3Fh
  5949 00001EA8 8816[011A]              		mov	[sec_trk], dl
  5950 00001EAC 86CD                    		xchg	cl, ch
  5951 00001EAE D0C5                    		rol	ch, 1
  5952 00001EB0 D0C5                    		rol	ch, 1
  5953 00001EB2 80E503                  		and	ch, 3
  5954 00001EB5 41                      		inc	cx		; make number of cylinders 1-based
  5955 00001EB6 890E[021A]              		mov	[num_cyln], cx
  5956                                  
  5957                                  ; make sure that eot contains the max number of sec/trk in system of floppies
  5958                                  
  5959                                  		;mov	cl, [sec_trk] ; 10/12/2023
  5960                                  		;cmp	cl, [eot]	; may set carry
  5961                                  		;;jbe	short eot_ok
  5962                                  		;; 09/12/2022
  5963                                  		;;jne	short eotok  ; wrong ! 14/08/2023
  5964                                  		;; 14/08/2023
  5965                                  		;jbe	short eotok
  5966                                  		;mov	[eot], cl
  5967                                  		; 10/12/2023
  5968 00001EBA 3A16[2C01]              		cmp	dl, [eot] ; dl = [sec_trk]
  5969 00001EBE 7604                    		jbe	short eotok
  5970 00001EC0 8816[2C01]              		mov	[eot], dl
  5971                                  ;eot_ok:
  5972                                  eotok:
  5973                                  		; 10/12/2023
  5974                                  		; !!!
  5975                                  		; (following pops are moved to 'chk_changeline' procedure)
  5976                                  		;
  5977                                  		; 20/12/2022
  5978                                  		;pop	es ; ((*)) es = cs = ds
  5979                                  		;;pop	cx	; 10/12/2023
  5980                                  		;pop	dx
  5981                                  		;pop	di
  5982                                  
  5983                                  		; 20/12/2022
  5984                                  		;pop	ds
  5985                                  
  5986                                  ; Check	for presence of	changeline
  5987                                  
  5988                                  ; 10/12/2023
  5989                                  %if 0
  5990                                  		; 10/12/2023
  5991                                  		;xor	cx, cx	; 0
  5992                                  		;push	cx
  5993                                  		push	dx
  5994                                  
  5995                                  		mov	ah, 15h
  5996                                  		int	13h		; DISK - DISK -	GET TYPE (AT,XT2,XT286,CONV,PS)
  5997                                  					; DL = drive ID
  5998                                  					; Return: CF set on error, AH =	disk type (3 = hard drive)
  5999                                  					; CX:DX	= number of sectors on the media
  6000                                  		; 10/12/2023
  6001                                  		pop	dx
  6002                                  		;pop	cx
  6003                                  		mov	cx, 0 ; 12/12/2023
  6004                                  		jc	short changeline_done
  6005                                  		cmp	ah, 2		; check	for presence of	changeline
  6006                                  		jnz	short changeline_done
  6007                                  
  6008                                  ; we have a drive with change line support.
  6009                                  
  6010                                  		or	cl, 2		; fchangeline
  6011                                  					; signal type
  6012                                  		mov	byte [fhave96], 1 ; remember that we have 96tpi disks
  6013                                  %endif
  6014                                  		; 10/12/2023
  6015 00001EC4 E83800                  		call	chk_changeline
  6016                                  		;jc	short changeline_done
  6017                                  
  6018                                  ; we now try to set up the form factor for the types of media that we know
  6019                                  ; and can recognise. for the rest, we set the form factor as "other".
  6020                                  
  6021                                  changeline_done:
  6022                                  
  6023                                  ; 40 cylinders and 9 or less sec/trk, treat as 48 tpi medium.
  6024                                  			
  6025 00001EC7 803E[021A]28            		cmp	byte [num_cyln], 40
  6026 00001ECC 750B                    		jnz	short try_80
  6027 00001ECE 803E[011A]09            		cmp	byte [sec_trk], 9
  6028 00001ED3 765F                    		jbe	short nextdrive
  6029                                  gotother:
  6030                                  		; 10/12/2023
  6031                                  		; ch = 0, cl = 2 or 0
  6032                                  				
  6033 00001ED5 B607                    		mov	dh, 7 		; ffOther
  6034                                  					; we have a "strange" medium 
  6035 00001ED7 EB5B                    		jmp	short nextdrive
  6036                                  ;-----------------------------------------------------------------------------
  6037                                  
  6038                                  ; 80 cylinders and 9 sectors/track => 720 kb device
  6039                                  ; 80 cylinders and 15 sec/trk => 96 tpi medium
  6040                                  
  6041                                  try_80:					
  6042 00001ED9 803E[021A]50            		cmp	byte [num_cyln], 80
  6043 00001EDE 75F5                    		jnz	short gotother
  6044 00001EE0 B609                    		mov	dh, 9 ; ff288	; assume 2.88 MB drive
  6045 00001EE2 803E[011A]24            		cmp	byte [sec_trk], 36 ; is it ?
  6046 00001EE7 744B                    		jz	short nextdrive	; yeah,	go update
  6047                                  
  6048                                  		; 12/05/2019 (ff144 type will not be used -compatibility problem-)
  6049                                  		; 08/01/2018 - Retro DOS v4.0 feature only ! for 1.44MB diskettes
  6050                                  		;mov	dh, ff144
  6051                                  		;cmp	byte [sec_trk], 18
  6052                                  		;je	short nextdrive
  6053                                  
  6054 00001EE9 803E[011A]0F            		cmp	byte [sec_trk], 15
  6055 00001EEE 740B                    		jz	short got96
  6056                                  		
  6057 00001EF0 803E[011A]09            		cmp	byte [sec_trk], 9
  6058 00001EF5 75DE                    		jnz	short gotother
  6059                                  		
  6060 00001EF7 B602                    		mov	dh, 2 		; ffSmall
  6061 00001EF9 EB39                    		jmp	short nextdrive
  6062                                  ; ----------------------------------------------------------------------------
  6063                                  
  6064                                  got96:					
  6065 00001EFB B601                    		mov	dh, 1		; ff96tpi
  6066 00001EFD EB35                    		jmp	short nextdrive
  6067                                  
  6068                                  ; ----------------------------------------------------------------------------
  6069                                  		
  6070                                  		; 10/12/2023 - Retro DOS v5.0 IO.SYS/IBMBIO.COM
  6071                                  		; check change line feature (and set fhave96 if there is)
  6072                                  		; (common procedure for 'eotok:' and 'noparmsfromrom:')
  6073                                  chk_changeline:
  6074 00001EFF 59                      		pop	cx ; near call return address
  6075                                  
  6076                                  		; (pop es, dx, di for 'eotok' and 'noparmsfromrom' procs)
  6077 00001F00 07                      		pop	es ; es=cs=ds ; 21/12/2022
  6078                                  		;pop	cx	; (10/12/2023)
  6079 00001F01 5A                      		pop	dx
  6080 00001F02 5F                      		pop	di ; BDS address/offset
  6081                                  		
  6082 00001F03 51                      		push	cx ; near call return address
  6083                                  
  6084                                  		;xor	cx, cx ; 0
  6085                                  		;push	cx
  6086 00001F04 52                      		push	dx
  6087                                  
  6088 00001F05 B415                    		mov	ah, 15h
  6089 00001F07 CD13                    		int	13h		; DISK - DISK -	GET TYPE (AT,XT2,XT286,CONV,PS)
  6090                                  					; DL = drive ID
  6091                                  					; Return: CF set on error, AH =	disk type (3 = hard drive)
  6092                                  					; CX:DX	= number of sectors on the media
  6093 00001F09 5A                      		pop	dx
  6094                                  		;pop	cx
  6095 00001F0A B90000                  		mov	cx, 0
  6096 00001F0D 720D                    		jc	short chk_chgl_1
  6097                                  
  6098 00001F0F 80FC02                  		cmp	ah, 2		; is there changeline?
  6099 00001F12 7508                    		jne	short chk_chgl_2 ; *
  6100                                  
  6101 00001F14 80C902                  		or	cl, 2
  6102                                  		;or	cl, ah ; 2
  6103 00001F17 C606[7700]01            		mov	byte [fhave96], 1 ; fchangeline
  6104                                  		; cf = 0
  6105                                  chk_chgl_1:
  6106                                  chk_chgl_2:
  6107 00001F1C C3                      		retn
  6108                                  
  6109                                  ;chk_chgl_2:	; *
  6110                                  ;		; 10/12/2023
  6111                                  ;		; ah = 1 ; harddisk type (ah = 3) return not possible here for floppies 
  6112                                  ;		;stc
  6113                                  ;		; cf = 1
  6114                                  ;		retn
  6115                                  
  6116                                  ; ----------------------------------------------------------------------------
  6117                                  
  6118                                  ; we have an old rom, so we either have a 48tpi or 96tpi drive. if the drive
  6119                                  ; has changeline, we assume it is a 96tpi, otherwise we treat it as a 48tpi.
  6120                                  
  6121                                  noparmsfromrom:
  6122                                  		; 10/12/2023
  6123                                  		; !!!
  6124                                  		; (following pops are moved to 'chk_changeline' procedure)
  6125                                  		;
  6126                                  		; 20/12/2022
  6127                                  		;pop	es ; ((*))
  6128                                  		;;pop	cx	; (10/12/2023)
  6129                                  		;pop	dx
  6130                                  		;pop	di
  6131                                  		
  6132                                  		; 20/12/2022
  6133                                  		;pop	ds
  6134                                  ; 10/12/2023
  6135                                  %if 0
  6136                                  		; 10/12/2023
  6137                                  		;xor	cx, cx ; 0
  6138                                  		;push	cx
  6139                                  		push	dx
  6140                                  
  6141                                  
  6142                                  		mov	ah, 15h
  6143                                  		int	13h		; DISK - DISK -	GET TYPE (AT,XT2,XT286,CONV,PS)
  6144                                  					; DL = drive ID
  6145                                  					; Return: CF set on error, AH =	disk type (3 = hard drive)
  6146                                  					; CX:DX	= number of sectors on the media
  6147                                  		; 10/12/2023
  6148                                  		pop	dx
  6149                                  		;pop	cx
  6150                                  		mov	cx, 0 ; 12/12/2023
  6151                                  		jc	short nextdrive
  6152                                  
  6153                                  		cmp	ah, 2		; is there changeline?
  6154                                  		jnz	short nextdrive
  6155                                  
  6156                                  		or	cl, 2
  6157                                  		mov	byte [fhave96], 1 ; fchangeline
  6158                                  %endif
  6159                                  		; 10/12/2023
  6160 00001F1D E8DFFF                  		call	chk_changeline
  6161 00001F20 7212                    		jc	short nextdrive
  6162                                  		
  6163                                  		; change line support, [fhave96] = 1
  6164                                  		
  6165 00001F22 C606[021A]50            		mov	byte [num_cyln], 80
  6166 00001F27 B601                    		mov	dh, 1		; ff96tpi
  6167 00001F29 B00F                    		mov	al, 15
  6168 00001F2B 3A06[2C01]              		cmp	al, [eot]
  6169 00001F2F 7603                    		jbe	short nextdrive
  6170 00001F31 A2[2C01]                		mov	[eot], al
  6171                                  ; ----------------------------------------------------------------------------
  6172                                  
  6173                                  ;eot_ok2:
  6174                                  nextdrive:
  6175                                  		; 10/12/2023
  6176                                  		; ch = 0, cl = 2 or 0	
  6177                                  				
  6178 00001F34 80C920                  		or	cl, 20h	; fi_own_physical
  6179                                  					; set this true	for all	drives
  6180 00001F37 88D7                    		mov	bh, dl		; save int13 drive number
  6181                                  
  6182                                  ; we need to do special things if we have a single drive system and are setting
  6183                                  ; up a logical drive. it needs to have the same int13 drive number as its
  6184                                  ; counterpart, but the next drive letter. also reset ownership flag.
  6185                                  ; we detect the presence of this situation by examining the flag single for the
  6186                                  ; value 2.
  6187 00001F39 803E[7800]02            		cmp	byte [single], 2
  6188 00001F3E 7505                    		jnz	short not_special
  6189 00001F40 FECF                    		dec	bh		; int13	drive number same for logical drive
  6190 00001F42 80F120                  		xor	cl, 20h	; fi_own_physical
  6191                                  					; reset	ownership flag for logical drive
  6192                                  not_special:
  6193                                  
  6194                                  ; the values that we put in for BDS_RBPB.BPB_HEADS and
  6195                                  ; BDS_RBPB.BPB_SECTORSPERTRACK will only remain if the
  6196                                  ; form factor is of type "ffother".
  6197                                  				
  6198                                  		;xor	ax, ax		; fill BDS for drive
  6199                                  		;mov	al, [num_heads]
  6200                                  		; 10/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM) ; *
  6201 00001F45 A1[001A]                		mov	ax, [num_heads]
  6202                                  		;mov	[di+36h], ax	; [di+BDS.rheads]
  6203 00001F48 894552                  		mov	[di+52h], ax	; [di+BDS.rheads] ; *
  6204 00001F4B 31C0                    		xor	ax, ax		; *
  6205 00001F4D A0[011A]                		mov	al, [sec_trk]
  6206                                  		;mov	[di+34h], ax	; [di+BDS.rsecpertrack]
  6207 00001F50 894550                  		mov	[di+50h], ax	; [di+BDS.rsecpertrack] ; *
  6208                                  		;mov	[di+23h], cx	; [di+BDS.flags]
  6209 00001F53 894D3F                  		mov	[di+3Fh], cx	; [di+BDS.flags] ; *
  6210                                  		;mov	[di+22h], dh	; [di+BDS.formfactor]
  6211 00001F56 88753E                  		mov	[di+3Eh], dh	; [di+BDS.formfactor] ; *
  6212 00001F59 885505                  		mov	[di+5],	dl	; [di+BDS.drivelet]
  6213 00001F5C 887D04                  		mov	[di+4],	bh	; [di+BDS.drivenum]
  6214                                  		;mov	bl, [num_cyln]
  6215                                  		;mov	[di+25h], bl	; [di+BDS.cylinders]
  6216                                  		; 10/12/2023
  6217 00001F5F A1[021A]                		mov	ax, [num_cyln]
  6218 00001F62 894541                  		mov	[di+41h], ax	; [di+BDS.cylinders] ; *
  6219                                  
  6220 00001F65 803E[7800]01            		cmp	byte [single], 1 ; Special case for single drive system
  6221 00001F6A 7510                    		jnz	short no_single
  6222                                  		;mov	byte [single], 2 ; Don't forget we have
  6223                                  					; single drive system
  6224                                  		; 10/12/2023
  6225 00001F6C FE06[7800]              		inc	byte [single]	; [single] = 2
  6226                                  		; 18/12/2022
  6227 00001F70 80C910                  		or	cl, 10h
  6228                                  		;or	cx, 10h		; fi_am_mult
  6229                                  					; set that this	is one of several drives
  6230                                  		;or	[di+23h], cx	; [di+BDS.flags]
  6231 00001F73 094D3F                  		or	[di+3Fh], cx	; [di+BDS.flags] ; *
  6232                                  					; save flags
  6233 00001F76 8B3D                    		mov	di, [di]	; [di+BDS.link]
  6234                                  					; move to next BDS in list
  6235 00001F78 FEC2                    		inc	dl		; add a	number
  6236 00001F7A EBB8                    		jmp	short nextdrive	; Use same info	for BDS	as previous
  6237                                  ; ----------------------------------------------------------------------------
  6238                                  
  6239                                  no_single:				
  6240                                  		;inc	dl
  6241                                  		; 18/12/2022
  6242 00001F7C 42                      		inc	dx
  6243 00001F7D E97CFE                  		jmp	loop_drive
  6244                                  ; ----------------------------------------------------------------------------
  6245                                  
  6246                                  		; 11/12/2023 - Retro DOS v5.0 IO.SYS/IBMBIO.COM
  6247                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:21E8h)
  6248                                  done_drives:	
  6249                                  		;mov	word [di+BDS.link], -1
  6250 00001F80 C705FFFF                		mov	word [di], -1	; set link to null
  6251                                  
  6252                                  ; set up all the hard drives in	the system
  6253                                  
  6254                                  		; 20/12/2022
  6255                                  		; 28/12/2018 - Retro DOS v4.0 (MSDOS 6.21)
  6256                                  dohard:					
  6257 00001F84 8A36[4F1A]              		mov	dh, [hnum]
  6258 00001F88 08F6                    		or	dh, dh		; done if no hardfiles
  6259 00001F8A 7459                    		jz	short static_configure
  6260 00001F8C B280                    		mov	dl, 80h
  6261                                  dohard1:				
  6262 00001F8E 52                      		push	dx
  6263 00001F8F 8B3E[521A]              		mov	di, [end_of_bdss]
  6264 00001F93 8A1E[7500]              		mov	bl, [drvmax]
  6265 00001F97 B700                    		mov	bh, 0		; first	primary	partition (or active)
  6266 00001F99 E89A01                  		call	sethard
  6267 00001F9C 7208                    		jb	short hardfile_err
  6268 00001F9E E86308                  		call	dmax_check	; error	if already 26 drives
  6269 00001FA1 7303                    		jnb	short hardfile_err
  6270 00001FA3 E87308                  		call	xinstall_bds	; insert new bds into linked list
  6271                                  hardfile_err:				
  6272 00001FA6 5A                      		pop	dx
  6273                                  		;inc	dl		; next hard drive
  6274                                  		; 12/12/2023
  6275 00001FA7 42                      		inc	dx
  6276 00001FA8 FECE                    		dec	dh
  6277 00001FAA 75E2                    		jnz	short dohard1
  6278                                  
  6279                                  ; end of physical drive	initialization
  6280                                  
  6281                                  ; *** do not change the position of the following statement.
  6282                                  ; *** domini routine will use [drvmax] value for the start of the logical
  6283                                  ; *** drive number of mini disk(s).
  6284                                  					
  6285 00001FAC E8C806                  		call	domini		; for setting up mini disks, if found
  6286                                  
  6287                                  ; -- begin added section
  6288                                  
  6289 00001FAF 8A36[4F1A]              		mov	dh, [hnum]	; we already know this is >0
  6290 00001FB3 B280                    		mov	dl, 80h
  6291                                  dohardx1:				
  6292 00001FB5 B701                    		mov	bh, 1		; do all subsequent primary partitions
  6293                                  dohardx2:				
  6294 00001FB7 52                      		push	dx
  6295 00001FB8 53                      		push	bx
  6296 00001FB9 8B3E[521A]              		mov	di, [end_of_bdss]
  6297 00001FBD 8A1E[7500]              		mov	bl, [drvmax]
  6298 00001FC1 E87201                  		call	sethard
  6299 00001FC4 720E                    		jb	short dohardx4	; move to next hardfile if error
  6300 00001FC6 E83B08                  		call	dmax_check	; make sure <=26 drives
  6301 00001FC9 7309                    		jnb	short dohardx4	; skip if error
  6302 00001FCB E84B08                  		call	xinstall_bds	; insert new bds into linked list
  6303 00001FCE 5B                      		pop	bx		; get partition number
  6304 00001FCF 5A                      		pop	dx		; restore physical drive counts
  6305 00001FD0 FEC7                    		inc	bh
  6306 00001FD2 EBE3                    		jmp	short dohardx2	; keep looping until we fail
  6307                                  ; ----------------------------------------------------------------------------
  6308                                  
  6309                                  dohardx4:				
  6310 00001FD4 5B                      		pop	bx		; unjunk partition number from stack
  6311 00001FD5 5A                      		pop	dx		; restore physical drive counts
  6312                                  		;inc	dl		; next hard drive
  6313                                  		; 12/12/2023
  6314 00001FD6 42                      		inc	dx
  6315 00001FD7 FECE                    		dec	dh
  6316 00001FD9 75DA                    		jnz	short dohardx1
  6317                                  
  6318                                  ; -- end changed section
  6319                                  
  6320                                  ;******************************************************************************
  6321                                  ; if more than 2 diskette drives on the system, then it is necessary to remap
  6322                                  ; the bds chain to adjust the logical drive num (drive letter) with greater
  6323                                  ; than two diskette drives
  6324                                  ;
  6325                                  ; new scheme:	if more than 2 disktte drives, first map the bds structure
  6326                                  ;		as usual and then rescan the bds chain to adjust the  drive
  6327                                  ;		letters. to do this, scan for disk drives and assign logical
  6328                                  ;		drive number starting from 2 and then rescan diskette drives
  6329                                  ;		and assign next to the last logical drive number of last disk
  6330                                  ;		drive to the 3rd and 4th diskette drives.
  6331                                  ;******************************************************************************
  6332                                  
  6333 00001FDB 803E[2501]02            		cmp	byte [dsktnum], 2 ; >2 diskette drives
  6334                                  		;jbe	short static_configure ; no - no need for remapping
  6335 00001FE0 7603                    		jbe	short no_remap
  6336 00001FE2 E8D500                  		call	remap		; remap	bds chain to adjust driver letters
  6337                                  no_remap:
  6338                                  
  6339                                  ; End of drive initialization.
  6340                                  
  6341                                  ; ----------------------------------------------------------------------------
  6342                                  
  6343                                  ;we now decide, based on the configurations available so far, what
  6344                                  ;code or data we need to keep as a stay resident code. the following table
  6345                                  ;shows the configurations under consideration. they are listed in the order
  6346                                  ;of their current position memory.
  6347                                  ;
  6348                                  ;configuration will be done in two ways:
  6349                                  ;
  6350                                  ;first, we are going to set "static configuration". static configuration will
  6351                                  ;consider from basic configuration to endof96tpi configuration. the result
  6352                                  ;of static configuration will be the address the dynamic configuration will
  6353                                  ;use to start with.
  6354                                  ;
  6355                                  ;secondly, "dynamic configuration" will be performed. dynamic configuration
  6356                                  ;involves possible relocation of code or data. dynamic configuration routine
  6357                                  ;will take care of bdsm tables and at rom fix module thru k09 suspend/resume
  6358                                  ;code individually. after these operation, [dosdatasg] will be set.
  6359                                  ;this will be the place sysinit routine will relocate msdos module for good.
  6360                                  
  6361                                  ; -- begin changed section
  6362                                  ;
  6363                                  ;   1.	 basic configuration for msbio (endfloppy)
  6364                                  ;   2.   end96tpi	; a system that supports "change line error"
  6365                                  ;   3.	 end of bdss	; end of bdss for hard disks
  6366                                  ;   4.	 endatrom	;some of at rom fix module.
  6367                                  ;   5.	 endcmosclockset;supporting program for cmos clock write.
  6368                                  ;   6.	 endk09 	;k09 cmos clock module to handle suspend/resume operation.
  6369                                  ;
  6370                                  
  6371                                  ; 02/10/2022 - Retro DOS v4.0 (MSDOS v5.0 IO.SYS)
  6372                                  
  6373                                  static_configure:			
  6374 00001FE5 8B3E[521A]              		mov	di, [end_of_bdss]
  6375 00001FE9 81FF[4C08]              		cmp	di, bdss	; 19/10/2022
  6376                                  		;cmp	di, offset bdss	; did we allocate any hard drive bdss?
  6377 00001FED 750D                    		jnz	short dynamic_configure	; that's the end, then
  6378                                  		; 18/10/2022
  6379 00001FEF BF[4C08]                		mov	di, end96tpi
  6380                                  		;mov	di, offset harddrv ; end96tpi
  6381                                  					; keep everything up to end96tpi
  6382 00001FF2 803E[7700]00            		cmp	byte [fhave96], 0
  6383 00001FF7 7503                    		jnz	short dynamic_configure
  6384                                  		
  6385 00001FF9 BF[3808]                		mov	di, endfloppy
  6386                                  dynamic_configure:
  6387                                  		; 20/12/2022
  6388                                  		;push	cs
  6389                                  		;pop	es
  6390                                  		
  6391                                  		; 10/12/2023
  6392 00001FFC FC                      		cld	; clear direction flag is not necessary here !?
  6393                                  			; because there will not be a running program
  6394                                  			; which will set direction flag as backward (std)
  6395                                  
  6396                                  ; -- end changed section
  6397                                  
  6398                                  		; 20/12/2022
  6399                                  		; ds = cs <> es
  6400                                  		; ss = 0
  6401                                  		; sp = 700h
  6402                                  
  6403                                  		; 13/12/2023
  6404 00001FFD BE00F0                  		mov	si, 0F000h
  6405 00002000 8EC6                    		mov	es, si		; ES ->	ROM BIOS segment
  6406                                  
  6407 00002002 803E[AF05]FC            		cmp	byte [model_byte], 0FCh ; AT ?
  6408                                  		;jnz	short checkcmosclock
  6409                                  		; 10/12/2023
  6410 00002007 751E                    		jnz	short checkcompaqbug ; no
  6411 00002009 803E[4F1A]00            		cmp	byte [hnum], 0	; No hard file?
  6412                                  		;jz	short checkcmosclock
  6413 0000200E 7417                    		jz	short checkcompaqbug
  6414 00002010 97                      		xchg	ax, di		; save allocation pointer in ax
  6415                                  		; 13/12/2023
  6416                                  		;mov	si, 0F000h
  6417                                  		;mov	es, si		; ES ->	ROM BIOS segment
  6418 00002011 BE[581A]                		mov	si, bios_date	; "01/10/84"
  6419 00002014 BFF5FF                  		mov	di, 0FFF5h	; ROM BIOS string is at	F000:FFF5
  6420 00002017 B90900                  		mov	cx, 9		; bdate_l
  6421                                  					; Only patch ROM for bios 01/10/84
  6422 0000201A F3A6                    		repe cmpsb		; check	for date + zero	on end
  6423 0000201C 97                      		xchg	ax, di		; restore allocation pointer
  6424                                  
  6425                                  ; M015 -- begin changes
  6426                                  
  6427                                  		;jnz	short checkcmosclock
  6428                                  		; 02/10/2022
  6429 0000201D 7508                    		jnz	short checkcompaqbug
  6430                                  
  6431                                  ; install at rom fix
  6432                                  
  6433                                  		; 19/10/2022
  6434                                  		;mov	cx, offset endatrom
  6435 0000201F B9[2018]                		mov	cx, endatrom
  6436                                  		;mov	si, offset ibm_disk_io
  6437 00002022 BE[F216]                		mov	si, ibm_disk_io
  6438 00002025 EB46                    		jmp	short install_int13_patch
  6439                                  ; ----------------------------------------------------------------------------
  6440                                  
  6441                                  ; M065 -- begin changes
  6442                                  ;
  6443                                  ; On certain systems with Western Digital disk controllers, the
  6444                                  ; following detection scheme caused an unpredictable and serious
  6445                                  ; failure. In particular, they've implemented a nonstandard
  6446                                  ; Int13(ah=16h) which reconfigures the hard drive, depending on
  6447                                  ; what happens to be at es:[bx] and other memory locations indexed
  6448                                  ; off of it.
  6449                                  ;
  6450                                  ; Compaq was unable to tell us exactly which kind of systems have
  6451                                  ; the bug, except that they guarantee that the bug was fixed in
  6452                                  ; ROM BIOSs dated 08/04/86 and later. We'll check for the COMPAQ
  6453                                  ; string, and then look for date codes before 08/04/86 to decide
  6454                                  ; when to install the hook.
  6455                                  
  6456                                  ;checkcmosclock:
  6457                                  ; 02/10/2022				
  6458                                  checkcompaqbug:
  6459                                  		; 20/12/2022
  6460                                  		; es = 0F000h
  6461                                  		;mov	ax, 0F000h	; point	to ROM BIOS
  6462                                  		;mov	es, ax
  6463                                  
  6464                                  		; 19/10/2022
  6465 00002027 26813EEAFF434F          		cmp	word [es:0FFEAh], 'CO'
  6466                                  		;cmp	word ptr es:0FFEAh, 'OC' ; look for COMPAQ
  6467 0000202E 754B                    		jnz	short not_compaq_patch
  6468 00002030 26813EECFF4D50          		cmp	word [es:0FFECh], 'MP'
  6469                                  		;cmp	word ptr es:0FFECh, 'PM'
  6470 00002037 7542                    		jnz	short not_compaq_patch
  6471 00002039 26813EEEFF4151          		cmp	word [es:0FFEEh], 'AQ'
  6472                                  		;cmp	word ptr es:0FFEEh, 'QA'
  6473 00002040 7539                    		jnz	short not_compaq_patch
  6474                                  
  6475                                  ; We're running on a COMPAQ. Now look at the date code.
  6476                                  
  6477 00002042 26A1FBFF                		mov	ax, [es:0FFFBh]	; get year
  6478 00002046 86E0                    		xchg	ah, al
  6479                                  
  6480                                  ; 11/12/2023
  6481                                  ; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:22B9h)
  6482                                  %if 0
  6483                                  		cmp	ax, 3836h       ; '68' (NASM syntax) (('86' in MASM syntax))
  6484                                  		ja	short not_compaq_patch
  6485                                  		jz	short chkcompaqbug1
  6486                                  		cmp	ax, 3739h       ; '97'
  6487                                  		jbe	short not_compaq_patch
  6488                                  		stc
  6489                                  chkcompaqbug1:
  6490                                  		jb	short do_compaq_patch
  6491                                  		mov	ax, [es:0FFF5h]
  6492                                  		xchg	ah, al
  6493                                  		cmp	ax, 3038h       ; '80'
  6494                                  		ja	short not_compaq_patch
  6495                                  		jb	short do_compaq_patch
  6496                                  		mov	ax, [es:0FFF8h]
  6497                                  		xchg	ah, al
  6498                                  		cmp	ax, 3034h       ; '40'
  6499                                  		jnb	short not_compaq_patch
  6500                                  do_compaq_patch:
  6501                                  %endif
  6502                                  		; 11/12/2023
  6503                                  		; (MSDOS 6.22 IO.SYS - BIOSDATA:1C85h)
  6504                                  
  6505 00002048 3D3638                  		cmp	ax, 3836h ; 02/10/2022 (NASM syntax)
  6506                                  		;cmp	ax, '86'        ; 3836h
  6507                                  					; is it	86?
  6508 0000204B 772E                    		ja	short not_compaq_patch
  6509 0000204D 7218                    		jb	short do_compaq_patch
  6510 0000204F 26A1F5FF                		mov	ax, [es:0FFF5h]	; get month
  6511 00002053 86E0                    		xchg	ah, al
  6512 00002055 3D3830                  		cmp	ax, 3038h ; 02/10/2022 (NASM syntax)
  6513                                  		;cmp	ax, '08'        ; 3038h
  6514                                  					; is it	08?
  6515 00002058 7721                    		ja	short not_compaq_patch
  6516 0000205A 720B                    		jb	short do_compaq_patch
  6517 0000205C 26A1F8FF                		mov	ax, [es:0FFF8h]	; get day
  6518 00002060 86E0                    		xchg	ah, al
  6519 00002062 3D3430                  		cmp	ax, 3034h ; 02/10/2022 (NASM syntax)
  6520                                  		;cmp	ax, '04'        ; 3034h
  6521                                  					; is it	04?
  6522 00002065 7314                    		jnb	short not_compaq_patch
  6523                                  
  6524                                  do_compaq_patch:			
  6525 00002067 B9[3D18]                		mov	cx, end_compaq_i13hook
  6526                                  		;mov	si, endatrom
  6527                                  		; 11/12/2023
  6528 0000206A BE[2018]                		mov	si, compaq_disk_io ; endatrom
  6529                                  
  6530                                  install_int13_patch:			
  6531 0000206D 0E                      		push	cs
  6532 0000206E 07                      		pop	es
  6533                                  		; 18/10/2022
  6534 0000206F 893E[B400]              		mov	[Orig13], di	; set new rom bios int 13 vector
  6535 00002073 8C0E[B600]              		mov	[Orig13+2], cs
  6536 00002077 29F1                    		sub	cx, si		; size of rom fix module
  6537 00002079 F3A4                    		rep movsb		; relocate it
  6538                                  
  6539                                  ; M065 -- end changes
  6540                                  
  6541                                  ; ----------------------------------------------------------------------------
  6542                                  not_compaq_patch:			; M065
  6543                                  		; 17/10/2022
  6544                                  checkcmosclock:	
  6545                                  		; 18/10/2022		
  6546 0000207B 0E                      		push	cs
  6547 0000207C 07                      		pop	es
  6548                                  
  6549                                  		; 20/12/2022
  6550                                  		; ds = cs = es
  6551                                  		; ss = 0
  6552                                  		; sp = 700h
  6553                                  
  6554                                  ; 09/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  6555                                  %if 0
  6556                                  		cmp	byte [havecmosclock], 1 ; cmos clock exists?
  6557                                  		jnz	short checkk09	; no
  6558                                  
  6559                                  		mov	word [daycnttoday], di
  6560                                  		;mov	word ptr ds:daycnttoday, di ; set the address for mschar
  6561                                  		mov	cx, 209	 ; enddaycnttoday - daycnt_to_day
  6562                                  		mov	si, daycnt_to_day
  6563                                  		rep movsb
  6564                                  		mov	word [bintobcd], di
  6565                                  		;mov	word ptr ds:bintobcd, di ; set the address for msclock
  6566                                  					; let original segment stay
  6567                                  		;mov	cx, 11	; endcmosclockset - bin_to_bcd
  6568                                  		; 08/08/2023
  6569                                  		mov	cl, 11
  6570                                  		mov	si, bin_to_bcd
  6571                                  		rep movsb
  6572                                  %endif
  6573                                  
  6574                                  ; 09/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  6575                                  ; PCDOS 7.1 IBMBIO.COM - BIOSDATA:22F4h
  6576                                  		;push	cs
  6577                                  		;pop	es
  6578                                  checkk09:				
  6579 0000207D 57                      		push	di ; ? ; save ? ; 21/12/2022
  6580                                  
  6581                                  ; 13/12/2023 - Retro DOS v4.2 IO.SYS
  6582                                  ; (MSDOS 6.22 IO.SYS - BIOSDATA:1CDAh)
  6583                                  %if 0		
  6584                                  
  6585                                  		mov	ax, 4101h	; wait for bh=es:[di]
  6586                                  		mov	bl, 1		; wait for 1 clock tick
  6587                                  		mov	bh, [es:di]
  6588                                  		stc			; Assume we will fail
  6589                                  		int	15h		; SYSTEM - WAIT	ON EXTERNAL EVENT (CONVERTIBLE)
  6590                                  					; AL = condition type, BH = condition compare or mask value
  6591                                  					; BL = timeout value times 55 milliseconds, 00h	means no timeout
  6592                                  					; DX = I/O port	address	if AL bit 4 set
  6593                                  					; 11/12/2023
  6594                                  					; ES:DI = user byte if AL bit 4 clear
  6595                                  %endif
  6596                                  		; 13/12/2023 - Retro DOS v5.0 IBMBIO.COM/IO.SYS
  6597                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:1CDAh)
  6598                                  	
  6599                                  		; ........
  6600                                  
  6601 0000207E B80041                  		mov	ax, 4100h	; wait for any external event (al=0)
  6602 00002081 B304                    		mov	bl, 4		; wait for 4 clock ticks
  6603 00002083 F9                      		stc			; Assume we will fail
  6604 00002084 CD15                    		int	15h		; SYSTEM - WAIT ON EXTERNAL EVENT (CONVERTIBLE)
  6605                                  					; AL = condition type, BH = condition compare or mask value
  6606                                  					; BL = timeout value times 55 milliseconds, 00h means no timeout
  6607                                  					; DX = I/O port address if AL bit 4 set
  6608                                  		; ........
  6609                                  
  6610 00002086 5F                      		pop	di ; ?
  6611 00002087 721B                    		jc	short configdone ; 21/12/2022
  6612                                  
  6613 00002089 C606[7900]01            		mov	byte [fhavek09], 1
  6614                                  					; remember we have a k09 type
  6615 0000208E 1E                      		push	ds
  6616 0000208F 31C0                    		xor	ax, ax
  6617 00002091 8ED8                    		mov	ds, ax
  6618                                  		
  6619 00002093 893EB001                		mov	[6Ch*4], di
  6620                                  		;mov	ds:1B0h, di	; [6Ch*4]
  6621                                  					; new int 6Ch handler
  6622                                  		;mov	word ptr ds:1B2h, cs ; [6Ch*4+2]
  6623 00002097 8C0EB201                		mov	word [6Ch*4+2], cs
  6624 0000209B 1F                      		pop	ds
  6625                                  		; 20/12/2022
  6626                                  		; ds = cs = es
  6627                                  		;mov	si, int6c
  6628                                  		;mov	cx, endk09-int6c ; 459
  6629                                  		;;mov	cx, 459		; endk09 - int6c
  6630                                  					; size of k09 routine
  6631                                  		; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  6632                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:2315h
  6633 0000209C BE[3E18]                		mov	si, int_6Ch
  6634 0000209F B9BC01                  		mov	cx, endk09-int_6Ch ; 461 in PCDOS 7.1 IBMBIO.COM
  6635 000020A2 F3A4                    		rep movsb		;
  6636                                  					; set up config	stuff for sysinit
  6637                                  ; ----------------------------------------------------------------------------
  6638                                  ; Set up config stuff for SYSINIT
  6639                                  
  6640                                  ; 17/10/2022
  6641                                  ;SETDRIVE equ SetDrive - DOSBIOSEG_2C7h ; (4D7h for MSDOS 5.0 IO.SYS)
  6642                                  ;GETBP equ GetBp - DOSBIOSEG_2C7h ; (606h for MSDOS 5.0 IO.SYS)
  6643                                  ; 09/12/2022
  6644                                  SETDRIVE equ SetDrive
  6645                                  GETBP equ GetBp
  6646                                  		
  6647                                  		; 17/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
  6648                                  configdone:	
  6649                                  		; 21/12/2022			
  6650                                  		; 20/03/2019
  6651                                  		;push	cs		; di is	final ending address of	msbio.
  6652                                  		;pop	ds
  6653                                  		
  6654 000020A4 83C70F                  		add	di, 15		; round	(up) to	paragraph
  6655                                  		; 10/12/2022
  6656                                  		;shr	di, 1
  6657                                  		;shr	di, 1
  6658                                  		;shr	di, 1
  6659                                  		;shr	di, 1
  6660 000020A7 B104                    		mov	cl, 4
  6661 000020A9 D3EF                    		shr	di, cl		
  6662                                  		; 10/12/2022
  6663 000020AB 83C770                  		add	di, 70h	 ; KERNEL_SEGMENT (in fact: IO.SYS loading segment)
  6664                                  		; 19/10/2022 - Temporary !
  6665                                  		;db	81h, 0C7h, 70h, 0 ; add di, 0070h
  6666 000020AE 893E[0300]              		mov	[DosDataSg], di	; where	the dos	data segment will be
  6667                                  
  6668                                  ; 21/12/2022 - Retro DOS v4.0 (MSDOS 5.0 combined/single kernel file)
  6669                                  
  6670                                  ; 19/03/2018 - No need to read remain clusters of MSDOS kernel because
  6671                                  	     ; Retro DOS v2.0 boot sector has loaded all of the kernel file before.
  6672                                  	     
  6673                                  	     ; ("MSINIT.ASM" contains kernel file reading code here, below...)
  6674                                  
  6675                                  ; 11/12/2023 - Retro DOS v5.0 (PCDOS 7.1 combined/single kernel file)
  6676                                  
  6677                                  	     ; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2332h)
  6678                                  
  6679                                  	     ; (("IBMDOS.COM" kernel file reading code here, below...))	
  6680                                  
  6681                                  ; ----------------------------------------------------------------------------
  6682                                  ; ----------------------------------------------------------------------------
  6683                                  %if 0
  6684                                  		mov	ax, [drvfat]	; get drive and	fat id
  6685                                  		; 22/12/2022
  6686                                  		; Note: SETDRIVES uses AL (drive number) only
  6687                                  		mov	bp, SETDRIVE
  6688                                  		;mov	bp, 5AEh ; 11/12/2023 (PCDOS 7.1 IBMBIO.COM)
  6689                                  		;;mov	bp, 4D7h	; set_drive (in	dosbios	code segment)
  6690                                  					; at 2C7h:4D7h = 70h:2A47h
  6691                                  		push	cs		; simulate far call
  6692                                  		call	call_bios_code	; get bds for drive
  6693                                  		mov	bp, GETBP	; ensure valid bpb is present
  6694                                  		;mov	bp, 6E4h ; 11/12/2023 (PCDOS 7.1 IBMBIO.COM)
  6695                                  		;;mov	bp, 606h	; GetBp (2C7h:606h = 70h:2B76h)
  6696                                  		push	cs
  6697                                  		call	call_bios_code
  6698                                  
  6699                                  	; resort to funky old segment definitions for now
  6700                                  
  6701                                  		; 22/12/2022
  6702                                  		;push	es		; copy bds to ds:di
  6703                                  		;pop	ds
  6704                                  
  6705                                  	; the following read of es:0000 was spurious anyway. Should look into it.
  6706                                  	;
  6707                                  	; hmmmmmm. j.k. took out a call to getfat right here a while
  6708                                  	;	  back. Apparently it was what actually setup es: for the following
  6709                                  	; cas----
  6710                                  
  6711                                  		; 22/12/2022
  6712                                  		;xor	di, di
  6713                                  		;mov	al, [es:di]	; get fat id byte
  6714                                  		;;mov	byte ptr es:drvfat+1, al ; save fat byte
  6715                                  		;mov	[es:drvfat+1], al
  6716                                  		;mov	ax, [es:drvfat]
  6717                                  		
  6718                                  		; 22/12/2022
  6719                                  		; ds = cs
  6720                                  	;;;	mov	al, [drvfat]
  6721                                  
  6722                                  	; cas -- why do a SECOND setdrive here???
  6723                                  
  6724                                  		; 22/12/2022
  6725                                  		;push	es		; save whatever's in es
  6726                                  		;push	ds		; copy bds to es:di
  6727                                  		;pop	es
  6728                                  		;push	cs		; copy Bios_Data to ds
  6729                                  		;pop	ds
  6730                                  	
  6731                                  	; 22/12/2022
  6732                                  	;;;	mov	bp, SETDRIVE
  6733                                  	;;;	;mov	bp, 4D7h	; SetDrive (2C7h:47Dh = 70h:2A47h)
  6734                                  	;;;	push	cs		; simulate far call
  6735                                  	;;;	call	call_bios_code	; get correct bds for this drive
  6736                                  	
  6737                                  		; 22/12/2022
  6738                                  		;push	es		; copy bds back to ds:di
  6739                                  		;pop	ds
  6740                                  		;pop	es		; pop whatever was in es
  6741                                  
  6742                                  	; Now we load in the MSDOS.SYS file
  6743                                  
  6744                                  	; 22/12/2022
  6745                                  	; -----
  6746                                  	;	mov	bx, [di+6]	; [di+BDS.BDS_BPB.BPB_BYTESPERSECTOR]
  6747                                  	;	mov	[cs:md_sectorsize], bx	; used by get_fat_sector proc.
  6748                                  	;	mov	bl, [di+1Fh]	; [di+BDS.fatsiz]
  6749                                  	;				; get size of fat on media
  6750                                  	;	;mov	es:16DEh, bl
  6751                                  	;	mov	[es:fbigfat], bl
  6752                                  	;	mov	cl, [di+8]
  6753                                  	;	mov	ax, [di+17h] ; [di+BDS.BDS_BPB.BPB_HIDDENSECTORS]
  6754                                  	;	;sub	es:16D8h, ax
  6755                                  	;	sub	[es:bios_l], ax	; subtract hidden sectors since we
  6756                                  	;				; need a logical sector number that will
  6757                                  	;				; be used by getclus(diskrd procedure)
  6758                                  	;	mov	ax, [di+19h] ; [di+BDS.BDS_BPB.BPB_HIDDENSECTORS+2]
  6759                                  	;	;sbb	es:16DAh, ax
  6760                                  	;	sbb	[es:bios_h], ax	; subtract upper 16 bits of sector num
  6761                                  	; -----
  6762                                  		
  6763                                  		; 11/12/2023 - Retro DOS v5.0 IO.SYS/IBMBIO.COM
  6764                                  	; -----	; 22/12/2022
  6765                                  		mov	bx, [es:di+6]	; [di+BDS.BDS_BPB.BPB_BYTESPERSECTOR]
  6766                                  		mov	[md_sectorsize], bx ; used by get_fat_sector proc.
  6767                                  		; 11/12/2023 ; *
  6768                                  		mov	bl, [es:di+3Bh]	; [di+BDS.fatsiz] ; *
  6769                                  		;mov	bl, [es:di+1Fh]	; [di+BDS.fatsiz]
  6770                                  					; get size of fat on media
  6771                                  		mov	[fbigfat], bl
  6772                                  		mov	cl, [es:di+8]
  6773                                  		mov	ax, [es:di+17h] ; [di+BDS.BDS_BPB.BPB_HIDDENSECTORS]
  6774                                  		sub	[First_Data_Sector], ax ; *
  6775                                  		;sub	[bios_l], ax	; subtract hidden sectors since we
  6776                                  					; need a logical sector number that will
  6777                                  					; be used by getclus(diskrd procedure)
  6778                                  		mov	ax, [es:di+19h] ; [di+BDS.BDS_BPB.BPB_HIDDENSECTORS+2]
  6779                                  		sbb	[First_Data_Sector+2], ax ; *
  6780                                  		;sbb	[bios_h], ax	; subtract upper 16 bits of sector num
  6781                                  	; ------
  6782                                  
  6783                                  		xor	ch, ch	 ; cx = sectors/cluster
  6784                                  
  6785                                  	; the boot program has left the directory at 0:500h
  6786                                  
  6787                                  		; 11/12/2023 - - Retro DOS v5.0 IBMBIO.COM/IO.SYS
  6788                                  		;push	di
  6789                                  		push	ds
  6790                                  		;xor	di, di
  6791                                  		;mov	ds, di
  6792                                  		xor	bx, bx ; 0
  6793                                  		mov	ds, bx
  6794                                  		mov	bx, [53Ah]
  6795                                  		;mov	bx, ds:53Ah    	; (First cluster of the 2nd dir entry
  6796                                  				   	; of root directory in the buffer at 500h)
  6797                                  		pop	ds
  6798                                  		mov     si, [firstcluster_hw] ; 11/12/2023 
  6799                                  				   	; (32 bit cluster number for FAT32 fs)
  6800                                  		;pop	ds
  6801                                  		;pop	di
  6802                                  
  6803                                  		; 12/12/2023
  6804                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2397h)
  6805                                  		; ...........
  6806                                  		; ds = cs
  6807                                  		mov	al, [fbigfat]
  6808                                  		push	ax              ; (*) save fbigfat flags
  6809                                  		mov	al, [drvfat]
  6810                                  		or	al, [Boot_Drv]
  6811                                  		jnz	short boot_drv_fixed ; hard disk
  6812                                  boot_drv_removable:			; calculate cluster count and set fbig or fbigbig flag
  6813                                  		push	bx              ; for removable drives
  6814                                  		push	cx
  6815                                  		push	dx
  6816                                  	
  6817                                  		; 12/12/2023
  6818                                  		push	es
  6819                                  		pop	ds
  6820                                  
  6821                                  		mov	ax, [di+0Eh]    ; [di+BDS.totalsecs16]
  6822                                  		xor	dx, dx
  6823                                  		or	ax, ax
  6824                                  		jnz	short prep_totalsecs_ok
  6825                                  		mov	ax, [di+1Bh]    ; [di+BDS.totalsecs32]
  6826                                  		mov	dx, [di+1Dh]
  6827                                  prep_totalsecs_ok:
  6828                                  		sub	ax, [di+9]      ; [di+BDS.resectors]
  6829                                  		sbb	dx, 0
  6830                                  		push	ax
  6831                                  		push	dx
  6832                                  		mov	bx, [di+11h]    ; [di+BDS.fatsecs16]
  6833                                  		xor	ax, ax
  6834                                  		or	bx, bx
  6835                                  		jnz	short prep_fatsecs_ok
  6836                                  		mov	bx, [di+1Fh]    ; [di+BDS.fatsecs32]
  6837                                  		mov	ax, [di+21h]
  6838                                  prep_fatsecs_ok:
  6839                                  		mov	cl, [di+0Bh]    ; ax:bx = 32 bit count of FAT sectors
  6840                                  				        ; [di+BDS.fats]
  6841                                  		xor	ch, ch
  6842                                  		mul	cx
  6843                                  		xchg	ax, cx
  6844                                  		mul	bx
  6845                                  		add	cx, dx
  6846                                  		mov	bx, ax          ; cx:bx = total (2*) fat sectors
  6847                                  		pop	dx
  6848                                  		pop	ax              ; dx:ax = totals sectors - reserved sectors
  6849                                  		sub	ax, bx
  6850                                  		sbb	dx, cx          ; dx:ax = data sectors (includes root dir sectors)
  6851                                  		mov	bx, [di+0Ch]    ; [di+BDS.direntries]
  6852                                  		add	bx, 15          ; 16 directory entries per sector
  6853                                  				        ; (round up sector count by adding 15)
  6854                                  		mov	cl, 4           ; (rounded) dir entries / 16
  6855                                  		shr	bx, cl
  6856                                  		xor	cx, cx
  6857                                  		sub	ax, bx
  6858                                  		sbb	dx, cx          ; dx:ax = data sectors (except root directory sectors)
  6859                                  					; (will be used for cluster count calculation)
  6860                                  		mov	cl, [di+8]      ; [di+BDS.secperclus]
  6861                                  
  6862                                  		; 12/12/2023
  6863                                  		push	cs
  6864                                  		pop	ds
  6865                                  
  6866                                  		push	ax              ; 32 bit division (data sectors / sector per cluster)
  6867                                  		mov	ax, dx
  6868                                  		xor	dx, dx
  6869                                  		div	cx
  6870                                  		mov	bx, ax
  6871                                  		pop	ax
  6872                                  		div	cx
  6873                                  		or	bx, bx          ; 32 bit cluster count if bx > 0
  6874                                  		jnz	short set_fbigbig_flag ; too big cluster number
  6875                                  		cmp	ax, 0FFF6h
  6876                                  		jb	short set_fbig_flag
  6877                                  set_fbigbig_flag:
  6878                                  		or	byte [fbigfat], 20h ; FAT32 ; fbigbig
  6879                                  		jmp	short set_fbig_flag_ok
  6880                                  ; ---------------------------------------------------------------------------
  6881                                  
  6882                                  set_fbig_flag:
  6883                                  		cmp	ax, 0FF6h       ; 4096-10
  6884                                  				        ; is this 16-bit fat?
  6885                                  		jb	short set_fbig_flag_ok ; no, small fat
  6886                                  		or	byte [fbigfat], 40h ; FAT16 ; fbig
  6887                                  set_fbig_flag_ok:
  6888                                  		pop	dx
  6889                                  		pop	cx
  6890                                  		pop	bx
  6891                                  boot_drv_fixed:
  6892                                  		xor	di, di
  6893                                  		; ...........
  6894                                  loadit:
  6895                                  		mov	ax, SYSINITSEG	; 46Dh
  6896                                  		;mov	ax, 544h	; 11/12/2023 - PCDOS 7.1 IBMBIO.COM
  6897                                  		;;mov	ax, 46Dh	; sysinit segment
  6898                                  		mov	es, ax
  6899                                  		mov	es, [es:CURRENTDOSLOCATION] ; 09/12/2022
  6900                                  		;mov	es, [es:271h]
  6901                                  
  6902                                  		call	getclus		; read cluster at ES:DI (DI is updated)
  6903                                  
  6904                                  ; ----------------------------------------------------------------------------
  6905                                  
  6906                                  		; 13/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  6907                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2431h)
  6908                                  
  6909                                  		;test	byte [cs:fbigfat], 20h ; fbigbig ; FAT32 fs flag
  6910                                  		test	byte [fbigfat], 20h ; fbigbig ; FAT32 fs flag
  6911                                  		jz	short iseof
  6912                                  
  6913                                  eofbigbig:	; si:bx = 32 bit cluster number
  6914                                  		cmp	si, 0FFFh
  6915                                  		jnz	short iseofx
  6916                                  		cmp	bx, 0FFF7h
  6917                                  		jmp	short iseofx
  6918                                  
  6919                                  ; ----------------------------------------------------------------------------
  6920                                  		; 13/12/2023
  6921                                  iseof:
  6922                                  		;;test	byte [cs:fbigfat], fbig
  6923                                  		;test	byte [cs:fbigfat], 40h ; fbig
  6924                                  		; 12/12/2023
  6925                                  		; ds = cs
  6926                                  		test	byte [fbigfat], 40h ; fbig
  6927                                  		jnz	short eofbig
  6928                                  		cmp	bx, 0FF7h
  6929                                  		jmp	short iseofx
  6930                                  ; ----------------------------------------------------------------------------
  6931                                  
  6932                                  eofbig:
  6933                                  		cmp	bx, 0FFF7h
  6934                                  iseofx:
  6935                                  		jb	short loadit	; keep loading until cluster = eof
  6936                                  %endif
  6937                                  ; ----------------------------------------------------------------------------
  6938                                  ; ----------------------------------------------------------------------------
  6939                                  
  6940 000020B2 E8FC04                  		call	setdrvparms	; 
  6941                                  
  6942                                  		;;;jmp	far ptr	46Dh:267h ; jmp	SYSINIT_SEG:SYSINIT_START
  6943                                  		;;jmp	far 46Dh:267h
  6944                                  		; 12/12/2023
  6945                                  		;jmp	far 544h:269h	; (PCDOS 7.1 IBMBIO.COM)
  6946                                  
  6947 000020B5 EA[6902]D704            		jmp	SYSINITSEG:SYSINITSTART
  6948                                  
  6949                                  ; =============== S U B	R O U T	I N E ========================================
  6950                                  
  6951                                  ; Following are subroutines to support resident device driver initialization
  6952                                  ;
  6953                                  ;M011 -- note:  deleted setup_bdsms and reset_bdsms here
  6954                                  
  6955                                  ;	M035 -- begin changed section
  6956                                  
  6957                                  ;******************************************************************************
  6958                                  ; module name: remap
  6959                                  ;
  6960                                  ; descriptive name: all the code for himem that could be separated from msbio
  6961                                  ;
  6962                                  ; function:  remap the bds chain to adjusted logical drive numbers (drive
  6963                                  ;	     letters) if more than two diskette drives on the system.
  6964                                  ;
  6965                                  ;     scheme:  if more than 2 diskette drives, first map the bds structure
  6966                                  ;	       as usual and then rescan the bds chain to adjust the drive
  6967                                  ;	       letters. to do this, scan for disk drives and assign logical
  6968                                  ;	       drive number starting from 2 and then rescan diskette drives
  6969                                  ;	       and assign next to the last logical drive number of last disk
  6970                                  ;	       drive to the 3rd and 4th diskette drives.
  6971                                  
  6972                                  ; input:       none
  6973                                  ; exit:	drive letters have been remapped in bds chain
  6974                                  ; exit error:  none
  6975                                  ; called from: msinit
  6976                                  ;
  6977                                  ; notes:  this function  will be called only if more than 2 diskettes are
  6978                                  ;	  found in the system
  6979                                  ;	  this function assumes that there are no more than 26 drives assigned
  6980                                  ;	    this is guaranteed by the code that creates bdss for partitions
  6981                                  ;	  this function assumes that the first entries in the chain are
  6982                                  ;	   floppy drives, and all the rest are hard drives
  6983                                  ;	  will alter the boot drive if necessary to reflect remapping
  6984                                  ;
  6985                                  ;******************************************************************************
  6986                                  
  6987                                  ; 17/10/2022
  6988                                  ; 02/10/2022
  6989                                  		; 15/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  6990                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2464h)
  6991                                  		; (MSDOS 6.22 IO.SYS - BIOSDATA:1D9Eh)
  6992                                  
  6993                                  remap:		; proc near
  6994                                  
  6995                                  		; 15/12/2023
  6996                                  		; ds = cs
  6997                                  		;mov	di, [cs:start_bds] ; get first bds
  6998 000020BA 8B3E[1901]              		mov	di, [start_bds]
  6999                                  
  7000                                  ; search for 1st fixed disk physical drive num
  7001                                  
  7002                                  drive_loop:
  7003 000020BE 807D0480                		cmp	byte [di+4], 80h ; [di+BDS.drivenum]
  7004                                  					; first	hard disk??
  7005 000020C2 7409                    		jz	short fdrv_found ; yes,	continue
  7006 000020C4 8B3D                    		mov	di, [di]	; [di+BDS.link]
  7007                                  					; get next bds,	assume segment
  7008 000020C6 83FFFF                  		cmp	di, -1 ; 0FFFFh	; last bds?
  7009 000020C9 75F3                    		jnz	short drive_loop ; loop	if not
  7010 000020CB EB49                    		jmp	short rmap_exit	; yes, no hard drive on	system
  7011                                  
  7012                                  ;------------------------------------------------------------------------------
  7013                                  ;first disk drive bds, now change the logical drive num to 2 and the subsequent
  7014                                  ;logical drive nums to 3, 4, 5 etc.
  7015                                  ;------------------------------------------------------------------------------
  7016                                  
  7017                                  fdrv_found:
  7018 000020CD B002                    		mov	al, 2		; start	with logical drv num=2
  7019                                  fdrv_loop:
  7020 000020CF 884505                  		mov	[di+5],	al	; [di+BDS.drivelet]
  7021 000020D2 8B3D                    		mov	di, [di]	; [di+BDS.link]
  7022                                  					; ds:di--> next	bds
  7023                                  		;inc	al		; set num for next drive
  7024                                  		; 18/12/2022
  7025 000020D4 40                      		inc	ax
  7026 000020D5 83FFFF                  		cmp	di, 0FFFFh	; last hard drive ?
  7027 000020D8 75F5                    		jnz	short fdrv_loop	; no - assign more disk drives
  7028                                  
  7029                                  ;------------------------------------------------------------------------------
  7030                                  ; now, rescan and find bds of 3rd floppy drive and assign next drive letter
  7031                                  ; in al to 3rd. if the current drive letter is past z, then do not allocate
  7032                                  ; any more.
  7033                                  ;------------------------------------------------------------------------------
  7034                                  
  7035                                  		;mov	di, [cs:start_bds] ; [start_bds]
  7036                                  		; 15/12/2023
  7037 000020DA 8B3E[1901]              		mov	di, [start_bds]	; get first bds
  7038 000020DE 8B3D                    		mov	di, [di]	; [di+BDS.link]
  7039                                  					; ds:di-->bds2
  7040                                  		;mov	ah, [cs:dsktnum] ; get number of floppies to remap
  7041 000020E0 8A26[2501]              		mov	ah, [dsktnum]
  7042 000020E4 80EC02                  		sub	ah, 2		; adjust for a:	& b:
  7043                                  remap_loop1:
  7044 000020E7 8B3D                    		mov	di, [di]	; [di+BDS.link]
  7045                                  					; set new num to next floppy
  7046 000020E9 884505                  		mov	[di+5],	al	; [di+BDS.drivelet]
  7047 000020EC FEC0                    		inc	al		; new number for next floppy
  7048 000020EE FECC                    		dec	ah		; count down extra floppies
  7049 000020F0 75F5                    		jnz	short remap_loop1
  7050                                  
  7051                                  ; now we've got to adjust the boot drive if we reassigned it
  7052                                  
  7053                                  		; 15/12/2023
  7054                                  		;mov	al, [cs:drvfat]
  7055 000020F2 A0[FA19]                		mov	al, [drvfat]
  7056 000020F5 3C02                    		cmp	al, 2		; is it	a: or b: ?
  7057 000020F7 721D                    		jb	short rmap_exit
  7058                                  		;sub	al, [cs:dsktnum]
  7059 000020F9 2A06[2501]              		sub	al, [dsktnum]	; is it one of the other floppies?
  7060 000020FD 7204                    		jb	short remap_boot_flop ;	brif so
  7061                                  
  7062                                  ; we've got to remap the boot hard drive
  7063                                  ; subtract the number of EXTRA floppies from it
  7064                                  
  7065 000020FF 0402                    		add	al, 2		; bootdrv -= (dsktnum-2)
  7066 00002101 EB04                    		jmp	short remap_change_boot_drv
  7067                                  ; ---------------------------------------------------------------------------
  7068                                  
  7069                                  ; we've got to remap the boot floppy.
  7070                                  ; add the number of hard drive partitions to it
  7071                                  
  7072                                  remap_boot_flop:
  7073                                  		;add	al, [cs:drvmax]	; bootdrv += (drvmax-dsktnum)
  7074                                  		; 15/12/2023
  7075 00002103 0206[7500]              		add	al, [drvmax]
  7076                                  remap_change_boot_drv:			
  7077                                  		;mov	[cs:drvfat], al ; alter msdos.sys load drive
  7078 00002107 A2[FA19]                		mov	[drvfat], al
  7079 0000210A FEC0                    		inc	al
  7080 0000210C 1E                      		push	ds
  7081 0000210D BFD704                  		mov	di, SYSINITSEG	; 46Dh
  7082                                  		;mov	di, 544h	; PCDOS 7.1 IBMBIO.COM
  7083                                  		;;mov	di, 46Dh	; SYSINIT segment
  7084 00002110 8EDF                    		mov	ds, di
  7085 00002112 A2[9802]                		mov	[DEFAULTDRIVE], al
  7086                                  		;mov	ds:296h, al	; [SYSINIT+DEFAULT_DRIVE]
  7087                                  					; pass it to sysinit as	well
  7088 00002115 1F                      		pop	ds ; ds = cs
  7089                                  rmap_exit:
  7090 00002116 C3                      		retn
  7091                                  
  7092                                  ; =============== S U B	R O U T	I N E =======================================
  7093                                  
  7094                                  ; 17/10/2022
  7095                                  ; 02/10/2022 - Retro DOS v4.0 (MSDOS 5.0 -actual-)
  7096                                  ; 28/12/2018 - Retro DOS v4.0 (MSDOS 6.21 -draft-)
  7097                                  ; 02/06/2018 - Retro DOS v3.0 (MSDOS 3.3)	
  7098                                  ; 19/03/2018 - Retro DOS v2.0 (MSDOS 2.11)
  7099                                  ;**************************************************
  7100                                  ; getboot - get the boot sector for a hard disk
  7101                                  ;
  7102                                  ; Reads the boot sector from a specified drive into
  7103                                  ; a buffer at the top of memory.
  7104                                  ;
  7105                                  ; dl = int13 drive number to read boot sector for
  7106                                  ;**************************************************
  7107                                  
  7108                                  ; 17/10/2022
  7109                                  bootbias equ 200h
  7110                                  
  7111                                  getboot:	; proc near
  7112                                  
  7113                                  		; 15/12/2023 - Retro DOS v5.0 
  7114                                  		;	 (Modified PCDOS 7.1) IBMBIO.COM/IO.SYS
  7115                                  		; ds = cs
  7116                                  		
  7117                                  		; 08/04/2018
  7118                                  		; Retro DOS v2.0 (IBMBIO.COM, IBMDOS 2.1)
  7119                                  		; 28/03/2018 - MSDOS 6.0 - MSINIT.ASM, 1991
  7120                                  		; 02/10/2022 - Retro DOS v4.0
  7121                                  		;	      (disassembled IO.SYS code of MSDOS 5.0)
  7122                                  
  7123                                  		;mov	ax, [cs:init_bootseg] ; 17/10/2022
  7124                                  		; 15/12/2023
  7125 00002117 A1[FD19]                		mov	ax, [init_bootseg]
  7126 0000211A 8EC0                    		mov	es, ax
  7127                                  
  7128                                  		; 17/10/2022
  7129 0000211C BB0002                  		mov	bx, bootbias ; 200h
  7130                                  		;mov	bx, 200h	; bootbias
  7131                                  					; load BX, ES:BX is where sector goes
  7132 0000211F B80102                  		mov	ax, 201h
  7133 00002122 30F6                    		xor	dh, dh
  7134 00002124 B90100                  		mov	cx, 1
  7135 00002127 CD13                    		int	13h		; DISK - READ SECTORS INTO MEMORY
  7136                                  					; AL = number of sectors to read, CH = track, CL = sector
  7137                                  					; DH = head, DL	= drive, ES:BX -> buffer to fill
  7138                                  					; Return: CF set on error, AH =	status,	AL = number of sectors read
  7139 00002129 7209                    		jc	short erret
  7140                                  		; 17/10/2022
  7141 0000212B 26813EFE0355AA          		cmp	word [es:bootbias+1FEh], 0AA55h
  7142                                  		;cmp	word ptr es:3FEh, 0AA55h ; [es:bootbias+1FEh]
  7143                                  					; Dave Litton magic word?
  7144 00002132 7401                    		jz	short norm_ret	; yes
  7145                                  erret:
  7146 00002134 F9                      		stc
  7147                                  norm_ret:
  7148 00002135 C3                      		retn
  7149                                  
  7150                                  ; =============== S U B	R O U T	I N E =======================================
  7151                                  
  7152                                  ; 28/12/2018 - Retro DOS v4.0 
  7153                                  
  7154                                  ;***************************************************************************
  7155                                  ;   sethard - generate bpb for a variable sized hard file. ibm has a
  7156                                  ;   partitioned hard file; we must read physical sector 0 to determine where
  7157                                  ;   our own logical sectors start. we also read in our boot sector to
  7158                                  ;   determine version number
  7159                                  ;
  7160                                  ;   inputs:	dl is rom drive number (80...)
  7161                                  ;		bh is partition number (0....) 
  7162                                  ;		ds:di points to bds
  7163                                  ;   outputs:	carry clear -> bpb is filled in
  7164                                  ;		carry set   -> bpb is left uninitialized due to error
  7165                                  ;	trashes (at least) si, cx
  7166                                  ;	MUST PRESERVE ES:!!!!
  7167                                  ;***************************************************************************
  7168                                  
  7169                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  7170                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:24E9h)
  7171                                  
  7172                                  sethard:	; proc near
  7173                                  		; 12/08/2023
  7174                                  		; ds = cs = BIOSDATA
  7175 00002136 57                      		push	di
  7176 00002137 53                      		push	bx
  7177                                  		;push	ds  ; ds = cs = BIOSDATA ; 12/08/2023
  7178 00002138 06                      		push	es
  7179 00002139 885D05                  		mov	[di+5],	bl	; [di+BDS.drivelet]
  7180 0000213C 885504                  		mov	[di+4],	dl	; [di+BDS.drivenum]
  7181                                  		; 16/12/2023
  7182 0000213F 804D3F01                		or	byte [di+3Fh], 1 ; PCDOS 7.1
  7183                                  		;or	byte [di+23h], 1 ; [di+BDS.flags]
  7184                                  					; fnon_removable
  7185 00002143 C6453E05                		mov	byte [di+3Eh], 5 ; PCDOS 7.1
  7186                                  		;mov	byte [di+22h], 5 ; [di+BDS.formfactor]
  7187                                  					; ffHardFile
  7188 00002147 C606[FC19]00            		mov	byte [fbigfat], 0 ; assume 12 bit FAT
  7189 0000214C 88FE                    		mov	dh, bh		; partition number
  7190 0000214E 52                      		push	dx
  7191 0000214F B408                    		mov	ah, 8
  7192 00002151 CD13                    		int	13h		; DISK - DISK -	GET CURRENT DRIVE PARAMETERS (XT,AT,XT286,CONV,PS)
  7193                                  					; DL = drive number
  7194                                  					; Return: CF set on error, AH =	status code, BL	= drive	type
  7195                                  					; DL = number of consecutive drives
  7196                                  					; DH = maximum value for head number, ES:DI -> drive parameter
  7197                                  		;inc	dh
  7198                                  		; 16/12/2023 - Retro DOS v5.0
  7199 00002153 88F2                    		mov	dl, dh
  7200 00002155 B600                    		mov	dh, 0
  7201 00002157 42                      		inc	dx
  7202                                  		;mov	[di+15h], dh	; [di+BDS.heads] ; get number of heads
  7203 00002158 895515                  		mov	[di+15h], dx
  7204 0000215B 5A                      		pop	dx
  7205 0000215C 7253                    		jc	short setret	; error	if no hard disk
  7206                                  		; 16/12/2023
  7207                                  		;jc	short setret_j
  7208                                  		
  7209 0000215E 80E13F                  		and	cl, 3Fh
  7210 00002161 884D13                  		mov	[di+13h], cl	; [di+BDS.secpertrack]
  7211 00002164 52                      		push	dx		; save partition number
  7212 00002165 E8AFFF                  		call	getboot
  7213 00002168 5A                      		pop	dx		; restore partition number
  7214 00002169 7246                    		jc	short setret
  7215                                  		; 16/12/2023
  7216                                  		;jnc	short chk_act_part
  7217                                  ;setret_j:
  7218                                  		;jmp	setret
  7219                                  
  7220                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  7221                                  chk_act_part:
  7222 0000216B 31DB                    		xor	bx, bx ; 0
  7223                                  		;;mov	[cs:ep_start_sector], bx
  7224                                  		;;mov	[cs:ep_start_sector+2], bx
  7225                                  		;mov	[cs:ep_hidden_secs], bx
  7226                                  		;mov	[cs:ep_hidden_secs+2], bx
  7227                                  		; 16/12/2023
  7228                                  		; ds = cs
  7229                                  		; 20/12/2023
  7230                                  		;mov	[ep_start_sector], bx
  7231                                  		;mov	[ep_start_sector+2], bx
  7232 0000216D 891E[D321]              		mov	[ep_hidden_secs], bx
  7233 00002171 891E[D521]              		mov	[ep_hidden_secs+2], bx
  7234                                  		
  7235 00002175 BBC203                  		mov	bx, 3C2h	; 1C2h+bootbias
  7236                                  
  7237                                  ; The first 'active' partition is 00, the second is 01....
  7238                                  ;   then the remainder of the 'primary' but non-active partitions
  7239                                  
  7240                                  act_part:
  7241 00002178 26F647FC80              		test	byte [es:bx-4], 80h ; is the partition active?
  7242 0000217D 740B                    		jz	short no_act	; no
  7243                                  ; 16/12/2023
  7244                                  %if 0		
  7245                                  		; 16/12/2023
  7246                                  		; reject if partitiontype != 1, 4, 6, 0Bh, 0Ch, 0Eh
  7247                                  		cmp	byte [es:bx], 1 ; FAT12
  7248                                  		jz	short got_good_act
  7249                                  		cmp	byte [es:bx], 4	; FAT16 CHS (<= 32MB)
  7250                                  		jz	short got_good_act
  7251                                  		
  7252                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  7253                                  		cmp	byte [es:bx], 0Bh ; FAT32 CHS
  7254                                  		jz	short got_good_act
  7255                                  		cmp	byte [es:bx], 0Ch ; FAT32 LBA
  7256                                  		jz	short got_good_act
  7257                                  		cmp	byte [es:bx], 0Eh ; FAT16 LBA
  7258                                  		jz	short got_good_act
  7259                                  
  7260                                  		cmp	byte [es:bx], 6	; FAT16 BIG CHS (> 32MB)
  7261                                  		jnz	short no_act
  7262                                  ;%else
  7263                                  		; 16/12/2023
  7264                                  		mov	al, [es:bx]	 ; partition type
  7265                                  
  7266                                  		; reject if partitiontype != 1, 4, 6, 0Bh, 0Ch, 0Eh
  7267                                  		cmp	al, 1		; FAT12
  7268                                  		je	short got_good_act
  7269                                  		cmp	al, 4		; FAT16 CHS (<= 32MB)
  7270                                  		je	short got_good_act
  7271                                  		
  7272                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  7273                                  		cmp	al, 0Bh		; FAT32 CHS
  7274                                  		je	short got_good_act
  7275                                  		cmp	al, 0Ch		; FAT32 LBA
  7276                                  		je	short got_good_act
  7277                                  		cmp	al, 0Eh		; FAT16 LBA
  7278                                  		je	short got_good_act
  7279                                  
  7280                                  		cmp	al, 6		; FAT16 BIG CHS (> 32MB)
  7281                                  		jne	short no_act
  7282                                  %endif		
  7283                                  		; 16/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
  7284                                  		; check if it is a primary dos partition
  7285                                  
  7286 0000217F E83300                  		call	chk_partition_type
  7287 00002182 7506                    		jne	short no_act
  7288                                  
  7289                                  got_good_act:				; 11/08/2023
  7290 00002184 08F6                    		or	dh, dh		; is this our target partition #?
  7291                                  					; (0 = first primary dos or active partition)
  7292 00002186 744F                    		jz	short set2	; WE GOT THE ONE WANTED!!
  7293 00002188 FECE                    		dec	dh		; count	down
  7294                                  no_act:					
  7295 0000218A 83C310                  		add	bx, 16
  7296 0000218D 81FB0204                		cmp	bx, 402h	; 202h+bootbias
  7297                                  					; last entry done?
  7298 00002191 75E5                    		jnz	short act_part	; no, process next entry
  7299                                  
  7300 00002193 BBC203                  		mov	bx, 3C2h	; 1C2h+bootbias
  7301                                  					; restore original value of bx
  7302                                  
  7303                                  ; Now scan the non-active partitions
  7304                                  
  7305                                  get_primary:
  7306 00002196 26F647FC80              		test	byte [es:bx-4], 80h
  7307 0000219B 750B                    		jnz	short not_prim	; we've already scanned
  7308                                  					; the ACTIVE ones
  7309                                  ; 16/12/2023
  7310                                  %if 0
  7311                                  		; 16/12/2023
  7312                                  		; see if partitiontype == 1, 4, 6, 0Bh, 0Ch, 0Eh
  7313                                  		cmp	byte [es:bx], 1	; FAT12
  7314                                  		jz	short got_prim
  7315                                  		cmp	byte [es:bx], 4	; FAT16 CHS (<= 32MB)
  7316                                  		jz	short got_prim
  7317                                  
  7318                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  7319                                  		cmp	byte [es:bx], 0Bh ; FAT32 CHS
  7320                                  		jz	short got_prim
  7321                                  		cmp	byte [es:bx], 0Ch ; FAT32 LBA
  7322                                  		jz	short got_prim
  7323                                  		cmp	byte [es:bx], 0Eh ; FAT16 LBA
  7324                                  		jz	short got_prim
  7325                                  
  7326                                  		cmp	byte [es:bx], 6	; FAT16 BIG CHS (> 32MB)
  7327                                  		jnz	short not_prim
  7328                                  ;%else
  7329                                  		; 16/12/2023
  7330                                  		mov	al, [es:bx]	 ; partition type
  7331                                  
  7332                                  		; see if partitiontype == 1, 4, 6, 0Bh, 0Ch, 0Eh
  7333                                  		cmp	al, 1		; FAT12
  7334                                  		je	short got_prim
  7335                                  		cmp	al, 4		; FAT16 CHS (<= 32MB)
  7336                                  		je	short got_prim
  7337                                  		
  7338                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  7339                                  		cmp	al, 0Bh		; FAT32 CHS
  7340                                  		je	short got_prim
  7341                                  		cmp	al, 0Ch		; FAT32 LBA
  7342                                  		je	short got_prim
  7343                                  		cmp	al, 0Eh		; FAT16 LBA
  7344                                  		je	short got_prim
  7345                                  
  7346                                  		cmp	al, 6		; FAT16 BIG CHS (> 32MB)
  7347                                  		jne	short not_prim
  7348                                  %endif
  7349                                  		; 16/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
  7350                                  		; check if it is a primary dos partition
  7351                                  
  7352 0000219D E81500                  		call	chk_partition_type
  7353 000021A0 7506                    		jne	short not_prim
  7354                                  
  7355                                  got_prim:
  7356 000021A2 08F6                    		or	dh, dh		; is this our target partition?
  7357 000021A4 7431                    		jz	short set2
  7358 000021A6 FECE                    		dec	dh
  7359                                  not_prim:
  7360 000021A8 83C310                  		add	bx, 16
  7361 000021AB 81FB0204                		cmp	bx, 402h	; 202h+bootbias
  7362 000021AF 75E5                    		jnz	short get_primary ; loop till we've gone through table
  7363                                  setret:					
  7364 000021B1 F9                      		stc			; error	return
  7365 000021B2 E9C503                  		jmp	ret_hard_err
  7366                                  
  7367                                  ; ---------------------------------------------------------------------------
  7368                                  		
  7369                                  		; 16/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
  7370                                  
  7371                                  chk_partition_type:
  7372                                  		; 16/12/2023
  7373 000021B5 268A07                  		mov	al, [es:bx]	 ; partition type
  7374                                  
  7375                                  		; see if partitiontype == 1, 4, 6, 0Bh, 0Ch, 0Eh
  7376 000021B8 3C01                    		cmp	al, 1		; FAT12
  7377 000021BA 7412                    		je	short chk_ptype_retn
  7378 000021BC 3C04                    		cmp	al, 4		; FAT16 CHS (<= 32MB)
  7379 000021BE 740E                    		je	short chk_ptype_retn
  7380                                  		
  7381                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  7382 000021C0 3C0B                    		cmp	al, 0Bh		; FAT32 CHS
  7383 000021C2 740A                    		je	short chk_ptype_retn
  7384 000021C4 3C0C                    		cmp	al, 0Ch		; FAT32 LBA
  7385 000021C6 7406                    		je	short chk_ptype_retn
  7386 000021C8 3C0E                    		cmp	al, 0Eh		; FAT16 LBA
  7387 000021CA 7402                    		je	short chk_ptype_retn
  7388                                  
  7389 000021CC 3C06                    		cmp	al, 6		; FAT16 BIG CHS (> 32MB)
  7390                                  chk_ptype_retn:
  7391                                  		; zf = 1 -> primary DOS partition
  7392                                  		; zf = 0 -> not a primary DOS partition
  7393 000021CE C3                      		retn
  7394                                  
  7395                                  ; ---------------------------------------------------------------------------
  7396                                  
  7397                                  		; 16/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
  7398                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:25B6h)
  7399                                  ep_start_sector:
  7400 000021CF 00000000                		dd 0
  7401 000021D3 00000000                ep_hidden_secs:	dd 0
  7402                                  
  7403                                  ; ---------------------------------------------------------------------------
  7404                                  
  7405                                  ;  until we get the real logical boot record and get the bpb,
  7406                                  ;  BDS_BPB.BPB_BIGTOTALSECTORS will be used instead of BDS_BPB.BPB_TOTALSECTORS
  7407                                  ;  for the convenience of the computation.
  7408                                  ;
  7409                                  ;  at the end of this procedure, if a bpb information is gotten from
  7410                                  ;  the valid boot record, then we are going to use those bpb information
  7411                                  ;  without change.
  7412                                  ;
  7413                                  ;  otherwise, if (hidden sectors + total sectors) <= a word, then we will move
  7414                                  ;  BDS_BPB.BPB_BIGTOTALSECTORS (low) to BDS_BPB.BPB_TOTALSECTORS and zero out
  7415                                  ;  BDS_BPB.BPB_BIGTOTALSECTORS entry to make it a conventional bpb format.
  7416                                  
  7417                                  set2:		
  7418                                  		; 12/08/2023
  7419                                  		; ds = cs = BIOSDATA segment (0070h)
  7420 000021D7 8816[FF19]              		mov	[rom_drv_num], dl
  7421                                  		;mov	[cs:rom_drv_num], dl
  7422                                  			; save the rom bios drive number we are handling now.
  7423 000021DB 268B4704                		mov	ax, [es:bx+4]	; hidden sectors (start	sector)
  7424 000021DF 268B5706                		mov	dx, [es:bx+6]
  7425                                  
  7426                                  ; decrement the sector count by 1 to make it zero based. exactly 64k
  7427                                  ; sectors should be allowed	
  7428                                  
  7429 000021E3 83E801                  		sub	ax, 1
  7430 000021E6 83DA00                  		sbb	dx, 0
  7431 000021E9 26034708                		add	ax, [es:bx+8]	; sectors in partition
  7432 000021ED 2613570A                		adc	dx, [es:bx+10]
  7433 000021F1 7305                    		jnc	short okdrive
  7434 000021F3 800E[FC19]80            		or	byte [fbigfat], 80h ; ftoobig
  7435                                  
  7436                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  7437                                  		;;;
  7438                                  okdrive:
  7439                                  		;add	ax, [cs:ep_hidden_secs]
  7440                                  		;adc	dx, [cs:ep_hidden_secs+2]
  7441                                  		; ds = cs
  7442 000021F8 0306[D321]              		add	ax, [ep_hidden_secs]
  7443 000021FC 1316[D521]              		adc	dx, [ep_hidden_secs+2]
  7444 00002200 7305                    		jnc	short okdrive_1
  7445 00002202 800E[FC19]80            		or	byte [fbigfat], 80h ; ftoobig
  7446                                  okdrive_1:
  7447 00002207 26803F0C                		cmp	byte [es:bx], 0Ch ; FAT32 LBA partition ID
  7448 0000220B 7418                    		je	short set_lba_flag
  7449 0000220D 26803F0E                		cmp	byte [es:bx], 0Eh ; FAT16 LBA partition ID
  7450 00002211 7412                    		je	short set_lba_flag
  7451 00002213 3B5513                  		cmp	dx, [di+13h]	; if dx > [di+BDS.secpertrack] then
  7452 00002216 730D                    		jnb	short set_lba_flag ; set LBA r/w flag
  7453 00002218 F77513                  		div	word [di+13h]
  7454 0000221B 31D2                    		xor	dx, dx
  7455 0000221D F77515                  		div	word [di+15h]
  7456 00002220 3D0004                  		cmp	ax, 400h	; if ax (cylinder number) >= 1024
  7457                                  					;  set LBA r/w flag
  7458 00002223 7204                     		jb	short set3
  7459                                  set_lba_flag:
  7460 00002225 804D4004                                or	byte [di+40h], 4 ; fLBArw ; LBA r/w flag
  7461                                  		;;;
  7462                                  ;okdrive:
  7463                                  		; 16/12/2023
  7464                                  set3:		
  7465                                  		;mov	ax, [es:bx+4]
  7466                                  		;mov	[di+17h], ax	; [di+BDS.hiddensecs]
  7467                                  		;			; BPB_HIDDENSECTORS = p->partitionbegin
  7468                                  		;mov	ax, [es:bx+6]
  7469                                  		;mov	[di+19h], ax	; [di+BDS.hiddensecs+2]
  7470                                  
  7471                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  7472                                  		;;;
  7473 00002229 268B4704                		mov	ax, [es:bx+4]	; start sector (LBA) of the partition
  7474 0000222D 268B5706                		mov	dx, [es:bx+6]
  7475                                  		;add	ax, [cs:ep_hidden_secs]
  7476                                  		;adc	dx, [cs:ep_hidden_secs+2]
  7477                                  		; ds = cs
  7478 00002231 0306[D321]              		add	ax, [ep_hidden_secs]
  7479                                  					; + hidden secs of the extd dos partion
  7480 00002235 1316[D521]              		adc	dx, [ep_hidden_secs+2]
  7481 00002239 894517                  		mov	[di+17h], ax	; [di+BDS.hiddensecs]
  7482 0000223C 895519                  		mov	[di+19h], dx	; [di+BDS.hiddensecs+2]
  7483 0000223F 31C0                    		xor	ax, ax ; 0
  7484 00002241 89457B                  		mov	[di+7Bh], ax	; [di+BDS.bdsm_hidden_trks]
  7485 00002244 89450E                  		mov	[di+0Eh], ax	; [di+BDS.totalsec16]	
  7486                                  		;;;
  7487                                  
  7488 00002247 268B570A                		mov	dx, [es:bx+10]	; # of sectors (high)
  7489 0000224B 268B4708                		mov	ax, [es:bx+8]	; # of sectors (low)
  7490 0000224F 89551D                  		mov	[di+1Dh], dx	; [di+BDS.totalsecs32+2]
  7491 00002252 89451B                  		mov	[di+1Bh], ax	; [di+BDS.totalsecs32]
  7492                                  					; bpb->maxsec =	p->partitionlength
  7493                                  		;cmp	dx, 0
  7494                                  		;ja	short okdrive_1
  7495                                  		; 16/12/2023
  7496 00002255 09D2                    		or	dx, dx
  7497 00002257 7505                    		jnz	short set3_read
  7498 00002259 83F840                  		cmp	ax, 64		; if (p->partitionlength < 64)
  7499                                  		;jb	short setret	; return -1;
  7500 0000225C 7264                    		jb	short set3_err
  7501                                  ;okdrive_1:
  7502                                  		; 16/12/2023
  7503                                  set3_read:
  7504 0000225E 8B5519                  		mov	dx, [di+19h]	; [di+BDS.hiddensecs+2]
  7505 00002261 8B4517                  		mov	ax, [di+17h]	; [di+BDS.hiddensecs]
  7506 00002264 31DB                    		xor	bx, bx		; boot sector number - for mini	disk
  7507                                  					; usually equal	to the # of sec/trk.
  7508 00002266 8A5D13                  		mov	bl, [di+13h]	; [di+BDS.secpertrack]
  7509 00002269 50                      		push	ax
  7510 0000226A 89D0                    		mov	ax, dx
  7511 0000226C 31D2                    		xor	dx, dx
  7512 0000226E F7F3                    		div	bx		; (sectors)dx:ax / (BDS.secpertrack)bx =
  7513                                  					; (track)temp_h:ax + (sector)dx
  7514                                  ; 16/12/2023
  7515                                  %if 0
  7516                                  		; 17/10/2022
  7517                                  		;mov	[cs:temp_h], ax
  7518                                  		; 12/08/2023 (ds=cs)
  7519                                  		mov	[temp_h], ax
  7520                                  		pop	ax
  7521                                  		div	bx
  7522                                  		mov	cl, dl
  7523                                  		inc	cl
  7524                                  		xor	bx, bx
  7525                                  		mov	bl, [di+15h]	; [di+BDS.heads]
  7526                                  		push	ax
  7527                                  		xor	dx, dx
  7528                                  		;mov	ax, [cs:temp_h]
  7529                                  		mov	ax, [temp_h] ; 12/08/2023
  7530                                  		div	bx
  7531                                  		;mov	[cs:temp_h], ax
  7532                                  		mov	[temp_h], ax ; 12/08/2023
  7533                                  		pop	ax
  7534                                  		div	bx		; dl is head, ax is cylinder
  7535                                  		; 12/08/2023 (ds=cs)
  7536                                  		cmp	word [temp_h], 0
  7537                                  		;cmp	word [cs:temp_h], 0
  7538                                  		ja	short setret_brdg ; exceeds the	limit of int 13h
  7539                                  		cmp	ax, 1024
  7540                                  		ja	short setret_brdg ; exceeds the	limit of int 13h
  7541                                  			; Retro DOS v3.2 note by Erdogan Tan - 28/07/2019
  7542                                  			; **MSDOS code accepts if ax = 1024 but it is nonsense here
  7543                                  			; ('ja' must be 'jnb')
  7544                                  okdrive_2:
  7545                                   		; 28/07/2019
  7546                                  ; dl is head.
  7547                                  ; ax is cylinder
  7548                                  ; cl is sector number (assume less than 2**6 = 64 for int 13h)
  7549                                  
  7550                                  ;*** for mini disks ***
  7551                                  
  7552                                  		cmp	word [di+47h], 1 ; [di+BDS.bdsm_ismini]
  7553                                  					; check for mini disk
  7554                                  		jnz	short oknotmini	; not mini disk.
  7555                                  		add	ax, [di+49h]	; [di+BDS.bdsm_hidden_trks]
  7556                                  					; set the physical track number
  7557                                  oknotmini:
  7558                                  %endif
  7559                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  7560                                  		;;;
  7561                                  		;mov	[cs:saved_word], ax
  7562 00002270 A3[9E04]                		mov	[saved_word], ax
  7563 00002273 58                      		pop	ax
  7564 00002274 F7F3                    		div	bx
  7565 00002276 88D1                    		mov	cl, dl
  7566 00002278 FEC1                    		inc	cl
  7567 0000227A 8B5D15                  		mov	bx, [di+15h]	; [di+BDS.heads]
  7568 0000227D 50                      		push	ax
  7569 0000227E 31D2                    		xor	dx, dx
  7570                                  		;mov	ax, [cs:saved_word]
  7571 00002280 A1[9E04]                		mov	ax, [saved_word]
  7572 00002283 F7F3                    		div	bx
  7573                                  		;mov	[cs:saved_word], ax
  7574 00002285 A3[9E04]                		mov	[saved_word], ax ; not necessary !? (ax must be 0)
  7575 00002288 58                      		pop	ax
  7576 00002289 F7F3                    		div	bx		; dl is head, ax is cylinder
  7577                                  		; 16/12/2023
  7578 0000228B 0E                      		push	cs
  7579 0000228C 07                      		pop	es ; (*)
  7580 0000228D BB[5201]                		mov	bx, disksector ; (**)
  7581                                  		;
  7582 00002290 F6454004                		test	byte [di+40h], 4 ; fLBArw ; LBA read/write flag
  7583 00002294 742F                    		jz	short set3_chs_read
  7584                                  set3_lba_read:
  7585                                  
  7586                                  ; 16/12/2023
  7587                                  %if 0
  7588                                  		;push	cs
  7589                                  		;pop	es ; (*)
  7590                                  		;mov	bx, disksector ; (**)
  7591                                  
  7592                                  		;push	ds
  7593                                  		;push	si
  7594                                  		xor	ax, ax	; 0
  7595                                  		push	ax
  7596                                  		push	ax
  7597                                  		mov	ax, [di+19h]	; [di+BDS.hiddensectors+2]
  7598                                  		push	ax
  7599                                  		mov	ax, [di+17h]	; [di+BDS.hiddensectors]
  7600                                  		push	ax
  7601                                  		push	es		; buffer address
  7602                                  		push	bx
  7603                                  		mov	ax, 1		; sector (read) count
  7604                                  		push	ax
  7605                                  		;mov	ax, 16		; DAP size
  7606                                  		mov	al, 16
  7607                                  		push	ax
  7608                                  		mov	dl, [rom_drv_num] ; ds = cs
  7609                                  		mov	ax, ss
  7610                                  		mov	ds, ax ; ds = ss
  7611                                  		mov	si, sp
  7612                                  		;mov	dl, [cs:rom_drv_num]
  7613                                  		mov	ah, 42h
  7614                                  		int	13h		; DISK - IBM/MS Extension
  7615                                  					; EXTENDED READ (DL - drive, DS:SI - disk address packet)
  7616                                  		;pop	si
  7617                                  		;pop	ds
  7618                                  		jnc	short set3_lba_read_ok
  7619                                  		add	sp, 16
  7620                                  		;pop	si
  7621                                  		;pop	ds
  7622                                  set3_err:
  7623                                  		;jmp	setret
  7624                                  		jmp	ret_hard_err
  7625                                  
  7626                                  set3_lba_read_ok
  7627                                  		add	sp, 16
  7628                                  		;pop	si
  7629                                  		;pop	ds
  7630                                  		jmp	short set3_read_ok
  7631                                  %else
  7632                                  		; 16/12/2023
  7633                                  		;push	si ; * ; (not necessary)
  7634                                  		;mov	si, empty_dap_buff ; dap_buffer
  7635 00002296 BE[2D1B]                		mov	si, dap_buffer ; empty_dap_buff 
  7636 00002299 56                      		push	si
  7637 0000229A 87F7                    		xchg	si, di
  7638                                  		; si = BDS
  7639                                  		; di = DAP buffer
  7640 0000229C B81000                  		mov	ax, 16
  7641 0000229F AB                      		stosw		; DAP size
  7642 000022A0 B001                    		mov	al, 1
  7643 000022A2 AB                      		stosw		; sector (read) count
  7644                                  		; buffer address
  7645 000022A3 89D8                    		mov	ax, bx	; offset disksector
  7646 000022A5 AB                      		stosw
  7647 000022A6 8CC0                    		mov	ax, es	; es=ds=cs = BIOSDATA segment
  7648 000022A8 AB                      		stosw
  7649                                  		; sector address (bits 0 to 31)	
  7650 000022A9 8B4417                  		mov	ax, [si+17h] ; [di+BDS.hiddensectors]
  7651 000022AC AB                      		stosw
  7652 000022AD 8B4419                  		mov	ax, [si+19h] ; [di+BDS.hiddensectors+2]
  7653 000022B0 AB                      		stosw
  7654                                  		; sector address bits 32 to 63 (0)
  7655 000022B1 31C0                    		xor	ax, ax ; 0
  7656 000022B3 AB                      		stosw
  7657 000022B4 AB                      		stosw
  7658                                  		;xchg	di, si
  7659 000022B5 89F7                    		mov	di, si
  7660                                  		; di = BDS
  7661 000022B7 5E                      		pop	si ; DAP buffer address	
  7662                                  		
  7663 000022B8 8A16[FF19]              		mov	dl, [rom_drv_num] ; ds = cs
  7664 000022BC B442                    		mov	ah, 42h
  7665 000022BE CD13                    		int	13h		; DISK - IBM/MS Extension
  7666                                  					; EXTENDED READ (DL - drive, DS:SI - disk address packet)
  7667                                  		;pop	si ; *
  7668 000022C0 7324                    		jnc	short set3_read_ok
  7669                                  set3_err:
  7670                                  		;jmp	setret
  7671 000022C2 E9B502                  		jmp	ret_hard_err
  7672                                  %endif
  7673                                  
  7674                                  set3_chs_read:
  7675 000022C5 837D7901                		cmp	word [di+79h], 1 ; [di+BDS.bdsm_ismini] ; check for mini disk
  7676 000022C9 7503                    		jnz	short oknotmini
  7677 000022CB 03457B                  		add	ax, [di+7Bh]	; [di+BDS.bdsm_hidden_trks]
  7678                                  		;;;
  7679                                  
  7680                                  oknotmini:
  7681                                  ;*** end of added logic for mini disk
  7682                                  				
  7683 000022CE D0CC                    		ror	ah, 1		; move high two bits of cyl to high
  7684 000022D0 D0CC                    		ror	ah, 1		; two bits of upper byte
  7685 000022D2 80E4C0                  		and	ah, 0C0h	; turn off remainder of bits
  7686 000022D5 08E1                    		or	cl, ah		; move two bits to correct spot
  7687 000022D7 88C5                    		mov	ch, al		; ch iscylinder (low 8 bits)
  7688                                  					; cl is sector + 2 high bits of cylinder
  7689 000022D9 88D6                    		mov	dh, dl		; dh is	head
  7690                                  		
  7691                                  		; 12/08/2023 (ds=cs)
  7692 000022DB 8A16[FF19]              		mov	dl, [rom_drv_num]
  7693                                  		;mov	dl, [cs:rom_drv_num] ; dl is drive number
  7694                                  
  7695                                  ; cl is sector + 2 high bits of cylinder
  7696                                  ; ch is low 8 bits of cylinder
  7697                                  ; dh is head
  7698                                  ; dl is drive
  7699                                  
  7700                                  ; for convenience, we are going to read the logical boot sector
  7701                                  ; into cs:disksector area.
  7702                                  
  7703                                  ; read in boot sector using bios disk interrupt. the buffer where it
  7704                                  ; is to be read in is cs:disksector.
  7705                                  
  7706                                  		; 16/12/2023
  7707                                  		; es=ds=cs = BIOSDATA segment
  7708                                  		; bx = disksector ; (**)
  7709                                  
  7710                                  		;push	cs
  7711                                  		;pop	es ; (*)
  7712                                  		
  7713                                  		;mov	bx, disksector	; for convenience,
  7714                                  					; we are going to read the logical boot sector
  7715                                  					; into cs:disksector area.
  7716 000022DF B80102                  		mov	ax, 201h
  7717 000022E2 CD13                    		int	13h		; DISK - READ SECTORS INTO MEMORY
  7718                                  					; AL = number of sectors to read, CH = track, CL = sector
  7719                                  					; DH = head, DL	= drive, ES:BX -> buffer to fill
  7720                                  					; Return: CF set on error, AH =	status,	AL = number of sectors read
  7721                                  		; 16/12/2023
  7722 000022E4 72DC                    		jc	short set3_err
  7723                                  
  7724                                  ; cs:disksec contains the boot sector. in theory, (ha ha) the bpb in this thing
  7725                                  ; is correct. we can, therefore, suck out all the relevant statistics on the
  7726                                  ; media if we recognize the version number.
  7727                                  
  7728                                  set3_read_ok:
  7729                                  		; 11/08/2023
  7730                                  		;mov	bx, disksector	; BIOSDATA:014Eh ; MSDOS 6.21 ; 11/08/2023
  7731                                  					; BIOSDATA:0152h ; PCDOS 7.1 IBMBIO.COM
  7732                                  		; 18/12/2023
  7733                                  		;push	bx ; +
  7734                                  		;push	ax ; (not necessary)
  7735                                  
  7736                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  7737                                  		;;;
  7738 000022E6 81BFFE0155AA            		cmp	word [bx+1FEh], 0AA55h
  7739 000022EC 7541                    		jne	short invalid_boot_record
  7740                                  		; 16/12/2023
  7741                                  		; 12/08/2023
  7742                                  		; ds = cs = BIOSDATA segment ('disksector:' is in BIOSDATA) 
  7743 000022EE 803FE9                  		cmp	byte [bx], 0E9h	; is it a near jump?
  7744 000022F1 740B                    		je	short check_1_ok ; yes
  7745 000022F3 803FEB                  		cmp	byte [bx], 0EBh	; is it a short jump?
  7746 000022F6 7537                    		jne	short invalid_boot_record ; no
  7747 000022F8 807F0290                		cmp	byte [bx+2], 90h ; yes, is the next one a nop?
  7748 000022FC 7531                    		jne	short invalid_boot_record ; no, invalid bs ; 11/08/2023
  7749                                  check_1_ok:
  7750 000022FE 837F1600                		cmp     word [bx+16h], 0 ; [bx+BPB_FATSz16]
  7751                                  		;jz	short check_1	; 16 bit FAT size is 0 if it is FAT32 bs
  7752                                  		; 16/12/2023
  7753 00002302 740E                    		jz	short check_2	; FAT32 bs
  7754                                  
  7755                                  		; FAT16 or FAT12 bs
  7756                                  
  7757                                  		;push	ds
  7758                                  		;push	si  ; (not necessary)
  7759 00002304 57                      		push	di
  7760                                  		; es=ds=cs = BIOSDATA segment
  7761                                  		;push	es
  7762                                  		;pop	ds
  7763                                  
  7764                                  		;mov	cx, 28
  7765 00002305 B90E00                  		mov	cx, 14 ; *
  7766 00002308 8D7724                  		lea	si, [bx+24h]	; move offset 36 to 63
  7767                                  					;      to offset 64 (28 bytes)
  7768 0000230B 8D7F40                  		lea	di, [bx+40h]	; boot sector offset 64
  7769 0000230E FC                      		cld	; (not necessary, 'std' is not used before here)
  7770                                  		;rep movsb
  7771 0000230F F3A5                    		rep movsw ; *
  7772 00002311 5F                      		pop	di
  7773                                  		;pop	si
  7774                                  		;pop	ds
  7775                                  		;;;
  7776                                  ; 16/12/2023
  7777                                  %if 0
  7778                                  ;check_1:
  7779                                  		; 12/08/2023
  7780                                  		; ds = cs = BIOSDATA segment ('disksector:' is in BIOSDATA) 
  7781                                  		cmp	byte [bx], 0E9h
  7782                                  		;cmp	byte [cs:bx], 0E9h ; is it a near jump?
  7783                                  		je	short check_1_ok ; yes
  7784                                  		cmp	byte [bx], 0EBh
  7785                                  		;cmp	byte [cs:bx], 0EBh ; is it a short jump?
  7786                                  		jne	short invalid_boot_record ; no
  7787                                  		cmp	byte [bx+2], 90h
  7788                                  		;cmp	byte [cs:bx+2], 90h ; yes, is the next one a nop?
  7789                                  		jne	short invalid_boot_record ; no, invalid bs ; 11/08/2023
  7790                                  check_1_ok:
  7791                                  %endif
  7792                                  
  7793                                  ; 18/12/2023
  7794                                  %if 0
  7795                                  		; 14/08/2023
  7796                                  check_2:
  7797                                  		mov	bx, disksector+11 ; disksector+EXT_BOOT.BPB
  7798                                  		;mov	bx, 159h	; disksector+EXT_BOOT.BPB
  7799                                  					; point to the bpb in the boot record
  7800                                  		;mov	al, [cs:bx+10]	; [bx+EBPB.MEDIADESCRIPTOR]
  7801                                  		mov	al, [bx+10] ; 12/08/2023 
  7802                                  					; get the mediadescriptor byte
  7803                                  		and	al, 0F0h	; mask off low nibble
  7804                                  		cmp	al, 0F0h	; is high nibble = 0Fh?
  7805                                  		jne	short invalid_boot_record ; no, invalid boot record
  7806                                  		;cmp	word [cs:bx], 512 ; [bx+EBPB.BYTESPERSECTOR]
  7807                                  		cmp	word [bx], 512 ; 12/08/2023
  7808                                  		jne	short invalid_boot_record ; invalidate non 512 byte sectors
  7809                                  
  7810                                  check2_ok:				; yes, mediadescriptor ok.
  7811                                  		mov	al, [bx+2] ; 12/08/2023
  7812                                  		;mov	al, [cs:bx+2]	; now make sure that
  7813                                  					; the sectorspercluster is
  7814                                  					; a power of 2
  7815                                  					;
  7816                                  					; [bx+EBPB.SECTORSPERCLUSTER]
  7817                                  					; get the sectorspercluster
  7818                                  %endif
  7819                                  		;;;
  7820                                  check_2:
  7821                                  		; 18/12/2023
  7822                                  		; bx = disksector
  7823 00002312 8A4715                  		mov	al, [bx+21]	; [bx+EXT_BOOT.BPB+EBPB.MEDIADESCRIPTOR]
  7824                                  					; get the mediadescriptor byte
  7825 00002315 24F0                    		and	al, 0F0h	; mask off low nibble
  7826 00002317 3CF0                    		cmp	al, 0F0h	; is high nibble = 0Fh?
  7827 00002319 7514                    		jne	short invalid_boot_record ; no, invalid boot record
  7828 0000231B 817F0B0002              		cmp	word [bx+11], 512 ; [bx+EXT_BOOT.BPB+EBPB.BYTESPERSECTOR]
  7829 00002320 750D                    		jne	short invalid_boot_record ; invalidate non 512 byte sectors
  7830                                  
  7831                                  check2_ok:	; yes, mediadescriptor ok.
  7832 00002322 8A470D                  		mov	al, [bx+13]	; now make sure that
  7833                                  					; the sectorspercluster is
  7834                                  					; a power of 2
  7835                                  					;
  7836                                  					; [bx++EXT_BOOT.BPB+EBPB.SECTORSPERCLUSTER]
  7837                                  					; get the sectorspercluster
  7838                                  		;;;
  7839                                  
  7840 00002325 08C0                    		or	al, al		; is it zero?
  7841 00002327 7406                    		jz	short invalid_boot_record ; yes, invalid boot record
  7842                                  
  7843                                  ck_power_of_two:
  7844 00002329 D0E8                    		shr	al, 1		; shift until first bit emerges
  7845 0000232B 73FC                    		jnc	short ck_power_of_two
  7846 0000232D 7406                    		jz	short valid_boot_record
  7847                                  
  7848                                  invalid_boot_record:
  7849                                  		; 18/12/2023
  7850                                  		;pop	ax
  7851                                  		;pop	bx ; +
  7852 0000232F E95E01                  		jmp	unknown		; jump to invalid boot record
  7853                                  					; unformatted or illegal media.
  7854                                  ; 16/12/2023
  7855                                  ; ---------------------------------------------------------------------------
  7856                                  ;	; 12/08/2023
  7857                                  ;setret_brdg:
  7858                                  ;		jmp	setret
  7859                                  ; ---------------------------------------------------------------------------
  7860                                  
  7861                                  unknown3_0_j:
  7862 00002332 E95F01                  		jmp	unknown3_0	; legally formatted media,
  7863                                  					; although, content might be bad.
  7864                                  ; ---------------------------------------------------------------------------
  7865                                  
  7866                                  valid_boot_record:
  7867                                  		; 18/12/2023
  7868                                  		;pop	ax
  7869                                  		;pop	bx ; +
  7870                                  		
  7871                                  		; 18/12/2023
  7872                                  		; bx = offset disksector ; +
  7873                                  
  7874                                  ; Signature found. Now check version.
  7875                                  
  7876                                  		; 14/08/2023
  7877 00002335 817F08322E              		cmp	word [bx+8], '2.'
  7878                                  		;cmp	word [cs:bx+8], '2.' ; 03/10/2022 (NASM syntax)
  7879                                  		;;cmp	word ptr cs:[bx+8], 2E32h ; '2.'
  7880 0000233A 7506                    		jne	short try5
  7881 0000233C 807F0A30                		cmp	byte [bx+10], '0'
  7882                                  		;cmp	byte [cs:bx+0Ah], '0' ; 03/10/2022 (NASM syntax)
  7883                                  		;;cmp	byte ptr cs:[bx+0Ah], 30h ; '0'
  7884                                  		; 12/08/2023
  7885                                  		;jnz	short try5
  7886                                  		;jmp	short copybpb
  7887 00002340 7425                    		je	short copybpb
  7888                                  
  7889                                  ;; --------------------------------------------------------------------------
  7890                                  ;;	; 12/08/2023
  7891                                  ;;setret_brdg:
  7892                                  ;;		jmp	setret
  7893                                  ;; --------------------------------------------------------------------------
  7894                                  ;
  7895                                  ;unknown3_0_j:
  7896                                  ;		jmp	unknown3_0	; legally formatted media,
  7897                                  ;					; although, content might be bad.
  7898                                  ; ---------------------------------------------------------------------------
  7899                                  
  7900                                  try5:
  7901 00002342 E83902                  		call	cover_fdisk_bug
  7902                                  
  7903                                  ; see if it is an os2 signature
  7904                                  
  7905                                  		; 12/08/2023
  7906                                  		; ds = cs = BIOSDATA segment
  7907 00002345 817F08302E              		cmp	word [bx+8], '0.'
  7908                                  		;cmp	word [cs:bx+8], '0.' ; 03/10/2022 (NASM syntax)
  7909                                  		;;cmp	word ptr cs:[bx+8], 2E30h ; '0.'
  7910 0000234A 750C                    		jne	short no_os2
  7911 0000234C 8A4707                  		mov	al, [bx+7] ; 12/08/2023
  7912                                  		;mov	al, [cs:bx+7]	; 17/10/2022 (NASM syntax)
  7913 0000234F 2C31                    		sub	al, '1'
  7914                                  		;sub	al, 31h		; '1'
  7915 00002351 24FE                    		and	al, 0FEh
  7916 00002353 7412                    		jz	short copybpb	; accept either	'1' or '2'
  7917 00002355 E93801                  		jmp	unknown
  7918                                  ; ---------------------------------------------------------------------------
  7919                                  
  7920                                  ; no os2 signature, this is to check for real dos versions
  7921                                  
  7922                                  no_os2:
  7923                                  		; 12/08/2023
  7924                                  		; ds = cs = BIOSDATA
  7925 00002358 817F08332E              		cmp	word [bx+8], '3.'			
  7926                                  		;cmp	word [cs:bx+8], '3.' ; 03/10/2022 (NASM syntax)
  7927                                  		;;cmp	word ptr cs:[bx+8], 2E33h ; '3.'
  7928 0000235D 72D3                    		jb	short unknown3_0_j ; must be 2.1 boot record.
  7929                                  					; do not trust it, but still legal.
  7930 0000235F 7506                    		jnz	short copybpb	; honor	os2 boot record
  7931                                  					; or dos 4.0 version
  7932 00002361 807F0A31                		cmp	byte [bx+10], '1' ; 12/08/2023
  7933                                  		;cmp	byte [cs:bx+10], '1'
  7934                                  		;;cmp	byte ptr cs:[bx+0Ah], 31h ; '1'
  7935 00002365 72CB                    		jb	short unknown3_0_j ; if version >= 3.1, then o.k.
  7936                                  copybpb:
  7937                                  
  7938                                  ; 03/10/2022
  7939                                  
  7940                                  ; we have a valid boot sector. use the bpb in it to build the
  7941                                  ; bpb in bios. it is assumed that only
  7942                                  ;	BDS_BPB.BPB_SECTORSPERCLUSTER
  7943                                  ;	BDS_BPB.BPB_ROOTENTRIES, and
  7944                                  ;	BDS_BPB.BPB_SECTORSPERFAT
  7945                                  ; need to be set (all other values in already). fbigfat is also set.
  7946                                  
  7947                                  ; if it is non fat based system, then just copy the bpb from the boot sector
  7948                                  ; into the bpb in bds table, and also set the boot serial number, volume id,
  7949                                  ; and system id according to the boot record.
  7950                                  ; for the non_fat system, don't need to set the other value. so just do goodret.
  7951                                  
  7952                                  		; 17/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  7953                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2787h)
  7954                                  		;;;
  7955                                  		; 17/12/2023
  7956 00002367 BE[5D01]                		mov	si, disksector+11
  7957                                  		;sub	ch, ch ; ; (ch may be > 0)
  7958 0000236A 29C9                    		sub	cx, cx ; 0 
  7959                                  		;mov	cl, [disksector+16] ; BPB_NumFATs
  7960 0000236C 8A4C05                  		mov	cl, [si+5] ; number of FATs
  7961                                  
  7962                                  		; NOTE: This check is not proper for FAT32 boot sector (standard spec)
  7963                                  		; (after PCDOS 7.1). So, it is not existing in Windows ME IO.SYS
  7964                                  		; Erdogan Tan - 01/09/2023 ((IBMBIO.COM 7.1 disassembly note))
  7965                                  
  7966                                  		;;cmp	word ptr cs:disksector+4Dh, 0 ; ???
  7967                                  		;cmp	word [disksector+4Dh], 0
  7968                                  		;jnz	short check_3
  7969                                  
  7970                                  		; 17/12/2023
  7971                                  		; check extended boot signature (0x29)
  7972                                  		;
  7973                                  		; (***) NOTE: 28 bytes of FAT16/FAT12 boot sector from offset 36
  7974                                  		; have been moved to offset 64 (see label 'check_1_ok:' above) 
  7975                                  		; ((now, BS_BootSig is at offset 66 even if it was at offset 38))
  7976                                  		
  7977                                  		;cmp	cs:disksector+42h, 29h	; BS_BootSig (FAT32)
  7978 0000236F 803E[9401]29            		cmp	byte [disksector+42h], 29h ; BS_BootSig (***)
  7979                                  		;jmp	short check_4
  7980                                  check_3:
  7981                                  		;;cmp	cs:disksector+26h, 29h	; BS_BootSig (FAT16/FAT12)
  7982                                  		;cmp	byte [disksector+26h], 29h ; (***)
  7983                                  check_4:
  7984 00002374 7538                    		jnz	short copybpb_fat	; conventional fat system
  7985                                  
  7986                                  ; 17/12/2023
  7987                                  %if 0
  7988                                  		; 10/12/2022
  7989                                  		; (number of FATs optimization)
  7990                                  		mov	si, disksector+11 ; disksector+0Bh
  7991                                  		;;mov	cl, [cs:disksector+10h] ; Number of FATs (may be 2 or 1)
  7992                                  		;mov	cl, [cs:si+05h]
  7993                                  		; 12/08/2023
  7994                                  		; ds = cs = BIOSDATA segment (0070h)
  7995                                  		mov	cl, [si+05h] ; number of FATs
  7996                                  
  7997                                  		cmp	byte [si+1Bh], 29h ; 12/08/2023
  7998                                  		;cmp	byte [cs:si+1Bh], 29h ; 10/12/2022	
  7999                                  		;;cmp	byte [cs:disksector+26h], 29h ; 17/10/2022
  8000                                  					; [disksector+EXT_BOOT.SIG]
  8001                                  					; EXT_BOOT_SIGNATURE
  8002                                  		jnz	short copybpb_fat ; conventional fat system
  8003                                  
  8004                                  		; 03/10/2022
  8005                                  		; 29/12/2018 - Retro DOS v4.0 modification note:
  8006                                  		; Regarding 'fat_big_small' part of this (MSDOS 6.0) code
  8007                                  		;	     number of FATs must be 2 ; =*?=
  8008                                  		; (Otherwise, '# of data sectors' would be calculated as wrong!!!)
  8009                                  		;
  8010                                  		;cmp	byte [disksector+EXT_BOOT.BPB+EBPB.NUMBEROFFATS], 2 ; =*?=
  8011                                  
  8012                                  		; 10/12/2022
  8013                                  		;cmp	byte [cs:disksector+10h], 0
  8014                                  					; [disksector+EXT_BOOT.BPB+EBPB.NUMBEROFFATS]
  8015                                  		;jnz	short copybpb_fat ; a fat system.
  8016                                  		or	cl, cl	 ; [cs:disksector+10h]
  8017                                  		jnz	short copybpb_fat ; a fat system.
  8018                                  %endif
  8019                                  
  8020                                  		; 17/12/2023 - Retro DOS v5.0
  8021                                  		;;cmp	byte [cs:disksector+10h], 0 ; BPB.fats
  8022                                  		;cmp	byte [disksector+10h], 0 ; BPB_NUmFATs
  8023                                  		;jnz	short copybpb_fat ; a fat system
  8024                                  		; 17/12/2023
  8025                                  		; cl = [disksector+10h]
  8026 00002376 20C9                    		and	cl, cl ; 0 ?
  8027 00002378 7534                    		jnz	short copybpb_fat ; a fat system
  8028                                  
  8029                                  ; non fat based	media.
  8030                                  
  8031 0000237A 57                      		push	di  ; BDS
  8032                                  		; 12/08/2023
  8033                                  		;push	ds  ; ds = cs = BIOSDATA segment
  8034                                  		
  8035                                  		; 17/12/2023
  8036                                  		; es = ds = cs
  8037                                  		;push	ds
  8038                                  		;pop	es
  8039                                  
  8040                                  		; 12/08/2023
  8041                                  		; ds = cs
  8042                                  		;push	cs
  8043                                  		;pop	ds
  8044                                  
  8045                                  		; 10/12/2022
  8046                                  		; (number of FATs optimization)
  8047                                  		; SI = disksector+11
  8048                                  		; 17/10/2022
  8049                                  		;;mov	si, 159h	; disksector+EXT_BOOT.BPB
  8050                                  		;mov	si, disksector+11
  8051 0000237B 83C706                  		add	di, 6		; add di,BDS.BPB
  8052                                  
  8053                                  ; just for completeness, we'll make sure that total_sectors and
  8054                                  ; big_total_sectors aren't both zero. I've seen examples of
  8055                                  ; this on DOS 3.30 boot records. I don't know exactly how it
  8056                                  ; got that way. If it occurs, then use the values from the
  8057                                  ; partition table.
  8058                                  
  8059                                  		; 17/12/2023
  8060                                  		; cx = 0
  8061                                  		; 18/12/2022
  8062                                  		;sub	cx, cx
  8063                                  
  8064                                  		;cmp	word [cs:si+8], 0 	; [cs:si+EBPB.TOTALSECTORS]
  8065                                  		;jnz	short already_nonz 
  8066                                  		;			; how about big_total?
  8067                                  		;cmp	word [cs:si+15h], 0	; [cs:si+EBPB.BIGTOTALSECTORS]
  8068                                  		;jnz	short already_nonz ; we're okay if any are != 0
  8069                                  		;cmp	word [cs:si+17h], 0	; [cs:si+EBPB.BIGTOTALSECTORS+2]
  8070                                  		;jnz	short already_nonz
  8071                                  
  8072                                  		; 12/08/2023
  8073                                  		; ds = cs = BIOSDATA segment (0070h)
  8074                                  
  8075                                  		; 17/12/2023
  8076                                  		; 12/08/2023
  8077 0000237E 394C08                  		cmp	[si+8], cx ; 0		; [si+EBPB.TOTALSECTORS]
  8078 00002381 751C                    		jnz	short already_nonz
  8079                                  				    	; how about big_total?
  8080 00002383 394C15                  		cmp	[si+15h], cx ; 0	; [si+EBPB.BIGTOTALSECTORS]
  8081 00002386 7517                    		jnz	short already_nonz ; we're okay if any are != 0
  8082 00002388 394C17                  		cmp	[si+17h], cx ; 0	; [si+EBPB.BIGTOTALSECTORS+2]
  8083 0000238B 7512                    		jnz	short already_nonz
  8084                                  
  8085                                  ; now let's copy the values from the partition table (now in the BDS)
  8086                                  ; into the BPB in the boot sector buffer, before they get copied back.
  8087                                  
  8088 0000238D 8B4508                  		mov	ax, [di+8]	; [di+BDS.totalsecs16]
  8089                                  		; 12/08/2023
  8090                                  		;mov	[cs:si+8], ax	; [cs:si+EBPB.TOTALSECTORS]
  8091 00002390 894408                  		mov	[si+8], ax
  8092 00002393 8B4515                  		mov	ax, [di+15h]	; [di+BDS.totalsecs32]
  8093                                  		;mov	[cs:si+15h], ax	; [cs:si+EBPB.BIGTOTALSECTORS]
  8094 00002396 894415                  		mov	[si+15h], ax
  8095 00002399 8B4517                  		mov	ax, [di+17h]	; [di+BDS.totalsecs32+2]
  8096                                  		;mov	[cs:si+17h], ax	; [cs:si+EBPB.BIGTOTALSECTORS+2]
  8097 0000239C 894417                  		mov	[si+17h], ax
  8098                                  
  8099                                  already_nonz:
  8100                                  		; 18/12/2022
  8101                                  		; cx = 0
  8102                                  		;mov	cl, 25
  8103                                  		;;mov	cx, 25		; A_BPB.size - 6 ; Use SMALL version!
  8104                                  		; 17/12/2023 - Retro DOS v5.0
  8105 0000239F B135                    		mov	cl, 53	; PCDOS 7.1 IBMBIO.COM
  8106                                  				; BDS.BPB size (25 + 28 for FAT32 parms)
  8107 000023A1 F3A4                    		rep movsb
  8108                                  		;pop	ds
  8109                                  		; 12/08/2023
  8110                                  		; ds = cs
  8111                                  		;pop	bp  ; ds (on top of stack) = BIOSDATA
  8112 000023A3 5F                      		pop	di  ; BDS
  8113                                  		;push	es
  8114                                  		;push	ds
  8115                                  		;pop	es
  8116                                  		;push	cs
  8117                                  		;pop	ds
  8118                                  		; 12/08/2023
  8119                                  		;mov	es, bp
  8120                                  		; ds = cs = es
  8121                                  		
  8122                                  		; 14/08/2023
  8123 000023A4 BD[5108]                		mov	bp, MOVMEDIAIDS ; mov_media_ids
  8124                                  		; 18/12/2022
  8125                                  		;mov	bp, mov_media_ids
  8126                                  		;;mov	bp, 751h	; mov_media_ids
  8127                                  					; at 2C7h:751h = 70h:2CC1h
  8128                                  					; set volume id, systemid, serial.
  8129 000023A7 0E                      		push	cs		; simulate far call
  8130 000023A8 E8B8F6                  		call	call_bios_code
  8131                                  		; 12/08/2023
  8132                                  		; ds = cs = es
  8133                                  		;push	es
  8134                                  		;pop	ds
  8135                                  		;pop	es
  8136 000023AB E9C501                  		jmp	goodret
  8137                                  
  8138                                  ; ---------------------------------------------------------------------------
  8139                                  
  8140                                  ; ****** cas ---
  8141                                  ; IBM DOS 3.30 doesn't seem to mind that the TOTAL_SECTORS and
  8142                                  ; BIG_TOTAL_SECTORS field in the boot sector are 0000. This
  8143                                  ; happens with some frequency -- perhaps through some OS/2 setup
  8144                                  ; program. We haven't actually been COPYING the TOTAL_SECTORS
  8145                                  ; from the boot sector into the DPB anyway, we've just been using
  8146                                  ; it for calculating the fat size. Pretty scary, huh? For now,
  8147                                  ; we'll go ahead and copy it into the DPB, except in the case
  8148                                  ; that it equals zero, in which case we just use the values in
  8149                                  ; the DPB from the partition table.
  8150                                  
  8151                                  ; 17/10/2022
  8152                                  ;MOVMEDIAIDS equ mov_media_ids - DOSBIOSEG_2C7h ; (751h for MSDOS 5.0 IO.SYS)
  8153                                  ;CLEARIDS equ clear_ids - DOSBIOSEG_2C7h ; (5D9h for MSDOS 5.0 IO.SYS)		    		
  8154                                  ; 09/12/2022
  8155                                  MOVMEDIAIDS equ mov_media_ids
  8156                                  CLEARIDS equ clear_ids
  8157                                  ; 11/09/2023
  8158                                  CLEARIDS_X equ clear_ids_x
  8159                                  
  8160                                  copybpb_fat:
  8161                                  		; 17/12/2023
  8162                                  		; ch = 0, cl = number of FATs
  8163                                  		; 10/12/2022
  8164                                  		; (number of FATs optimization)
  8165                                  		; SI = disksector+11
  8166                                  		; 17/10/2022
  8167                                  		;mov	si, disksector+11
  8168                                  		;;mov	si, 159h	; disksector+EXT_BOOT.BPB
  8169                                  					; cs:si	-> bpb in boot
  8170                                  		; 17/12/2023
  8171                                  		; dx = 0
  8172                                  		;xor	dx, dx
  8173                                  
  8174                                  		; 12/08/2023
  8175                                  		; ds = cs = BIOSDATA segment (0070h)
  8176 000023AE 8B4408                  		mov	ax, [si+8]
  8177                                  		;mov	ax, [cs:si+8]	; [cs:si+EBPB.TOTALSECTORS]
  8178                                  					; get totsec from boot sec
  8179 000023B1 09C0                    		or	ax, ax
  8180 000023B3 7514                    		jnz	short copy_totsec ; if non zero, use that
  8181 000023B5 8B4415                  		mov	ax, [si+15h] ; 12/08/2023
  8182                                  		;mov	ax, [cs:si+15h]	; [cs:si+EBPB.BIGTOTALSECTORS]
  8183                                  					; get the big version
  8184                                  					; (32 bit total	sectors)
  8185 000023B8 8B5417                  		mov	dx, [si+17h] ; 12/08/2023
  8186                                  		;mov	dx, [cs:si+17h]	; [cs:si+EBPB.BIGTOTALSECTORS+2]
  8187                                  		; 10/12/2022
  8188                                  		; (number of FATs optimization)
  8189                                  		; CL = number of FATs (2 or 1) 
  8190 000023BB 89D3                    		mov	bx, dx		; see if it is a big zero
  8191 000023BD 09C3                    		or	bx, ax
  8192 000023BF 7508                    		jnz	short copy_totsec
  8193                                  			; screw it. it was bogus.
  8194 000023C1 8B451B                  		mov	ax, [di+1Bh]	; [di+BDS.totalsecs32]
  8195 000023C4 8B551D                  		mov	dx, [di+1Dh]	; [di+BDS.totalsecs32+2]
  8196 000023C7 EB06                    		jmp	short fat_big_small
  8197                                  
  8198                                  		;mov	cx, dx
  8199                                  		;or	cx, ax		; see if it is a big zero
  8200                                  		;jz	short totsec_already_set ; screw it. it	was bogus.
  8201                                  copy_totsec:				
  8202 000023C9 89451B                  		mov	[di+1Bh], ax	; [di+BDS.totalsecs32]
  8203                                  					; make DPB match boot sec
  8204 000023CC 89551D                  		mov	[di+1Dh], dx	; [di+BDS.totalsecs32+2]
  8205                                  
  8206                                  		; 10/12/2022
  8207                                  ;totsec_already_set:			
  8208                                  		;mov	ax, [di+1Bh]	; [di+BDS.totalsecs32]
  8209                                  		;mov	dx, [di+1Dh]	; [di+BDS.totalsecs32+2]
  8210                                  
  8211                                  ; determine fat entry size.
  8212                                  
  8213                                  fat_big_small:
  8214                                  
  8215                                  ;at this moment dx;ax = total sector number
  8216                                  
  8217                                  ;Do not assume 1 reserved sector. Update the reserved sector field in BDS 
  8218                                  ;from the BPB on the disk
  8219                                  		
  8220                                  		; 12/08/2023
  8221                                  		; ds = cs = BIOSDATA segment (0070h)
  8222                                  				
  8223 000023CF 8B5C03                  		mov	bx, [si+3]
  8224                                  		;mov	bx, [cs:si+3]	; [cs:si+EBPB.RESERVEDSECTORS]
  8225                                  					; get #reserved_sectors	from BPB
  8226 000023D2 895D09                  		mov	[di+9],	bx	; [di+BDS.resectors]
  8227                                  					; update BDS field
  8228 000023D5 29D8                    		sub	ax, bx
  8229 000023D7 83DA00                  		sbb	dx, 0		; update the count
  8230                                  		; 12/08/2023
  8231 000023DA 8B5C0B                  		mov	bx, [si+0Bh]
  8232                                  		;mov	bx, [cs:si+0Bh]	; [cs:si+EBPB.SECTORSPERFAT]
  8233                                  					; bx = sectors/fat
  8234 000023DD 895D11                  		mov	[di+11h], bx	; [di+BDS.fatsecs]
  8235                                  					; set in bds bpb
  8236                                  		; 17/12/2023 - Retro DOS v5.0
  8237                                  		;	      (PCDOS 7.1 IBMBIO.COM)
  8238 000023E0 53                      		push	bx ; FAT sectors
  8239 000023E1 09DB                    		or	bx, bx
  8240 000023E3 753A                    		jnz	short fat_16bit	
  8241                                  
  8242                                  ; 17/12/2023
  8243                                  %if 0		
  8244                                  		sub	ax, [si+19h]	; FAT32 file system (PCDOS 7.1 BUG!)
  8245                                  					; BPB.FATSz32
  8246                                  		sbb	dx, [si+1Bh]	; BPB.FATSz32+2 (PCDOS 7.1 BUG!)
  8247                                  		; dx:ax = partition size - (one FAT sectors + reserved sects)  
  8248                                  		mov	bx, [si+19h]	; BPB.FATSz32
  8249                                  		mov	[di+1Fh], bx	; [di+BDS.fatsecs32]
  8250                                  		mov	bx, [si+1Bh]	; BPB.FATSz32+2
  8251                                  		mov	[di+21h], bx	; [di+BDS.fatsecs32+2]
  8252                                  		mov	bx, [si+1Dh]	; BPB.BPB_ExtFlags
  8253                                  		mov	[di+23h], bx	; [di+BDS.extflags]
  8254                                  		mov	bx, [si+1Fh]	; BPB.FSVer
  8255                                  		mov	[di+25h], bx	; [di+BDS.fsver]
  8256                                  		mov	bx, [si+21h]	; BPB.RootClus
  8257                                  		mov	[di+27h], bx	; [di+BDS.rootdirclust]
  8258                                  		mov	bx, [si+23h]	; BPB.RootClus+2
  8259                                  		mov	[di+29h], bx	; [di+BDS.rootdirclust+2]
  8260                                  		mov	bx, [si+25h]	; BPB.FSInfo
  8261                                  		mov	[di+2Bh], bx	; [di+BDS.fsinfo]
  8262                                  		mov	bx, [si+27h]	; BPB.FSInfo+2
  8263                                  		mov	[di+2Dh], bx	; [di+BDS.fsinfo+2]
  8264                                  		jmp	short fat_32bit	; PCDOS 7.1 BUG! Erdogan Tan - 8/8/2023
  8265                                  					; correct code (would be):
  8266                                  					;   mov cl, [cs:si+05h] ; BPB_NumFATs
  8267                                  					; sub_fat32_size:
  8268                                  					;   sub ax, [cs:si+19h] ; BPB_FATSz32
  8269                                  					;   sbb dx, [cs:si+1Bh] ; BPB_FATSz32+2
  8270                                  					;   dec cl
  8271                                  					;   jg short sub_fat32_size
  8272                                  					;   jmp short fat_32bit
  8273                                  %endif
  8274                                  		; 17/12/2023
  8275                                  		; cl = BPB_NumFATs (2 or 1)
  8276                                  		; ch = 0
  8277 000023E5 8B5C19                  		mov	bx, [si+19h]	; BPB.FATSz32
  8278                                  sub_fat32_size:
  8279 000023E8 29D8                    		sub	ax, bx
  8280 000023EA 1B541B                  		sbb	dx, [si+1Bh]	; BPB.FATSz32+2
  8281                                  		;dec	cl
  8282 000023ED 49                      		dec	cx
  8283 000023EE 7FF8                    		jg	short sub_fat32_size
  8284                                  
  8285 000023F0 895D1F                  		mov	[di+1Fh], bx	; [di+BDS.fatsecs32]
  8286 000023F3 8B5C1B                  		mov	bx, [si+1Bh]	; BPB.FATSz32+2
  8287 000023F6 895D21                  		mov	[di+21h], bx	; [di+BDS.fatsecs32+2]
  8288                                  
  8289 000023F9 8B5C1D                  		mov	bx, [si+1Dh]	; BPB.BPB_ExtFlags
  8290 000023FC 895D23                  		mov	[di+23h], bx	; [di+BDS.extflags]
  8291 000023FF 8B5C1F                  		mov	bx, [si+1Fh]	; BPB.FSVer
  8292 00002402 895D25                  		mov	[di+25h], bx	; [di+BDS.fsver]
  8293 00002405 8B5C21                  		mov	bx, [si+21h]	; BPB.RootClus
  8294 00002408 895D27                  		mov	[di+27h], bx	; [di+BDS.rootdirclust]
  8295 0000240B 8B5C23                  		mov	bx, [si+23h]	; BPB.RootClus+2
  8296 0000240E 895D29                  		mov	[di+29h], bx	; [di+BDS.rootdirclust+2]
  8297 00002411 8B5C25                  		mov	bx, [si+25h]	; BPB.FSInfo
  8298 00002414 895D2B                  		mov	[di+2Bh], bx	; [di+BDS.fsinfo]
  8299 00002417 8B5C27                  		mov	bx, [si+27h]	; BPB.FSInfo+2
  8300 0000241A 895D2D                  		mov	[di+2Dh], bx	; [di+BDS.fsinfo+2]
  8301 0000241D EB08                    		jmp	short fat_32bit
  8302                                  		
  8303                                  fat_16bit:
  8304                                  		; 17/12/2023 - Retro DOS v5.0
  8305                                  		;	      (PCDOS 7.1 IBMBIO.COM)
  8306                                  		; 10/12/2022
  8307                                  		; (number of FATs optimization)
  8308                                  		; CL = number of FATs (2 or 1)
  8309                                  		; CH = 0 ; 17/12/2023 
  8310                                  		;dec	cl ; *
  8311                                  		; 18/12/2022
  8312 0000241F 49                      		dec	cx ; *
  8313 00002420 D3E3                    		shl	bx, cl
  8314                                  		;shl	bx, 1	; =*?=	; always 2 fats
  8315                                  		
  8316 00002422 29D8                    		sub	ax, bx		; sub #	fat sectors
  8317 00002424 83DA00                  		sbb	dx, 0
  8318                                  fat_32bit:	
  8319                                  		; 17/12/2023
  8320 00002427 8B5C06                  		mov	bx, [si+6] ; 12/08/2023
  8321                                  		;mov	bx, [cs:si+6]	; [cs:si+EBPB.ROOTENTRIES]
  8322                                  					; # root entries
  8323 0000242A 895D0C                  		mov	[di+0Ch], bx	; [di+BDS.direntries]
  8324                                  					; set in bds bpb
  8325 0000242D B104                    		mov	cl, 4
  8326 0000242F D3EB                    		shr	bx, cl		; div by 16 ents/sector
  8327 00002431 29D8                    		sub	ax, bx		; sub #	dir sectors
  8328 00002433 83DA00                  		sbb	dx, 0		;
  8329                                  					; dx:ax	now contains the
  8330                                  					; # of data sectors
  8331                                  		; 17/12/2023
  8332                                  		; ch = 0
  8333                                  		;xor	cx, cx ; *
  8334 00002436 8A4C02                  		mov	cl, [si+2] ; 12/08/2023
  8335                                  		;mov	cl, [cs:si+2]	; [cs:si+EBPB.SECTORSPERCLUSTER]
  8336                                  					; sectors per cluster
  8337 00002439 884D08                  		mov	[di+8],	cl	; [di+BDS.secperclus]
  8338                                  					; set in bios bpb
  8339 0000243C 50                      		push	ax
  8340 0000243D 89D0                    		mov	ax, dx
  8341 0000243F 31D2                    		xor	dx, dx
  8342 00002441 F7F1                    		div	cx		; cx = sectors per cluster
  8343                                  		; 12/08/2023 (ds=cs)
  8344                                  		;mov	[temp_h], ax
  8345                                  		;;mov	[cs:temp_h], ax	; [temp_h]:ax now contains the
  8346                                  					; # clusters.
  8347                                  		; 17/12/2023
  8348 00002443 A3[9E04]                		mov	[saved_word], ax ; hw of cluster number
  8349 00002446 58                      		pop	ax
  8350 00002447 F7F1                    		div	cx
  8351                                  		; 17/12/2023
  8352                                  		;;cmp	word [cs:temp_h], 0
  8353                                  		;cmp	word [temp_h], 0  ; 12/08/2023
  8354                                  		;cmp	word [saved_word], 0 ; (*)
  8355                                  		;ja	short toobig_ret ; too big cluster number
  8356                                  
  8357                                  		; 17/12/2023
  8358                                  		;;;
  8359 00002449 5B                      		pop	bx ; FAT sectors (16 bit)
  8360                                  		;and	bx, bx ; 0 ?
  8361 0000244A 09DB                    		or	bx, bx ; 0 ?
  8362 0000244C 751F                    		jnz	short chk_clnum_hw
  8363                                  				 ; 16 bit fat sectors > 0 ; FAT12 or FAT16 fs
  8364                                  
  8365 0000244E 813E[9E04]FF0F          		cmp	word [saved_word], 0FFFh 
  8366 00002454 7503                    		jne	short fat32_clust_limit
  8367 00002456 83F8F6                  		cmp	ax, 0FFF6h	; FAT32 cluster number limit: 0FFFFFF6h
  8368                                  fat32_clust_limit:
  8369 00002459 772D                    		ja	short short toobig_ret ; too big cluster number
  8370 0000245B 391E[9E04]              		cmp	[saved_word], bx ; 0 ?
  8371                                  	 	;jnz	short fat16_clust_limit
  8372 0000245F 7505                    		jnz	short set_fbigbig_flag ; 17/12/2023
  8373                                  fat16_clust_limit:	; 17/12/2023
  8374 00002461 83F8F6                  		cmp	ax, 0FFF6h	; FAT16 cluster number limit: 0FFF6h
  8375                                  ;fat16_clust_limit:
  8376 00002464 760E                    		jna     short fat12_clust_limit ; jbe
  8377                                  set_fbigbig_flag:	; 17/12/2023
  8378 00002466 800E[FC19]20            		or	byte [fbigfat], 20h ; fbigbig ; FAT32 fs
  8379 0000246B EB11                    		jmp	short copymediaid
  8380                                  chk_clnum_hw:
  8381 0000246D 833E[9E04]00            		cmp	word [saved_word], 0 ; (*)
  8382 00002472 7714                    		ja	short toobig_ret ; too big cluster number
  8383                                  		;;;
  8384                                  fat12_clust_limit:
  8385 00002474 3DF60F                  		cmp	ax, 0FF6h	; 4096-10
  8386                                  					; is this 16-bit fat?
  8387 00002477 7205                    		jb	short copymediaid ; no,	small fat
  8388                                  		; 17/10/2022
  8389 00002479 800E[FC19]40            		or	byte [fbigfat], 40h ; fbig ; FAT16 fs
  8390                                  		;or	ds:fbigfat, 40h	; fbig
  8391                                  					; 16 bit fat
  8392                                  copymediaid:
  8393                                  		; 17/12/2023
  8394                                  		; es = ds = cs
  8395                                  		
  8396                                  		;push	es
  8397                                  		;push	ds
  8398                                  		;pop	es
  8399                                  		
  8400                                  		; 12/08/2023
  8401                                  		; ds = cs = BIOSDATA
  8402                                  		;push	cs
  8403                                  		;pop	ds
  8404                                  		; 17/10/2022
  8405 0000247E BD[5108]                		mov	bp, MOVMEDIAIDS
  8406                                  		;mov	bp, 865h	; (PCDOS 7.1 IBMBIO.COM)
  8407                                  		;;mov	bp, 751h	; mov_media_ids
  8408                                  					; at 2C7h:751h = 70h:2CC1h
  8409                                  					; copy filesys_id, volume label
  8410 00002481 0E                      		push	cs		; simulate far call
  8411 00002482 E8DEF5                  		call	call_bios_code
  8412                                  
  8413                                  		; 12/08/2023
  8414                                  		;push	es
  8415                                  		;pop	ds
  8416                                  		; 17/12/2023	
  8417                                  		;pop	es
  8418                                  
  8419 00002485 E9CD00                  		jmp	massage_bpb	; now final check for bpb info
  8420                                  					; and return.
  8421                                  ; ---------------------------------------------------------------------------
  8422                                  
  8423                                  toobig_ret:
  8424                                  		; 12/08/2023 (ds=cs=BIOSDATA)
  8425 00002488 800E[FC19]80            		or	byte [fbigfat], 80h ; ftoobig
  8426                                  		;or	byte [cs:fbigfat], 80h ; ftoobig 
  8427                                  					; too big (32 bit clust #) for FAT16
  8428 0000248D E9E300                  		jmp	goodret		; still	drive letter is	assigned
  8429                                  					; but useless. to big for
  8430                                  					; current pc dos fat file system
  8431                                  ; ---------------------------------------------------------------------------
  8432                                  
  8433                                  unknown:
  8434                                  		; 17/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  8435 00002490 804D4002                		or	byte [di+40h], 2 ; [di+BDS.flags+1]
  8436                                  					 ; unformatted_media
  8437                                  		; 12/12/2022
  8438                                  		;or	byte [di+24h], 02h
  8439                                  		;;or	word [di+23h], 200h ; [di+BDS.flags]
  8440                                  					; unformatted_media
  8441                                  					; Set unformatted media	flag.
  8442                                  
  8443                                  ; the boot signature may not be	recognizable,
  8444                                  ; but we should	try and	read it	anyway.
  8445                                  
  8446                                  unknown3_0:
  8447 00002494 8B551D                  		mov	dx, [di+1Dh]	; skip setting unformatted_media bit
  8448                                  					; [di+BDS.totalsecs32+2]
  8449 00002497 8B451B                  		mov	ax, [di+1Bh]	; [di+BDS.totalsecs32]
  8450 0000249A BE[081A]                		mov	si, disktable2
  8451                                  scan:					; 08/08/2023
  8452                                  		;cmp	dx, [cs:si]	; total sectors hw
  8453                                  		; 12/08/2023 (ds=cs)
  8454 0000249D 3B14                    		cmp	dx, [si] 
  8455 0000249F 720C                     		jb	short gotparm
  8456 000024A1 7705                    		ja	short scan_next
  8457                                  		;cmp	ax, [cs:si+2]	; total sectors lw
  8458 000024A3 3B4402                  		cmp	ax, [si+2]
  8459 000024A6 7605                    		jbe	short gotparm
  8460                                  scan_next:				
  8461 000024A8 83C60A                  		add	si, 10		; 5*2
  8462 000024AB EBF0                    		jmp	short scan	; covers upto 512 mb media
  8463                                  ; ---------------------------------------------------------------------------
  8464                                  
  8465                                  gotparm:
  8466 000024AD 8A4C08                  		mov	cl, [si+8]	; fat size for fbigfat flag
  8467                                  		;or	ds:fbigfat, cl
  8468                                  		; 17/10/2022
  8469 000024B0 080E[FC19]              		or	[fbigfat], cl	; (fbig flag, 40h or 0) ; 08/08/2023
  8470                                  		; 12/08/2023
  8471                                  		; ds = cs = BIOSDATA
  8472 000024B4 8B4C04                  		mov	cx, [si+4]
  8473                                  		;mov	cx, [cs:si+4]	; ch = number of sectors per cluster
  8474                                  					; cl = log base 2 of ch
  8475 000024B7 8B5406                  		mov	dx, [si+6]
  8476                                  		;mov	dx, [cs:si+6]	; dx = number of root dir entries
  8477                                  
  8478                                  ; now calculate size of fat table
  8479                                  
  8480 000024BA 89550C                  		mov	[di+0Ch], dx	; [di+BDS.direntries]
  8481                                  					; save number of (root)	dir entries
  8482 000024BD 8B551D                  		mov	dx, [di+1Dh]	; [di+BDS.totalsecs32+2]
  8483 000024C0 8B451B                  		mov	ax, [di+1Bh]	; [di+BDS.totalsecs32]
  8484 000024C3 886D08                  		mov	[di+8],	ch	; [di+BDS.secperclus]
  8485                                  					; save sectors per cluster
  8486                                  		
  8487                                  		; 17/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  8488 000024C6 F606[FC19]60            		test	byte [fbigfat], 60h ; fbig+fbigbig ; FAT16 or FAT32
  8489                                  		; 11/09/2023
  8490                                  		; 17/10/2022
  8491                                  		;test	byte [fbigfat], 40h
  8492                                  		;;test	ds:fbigfat, 40h	; fbig
  8493                                  					; if (fbigfat)
  8494 000024CB 751E                    		jnz	short dobig	; goto dobig; (16 bit fat)
  8495                                  
  8496                                  ; we don't need to change "small fat" logic since it is guaranteed
  8497                                  ; that double word total sector will not use 12 bit fat (unless
  8498                                  ; it's sectors/cluster >= 16 which will never be in this case.)
  8499                                  ; so in this case we assume dx = 0 !!
  8500                                  
  8501 000024CD 31DB                    		xor	bx, bx		; 12 bit fat (FAT12 fs)
  8502 000024CF 88EB                    		mov	bl, ch
  8503 000024D1 4B                      		dec	bx
  8504 000024D2 01C3                    		add	bx, ax		; dx=0
  8505 000024D4 D3EB                    		shr	bx, cl		; bx = 1+(bpb->maxsec+BDS.secperclus-1)/
  8506 000024D6 43                      		inc	bx		; BDS.secperclus
  8507 000024D7 80E3FE                  		and	bl, 0FEh	; bx &= ~1; (=number of clusters)
  8508 000024DA 89DE                    		mov	si, bx
  8509 000024DC D1EB                    		shr	bx, 1
  8510 000024DE 01F3                    		add	bx, si		; number of FAT bytes ; 08/08/2023
  8511 000024E0 81C3FF01                		add	bx, 511		; bx +=	511 + bx/2
  8512 000024E4 D0EF                    		shr	bh, 1		; bh >>= 1; (=bx/512)
  8513 000024E6 887D11                  		mov	[di+11h], bh	; [di+BDS.fatsecs]
  8514                                  					; save number of fat sectors
  8515 000024E9 EB6A                    		jmp	short massage_bpb
  8516                                  ; ---------------------------------------------------------------------------
  8517                                  
  8518                                  ; for bigfat we do need to extend this logic to 32 bit sector calculation.
  8519                                  
  8520                                  dobig:					
  8521 000024EB B104                    		mov	cl, 4		; 16 (2^4) directory entries per sector
  8522 000024ED 52                      		push	dx		; save total sectors (high)
  8523 000024EE 8B550C                  		mov	dx, [di+0Ch]	; [di+BDS.direntries]
  8524 000024F1 D3EA                    		shr	dx, cl		; root dir sectors = BDS.direntries / 16;
  8525 000024F3 29D0                    		sub	ax, dx
  8526 000024F5 5A                      		pop	dx
  8527 000024F6 83DA00                  		sbb	dx, 0		; dx:ax	= total	sectors	- root dir sectors
  8528 000024F9 83E801                  		sub	ax, 1
  8529 000024FC 83DA00                  		sbb	dx, 0		; dx:ax	= t - r	- d
  8530                                  					; total	secs - reserved	secs - root dir	secs
  8531 000024FF B302                    		mov	bl, 2
  8532 00002501 8A7D08                  		mov	bh, [di+8]	; [di+BDS.secperclus]
  8533                                  					; bx = 256 * BDS.secperclus + 2
  8534                                  
  8535                                  ; I don't understand why to add bx here!!!
  8536                                  
  8537                                  		; 29/12/2018 - Erdogan Tan (Retro DOS v4.0)
  8538                                  		; 27/09/2022
  8539                                  		; (Microsoft FAT32 File	System Specification,
  8540                                  		; December 2000, Page 21)
  8541                                  		; TmpVal1 = DskSize - (BPB_ResvdSecCnt+RootrDirSectors)
  8542                                  		; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs
  8543                                  		; 8/8/2023 (Retro DOS v5.0)
  8544                                  		; If(FATType == FAT32)
  8545                                  		;   TmpVal2 = TmpVal2 / 2;
  8546                                  		; FATsz	= (TmpVal1+(TmpVal2-1))/TmpVal2
  8547                                  		; 8/8/2023 (Retro DOS v5.0)
  8548                                  		; If(FATType == FAT32) {
  8549                                  		;   BPB_FATSz16 = 0;
  8550                                  		;   BPB_FATSz32 = FATSz;
  8551                                  		;} else {
  8552                                  		;   BPB_FATSz16 = LOWORD(FATSz);
  8553                                  		;/* there is no BPB_FATSz32 in a FAT16 BPB */
  8554                                  		;}
  8555                                  					; dx:ax = TmpVal1, bx = TmpVal2
  8556 00002504 01D8                    		add	ax, bx		; 
  8557 00002506 83D200                  		adc	dx, 0		; dx:ax = TmpVal1+TmpVal2
  8558 00002509 83E801                  		sub	ax, 1		
  8559 0000250C 83DA00                  		sbb	dx, 0		; dx:ax = TmpVal1+TmpVal2-1
  8560                                  
  8561                                  		;;;
  8562                                  		; 17/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  8563 0000250F F606[FC19]20            		test	byte [fbigfat], 20h ; fbigbig (FAT32) flag
  8564 00002514 740D                    		jz      short dobig1
  8565                                  
  8566 00002516 D1EB                    		shr	bx, 1           ; TmpVal2 = TmpVal2 / 2
  8567                                  					; dx:ax = TmpVal1+(2*TmpVal2)-1
  8568 00002518 83E81F                  		sub	ax, 31          ; reserved sectors = 32 (for FAT32 fs) /// 1+31 = 32
  8569 0000251B 83DA00                  		sbb	dx, 0
  8570 0000251E 29D8                    		sub	ax, bx
  8571 00002520 83DA00                  		sbb	dx, 0           ; dx:ax = TmpVal1+(2*TmpVal2)-TmpVal2-1
  8572                                  					;       = TmpVal1+(TmpVal2-1)
  8573                                  dobig1:
  8574 00002523 50                      		push	ax		; save lw of dividend
  8575 00002524 89D0                    		mov	ax, dx		; divide hw of dx:ax at first (as 1st stage)
  8576 00002526 31D2                    		xor	dx, dx
  8577 00002528 F7F3                    		div	bx		; 32 bit division, dx:ax/bx
  8578                                  					; remainder in dx is hw of 2nd stage dividend
  8579 0000252A 89C5                    		mov	bp, ax		; hw of quotient
  8580 0000252C 58                      		pop	ax		; restore lw of dividend (of 1st stage)
  8581                                  		;;;
  8582                                  
  8583                                  ; assuming dx in the table will never be bigger than bx.
  8584                                  
  8585 0000252D F7F3                    		div	bx		; BDS.fatsecs =
  8586                                  					; ceil((total-dir-res)/(256*BDS.secperclus+2))
  8587 0000252F 894511                  		mov	[di+11h], ax	; [di+BDS.fatsecs]
  8588                                  					; number of fat	sectors
  8589                                  		;;;
  8590                                  		
  8591                                  		; 18/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  8592 00002532 8A1E[FC19]              		mov	bl, [fbigfat]
  8593 00002536 885D3B                  		mov	[di+3Bh], bl	; [di+BDS.fatsiz] ; fat size flag
  8594                                  		
  8595 00002539 F6C320                  		test	bl, 20h		; fbigbig (FAT32) flag
  8596 0000253C 7410                    		jz	short dobig2	; not FAT32
  8597                                  
  8598 0000253E 89451F                  		mov	[di+1Fh], ax	; [di+BDS.fatsecs32]
  8599 00002541 896D21                  		mov	[di+21h], bp	; [di+BDS.fatsecs32+2]
  8600 00002544 C745110000              		mov	word [di+11h], 0 ; [di+BDS.fatsecs] = 0
  8601                                  					; clear 16 bit FAT size field
  8602 00002549 C745092000              		mov	word [di+9], 32	; [di+BDS.resectors]
  8603                                  					; set reserved sectors to 32 (FAT32 de facto)
  8604                                  dobig2:
  8605                                  		;;;
  8606                                  
  8607                                  ; now, set the default filesys_id, volume label, serial number
  8608                                  
  8609                                  		; 05/08/2023
  8610                                  		; [di+1Fh] = [fbigfat]
  8611                                  		;
  8612                                  		;;mov	bl, ds:fbigfat
  8613                                  		;; 17/10/2022
  8614                                  		;mov	bl, [fbigfat]
  8615                                  		;mov	[di+1Fh], bl	; [di+BDS.fatsiz] ; fat	size flag
  8616                                  
  8617                                  		; 12/08/2023
  8618                                  		;push	ds ; ds = cs = BIOSDATA
  8619                                  		
  8620                                  		; 17/12/2023
  8621                                  		; es = ds = cs
  8622                                  		;push	ds
  8623                                  		;pop	es
  8624                                  
  8625                                  		; 12/08/2023 
  8626                                  		; ds = cs = BIOSDATA
  8627                                  		;push	cs
  8628                                  		;pop	ds
  8629                                  
  8630                                  		; 18/12/2023 - Retro DOS v5.0
  8631                                  		; bl = [fbigfat] (clear_ids_x uses bl value here)
  8632                                  		; 11/09/2023
  8633                                  		;mov	al, [fbigfat]
  8634 0000254E BD[A106]                		mov	bp, CLEARIDS_X	; clear_ids_x (uses AL value here)
  8635                                  		; 17/10/2022
  8636                                  		;mov	bp, CLEARIDS
  8637                                  		;;mov	bp, 5D9h	; clear_ids
  8638                                  					; at 2C7h:5D9h = 70h:2B49h
  8639                                  					; at BIOSCODE:06ABh
  8640                                  					;	in PCDOS 7.1 IBMBIO.COM
  8641 00002551 0E                      		push	cs
  8642 00002552 E80EF5                  		call	call_bios_code
  8643                                  
  8644                                  		; 12/08/2023
  8645                                  		;pop	ds ; ds = cs = BIOSDATA
  8646                                  
  8647                                  ; at this point, in bpb of bds table, BDS_BPB.BPB_BIGTOTALSECTORS which is
  8648                                  ; set according to the partition information. we are going to
  8649                                  ; see if (hidden sectors + total sectors) > a word. if it is true,
  8650                                  ; then no change. otherwise, BDS_BPB.BPB_BIGTOTALSECTORS will be moved
  8651                                  ; to BDS_BPB.BPB_TOTALSECTORS and BDS_BPB.BPB_BIGTOTALSECTORS will be set to 0.
  8652                                  ; we don't do this for the bpb information from the boot record. we
  8653                                  ; are not going to change the bpb information from the boot record.
  8654                                  
  8655                                  massage_bpb:
  8656                                  		; 05/08/2023
  8657                                  		; [di+1Fh] = [fbigfat]
  8658                                  		;
  8659                                  		;; 12/12/2022
  8660                                  		;mov	bl, [fbigfat]
  8661                                  		;mov	[di+1Fh], bl	; [di+BDS.fatsiz]
  8662                                  		;			; set size of fat on media
  8663                                  		;
  8664 00002555 8B551D                  		mov	dx, [di+1Dh]	; [di+BDS.totalsecs32+2]
  8665 00002558 8B451B                  		mov	ax, [di+1Bh]	; [di+BDS.totalsecs32]
  8666                                  		; 11/09/2023
  8667 0000255B 09D2                    		or	dx, dx
  8668 0000255D 7514                    		jnz	short goodret	
  8669                                  		;cmp	dx, 0		; double word total sectors?
  8670                                  		;;ja	short goodret	; don't have to change it.
  8671                                  		;; 12/12/2022
  8672                                  		;ja	short short goodret2
  8673                                  		;cmp	word [di+19h], 0 ; [di+BDS.hiddensecs+2]
  8674                                  		;ja	short goodret	; don't have to change it.
  8675                                  		; 12/12/2022
  8676 0000255F 395519                  		cmp	[di+19h], dx ; 0
  8677                                  		;ja	short goodret2
  8678 00002562 770F                    		ja	short goodret	; 11/09/2023
  8679 00002564 034517                  		add	ax, [di+17h]	; [di+BDS.hiddensecs]
  8680                                  		;jb	short goodret
  8681                                  		; 12/12/2022
  8682                                  		;jc	short goodret
  8683 00002567 7209                    		jc	short goodret_clc ; 11/09/2023
  8684 00002569 8B451B                  		mov	ax, [di+1Bh]	; [di+BDS.totalsecs32]
  8685 0000256C 89450E                  		mov	[di+0Eh], ax	; [di+BDS.totalsecs16]
  8686                                  		;mov	word [di+1Bh], 0 ; [di+BDS.totalsecs32]
  8687                                  		; 12/12/2022
  8688 0000256F 89551B                  		mov	[di+1Bh], dx ; 0
  8689                                  goodret_clc:
  8690                                  		; 11/09/2023
  8691 00002572 F8                      		clc 
  8692                                  goodret:
  8693                                  		;mov	bl, ds:fbigfat
  8694                                  		; 11/09/2023
  8695                                  		; 12/12/2022
  8696                                  		; 17/10/2022
  8697 00002573 8A1E[FC19]              		mov	bl, [fbigfat]
  8698                                  		; 17/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  8699 00002577 885D3B                  		mov	[di+3Bh], bl	; [di+BDS.fatsiz]
  8700                                  		;mov	[di+1Fh], bl	; [di+BDS.fatsiz]
  8701                                  					; set size of fat on media
  8702                                  		; 11/09/2023
  8703                                  		;clc
  8704                                  ret_hard_err:
  8705                                  		; 12/12/2022
  8706                                  goodret2:
  8707 0000257A 07                      		pop	es
  8708                                  		;pop	ds	; ds = cs = BIOSDATA ; 14/08/2023
  8709 0000257B 5B                      		pop	bx
  8710 0000257C 5F                      		pop	di
  8711 0000257D C3                      		retn
  8712                                  
  8713                                  ; =============== S U B	R O U T	I N E =======================================
  8714                                  
  8715                                  ; 15/10/2022
  8716                                  
  8717                                  ;fdisk of pc dos 3.3 and below, os2 1.0 has a bug. the maximum number of
  8718                                  ;sector that can be handled by pc dos 3.3 ibmbio should be 0ffffh.
  8719                                  ;instead, sometimes fdisk use 10000h to calculate the maximum number.
  8720                                  ;so, we are going to check that if BPB_TOTALSECTORS + hidden sector = 10000h
  8721                                  ;then subtract 1 from BPB_TOTALSECTORS.
  8722                                  
  8723                                  		; 17/10/2022
  8724                                  cover_fdisk_bug:
  8725                                  		; 12/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  8726                                  		; ds = cs
  8727                                  
  8728                                  		; 18/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  8729                                  		; (optimization)
  8730                                  		;push	ax
  8731                                  		;push	dx
  8732                                  		;push	si
  8733                                  
  8734                                  		; 18/12/2023
  8735                                  		; bx = offset disksector
  8736                                  
  8737                                  		; 18/12/2023
  8738 0000257E 807F2629                		cmp	byte [bx+26h], 29h
  8739                                  		; 12/08/2023
  8740                                  		;cmp	byte [disksector+26h], 29h
  8741                                  		;;cmp	byte [cs:disksector+26h], 29h
  8742                                  					; [disksector+EXT_BOOT.SIG],
  8743                                  					; EXT_BOOT_SIGNATURE
  8744 00002582 7426                    		je	short cfb_retit	; if extended bpb, then	>= pc dos 4.00
  8745                                  		
  8746 00002584 817F073130              		cmp	word [bx+7], 3031h
  8747                                  		;cmp	word [cs:bx+7], 3031h ; '10' ; os2 1.0 = ibm 10.0
  8748 00002589 7506                    		jne	short cfb_chk_totalsecs ; 11/08/2023
  8749 0000258B 807F0A30                		cmp	byte [bx+10], '0'
  8750                                  		;cmp	byte [cs:bx+10], '0'
  8751 0000258F 7519                    		jne	short cfb_retit
  8752                                  
  8753                                  cfb_chk_totalsecs:
  8754                                  		; 11/08/2023
  8755                                  ; 18/12/2023
  8756                                  %if 0
  8757                                  		; 17/10/2022		
  8758                                  		mov	si, disksector+11 ; 14Eh+0Bh
  8759                                  		;mov	si, 159h	; disksector+EXT_BOOT.BPB
  8760                                  		; 12/08/2023
  8761                                  		cmp	word [si+8], 0
  8762                                  		;cmp	word [cs:si+8], 0 ; [cs:si+EBPB.TOTALSECTORS]
  8763                                  					; just to make sure.
  8764                                  		jz	short cfb_retit
  8765                                  		;mov	ax, [cs:si+8]	; [cs:si+EBPB.TOTALSECTORS]
  8766                                  		;add	ax, [cs:si+11h]	; [cs:si+EBPB.HIDDENSECTORS]
  8767                                  		; 12/08/2023
  8768                                  		mov	ax, [si+8]
  8769                                  		add	ax, [si+11h]
  8770                                  
  8771                                  		jnb	short cfb_retit
  8772                                  		jnz	short cfb_retit
  8773                                  					; if carry set and ax=0
  8774                                  		dec	word [si+8]
  8775                                  		;dec	word [cs:si+8]	; 0 -> 0FFFFh
  8776                                  					; then decrease	BPB_TOTALSECTORS by 1
  8777                                  %endif
  8778                                  		; 18/12/2023
  8779                                  		;cmp	word [bx+19], 0
  8780 00002591 8B4713                  		mov	ax, [bx+19]	; [bx+EBPB.TOTALSECTORS]
  8781 00002594 21C0                    		and	ax, ax ; 0 ?
  8782 00002596 7412                    		jz	short cfb_retit
  8783                                  
  8784                                  		;mov	ax, [bx+19]
  8785 00002598 03471C                  		add	ax, [bx+28]	; [bx+EBPB.HIDDENSECTORS]
  8786 0000259B 730D                    		jnc	short cfb_retit
  8787 0000259D 750B                    		jnz	short cfb_retit
  8788                                  		; ax = 0		; 0 -> 0FFFFh
  8789 0000259F FF4F13                  		dec	word [bx+19]	; then decrease	BPB_TOTALSECTORS by 1
  8790                                  
  8791 000025A2 836D1B01                		sub	word [di+1Bh], 1 ; [di+BDS.totalsecs32]
  8792 000025A6 835D1D00                		sbb	word [di+1Dh], 0 ; [di+BDS.totalsecs32+2]
  8793                                  cfb_retit:	
  8794                                  		; 18/12/2023
  8795                                  		;pop	si
  8796                                  		;pop	dx
  8797                                  		;pop	ax
  8798                                  		
  8799 000025AA C3                      		retn
  8800                                  
  8801                                  ; ---------------------------------------------------------------------------
  8802                                  
  8803 000025AB 0200                    word2:		dw 2
  8804 000025AD 0300                    word3:		dw 3
  8805 000025AF 0002                    word512:	dw 512
  8806                                  
  8807                                  ; =============== S U B	R O U T	I N E =======================================
  8808                                  
  8809                                  ; 15/10/2022
  8810                                  
  8811                                  ; setdrvparms sets up the recommended bpb in each bds in the system based on
  8812                                  ; the form factor. it is assumed that the bpbs for the various form factors
  8813                                  ; are present in the bpbtable. for hard files, the recommended bpb is the same
  8814                                  ; as the bpb on the drive.
  8815                                  ;
  8816                                  ; no attempt is made to preserve registers since we are going to jump to
  8817                                  ; sysinit straight after this routine.
  8818                                  
  8819                                  		; 18/12/2023 - Retro DOS v5.0 
  8820                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2A43h)
  8821                                  setdrvparms:
  8822                                  		; 12/12/2023
  8823                                  		; ds = cs
  8824 000025B1 31DB                    		xor	bx, bx
  8825                                  		; 18/10/2022
  8826 000025B3 C43E[1901]              		les	di, [start_bds] ; get first bds in list
  8827                                  _next_bds:
  8828 000025B7 06                      		push	es
  8829 000025B8 57                      		push	di
  8830                                  
  8831                                  		; 18/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  8832 000025B9 268A5D3E                		mov	bl, [es:di+3Eh]	; [es:di+BDS.formfactor]
  8833                                  		;mov	bl, [es:di+22h]	; [es:di+BDS.formfactor]
  8834                                  
  8835 000025BD 80FB05                  		cmp	bl, 5		; ffHardFile
  8836 000025C0 753A                    		jnz	short nothardff
  8837 000025C2 31D2                    		xor	dx, dx
  8838 000025C4 268B450E                		mov	ax, [es:di+0Eh]	; [es:di+BDS.totalsecs16]
  8839 000025C8 09C0                    		or	ax, ax
  8840 000025CA 7508                    		jnz	short get_ccyl
  8841 000025CC 268B551D                		mov	dx, [es:di+1Dh]	; [es:di+BDS.totalsecs32+2]
  8842 000025D0 268B451B                		mov	ax, [es:di+1Bh]	; [es:di+BDS.totalsecs32]
  8843                                  get_ccyl:
  8844 000025D4 52                      		push	dx
  8845 000025D5 50                      		push	ax
  8846 000025D6 268B4515                		mov	ax, [es:di+15h]	; [es:di+BDS.heads]
  8847 000025DA 26F76513                		mul	word [es:di+13h] ; [es:di+BDS.secpertrack]
  8848                                  					; assume sectors per cyl. < 64k.
  8849 000025DE 89C1                    		mov	cx, ax		; cx has # sectors per cylinder
  8850 000025E0 58                      		pop	ax
  8851 000025E1 5A                      		pop	dx		; dx:ax	= total	sectors
  8852 000025E2 50                      		push	ax
  8853 000025E3 89D0                    		mov	ax, dx
  8854 000025E5 31D2                    		xor	dx, dx
  8855 000025E7 F7F1                    		div	cx
  8856                                  		; 12/12/2023  ; !*!
  8857                                  		; (data segment may not be same with code segment here)
  8858                                  		;mov	[cs:temp_h], ax	; ax be	0 here.
  8859                                  		; 18/12/2023 - Retro DOS v5.0
  8860                                  		;mov	[cs:saved_word], ax
  8861 000025E9 58                      		pop	ax
  8862 000025EA F7F1                    		div	cx		; div #sec by sec/cyl to get # cyl.
  8863 000025EC 09D2                    		or	dx, dx
  8864 000025EE 7401                    		jz	short no_cyl_rnd ; came out even
  8865 000025F0 40                      		inc	ax		; round	up
  8866                                  no_cyl_rnd:
  8867                                  		; 18/12/2023 - Retro DOS v5.0
  8868 000025F1 26894541                		mov	[es:di+41h], ax	; [es:di+BDS.cylinders]
  8869                                  		;mov	[es:di+25h], ax	; [es:di+BDS.cylinders]
  8870                                  		
  8871 000025F5 06                      		push	es
  8872 000025F6 1F                      		pop	ds  ; !*! ; 12/12/2023
  8873                                  
  8874 000025F7 8D7506                  		lea	si, [di+6]	; [di+BDS.bytespersec]
  8875                                  					; ds:si	-> bpb for hard	file
  8876 000025FA EB55                    		jmp	short set_recbpb
  8877                                  ; ---------------------------------------------------------------------------
  8878                                  
  8879                                  nothardff:				
  8880 000025FC 0E                      		push	cs
  8881 000025FD 1F                      		pop	ds
  8882                                  
  8883                                  ; if fake floppy drive variable is set then we don't have to handle this bds.
  8884                                  ; we can just go and deal with the next bds at label go_to_next_bds.
  8885                                  
  8886                                  		; 10/12/2022
  8887                                  		; ds = cs
  8888                                  		; 17/10/2022 (ds=cs)
  8889 000025FE 803E[031A]01            		cmp	byte [fakefloppydrv], 1
  8890                                  		;cmp	byte [cs:fakefloppydrv], 1
  8891 00002603 7454                    		jz	short go_to_next_bds
  8892 00002605 80FB07                  		cmp	bl, 7		; ffother
  8893                                  					; special case "other" type of medium
  8894 00002608 753D                    		jnz	short not_process_other
  8895                                  process_other:
  8896 0000260A 31D2                    		xor	dx, dx
  8897                                  
  8898                                  		;mov	ax, [di+25h]	; [di+BDS.cylinders]
  8899                                  		;mul	word [di+36h]	; [di+BDS.rheads]
  8900                                  		;mul	word [di+34h]	; [di+BDS.rsecpertrack]
  8901                                  		;mov	[di+2Fh], ax	; [di+BDS.rtotalsecs16]
  8902                                  		;			; have the total number of sectors
  8903                                  		; 18/12/2023 - Retro DOS v5.0
  8904 0000260C 8B4541                  		mov	ax, [di+41h]	; [di+BDS.cylinders]
  8905 0000260F F76552                  		mul	word [di+52h]	; [di+BDS.rheads]
  8906 00002612 F76550                  		mul	word [di+50h]	; [di+BDS.rsecpertrack]
  8907 00002615 89454B                  		mov	[di+4Bh], ax	; [di+BDS.rtotalsecs16]
  8908                                  					; have the total number of sectors
  8909 00002618 48                      		dec	ax
  8910 00002619 B201                    		mov	dl, 1
  8911                                  _again:					
  8912 0000261B 3DF60F                  		cmp	ax, 0FF6h	; 4096-10
  8913 0000261E 7206                    		jb	short _@@
  8914 00002620 D1E8                    		shr	ax, 1
  8915 00002622 D0E2                    		shl	dl, 1
  8916 00002624 EBF5                    		jmp	short _again
  8917                                  ; ---------------------------------------------------------------------------
  8918                                  
  8919                                  _@@:
  8920 00002626 80FA01                  		cmp	dl, 1		; is it	a small	disk ?
  8921 00002629 7405                    		jz	short __@@	; yes, 224 root	entries	is enuf
  8922                                  
  8923                                  		; 18/12/2023 - Retro DOS v5.0
  8924 0000262B C74549F000              		mov	word [di+49h], 240 ; [di+BDS.rdirentries]
  8925                                  		;mov	word [di+2Dh], 240 ; [di+BDS.rdirentries]
  8926                                  __@@:
  8927                                  		; 18/12/2023 - Retro DOS v5.0
  8928 00002630 885545                  		mov	[di+45h], dl	; [di+BDS.rsecperclus]
  8929                                  		;mov	[di+29h], dl	; [di+BDS.rsecperclus]
  8930                                  
  8931                                  ; logic to get the sectors/fat area.
  8932                                  ; fat entry is assumed to be 1.5 bytes!!!
  8933                                  
  8934                                  		; 10/12/2022
  8935                                  		; ds = cs
  8936                                  		; 17/10/2022 (ds=cs)
  8937 00002633 F726[AD25]              		mul	word [word3]	; * 3
  8938 00002637 F736[AB25]              		div	word [word2]	; / 2
  8939 0000263B 31D2                    		xor	dx, dx
  8940 0000263D F736[AF25]              		div	word [word512]	; / 512
  8941                                  		;
  8942                                  		; 10/12/2022
  8943                                  		;mul	word [cs:word3]	; * 3
  8944                                  		;div	word [cs:word2]	; / 2
  8945                                  		;xor	dx, dx
  8946                                  		;div	word [cs:word512] ; / 512
  8947                                  		;
  8948 00002641 40                      		inc	ax		; + 1
  8949                                  no_round_up:
  8950                                  		; 18/12/2023 - Retro DOS v5.0
  8951 00002642 89454E                  		mov	[di+4Eh], ax	; [di+BDS.rfatsecs]
  8952                                  		;mov	[di+32h], ax	; [di+BDS.rfatsecs]
  8953                                  
  8954 00002645 EB12                    		jmp	short go_to_next_bds
  8955                                  ; ---------------------------------------------------------------------------
  8956                                  
  8957                                  not_process_other:
  8958 00002647 D1E3                    		shl	bx, 1		; bx is	word index into	table of bpbs
  8959                                  		
  8960                                  		;mov	si, bpbtable
  8961                                  		;mov	si, [bpbtable+bx] ; 15/10/2022
  8962                                  		; 09/12/2022
  8963                                  		;mov	si, BPBTABLE
  8964                                  		;mov	si, [bx+si]	; get address of bpb
  8965                                  		; 10/12/2022
  8966                                  		;mov	si, [BPBTABLE+bx]
  8967                                  		; 13/12/2022
  8968                                  		;mov	si, [SYSINITOFFSET+bpbtable+bx] ; wrong ! 14/08/2023
  8969                                  		
  8970                                  		; 14/08/2023
  8971                                  		SYSINIT_OFFSET equ (SYSINITSEG-DOSBIODATASEG<<4)
  8972                                  							; correct offset
  8973 00002649 8BB7[4690]              		mov	si, [bx+SYSINIT_OFFSET+bpbtable]
  8974                                  		
  8975                                  		; 18/12/2023 
  8976                                  		; si = address of the requested disk(ette) parameter block
  8977                                  		;	! as offset from SYSINIT segment !
  8978                                  
  8979                                  		; 28/08/2023
  8980 0000264D 81C67046                		add	si, SYSINIT_OFFSET
  8981                                  			; + displacement from BIOSDATA segment ; 18/12/2023
  8982                                  set_recbpb:
  8983                                  		; 18/12/2023
  8984                                  		;lea	di, [di+27h]	; [di+BDS.R_BPB]
  8985                                  		;			; es:di	-> recbpb
  8986                                  		;mov	cx, 25		; bpbx.size
  8987                                  		;rep movsb		; move (size bpbx) bytes
  8988                                  		
  8989                                  		; 18/12/2023 - Retro DOS v5.0
  8990 00002651 8D7D43                  		lea	di, [di+43h]	; [di+BDS.R_BPB]
  8991                                  					; es:di	-> recbpb
  8992 00002654 B93500                  		mov	cx, 53		; bpbx.size
  8993 00002657 F3A4                    		rep movsb		; move (size bpbx) byte
  8994                                  go_to_next_bds:
  8995 00002659 5F                      		pop	di
  8996 0000265A 07                      		pop	es		; restore pointer to bds
  8997 0000265B 26C43D                  		les	di, [es:di]	; [es:di+BDS.link]
  8998 0000265E 83FFFF                  		cmp	di, 0FFFFh	; -1
  8999 00002661 740A                    		jz	short got_end_of_bds_chain
  9000 00002663 E951FF                  		jmp	_next_bds
  9001                                  
  9002                                  ; ---------------------------------------------------------------------------
  9003                                  
  9004                                  		; 18/12/2022
  9005                                  ;got_end_of_bds_chain:
  9006                                  		;retn
  9007                                  
  9008                                  ; =============== S U B	R O U T	I N E =======================================
  9009                                  
  9010                                  ; 15/10/2022
  9011                                  ; 30/12/2018 - Retro DOS v4.0
  9012                                  
  9013                                  ; al = device number
  9014                                  
  9015                                  print_init:	
  9016 00002666 98                      		cbw
  9017 00002667 89C2                    		mov	dx, ax
  9018 00002669 B401                    		mov	ah, 1
  9019 0000266B CD17                    		int	17h		; PRINTER - INITIALIZE
  9020                                  					; DX = printer port (0-3)
  9021                                  					; Return: AH = status
  9022                                  got_end_of_bds_chain:	; 18/12/2022
  9023 0000266D C3                      		retn
  9024                                  
  9025                                  ; =============== S U B	R O U T	I N E =======================================
  9026                                  
  9027                                  ; al = device number
  9028                                  
  9029                                  aux_init:
  9030 0000266E 98                      		cbw
  9031 0000266F 89C2                    		mov	dx, ax
  9032                                  		;mov	al, 0A3h	; RSINIT ; 0A3h
  9033                                  					; 2400,n,1,8 (msequ.inc)
  9034                                  		;mov	ah, 0
  9035                                  		; 10/12/2022
  9036 00002671 B8A300                  		mov	ax, 00A3h
  9037 00002674 CD14                    		int	14h		; SERIAL I/O - INITIALIZE USART
  9038                                  					; 	AL = initializing parameters,
  9039                                  					;	DX = port number (0-3)
  9040                                  					; Return: AH = RS-232 status code bits,
  9041                                  					;	  AL = modem status bits
  9042 00002676 C3                      		retn
  9043                                  
  9044                                  ; =============== S U B	R O U T	I N E =======================================
  9045                                  
  9046                                  ; 18/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
  9047                                  ; 08/08/2023 - Retro DOS v4.2 (Modified MSDOS 6.22 IO.SYS)
  9048                                  ; 15/10/2022 (Modified MSDOS 5.0 IO.SYS) -Retro DOS v4 2022- (MSDOS 5.0-6.21)
  9049                                  ; 30/12/2018 - Retro DOS v4.0
  9050                                  ; 03/06/2018 - Retro DOS v3.0
  9051                                  ; (19/03/2018 - Retro DOS v2.0)
  9052                                  
  9053                                  ; domini **********************************************************************
  9054                                  ;
  9055                                  ;mini disk initialization routine. called right after dohard
  9056                                  ;modified for >2 hardfile support
  9057                                  ;
  9058                                  ; **cs=ds=es=datagrp
  9059                                  ;
  9060                                  ; **domini will search for every extended partition in the system, and
  9061                                  ;   initialize it.
  9062                                  ;
  9063                                  ; **bdsm stands for bds table for mini disk and located right after the label
  9064                                  ;   end96tpi. end_of_bdsm will have the offset value of the ending
  9065                                  ;   address of bdsm table.
  9066                                  ;
  9067                                  ; **bdsm is the same as usual bds structure except that tim_lo, tim_hi entries
  9068                                  ;   are overlapped and used to identify mini disk and the number of hidden_trks.
  9069                                  ;   right now, they are called as ismini, hidden_trks respectively.
  9070                                  ;
  9071                                  ; **domini will use the same routine in sethard routine after label set2 to
  9072                                  ;   save coding.
  9073                                  ;
  9074                                  ; **drvmax determined in dohard routine will be used for the next
  9075                                  ;   available logical mini disk drive number.
  9076                                  ;
  9077                                  ; input: drvmax, dskdrvs
  9078                                  ;
  9079                                  ; output: minidisk installed. bdsm table established and installed to bds.
  9080                                  ;	  end_of_bdsm - ending offset address of bdsm.
  9081                                  ;
  9082                                  ; called modules:
  9083                                  ;		  getboot
  9084                                  ;		  find_mini_partition (new), xinstall_bds (new), M038
  9085                                  ;
  9086                                  ;		  setmini (new, it will use set2 routine)
  9087                                  ;
  9088                                  ; variables used: end_of_bdsm
  9089                                  ;		  rom_minidisk_num
  9090                                  ;		  mini_hdlim, mini_seclim
  9091                                  ;		  BDS_STRUC, start_bds
  9092                                  ;
  9093                                  ;******************************************************************************
  9094                                  		; 18/12/2023 - Retro DOS v5.0 IO.SYS/IBMBIO.COM
  9095                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2B10h)
  9096                                  
  9097                                  		; 19/10/2022
  9098                                  domini:
  9099 00002677 8A36[4F1A]              		mov	dh, [hnum]	; get number of hardfiles
  9100                                  		; 10/12/2022
  9101 0000267B 20F6                    		and	dh, dh
  9102                                  		;cmp	dh, 0
  9103 0000267D 743C                    		jz	short dominiret	; no hard file?	then exit.
  9104 0000267F B280                    		mov	dl, 80h		; start	with hardfile 80h
  9105                                  domini_loop:
  9106                                  		; 18/12/2023 - Retro DOS v5.0
  9107 00002681 31C0                    		xor	ax, ax ; 0
  9108                                  		; ds = cs
  9109                                  		;mov	[cs:ep_start_sector], ax
  9110                                  		;mov	[cs:ep_start_sector+2], ax
  9111                                  		;mov	[cs:ep_hidden_secs], ax
  9112                                  		;mov	[cs:ep_hidden_secs+2], ax
  9113 00002683 A3[CF21]                		mov	[ep_start_sector], ax
  9114 00002686 A3[D121]                		mov	[ep_start_sector+2], ax
  9115 00002689 A3[D321]                		mov	[ep_hidden_secs], ax
  9116 0000268C A3[D521]                		mov	[ep_hidden_secs+2], ax
  9117                                  		;
  9118 0000268F 52                      		push	dx
  9119 00002690 8816[4E1A]              		mov	[rom_minidisk_num], dl
  9120 00002694 B408                    		mov	ah, 8
  9121 00002696 CD13                    		int	13h		; DISK - DISK -	GET CURRENT DRIVE PARAMETERS (XT,AT,XT286,CONV,PS)
  9122                                  					; DL = drive number
  9123                                  					; Return: CF set on error, AH =	status code, BL	= drive	type
  9124                                  					; DL = number of consecutive drives
  9125                                  					; DH = maximum value for head number, ES:DI -> drive parameter
  9126                                  		
  9127                                  		; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  9128                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:2B36h
  9129                                  		;inc	dh
  9130                                  		;xor	ax, ax
  9131                                  		;mov	al, dh
  9132 00002698 31C0                    		xor	ax, ax
  9133 0000269A 88F0                    		mov	al, dh	; <= 255
  9134 0000269C 40                      		inc	ax	; (0FFh -> 100h)
  9135 0000269D A3[541A]                		mov	[mini_hdlim], ax ; # of heads
  9136                                  		;and	cl, 3Fh
  9137                                  		;mov	al, cl
  9138                                  		; 08/08/2023
  9139 000026A0 88C8                    		mov	al, cl
  9140 000026A2 83E03F                  		and	ax, 3Fh
  9141 000026A5 A3[561A]                		mov	[mini_seclim], ax ; # of sectors/track
  9142                                  		
  9143                                  		; 18/12/2023
  9144                                  		;push	es ; * ; not necessary
  9145 000026A8 8A16[4E1A]              		mov	dl, [rom_minidisk_num]
  9146 000026AC E868FA                  		call	getboot		; read master boot record into
  9147                                  					; initbootsegment:bootbias
  9148 000026AF 7203                    		jc	short domininext
  9149 000026B1 E80800                  		call	find_mini_partition
  9150                                  domininext:
  9151                                  		;pop	es ; *
  9152 000026B4 5A                      		pop	dx
  9153 000026B5 FEC2                    		inc	dl		; next hard file
  9154 000026B7 FECE                    		dec	dh
  9155 000026B9 75C6                    		jnz	short domini_loop
  9156                                  dominiret:
  9157 000026BB C3                      		retn
  9158                                  
  9159                                  ; =============== S U B	R O U T	I N E =======================================
  9160                                  
  9161                                  ; 15/10/2022 (Modified MSDOS 5.0 IO.SYS)
  9162                                  ; 30/12/2018 - Retro DOS v4.0
  9163                                  
  9164                                  ;find_mini_partition tries to find every extended partition on a disk.
  9165                                  ;at entry:	di -> bdsm entry
  9166                                  ;		es:bx -> 07c0:bootbias - master boot record
  9167                                  ;		rom_minidisk_num - rom drive number
  9168                                  ;		drvmax - logical drive number
  9169                                  ;		mini_hdlim, mini_seclim
  9170                                  ;
  9171                                  ;called routine: setmini which uses set2 (in sethard routine)
  9172                                  ;variables & equates used from original bios - flags, fnon_removable, fbigfat
  9173                                  
  9174                                  
  9175                                  		; 19/12/2023 - Retro DOS v5.0 
  9176                                  		;	(Modified PCDOS 7.1 IBMBIO.COM)
  9177                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSADATA:2BFCh)
  9178                                  
  9179                                  find_mini_partition:	
  9180 000026BC 81C3C201                		add	bx, 1C2h	; bx ->	file system id
  9181                                  
  9182                                  		; 19/12/2023
  9183                                  		; PCDOS 7.1 IBMBIO.COM
  9184                                  		;mov	word [ld_p_number], 26
  9185                                  fmpnext:
  9186                                  		;add	word [ld_p_number], 16
  9187                                  		;cmp	word [ld_p_number], 4122
  9188                                  		;		; 64 logical disk partitions (64 EBRs)
  9189                                  		;		; (64*4 = 256 pte's, 256*16 = 4096, + 26 = 4122)
  9190                                  		;jg	short fmpnextfound
  9191                                  				
  9192 000026C0 26803F05                		cmp	byte [es:bx], 5 ; 05h = extended partition id.
  9193 000026C4 7410                    		je	short fmpgot ; Extended DOS CHS
  9194                                  		
  9195                                  		; 19/12/2023 - Retro DOS v5.0
  9196 000026C6 26803F0F                		cmp     byte [es:bx], 0Fh ; Extended DOS LBA
  9197 000026CA 740A                    		je	short fmpgot
  9198                                  
  9199 000026CC 83C310                  		add	bx, 16
  9200 000026CF 81FB0204                		cmp	bx, 402h	; 202h+bootbias
  9201 000026D3 75EB                    		jnz	short fmpnext
  9202                                  		;jmp	short fmpnextfound ; extended partition	not found
  9203                                  		; 18/12/2022
  9204                                  fmpnextfound:
  9205 000026D5 C3                      		retn
  9206                                  
  9207                                  ;		; 30/07/2019 - Retro DOS v3.2
  9208                                  ;		jb	short fmpnext
  9209                                  ;fmpret:
  9210                                  ;		retn	; 29/05/2019
  9211                                  
  9212                                  ; ---------------------------------------------------------------------------
  9213                                  
  9214                                  		; 19/10/2022
  9215                                  fmpgot:					; found my partition.
  9216 000026D6 E82B01                  		call	dmax_check	; check	for drvmax already 26
  9217 000026D9 73FA                    		jnb	short fmpnextfound ; done if too many
  9218                                  
  9219 000026DB 8B3E[521A]              		mov	di, [end_of_bdss] ; get next free bds
  9220                                  
  9221                                  		; 19/12/2023
  9222                                  		;mov	word [di+47h], 1 ; [di+BDS.bdsm_ismini]
  9223                                  		;; 10/12/2022
  9224                                  		;or	byte [di+23h], 1
  9225                                  		;;or	word [di+23h], 1 ; [di+BDS.flags]
  9226                                  		;			; fNon_Removable
  9227                                  		;mov	byte [di+22h], 5 ; [di+BDS.formfactor]
  9228                                  		;			; ffHardFile
  9229                                  		; 19/12/2023 - Retro DOS v5.0
  9230 000026DF C745790100              		mov	word [di+79h], 1 ; [di+BDS.bdsm_ismini]
  9231 000026E4 804D3F01                		or	byte [di+3Fh], 1 ; [di+BDS.flags], fNon_Removable
  9232 000026E8 C6453E05                		mov	byte [di+3Eh], 5 ; [di+BDS.formfactor], ffHardFile 
  9233                                  
  9234 000026EC C606[FC19]00            		mov	byte [fbigfat], 0 ; assume 12 bit fat.
  9235 000026F1 A1[541A]                		mov	ax, [mini_hdlim]
  9236 000026F4 894515                  		mov	[di+15h], ax	; [di+BDS.heads]
  9237 000026F7 A1[561A]                		mov	ax, [mini_seclim]
  9238 000026FA 894513                  		mov	[di+13h], ax	; [di+BDS.secpertrack]
  9239 000026FD A0[4E1A]                		mov	al, [rom_minidisk_num]
  9240 00002700 884504                  		mov	[di+4],	al	; [di+BDS.drivenum]
  9241                                  					; set physical number
  9242 00002703 A0[7500]                		mov	al, [drvmax]
  9243 00002706 884505                  		mov	[di+5],	al	; [di+BDS.drivelet]
  9244                                  					; set logical number
  9245 00002709 26837F0A00              		cmp	word [es:bx+10], 0
  9246                                  		;ja	short fmpgot_cont
  9247 0000270E 7707                    		ja	short fmpgot1	; 19/12/2023
  9248 00002710 26837F0840              		cmp	word [es:bx+8], 64 ; with current bpb,
  9249                                  					; only lower word is meaningful.
  9250 00002715 72BE                    		jb	short fmpnextfound
  9251                                  					; should be bigger than 64 sectors at least
  9252                                  fmpgot1:	; 19/12/2023
  9253                                  ;fmpgot_cont:				
  9254 00002717 83EB04                  		sub	bx, 4		; let bx point to the start of the entry
  9255 0000271A 268A7702                		mov	dh, [es:bx+2]	; cylinder
  9256 0000271E 80E6C0                  		and	dh, 0C0h	; get higher bits of cyl
  9257 00002721 D0C6                    		rol	dh, 1
  9258 00002723 D0C6                    		rol	dh, 1
  9259 00002725 268A5703                		mov	dl, [es:bx+3]	; cyl byte
  9260                                  		; 19/12/2023 - Retro DOS v5.0
  9261 00002729 89557B                  		mov	[di+7Bh], dx	; [di+BDS.bdsm_hidden_trks]
  9262                                  		;mov	[di+49h], dx	; [di+BDS.bdsm_hidden_trks]
  9263                                  					; set hidden trks
  9264                                  		; 19/12/2023
  9265                                  		;push	bx ; * ; PCDOS 7.1	
  9266                                  		;;;
  9267 0000272C 268B4F08                		mov	cx, [es:bx+8]	; partition size, lw
  9268 00002730 268B470A                		mov	ax, [es:bx+10]	; partition size, hw
  9269 00002734 030E[CF21]              		add	cx, [ep_start_sector]
  9270 00002738 1306[D121]              		adc	ax, [ep_start_sector+2]
  9271 0000273C 31D2                    		xor	dx, dx ; 19/12/2023
  9272 0000273E 3916[CF21]              		cmp	[ep_start_sector], dx ; 0
  9273                                  		;cmp	word [ep_start_sector], 0
  9274 00002742 750D                    		jnz	short fmpgot2
  9275 00002744 3916[D121]              		cmp	[ep_start_sector+2], dx ; 0
  9276                                  		;cmp	word [ep_start_sector+2], 0
  9277 00002748 7507                    		jnz	short fmpgot2
  9278 0000274A 890E[CF21]              		mov	[ep_start_sector], cx
  9279 0000274E A3[D121]                		mov	[ep_start_sector+2], ax
  9280                                  fmpgot2:
  9281 00002751 890E[D321]              		mov	[ep_hidden_secs], cx
  9282 00002755 A3[D521]                		mov	[ep_hidden_secs+2], ax
  9283                                  		
  9284                                  		; convert start sector address to CHS
  9285                                  	
  9286                                  		; 19/12/2023
  9287                                  		; dx = 0
  9288                                  		;push	bx ; * ; not necessary
  9289                                  
  9290                                  		;mov	bx, [di+13h]	; [di+BDS.secpertrack]
  9291 00002758 8B7513                  		mov	si, [di+13h]	; [di+BDS.secpertrack]
  9292                                  		;xor	dx, dx  ; dx = 0
  9293                                  		;div	bx
  9294 0000275B F7F6                    		div	si
  9295 0000275D 91                      		xchg	ax, cx
  9296                                  		;div	bx
  9297 0000275E F7F6                    		div	si
  9298 00002760 8B5D15                  		mov	bx, [di+15h]	; [di+BDS.heads]
  9299 00002763 91                      		xchg	ax, cx
  9300 00002764 31D2                    		xor	dx, dx
  9301                                  		;div	bx
  9302 00002766 F7F6                    		div	si
  9303 00002768 91                      		xchg	ax, cx
  9304                                  		;div	bx
  9305 00002769 F7F6                    		div	si
  9306                                  
  9307                                  		;pop	bx ; *
  9308                                  
  9309 0000276B 09C9                    		or	cx, cx
  9310 0000276D 7505                    		jnz	short fmpgot_lba_rd
  9311 0000276F 3D0004                  		cmp	ax, 1024	; cylinder number < 1024, CHS read is proper
  9312 00002772 7235                    		jb	short fmpgot_chs_rd
  9313                                  fmpgot_lba_rd:
  9314 00002774 804D4004                		or	byte [di+40h], 4 ; set fLBArw flag ; LBA read/write ok/ready
  9315 00002778 8A16[4E1A]              		mov	dl, [rom_minidisk_num]
  9316 0000277C 1E                      		push	ds
  9317                                  		; 19/12/2023
  9318                                  		;push	si ; ** ; not necessary 
  9319 0000277D 31C0                    		xor	ax, ax		; push bp
  9320                                  				        ; mov bp, sp ; (*)
  9321 0000277F 50                      		push	ax ; 0
  9322 00002780 50                      		push	ax ; 0
  9323 00002781 FF36[D521]              		push	word [ep_hidden_secs+2]
  9324 00002785 FF36[D321]              		push	word [ep_hidden_secs]
  9325 00002789 B80002                  		mov	ax, bootbias ; 200h	
  9326                                  		;mov	ax, 200h	; bootbias (buffer offset)
  9327 0000278C 06                      		push	es		; buffer segment
  9328 0000278D 50                      		push	ax
  9329 0000278E B80100                  		mov	ax, 1
  9330 00002791 50                      		push	ax		; read count
  9331 00002792 B81000                  		mov	ax, 10h		; DAP size = 16
  9332 00002795 50                      		push	ax
  9333 00002796 8CD0                    		mov	ax, ss
  9334 00002798 8ED8                    		mov	ds, ax
  9335 0000279A 89E6                    		mov	si, sp		; ds:si = Disk Address Packet
  9336                                  		
  9337 0000279C B442                    		mov	ah, 42h		; LBA read
  9338 0000279E CD13                    		int	13h		; DISK - IBM/MS Extension
  9339                                  					; EXTENDED READ (DL - drive, DS:SI - disk address packet)
  9340                                  		; 19/12/2023	
  9341                                  		;pushf		; PCDOS 7.1 IBMBIO.COM BUG! Erdogan Tan - 08/08/2023
  9342                                  		;add	sp, 16
  9343                                  		;popf		; BUG!
  9344                                  					; mov sp, bp ; (*)
  9345                                  					; pop bp
  9346                                  		; 19/12/2023
  9347 000027A0 9F                      		lahf		; load status flags into AH
  9348 000027A1 83C410                  		add	sp, 16
  9349 000027A4 9E                      		sahf		; store AH into flags
  9350                                  		
  9351                                  		;pop	si ; ** ; 19/12/2023
  9352 000027A5 1F                      		pop	ds
  9353 000027A6 7317                    		jnc	short fmpgot3
  9354                                  fmpnotfound:	; 19/12/2023
  9355 000027A8 C3                      		retn
  9356                                  		;jmp	short fmpgot3 
  9357                                  		;;;
  9358                                  
  9359                                  		; 19/12/2023
  9360                                  fmpgot_chs_rd:
  9361 000027A9 268B4F02                		mov	cx, [es:bx+2]	; cylinder,cylinder/sector
  9362 000027AD 268A7701                		mov	dh, [es:bx+1]	; head
  9363 000027B1 8A16[4E1A]              		mov	dl, [rom_minidisk_num]
  9364 000027B5 BB0002                  		mov	bx, 200h	; bootbias
  9365 000027B8 B80102                  		mov	ax, 201h
  9366 000027BB CD13                    		int	13h		; DISK - READ SECTORS INTO MEMORY
  9367                                  					; AL = number of sectors to read, CH = track, CL = sector
  9368                                  					; DH = head, DL	= drive, ES:BX -> buffer to fill
  9369                                  					; Return: CF set on error, AH =	status,	AL = number of sectors read
  9370                                  ;fmpgot3:	; 19/12/2023
  9371                                  		;jc	short fmpnextfound
  9372 000027BD 72E9                    		jc	short fmpnotfound
  9373                                  fmpgot3:	
  9374 000027BF BBC203                  		mov	bx, 3C2h	; 1C2h+bootbias
  9375                                  
  9376                                  		; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  9377                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:2C7Ch
  9378 000027C2 26817F3C55AA            		cmp	word [es:bx+3Ch], 0AA55h ; 03C2h+03Ch = 3FEh
  9379                                  		;jne	short fmpnextfound ; not a valid boot sector !
  9380                                  		; 19/12/2023
  9381 000027C8 75DE                    		jne	short fmpnotfound ; not a valid boot sector !
  9382                                  
  9383                                  		; 13/08/2023
  9384                                  		;push	es
  9385 000027CA E80800                  		call	setmini		; install a mini disk.
  9386                                  					; bx value saved.
  9387                                  		;pop	es  ; 13/08/2023
  9388 000027CD 7203                    		jc	short fmpnextchain
  9389 000027CF E84700                  		call	xinstall_bds	; -- install the bdsm into table
  9390                                  fmpnextchain:
  9391 000027D2 E9EBFE                  		jmp	fmpnext		; let's find out
  9392                                  					; if we	have any chained partition
  9393                                  ; ---------------------------------------------------------------------------
  9394                                  
  9395                                  		; 18/12/2022
  9396                                  ;fmpnextfound:
  9397                                  		;retn
  9398                                  
  9399                                  ; =============== S U B	R O U T	I N E =======================================
  9400                                  
  9401                                  ; 15/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
  9402                                  ; 28/12/2018 - Retro DOS v4.0 (MSDOS 6.21)
  9403                                  
  9404                                  ; 19/12/2022 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
  9405                                  ; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2C92h)
  9406                                  
  9407                                  setmini:	; 'setmini' is called from 'find_mini_partition' procedure
  9408                                  	
  9409 000027D5 57                      		push	di
  9410 000027D6 53                      		push	bx
  9411                                  		; 12/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  9412                                  		; ds = cs = BIOSDATA segment
  9413                                  		;push	ds
  9414 000027D7 06                      		push	es
  9415                                  setmini_1:
  9416                                  		;cmp	byte [es:bx], 1 ; FAT12 partition
  9417                                  		;je	short setmini_2
  9418                                  		;cmp	byte [es:bx], 4 ; FAT16 (CHS) partition
  9419                                  		;je	short setmini_2
  9420                                  		;cmp	byte [es:bx], 6 ; FAT16 BIG (CHS) partition
  9421                                  		;je	short setmini_2
  9422                                  		;
  9423                                  		; 19/12/2023 - Retro DOS v5.0
  9424                                  		;cmp	byte [es:bx], 0Bh ; FAT32 (CHS) partition
  9425                                  		;je	short setmini_2
  9426                                  		;cmp	byte [es:bx], 0Ch ; FAT32 (LBA) partition
  9427                                  		;je	short setmini_2
  9428                                  		;cmp	byte [es:bx], 0Eh ; FAT16 (LBA) partition
  9429                                  		;je	short setmini_2
  9430                                  
  9431                                  		; 19/12/2023
  9432 000027D8 268A07                  		mov 	al, [es:bx]
  9433 000027DB 3C01                    		cmp	al, 1 		; FAT12 partition
  9434 000027DD 7422                    		je	short setmini_2
  9435 000027DF 3C04                    		cmp	al, 4 		; FAT16 (CHS) partition
  9436 000027E1 741E                    		je	short setmini_2
  9437 000027E3 3C06                    		cmp	al, 6 		; FAT16 BIG (CHS) partition
  9438 000027E5 741A                    		je	short setmini_2
  9439 000027E7 3C0B                    		cmp	al, 0Bh 	; FAT32 (CHS) partition
  9440 000027E9 7416                    		je	short setmini_2
  9441 000027EB 3C0C                    		cmp	al, 0Ch 	; FAT32 (LBA) partition
  9442 000027ED 7412                    		je	short setmini_2
  9443 000027EF 3C0E                    		cmp	al, 0Eh 	; FAT16 (LBA) partition
  9444 000027F1 740E                    		je	short setmini_2
  9445                                  
  9446 000027F3 83C310                  		add	bx, 16
  9447 000027F6 81FB0204                		cmp	bx, 402h	; 202h+bootbias
  9448                                  		;jne	short setmini_1
  9449 000027FA 72DC                    		jb	short setmini_1 ; 19/12/2023
  9450 000027FC F9                      		stc
  9451 000027FD 07                      		pop	es
  9452                                  		; 12/08/2023
  9453                                  		;pop	ds
  9454 000027FE 5B                      		pop	bx
  9455 000027FF 5F                      		pop	di
  9456 00002800 C3                      		retn
  9457                                  
  9458                                  ; ---------------------------------------------------------------------------
  9459                                  setmini_2:
  9460 00002801 E9D3F9                  		jmp	set2		; branch into middle of sethard
  9461                                  
  9462                                  ; =============== S U B	R O U T	I N E =======================================
  9463                                  
  9464                                  ; 30/12/2022 - Retro DOS v4.2
  9465                                  ; (SYSINITSEG is 473h for MSDOS 6.21 IO.SYS)
  9466                                  
  9467                                  ; 15/10/2022
  9468                                  ; 28/12/2018 - Retro DOS v4.0
  9469                                  ;
  9470                                  ; dmax_check -- call this when we want to install a new drive.
  9471                                  ;		it checks for drvmax < 26 to see if there is
  9472                                  ;		a drive letter left.
  9473                                  ;
  9474                                  ;	drvmax < 26 : carry SET!
  9475                                  ;	drvmax >=26 : carry RESET!, error flag set for message later
  9476                                  ;			trash ax
  9477                                  
  9478                                  		; 19/12/2023 - Retro DOS v5.0
  9479                                  dmax_check:
  9480 00002804 803E[7500]1A            		cmp	byte [drvmax], 26 ; checks for drvmax < 26
  9481 00002809 720D                    		jb	short dmax_ok	; return with carry if okay
  9482 0000280B 06                      		push	es
  9483                                  		;;mov	ax, 46Dh	; SYSINIT_SEG (SYSINIT segment)
  9484                                  		;mov	ax, 544h	; 19/12/2023 (PCDOS 7.1)
  9485 0000280C B8D704                  		mov	ax, SYSINITSEG	; 17/10/2022	
  9486 0000280F 8EC0                    		mov	es, ax
  9487                                  		; 18/10/2022
  9488 00002811 26C606[8303]01          		mov	byte [es:TOOMANYDRIVESFLAG], 1 ; 09/12/2022 
  9489                                  		;mov	byte ptr es:3FFh, 1 ; [es:toomanydrivesflag]
  9490                                  					; set message flag
  9491                                  					; [SYSINIT+toomanydrivesflag]
  9492 00002817 07                      		pop	es
  9493                                  
  9494                                  		;;push	es
  9495                                  		;;mov	ax,SYSINIT_SEG
  9496                                  		;;mov	es,ax
  9497                                  		;;mov	byte [es:toomanydrivesflag],1
  9498                                  					; set message flag
  9499                                  		;;pop	es
  9500                                  		;
  9501                                  		;mov	byte [SYSINIT+toomanydrivesflag],1
  9502                                  dmax_ok:
  9503 00002818 C3                      		retn
  9504                                  
  9505                                  ; =============== S U B	R O U T	I N E =======================================
  9506                                  
  9507                                  ; 18/10/2022
  9508                                  ; 15/10/2022
  9509                                  ; 28/12/2018 - Retro DOS v4.0
  9510                                  ;
  9511                                  ;	link next bds (at ds:di) into the chain. assume that the
  9512                                  ;	  chain is entirely within ds == datagrp. also update drvmax,
  9513                                  ;	  dskdrv_table, and end_of_bdss.	
  9514                                  
  9515                                  		; 19/12/2023 - Retro DOS v5.0
  9516                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2CE1h)
  9517                                  xinstall_bds:
  9518 00002819 56                      		push	si
  9519 0000281A 53                      		push	bx
  9520 0000281B 8B36[1901]              		mov	si, [start_bds]	; get first bds
  9521                                  xinstall_bds_1:
  9522 0000281F 833CFF                  		cmp	word [si], 0FFFFh ; is this the last one?
  9523 00002822 7404                    		jz	short xinstall_bds_2 ;	skip ahead if so
  9524                                  		;mov	si, [si+BDS.link]
  9525 00002824 8B34                    		mov	si, [si]	; chain	through	list
  9526 00002826 EBF7                    		jmp	short xinstall_bds_1
  9527                                  
  9528                                  xinstall_bds_2:
  9529                                  		;mov	[si+BDS.link], di
  9530 00002828 893C                    		mov	[si], di
  9531                                  		;mov	[si+BDS.link+2], ds
  9532 0000282A 8C5C02                  		mov	[si+2], ds
  9533                                  		;mov	word [di+BDS.link], -1
  9534 0000282D C705FFFF                		mov	word [di], 0FFFFh ; make sure it is a null ptr.
  9535                                  		;mov	[di+BDS.link+2], ds
  9536 00002831 8C5D02                  		mov	[di+2], ds ; might as well plug segment
  9537                                  		; 20/03/2019 - Retro DOS v4.0
  9538                                  		;lea	bx, [di+BDS.BPB]
  9539 00002834 8D5D06                  		lea	bx, [di+6]
  9540 00002837 8B36[501A]              		mov	si, [last_dskdrv_table]
  9541 0000283B 891C                    		mov	[si], bx
  9542 0000283D 8306[501A]02            		add	word [last_dskdrv_table], 2
  9543 00002842 FE06[7500]              		inc	byte [drvmax]
  9544                                  		;add	word [end_of_bdss], 100 ; BDS.size = 100
  9545                                  		; 19/12/2023 - Retro DOS v5.0
  9546 00002846 8106[521A]9600          		add	word [end_of_bdss], 150 ; BDS.size = 150
  9547 0000284C 5B                      		pop	bx
  9548 0000284D 5E                      		pop	si
  9549 0000284E C3                      		retn
  9550                                  
  9551                                  ; =============== S U B	R O U T	I N E =======================================
  9552                                  
  9553                                  ; 17/10/2022
  9554                                  ; 15/10/2022
  9555                                  ; 28/12/2018 - Retro DOS v4.0
  9556                                  ; 03/06/2018 - Retro DOS v3.0
  9557                                  
  9558                                  		; 19/12/2023 - Retro DOS v5.0
  9559                                  cmos_clock_read:
  9560 0000284F 50                      		push	ax
  9561 00002850 51                      		push	cx
  9562 00002851 52                      		push	dx
  9563 00002852 55                      		push	bp
  9564 00002853 31ED                    		xor	bp, bp
  9565                                  loop_clock:
  9566 00002855 31C9                    		xor	cx, cx
  9567 00002857 31D2                    		xor	dx, dx
  9568 00002859 B402                    		mov	ah, 2
  9569 0000285B CD1A                    		int	1Ah		; CLOCK	- READ REAL TIME CLOCK (AT,XT286,CONV,PS)
  9570                                  					; Return: CH = hours in	BCD
  9571                                  					; CL = minutes in BCD
  9572                                  					; DH = seconds in BCD
  9573                                  		; 19/12/2023
  9574                                  		;cmp	cx, 0
  9575 0000285D 21C9                    		and	cx, cx
  9576 0000285F 750F                    		jnz	short clock_present
  9577                                  		;cmp	dx, 0
  9578 00002861 09D2                    		or	dx, dx
  9579 00002863 750B                    		jnz	short clock_present
  9580                                  		;cmp	bp, 1		; read again after a slight delay, in case clock
  9581                                  		;je	short no_readdate ; was	at zero	setting.
  9582 00002865 21ED                    		and	bp, bp
  9583 00002867 751A                    		jnz	short no_readdate
  9584 00002869 45                      		inc	bp		; only perform delay once.
  9585                                  		;mov	cx, 4000h	; 16384
  9586                                  		; 19/12/2023
  9587 0000286A B540                    		mov	ch, 40h ; cx = 4000h ; 16384
  9588                                  delay:					
  9589 0000286C E2FE                    		loop	delay
  9590 0000286E EBE5                    		jmp	short loop_clock
  9591                                  ; ---------------------------------------------------------------------------
  9592                                  
  9593                                  clock_present:
  9594                                  		;mov	byte [cs:havecmosclock], 1 ; set the flag for cmos clock
  9595                                  		; 19/12/2023
  9596                                  		; ds = cs
  9597 00002870 C606[8C04]01            		mov	byte [havecmosclock], 1 ; set the flag for cmos clock
  9598                                  		
  9599 00002875 E81000                  		call	cmosck		; reset	cmos clock rate	that may be
  9600                                  					; possibly destroyed by	cp dos and
  9601                                  					; post routine did not restore that.
  9602 00002878 56                      		push	si
  9603 00002879 E8EFEF                  		call	read_real_date	; read real-time clock for date
  9604 0000287C FA                      		cli
  9605                                  		;mov	ds:daycnt, si	; set system date
  9606 0000287D 8936[8904]              		mov	[daycnt], si
  9607 00002881 FB                      		sti
  9608 00002882 5E                      		pop	si
  9609                                  no_readdate:
  9610 00002883 5D                      		pop	bp
  9611 00002884 5A                      		pop	dx
  9612 00002885 59                      		pop	cx
  9613 00002886 58                      		pop	ax
  9614                                  cmosck9:	; 19/12/2023
  9615 00002887 C3                      		retn
  9616                                  
  9617                                  ; ---------------------------------------------------------------------------
  9618                                  
  9619                                  ; the following code is written by jack gulley in engineering group.
  9620                                  ; cp dos (CP/DOS, OS/2) is changing cmos clock rate for its own purposes
  9621                                  ; and if the use cold boot the system to use pc dos while running cp dos,
  9622                                  ; the cmos clock rate are still slow which slow down disk operations
  9623                                  ; of pc dos which uses cmos clock. pc dos is put this code in msinit
  9624                                  ; to fix this problem at the request of cp dos.
  9625                                  ;
  9626                                  ; the program is modified to be run on msinit. equates are defined
  9627                                  ; in cmosequ.inc. this program will be called by cmos_clock_read procedure.
  9628                                  ;
  9629                                  ;  the following code cmosck is used to insure that the cmos has not
  9630                                  ;	had its rate controls left in an invalid state on older at's.
  9631                                  ;
  9632                                  ;	it checks for an at model byte "fc" with a submodel type of
  9633                                  ;	00, 01, 02, 03 or 06 and resets the periodic interrupt rate
  9634                                  ;	bits in case post has not done it. this initilization routine
  9635                                  ;	is only needed once when dos loads. it should be run as soon
  9636                                  ;	as possible to prevent slow diskette access.
  9637                                  ;
  9638                                  ;	this code exposes one to dos clearing cmos setup done by a
  9639                                  ;	resident program that hides and re-boots the system.
  9640                                  
  9641                                  cmosck:					; check and reset rtc rate bits
  9642                                  
  9643                                  ;model byte and submodel byte were already determined in msinit.
  9644                                  
  9645                                  	; 16/06/2018 - Retro DOS v3.0
  9646                                  	; 19/03/2018 (Model: 0FCh, Sub Model: 01h, REF: AMIBIOS Prog. Guide)
  9647                                  
  9648                                  	; 19/12/2023 - Retro DOS v5.0
  9649                                  	
  9650                                  		; 19/12/2023
  9651                                  		; ds = cs
  9652                                  		;push	ax ; not necessary ; 19/12/2023
  9653                                  		;
  9654 00002888 803E[AF05]FC            		cmp	byte [model_byte], 0FCh
  9655                                  		;cmp	byte [cs:model_byte], 0FCh
  9656 0000288D 75F8                    		jnz	short cmosck9	; Exit if not an AT model
  9657 0000288F 2E803E[B005]06          		cmp	byte [cs:secondary_model_byte], 6
  9658                                  		;cmp	byte [cs:secondary_model_byte], 6
  9659                                  					; Is it 06 for the industral AT ?
  9660 00002895 7407                    		jz	short cmosck4	; Go reset CMOS periodic rate if 06
  9661 00002897 803E[B005]04            		cmp	byte [secondary_model_byte], 4
  9662                                  		;cmp	byte [cs:secondary_model_byte], 4
  9663                                  					; Is it 00, 01, 02, or 03 ?
  9664 0000289C 73E9                    		jnb	short cmosck9	; EXIT if problem fixed by POST
  9665                                  					; Also,Secondary_model_byte = 0
  9666                                  					;   when AH=0C0h, int 15h failed.
  9667                                  					;	RESET THE CMOS PERIODIC RATE
  9668                                  					;  Model=FC submodel=00,01,02,03 or 06
  9669                                  cmosck4:
  9670 0000289E B08A                    		mov	al, 8Ah		; cmos_reg_a|nmi
  9671                                  					; NMI disabled on return
  9672 000028A0 B426                    		mov	ah, 26h		; 00100110b
  9673                                  					; Set divider & rate selection
  9674 000028A2 E80B00                  		call	cmos_write
  9675 000028A5 B08B                    		mov	al, 8Bh		; cmos_reg_b|nmi
  9676                                  					; NMI disabled on return
  9677 000028A7 E82000                  		call	cmos_read
  9678 000028AA 2407                    		and	al, 7		; 00000111b
  9679                                  					; clear SET,PIE,AIE,UIE,SQWE
  9680 000028AC 88C4                    		mov	ah, al
  9681 000028AE B00B                    		mov	al, 0Bh		; cmos_reg_b
  9682                                  					; NMI enabled on return
  9683                                  		; 19/12/2023
  9684                                  		;call	cmos_write
  9685                                  ;cmosck9:
  9686                                  		;pop	ax ; 19/12/2023
  9687                                  		;retn
  9688                                  
  9689                                  		; 19/12/2023
  9690                                  		;jmp	short cmos_write
  9691                                  
  9692                                  ; =============== S U B	R O U T	I N E =======================================
  9693                                  
  9694                                  ;--- cmos_write ----------------------------------------------------------------
  9695                                  ;		write byte to cmos system clock configuration table	       :
  9696                                  ;									       :
  9697                                  ; input: (al)=	cmos table address to be written to			       :
  9698                                  ;		bit    7 = 0 for nmi enabled and 1 for nmi disabled on exit    :
  9699                                  ;		bits 6-0 = address of table location to write		       :
  9700                                  ;	 (ah)=	new value to be placed in the addressed table location	       :
  9701                                  ;									       :
  9702                                  ; output:	value in (ah) placed in location (al) with nmi left disabled   :
  9703                                  ;		if bit 7 of (al) is on. during the cmos update both nmi and    :
  9704                                  ;		normal interrupts are disabled to protect cmos data integrity. :
  9705                                  ;		the cmos address register is pointed to a default value and    :
  9706                                  ;		the interrupt flag restored to the entry state on return.      :
  9707                                  ;		only the cmos location and the nmi state is changed.	       :
  9708                                  ;-------------------------------------------------------------------------------
  9709                                  
  9710                                  cmos_write:				; write (ah) to location (al)
  9711 000028B0 9C                      		pushf			;
  9712 000028B1 50                      		push	ax		; save work register values
  9713 000028B2 FA                      		cli
  9714 000028B3 50                      		push	ax		; save user nmi	state
  9715 000028B4 0C80                    		or	al, 80h		; disable nmi for us
  9716 000028B6 E670                    		out	70h, al		; CMOS Memory/RTC Index	Register:
  9717                                  					; RTC Seconds
  9718 000028B8 90                      		nop
  9719 000028B9 88E0                    		mov	al, ah
  9720 000028BB E671                    		out	71h, al		; CMOS Memory/RTC Data Register
  9721 000028BD 58                      		pop	ax		; get user nmi
  9722 000028BE 2480                    		and	al, 80h
  9723 000028C0 0C0F                    		or	al, 0Fh
  9724 000028C2 E670                    		out	70h, al		; CMOS Memory/RTC Index	Register:
  9725                                  					; RTC Seconds
  9726 000028C4 90                      		nop
  9727 000028C5 E471                    		in	al, 71h		; CMOS Memory/RTC Data Register
  9728 000028C7 58                      		pop	ax		; restore work registers
  9729                                  
  9730                                  		; 19/12/2023
  9731                                  		;push	cs		; *place code segment in stack and
  9732                                  		;call	cmos_popf	; *handle popf for b- level 80286
  9733                                  		;retn
  9734 000028C8 EB1A                    		jmp	short cmos_rw_popf
  9735                                  
  9736                                  ; =============== S U B	R O U T	I N E =======================================
  9737                                  
  9738                                  ;--- CMOS_READ -----------------------------------------------------------------
  9739                                  ;		read byte from cmos system clock configuration table	       :
  9740                                  ;									       :
  9741                                  ; input: (al)=	cmos table address to be read				       :
  9742                                  ;		bit    7 = 0 for nmi enabled and 1 for nmi disabled on exit    :
  9743                                  ;		bits 6-0 = address of table location to read		       :
  9744                                  ;									       :
  9745                                  ; output: (al)	value at location (al) moved into (al). if bit 7 of (al) was   :
  9746                                  ;		on then nmi left disabled. during the cmos read both nmi and  :
  9747                                  ;		normal interrupts are disabled to protect cmos data integrity. :
  9748                                  ;		the cmos address register is pointed to a default value and    :
  9749                                  ;		the interrupt flag restored to the entry state on return.      :
  9750                                  ;		only the (al) register and the nmi state is changed.	       :
  9751                                  ;-------------------------------------------------------------------------------
  9752                                  
  9753                                  cmos_read:				; read location (al) into (al)
  9754 000028CA 9C                      		pushf
  9755 000028CB FA                      		cli
  9756 000028CC 53                      		push	bx
  9757 000028CD 50                      		push	ax		; AL = cmos table address to be read
  9758 000028CE 0C80                    		or	al, 80h
  9759 000028D0 E670                    		out	70h, al		; CMOS Memory/RTC Index	Register:
  9760                                  					; RTC Seconds
  9761 000028D2 90                      		nop			; (undocumented delay needed)
  9762 000028D3 E471                    		in	al, 71h		; CMOS Memory/RTC Data Register
  9763 000028D5 89C3                    		mov	bx, ax
  9764 000028D7 58                      		pop	ax
  9765 000028D8 2480                    		and	al, 80h
  9766 000028DA 0C0F                    		or	al, 0Fh
  9767 000028DC E670                    		out	70h, al		; CMOS Memory/RTC Index	Register:
  9768                                  					; RTC Seconds
  9769 000028DE 90                      		nop
  9770 000028DF E471                    		in	al, 71h		; CMOS Memory/RTC Data Register
  9771 000028E1 89D8                    		mov	ax, bx
  9772 000028E3 5B                      		pop	bx
  9773                                  
  9774                                  		; 19/12/2023
  9775                                  cmos_rw_popf:
  9776 000028E4 0E                      		push	cs		; *place code segment in stack and
  9777 000028E5 E80100                  		call	cmos_popf	; *handle popf for b- level 80286
  9778 000028E8 C3                      		retn			; return with flags restored
  9779                                  
  9780                                  ; ---------------------------------------------------------------------------
  9781                                  
  9782                                  cmos_popf:				
  9783 000028E9 CF                      		iret			; popf for level b- parts
  9784                                  					; return far and restore flags
  9785                                  
  9786                                  ; 21/12/2022
  9787                                  ; ---------------------------------------------------------------------------
  9788                                  ; ---------------------------------------------------------------------------
  9789                                  %if 0
  9790                                  
  9791                                  ; ---------------------------------------------------------------------------
  9792                                  ; MSINIT.ASM (MSDOS 6.0, 1991)
  9793                                  ; ---------------------------------------------------------------------------
  9794                                  ; The following routines provide support for reading in the file MSDOS.SYS.
  9795                                  ; ---------------------------------------------------------------------------
  9796                                  
  9797                                  ; 15/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
  9798                                  ;
  9799                                  ; (For Retro DOS, 'IO.SYS' and 'MSDOS.SYS' are already loaded together
  9800                                  ;  at once -as single kernel file- by the Retro DOS boot sector code.
  9801                                  ;  So, following disk reads -MSDOS.SYS loading- is not needed!
  9802                                  ;  Only needing is to move MSDOS Kernel to it's final memory location.) 
  9803                                  
  9804                                  ; =============== S U B	R O U T	I N E =======================================
  9805                                  
  9806                                  ; GetClus, read in a cluster at a specified address
  9807                                  ;
  9808                                  ;  bx = cluster to read
  9809                                  ;  cx = sectors per cluster
  9810                                  ;  es:di = load location
  9811                                  
  9812                                  ; 17/10/2022
  9813                                  ;DISKRD equ diskrd - DOSBIOSEG_2C7h	; (8E5h for MSDOS 5.0 IO.SYS)
  9814                                  ; 09/12/2022
  9815                                  DISKRD equ diskrd
  9816                                  
  9817                                  		; 20/12/2023 - Retro DOS v5.0
  9818                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2DC4h)
  9819                                  
  9820                                  		; si:bx = (32 bit) cluster to read
  9821                                  		; cx = sectors per cluster
  9822                                  		; es:di = load location
  9823                                  
  9824                                  		; 17/10/2022
  9825                                  getclus:
  9826                                  		; 12/12/2023
  9827                                  		; ds = cs
  9828                                  		
  9829                                  		push	cx ; 1*
  9830                                  		push	di ; 2*
  9831                                  		;mov	[cs:doscnt], cx
  9832                                  		mov	[doscnt], cx ; 12/12/2023
  9833                                  
  9834                                  		; 20/12/2023
  9835                                  		;;mov	[cs:ClusterH], si ; high word of cluster number
  9836                                  		;mov	[ClusterH], si ; high word of cluster number
  9837                                  		mov	bp, si
  9838                                  
  9839                                  		mov	ax, bx
  9840                                  
  9841                                  		;dec	ax
  9842                                  		;dec	ax
  9843                                  		; 20/12/2023
  9844                                  		sub	ax, 2
  9845                                  
  9846                                  		;;sbb	[cs:ClusterH], 0
  9847                                  		;sbb	[ClusterH], 0
  9848                                  		sbb	bp, 0		
  9849                                  
  9850                                  		; 20/12/2023
  9851                                  		;;xchg	ax, [cs:ClusterH]
  9852                                  		;xchg	ax, [ClusterH]
  9853                                  		xchg	ax, bp
  9854                                  
  9855                                  		mul	cx
  9856                                  
  9857                                  		;;xchg	ax, [cs:ClusterH]
  9858                                  		;xchg	ax, [ClusterH]
  9859                                  		xchg	ax, bp ; (+)
  9860                                  		;
  9861                                  		mul	cx		;; convert to logical sector
  9862                                  					;; dx:ax = matching logical sector number
  9863                                  					;;	  starting from the data sector
  9864                                  		;;add	ax, [cs:bios_l]
  9865                                  		;;adc	dx, [cs:bios_h]	; dx:ax	= first	logical	sector to read
  9866                                  		; 12/12/2023
  9867                                  		;add	ax, [bios_l]
  9868                                  		;adc	dx, [bios_h]	; dx:ax	= first	logical	sector to read
  9869                                  
  9870                                  		; 20/12/2023
  9871                                  		;;add	dx, [cs:ClusterH]
  9872                                  		;add	ax, [cs:First_Data_Sector]
  9873                                  		;adc	dx, [cs:First_Data_Sector+2]
  9874                                  		add	dx, bp ; (+)
  9875                                  		;add	dx, [ClusterH]	; convert to logical sector
  9876                                  					; dx:ax	= matching logical sector number
  9877                                  					;	  starting from the data sector
  9878                                  		add	ax, [First_Data_Sector]
  9879                                  		adc	dx, [First_Data_Sector+2]
  9880                                  					; dx:ax = first logical sector to read
  9881                                  unpack:
  9882                                  		; 20/12/2023			
  9883                                  		push	ds ; 3* ; ds = cs ; 12/12/2023
  9884                                  		push	dx ; 4* ; * ; 12/12/2023
  9885                                  		push	ax ; 5*
  9886                                  		push	bx ; 6*
  9887                                  		push	si ; 7* ; 20/12/2023
  9888                                  
  9889                                  		;;mov	si, [cs:fatloc]
  9890                                  		;mov	si, [fatloc] ; 12/12/2023
  9891                                  		;mov	ds, si
  9892                                  		; 20/12/2023
  9893                                  		;mov	ax, [fatloc]
  9894                                  		;mov	ds, ax
  9895                                  		push	bx ; 8*
  9896                                  		push	word [fatloc] ; 9*
  9897                                  
  9898                                  		;test	byte [cs:fbigfat], 20h
  9899                                  		test	byte [fbigfat], 20h	; fbigbig FAT32 ?
  9900                                  		pop	ds ; 9* ; ds = [fatloc]
  9901                                  		jz      short not_32bit_cluster ; no
  9902                                  unpack32:
  9903                                  		;push	dx
  9904                                  		mov	dx, si
  9905                                  		;mov	si, bx
  9906                                  		pop	si ; 8* ; si = bx
  9907                                  		add	si, si
  9908                                  		adc	dx, dx
  9909                                  		add	si, si
  9910                                  		adc	dx, dx 
  9911                                  			; dx:si = 4*(si:bx) ; clust num offset from FAT entry 0
  9912                                  		call	get_fat_sector
  9913                                  		mov	si, [bx+2]	; high word of the FAT32 cluster number
  9914                                  		mov	bx, [bx]	; low word of the FAT32 cluster number
  9915                                  		;pop	dx
  9916                                  		jmp	short getcl1
  9917                                  
  9918                                  not_32bit_cluster:
  9919                                  		;mov	si, bx		; next cluster
  9920                                  		pop	si ; 8* ; si = bx
  9921                                  		test	byte [cs:fbigfat], 40h	; fbig
  9922                                  					; 16 bit fat?
  9923                                  		jnz	short unpack16	; yes
  9924                                  unpack12:
  9925                                  		shr	si, 1		; 12 bit fat. si = si/2
  9926                                  					; si = clus + clus/2
  9927                                  		add	si, bx		;
  9928                                  					; (si =	byte offset of the cluster in the FAT)
  9929                                  		;push	dx ; 12/12/2023
  9930                                  		xor	dx, dx
  9931                                  		; 12/12/2023
  9932                                  		; ds = FAT buffer segment
  9933                                  		call	get_fat_sector
  9934                                  		;pop	dx ; 12/12/2023
  9935                                  
  9936                                  		mov	ax, [bx]	; save it into ax
  9937                                  		jnz	short even_odd	; if not a splitted fat, check even-odd.
  9938                                  		; 25/06/2023
  9939                                  		;mov	al, [bx]	; splitted fat
  9940                                  		
  9941                                  		; 12/12/2023
  9942                                  		;mov	[cs:temp_cluster], al
  9943                                  		push	ax ; **	; al = low 8 bits of 12 bits cluster number
  9944                                  
  9945                                   		inc	si		; (next	byte)
  9946                                  
  9947                                  		;push	dx ; 12/12/2023
  9948                                  		xor	dx, dx
  9949                                  		call	get_fat_sector
  9950                                  		;pop	dx ; 12/12/2023
  9951                                  
  9952                                  		;mov	al, ds:0
  9953                                  		; 12/12/2023
  9954                                  		; ds = FAT buffer segment
  9955                                  		;mov	al, [0] ; 19/10/2022
  9956                                  		;mov	[cs:temp_cluster+1], al
  9957                                  		;mov	ax, [cs:temp_cluster]
  9958                                  		; 12/12/2023
  9959                                  		;mov	al, [cs:temp_cluster]
  9960                                  		pop	ax  ; ** ; al = low 8 bits of 12 bits cluster number
  9961                                  		mov	ah, [0] ; high 4 bits (bits 7 to 11) of 12 bits cluster num
  9962                                  even_odd:
  9963                                  		pop	bx		; restore old fat entry	value
  9964                                  		push	bx		; save it right	away.	
  9965                                  		shr	bx, 1		; was it even or odd?
  9966                                  		jnb	short havclus	; it was even.
  9967                                  		shr	ax, 1		; odd. massage fat value and keep
  9968                                  					; the highest 12 bits.
  9969                                  		shr	ax, 1
  9970                                  		shr	ax, 1
  9971                                  		shr	ax, 1
  9972                                  havclus:
  9973                                  		mov	bx, ax		; now bx = new fat entry.
  9974                                  		and	bx, 0FFFh	; keep low 12 bits.
  9975                                  		jmp	short unpackx
  9976                                  ; ---------------------------------------------------------------------------
  9977                                  
  9978                                  unpack16:
  9979                                  		;push	dx	; 12/12/2023
  9980                                  		xor	dx, dx ; 0
  9981                                  		shl	si, 1		; extend to 32 bit offset
  9982                                  		;adc	dx, 0
  9983                                  		; 12/12/2023
  9984                                  		rcl	dx, 1
  9985                                  
  9986                                  		; 12/12/2023
  9987                                  		; ds = FAT buffer segment
  9988                                  		call	get_fat_sector
  9989                                  		;pop	dx	; 12/12/2023
  9990                                  		mov	bx, [bx]	;
  9991                                  					; bx = new fat entry.
  9992                                  unpackx:
  9993                                  		; 20/12/2023
  9994                                  		xor	si, si		; high word of cluster number = 0
  9995                                  					; (FAT12 or FAT16)
  9996                                  getcl1:	
  9997                                  		; 20/12/2023
  9998                                  		;pop	word [cs:ClusterH]
  9999                                  		pop	dx	; 7* - cluster number hw
 10000                                  		;pop	si		; restore old bx value into si
 10001                                  		pop	ax	; 6* - cluster number lw
 10002                                  
 10003                                  		; 20/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 10004                                  		; (this is a fast kernel loading method by the MSDOS programmer)
 10005                                  		; ((consequtive clusters --> consequtive sectors))
 10006                                  
 10007                                  		sub	ax, bx	; previous - current (or current - new)	
 10008                                  		;sbb	[cs:ClusterH], si
 10009                                  		sbb	dx, si
 10010                                  		;cmp	[cs:ClusterH], -1 ; one apart? (current = previous+1)
 10011                                  		cmp	dx, -1
 10012                                  		jnz	short not_consenquental
 10013                                  		cmp	ax, -1		; 0FFFFh ; is [ClusterH]:ax = -1 ?
 10014                                  
 10015                                  not_consequental:
 10016                                  		pop	ax ; 5* 	; restore logical sector (low)
 10017                                  		pop	dx ; 4* ; * ; 12/12/2023
 10018                                  		pop	ds ; 3*
 10019                                  
 10020                                  		;; 12/12/2023
 10021                                  		;; (this is a fast kernel loading method by the MSDOS programmer)
 10022                                  		;; ((consequtive clusters --> consequtive sectors))
 10023                                  		;; ds = cs
 10024                                  		;sub	si, bx
 10025                                  		;cmp	si, -1		; one apart? (consequtive?)
 10026                                  		;			; (current = previous+1)
 10027                                  
 10028                                  		jnz	short getcl2	; no, read [doscnt] sectors 
 10029                                  
 10030                                  		;add	[cs:doscnt], cx ; (cx = sectors per cluster)
 10031                                  		add	[doscnt], cx ; 12/12/2023 ; add to read count
 10032                                  		jmp	unpack
 10033                                  ; ---------------------------------------------------------------------------
 10034                                  
 10035                                  getcl2:
 10036                                  		push	si ; 20/12/2023
 10037                                  		push	bx	
 10038                                  		; bx = low word of the new cluster number
 10039                                  		; 20/12/2023 - Retro DOS v5.0 (32 bit cluster numbers)
 10040                                  		; si = high word of the new cluster number
 10041                                  		push	dx		; sector to read (high word)
 10042                                  		push	ax		; sector to read (low word)
 10043                                  		
 10044                                  		; 12/12/2023
 10045                                  		; ds = cs
 10046                                  		;mov	ax, [cs:drvfat]	; get drive and	fat spec
 10047                                  		;mov	cx, [cs:doscnt]
 10048                                  		mov	ax, [drvfat]	; get drive and	fat spec
 10049                                  
 10050                                  		;;;
 10051                                  		; 20/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 10052                                  		;
 10053                                  		; dma and segment (64K boundary) overrun precaution
 10054                                  		; (sector count will be decreased if it is required)
 10055                                   		mov	cx, di
 10056                                  		not	cx		; cx = 65535 - cx
 10057                                  		shr	cx, 1		; cx = cx/2
 10058                                  		xor	cl, cl
 10059                                  		xchg	cl, ch		; cx = cx/256
 10060                                  		
 10061                                  		;cmp	cx, [cs:doscnt]	
 10062                                  				; if sector read count > cx, decrease it to cx
 10063                                  		cmp	cx, [doscnt]
 10064                                  		jbe	short getcl3
 10065                                  		;;;
 10066                                  		;mov	cx, [cs:doscnt]
 10067                                  		mov	cx, [doscnt]
 10068                                  getcl3:
 10069                                  		pop	dx		; sector to read for diskrd (low)
 10070                                  		;pop	word [cs:start_sec_h]
 10071                                  		; 12/12/2023
 10072                                  		pop	word [start_sec_h]
 10073                                  					; sector to read for diskrd (high)
 10074                                  		; 12/12/2023
 10075                                  		; ds = cs
 10076                                  		;push	ds
 10077                                  		;push	cs
 10078                                  		;pop	ds
 10079                                  		
 10080                                  		push	cs		; simulate far call
 10081                                  
 10082                                  		; 20/12/2023
 10083                                  		; 17/10/2022
 10084                                  		mov	bp, DISKRD	; offset diskrd
 10085                                  		;mov	bp, 0A2Bh	; 20/12/2023
 10086                                  		;	(PCDOS 7.1 IBMBIO.COM - BIOSCODE:0A2Bh ; 364h:0A2Bh)
 10087                                  		;mov	bp, 8E5h	; 17/10/2022
 10088                                  					; 2C7h:8E5h = 70h:2E55h
 10089                                  
 10090                                  		call	call_bios_code	; read the clusters
 10091                                  		
 10092                                  		;pop	ds
 10093                                  		; 12/12/2023
 10094                                  		; ds = cs
 10095                                  		pop	bx		; lw of the new cluster number
 10096                                  		pop	si ; 20/12/2023 ; hw of the new cluster number
 10097                                  
 10098                                  		pop	di ; 2* - (kernel) load location (es:di)
 10099                                  
 10100                                  		;mov	ax, [cs:doscnt]	; get number of	sectors	read
 10101                                  		; 12/12/2023
 10102                                  		mov	ax, [doscnt]
 10103                                  		xchg	ah, al		; multiply by 256
 10104                                  		shl	ax, 1		; times	2 equal	512
 10105                                  		add	di, ax		; update load location
 10106                                  
 10107                                  		pop	cx ; 1*		; restore sectors/cluster
 10108                                  
 10109                                  		retn
 10110                                  
 10111                                  ; =============== S U B	R O U T	I N E =======================================
 10112                                  
 10113                                  ;function: find and read the corresponding fat sector into ds:0
 10114                                  ;
 10115                                  ;in). dx:si - offset value (starting from fat entry 0) of fat entry to find. M054
 10116                                  ;     ds - fatloc segment
 10117                                  ;     cs:drvfat - logical drive number, fat id
 10118                                  ;     cs:md_sectorsize
 10119                                  ;     cs:last_fat_secnum - last fat sector number read in.
 10120                                  ;
 10121                                  ;out). corresponding fat sector read in.
 10122                                  ;      bx = offset value from fatlog segment.
 10123                                  ;      other registers are saved.
 10124                                  ;      zero flag set if the fat entry is splitted, i.e., when 12 bit fat entry
 10125                                  ;      starts at the last byte of the fat sector. in this case, the caller
 10126                                  ;      should save this byte, and read the next fat sector to get the rest
 10127                                  ;      of the fat entry value. (this will only happen with the 12 bit fat.)
 10128                                  
 10129                                  		; 17/10/2022
 10130                                  get_fat_sector:	
 10131                                  		; 12/12/2023
 10132                                  		; ds = fat buffer segment
 10133                                  
 10134                                  		; 12/12/2023
 10135                                  		;push	ax ; (not necessary)
 10136                                  		push	cx ; read count (sectors per cluster)
 10137                                  		push	di ; IBMDOS.COM/MSDOS.SYS load offset
 10138                                  		push	si ; FAT offset value (from fat entry 0)
 10139                                  		push	es ; IBMDOS.COM/MSDOS.SYS load segment
 10140                                  		push	ds ; FAT buffer segment
 10141                                  
 10142                                  		; 12/12/2023
 10143                                  		push	cs
 10144                                  		pop	ds
 10145                                  	
 10146                                  		mov	ax, si
 10147                                  		;;mov	cx, [cs:md_sectorsize] ; 512
 10148                                  		; 12/12/2023
 10149                                  		;mov	cx, [md_sectorsize] ; 512
 10150                                  		;div	cx		; ax = sector number, dx = offset
 10151                                  		; 12/12/2023
 10152                                  		;nop
 10153                                  
 10154                                  		; 12/12/2023
 10155                                  		div	word [md_sectorsize] ; 512
 10156                                  
 10157                                  		; ax = FAT sector (sequence/index) number
 10158                                  		; dx = cluster number offset
 10159                                  
 10160                                  		; Get rid of the assumption that
 10161                                  		; there	is only	one reserved sector
 10162                                  
 10163                                  		; 12/12/2023 ; *
 10164                                  		;push	es ; *
 10165                                  		;push	ds ; *
 10166                                  		;push	di ; *
 10167                                  		push	ax
 10168                                  		;push	cs ; *
 10169                                  		;pop	ds ; *
 10170                                  
 10171                                  		;mov	ax, [cs:drvfat]	; get drive # and FAT id
 10172                                  		; 12/12/2023
 10173                                  		mov	ax, [drvfat]	; get drive # and FAT id 
 10174                                  		mov	bp, SETDRIVE
 10175                                  		;mov	bp, 5AEh  ; PCDOS 7.1 IBMBIO.COM
 10176                                  		;;mov	bp, 4D7h	; setdrive
 10177                                  					; at 2C7h:4D7h = 70h:2A47h
 10178                                  		push	cs		; simulate far call
 10179                                  		call	call_bios_code	; get bds for drive
 10180                                  		pop	ax		; (sector number -without reserved and hidden sectors-)
 10181                                  		add	ax, [es:di+9]	; [es:di+BDS.resectors]
 10182                                  					; add #reserved_sectors
 10183                                  		; 12/12/2023
 10184                                  		;pop	di ; *
 10185                                  		;pop	ds ; *
 10186                                  		;pop	es ; *
 10187                                  
 10188                                  		; 12/12/2023
 10189                                  		; ds = cs
 10190                                  		cmp	ax, [last_fat_sec_num]
 10191                                  		;cmp	ax, [cs:last_fat_sec_num]
 10192                                  		jz	short gfs_split_chk ; don't need to read it again.
 10193                                  		mov	[last_fat_sec_num], ax
 10194                                  		;mov	[cs:last_fat_sec_num], ax
 10195                                  					; sector number
 10196                                  					; (in the partition, without hidden sectors)
 10197                                  		; 13/12/2023
 10198                                  		pop	es ; FAT buffer segment (DS on top of the stack)
 10199                                  		push	es ; (put it on top of the stack again)
 10200                                  
 10201                                  		push	dx ; cluster number offset
 10202                                  
 10203                                  		; 12/12/2023
 10204                                  		xor	cx, cx
 10205                                  		mov	[start_sec_h], cx ;0 
 10206                                  		;mov	word [cs:start_sec_h], 0 
 10207                                  					; prepare to read the fat sector
 10208                                  					; start_sec_h is always	0 for fat sector.
 10209                                  		mov	dx, ax
 10210                                  		; 12/12/2023
 10211                                  		inc	cx ; cx = 1
 10212                                  		;mov	cx, 1		; 1 sector read
 10213                                  		;mov	ax, [cs:drvfat]
 10214                                  		mov	ax, [drvfat]
 10215                                  		;push	ds
 10216                                  		;pop	es
 10217                                  
 10218                                  		xor	di, di	; 0	; es:di	-> fatloc segment:0
 10219                                  		
 10220                                  		; 12/12/2023
 10221                                  		;push	ds
 10222                                  		;push	cs
 10223                                  		;pop	ds
 10224                                  		
 10225                                  		push	cs		; simulate far call
 10226                                  		mov	bp, DISKRD	; 8E5h
 10227                                  		;mov	bp, 8E5h	; offset diskrd
 10228                                  					; 2C7h:8E5h = 70h:2E55h
 10229                                  		call	call_bios_code
 10230                                  
 10231                                  		; 12/12/2023
 10232                                  		;pop	ds
 10233                                  		; ds = cs = biosdata segment
 10234                                  
 10235                                  		pop	dx ; cluster number offset 
 10236                                  
 10237                                  gfs_split_chk:
 10238                                  		; 13/12/2023
 10239                                  		;mov	cx, [cs:md_sectorsize] ; 512
 10240                                  		mov	cx, [md_sectorsize]
 10241                                  ;gfs_split_chk:					
 10242                                  		dec	cx		; 511
 10243                                  		cmp	dx, cx		; if offset points to the
 10244                                  					; last byte of this sector,
 10245                                  					; then splitted	entry.
 10246                                  		mov	bx, dx		; set bx to dx
 10247                                  		
 10248                                  		; 12/12/2023
 10249                                  		; bx = dx = cluster number offset in the FAT buffer
 10250                                  		pop	ds ; FAT buffer segment
 10251                                  		pop	es ; IBMDOS.COM/MSDOS.SYS load segment
 10252                                  		pop	si ; FAT offset value (from fat entry 0)
 10253                                  		pop	di ; IBMDOS.COM/MSDOS.SYS load offset
 10254                                  		pop	cx ; read count (sectors per cluster)
 10255                                  		;pop	ax
 10256                                  
 10257                                  		retn
 10258                                  ; 15/10/2022
 10259                                  ;Bios_Data_Init	ends
 10260                                  
 10261                                  %endif
 10262                                  ; ---------------------------------------------------------------------------
 10263                                  ; ---------------------------------------------------------------------------
 10264                                  
 10265                                  		; 09/12/2022
 10266                                  		;db 0
 10267                                  
 10268                                  numbertodiv	equ ($-BData_start)
 10269                                  numbertomod	equ (numbertodiv % 16)
 10270                                  
 10271                                  %if (numbertomod>0) & (numbertomod<16) ; 17/09/2023
 10272 000028EA 00<rep 6h>              		times (16-numbertomod) db 0
 10273                                  %endif
 10274                                  
 10275                                  ;align 16
 10276                                  
 10277                                  ; 09/12/2022
 10278                                  IOSYSCODESEGOFF equ $ - BData_start
 10279                                  ; 29/09/2023
 10280                                  ;IOSYSCODESEGOFF equ $-$$
 10281                                  IOSYSCODESEG	equ (IOSYSCODESEGOFF>>4)+(700h>>4)
 10282                                  
 10283                                  ; 28/09/2023
 10284                                  S1SIZE equ $-$$
 10285                                  
 10286                                  ;--- End of DOSBIOS data segment --------------------------------------------
 10287                                  ; ---------------------------------------------------------------------------
 10288                                  		;db 4 dup(0)
 10289                                  ; 09/12/2022		
 10290                                  ;		times 4 db 0	; 19/10/2022
 10291                                  ; ---------------------------------------------------------------------------
 10292                                  
 10293                                  ;============================================================================
 10294                                  ; DOS BIOS (IO.SYS) CODE SEGMENT 
 10295                                  ;============================================================================
 10296                                  ; 09/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 10297                                  
 10298                                  section .BIOSCODE vstart=0  
 10299                                  
 10300                                  BCode_start:	 ; 09/12/2022
 10301                                   
 10302                                  ; 02/10/2022
 10303                                  
 10304                                  ;--- DOSBIOS code segment ---------------------------------------------------
 10305                                  ;----------------------------------------------------------------------------
 10306                                  ; MSBIO1.ASM (MSDOS 6.0, 1991)
 10307                                  ;----------------------------------------------------------------------------
 10308                                  
 10309                                  DOSBIOSEG_2C7h:	;db 30h dup(0)		; SEGMENT 2C7h (2C70h-700h=2570h)
 10310 00000000 00<rep 30h>             		times 48 db 0		; 19/10/2022	
 10311 00000030 7000                    BiosDataWord:	dw 70h
 10312                                  
 10313                                  ; 15/10/2022
 10314                                  ;BIOSDATAWORD	equ BiosDataWord - DOSBIOSEG_2C7h
 10315                                  ; 09/12/2022
 10316                                  BIOSDATAWORD	equ BiosDataWord
 10317                                  
 10318                                  ; ---------------------------------------------------------------------------
 10319                                  
 10320                                  ; 15/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 10321                                  ; 20/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
 10322                                  
 10323                                  ;************************************************************************
 10324                                  ;*									*
 10325                                  ;*	seg_reinit is called with ax = our new code segment value,	*
 10326                                  ;*	  trashes di, cx, es						*
 10327                                  ;*									*
 10328                                  ;*	cas -- should be made disposable!				*
 10329                                  ;*									*
 10330                                  ;************************************************************************
 10331                                  
 10332                                  	; 20/09/2023	
 10333                                  	; 10/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 10334                                  	; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0032h 
 10335                                  
 10336                                  _seg_reinit:
 10337 00000032 2E8E06[3000]            		mov	es, [cs:BIOSDATAWORD]
 10338                                  					; at 2C7h:30h or 70h:25A0h
 10339                                  		;mov	di, (offset cdev+2)
 10340 00000037 BF[0406]                		mov	di, cdev+2	; 19/10/2022
 10341                                  		; 20/09/2023
 10342                                  		;mov	cx, 4		; (end_BC_entries - cdev)/4
 10343                                  		; 10/08/2023
 10344 0000003A B90300                  		mov	cx, 3 ; (PCDOS 7.1)
 10345                                  _seg_reinit_1:
 10346 0000003D AB                      		stosw			; modify Bios_Code entry points
 10347 0000003E 47                      		inc	di
 10348 0000003F 47                      		inc	di
 10349 00000040 E2FB                    		loop	_seg_reinit_1
 10350                                  
 10351                                  		; 10/08/2023 (PCDOS 7.1)
 10352                                  		; (direct jump to i2f_handler from BIOSDATA:bios_i2f)
 10353                                  		; (instead of 'bcode_i2f: dw i2f_handler, IOSYSCODESEG')
 10354                                  		
 10355                                  		; 20/09/2023
 10356 00000042 26A3[0800]              		mov	[es:bios_i2f_seg], ax ; actual BIOSCODE segment
 10357                                  		
 10358 00000046 CB                      		retf
 10359                                  
 10360                                  ; ---------------------------------------------------------------------------
 10361                                  
 10362                                  ; 15/10/2022
 10363                                  
 10364                                  ;************************************************************************
 10365                                  ;*									*
 10366                                  ;*	chardev_entry - main device driver dispatch routine		*
 10367                                  ;*	   called with a dummy parameter block on the stack		*
 10368                                  ;*	   dw dispatch_table, dw prn/aux numbers (optional)		*
 10369                                  ;*									*
 10370                                  ;*	will eventually take care of doing the transitions in		*
 10371                                  ;*	   out of Bios_Code						*
 10372                                  ;*									*
 10373                                  ;************************************************************************
 10374                                  
 10375                                  		; 20/09/2023
 10376                                  chardev_entry:				; 0070h:25B3h =	02C7h:0043h
 10377 00000047 56                      		push	si
 10378 00000048 50                      		push	ax
 10379 00000049 51                      		push	cx
 10380 0000004A 52                      		push	dx
 10381 0000004B 57                      		push	di
 10382 0000004C 55                      		push	bp
 10383 0000004D 1E                      		push	ds
 10384 0000004E 06                      		push	es
 10385 0000004F 53                      		push	bx
 10386 00000050 89E5                    		mov	bp, sp
 10387 00000052 8B7612                  		mov	si, [bp+18]	; get return address (dispatch table)
 10388                                  		;;mov	ds, word [cs:0030h]
 10389                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:0030h]
 10390 00000055 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD] ; 17/10/2022
 10391                                  		; 20/09/2023 (PCDOS 7.1 - IBMBIO.COM - BIOSCODE:005Ah)
 10392 0000005A C434                    		les	si, [si]
 10393                                  		;mov	ax, [si+2]	; get the device number	if present
 10394 0000005C 8CC0                    		mov	ax, es
 10395 0000005E A2[2100]                		mov	[auxnum], al
 10396 00000061 8826[8004]              		mov	[printdev], ah
 10397                                  		;mov	si, [si]	; point	to the device dispatch table
 10398 00000065 C41E[1200]              		les	bx, [ptrsav]	; get pointer to i/o packet
 10399 00000069 268A4701                		mov	al, [es:bx+1]	; [es:bx+unit]	; al = unit code
 10400 0000006D 268A670D                		mov	ah, [es:bx+13]	; [es:bx+media]	; ah = media descrip
 10401 00000071 268B4F12                		mov	cx, [es:bx+18]	; [es:bx+count]	; cx = count
 10402 00000075 268B5714                		mov	dx, [es:bx+20]	; [es:bx+start]	; dx = start sector
 10403                                  		; 17/10/2022
 10404 00000079 81FE[6F05]              		cmp	si, DSKTBL
 10405                                  		;;cmp	si, 579h	; (PCDOS 7.1 IBMBIO.COM)
 10406                                  		;cmp	si, 4A2h	; dsktbl
 10407                                  					; at 2C7h:4A2h = 70h:2A12h
 10408 0000007D 7517                    		jnz	short no_sector32_mapping
 10409                                  
 10410                                  ; Special case for 32-bit start sector number:
 10411                                  ;   if (si==dsktbl) /* if this is a disk device call */
 10412                                  ;      set high 16 bits of secnum to 0
 10413                                  ;      if (secnum == 0xffff) fetch 32 bit sector number
 10414                                  ;
 10415                                  ; pass high word of sector number in start_sec_h, low word in dx
 10416                                  ;
 10417                                  ; note: start_l and start_h are the offsets within the io_request packet
 10418                                  ;	  which contain the low and hi words of the 32 bit start sector if
 10419                                  ;	  it has been used.
 10420                                  ;
 10421                                  ; note: remember not to destroy the registers which have been set up before
 10422                                  
 10423                                  		; 20/09/2023
 10424                                  		;mov	ds:start_sec_h,	0 ; initialize to 0
 10425 0000007F C706[9C04]0000          		mov	word [start_sec_h], 0
 10426 00000085 83FAFF                  		cmp	dx, 0FFFFh
 10427 00000088 750C                    		jnz	short no_sector32_mapping
 10428 0000008A 268B571C                		mov	dx, [es:bx+28]	; [es:bx+start_h]
 10429                                  					; 32 bits dsk req
 10430                                  		;mov	ds:start_sec_h,	dx ; start_sec_h = packet.start_h
 10431 0000008E 8916[9C04]              		mov	[start_sec_h], dx
 10432 00000092 268B571A                		mov	dx, [es:bx+26]	; [es:bx+start_l]
 10433                                  					; dx = packet.start_l
 10434                                  no_sector32_mapping:
 10435 00000096 97                      		xchg	ax, di
 10436 00000097 268A4702                		mov	al, [es:bx+2]	; [es:bx+cmd]
 10437 0000009B 2E3A04                  		cmp	al, [cs:si]
 10438 0000009E 732B                    		jnb	short command_error
 10439 000000A0 98                      		cbw			; note that al <= 15 means ok
 10440 000000A1 D1E0                    		shl	ax, 1
 10441 000000A3 01C6                    		add	si, ax
 10442 000000A5 97                      		xchg	ax, di
 10443 000000A6 26C47F0E                		les	di, [es:bx+14]	; [es:bx+trans]
 10444 000000AA FC                      		cld
 10445                                  		; 17/10/2022
 10446 000000AB 2EFF5401                		call	near [cs:si+1]
 10447                                  		;call	word ptr cs:si+1
 10448 000000AF 7202                    		jb	short already_got_ah_status
 10449 000000B1 B401                    		mov	ah, 1
 10450                                  already_got_ah_status:
 10451                                  		;;mov	ds, [cs:0030h]	; 15/10/2022
 10452                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:0030h]
 10453                                  					; cas note: shouldn't be needed!
 10454 000000B3 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD] ; 17/10/2022
 10455                                  		;lds	bx, ds:ptrsav
 10456 000000B8 C51E[1200]              		lds	bx, [ptrsav]
 10457 000000BC 894703                  		mov	[bx+3],	ax	; [bx+status]
 10458                                  					; mark operation complete
 10459 000000BF 5B                      		pop	bx
 10460 000000C0 07                      		pop	es
 10461 000000C1 1F                      		pop	ds
 10462 000000C2 5D                      		pop	bp
 10463 000000C3 5F                      		pop	di
 10464 000000C4 5A                      		pop	dx
 10465 000000C5 59                      		pop	cx
 10466 000000C6 58                      		pop	ax
 10467 000000C7 5E                      		pop	si
 10468                                  		;add	sp, 2		; get rid of fake return address
 10469                                  		; 20/09/2023 (PCDOS 7.1	- IBMBIO.COM - BIOSCODE:00C8h)
 10470 000000C8 44                      		inc	sp
 10471 000000C9 44                      		inc	sp	
 10472                                  
 10473                                  		; fall through into bc_retf
 10474                                  ; ---------------------------------------------------------------------------	
 10475                                  bc_retf:
 10476 000000CA CB                      		retf
 10477                                  ; ---------------------------------------------------------------------------
 10478                                  
 10479                                  command_error:				
 10480 000000CB E80700                  		call	bc_cmderr
 10481 000000CE EBE3                    		jmp	short already_got_ah_status
 10482                                  ; 15/10/2022
 10483                                  ; 01/05/2019
 10484                                  
 10485                                  ;----------------------------------------------------------------------------
 10486                                  ; The following piece of hack is for supporting CP/M compatibility
 10487                                  ; Basically at offset 5 we have a far call into 0:c0. But this does not call
 10488                                  ; 0:c0 directly instead it call f01d:fef0, because it needs to support 'lhld 6'
 10489                                  ; The following hack has to reside at ffff:d0 (= f01d:fef0) if BIOS is loaded
 10490                                  ; high.
 10491                                  ;----------------------------------------------------------------------------
 10492                                  
 10493                                  
 10494                                  		;db 7 dup(0)
 10495                                  
 10496                                  		; 20/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 10497                                  		; (PCDOS 7.1 - IBMBIO.COM - BIOSCODE:0D0h)
 10498                                  		; 15/10/2022
 10499                                  		;dw 0		; pad to bring offset to 0D0h
 10500                                  
 10501 000000D0 00<rep 5h>              off_d0: 	times 5 db 0	; 5 bytes from 0:c0 will be copied onto here
 10502                                  				;  which is the CP/M call 5 entry point
 10503                                  		
 10504                                  ; ---------------------------------------------------------------------------
 10505                                  
 10506                                  ;	exit - all routines return through this path
 10507                                  
 10508                                  bc_cmderr:				
 10509 000000D5 B003                    		mov	al, 3		; 2C7h:D5h = 70h:2645h
 10510                                  					; unknown command error
 10511                                  
 10512                                  ; =============== S U B	R O U T	I N E =======================================
 10513                                  
 10514                                  ;	now zero the count field by subtracting its current value,
 10515                                  ;	  which is still in cx, from itself.
 10516                                  
 10517                                  ;	subtract the number of i/o's NOT YET COMPLETED from total
 10518                                  ;	  in order to return the number actually complete
 10519                                  
 10520                                  bc_err_cnt:	
 10521                                  		;les	bx, ds:ptrsav
 10522                                  		; 19/10/2022
 10523 000000D7 C41E[1200]              		les	bx, [ptrsav]
 10524 000000DB 26294F12                		sub	[es:bx+18], cx	; [es:bx+count]
 10525                                  					; # of successful i/o's
 10526 000000DF B481                    		mov	ah, 81h		; mark error return
 10527 000000E1 F9                      		stc			; indicate abnormal end
 10528 000000E2 C3                      		retn
 10529                                  
 10530                                  ; 15/10/2022
 10531                                  
 10532                                  ;Bios_Code ends
 10533                                  
 10534                                  ;----------------------------------------------------------------------------
 10535                                  ; MSCHAR.ASM - MSDOS 6.0 - 1991
 10536                                  ;----------------------------------------------------------------------------
 10537                                  ; 15/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 10538                                  ; 10/01/2019 - Retro DOS v4.0
 10539                                  
 10540                                  ; 30/04/2019
 10541                                  
 10542                                  ;title	mschar - character and clock devices
 10543                                  
 10544                                  ;MODE_CTRLBRK	equ	0FFh
 10545                                  
 10546                                  ; BIOSCODE:00E4h (MSDOS 6.21, IO.SYS)
 10547                                  
 10548                                  ;************************************************************************
 10549                                  ;*									*
 10550                                  ;*	device driver dispatch tables					*
 10551                                  ;*									*
 10552                                  ;*	each table starts with a byte which lists the number of		*
 10553                                  ;*	legal functions, followed by that number of words. Each		*
 10554                                  ;*	word represents an offset of a routine in Bios_Code which	*
 10555                                  ;*	handles the function. The functions are terminated with		*
 10556                                  ;*	a near return. If carry is reset, a 'done' code is returned	*
 10557                                  ;*	to the caller. If carry is set, the ah/al registers are		*
 10558                                  ;*	returned as abnormal completion status. Notice that ds		*
 10559                                  ;*	is assumed to point to the Bios_Data segment throughout.	*
 10560                                  ;*									*
 10561                                  ;************************************************************************
 10562                                  
 10563                                  		; 20/09/2023
 10564                                  		; (PCDOS 7.1 - IBMBIO.COM - BIOSCODE:00E3h)
 10565                                  		; 13/12/2022
 10566 000000E3 00                      		db 0
 10567                                  
 10568                                  		; 13/12/2022
 10569 000000E4 0B                      con_table:	db ((con_table_end - con_table)-1)/2 ; 11
 10570                                  					; 2C7h:0E4h = 70h:2654h
 10571 000000E5 [FA01]                  		dw bc_exvec  ; 1FBh	; bc_exvec at 2C7h:1FBh	= 70h:276Bh
 10572                                  					; 00 init
 10573 000000E7 [FA01]                  		dw bc_exvec  ; 1FBh	; 01
 10574 000000E9 [FA01]                  		dw bc_exvec  ; 1FBh	; 02
 10575 000000EB [D500]                  		dw bc_cmderr ; 0D5h	; bc_exvec at 2C7h:D5h = 70h:2645h
 10576                                  					; 03
 10577 000000ED [5C01]                  		dw con_read  ; 15Ch	; con_read at 2C7h:15Ch	= 70h:26CCh
 10578                                  					; 04
 10579 000000EF [9F01]                  		dw con_rdnd  ; 19Fh	; con_rdnd at 2C7h:19Fh	= 70h:270Fh
 10580                                  					; 05
 10581 000000F1 [FA01]                  		dw bc_exvec  ; 1FBh	; 06
 10582 000000F3 [0802]                  		dw con_flush ; 209h	; con_flush at 2C7h:209h = 70h:2779h
 10583                                  					; 07
 10584 000000F5 [FC01]                  		dw con_writ  ; 1FDh	; con_writ at 2C7h:1FDh	= 70h:276Dh
 10585                                  					; 08
 10586 000000F7 [FC01]                  		dw con_writ  ; 1FDh	; 09
 10587 000000F9 [FA01]                  		dw bc_exvec  ; 1FBh	; 0A
 10588                                  con_table_end:
 10589 000000FB 1A                      prn_table:	db ((prn_table_end - prn_table)-1)/2 ; 26			
 10590                                  					; 2C7h:0FBh = 70h:266Bh
 10591 000000FC [FA01]                  		dw bc_exvec   ; 1FBh	; bc_exvec
 10592 000000FE [FA01]                  		dw bc_exvec   ; 1FBh	; 01
 10593 00000100 [FA01]                  		dw bc_exvec   ; 1FBh	; 02
 10594 00000102 [D500]                  		dw bc_cmderr  ;	0D5h	; bc_cmderr
 10595 00000104 [1902]                  		dw prn_input  ;	21Ah	; prn_input
 10596                                  					; 04 indicate zero chars read
 10597 00000106 [C701]                  		dw z_bus_exit ; 1C8h	; z_bus_exit
 10598                                  					; 05 read non-destructive
 10599 00000108 [FA01]                  		dw bc_exvec   ; 1FBh	; 06
 10600 0000010A [FA01]                  		dw bc_exvec   ; 1FBh	; 07
 10601 0000010C [1E02]                  		dw prn_writ   ;	21Fh	; prn_writ
 10602 0000010E [1E02]                  		dw prn_writ   ; 21Fh	; 09
 10603 00000110 [4F02]                  		dw prn_stat   ; 251h	; prn_stat
 10604 00000112 [FA01]                  		dw bc_exvec   ; 1FBh	; 0B
 10605 00000114 [FA01]                  		dw bc_exvec   ; 1FBh	; 0C
 10606 00000116 [FA01]                  		dw bc_exvec   ; 1FBh	; 0D
 10607 00000118 [FA01]                  		dw bc_exvec   ; 1FBh	; 0E
 10608 0000011A [FA01]                  		dw bc_exvec   ; 1FBh	; 0F
 10609 0000011C [9402]                  		dw prn_tilbusy ; 28Bh	; prn_tilbusy
 10610 0000011E [FA01]                  		dw bc_exvec   ; 1FBh	; 11
 10611 00000120 [FA01]                  		dw bc_exvec   ; 1FBh	; 12
 10612 00000122 [C202]                  		dw prn_genioctl ; 2BAh	; prn_genioctl
 10613 00000124 [FA01]                  		dw bc_exvec   ; 1FBh	; 14
 10614 00000126 [FA01]                  		dw bc_exvec   ; 1FBh	; 15
 10615 00000128 [FA01]                  		dw bc_exvec   ; 1FBh	; 16
 10616 0000012A [FA01]                  		dw bc_exvec   ; 1FBh	; 17
 10617 0000012C [FA01]                  		dw bc_exvec   ; 1FBh	; 18
 10618 0000012E [F702]                  		dw prn_ioctl_query ; 2F0h ; prn_ioctl_query
 10619                                  prn_table_end:
 10620 00000130 0B                      aux_table:	db ((aux_table_end - aux_table)-1)/2 ; 11			
 10621                                  					; 2C7h:130h = 70h:26A0h
 10622 00000131 [FA01]                  		dw bc_exvec   ; 1FBh	; 00 - init
 10623 00000133 [FA01]                  		dw bc_exvec   ; 1FBh	; 01
 10624 00000135 [FA01]                  		dw bc_exvec   ; 1FBh	; 02
 10625 00000137 [D500]                  		dw bc_cmderr  ;	0D5h	; 03
 10626 00000139 [1203]                  		dw aux_read   ; 30Dh	; aux_read ; 04	- read
 10627 0000013B [3703]                  		dw aux_rdnd   ; 335h	; aux_rdnd - 05	- read non-destructive
 10628 0000013D [FA01]                  		dw bc_exvec   ; 1FBh	; 06
 10629 0000013F [7803]                  		dw aux_flsh   ;	36Ch	; aux_flsh
 10630 00000141 [7F03]                  		dw aux_writ   ;	374h	; aux_writ
 10631 00000143 [7F03]                  		dw aux_writ   ;	374h	; 09
 10632 00000145 [5703]                  		dw aux_wrst   ;	355h	; aux_wrst
 10633                                  aux_table_end:
 10634 00000147 0A                      tim_table	db ((tim_table_end - tim_table)-1)/2 ; 10
 10635                                  					; 2C7h:147h = 70h:26B7h
 10636 00000148 [FA01]                  		dw bc_exvec   ; 1FBh	; 00
 10637 0000014A [FA01]                  		dw bc_exvec   ; 1FBh	; 01
 10638 0000014C [FA01]                  		dw bc_exvec   ; 1FBh	; 02
 10639 0000014E [D500]                  		dw bc_cmderr  ;	0D5h	; 03
 10640 00000150 [E404]                  		dw tim_read   ;	435h	; tim_read
 10641 00000152 [C701]                  		dw z_bus_exit ; 1C8h	; z_bus_exit
 10642 00000154 [FA01]                  		dw bc_exvec   ; 1FBh	; 06
 10643 00000156 [FA01]                  		dw bc_exvec   ; 1FBh	; 07
 10644 00000158 [E503]                  		dw tim_writ   ; 3DBh	; tim_writ
 10645 0000015A [E503]                  		dw tim_writ   ; 3DBh	; 09
 10646                                  tim_table_end:
 10647                                  
 10648                                  ; ---------------------------------------------------------------------------
 10649                                  
 10650                                  ;************************************************************************
 10651                                  ;*									*
 10652                                  ;*	con_read - read cx bytes from keyboard into buffer at es:di	*
 10653                                  ;*									*
 10654                                  ;************************************************************************
 10655                                  
 10656                                  con_read:				; 2C7h:15Ch = 70h:26CCh
 10657                                  		;jcxz	short con_exit	; read cx bytes	from keyboard into buffer
 10658 0000015C E306                    		jcxz	con_exit	; 19/10/2022
 10659                                  con_loop:				
 10660 0000015E E80500                  		call	chrin		; get char in al
 10661 00000161 AA                      		stosb			; store	char at	es:di
 10662 00000162 E2FA                    		loop	con_loop
 10663                                  con_exit:				
 10664 00000164 F8                      		clc
 10665 00000165 C3                      		retn
 10666                                  
 10667                                  ; =============== S U B	R O U T	I N E =======================================
 10668                                  
 10669                                  ;************************************************************************
 10670                                  ;*									*
 10671                                  ;*	chrin - input single char from keyboard into al			*
 10672                                  ;*									*
 10673                                  ;*	  we are going to issue extended keyboard function, if		*
 10674                                  ;*	  supported. the returning value of the extended keystroke	*
 10675                                  ;*	  of the extended keyboard function uses 0E0h in al		*
 10676                                  ;*	  instead of 00h as in the conventional keyboard function.	*
 10677                                  ;*	  this creates a conflict when the user entered real		*
 10678                                  ;*	  greek alpha charater (= 0E0h) to  distinguish the extended	*
 10679                                  ;*	  keystroke and the greek alpha. this case will be handled	*
 10680                                  ;*	  in the following manner:					*
 10681                                  ;*									*
 10682                                  ;*	      ah = 16h							*
 10683                                  ;*	      int 16h							*
 10684                                  ;*	      if al == 0, then extended code (in ah)			*
 10685                                  ;*	      else if al == 0E0h, then					*
 10686                                  ;*	      if ah <> 0, then extended code (in ah)			*
 10687                                  ;*		else greek_alpha character.				*
 10688                                  ;*									*
 10689                                  ;*	also, for compatibility reason, if an extended code is		*
 10690                                  ;*	  detected, then we are going to change the value in al		*
 10691                                  ;*	  from 0E0h to 00h.						*
 10692                                  ;*									*
 10693                                  ;************************************************************************
 10694                                  
 10695                                  		; 19/10/2022
 10696                                  chrin:		
 10697 00000166 8A26[7E04]              		mov	ah, [keyrd_func] ; set by msinit. 0 or 10h
 10698 0000016A 30C0                    		xor	al, al
 10699 0000016C 8606[0C00]              		xchg	al, [altah]	; get character	& zero altah
 10700 00000170 08C0                    		or	al, al
 10701 00000172 752A                    		jnz	short keyret
 10702 00000174 CD16                    		int	16h		; KEYBOARD -
 10703 00000176 09C0                    		or	ax, ax
 10704 00000178 74EC                    		jz	short chrin
 10705 0000017A 3D0072                  		cmp	ax, 7200h	; check	for ctrl-prtsc
 10706 0000017D 7504                    		jnz	short alt_ext_chk
 10707 0000017F B010                    		mov	al, 10h
 10708 00000181 EB1B                    		jmp	short keyret
 10709                                  ; ---------------------------------------------------------------------------
 10710                                  
 10711                                  ;  if operation was extended function (i.e. keyrd_func != 0) then
 10712                                  ;    if character read was 0E0h then
 10713                                  ;      if extended byte was zero (i.e. ah == 0) then
 10714                                  ;	 goto keyret
 10715                                  ;      else
 10716                                  ;	 set al to zero
 10717                                  ;	 goto alt_save
 10718                                  ;      endif
 10719                                  ;    endif
 10720                                  ;  endif
 10721                                  
 10722                                  alt_ext_chk:
 10723 00000183 803E[7E04]00            		cmp	byte [keyrd_func], 0
 10724 00000188 740C                    		jz	short not_ext
 10725 0000018A 3CE0                    		cmp	al, 0E0h
 10726 0000018C 7508                    		jnz	short not_ext
 10727 0000018E 08E4                    		or	ah, ah
 10728 00000190 740C                    		jz	short keyret
 10729 00000192 30C0                    		xor	al, al
 10730 00000194 EB04                    		jmp	short alt_save
 10731                                  ; ---------------------------------------------------------------------------
 10732                                  
 10733                                  not_ext:				
 10734 00000196 08C0                    		or	al, al		; special case?
 10735 00000198 7504                    		jnz	short keyret
 10736                                  alt_save:				
 10737 0000019A 8826[0C00]              		mov	[altah], ah	; store	special	key
 10738                                  keyret:					
 10739 0000019E C3                      		retn
 10740                                  
 10741                                  ; ---------------------------------------------------------------------------
 10742                                  
 10743                                  ;************************************************************************
 10744                                  ;*									*
 10745                                  ;*	con_rdnd - keyboard non destructive read, no wait		*
 10746                                  ;*									*
 10747                                  ;*	pc-convertible-type machine: if bit 10 is set by the dos	*
 10748                                  ;*	in the status word of the request packet, and there is no	*
 10749                                  ;*	character in the input buffer, the driver issues a system	*
 10750                                  ;*	wait request to the rom. on return from the rom, it returns	*
 10751                                  ;*	a 'char-not-found' to the dos.					*
 10752                                  ;*									*
 10753                                  ;************************************************************************
 10754                                  
 10755                                  		; 19/10/2022
 10756                                  con_rdnd:				
 10757 0000019F A0[0C00]                		mov	al, [altah]
 10758 000001A2 08C0                    		or	al, al
 10759 000001A4 754C                    		jnz	short rdexit
 10760 000001A6 8A26[7F04]              		mov	ah, [keysts_func]
 10761 000001AA CD16                    		int	16h		; KEYBOARD -
 10762 000001AC 751D                    		jnz	short gotchr
 10763 000001AE 803E[7900]00            		cmp	byte [fhavek09], 0
 10764 000001B3 7412                    		jz	short z_bus_exit
 10765 000001B5 C41E[1200]              		les	bx, [ptrsav]
 10766                                  		; 12/12/2022
 10767 000001B9 26F6470404              		test	byte [es:bx+4], 04h
 10768                                  		;test	word [es:bx+3], 400h ; [es:bx+status]
 10769 000001BE 7407                    		jz	short z_bus_exit
 10770 000001C0 B80041                  		mov	ax, 4100h
 10771 000001C3 30DB                    		xor	bl, bl
 10772 000001C5 CD15                    		int	15h		; SYSTEM - WAIT	ON EXTERNAL EVENT (CONVERTIBLE)
 10773                                  					; AL = condition type, BH = condition compare or mask value
 10774                                  					; BL = timeout value times 55 milliseconds, 00h	means no timeout
 10775                                  					; DX = I/O port	address	if AL bit 4 set
 10776                                  z_bus_exit:				
 10777 000001C7 F9                      		stc			; 2C7h:1C8h = 70h:2738h
 10778 000001C8 B403                    		mov	ah, 3		; indicate busy	status
 10779 000001CA C3                      		retn
 10780                                  ; ---------------------------------------------------------------------------
 10781                                  
 10782                                  gotchr:					
 10783 000001CB 09C0                    		or	ax, ax
 10784 000001CD 7508                    		jnz	short notbrk	; check	for null after break
 10785 000001CF 8A26[7E04]              		mov	ah, [keyrd_func] ; issue keyboard read function
 10786 000001D3 CD16                    		int	16h		; KEYBOARD -
 10787 000001D5 EBC8                    		jmp	short con_rdnd	; get a	real status
 10788                                  ; ---------------------------------------------------------------------------
 10789                                  
 10790                                  notbrk:					
 10791 000001D7 3D0072                  		cmp	ax, 7200h	; check	for ctrl-prtsc
 10792 000001DA 7504                    		jnz	short rd_ext_chk
 10793 000001DC B010                    		mov	al, 10h		; ('P' & 1Fh) ; return control p
 10794 000001DE EB12                    		jmp	short rdexit
 10795                                  ; ---------------------------------------------------------------------------
 10796                                  
 10797                                  rd_ext_chk:				
 10798 000001E0 803E[7E04]00            		cmp	byte [keyrd_func], 0 ; extended keyboard function?
 10799 000001E5 740B                    		jz	short rdexit
 10800 000001E7 3CE0                    		cmp	al, 0E0h	; extended key value or	greek alpha?
 10801 000001E9 7507                    		jnz	short rdexit
 10802 000001EB 80FC00                  		cmp	ah, 0		; scan code exist?
 10803 000001EE 7402                    		jz	short rdexit	; yes. greek alpha char.
 10804 000001F0 B000                    		mov	al, 0		; no. extended key stroke.
 10805                                  					; change it for	compatibility
 10806                                  rdexit:					
 10807 000001F2 C41E[1200]              		les	bx, [ptrsav]
 10808 000001F6 2688470D                		mov	[es:bx+13], al	; [es:bx+media]
 10809                                  					; return keyboard character here
 10810                                  bc_exvec:				
 10811 000001FA F8                      		clc			; bc_exvec at 2C7h:1FBh	= 70h:276Bh
 10812                                  					; indicate normal termination
 10813 000001FB C3                      		retn
 10814                                  ; ---------------------------------------------------------------------------
 10815                                  
 10816                                  ;************************************************************************
 10817                                  ;*									*
 10818                                  ;*	con_write - console write routine				*
 10819                                  ;*									*
 10820                                  ;*	entry:	es:di -> buffer						*
 10821                                  ;*		cx    =  count						*
 10822                                  ;*									*
 10823                                  ;************************************************************************
 10824                                  
 10825                                  con_writ:
 10826                                  		;jcxz	short bc_exvec
 10827 000001FC E3FC                    		jcxz	bc_exvec	; 19/10/2022
 10828                                  		; 12/12/2022
 10829                                  		;jcxz	cc_ret
 10830                                  con_lp:					
 10831 000001FE 268A05                  		mov	al, [es:di]
 10832 00000201 47                      		inc	di
 10833 00000202 CD29                    		int	29h		; DOS 2+ internal - FAST PUTCHAR
 10834                                  					; AL = character to display
 10835 00000204 E2F8                    		loop	con_lp
 10836                                  cc_ret:					
 10837 00000206 F8                      		clc
 10838 00000207 C3                      		retn
 10839                                  
 10840                                  ; =============== S U B	R O U T	I N E =======================================
 10841                                  
 10842                                  ;************************************************************************
 10843                                  ;*									*
 10844                                  ;*	con_flush - flush out keyboard queue				*
 10845                                  ;*									*
 10846                                  ;************************************************************************
 10847                                  
 10848                                  con_flush:
 10849 00000208 C606[0C00]00            		mov	byte [altah], 0	; clear	out holding buffer
 10850                                  flloop:					; while	(charavail()) charread();	
 10851 0000020D B401                    		mov	ah, 1
 10852 0000020F CD16                    		int	16h		; KEYBOARD - CHECK BUFFER, DO NOT CLEAR
 10853                                  					; Return: ZF clear if character	in buffer
 10854                                  					; AH = scan code, AL = character
 10855                                  					; ZF set if no character in buffer
 10856 00000211 74F3                    		jz	short cc_ret
 10857 00000213 30E4                    		xor	ah, ah
 10858 00000215 CD16                    		int	16h		; KEYBOARD - READ CHAR FROM BUFFER, WAIT IF EMPTY
 10859                                  					; Return: AH = scan code, AL = character
 10860 00000217 EBF4                    		jmp	short flloop
 10861                                  
 10862                                  ; ---------------------------------------------------------------------------
 10863                                  
 10864                                  ; 15/10/2022
 10865                                  
 10866                                  ;************************************************************************
 10867                                  ;*									*
 10868                                  ;*	some equates for rom bios printer i/o				*
 10869                                  ;*									*
 10870                                  ;************************************************************************
 10871                                  
 10872                                  ; ibm rom status bits (i don't trust them, neither should you)
 10873                                  ; warning!!! the ibm rom does not return just one bit. it returns a
 10874                                  ; whole slew of bits, only one of which is correct.
 10875                                  
 10876                                  ;notbusystatus	equ 10000000b		; not busy
 10877                                  ;nopaperstatus	equ 00100000b		; no more paper
 10878                                  ;prnselected	equ 00010000b		; printer selected
 10879                                  ;ioerrstatus	equ 00001000b		; some kinda error
 10880                                  ;timeoutstatus	equ 00000001b		; time out.
 10881                                  ;
 10882                                  ;noprinter	equ 00110000b		; no printer attached
 10883                                  
 10884                                  ; 18/03/2019 - Retro DOS v4.0
 10885                                  ;error_I24_out_of_paper	equ 9 ; MSDOS 6.0, ERR.INC, 1991
 10886                                  
 10887                                  ; ---------------------------------------------------------------------------
 10888                                  
 10889                                  ;************************************************************************
 10890                                  ;*									*
 10891                                  ;*	prn_input - return with no error but zero chars read		*
 10892                                  ;*									*
 10893                                  ;*	enter with cx = number of characters requested			*
 10894                                  ;*									*
 10895                                  ;************************************************************************
 10896                                  
 10897                                  prn_input:				; 2C7h:21Ah = 70h:278Ah
 10898 00000219 E8BBFE                  		call	bc_err_cnt	; reset	count to zero
 10899                                  					; (sub reqpkt.count,cx)
 10900                                  		; 12/12/2022
 10901                                  prn_done:
 10902 0000021C F8                      		clc			; but return with carry	reset for no error
 10903 0000021D C3                      		retn
 10904                                  ; ---------------------------------------------------------------------------
 10905                                  
 10906                                  ;************************************************************************
 10907                                  ;*									*
 10908                                  ;*	prn_writ - write cx bytes from es:di to printer device		*
 10909                                  ;*									*
 10910                                  ;*	auxnum has printer number					*
 10911                                  ;*									*
 10912                                  ;************************************************************************
 10913                                  
 10914                                  prn_writ:				; 2C7h:21Fh = 70h:278Fh
 10915                                  		;jcxz	short prn_done	; no chars to output
 10916 0000021E E3FC                    		jcxz	prn_done	; 19/10/2022
 10917                                  prn_loop:				
 10918 00000220 BB0200                  		mov	bx, 2		; retry	count
 10919                                  prn_out:				
 10920 00000223 E83600                  		call	prnstat		; get status
 10921 00000226 751D                    		jnz	short TestPrnError
 10922 00000228 268A05                  		mov	al, [es:di]	; get character	to print
 10923 0000022B 30E4                    		xor	ah, ah
 10924 0000022D E82E00                  		call	prnop		; print	to printer
 10925 00000230 7419                    		jz	short prn_con	; no error - continue
 10926 00000232 80FCFF                  		cmp	ah, 0FFh	; MODE_CTRLBRK
 10927 00000235 7509                    		jnz	short _prnwf
 10928 00000237 B00C                    		mov	al, 0Ch		; error_I24_gen_failure
 10929 00000239 C606[0C00]00            		mov	byte [altah], 0
 10930 0000023E EB08                    		jmp	short pmessg
 10931                                  ; ---------------------------------------------------------------------------
 10932                                  
 10933                                  _prnwf:					
 10934 00000240 F6C401                  		test	ah, 1		; timeoutstatus
 10935 00000243 7406                    		jz	short prn_con
 10936                                  TestPrnError:				
 10937 00000245 4B                      		dec	bx		; retry	until count is exhausted.
 10938 00000246 75DB                    		jnz	short prn_out
 10939                                  pmessg:					
 10940 00000248 E98CFE                  		jmp	bc_err_cnt
 10941                                  ; ---------------------------------------------------------------------------
 10942                                  
 10943                                  prn_con:				
 10944 0000024B 47                      		inc	di		; point	to next	char and continue
 10945 0000024C E2D2                    		loop	prn_loop
 10946                                  ;prn_done:				
 10947                                  		; 12/12/2022
 10948                                  prn_done2:
 10949                                  		;clc
 10950                                  		; cf=0
 10951 0000024E C3                      		retn
 10952                                  ; ---------------------------------------------------------------------------
 10953                                  
 10954                                  ;************************************************************************
 10955                                  ;*									*
 10956                                  ;*	prn_stat - device driver entry to return printer status		*
 10957                                  ;*									*
 10958                                  ;************************************************************************
 10959                                  
 10960                                  prn_stat:				; 2C7h:251h = 70h:27C1h
 10961 0000024F E80A00                  		call	prnstat		; device in dx
 10962 00000252 75F4                    		jnz	short pmessg
 10963 00000254 F6C480                  		test	ah, 80h		; notbusystatus
 10964                                  		;jnz	short prn_done
 10965                                  		; 12/12/2022
 10966 00000257 75F5                    		jnz	short prn_done2 ; cf=0
 10967 00000259 E96BFF                  		jmp	z_bus_exit
 10968                                  ; ---------------------------------------------------------------------------
 10969                                  
 10970                                  ;************************************************************************
 10971                                  ;*									*
 10972                                  ;*	prnstat - utility function to call ROM BIOS to check		*
 10973                                  ;*		 printer status. Return meaningful error code		*
 10974                                  ;*									*
 10975                                  ;************************************************************************
 10976                                  
 10977                                  prnstat:				
 10978 0000025C B402                    		mov	ah, 2		; set command for get status
 10979                                  					; PRINTER - GET	STATUS
 10980                                  					; DX = printer port (0-3)
 10981                                  					; Return: AH = status
 10982                                  
 10983                                  ; =============== S U B	R O U T	I N E =======================================
 10984                                  
 10985                                  ;************************************************************************
 10986                                  ;*									*
 10987                                  ;*	prnop - call ROM BIOS printer function in ah			*
 10988                                  ;*		return zero true if no error				*
 10989                                  ;*		return zero false if error, al = error code		*
 10990                                  ;*									*
 10991                                  ;************************************************************************
 10992                                  
 10993                                  prnop:
 10994                                  		; 20/12/2023 - Retro DOS v5.0
 10995                                  		; PCDOS 7.1 IBMBIO.COM
 10996                                  		
 10997                                  		;mov	dx, [auxnum]	; get printer number
 10998                                  		;int	17h
 10999                                  
 11000 0000025E 1E                      		push	ds
 11001 0000025F FF36[2100]              		push	word [auxnum]
 11002 00000263 31D2                    		xor	dx, dx ; 0
 11003 00000265 8EDA                    		mov	ds, dx
 11004 00000267 5A                      		pop	dx
 11005 00000268 9C                      		pushf			; simulate int 17h
 11006 00000269 FA                      		cli
 11007                                  		;call	dword ptr ds:5Ch
 11008 0000026A FF1E5C00                		call	far [17h*4]	; 0:5Ch = INT 17h vector
 11009 0000026E 1F                      		pop	ds
 11010                                  
 11011                                  	; This check was added to see if this is a case of no
 11012                                  	; printer being installed. This tests checks to be sure
 11013                                  	; the error is noprinter (30h)
 11014                                  
 11015 0000026F 50                      		push	ax
 11016 00000270 80E430                  		and	ah, 30h
 11017 00000273 80FC30                  		cmp	ah, 30h		; noprinter
 11018 00000276 58                      		pop	ax
 11019 00000277 7506                    		jnz	short NextTest
 11020 00000279 80E4DF                  		and	ah, 0DFh	; ~nopaperstatus
 11021 0000027C 80CC08                  		or	ah, 8		; ioerrstatus
 11022                                  
 11023                                  ; examine the status bits to see if an error occurred. unfortunately, several
 11024                                  ; of the bits are set so we have to pick and choose. we must be extremely
 11025                                  ; careful about breaking basic.
 11026                                  
 11027                                  NextTest:				
 11028 0000027F F6C428                  		test	ah, 28h		; (ioerrstatus+nopaperstatus)
 11029                                  					; i/o error?
 11030 00000282 740A                    		jz	short checknotready ; no, try not ready
 11031                                  
 11032                                  ; at this point, we know we have an error. the converse is not true
 11033                                  
 11034 00000284 B009                    		mov	al, 9		; error_I24_out_of_paper
 11035                                  					; first, assume	out of paper
 11036 00000286 F6C420                  		test	ah, 20h		; out of paper set?
 11037 00000289 7502                    		jnz	short ret1	; yes, error is	set
 11038 0000028B FEC0                    		inc	al		; return al=10 (i/o error)
 11039                                  ret1:					
 11040 0000028D C3                      		retn
 11041                                  ; ---------------------------------------------------------------------------
 11042                                  
 11043                                  checknotready:				
 11044 0000028E B002                    		mov	al, 2		; assume not-ready
 11045 00000290 F6C401                  		test	ah, 1
 11046 00000293 C3                      		retn
 11047                                  
 11048                                  ; ---------------------------------------------------------------------------
 11049                                  
 11050                                  ;************************************************************************
 11051                                  ;*									*
 11052                                  ;*	prn_tilbusy - output until busy. Used by print spooler.		*
 11053                                  ;*		     this entry point should never block waiting for	*
 11054                                  ;*		     device to come ready.				*
 11055                                  ;*									*
 11056                                  ;*	inputs:	cx = count, es:di -> buffer				*
 11057                                  ;*	outputs: set the number of bytes transferred in the		*
 11058                                  ;*		 device driver request packet				*
 11059                                  ;*									*
 11060                                  ;************************************************************************
 11061                                  
 11062                                  		; 19/10/2022
 11063                                  prn_tilbusy:				; 2C7h:28Bh = 70h:27FBh
 11064 00000294 89FE                    		mov	si, di		; everything is	set for	lodsb
 11065                                  prn_tilbloop:				
 11066 00000296 51                      		push	cx
 11067 00000297 53                      		push	bx
 11068 00000298 30FF                    		xor	bh, bh
 11069 0000029A 8A1E[8004]              		mov	bl, [printdev]
 11070 0000029E D1E3                    		shl	bx, 1
 11071                                  		;mov	cx, ds:wait_count[bx] ;	wait count times to come ready
 11072 000002A0 8B8F[8104]              		mov	cx, [wait_count+bx]
 11073 000002A4 5B                      		pop	bx
 11074                                  prn_getstat:				
 11075 000002A5 E8B4FF                  		call	prnstat		; get status
 11076 000002A8 7514                    		jnz	short prn_bperr	; error
 11077 000002AA F6C480                  		test	ah, 80h		; ready	yet?
 11078 000002AD E1F6                    		loope	prn_getstat	; no, go for more
 11079 000002AF 59                      		pop	cx		; get original count
 11080 000002B0 740D                    		jz	short prn_berr	; still	not ready => done
 11081 000002B2 26                      		es
 11082 000002B3 AC                      		lodsb
 11083                                  		;lods	byte ptr es:[si] ; es
 11084                                  					; lodsb
 11085 000002B4 30E4                    		xor	ah, ah
 11086 000002B6 E8A5FF                  		call	prnop
 11087 000002B9 7504                    		jnz	short prn_berr	; error
 11088 000002BB E2D9                    		loop	prn_tilbloop
 11089                                  		; 12/12/2022
 11090                                  		; cf=0 (prnop)
 11091                                  		;clc			; normal no-error return
 11092 000002BD C3                      		retn			;   from device driver
 11093                                  
 11094                                  ; ---------------------------------------------------------------------------
 11095                                  
 11096                                  prn_bperr:				
 11097 000002BE 59                      		pop	cx		; restore transfer count from stack
 11098                                  prn_berr:				
 11099 000002BF E915FE                  		jmp	bc_err_cnt
 11100                                  ; ---------------------------------------------------------------------------
 11101                                  
 11102                                  ; 15/10/2022
 11103                                  
 11104                                  ;************************************************************************
 11105                                  ;*									*
 11106                                  ;*	prn_genioctl - get/set printer retry count			*
 11107                                  ;*									*
 11108                                  ;************************************************************************
 11109                                  
 11110                                  ; IOCTL.INC (MSDOS 6.0, 1991)
 11111                                  ; 11/01/2019
 11112                                  
 11113                                  ;********************************;*
 11114                                  ; CHARACTER DEVICES (PRINTERS)	 ;*
 11115                                  ;********************************;*
 11116                                  
 11117                                  ;;RAWIO SUB-FUNCTIONS
 11118                                  ;;get_retry_count equ 65h
 11119                                  ;;set_retry_count equ 45h
 11120                                  
 11121                                  ;;struc A_RETRYCOUNT
 11122                                  ;;.rc_count: resw 1
 11123                                  ;;endstruc
 11124                                  
 11125                                  ;ioc_pc equ 5
 11126                                  
 11127                                  ; ---------------------------------------------------------------------------
 11128                                  
 11129                                  		; 19/10/2022
 11130                                  prn_genioctl:				; 2C7h:2BAh = 70h:282Ah
 11131 000002C2 C43E[1200]              		les	di, [ptrsav]
 11132 000002C6 26807D0D05              		cmp	byte [es:di+13], 5 ; [es:di+IOCTL_REQ.MAJORFUNCTION]
 11133                                  					; ioc_pc
 11134 000002CB 7403                    		jz	short prnfunc_ok
 11135                                  
 11136                                  prnfuncerr:				
 11137 000002CD E905FE                  		jmp	bc_cmderr
 11138                                  ; ---------------------------------------------------------------------------
 11139                                  
 11140                                  prnfunc_ok:				
 11141 000002D0 268A450E                		mov	al, [es:di+14]	; [es:di+IOCTL_REQ.MINORFUNCTION]
 11142 000002D4 26C47D13                		les	di, [es:di+19]	; [es:di+IOCTL_REQ.GENERICIOCTL_PACKET]
 11143 000002D8 30FF                    		xor	bh, bh
 11144                                  		;mov	bl, ds:printdev	; get index into retry counts
 11145 000002DA 8A1E[8004]              		mov	bl, [printdev]
 11146 000002DE D1E3                    		shl	bx, 1
 11147                                  		;mov	cx, ds:wait_count[bx] ;	pull out retry count for device
 11148 000002E0 8B8F[8104]              		mov	cx, [wait_count+bx]
 11149 000002E4 3C65                    		cmp	al, 65h		; get_retry_count
 11150 000002E6 7407                    		jz	short prngetcount
 11151 000002E8 3C45                    		cmp	al, 45h		; set_retry_count
 11152 000002EA 75E1                    		jnz	short prnfuncerr
 11153 000002EC 268B0D                  		mov	cx, [es:di]
 11154                                  prngetcount:				
 11155                                  		;mov	ds:wait_count[bx], cx
 11156 000002EF 898F[8104]              		mov	[wait_count+bx], cx
 11157 000002F3 26890D                  		mov	[es:di], cx	; [es:di+A_RETRYCOUNT.RC_COUNT]
 11158                                  					; return current retry count
 11159                                  		; 12/12/2022
 11160                                  		; cf=0
 11161                                  		;clc
 11162 000002F6 C3                      		retn
 11163                                  ; ---------------------------------------------------------------------------
 11164                                  
 11165                                  ;************************************************************************
 11166                                  ;*									*
 11167                                  ;*  prn_ioctl_query							*
 11168                                  ;*									*
 11169                                  ;*  Added for 5.00							*
 11170                                  ;************************************************************************
 11171                                  
 11172                                  prn_ioctl_query:			; 2C7h:2F0h = 70h:2860h
 11173 000002F7 C43E[1200]              		les	di, [ptrsav]
 11174 000002FB 26807D0D05              		cmp	byte [es:di+13], 5 ; [es:di+IOCTL_REQ.MAJORFUNCTION]
 11175                                  					; ioc_pc
 11176 00000300 750D                    		jnz	short prn_query_err
 11177 00000302 268A450E                		mov	al, [es:di+14]	; [es:di+IOCTL_REQ.MINORFUNCTION]
 11178 00000306 3C65                    		cmp	al, 65h		; GET_RETRY_COUNT
 11179 00000308 7404                    		jz	short IOCtlSupported
 11180 0000030A 3C45                    		cmp	al, 45h		; SET_RETRY_COUNT
 11181 0000030C 7501                    		jnz	short prn_query_err
 11182                                  IOCtlSupported:	
 11183                                  		; 12/12/2022
 11184                                  		; cf=0		
 11185                                  		;clc
 11186 0000030E C3                      		retn
 11187                                  ; ---------------------------------------------------------------------------
 11188                                  
 11189                                  prn_query_err:
 11190                                  		; 12/12/2022				
 11191                                  		;stc
 11192 0000030F E9C3FD                  		jmp	bc_cmderr ; (bc_cmderr sets cf to 1)
 11193                                  ; ---------------------------------------------------------------------------
 11194                                  
 11195                                  ;************************************************************************
 11196                                  ;*									*
 11197                                  ;*	aux port driver code -- "aux" == "com1"				*
 11198                                  ;*									*
 11199                                  ;*	the device driver entry/dispatch code sets up auxnum to		*
 11200                                  ;*	give the com port number to use (0=com1, 1=com2, 2=com3...)	*
 11201                                  ;*									*
 11202                                  ;************************************************************************
 11203                                  
 11204                                  ;	values in ah, requesting function of int 14h in rom bios
 11205                                  
 11206                                  ;auxfunc_send	 equ	1	;transmit
 11207                                  ;auxfunc_receive equ	2	;read
 11208                                  ;auxfunc_status	 equ	3	;request status
 11209                                  
 11210                                  ;	error flags, reported by int 14h, reported in ah:
 11211                                  
 11212                                  ;flag_data_ready equ	01h	;data ready
 11213                                  ;flag_overrun	 equ	02h	;overrun error
 11214                                  ;flag_parity	 equ	04h	;parity error
 11215                                  ;flag_frame	 equ	08h	;framing error
 11216                                  ;flag_break	 equ	10h	;break detect
 11217                                  ;flag_tranhol_emp equ	20h	;transmit holding register empty
 11218                                  ;flag_timeout	 equ	80h	;timeout
 11219                                  
 11220                                  ;	these flags reported in al:
 11221                                  
 11222                                  ;flag_cts	 equ	10h	;clear to send
 11223                                  ;flag_dsr	 equ	20h	;data set ready
 11224                                  ;flag_rec_sig	 equ	80h	;receive line signal detect
 11225                                  
 11226                                  ; ---------------------------------------------------------------------------
 11227                                  
 11228                                  ;************************************************************************
 11229                                  ;*									*
 11230                                  ;*	aux_read - read cx bytes from [auxnum] aux port to buffer	*
 11231                                  ;*		   at es:di						*
 11232                                  ;*									*
 11233                                  ;************************************************************************
 11234                                  
 11235                                  aux_read:				; 2C7h:30Dh = 70h:287Dh
 11236                                  		;jcxz	short exvec2
 11237 00000312 E311                    		jcxz	exvec2		; 19/10/2022
 11238 00000314 E88000                  		call	getbx		; put address of auxbuf	in bx
 11239 00000317 30C0                    		xor	al, al
 11240 00000319 8607                    		xchg	al, [bx]
 11241 0000031B 08C0                    		or	al, al
 11242 0000031D 7503                    		jnz	short aux2
 11243                                  aux1:					
 11244 0000031F E80500                  		call	auxin		; get character	from port
 11245                                  					; won't return if error
 11246                                  aux2:					
 11247 00000322 AA                      		stosb
 11248 00000323 E2FA                    		loop	aux1		; if more characters, go around	again
 11249                                  exvec2:					
 11250 00000325 F8                      		clc			; all done, successful exit
 11251                                  auxin_retn:	; 18/12/2022
 11252 00000326 C3                      		retn
 11253                                  ; ---------------------------------------------------------------------------
 11254                                  
 11255                                  ;************************************************************************
 11256                                  ;*									*
 11257                                  ;*	auxin - call rom bios to read character from aux port		*
 11258                                  ;*		if error occurs, map the error and return one		*
 11259                                  ;*		level up to device driver exit code, setting		*
 11260                                  ;*		the number of bytes transferred appropriately		*
 11261                                  ;*									*
 11262                                  ;************************************************************************
 11263                                  
 11264                                  auxin:					
 11265 00000327 B402                    		mov	ah, 2		; auxfunc_receive
 11266 00000329 E83A00                  		call	auxop
 11267 0000032C F6C40E                  		test	ah, 0Eh		; flag_frame|flag_parity|flag_overrun
 11268                                  		;jnz	short arbad	; skip if any error bits set
 11269                                  		;retn
 11270                                  		; 25/06/2023 (BugFix)
 11271 0000032F 74F5                    		jz	short auxin_retn
 11272                                  ; ---------------------------------------------------------------------------
 11273                                  
 11274                                  arbad:					
 11275 00000331 58                      		pop	ax		; remove return	address	(near call)
 11276                                  		;xor	al, al
 11277                                  		;or	al, 0B0h	; flag_rec_sig|	flag_dsr|flag_cts
 11278                                  		; 11/08/2023
 11279 00000332 B0B0                    		mov	al, 0B0h	; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0334h
 11280 00000334 E9A0FD                  		jmp	bc_err_cnt
 11281                                  
 11282                                  ; ---------------------------------------------------------------------------
 11283                                  
 11284                                  ;************************************************************************
 11285                                  ;*									*
 11286                                  ;*	aux_rdnd - non-destructive aux port read			*
 11287                                  ;*									*
 11288                                  ;************************************************************************
 11289                                  
 11290                                  aux_rdnd:				; 2C7h:335h = 70h:28A5h
 11291 00000337 E85D00                  		call	getbx
 11292 0000033A 8A07                    		mov	al, [bx]	; have bx point	to auxbuf
 11293 0000033C 08C0                    		or	al, al		; if al	is non-zero (char in buffer)
 11294 0000033E 7511                    		jnz	short auxdrx	; then return character
 11295 00000340 E82100                  		call	auxstat		; if not, get status of	aux device
 11296 00000343 F6C401                  		test	ah, 1		; flag_data_ready - test data ready
 11297 00000346 740C                    		jz	short auxbus	; then device is busy (not ready)
 11298 00000348 A820                    		test	al, 20h		; flag_dsr - test data set ready
 11299 0000034A 7408                    		jz	short auxbus	; then device is busy (not ready)
 11300 0000034C E8D8FF                  		call	auxin		; else aux is ready, get character
 11301 0000034F 8807                    		mov	[bx], al
 11302                                  auxdrx:					
 11303 00000351 E99EFE                  		jmp	rdexit		; return busy status
 11304                                  ; ---------------------------------------------------------------------------
 11305                                  
 11306                                  auxbus:					
 11307 00000354 E970FE                  		jmp	z_bus_exit
 11308                                  ; ---------------------------------------------------------------------------
 11309                                  
 11310                                  ;************************************************************************
 11311                                  ;*									*
 11312                                  ;*	aux_wrst - return aux port write status				*
 11313                                  ;*									*
 11314                                  ;************************************************************************
 11315                                  
 11316                                  aux_wrst:				; 2C7h:355h = 70h:28C5h
 11317 00000357 E80A00                  		call	auxstat		; get status of	aux in ax
 11318 0000035A A820                    		test	al, 20h		; test data set	ready
 11319 0000035C 74F6                    		jz	short auxbus	; then device is busy (not ready)
 11320 0000035E F6C420                  		test	ah, 20h		; flag_tranhol_emp - test transmit hold	reg empty
 11321 00000361 74F1                    		jz	short auxbus	; then device is busy (not ready)
 11322                                  		; 12/12/2022
 11323                                  		; cf=0	; (test instruction resets cf)
 11324                                  		;clc
 11325 00000363 C3                      		retn
 11326                                  ; ---------------------------------------------------------------------------
 11327                                  
 11328                                  ;************************************************************************
 11329                                  ;*									*
 11330                                  ;*	auxstat - call rom bios to determine aux port status		*
 11331                                  ;*									*
 11332                                  ;*	exit:	ax = status						*
 11333                                  ;*		dx = [auxnum]						*
 11334                                  ;*									*
 11335                                  ;************************************************************************
 11336                                  
 11337                                  auxstat:				
 11338 00000364 B403                    		mov	ah, 3		; auxfunc_status
 11339                                  
 11340                                  		; fall into auxop
 11341                                  
 11342                                  ; =============== S U B	R O U T	I N E =======================================
 11343                                  
 11344                                  ;************************************************************************
 11345                                  ;*									*
 11346                                  ;*	auxop - perform rom-biox aux port interrupt			*
 11347                                  ;*									*
 11348                                  ;*	entry:	ah = int 14h function number				*
 11349                                  ;*	exit:	ax = results						*
 11350                                  ;*		dx = [auxnum]						*
 11351                                  ;*									*
 11352                                  ;************************************************************************
 11353                                  
 11354                                  auxop:		; proc near
 11355                                  		; 20/12/2023 - Retro DOS v5.0
 11356                                  		;mov	dx, [auxnum]	; ah=function code
 11357                                  		;			; 0=init, 1=send, 2=receive, 3=status
 11358                                  		;			; get port number
 11359                                  		;
 11360                                  		;int	14h		; SERIAL I/O - GET USART STATUS
 11361                                  		;			; DX = port number (0-3)
 11362                                  		;			; Return: AX = port status code
 11363                                  		; (PCDOS 7.1 IBMBIO.COM)
 11364 00000366 1E                      		push	ds
 11365 00000367 FF36[2100]              		push	word [auxnum]
 11366 0000036B 31D2                    		xor	dx, dx ; 0
 11367 0000036D 8EDA                    		mov	ds, dx
 11368 0000036F 5A                      		pop	dx
 11369 00000370 9C                      		pushf			; simulate INT 14h
 11370 00000371 FA                      		cli
 11371                                  		;call	dword ptr ds:50h
 11372 00000372 FF1E5000                		call	far [14h*4]	; INT 14h vector (14h*4 = 50h)
 11373 00000376 1F                      		pop	ds
 11374                                  
 11375 00000377 C3                      		retn
 11376                                  
 11377                                  ; ---------------------------------------------------------------------------
 11378                                  
 11379                                  ;************************************************************************
 11380                                  ;*									*
 11381                                  ;*	aux_flsh - flush aux input buffer - set contents of		*
 11382                                  ;*		   auxbuf [auxnum] to zero				*
 11383                                  ;*									*
 11384                                  ;*	cas - shouldn't this code call the rom bios input function	*
 11385                                  ;*	      repeatedly until it isn't ready?  to flush out any	*
 11386                                  ;*	      pending serial input queue if there's a tsr like MODE	*
 11387                                  ;*	      which is providing interrupt-buffering of aux port?	*
 11388                                  ;*									*
 11389                                  ;************************************************************************
 11390                                  
 11391                                  aux_flsh:				; 2C7h:36Ch = 70h:28DCh
 11392 00000378 E81C00                  		call	getbx		; flush	aux input buffer
 11393 0000037B C60700                  		mov	byte [bx], 0	; get bx to point to auxbuf
 11394                                  					; zero out buffer
 11395                                  		;clc			; all done, successful return
 11396                                  		; 12/12/2022
 11397                                  		; cf=0 ('add' instruction in 'getbx')
 11398 0000037E C3                      		retn
 11399                                  ; ---------------------------------------------------------------------------
 11400                                  
 11401                                  ;************************************************************************
 11402                                  ;*									*
 11403                                  ;*	aux_writ - write to aux device					*
 11404                                  ;*									*
 11405                                  ;************************************************************************
 11406                                  
 11407                                  aux_writ:				; 2C7h:374h = 70h:28E4h
 11408                                  		;jcxz	short exvec2	; write	to aux device (if cx > 0)
 11409 0000037F E3A4                    		jcxz	exvec2		; 19/10/2022
 11410                                  aux_loop:				
 11411 00000381 268A05                  		mov	al, [es:di]	; get character	to be written
 11412                                  					; move di pointer to next character
 11413 00000384 47                      		inc	di
 11414 00000385 B401                    		mov	ah, 1		; auxfunc_send - indicates a write
 11415 00000387 E8DCFF                  		call	auxop		; send character over aux port
 11416 0000038A F6C480                  		test	ah, 80h		; check	for error
 11417 0000038D 7405                    		jz	short awok	; then no error
 11418 0000038F B00A                    		mov	al, 10		; else indicate	write fault
 11419 00000391 E943FD                  		jmp	bc_err_cnt	; call error routines
 11420                                  ; ---------------------------------------------------------------------------
 11421                                  
 11422                                  awok:					
 11423 00000394 E2EB                    		loop	aux_loop	; if cx	is non-zero,
 11424                                  					; still	more character to print
 11425                                  		;clc			; all done, successful return
 11426                                  		; 12/12/2022
 11427                                  		; cf=0 (test instruction above)	
 11428 00000396 C3                      		retn
 11429                                  
 11430                                  ; =============== S U B	R O U T	I N E =======================================
 11431                                  
 11432                                  ;************************************************************************
 11433                                  ;*									*
 11434                                  ;*	getbx - return bx -> single byte input buffer for		*
 11435                                  ;*		selected aux port ([auxnum])				*
 11436                                  ;*									*
 11437                                  ;************************************************************************
 11438                                  
 11439                                  getbx:	
 11440 00000397 8B1E[2100]              		mov	bx, [auxnum]	; return bx -> single byte input buffer
 11441                                  					; for selected aux port	([auxnum])
 11442                                  		;add	bx, offset auxbuf
 11443 0000039B 81C3[1600]              		add	bx, auxbuf	; 19/10/2022
 11444                                  		; 12/12/2022
 11445                                  		; cf=0 (if [auxnum] is valid number) 
 11446 0000039F C3                      		retn
 11447                                  
 11448                                  ; ---------------------------------------------------------------------------
 11449                                  
 11450                                  ; 15/10/2022
 11451                                  
 11452                                  ;----------------------------------------------------------------
 11453                                  ;								:
 11454                                  ;		    clock device driver 			:
 11455                                  ;								:
 11456                                  ;								:
 11457                                  ;   this file contains the clock device driver. 		:
 11458                                  ;								:
 11459                                  ;   the routines in this files are:				:
 11460                                  ;								:
 11461                                  ;	routine 		function			:
 11462                                  ;	------- 		--------			:
 11463                                  ;	tim_writ		set the current time		:
 11464                                  ;	tim_read		read the current time		:
 11465                                  ;	time_to_ticks		convert time to corresponding	:
 11466                                  ;				  number of clock ticks 	:
 11467                                  ;								:
 11468                                  ; the clock ticks at the rate of:				:
 11469                                  ;								:
 11470                                  ;	1193180/65536 ticks/second (about 18.2 ticks per second):
 11471                                  ; see each routine for information on the use.			:
 11472                                  ;								:
 11473                                  ;----------------------------------------------------------------
 11474                                  
 11475                                  ; convert time to ticks
 11476                                  ; input : time in cx and dx
 11477                                  ; ticks returned in cx:dx
 11478                                  
 11479                                  ;19/07/2019
 11480                                  ;09/03/2019
 11481                                  
 11482                                  time_to_ticks:				; 0070h:2906h =	02C7h:0396h
 11483                                  
 11484                                  ; first convert from hour,min,sec,hund. to
 11485                                  ; total number of 100th of seconds
 11486                                  
 11487 000003A0 B03C                    		mov	al, 60
 11488 000003A2 F6E5                    		mul	ch		; hours	to minutes
 11489 000003A4 B500                    		mov	ch, 0
 11490 000003A6 01C8                    		add	ax, cx		; total	minutes
 11491 000003A8 B97017                  		mov	cx, 6000	; 60*100
 11492 000003AB 89D3                    		mov	bx, dx		; get out of the way of	the multiply
 11493 000003AD F7E1                    		mul	cx		; convert to 1/100 sec
 11494 000003AF 89C1                    		mov	cx, ax
 11495 000003B1 B064                    		mov	al, 100
 11496 000003B3 F6E7                    		mul	bh		; convert seconds to 1/100 sec
 11497 000003B5 01C1                    		add	cx, ax		; combine seconds with hours and min
 11498 000003B7 83D200                  		adc	dx, 0		; ripple carry
 11499 000003BA B700                    		mov	bh, 0
 11500 000003BC 01D9                    		add	cx, bx		; combine 1/100	sec
 11501 000003BE 83D200                  		adc	dx, 0
 11502                                  
 11503                                  	; dx:cx is time in 1/100 sec
 11504                                  
 11505 000003C1 92                      		xchg	ax, dx
 11506 000003C2 91                      		xchg	ax, cx		; now time is in cx:ax
 11507 000003C3 BB0BE9                  		mov	bx, 59659
 11508 000003C6 F7E3                    		mul	bx		; multiply low half
 11509 000003C8 87D1                    		xchg	dx, cx
 11510 000003CA 92                      		xchg	ax, dx		; cx->ax, ax->dx, dx->cx
 11511 000003CB F7E3                    		mul	bx		; multiply high	half
 11512 000003CD 01C8                    		add	ax, cx		; combine overlapping products
 11513 000003CF 83D200                  		adc	dx, 0
 11514 000003D2 92                      		xchg	ax, dx		; ax:dx=time*59659
 11515 000003D3 BB0500                  		mov	bx, 5
 11516 000003D6 F6F3                    		div	bl		; divide high half by 5
 11517 000003D8 88C1                    		mov	cl, al
 11518 000003DA B500                    		mov	ch, 0
 11519 000003DC 88E0                    		mov	al, ah		; remainder of divide-by-5
 11520 000003DE 98                      		cbw
 11521 000003DF 92                      		xchg	ax, dx		; use it to extend low half
 11522 000003E0 F7F3                    		div	bx		; divide low half by 5
 11523 000003E2 89C2                    		mov	dx, ax		; cx:dx	is now number of ticks in time
 11524 000003E4 CB                      		retf			; far return
 11525                                  
 11526                                  ; ---------------------------------------------------------------------------
 11527                                  
 11528                                  ; 17/10/2022
 11529                                  ; 15/10/2022
 11530                                  
 11531                                  ;--------------------------------------------------------------------
 11532                                  ;
 11533                                  ; tim_writ sets the current time
 11534                                  ;
 11535                                  ; on entry es:[di] has the current time:
 11536                                  ;
 11537                                  ;	number of days since 1-1-80	(word)
 11538                                  ;	minutes (0-59)			(byte)
 11539                                  ;	hours (0-23)			(byte)
 11540                                  ;	hundredths of seconds (0-99)	(byte)
 11541                                  ;	seconds (0-59)			(byte)
 11542                                  ;
 11543                                  ; each number has been checked for the correct range.
 11544                                  ;
 11545                                  ;	NOTE: Any changes in this routine probably require corresponding
 11546                                  ;	changes in the version that is built with the power manager driver.
 11547                                  ;	See ptime.asm.
 11548                                  ;
 11549                                  ;--------------------------------------------------------------------
 11550                                  
 11551                                  	; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 11552                                  	; PCDOS 7.1 IBMBIO.COM - BIOSCODE:03EAh
 11553                                  tim_writ:				; 2C7h:3DBh = 70h:294Bh
 11554 000003E5 268B05                  		mov	ax, [es:di]
 11555 000003E8 50                      		push	ax		; daycnt. we need to set this at the very
 11556                                  					; end to avoid tick windows.
 11557 000003E9 803E[8C04]00            		cmp	byte [havecmosclock], 0
 11558                                  		;cmp	ds:havecmosclock, 0
 11559 000003EE 7423                    		jz	short no_cmos_1
 11560 000003F0 268A4503                		mov	al, [es:di+3]	; near indirect	calls
 11561                                  					; get binary hours
 11562                                  					; convert to bcd
 11563                                  		;call	far [bintobcd]
 11564                                  		;;call	ds:bintobcd	; call far [bintobcd]
 11565                                  		; 08/08/2023
 11566 000003F4 E8E800                  		call	bintobcd
 11567 000003F7 88C5                    		mov	ch, al		; ch = bcd hours
 11568 000003F9 268A4502                		mov	al, [es:di+2]	; get binary minutes
 11569                                  		;call	far [bintobcd]
 11570                                  		;;call	ds:bintobcd	; convert to bcd
 11571 000003FD E8DF00                  		call	bintobcd
 11572 00000400 88C1                    		mov	cl, al		; cl = bcd minutes
 11573 00000402 268A4505                		mov	al, [es:di+5]	; get binary seconds
 11574                                  		;call	far [bintobcd]
 11575                                  		;;call	ds:bintobcd
 11576 00000406 E8D600                  		call	bintobcd
 11577                                  
 11578 00000409 88C6                    		mov	dh, al		; dh = bcd seconds
 11579 0000040B B200                    		mov	dl, 0		; dl = 0 (st) or 1 (dst)
 11580 0000040D FA                      		cli
 11581 0000040E B403                    		mov	ah, 3
 11582 00000410 CD1A                    		int	1Ah		; CLOCK	- SET REAL TIME	CLOCK (AT,XT286,CONV,PS)
 11583                                  					; CH = hours in	BCD, CL	= minutes in BCD
 11584                                  					;  DH =	seconds	in BCD,DL = 01h	if daylight savings, 00h if standard time
 11585                                  					; Return: CMOS clock set
 11586 00000412 FB                      		sti
 11587                                  no_cmos_1:				
 11588 00000413 268B4D02                		mov	cx, [es:di+2]
 11589 00000417 268B5504                		mov	dx, [es:di+4]
 11590                                  		; 17/10/2022
 11591 0000041B FF1E[0606]              		call	far [ttticks]
 11592                                  		;call	dword ptr ds:ttticks ; call far	[ttticks]
 11593                                  					; convert time to ticks
 11594                                  					; cx:dx	now has	time in	ticks
 11595 0000041F FA                      		cli			; turn off timer
 11596 00000420 B401                    		mov	ah, 1
 11597 00000422 CD1A                    		int	1Ah		; CLOCK	- SET TIME OF DAY
 11598                                  					; CX:DX	= clock	count
 11599                                  					; Return: time of day set
 11600                                  		;pop	ds:daycnt
 11601 00000424 8F06[8904]              		pop	word [daycnt]
 11602 00000428 FB                      		sti
 11603                                  		;cmp	ds:havecmosclock, 0
 11604 00000429 803E[8C04]00            		cmp	byte [havecmosclock], 0
 11605 0000042E 7409                    		jz	short no_cmos_2
 11606                                  
 11607                                  		; 08/08/2023
 11608                                  		;call	far [daycnttoday]
 11609                                  		;;call	ds:daycnttoday	; call far [daycnttoday]
 11610                                  					; convert to bcd format
 11611 00000430 E80700                  		call	daycnttoday
 11612                                  
 11613 00000433 FA                      		cli
 11614 00000434 B405                    		mov	ah, 5
 11615 00000436 CD1A                    		int	1Ah		; CLOCK	- SET DATE IN REAL TIME	CLOCK (AT,XT286,CONV,PS)
 11616                                  					; DL = day in BCD, DH =	month in BCD, CL = year	in BCD
 11617                                  					; CH = century (19h or 20h)
 11618                                  					; Return: CMOS clock set
 11619 00000438 FB                      		sti
 11620                                  no_cmos_2:
 11621                                  		; 12/12/2022
 11622                                  		; cf=0
 11623                                  		;clc
 11624 00000439 C3                      		retn
 11625                                  
 11626                                  ; ---------------------------------------------------------------------------
 11627                                  
 11628                                  ; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 11629                                  ; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0440h
 11630                                  %if 1 
 11631                                  
 11632                                  ; CMOS Clock setting support routines used by MSCLOCK.
 11633                                  ; Warning!!! This code will be dynamically relocated by MSINIT.
 11634                                  
 11635                                  daycnttoday:	; proc near
 11636                                  
 11637                                  ; entry: [daycnt] = number of days since 1-1-80
 11638                                  ;
 11639                                  ; return: ch - century in bcd
 11640                                  ;	  cl - year in bcd
 11641                                  ;	  dh - month in bcd
 11642                                  ;	  dl - day in bcd
 11643                                  
 11644                                  		; 20/12/2023 - Retro DOS v5.0
 11645                                  
 11646                                  		; 08/08/2023 (ds:) (near proc)
 11647                                  		; 16/10/2022 (cs:) (far proc)		
 11648 0000043A FF36[8904]              		push	word [daycnt] ; save daycnt
 11649 0000043E 813E[8904]891C          		cmp	word [daycnt], 7305 ; (365*20+(20/4))
 11650                                  					; # days from 1-1-1980 to 1-1-2000
 11651 00000444 7308                    		jnb	short century20
 11652                                  		;mov	byte [base_century], 19
 11653                                  		;mov	byte [base_year], 80
 11654                                  		; 08/08/2023
 11655 00000446 C706[8D04]1350          		mov	word [base_century], 5013h
 11656 0000044C EB0C                    		jmp	short years
 11657                                  ; ----------------------------------------------------------------------------
 11658                                  		
 11659                                  century20:				
 11660                                  		;mov	byte [base_century], 20
 11661                                  		;mov	byte [base_year], 0
 11662                                  		; 08/08/2023
 11663 0000044E C706[8D04]1400          		mov	word [base_century], 20
 11664 00000454 812E[8904]891C          		sub	word [daycnt], 7305 ; (365*20+(20/4))
 11665                                  					; adjust daycnt
 11666                                  years:					
 11667 0000045A 31D2                    		xor	dx, dx
 11668 0000045C A1[8904]                		mov	ax, [daycnt]
 11669 0000045F BBB505                  		mov	bx, 1461	; (366+365*3)
 11670                                  					; # of days in a Leap year block
 11671 00000462 F7F3                    		div	bx		; AX = # of leap block,	DX = daycnt
 11672 00000464 8916[8904]              		mov	[daycnt], dx	; save daycnt left
 11673 00000468 B304                    		mov	bl, 4
 11674 0000046A F6E3                    		mul	bl		; AX = # of years. Less	than 100
 11675 0000046C 0006[8E04]              		add	[base_year], al ; So, ah = 0. Adjust year
 11676 00000470 FF06[8904]              		inc	word [daycnt]	; set daycnt to	1 base
 11677                                  		; 08/08/2023
 11678 00000474 BB6E01                  		mov	bx, 366
 11679 00000477 B90300                  		mov	cx, 3
 11680                                  		;cmp	word [daycnt], 366 ; daycnt=remainder of leap year
 11681 0000047A 391E[8904]              		cmp	[daycnt], bx ; 366
 11682 0000047E 7619                    		jbe	short leapyear	; within 366+355+355+355 days.
 11683 00000480 FE06[8E04]              		inc	byte [base_year] ; if daycnt <= 366, then leap year
 11684                                  		;sub	word [daycnt], 366 ; else daycnt--, base_year++ ;
 11685 00000484 291E[8904]              		sub	[daycnt], bx ; 366 ; 08/08/2023
 11686                                  		;mov	cx, 3		; And next three years are normal
 11687                                  		; 08/08/2023
 11688 00000488 4B                      		dec	bx ; 365
 11689                                  regularyear:	; 20/12/2023
 11690                                  		;cmp	word [daycnt], 365 ; for(i=1; i>3 or daycnt <=365; i++)
 11691 00000489 391E[8904]              		cmp	[daycnt], bx ; 365 ; 08/08/2023
 11692 0000048D 760F                    		jbe	short yeardone	; {if (daycnt >	365)
 11693 0000048F FE06[8E04]              		inc	byte [base_year] ; { daycnt -=	365
 11694                                  		;sub	word [daycnt], 365 ; }
 11695 00000493 291E[8904]              		sub	[daycnt], bx ; 365 ; 08/08/2023
 11696 00000497 E2F0                    		loop	regularyear	; }
 11697                                  					;
 11698                                  					; should never fall through loop
 11699                                  leapyear:	
 11700 00000499 C606[9004]1D            		mov	byte [february], 29 ; 08/08/2023			
 11701                                  		;mov	byte [month_tab+1], 29 ; leap year.
 11702                                  					; change month table.
 11703                                  yeardone:				
 11704 0000049E 31DB                    		xor	bx, bx
 11705 000004A0 31D2                    		xor	dx, dx
 11706 000004A2 A1[8904]                		mov	ax, [daycnt]
 11707                                  		;mov	si, offset month_tab
 11708 000004A5 BE[8F04]                		mov	si, month_tab	; 19/10/2022
 11709                                  		;mov	cx, 12
 11710                                  		; 08/08/2023
 11711 000004A8 B10C                    		mov	cl, 12
 11712                                  months:					
 11713 000004AA FEC3                    		inc	bl
 11714                                  		; 08/08/2023
 11715 000004AC 8A14                    		mov	dl, [si]	; PCDOS 7.1 IBMBIO.COM - BIOSCODE:04B7h
 11716 000004AE 39D0                    		cmp	ax, dx		; cmp daycnt for each month till fit
 11717                                  					; dh=0
 11718 000004B0 7605                    		jbe	short month_done
 11719 000004B2 46                      		inc	si		; next month
 11720 000004B3 29D0                    		sub	ax, dx		; adjust daycnt
 11721 000004B5 E2F3                    		loop	months		;
 11722                                  					; should never fall through loop
 11723                                  month_done:	
 11724 000004B7 C606[9004]1C            		mov	byte [february], 28 ; 08/08/2023
 11725                                  		;mov	byte [month_tab+1], 28
 11726                                  					; restore month table value
 11727 000004BC 88DA                    		mov	dl, bl
 11728 000004BE 8A36[8E04]              		mov	dh, [base_year]
 11729 000004C2 8A0E[8D04]              		mov	cl, [base_century] ; al=day,dl=month,dh=year,cl=cntry
 11730 000004C6 E81600                  		call	bintobcd	; convert "day"	to bcd
 11731                                  					; dl = bcd day,	al = month
 11732 000004C9 86D0                    		xchg	dl, al
 11733 000004CB E81100                  		call	bintobcd	; dh = bcd month, al = year
 11734 000004CE 86F0                    		xchg	dh, al
 11735 000004D0 E80C00                  		call	bintobcd	; cl = bcd year, al = century
 11736 000004D3 86C8                    		xchg	cl, al
 11737 000004D5 E80700                  		call	bintobcd	; ch = bcd century
 11738 000004D8 88C5                    		mov	ch, al
 11739 000004DA 8F06[8904]              		pop	word [daycnt] ; restore original value
 11740 000004DE C3                      		retn
 11741                                  
 11742                                  ;----------------------------------------------------------------------------
 11743                                  
 11744                                  bintobcd:	; proc near		; real time clock support
 11745                                  
 11746                                  ;convert a binary input in al (less than 63h or 99 decimal)
 11747                                  ;into a bcd value in al. ah destroyed.	
 11748                                  		
 11749 000004DF D40A                    		aam			; AH = AL/10, AL = AL MOD 10
 11750 000004E1 D510                    		aad     10h             ; db 0D5h,10h
 11751                                  					; AL = (AH*10H)+AL, AH = 0
 11752 000004E3 C3                      		retn
 11753                                  %endif
 11754                                  
 11755                                  ;----------------------------------------------------------------------------
 11756                                  
 11757                                  ; 15/10/2022
 11758                                  
 11759                                  ;----------------------------------------------------------------------------
 11760                                  ; gettime reads date and time
 11761                                  ; and returns the following information:
 11762                                  ;
 11763                                  ;	es:[di]  =count of days since 1-1-80
 11764                                  ;	es:[di+2]=hours
 11765                                  ;	es:[di+3]=minutes
 11766                                  ;	es:[di+4]=seconds
 11767                                  ;	es:[di+5]=hundredths of seconds
 11768                                  ;
 11769                                  ;	NOTE: Any changes in this routine probably require corresponding
 11770                                  ;	changes in the version that is built with the power manager driver.
 11771                                  ;	See ptime.asm.
 11772                                  ;----------------------------------------------------------------------------
 11773                                  
 11774                                  tim_read:				; 2C7h:435h = 70h:29A5h
 11775 000004E4 E84A00                  		call	GetTickCnt
 11776 000004E7 8B36[8904]              		mov	si, [daycnt]
 11777                                  
 11778                                  ; we now need to convert the time in tick to the time in 100th of
 11779                                  ; seconds. the relation between tick and seconds is:
 11780                                  ;
 11781                                  ;		 65,536 seconds
 11782                                  ;	       ----------------
 11783                                  ;		1,193,180 tick
 11784                                  ;
 11785                                  ; to get to 100th of second we need to multiply by 100. the equation is:
 11786                                  ;
 11787                                  ;	ticks from clock  * 65,536 * 100
 11788                                  ;      --------------------------------- = time in 100th of seconds
 11789                                  ;		1,193,180
 11790                                  ;
 11791                                  ; fortunately this formula simplifies to:
 11792                                  ;
 11793                                  ;	ticks from clock * 5 * 65,536
 11794                                  ;      --------------------------------- = time in 100th of seconds
 11795                                  ;		59,659
 11796                                  ;
 11797                                  ; the calculation is done by first multipling tick by 5. next we divide by
 11798                                  ; 59,659. in this division we multiply by 65,536 by shifting the dividend
 11799                                  ; my 16 bits to the left.
 11800                                  ;
 11801                                  ; start with ticks in cx:dx
 11802                                  ; multiply by 5
 11803                                  
 11804 000004EB 89C8                    		mov	ax, cx
 11805 000004ED 89D3                    		mov	bx, dx		; start	with ticks in cx:dx
 11806                                  					; multiply by 5
 11807 000004EF D1E2                    		shl	dx, 1
 11808 000004F1 D1D1                    		rcl	cx, 1		; times	2
 11809 000004F3 D1E2                    		shl	dx, 1
 11810 000004F5 D1D1                    		rcl	cx, 1		; times	4
 11811 000004F7 01DA                    		add	dx, bx
 11812 000004F9 11C8                    		adc	ax, cx		; times	5
 11813 000004FB 92                      		xchg	ax, dx
 11814                                  
 11815                                  ; now have ticks * 5 in	dx:ax
 11816                                  ; we now need to multiply by 65536 and divide by 59659 d.
 11817                                  
 11818 000004FC B90BE9                  		mov	cx, 59659	; get divisor
 11819 000004FF F7F1                    		div	cx		; dx now has remainder
 11820                                  					; ax has high word of final quotient
 11821                                  
 11822                                  		; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 11823                                  		;mov	bx, ax		; put high word	in safe	place
 11824 00000501 93                      		xchg	bx, ax
 11825 00000502 31C0                    		xor	ax, ax		; this is the multiply by 65536
 11826 00000504 F7F1                    		div	cx		; bx:ax	now has	time in	100th of seconds
 11827                                  
 11828                                  ; rounding based on the	remainder may be added here
 11829                                  ; the result in	bx:ax is time in 1/100 second.
 11830                                  
 11831 00000506 89DA                    		mov	dx, bx		
 11832 00000508 B9C800                  		mov	cx, 200		; extract 1/100's
 11833                                  
 11834                                  ; division by 200 is necessary to ensure no overflow--max result
 11835                                  ; is number of seconds in a day/2 = 43200.
 11836                                  
 11837 0000050B F7F1                    		div	cx
 11838 0000050D 80FA64                  		cmp	dl, 100		; remainder over 100?
 11839 00000510 7203                    		jb	short noadj
 11840 00000512 80EA64                  		sub	dl, 100		; keep 1/100's less than 100
 11841                                  noadj:					
 11842 00000515 F5                      		cmc			; if we	subtracted 100,	carry is now set
 11843 00000516 88D3                    		mov	bl, dl		; save 1/100's
 11844                                  
 11845                                  ; to compensate	for dividing by	200 instead of 100, we now multiply
 11846                                  ; by two, shifting a one in if the remainder had exceeded 100.
 11847                                  
 11848 00000518 D1D0                    		rcl	ax, 1		
 11849 0000051A B200                    		mov	dl, 0
 11850 0000051C D1D2                    		rcl	dx, 1
 11851                                  		;mov	cx, 60		; divide out seconds
 11852                                  		; 20/12/2023
 11853 0000051E B13C                    		mov	cl, 60
 11854 00000520 F7F1                    		div	cx
 11855 00000522 88D7                    		mov	bh, dl		; save the seconds
 11856 00000524 F6F1                    		div	cl		; break	into hours and minutes
 11857 00000526 86C4                    		xchg	al, ah
 11858                                  
 11859                                  ; time is now in ax:bx (hours, minutes, seconds, 1/100 sec)
 11860                                  
 11861                                  		; 08/08/2023
 11862                                  		;push	ax
 11863                                  		;mov	ax, si		; daycnt
 11864 00000528 96                      		xchg	ax, si
 11865 00000529 AB                      		stosw
 11866                                  		;pop	ax
 11867 0000052A 96                      		xchg	ax, si		; al = hours, ah = minutes
 11868 0000052B AB                      		stosw
 11869 0000052C 89D8                    		mov	ax, bx
 11870 0000052E AB                      		stosw
 11871 0000052F F8                      		clc			; [es:di] = count of days since 1-1-80
 11872                                  					;   [es:di+2] = hours
 11873                                  					;   [es:di+3] = minutes
 11874                                  					;   [es:di+4] = seconds
 11875                                  					;   [es:di+5] = hundredths of seconds
 11876 00000530 C3                      		retn
 11877                                  
 11878                                  ; =============== S U B	R O U T	I N E =======================================
 11879                                  
 11880                                  ; 15/10/2022
 11881                                  
 11882                                  ;----------------------------------------------------------------------------
 11883                                  ;
 11884                                  ; procedure : GetTickCnt
 11885                                  ;
 11886                                  ;		Returns the tick count in CX:DX. Takes care of DayCnt in case
 11887                                  ;		of rollover [except when power management driver is in use]. 
 11888                                  ;		Uses the following logic for updating Daycnt
 11889                                  ;
 11890                                  ;		if ( rollover ) {
 11891                                  ;			if ( t_switch )
 11892                                  ;				daycnt++ ;
 11893                                  ;			else
 11894                                  ;				daycnt += rollover ;
 11895                                  ;		}
 11896                                  ;
 11897                                  ; USES : AX
 11898                                  ;
 11899                                  ; RETURNS : CX:DX - tick count
 11900                                  ; MODIFIES : daycnt
 11901                                  ;
 11902                                  ;----------------------------------------------------------------------------
 11903                                  
 11904                                  		; 17/10/2022
 11905                                  GetTickCnt:
 11906 00000531 30E4                    		xor	ah, ah
 11907 00000533 CD1A                    		int	1Ah		; CLOCK	- GET TIME OF DAY
 11908                                  					; Return: CX:DX	= clock	count
 11909                                  					; AL = 00h if clock was	read or	written	(via AH=0,1) since the previous
 11910                                  					; midnight
 11911                                  					; Otherwise, AL	> 0
 11912                                  		; 20/12/2023
 11913 00000535 30E4                    		xor	ah, ah
 11914 00000537 3826[8B04]              		cmp	byte [t_switch], ah ; 0
 11915                                  		;cmp	byte [t_switch], 0 ; use old method ? (>0 is yes)
 11916 0000053B 7505                    		jnz	short inc_case	; old method assumes that Int 1Ah returns rollover flag
 11917                                  		;xor	ah, ah		; new method assumes that Int 1Ah returns roll over count
 11918                                  					; and not flag
 11919 0000053D 0106[8904]              		add	[daycnt], ax
 11920 00000541 C3                      		retn
 11921                                  ; ---------------------------------------------------------------------------
 11922                                  
 11923                                  inc_case:
 11924 00000542 08C0                    		or	al, al
 11925 00000544 7404                    		jz	short no_rollover
 11926 00000546 FF06[8904]              		inc	word [daycnt]
 11927                                  no_rollover:
 11928 0000054A C3                      		retn
 11929                                  
 11930                                  ; ---------------------------------------------------------------------------
 11931                                  ; ---------------------------------------------------------------------------
 11932                                  ; 03/10/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
 11933                                  ; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0556h
 11934                                  
 11935                                  %if 1
 11936                                  
 11937 0000054B 4641543132202020        fat_12_id:	db 'FAT12   '
 11938 00000553 4641543136202020        fat_16_id:	db 'FAT16   '
 11939 0000055B 4641543332202020        fat_32_id:	db 'FAT32   '
 11940 00000563 4E4F204E414D452020-     nul_vid:	db 'NO NAME    '
 11940 0000056C 2020               
 11941                                  
 11942                                  %endif
 11943                                  
 11944                                  ; ---------------------------------------------------------------------------
 11945                                  
 11946                                  ;----------------------------------------------------------------------------
 11947                                  ; MSDISK.ASM - MSDOS 6.0 - 1991
 11948                                  ;----------------------------------------------------------------------------
 11949                                  ; 15/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 11950                                  ; 09/03/2019 - Retro DOS v4.0
 11951                                  
 11952                                  ; MSDISK.ASM - MSDOS 3.3 - 02/02/1988
 11953                                  ; 26/05/2018 - Retro DOS v3.0
 11954                                  ; 23/03/2018 - Retro DOS v2.0
 11955                                  
 11956                                  ;error_unknown_media equ	7	; for use in BUILD BPB call
 11957                                  
 11958                                  ;struc BPB_TYPE
 11959                                  ;.SECSIZE:	resw 1
 11960                                  ;.SECALL:	resb 1
 11961                                  ;.RESNUM:	resw 1
 11962                                  ;.FATNUM:	resb 1
 11963                                  ;.DIRNUM:	resw 1
 11964                                  ;.SECNUM:	resw 1
 11965                                  ;.FATID:	resb 1
 11966                                  ;.FATSIZE:	resw 1
 11967                                  ;.SLIM:		resw 1
 11968                                  ;.HLIM:		resw 1
 11969                                  ;.HIDDEN:	resw 1
 11970                                  ;.size:
 11971                                  ;endstruc
 11972                                  
 11973                                  ;-----------------------------------------------------------------
 11974                                  ;	disk interface routines
 11975                                  ;-----------------------------------------------------------------
 11976                                  
 11977                                  ; device attribute bits:
 11978                                  ;	bit 6 - get/set map for logical drives and generic ioctl.
 11979                                  
 11980                                  ;MAXERR		equ	5
 11981                                  ;MAX_HD_FMT_ERR	equ	2
 11982                                  
 11983                                  ;LSTDRV	equ 504h
 11984                                  
 11985                                  ; some floppies do not have changeline. as a result, media-check would
 11986                                  ; normally return i-don't-know, the dos would continually reread the fat and
 11987                                  ; discard cached data. we optimize this by implementing a logical door-latch:
 11988                                  ; it is physically impossible to change a disk in under 2 seconds. we retain
 11989                                  ; the time of the last successful disk operation and compare it with the current
 11990                                  ; time during media-check. if < 2 seconds and at least 1 timer tick has passed,
 11991                                  ; the we say no change. if > 2 seconds then we say i-don't-know. finally, 
 11992                                  ; since we cannot trust the timer to be always available, we record the number 
 11993                                  ; of media checks that have occurred when no apparent time has elapsed. while
 11994                                  ; this number is < a given threshold, we say no change. when it exceeds that
 11995                                  ; threshold, we say i-don't-know and reset the counter to 0. when we store 
 11996                                  ; the time of last successful access, if we see that time has passed too,
 11997                                  ; we reset the counter.
 11998                                  
 11999                                  accessmax	equ	5
 12000                                  
 12001                                  ; due to various bogosities, we need to continually adjust what the head
 12002                                  ; settle time is.  the following algorithm is used:
 12003                                  ;
 12004                                  ;   get the current head settle value.
 12005                                  ;   if it is 0, then
 12006                                  ;	set slow = 15
 12007                                  ;   else
 12008                                  ;	set slow = value
 12009                                  ;   ...
 12010                                  ;*********************************************
 12011                                  ;************ old algorithm ******************
 12012                                  ;*   if we are seeking and writing then
 12013                                  ;*	 use slow
 12014                                  ;*   else
 12015                                  ;*	 use fast
 12016                                  ;*********************************************
 12017                                  ;*********** ibm's requested logic ***********
 12018                                  ;   if we are seeking and writing and not on an at then
 12019                                  ;	use slow
 12020                                  ;   else
 12021                                  ;	use fast
 12022                                  ;   ...
 12023                                  ;   restore current head settle value
 12024                                  ;
 12025                                  ;
 12026                                  ;---------------------------------------
 12027                                  multrk_on	equ	10000000b	;user spcified mutitrack=on, or system turns
 12028                                  					; it on after handling config.sys file as a
 12029                                  					; default value, if multrk_flag = multrk_off1.
 12030                                  multrk_off1	equ	00000000b	;initial value. no "multitrack=" command entered.
 12031                                  multrk_off2	equ	00000001b	;user specified multitrack=off.
 12032                                  
 12033                                  ; close data segment, open Bios_Code segment
 12034                                  
 12035                                  ; 15/10/2022
 12036                                  
 12037                                  ; BIOSCODE:04A2h (MSDOS 6.21, IO.SYS)
 12038                                  
 12039                                  ;-----------------------------------------------------------------
 12040                                  ;	command jump table
 12041                                  ;-----------------------------------------------------------------
 12042                                  
 12043 0000056E 00                      		db 0
 12044                                  ; 11/12/2022
 12045                                  %if 0
 12046                                  
 12047                                  dsktbl:		db 26			; 2C7h:4A2h = 70h:2A12h
 12048                                  					; ((dtbl_siz-1)/2) ; this is the size of the table ; 26
 12049                                  		dw 1742h		; dsk_init
 12050                                  		dw 4EBh			; media_chk
 12051                                  		dw 592h			; get_bpb
 12052                                  		dw 0D5h			; bc_cmderr
 12053                                  		dw 857h			; dsk_read
 12054                                  		dw 83Dh			; x_bus_exit
 12055                                  		dw 558h			; ret_carry_clear
 12056                                  		dw 558h			; ret_carry_clear
 12057                                  		dw 849h			; dsk_writ
 12058                                  		dw 841h			; dsk_writv
 12059                                  		dw 558h			; ret_carry_clear
 12060                                  		dw 558h			; ret_carry_clear
 12061                                  		dw 0D5h			; bc_cmderr
 12062                                  		dw 80Ah			; dsk_open
 12063                                  		dw 81Ah			; dsk_close
 12064                                  		dw 831h			; dsk_rem
 12065                                  		dw 558h			; ret_carry_clear
 12066                                  		dw 558h			; ret_carry_clear
 12067                                  		dw 558h			; ret_carry_clear
 12068                                  		dw 0C6Bh		; do_generic_ioctl
 12069                                  		dw 558h			; ret_carry_clear
 12070                                  		dw 558h			; ret_carry_clear
 12071                                  		dw 558h			; ret_carry_clear
 12072                                  		dw 1124h		; ioctl_getown
 12073                                  		dw 1142h		; ioctl_setown
 12074                                  		dw 129Ah		; ioctl_support_query
 12075                                  
 12076                                  ;dtbl_siz equ $-dsktbl
 12077                                  
 12078                                  %endif
 12079                                  
 12080                                  ; 21/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
 12081                                  ; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0579h		
 12082                                  
 12083                                  		; 21/12/2023 - Retro DOS v5.0
 12084                                  		; 11/12/2022
 12085 0000056F 1A                      dsktbl:		db (dtbl_siz-1)/2	; 26 ; this is the size of the table
 12086 00000570 [501A]                  		dw dsk_init
 12087 00000572 [B805]                  		dw media_chk
 12088 00000574 [5706]                  		dw get_bpb
 12089                                  		;dw bc_cmderr
 12090 00000576 [4B0E]                  		dw ioctl_input ; PCDOS 7 ; 21/12/2023
 12091 00000578 [7409]                  		dw dsk_read
 12092 0000057A [5A09]                  		dw x_bus_exit
 12093 0000057C [2206]                  		dw ret_carry_clear
 12094 0000057E [2206]                  		dw ret_carry_clear
 12095 00000580 [6609]                  		dw dsk_writ
 12096 00000582 [5E09]                  		dw dsk_writv
 12097 00000584 [2206]                  		dw ret_carry_clear
 12098 00000586 [2206]                  		dw ret_carry_clear
 12099                                  		;dw bc_cmderr
 12100 00000588 [F80D]                  		dw ioctl_output ; PCDOS 7 ; 21/12/2023
 12101 0000058A [2B09]                  		dw dsk_open
 12102 0000058C [3A09]                  		dw dsk_close
 12103 0000058E [5009]                  		dw dsk_rem
 12104 00000590 [2206]                  		dw ret_carry_clear
 12105 00000592 [2206]                  		dw ret_carry_clear
 12106 00000594 [2206]                  		dw ret_carry_clear
 12107 00000596 [CD0E]                  		dw do_generic_ioctl
 12108 00000598 [2206]                  		dw ret_carry_clear
 12109 0000059A [2206]                  		dw ret_carry_clear
 12110 0000059C [2206]                  		dw ret_carry_clear
 12111 0000059E [A813]                  		dw ioctl_getown
 12112 000005A0 [C513]                  		dw ioctl_setown
 12113 000005A2 [2215]                  		dw ioctl_support_query
 12114                                  
 12115                                  dtbl_siz equ $-dsktbl
 12116                                  
 12117                                  ; =============== S U B	R O U T	I N E =======================================
 12118                                  
 12119                                  ; ---------------------------------------------------------------------------
 12120                                  ; setdrive scans through the data structure of bdss, and returns a pointer to
 12121                                  ; the one that belongs to the drive specified. carry is set if none exists
 12122                                  ; for the drive. Pointer is returned in es:[di]
 12123                                  ;
 12124                                  ;  AL contains the logical drive number.
 12125                                  ; ---------------------------------------------------------------------------
 12126                                  
 12127                                  SetDrive:
 12128                                  		;les	di, dword ptr ds:start_bds ; Point es:di to first bds
 12129 000005A4 C43E[1901]              		les	di, [start_bds] ; 19/10/2022
 12130                                  X_Scan_Loop:
 12131 000005A8 26384505                		cmp	[es:di+5], al	
 12132 000005AC 7409                    		jz	short X_SetDrv
 12133 000005AE 26C43D                  		les	di, [es:di]	; [es:di+BDS.link] ; Go	to next	bds
 12134 000005B1 83FFFF                  		cmp	di, 0FFFFh
 12135 000005B4 75F2                    		jnz	short X_Scan_Loop
 12136 000005B6 F9                      		stc
 12137                                  X_SetDrv:
 12138 000005B7 C3                      		retn
 12139                                  
 12140                                  ; ---------------------------------------------------------------------------
 12141                                  
 12142                                  ; 15/10/2022
 12143                                  
 12144                                  	; 21/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
 12145                                  	; PCDOS 7.1 IBMBIO.COM - BIOSCODE:05C2h
 12146                                  
 12147                                  ; ---------------------------------------------------------------------
 12148                                  ; if id is f9, have a 96tpi disk else
 12149                                  ; if bit 2 is 0 then media is not removable and could not have changed
 12150                                  ;  otherwise if within 2 secs of last disk operation media could not
 12151                                  ;    have changed, otherwise dont know if media has changed
 12152                                  ; ---------------------------------------------------------------------
 12153                                  
 12154                                  media_chk:				; 2C7h:4EBh = 70h:2A5Bh
 12155 000005B8 E8E9FF                  		call	SetDrive
 12156 000005BB BE0100                  		mov	si, 1
 12157                                  		; 21/12/2023
 12158 000005BE 26F6454001              		test	byte [es:di+40h], 1
 12159                                  		;test	byte [es:di+24h], 1 ; [es:di+BDS.flags+1]
 12160                                  					; fchanged_by_format
 12161 000005C3 7415                    		jz	short WeAreNotFakingIt
 12162                                  		; 21/12/2023
 12163 000005C5 26806540FE              		and	byte [es:di+40h], 0FEh
 12164                                  		; 12/12/2022
 12165                                  		;and	byte [es:di+24h], 0FEh ; ~fchanged_by_format
 12166                                  		;;and	word [es:di+23h], 0FEFFh ; [es:di+BDS.flags]
 12167                                  					; ~fchanged_by_format ;	reset flag
 12168 000005CA C606[1E01]FF            		mov	byte [tim_drv], 0FFh ; -1
 12169                                  					; Ensure that we ask the rom if media has changed
 12170                                  		; 21/12/2023
 12171 000005CF 26F6453F01              		test	byte [es:di+3Fh], 1
 12172                                  		;test	byte [es:di+23h], 1 ; [es:di+BDS.flags]
 12173                                  					; fnon_removable
 12174 000005D4 740B                    		jz	short wehaveafloppy
 12175                                  		;mov	si, 0FFFFh	; Indicate media changed
 12176                                  		; 11/08/2023
 12177 000005D6 F7DE                    		neg	si		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:05E0h
 12178 000005D8 EB2B                    		jmp	short Media_Done ; Media_Done
 12179                                  ; ---------------------------------------------------------------------------
 12180                                  
 12181                                  WeAreNotFakingIt:
 12182                                  		; 21/12/2023
 12183 000005DA 26F6453F01              		test	byte [es:di+3Fh], 1
 12184                                  		;test	byte [es:di+BDS.flags], fnon_removable			
 12185                                  		;test	byte [es:di+23h], 1
 12186 000005DF 7524                    		jnz	short Media_Done
 12187                                  wehaveafloppy:
 12188                                  		;xor	si, si ; 0	; Presume "I don't know"
 12189                                  		; 11/08/2023
 12190 000005E1 4E                      		dec	si ; 0 		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:05EBh
 12191                                  
 12192                                  		; If we have a floppy with changeline support, we ask the ROM
 12193                                  		; to determine if media has changed. We do not perform the
 12194                                  		; 2 second check for these drives.
 12195                                  
 12196 000005E2 803E[7700]00            		cmp	byte [fhave96], 0	; Do we	have changeline	support?
 12197 000005E7 740A                    		jz	short mChk_NoChangeLine	; Brif not
 12198 000005E9 E83C15                  		call	mediacheck	;  Call	into removable routine
 12199 000005EC 7236                    		jb	short err_exitj
 12200 000005EE E8A016                  		call	haschange
 12201 000005F1 7512                    		jnz	short Media_Done
 12202                                  mChk_NoChangeLine:
 12203                                  		; If we come here, we have a floppy with no changeline support
 12204                                  			
 12205 000005F3 BE0100                  		mov	si, 1		; Presume no change
 12206 000005F6 A0[1E01]                		mov	al, [tim_drv]	; Last drive accessed
 12207 000005F9 263A4504                		cmp	al, [es:di+4]	; [es:di+BDS.drivenum]
 12208                                  					; Is drive of last access the same?
 12209 000005FD 7505                    		jnz	short Media_Unk	; No, then "i don't know"
 12210 000005FF E82800                  		call	Check_Time_Of_Access
 12211 00000602 EB01                    		jmp	short Media_Done
 12212                                  ; ---------------------------------------------------------------------------
 12213                                  
 12214                                  Media_Unk:
 12215 00000604 4E                      		dec	si		; ; Return "I don't know"
 12216                                  
 12217                                  		; SI now contains the correct value for media change.
 12218                                  		; Clean up the left overs
 12219                                  Media_Done:
 12220                                  		; 19/10/2022
 12221 00000605 06                      		push	es
 12222 00000606 C41E[1200]              		les	bx, [ptrsav]
 12223 0000060A 2689770E                		mov	[es:bx+0Eh], si	; [es:bx+trans]
 12224 0000060E 07                      		pop	es
 12225 0000060F 09F6                    		or	si, si
 12226 00000611 790F                    		jns	short ret_carry_clear ;	volidok
 12227 00000613 803E[7700]00            		cmp	byte [fhave96], 0
 12228 00000618 7403                    		jz	short mChk1_NoChangeLine ; Brif	no changeline support
 12229 0000061A E80616                  		call	media_set_vid
 12230                                  mChk1_NoChangeLine:
 12231 0000061D C606[1E01]FF            		mov	byte [tim_drv], 0FFh ; -1
 12232                                  					; Make sure we ask rom for media check
 12233                                  ret_carry_clear:			
 12234 00000622 F8                      		clc			; volidok
 12235 00000623 C3                      		retn
 12236                                  ; ---------------------------------------------------------------------------
 12237                                  
 12238                                  err_exitj:
 12239 00000624 E88307                  		call	maperror	; guaranteed to	set carry
 12240                                  ret81:					
 12241 00000627 B481                    		mov	ah, 81h		; return error status
 12242 00000629 C3                      		retn			; return with carry set
 12243                                  
 12244                                  ; =============== S U B	R O U T	I N E =======================================
 12245                                  
 12246                                  ; ---------------------------------------------------------------------------
 12247                                  ; perform a check on the time passed since the last access for this physical
 12248                                  ; drive.
 12249                                  ; we are accessing the same drive. if the time of last successful access was
 12250                                  ; less than 2 seconds ago, then we may presume that the disk was not changed.
 12251                                  ; returns in si:
 12252                                  ;	0 - if time of last access was >= 2 seconds
 12253                                  ;	1 - if time was < 2 seconds (i.e no media change assumed)
 12254                                  ; registers affected ax,cx,dx, flags.
 12255                                  ;
 12256                                  ;	assume es:di -> bds, ds->Bios_Data
 12257                                  ; ---------------------------------------------------------------------------
 12258                                  
 12259                                  		; 21/12/2023 - Retro DOS v5.0 IBMBIO.COM
 12260                                  		; 19/10/2022
 12261                                  Check_Time_Of_Access:
 12262 0000062A BE0100                  		mov	si, 1		; presume no change.
 12263 0000062D E801FF                  		call	GetTickCnt	; cx:dx	is the elapsed time
 12264                                  		; 21/12/2023
 12265 00000630 268B4579                		mov	ax, [es:di+79h]
 12266                                  		;mov	ax, [es:di+47h]	; [es:di+BDS.tim_lo]
 12267                                  					; get stored time
 12268 00000634 29C2                    		sub	dx, ax
 12269                                  		; 21/12/2023
 12270 00000636 268B457B                		mov	ax, [es:di+7Bh]
 12271                                  		;mov	ax, [es:di+49h]	; [es:di+BDS.tim_hi]
 12272 0000063A 19C1                    		sbb	cx, ax
 12273                                  		; 11/08/2023
 12274                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0646h
 12275                                  		;mov	al, [accesscount]
 12276 0000063C 7515                    		jnz	short timecheck_unk ; cx<>0 => >1 hour
 12277 0000063E 09D2                    		or	dx, dx		; time must pass
 12278 00000640 750C                    		jnz	short timepassed ; yes, examine max value
 12279                                  		; 11/08/2023
 12280                                  		;inc	al
 12281                                  		;cmp	al, 5
 12282                                  		;;inc	byte [accesscount]
 12283                                  		;;cmp	byte [accesscount], 5
 12284                                  		;			; if count is less than threshold, ok
 12285                                  		;jb	short timecheck_ret
 12286                                  		;;dec	byte [accesscount] ; don't let the count wrap
 12287                                  		; 11/08/2023
 12288                                  		;dec	al
 12289                                  		;jmp	short timecheck_unk ; "i don't know" if media changed
 12290                                  		; 11/08/2023
 12291 00000642 803E[1D01]04            		cmp	byte [accesscount], 4
 12292 00000647 730A                    		jnb	short timecheck_unk
 12293 00000649 FE06[1D01]              		inc	byte [accesscount]
 12294 0000064D C3                      		retn
 12295                                  
 12296                                  ; ---------------------------------------------------------------------------
 12297                                  
 12298                                  timepassed:
 12299 0000064E 83FA24                  		cmp	dx, 36		; 18*2 ; 18.2 tics per second.
 12300                                  					; min elapsed time? (2 seconds)
 12301 00000651 7601                    		jbe	short timecheck_ret ; yes, presume no change
 12302                                  
 12303                                  		; everything indicates that we do not know what has happened.
 12304                                  timecheck_unk:
 12305 00000653 4E                      		dec	si		; presume i don't know
 12306                                  timecheck_ret:
 12307                                  		; 11/08/2023
 12308                                  		;mov	[accesscount], al
 12309 00000654 C3                      		retn
 12310                                  
 12311                                  ; ---------------------------------------------------------------------------
 12312                                  ; 15/10/2022
 12313                                  Err_Exitj2:
 12314 00000655 EBCD                    		jmp	short err_exitj
 12315                                  
 12316                                  ; ---------------------------------------------------------------------------
 12317                                  
 12318                                  ; 15/10/2022
 12319                                  
 12320                                  ; ==========================================================================
 12321                                  ; Build a valid bpb for the disk in the drive.
 12322                                  ; ==========================================================================
 12323                                  
 12324                                  
 12325                                  		; 21/12/2023 - Retro DOS v5.0 IBMBIO.COM
 12326                                  		; 19/10/2022
 12327                                  get_bpb:				; 2C7h:592h = 70h:2B02h
 12328 00000657 268A25                  		mov	ah, [es:di]	; get fat id byte read by dos
 12329 0000065A E847FF                  		call	SetDrive	; get the correct bds for the drive
 12330                                  		; 21/12/2023
 12331 0000065D 26F6453F01              		test	byte [es:di+3Fh], 1
 12332                                  		;test	byte [es:di+23h], 1 ; [es:di+BDS.flags]
 12333                                  					; fnon_removable
 12334 00000662 7523                    		jnz	short already_gotbpb ; no need to build	for fixed disks
 12335                                  
 12336                                  		; let's set the default value for volid,vol_serial,
 12337                                  		; filesys_id in bds table
 12338                                  
 12339 00000664 E83600                  		call	clear_ids
 12340                                  		;mov	ds:set_id_flag,	1 ; indicate to	set system id in bds
 12341 00000667 C606[9B04]01            		mov	byte [set_id_flag], 1
 12342 0000066C E86700                  		call	GetBp		; build	a bpb if necessary
 12343 0000066F 72B6                    		jb	short ret81
 12344                                  		;cmp	ds:set_id_flag,	2 ; already, volume_label set from boot
 12345 00000671 803E[9B04]02            		cmp	byte [set_id_flag], 2
 12346                                  		;mov	ds:set_id_flag,	0 ; record to bds table?
 12347 00000676 C606[9B04]00            		mov	byte [set_id_flag], 0
 12348 0000067B 740A                    		jz	short already_gotbpb ; do not set it again from	root dir
 12349                                  					; otherwise, conventional boot record
 12350                                  		;cmp	ds:fhave96, 0	; do we	have changeline	support?
 12351 0000067D 803E[7700]00            		cmp	byte [fhave96], 0
 12352 00000682 7403                    		jz	short already_gotbpb ; brif not
 12353 00000684 E81016                  		call	set_volume_id
 12354                                  already_gotbpb:
 12355 00000687 83C706                  		add	di, 6		; BDS.BPB
 12356                                  					; return the bpb from the current bds
 12357                                  
 12358                                  ;		fall into setptrsav, es:di -> result
 12359                                  
 12360                                  ; ---------------------------------------------------------------------------
 12361                                  
 12362                                  ; 15/10/2022
 12363                                  
 12364                                  ; ==========================================================================
 12365                                  ;Setptrsav is also jumped to from dsk_init (msbio2.asm). In both cases, the
 12366                                  ;pointer to be returned is in es:di. We were incorrectly returning ds:di.
 12367                                  ;Note that this works in most cases because most pointers are in Bios_Data.
 12368                                  ;It fails, for instance, when we install an external drive using driver.sys
 12369                                  ;because then the BDS segment is no longer Bios_Data. 
 12370                                  ;NB: It is fine to corrupt cx because this is not a return value and anyway
 12371                                  ;this returns to Chardev_entry (msbio1.asm) where all registers are 
 12372                                  ;restored before returning to the caller.
 12373                                  ; ==========================================================================
 12374                                  
 12375                                  ; 21/12/2023
 12376                                  %if 0
 12377                                  		; 19/10/2022
 12378                                  SetPtrSav:	; return point for dsk_init
 12379                                  		mov	cx, es		; save es
 12380                                  		;les	bx, ds:ptrsav
 12381                                  		les	bx, [ptrsav]
 12382                                  		mov	[es:bx+0Dh], ah	; [es:bx+media]
 12383                                  		mov	[es:bx+12h], di	; [es:bx+count]
 12384                                  		mov	[es:bx+14h], cx	; [es:bx+count+2]
 12385                                  		clc
 12386                                  		retn
 12387                                  %endif
 12388                                  		; 21/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
 12389                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0698h
 12390                                  SetPtrSav:	
 12391                                  		; return point for dsk_init
 12392 0000068A 1E                      		push	ds
 12393                                  		;lds	bx, ds:ptrsav
 12394 0000068B C51E[1200]              		lds	bx, [ptrsav]
 12395 0000068F 88670D                  		mov	[bx+0Dh], ah	; [bx+media]
 12396 00000692 897F12                  		mov	[bx+12h], di	; [bx+count]
 12397 00000695 8C4714                  		mov	[bx+14h], es	; [bx+count+2]
 12398 00000698 1E                      		push	ds
 12399 00000699 07                      		pop	es
 12400 0000069A 1F                      		pop	ds
 12401 0000069B F8                      		clc
 12402 0000069C C3                      		retn
 12403                                  
 12404                                  ; =============== S U B	R O U T	I N E =======================================
 12405                                  
 12406                                  ; 15/10/2022
 12407                                  
 12408                                  ; -----------------------------------------------------
 12409                                  ; clear ids in bds table. only applied for floppies.
 12410                                  ;input:  es:di -> bds table
 12411                                  ;	assumes ds: -> Bios_Data
 12412                                  ;output: volid set to "NO NAME    "
 12413                                  ;	 vol_serial set to 0.
 12414                                  ;	 filesys_id set to "FAT12   " or "FAT16   "
 12415                                  ;	   depending on the flag fatsize in bds.
 12416                                  ;
 12417                                  ;	trashes si, cx
 12418                                  ; -----------------------------------------------------
 12419                                  
 12420                                  ;size_of_EXT_BOOT_VOL_LABEL equ 11
 12421                                  ;size_of_EXT_SYSTEM_ID equ 8
 12422                                  
 12423                                  ; 11/09/2023
 12424                                  ; 14/08/2023
 12425                                  ;BDS.fatsiz equ 1Fh
 12426                                  ; 21/12/2023
 12427                                  ;BDS.fatsiz equ 59
 12428                                  
 12429                                  		; 22/12/2023
 12430                                  		; 21/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
 12431                                  clear_ids:
 12432                                  		;mov	al, [es:di+1Fh] ; mov al,[es:di+BDS.fatsiz]
 12433                                  		; 21/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM BugFix)
 12434 0000069D 268A5D3B                		mov	bl, [es:di+3Bh] ; mov bl,[es:di+BDS.fatsiz]; *+
 12435                                  clear_ids_x:
 12436                                  		; 21/12/2023 
 12437                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:06ABh)
 12438                                  		; 11/09/2023		
 12439                                   		; (MSDOS 5.0 IO.SYS - BIOSCODE:05D9h)
 12440 000006A1 57                      		push	di
 12441 000006A2 31C9                    		xor	cx, cx		; no serial number
 12442                                  		; 21/12/2023
 12443 000006A4 26898D8900              		mov	[es:di+89h], cx	; [es:di+BDS.vol_serial]
 12444 000006A9 26898D8B00              		mov	[es:di+8Bh], cx	; [es:di+BDS.vol_serial+2]
 12445                                  		;mov	[es:di+57h], cx	; [es:di+BDS.vol_serial]
 12446                                  		;mov	[es:di+59h], cx	; [es:di+BDS.vol_serial+2]
 12447                                  
 12448                                  		; BUGBUG - there's a lot in common here and with
 12449                                  		; mov_media_ids.. see if we can save some space by
 12450                                  		; merging them... jgl
 12451                                  
 12452                                  		;mov	cx, 11		; size_of_EXT_BOOT_VOL_LABEL
 12453                                  		; 10/12/2022
 12454 000006AE B10B                    		mov	cl, 11 ; cx = 11
 12455                                  
 12456                                  		;;mov	si, offset vol_no_name ; "NO NAME    "
 12457                                  		;mov	si, vol_no_name	; 19/10/2022
 12458                                  		; 22/12/2023
 12459                                  		;mov	si, offset nul_vid ; "NO NAME    "
 12460 000006B0 BE[6305]                		mov	si, nul_vid
 12461                                  
 12462                                  		; 21/12/2023
 12463 000006B3 83C77D                  		add	di, 125
 12464                                  		;add	di, 75		; BDS.volid
 12465                                  		
 12466                                  		;rep movsb
 12467                                  		; 21/12/2023
 12468                                  		;rep movs byte ptr es:[di], byte ptr cs:[si] ; cs rep movsb
 12469                                  		; 26/12/2023
 12470                                  		;cs	; vol_no_name is in BIOSCODE segment
 12471                                  		;rep movsb
 12472 000006B6 F3                      		rep
 12473 000006B7 2E                      		cs
 12474 000006B8 A4                      		movsb
 12475                                  
 12476                                  		; 11/09/2023 (BugFix, DI is not start addr of BDS structure here)
 12477                                  		;;test	byte [es:di+BDS.fatsiz], fbig
 12478                                  		; (MSDOS 5.0 IO.SYS - BIOSCODE:05EFh)
 12479                                  		;test	byte [es:di+1Fh], 40h
 12480                                  		; 21/12/2023 - Retro DOS v5.0
 12481                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:06C3h)
 12482                                  		;test	byte [es:di+59], 20h 
 12483                                  			; (here, es:di points to the BDS offset +136)
 12484                                  			; purpose: test byte [es:di+BDS.fatsiz], fbigbig
 12485                                  			; applied: test byte [es:BDS.fatsiz+136], fbigbig -BUG!-
 12486                                  
 12487                                  			; (PCDOS 7.1 BUG note: 26/06/2023 - Erdogan Tan)
 12488                                  			;; ! NOTE - 11/08/2023 - Erdogan Tan (Retro DOS v4.2 IO.SYS bugfix)
 12489                                  			; Microsoft/IBM code has a bug here because the BDS's
 12490                                  			; .volid and .filesys_id fields will be reset
 12491                                  			; (to their default text) according to 'BDS.fatsiz' flags
 12492                                  			; at the BDS offset 59 but current (this) code checks flags
 12493                                  			; at ES:DI+59 while DI points the BDS offset 136!? ; (PCDOS 7.1)
 12494                                  			;; at the BDS offset 31 but current (this) code checks flags
 12495                                  			;; at ES:DI+31 while DI points the BDS offset 86!? ; (MSDOS 6.22)
 12496                                  			;
 12497                                  			; Correct Code:
 12498                                  			; ;test byte [ES:59],20h or [ES:BDS.fatsiz],fbigbig  ; (PCDOS 7.1)	
 12499                                  			; ;;test byte [ES:31],40h or [ES:BDS.fatsiz],fbig  ; (MSDOS 6.22)
 12500                                  			; 11/09/2023
 12501                                  			; (before 'rep movsb') 'mov al,[es:di+BDS.Fatsiz]' and then
 12502                                  			; (after 'rep movsb') 'test al,fbig' (AL is free/proper to use here)	
 12503                                  			;
 12504                                  			; Same BUG is existing in MSDOS 6.22 IO.SYS - BIOSCODE:05EFh
 12505                                  			; and in Windows ME IO.SYS - BIOSCODE:0E1Ah as 'test byte [es:di+59],20h'
 12506                                  
 12507                                  			;
 12508                                  			; (Why this bug did not affect MSDOS and PCDOS 7.x applications:
 12509                                  			; 'clear_ids' is used for floppy disks only and the default
 12510                                  			; option of 'clear_ids' is FAT12 volid and filesys_id text
 12511                                  			; when the flag bit has wrong value for FAT16/40h or FAT32/20h.)
 12512                                  
 12513                                  		; 21/12/2023 - Retro DOS v5.0
 12514                                  		;mov	si, offset fat_32_id ; "FAT32   "
 12515 000006B9 BE[5B05]                		mov	si, fat_32_id	
 12516                                  
 12517                                  		; 21/12/2023
 12518                                  		; BugFix (of the PCDOS 7.1 IBMBIO.COM BUG) ; *+
 12519                                  		;test	bl, fbigbig ; FAT32 flag
 12520 000006BC F6C320                  		test	bl, 20h ; * ; BL = [es:BDS.fatsiz] = [es:59]
 12521 000006BF 750B                    		jnz	short ci_bigfat
 12522                                  
 12523                                  		;mov	si, offset fat_16_id ; "FAT16	"
 12524 000006C1 BE[5305]                		mov	si, fat_16_id	; 19/10/2022
 12525                                  		
 12526                                  		; 21/12/2023
 12527                                  		; !BUG! (PCDOS 7.1 IBMBIO.COM BIOSCODE:06CDh)
 12528                                  		;test	byte [es:di+59], 40h ; [es:di+BDS.fatsiz], fbig
 12529                                  		; BugFix ; *+
 12530                                  		;test	bl, fbig ; FAT16 flag
 12531 000006C4 F6C340                  		test	bl, 40h ; * ; Retro DOS v5.0
 12532                                  		;;test	al, 40h ; * ; Retro DOS v4.2
 12533 000006C7 7503                    		jnz	short ci_bigfat
 12534                                  
 12535                                  		;mov	si, offset fat_12_id ; "FAT12	"
 12536 000006C9 BE[4B05]                		mov	si, fat_12_id	; 19/10/2022
 12537                                  ci_bigfat:
 12538                                  		;mov	cx, 8		; size_of_EXT_SYSTEM_ID
 12539                                  		; 10/12/2022
 12540 000006CC B108                    		mov	cl, 8 ; cx = 8 
 12541 000006CE 83C705                  		add	di, 5		; (BDS.filesys_id-BDS.volid)-size_of_EXT_BOOT_VOL_LABEL
 12542                                  					; filesys_id field
 12543                                  		;rep movsb
 12544                                  		; 21/12/2023 - Retro DOS v5.0
 12545                                  		;rep movs byte ptr es:[di], byte ptr cs:[si] ; 0F3h,2Eh,0A4h
 12546                                  		; 26/12/2023
 12547                                  		;cs	; fat32_id, fat16_id and fat12_id are in BIOSCODE segment
 12548                                  		;rep movsb
 12549 000006D1 F3                      		rep
 12550 000006D2 2E                      		cs
 12551 000006D3 A4                      		movsb
 12552                                  
 12553 000006D4 5F                      		pop	di		; restore bds pointer
 12554                                  getret_exit:		; 21/12/2023
 12555 000006D5 C3                      		retn
 12556                                  
 12557                                  ; =============== S U B	R O U T	I N E =======================================
 12558                                  
 12559                                  ; 15/10/2022
 12560                                  
 12561                                  ; ---------------------------------------------------------------------------
 12562                                  ;	getbp - return bpb from the drive specified by the bds.
 12563                                  ;	    if the return_fake_bpb flag is set, then it does nothing.
 12564                                  ;	    note that we never come here for fixed disks.
 12565                                  ;	    for all other cases,
 12566                                  ;	      - it reads boot sector to pull out the bpb
 12567                                  ;	      - if no valid bpb is found, it then reads the fat sector,
 12568                                  ;		to get the fat id byte to build the bpb from there.
 12569                                  ;
 12570                                  ;   inputs:	es:di point to correct bds.
 12571                                  ;
 12572                                  ;   outputs:	fills in bpb in current bds if valid bpb or fat id on disk.
 12573                                  ;		carry set, and al=7 if invalid disk.
 12574                                  ;		carry set and error code in al if other error.
 12575                                  ;		if failed to recognize the boot record, then will set the
 12576                                  ;		set_id_flag to 0.
 12577                                  ;		this routine will only work for a floppy diskette.
 12578                                  ;		     for a fixed disk, it will just return.
 12579                                  ;
 12580                                  ;	****** Note: getbp is a clone of getbp which uses the newer
 12581                                  ;	  segment definitions. It should be migrated towards.
 12582                                  ;	   now es:di has the bds, ds: has Bios_Data
 12583                                  ; ---------------------------------------------------------------------------
 12584                                  
 12585                                  		; 21/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
 12586                                  GetBp:
 12587                                  		; if returning fake bpb then return bpb as is.
 12588                                  		; 21/12/2023
 12589 000006D6 26F6453F05              		test	byte [es:di+3Fh], 5 ; PCDOS 7.1
 12590                                  		;test	byte [es:di+BDS.flags], return_fake_bpb|fnon_removable		
 12591                                  		;test	byte [es:di+23h], 5 ; MSDOS 6.22 (& MSDOS 5.0)
 12592                                  		;jz	short getbp1	; getbp1
 12593                                  		;jmp	getret_exit
 12594                                  		; 21/12/2023
 12595 000006DB 75F8                    		jnz	short getret_exit
 12596                                  ; ---------------------------------------------------------------------------
 12597                                  getbp1:	
 12598 000006DD 51                      		push	cx
 12599 000006DE 52                      		push	dx
 12600 000006DF 53                      		push	bx
 12601                                  
 12602                                  		; attempt to read in boot sector and determine bpb.
 12603                                  		; we assume that the 2.x and greater dos disks all
 12604                                  		; have a valid boot sector.
 12605                                  
 12606 000006E0 E8D200                  		call	readbootsec
 12607 000006E3 720A                    		jb	short getbp_err_ret_brdg ; carry set if there was error.
 12608 000006E5 09DB                    		or	bx, bx		; bx is	0 if boot sector is valid.
 12609 000006E7 7509                    		jnz	short dofatbpb
 12610 000006E9 E81701                  		call	movbpb		; move bpb into	registers
 12611                                  		;jmp	short Has1
 12612                                  		; 21/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
 12613 000006EC E9B800                  		jmp	getret
 12614                                  ; ---------------------------------------------------------------------------
 12615                                  
 12616                                  getbp_err_ret_brdg:
 12617 000006EF E9B900                  		jmp	getbp_err_ret
 12618                                  ; ---------------------------------------------------------------------------
 12619                                  
 12620                                  		; we have a 1.x diskette. In this case read in the fat ID byte
 12621                                  		; and fill in bpb from there.
 12622                                  dofatbpb:				
 12623 000006F2 E8B601                  		call	readfat		; puts media descriptor	byte in	ah
 12624 000006F5 72F8                    		jb	short getbp_err_ret_brdg
 12625                                  		;cmp	ds:fhave96, 0	;  changeline support available?
 12626 000006F7 803E[7700]00            		cmp	byte [fhave96], 0 ; 19/10/2022
 12627 000006FC 7403                    		jz	short bpb_nochangeline ; brif not
 12628 000006FE E83715                  		call	hidensity	; may not return! May add sp, 2	and
 12629                                  					; jump to has1!!!!!! or	has720K
 12630                                  bpb_nochangeline:		; test for a valid 3.5" medium			
 12631                                  		; 21/12/2023 - Retro DOS v5.0
 12632 00000701 26807D3E02              		cmp	byte [es:di+3Eh], 2
 12633                                  		;cmp	byte [es:di+22h], 2 ; [es:di+BDS.formfactor]
 12634                                  					; ffSmall
 12635 00000706 7512                    		jnz	short is_floppy
 12636 00000708 80FCF9                  		cmp	ah, 0F9h	; is it	a valid	fat id byte for	3.5" ?
 12637 0000070B 7512                    		jnz	short got_unknown_medium
 12638                                  Has720K:
 12639                                  		; 21/12/2023
 12640                                  		;;mov	bx, offset sm92 ; pointer to correct bpb
 12641                                  		;mov	bx, sm92	; 19/10/2022
 12642                                  
 12643                                  		; es points to segment of bds. the following should be modified
 12644                                  		; to get spf,csec,spau,spt correctly. it had been wrong if
 12645                                  		; driver.sys is loaded since the bds is inside the driver.sys.
 12646                                  
 12647                                  		; 21/12/2023
 12648                                  		;; 10/12/2022
 12649                                  		;;mov	al, [bx+0]	; [bx+bpbtype.spf]
 12650                                  		;; 21/12/2022
 12651                                  		;mov	al, [bx]
 12652                                  		;mov	cx, [bx+3]	; [bx+bpbtype.csec]
 12653                                  		;mov	dx, [bx+5]	; [bx+bpbtype.spau]
 12654                                  		;mov	bx, [bx+1]	; [bx+bpbtype.spt]
 12655                                  		;; 19/10/2022 - Temporary !
 12656                                  		;;db	8Ah, 87h, 0, 0	; mov al, [bx+0]
 12657                                  		;;db	8Bh, 8Fh, 3, 0	; mov cx, [bx+3]
 12658                                  		;;db	8Bh, 97h, 5, 0	; mov dx, [bx+5]
 12659                                  		;;db	8Bh, 9Fh, 1, 0	; mov bx, [bx+1]
 12660                                  
 12661                                  		; 21/12/2023 - Retro DOS v5.0
 12662 0000070D B003                    		mov	al, 3		; bpbtype.sbf = 3
 12663 0000070F B9A005                  		mov	cx, 1440	; bpbtype.csec = 1440
 12664 00000712 BA0202                  		mov	dx, 202h	; dl = bpbtype.spau = 2
 12665                                  					; dh = bpbtype.chead = 2
 12666 00000715 BB0970                  		mov	bx, 7009h	; bl = bpbtype.spt = 9
 12667                                  					; bh = bpbtype.dire = 112
 12668 00000718 EB33                    		jmp	short Has1
 12669                                  ; ---------------------------------------------------------------------------
 12670                                  
 12671                                  is_floppy:			; must be a 5.25" floppy if we come here
 12672 0000071A 80FCF8                  		cmp	ah, 0F8h	; valid	media??	(0F8h-0FFh)
 12673                                  		;jb	short got_unknown_medium
 12674                                  		; 21/12/2023
 12675 0000071D 730A                    		jnb	short chk_160K
 12676                                  ; ---------------------------------------------------------------------------
 12677                                  		; 21/12/2023
 12678                                  		; we have a 3.5" diskette for which we cannot build a bpb.
 12679                                  		; we do	not assume any type of bpb for this medium.
 12680                                  got_unknown_medium:
 12681                                  		;mov	ds:set_id_flag,	0
 12682 0000071F C606[9B04]00            		mov	byte [set_id_flag], 0
 12683 00000724 B007                    		mov	al, 7
 12684 00000726 F9                      		stc
 12685 00000727 EB7E                    		jmp	short getret
 12686                                  ; ---------------------------------------------------------------------------
 12687                                  chk_160K:
 12688 00000729 B001                    		mov	al, 1		; set number of	fat sectors
 12689 0000072B BB0840                  		mov	bx, 16392	; 64*256+8
 12690                                  					; set dir entries and sector max
 12691 0000072E B94001                  		mov	cx, 320		; 40*8
 12692                                  					; set size of drive
 12693 00000731 BA0101                  		mov	dx, 257		; 01*256+1
 12694                                  					; set head limit and sec/all unit
 12695                                  		; 21/12/2023
 12696                                  		;mov	al, 1		; bpbtype.sbf = 1
 12697                                  		;mov	bx, 4008h	; bl = bpbtype.spt = 8
 12698                                  		;			; bh = bpbtype.dire = 64
 12699                                  		;mov	cx, 140h	; bpbtype.csec = 320
 12700                                  		;mov	dx, 101h	; dl = bpbtype.spau = 1
 12701                                  		;			; dh = bpbtype.chead = 1
 12702                                  
 12703 00000734 F6C402                  		test	ah, 2		; test for 8 or	9 sector
 12704 00000737 7507                    		jnz	short has8	; nz = has 8 sectors
 12705 00000739 FEC0                    		inc	al	; 2 	; inc number of	fat sectors
 12706 0000073B FEC3                    		inc	bl	; 9	; inc sector max
 12707                                  		;add	cx, 40		; increase size	(to 360)
 12708                                  		; 18/12/2022
 12709 0000073D 80C128                  		add	cl, 40	; 28h	; 180K (360 sectors)
 12710                                  has8:
 12711 00000740 F6C401                  		test	ah, 1		; test for 1 or	2 heads
 12712 00000743 7408                    		jz	short Has1	; jz = 1 head
 12713 00000745 01C9                    		add	cx, cx		; double size of disk
 12714 00000747 B770                    		mov	bh, 112		; increase number of directory entries
 12715 00000749 FEC6                    		inc	dh	; 2	; inc sec/all unit
 12716 0000074B FEC2                    		inc	dl	; 2	; inc head limit
 12717                                  Has1:
 12718                                  		; 02/09/2023 (PCDOS 7.1, IBMBIO.COM - BIOSCODE:0754h)
 12719 0000074D 1E                      		push	ds
 12720 0000074E 06                      		push	es
 12721 0000074F 1F                      		pop	ds
 12722                                  
 12723                                  		;mov	[es:di+8], dh	; [es:di+BDS.secperclus]
 12724                                  		;mov	[es:di+0Ch], bh	; [es:di+BDS.direntries]
 12725                                  		;mov	[es:di+0Eh], cx	; [es:di+BDS.totalsecs16]
 12726                                  		;mov	[es:di+10h], ah	; [es:di+BDS.media]
 12727                                  		;mov	[es:di+11h], al	; [es:di+BDS.fatsecs]
 12728                                  		;mov	[es:di+13h], bl	; [es:di+BDS.secpertrack]
 12729                                  		;mov	[es:di+15h], dl	; [es:di+BDS.heads]
 12730                                  
 12731 00000750 887508                  		mov	[di+8], dh	; [di+BDS.secperclus]
 12732 00000753 30F6                    		xor	dh, dh
 12733 00000755 895515                  		mov	[di+15h], dx	; [di+BDS.heads]
 12734 00000758 88FA                    		mov	dl, bh
 12735 0000075A 89550C                  		mov	[di+0Ch], dx	; [di+BDS.direntries]
 12736 0000075D 894D0E                  		mov	[di+0Eh], cx	; [di+BDS.totalsecs16]
 12737 00000760 894D1B                  		mov	[di+1Bh], cx	; [di+BDS.totalsecs32]
 12738 00000763 886510                  		mov	[di+10h], ah	; [di+BDS.media]
 12739 00000766 88C2                    		mov	dl, al
 12740 00000768 895511                  		mov	[di+11h], dx	; [di+BDS.fatsecs]
 12741 0000076B 88DA                    		mov	dl, bl
 12742 0000076D 895513                  		mov	[di+13h], dx	; [di+BDS.secpertrack]
 12743                                  
 12744                                  		; the BDS_BPB.BPB_HIDDENSECTORS+2 field and the
 12745                                  		; BDS_BPB.BPB_BIGTOTALSECTORS field need to be set
 12746                                  		; to 0 since this code is for floppies
 12747                                  
 12748                                  		; 18/12/2022
 12749                                  		;mov	word [es:di+19h], 0 ; [es:di+BDS.hiddensecs+2]
 12750                                  		;mov	word [es:di+17h], 0 ; [es:di+BDS.hiddensecs]
 12751                                  		;mov	word [es:di+1Dh], 0 ; [es:di+BDS.totalsecs32+2]
 12752                                  		; 18/12/2022
 12753 00000770 29C9                    		sub	cx, cx ; 0
 12754                                  		;mov	[es:di+19h], cx ; 0 ; [es:di+BDS.hiddensecs+2]
 12755                                  		;mov	[es:di+17h], cx ; 0 ; [es:di+BDS.hiddensecs]
 12756                                  		;mov	[es:di+1Dh], cx ; 0 ; [es:di+BDS.totalsecs32+2]
 12757                                  		
 12758                                  		; 02/09/2023
 12759 00000772 894D19                  		mov	[di+19h], cx ; 0 ; [di+BDS.hiddensecs+2]
 12760 00000775 894D17                  		mov	[di+17h], cx ; 0 ; [di+BDS.hiddensecs]
 12761 00000778 894D1D                  		mov	[di+1Dh], cx ; 0 ; [di+BDS.totalsecs32+2]
 12762                                  
 12763                                  		; 21/12/2023 - Retro DOS v5.0
 12764 0000077B 894D1F                  		mov     [di+1Fh], cx    ; [di+BDS.fatsecs32] ; BPB_FATSz32
 12765 0000077E 894D21                  		mov     [di+21h], cx    ; [di+BDS.fatsecs32+2]
 12766 00000781 894D27                  		mov     [di+27h], cx    ; [di+BDS.rootdirclust]
 12767 00000784 894D29                  		mov     [di+29h], cx    ; [di+BDS.rootdirclust+2]
 12768 00000787 894D2F                  		mov     [di+2Fh], cx    ; [di+BDS.reserved]
 12769                                  					;     BPB_Reserved (12 zero bytes)
 12770 0000078A 894D31                  		mov     [di+31h], cx
 12771 0000078D 894D33                  		mov     [di+33h], cx
 12772 00000790 894D35                  		mov     [di+35h], cx
 12773 00000793 894D37                  		mov     [di+37h], cx
 12774 00000796 894D39                  		mov     [di+39h], cx
 12775 00000799 894D23                  		mov     [di+23h], cx    ; [di+BDS.extflags] ; BPB_ExtFlags
 12776 0000079C 894D25                  		mov     [di+25h], cx    ; [di+BDS.fsver] ; BPB_FSVer
 12777                                  
 12778 0000079F 49                      		dec     cx              ; -1 ; 0FFFFFFFFh
 12779 000007A0 894D2B                  		mov     [di+2Bh], cx    ; [di+BDS.fsinfo] ; BPB_FSInfo
 12780 000007A3 894D2D                  		mov     [di+2Dh], cx    ; [di+BDS.bkbootsec] ; BPB_BkBootSec
 12781                                  		
 12782 000007A6 1F                      		pop	ds ; 02/09/2023
 12783                                  getret:
 12784 000007A7 5B                      		pop	bx
 12785 000007A8 5A                      		pop	dx
 12786 000007A9 59                      		pop	cx
 12787                                  ;getret_exit:		; 21/12/2023
 12788 000007AA C3                      		retn
 12789                                  ; ---------------------------------------------------------------------------
 12790                                  
 12791                                  getbp_err_ret:	; before doing anything else, set set_id_flag to 0.
 12792                                  		;mov	ds:set_id_flag,	0
 12793                                  		; 19/10/2022
 12794 000007AB C606[9B04]00            		mov	byte [set_id_flag], 0
 12795 000007B0 E8F705                  		call	maperror
 12796 000007B3 EBF2                    		jmp	short getret
 12797                                  ; ---------------------------------------------------------------------------
 12798                                  ; 21/12/2023
 12799                                  ;		; we have a 3.5" diskette for which we cannot build a bpb.
 12800                                  ;		; we do	not assume any type of bpb for this medium.
 12801                                  ;
 12802                                  ;got_unknown_medium:
 12803                                  ;		;mov	ds:set_id_flag,	0
 12804                                  ;		mov	byte [set_id_flag], 0
 12805                                  ;		mov	al, 7
 12806                                  ;		stc
 12807                                  ;		jmp	short getret
 12808                                  
 12809                                  ; =============== S U B	R O U T	I N E =======================================
 12810                                  
 12811                                  ; 15/10/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS)
 12812                                  
 12813                                  ; ----------------------------------------------------------------
 12814                                  ; read in the boot sector. set carry if error in reading sector.
 12815                                  ; bx is set to 1 if the boot sector is invalid, otherwise it is 0.
 12816                                  ;
 12817                                  ;	assumes es:di -> bds, ds-> Bios_Data
 12818                                  ; ----------------------------------------------------------------
 12819                                  ; 10/03/2019 - Retro DOS v4.0
 12820                                  
 12821                                  ; 30/12/2022 - Retro DOS v4.2
 12822                                  ; (MSDOS 6.21 IO.SYS, BIOSCODE:06C3h)
 12823                                  ; ((MSDOS 6.22 IO.SYS, BIOSCODE:06C3h)) ; 22/12/2023
 12824                                  
 12825                                  ; 22/12/2023 - Retro DOS v5.0
 12826                                  ; (PCDOS 7.1 IBMBIO.COM, BIOSCODE:07C6h)
 12827                                  
 12828                                  readbootsec:	
 12829 000007B5 B600                    		mov	dh, 0		; head 0
 12830 000007B7 B90100                  		mov	cx, 1		; cylinder 0, sector 1
 12831 000007BA E8FB00                  		call	read_sector
 12832 000007BD 7243                    		jb	short err_ret
 12833 000007BF 31DB                    		xor	bx, bx		; assume valid boot sector
 12834                                  
 12835                                  		; put a sanity check for the boot sector in here to detect
 12836                                  		; boot sectors that do not have valid bpbs. we examine the
 12837                                  		; first two bytes - they must contain a long jump (69h) or a
 12838                                  		; short jump (EBh) followed by a nop (90h), or a short jump
 12839                                  		; (E9h). if this test is passed, we further check by examining
 12840                                  		; the signature at the end of the boot sector for the word
 12841                                  		; AA55h. if the signature is not present, we examine the media
 12842                                  		; descriptor byte to see if it is valid. for dos 3.3, this
 12843                                  		; logic is modified a little bit. we are not going to check
 12844                                  		; signature. instead we are going to sanity check the media
 12845                                  		; byte in bpb regardless of the validity of signature. this is
 12846                                  		; to save the already developed commercial products that have
 12847                                  		; good jump instruction and signature but with the false bpb
 12848                                  		; informations
 12849                                  
 12850                                  ; that will crash the diskette drive operation. (for example, symphony diskette).
 12851                                  
 12852                                  		; 02/09/2023
 12853                                  		; 19/10/2022
 12854                                  		;cmp	byte [disksector], 69h ; is it a direct jump?
 12855                                  		;jz	short check_bpb_mediabyte ; don't need to find a nop
 12856                                  		;cmp	byte [disksector], 0E9h ; dos 2.0 jump?
 12857                                  		;jz	short check_bpb_mediabyte ; no need for	nop
 12858                                  		;cmp	byte [disksector], 0EBh ; how about a short jump?
 12859                                  		;jnz	short invalidbootsec
 12860                                  		;cmp	byte [disksector+2], 90h ; is next one a nop?
 12861                                  		;jnz	short invalidbootsec
 12862                                  
 12863                                  		; 02/09/2023 (PCDOS 7.1)
 12864 000007C1 A0[5201]                		mov	al, [disksector]
 12865 000007C4 3C69                    		cmp	al, 69h		; is it a direct jump?
 12866 000007C6 740F                    		je	short check_bpb_mediabyte
 12867                                  					; don't need to find a nop
 12868 000007C8 3CE9                    		cmp	al, 0E9h	; dos 2.0 jump?
 12869 000007CA 740B                    		je	short check_bpb_mediabyte
 12870                                  					; no need for nop
 12871 000007CC 3CEB                    		cmp	al, 0EBh	; how about a short jump?
 12872 000007CE 7530                    		jne	short invalidbootsec
 12873 000007D0 803E[5401]90            		cmp	byte [disksector+2], 90h ; is next one a nop?
 12874 000007D5 7529                    		jne	short invalidbootsec
 12875                                  
 12876                                  ; 15/10/5022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 12877                                  ;
 12878                                  ;; 10/03/2019
 12879                                  ;; (MSDOS 3.3, MSDISK.ASM, 1988)
 12880                                  ;;
 12881                                  ;; Don't have to perform the following signature check since
 12882                                  ;; we need to check the media byte even with the good signatured diskette.
 12883                                  ;;
 12884                                  ;;check_signature:
 12885                                  ;;		cmp	word [cs:disksector+1FEh],0AA55h ; see if non-ibm
 12886                                  ;;							 ; disk or 1.x media.
 12887                                  ;;		jz	short checksinglesided ; go see if singled sided medium.
 12888                                  ;;					       ; may need some special handling
 12889                                  
 12890                                  ; check for non-ibm disks which do not have the signature AA55h at the
 12891                                  ; end of the boot sector, but still have a valid boot sector. this is done
 12892                                  ; by examining the media descriptor in the boot sector.
 12893                                  
 12894                                  		; 19/10/2022
 12895                                  check_bpb_mediabyte:
 12896 000007D7 A0[6701]                		mov	al, [disksector+15h]
 12897                                  					; [disksector+EXT_BOOT.BPB+EBPB.MEDIADESCRIPTOR]
 12898 000007DA 50                      		push	ax ; 02/09/2023
 12899 000007DB 24F0                    		and	al, 0F0h
 12900 000007DD 3CF0                    		cmp	al, 0F0h	; allow	for strange media
 12901 000007DF 58                      		pop	ax ; 02/09/2023
 12902 000007E0 751E                    		jnz	short invalidbootsec
 12903                                  
 12904                                  ; there were some (apparently a lot of them) diskettes that had been formatted
 12905                                  ; under dos 3.1 and earlier versions which have invalid bpbs in their boot
 12906                                  ; sectors. these are specifically diskettes that were formatted in drives
 12907                                  ; with one head, or whose side 0 was bad. these contain bpbs in the boot
 12908                                  ; sector that have the sec/clus field set to 2 instead of 1, as is standard
 12909                                  ; in dos. in order to support them, we have to introduce a "hack" that will
 12910                                  ; help our build bpb routine to recognise these specific cases, and to
 12911                                  ; set up out copy of the bpb accordingly.
 12912                                  ; we do this by checking to see if the boot sector is off a diskette that
 12913                                  ; is single-sided and is a pre-dos 3.20 diskette. if it is, we set the
 12914                                  ; sec/clus field to 1. if not, we carry on as normal.
 12915                                  
 12916                                  checksinglesided:
 12917                                  		;mov	al, [disksector+15h]
 12918                                  		; 02/09/2023
 12919                                  		; al = [disksector+15h]
 12920 000007E2 3CF0                    		cmp	al, 0F0h
 12921 000007E4 741B                    		jz	short gooddsk
 12922 000007E6 A801                    		test	al, 1
 12923 000007E8 7517                    		jnz	short gooddsk
 12924 000007EA 813E[5A01]332E          		cmp	word [disksector+8], 2E33h ; "3."
 12925 000007F0 7507                    		jnz	short mustbeearlier
 12926 000007F2 803E[5C01]32            		cmp	byte [disksector+0Ah], 32h ; "2"
 12927 000007F7 7308                    		jnb	short gooddsk
 12928                                  
 12929                                  ; we must have a pre-3.20 diskette. set the sec/clus field to 1
 12930                                  
 12931                                  mustbeearlier:				
 12932 000007F9 C606[5F01]01            		mov	byte [disksector+0Dh], 1
 12933                                  					; [disksector+EXT_BOOT.BPB+EBPB.SECTORSPERCLUSTER]
 12934 000007FE EB01                    		jmp	short gooddsk
 12935                                  ; ---------------------------------------------------------------------------
 12936                                  
 12937                                  invalidbootsec:				
 12938 00000800 43                      		inc	bx		; indicate that boot sector invalid
 12939                                  		; 10/12/2022
 12940                                  movbpb_ret:
 12941                                  gooddsk:				
 12942 00000801 F8                      		clc
 12943                                  err_ret:
 12944 00000802 C3                      		retn
 12945                                  ; ---------------------------------------------------------------------------
 12946                                  
 12947                                  		; 10/12/2022
 12948                                  ;err_ret:				
 12949                                  		;retn
 12950                                  
 12951                                  ; =============== S U B	R O U T	I N E =======================================
 12952                                  
 12953                                  ; 15/10/2022
 12954                                  ; ---------------------------------------------------------------------------
 12955                                  ; 'movbpb' moves the bpb read from the boot sector into registers for use by
 12956                                  ; getbp routine at has1
 12957                                  ;
 12958                                  ; if the set_id_flag is 1, and if an extended boot record, then set volume
 12959                                  ; serial number, volume label, file system id in bds according to
 12960                                  ; the boot record. after that, this routine will set the set_id_flag to 2
 12961                                  ; to signal that volume label is set already from the extended boot record
 12962                                  ; (so, don't set it again by calling "set_volume_id" routine which uses
 12963                                  ; the volume label in the root directory.)
 12964                                  ; ---------------------------------------------------------------------------
 12965                                  
 12966                                  ; 10/03/2019 - Retro DOS v4.0
 12967                                  
 12968                                  ; 22/12/2023
 12969                                  %if 0
 12970                                  		; 19/10/2022
 12971                                  movbpb:
 12972                                  		mov	dh, [disksector+0Dh]
 12973                                  					; disksector+EXT_BOOT.BPB+EBPB.SECTORSPERCLUSTER]
 12974                                  					; sectors per unit
 12975                                  		mov	bh, [disksector+11h]
 12976                                  					; [disksector+EXT_BOOT.BPB+EBPB.ROOTENTRIES]
 12977                                  					; number of directory entries
 12978                                  		mov	cx, [disksector+13h]
 12979                                  					; [disksector+EXT_BOOT.BPB+EBPB.TOTALSECTORS]
 12980                                  					; size of drive
 12981                                  		mov	ah, [disksector+15h]
 12982                                  					; [disksector+EXT_BOOT.BPB+EBPB.MEDIADESCRIPTOR]
 12983                                  					; media	descriptor
 12984                                  		mov	al, [disksector+16h];
 12985                                  					; [disksector+EXT_BOOT.BPB+EBPB.SECTORSPERFAT]
 12986                                  					; number of fat	sectors
 12987                                  		mov	bl, [disksector+18h]
 12988                                  					; [disksector+EXT_BOOT.BPB+EBPB.SECTORSPERTRACK]
 12989                                  					; sectors per track
 12990                                  		mov	dl, [disksector+1Ah]
 12991                                  					; [disksector+EXT_BOOT.BPB+EBPB.HEADS]
 12992                                  					; number of heads
 12993                                  %else
 12994                                  		; 22/12/2023 - Retro DOS v5.0
 12995                                  		; (PCDOS 7.1 IBMBIO.COM, BIOSCODE:0814h)
 12996                                  movbpb:
 12997 00000803 57                      		push	di
 12998 00000804 83C706                  		add	di, 6		; BDS+6 = BDS.BPB
 12999 00000807 8D36[5D01]              		lea	si, [disksector+0Bh]
 13000 0000080B B93500                  		mov	cx, 53		; copy bios parameters block
 13001                                  					; from BPB_BytsPerSec to (FAT32) BS_DrvNum (excluded)
 13002 0000080E FC                      		cld
 13003 0000080F F3A4                    		rep movsb
 13004 00000811 8B4CD3                  		mov	cx, [si-45]	; si = disksector+64 -> 64-45 = 19
 13005                                  					; disksektor+19 = BPB_TotSec16
 13006 00000814 31C0                    		xor	ax, ax
 13007 00000816 E308                    		jcxz	movbpb_bigdisk
 13008 00000818 26894DE0                		mov	[es:di-32], cx	; write 16 bit total sectors
 13009                                  					; to 32 bit total sectors field
 13010 0000081C 268945E2                		mov	[es:di-30], ax	; BPB_TotalSec32+2 (BDS offset 29, BPB offset 23)
 13011                                  movbpb_bigdisk:
 13012 00000820 3944D6                  		cmp	[si-42], ax     ; BPB_FATSz16 = disksector+22
 13013 00000823 740F                    		jz	short movbpb_fat32
 13014                                  movbpb_fat:
 13015 00000825 83EF1C                  		sub	di, 28		; di = BDS offset 31 (BPB offset 25)
 13016 00000828 B10C                    		mov	cl, 12
 13017                                  		;mov	cx, 12	; clear 12 byte extended BDS (FAT32) fields
 13018                                  					; (which are used only for FAT32 disks)
 13019 0000082A F3AA                    		rep stosb
 13020 0000082C 48                      		dec	ax		; -1 ; 0FFFFh
 13021 0000082D AB                      		stosw			; set BDS offset 43 (dword) to -1
 13022                                  					; dword [BDS.BPB_FSInfo] = 0FFFFFFFFh
 13023 0000082E AB                      		stosw
 13024 0000082F 40                      		inc	ax		; ax = 0
 13025 00000830 B10C                    		mov	cl, 12		
 13026                                  		;mov	cx, 12		; clear BDS offset 47 to 59
 13027                                  					; (BPB offset 41 to 53) (disksector offset 52 to 64)
 13028 00000832 F3AA                    		rep stosb
 13029                                  movbpb_fat32:
 13030 00000834 5F                      		pop	di
 13031                                  %endif
 13032 00000835 803E[9B04]01            		cmp	byte [set_id_flag], 1 ; called by get_bpb?
 13033 0000083A 75C5                    		jnz	short movbpb_ret
 13034 0000083C E81200                  		call	mov_media_ids
 13035 0000083F 7205                    		jb	short movbpb_conv ; conventional boot record?
 13036 00000841 C606[9B04]02            		mov	byte [set_id_flag], 2 ; signals that volume id is set
 13037                                  movbpb_conv:
 13038 00000846 803E[7700]01            		cmp	byte [fhave96], 1
 13039 0000084B 75B4                    		jnz	short movbpb_ret
 13040 0000084D E83B14                  		call	resetchanged	; reset	flags in bds to	not fchanged.
 13041                                  		; 10/12/2022
 13042                                  		; cf = 0
 13043                                  ;movbpb_ret:
 13044                                  		;clc
 13045 00000850 C3                      		retn
 13046                                  
 13047                                  ; =============== S U B	R O U T	I N E =======================================
 13048                                  
 13049                                  ;copy the boot_serial number, volume id, and filesystem id from the
 13050                                  ;***extended boot record*** in ds:disksector to the bds table pointed
 13051                                  ;by es:di.
 13052                                  
 13053                                  ;in.) es:di -> bds
 13054                                  ;     ds:disksector = valid extended boot record.
 13055                                  ;out.) vol_serial, bds_volid and bds_system_id in bds are set according to
 13056                                  ;      the boot record information.
 13057                                  ;     carry flag set if not an extended bpb.
 13058                                  ;     all registers saved except the flag.
 13059                                  
 13060                                  ; 22/12/2023
 13061                                  %if 0
 13062                                  		; 19/10/2022
 13063                                  mov_media_ids:		
 13064                                  		cmp	byte [disksector+26h], 29h
 13065                                  					; [disksector+EXT_BOOT.SIG],
 13066                                  					; EXT_BOOT_SIGNATURE
 13067                                  		jnz	short mmi_not_ext
 13068                                  		push	cx
 13069                                  		mov	cx, [disksector+27h]
 13070                                  					; [disksector+EXT_BOOT.SERIAL]
 13071                                  		mov	[es:di+57h], cx	; [es:di+BDS.vol_serial]
 13072                                  		mov	cx, [disksector+29h]
 13073                                  					; [disksector+EXT_BOOT.SERIAL+2]
 13074                                  		mov	[es:di+59h], cx	; [es:di+BDS.vol_serial+2]
 13075                                  		push	di
 13076                                  		push	si
 13077                                  		mov	cx, 11		; size_of_EXT_BOOT_VOL_LABEL
 13078                                  		mov	si, disksector+2Bh
 13079                                  		;mov	si, (offset disksector+2Bh) ;
 13080                                  					; disksector+EXT_BOOT.VOL_LABEL
 13081                                  		add	di, 75		; BDS.volid
 13082                                  		rep movsb
 13083                                  		;mov	cx, 8		; size_of_EXT_SYSTEM_ID
 13084                                  		; 10/12/2022
 13085                                  		mov	cl, 8 ; cx = 8
 13086                                  		mov	si, disksector+36h
 13087                                  		;mov	si, (offset disksector+36h) ; disksector+EXT_BOOT.SYSTEM_ID
 13088                                  		add	di, 5		; (BDS.filesys_id-BDS.volid)-size_of_EXT_BOOT_VOL_LABEL
 13089                                  		rep movsb
 13090                                  		pop	si
 13091                                  		pop	di
 13092                                  		pop	cx
 13093                                  		; 10/12/2022
 13094                                  		; cf = 0
 13095                                  		;clc		; this clc is not required (16/06/2019 - Erdogan Tan)
 13096                                  				; (20/09/2022)
 13097                                  		retn
 13098                                  %else
 13099                                  		; 22/12/2023 - Retro DOS v5.0
 13100                                  		; (PCDOS 7.1 IBMBIO.COM, BIOSCODE:0865h)
 13101                                  		;;;		
 13102                                  mov_media_ids:
 13103 00000851 833E[6801]00            		cmp	word [disksector+16h], 0 ; BPB.FATSz16
 13104 00000856 7507                    		jnz	short mmi_chk_fat
 13105 00000858 803E[9401]29            		cmp	byte [disksector+42h], 29h
 13106                                  					; [disksector+FAT32_EXT_BOOT.SIG],
 13107                                  					; EXT_BOOT_SIGNATURE
 13108 0000085D EB05                    		jmp	short mmi_chk_fat32
 13109                                  mmi_chk_fat:
 13110 0000085F 803E[7801]29            		cmp	byte [disksector+26h], 29h
 13111                                  					; [disksector+EXT_BOOT.SIG],EXT_BOOT_SIGNATURE
 13112                                  mmi_chk_fat32:
 13113 00000864 7543                    		jnz	short mmi_not_ext
 13114 00000866 51                      		push	cx
 13115 00000867 50                      		push	ax
 13116 00000868 57                      		push	di
 13117 00000869 56                      		push	si
 13118 0000086A 1E                      		push	ds
 13119 0000086B 833E[6801]00            		cmp	word [disksector+16h], 0 ; BPB.FATSz16
 13120 00000870 750C                    		jnz	short mmi_fat
 13121                                  
 13122                                  mmi_fat32:				; FAT32 file system
 13123                                  		;lds	cx, dword ptr ds:disksector+43h
 13124 00000872 C50E[9501]              		lds	cx, [disksector+43h]	; BS_FAT32_VolID
 13125 00000876 BE[9901]                		mov	si, disksector+47h	; BS_FAT32_VolLab
 13126 00000879 B8[A401]                		mov	ax, disksector+52h	; BS_FAT32_FilSysType
 13127 0000087C EB0A                    		jmp	short mmi_do
 13128                                  
 13129                                  mmi_fat:
 13130                                  		;lds	cx, dword ptr ds:disksector+27h
 13131 0000087E C50E[7901]              		lds	cx, [disksector+27h]	; BS_VolID
 13132 00000882 BE[7D01]                		mov	si, disksector+2Bh	; BS_VolLab
 13133 00000885 B8[8801]                		mov	ax, disksector+36h	; BS_FilSysType
 13134                                  mmi_do:
 13135 00000888 26898D8900              		mov	[es:di+89h], cx	; [es:di+BDS.vol_serial]
 13136                                  					; (BDS offset 137)
 13137 0000088D 268C9D8B00              		mov	[es:di+8Bh], ds	; [es:di+BDS.vol_serial+2]
 13138 00000892 1F                      		pop	ds
 13139 00000893 B90B00                  		mov	cx, 11
 13140 00000896 83C77D                  		add	di, 125		; di = di+125 = BDS.volid
 13141 00000899 F3A4                    		rep movsb
 13142 0000089B B108                    		mov	cl, 8		; di = di+136
 13143 0000089D 89C6                    		mov	si, ax		; BS_FilSysType or BS_FAT32_FilSysType
 13144 0000089F 83C705                  		add	di, 5		; di = di+141 = BDS.filesys_id
 13145 000008A2 F3A4                    		rep movsb
 13146 000008A4 5E                      		pop	si
 13147 000008A5 5F                      		pop	di
 13148 000008A6 58                      		pop	ax
 13149 000008A7 59                      		pop	cx
 13150                                  		;clc	; this clc is not required (16/06/2019 - Erdogan Tan)
 13151                                  			; (20/09/2022 - 27/06/2023) MSDOS 6.21 .. PCDOS 7.1
 13152 000008A8 C3                      		retn
 13153                                  %endif
 13154                                  		;;;
 13155                                  
 13156                                  ; ---------------------------------------------------------------------------
 13157                                  
 13158                                  mmi_not_ext:				
 13159 000008A9 F9                      		stc
 13160 000008AA C3                      		retn
 13161                                  
 13162                                  ; =============== S U B	R O U T	I N E =======================================
 13163                                  
 13164                                  ; 15/10/2022
 13165                                  ; --------------------------------------------------------------
 13166                                  ; read in the fat sector and get the media byte from it.
 13167                                  ; input : es:di -> bds
 13168                                  ; output:
 13169                                  ;	  carry set if an error occurs, ax contains error code.
 13170                                  ;	  otherwise, ah contains media byte on exit
 13171                                  ; --------------------------------------------------------------
 13172                                  
 13173                                  readfat:	
 13174                                  		;mov	dh, 0
 13175                                  		; 10/12/2022
 13176 000008AB 30F6                    		xor	dh, dh
 13177 000008AD B90200                  		mov	cx, 2		; head 0
 13178                                  					; cylinder 0, sector 2
 13179 000008B0 E80500                  		call	read_sector
 13180 000008B3 7202                    		jb	short bad_fat_ret
 13181 000008B5 8A27                    		mov	ah, [bx]	; media	byte
 13182                                  bad_fat_ret:				
 13183 000008B7 C3                      		retn
 13184                                  
 13185                                  ; =============== S U B	R O U T	I N E =======================================
 13186                                  
 13187                                  ; 15/10/2022
 13188                                  
 13189                                  ; ---------------------------------------------------------------------------
 13190                                  ; read a single sector into the temp buffer.
 13191                                  ; perform three retries in case of error.
 13192                                  ;   inputs:	es:[di].bds_drivenum has physical drive to use
 13193                                  ;		cx has sector and cylinder
 13194                                  ;		dh has head
 13195                                  ;		es:di has bds
 13196                                  ;		ds has Bios_Data
 13197                                  ;
 13198                                  ;   outputs:	carry clear
 13199                                  ;		    Bios_Data:bx point to sector
 13200                                  ;		       (note: some callers assume location of buffer)
 13201                                  ;
 13202                                  ;		carry set
 13203                                  ;		    ax has rom error code
 13204                                  ;
 13205                                  ; register bp is preserved.
 13206                                  ; ---------------------------------------------------------------------------
 13207                                  
 13208                                  ; 10/03/2019 - Retro DOS v4.0
 13209                                  ; 22/12/2023 - Retro DOS v5.0
 13210                                  
 13211                                  		; 19/10/2022
 13212                                  read_sector:
 13213 000008B8 55                      		push	bp
 13214 000008B9 BD0300                  		mov	bp, 3		; make 3 attempts
 13215 000008BC 268A5504                		mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 13216 000008C0 BB[5201]                		mov	bx, disksector	; get es:bx to point to	buffer
 13217                                  rd_ret:
 13218 000008C3 06                      		push	es
 13219 000008C4 1E                      		push	ds
 13220 000008C5 07                      		pop	es
 13221 000008C6 B80102                  		mov	ax, 201h
 13222 000008C9 CD13                    		int	13h		; DISK - READ SECTORS INTO MEMORY
 13223                                  					; AL = number of sectors to read, CH = track, CL = sector
 13224                                  					; DH = head, DL	= drive, ES:BX -> buffer to fill
 13225                                  					; Return: CF set on error, AH =	status,	AL = number of sectors read
 13226 000008CB 07                      		pop	es
 13227 000008CC 734A                    		jnb	short okret2
 13228                                  rd_rty:
 13229 000008CE E81105                  		call	again		; reset	disk, decrement	bp, preserve ax
 13230 000008D1 7442                    		jz	short err_rd_ret
 13231                                  
 13232                                  		; 22/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 13233 000008D3 26F6453F01              		test	byte [es:di+3Fh], 1
 13234                                  		;test	byte [es:di+23h], 1
 13235                                  		;;test	byte ptr [es:di+23h], 1	; [es:di+BDS.flags]
 13236                                  					; fnon_removable
 13237 000008D8 75E9                    		jnz	short rd_ret
 13238 000008DA 803E[A905]00            		cmp	byte [media_set_for_format], 0
 13239 000008DF 7510                    		jnz	short rd_skip1_dpt
 13240 000008E1 50                      		push	ax
 13241 000008E2 1E                      		push	ds		; for retry, set the head settle time to 0Fh
 13242 000008E3 C536[2D01]              		lds	si, [dpt]
 13243                                  		;mov	al, [si+9]	; [si+DISK_PARMS.DISK_HEAD_STTL]
 13244                                  		;mov	byte [si+9], 15 ; [si+DISK_PARMS.DISK_HEAD_STTL]
 13245                                  		;			; NORMSETTLE
 13246                                  		; 12/12/2022
 13247 000008E7 B00F                    		mov	al, 15
 13248 000008E9 864409                  		xchg	al, [si+9]
 13249                                  		; 
 13250 000008EC 1F                      		pop	ds
 13251 000008ED A2[2A01]                		mov	[save_head_sttl], al
 13252 000008F0 58                      		pop	ax
 13253                                  rd_skip1_dpt:
 13254 000008F1 06                      		push	es
 13255 000008F2 1E                      		push	ds
 13256 000008F3 07                      		pop	es
 13257 000008F4 B80102                  		mov	ax, 201h
 13258 000008F7 CD13                    		int	13h		; DISK - READ SECTORS INTO MEMORY
 13259                                  					; AL = number of sectors to read, CH = track, CL = sector
 13260                                  					; DH = head, DL	= drive, ES:BX -> buffer to fill
 13261                                  					; Return: CF set on error, AH =	status,	AL = number of sectors read
 13262 000008F9 07                      		pop	es
 13263 000008FA 9C                      		pushf
 13264 000008FB 803E[A905]00            		cmp	byte [media_set_for_format], 0
 13265 00000900 750E                    		jnz	short rd_skip2_dpt
 13266 00000902 50                      		push	ax
 13267 00000903 A0[2A01]                		mov	al, [save_head_sttl]
 13268 00000906 1E                      		push	ds
 13269 00000907 C536[2D01]              		lds	si, [dpt]
 13270 0000090B 884409                  		mov	[si+9],	al	; [si+DISK_PARMS.DISK_HEAD_STTL]
 13271 0000090E 1F                      		pop	ds
 13272 0000090F 58                      		pop	ax
 13273                                  rd_skip2_dpt:
 13274 00000910 9D                      		popf
 13275 00000911 7305                    		jnb	short okret2
 13276 00000913 EBB9                    		jmp	short rd_rty
 13277                                  ; ---------------------------------------------------------------------------
 13278                                  
 13279                                  err_rd_ret:
 13280 00000915 B2FF                    		mov	dl, 0FFh	; make sure we ask rom if media	has changed
 13281                                  					; return error
 13282 00000917 F9                      		stc
 13283                                  
 13284                                  ; update information pertaining to last drive accessed, time of access, last
 13285                                  ; track accessed in that drive.
 13286                                  
 13287                                  okret2:
 13288 00000918 8816[7600]              		mov	[step_drv], dl	; set up for head settle logic in disk
 13289 0000091C 8816[1E01]              		mov	[tim_drv], dl	; save drive last accessed
 13290                                  		
 13291                                  		; 22/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 13292 00000920 26886D78                		mov	[es:di+78h], ch
 13293                                  		;mov	[es:di+46h], ch	; [es:di+BDS.track]
 13294                                  					; save last track accessed on this drive
 13295                                  					; preserve flags in case error occurred
 13296 00000924 9C                      		pushf
 13297 00000925 E89A04                  		call	set_tim
 13298 00000928 9D                      		popf			; restore flags
 13299 00000929 5D                      		pop	bp
 13300 0000092A C3                      		retn
 13301                                  
 13302                                  ;----------------------------------------------------------------------------
 13303                                  ;	disk open/close routines
 13304                                  ;----------------------------------------------------------------------------
 13305                                  
 13306                                  dsk_open:				; 2C7h:80Ah = 70h:2D7Ah
 13307 0000092B 803E[7700]00            		cmp	byte [fhave96], 0
 13308 00000930 7407                    		jz	short dsk_open_exit ; done if no changeline support
 13309 00000932 E86FFC                  		call	SetDrive	; get bds for drive
 13310                                  		; 22/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 13311 00000935 26FF453C                		inc	word [es:di+3Ch] ; [es:di+BDS.opcnt] ; BDS offset 60
 13312                                  		;inc	word [es:di+20h] ; [es:di+BDS.opcnt]
 13313                                  dsk_open_exit:
 13314                                  		; 10/12/2022
 13315                                  		; cf = 0			
 13316                                  		;clc		; CF is	already	ZERO here (18/09/2022, MSDOS 5.0 IO.SYS)
 13317                                  				; (19/07/2019 -	Erdogan	Tan - MSDOS 6.0	IO.SYS - retrodos4.s)
 13318 00000939 C3                      		retn
 13319                                  ; ---------------------------------------------------------------------------
 13320                                  
 13321                                  dsk_close:				; 2C7h:81Ah = 70h:2D8Ah
 13322 0000093A 803E[7700]00            		cmp	byte [fhave96], 0
 13323 0000093F 740E                    		jz	short exitjx	; done if no changeline	support
 13324 00000941 E860FC                  		call	SetDrive	; get bds for drive
 13325                                  		; 22/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 13326 00000944 26837D3C00              		cmp	word [es:di+3Ch], 0 ; [es:di+BDS.opcnt] ; BDS off 60
 13327                                  		;cmp	word [es:di+20h], 0 ; [es:di+BDS.opcnt]
 13328 00000949 7404                    		jz	short exitjx	; watch	out for	wrap
 13329                                  		; 22/12/2023
 13330 0000094B 26FF4D3C                		dec	word [es:di+3Ch]
 13331                                  		;dec	word [es:di+20h]
 13332                                  exitjx:
 13333                                  		; 10/12/2022
 13334                                  		; cf = 0
 13335                                  		;clc		; CF is	already	ZERO here (18/09/2022, MSDOS 5.0 IO.SYS)
 13336                                  				; (19/07/2019 -	Erdogan	Tan - MSDOS 6.0	IO.SYS - retrodos4.s)
 13337 0000094F C3                      		retn
 13338                                  
 13339                                  ;----------------------------------------------------------------------------
 13340                                  ;		disk removable routine
 13341                                  ;----------------------------------------------------------------------------
 13342                                  
 13343                                  		; al is	unit #
 13344                                  dsk_rem:				; 2C7h:831h = 70h:2DA1h
 13345 00000950 E851FC                  		call	SetDrive	; get bds for this drive
 13346                                  		; 22/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 13347                                  		;test	byte [es:di+BDS.flags], fnon_removable
 13348 00000953 26F6453F01              		test	byte [es:di+3Fh], 1 ; [es:di+BDS.flags], fnon_removable
 13349 00000958 74F5                    		jz	short exitjx
 13350                                  		;test	byte [es:di+23h], 1 ; [es:di+BDS.flags], fnon_removable
 13351                                  		;;jnz	short x_bus_exit ; non_rem
 13352                                  		;jnz	short non_rem	; 15/10/2022
 13353                                  		;; 10/12/2022
 13354                                  		;; cf = 0
 13355                                  		;;clc			; CF is already ZERO here
 13356                                  		;			; 15/10/2022
 13357                                  		;retn
 13358                                  ; ---------------------------------------------------------------------------
 13359                                  
 13360                                  non_rem:
 13361                                  x_bus_exit:
 13362 0000095A B403                    		mov	ah, 3		; 2C7h:83Dh = 0070h:2DADh
 13363                                  					; return busy status
 13364 0000095C F9                      		stc
 13365                                  dsk_ret:
 13366 0000095D C3                      		retn
 13367                                  
 13368                                  ;----------------------------------------------------------------------------
 13369                                  ;		disk i/o routines
 13370                                  ;----------------------------------------------------------------------------
 13371                                  
 13372                                  dsk_writv:				; 2C7h:841h = 70h:2DB1h
 13373                                  		;mov	word [wrtverify], 103h
 13374                                  		; 19/10/2022
 13375 0000095E C706[2001]0301          		mov	word [rflag], 103h
 13376                                  		;mov	word ptr ds:rflag, 103h	; write	and verify
 13377 00000964 EB06                    		jmp	short dsk_cl
 13378                                  ; ---------------------------------------------------------------------------
 13379                                  
 13380                                  dsk_writ:				; 2C7h:849h = 70h:2DB9h
 13381                                  		;mov	word [wrtverify], 3
 13382                                  		; 19/10/2022
 13383 00000966 C706[2001]0300          		mov	word [rflag], 3
 13384                                  		;mov	word ptr ds:rflag, 3 ; romwrite
 13385                                  dsk_cl:
 13386 0000096C E8A400                  		call	diskio		; romwrite
 13387                                  ; ---------------------------------------------------------------------------
 13388                                  
 13389                                  dsk_io:
 13390 0000096F 73EC                    		jnb	short dsk_ret
 13391 00000971 E963F7                  		jmp	bc_err_cnt
 13392                                  ; ---------------------------------------------------------------------------
 13393                                  
 13394                                  dsk_read:				; ; 2C7h:857h =	70h:2DC7h
 13395 00000974 E89700                  		call	diskrd
 13396 00000977 EBF6                    		jmp	short dsk_io
 13397                                  
 13398                                  ; =============== S U B	R O U T	I N E =======================================
 13399                                  
 13400                                  ; 15/10/2022
 13401                                  ; 10/03/2019 - Retro DOS v4.0
 13402                                  ; 22/12/2023 - Retro DOS v5.0
 13403                                  
 13404                                  ;-----------------------------------------------------------
 13405                                  ; miscellaneous odd jump routines. 
 13406                                  ; moved out of mainline for speed.
 13407                                  
 13408                                  ; if we have a system where we have virtual drives, we need 
 13409                                  ; to prompt the user to place the correct disk in the drive.
 13410                                  ;
 13411                                  ;	assume es:di -> bds, ds:->Bios_Data
 13412                                  ;-----------------------------------------------------------
 13413                                  
 13414                                  		; 19/10/2022
 13415                                  checksingle:
 13416 00000979 50                      		push	ax
 13417 0000097A 53                      		push	bx
 13418                                  		; 22/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 13419 0000097B 268B5D3F                		mov	bx, [es:di+3Fh]	; [es:di+BDS.flags]
 13420                                  		;mov	bx, [es:di+23h]	; [es:di+BDS.flags]
 13421                                  
 13422                                  ; if hard drive, cannot change disk.
 13423                                  ; if current owner of physical drive, no need to change diskette.
 13424                                  
 13425 0000097F F6C321                  		test	bl, 21h		; fnon_removable|fi_own_physical
 13426 00000982 7573                    		jnz	short singleret
 13427 00000984 F6C310                  		test	bl, 10h		; fi_am_mult
 13428                                  					; is there a drive sharing this	physical drive?
 13429 00000987 746E                    		jz	short singleret
 13430                                  
 13431                                  ; look for the previous owner of this physical drive
 13432                                  ; and reset its ownership flag.
 13433                                  
 13434 00000989 268A4504                		mov	al, [es:di+4]	; [es:di+BDS.drivenum]
 13435                                  					; get physical drive number
 13436 0000098D 06                      		push	es		; preserve pointer to current bds
 13437 0000098E 57                      		push	di
 13438 0000098F C43E[1901]              		les	di, [start_bds] ; get first bds
 13439                                  scan_list:
 13440 00000993 26384504                		cmp	[es:di+4], al
 13441 00000997 7553                    		jnz	short scan_skip	; Not our drive. Try next bds.
 13442 00000999 B320                    		mov	bl, 20h	; ' '   ; fi_own_physical ; test ownership flag
 13443                                  		; 22/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 13444 0000099B 26845D3F                		test	[es:di+3Fh], bl	; [es:di+BDS.flags]
 13445                                  		;test	[es:di+23h], bl
 13446 0000099F 744B                    		jz	short scan_skip	; he doesn't own it either. continue
 13447 000009A1 26305D3F                		xor	[es:di+3Fh], bl
 13448                                  		;xor	[es:di+23h], bl	; reset	ownership flag
 13449 000009A5 5F                      		pop	di		; restore pointer to current bds
 13450 000009A6 07                      		pop	es
 13451 000009A7 26085D3F                		or	[es:di+3Fh], bl
 13452                                  		;or	[es:di+23h], bl	; ; set	ownership flag
 13453                                  
 13454                                  ; we examine the fsetowner flag. if it is set, then we are using the code in
 13455                                  ; checksingle to just set the owner of a drive. we must not issue the prompt
 13456                                  ; in this case.
 13457 000009AB 803E[7A00]01            		cmp	byte [fsetowner], 1
 13458 000009B0 7517                    		jnz	short not_fsetowner
 13459                                  		;cmp	byte ptr es:[di+4], 0 ;	are we handling	drive number 0 ?
 13460 000009B2 26807D0400              		cmp	byte [es:di+4], 0
 13461 000009B7 753E                    		jnz	short singleret
 13462 000009B9 268A4505                		mov	al, [es:di+5]
 13463                                  		;mov	al, es:[di+5]	; [es:di+BDS.drivelet]
 13464                                  					; get the DOS drive letter
 13465 000009BD 06                      		push	es
 13466 000009BE 8E06[1A00]              		mov	es, [zeroseg]
 13467 000009C2 26A20405                		mov	[es:LSTDRV], al
 13468                                  		;mov	es:504h, al	; [es:LSTDRV]
 13469                                  					; set up sdsb
 13470 000009C6 07                      		pop	es		; restore bds pointer
 13471 000009C7 EB2E                    		jmp	short singleret
 13472                                  ; ---------------------------------------------------------------------------
 13473                                  
 13474                                  ; to support "backward" compatibility with ibm's "single drive status byte"
 13475                                  ; we now check to see if we are in a single drive system and the application
 13476                                  ; has "cleverly" diddled the sdsb
 13477                                  
 13478                                  not_fsetowner:
 13479 000009C9 803E[7800]02            		cmp	byte [single], 2 ; if (single_drive_system)
 13480 000009CE 7517                    		jnz	short ignore_sdsb
 13481 000009D0 50                      		push	ax
 13482 000009D1 268A4505                		mov	al, [es:di+5]	; if (curr_drv == req_drv)
 13483 000009D5 88C4                    		mov	ah, al
 13484 000009D7 06                      		push	es
 13485 000009D8 8E06[1A00]              		mov	es, [zeroseg]
 13486 000009DC 2686060405              		xchg	al, [es:LSTDRV]
 13487                                  		;xchg	al, es:504h	; [es:LSTDRV]
 13488                                  					; then swap(curr_drv,req_drv)
 13489 000009E1 07                      		pop	es
 13490 000009E2 38C4                    		cmp	ah, al		; else
 13491 000009E4 58                      		pop	ax		; swap(curr_drv,req_drv)
 13492 000009E5 7410                    		jz	short singleret	; issue	swap_dsk_msg
 13493                                  ignore_sdsb:
 13494 000009E7 E8B710                  		call	swpdsk
 13495 000009EA EB0B                    		jmp	short singleret
 13496                                  ; ---------------------------------------------------------------------------
 13497                                  
 13498                                  scan_skip:
 13499 000009EC 26C43D                  		les	di, [es:di]
 13500                                  		;les	di, es:[di]	; [es:di+BDS.link]
 13501                                  					; go to	next bds
 13502 000009EF 83FFFF                  		cmp	di, 0FFFFh ; -1	; end of list?
 13503 000009F2 759F                    		jnz	short scan_list	; continue until hit end of list
 13504 000009F4 F9                      		stc
 13505 000009F5 5F                      		pop	di		; restore current bds
 13506 000009F6 07                      		pop	es
 13507                                  singleret:
 13508 000009F7 5B                      		pop	bx
 13509 000009F8 58                      		pop	ax
 13510 000009F9 C3                      		retn
 13511                                  
 13512                                  ; 22/12/2023
 13513                                  %if 0
 13514                                  ; ---------------------------------------------------------------------------
 13515                                  
 13516                                  baddrive:
 13517                                  		mov	al, 8		; sector not found
 13518                                  		jmp	short baddrive_ret
 13519                                  %endif
 13520                                  
 13521                                  ; ---------------------------------------------------------------------------
 13522                                  
 13523                                  unformatteddrive:
 13524 000009FA B007                    		mov	al, 7		; unknown media
 13525                                  ;baddrive_ret:
 13526 000009FC F9                      		stc
 13527                                  ; ---------------------------------------------------------------------------
 13528                                  
 13529                                  ioret:
 13530 000009FD C3                      		retn
 13531                                  
 13532                                  ; ---------------------------------------------------------------------------
 13533                                  		
 13534                                  		; 22/12/2023 - Retro DOS v5.0
 13535                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0A1Bh
 13536                                  
 13537 000009FE 10                      LBA_Packet:	db 16			; ...
 13538                                  					; DAP buffer
 13539 000009FF 00                                      db 0
 13540 00000A00 0000                    dap_block_cnt:	dw 0			; ...
 13541 00000A02 00000000                dap_trans_buf:	dd 0			; ...
 13542 00000A06 00000000                dap_lba_value:	dd 0			; ...
 13543 00000A0A 00000000                		dd 0
 13544                                  
 13545                                  ; ---------------------------------------------------------------------------
 13546                                  
 13547                                  ; 15/10/2022
 13548                                  
 13549                                  ; ---------------------------------------------------------------------------
 13550                                  ;	disk i/o handler
 13551                                  ;
 13552                                  ;	al = drive number (0-6)
 13553                                  ;	ah = media descriptor
 13554                                  ;	cx = sector count
 13555                                  ;	dx = first sector (low)
 13556                                  ;	[start_sec_h] = first sector (high)  32 bit calculation.
 13557                                  ;	ds = cs
 13558                                  ;	es:di = transfer address
 13559                                  ;	[rflag]=operation (2=read, 3=write)
 13560                                  ;	[verify]=1 for verify after write
 13561                                  ;
 13562                                  ;	if successful carry flag = 0
 13563                                  ;	  else cf=1 and al contains error code
 13564                                  ; ---------------------------------------------------------------------------
 13565                                  
 13566                                  		; 12/12/2023
 13567                                  		; ds = biosdata segment (cs = bioscode segment)
 13568                                  diskrd:	
 13569                                  		;mov	ds:rflag, 2	; romread
 13570                                  		; 19/10/2022
 13571 00000A0E C606[2001]02            		mov	byte [rflag], 2 ; romread
 13572                                  
 13573                                  ; =============== S U B	R O U T	I N E =======================================
 13574                                  
 13575                                  		; 22/12/2023 - Retro DOS v5.0
 13576                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0A30h
 13577                                  ; 22/12/2023
 13578                                  %if 0
 13579                                  		; 19/10/2022
 13580                                  diskio:
 13581                                  		mov	bx, di		; es:bx	= transfer address
 13582                                  		mov	[xfer_seg], es	; save transfer	segment
 13583                                  		call	SetDrive
 13584                                  		mov	al, [es:di+10h]	; [es:di+BDS.media]
 13585                                  		mov	[medbyt], al
 13586                                  		;jcxz	short ioret
 13587                                  		jcxz	ioret
 13588                                  
 13589                                  ; see if the media is formatted or not by checking the flags field in
 13590                                  ; in the bds. if it is unformatted we cannot allow i/o, so we should
 13591                                  ; go to the error exit at label unformatteddrive.
 13592                                  
 13593                                  		test	byte [es:di+24h], 2
 13594                                  		;test	byte ptr es:[di+24h], 2	; [es:di+BDS.flags+1]
 13595                                  					; unformatted_media
 13596                                  		jnz	short unformatteddrive
 13597                                  		mov	[seccnt], cx	; save sector count
 13598                                  		mov	[spsav], sp	; save sp
 13599                                  
 13600                                  ; ensure that we are trying to access valid sectors on the drive
 13601                                  
 13602                                  		mov	ax, dx
 13603                                  		xor	si, si ; 0
 13604                                  		add	dx, cx
 13605                                  		;adc	si, 0
 13606                                  		; 02/09/2023 (PCDOS 7.1)
 13607                                  		rcl	si, 1
 13608                                  		cmp	word [es:di+0Eh], 0 ; [es:di+BDS.totalsecs16]
 13609                                  					; 32 bit sector ?
 13610                                  		jz	short sanity32
 13611                                  		;cmp	si, 0
 13612                                  		; 02/09/2023
 13613                                  		or	si, si
 13614                                  		jnz	short baddrive
 13615                                  		cmp	dx, [es:di+0Eh]	; [es:di+BDS.totalsecs16]
 13616                                  		ja	short baddrive
 13617                                  		jmp	short sanityok
 13618                                  ; ---------------------------------------------------------------------------
 13619                                  
 13620                                  sanity32:
 13621                                  		add	si, [start_sec_h]
 13622                                  		cmp	si, [es:di+1Dh]	; [es:di+BDS.totalsecs32+2]
 13623                                  		jb	short sanityok
 13624                                  		ja	short baddrive
 13625                                  		cmp	dx, [es:di+1Bh]	; [es:di+BDS.totalsecs32]
 13626                                  		ja	short baddrive
 13627                                  sanityok:
 13628                                  		mov	dx, [start_sec_h]
 13629                                  		add	ax, [es:di+17h]	; [es:di+BDS.hiddensecs]
 13630                                  		adc	dx, [es:di+19h]	; [es:di+BDS.hiddensecs+2]
 13631                                  
 13632                                  ; now dx;ax have the physical first sector.
 13633                                  ; since the following procedures is going to destroy ax, let's
 13634                                  ; save it temporarily to saved_word.
 13635                                  
 13636                                  		mov	[saved_word], ax ; save the sector number (low)
 13637                                  
 13638                                  ; set up pointer to disk base table in [dpt]. we cannot assume that iosetup
 13639                                  ; will do it because we will skip the set up stuff with hard disks.
 13640                                  
 13641                                  		push	es
 13642                                  		;mov	es, [zeroseg]
 13643                                  		; 02/09/2023
 13644                                  		xor	si, si ; 0
 13645                                  		mov	es, si
 13646                                  		les	si, [es:DSKADR]
 13647                                  		;les	si, es:78h	; [es:DSKADR]
 13648                                  					; current disk parm table
 13649                                  		mov	[dpt], si
 13650                                  		mov	[dpt+2], es
 13651                                  		pop	es
 13652                                  		test	byte [es:di+23h], 1 ; [es:di+BDS.flags]
 13653                                  					; fnon_removable
 13654                                  		jnz	short skip_setup
 13655                                  		call	checksingle
 13656                                  
 13657                                  ; check to see if we have previously noted a change line. the routine
 13658                                  ; returns if everything is ok. otherwise, it pops off the stack and returns
 13659                                  ; the proper error code.
 13660                                  
 13661                                  		cmp	byte [fhave96], 0 ; do we have changeline support?
 13662                                  		jz	short diskio_nochangeline ; brif not
 13663                                  		call	checklatchio	; will do a sneaky pop stack return
 13664                                  					; if a disk error occurs
 13665                                  diskio_nochangeline:			
 13666                                  		call	iosetup		; set up tables	and variables for i/o
 13667                                  
 13668                                  ; now the settle values are correct for the following code
 13669                                  
 13670                                  skip_setup:
 13671                                  
 13672                                  ; 32 bit sector calculation.
 13673                                  ; dx:[saved_word] = starting sector number.
 13674                                  				
 13675                                  		mov	ax, dx
 13676                                  		xor	dx, dx
 13677                                  		;div	word [es:di+13h] ; [es:di+BDS.secpertrack]
 13678                                  					 ; divide by sec per track
 13679                                  		; 02/09/2023
 13680                                  		mov	cx, [es:di+13h]
 13681                                  		div	cx
 13682                                  		mov	[temp_h], ax
 13683                                  		mov	ax, [saved_word]
 13684                                  		div	cx ; 02/09/2023
 13685                                  		;div	word [es:di+13h] ; [es:di+BDS.secpertrack]
 13686                                  					; now, [temp_h]:ax = track #, dx = sector
 13687                                  		;inc	dl		; sector number	is 1 based.
 13688                                  		; 18/12/2022
 13689                                  		inc	dx
 13690                                  		mov	[cursec], dl	; save current sector
 13691                                  		mov	cx, [es:di+15h]	; es:di+BDS.heads]
 13692                                  					; get number of	heads
 13693                                  		push	ax
 13694                                  		xor	dx, dx
 13695                                  		mov	ax, [temp_h]	; divide tracks	by heads per cylinder
 13696                                  		div	cx
 13697                                  		mov	[temp_h], ax
 13698                                  		pop	ax
 13699                                  		div	cx		; now, [temp_h]:ax = cylinder #, dx = head
 13700                                  		cmp	word [temp_h], 0
 13701                                  		ja	short baddrive_brdg
 13702                                  		cmp	ax, 1024	; 2^10 currently maxium	for track #.
 13703                                  		ja	short baddrive_brdg
 13704                                  		mov	[curhd], dl	; save current head
 13705                                  		mov	[curtrk], ax	; save current track
 13706                                  
 13707                                  ; we are now set up for the i/o. normally, we consider the dma boundary
 13708                                  ; violations here. not true. we perform the operation as if everything is
 13709                                  ; symmetric; let the int 13 handler worry about the dma violations.
 13710                                  
 13711                                  		mov	ax, [seccnt]
 13712                                  		call	block		; (cas - call/ret)
 13713                                  		;call	done
 13714                                  		;retn
 13715                                  		; 18/12/2022
 13716                                  		jmp	done
 13717                                  %else
 13718                                  		;;;	; 22/12/2023
 13719                                  diskio:
 13720 00000A13 89FB                    		mov	bx, di		; al = drive number
 13721                                  					; cx = sector count
 13722                                  					; dx = first sector (low)
 13723                                  					; [start_sec_h] = first sector (high)
 13724                                  					;
 13725                                  					; es:bx = transfer address
 13726 00000A15 8C06[A804]              		mov	[xfer_seg], es	; save transfer segment
 13727 00000A19 E888FB                  		call	SetDrive
 13728 00000A1C 268A4510                		mov	al, [es:di+10h]	; [es:di+BDS.media]
 13729 00000A20 A2[1F01]                		mov	[medbyt], al
 13730 00000A23 E3D8                    		jcxz	ioret
 13731                                  
 13732                                  ; see if the media is formatted or not by checking the flags field in
 13733                                  ; in the bds. if it is unformatted we cannot allow i/o, so we should
 13734                                  ; go to the error exit at label unformatteddrive.
 13735                                  
 13736 00000A25 26F6454002              		test	byte [es:di+40h], 2 ; [es:di+BDS.flags+1]
 13737                                  					; unformatted_media
 13738 00000A2A 75CE                    		jnz	short unformatteddrive
 13739 00000A2C 890E[2201]              		mov	[seccnt], cx	; save sector count
 13740 00000A30 8926[3501]              		mov	[spsav], sp	; save sp
 13741                                  
 13742                                  ; ensure that we are trying to access valid sectors on the drive
 13743                                  
 13744 00000A34 89D0                    		mov	ax, dx
 13745 00000A36 31F6                    		xor	si, si ; 0
 13746 00000A38 01CA                    		add	dx, cx
 13747 00000A3A D1D6                    		rcl	si, 1
 13748 00000A3C 26837D0E00              		cmp	word [es:di+0Eh], 0 ; [es:di+BDS.totalsecs16]
 13749                                  					; > 32 bit sector ?
 13750 00000A41 740E                    		jz	short sanity32
 13751 00000A43 09F6                    		or	si, si
 13752 00000A45 7506                    		jnz	short baddrive
 13753 00000A47 263B550E                		cmp	dx, [es:di+0Eh]	; [es:di+BDS.totalsecs16]
 13754                                  		;ja	short baddrive
 13755                                  		;jmp	short sanityok
 13756                                  		; 22/12/2023
 13757 00000A4B 7616                    		jna	short sanityok
 13758                                  ; 22/12/2023
 13759                                  %if 1
 13760                                  ; ---------------------------------------------------------------------------
 13761                                  
 13762                                  baddrive:
 13763 00000A4D B008                    		mov	al, 8		; sector not found
 13764                                  		;jmp	short baddrive_ret
 13765                                  ; ---------------------------------------------------------------------------
 13766                                  ;unformatteddrive:
 13767                                  		;mov	al, 7		; unknown media
 13768                                  baddrive_ret:
 13769 00000A4F F9                      		stc
 13770                                  ;ioret:
 13771 00000A50 C3                      		retn
 13772                                  %endif
 13773                                  
 13774                                  ; ---------------------------------------------------------------------------
 13775                                  
 13776                                  sanity32:
 13777 00000A51 0336[9C04]              		add	si, [start_sec_h]
 13778 00000A55 263B751D                		cmp	si, [es:di+1Dh]	; [es:di+BDS.totalsecs32+2]
 13779 00000A59 7208                    		jb	short sanityok
 13780 00000A5B 77F0                    		ja	short baddrive
 13781 00000A5D 263B551B                		cmp	dx, [es:di+1Bh]	; [es:di+BDS.totalsecs32]
 13782 00000A61 77EA                    		ja	short baddrive
 13783                                  sanityok:
 13784 00000A63 8B16[9C04]              		mov	dx, [start_sec_h]
 13785 00000A67 26034517                		add	ax, [es:di+17h]	; [es:di+BDS.hiddensecs]
 13786 00000A6B 26135519                		adc	dx, [es:di+19h]	; [es:di+BDS.hiddensecs+2]
 13787                                  
 13788                                  ; now dx;ax have the physical first sector.
 13789                                  ; since the following procedures is going to destroy ax, let's
 13790                                  ; save it temporarily to saved_word.
 13791                                  
 13792 00000A6F A3[9E04]                		mov	[saved_word], ax ; save the sector number (low)
 13793                                  
 13794                                  ; set up pointer to disk base table in [dpt]. we cannot assume that iosetup
 13795                                  ; will do it because we will skip the set up stuff with hard disks.
 13796                                  
 13797 00000A72 06                      		push	es
 13798 00000A73 31F6                    		xor	si, si ; 0
 13799 00000A75 8EC6                    		mov	es, si
 13800                                  		;les	si, dword ptr es:78h
 13801 00000A77 26C4367800              		les	si, [es:78h]	; INT 1Eh vector address
 13802                                  					; [es:DSKADR] - current disk parm table
 13803 00000A7C 8936[2D01]              		mov	[dpt], si
 13804 00000A80 8C06[2F01]              		mov	[dpt+2], es
 13805 00000A84 07                      		pop	es
 13806 00000A85 26F6453F01              		test	byte [es:di+3Fh], 1 ; [es:di+BDS.flags], fnon_removable
 13807 00000A8A 7510                    		jnz	short chk_13h_ext_flag
 13808 00000A8C E8EAFE                  		call	checksingle
 13809                                  
 13810                                  ; check to see if we have previously noted a change line. the routine
 13811                                  ; returns if everything is ok. otherwise, it pops off the stack and returns
 13812                                  ; the proper error code.
 13813                                  
 13814 00000A8F 803E[7700]00            		cmp	byte [fhave96], 0 ; do we have changeline support?
 13815 00000A94 7403                    		jz	short diskio_nochangeline ; brif not
 13816 00000A96 E8D610                  		call	checklatchio	; will do a sneaky pop stack return
 13817                                  					; if a disk error occurs
 13818                                  diskio_nochangeline:
 13819 00000A99 E8E000                  		call	iosetup		; set up tables and variables for i/o
 13820                                  
 13821                                  chk_13h_ext_flag:
 13822 00000A9C 26F6454004              		test	byte [es:di+40h], 4 ; [es:di+BDS.flags+1], fLBArw
 13823                                  					; LBA read/write flag
 13824 00000AA1 7539                    		jnz	short set_lbarw_1
 13825                                  		;jmp	skip_setup
 13826                                  		; 22/12/2023
 13827                                  ; ---------------------------------------------------------------------------
 13828                                  
 13829                                  ; now the settle values are correct for the following code
 13830                                  
 13831                                  skip_setup:
 13832                                  
 13833                                  ; 32 bit sector calculation.
 13834                                  ; dx:[saved_word] = starting sector number.
 13835                                  
 13836                                  		;push	bp ; ! (not necessary) ; 22/12/2023
 13837 00000AA3 92                      		xchg	ax, dx ; mov ax,dx
 13838 00000AA4 31D2                    		xor	dx, dx
 13839 00000AA6 268B4D13                		mov	cx, [es:di+13h]	; [es:di+BDS.secpertrack]
 13840                                  					; divide by sec per track
 13841 00000AAA F7F1                    		div	cx
 13842 00000AAC 95                      		xchg	ax, bp ; mov bp,ax
 13843 00000AAD A1[9E04]                		mov	ax, [saved_word]
 13844 00000AB0 F7F1                    		div	cx		; [es:di+BDS.secpertrack]
 13845                                  					; now, bp:ax = track #, dx = sector
 13846                                  					; sector number is 1 based.
 13847 00000AB2 42                      		inc	dx
 13848 00000AB3 8816[3101]              		mov	[cursec], dl	; save current sector
 13849 00000AB7 268B4D15                		mov	cx, [es:di+15h] ; [es:di+BDS.heads]
 13850                                  					; get number of heads
 13851                                  		; 22/12/2023
 13852                                  		;push	ax ; *
 13853 00000ABB 31D2                    		xor	dx, dx
 13854 00000ABD 95                      		xchg	ax, bp ; bp = *	; divide tracks by heads per cylinder
 13855 00000ABE F7F1                    		div	cx
 13856 00000AC0 95                      		xchg	ax, bp ; ax = *, bp = **
 13857                                  		;pop	ax ; *
 13858 00000AC1 F7F1                    		div	cx		; now, bp:ax = cylinder #, dx = head
 13859 00000AC3 09ED                    		or	bp, bp ; ** = 0 ?
 13860                                  		;pop	bp ; ! ; 22/12/2023
 13861                                  		;jnz	short baddrive_brdg
 13862                                  		; 22/12/2023
 13863 00000AC5 7586                    		jnz	short baddrive
 13864                                  
 13865                                  		;cmp	ax, 1024	; 2^10 currently maximum for track #.
 13866                                  		;jnb	short baddrive_brdg
 13867                                  		; 22/12/2023
 13868 00000AC7 80FC04                  		cmp	ah, 4	; if ax >= 4*256 (1024) 
 13869 00000ACA 7381                    		jnb	short baddrive 
 13870                                  
 13871 00000ACC 8816[3201]              		mov	[curhd], dl	; save current head
 13872 00000AD0 A3[3301]                		mov	[curtrk], ax	; save current track
 13873                                  
 13874                                  ; we are now set up for the i/o. normally, we consider the dma boundary
 13875                                  ; violations here. not true. we perform the operation as if everything is
 13876                                  ; symmetric; let the int 13 handler worry about the dma violations.
 13877                                  
 13878 00000AD3 A1[2201]                		mov	ax, [seccnt]
 13879 00000AD6 E82101                  		call	block
 13880                                  		;call	done
 13881                                  		;retn
 13882                                  		; 22/12/2023
 13883 00000AD9 E9E700                  		jmp	done
 13884                                  		
 13885                                  ; ---------------------------------------------------------------------------
 13886                                  
 13887                                  set_lbarw_1:
 13888 00000ADC A1[9E04]                		mov	ax, [saved_word] ; check for mini disk
 13889                                  					 ; (logical dos drive/partition)
 13890 00000ADF 26837D7901              		cmp	word [es:di+79h], 1 ; [di+BDS.bdsm_ismini]
 13891                                  					    ; logical dos partition
 13892 00000AE4 750F                    		jnz	short set_lbarw_2 ; not a logical dos partition/drive
 13893 00000AE6 26837D7B00              		cmp	word [es:di+7Bh], 0 ; [di+BDS.bdsm_hidden_trks] (> 0)
 13894 00000AEB 7408                    		jz	short set_lbarw_2
 13895 00000AED 26034517                		add	ax, [es:di+17h]	; [es:di+BDS.hiddensecs]
 13896 00000AF1 26135519                		adc	dx, [es:di+19h]	; [es:di+BDS.hiddensecs+2]
 13897                                  
 13898                                  set_lbarw_2:
 13899 00000AF5 2EA3[060A]              		mov	[cs:dap_lba_value], ax
 13900 00000AF9 2E8916[080A]            		mov	[cs:dap_lba_value+2], dx
 13901 00000AFE 2E891E[020A]            		mov	[cs:dap_trans_buf], bx
 13902 00000B03 A1[A804]                		mov	ax, [xfer_seg]
 13903 00000B06 2EA3[040A]              		mov	[cs:dap_trans_buf+2], ax
 13904 00000B0A A1[2201]                		mov	ax, [seccnt]
 13905 00000B0D 2EA3[000A]              		mov	[cs:dap_block_cnt], ax
 13906 00000B11 BD0500                  		mov	bp, 5
 13907 00000B14 892E[A304]              		mov	[vretry_cnt], bp ; verify op. retry cnt for write-verify
 13908 00000B18 892E[A504]              		mov	[soft_ecc_cnt], bp ; soft ecc error retry count
 13909                                  
 13910                                  set_lbarw_3:
 13911 00000B1C 268A5504                		mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 13912 00000B20 8A26[2001]              		mov	ah, [rflag]	; get read/write indicator
 13913 00000B24 80C440                  		add	ah, 40h
 13914 00000B27 30C0                    		xor	al, al
 13915 00000B29 1E                      		push	ds
 13916 00000B2A 0E                      		push	cs
 13917 00000B2B 1F                      		pop	ds
 13918 00000B2C BE[FE09]                		mov	si, LBA_Packet
 13919 00000B2F CD13                    		int	13h		; LBA read/write
 13920 00000B31 1F                      		pop	ds
 13921 00000B32 731A                    		jnc	short set_lbarw_7
 13922 00000B34 E8AB02                  		call	again
 13923                                  set_lbarw_9:
 13924 00000B37 7503                    		jnz	short set_lbarw_4
 13925 00000B39 E92A02                  		jmp	harderr
 13926                                  ; ---------------------------------------------------------------------------
 13927                                  
 13928                                  set_lbarw_4:
 13929                                  ;set_lbarw_9:	; 22/12/2023
 13930 00000B3C 80FCCC                  		cmp	ah, 0CCh	; Write fault (hard disk)
 13931 00000B3F 7505                    		jnz	short set_lbarw_5
 13932 00000B41 BD0100                  		mov	bp, 1
 13933 00000B44 EB06                    		jmp	short set_lbarw_6
 13934                                  ; ---------------------------------------------------------------------------
 13935                                  
 13936                                  set_lbarw_5:
 13937                                  set_lbarw_10:	; 22/12/2023
 13938 00000B46 C706[A504]0500          		mov	word [soft_ecc_cnt], 5 ; soft ecc error retry count
 13939                                  set_lbarw_6:
 13940                                  set_lbarw_11:
 13941 00000B4C EBCE                    		jmp	short set_lbarw_3
 13942                                  ; ---------------------------------------------------------------------------
 13943                                  
 13944                                  set_lbarw_7:
 13945 00000B4E 813E[2001]0301          		cmp	word [rflag], 103h
 13946 00000B54 7523                    		jnz	short set_lbarw_12
 13947 00000B56 B444                    		mov	ah, 44h
 13948 00000B58 1E                      		push	ds
 13949 00000B59 0E                      		push	cs
 13950 00000B5A 1F                      		pop	ds
 13951 00000B5B CD13                    		int	13h		; DISK - IBM/MS Extension - VERIFY SECTORS
 13952                                  					;  (DL - drive, [SI - disk address packet)
 13953 00000B5D 1F                      		pop	ds
 13954 00000B5E 7319                    		jnc	short set_lbarw_12
 13955 00000B60 80FC11                  		cmp	ah, 11h		; ECC corrected data error (soft error - retried OK )
 13956 00000B63 7506                    		jnz	short set_lbarw_8
 13957 00000B65 FF0E[A504]              		dec	word [soft_ecc_cnt]
 13958                                  ;set_lbarw_8:
 13959 00000B69 740E                    		jz	short set_lbarw_12
 13960                                  set_lbarw_8:
 13961 00000B6B E8CE07                  		call	ResetDisk
 13962 00000B6E 80FC11                  		cmp	ah, 11h
 13963 00000B71 74D9                    		jz	short set_lbarw_11
 13964 00000B73 FF0E[A304]              		dec	word [vretry_cnt]
 13965                                  		;jnz	short set_lbarw_9
 13966                                  		;jmp	harderr
 13967                                  		; 22/12/2023
 13968 00000B77 EBBE                    		jmp	short set_lbarw_9
 13969                                  
 13970                                  ; ---------------------------------------------------------------------------
 13971                                  ;		; 22/12/2023
 13972                                  ;set_lbarw_9:
 13973                                  ;		cmp	ah, 0CCh
 13974                                  ;		jnz	short set_lbarw_10
 13975                                  ;		mov	bp, 1
 13976                                  ;		jmp	short set_lbarw_11
 13977                                  ; ---------------------------------------------------------------------------
 13978                                  ;		; 22/12/2023
 13979                                  ;set_lbarw_10:
 13980                                  ;		mov	word [soft_ecc_cnt], 5 ; soft ecc error retry count
 13981                                  ;set_lbarw_11:
 13982                                  ;		jmp	short set_lbarw_3
 13983                                  ; ---------------------------------------------------------------------------
 13984                                  
 13985                                  set_lbarw_12:
 13986 00000B79 31C0                    		xor	ax, ax
 13987                                  skip_dpt_setting:	; 23/12/2023
 13988 00000B7B C3                      		retn
 13989                                  		;;;	; 22/12/2023
 13990                                  %endif
 13991                                  
 13992                                  ; ---------------------------------------------------------------------------
 13993                                  
 13994                                  		; 22/12/2023
 13995                                  ;baddrive_brdg:
 13996                                  		;jmp	baddrive
 13997                                  
 13998                                  ; =============== S U B	R O U T	I N E =======================================
 13999                                  
 14000                                  ;--------------------------------------------------------------
 14001                                  ; set the drive-last-accessed flag for diskette only.
 14002                                  ; we know that the hard disk will not be removed.
 14003                                  ; es:di -> current bds.
 14004                                  ; ds -> Bios_Data
 14005                                  ; ax,cx,si are destroyed.
 14006                                  ;--------------------------------------------------------------
 14007                                  
 14008                                  		; 23/12/2023 - Retro DOS v5.0
 14009                                  
 14010                                  		; 19/10/2022
 14011                                  iosetup:
 14012 00000B7C 268A4504                		mov	al, [es:di+4]	; [es:di+BDS.drivenum]
 14013 00000B80 A2[1E01]                		mov	[tim_drv], al	; save drive letter
 14014                                  
 14015                                  ; determine proper head settle values
 14016                                  
 14017 00000B83 803E[A905]00            		cmp	byte [media_set_for_format], 0
 14018 00000B88 75F1                    		jnz	short skip_dpt_setting
 14019 00000B8A A0[2C01]                		mov	al, [eot]	; fetch	up eot before changing ds
 14020 00000B8D 1E                      		push	ds
 14021 00000B8E C536[2D01]              		lds	si, [dpt]	; get pointer to disk base table
 14022 00000B92 884404                  		mov	[si+4],	al
 14023                                  		; 23/12/2023
 14024 00000B95 88C4                    		mov	ah, al
 14025 00000B97 8A440A                  		mov	al, [si+10]	; [si+DISK_PARMS.DISK_MOTOR_STRT]
 14026                                  		;mov	ah, [si+4]	; [si+DISK_PARMS.DISK_EOT]
 14027 00000B9A 1F                      		pop	ds
 14028 00000B9B A2[2601]                		mov	[motorstartup], al
 14029 00000B9E 8826[2B01]              		mov	[save_eot], ah
 14030                                  
 14031                                  ; for 3.5" drives, both external as well as on the k09, we need to set the
 14032                                  ; motor start time to 4. this checking for every i/o is going to affect
 14033                                  ; performance across the board, but is necessary!!
 14034                                  
 14035 00000BA2 1E                      		push	ds
 14036 00000BA3 C536[2D01]              		lds	si, [dpt]	; get pointer to disk base table
 14037                                  		; 23/12/2023  - Retro DOS v5.0
 14038 00000BA7 26807D3E02              		cmp	byte [es:di+3Eh], 2 ; (PCDOS 7.1 IBMBIO.COM)
 14039                                  		;cmp	byte [es:di+22h], 2 ; [es:di+BDS.formfactor]
 14040                                  					; ffSmall
 14041 00000BAC 7505                    		jnz	short motor_start_ok
 14042 00000BAE B004                    		mov	al, 4
 14043 00000BB0 86440A                  		xchg	al, [si+10]	; [si+DISK_PARMS.DISK_MOTOR_STRT]
 14044                                  motor_start_ok:
 14045                                  
 14046                                  ; ds:si now points to disk parameter table.
 14047                                  ; get current settle and set fast settle
 14048                                  
 14049                                  		;xor	al, al
 14050                                  		;inc	al		; ibm wants fast settle	to be 1
 14051                                  		; 18/12/2022
 14052 00000BB3 31C0                    		xor	ax, ax
 14053 00000BB5 40                      		inc	ax
 14054 00000BB6 864409                  		xchg	al, [si+9]	; [si+DISK_PARMS.DISK_HEAD_STTL]
 14055                                  					; get settle and set up	for fast
 14056 00000BB9 1F                      		pop	ds
 14057 00000BBA A2[2701]                		mov	[settlecurrent], al
 14058 00000BBD B00F                    		mov	al, 15		; NORMSETTLE
 14059                                  					; someone has diddled the settle
 14060 00000BBF A2[2801]                		mov	[settleslow], al
 14061                                  		; 23/12/2023
 14062                                  ;skip_dpt_setting:
 14063 00000BC2 C3                      		retn
 14064                                  
 14065                                  ; =============== S U B	R O U T	I N E =======================================
 14066                                  
 14067                                  ;--------------------------------------------------------------
 14068                                  ; set time of last access, and reset default values in the dpt.
 14069                                  ;
 14070                                  ;	  note: trashes (at least) si
 14071                                  ;--------------------------------------------------------------
 14072                                  
 14073                                  		; 23/12/2023 - Retro DOS v5.0
 14074                                  
 14075                                  		; 19/10/2022
 14076                                  done:		
 14077                                  		;test	byte [es:di+23h], 1 ; [es:di+BDS.flags]
 14078                                  					; fnon_removable
 14079                                  		; 23/12/2023
 14080 00000BC3 26F6453F01              		test	byte [es:di+3Fh], 1 ; (PCDOS 7.1 IBMBIO.COM)
 14081 00000BC8 752F                    		jnz	short ddbx	; do not set for non-removable media
 14082 00000BCA E8F501                  		call	set_tim
 14083                                  ;diddleback:
 14084                                  ; 09/12/2022
 14085                                  diddle_back:
 14086 00000BCD 9C                      		pushf
 14087 00000BCE 803E[A905]00            		cmp	byte [media_set_for_format], 0
 14088 00000BD3 7523                    		jnz	short nodiddleback
 14089 00000BD5 50                      		push	ax
 14090 00000BD6 06                      		push	es
 14091 00000BD7 C436[2D01]              		les	si, [dpt]
 14092 00000BDB A0[2B01]                		mov	al, [save_eot]
 14093 00000BDE 26884404                		mov	[es:si+4], al	; [es:si+DISK_PARMS.DISK_EOT]
 14094 00000BE2 A0[2701]                		mov	al, [settlecurrent]
 14095 00000BE5 8A26[2601]              		mov	ah, [motorstartup]
 14096 00000BE9 26884409                		mov	[es:si+9], al	; [es:si+DISK_PARMS.DISK_HEAD_STTL]
 14097 00000BED 26C6440302              		mov	byte [es:si+3], 2 ; [es:si+DISK_PARMS.DISK_SECTOR_SIZ]
 14098 00000BF2 2688640A                		mov	[es:si+0Ah], ah	; [es:si+DISK_PARMS.DISK_MOTOR_STRT]
 14099 00000BF6 07                      		pop	es
 14100 00000BF7 58                      		pop	ax
 14101                                  nodiddleback:
 14102 00000BF8 9D                      		popf
 14103                                  ddbx:
 14104 00000BF9 C3                      		retn
 14105                                  
 14106                                  ; =============== S U B	R O U T	I N E =======================================
 14107                                  
 14108                                  ;--------------------------------------------------------------
 14109                                  ;read the number of sectors specified in ax,
 14110                                  ;handling track boundaries
 14111                                  ;es:di -> bds for this drive
 14112                                  ;--------------------------------------------------------------
 14113                                  
 14114                                  		; 23/12/2023 - Retro DOS v5.0
 14115                                  
 14116                                  		; 19/10/2022
 14117                                  block:	
 14118 00000BFA 09C0                    		or	ax, ax
 14119 00000BFC 74FB                    		jz	short ddbx
 14120                                  		; 23/12/2023
 14121 00000BFE 26F6453F01              		test	byte [es:di+3Fh], 1 ; (PCDOS 7.1 IBMBIO.COM)
 14122                                  		;test	byte [es:di+23h], 1 ; [es:di+BDS.flags]
 14123                                  					    ; fnon_removable
 14124 00000C03 740D                    		jz	short block_floppy
 14125                                  
 14126                                  ; check	to see if multi	track operation	is allowed. if not
 14127                                  ; we have to go	to the block_floppy below to break up the operation.
 14128                                  
 14129 00000C05 F606[A004]80            		test	byte [multrk_flag], 80h
 14130                                  		;test	byte ptr ds:multrk_flag, 80h ; multrk_on
 14131 00000C0A 7406                    		jz	short block_floppy
 14132 00000C0C E82800                  		call	Disk
 14133 00000C0F 31C0                    		xor	ax, ax
 14134 00000C11 C3                      		retn
 14135                                  ; ---------------------------------------------------------------------------
 14136                                  
 14137                                  block_floppy:
 14138                                  
 14139                                  ; read at most 1 track worth. perform minimization at sector / track
 14140                                  
 14141 00000C12 268A4D13                		mov	cl, [es:di+19]	; [es:di+BDS.secpertrack]
 14142                                  		;inc	cl
 14143                                  		; 23/12/2023
 14144 00000C16 41                      		inc	cx
 14145 00000C17 2A0E[3101]              		sub	cl, [cursec]
 14146 00000C1B 30ED                    		xor	ch, ch
 14147 00000C1D 39C8                    		cmp	ax, cx
 14148 00000C1F 7302                    		jnb	short gotmin
 14149 00000C21 89C1                    		mov	cx, ax
 14150                                  gotmin:
 14151                                  
 14152                                  ; ax is the requested number of sectors to read
 14153                                  ; cx is the number that we can do on this track
 14154                                  
 14155 00000C23 50                      		push	ax
 14156 00000C24 51                      		push	cx
 14157 00000C25 89C8                    		mov	ax, cx
 14158 00000C27 E80D00                  		call	Disk
 14159 00000C2A 59                      		pop	cx
 14160 00000C2B 58                      		pop	ax
 14161                                  
 14162                                  ; cx is the number of sectors just transferred
 14163                                  
 14164 00000C2C 29C8                    		sub	ax, cx		; reduce sectors-remaining by last i/o
 14165 00000C2E D0E1                    		shl	cl, 1
 14166 00000C30 00CF                    		add	bh, cl		; adjust transfer address
 14167 00000C32 EBC6                    		jmp	short block
 14168                                  dskerr_brdg:
 14169 00000C34 E9F100                  		jmp	dskerr
 14170                                  
 14171                                  ; =============== S U B	R O U T	I N E =======================================
 14172                                  
 14173                                  ; 15/10/2022
 14174                                  
 14175                                  ;--------------------------------------------------------------
 14176                                  ;perform disk i/o with retries
 14177                                  ; al = number of sectors (1-8, all on one track)
 14178                                  ; es:di point to drive parameters
 14179                                  ; xfer_seg:bx = transfer address 
 14180                                  ;		(must not cross a 64k physical boundary)
 14181                                  ; [rflag] = 2 if read, 3 if write
 14182                                  ; [verify] = 0 for normal, 1 for verify after write
 14183                                  ;--------------------------------------------------------------
 14184                                  
 14185                                  		; 23/12/2023 - Retro DOS v5.0
 14186                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:0C74h)
 14187                                  
 14188                                  		; 19/10/2022
 14189                                  Disk:
 14190                                  
 14191                                  ; Check for hard disk format and
 14192                                  ; if TRUE then set max error count to 2
 14193                                  
 14194 00000C37 BD0500                  		mov	bp, 5		; MAXERR
 14195                                  					; set up retry count
 14196                                  		; 23/12/2023
 14197 00000C3A 268A4D3F                		mov	cl, [es:di+3Fh]
 14198 00000C3E 83E101                  		and	cx, 1
 14199                                  		;test	byte [es:di+3Fh], 1
 14200                                  		;;test	byte [es:di+23h], 1 
 14201                                  					; [es:di+BDS.flags], fnon_removable
 14202 00000C41 7408                    		jz	short GetRdWrInd
 14203 00000C43 80FC04                  		cmp	ah, 4		; romverify ; Is this a	track verify?
 14204 00000C46 7403                    		jz	short GetRdWrInd
 14205 00000C48 BD0200                  		mov	bp, 2		; This is not verify so only 1 retry
 14206                                  GetRdWrInd:				
 14207 00000C4B 892E[A304]              		mov	[vretry_cnt], bp ; verify op. retry cnt for write-verify
 14208 00000C4F 892E[A504]              		mov	[soft_ecc_cnt], bp ; soft ecc error retry count.
 14209 00000C53 8A26[2001]              		mov	ah, [rflag]	; get read/write indicator
 14210                                  ;retry:
 14211                                  ; 09/12/2022
 14212                                  _retry:
 14213 00000C57 50                      		push	ax
 14214 00000C58 8B16[3301]              		mov	dx, [curtrk]
 14215                                  		; 23/12/2023
 14216 00000C5C E30B                    		jcxz	disk_not_mini
 14217                                  		;test	byte [es:di+3Fh], 1
 14218                                  		;;test	byte [es:di+23h], 1
 14219                                  		;jz	short disk_not_mini
 14220                                  
 14221                                  		; 23/12/2023
 14222 00000C5E 26837D7901              		cmp	word [es:di+79h], 1
 14223                                  		;cmp	word [es:di+47h], 1 ; [es:di+BDS.bdsm_ismini]
 14224                                  					; is this a mini disk? ((logical dos partition))
 14225 00000C63 7504                    		jnz	short disk_not_mini ; no. continue to next.
 14226                                  		; 23/12/2023
 14227 00000C65 2603557B                		add     dx, [es:di+7Bh]
 14228                                  		;add	dx, [es:di+49h]	; [es:di+BDS.bdsm_hidden_trks]
 14229                                  					; add hidden trks.
 14230                                  disk_not_mini:
 14231 00000C69 D0CE                    		ror	dh, 1
 14232 00000C6B D0CE                    		ror	dh, 1
 14233 00000C6D 0A36[3101]              		or	dh, [cursec]
 14234 00000C71 89D1                    		mov	cx, dx
 14235 00000C73 86E9                    		xchg	ch, cl		;  cl =	sector,	ch = cylinder
 14236 00000C75 8A36[3201]              		mov	dh, [curhd]	; load current head number and
 14237 00000C79 268A5504                		mov	dl, [es:di+4]	; physical drive number
 14238                                  					; [es:di+BDS.drivenum]
 14239                                  		; 23/12/2023
 14240 00000C7D 26807D3E05              		cmp	byte [es:di+3Eh], 5 
 14241                                  		;cmp	byte [es:di+22h], 5 ; [es:di+BDS.formfactor], ffHardFile
 14242 00000C82 7411                    		jz	short do_fast	; hard files use fast speed
 14243                                  
 14244                                  ; if we have [step_drv] set to -1, we use the slow settle time.
 14245                                  ; this helps when we have just done a reset disk operation and the head has
 14246                                  ; been moved to another cylinder - the problem crops up with 3.5" drives.
 14247                                  
 14248 00000C84 803E[7600]FF            		cmp	byte [step_drv], 0FFh ; -1
 14249                                  		;jz	short do_writej
 14250                                  		; 23/12/2023
 14251 00000C89 746A                    		jz	short do_write
 14252 00000C8B 80FC02                  		cmp	ah, 2		; romread
 14253 00000C8E 7405                    		jz	short do_fast
 14254 00000C90 80FC04                  		cmp	ah, 4		; romverify
 14255                                  		;jz	short do_fast
 14256                                  		; 23/12/2023
 14257 00000C93 7560                    		jnz	short do_write
 14258                                  ;do_writej:
 14259                                  
 14260                                  ; reads always fast, unless we have just done a disk reset operation
 14261                                  			
 14262                                  		;jmp	short do_write	; reads	always fast
 14263                                  ; ---------------------------------------------------------------------------
 14264                                  
 14265                                  do_fast:
 14266 00000C95 E80501                  		call	fastspeed	; change settle	mode
 14267                                  testerr:
 14268 00000C98 729A                    		jb	short dskerr_brdg
 14269                                  
 14270                                  		; 23/12/2023 Retro DOS v5.0
 14271                                  		; (PCDOS 7.1 IBMBIO.COM)
 14272 00000C9A 83FD05                  		cmp	bp, 5		; is there retry ?
 14273 00000C9D 7505                    		jnz	short testerror	; yes
 14274 00000C9F 80FCBB                  		cmp	ah, 0BBh	; Undefined error (hard disk)
 14275 00000CA2 7490                    		jz	short dskerr_brdg
 14276                                  testerror:
 14277                                  
 14278                                  ; set drive and track of last access
 14279                                  
 14280 00000CA4 8816[7600]              		mov	[step_drv], dl
 14281                                  		; 23/12/2023
 14282 00000CA8 26886D78                		mov	[es:di+78h], ch
 14283                                  		;mov	[es:di+46h], ch	; [es:di+BDS.track]
 14284                                  no_set:
 14285                                  		;cmp	word [wrtverify], 103h
 14286 00000CAC 813E[2001]0301          		cmp	word [rflag], 103h ; check for write and verify
 14287 00000CB2 7452                    		jz	short doverify
 14288                                  noverify:
 14289 00000CB4 58                      		pop	ax
 14290                                  
 14291                                  ; check the flags word in the bds to see if the drive is non removable
 14292                                  ; if not we needn't do anything special
 14293                                  ; if it is a hard disk then check to see if multi-track operation
 14294                                  ; is specified. if specified we don't have to calculate for the next
 14295                                  ; track since we are already done. so we can go to the exit of this routine.
 14296                                  
 14297                                  		; 23/12/2023
 14298 00000CB5 26F6453F01              		test	byte [es:di+3Fh], 1
 14299                                  		;test	byte [es:di+23h], 1 ; [es:di+BDS.flags]
 14300                                  					; fnon_removable
 14301 00000CBA 7407                    		jz	short its_removable
 14302 00000CBC F606[A004]80            		test	byte [multrk_flag], 80h ; multrk_on
 14303 00000CC1 7530                    		jnz	short disk_ret
 14304                                  its_removable:
 14305 00000CC3 80E13F                  		and	cl, 3Fh		; eliminate cylinder bits from sector
 14306 00000CC6 30E4                    		xor	ah, ah
 14307 00000CC8 2906[2201]              		sub	[seccnt], ax	; reduce count of sectors to go	next sector
 14308 00000CCC 00C1                    		add	cl, al
 14309 00000CCE 880E[3101]              		mov	[cursec], cl
 14310 00000CD2 263A4D13                		cmp	cl, [es:di+13h]	; [es:di+BDS.secpertrack]
 14311                                  					; see if sector/track limit reached
 14312 00000CD6 761B                    		jbe	short disk_ret
 14313 00000CD8 C606[3101]01            		mov	byte [cursec], 1 ; start with first sector of next track
 14314 00000CDD 8A36[3201]              		mov	dh, [curhd]
 14315 00000CE1 FEC6                    		inc	dh
 14316 00000CE3 263A7515                		cmp	dh, [es:di+15h]	; [es:di+BDS.heads]
 14317 00000CE7 7206                    		jb	short noxor
 14318 00000CE9 30F6                    		xor	dh, dh
 14319 00000CEB FF06[3301]              		inc	word [curtrk]
 14320                                  noxor:
 14321 00000CEF 8836[3201]              		mov	[curhd], dh
 14322                                  disk_ret:
 14323 00000CF3 F8                      		clc
 14324 00000CF4 C3                      		retn
 14325                                  ; ---------------------------------------------------------------------------
 14326                                  
 14327                                  ; 15/10/2022
 14328                                  
 14329                                  ; 24/12/2023 - Retro DOS v5.0
 14330                                  
 14331                                  ;--------------------------------------------------------------
 14332                                  ; the request is for write. determine if we are talking about
 14333                                  ; the same track and drive. if so, use the fast speed.
 14334                                  ;--------------------------------------------------------------
 14335                                  
 14336                                  do_write:
 14337 00000CF5 3A16[7600]              		cmp	dl, [step_drv]
 14338 00000CF9 7506                    		jnz	short do_norm	; we have changed drives
 14339                                  		; 24/12/2023
 14340 00000CFB 263A6D78                		cmp	ch, [es:di+78h]
 14341                                  		;cmp	ch, [es:di+46h]	; [es:di+BDS.track]
 14342 00000CFF 7494                    		jz	short do_fast	; we are still on the same track
 14343                                  do_norm:
 14344 00000D01 E87500                  		call	normspeed
 14345 00000D04 EB92                    		jmp	short testerr
 14346                                  ; ---------------------------------------------------------------------------
 14347                                  
 14348                                  ;--------------------------------------------------------------
 14349                                  ; we have a verify request also. get state info and go verify
 14350                                  ;--------------------------------------------------------------
 14351                                  
 14352                                  doverify:
 14353 00000D06 58                      		pop	ax
 14354 00000D07 50                      		push	ax
 14355 00000D08 B404                    		mov	ah, 4
 14356 00000D0A E89000                  		call	fastspeed
 14357 00000D0D 73A5                    		jnb	short noverify
 14358                                  
 14359                                  ; check the error returned in ah to see if it is a soft ecc error.
 14360                                  ; if it is not we needn't do anything special. if it is a soft
 14361                                  ; ecc error then decrement the soft_ecc_cnt error retry count. if
 14362                                  ; this retry count becomes 0 then we just ignore the error and go to
 14363                                  ; no_verify but if we can still try then we call the routine to reset
 14364                                  ; the disk and go to dskerr1 to retry the operation.
 14365                                  
 14366 00000D0F 80FC11                  		cmp	ah, 11h		; soft ecc error ?
 14367 00000D12 750B                    		jnz	short not_softecc_err
 14368 00000D14 FF0E[A504]              		dec	word [soft_ecc_cnt]
 14369 00000D18 749A                    		jz	short noverify	; no more retry
 14370 00000D1A E81F06                  		call	ResetDisk	; reset	disk
 14371 00000D1D EB3E                    		jmp	short dskerr1	; retry
 14372                                  ; ---------------------------------------------------------------------------
 14373                                  
 14374                                  not_softecc_err:			; other error.
 14375 00000D1F E81A06                  		call	ResetDisk
 14376 00000D22 FF0E[A304]              		dec	word [vretry_cnt]
 14377 00000D26 EB1C                    		jmp	short dskerr0
 14378                                  ; ---------------------------------------------------------------------------
 14379                                  
 14380                                  ;--------------------------------------------------------------
 14381                                  ; need to special case the change-line error ah=06h.
 14382                                  ; if we get this, we need to return it.
 14383                                  ;--------------------------------------------------------------
 14384                                  
 14385                                  dskerr:
 14386 00000D28 803E[7700]00            		cmp	byte [fhave96], 0	; do we	have changeline	support?
 14387 00000D2D 7403                    		jz	short dskerr_nochangeline ; brif not
 14388 00000D2F E8C30E                  		call	checkio
 14389                                  dskerr_nochangeline:
 14390 00000D32 803E[A704]01            		cmp	byte [multitrk_format_flag], 1 ; multi trk format request?
 14391 00000D37 7508                    		jnz	short dochkagain ; no more retry.
 14392 00000D39 BD0100                  		mov	bp, 1
 14393 00000D3C C606[A704]00            		mov	byte [multitrk_format_flag], 0 ; clear the flag.
 14394                                  dochkagain:
 14395 00000D41 E89E00                  		call	again
 14396                                  dskerr0:
 14397 00000D44 7420                    		jz	short harderr
 14398                                  		; 24/12/2023
 14399 00000D46 26F6453F01              		test	byte [es:di+3Fh], 1
 14400                                  		;test	byte [es:di+23h], 1 ; [es:di+BDS.flags]
 14401                                  					; fnon_removable
 14402 00000D4B 7505                    		jnz	short skip_timeout_chk
 14403 00000D4D 80FC80                  		cmp	ah, 80h		; timeout?
 14404 00000D50 7414                    		jz	short harderr
 14405                                  skip_timeout_chk:
 14406 00000D52 80FCCC                  		cmp	ah, 0CCh	; write	fault error?
 14407 00000D55 740A                    		jz	short write_fault_err ;	then, don't retry.
 14408 00000D57 C706[A504]0500          		mov	word [soft_ecc_cnt], 5 ; MAXERR
 14409                                  					; set soft_ecc_cnt back	to maxerr
 14410                                  dskerr1:
 14411 00000D5D 58                      		pop	ax		; restore sector count
 14412                                  		;jmp	retry
 14413                                  		; 09/12/2022
 14414 00000D5E E9F6FE                  		jmp	_retry
 14415                                  ; ---------------------------------------------------------------------------
 14416                                  
 14417                                  write_fault_err:
 14418 00000D61 BD0100                  		mov	bp, 1		; just retry only once
 14419                                  					; for write fault error.
 14420 00000D64 EBF7                    		jmp	short dskerr1
 14421                                  
 14422                                  		; fall into harderr
 14423                                  ; ---------------------------------------------------------------------------
 14424                                  
 14425                                  ; entry point for routines that call maperror themselves
 14426                                  
 14427                                  harderr:
 14428 00000D66 E84100                  		call	maperror
 14429                                  harderr2:
 14430 00000D69 C606[1E01]FF            		mov	byte [tim_drv], 0FFh
 14431                                  					; force a media check through rom
 14432 00000D6E 8B0E[2201]              		mov	cx, [seccnt]	; get count of sectors to go
 14433 00000D72 8B26[3501]              		mov	sp, [spsav]	; recover entry	stack pointer
 14434                                  
 14435                                  ; since we are performing a non-local goto, restore the disk parameters
 14436                                  
 14437                                  		;jmp	diddleback
 14438                                  		; 09/12/2022
 14439 00000D76 E954FE                  		jmp	diddle_back
 14440                                  
 14441                                  ; =============== S U B	R O U T	I N E =======================================
 14442                                  
 14443                                  ; change settle value from settlecurrent to whatever is appropriate
 14444                                  ; note that this routine is never called for a fixed disk.
 14445                                  
 14446                                  		; 19/10/2022
 14447                                  normspeed:
 14448 00000D79 803E[A905]00            		cmp	byte [media_set_for_format], 0
 14449 00000D7E 751D                    		jnz	short fastspeed
 14450 00000D80 06                      		push	es
 14451 00000D81 50                      		push	ax
 14452 00000D82 A0[2801]                		mov	al, [settleslow]
 14453 00000D85 C436[2D01]              		les	si, [dpt]	; current disk parm table
 14454 00000D89 26884409                		mov	[es:si+9], al	; [es:si+DISK_PARMS.DISK_HEAD_STTL]
 14455 00000D8D 58                      		pop	ax
 14456 00000D8E 07                      		pop	es
 14457 00000D8F E80B00                  		call	fastspeed
 14458                                  		; 24/12/2023
 14459                                  		;push	es
 14460                                  		;les	si, [dpt]
 14461                                  		;mov	byte [es:si+9], 1 ; [es:si+DISK_PARMS.DISK_HEAD_STTL]
 14462                                  		;			; 1 is fast settle value
 14463                                  		;pop	es
 14464 00000D92 1E                      		push	ds
 14465 00000D93 C536[2D01]              		lds	si, [dpt]
 14466 00000D97 C6440901                		mov	byte [si+9], 1
 14467 00000D9B 1F                      		pop	ds
 14468                                  
 14469 00000D9C C3                      		retn
 14470                                  
 14471                                  ; =============== S U B	R O U T	I N E =======================================
 14472                                  
 14473                                  ; if the drive has been marked as too big (i.e. starting sector of the
 14474                                  ; partition is > 16 bits, then always return drive not ready.
 14475                                  
 14476                                  		; 24/12/2023 - Retro DOS v5.0
 14477                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:0DDDh)
 14478                                  fastspeed:
 14479                                  		;;test	byte [es:di+3Bh], 80h ; [es:di+BDS.fatsiz]
 14480                                  		;test	byte [es:di+1Fh], 80h ; [es:di+BDS.fatsiz]
 14481                                  		;			; ftoobig
 14482                                  		;jnz	short notready
 14483 00000D9D 06                      		push	es
 14484 00000D9E 8E06[A804]              		mov	es, [xfer_seg]
 14485 00000DA2 CD13                    		int	13h		; DISK -
 14486 00000DA4 8C06[A804]              		mov	[xfer_seg], es
 14487 00000DA8 07                      		pop	es
 14488 00000DA9 C3                      		retn
 14489                                  ; ---------------------------------------------------------------------------
 14490                                  ;		; 24/12/2023
 14491                                  ;notready:
 14492                                  		;stc
 14493                                  		;mov	ah, 80h
 14494                                  		;retn
 14495                                  
 14496                                  ; =============== S U B	R O U T	I N E =======================================
 14497                                  
 14498                                  ; map error returned by rom in ah into corresponding code to be returned to
 14499                                  ; dos in al. trashes di. guaranteed to set carry.
 14500                                  
 14501                                  maperror:
 14502 00000DAA 51                      		push	cx
 14503 00000DAB 06                      		push	es
 14504 00000DAC 1E                      		push	ds		; set es=Bios_Data
 14505 00000DAD 07                      		pop	es
 14506 00000DAE 88E0                    		mov	al, ah		; put error code in al
 14507 00000DB0 A2[4601]                		mov	[lsterr], al	; terminate list with error code
 14508                                  		; 24/12/2023
 14509 00000DB3 B90B00                  		mov	cx, 11 ; PCDOS 7.1 ; 02/09/2023
 14510                                  		;mov	cx, 9		; numerr (= errout-errin)
 14511                                  					; number of possible error conditions
 14512 00000DB6 BF[3C01]                		mov	di, errin	; point to error conditions
 14513 00000DB9 F2AE                    		repne scasb
 14514                                  
 14515                                  		; 24/12/2023
 14516                                  		; 02/09/2023
 14517 00000DBB 8A450A                  		mov	al, [di+10] ; PCDOS 7.1 IBMBIO.COM
 14518                                  		; 10/12/2022
 14519                                  		;mov	al, [di+8]	; [di+numerr-1]
 14520                                  					; get translation
 14521                                  		; 19/10/2022 - Temporary ! 
 14522                                  		;db	8Ah, 85h, 8, 0	; mov al, [di+8]
 14523 00000DBE 07                      		pop	es
 14524 00000DBF 59                      		pop	cx
 14525 00000DC0 F9                      		stc			; flag error condition
 14526 00000DC1 C3                      		retn
 14527                                  
 14528                                  ; =============== S U B	R O U T	I N E =======================================
 14529                                  
 14530                                  ; set the time of last access for this drive.
 14531                                  ; this is done only for removable media. es:di -> bds
 14532                                  
 14533                                  set_tim:
 14534 00000DC2 50                      		push	ax
 14535 00000DC3 E86BF7                  		call	GetTickCnt	; Does INT 1A ah=0 & updates daycnt
 14536                                  
 14537                                  ; we have the new time. if we see that the time has passed,
 14538                                  ; then we reset the threshold counter...
 14539                                  
 14540                                  		; 24/12/2023 - Retro DOS v5.0
 14541 00000DC6 263B5579                		cmp	dx, [es:di+79h]	; PCDOS 7.1 IBMBIO.COM
 14542                                  		;cmp	dx, [es:di+47h]	; [es:di+BDS.tim_lo]
 14543 00000DCA 7506                    		jne	short setaccess
 14544                                  		; 24/12/2023
 14545 00000DCC 263B4D7B                		cmp	cx, [es:di+7Bh]	; PCDOS 7.1 IBMBIO.COM
 14546                                  		;cmp	cx, [es:di+49h]	; [es:di+BDS.tim_hi]
 14547                                  		;jz	short done_set
 14548                                  		; 12/12/2022
 14549 00000DD0 740E                    		je	short done_set2
 14550                                  setaccess:
 14551 00000DD2 C606[1D01]00            		mov	byte [accesscount], 0
 14552                                  		
 14553                                  		; 24/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 14554 00000DD7 26895579                		mov	[es:di+79h], dx
 14555 00000DDB 26894D7B                		mov	[es:di+7Bh], cx
 14556                                  		;mov	[es:di+47h], dx	; [es:di+BDS.tim_lo]
 14557                                  		;mov	[es:di+49h], cx	; [es:di+BDS.tim_hi]
 14558                                  done_set:
 14559 00000DDF F8                      		clc
 14560                                  done_set2:		; 12/12/2022
 14561 00000DE0 58                      		pop	ax
 14562 00000DE1 C3                      		retn
 14563                                  
 14564                                  ; =============== S U B	R O U T	I N E =======================================
 14565                                  
 14566                                  ; this routine is called if an error occurs while formatting or verifying.
 14567                                  ; it resets the drive,and decrements the retry count.
 14568                                  ; on entry - ds:di - points to bds for the drive
 14569                                  ;	     bp    - contains retry count
 14570                                  ; on exit    flags indicate result of decrementing retry count
 14571                                  
 14572                                  again:
 14573 00000DE2 E85705                  		call	ResetDisk
 14574 00000DE5 80FC06                  		cmp	ah, 6
 14575 00000DE8 7402                    		jz	short dont_dec_retry_count ; If	it is a	media change error
 14576                                  					; do not decrement retry count.
 14577 00000DEA 4D                      		dec	bp		; decrement retry count
 14578 00000DEB C3                      		retn
 14579                                  ; ---------------------------------------------------------------------------
 14580                                  
 14581                                  dont_dec_retry_count:
 14582 00000DEC 08E4                    		or	ah, ah
 14583 00000DEE C3                      		retn
 14584                                  
 14585                                  ;----------------------------------------------------------------------------
 14586                                  ; Retro DOS v5.0 - PCDOS 7.1 IBMBIO.COM - BIOSCODE:0E30h
 14587                                  ;----------------------------------------------------------------------------
 14588                                  ; 24/12/2023 - Retro DOS v5.0
 14589                                  ;;;;
 14590                                  
 14591 00000DEF 00                      ioctl_drvnum:	db 0
 14592                                  
 14593                                  		; 24/12/2023
 14594                                  
 14595                                  ; =============== S U B R O U T I N E =======================================
 14596                                  
 14597                                  get_phy_drv_num:
 14598 00000DF0 E8B1F7                  		call	SetDrive	; get physical drive number
 14599                                  					; INPUT: al = logical drive number (BDS.drivelet)
 14600                                  					; OUTPUT: physical drive number (BDS.drivenum)
 14601 00000DF3 268A5504                		mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 14602 00000DF7 C3                      		retn
 14603                                  
 14604                                  ; =============== S U B R O U T I N E =======================================
 14605                                  
 14606                                  		; 24/12/2023
 14607                                  ioctl_output:
 14608 00000DF8 E8F5FF                  		call	get_phy_drv_num
 14609 00000DFB 2E8816[EF0D]            		mov	[cs:ioctl_drvnum], dl
 14610 00000E00 B441                    		mov	ah, 41h
 14611 00000E02 BBAA55                  		mov	bx, 55AAh
 14612 00000E05 CD13                    		int	13h		; DISK - Check for INT 13h Extensions
 14613                                  					; BX = 55AAh, DL = drive number
 14614                                  					; Return: CF set if not supported
 14615                                  					; AH = extensions version
 14616                                  					; BX = AA55h
 14617                                  					; CX = Interface support bit map
 14618 00000E07 7235                    		jc	short int13h_exts_err
 14619                                  ioctl_input_1:
 14620 00000E09 C43E[1200]              		les	di, [ptrsav]
 14621 00000E0D 26C47D0E                		les	di, [es:di+14]	; [es:di+IOCTL_REQ.MINORFUNCTION]
 14622 00000E11 723E                    		jc	short ioctl_input_2
 14623 00000E13 B80046                  		mov	ax, 4600h	; Eject removable media
 14624 00000E16 263805                  		cmp	[es:di], al	; al = 0 ; disk ioctl function = 0
 14625 00000E19 7417                    		je	short ioctl_output_1
 14626 00000E1B 26803D01                		cmp	byte [es:di], 1 ; al = 1 ; disk ioctl function = 1
 14627 00000E1F 751B                    		jne	short ioctl_output_2
 14628 00000E21 B80145                  		mov	ax, 4501h	; Lock/unlock media
 14629                                  					; (al, 0 = lock, 1 = unlock)
 14630 00000E24 26807D0100              		cmp	byte [es:di+1], 0 ; unlock (reverse of INT 13h ah=45h)
 14631 00000E29 7407                    		jz	short ioctl_output_1
 14632 00000E2B 26384501                		cmp	[es:di+1], al	; lock (reverse of INT 13h ah=45h)
 14633 00000E2F 750B                    		jne	short ioctl_output_2
 14634 00000E31 48                      		dec	ax
 14635                                  ioctl_output_1:
 14636 00000E32 2E8A16[EF0D]            		mov	dl, [cs:ioctl_drvnum]
 14637 00000E37 CD13                    		int	13h		; DISK - IBM/MS Extension - LOCK/UNLOCK DRIVE (DL - drive, [SI - disk address packet)
 14638 00000E39 7203                    		jc	short int13h_exts_err
 14639                                  ioctl_lock_err:
 14640                                  		; cf=0
 14641                                  ioctl_output_ret:
 14642                                  		;clc
 14643 00000E3B C3                      		retn
 14644                                  ; ---------------------------------------------------------------------------
 14645                                  
 14646                                  ioctl_output_2:
 14647 00000E3C B401                    		mov	ah, 1
 14648                                  int13h_exts_err:
 14649 00000E3E 80FCB0                  		cmp	ah, 0B0h	; volume not locked in drive
 14650 00000E41 74F8                    		je	short ioctl_lock_err
 14651 00000E43 80FCB4                  		cmp	ah, 0B4h	; lock count exceeded
 14652 00000E46 74F3                    		je	short ioctl_lock_err
 14653 00000E48 E9D9F7                  		jmp	err_exitj
 14654                                  
 14655                                  ; =============== S U B R O U T I N E =======================================
 14656                                  
 14657                                  		; 24/12/2023
 14658                                  ioctl_input:
 14659 00000E4B E8A2FF                  		call	get_phy_drv_num
 14660 00000E4E F9                      		stc
 14661 00000E4F EBB8                    		jmp	short ioctl_input_1
 14662                                  ioctl_input_2:
 14663 00000E51 26803D06                		cmp	byte [es:di], 6	; disk ioctl function = 6
 14664 00000E55 75E5                    		jne	short ioctl_output_2
 14665 00000E57 B80245                  		mov	ax, 4502h	; get lock status
 14666 00000E5A CD13                    		int	13h		; DISK - IBM/MS Extension - LOCK/UNLOCK DRIVE (DL - drive, [SI - disk address packet)
 14667 00000E5C 72E0                    		jc	short int13h_exts_err
 14668 00000E5E BB0C00                  		mov	bx, 0Ch		; bit 1 lock bit
 14669 00000E61 3C00                    		cmp	al, 0		; not locked
 14670 00000E63 7402                    		jz	short ioctl_input_3
 14671 00000E65 B30E                    		mov	bl, 0Eh
 14672                                  ioctl_input_3:
 14673 00000E67 53                      		push	bx
 14674 00000E68 B404                    		mov	ah, 4
 14675 00000E6A B90101                  		mov	cx, 101h
 14676 00000E6D B601                    		mov	dh, 1
 14677 00000E6F CD13                    		int	13h		; DISK - VERIFY SECTORS
 14678                                  					; AL = number of sectors to verify, CH = track, CL = sector
 14679                                  					; DH = head, DL = drive
 14680                                  					; Return: CF set on error, AH = status
 14681                                  					; AL = number of sectors verified
 14682 00000E71 5B                      		pop	bx
 14683 00000E72 80FC31                  		cmp	ah, 31h		; no media in drive (IBM/MS INT 13 extensions)
 14684 00000E75 740B                    		je	short ioctl_input_5
 14685 00000E77 80FC80                  		cmp	ah, 80h		; timeout (not ready)
 14686 00000E7A 7406                    		je	short ioctl_input_5
 14687                                  ioctl_input_4:
 14688 00000E7C 26895D01                		mov	[es:di+1], bx
 14689 00000E80 EBB9                    		jmp	short ioctl_lock_err
 14690                                  ioctl_input_5:
 14691 00000E82 81CB0108                		or	bx, 801h	; bit 0 error bit (1 = error, 31h or 80h)
 14692                                  					; bit 11 (not ready -removable media error- bit)
 14693                                  					; if bit 11 = 0, another error (except 31h and 80h)
 14694 00000E86 EBF4                    		jmp	short ioctl_input_4
 14695                                  
 14696                                  ; ---------------------------------------------------------------------------
 14697                                  ;;;;
 14698                                  
 14699                                  ; 16/10/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS)
 14700                                  
 14701                                  ;----------------------------------------------------------------------------
 14702                                  ; MSDIOCTL.ASM - MSDOS 6.0 - 1991
 14703                                  ;----------------------------------------------------------------------------
 14704                                  ; 11/03/2019 - Retro DOS v4.0
 14705                                  
 14706                                  ; 18/03/2019
 14707                                  
 14708                                  ; ==========================================================================
 14709                                  ;
 14710                                  ; NOTE: GetAccessFlag/SetAccessFlag is unpublished function.
 14711                                  ;
 14712                                  ;      This function is intended to give the user to control the
 14713                                  ;      bds table flags of unformatted_media bit.
 14714                                  ;      GetAccessFlag will show the status -
 14715                                  ;	 a_DiskAccess_Control.dac_access_flag = 0 disk i/o not allowed
 14716                                  ;						1 disk i/o allowed
 14717                                  ;      SetAccessFlag will set/reset the unformatted_media bit in flags -
 14718                                  ;	 a_DiskAccess_Control.dac_access_flag = 0 allow disk i/o
 14719                                  ;						1 disallow disk i/o
 14720                                  ; ==========================================================================
 14721                                  
 14722                                  		; generic ioctl dispatch tables
 14723                                  
 14724                                  ; BIOSCODE:0C3Ch (MSDOS 6.21, IO.SYS)
 14725                                  
 14726                                  ; 24/12/2023
 14727                                  ; BIOSCODE:0ECAh (PCDOS 7.1, IBMBIO.COM)
 14728                                  
 14729                                  ; ---------------------------------------------------------------------------
 14730                                  		; 24/12/2023
 14731                                  		;db 0
 14732                                  ; 09/12/2022 
 14733                                  %if 0
 14734                                  
 14735                                  IoReadJumpTable: db 8	; ((IoWriteJumpTable-IoReadJumpTable)-1)/2
 14736                                  		dw 0CA7h	; 60h	; GetDeviceParameters
 14737                                  		dw 0EE8h	; 61h	;gh ReadTrack
 14738                                  		dw 0E86h	; 62h	; VerifyTrack
 14739                                  		dw 0CA3h	 	; Cmd_Error_Proc
 14740                                  		dw 0CA3h		; Cmd_Error_Proc
 14741                                  		dw 0CA3h		; Cmd_Error_Proc
 14742                                  		dw 119Ah	; 66h	; GetMediaId
 14743                                  		dw 1269h	; 67h	; GetAccessFlag ; unpublished function
 14744                                  		dw 12C1h	; 68h	; SenseMediaType
 14745                                  
 14746                                  IoWriteJumpTable: db 7	; ((IOC_DC_Table-IoWriteJumpTable)-1)/2
 14747                                  		dw 0CF3h	; 40h	; SetDeviceParameters
 14748                                  		dw 0EEFh	; 41h	; WriteTrack
 14749                                  		dw 0DC1h	; 42h	; FormatTrack
 14750                                  		dw 0CA3h		; Cmd_Error_Proc
 14751                                  		dw 0CA3h		; Cmd_Error_Proc
 14752                                  		dw 0CA3h		; Cmd_Error_Proc
 14753                                  		dw 11D2h	; 46h	; SetMediaId
 14754                                  		dw 1280h	; 47h	; SetAccessFlag ; unpublished function
 14755                                  
 14756                                  %endif
 14757                                  		; 24/12/2023 - Retro DOS v5.0
 14758                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:0ECAh)
 14759                                  
 14760                                  		; 09/12/2022
 14761                                  IoReadJumpTable:
 14762 00000E88 10                      		db ((IoWriteJumpTable-IoReadJumpTable)-1)/2 ; 15
 14763 00000E89 [1B0F]                  		dw GetDeviceParameters	; 60h
 14764 00000E8B [9411]                  		dw ReadTrack		; 61h
 14765 00000E8D [3411]                  		dw VerifyTrack		; 62h
 14766 00000E8F [170F]                  		dw Cmd_Error_Proc
 14767 00000E91 [170F]                  		dw Cmd_Error_Proc
 14768 00000E93 [170F]                  		dw Cmd_Error_Proc
 14769 00000E95 [1314]                  		dw GetMediaId		; 66h
 14770 00000E97 [F014]                  		dw GetAccessFlag	; 67h ; unpublished function
 14771 00000E99 [4A15]                  		dw SenseMediaType	; 68h
 14772                                  		; 24/12/2023
 14773                                  		; Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 14774 00000E9B [170F]                  		dw Cmd_Error_Proc	; 69h
 14775 00000E9D [170F]                  		dw Cmd_Error_Proc	; 6Ah
 14776 00000E9F [170F]                  		dw Cmd_Error_Proc
 14777 00000EA1 [170F]                  		dw Cmd_Error_Proc
 14778 00000EA3 [170F]                  		dw Cmd_Error_Proc
 14779 00000EA5 [170F]                  		dw Cmd_Error_Proc	; 6Eh
 14780 00000EA7 [CE15]                  		dw GetDrvMapInfo	; 6Fh
 14781                                  
 14782                                  IoWriteJumpTable:
 14783 00000EA9 0A                      		db ((IOC_DC_Table-IoWriteJumpTable)-1)/2 ; 9
 14784 00000EAA [7B0F]                  		dw SetDeviceParameters	; 40h
 14785 00000EAC [9B11]                  		dw WriteTrack		; 41h
 14786 00000EAE [6E10]                  		dw FormatTrack		; 42h
 14787 00000EB0 [170F]                  		dw Cmd_Error_Proc
 14788 00000EB2 [170F]                  		dw Cmd_Error_Proc
 14789 00000EB4 [170F]                  		dw Cmd_Error_Proc
 14790 00000EB6 [5314]                  		dw SetMediaId		; 46h
 14791 00000EB8 [0515]                  		dw SetAccessFlag	; 47h ; unpublished function
 14792                                  		; 24/12/2023
 14793                                  		; Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 14794 00000EBA [8715]                  		dw SetLockState		; 48h
 14795 00000EBC [9E15]                  		dw EjectMedia		; 49h	
 14796                                  		
 14797                                  ; ==========================================================================
 14798                                  ; IOC_DC_Table
 14799                                  ;
 14800                                  ; This table contains all of the valid generic IOCtl Minor codes for
 14801                                  ; major function 08 to be used by the Ioctl_Support_Query function.
 14802                                  ; Added for 5.00
 14803                                  ; ==========================================================================
 14804                                  
 14805                                  		; 24/12/2023 - Retro DOS v5.0
 14806                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:0F00h)
 14807                                  
 14808 00000EBE 60                      IOC_DC_Table:	db 60h			; GET_DEVICE_PARAMETERS
 14809 00000EBF 40                      		db 40h			; SET_DEVICE_PARAMETERS
 14810 00000EC0 61                      		db 61h			; READ_TRACK
 14811 00000EC1 41                      		db 41h			; WRITE_TRACK
 14812 00000EC2 62                      		db 62h			; VERIFY_TRACK
 14813 00000EC3 42                      		db 42h			; FORMAT_TRACK
 14814 00000EC4 66                      		db 66h			; GET_MEDIA_ID
 14815 00000EC5 46                      		db 46h			; SET_MEDIA_ID
 14816 00000EC6 67                      		db 67h			; GET_ACCESS_FLAG
 14817 00000EC7 47                      		db 47h			; SET_ACCESS_FLAG
 14818 00000EC8 68                      		db 68h			; SENSE_MEDIA_TYPE
 14819                                  		; 24/12/2023
 14820                                  		; Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 14821 00000EC9 48                      		db 48h			; SET_LOCK_STATE
 14822 00000ECA 49                      		db 49h			; EJECT_MEDIA
 14823 00000ECB 6F                      		db 6Fh			; GET_DRV_MAP_INFO
 14824                                  
 14825                                  ;IOC_DC_TABLE_LEN EQU $ - IOC_DC_Table
 14826                                  
 14827                                  		; 24/12/2023 - Retro DOS v5.0
 14828                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:0F0Eh)
 14829                                  
 14830 00000ECC 00                      new_genioctl:	db 0
 14831                                  
 14832                                  ; ---------------------------------------------------------------------------
 14833                                  
 14834                                  ; 16/10/2022
 14835                                  
 14836                                  ; ==========================================================================
 14837                                  ; Do_Generic_IOCtl: perform generic ioctl request
 14838                                  ;
 14839                                  ;    input: AL contains logical drive
 14840                                  ;
 14841                                  ;	functions are dispatched through a call. On return, carry indicates
 14842                                  ;	error code in al. Note::bES:b& ds undefined on return from
 14843                                  ;	subfunctions.
 14844                                  ;
 14845                                  ; ==========================================================================
 14846                                  
 14847                                  ; 11/03/2019
 14848                                  		; 24/12/2023 - Retro DOS v5.0
 14849                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:0F0Fh)
 14850                                  
 14851                                  		; 19/10/2022
 14852                                  do_generic_ioctl:			; 2C7h:0C6Bh = 70h:31DBh
 14853 00000ECD E8D4F6                  		call	SetDrive	; ES:DI	Points to bds for drive
 14854                                  		
 14855                                  		; 24/12/2023
 14856                                  		;;;
 14857 00000ED0 2EC606[CC0E]00          		mov	byte [cs:new_genioctl], 0
 14858                                  					; 0, old generic ioctl function
 14859 00000ED6 06                      		push	es
 14860 00000ED7 C41E[1200]              		les	bx, [ptrsav]	; ES:BX	Points to request header
 14861 00000EDB 26807F0D08              		cmp	byte [es:bx+0Dh], 8 ; [es:bx+IOCTL_REQ.MAJORFUNCTION]
 14862                                  					; RAWIO
 14863                                  		; 24/12/2023
 14864                                  		;mov	al, [es:bx+0Eh]	; [es:bx+IOCTL_REQ.MINORFUNCTION]
 14865                                  		;pop	es
 14866                                  		;jnz	short IoctlFuncErr
 14867 00000EE0 740A                    		jz	short chk_genioctl_minor
 14868 00000EE2 2EFE06[CC0E]            		inc	byte [cs:new_genioctl]
 14869                                  					; 1, new generic ioctl function (FAT32)
 14870 00000EE7 26807F0D48              		cmp	byte [es:bx+0Dh], 48h ; Generic IOCtl Request support
 14871                                  				; (called only if bit 6 of attribute is set to 1)
 14872                                  chk_genioctl_minor:
 14873 00000EEC 268A470E                		mov	al, [es:bx+0Eh]	; [es:bx+IOCTL_REQ.MINORFUNCTION]
 14874 00000EF0 07                      		pop	es
 14875 00000EF1 7525                    		jnz	short IoctlFuncErr
 14876                                  		;;;
 14877                                  
 14878                                  		; cas note: Could do the above two blocks in reverse order.
 14879                                  		; Would have to preserve al for SetDrive
 14880                                  
 14881                                  		; 10/12/2022
 14882 00000EF3 BE[880E]                		mov	si, IoReadJumpTable
 14883                                  		;mov	si, 0C3Ch	; IoReadJumpTable
 14884                                  					; at 2C7h:0C3Ch	= 70h:31ACh
 14885 00000EF6 A820                    		test	al, 20h		; GEN_IOCTL_FN_TST ; test of req. function
 14886 00000EF8 7503                    		jnz	short NotGenericWrite ; function is a read.
 14887                                  		; 10/12/2022
 14888 00000EFA BE[A90E]                		mov	si, IoWriteJumpTable
 14889                                  		;mov	si, 0C4Fh	; IoWriteJumpTable
 14890                                  					; at 2C7h:0C4Fh	= 70h:31BFh
 14891                                  NotGenericWrite:
 14892 00000EFD 24DF                    		and	al, 0DFh	; ~GEN_IOCTL_FN_TST ; get rid of read/write bit
 14893 00000EFF 2C40                    		sub	al, 40h		; offset for base function
 14894 00000F01 2E3A04                  		cmp	al, [cs:si]
 14895 00000F04 7712                    		ja	short IoctlFuncErr
 14896 00000F06 98                      		cbw
 14897                                  		; 24/12/2023
 14898                                  		;shl	ax, 1
 14899 00000F07 01C0                    		add	ax, ax
 14900 00000F09 46                      		inc	si
 14901 00000F0A 01C6                    		add	si, ax
 14902 00000F0C 2EFF14                  		call	near [cs:si]
 14903                                  		;call	word ptr cs:[si]
 14904 00000F0F 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 14905                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 14906                                  					; 2C7h:30h = 70h:25A0h
 14907 00000F14 B481                    		mov	ah, 81h		; Return this status in	case of	carry
 14908 00000F16 C3                      		retn			; Pass carry flag through to exit code
 14909                                  ; ---------------------------------------------------------------------------
 14910                                  
 14911                                  		; Cmd_Error_Proc is called as a procedure and also use
 14912                                  		; as a fall through from above
 14913                                  Cmd_Error_Proc:				; 2C7h:0CA3h = 70h:3213h
 14914 00000F17 5A                      		pop	dx
 14915                                  IoctlFuncErr:
 14916 00000F18 E9BAF1                  		jmp	bc_cmderr
 14917                                  ; ---------------------------------------------------------------------------
 14918                                  
 14919                                  ; 16/10/2022
 14920                                  
 14921                                  ; ==========================================================================
 14922                                  ;**	GetDeviceParameters:
 14923                                  ;
 14924                                  ;	GetDeviceParameters implements the generic ioctl function:
 14925                                  ;	majorcode=RAWIO, minorcode=GetDeviceParameters (60h)
 14926                                  ;
 14927                                  ;	ENTRY	(ES:di) = BDS for drive
 14928                                  ;		PtrSav = long pointer to request header
 14929                                  ;	EXIT	??? BUGBUG
 14930                                  ;	USES	??? BUGBUG
 14931                                  ; ==========================================================================
 14932                                  
 14933                                  		; 24/12/2023 - Retro DOS v5.0
 14934                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:0F5Dh)
 14935                                  
 14936                                  		; 19/10/2022
 14937                                  GetDeviceParameters:
 14938                                  		; Copy info from bds to the device parameters packet
 14939                                  
 14940 00000F1B C51E[1200]              		lds	bx, [ptrsav]	; DS:BX	points to request header
 14941 00000F1F C55F13                  		lds	bx, [bx+19]	; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 14942                                  					; (DS:BX) = return buffer
 14943                                  		; 24/12/2023
 14944 00000F22 268A453E                		mov	al, [es:di+3Eh]
 14945                                  		;mov	al, [es:di+34]	; [es:di+BDS.formfactor]
 14946 00000F26 884701                  		mov	[bx+1],	al	; [bx+A_DEVICEPARAMETERS.DP_DEVICETYPE]
 14947                                  		; 24/12/2023
 14948 00000F29 268B453F                		mov	ax, [es:di+3Fh]
 14949                                  		;mov	ax, [es:di+35]	; [es:di+BDS.flags]
 14950 00000F2D 83E003                  		and	ax, 3		; fnon_removable+fchangeline
 14951                                  					; Mask off other bits
 14952 00000F30 894702                  		mov	[bx+2],	ax	; [bx+A_DEVICEPARAMETERS.DP_DEVICEATTRIBUTES]
 14953                                  		; 24/12/2023
 14954 00000F33 268B4541                		mov     ax, [es:di+41h]
 14955                                  		;mov	ax, [es:di+37]	; [es:di+BDS.cylinders]
 14956 00000F37 894704                  		mov	[bx+4],	ax	; [bx+A_DEVICEPARAMETERS.DP_CYLINDERS]
 14957 00000F3A 30C0                    		xor	al, al		; Set media type to default
 14958 00000F3C 884706                  		mov	[bx+6],	al	; [bx+A_DEVICEPARAMETERS.DP_MEDIATYPE]
 14959                                  					
 14960                                  		; copy recommended bpb
 14961                                  
 14962                                  		; 24/12/2023
 14963 00000F3F 8D7543                  		lea     si, [di+43h]
 14964                                  		;lea	si, [di+39]	; [di+BDS.rbytespersec]	= [di+BDS.R_BPB]
 14965 00000F42 F60701                  		test	byte [bx], 1	; [bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS]
 14966                                  					; BUILD_DEVICE_BPB
 14967 00000F45 7412                    		jz	short UseBpbPresent
 14968 00000F47 1E                      		push	ds		; Save request packet segment
 14969 00000F48 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 14970                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 14971                                  					; 2C7h:30h = 70h:25A0h
 14972                                  					; Point back to Bios_Data
 14973 00000F4D E829FA                  		call	checksingle
 14974 00000F50 E883F7                  		call	GetBp		; Build	the bpb	from scratch
 14975 00000F53 1F                      		pop	ds		; Restore request packet segment
 14976 00000F54 7224                    		jb	short GetParmRet
 14977 00000F56 8D7506                  		lea	si, [di+6]	; [di+BDS.bytespersec] = [di+BSD.DP_BPB]
 14978                                  					; Use this subfield of bds instead
 14979                                  UseBpbPresent:				
 14980 00000F59 8D7F07                  		lea	di, [bx+7]	; [bx+A_DEVICEPARAMETERS.DP_BPB]
 14981                                  					; This is where	the result goes
 14982                                  		; 24/12/2023
 14983 00000F5C 31D2                    		xor	dx, dx ; 0
 14984                                  		
 14985                                  		; 24/12/2023
 14986 00000F5E B91F00                  		mov	cx, 31		; A_BPB.size = 31
 14987                                  		;mov	cx, 25		; A_BPB.size - 6
 14988                                  					; For now use 'small' bpb
 14989                                  		; 24/12/2023
 14990                                  		;;;
 14991 00000F61 2E3816[CC0E]            		cmp	[cs:new_genioctl], dl ; 0 ? ; *
 14992 00000F66 7404                    		jz	short gdp_1	; old type (FAT12 & FAT16) structure
 14993                                  		;mov	cx, 53		; FAT32 BPB size
 14994                                  		;mov	dx, 32		; 53+32 = 85 bytes (A_BPB_FAT32.size)
 14995 00000F68 B135                    		mov	cl, 53
 14996 00000F6A B220                    		mov	dl, 32
 14997                                  gdp_1:
 14998                                  		;;;
 14999 00000F6C 1E                      		push	ds		; reverse segments for copy
 15000 00000F6D 06                      		push	es
 15001 00000F6E 1F                      		pop	ds
 15002 00000F6F 07                      		pop	es
 15003 00000F70 F3A4                    		rep movsb
 15004                                  
 15005                                  		; 24/12/2023
 15006                                  		;;;
 15007 00000F72 89D1                    		mov	cx, dx		; 0 or 32
 15008 00000F74 E304                    		jcxz	gdp_2
 15009 00000F76 30C0                    		xor	al, al		; 32 zeros
 15010 00000F78 F3AA                    		rep stosb
 15011                                  gdp_2:
 15012                                  		;clc	; cf is already 0 ; * ; 24/12/2023
 15013                                  		;;;		
 15014                                  		
 15015                                  		; 12/12/2022
 15016                                  		; cf=0 (test instruction -above- resets cf) 	
 15017                                  		;clc
 15018                                  GetParmRet:				
 15019 00000F7A C3                      		retn
 15020                                  ; ---------------------------------------------------------------------------
 15021                                  
 15022                                  ; 17/10/2022
 15023                                  ; 16/10/2022
 15024                                  
 15025                                  ; ==========================================================================
 15026                                  ; SetDeviceParameters:
 15027                                  ;
 15028                                  ; input: ES:di points to bds for drive
 15029                                  ; ==========================================================================
 15030                                  
 15031                                  		; 24/12/2023 - Retro DOS v5.0
 15032                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:0FC0h)
 15033                                  
 15034                                  		; 19/10/2022
 15035                                  SetDeviceParameters:			; 2C7h:0CF3h = 70h:3263h
 15036 00000F7B C51E[1200]              		lds	bx, [ptrsav]	; DS:BX	points to request header
 15037 00000F7F C55F13                  		lds	bx, [bx+19]	; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 15038                                  		; 24/12/2023
 15039 00000F82 26814D3F4001            		or	word [es:di+3Fh], 140h
 15040                                  		;or	word [es:di+23h], 140h ; [es:di+BDS.flags]
 15041                                  					; fchanged_by_format|fchanged
 15042 00000F88 F60702                  		test	byte [bx], 2	; [bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS]
 15043                                  					; ONLY_SET_TRACKLAYOUT
 15044                                  		;jnz	short setTrackTable
 15045                                  		; 24/12/2023
 15046 00000F8B 7403                    		jz	short sdp_1
 15047 00000F8D E98000                  		jmp	setTrackTable
 15048                                  sdp_1:	
 15049 00000F90 8A4701                  		mov	al, [bx+1]	; [bx+A_DEVICEPARAMETERS.DP_DEVICETYPE]
 15050                                  		; 24/12/2023
 15051 00000F93 2688453E                		mov	[es:di+3Eh], al
 15052                                  		;mov	[es:di+34], al	; [es:di+BDS.formfactor]
 15053 00000F97 8B4704                  		mov	ax, [bx+4]	; [bx+A_DEVICEPARAMETERS.DP_CYLINDERS]
 15054                                  		; 24/12/2023
 15055 00000F9A 26894541                		mov	[es:di+41h], ax
 15056                                  		;mov	[es:di+37], ax	; [es:di+BDS.cylinders]
 15057 00000F9E 8B4702                  		mov	ax, [bx+2]	; [bx+A_DEVICEPARAMETERS.DP_DEVICEATTRIBUTES]
 15058 00000FA1 1E                      		push	ds
 15059                                  		; 17/10/2022
 15060 00000FA2 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 15061                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 15062                                  					; 2C7h:30h = 70h:25A0h
 15063                                  		;cmp	byte [fhave96], 0
 15064 00000FA7 803E[7700]00            		cmp	byte [fhave96], 0
 15065 00000FAC 1F                      		pop	ds
 15066 00000FAD 7502                    		jnz	short HaveChange ; we have changeline support
 15067                                  		; 10/12/2022
 15068 00000FAF 24FD                    		and	al, 0FDh
 15069                                  		;and	ax, 0FFFDh	; ~fchangeline
 15070                                  
 15071                                  		; Ignore all bits except non_removable and changeline
 15072                                  HaveChange:
 15073 00000FB1 83E003                  		and	ax, 3		; fnon_removable|fchangeline
 15074                                  		; 24/12/2023
 15075 00000FB4 268B4D3F                		mov	cx, [es:di+3Fh]
 15076                                  		;mov	cx, [es:di+35]	; [es:di+BDS.flags]
 15077 00000FB8 81E1F4FD                		and	cx, 0FDF4h	; ~(fnon_removable|fchangeline|good_tracklayout|unformatted_media)
 15078 00000FBC 09C8                    		or	ax, cx
 15079                                  		; 24/12/2023
 15080 00000FBE 2689453F                		mov	[es:di+3Fh], ax
 15081                                  		;mov	[es:di+35], ax	; [es:di+BDS.flags]
 15082 00000FC2 8A4706                  		mov	al, [bx+6]	; [bx+A_DEVICEPARAMETERS.DP_MEDIATYPE]
 15083                                  					; Set media type
 15084 00000FC5 1E                      		push	ds
 15085 00000FC6 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 15086                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 15087 00000FCB A2[A805]                		mov	[mediatype], al
 15088                                  		;mov	ds:mediatype, al
 15089                                  
 15090                                  		; 24/12/2023
 15091                                  		;;;
 15092 00000FCE B93500                  		mov	cx, 53		; FAT32 BPB size
 15093 00000FD1 2E803E[CC0E]00          		cmp	byte [cs:new_genioctl], 0
 15094 00000FD7 7502                    		jnz	short sdp_2	; new type (FAT32) structure
 15095                                  		;mov	cx, 31		; A_BPB.size = 31
 15096 00000FD9 B11F                    		mov	cl, 31
 15097                                  sdp_2:
 15098                                  		;;;	
 15099 00000FDB 1F                      		pop	ds
 15100                                  
 15101                                  		; The media changed (maybe) so we will have to do a set dasd
 15102                                  		; the next time we format a track
 15103                                  
 15104                                  		; 24/12/2023
 15105 00000FDC 26804D3F80              		or	byte [es:di+3Fh], 80h
 15106                                  		; 10/12/2022
 15107                                  		;or	byte [es:di+35], 80h
 15108                                  		;;or	word [es:di+35], 80h ; [es:di+BDS.flags]
 15109                                  					; set_dasd_true
 15110 00000FE1 57                      		push	di		; Save bds pointer
 15111                                  
 15112                                  		; Figure out what we are supposed to do with the bpb
 15113                                  		; were we asked to install a fake bpb?
 15114                                  
 15115 00000FE2 F60701                  		test	byte [bx], 1	; [bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS]
 15116                                  					; INSTALL_FAKE_BPB
 15117 00000FE5 7511                    		jnz	short InstallFakeBpb
 15118                                  
 15119                                  		; were we returning a fake bpb when asked to build a bpb?
 15120                                  
 15121                                  		; 24/12/2023
 15122 00000FE7 26F6453F04              		test	byte [es:di+3Fh], 4
 15123                                  		; 10/12/2022
 15124                                  		;test	byte [es:di+35], 4
 15125                                  		;;test	word [es:di+35], 4 ; [es:di+BDS.flags]
 15126                                  					; return_fake_bpb
 15127 00000FEC 7405                    		jz	short InstallRecommendedBpb
 15128                                  
 15129                                  		; we were returning a fake bpb but we can stop now
 15130                                  
 15131                                  		; 24/12/2023
 15132 00000FEE 2680653FFB              		and	byte [es:di+3Fh], 0FBh
 15133                                  		; 10/12/2022
 15134                                  		;and	byte [es:di+35], 0FBh
 15135                                  		;;and	word [es:di+35], 0FFFBh ; [es:di+BDS.flags]
 15136                                  					; ~return_fake_bpb
 15137                                  InstallRecommendedBpb:
 15138                                  		; 24/12/2023
 15139                                  		;mov	cx, 31		; A_BPB.size
 15140                                  		;lea	di, [di+27h]	; [di+BDS.R_BPB] = [di+BDS.rbytespersec]
 15141                                  		; cx = 53 or 31
 15142 00000FF3 8D7D43                  		lea	di, [di+43h]	; (PCDOS 7.1 IBMBIO.COM)
 15143 00000FF6 EB08                    		jmp	short CopyTheBpb
 15144                                  ; ---------------------------------------------------------------------------
 15145                                  
 15146                                  InstallFakeBpb:
 15147                                  		; 24/12/2023
 15148 00000FF8 26804D3F04              		or	byte [es:di+3Fh], 4
 15149                                  		; 10/12/2022
 15150                                  		;or	byte [es:di+35], 4
 15151                                  		;;or	word [es:di+35], 4 ; byte [es:di+BDS.flags]
 15152                                  					; return_fake_bpb
 15153                                  		; 24/12/2023
 15154                                  		; cx = 53 or 31
 15155                                  		;mov	cx, 25		; A_BPB.size - 6
 15156                                  					; move 'smaller' bpb
 15157 00000FFD 8D7D06                  		lea	di, [di+6]	; [es:di+BDS.BPB] = [es:di+BDS.bytespersec]
 15158                                  CopyTheBpb:				
 15159 00001000 8D7707                  		lea	si, [bx+7]	; [bx+A_DEVICEPARAMETERS.DP_BPB]
 15160 00001003 F3A4                    		rep movsb
 15161 00001005 1E                      		push	ds		; Save packet segment
 15162                                  		; 17/10/2022
 15163 00001006 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 15164                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 15165                                  					; Setup	for ds -> Bios_Data
 15166 0000100B E8DD03                  		call	RestoreOldDpt	; Restore the old Dpt from TempDpt
 15167 0000100E 1F                      		pop	ds		; Restore packet segment
 15168 0000100F 5F                      		pop	di		; Restore bds pointer
 15169                                  setTrackTable:	
 15170                                  		; 24/12/2023
 15171                                  		;mov	cx, [bx+38]	; [bx+26h]
 15172                                  		;;;
 15173 00001010 8B4F5C                  		mov	cx, [bx+5Ch]	; [bx+A_DEVICEPARAMETERS.DP_TRACKTABLEENTRIES]
 15174                                  					; offset 85+7 (A_BPB.size+7) (FAT32)
 15175 00001013 2E803E[CC0E]00          		cmp	byte [cs:new_genioctl], 0
 15176 00001019 7503                    		jnz	short sdp_3	; new type (FAT32) structure
 15177 0000101B 8B4F26                  		mov	cx, [bx+26h]	; [bx+A_DEVICEPARAMETERS.DP_TRACKTABLEENTRIES]
 15178                                  					; offset 31+7 (A_BPB.size+7)
 15179                                  sdp_3:
 15180                                  		;;;
 15181                                  
 15182 0000101E 1E                      		push	ds
 15183 0000101F 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 15184 00001024 890E[AA04]              		mov	[sectorspertrack], cx
 15185 00001028 1F                      		pop	ds
 15186                                  		
 15187                                  		; 24/12/2023
 15188 00001029 2680653FF7              		and	byte [es:di+3Fh], 0F7h
 15189                                  		; 10/12/2022
 15190                                  		;and	byte [es:di+35], 0F7h
 15191                                  		;;and	word [es:di+35], 0FFF7h ; [es:di+BDS.flags]
 15192                                  					; ~good_tracklayout
 15193 0000102E F60704                  		test	byte [bx], 4	; [bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS]
 15194                                  					; TRACKLAYOUT_IS_GOOD
 15195 00001031 7405                    		jz	short UglyTrackLayOut
 15196                                  		; 24/12/2023
 15197 00001033 26804D3F08              		or	byte [es:di+3Fh], 8
 15198                                  		; 10/12/2022
 15199                                  		;or	byte [es:di+35], 8
 15200                                  		;;or	word [es:di+35], 8 ; [es:di+BDS.flags]
 15201                                  					; good_tracklayout
 15202                                  UglyTrackLayOut:
 15203 00001038 83F93F                  		cmp	cx, 63		; MAX_SECTORS_IN_TRACK
 15204 0000103B 772D                    		ja	short TooManyPerTrack
 15205                                  		;jcxz	short SectorInfoSaved
 15206 0000103D E329                    		jcxz	SectorInfoSaved	; 19/10/2022
 15207                                  		
 15208 0000103F BF[AC04]                		mov	di, tracktable
 15209                                  
 15210                                  		; 24/12/2023
 15211                                  		;lea	si, [bx+40]	; [bx+A_DEVICEPARAMETERS.DP_SECTORTABLE]
 15212                                  		;;;
 15213 00001042 8D775E                  		lea	si, [bx+5Eh]	; [bx+A_DEVICEPARAMETERS.DP_SECTORTABLE]
 15214                                  					; offset 85+9 (A_BPB.size+9) (FAT32)
 15215 00001045 2E803E[CC0E]00          		cmp	byte [cs:new_genioctl], 0
 15216 0000104B 7503                    		jnz	short sdp_4	; new type (FAT32) structure
 15217 0000104D 8D7728                  		lea	si, [bx+28h]	; [bx+A_DEVICEPARAMETERS.DP_SECTORTABLE]
 15218                                  					; offset 31+9 (A_BPB.size+9)
 15219                                  sdp_4:
 15220                                  		;;;
 15221                                  
 15222                                  		; 17/10/2022
 15223 00001050 2E8E06[3000]            		mov	es, [cs:BIOSDATAWORD]
 15224                                  		;mov	es, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 15225                                  					; Trash	our bds	pointer
 15226                                  StoreSectorInfo:
 15227 00001055 47                      		inc	di
 15228 00001056 47                      		inc	di		; Skip over cylinder and head
 15229 00001057 AD                      		lodsw			; Get sector id
 15230 00001058 AA                      		stosb			; Copy it
 15231 00001059 AD                      		lodsw			; Get sector size
 15232                                  		
 15233                                  		; 24/12/2023
 15234                                  		; 02/09/2023 (PCDOS 7.1)
 15235                                  		;call	SectSizeToSectIndex
 15236 0000105A 80FC03                  		cmp	ah, 3 ; 02/09/2023
 15237                                  		;cmp	ah, 2		; (0=>128,1=>256,2=>512,3=>1024)
 15238                                  					; examine upper	byte only
 15239 0000105D 7704                    		ja	short OneK
 15240 0000105F 88E0                    		mov	al, ah		; value	in AH is the index!
 15241 00001061 EB02                    		jmp	short sdp_s
 15242                                  OneK:
 15243 00001063 B003                    		mov	al, 3		; 1024 bytes per sector
 15244                                  sdp_s:
 15245 00001065 AA                      		stosb			; Store	sector SIZE index
 15246 00001066 E2ED                    		loop	StoreSectorInfo
 15247                                  SectorInfoSaved:
 15248 00001068 F8                      		clc
 15249 00001069 C3                      		retn
 15250                                  ; ---------------------------------------------------------------------------
 15251                                  
 15252                                  TooManyPerTrack:
 15253 0000106A B00C                    		mov	al, 0Ch
 15254 0000106C F9                      		stc
 15255 0000106D C3                      		retn
 15256                                  ; ---------------------------------------------------------------------------
 15257                                  
 15258                                  ; 16/10/2022
 15259                                  
 15260                                  ; ==========================================================================
 15261                                  ; FormatTrack:
 15262                                  ; if specialfunction byte is 1,then this is a status call to see if there is
 15263                                  ; rom support for the combination of sec/trk and # of cyln,and if the
 15264                                  ; combination is legal. if specialfunction byte is 0,then format the track.
 15265                                  ;
 15266                                  ; input: ES:di points to bds for drive
 15267                                  ;
 15268                                  ; output:
 15269                                  ;	for status call:
 15270                                  ;	specialfunction byte set to:
 15271                                  ;		0 - rom support + legal combination
 15272                                  ;		1 - no rom support
 15273                                  ;		2 - illegal combination
 15274                                  ;		3 - no media present
 15275                                  ;	carry cleared.
 15276                                  ;
 15277                                  ;	for format track:
 15278                                  ;		carry set if error
 15279                                  ;
 15280                                  ; ==========================================================================
 15281                                  
 15282                                  ; 16/03/2019
 15283                                  		; 24/12/2023 - Retro DOS 5.0
 15284                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:1B07h)
 15285                                  
 15286                                  		; 19/10/2022
 15287                                  FormatTrack:
 15288 0000106E C51E[1200]              		lds	bx, [ptrsav]
 15289 00001072 C55F13                  		lds	bx, [bx+19]	; [bx+IOCTL_REQ.GENERICIOCTL_PACKET
 15290 00001075 F60701                  		test	byte [bx], 1	; [bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS]
 15291                                  					; STATUS_FOR_FORMAT
 15292 00001078 740E                    		jz	short DoFormatTrack
 15293 0000107A 1E                      		push	ds
 15294                                  		; 17/10/2022
 15295 0000107B 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 15296                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 15297 00001080 E82502                  		call	SetMediaForFormat ; Also moves current Dpt to TempDpt
 15298 00001083 1F                      		pop	ds
 15299 00001084 8807                    		mov	[bx], al	; [bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS]
 15300 00001086 F8                      		clc
 15301 00001087 C3                      		retn
 15302                                  ; ---------------------------------------------------------------------------
 15303                                  
 15304                                  DoFormatTrack:
 15305                                  		; 24/12/2023 - Retro DOS 5.0
 15306 00001088 26807D3E05              		cmp	byte [es:di+3Eh], 5				
 15307                                  		;cmp	byte [es:di+34], 5 ; [es:di+BDS.formfactor]
 15308                                  					; DEV_HARDDISK
 15309 0000108D 7508                    		jnz	short DoFormatDiskette
 15310                                  		; 17/10/2022
 15311 0000108F 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 15312                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 15313                                  					; Point	to Bios_Data (at 2C7h:30h or 70h:25A0h)
 15314 00001094 E99D00                  		jmp	VerifyTrack
 15315                                  ; ---------------------------------------------------------------------------
 15316                                  
 15317                                  DoFormatDiskette:
 15318 00001097 8B4F01                  		mov	cx, [bx+1]
 15319 0000109A 8B5703                  		mov	dx, [bx+3]
 15320 0000109D F60702                  		test	byte [bx], 2
 15321                                  		; 17/10/2022
 15322 000010A0 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 15323                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 15324                                  					; Setup	ds-> Bios_Data for verify
 15325 000010A5 7403                    		jz	short DoFormatDiskette_1
 15326 000010A7 E9E500                  		jmp	VerifyTrack_Err
 15327                                  ; ---------------------------------------------------------------------------
 15328                                  
 15329                                  DoFormatDiskette_1:
 15330 000010AA E8FB01                  		call	SetMediaForFormat ; Also moves current Dpt to TempDpt
 15331 000010AD 3C01                    		cmp	al, 1		;  ROM support for sec/trk,# trks comb?
 15332 000010AF 7406                    		jz	short NeedToSetDasd ; Old rom
 15333 000010B1 3C03                    		cmp	al, 3		; Time out error?
 15334 000010B3 7507                    		jnz	short NoSetDasd	; No,fine. (at this point, don't care
 15335                                  					; about	the illegal combination)
 15336 000010B5 EB68                    		jmp	short FormatFailed
 15337                                  ; ---------------------------------------------------------------------------
 15338                                  
 15339                                  NeedToSetDasd:
 15340 000010B7 52                      		push	dx
 15341 000010B8 E89001                  		call	SetDasd		; INT 13h, AH=17h
 15342 000010BB 5A                      		pop	dx
 15343                                  NoSetDasd:
 15344 000010BC E8BAF8                  		call	checksingle	; Do any needed	diskette swapping
 15345 000010BF 89D0                    		mov	ax, dx		; Get track from packet
 15346 000010C1 A3[3901]                		mov	[trknum], ax
 15347 000010C4 880E[3801]              		mov	[hdnum], cl	; Store	head from packet
 15348 000010C8 88CC                    		mov	ah, cl
 15349 000010CA BB[AC04]                		mov	bx, tracktable
 15350 000010CD 8B0E[AA04]              		mov	cx, [sectorspertrack]
 15351                                  		; 24/12/2023 - Retro DOS 5.0
 15352 000010D1 E307                    		jcxz	set_fmt_retry_count
 15353                                  StoreCylinderHead:
 15354 000010D3 8907                    		mov	[bx], ax	; Store	into TrackTable
 15355 000010D5 83C304                  		add	bx, 4		; Skip to next sector field
 15356 000010D8 E2F9                    		loop	StoreCylinderHead
 15357                                  set_fmt_retry_count:	; 24/12/2023
 15358                                  		;mov	cx, 5		; MAXERR - Set up retry	count
 15359                                  		; 02/09/2023
 15360 000010DA B105                    		mov	cl, 5
 15361                                  FormatRetry:
 15362 000010DC 51                      		push	cx
 15363 000010DD BB[AC04]                		mov	bx, tracktable
 15364 000010E0 A0[AA04]                		mov	al, [sectorspertrack]
 15365 000010E3 B405                    		mov	ah, 5		; romformat
 15366 000010E5 8C1E[A804]              		mov	[xfer_seg], ds
 15367 000010E9 E86602                  		call	ToRom
 15368 000010EC 59                      		pop	cx
 15369 000010ED 7216                    		jb	short FormatError
 15370 000010EF 51                      		push	cx		; Now verify the sectors just formatted.
 15371                                  					; NOTE:	because	of bug in some BIOSes we have to
 15372                                  					;	set ES:BX to 00:00
 15373 000010F0 53                      		push	bx
 15374 000010F1 31DB                    		xor	bx, bx
 15375 000010F3 891E[A804]              		mov	[xfer_seg], bx
 15376 000010F7 A0[AA04]                		mov	al, [sectorspertrack]
 15377 000010FA B404                    		mov	ah, 4		; romverify
 15378 000010FC B101                    		mov	cl, 1
 15379 000010FE E85102                  		call	ToRom
 15380 00001101 5B                      		pop	bx
 15381 00001102 59                      		pop	cx
 15382 00001103 7329                    		jnb	short FormatOk
 15383                                  FormatError:
 15384 00001105 E83402                  		call	ResetDisk
 15385 00001108 C606[AA05]01            		mov	byte [had_format_error], 1
 15386 0000110D 50                      		push	ax
 15387 0000110E 51                      		push	cx
 15388 0000110F 52                      		push	dx
 15389 00001110 E89501                  		call	SetMediaForFormat
 15390 00001113 3C01                    		cmp	al, 1
 15391 00001115 7503                    		jnz	short WhileErr
 15392 00001117 E83101                  		call	SetDasd
 15393                                  WhileErr:
 15394 0000111A 5A                      		pop	dx
 15395 0000111B 59                      		pop	cx
 15396 0000111C 58                      		pop	ax
 15397 0000111D E2BD                    		loop	FormatRetry
 15398                                  FormatFailed:
 15399 0000111F C606[AA05]01            		mov	byte [had_format_error], 1
 15400                                  					; Set the format error flag
 15401 00001124 80FC06                  		cmp	ah, 6		; DSK_CHANGELINE_ERR - convert change line
 15402 00001127 7502                    		jnz	short DoMapIt	; Error	to time	out error
 15403 00001129 B480                    		mov	ah, 80h		; DSK_TIMEOUT_ERR
 15404                                  DoMapIt:
 15405 0000112B E97CFC                  		jmp	maperror
 15406                                  ; ---------------------------------------------------------------------------
 15407                                  
 15408                                  FormatOk:
 15409 0000112E C606[AA05]00            		mov	byte [had_format_error], 0 ; reset the format error flag
 15410 00001133 C3                      		retn
 15411                                  ; ---------------------------------------------------------------------------
 15412                                  
 15413                                  ; 16/10/2022
 15414                                  
 15415                                  ; ==========================================================================
 15416                                  ;
 15417                                  ; VerifyTrack:
 15418                                  ;
 15419                                  ; input: ES:di points to bds for drive
 15420                                  ; ==========================================================================
 15421                                  
 15422                                  		; 24/12/2023 - Retro DOS 5.0
 15423                                  VerifyTrack:
 15424 00001134 1E                      		push	ds
 15425 00001135 C51E[1200]              		lds	bx, [ptrsav]	; DS:BX points to request header.
 15426 00001139 C55F13                  		lds	bx, [bx+19]	; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 15427                                  
 15428                                  		; Come here with DS:[BX] -> packet, ES:[DI] -> bds
 15429                                  
 15430 0000113C 8B4F03                  		mov	cx, [bx+3]	; [bx+A_VERIFYPACKET.VP_CYLINDER]
 15431 0000113F 8B4701                  		mov	ax, [bx+1]	; [bx+A_VERIFYPACKET.VP_HEAD]
 15432 00001142 8B5705                  		mov	dx, [bx+5]	; [bx+A_FORMATPACKET.FP_TRACKCOUNT]
 15433 00001145 8A1F                    		mov	bl, [bx]	; [bx+A_FORMATPACKET.FP_SPECIALFUNCTIONS]
 15434                                  					; Get option flag word
 15435 00001147 1F                      		pop	ds
 15436 00001148 C606[2001]04            		mov	byte [rflag], 4	; romverify
 15437 0000114D 890E[3301]              		mov	[curtrk], cx
 15438 00001151 A2[3201]                		mov	[curhd], al	; ASSUME heads < 256
 15439 00001154 8B0E[AA04]              		mov	cx, [sectorspertrack]
 15440                                  
 15441                                  		; Check specialfunctions to see if DO_FAST_FORMAT has been
 15442                                  		; specified if not we should go to the normal track verification
 15443                                  		; routine. If fast format has been specified we should get the
 15444                                  		; number of tracks to be verified and check it to see if it is
 15445                                  		; > 255. If it is then it is an error and we should go to
 15446                                  		; VerifyTrack_Err. If not multiply the number of tracks by the
 15447                                  		; sectors per track to get the total number of sectors to be
 15448                                  		; verified. This should also be less than equal to 255
 15449                                  		; otherwise we go to same error exit. If everything is okay
 15450                                  		; we initalise cx to the total sectors. use ax as a temporary
 15451                                  		; register.
 15452                                  
 15453                                  					; Special function requested?	
 15454 00001158 F6C302                  		test	bl, 2		; DO_FAST_FORMAT
 15455 0000115B 7421                    		jz	short NormVerifyTrack
 15456 0000115D 89D0                    		mov	ax, dx		; Get ax = number of trks to verify
 15457 0000115F 08E4                    		or	ah, ah
 15458 00001161 752C                    		jnz	short VerifyTrack_Err ; #tracks > 255
 15459 00001163 F6E1                    		mul	cl
 15460 00001165 08E4                    		or	ah, ah
 15461 00001167 7526                    		jnz	short VerifyTrack_Err ; #sectors > 255	
 15462 00001169 89C1                    		mov	cx, ax
 15463                                  		; 24/12/2023
 15464 0000116B 26F6453F01              		test	byte [es:di+3Fh], 1 ; PCDOS 7.1 IBMBIO.COM
 15465                                  		; 10/12/2022
 15466                                  		;test	byte [es:di+35], 1
 15467                                  		;;test	word [es:di+35], 1 ; [es:di+BDS.flags]
 15468                                  					; fnon_removable
 15469 00001170 740C                    		jz	short NormVerifyTrack
 15470                                  					; Multitrack operation = on?
 15471                                  		; 10/12/2022
 15472                                  		; 19/10/2022
 15473 00001172 F606[A004]80            		test	byte [multrk_flag], 80h
 15474                                  		;test	word [multrk_flag], 80h ; MULTI_TRK_ON
 15475                                  		;;test	ds:multrk_flag,	80h ; MULTI_TRK_ON
 15476 00001177 7405                    		jz	short NormVerifyTrack
 15477 00001179 C606[A704]01            		mov	byte [multitrk_format_flag], 1
 15478                                  NormVerifyTrack:
 15479 0000117E 31C0                    		xor	ax, ax		; 1st sector
 15480 00001180 31DB                    		xor	bx, bx
 15481 00001182 891E[A804]              		mov	[xfer_seg], bx	; Use 0:0 as the transfer address for verify
 15482 00001186 E83F00                  		call	TrackIo
 15483 00001189 C606[A704]00            		mov	byte [multitrk_format_flag], 0
 15484 0000118E C3                      		retn
 15485                                  ; ---------------------------------------------------------------------------
 15486                                  
 15487                                  VerifyTrack_Err:
 15488 0000118F B401                    		mov	ah, 1
 15489 00001191 E916FC                  		jmp	maperror
 15490                                  ; ---------------------------------------------------------------------------
 15491                                  
 15492                                  ; 16/10/2022
 15493                                  
 15494                                  ; ==========================================================================
 15495                                  ;
 15496                                  ; ReadTrack:
 15497                                  ;
 15498                                  ; input: ES:di points to bds for drive
 15499                                  ;
 15500                                  ; ==========================================================================
 15501                                  
 15502                                  ReadTrack:
 15503 00001194 C606[2001]02            		mov	byte [rflag], 2	; romread
 15504 00001199 EB05                    		jmp	short ReadWriteTrack
 15505                                  ; ---------------------------------------------------------------------------
 15506                                  
 15507                                  WriteTrack:
 15508                                  
 15509                                  ; ==========================================================================
 15510                                  ;
 15511                                  ; WriteTrack:
 15512                                  ;
 15513                                  ; input: ES:di points to bds for drive
 15514                                  ;
 15515                                  ; ==========================================================================
 15516                                  				
 15517 0000119B C606[2001]03            		mov	byte [rflag], 3	; romwrite
 15518                                  
 15519                                  		; Fall into ReadWriteTrack
 15520                                  
 15521                                  ; ==========================================================================
 15522                                  ;
 15523                                  ; readWriteTrack:
 15524                                  ;
 15525                                  ; input:
 15526                                  ;    ES:di points to bds for drive
 15527                                  ;    rFlag - 2 for read,3 for write
 15528                                  ;
 15529                                  ; ==========================================================================
 15530                                  
 15531                                  ReadWriteTrack:	
 15532                                  		; save bds pointer segment so we can use it to access
 15533                                  		; our packet. Notice that this is not the standard register
 15534                                  		; assignment for accessing packets
 15535                                  		
 15536                                  		; 19/10/2022
 15537 000011A0 06                      		push	es
 15538 000011A1 C41E[1200]              		les	bx, [ptrsav]	; ES:BX	-> to request header
 15539 000011A5 26C45F13                		les	bx, [es:bx+19]	; [es:bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 15540 000011A9 268B4703                		mov	ax, [es:bx+3]	; [es:bx+A_TRACKREADWRITEPACKET.TRWP_CYLINDER]
 15541 000011AD A3[3301]                		mov	[curtrk], ax
 15542 000011B0 268B4701                		mov	ax, [es:bx+1]	; [es:bx+A_TRACKREADWRITEPACKET.TRWP_HEAD]
 15543 000011B4 A2[3201]                		mov	[curhd], al	; Assume heads < 256!!!
 15544 000011B7 268B4705                		mov	ax, [es:bx+5]	; [es:bx+A_TRACKREADWRITEPACKET.TRWP_FIRSTSECTOR]
 15545 000011BB 268B4F07                		mov	cx, [es:bx+7]	; [es:bx+A_TRACKREADWRITEPACKET.TRWP_SECTORSTOREADWRITE]
 15546 000011BF 26C45F09                		les	bx, [es:bx+9]	; [es:bx+A_TRACKREADWRITEPACKET.TRWP_TRANSFERADDRESS]
 15547                                  					; Get transfer address
 15548                                  
 15549                                  		; we just trashed our packet address, but we no longer care
 15550                                  
 15551 000011C3 8C06[A804]              		mov	[xfer_seg], es	; Pass transfer	segment
 15552 000011C7 07                      		pop	es
 15553                                  
 15554                                  		; Fall into TrackIo
 15555                                  
 15556                                  ; =============== S U B	R O U T	I N E =======================================
 15557                                  
 15558                                  ; 16/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 15559                                  
 15560                                  ; ==========================================================================
 15561                                  ;
 15562                                  ; TrackIo:
 15563                                  ;    performs track read/write/verify
 15564                                  ;
 15565                                  ;   input:
 15566                                  ;      rFlag	- 2 = read
 15567                                  ;		  3 = write
 15568                                  ;		  4 = verify
 15569                                  ;      AX	- Index into track table of first sector to io
 15570                                  ;      CX	- Number of sectors to io
 15571                                  ;      Xfer_Seg:BX - Transfer address
 15572                                  ;      ES:DI	- Pointer to bds
 15573                                  ;      CurTrk	- Current cylinder
 15574                                  ;      CurHd	- Current head
 15575                                  ;
 15576                                  ; ==========================================================================
 15577                                  
 15578                                  ; 16/03/2019 - Retro DOS v4.0
 15579                                  
 15580                                  		; 24/12/2023 - Retro DOS 5.0		
 15581                                  
 15582                                  		; 19/10/2022
 15583                                  TrackIo:
 15584                                  					; Procedure `disk' will pop stack to
 15585 000011C8 8926[3501]              		mov	[spsav], sp	; SpSav	and return if error
 15586 000011CC E8AAF7                  		call	checksingle	; Ensure correct disk is in drv
 15587 000011CF 803E[A905]01            		cmp	byte [media_set_for_format], 1
 15588                                  					; See if we have already set	disk
 15589 000011D4 7407                    		jz	short Dptalreadyset ; base table
 15590 000011D6 50                      		push	ax		; set up tables	and variables for i/o
 15591 000011D7 51                      		push	cx
 15592 000011D8 E8A1F9                  		call	iosetup
 15593 000011DB 59                      		pop	cx
 15594 000011DC 58                      		pop	ax
 15595                                  Dptalreadyset:				; Point si at the table entry of the			
 15596 000011DD BE[AC04]                		mov	si, tracktable	; first sector to be io'd
 15597                                  		; 24/12/2023
 15598                                  		;add	ax, ax		; PCDOS 7.1 IBMBIO.COM
 15599                                  		;add	ax, ax
 15600 000011E0 D1E0                    		shl	ax, 1
 15601 000011E2 D1E0                    		shl	ax, 1
 15602 000011E4 01C6                    		add	si, ax
 15603                                  
 15604                                  		; WE WANT:
 15605                                  		; CX to	be the number of times we have to loop
 15606                                  		; DX to	be the number of sectors we read on each iteration
 15607                                  		
 15608 000011E6 BA0100                  		mov	dx, 1
 15609                                  
 15610                                  		; 24/12/2023
 15611 000011E9 26F6453F08              		test	byte [es:di+3Fh], 8 ; PCDOS 7.1 IBMBIO.COM
 15612                                  		; 12/12/2022
 15613                                  		;test	byte [es:di+23h], 8
 15614                                  		;;test	word [es:di+35], 8 ; [es:di+BDS.flags]
 15615                                  					; good_tracklayout
 15616 000011EE 7402                    		jz	short ionextsector
 15617                                  		
 15618 000011F0 87D1                    		xchg	dx, cx		; HEY! We can read all secs in one blow
 15619                                  ionextsector:
 15620 000011F2 51                      		push	cx
 15621 000011F3 52                      		push	dx
 15622 000011F4 46                      		inc	si
 15623 000011F5 46                      		inc	si		; Skip over the	cylinder and head in
 15624                                  					; the track table
 15625 000011F6 AC                      		lodsb			; Get sector ID	from track table
 15626 000011F7 A2[3101]                		mov	[cursec], al
 15627                                  
 15628                                  		; assumptions for a fixed disk multi-track disk	i/o
 15629                                  		; 1). In the input CX (# of sectors to go) to TrackIo,
 15630                                  		;     only CL is valid.
 15631                                  		; 2). Sector size should be set	to 512 bytes.
 15632                                  		; 3). Good track layout
 15633                                  		
 15634                                  		; 24/12/2023
 15635 000011FA 26F6453F01              		test	byte [es:di+3Fh], 1 ; PCDOS 7.1 IBMBIO.COM
 15636                                  		; 12/12/2022
 15637                                  		;test	byte [es:di+23h], 1
 15638                                  		;;test	word [es:di+35], 1 ; [es:di+BDS.flags]
 15639                                  					; fnon_removable ; Fixed disk?
 15640 000011FF 7414                    		jz	short IoRemovable ; No
 15641                                  
 15642                                  		; 12/12/2022
 15643 00001201 F606[A004]80            		test	byte [multrk_flag], 80h
 15644                                  		;test	word [multrk_flag], 80h ; MULTI_TRK_ON
 15645                                  						; Allow multi-track operation?
 15646 00001206 740D                    		jz	short IoRemovable ; No,don't do that.
 15647 00001208 8916[2201]              		mov	[seccnt], dx
 15648 0000120C 89D0                    		mov	ax, dx
 15649 0000120E E826FA                  		call	Disk
 15650 00001211 5A                      		pop	dx
 15651 00001212 59                      		pop	cx
 15652 00001213 F8                      		clc
 15653 00001214 C3                      		retn
 15654                                  ; ---------------------------------------------------------------------------
 15655                                  
 15656                                  IoRemovable:
 15657 00001215 AC                      		lodsb			; Get sector size index	from track
 15658                                  					; table	and save it
 15659 00001216 50                      		push	ax
 15660 00001217 56                      		push	si
 15661 00001218 1E                      		push	ds		; Save Bios_Data
 15662 00001219 50                      		push	ax
 15663 0000121A 8A26[2C01]              		mov	ah, [eot]	; Preserve whatever might be in	ah
 15664                                  					; Fetch	EOT while ds-> Bios_Data
 15665 0000121E C536[2D01]              		lds	si, [dpt]
 15666 00001222 884403                  		mov	[si+3],	al	; [si+DISK_PARMS.DISK_SECTOR_SIZ]
 15667 00001225 886404                  		mov	[si+4],	ah	; [si+DISK_PARMS.DISK_EOT]
 15668 00001228 58                      		pop	ax
 15669 00001229 1F                      		pop	ds
 15670 0000122A 88D0                    		mov	al, dl
 15671 0000122C A3[2201]                		mov	[seccnt], ax
 15672 0000122F E805FA                  		call	Disk
 15673 00001232 5E                      		pop	si		; Advance buffer pointer by adding
 15674                                  					; sector size
 15675                                  		;pop	ax
 15676                                  		; 24/12/2023
 15677 00001233 59                      		pop	cx
 15678                                  
 15679                                  		; 02/09/2023 (PCDOS 7.1)
 15680                                  		;call	SectorSizeIndexToSectorSize
 15681                                  		;mov	cl, al	; 24/12/2023
 15682 00001234 B88000                  		mov	ax, 128
 15683 00001237 D3E0                    		shl	ax, cl
 15684                                  
 15685 00001239 01C3                    		add	bx, ax
 15686 0000123B 5A                      		pop	dx
 15687 0000123C 59                      		pop	cx
 15688 0000123D E2B3                    		loop	ionextsector
 15689 0000123F 803E[A905]01            		cmp	byte [media_set_for_format], 1
 15690                                  		;jz	short NoNeedDone
 15691                                  		; 12/12/2022
 15692 00001244 7404                    		je	short NoNeedDone2
 15693 00001246 E87AF9                  		call	done		; set time of last access, and reset
 15694                                  					; entries in Dpt.
 15695                                  NoNeedDone:
 15696 00001249 F8                      		clc	; not necessary ('done' clears cf) ; 24/12/2023
 15697                                  NoNeedDone2:
 15698 0000124A C3                      		retn
 15699                                  
 15700                                  ; =============== S U B	R O U T	I N E =======================================
 15701                                  
 15702                                  ; ---------------------------------------------------------------------------
 15703                                  ;
 15704                                  ; The sector size in bytes needs to be converted to an index value for the ibm
 15705                                  ; rom. (0=>128,1=>256,2=>512,3=>1024). It is assumed that only these values
 15706                                  ; are permissible.
 15707                                  ;
 15708                                  ; On Input   AX contains sector size in bytes
 15709                                  ; On Output  AL Contains index
 15710                                  ; All other registers preserved
 15711                                  ;
 15712                                  ; ---------------------------------------------------------------------------
 15713                                  
 15714                                  ; 02/09/2023
 15715                                  ;SectSizeToSectIndex:
 15716                                  ;		cmp	ah, 2		; (0=>128,1=>256,2=>512,3=>1024)
 15717                                  ;					; examine upper	byte only
 15718                                  ;		ja	short OneK
 15719                                  ;		mov	al, ah		; value	in AH is the index!
 15720                                  ;		retn
 15721                                  
 15722                                  ; ---------------------------------------------------------------------------
 15723                                  ;
 15724                                  ;OneK:
 15725                                  ;		mov	al, 3
 15726                                  ;		retn
 15727                                  
 15728                                  ; =============== S U B	R O U T	I N E =======================================
 15729                                  
 15730                                  ; 02/09/2023
 15731                                  ;SectorSizeIndexToSectorSize:
 15732                                  ;		mov	cl, al
 15733                                  ;		mov	ax, 128
 15734                                  ;		shl	ax, cl
 15735                                  ;		retn
 15736                                  
 15737                                  ; =============== S U B	R O U T	I N E =======================================
 15738                                  
 15739                                  ; 16/10/2022
 15740                                  
 15741                                  ; ---------------------------------------------------------------------------
 15742                                  ;
 15743                                  ; SetDASD
 15744                                  ;
 15745                                  ; Set up the rom for formatting.
 15746                                  ; we have to tell the rom bios what type of disk is in the drive.
 15747                                  ;
 15748                                  ; On Input   - ES:di - Points to bds
 15749                                  ;
 15750                                  ; ---------------------------------------------------------------------------
 15751                                  
 15752                                  		; 24/12/2023 - Retro DOS 5.0
 15753                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:129Bh)
 15754                                  
 15755                                  		; 19/10/2022
 15756                                  SetDasd:
 15757 0000124B 803E[AA05]01            		cmp	byte [had_format_error], 1 ;
 15758                                  					; See if we've previously set dasd type
 15759 00001250 740C                    		jz	short DoSetDasd
 15760                                  		; 24/12/2023
 15761 00001252 26F6453F80              		test	byte [es:di+3Fh], 80h
 15762                                  		; 10/12/2022
 15763                                  		;test	byte [es:di+23h], 80h
 15764                                  		;;test	word [es:di+23h], 80h ; [es:di+BDS.flags]
 15765                                  					; set_dasd_true
 15766 00001257 7446                    		jz	short DasdHasBeenSet
 15767                                  		; 24/12/2023
 15768 00001259 2680653F7F              		and	byte [es:di+3Fh], 7Fh
 15769                                  		; 10/12/2022
 15770                                  		;and	byte [es:di+23h], 7Fh
 15771                                  		;;and	word [es:di+23h], 0FF7Fh ; [es:di+BDS.flags]
 15772                                  					; ~set_dasd_true
 15773                                  DoSetDasd:
 15774 0000125E C606[AA05]00            		mov	byte [had_format_error], 0 ; Reset it
 15775 00001263 C606[3B01]50            		mov	byte [gap_patch], 50h ; Format gap for 48tpi disks
 15776 00001268 B004                    		mov	al, 4
 15777                                  		; 24/12/2023
 15778 0000126A 268A653E                		mov	ah, [es:di+3Eh]
 15779                                  		; 02/09/2023
 15780                                  		;mov	ah, [es:di+22h] ; [es:di+BDS.formfactor]
 15781 0000126E 80FC02                  		cmp	ah, 2
 15782                                  		;cmp	byte [es:di+22h], 2 ; [es:di+BDS.formfactor]
 15783                                  					; DEV_3INCH720KB
 15784 00001271 7414                    		jz	short DoSet
 15785                                  		; 24/12/2023
 15786 00001273 B001                    		mov	al, 1
 15787                                  		;cmp	ah, 1
 15788 00001275 38C4                    		cmp	ah, al	; 1
 15789                                  		;cmp	byte [es:di+22h], 1 ; [es:di+BDS.formfactor]
 15790                                  					; DEV_5INCH96TPI
 15791                                  		;jz	short GotBig
 15792                                  		; 24/12/2023
 15793                                  		;mov	al, 1
 15794                                  		;jmp	short DoSet
 15795                                  		; 02/09/2023
 15796 00001277 750E                    		jnz	short DoSet
 15797                                  GotBig:
 15798                                  		;mov	al, 2		; 160/320k in a	1.2 meg	drive
 15799                                  		; 02/09/2023
 15800 00001279 40                      		inc	ax  ; mov al, 2
 15801 0000127A 803E[A805]00            		cmp	byte [mediatype], 0
 15802 0000127F 7506                    		jnz	short DoSet
 15803                                  		;mov	al, 3		; 1.2meg in a 1.2meg drive
 15804                                  		; 10/12/2022
 15805                                  		;inc	al  ; al = 3
 15806                                  		; 18/12/2022
 15807 00001281 40                      		inc	ax  ; al = 3
 15808 00001282 C606[3B01]54            		mov	byte [gap_patch], 54h
 15809                                  DoSet:
 15810 00001287 1E                      		push	ds
 15811 00001288 56                      		push	si
 15812                                  
 15813                                  		;mov	ds, [zeroseg]	; Point	to interrupt vectors
 15814                                  		; 02/09/2023
 15815 00001289 31F6                    		xor	si, si
 15816 0000128B 8EDE                    		mov	ds, si	; 0
 15817                                  
 15818 0000128D C5367800                		lds	si, [DSKADR]
 15819                                  		;lds	si, [78h]	; [DSKADR]  (Int 1Eh)
 15820                                  		;;lds	si, ds:78h
 15821                                  
 15822 00001291 C644090F                		mov	byte [si+9], 0Fh ;
 15823                                  					; [si+DISK_PARMS.DISK_HEAD_STTL]
 15824 00001295 5E                      		pop	si
 15825 00001296 1F                      		pop	ds
 15826 00001297 B417                    		mov	ah, 17h
 15827 00001299 268A5504                		mov	dl, [es:di+4]
 15828 0000129D CD13                    		int	13h		; DISK - DISK -	SET TYPE (AT,XT2,XT286,CONV,PS
 15829                                  					; AL = disk type AL = 03h - high-capacity disk in high-capacity	drive
 15830                                  DasdHasBeenSet:
 15831 0000129F 268A6513                		mov	ah, [es:di+13h]	; [es:di+BDS.secpertrack]
 15832 000012A3 8826[3701]              		mov	[formt_eot], ah
 15833 000012A7 C3                      		retn
 15834                                  
 15835                                  ; =============== S U B	R O U T	I N E =======================================
 15836                                  
 15837                                  ; =============== S U B	R O U T	I N E =======================================
 15838                                  
 15839                                  ; 16/10/2022
 15840                                  
 15841                                  ; ---------------------------------------------------------------------------
 15842                                  ;
 15843                                  ; Set Media Type for Format
 15844                                  ; Performs the int 13 with ah = 18h to see if the medium described in the
 15845                                  ; BPB area in the BDS can be handled by the rom.
 15846                                  ; On Input, ES:DI -> current BDS.
 15847                                  ; The status of the operation is returned in AL
 15848                                  ;
 15849                                  ;	- 0 - if the support is available,and the combination is valid.
 15850                                  ;	- 1 - no rom support
 15851                                  ;	- 2 - illegal combination
 15852                                  ;	- 3 - no media present (rom support exists but cannot determine now)
 15853                                  ;
 15854                                  ; Flags also may be altered. All other registers preserved.
 15855                                  ; If the call to rom returns no error,then the current Dpt is "replaced" by
 15856                                  ; the one returned by the rom. This is Done by changing the pointer in [Dpt]
 15857                                  ; to the one returned. the original pointer to the disk base table is stored
 15858                                  ; in TempDpt, until it is restored.
 15859                                  ;
 15860                                  ; ---------------------------------------------------------------------------
 15861                                  
 15862                                  		; 24/12/2023 - Retro DOS 5.0
 15863                                  
 15864                                  		; 19/10/2022
 15865                                  SetMediaForFormat:	
 15866 000012A8 51                      		push	cx
 15867 000012A9 52                      		push	dx
 15868                                  
 15869                                  		; If we have a format error, then do not change Dpt, TempDpt.
 15870                                  		; but we need to call int 13h, ah=18h again.
 15871                                  
 15872 000012AA 803E[AA05]01            		cmp	byte [had_format_error], 1
 15873 000012AF 7425                    		jz	short SkipSaveDskAdr
 15874 000012B1 30C0                    		xor	al, al		; If already done return 0
 15875 000012B3 803E[A905]01            		cmp	byte [media_set_for_format], 1
 15876 000012B8 7502                    		jnz	short DoSetMediaForFormat
 15877 000012BA EB7D                    		jmp	SetMediaRet	; Media	already	set
 15878                                  ; ---------------------------------------------------------------------------
 15879                                  
 15880                                  DoSetMediaForFormat:
 15881 000012BC 06                      		push	es
 15882 000012BD 56                      		push	si
 15883                                  
 15884                                  		; 02/09/2023
 15885                                  		;mov	es, [zeroseg]	; Point to interrupt vectors
 15886 000012BE 31F6                    		xor	si, si ; 0
 15887 000012C0 8EC6                    		mov	es, si
 15888                                  
 15889 000012C2 26C4367800              		les	si, [es:DSKADR]
 15890                                  		;les	si, es:78h	; [es:DSKADR]
 15891                                  					; Get pointer to disk base table
 15892 000012C7 8936[2D01]              		mov	[dpt], si
 15893 000012CB 8C06[2F01]              		mov	[dpt+2], es	; Save pointer to table
 15894                                  
 15895                                  		; Initialize the head settle time to 0Fh. See the offsets
 15896                                  		; given in dskprm.inc.
 15897                                  
 15898 000012CF 26C644090F              		mov	byte [es:si+9], 0Fh ; [es:si+DISK_PARMS.DISK_HEAD_STTL]
 15899 000012D4 5E                      		pop	si
 15900 000012D5 07                      		pop	es
 15901                                  SkipSaveDskAdr:
 15902                                  		; 24/12/2023
 15903 000012D6 268B4D41                		mov	cx, [es:di+41h]	; (PCDOS 7.1 IBMBIO.COM)
 15904                                  		;mov	cx, [es:di+25h]	; [es:di+BDS.cylinders]
 15905 000012DA 49                      		dec	cx
 15906 000012DB 80E503                  		and	ch, 3
 15907 000012DE D0CD                    		ror	ch, 1
 15908 000012E0 D0CD                    		ror	ch, 1
 15909 000012E2 86E9                    		xchg	ch, cl
 15910 000012E4 260A4D13                		or	cl, [es:di+13h]	; [es:di+BDS.secpertrack]
 15911 000012E8 268A5504                		mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 15912 000012EC 06                      		push	es
 15913 000012ED 1E                      		push	ds
 15914 000012EE 56                      		push	si
 15915 000012EF 57                      		push	di
 15916 000012F0 B418                    		mov	ah, 18h
 15917 000012F2 CD13                    		int	13h		; DISK - SET MEDIA TYPE	FOR FORMAT (AT model 3x9,XT2,XT286,PS)
 15918                                  					; DL = drive number, CH	= lower	8 bits of number of tracks, CL = sectors per track
 15919 000012F4 7231                    		jc	short FormaStatErr
 15920 000012F6 803E[AA05]01            		cmp	byte [had_format_error], 1
 15921 000012FB 7423                    		jz	short skip_disk_base_setting
 15922 000012FD 06                      		push	es		; Save segment returned	by the rom
 15923                                  
 15924                                  		; 02/09/2023
 15925                                  		;mov	es, [zeroseg]	; Point	to interrupt vector segment
 15926 000012FE 31F6                    		xor	si, si
 15927 00001300 8EC6                    		mov	es, si ; 0
 15928 00001302 06                      		push	es ; * ; 02/09/2023
 15929                                  
 15930 00001303 26C4367800              		les	si, [es:DSKADR]
 15931                                  		;les	si, es:78h	; [es:DSKADR] (Int 1Eh)
 15932                                  					; Get current disk base	table
 15933 00001308 8936[AB05]              		mov	[tempdpt], si
 15934 0000130C 8C06[AD05]              		mov	[tempdpt+2], es ; Save it
 15935                                  
 15936                                  		; 02/09/2023
 15937                                  		;;mov	es, [zeroseg]
 15938                                  		;xor	si, si ; 0
 15939                                  		;mov	es, si
 15940 00001310 07                      		pop	es ; * ; 02/09/2023
 15941                                  
 15942                                  		;mov	es:78h,	di
 15943 00001311 26893E7800              		mov	[es:DSKADR], di
 15944                                  		;pop	word ptr es:7Ah	; replace with one returned by rom
 15945 00001316 268F067A00              		pop	word [es:DSKADR+2]
 15946 0000131B C606[A905]01            		mov	byte [media_set_for_format], 1
 15947                                  skip_disk_base_setting:
 15948 00001320 30C0                    		xor	al, al		; Legal	combination + rom support code
 15949                                  		;mov	ds:had_format_error, al	; Reset	the flag
 15950 00001322 A2[AA05]                		mov	[had_format_error], al
 15951 00001325 EB0E                    		jmp	short PopStatRet
 15952                                  ; ---------------------------------------------------------------------------
 15953                                  
 15954                                  FormaStatErr:
 15955                                  		; 10/12/2022
 15956 00001327 B003                    		mov	al, 3
 15957                                  
 15958 00001329 80FC0C                  		cmp	ah, 0Ch		; DSK_ILLEGAL_COMBINATION
 15959                                  					; Illegal combination =	0Ch
 15960 0000132C 7406                    		jz	short FormatStatIllegalComb
 15961 0000132E 80FC80                  		cmp	ah, 80h		; DSK_TIMEOUT_ERR
 15962 00001331 7402                    		jz	short FormatStatTimeOut
 15963                                  		; 10/12/2022
 15964                                  		;dec	al
 15965                                  		; 18/12/2022
 15966 00001333 48                      		dec	ax
 15967                                  		; al = 2
 15968                                  		;mov	al, 1		; Function not supported.
 15969                                  		;jmp	short PopStatRet
 15970                                  ; ---------------------------------------------------------------------------
 15971                                  
 15972                                  FormatStatIllegalComb:
 15973                                  		; 10/12/2022
 15974                                  		;dec	al	; 3 -> 2 or 2 -> 1
 15975                                  		; 18/12/2022
 15976 00001334 48                      		dec	ax
 15977                                  		; al = 2
 15978                                  		;mov	al, 2		; Function supported, but
 15979                                  					; Illegal sect/trk,trk combination.
 15980                                  		; 10/12/2022
 15981                                  		;jmp	short PopStatRet
 15982                                  ; ---------------------------------------------------------------------------
 15983                                  
 15984                                  FormatStatTimeOut:
 15985                                  		; 10/12/2022
 15986                                  		; al = 3
 15987                                  		;mov	al, 3		; Function supported, but
 15988                                  					; Media	not present.
 15989                                  PopStatRet:
 15990 00001335 5F                      		pop	di
 15991 00001336 5E                      		pop	si
 15992 00001337 1F                      		pop	ds
 15993 00001338 07                      		pop	es
 15994                                  SetMediaRet:
 15995 00001339 5A                      		pop	dx
 15996 0000133A 59                      		pop	cx
 15997 0000133B C3                      		retn
 15998                                  
 15999                                  ; =============== S U B	R O U T	I N E =======================================
 16000                                  
 16001                                  ; 16/10/2022
 16002                                  
 16003                                  ; ---------------------------------------------------------------------------
 16004                                  ;
 16005                                  ; RESET THE DRIVE
 16006                                  ;
 16007                                  ; we also set [Step_Drv] to -1 to force the main disk routine to use the
 16008                                  ; slow head settle time for the next operation. this is because the reset
 16009                                  ; operation moves the head to cylinder 0,so we need to do a seek the next
 16010                                  ; time around - there is a problem with 3.5" drives in that the head does
 16011                                  ; not settle down in time,even for read operations!!
 16012                                  ;
 16013                                  ; ---------------------------------------------------------------------------
 16014                                  
 16015                                  ResetDisk:
 16016 0000133C 50                      		push	ax
 16017                                  
 16018                                  		; 02/09/2023
 16019 0000133D B80100                  		mov	ax, 1 ; PCDOS 7.1
 16020 00001340 3806[A905]              		cmp	[media_set_for_format], al ; 1
 16021                                  		;cmp	byte [media_set_for_format], 1
 16022                                  					; Reset while formatting?
 16023 00001344 7503                    		jnz	short ResetDisk_cont
 16024                                  					; Then verify operation in "fmt & vrfy"
 16025                                  		;mov	byte [had_format_error], 1 ; Might have failed.
 16026 00001346 A2[AA05]                		mov	[had_format_error], al ; 1
 16027                                  ResetDisk_cont:
 16028                                  		; 02/09/2023 (ah=0)
 16029                                  		;xor	ah, ah		; So signals that we had a format error
 16030 00001349 CD13                    		int	13h		; DISK - RESET DISK SYSTEM
 16031                                  					; DL = drive (if bit 7 is set both hard	disks and floppy disks reset)
 16032 0000134B C606[7600]FF            		mov	byte [step_drv], 0FFh ; -1
 16033                                  					; Zap up the speed
 16034 00001350 58                      		pop	ax
 16035 00001351 C3                      		retn
 16036                                  
 16037                                  ; =============== S U B	R O U T	I N E =======================================
 16038                                  
 16039                                  ; 16/10/2022
 16040                                  
 16041                                  ; ---------------------------------------------------------------------------
 16042                                  ;
 16043                                  ; This routine sets up the drive parameter table with the values needed for
 16044                                  ; format,does an int 13. values in Dpt are restored after a verify is done.
 16045                                  ;
 16046                                  ; on entry  -	ES:DI - points to bds for the drive
 16047                                  ;		Xfer_Seg:BX - points to trkbuf
 16048                                  ;		AL    - number of sectors
 16049                                  ;		AH    - int 13 function code
 16050                                  ;		CL    - sector number for verify
 16051                                  ;		DS    - Bios_Data
 16052                                  ;
 16053                                  ; ON EXIT   -	DS,DI,ES,BX remain unchanged.
 16054                                  ;		AX and flags are the results of the int 13
 16055                                  ;
 16056                                  ; ---------------------------------------------------------------------------
 16057                                  
 16058                                  		; 24/12/2023 - Retro DOS 5.0
 16059                                  
 16060                                  		; 19/10/2022
 16061                                  ToRom:
 16062 00001352 53                      		push	bx
 16063 00001353 56                      		push	si
 16064                                  
 16065                                  		; Compaq bug fix - check whether we are using new ROM
 16066                                  		; functionality to set up format, not merely if it exists.
 16067                                  		; This was formerly a check against [new_rom]
 16068                                  
 16069 00001354 F606[A905]01            		test	byte [media_set_for_format], 1
 16070 00001359 7534                    		jnz	short GotValidDpt
 16071 0000135B 50                      		push	ax
 16072 0000135C 06                      		push	es		; Save bds segment
 16073                                  		; 24/12/2023
 16074 0000135D 26807D3E02              		cmp	byte [es:di+3Eh], 2
 16075                                  		;cmp	byte [es:di+22h], 2 ; [es:di+BDS.formfactor]
 16076                                  					; ffSmall ; is it a 3.5" drive?
 16077                                  		; 24/12/2023
 16078                                  		;pushf	; not necessary	; (Save	the cmp	result)
 16079 00001362 8E06[1A00]              		mov	es, [zeroseg]
 16080                                  		;les	si, es:78h	; Get pointer to disk base table
 16081 00001366 26C4367800              		les	si, [es:DSKADR]
 16082                                  		;mov	word ptr ds:dpt, si
 16083                                  		;mov	word ptr ds:dpt+2, es ;	 Save pointer to table
 16084 0000136B 8936[2D01]              		mov	[dpt], si
 16085 0000136F 8C06[2F01]              		mov	[dpt+2], es	; Save pointer to table
 16086                                  		
 16087 00001373 A0[3701]                		mov	al, [formt_eot]
 16088 00001376 26884404                		mov	[es:si+4], al	; [es:si+DISK_PARMS.DISK_EOT]
 16089 0000137A A0[3B01]                		mov	al, [gap_patch]
 16090 0000137D 26884407                		mov	[es:si+7], al	; [es:si+DISK_PARMS.DISK_FORMT_GAP]
 16091                                  					; Important for	format
 16092 00001381 26C644090F              		mov	byte [es:si+9], 0Fh ; [es:si+DISK_PARMS.DISK_HEAD_STTL]
 16093                                  					; Assume we are	doing a	seek operation
 16094                                  					; Setup	motor start correctly for 3.5" drives
 16095                                  		; 24/12/2023
 16096                                  		;popf			; Get result of	earlier	cmp
 16097 00001386 7505                    		jnz	short MotorStrtOK
 16098 00001388 26C6440A04              		mov	byte [es:si+0Ah], 4 ; [es:si+DISK_PARMS.DISK_MOTOR_STRT]
 16099                                  MotorStrtOK:
 16100 0000138D 07                      		pop	es		; Restore bds segment
 16101 0000138E 58                      		pop	ax
 16102                                  GotValidDpt:
 16103 0000138F 8B16[3901]              		mov	dx, [trknum]	; Set track number
 16104 00001393 88D5                    		mov	ch, dl		; Set low 8 bits in ch
 16105 00001395 268A5504                		mov	dl, [es:di+4]	; Set drive number
 16106 00001399 8A36[3801]              		mov	dh, [hdnum]	; Set head number
 16107 0000139D 06                      		push	es		; Save bds segment
 16108 0000139E 8E06[A804]              		mov	es, [xfer_seg]
 16109 000013A2 CD13                    		int	13h		; DISK -
 16110 000013A4 07                      		pop	es		; Restore bds segment
 16111 000013A5 5E                      		pop	si
 16112 000013A6 5B                      		pop	bx
 16113 000013A7 C3                      		retn
 16114                                  
 16115                                  ; ---------------------------------------------------------------------------
 16116                                  
 16117                                  ; 16/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 16118                                  ; 24/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
 16119                                  
 16120                                  ; BIOSCODE:1124h (MSDOS 6.21, IO.SYS)
 16121                                  ; PCDOS 7.1 IBMBIO.COM - BIOSCODE:1404h
 16122                                  
 16123                                  ; ==========================================================================
 16124                                  ;
 16125                                  ; get the owner of the physical drive represented by the logical drive in al.
 16126                                  ; the assumption is that we **always** keep track of the owner of a drive!!
 16127                                  ; if this is not the case, the system may hang, just following the linked list.
 16128                                  ;
 16129                                  ; ==========================================================================
 16130                                  
 16131                                  		; 24/12/2023 - Retro DOS 5.0
 16132                                  
 16133                                  		; 19/10/2022
 16134                                  ioctl_getown:
 16135 000013A8 E8F9F1                  		call	SetDrive
 16136 000013AB 268A4504                		mov	al, [es:di+4]	; [es:di+BDS.drivenum]
 16137                                  					; Get physical drive number
 16138 000013AF C43E[1901]              		les	di, [start_bds] ; Get start of bds chain
 16139                                  ownloop:
 16140 000013B3 26384504                		cmp	[es:di+4], al	; [es:di+BDS.drivenum]
 16141 000013B7 7507                    		jnz	short getnextBDS
 16142                                  		; 24/12/2023
 16143 000013B9 26F6453F20              		test	byte [es:di+3Fh], 20h ; (PCDOS 7.1 IBMBIO.COM)
 16144                                  		; 10/12/2022
 16145                                  		;test	byte [es:di+23h], 20h
 16146                                  		;;test	word [es:di+23h], 20h ; [es:di+BDS.flags]
 16147                                  					; fi_own_physical
 16148 000013BE 7514                    		jnz	short exitown
 16149                                  getnextBDS:
 16150 000013C0 26C43D                  		les	di, [es:di]	; [es:di+BDS.link]
 16151 000013C3 EBEE                    		jmp	short ownloop
 16152                                  ; ---------------------------------------------------------------------------
 16153                                  
 16154                                  ; ==========================================================================
 16155                                  ;
 16156                                  ; set the ownership of the physical drive represented by the logical drive
 16157                                  ; in al to al.
 16158                                  ;
 16159                                  ; ==========================================================================
 16160                                  
 16161                                  		; 24/12/2023 - Retro DOS 5.0
 16162                                  
 16163                                  		; 19/10/2022
 16164                                  ioctl_setown:
 16165 000013C5 E8DCF1                  		call	SetDrive
 16166 000013C8 C606[7A00]01            		mov	byte [fsetowner], 1
 16167                                  					; set flag for CheckSingle to look at.
 16168 000013CD E8A9F5                  		call	checksingle
 16169                                  		; 02/09/2023
 16170 000013D0 FE0E[7A00]              		dec	byte [fsetowner] ; 0
 16171                                  		;mov	byte [fsetowner], 0
 16172                                  					; set ownership	of drive reset flag
 16173                                  		; Fall into ExitOwn
 16174                                  
 16175                                  ; ==========================================================================
 16176                                  ;
 16177                                  ; if there is only one logical drive assigned to this physical drive, return
 16178                                  ; 0 to user to indicate this. Enter with ES:di -> the owner's bds.
 16179                                  ;
 16180                                  ; ==========================================================================
 16181                                  
 16182                                  		; 24/12/2023 - Retro DOS 5.0
 16183                                  exitown:
 16184 000013D4 30C9                    		xor	cl, cl
 16185                                  		; 24/12/2023
 16186 000013D6 26F6453F10              		test	byte [es:di+3Fh], 10h ; (PCDOS 7.1 IBMBIO.COM)
 16187                                  		; 12/12/2022
 16188                                  		;test	byte [es:di+23h], 10h
 16189                                  		;;test	word [es:di+23h], 10h ; [es:di+BDS.flags]
 16190                                  					; fi_am_mult
 16191 000013DB 7406                    		jz	short exitnomult
 16192 000013DD 268A4D05                		mov	cl, [es:di+5]	; [es:di+BDS.drivelet]
 16193                                  					; Get logical drive number
 16194                                  					; Get it 1-based
 16195 000013E1 FEC1                    		inc	cl
 16196                                  exitnomult:
 16197 000013E3 C51E[1200]              		lds	bx, [ptrsav]
 16198 000013E7 884F01                  		mov	[bx+1],	cl	; [bx+unit]
 16199                                  					; Exit normal termination
 16200                                  		; 12/12/2022
 16201                                  		; cf=0
 16202                                  		;clc
 16203 000013EA C3                      		retn
 16204                                  
 16205                                  ; =============== S U B	R O U T	I N E =======================================
 16206                                  
 16207                                  ; 16/10/2022
 16208                                  
 16209                                  ; ---------------------------------------------------------------------------
 16210                                  ;
 16211                                  ; moves the old Dpt that had been saved in TempDpt back to Dpt. this is done
 16212                                  ; only if the first byte of TempDpt is not -1.
 16213                                  ; all registers (including flags) are preserved.
 16214                                  ;
 16215                                  ; ---------------------------------------------------------------------------
 16216                                  
 16217                                  		; 24/12/2023
 16218                                  		; 19/10/2022
 16219                                  RestoreOldDpt:
 16220                                  		; if we have already restored the disk base table earlier,
 16221                                  		; do not do it again.
 16222                                  
 16223 000013EB 50                      		push	ax
 16224 000013EC 30C0                    		xor	al, al
 16225 000013EE A2[AA05]                		mov	[had_format_error], al	; Reset flag and 
 16226 000013F1 8606[A905]              		xchg	al, [media_set_for_format] ; get current flag setting
 16227 000013F5 08C0                    		or	al, al
 16228 000013F7 7418                    		jz	short DontRestore
 16229 000013F9 56                      		push	si
 16230 000013FA 1E                      		push	ds
 16231 000013FB 06                      		push	es
 16232 000013FC C536[AB05]              		lds	si, [tempdpt]
 16233                                  
 16234                                  		; 17/10/2022
 16235                                  		;mov	es, [cs:BIOSDATAWORD]
 16236                                  		;;mov	es, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 16237                                  		;mov	es, [es:zeroseg]
 16238                                  		;;mov	es, es:zeroseg	; CAS -- bleeeech!
 16239                                  
 16240                                  		; 24/12/2023
 16241 00001400 31C0                    		xor	ax, ax
 16242 00001402 8EC0                    		mov	es, ax ; 0
 16243                                  
 16244                                  		;mov	es:78h,	si	; [es:DSKADR]  (Int 1Eh)
 16245 00001404 2689367800              		mov	[es:DSKADR], si
 16246                                  		;mov	word ptr es:7Ah, ds ; [es:DSKADR+2]
 16247 00001409 268C1E7A00              		mov	[es:DSKADR+2], ds
 16248 0000140E 07                      		pop	es
 16249 0000140F 1F                      		pop	ds
 16250 00001410 5E                      		pop	si
 16251                                  DontRestore:
 16252 00001411 58                      		pop	ax
 16253                                  		; 12/12/2022
 16254                                  		; cf=0
 16255                                  		;clc			;  Clear carry
 16256 00001412 C3                      		retn
 16257                                  
 16258                                  ; ---------------------------------------------------------------------------
 16259                                  
 16260                                  ; 16/10/2022
 16261                                  
 16262                                  ; ==========================================================================
 16263                                  ;	get media id
 16264                                  ; ==========================================================================
 16265                                  ;
 16266                                  ; FUNCTION: get the volume label,the system id and the serial number from
 16267                                  ;	    the media that has the extended boot record.
 16268                                  ;	    for the conventional media,this routine will return "unknown
 16269                                  ;	    media type" error to dos.
 16270                                  ;
 16271                                  ; INPUT :   ES:di -> bds table for this drive.
 16272                                  ;
 16273                                  ; OUTPUT:   the request packet filled with the information,if not carry.
 16274                                  ;	    if carry set,then al contains the device driver error number
 16275                                  ;	    that will be returned to dos.
 16276                                  ;	    register DS,DX,AX,CX,DI,SI destroyed.
 16277                                  ;
 16278                                  ; SUBROUTINES TO BE CALLED:
 16279                                  ;	BootIo:NEAR
 16280                                  ;
 16281                                  ; LOGIC:
 16282                                  ;	to recognize the extended boot record,this logic will actually
 16283                                  ;	access the boot sector even if it is a hard disk.
 16284                                  ;	note:the valid extended bpb is recognized by looking at the mediabyte
 16285                                  ;	field of bpb and the extended boot signature.
 16286                                  ;
 16287                                  ; {
 16288                                  ;	get logical drive number from bds table;
 16289                                  ;	rFlag = read operation;
 16290                                  ;	BootIo;		 /*get the media boot record into the buffer
 16291                                  ;	if (no error) then
 16292                                  ;	     if (extended boot record) then
 16293                                  ;		{ set volume label,volume serial number and system id
 16294                                  ;		  of the request packet to those of the boot record;
 16295                                  ;		};
 16296                                  ;	     else		  /*not an extended bpb */
 16297                                  ;		{ set register al to "unknown media.." error code;
 16298                                  ;		  set carry bit;
 16299                                  ;		};
 16300                                  ;	else
 16301                                  ;	     ret;	/*already error code is set in the register al
 16302                                  ;
 16303                                  ; ==========================================================================
 16304                                  
 16305                                  ;size_of_EXT_BOOT_SERIAL equ 4
 16306                                  ;;size_of_EXT_BOOT_VOL_LABEL equ 11
 16307                                  ;;size_of_EXT_SYSTEM_ID equ 8
 16308                                  
 16309                                  		; 24/12/2023 - Retro DOS 5.0
 16310                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:1478h)
 16311                                  
 16312                                  		; 19/10/2022
 16313                                  GetMediaId:
 16314 00001413 E8B000                  		call	ChangeLineChk
 16315 00001416 268A4505                		mov	al, [es:di+5]	; [es:di+BDS.drivelet] ; Logical drive number
 16316 0000141A C606[2001]02            		mov	byte [rflag], 2	; Read operation
 16317 0000141F E88C00                  		call	BootIo		; Read boot sector into	DiskSector
 16318 00001422 722E                    		jb	short IOCtl_If1
 16319                                  					; Valid? (0F0h-0FFh?)
 16320 00001424 803E[6701]F0            		cmp	byte [disksector+15h], 0F0h
 16321                                  					; [disksector+EXT_BOOT.BPB+EBPB.MEDIADESCRIPTOR]
 16322                                  		;jb	short IOCtl_If2	; brif not valid (0F0h - 0FFh)
 16323                                  		; 24/12/2023
 16324 00001429 7225                    		jb	short IOCtl_If7		
 16325                                  
 16326                                  		; 24/12/2023
 16327                                  		; 10/12/2022
 16328                                  		;mov	si, disksector+26h
 16329                                  		;;;
 16330                                  		; 24/12/2023
 16331                                  		;mov	si, disksector+43h ; BS_FAT32_VolID
 16332 0000142B BE[9401]                		mov	si, disksector+42h ; BS_FAT32_BootSig ; 24/12/2023
 16333 0000142E 833E[6801]00            		cmp	word [disksector+16h], 0 ; BPB.FATSz16
 16334 00001433 7403                    		jz	short IOCtl_If3 ; FAT32 fs
 16335 00001435 83EE1C                  		sub	si, 1Ch         ; FAT (12-16) fs ; 43h-1Ch = 27h ; BS_VolID
 16336                                  		; si = disksector+26h = BS_BootSig ; 24/12/2023
 16337                                  IOCtl_If3:
 16338                                  		;cmp	byte [si-1], 29h ; BS_BootSig or BS_FAT32_BootSig
 16339                                  		;;;
 16340 00001438 803C29                  		cmp	byte [si], 29h
 16341                                  		;cmp	byte [disksector+26h], 29h ; [disksector+EXT_BOOT.SIG]
 16342                                  					; EXT_BOOT_SIGNATURE
 16343 0000143B 7512                    		jne	short IOCtl_If2	; not extended boot record
 16344 0000143D C43E[1200]              		les	di, [ptrsav]	; es:di	points to request header
 16345 00001441 26C47F13                		les	di, [es:bx+19]	; [es:bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 16346                                  		; 10/12/2022
 16347                                  		;mov	si, disksector+27h ; disksector+EXT_BOOT.SERIAL
 16348 00001445 46                      		inc	si
 16349                                  		; 24/12/2023
 16350                                  		; si = disksector+27h (BS_VolID)
 16351                                  		;      or disksector+43h (BS_FAT32_VolID)
 16352                                  
 16353 00001446 83C702                  		add	di, 2		; A_MEDIA_ID_INFO.MI_SERIAL
 16354                                  IOCtl_If4:		; 24/12/2023
 16355 00001449 B91700                  		mov	cx, 23		; size_of_EXT_BOOT_SERIAL
 16356                                  					; L+size_of_EXT_BOOT_VOL_LABEL
 16357                                  					; +size_of_EXT_SYSTEM_ID
 16358 0000144C F3A4                    		rep movsb		; Move from Bios_Data into request packet
 16359                                  	
 16360                                  		; 10/12/2022
 16361                                  		; cf = 0
 16362                                  		;clc
 16363                                  
 16364 0000144E C3                      		retn
 16365                                  ; ---------------------------------------------------------------------------
 16366                                  
 16367                                  		; 24/12/2023
 16368                                  IOCtl_If2:
 16369 0000144F F9                      		stc	
 16370                                  IOCtl_If7:
 16371 00001450 B007                    		mov	al, 7		; error_unknown_media
 16372                                  		;stc
 16373                                  IOCtl_If6:
 16374                                  IOCtl_If1:
 16375 00001452 C3                      		retn
 16376                                  ; ---------------------------------------------------------------------------
 16377                                  
 16378                                  ; 16/10/2022
 16379                                  
 16380                                  ; ==========================================================================
 16381                                  ;  set media id
 16382                                  ; ==========================================================================
 16383                                  
 16384                                  ; function: set the volume label, the system id and the serial number of
 16385                                  ;	    the media that has the extended boot record.
 16386                                  ;	    for the conventional media, this routine will return "unknown
 16387                                  ;	    media.." error to dos.
 16388                                  ;	    this routine will also set the corresponding informations in
 16389                                  ;	    the bds table.
 16390                                  ;
 16391                                  ; input :   ES:di -> bds table for this drive.
 16392                                  ;
 16393                                  ; output:   the extended boot record in the media will be set according to
 16394                                  ;	    the request packet.
 16395                                  ;	    if carry set, then al contains the device driver error number
 16396                                  ;	    that will be returned to dos.
 16397                                  ;
 16398                                  ; subroutines to be called:
 16399                                  ;	BootIo:NEAR
 16400                                  ;
 16401                                  ; logic:
 16402                                  ;
 16403                                  ; {
 16404                                  ;	get drive_number from bds;
 16405                                  ;	rFlag = "read operation";
 16406                                  ;	BootIo;
 16407                                  ;	if (no error) then
 16408                                  ;	     if (extended boot record) then
 16409                                  ;		{ set volume label,volume serial number and system id
 16410                                  ;		  of the boot record to those of the request packet;
 16411                                  ;		  rFlag = "write operation";
 16412                                  ;		  get drive number from bds;
 16413                                  ;		  BootIo;	  /*write it back*/
 16414                                  ;		};
 16415                                  ;	     else		  /*not an extended bpb */
 16416                                  ;		{ set register al to "unknown media.." error code;
 16417                                  ;		  set carry bit;
 16418                                  ;		  ret;	 /*return back to caller */
 16419                                  ;		};
 16420                                  ;	else
 16421                                  ;	     ret;		 /*already error code is set */
 16422                                  ;
 16423                                  ; ==========================================================================
 16424                                  
 16425                                  		; 24/12/2023 - Retro DOS 5.0
 16426                                  
 16427                                  		; 19/10/2022
 16428                                  SetMediaId:
 16429 00001453 E87000                  		call	ChangeLineChk
 16430 00001456 268A4505                		mov	al, [es:di+5]	; [es:di+BDS.drivelet]
 16431                                  					; Logical drive	number
 16432 0000145A 88C2                    		mov	dl, al
 16433 0000145C C606[2001]02            		mov	byte [rflag], 2	; romread
 16434 00001461 52                      		push	dx
 16435 00001462 E84900                  		call	BootIo		; Read boot sec	to Bios_Data:DiskSector
 16436 00001465 5A                      		pop	dx
 16437 00001466 72EA                    		jb	short IOCtl_If6
 16438                                  					; Valid? (0F0h-0FFh?)
 16439 00001468 803E[6701]F0            		cmp	byte [disksector+15h], 0F0h
 16440                                  					; [disksector+EXT_BOOT.BPB+EBPB.MEDIADESCRIPTOR]
 16441 0000146D 72E1                    		jb	short IOCtl_If7	; Brif not
 16442                                  
 16443                                  		; 24/12/2023
 16444                                  		;cmp	byte [disksector+26h], 29h ; [disksector+EXT_BOOT.SIG]
 16445                                  		;			; EXT_BOOT_SIGNATURE
 16446                                  		;jnz	short IOCtl_If7	; not extended boot record
 16447                                  		
 16448 0000146F 06                      		push	es		; Save BDS pointer
 16449 00001470 57                      		push	di
 16450 00001471 1E                      		push	ds		; Point	ES To boot record
 16451 00001472 07                      		pop	es
 16452                                  
 16453                                  		; 24/12/2023
 16454                                  		;;;
 16455                                  		;mov	di, disksector+43h ; disksector+EXT_BOOT.SERIAL
 16456 00001473 BF[9401]                		mov	di, disksector+42h ; BS_FAT32_BootSig ; 24/12/2023 
 16457 00001476 833E[6801]00            		cmp	word [disksector+16h], 0 ; BPB.FATSz16
 16458 0000147B 7403                    		jz      short IOCtl_If5	; FAT32 fs
 16459 0000147D 83EF1C                  		sub	di, 1Ch		; 67-28 ; offset disksektor+27h
 16460                                  		; di = disksector+26h = BS_BootSig ; 24/12/2023
 16461                                  IOCtl_If5:
 16462                                  		;cmp	byte [di-1], 29h ; BS_BootSig or BS_FAT32_BootSig
 16463 00001480 803D29                  		cmp	byte [di], 29h
 16464 00001483 7404                    		je	short IOCtl_If8
 16465 00001485 5F                      		pop	di		; not extended boot record
 16466 00001486 07                      		pop	es
 16467                                  		;jmp	short IOCtl_If7
 16468                                  		; 24/12/2023
 16469 00001487 EBC6                    		jmp	short IOCtl_If2
 16470                                  IOCtl_If8:
 16471                                  		;;;
 16472                                  		; 24/12/2023
 16473                                  		;mov	di, disksector+27h ; disksector+EXT_BOOT.SERIAL
 16474 00001489 47                      		inc	di
 16475                                  		; di = disksector+27h (BS_VolID)
 16476                                  		;      or disksector+43h (BS_FAT32_VolID)
 16477                                  
 16478 0000148A C536[1200]              		lds	si, [ptrsav]	; ds:si	points to request header.
 16479 0000148E C57413                  		lds	si, [si+19]	; [si+IOCTL_REQ.GENERICIOCTL_PACKET]
 16480 00001491 83C602                  		add	si, 2		; A_MEDIA_ID_INFO.MI_SERIAL
 16481                                  		
 16482                                  		; 24/12/2023
 16483                                  		;mov	cx, 23		; size_of_EXT_BOOT_SERIAL
 16484                                  		;			; +size_of_EXT_BOOT_VOL_LABEL
 16485                                  		;			; +size_of_EXT_SYSTEM_ID
 16486                                  		;rep movsb
 16487 00001494 E8B2FF                  		call	IOCtl_If4       ; copy volume serial, label and system id
 16488                                  
 16489 00001497 06                      		push	es		; point	ds back	to Bios_Data
 16490 00001498 1F                      		pop	ds
 16491 00001499 5F                      		pop	di		; restore bds pointer
 16492 0000149A 07                      		pop	es
 16493 0000149B E8B3F3                  		call	mov_media_ids	; update the bds media id info.
 16494 0000149E 88D0                    		mov	al, dl
 16495 000014A0 C606[2001]03            		mov	byte [rflag], 3	; romwrite
 16496 000014A5 E80600                  		call	BootIo		; write	it back.
 16497 000014A8 C606[1E01]FF            		mov	byte [tim_drv], 0FFh
 16498                                  					; make sure chk_media check the driver
 16499                                  					; return with error code from BootIo
 16500 000014AD C3                      		retn
 16501                                  ; ---------------------------------------------------------------------------
 16502                                  
 16503                                  		; 24/12/2023
 16504                                  ;IOCtl_If7:
 16505                                  ;		mov	al, 7		; error_unknown_media
 16506                                  ;		stc
 16507                                  ;IOCtl_If6:
 16508                                  ;		retn
 16509                                  
 16510                                  ; =============== S U B	R O U T	I N E =======================================
 16511                                  
 16512                                  ; =============== S U B	R O U T	I N E =======================================
 16513                                  
 16514                                  ; 16/10/2022
 16515                                  
 16516                                  ; ---------------------------------------------------------------------------
 16517                                  ;	BootIo
 16518                                  ; ---------------------------------------------------------------------------
 16519                                  ;
 16520                                  ; function: read/write the boot record into boot sector.
 16521                                  ;
 16522                                  ; input :
 16523                                  ;	    al=logical drive number
 16524                                  ;	    rFlag = operation (read/write)
 16525                                  ;
 16526                                  ; output:   for read operation,the boot record of the drive specified in bds
 16527                                  ;	    be read into the DiskSector buffer.
 16528                                  ;	    for write operation,the DiskSector buffer image will be written
 16529                                  ;	    to the drive specified in bds.
 16530                                  ;	    if carry set,then al contains the device driver error number
 16531                                  ;	    that will be returned to dos.
 16532                                  ;	    AX,CX,DX register destroyed.
 16533                                  ;	    if carry set,then al will contain the error code from DiskIO.
 16534                                  ;
 16535                                  ; subroutines to be called:
 16536                                  ;	DiskIO:NEAR
 16537                                  ;
 16538                                  ; logic:
 16539                                  ;
 16540                                  ; {
 16541                                  ;	first_sector = 0;	 /*logical sector 0 is the boot sector */
 16542                                  ;	sectorcount = 1;	 /*read 1 sector only */
 16543                                  ;	buffer = DiskSector;	 /*read it into the DiskSector buffer */
 16544                                  ;	call DiskIO (rFlag,drive_number,first_sector,sectorcount,buffer);
 16545                                  ; }
 16546                                  ; ==========================================================================
 16547                                  
 16548                                  		; 19/10/2022
 16549                                  BootIo:	
 16550 000014AE 06                      		push	es
 16551 000014AF 57                      		push	di
 16552 000014B0 53                      		push	bx
 16553 000014B1 1E                      		push	ds
 16554 000014B2 07                      		pop	es		; Point ES: to Bios_Data
 16555                                  
 16556                                  		; Call DiskIO to read/write the boot sec. The parameters which
 16557                                  		; need to be initialized for this subroutine out here are
 16558                                  		; - Transfer address to Bios_Data:DiskSector
 16559                                  		; - Low sector needs to be initalized to 0. this is a reg. param
 16560                                  		; - Hi sector in [Start_Sec_H] needs to be initialised to 0.
 16561                                  		; - Number of sectors <-- 1
 16562                                  
 16563 000014B3 BF[5201]                		mov	di, disksector	; es:di -> transfer address
 16564 000014B6 31D2                    		xor	dx, dx		; First	sector (h) -> 0
 16565 000014B8 8916[9C04]              		mov	[start_sec_h], dx ; Start sector (h) -> 0
 16566 000014BC B90100                  		mov	cx, 1
 16567 000014BF E851F5                  		call	diskio
 16568 000014C2 5B                      		pop	bx
 16569 000014C3 5F                      		pop	di
 16570 000014C4 07                      		pop	es
 16571 000014C5 C3                      		retn
 16572                                  
 16573                                  ; =============== S U B	R O U T	I N E =======================================
 16574                                  
 16575                                  ; 16/10/2022
 16576                                  
 16577                                  ; ---------------------------------------------------------------------------
 16578                                  ;	ChangeLineChk
 16579                                  ; ---------------------------------------------------------------------------
 16580                                  ;
 16581                                  ; when the user calls get/set media id call before dos establishes the media
 16582                                  ; by calling "media_chk",the change line activity of the drive is going to be
 16583                                  ; lost.	this routine will check the change line activity and will save the
 16584                                  ; history in the flags.
 16585                                  ;
 16586                                  ; FUNCTION: check the change line error activity
 16587                                  ;
 16588                                  ; INPUT :  ES:di -> bds table.
 16589                                  ;
 16590                                  ; OUTPUT:   flag in bds table will be updated if change line occurs.
 16591                                  ;
 16592                                  ; SUBROUTINES TO BE CALLED:
 16593                                  ;	Set_Changed_DL
 16594                                  ;
 16595                                  ; ---------------------------------------------------------------------------
 16596                                  
 16597                                  		; 24/12/2023 - Retro DOS 5.0
 16598                                  ChangeLineChk:	
 16599 000014C6 268A5504                		mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 16600 000014CA 08D2                    		or	dl, dl		; Fixed	disk?
 16601 000014CC 7821                    		js	short ChangeLnChkRet ; Yes, skip it.
 16602                                  		; 24/12/2023
 16603 000014CE 26F6453F04              		test	byte [es:di+3Fh], 4 ; [es:di+BDS.flags] ; PCDOS 7.1
 16604                                  		; 12/12/2022
 16605                                  		;test	byte [es:di+23h], 4
 16606                                  		;;test	word [es:di+23h], 4 ; [es:di+BDS.flags]
 16607                                  					; return_fake_bpb
 16608 000014D3 751A                    		jnz	short ChangeLnChkRet
 16609 000014D5 803E[7700]01            		cmp	byte [fhave96], 1   ; This rom support change line?
 16610 000014DA 7513                    		jnz	short ChangeLnChkRet
 16611 000014DC E8B207                  		call	haschange	; This drive support change line?
 16612 000014DF 740E                    		jz	short ChangeLnChkRet ; Do nothing
 16613                                  
 16614                                  		; Execute the rom disk interrupt to check changeline activity.
 16615                                  
 16616 000014E1 B416                    		mov	ah, 16h
 16617 000014E3 CD13                    		int	13h	; DISK - FLOPPY	DISK - CHANGE OF DISK STATUS (AT,XT2,XT286,CONV,PS)
 16618                                  				; DL = drive to	check
 16619                                  				; Return: AH = disk change status
 16620 000014E5 7308                    		jnb	short ChangeLnChkRet
 16621 000014E7 53                      		push	bx
 16622 000014E8 BB4000                  		mov	bx, 40h		; fchanged
 16623                                  					; Update flag in BDS for this
 16624                                  					; physical drive
 16625 000014EB E87C07                  		call	set_changed_dl
 16626 000014EE 5B                      		pop	bx
 16627                                  ChangeLnChkRet:				
 16628 000014EF C3                      		retn
 16629                                  
 16630                                  ; ---------------------------------------------------------------------------
 16631                                  
 16632                                  ; 16/10/2022
 16633                                  
 16634                                  ; ==========================================================================
 16635                                  ;	GetAccessFlag
 16636                                  ; ==========================================================================
 16637                                  ;
 16638                                  ; FUNCTION: get the status of UNFORMATTED_MEDIA bit of flags in bds table
 16639                                  ;
 16640                                  ; INPUT :
 16641                                  ;	    ES:di -> bds table
 16642                                  ;
 16643                                  ; OUTPUT:   a_DiskAccess_Control.dac_access_flag = 0 if disk i/o not allowed.
 16644                                  ;						 = 1 if disk i/o allowed.
 16645                                  ; ==========================================================================
 16646                                  
 16647                                  		; 24/12/2023 - Retro DOS 5.0
 16648                                  
 16649                                  		; 19/10/2022
 16650                                  GetAccessFlag:				
 16651 000014F0 C51E[1200]              		lds	bx, [ptrsav]	; DS:BX	points to request header
 16652 000014F4 C55F13                  		lds	bx, [bx+19]	; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 16653                                  		;mov	al, 0		; Assume result	is unformatted
 16654                                  		; 10/12/2022
 16655 000014F7 28C0                    		sub	al, al
 16656                                  		; 24/12/2023
 16657 000014F9 26F6454002              		test	byte [es:di+40h], 02h ; (PCDOS 7.1 IBMBIO.COM)
 16658                                  		;test	word ptr es:[di+3Fh], 200h
 16659                                  		; 10/12/2022
 16660                                  		;test	byte [es:di+36], 02h
 16661                                  		;;test	word [es:di+35], 200h ; [es:di+BDS.flags]
 16662                                  					; unformatted_media
 16663 000014FE 7501                    		jnz	short GafDone	; Done if unformatted
 16664                                  		;inc	al		; Return true for formatted
 16665                                  		; 24/12/2023
 16666 00001500 40                      		inc	ax
 16667                                  GafDone:				
 16668 00001501 884701                  		mov	[bx+1],	al	; [bx+A_DISKACCESS_CONTROL.DAC_ACCESS_FLAG]
 16669 00001504 C3                      		retn
 16670                                  ; ---------------------------------------------------------------------------
 16671                                  
 16672                                  ; 16/10/2022
 16673                                  
 16674                                  ; ==========================================================================
 16675                                  ;	SetAccessFlag
 16676                                  ; ==========================================================================
 16677                                  ;
 16678                                  ; function: set/reset the UNFORMATTED_MEDIA bit of flags in bds table
 16679                                  ;
 16680                                  ; input :
 16681                                  ;	    ES:di -> bds table
 16682                                  ;
 16683                                  ; output:   unformtted_media bit modified according to the user request
 16684                                  ; ==========================================================================
 16685                                  
 16686                                  		; 24/12/2023 - Retro DOS 5.0
 16687                                  
 16688                                  		; 19/10/2022
 16689                                  SetAccessFlag:				
 16690 00001505 C51E[1200]              		lds	bx, [ptrsav]	; ES:BX	points to request header
 16691 00001509 C55F13                  		lds	bx, [bx+19]	; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 16692                                  		; 24/12/2023
 16693 0000150C 26806540FD              		and	byte [es:di+40h], 0FDh ; (PCDOS 7.1 IBMBIO.COM)
 16694                                  		;and	word ptr es:[di+3Fh], 0FDFFh
 16695                                  		; 10/12/2022
 16696                                  		;and	byte [es:di+36], 0FDh
 16697                                  		;;and	word [es:di+35], 0FDFFh ; [es:di+BDS.flags]
 16698                                  					; ~unformatted_media
 16699 00001511 807F0100                		cmp	byte [bx+1], 0	; [bx+A_DISKACCESS_CONTROL.DAC_ACCESS_FLAG]
 16700 00001515 750A                    		jnz	short saf_Done
 16701                                  		; 24/12/2023
 16702 00001517 26804D4002              		or	byte [es:di+40h], 02h ; (PCDOS 7.1 IBMBIO.COM)
 16703                                  		;or	word ptr es:[di+3Fh], 200h
 16704                                  		; 10/12/2022
 16705 0000151C 26804D2402              		or	byte [es:di+36], 02h
 16706                                  		;or	word [es:di+35], 200h ; [es:di+BDS.flags]
 16707                                  					; unformatted_media
 16708                                  saf_Done:				
 16709 00001521 C3                      		retn
 16710                                  ; ---------------------------------------------------------------------------
 16711                                  
 16712                                  ; 16/10/2022
 16713                                  
 16714                                  ; ==========================================================================
 16715                                  ; Ioctl_Support_Query
 16716                                  ; ==========================================================================
 16717                                  ;
 16718                                  ; New device command which was added in DOS 5.00 to allow a query of a 
 16719                                  ; specific GENERIC IOCtl to see if it is supported. Bit 7 in the
 16720                                  ; device attributes specifies if this function is supported.
 16721                                  ;
 16722                                  ; ==========================================================================
 16723                                  
 16724                                  		; 24/12/2023 - Retro DOS 5.0
 16725                                  
 16726                                  		; 19/10/2022
 16727                                  ioctl_support_query:
 16728 00001522 06                      		push	es
 16729 00001523 C41E[1200]              		les	bx, [ptrsav]	; ES:BX Points to request header.
 16730 00001527 268B470D                		mov	ax, [es:bx+13]	; [es:bx+IOCTL_REQ.MAJORFUNCTION]
 16731                                  					; AL ==	Major, AH == Minor
 16732                                  		; 24/12/2023
 16733                                  		; 02/09/2023 (PCDOS 7.1)
 16734 0000152B 3C48                    		cmp	al, 48h		; IOC_NEW_DC (PCDOS 7.1)
 16735                                  					; new generic ioctl function (FAT32)
 16736 0000152D 7404                    		je	short ioctl_support
 16737                                  
 16738 0000152F 3C08                    		cmp	al, 8		; IOC_DC
 16739                                  					; See if major code is 8
 16740 00001531 7513                    		jne	short nosupport
 16741                                  ioctl_support:
 16742 00001533 0E                      		push	cs
 16743 00001534 07                      		pop	es
 16744                                  		; 24/12/2023
 16745                                  		; 02/09/2023
 16746 00001535 B90E00                  		mov	cx, 14          ; (PCDOS 7.1) IOC_DC_TABLE_LEN
 16747                                  		;mov	cx, 11		; IOC_DC_TABLE_LEN
 16748                                  		; 10/12/2022
 16749 00001538 BF[BE0E]                		mov	di, IOC_DC_Table
 16750                                  		;mov	di, 0C60h	; IOC_DC_Table
 16751                                  					; at 2C7h:0C60h	= 70h:31D0h
 16752 0000153B 86C4                    		xchg	al, ah		; Put minor code in AL
 16753 0000153D F2AE                    		repne scasb		; Scan for minor code in AL
 16754 0000153F 7505                    		jnz	short nosupport	; it was not found
 16755 00001541 B80001                  		mov	ax, 100h
 16756                                  		; 10/12/2022
 16757                                  		; (jump to ioctlsupexit is not required)
 16758                                  		;jmp	short $+2	; ioctlsupexit
 16759                                  					; Signal ioctl is supported
 16760                                  		;;jmp	short ioctlsupexit
 16761                                  ; ---------------------------------------------------------------------------
 16762                                  ioctlsupexit:
 16763 00001544 07                      		pop	es
 16764                                  		; 10/12/2022
 16765                                  		; cf = 0
 16766                                  		;clc
 16767 00001545 C3                      		retn
 16768                                  ; ---------------------------------------------------------------------------
 16769                                  nosupport:
 16770 00001546 07                      		pop	es
 16771 00001547 E98BEB                  		jmp	bc_cmderr
 16772                                  ; ---------------------------------------------------------------------------
 16773                                  
 16774                                  ; 16/10/2022
 16775                                  
 16776                                  ; ==========================================================================
 16777                                  ;	GetMediaSenseStatus
 16778                                  ; ==========================================================================
 16779                                  ;
 16780                                  ; FUNCTION: Will return the type of diskette media in the specified DOS
 16781                                  ;	    diskette drive and whether the media is the default type
 16782                                  ;	    for that drive. (default type means the max size for that
 16783                                  ;	    drive)
 16784                                  ;
 16785                                  ; INPUT :   ES:DI -> BDS table
 16786                                  ; OUTPUT:   If carry clear
 16787                                  ;	    DS:BX -> Updated IOCtlPacket
 16788                                  ;
 16789                                  ;			 Special Function at offset 0:
 16790                                  ;				0	- Media detected is not default type
 16791                                  ;				1	- Media detected is default type
 16792                                  ;
 16793                                  ;			 Device Type at offset 1:
 16794                                  ;				2       - 720K 3.5" 80 tracks
 16795                                  ;				7	- 1.44M 3.5" 80 tracks
 16796                                  ;				9	- 2.88M 3.5" 80 tracks
 16797                                  ;
 16798                                  ; Error Codes returned in AX if carry set:
 16799                                  ;
 16800                                  ; 8102 - Drive not ready	- No disk is in the drive.
 16801                                  ; 8107 - Unknown media type	- Drive doesn't support this function or
 16802                                  ;				  the media is really unkown, any error
 16803                                  ;				  other than "media not present"
 16804                                  ; 
 16805                                  ; ==========================================================================
 16806                                  
 16807                                  		; 19/10/2022
 16808                                  SenseMediaType:
 16809 0000154A C51E[1200]              		lds	bx, [ptrsav]	; DS:BX	points to request header.
 16810 0000154E C55F13                  		lds	bx, [bx+19]	; bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 16811                                  		; 10/10/2022
 16812                                  		;mov	word [bx], 0	; Initialize the 2 packet bytes
 16813 00001551 31D2                    		xor	dx, dx
 16814 00001553 8917                    		mov	[bx], dx ; 0
 16815                                  		;
 16816 00001555 268A5504                		mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 16817                                  					; Get int 13h drive number from	BDS
 16818                                  		; 10/12/2022
 16819                                  		;xor	dh, dh		; DX = physical	drive number
 16820 00001559 B420                    		mov	ah, 20h		; Get Media Type function
 16821                                  					; If no	carry media type in AL
 16822 0000155B CD13                    		int	13h		; DISK - QCACHE	- DISMOUNT
 16823 0000155D 7216                    		jc	short MediaSenseEr ; error code	in AH
 16824 0000155F FE07                    		inc	byte [bx]	; Signal media type is default (bit 1)
 16825                                  DetermineMediaType:
 16826 00001561 FEC8                    		dec	al
 16827 00001563 3C02                    		cmp	al, 2		; Chk for 720K ie: (3-1) = 2
 16828 00001565 740A                    		jz	short GotMediaType
 16829 00001567 0404                    		add	al, 4
 16830 00001569 3C07                    		cmp	al, 7		; Chk for 1.44M ie: (4-1+4) = 7
 16831 0000156B 7404                    		jz	short GotMediaType
 16832 0000156D 3C09                    		cmp	al, 9		; Chk for 2.88M	ie: (6-1+4) = 9
 16833 0000156F 7510                    		jnz	short UnknownMediaType ; Just didn't recognize media type
 16834                                  GotMediaType:
 16835 00001571 884701                  		mov	[bx+1],	al	; Save the return value
 16836                                  		; 10/12/2022
 16837                                  		; cf = 0
 16838                                  		;clc			; Signal success
 16839 00001574 C3                      		retn
 16840                                  ; ---------------------------------------------------------------------------
 16841                                  
 16842                                  MediaSenseEr:
 16843 00001575 80FC32                  		cmp	ah, 32h		; See if not default media error
 16844 00001578 74E7                    		jz	short DetermineMediaType ; Not really an error
 16845 0000157A B002                    		mov	al, 2		; Now assume drive not ready
 16846 0000157C 80FC31                  		cmp	ah, 31h		; See if media was present
 16847 0000157F 7402                    		jz	short SenseErrExit ; Return drive not ready
 16848                                  UnknownMediaType:
 16849 00001581 B007                    		mov	al, 7		; Just don't know the media type
 16850                                  SenseErrExit:
 16851 00001583 B481                    		mov	ah, 81h		; Signal error return
 16852 00001585 F9                      		stc
 16853 00001586 C3                      		retn
 16854                                  
 16855                                  ; ----------------------------------------------------------------------------
 16856                                  		; 10/12/2022
 16857                                  		;db    0
 16858                                  ; ----------------------------------------------------------------------------
 16859                                  
 16860                                  ;-----------------------------------------------------------------------------
 16861                                  ; PCDOS 7.1 IBMBIO.COM - BIOSCODE:15F2h
 16862                                  ;-----------------------------------------------------------------------------
 16863                                  ; 26/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
 16864                                  
 16865                                  ; =============== S U B R O U T I N E =======================================
 16866                                  
 16867                                  SetLockState:
 16868 00001587 C51E[1200]              		lds	bx, [ptrsav]	; set media lock state
 16869 0000158B C55F13                  		lds	bx, [bx+13h]	; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 16870                                  		;mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 16871                                  		;call	check_int13h_exts_present
 16872                                  		; 26/12/2023
 16873 0000158E E82100                  		call	check_int13h_exts_p
 16874                                  		;mov	al, 3		; unknown command error
 16875 00001591 721C                    		jc	short setlockst_ret
 16876 00001593 8A07                    		mov	al, [bx]	; [bx+A_LOCKSTATE_CONTROL.LOCKSTATE_FUNCTIONS]
 16877 00001595 B445                    		mov	ah, 45h
 16878 00001597 CD13                    		int	13h		; DISK - IBM/MS Extension - LOCK/UNLOCK DRIVE
 16879                                  		; (DL - drive, [SI - disk address packet)
 16880 00001599 884701                  		mov	[bx+1], al	; 1 = locked, 0 = not locked
 16881                                  		; [bx+A_LOCKSTATE_CONTROL.LOCKSTATE_FLAG]
 16882                                  		
 16883                                  		; 26/12/2023
 16884 0000159C EB0A                    		jmp	short sls_em
 16885                                  
 16886                                  ;		jnc	short setlockst_ret
 16887                                  ;		mov	al, ah
 16888                                  ;		call	maperror
 16889                                  ;setlockst_ret:
 16890                                  ;		mov	ah, 81h		; Return this status in case of carry
 16891                                  ;		retn
 16892                                  
 16893                                  ; =============== S U B R O U T I N E =======================================
 16894                                  
 16895                                  EjectMedia:
 16896                                  		;mov	dl, [es:di+4]	; eject media in drive
 16897                                  		;			; [es:di+BDS.drivenum]
 16898                                  		;call	check_int13h_exts_present
 16899                                  		; 26/12/2023
 16900 0000159E E81100                  		call	check_int13h_exts_p
 16901                                  		;mov	al, 3		; unknown command error
 16902 000015A1 720C                    		jc	short ejectm_ret
 16903 000015A3 B80046                  		mov	ax, 4600h
 16904 000015A6 CD13                    		int	13h		; DISK - IBM/MS Extension - EJECT MEDIA
 16905                                  		; (DL - drive)
 16906                                  sls_em:			; 26/12/2023
 16907 000015A8 7305                    		jnc	short ejectm_ret
 16908 000015AA 88E0                    		mov	al, ah
 16909 000015AC E8FBF7                  		call	maperror
 16910                                  setlockst_ret:		; 26/12/2023
 16911                                  ejectm_ret:
 16912 000015AF B481                    		mov	ah, 81h		; Return this status in case of carry
 16913 000015B1 C3                      		retn
 16914                                  
 16915                                  ; =============== S U B R O U T I N E =======================================
 16916                                  
 16917                                  		; 26/12/2023
 16918                                  check_int13h_exts_p:
 16919 000015B2 268A5504                		mov	dl, [es:di+4]
 16920                                  
 16921                                  check_int13h_exts_present:
 16922 000015B6 B441                    		mov	ah, 41h
 16923 000015B8 53                      		push	bx
 16924 000015B9 BBAA55                  		mov	bx, 55AAh
 16925 000015BC CD13                    		int	13h		; DISK - Check for INT 13h Extensions
 16926                                  					; BX = 55AAh, DL = drive number
 16927                                  					; Return: CF set if not supported
 16928                                  					; AH = extensions version
 16929                                  					; BX = AA55h
 16930                                  					; CX = Interface support bit map
 16931 000015BE 81FB55AA                		cmp	bx, 0AA55h
 16932 000015C2 5B                      		pop	bx
 16933 000015C3 7505                    		jnz	short exts_notsupported
 16934 000015C5 F6C102                  		test	cl, 2		; bit 1 - drive locking and ejecting subset
 16935 000015C8 7503                    		jnz	short exts_supported
 16936                                  exts_notsupported:
 16937                                  		; 26/12/2023
 16938 000015CA B003                    		mov	al, 3
 16939                                  		;
 16940 000015CC F9                      		stc
 16941                                  exts_supported:
 16942 000015CD C3                      		retn
 16943                                  
 16944                                  ; =============== S U B R O U T I N E =======================================
 16945                                  
 16946                                  GetDrvMapInfo:
 16947 000015CE 8CD9                    		mov	cx, ds		; get drive map information
 16948                                  					;
 16949                                  					; es:di points to BDS which belongs to
 16950                                  					;	  the requested logical/dos drive number
 16951                                  					;
 16952                                  					; Format of parameter block:
 16953                                  					; Offset  Description (Table 01570)
 16954                                  					;  00h    (call) length of this buffer (in bytes)
 16955                                  					;  01h    (ret) number of bytes in parameter block
 16956                                  					;	    actually used
 16957                                  					;  02h    (ret) drive flags
 16958                                  					;  03h    (ret) physical drive number
 16959                                  					;	    00h-7Fh floppy
 16960                                  					;	    80h-FEh hard
 16961                                  					;	    FFh no physical drive
 16962                                  					;  04h    (ret) bitmap of logical drives associated with
 16963                                  					;	    physical drive
 16964                                  					;	    bit 0 = drive A:, etc.
 16965                                  					;  08h    (ret) relative block address of partition start
 16966                                  					;	    qword
 16967                                  					;
 16968                                  					; Ref: Ralf Brown's Interrupt List, INTERRUP.G
 16969 000015D0 C51E[1200]              		lds	bx, [ptrsav]
 16970 000015D4 C55F13                  		lds	bx, [bx+13h]	; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 16971 000015D7 B80381                  		mov	ax, 8103h	; ah = generic ioctl error code (81h)
 16972                                  					; al = unknown command error (03h)
 16973 000015DA 803F10                  		cmp	byte [bx], 10h	; parameter buffer length = 16 bytes
 16974 000015DD 7251                    		jb	short gdmi_4
 16975 000015DF 268A5504                		mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 16976 000015E3 885703                  		mov	[bx+3], dl	; parameter block - offset 3 - physical drive number
 16977 000015E6 C6470110                		mov	byte [bx+1], 10h ; parameter block - actually used length
 16978 000015EA 268B4517                		mov	ax, [es:di+17h]	; [es:di+BDS.hiddensectors]
 16979 000015EE 894708                  		mov	[bx+8], ax	; parameter block - offset 8 - partition start LBA
 16980 000015F1 268B4519                		mov	ax, [es:di+19h]	; [es:di+BDS.hiddensectors+2]
 16981 000015F5 89470A                  		mov	[bx+0Ah], ax	; parameter block - offset 10
 16982 000015F8 31C0                    		xor	ax, ax ; 0
 16983 000015FA 884702                  		mov	[bx+2], al	; drive flags = 0 (protected mode flags etc.)
 16984 000015FD 89470C                  		mov	[bx+0Ch], ax	; high dword of partition start address (LBA) is 0
 16985 00001600 89470E                  		mov	[bx+0Eh], ax
 16986 00001603 894704                  		mov	[bx+4], ax	; logical drive bitmap of same physical drive
 16987                                  					; initialized as 0
 16988 00001606 894706                  		mov	[bx+6], ax ; 0
 16989 00001609 8EC1                    		mov	es, cx
 16990                                  		;les	di, dword ptr es:start_bds ; 1st BDS
 16991 0000160B 26C43E[1901]            		les	di, [es:start_bds]
 16992 00001610 B90100                  		mov	cx, 1		; bit 0 (drive A:)
 16993                                  gdmi_1:
 16994 00001613 83FFFF                  		cmp	di, 0FFFFh	; last BDS ?
 16995 00001616 7415                    		jz	short gdmi_3	; yes
 16996 00001618 26385504                		cmp	[es:di+4], dl	; [es:di+BDS.drivenum], dl
 16997                                  					; is it same physical drive ?
 16998 0000161C 7506                    		jnz	short gdmi_2	; no
 16999 0000161E 094F04                  		or	[bx+4], cx	; set bit for logical drive index of this BDS
 17000                                  					; (previously) shifted bit (which is 1/ON) is in ax:cx
 17001 00001621 094706                  		or	[bx+6], ax
 17002                                  gdmi_2:
 17003 00001624 D1E1                    		shl	cx, 1		; shift one left for setting the next drive's bit
 17004 00001626 D1D0                    		rcl	ax, 1		; set high word of the bit select (set) value
 17005 00001628 26C43D                  		les	di, [es:di]	; next BDS
 17006 0000162B EBE6                    		jmp	short gdmi_1	; loop until di = -1 (last BDS sign)
 17007                                  gdmi_3:
 17008 0000162D B80001                  		mov	ax, 100h	; success
 17009                                  gdmi_4:
 17010 00001630 C3                      		retn
 17011                                  
 17012                                  ;-----------------------------------------------------------------------------
 17013                                  
 17014                                  ; 16/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 17015                                  ; 26/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
 17016                                  
 17017                                  ;-----------------------------------------------------------------------------
 17018                                  ; MSINT13.ASM - MSDOS 6.0 - 1991
 17019                                  ;-----------------------------------------------------------------------------
 17020                                  ; 16/03/2019 - Retro DOS v4.0
 17021                                  
 17022                                  ;	int 2f function 13h allows the user to change the orig13 int_13 vector
 17023                                  ;	after booting. this allows testing and implementation of custom int_13
 17024                                  ;	handlers, without giving up ms-dos error recovery
 17025                                  ;	entry:	ds:dx	== addr. of new int_13 handler
 17026                                  ;		es:bx	== addr. of new int_13 vector used by warm boot (int19)
 17027                                  ;	exit:	orig13	== address of new int_13 handler
 17028                                  ;		ds:dx	== old orig13 value
 17029                                  ;		es:bx	== old old13  value
 17030                                  ;
 17031                                  ; int 2f handler for external block drivers to communicate with the internal
 17032                                  ; block driver in msdisk. the multiplex number chosen is 8. the handler
 17033                                  ; sets up the pointer to the request packet in [ptrsav] and then jumps to
 17034                                  ; dsk_entry, the entry point for all disk requests.
 17035                                  ;
 17036                                  ; on exit from this driver, we will return to the external driver
 17037                                  ; that issued this int 2f, and can then remove the flags from the stack.
 17038                                  ; this scheme allows us to have a small external device driver, and makes
 17039                                  ; the maintainance of the various drivers (driver and msbio) much easier,
 17040                                  ; since we only need to make changes in one place (most of the time).
 17041                                  ;
 17042                                  ;   ax=800h - check for installed handler - reserved
 17043                                  ;   ax=801h - install the bds into the linked list
 17044                                  ;   ax=802h - dos request
 17045                                  ;   ax=803h - return bds table starting pointer in ds:di
 17046                                  ;	   (ems device driver hooks int 13h to handle 16kb dma overrun
 17047                                  ;	    problem. bds table is going to be used to get head/sector
 17048                                  ;	    informations without calling generic ioctl get device parm call.)
 17049                                  
 17050                                  ;BIOSSEGMENT equ 70h
 17051                                  DOSBIOSSEG equ 0070h ; 17/10/2022
 17052                                  
 17053                                  ;;BIOSCODE:1302h (MSDOS 6.21, IO.SYS)
 17054                                  ;BIOSCODE:16AAh (PCDOS 7.1, IBMBIO.COM) ; 26/12/2023
 17055                                  
 17056                                  i2f_handler:				; here is 02C7h:1302h =	0070h:3872h
 17057 00001631 80FC13                  		cmp	ah, 13h
 17058 00001634 7413                    		jz	short int2f_replace_int13
 17059 00001636 80FC08                  		cmp	ah, 8
 17060 00001639 7432                    		jz	short mine
 17061                                  
 17062                                  ; Check for WIN386 startup and return the BIOS instance data
 17063                                  
 17064 0000163B 80FC16                  		cmp	ah, 16h		; MultWin386
 17065 0000163E 746D                    		jz	short win386call
 17066 00001640 80FC4A                  		cmp	ah, 4Ah		; multMULT
 17067 00001643 7503                    		jnz	short i2f_handler_iret
 17068 00001645 E99800                  		jmp	handle_multmult
 17069                                  ; ---------------------------------------------------------------------------
 17070                                  
 17071                                  i2f_handler_iret:			
 17072 00001648 CF                      		iret
 17073                                  ; ---------------------------------------------------------------------------
 17074                                  
 17075                                  int2f_replace_int13:
 17076 00001649 FA                      		cli	; 26/12/2023
 17077 0000164A 50                      		push	ax	; free up a register for caller's ds
 17078 0000164B 8CD8                    		mov	ax, ds	; then we can use ds: -> Bios_Data
 17079                                  		;;mov	ds, word [cs:0030h] ; 15/10/2022	
 17080                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:0030h]
 17081                                  					; = [02C7h:0030h] = [0070h:25A0h]
 17082 0000164D 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD] ; 17/10/2022
 17083                                  		; 19/10/2022
 17084                                  		;push	word ptr ds:Orig13	; save old value of old13 and
 17085                                  		;push	word ptr ds:Orig13+2	; orig13 so that we can
 17086                                  		;push	word ptr ds:Old13	; return them to caller
 17087                                  		;push	word ptr ds:Old13+2
 17088                                  		
 17089                                  		; 02/09/2023 (PCDOS 7.1)
 17090                                  		;push	word [Orig13]
 17091 00001652 FF36[B600]              		push	word [Orig13+2]
 17092                                  		;push	word [Old13]
 17093 00001656 FF36[0801]              		push	word [Old13+2]
 17094                                  
 17095                                  		;mov	word ptr ds:Orig13, dx	; orig13 := addr. of new int_13
 17096                                  		;mov	word ptr ds:Orig13+2, ax
 17097                                  		;mov	word ptr ds:Old13, bx	; old13 := addr. of new boot_13
 17098                                  		;mov	word ptr ds:Old13+2, es
 17099                                  		
 17100                                  		;mov	[Orig13], dx
 17101                                  		; 02/09/2023
 17102 0000165A 8716[B400]              		xchg	dx, [Orig13]
 17103 0000165E A3[B600]                		mov	[Orig13+2], ax
 17104                                  		;mov	[Old13], bx
 17105                                  		; 02/09/2023
 17106 00001661 871E[0601]              		xchg	bx, [Old13]
 17107 00001665 8C06[0801]              		mov	[Old13+2], es
 17108                                  
 17109 00001669 07                      		pop	es			; es:bx := old old13 vector
 17110                                  		; 02/09/2023
 17111                                  		;pop	bx
 17112 0000166A 1F                      		pop	ds			; ds:dx := old orig13 vector
 17113                                  		;pop	dx ; 02/09/2023
 17114 0000166B 58                      		pop	ax
 17115                                  i2f_iret:
 17116 0000166C CF                      		iret
 17117                                  ; ---------------------------------------------------------------------------
 17118                                  
 17119                                  mine:
 17120 0000166D 3CF8                    		cmp	al, 0F8h 		; iret on reserved functions
 17121 0000166F 73FB                    		jnb	short i2f_iret
 17122 00001671 08C0                    		or	al, al			; a get installed state request?
 17123 00001673 7503                    		jnz	short disp_func
 17124 00001675 B0FF                    		mov	al, 0FFh
 17125                                  		;jmp	short i2f_iret
 17126                                  		; 02/09/2023
 17127 00001677 CF                      		iret
 17128                                  ; ---------------------------------------------------------------------------
 17129                                  
 17130                                  disp_func:
 17131 00001678 3C01                    		cmp	al, 1			; request for installing bds?
 17132 0000167A 7418                    		jz	short do_subfun_01
 17133 0000167C 3C03                    		cmp	al, 3			; get bds vector?
 17134 0000167E 7423                    		jz	short do_get_bds_vector
 17135                                  
 17136                                  ; set up pointer to request packet
 17137                                  
 17138 00001680 1E                      		push	ds
 17139 00001681 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD] ; 17/10/2022
 17140                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 17141                                  					; = [0070h:25A0h] = [02C7h:0030h]
 17142                                  		; 19/10/2022
 17143                                  		;mov	word ptr ds:ptrsav, bx
 17144                                  		;mov	word ptr ds:ptrsav+2, es
 17145 00001686 891E[1200]              		mov	[ptrsav], bx
 17146 0000168A 8C06[1400]              		mov	[ptrsav+2], es
 17147 0000168E 1F                      		pop	ds
 17148                                  		;jmp	far ptr	i2f_dskentry
 17149                                  		; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 17150                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:1708h
 17151 0000168F EA[5E06]7000            		jmp	DOSBIOSSEG:dsk_entry ; BIOSDATA:dsk_entry
 17152                                  		;; 17/10/2022
 17153                                  		;;jmp	far DOSBIOSSEG:dsk_entry
 17154                                  		;jmp	DOSBIOSSEG:i2f_dskentry ; 70h:i2f_dskentry
 17155                                  					; NOTE: jump to a FAR function, not an
 17156                                  					;  IRET type function. Callers of
 17157                                  					;  this int2f subfunction will have
 17158                                  					;  to be careful to do a popf
 17159                                  
 17160                                  ; ---------------------------------------------------------------------------
 17161                                  
 17162                                  do_subfun_01:
 17163 00001694 06                      		push	es
 17164 00001695 1E                      		push	ds
 17165 00001696 1E                      		push	ds
 17166 00001697 07                      		pop	es
 17167                                  		; 17/10/2022
 17168 00001698 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 17169                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 17170                                  					; point	ds: -> Bios_Data
 17171 0000169D E8BC03                  		call	install_bds
 17172 000016A0 1F                      		pop	ds
 17173 000016A1 07                      		pop	es
 17174                                  		;jmp	short i2f_iret
 17175                                  		; 02/09/2023
 17176 000016A2 CF                      		iret
 17177                                  ; ---------------------------------------------------------------------------
 17178                                  
 17179                                  do_get_bds_vector:
 17180                                  		; 17/10/2022
 17181 000016A3 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 17182                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 17183 000016A8 C53E[1901]              		lds	di, [start_bds]
 17184                                  		;lds	di, ds:start_bds
 17185                                  ;ii2f_iret:	; 10/12/2022
 17186                                  		;jmp	short i2f_iret
 17187                                  		; 02/09/2023
 17188 000016AC CF                      		iret
 17189                                  ; ---------------------------------------------------------------------------
 17190                                  
 17191                                  ; 17/10/2022
 17192                                  ; 16/10/2022
 17193                                  
 17194                                  ; WIN386 startup stuff is done here. If starting up we set our WIN386 present
 17195                                  ; flag and return instance data. If exiting, we reset the WIN386 present flag
 17196                                  ; NOTE: We assume that the BIOS int 2fh is at the bottom of the chain.
 17197                                  
 17198                                  win386call:
 17199 000016AD 1E                      		push	ds
 17200 000016AE 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 17201                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 17202                                  					; at 2C7h:30h =	70h:25A0h
 17203 000016B3 3C05                    		cmp	al, 5		; Win386_Init
 17204                                  					; is it	win386 initializing?
 17205 000016B5 7410                    		jz	short Win386Init
 17206 000016B7 3C06                    		cmp	al, 6		; Win386_Exit
 17207                                  					; is it	win386 exiting?
 17208 000016B9 7523                    		jnz	short win_iret	; if not, continue int2f chain
 17209                                  		; 12/12/2022
 17210 000016BB F6C201                  		test	dl, 1
 17211                                  		;test	dx, 1		; is it	win386 or win286 dos extender?
 17212 000016BE 751E                    		jnz	short win_iret	; if not win386, then continue
 17213                                  		;and	ds:IsWin386, 0	; indicate that	win386 is not present  
 17214 000016C0 8026[1208]00            		and	byte [IsWin386], 0 
 17215 000016C5 EB17                    		jmp	short win_iret
 17216                                  ; ---------------------------------------------------------------------------
 17217                                  
 17218                                  Win386Init:
 17219                                  		; 12/12/2022
 17220 000016C7 F6C201                  		test	dl, 1
 17221                                  		;test	dx, 1		; is it win386 or win286 dos extender?
 17222 000016CA 7512                    		jnz	short win_iret	; if not win386, then continue
 17223                                  		;or	ds:IsWin386, 1	; Indicate WIN386 present
 17224 000016CC 800E[1208]01            		or	byte [IsWin386], 1
 17225                                  		;mov	word ptr ds:SI_Next, bx	; Hook our structure into chain
 17226                                  		;mov	word ptr ds:SI_Next+2, es
 17227 000016D1 891E[E007]              		mov	[SI_Next], bx
 17228 000016D5 8C06[E207]              		mov	[SI_Next+2], es
 17229                                  		;mov	bx, offset Win386_SI ; point ES:BX to Win386_SI
 17230 000016D9 BB[DE07]                		mov	bx, Win386_SI	; 19/10/2022
 17231 000016DC 1E                      		push	ds
 17232 000016DD 07                      		pop	es
 17233                                  win_iret:
 17234 000016DE 1F                      		pop	ds
 17235                                  ii2f_iret:	; 10/12/2022
 17236                                  		;jmp	short i2f_iret	; return back up the chain
 17237                                  		; 02/09/2023
 17238 000016DF CF                      		iret
 17239                                  ; ---------------------------------------------------------------------------
 17240                                  
 17241                                  handle_multmult:
 17242 000016E0 3C01                    		cmp	al, 1
 17243 000016E2 7514                    		jnz	short try_2
 17244 000016E4 1E                      		push	ds
 17245 000016E5 E84500                  		call	HMAPtr		; get offset of free HMA
 17246                                  		; 10/12/2022
 17247                                  		;xor	bx, bx
 17248                                  		;dec	bx
 17249 000016E8 BBFFFF                  		mov	bx, 0FFFFh
 17250 000016EB 8EC3                    		mov	es, bx		; seg of HMA
 17251 000016ED 89FB                    		mov	bx, di
 17252 000016EF F7D3                    		not	bx
 17253 000016F1 09DB                    		or	bx, bx
 17254 000016F3 7401                    		jz	short try_1
 17255 000016F5 43                      		inc	bx
 17256                                  try_1:
 17257 000016F6 1F                      		pop	ds
 17258                                  		;jmp	short ii2f_iret
 17259                                  		; 02/09/2023
 17260 000016F7 CF                      		iret
 17261                                  ; ---------------------------------------------------------------------------
 17262                                  
 17263                                  try_2:
 17264 000016F8 3C02                    		cmp	al, 2		; multMULTALLOCHMA
 17265 000016FA 7530                    		jnz	short try_3
 17266 000016FC 1E                      		push	ds
 17267                                  		; 10/12/2022
 17268                                  		;xor	di, di
 17269                                  		;dec	di
 17270 000016FD BFFFFF                  		mov	di, 0FFFFh	; assume not enough space
 17271 00001700 8EC7                    		mov	es, di
 17272 00001702 E82800                  		call	HMAPtr		; get offset of free HMA
 17273 00001705 83FFFF                  		cmp	di, 0FFFFh
 17274 00001708 7421                    		jz	short InsuffHMA
 17275 0000170A F7DF                    		neg	di		; free space in HMA
 17276 0000170C 39FB                    		cmp	bx, di
 17277 0000170E 7605                    		jbe	short try_4
 17278                                  		; 10/12/2022
 17279                                  		;sub	di, di
 17280                                  		;dec	di
 17281 00001710 BFFFFF                  		mov	di, 0FFFFh
 17282                                  		;jmp	short InsuffHMA
 17283                                  		; 02/09/2023
 17284 00001713 1F                      		pop	ds
 17285 00001714 CF                      		iret
 17286                                  ; ---------------------------------------------------------------------------
 17287                                  
 17288                                  try_4:
 17289                                  		;mov	di, ds:FreeHMAPtr
 17290 00001715 8B3E[D707]              		mov	di, [FreeHMAPtr]
 17291 00001719 83C30F                  		add	bx, 15
 17292                                  		;and	bx, 0FFF0h
 17293                                  		; 10/12/2022
 17294 0000171C 80E3F0                  		and	bl, 0F0h
 17295                                  		;add	ds:FreeHMAPtr, bx ; update the free pointer
 17296 0000171F 011E[D707]              		add	[FreeHMAPtr], bx
 17297 00001723 7506                    		jnz	short InsuffHMA
 17298 00001725 C706[D707]FFFF          		mov	word [FreeHMAPtr], 0FFFFh ; -1
 17299                                  		;mov	ds:FreeHMAPtr, 0FFFFh
 17300                                  					; no more HMA if we have wrapped
 17301                                  InsuffHMA:
 17302 0000172B 1F                      		pop	ds
 17303                                  		; 10/12/2022
 17304                                  try_3:
 17305                                  		;jmp	short ii2f_iret
 17306                                  		; 02/09/2023
 17307 0000172C CF                      		iret
 17308                                  ; ---------------------------------------------------------------------------
 17309                                  
 17310                                  		; 10/12/2022
 17311                                  ;try_3:
 17312                                  		;jmp	ii2f_iret
 17313                                  
 17314                                  ; =============== S U B	R O U T	I N E =======================================
 17315                                  
 17316                                  ; 16/10/2022
 17317                                  
 17318                                  ;--------------------------------------------------------------------------
 17319                                  ;
 17320                                  ; procedure : HMAPtr
 17321                                  ;
 17322                                  ;		Gets the offset of the free HMA area ( with respect to
 17323                                  ;							seg ffff )
 17324                                  ;		If DOS has not moved high, tries to move DOS high.
 17325                                  ;		In the course of doing this, it will allocate all the HMA
 17326                                  ;		and set the FreeHMAPtr to past the end of the BIOS and 
 17327                                  ;		DOS code. The call to MoveDOSIntoHMA (which is a pointer)
 17328                                  ;		enters the routine in sysinit1 called FTryToMovDOSHi.
 17329                                  ;
 17330                                  ;	RETURNS : offset of free HMA in DI
 17331                                  ;		  BIOS_DATA, seg in DS
 17332                                  ;
 17333                                  ;--------------------------------------------------------------------------
 17334                                  
 17335                                  		; 17/10/2022
 17336                                  HMAPtr:
 17337 0000172D 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 17338                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 17339 00001732 8B3E[D707]              		mov	di, [FreeHMAPtr]
 17340                                  		;mov	di, ds:FreeHMAPtr
 17341 00001736 83FFFF                  		cmp	di, 0FFFFh
 17342 00001739 750F                    		jnz	short HMAPtr_retn
 17343 0000173B 803E[DD07]00            		cmp	byte [SysinitPresent], 0
 17344                                  		;cmp	ds:SysinitPresent, 0
 17345 00001740 7408                    		jz	short HMAPtr_retn
 17346 00001742 FF1E[D907]              		call	far [MoveDOSIntoHMA]
 17347                                  		;call	ds:MoveDOSIntoHMA ; call far [MoveDOSIntoHMA]
 17348 00001746 8B3E[D707]              		mov	di, [FreeHMAPtr]
 17349                                  		;mov	di, ds:FreeHMAPtr
 17350                                  HMAPtr_retn:
 17351 0000174A C3                      		retn
 17352                                  
 17353                                  ; =============== S U B	R O U T	I N E =======================================
 17354                                  
 17355                                  ; 16/10/2022
 17356                                  
 17357                                  ; move a 512 byte sector from ds:si to es:di, do not trash cx
 17358                                  ; but go ahead and update direction flag, si, & di
 17359                                  
 17360                                  move_sector:
 17361                                  
 17362                                  ; The 80386 microprocessor considers an access to WORD 0FFFFh in
 17363                                  ; any segment to be a fault. Theoretically, this could be handled
 17364                                  ; by the fault handler and the behavior of an 8086 could be emulated
 17365                                  ; by wrapping the high byte to offset 0000h. This would be a lot
 17366                                  ; of work and was, indeed, blown off by the Win386 guys. COMPAQ
 17367                                  ; also handles the fault incorrectly in their ROM BIOS for real
 17368                                  ; mode. Their fault handler was only designed to deal with one
 17369                                  ; special case which occurred in a magazine benchmark, but didn't
 17370                                  ; handle the general case worth beans.
 17371                                  ;
 17372                                  ; Simply changing this code to do a byte loop would work okay but
 17373                                  ; would involve a general case performance hit. Therefore, we'll
 17374                                  ; check for either source or destination offsets being within one
 17375                                  ; sector of the end of their segments and only in that case fall
 17376                                  ; back to a byte move.
 17377                                  
 17378 0000174B FC                      		cld
 17379 0000174C 51                      		push	cx
 17380 0000174D B90001                  		mov	cx, 256
 17381 00001750 81FE00FE                		cmp	si, 0FE00h
 17382 00001754 770A                    		ja	short movsec_bytes
 17383 00001756 81FF00FE                		cmp	di, 0FE00h
 17384 0000175A 7704                    		ja	short movsec_bytes
 17385 0000175C F3A5                    		rep movsw
 17386 0000175E 59                      		pop	cx
 17387 0000175F C3                      		retn
 17388                                  ; ---------------------------------------------------------------------------
 17389                                  
 17390                                  movsec_bytes:
 17391 00001760 D1E1                    		shl	cx, 1
 17392 00001762 F3A4                    		rep movsb
 17393 00001764 59                      		pop	cx
 17394 00001765 C3                      		retn
 17395                                  
 17396                                  ; =============== S U B	R O U T	I N E =======================================
 17397                                  
 17398                                  ; 16/10/2022
 17399                                  
 17400                                  ; check_wrap is a routine that adjusts the starting sector, starting head
 17401                                  ; and starting cylinder for an int 13 request that requests i/o of a lot
 17402                                  ; of sectors. it only does this for fixed disks. it is used in the sections
 17403                                  ; of code that handle ecc errors and dma errors. it is necessary, because
 17404                                  ; ordinarily the rom would take care of wraps around heads and cylinders,
 17405                                  ; but we break down a request when we get an ecc or dma error into several
 17406                                  ; i/o of one or more sectors. in this case, we may already be beyond the
 17407                                  ; number of sectors on a track on the medium, and the request would fail.
 17408                                  ;
 17409                                  ; input conditions:
 17410                                  ;	all registers set up for an int 13 request.
 17411                                  ;
 17412                                  ; output:
 17413                                  ;	dh - contains starting head number for request
 17414                                  ;	cx - contains starting sector and cylinder numbers
 17415                                  ;	(the above may or may not have been changed, and are 0-based)
 17416                                  ;	all other registers preserved.
 17417                                  
 17418                                  		; 26/12/2023 - Retro DOS 5.0
 17419                                  check_wrap:	
 17420 00001766 50                      		push	ax
 17421 00001767 53                      		push	bx
 17422 00001768 06                      		push	es
 17423 00001769 57                      		push	di
 17424 0000176A E86C00                  		call	find_bds	; get pointer to bds for drive in dl
 17425 0000176D 725E                    		jb	short no_wrap	; finished if DOS doesn't use it
 17426                                  		; 26/12/2023
 17427 0000176F 26F6453F01              		test	byte [es:di+3Fh], 1
 17428                                  		; 12/12/2022
 17429                                  		;test	byte [es:di+23h], 1
 17430                                  		;;test	word [es:di+23h], 1 ; [es:di+BDS.flags],fnon_removable
 17431 00001774 7457                    		jz	short no_wrap	; no wrapping for removable media
 17432 00001776 268B5D13                		mov	bx, [es:di+13h]	; [es:di+BDS.secpertrack]
 17433 0000177A 89C8                    		mov	ax, cx
 17434 0000177C 83E03F                  		and	ax, 3Fh		; extract sector number
 17435 0000177F 39D8                    		cmp	ax, bx		; are we going to wrap?
 17436 00001781 764A                    		jbe	short no_wrap
 17437 00001783 F6F3                    		div	bl		; ah=new sector	#, al=#	of head	wraps
 17438                                  
 17439                                  ; we need to be careful here. if the new sector # is 0, then we are on the
 17440                                  ; last sector on that track.
 17441                                  
 17442 00001785 08E4                    		or	ah, ah
 17443 00001787 7503                    		jnz	short not_on_bound
 17444                                  		; 18/12/2022
 17445 00001789 48                      		dec	ax ; *
 17446 0000178A 88DC                    		mov	ah, bl		; set sector=BDS_BPB.BPB_SECTORSPERTRACK
 17447                                  					; if on	boundary
 17448                                  		;dec	al ; *		; also decrement # of head wraps
 17449                                  not_on_bound:
 17450 0000178C 80E1C0                  		and	cl, 0C0h	; zero out sector #
 17451 0000178F 08E1                    		or	cl, ah		; or in	new sector #
 17452 00001791 30E4                    		xor	ah, ah		; ax = # of head wraps
 17453 00001793 40                      		inc	ax
 17454 00001794 00F0                    		add	al, dh		; add in starting head #
 17455 00001796 80D400                  		adc	ah, 0		; catch	any carry
 17456                                  		; 02/09/2023
 17457 00001799 268B5D15                		mov	bx, [es:di+15h]	; [es:di+BDS.heads]
 17458 0000179D 39D8                    		cmp	ax, bx
 17459                                  		;cmp	ax, [es:di+15h]	; [es:di+BDS.heads]
 17460                                  					; are we going to wrap around a	head?
 17461 0000179F 7632                    		jbe	short no_wrap_head ; do	not lose new head number!!
 17462 000017A1 52                      		push	dx		; preserve drive number and head number
 17463 000017A2 31D2                    		xor	dx, dx
 17464                                  		;mov	bx, [es:di+15h]	; [es:di+BDS.heads]
 17465 000017A4 F7F3                    		div	bx		; dx=new head #, ax=# of cylinder wraps
 17466                                  
 17467                                  ; careful here! if new head # is 0, then we are on the last head.
 17468                                  
 17469 000017A6 09D2                    		or	dx, dx
 17470 000017A8 7507                    		jnz	short no_head_bound
 17471 000017AA 89DA                    		mov	dx, bx		; on boundary. set to BDS_BPB.BPB_HEADS
 17472                                  
 17473                                  ; if we had some cylinder wraps, we need to reduce them by one!!
 17474                                  
 17475 000017AC 09C0                    		or	ax, ax
 17476 000017AE 7401                    		jz	short no_head_bound
 17477 000017B0 48                      		dec	ax		; reduce number	of cylinder wraps
 17478                                  no_head_bound:				
 17479 000017B1 88D7                    		mov	bh, dl		; bh has new head number
 17480 000017B3 5A                      		pop	dx		; restore drive number and head number
 17481 000017B4 FECF                    		dec	bh		; get it 0-based
 17482 000017B6 88FE                    		mov	dh, bh		; set up new head number in dh
 17483 000017B8 88CF                    		mov	bh, cl
 17484 000017BA 80E73F                  		and	bh, 3Fh		; preserve sector number
 17485 000017BD B306                    		mov	bl, 6
 17486 000017BF 86CB                    		xchg	cl, bl
 17487 000017C1 D2EB                    		shr	bl, cl		; get ms cylinder bits to ls end
 17488 000017C3 00C5                    		add	ch, al		; add in cylinder wrap
 17489 000017C5 10E3                    		adc	bl, ah		; add in high byte
 17490 000017C7 D2E3                    		shl	bl, cl		; move up to ms	end
 17491 000017C9 86D9                    		xchg	bl, cl		; restore cylinder bits	into cl
 17492 000017CB 08F9                    		or	cl, bh		; or in	sector number
 17493                                  no_wrap:				
 17494 000017CD F8                      		clc
 17495 000017CE 5F                      		pop	di
 17496 000017CF 07                      		pop	es
 17497 000017D0 5B                      		pop	bx
 17498 000017D1 58                      		pop	ax
 17499 000017D2 C3                      		retn
 17500                                  ; ---------------------------------------------------------------------------
 17501                                  
 17502                                  no_wrap_head:				
 17503 000017D3 88C6                    		mov	dh, al		; do not lose new head number
 17504 000017D5 FECE                    		dec	dh		; get it 0-based
 17505 000017D7 EBF4                    		jmp	short no_wrap
 17506                                  
 17507                                  ; =============== S U B	R O U T	I N E =======================================
 17508                                  
 17509                                  ; 16/10/2022
 17510                                  
 17511                                  ; this is a special version of the bds lookup code which is
 17512                                  ; based on physical drives rather than the usual logical drives
 17513                                  ; carry is set if the physical drive in dl is found, es:di -> its bds
 17514                                  ; otherwise carry is clear
 17515                                  ;
 17516                                  ; guaranteed to trash no registers except es:di
 17517                                  
 17518                                  		; 19/10/2022
 17519                                  find_bds:	
 17520 000017D9 C43E[1901]              		les	di, [start_bds]	; point es:di to first bds
 17521                                  fbds_1:					
 17522 000017DD 26385504                		cmp	[es:di+4], dl	; [es:di+BDS.drivenum]
 17523 000017E1 7409                    		jz	short fdbs_2
 17524 000017E3 26C43D                  		les	di, [es:di]	; [es:di+BDS.link]
 17525                                  					; go to next bds
 17526 000017E6 83FFFF                  		cmp	di, 0FFFFh
 17527 000017E9 75F2                    		jnz	short fbds_1
 17528 000017EB F9                      		stc
 17529                                  fdbs_2:					
 17530 000017EC C3                      		retn
 17531                                  
 17532                                  ; =============== S U B	R O U T	I N E =======================================
 17533                                  
 17534                                  ; 16/10/2022
 17535                                  		; 17/10/2022
 17536                                  doint:
 17537                                  		; 10/12/2022
 17538 000017ED 8A5608                  		mov	dl, [bp+8]	; [bp+INT13FRAME.olddx]
 17539                                  					; get physical drive number
 17540                                  		; 19/10/2022 - Temporary !
 17541                                  		;db	8Ah, 96h, 8, 0	; mov dl, [bp+8]	
 17542                                  		
 17543 000017F0 30E4                    		xor	ah, ah
 17544 000017F2 08C0                    		or	al, al
 17545 000017F4 7410                    		jz	short dointdone	; if zero sectors, return ax=0
 17546                                  		; 10/12/2022
 17547 000017F6 8A6603                  		mov	ah, [bp+3]	; [bp+INT13FRAME.oldax+1]
 17548                                  					; get request code
 17549                                  		;db	8Ah, 0A6h, 3, 0	; mov ah, [bp+3]
 17550 000017F9 FF7610                  		push	word [bp+10h]	; [bp+INT13FRAME.oldf]
 17551                                  		;db	0FFh, 0B6h, 10h, 0 ; push word [bp+10h]
 17552 000017FC 9D                      		popf
 17553                                  		;call	far 70h:797h ; MSDOS 6.21 IO.SYS BIOSCODE:14EAh
 17554                                  		; 17/10/2022
 17555 000017FD 9A[0B07]7000            		call	DOSBIOSSEG:call_orig13
 17556                                  		;;call	call_orig13	; call far 70h:797h
 17557                                  					; call far KERNEL_SEGMENT:call_orig13
 17558 00001802 9C                      		pushf
 17559                                  		; 10/12/2022
 17560 00001803 8F4610                  		pop	word [bp+10h]	; [bp+INT13FRAME.oldf]
 17561                                  		;db	8Fh, 86h, 10h, 0 ; pop word [bp+10h]
 17562                                  dointdone:				
 17563 00001806 C3                      		retn
 17564                                  
 17565                                  ;----------------------------------------------------------------------------
 17566                                  
 17567                                  ; 16/10/2022
 17568                                  
 17569                                  ; this is the true int 13 handler. we parse the request to see if there is
 17570                                  ; a dma violation. if so, depending on the function, we:
 17571                                  ;   read/write break the request into three pieces and move the middle one
 17572                                  ;	       into our internal buffer.
 17573                                  ;
 17574                                  ;   format     copy the format table into the buffer
 17575                                  ;   verify     point the transfer address into the buffer
 17576                                  ;
 17577                                  ; this is the biggest bogosity of all. the ibm controller does not handle
 17578                                  ; operations that cross physical 64k boundaries. in these cases, we copy
 17579                                  ; the offending sector into the buffer below and do the i/o from there.
 17580                                  
 17581                                  ;struc INT13FRAME
 17582                                  ;.oldbp: resw
 17583                                  ;.oldax: resw 
 17584                                  ;.oldbx: resw
 17585                                  ;.oldcx: resw
 17586                                  ;.olddx: resw
 17587                                  ;.oldds: resw	; now we save caller's ds, too
 17588                                  ;.olddd: resd
 17589                                  ;.oldf:	resw
 17590                                  ;end struc
 17591                                  
 17592                                  ;----------------------------------------------------------------------------
 17593                                  
 17594                                  ;   entry conditions:
 17595                                  ;	ah = function
 17596                                  ;	al = number of sectors
 17597                                  ;	es:bx = dma address
 17598                                  ;	cx = packed track and sector
 17599                                  ;	dx = head and drive
 17600                                  ;   output conditions:
 17601                                  ;	no dma violation.
 17602                                  
 17603                                  ;	use extreme caution when working with this code. In general,
 17604                                  ;	  all registers are hot at all times.
 17605                                  ;
 17606                                  ;	question:  does this code handle cases where dma errors
 17607                                  ;	  occur during ecc retries, and where ecc errors occur during
 17608                                  ;	  dma breakdowns???? Hmmmmm.
 17609                                  
 17610                                  ;----------------------------------------------------------------------------
 17611                                  
 17612                                  ; ---------------------------------------------------------------------------
 17613                                  
 17614                                  		; 26/12/2023 - Retro DOS v5.0
 17615                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:1889h
 17616                                  dtype_array:
 17617 00001807 90004000                		dd 400090h		; 40h:90h is drive type array addr
 17618                                  
 17619                                  ; 17/10/2022
 17620                                  ;DTYPEARRAY equ dtype_array - DOSBIOSEG_2C7h ; (14F5h for MSDOS 5.0 IO.SYS)
 17621                                  ; 09/12/2022
 17622                                  DTYPEARRAY equ dtype_array
 17623                                  
 17624                                  ; ---------------------------------------------------------------------------
 17625                                  
 17626                                  ; stick some special stuff out of mainline
 17627                                  
 17628                                  ; we know we're doing a format command. if we have changeline
 17629                                  ; support, then flag some special changed stuff and set changed
 17630                                  ; by format bit for all logical drives using this physical drive
 17631                                  
 17632                                  format_special_stuff:
 17633 0000180B 803E[7700]00            		cmp	byte [fhave96], 0	; do we have changeline support?
 17634 00001810 7459                    		jz	short format_special_stuff_done ; brif not
 17635 00001812 53                      		push	bx
 17636 00001813 BB4001                  		mov	bx, 140h	; fchanged_by_format+fchanged
 17637 00001816 E85104                  		call	set_changed_dl	; indicate that media changed by format
 17638 00001819 5B                      		pop	bx
 17639 0000181A EB4F                    		jmp	short format_special_stuff_done
 17640                                  ; ---------------------------------------------------------------------------
 17641                                  
 17642                                  ; 16/10/2022
 17643                                  
 17644                                  ; we know we've got ec35's on the system. Now see if we're doing
 17645                                  ; a floppy. If so, create a mask and see if this particular
 17646                                  ; drive is an ec35. If so, set dtype_array[drive]=93h
 17647                                  
 17648                                  		; 19/10/2022
 17649                                  ec35_special_stuff:
 17650 0000181C 84D2                    		test	dl, dl		; floppy or hard disk?
 17651 0000181E 7852                    		js	short ec35_special_stuff_done ;	if hard	drive, we're done
 17652 00001820 50                      		push	ax		; see if this PARTICULAR drive is ec35
 17653 00001821 51                      		push	cx
 17654 00001822 88D1                    		mov	cl, dl		; turn drive number into bit map
 17655 00001824 B001                    		mov	al, 1		; assume drive 0
 17656 00001826 D2E0                    		shl	al, cl		; shift	over correct number of times
 17657 00001828 8406[A204]              		test	[ec35flag], al	; electrically compatible 3.5 incher?
 17658 0000182C 59                      		pop	cx
 17659 0000182D 58                      		pop	ax
 17660 0000182E 7442                    		jz	short ec35_special_stuff_done
 17661                                  					; done if this floppy is not an	ec35
 17662 00001830 53                      		push	bx		; free up a far	pointer	(es:bx)
 17663 00001831 06                      		push	es
 17664                                  		; 17/10/2022
 17665 00001832 2EC41E[0718]            		les	bx, [cs:DTYPEARRAY]
 17666                                  		;les	bx, dword ptr cs:DTYPEARRAY ; [cs:dtype_array]
 17667                                  					; 0070h:3A65h =	2C7h:14F5h
 17668 00001837 00D3                    		add	bl, dl
 17669 00001839 80D700                  		adc	bh, 0		; find entry for this drive
 17670 0000183C 26C60793                		mov	byte [es:bx], 93h ; establish drive type as:
 17671                                  					; (360k	disk in	360k drive,
 17672                                  					; no double-stepping, 250 kbs transfer rate)
 17673 00001840 07                      		pop	es
 17674 00001841 5B                      		pop	bx
 17675 00001842 EB2E                    		jmp	short ec35_special_stuff_done
 17676                                  ; ---------------------------------------------------------------------------
 17677                                  
 17678                                  ; 16/10/2022
 17679                                  
 17680                                  ; ps2_30 machine has some problem with ah=8h (read drive parm), int 13h.
 17681                                  ; this function does not reset the common buses after the execution.
 17682                                  ; to solve this problem, when we detect ah=8h, then we will save the result and
 17683                                  ; will issue ah=1 (read status) call to reset the buses.
 17684                                  
 17685                                  ps2_special_stuff:
 17686 00001844 803E[1E00]08            		cmp	byte [prevoper], 8 ; (ps2_30)
 17687                                  					; read driver parm ?
 17688 00001849 7407                    		jz	short ps2_30_problem
 17689 0000184B 803E[1E00]15            		cmp	byte [prevoper], 15h
 17690                                  					; apparently function 15h fails, too
 17691 00001850 752D                    		jnz	short ps2_special_stuff_done
 17692                                  ps2_30_problem:
 17693 00001852 50                      		push	ax
 17694 00001853 B401                    		mov	ah, 1
 17695                                  		; 26/12/2023
 17696                                  		;call	70h:70Bh ; PCDOS 7.1 IBMBIO.COM BIOSCODE:18D7h
 17697                                  		;		 ; call BIOSDATA:call_orig13	
 17698                                  		;;call	far 70:797h ; MSDOS 6.21 IO.SYS BIOSCODE:1543h
 17699                                  		; 17/10/2022
 17700 00001855 9A[0B07]7000            		call	DOSBIOSSEG:call_orig13
 17701                                  		;call	call_orig13	; call far 70:797h
 17702                                  					; call far KERNEL_SEGMENT:call_orig13
 17703 0000185A 58                      		pop	ax
 17704 0000185B EB22                    		jmp	short ps2_special_stuff_done
 17705                                  ; ---------------------------------------------------------------------------
 17706                                  
 17707                                  ; 17/10/2022
 17708                                  ; 16/10/2022
 17709                                  
 17710                                  ; here is the actual int13 handler
 17711                                  
 17712                                  i13z:					; 0070h:3ABBh =	02C7h:154Bh
 17713                                  
 17714                                  ; cas -- inefficient! could push ds and load ds-> Bios_Data before
 17715                                  ; vectoring up here from Bios_Data
 17716                                  
 17717                                  		; 19/10/2022
 17718 0000185D 1E                      		push	ds		; save caller's ds register first thing
 17719                                  		;;mov	ds, word [cs:0030h]
 17720                                  					; and set up our own ds -> Bios_Data
 17721 0000185E 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 17722                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:0030h]
 17723                                  					; = [02C7h:0030h] = [0070h:25A0h]
 17724                                  
 17725                                  ; let the operation proceed. if there is a dma violation, then we do things
 17726                                  
 17727 00001863 A3[1E00]                		mov	[prevoper], ax	; save request
 17728 00001866 80FC05                  		cmp	ah, 5		; romformat
 17729 00001869 74A0                    		jz	short format_special_stuff
 17730                                  					; go do special stuff for format
 17731                                  format_special_stuff_done:
 17732 0000186B 803E[A204]00            		cmp	byte [ec35flag], 0 ; any electrically compat 3.5 inchers?
 17733 00001870 75AA                    		jnz	short ec35_special_stuff
 17734                                  					; go handle it out of line if so
 17735                                  ec35_special_stuff_done:
 17736                                  		; 26/12/2023
 17737                                  		;call	70h:70Bh ; PCDOS 7.1 IBMBIO.COM BIOSCODE:18EDh
 17738                                  		;;call	far 70:797h ; MSDOS 6.21 IO.SYS BIOSCODE:1560h
 17739 00001872 9A[0B07]7000            		call	DOSBIOSSEG:call_orig13
 17740                                  		;call	call_orig13	; call far KERNEL_SEGMENT:call_orig13
 17741                                  		
 17742 00001877 9C                      		pushf			; save result flags
 17743                                  		
 17744 00001878 803E[AF05]FA            		cmp	byte [model_byte], 0FAh ; is this a ps2/30?
 17745                                  					; mdl_ps2_30
 17746 0000187D 74C5                    		jz	short ps2_special_stuff
 17747                                  					; exit mainline to address special
 17748                                  ps2_special_stuff_done:			; ps2/30 problem if so
 17749 0000187F 9D                      		popf
 17750 00001880 7221                    		jb	short goterr13	; error	on original orig13 call-thru?
 17751                                  ret_from_i13:
 17752 00001882 1F                      		pop	ds
 17753 00001883 CA0200                  		retf	2		; restore ds &	iret w/flags
 17754                                  ; ---------------------------------------------------------------------------
 17755                                  
 17756                                  ; most of our code exits through here. If carry isn't set, then
 17757                                  ; just do a simple exit. Else doublecheck that we aren't getting
 17758                                  ; a changeline error.
 17759                                  
 17760                                  i13ret_ck_chglinerr:			
 17761 00001886 73FA                    		jnb	short ret_from_i13 ; done if not an error termination
 17762                                  i13_ret_error:				
 17763 00001888 80FC06                  		cmp	ah, 6		; did i	see a change event?
 17764 0000188B 7513                    		jnz	short int13b	; skip if wrong	error
 17765 0000188D 08D2                    		or	dl, dl		; is this for the hard disk?
 17766 0000188F 780F                    		js	short int13b	; yes, ignore
 17767 00001891 803E[7700]00            		cmp	byte [fhave96], 0
 17768 00001896 7408                    		jz	short int13b	; just in case ROM returned this
 17769                                  					; error	even though it told us it
 17770                                  					; never	would
 17771 00001898 53                      		push	bx
 17772 00001899 BB4000                  		mov	bx, 40h		; fchanged
 17773 0000189C E8CB03                  		call	set_changed_dl
 17774 0000189F 5B                      		pop	bx
 17775                                  int13b:
 17776 000018A0 F9                      		stc			; now return the error
 17777 000018A1 EBDF                    		jmp	short ret_from_i13
 17778                                  ; ---------------------------------------------------------------------------
 17779                                  
 17780                                  ; some kind of error occurred. see if it is dma violation
 17781                                  
 17782                                  goterr13:
 17783 000018A3 80FC09                  		cmp	ah, 9		; dma error?
 17784 000018A6 747C                    		jz	short gotdmaerr
 17785                                  goterr13_xxxx:
 17786 000018A8 80FC11                  		cmp	ah, 11h		; ecc error?
 17787 000018AB 75DB                    		jnz	short i13_ret_error ; other error. just	return back.
 17788 000018AD 803E[A905]01            		cmp	byte [media_set_for_format], 1 ; formatting?
 17789 000018B2 74D4                    		jz	short i13_ret_error
 17790                                  
 17791 000018B4 803E[1F00]02            		cmp	byte [prevoper+1], 2
 17792                                  		;cmp	byte ptr ds:prevoper+1,	2 ; ecc-corrected error
 17793                                  					; (2 = romread)
 17794                                  					; ECC correction only applies to reads
 17795 000018B9 75CD                    		jnz	short i13_ret_error
 17796                                  
 17797 000018BB 30E4                    		xor	ah, ah
 17798                                  		;;call	far 70:797h ; MSDOS 6.21 IO.SYS BIOSCODE:15ABh
 17799                                  		; 17/10/2022
 17800 000018BD 9A[0B07]7000            		call	DOSBIOSSEG:call_orig13
 17801                                  		;call	call_orig13	; call far KERNEL_SEGMENT:call_orig13
 17802                                  					; call far 70:797h
 17803 000018C2 A1[1E00]                		mov	ax, [prevoper]
 17804 000018C5 30E4                    		xor	ah, ah		; return code =	no error
 17805 000018C7 3C01                    		cmp	al, 1		; if request for one sector, assume ok
 17806 000018C9 74B7                    		jz	short ret_from_i13 ; return with carry clear
 17807 000018CB 53                      		push	bx
 17808 000018CC 51                      		push	cx
 17809 000018CD 52                      		push	dx
 17810 000018CE A2[2000]                		mov	[number_of_sec], al
 17811                                  loop_ecc:
 17812 000018D1 B80102                  		mov	ax, 201h	; read one sector
 17813                                  
 17814                                  ; we do reads one sector at a time. this ensures that we will eventually
 17815                                  ; finish the request since ecc errors on one sector do read in that sector.
 17816                                  ;
 17817                                  ; we need to put in some "intelligence" into the ecc handler to handle reads
 17818                                  ; that attempt to read more sectors than are available on a particular
 17819                                  ; track.
 17820                                  ;
 17821                                  ; we call check_wrap to set up the sector #, head # and cylinder # for
 17822                                  ; this request.
 17823                                  ;
 17824                                  ; at this point, all registers are set up for the call to orig13, except
 17825                                  ; that there may be a starting sector number that is bigger than the number
 17826                                  ; of sectors on a track.
 17827                                  ;
 17828 000018D4 E88FFE                  		call	check_wrap	; get correct parameters for int 13
 17829                                  		;;call	far 70:797h ; MSDOS 6.21 IO.SYS BIOSCODE:15C5h
 17830                                  		; 17/10/2022
 17831 000018D7 9A[0B07]7000            		call	DOSBIOSSEG:call_orig13
 17832                                  		;call	call_orig13	; call far KERNEL_SEGMENT:call_orig13
 17833 000018DC 730C                    		jnb	short ok11_op
 17834 000018DE 80FC09                  		cmp	ah, 9		; DMA error during ECC read?
 17835 000018E1 741B                    		jz	short handle_dma_during_ecc
 17836 000018E3 80FC11                  		cmp	ah, 11h		; only allow ecc errors
 17837 000018E6 7510                    		jnz	short ok11_exit_err
 17838                                  		; 10/12/2022
 17839                                  		; xor ax ax -> ah = 0
 17840                                  		;mov	ah, 0		; ecc error. reset the system again.
 17841 000018E8 31C0                    		xor	ax, ax		; clear	the error code so that if this
 17842                                  					; was the last sector, no error	code
 17843                                  					; will be returned for the corrected
 17844                                  					; read.	(clear carry too.)
 17845                                  ok11_op:
 17846 000018EA FE0E[2000]              		dec	byte [number_of_sec]
 17847 000018EE 7409                    		jz	short ok11_exit	; all done?
 17848 000018F0 FEC1                    		inc	cl		; advance sector number
 17849                                  					; add 200h to address
 17850 000018F2 FEC7                    		inc	bh
 17851 000018F4 FEC7                    		inc	bh
 17852 000018F6 EBD9                    		jmp	short loop_ecc
 17853                                  ; ---------------------------------------------------------------------------
 17854                                  
 17855                                  ; locate error returns centrally
 17856                                  
 17857                                  ok11_exit_err:
 17858 000018F8 F9                      		stc			; set carry bit again.
 17859                                  ok11_exit:
 17860 000018F9 5A                      		pop	dx
 17861 000018FA 59                      		pop	cx
 17862 000018FB 5B                      		pop	bx
 17863 000018FC EB88                    		jmp	short i13ret_ck_chglinerr
 17864                                  ; ---------------------------------------------------------------------------
 17865                                  
 17866                                  ; do the single sector read again, this time into our temporary
 17867                                  ; buffer, which is guaranteed not to have a DMA error, then
 17868                                  ; move the data to its proper location and proceed
 17869                                  
 17870                                  handle_dma_during_ecc:
 17871 000018FE 06                      		push	es
 17872 000018FF 53                      		push	bx
 17873 00001900 BB[5201]                		mov	bx, disksector
 17874 00001903 1E                      		push	ds
 17875 00001904 07                      		pop	es		; point es:bx to buffer
 17876 00001905 B80102                  		mov	ax, 201h	; read one sector
 17877                                  		;;call	far 70:797h ; MSDOS 6.21 IO.SYS BIOSCODE:15F8h
 17878                                  		; 17/10/2022
 17879 00001908 9A[0B07]7000            		call	DOSBIOSSEG:call_orig13
 17880                                  		;call	call_orig13	; call far KERNEL_SEGMENT:call_orig13
 17881 0000190D 5B                      		pop	bx
 17882 0000190E 07                      		pop	es
 17883 0000190F 7305                    		jnb	short handle_dma_during_ecc_noerr
 17884 00001911 80FC11                  		cmp	ah, 11h
 17885 00001914 75E2                    		jnz	short ok11_exit_err ; if anything but ecc error, bomb out
 17886                                  
 17887                                  ; now we're kosher. Copy the data to where it belongs and resume
 17888                                  ; the ECC looping code.
 17889                                  
 17890                                  handle_dma_during_ecc_noerr:
 17891 00001916 56                      		push	si
 17892 00001917 57                      		push	di
 17893 00001918 89DF                    		mov	di, bx
 17894 0000191A BE[5201]                		mov	si, disksector
 17895 0000191D E82BFE                  		call	move_sector
 17896 00001920 5F                      		pop	di
 17897 00001921 5E                      		pop	si
 17898 00001922 EBC6                    		jmp	short ok11_op
 17899                                  ; ---------------------------------------------------------------------------
 17900                                  
 17901                                  ; we truly have a dma violation. restore register ax and retry the
 17902                                  ; operation as best we can.
 17903                                  
 17904                                  gotdmaerr:
 17905 00001924 A1[1E00]                		mov	ax, [prevoper]	; 19/10/2022
 17906 00001927 FB                      		sti
 17907 00001928 80FC02                  		cmp	ah, 2		; romread
 17908 0000192B 723B                    		jb	short i13_done_dmaerr
 17909                                  					; just pass dma error thru for
 17910                                  					; functions we don't handle
 17911 0000192D 80FC04                  		cmp	ah, 4		; romverify
 17912 00001930 743C                    		jz	short intverify
 17913 00001932 80FC05                  		cmp	ah, 5		; romformat
 17914 00001935 7448                    		jz	short intformat
 17915 00001937 772F                    		ja	short i13_done_dmaerr
 17916                                  
 17917                                  ; we are doing a read/write call. check for dma problems
 17918                                  
 17919                                  ;	******** set up stack frame here!!! ********
 17920                                  
 17921 00001939 52                      		push	dx
 17922 0000193A 51                      		push	cx
 17923 0000193B 53                      		push	bx
 17924 0000193C 50                      		push	ax
 17925 0000193D 55                      		push	bp
 17926 0000193E 89E5                    		mov	bp, sp
 17927 00001940 8CC2                    		mov	dx, es		; check	for 64k	boundary error
 17928                                  		; 26/12/2023
 17929                                  		;add	dx, dx
 17930                                  		;add	dx, dx
 17931                                  		;add	dx, dx
 17932                                  		;add	dx, dx		; dx = dx*16
 17933 00001942 D1E2                    		shl	dx, 1
 17934 00001944 D1E2                    		shl	dx, 1
 17935 00001946 D1E2                    		shl	dx, 1
 17936 00001948 D1E2                    		shl	dx, 1		; segment converted to absolute	address
 17937 0000194A 01DA                    		add	dx, bx		; combine with offset
 17938 0000194C 81C2FF01                		add	dx, 511		; simulate a transfer
 17939                                  
 17940                                  ; if carry is set, then we are within 512 bytes of the end of the segment.
 17941                                  ; we skip the first transfer and perform the remaining buffering and transfer
 17942                                  
 17943 00001950 7303                    		jnb	short no_skip_first
 17944 00001952 E98300                  		jmp	bufferx		; restore dh=head & do buffer
 17945                                  ; ---------------------------------------------------------------------------
 17946                                  
 17947                                  no_skip_first:
 17948 00001955 D0EE                    		shr	dh, 1		; dh = number of sectors before	address
 17949 00001957 B480                    		mov	ah, 128		; ah = max number of sectors in	segment
 17950 00001959 28F4                    		sub	ah, dh
 17951                                  
 17952                                  ; ah is now the number of sectors that we can successfully write in this
 17953                                  ; segment. if this number is above or equal to the requested number, then we
 17954                                  ; continue the operation as normal. otherwise, we break it into pieces.
 17955                                  ;
 17956                                  ; wait a sec. this is goofy. the whole reason we got here in the
 17957                                  ; first place is because we got a dma error. so it's impossible
 17958                                  ; for the whole block to fit, unless the dma error was returned
 17959                                  ; in error.
 17960                                  
 17961 0000195B 38C4                    		cmp	ah, al		; can we fit it	in?
 17962 0000195D 7236                    		jb	short doblock	; no, perform blocking.
 17963                                  
 17964                                  ; yes, the request fits. let it happen.
 17965                                  
 17966 0000195F 8A7609                  		mov	dh, [bp+9]	; [bp+INT13FRAME.olddx+1]
 17967                                  					; set up head number
 17968 00001962 E888FE                  		call	doint
 17969 00001965 E9D900                  		jmp	bad13		; and return from this place
 17970                                  ; ---------------------------------------------------------------------------
 17971                                  
 17972                                  i13_done_dmaerr:
 17973 00001968 B409                    		mov	ah, 9		; pass dma error thru to caller
 17974 0000196A F9                      		stc
 17975 0000196B E914FF                  		jmp	ret_from_i13	; return with error,
 17976                                  					; we know it's not a changeline error
 17977                                  ; ---------------------------------------------------------------------------
 17978                                  
 17979                                  ; verify the given sectors. place the buffer pointer into our space.
 17980                                  
 17981                                  intverify:
 17982 0000196E 06                      		push	es		; save caller's dma address
 17983 0000196F 53                      		push	bx
 17984 00001970 1E                      		push	ds		; es:bx	-> Bios_Data:disksector
 17985 00001971 07                      		pop	es
 17986                                  dosimple:
 17987 00001972 BB[5201]                		mov	bx, disksector
 17988                                  					; do the i/o from Bios_Data:disksector
 17989                                  		;;call	far 70:797h ; MSDOS 6.21 IO.SYS BIOSCODE:1665h
 17990                                  		; 17/10/2022
 17991 00001975 9A[0B07]7000            		call	DOSBIOSSEG:call_orig13
 17992                                  		;call	call_orig13	; call far KERNEL_SEGMENT:call_orig13
 17993 0000197A 5B                      		pop	bx
 17994 0000197B 07                      		pop	es
 17995 0000197C E907FF                  		jmp	i13ret_ck_chglinerr
 17996                                  ; ---------------------------------------------------------------------------
 17997                                  
 17998                                  ; format operation. copy the parameter table into Bios_Data:disksector
 17999                                  
 18000                                  intformat:
 18001 0000197F 06                      		push	es
 18002 00001980 53                      		push	bx
 18003 00001981 56                      		push	si
 18004 00001982 57                      		push	di
 18005 00001983 1E                      		push	ds
 18006                                  
 18007                                  ; point ds to the caller's dma buffer, es to Bios_Data
 18008                                  ; in other words, swap (ds, es)
 18009                                  
 18010 00001984 06                      		push	es
 18011 00001985 1E                      		push	ds
 18012 00001986 07                      		pop	es
 18013 00001987 1F                      		pop	ds
 18014 00001988 89DE                    		mov	si, bx
 18015 0000198A BF[5201]                		mov	di, disksector
 18016 0000198D E8BBFD                  		call	move_sector	; user's data into Bios_Data:disksector
 18017 00001990 1F                      		pop	ds
 18018 00001991 5F                      		pop	di
 18019 00001992 5E                      		pop	si		; do the i/o from
 18020 00001993 EBDD                    		jmp	short dosimple	; Bios_Data:disksector
 18021                                  ; ---------------------------------------------------------------------------
 18022                                  
 18023                                  ; we can't fit the request into the entire block. perform the operation on
 18024                                  ; the first block.
 18025                                  ;
 18026                                  ; doblock is modified to correctly handle multi-sector disk i/o.
 18027                                  ; old doblock had added the number of sectors i/oed (ah in old doblock) after
 18028                                  ; the doint call to cl. observing only the lower 6 bits of cl(=max. 64) can
 18029                                  ; represent a starting sector, if ah was big, then cl would be clobbered.
 18030                                  ; by the way, we still are going to use cl for this purpose since checkwrap
 18031                                  ; routine will use it as an input. to prevent cl from being clobbered, a
 18032                                  ; safe number of sectors should be calculated like "63 - # of sectors/track".
 18033                                  ; doblock will handle the first block of requested sectors within the
 18034                                  ; boundary of this safe value.
 18035                                  
 18036                                  		; 26/12/2023 - Retro DOS v5.0
 18037                                  doblock:
 18038                                  
 18039                                  ; try to get the # of sectors/track from bds via rom drive number.
 18040                                  ; for any mini disks installed, here we have to pray that they have the
 18041                                  ; same # of sector/track as the main dos partition disk drive.
 18042                                  				
 18043 00001995 8B5608                  		mov	dx, [bp+8]	; [bp+INT13FRAME.olddx]
 18044                                  					; get head #, drive #
 18045 00001998 51                      		push	cx
 18046 00001999 06                      		push	es
 18047 0000199A 57                      		push	di		; ah - # of sectors before dma boundary
 18048                                  					; al - requested # of sectors for i/o.
 18049 0000199B E83BFE                  		call	find_bds
 18050 0000199E 268B4D13                		mov	cx, [es:di+13h]	; [es:di+BDS.secpertrack]
 18051                                  		; 26/12/2023
 18052 000019A2 26F6453F01              		test	byte [es:di+3Fh], 1
 18053                                  		; 12/12/2022
 18054                                  		;test	byte [es:di+23h], 1
 18055                                  		;;test	word [es:di+23h], 1 ; [es:di+BDS.flags],fnon_removable
 18056 000019A7 5F                      		pop	di
 18057 000019A8 07                      		pop	es
 18058 000019A9 88E0                    		mov	al, ah		; set al=ah for	floppies
 18059 000019AB 7404                    		jz	short doblockflop ; they are track by track operation
 18060 000019AD B43F                    		mov	ah, 63		; ah = 63-secpt	(# safe	sectors??)
 18061 000019AF 28CC                    		sub	ah, cl		; al - # of sectors before dma boundary
 18062                                  doblockflop:
 18063 000019B1 59                      		pop	cx
 18064                                  doblockcontinue:
 18065 000019B2 38C4                    		cmp	ah, al		; if safe_# >= #_of_sectors_to_go_before dma,
 18066 000019B4 7305                    		jnb	short doblocklast ; then #_of_sectors_to_go as it is for doint.
 18067 000019B6 50                      		push	ax
 18068 000019B7 88E0                    		mov	al, ah		; otherwise, set al to ah to operate.
 18069 000019B9 EB03                    		jmp	short doblockdoint
 18070                                  ; ---------------------------------------------------------------------------
 18071                                  
 18072                                  doblocklast:
 18073 000019BB 88C4                    		mov	ah, al
 18074 000019BD 50                      		push	ax
 18075                                  doblockdoint:				; let ah = al =	# of sectors for this shot
 18076 000019BE E82CFE                  		call	doint
 18077 000019C1 727E                    		jb	short bad13	; something happened, bye!
 18078 000019C3 58                      		pop	ax
 18079 000019C4 286602                  		sub	[bp+2],	ah	; sub [bp+INT13FRAME.oldax], ah
 18080                                  					; decrement by the successful operation
 18081 000019C7 00E1                    		add	cl, ah		; advance sector #. safety gauranteed.
 18082 000019C9 00E7                    		add	bh, ah		; advance dma addres
 18083 000019CB 00E7                    		add	bh, ah		; twice	for 512	byte sectors
 18084 000019CD 38C4                    		cmp	ah, al		; check	the previous value
 18085 000019CF 740A                    		jz	short buffer	; if #_of_sectors_to_go	< safe_#,
 18086                                  					; then we are done already.
 18087 000019D1 28E0                    		sub	al, ah		; otherwise,
 18088                                  					; #_sector_to_go = #_of_sector_to_go - safe_#
 18089 000019D3 E890FD                  		call	check_wrap	; get new cx, dh for the next operation.
 18090 000019D6 EBDA                    		jmp	short doblockcontinue ;	handles	next sectors left.
 18091                                  ; ---------------------------------------------------------------------------
 18092                                  
 18093                                  bufferx:
 18094 000019D8 8A7609                  		mov	dh, [bp+9]	; [bp+INT13FRAME.olddx+1]
 18095                                  					; set up head number
 18096                                  buffer:
 18097 000019DB 53                      		push	bx
 18098 000019DC 8A6603                  		mov	ah, [bp+3]	; [bp+INT13FRAME.oldax+1]
 18099 000019DF 80FC03                  		cmp	ah, 3		; romwrite
 18100 000019E2 7525                    		jnz	short doread	;
 18101                                  					
 18102                                  ; copy the offending sector into local buffer
 18103                                  
 18104 000019E4 06                      		push	es
 18105 000019E5 1E                      		push	ds
 18106 000019E6 56                      		push	si
 18107 000019E7 57                      		push	di
 18108 000019E8 1E                      		push	ds		; exchange segment registers
 18109 000019E9 06                      		push	es
 18110 000019EA 1F                      		pop	ds
 18111 000019EB 07                      		pop	es
 18112 000019EC BF[5201]                		mov	di, disksector	; where to move
 18113 000019EF 57                      		push	di		; save it
 18114 000019F0 89DE                    		mov	si, bx		; source
 18115 000019F2 E856FD                  		call	move_sector	; move sector into local buffer
 18116 000019F5 5B                      		pop	bx		; new transfer address
 18117                                  					; (es:bx = Bios_Data:diskbuffer)
 18118 000019F6 5F                      		pop	di		; restore caller's di & si
 18119 000019F7 5E                      		pop	si
 18120 000019F8 1F                      		pop	ds		; restore Bios_Data
 18121                                  
 18122                                  ; see if we are wrapping around a track or head
 18123                                  
 18124 000019F9 B001                    		mov	al, 1		; [bp+INT13FRAME.olddx]
 18125                                  					; get drive number
 18126 000019FB 8A5608                  		mov	dl, [bp+8]
 18127 000019FE E865FD                  		call	check_wrap	; sets up registers if wrap-around
 18128                                  					;
 18129                                  					; ah is	function
 18130                                  					; al is	1 for single sector transfer
 18131                                  					; es:bx	is local transfer addres
 18132                                  					; cx is	track/sector number
 18133                                  					; dx is	head/drive number
 18134                                  					; si,di	unchanged
 18135 00001A01 E8E9FD                  		call	doint
 18136 00001A04 07                      		pop	es		; restore caller's dma segment
 18137 00001A05 723A                    		jb	short bad13	; go clean up
 18138 00001A07 EB22                    		jmp	short dotail
 18139                                  ; ---------------------------------------------------------------------------
 18140                                  
 18141                                  ; reading a sector. do int first, then move things around
 18142                                  
 18143                                  doread:
 18144 00001A09 06                      		push	es
 18145 00001A0A 53                      		push	bx
 18146 00001A0B 1E                      		push	ds		; es = Bios_Code
 18147 00001A0C 07                      		pop	es
 18148 00001A0D BB[5201]                		mov	bx, disksector
 18149 00001A10 B001                    		mov	al, 1
 18150 00001A12 8A5608                  		mov	dl, [bp+8]	; [bp+INT13FRAME.olddx]
 18151                                  					; get drive number
 18152 00001A15 E84EFD                  		call	check_wrap	;
 18153                                  					; ah = function
 18154                                  					; al = 1 for single sector
 18155                                  					; es:bx	points to local	buffer
 18156                                  					; cx, dx are track/sector, head/drive
 18157 00001A18 E8D2FD                  		call	doint
 18158 00001A1B 5B                      		pop	bx
 18159 00001A1C 07                      		pop	es
 18160 00001A1D 7222                    		jb	short bad13
 18161 00001A1F 56                      		push	si
 18162 00001A20 57                      		push	di
 18163 00001A21 89DF                    		mov	di, bx
 18164 00001A23 BE[5201]                		mov	si, disksector
 18165 00001A26 E822FD                  		call	move_sector
 18166 00001A29 5F                      		pop	di
 18167 00001A2A 5E                      		pop	si
 18168                                  
 18169                                  ; note the fact that we've done 1 more sector
 18170                                  
 18171                                  dotail:
 18172 00001A2B 5B                      		pop	bx		; retrieve new dma area
 18173 00001A2C 80C702                  		add	bh, 2		; advance over sector
 18174 00001A2F 41                      		inc	cx
 18175 00001A30 8A4602                  		mov	al, [bp+2]	; [bp+INT13FRAME.oldax]
 18176 00001A33 F8                      		clc
 18177 00001A34 FEC8                    		dec	al
 18178 00001A36 7409                    		jz	short bad13	; no more i/o
 18179                                  
 18180                                  ; see if we wrap around a track or head boundary with starting sector
 18181                                  ; we already have the correct head number to pass to check_wrap
 18182                                  
 18183 00001A38 8A5608                  		mov	dl, [bp+8]	; [bp+INT13FRAME.olddx]
 18184 00001A3B E828FD                  		call	check_wrap
 18185 00001A3E E8ACFD                  		call	doint
 18186                                  
 18187                                  ; we are done. ax has the final code; we throw away what we got before
 18188                                  
 18189                                  ; M046  -- okay gang. Now we've either terminated our DMA loop,
 18190                                  ;	   or we've finished. If carry is set now, our only
 18191                                  ;	   hope for salvation is that it was a read operation
 18192                                  ;	   and the error code is ECC error. In that case, we'll
 18193                                  ;	   just pop the registers and go do the old ECC thing.
 18194                                  ;	   When the DMA error that got us here in the first
 18195                                  ;	   place occurs, it'll handle it.
 18196                                  
 18197                                  bad13:
 18198 00001A41 89EC                    		mov	sp, bp
 18199 00001A43 5D                      		pop	bp
 18200 00001A44 5B                      		pop	bx
 18201 00001A45 5B                      		pop	bx
 18202 00001A46 59                      		pop	cx
 18203 00001A47 5A                      		pop	dx
 18204 00001A48 7203                    		jb	short xgoterr13_xxxx ; go handle ECC errors
 18205 00001A4A E935FE                  		jmp	ret_from_i13	; non-error exit
 18206                                  ; ---------------------------------------------------------------------------
 18207                                  
 18208                                  xgoterr13_xxxx:	
 18209 00001A4D E958FE                  		jmp	goterr13_xxxx
 18210                                  
 18211                                  ; ---------------------------------------------------------------------------
 18212                                  		; 10/12/2022
 18213                                  		;db 	0
 18214                                  ; ---------------------------------------------------------------------------
 18215                                  
 18216                                  ;Bios_Code ends
 18217                                  
 18218                                  ; 16/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 18219                                  
 18220                                  ;-----------------------------------------------------------------------------
 18221                                  ; MSBIO2.ASM - MSDOS 6.0 - 1991
 18222                                  ;-----------------------------------------------------------------------------
 18223                                  ; 17/03/2019 - Retro DOS v4.0
 18224                                  
 18225                                  		; 19/10/2022
 18226                                  dsk_init:				; 2C7h:1742h = 70h:3CB2h
 18227 00001A50 8A26[7500]              		mov	ah, [drvmax]
 18228 00001A54 BF[3C05]                		mov	di, dskdrvs
 18229 00001A57 1E                      		push	ds		; pass result in es:di
 18230 00001A58 07                      		pop	es
 18231 00001A59 E92EEC                  		jmp	SetPtrSav
 18232                                  
 18233                                  ; =============== S U B	R O U T	I N E =======================================
 18234                                  
 18235                                  ;---------------------------------------------------------------------------
 18236                                  ; install_bds installs a bds at location es:di into the current linked list of
 18237                                  ; bds maintained by this device driver. it places the bds at the end of the
 18238                                  ; list. Trashes (at least) ax, bx, di, si
 18239                                  ;---------------------------------------------------------------------------
 18240                                  
 18241                                  		; 26/12/2023 - Retro DOS v5.0
 18242                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:1AE0h
 18243                                  install_bds:
 18244 00001A5C 1E                      		push	ds		; save Bios_Data segment
 18245 00001A5D BE[1901]                		mov	si, start_bds	; beginning of chain
 18246                                  
 18247                                  		; ds:si now points to link to first bds
 18248                                  		; assume bds list is non-empty
 18249                                  loop_next_bds:
 18250 00001A60 C534                    		lds	si, [si]	; [si+BDS.link]
 18251                                  					; fetch	next bds
 18252 00001A62 268A4504                		mov	al, [es:di+4]	; [es:di+BDS.drivenum]
 18253 00001A66 384404                  		cmp	[si+4],	al	; does this one	share a	physical
 18254                                  					; drive	with new one?
 18255 00001A69 7518                    		jnz	short next_bds
 18256 00001A6B B310                    		mov	bl, 10h		; fi_am_mult
 18257                                  		; 26/12/2023
 18258 00001A6D 26085D3F                		or	[es:di+3Fh], bl
 18259                                  		;or	[es:di+23h], bl	; [es:di+BDS.flags]
 18260                                  					; set both of them to i_am_mult	if so
 18261 00001A71 085C3F                  		or	[si+3Fh], bl
 18262                                  		;or	[si+23h], bl	; [si+BDS.flags]
 18263 00001A74 2680653FDF              		and	byte [es:di+3Fh], 0DFh
 18264                                  		;and	byte [es:di+23h], 0DFh ; [es:di+BDS.flags],~fi_own_physical
 18265                                  					; we don't own it
 18266 00001A79 8A5C3F                  		mov	bl, [si+3Fh]
 18267                                  		;mov	bl, [si+23h]	; [si+BDS.flags]
 18268                                  					; determine if changeline available
 18269 00001A7C 80E302                  		and	bl, 2		; fchangeline
 18270 00001A7F 26085D3F                		or	[es:di+3Fh], bl
 18271                                  		;or	[es:di+23h], bl	; [es:di+BDS.flags]
 18272                                  next_bds:
 18273                                  		; 02/09/2023 (PCDOS 7.1)
 18274 00001A83 B8FFFF                  		mov	ax, 0FFFFh	; -1
 18275 00001A86 3904                    		cmp	[si], ax	; [si+BDS.link],-1
 18276                                  		;cmp	word [si], 0FFFFh ; [si+BDS.link],-1
 18277                                  					; are we at end	of list?
 18278 00001A88 75D6                    		jnz	short loop_next_bds
 18279 00001A8A 8C4402                  		mov	[si+2], es	; [si+BDS.link+2],es
 18280                                  					; install bds
 18281 00001A8D 893C                    		mov	[si], di
 18282 00001A8F 268905                  		mov	[es:di], ax	; [es:di+BDS.link],-1
 18283                                  		;mov	word [es:di], 0FFFFh ; [es:di+BDS.link],-1
 18284                                  					; set next pointer to null
 18285 00001A92 1F                      		pop	ds
 18286                                  
 18287                                  ; 01/07/2023 - Retro DOS v4.2 (MSDOS 6.21 IO.SYS - BIOSCODE:1785h)
 18288                                  ; 16/10/2022 (MSDOS 6.0 Code)
 18289                                  
 18290                                  ; **** If the new drive has a higher EOT value, we must alter the
 18291                                  ;      'eot' variable appropriately.
 18292                                  
 18293                                  		; 26/12/2023
 18294 00001A93 268A4550                		mov	al, [es:di+50h]	; [es:di+BDS.rsecpertrack]
 18295                                  		; 01/06/2019
 18296                                  		;mov	al,[es:di+52]
 18297                                  		; 22/07/2023
 18298                                  		;mov	al,[es:di+BDS.rsecpertrack]
 18299 00001A97 3A06[2C01]              		cmp	al,[eot]
 18300 00001A9B 7603                    		jbe	short _eot_ok
 18301 00001A9D A2[2C01]                		mov	[eot],al
 18302                                  _eot_ok:
 18303 00001AA0 C3                      		retn
 18304                                  
 18305                                  ; ---------------------------------------------------------------------------
 18306                                  
 18307                                  ; 17/10/2022
 18308                                  ;DRVLET	equ drvlet - DOSBIOSEG_2C7h
 18309                                  ;SNGMSG	equ sngmsg - DOSBIOSEG_2C7h
 18310                                  ; 09/12/2022
 18311                                  DRVLET equ drvlet
 18312                                  SNGMSG equ sngmsg
 18313                                  
 18314                                  ; 16/10/2022
 18315                                  
 18316                                  ;---------------------------------------------------------------------------
 18317                                  ;  ask to swap the disk in drive a:
 18318                                  ;	es:di -> bds
 18319                                  ;	ds -> Bios_Data
 18320                                  ;---------------------------------------------------------------------------
 18321                                  
 18322                                  		; 26/12/2023 - Retro DOS v5.0
 18323                                  
 18324                                  		; 19/10/2022
 18325 00001AA1 F606[1208]01            swpdsk:		test	byte [IsWin386], 1
 18326                                  		;test	ds:IsWin386, 1	; Is win386 present?
 18327 00001AA6 7405                    		jz	short no_win386	; no, skip SetFocus
 18328                                  		
 18329                                  		; set focus to the correct VM
 18330                                  		;call	far ptr 70h:813h ; PCDOS 7.1 IBMBIO.COM BIOSCODE:1B2Ch
 18331                                  		;;call	far 70h:8D1h	; MSDOS 6.21 IO.SYS BIOSCODE:179Ah
 18332                                  		; 17/10/2022
 18333 00001AA8 9A[1308]7000            		call	DOSBIOSSEG:V86_Crit_SetFocus ; BIOSDATA:V86_Crit_SetFocus
 18334                                  		;call	far ptr	V86_Crit_SetFocus ; call far 70h:8D1h
 18335                                  					; call far KERNEL_SEGMENT:V86_Crit_SetFocus
 18336                                  no_win386:
 18337 00001AAD 51                      		push	cx
 18338 00001AAE 52                      		push	dx
 18339 00001AAF 268A5505                		mov	dl, [es:di+5]	; [es:di+BDS.drivelet]
 18340                                  					; get the drive	letter
 18341                                  
 18342                                  ; WARNING : next two instructions assume that if the new disk is for drive B
 18343                                  ;           then existing dsk is drive A & vice versa
 18344                                  
 18345 00001AB3 88D6                    		mov	dh, dl
 18346 00001AB5 80F601                  		xor	dh, 1
 18347 00001AB8 29C9                    		sub	cx, cx		; nobody has handled swap disk
 18348 00001ABA B8004A                  		mov	ax, 4A00h	; multMULT<<8)|multMULTSWPDSK
 18349                                  					; broad	cast code for swap disk
 18350                                  					; Broadcast it
 18351 00001ABD CD2F                    		int	2Fh
 18352 00001ABF 41                      		inc	cx		; cx == -1 ?
 18353 00001AC0 741E                    		jz	short swpdsk9	; somebody has handled it
 18354                                  
 18355                                  ; using a different drive in a one drive system so request the user change disks
 18356                                  
 18357 00001AC2 80C241                  		add	dl, 'A'
 18358                                  		; 17/10/2022
 18359 00001AC5 2E8816[FF1A]            		mov	[cs:DRVLET], dl	; "A: and press any key when ready\r\n\n"
 18360                                  		; 16/10/2022
 18361                                  		;;mov	byte [cs:drvlet], dl
 18362                                  		;mov	byte ptr cs:17E4h, dl ; [cs:drvlet]
 18363                                  					; 0070h:3D54h =	2C7h:17E4h
 18364 00001ACA BE[E31A]                		mov	si, SNGMSG	; "\r\nInsert diskette for drive "
 18365                                  		;mov	si, 17C8h	; sngmsg
 18366                                  					; 0070h:3D38h =	2C7h:17C8h
 18367 00001ACD 53                      		push	bx
 18368 00001ACE 2E                      		cs
 18369 00001ACF AC                      		lodsb			; get the next character of the message
 18370                                  		;lods	byte ptr cs:[si]
 18371                                  wrmsg_loop:
 18372 00001AD0 CD29                    		int	29h		; DOS 2+ internal - FAST PUTCHAR
 18373                                  					; AL = character to display
 18374 00001AD2 2E                      		cs
 18375 00001AD3 AC                      		lodsb
 18376                                  		;lods	byte ptr cs:[si] ; cs lodsb
 18377                                  					; get the next character of the	message
 18378 00001AD4 08C0                    		or	al, al
 18379 00001AD6 75F8                    		jnz	short wrmsg_loop
 18380 00001AD8 E82DE7                  		call	con_flush	; flush out keyboard queue
 18381                                  					; call rom-bios
 18382 00001ADB 30E4                    		xor	ah, ah
 18383 00001ADD CD16                    		int	16h		; KEYBOARD - READ CHAR FROM BUFFER, WAIT IF EMPTY
 18384                                  					; Return: AH = scan code, AL = character
 18385 00001ADF 5B                      		pop	bx
 18386                                  swpdsk9:
 18387 00001AE0 5A                      		pop	dx
 18388 00001AE1 59                      		pop	cx
 18389 00001AE2 C3                      		retn
 18390                                  
 18391                                  ; ---------------------------------------------------------------------------
 18392                                  
 18393                                  ; 16/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 18394                                  
 18395                                  ;--------------------------------------------------------
 18396                                  ; include msbio.cl2 (MSDOS 6.0, 1991)
 18397                                  ;--------------------------------------------------------
 18398                                  ; (MSDOS 6.21 IO.SYS BIOSCODE:17D5h)
 18399                                  ;--------------------------------------------------------
 18400                                  ; 17/03/2019 - Retro DOS v4.0
 18401                                  ; 26/12/2023 - Retro DOS v5.0
 18402                                  
 18403                                  		; MSDOS 5.0 IO.SYS offset 0070h:3D38h or 02C7h:17C8h
 18404                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:1B67h
 18405 00001AE3 0D0A                    sngmsg:		db 0Dh,0Ah
 18406 00001AE5 496E73657274206469-     		db 'Insert diskette for drive '
 18406 00001AEE 736B6574746520666F-
 18406 00001AF7 7220647269766520   
 18407                                  
 18408                                  		; MSDOS 5.0 IO.SYS offset 0070h:3D54h or 02C7h:17E4h
 18409                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:1B83h
 18410 00001AFF 413A20616E64207072-     drvlet:		db 'A: and press any key when ready',0Dh,0Ah
 18410 00001B08 65737320616E79206B-
 18410 00001B11 6579207768656E2072-
 18410 00001B1A 656164790D0A       
 18411 00001B20 0A00                    		db 0Ah,0
 18412                                  
 18413                                  ; =============== S U B	R O U T	I N E =======================================
 18414                                  
 18415                                  ;---------------------------------------------------------------------------
 18416                                  ; input : es:di points to current bds for drive.
 18417                                  ; return : zero set if no open files
 18418                                  ;	   zero reset if open files
 18419                                  ;---------------------------------------------------------------------------
 18420                                  
 18421                                  		; 26/12/2023 - Retro DOS v5.0
 18422                                  chkopcnt:	
 18423 00001B22 26837D3C00              		cmp     word [es:di+3Ch], 0
 18424                                  		;cmp	word [es:di+20h], 0 ; [es:di+BDS.opcnt]
 18425 00001B27 C3                      		retn
 18426                                  
 18427                                  ; =============== S U B	R O U T	I N E =======================================
 18428                                  
 18429                                  ;---------------------------------------------------------------------------
 18430                                  ; at media check time, we need to really get down and check what the change is.
 18431                                  ; this is guaranteed to be expensive.
 18432                                  ;
 18433                                  ;	es:di -> bds, ds -> Bios_Data
 18434                                  ;---------------------------------------------------------------------------
 18435                                  
 18436                                  		; 26/12/2023 - Retro DOS v5.0
 18437                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:1BA6h
 18438                                  mediacheck:
 18439 00001B28 E84EEE                  		call	checksingle	; make sure correct disk is in place
 18440 00001B2B 31F6                    		xor	si, si
 18441 00001B2D E86101                  		call	haschange
 18442 00001B30 742F                    		jz	short mediaret
 18443                                  		; 26/12/2023
 18444                                  		;test	byte [es:di+3Fh], 40h ; [es:di+BDS.flags], fchanged ; 40h
 18445 00001B32 E85001                  		call	checkromchange
 18446 00001B35 752B                    		jnz	short mediadovolid
 18447 00001B37 50                      		push	ax
 18448 00001B38 52                      		push	dx
 18449 00001B39 268A5504                		mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 18450                                  					; set logical drive number
 18451 00001B3D B416                    		mov	ah, 16h
 18452 00001B3F CD13                    		int	13h		; DISK - FLOPPY	DISK - CHANGE OF DISK STATUS (AT,XT2,XT286,CONV,PS)
 18453                                  					; DL = drive to	check
 18454                                  					; Return: AH = disk change status
 18455 00001B41 5A                      		pop	dx
 18456 00001B42 58                      		pop	ax
 18457 00001B43 721D                    		jb	short mediadovolid
 18458 00001B45 BE0100                  		mov	si, 1		; signal no change
 18459                                  
 18460                                  ; there are some drives with changeline that "lose" the changeline indication
 18461                                  ; if a different drive is accessed after the current one. in order to avoid
 18462                                  ; missing a media change, we return an "i don't know" to dos if the changeline
 18463                                  ; is not active and we are accessing a different drive from the last one.
 18464                                  ; if we are accessing the same drive, then we can safely rely on the changeline
 18465                                  ; status.
 18466                                  		; 19/10/2022
 18467 00001B48 8A1E[1E01]              		mov	bl, [tim_drv]	; get last drive accessed
 18468 00001B4C 26385D04                		cmp	[es:di+4], bl	; [es:di+BDS.drivenum]
 18469                                  					; (If the last drive accessed is not current drive
 18470                                  					; media	change status may be incorrect.	So,
 18471                                  					; "I don't now" will be returned even if it is indicated
 18472                                  					; as media is not changed.)
 18473 00001B50 740F                    		jz	short mediaret	; (same	drive,
 18474                                  					; media	changeline indication is reliable)
 18475                                  
 18476                                  ; do the 2 second twiddle. if time >= 2 seconds, do a volid check.
 18477                                  ; otherwise return "i don't know" (strictly speaking, we should return a
 18478                                  ; "not changed" here since the 2 second test said no change.)
 18479                                  
 18480 00001B52 50                      		push	ax
 18481 00001B53 51                      		push	cx
 18482 00001B54 52                      		push	dx
 18483 00001B55 E8D2EA                  		call	Check_Time_Of_Access
 18484 00001B58 5A                      		pop	dx
 18485 00001B59 59                      		pop	cx
 18486 00001B5A 58                      		pop	ax
 18487 00001B5B 09F6                    		or	si, si
 18488 00001B5D 7403                    		jz	short mediadovolid ; check_time	says ">= 2 secs	passed"
 18489                                  					; (volume id will be checked)
 18490 00001B5F 31F6                    		xor	si, si		; return "i don't know"
 18491                                  mediaret:
 18492 00001B61 C3                      		retn
 18493                                  ; ---------------------------------------------------------------------------
 18494                                  
 18495                                  ; somehow the media was changed. look at vid to see. we do not look at fat
 18496                                  ; because this may be different since we only set medbyt when doing a read
 18497                                  ; or write.
 18498                                  
 18499                                  mediadovolid:
 18500 00001B62 E871EB                  		call	GetBp		; build	a new bpb in current bds
 18501 00001B65 72FA                    		jb	short mediaret
 18502 00001B67 E82D00                  		call	check_vid
 18503 00001B6A 73F5                    		jnb	short mediaret
 18504 00001B6C E93BF2                  		jmp	maperror	; fix up al for	return to dos
 18505                                  ; ---------------------------------------------------------------------------
 18506                                  
 18507                                  ; simple, quick check of latched change. if no indication, then return
 18508                                  ; otherwise do expensive check. if the expensive test fails, pop off the
 18509                                  ; return and set al = 15 (for invalid media change) which will be returned to
 18510                                  ; dos.
 18511                                  ;
 18512                                  ; for dos 3.3, this will work only for the drive that has changeline.
 18513                                  
 18514                                  ;	call with es:di -> bds, ds -> Bios_Data
 18515                                  ;	***** warning:  this routine will return one level up on the stack
 18516                                  ;			if an error occurs!
 18517                                  
 18518                                  checklatchio:
 18519                                  
 18520                                  ; if returning fake bpb then assume the disk has not changed
 18521                                  
 18522                                  		; 26/12/2023
 18523                                  		;cmp	word [es:di+3Ch], 0 ; [es:di+BDS.opcnt]	
 18524 00001B6F E8B0FF                  		call	chkopcnt
 18525 00001B72 741B                    		jz	short checkret	; done if zero
 18526                                  
 18527                                  ; check for past rom indications. if no rom change indicated, then return ok.
 18528                                  
 18529                                  		; 26/12/2023
 18530                                  		;test	word [es:di+3Fh], 40h
 18531                                  		;			; test [es:di+BDS.flags], fchanged ; 40h
 18532 00001B74 E80E01                  		call	checkromchange
 18533 00001B77 7416                    		jz	short checkret
 18534                                  
 18535                                  ; we now see that a change line has been seen in the past. let's do the
 18536                                  ; expensive verification.
 18537                                  
 18538 00001B79 E85AEB                  		call	GetBp		; build	bpb in current bds
 18539 00001B7C 720F                    		jb	short ret_no_error_map ; getbp has already called maperror
 18540 00001B7E E81600                  		call	check_vid
 18541 00001B81 7207                    		jb	short checklatchret ; disk error trying	to read	in.
 18542 00001B83 09F6                    		or	si, si		; is changed for sure?
 18543 00001B85 7908                    		jns	short checkret
 18544 00001B87 E88F00                  		call	returnvid
 18545                                  checklatchret:
 18546 00001B8A E81DF2                  		call	maperror	; fix up al for	return to dos
 18547                                  ret_no_error_map:
 18548 00001B8D F9                      		stc
 18549 00001B8E 5E                      		pop	si		; pop off return address
 18550                                  checkret:
 18551 00001B8F C3                      		retn
 18552                                  ; ---------------------------------------------------------------------------
 18553                                  
 18554                                  ; check the fat and the vid. return in di -1 or 0. return with carry set
 18555                                  ; only if there was a disk error. return that error code in ax.
 18556                                  ;
 18557                                  ;	called with es:di -> bds, ds -> Bios_Data
 18558                                  
 18559                                  checkfatvid:
 18560 00001B90 E8D101                  		call	fat_check	; check	the fat	and the	vid
 18561 00001B93 09F6                    		or	si, si
 18562 00001B95 7835                    		js	short changed_drv
 18563                                  
 18564                                  ; the fat was the same. fall into check_vid and check volume id.
 18565                                  
 18566                                  		; fall into check_vid
 18567                                  
 18568                                  ; =============== S U B	R O U T	I N E =======================================
 18569                                  
 18570                                  ; now with the extended boot record, the logic should be enhanced.
 18571                                  ;
 18572                                  ; if it is the extended boot record, then we check the volume serial
 18573                                  ; number instead of volume id. if it is different, then set si to -1.
 18574                                  ;
 18575                                  ; if it is same, then si= 1 (no change).
 18576                                  ;
 18577                                  ; if it is not the extended boot record, then just follows the old
 18578                                  ; logic. dos 4.00 will check if the # of fat in the boot record bpb
 18579                                  ; is not 0.  if it is 0 then it must be non_fat based system and
 18580                                  ; should have already covered by extended boot structure checking.
 18581                                  ; so, we will return "i don't know" by setting si to 0.
 18582                                  ;
 18583                                  ; this routine assume the newest valid boot record is in cs:[disksector].
 18584                                  ; (this will be gauranteed by a successful getbp call right before this
 18585                                  ; routine.)
 18586                                  ;
 18587                                  ;	called with es:di -> bds, ds -> bds
 18588                                  
 18589                                  		; 26/12/2023 - Retro DOS v5.0
 18590                                  		; 19/10/2022
 18591                                  check_vid:
 18592                                  
 18593                                  ; check the disksector.EXT_BOOT_SIG variable for the extended
 18594                                  ; boot signature. if it is set then go to do the extended
 18595                                  ; id check otherwise continue with code below
 18596                                  
 18597                                  		; 26/12/2023
 18598                                  		;;;
 18599 00001B97 833E[6801]00            		cmp	word  [disksector+16h], 0 ; BPB_FATSz16
 18600 00001B9C 7507                    		jnz     short chk_vid_1
 18601 00001B9E 803E[9401]29            		cmp     byte [disksector+42h], 29h ; BS_FAT32_BootSig
 18602                                  					; [disksector+EXT_BOOT.SIG],EXT_BOOT_SIGNATURE
 18603 00001BA3 EB05                    		jmp     short chk_vid_2
 18604                                  chk_vid_1:
 18605                                  		;;;
 18606 00001BA5 803E[7801]29            		cmp	byte [disksector+26h], 29h
 18607                                  					; [disksector+EXT_BOOT.SIG],
 18608                                  					; EXT_BOOT_SIGNATURE
 18609                                  chk_vid_2:		; 26/12/2023
 18610 00001BAA 7427                    		jz	short do_ext_check_id
 18611 00001BAC E8E200                  		call	haschange
 18612 00001BAF 74DE                    		jz	short checkret
 18613 00001BB1 31F6                    		xor	si, si
 18614 00001BB3 803E[6201]00            		cmp	byte [disksector+10h], 0 ; BPB_NumFATs
 18615                                  					; [disksector+EXT_BOOT.BPB+EBPB.NUMBEROFFATS]
 18616 00001BB8 7411                    		jz	short checkfatret ; don't read vol id
 18617                                  					; if not fat system
 18618 00001BBA E8F400                  		call	read_volume_id
 18619 00001BBD 720C                    		jb	short checkfatret
 18620 00001BBF E89901                  		call	check_volume_id
 18621 00001BC2 BEFFFF                  		mov	si, 0FFFFh	; -1
 18622                                  					; definitely changed
 18623 00001BC5 7505                    		jnz	short changed_drv
 18624                                  
 18625 00001BC7 46                      		inc	si		; not changed
 18626                                  vid_no_changed:
 18627 00001BC8 E8C000                  		call	resetchanged
 18628                                  		; 12/12/2022
 18629                                  		; cf=0 ('and' instruction in 'resetchanged' clears cf) 
 18630                                  		;clc
 18631                                  checkfatret:
 18632 00001BCB C3                      		retn
 18633                                  ; ---------------------------------------------------------------------------
 18634                                  
 18635                                  		; 12/12/2022
 18636                                  changed_drv:
 18637 00001BCC F8                      		clc			; cas -- return	no error
 18638 00001BCD C606[1E01]FF            		mov	byte  [tim_drv], 0FFh 
 18639                                  					; ensure that we ask rom for media
 18640 00001BD2 C3                      		retn			; check	next time round
 18641                                  ; ---------------------------------------------------------------------------
 18642                                  
 18643                                  ; extended id check
 18644                                  
 18645                                  ; 16/10/2022
 18646                                  
 18647                                  ; the code to check extended id is basically a check to see if the
 18648                                  ; volume serial number is still the same. the volume serial number
 18649                                  ; previously read is in cs:disksector.EXT_BOOT_SERIAL
 18650                                  ; ds:di points to the bds of the drive under consideration.
 18651                                  ; the bds has fields containing the high and low words 
 18652                                  ; of the volume serial number of the media in the drive.
 18653                                  ; compare these fields to the fields mentioned above. if these fields
 18654                                  ; do not match the media has changed and so we should jump to the code
 18655                                  ; starting at ext_changed else return "i don't know" status
 18656                                  ; in the register used for the changeline status and continue executing
 18657                                  ; the code given below. for temporary storage use the register which
 18658                                  ; has been saved and restored around this block.
 18659                                  ;
 18660                                  ; bds fields in inc\msbds.inc
 18661                                  
 18662                                  		; 26/12/2023 - Retro DOS v5.0
 18663                                  		; 19/10/2022
 18664                                  do_ext_check_id:
 18665                                  		; 26/12/2023
 18666                                  		;push	ax
 18667                                  		;;mov	ax, word ptr ds:disksector+27h
 18668                                  		;			; [DiskSector+EXT_BOOT.SERIAL]
 18669                                  		;mov	ax, [disksector+27h]
 18670                                  ; 26/12/2023
 18671                                  %if 1
 18672                                  		;;;
 18673 00001BD3 57                      		push	di
 18674 00001BD4 BE[9501]                		mov	si, disksector+43h ; BS_FAT32_VolID
 18675                                  					; [DiskSector+FAT32_EXT_BOOT.SERIAL]
 18676 00001BD7 833E[6801]00            		cmp	word [disksector+16h], 0 ; BPB_FATSz16
 18677 00001BDC 7403                    		jz	short chk_vid_3
 18678 00001BDE 83EE1C                  		sub	si, 28		; BS_VolID
 18679                                  		; si = disksector+27h	; [DiskSector+EXT_BOOT.SERIAL]
 18680                                  chk_vid_3:
 18681                                  		; [es:di+89h] = [es:di+BDS.vol_serial]
 18682 00001BE1 81C78900                		add	di, 137		; BDS.vol_serial
 18683 00001BE5 A7                      		cmpsw	; [DiskSector+EXT_BOOT.SERIAL] ; (or FAT32_EXT_BOOT)
 18684                                  			;		= [di+BDS.vol_serial] ?
 18685 00001BE6 7501                    		jnz	short chk_vid_4
 18686 00001BE8 A7                      		cmpsw	; [DiskSector+EXT_BOOT.SERIAL+2] ; (or FAT32_EXT_BOOT)
 18687                                  			;		= [di+BDS.vol_serial+2] ?
 18688                                  chk_vid_4:
 18689 00001BE9 5F                      		pop	di
 18690                                  		;pop	ax
 18691 00001BEA 7504                    		jnz	short ext_changed ; not equal/same
 18692 00001BEC 31F6                    		xor	si, si 		 ; 0 ; don't know
 18693 00001BEE EBD8                    		jmp	short vid_no_changed ; reset the flag
 18694                                  		;;;
 18695                                  %else
 18696                                  		; 02/09/2023
 18697                                  		xor	si, si ; 0
 18698                                  		cmp	ax, [es:di+57h]	; [di+BDS.vol_serial]
 18699                                  		jnz	short ext_changed
 18700                                  		mov	ax, [disksector+29h] ; [DiskSector+EXT_BOOT.SERIAL+2]
 18701                                  		cmp	ax, [es:di+59h]	; [di+BDS.vol_serial+2]
 18702                                  		jnz	short ext_changed
 18703                                  		;xor	si, si		; 0
 18704                                  					; don't know
 18705                                  		pop	ax
 18706                                  		jmp	short vid_no_changed
 18707                                  					; reset the flag
 18708                                  %endif
 18709                                  
 18710                                  ; ---------------------------------------------------------------------------
 18711                                  
 18712                                  ext_changed:
 18713                                  		; 26/12/2023
 18714                                  		;pop	ax
 18715                                  		; 02/09/2023
 18716                                  		;dec	si ; mov si, 0FFFFh ; -1
 18717 00001BF0 BEFFFF                  		mov	si, 0FFFFh	; -1
 18718                                  					; disk changed!
 18719                                  		; 12/12/2022
 18720                                  		; ('changed_drv' clears cf)
 18721                                  		;clc
 18722 00001BF3 EBD7                    		jmp	short changed_drv
 18723                                  
 18724                                  ; ---------------------------------------------------------------------------
 18725                                  
 18726                                  ; at i/o time, we detected the error. now we need to determine whether the
 18727                                  ; media was truly changed or not. we return normally if media change unknown.
 18728                                  ; and we pop off the call and jmp to harderr if we see an error.
 18729                                  ;
 18730                                  ; es:di -> bds
 18731                                  
 18732                                  checkio:
 18733 00001BF5 80FC06                  		cmp	ah, 6
 18734 00001BF8 75D1                    		jnz	short checkfatret
 18735                                  		; 26/12/2023 - Retro DOS v5.0
 18736                                  		;cmp	word [es:di+3Ch], 0 ; [es:di+BDS.opcnt]
 18737 00001BFA E825FF                  		call	chkopcnt
 18738 00001BFD 74CC                    		jz	short checkfatret
 18739 00001BFF E8D4EA                  		call	GetBp
 18740 00001C02 7212                    		jb	short no_error_map
 18741 00001C04 E889FF                  		call	checkfatvid
 18742 00001C07 7209                    		jb	short checkioret ; disk	error trying to	read in.
 18743 00001C09 09F6                    		or	si, si		; is changed for sure?
 18744 00001C0B 7802                    		js	short checkioerr ; yes changed
 18745 00001C0D 45                      		inc	bp		; allow	a retry
 18746 00001C0E C3                      		retn
 18747                                  ; ---------------------------------------------------------------------------
 18748                                  
 18749                                  checkioerr:
 18750 00001C0F E80700                  		call	returnvid
 18751                                  
 18752                                  checkioret:
 18753 00001C12 F9                      		stc			; make sure carry gets passed through
 18754 00001C13 E950F1                  		jmp	harderr
 18755                                  ; ---------------------------------------------------------------------------
 18756                                  
 18757                                  no_error_map:				
 18758 00001C16 E950F1                  		jmp	harderr2
 18759                                  
 18760                                  ; =============== S U B	R O U T	I N E =======================================
 18761                                  
 18762                                  ; return vid sets up the vid for a return to dos.
 18763                                  ;  es:di -> bds, returns pointer in packet to bds_volid
 18764                                  ;  **** trashes si! ****
 18765                                  
 18766                                  returnvid:
 18767 00001C19 BE1600                  		mov	si, 22		; extra
 18768                                  					; offset into pointer to return	value
 18769 00001C1C E80700                  		call	vid_into_packet
 18770 00001C1F B406                    		mov	ah, 6
 18771 00001C21 F9                      		stc
 18772 00001C22 C3                      		retn
 18773                                  
 18774                                  ; ---------------------------------------------------------------------------
 18775                                  
 18776                                  ; moves the pointer to the volid for the drive into the original request packet
 18777                                  ; no attempt is made to preserve registers.
 18778                                  ;
 18779                                  ; assumes es:di -> bds
 18780                                  ; **trashes si**
 18781                                  
 18782                                  media_set_vid:
 18783 00001C23 BE0F00                  		mov	si, 15		; trans+1
 18784                                  					; return the value here	in packet
 18785                                  
 18786                                  		; fall into vid_into_packet
 18787                                  
 18788                                  ; =============== S U B	R O U T	I N E =======================================
 18789                                  
 18790                                  ; return pointer to vid in bds at es:di in packet[si]
 18791                                  
 18792                                  		; 26/12/2023 - Retro DOS v5.0
 18793                                  		; 19/10/2022
 18794                                  vid_into_packet:
 18795 00001C26 1E                      		push	ds		; return pointer to vid	in bds at es:di	in packet[si]
 18796 00001C27 C51E[1200]              		lds	bx, [ptrsav]
 18797                                  		; 26/12/2023
 18798 00001C2B 83C77D                  		add	di, 125         ; BDS.volid (BDS offset 125)
 18799                                  		;add	di, 75		; BDS.volid
 18800 00001C2E 8938                    		mov	[bx+si], di
 18801 00001C30 83EF7D                  		sub     di, 125         ; BDS start (BDS offset 0)
 18802                                  		;sub	di, 75		
 18803 00001C33 8C4002                  		mov	[bx+si+2], es
 18804 00001C36 1F                      		pop	ds
 18805                                  dofloppy:	; 18/12/2022
 18806 00001C37 C3                      		retn
 18807                                  
 18808                                  ; ---------------------------------------------------------------------------
 18809                                  
 18810                                  ;----------------------------------------------------------------------------
 18811                                  ;   hidensity - examine a drive/media descriptor to set the media type. if
 18812                                  ;   the media descriptor is not f9 (not 96tpi or 3 1/2), we return and let the
 18813                                  ;   caller do the rest. otherwise, we pop off the return and jump to the tail
 18814                                  ;   of getbp. for 3.5" media, we just return.
 18815                                  ;
 18816                                  ;   inputs:	es:di point to correct bds for this drive
 18817                                  ;		ah has media byte
 18818                                  ;
 18819                                  ;   outputs:	carry clear
 18820                                  ;		    no registers modified
 18821                                  ;		carry set
 18822                                  ;		    al = sectors/fat
 18823                                  ;		    bh = number of root directory entries
 18824                                  ;		    bl = sectors per track
 18825                                  ;		    cx = number of sectors
 18826                                  ;		    dh = sectors per allocation unit
 18827                                  ;		    dl = number of heads
 18828                                  ;
 18829                                  ;----------------------------------------------------------------------------
 18830                                  
 18831                                  		; 26/12/2023 - Retro DOS v5.0
 18832                                  hidensity:
 18833                                  
 18834                                  ; check for correct drive
 18835                                  		
 18836                                  		; 26/12/2023
 18837 00001C38 26F6453F02              		test	byte [es:di+3Fh], 2 ; is it special?
 18838                                  		; 12/12/2022
 18839                                  		;test	byte [es:di+23h], 2
 18840                                  		;;test	word [es:di+23h], 2 ; is it special?
 18841                                  					; [es:di+BDS.flags], fchangeline
 18842 00001C3D 74F8                    		jz	short dofloppy	; no, do normal floppy test
 18843                                  
 18844                                  ; we have a media byte that is pretty complex. examine drive information
 18845                                  ; table to see what kind it is.
 18846                                  
 18847                                  		; 26/12/2023
 18848 00001C3F 26807D3E02              		cmp	byte [es:di+3Eh], 2 ; is it single-media?
 18849                                  		;cmp	byte [es:di+22h], 2 ; is it single-media?
 18850 00001C44 74F1                    		jz	short dofloppy	; [es:di+BDS.formfactor], ffSmall
 18851                                  					; yes, use fatid...
 18852                                  ; 96 tpi drive?
 18853 00001C46 80FCF9                  		cmp	ah, 0F9h
 18854 00001C49 75EC                    		jnz	short dofloppy
 18855                                  
 18856                                  ;------ If formfactor of drive = ffother or ff288 it has to be
 18857                                  ;------ a 720K diskette
 18858                                  
 18859                                  		; 02/09/2023 (PCDOS 7.1)
 18860                                  		; 26/12/2023
 18861 00001C4B 268A453E                		mov	al, [es:di+3Eh] ; [es:di+BDS.formfactor]
 18862                                  		;mov	al, [es:di+22h]	; [es:di+BDS.formfactor]
 18863 00001C4F 3C07                    		cmp	al, 7
 18864                                  		;cmp	byte [es:di+22h], 7 ; [es:di+BDS.formfactor]
 18865                                  					; ffOther
 18866 00001C51 7413                    		jz	short Is720K
 18867 00001C53 3C09                    		cmp	al, 9
 18868                                  		;cmp	byte [es:di+22h], 9 ; [es:di+BDS.formfactor]
 18869                                  					; ff288
 18870 00001C55 740F                    		jz	short Is720K
 18871 00001C57 B007                    		mov	al, 7		; seven	sectors	/ fat
 18872 00001C59 BB0FE0                  		mov	bx, 57359	; 224*256+0Fh
 18873                                  					; 224 root dir entries
 18874                                  					; & 0Fh sector max
 18875 00001C5C B96009                  		mov	cx, 2400	; 80*15*2
 18876                                  					; 80 tracks, 15 sectors/track,
 18877                                  					; 2 sides
 18878                                  		; 02/09/2023
 18879 00001C5F 5A                      		pop	dx		; pop off return address
 18880 00001C60 BA0201                  		mov	dx, 258		; 1*256+2
 18881                                  					; sectors/allocation unit
 18882                                  					; & head max
 18883                                  		;add	sp, 2		; pop off return address
 18884 00001C63 E9E7EA                  		jmp	Has1		; return to tail of getbp
 18885                                  ; ---------------------------------------------------------------------------
 18886                                  
 18887                                  Is720K:
 18888                                  		; 02/09/2023
 18889 00001C66 5B                      		pop	bx		; pop off return address
 18890                                  		;add	sp, 2		; pop off return address
 18891 00001C67 E9A3EA                  		jmp	Has720K		; return to 720K code
 18892                                  ; ---------------------------------------------------------------------------
 18893                                  
 18894                                  		; 18/12/2022
 18895                                  ;dofloppy:
 18896                                  		;retn
 18897                                  
 18898                                  ; =============== S U B	R O U T	I N E =======================================
 18899                                  
 18900                                  ; 16/10/2022
 18901                                  
 18902                                  ;---------------------------------------------------------------------------
 18903                                  ; set_changed_dl - sets flag bits according to bits set in bx.
 18904                                  ;		   essentially used to indicate changeline, or format.
 18905                                  ;
 18906                                  ;   inputs:	dl contains physical drive number
 18907                                  ;		bx contains bits to set in the flag field in the bdss
 18908                                  ;   outputs:	none
 18909                                  ;   registers modified: flags
 18910                                  ;
 18911                                  ;	called from int13 hooker.  Must preserve ALL registers!!!
 18912                                  ;
 18913                                  ; in the virtual drive system we *must* flag the other drives as being changed
 18914                                  ;---------------------------------------------------------------------------
 18915                                  
 18916                                  		; 26/12/2023 - Retro DOS v5.0
 18917                                  set_changed_dl:	
 18918 00001C6A 06                      		push	es
 18919 00001C6B 57                      		push	di
 18920                                  		;les	di, ds:start_bds
 18921                                  		; 19/10/2022
 18922 00001C6C C43E[1901]              		les	di, [start_bds]
 18923                                  
 18924                                  ; note: we assume that the list is non-empty
 18925                                  
 18926                                  scan_bds:
 18927 00001C70 26385504                		cmp	[es:di+4], dl	; [es:di+BDS.drivenum]
 18928 00001C74 7504                    		jnz	short get_next_bds
 18929                                  
 18930                                  ; someone may complain, but this *always* must be done when a disk change is
 18931                                  ; noted. there are *no* other compromising circumstances.
 18932                                  
 18933                                  		; 26/12/2023
 18934 00001C76 26095D3F                		or	[es:di+3Fh], bx	; [es:di+BDS.flags]
 18935                                  		;or	[es:di+23h], bx	; [es:di+BDS.flags]
 18936                                  					; signal change	on other drive
 18937                                  get_next_bds:
 18938 00001C7A 26C43D                  		les	di, [es:di]	; [es:di+BDS.link]
 18939                                  					; go to	next bds
 18940 00001C7D 83FFFF                  		cmp	di, 0FFFFh
 18941 00001C80 75EE                    		jnz	short scan_bds	; loop unless we hit end of chain
 18942 00001C82 5F                      		pop	di
 18943 00001C83 07                      		pop	es
 18944 00001C84 C3                      		retn
 18945                                  
 18946                                  ; =============== S U B	R O U T	I N E =======================================
 18947                                  
 18948                                  ;---------------------------------------------------------------------------
 18949                                  ; checkromchange - see if external program has diddled rom change line.
 18950                                  ;
 18951                                  ;   inputs:	es:di points to current bds.
 18952                                  ;   outputs:	zero set - no change
 18953                                  ;		zero reset - change
 18954                                  ;   registers modified: none
 18955                                  ;---------------------------------------------------------------------------
 18956                                  
 18957                                  		; 26/12/2023 - Retro DOS v5.0
 18958                                  checkromchange:	
 18959                                  		;test	word [es:di+BDS.flags], fchanged ; 40h
 18960                                  		; 26/12/2023
 18961 00001C85 26F6453F40              		test	byte [es:di+3Fh], 40h
 18962                                  		; 10/12/2022
 18963                                  		;test	byte [es:di+23h], 40h
 18964                                  		;;test	word [es:di+23h], 40h ; [es:di+BDS.flags]
 18965                                  					; fchanged
 18966 00001C8A C3                      		retn
 18967                                  
 18968                                  ; =============== S U B	R O U T	I N E =======================================
 18969                                  
 18970                                  ;---------------------------------------------------------------------------
 18971                                  ; resetchanged - restore value of change line
 18972                                  ;
 18973                                  ;   inputs:	es:di points to current bds
 18974                                  ;   outputs:	none
 18975                                  ;   registers modified: none
 18976                                  ;---------------------------------------------------------------------------
 18977                                  
 18978                                  		; 26/12/2023 - Retro DOS v5.0
 18979                                  resetchanged:
 18980                                  		;and	word [es:di+BDS.flags], ~fchanged ; 0FFBFh
 18981                                  		; 26/12/2023
 18982 00001C8B 2680653FBF              		and	byte [es:di+3Fh], 0BFh
 18983                                  		; 10/12/2022
 18984                                  		;and	byte [es:di+23h], 0BFh
 18985                                  		;;and	word [es:di+23h], 0FFBFh ; [es:di+BDS.flags]
 18986                                  					; ~fchanged
 18987 00001C90 C3                      		retn
 18988                                  
 18989                                  ; =============== S U B	R O U T	I N E =======================================
 18990                                  
 18991                                  ;---------------------------------------------------------------------------
 18992                                  ; haschange - see if drive can supply change line
 18993                                  ;
 18994                                  ;   inputs:	es:di points to current bds
 18995                                  ;   outputs:	zero set - no change line available
 18996                                  ;		zero reset - change line available
 18997                                  ;   registers modified: none
 18998                                  ;---------------------------------------------------------------------------
 18999                                  
 19000                                  		; 26/12/2023 - Retro DOS v5.0
 19001                                  haschange:
 19002                                  		;test	word [es:di+BDS.flags], fchangeline ; 2
 19003                                  		; 26/12/2023
 19004 00001C91 26F6453F02              		test	byte [es:di+3Fh], 2
 19005                                  		; 10/12/2022
 19006                                  		;test	byte [es:di+23h], 2
 19007                                  		;;test	word [es:di+23h], 2 ; [es:di+BDS.flags]
 19008                                  					; fchangeline
 19009 00001C96 C3                      		retn
 19010                                  
 19011                                  ; ---------------------------------------------------------------------------
 19012                                  
 19013                                  ; 16/10/2022
 19014                                  
 19015                                  ;-------------------------------------------------------------------------
 19016                                  ; set_volume_id      -	main routine, calls other routines.
 19017                                  ; read_volume_id     -	read the volume id and tells if it has been changed.
 19018                                  ; transfer_volume_id -	copy the volume id from tmp to special drive.
 19019                                  ; check_volume_id    -	compare volume id in tmp area with one expected for drive.
 19020                                  ; fat_check          -	see of the fatid has changed in the specified drive.
 19021                                  ;-------------------------------------------------------------------------
 19022                                  
 19023                                  ; set_volume_id
 19024                                  ;   if drive has changeline support, read in and set the volume_id
 19025                                  ; and the last fat_id byte. if no change line support then do nothing.
 19026                                  ;
 19027                                  ;   on entry:
 19028                                  ;	es:di points to the bds for this disk.
 19029                                  ;	ah contains media byte
 19030                                  ;
 19031                                  ;   on exit:
 19032                                  ;	carry clear:
 19033                                  ;	   successful call
 19034                                  ;	carry set
 19035                                  ;	   error and ax has error code
 19036                                  
 19037                                  set_volume_id:
 19038 00001C97 52                      		push	dx		; save registers
 19039 00001C98 50                      		push	ax
 19040 00001C99 E8F5FF                  		call	haschange	; does drive have changeline support?
 19041 00001C9C 740B                    		jz	short setvret	; no, get out
 19042 00001C9E E81000                  		call	read_volume_id
 19043 00001CA1 7209                    		jb	short seterr
 19044 00001CA3 E8A900                  		call	transfer_volume_id ; copy the volume id	to special drive
 19045 00001CA6 E8E2FF                  		call	resetchanged	; restore value	of change line
 19046                                  setvret:				
 19047                                  		; 10/12/2022
 19048                                  		; cf = 0
 19049                                  		;clc			; no error, clear carry flag
 19050 00001CA9 58                      		pop	ax		; restore registers
 19051 00001CAA 5A                      		pop	dx
 19052 00001CAB C3                      		retn
 19053                                  ; ---------------------------------------------------------------------------
 19054                                  
 19055                                  seterr:
 19056 00001CAC 5A                      		pop	dx		; pop stack but don't overwrite ax
 19057 00001CAD 5A                      		pop	dx		; restore dx
 19058 00001CAE C3                      		retn
 19059                                  ; ---------------------------------------------------------------------------
 19060 00001CAF 0000                    root_sec:	dw 0			; root sector #
 19061                                  
 19062                                  ; 16/10/2022
 19063                                  ;ROOTSEC equ root_sec - DOSBIOSEG_2C7h		
 19064                                  ; 09/12/2022
 19065                                  ROOTSEC equ root_sec
 19066                                  
 19067                                  ; =============== S U B	R O U T	I N E =======================================
 19068                                  
 19069                                  ; 16/10/2022
 19070                                  
 19071                                  ; read_volume_id read the volume id and tells if it has been changed.
 19072                                  ;
 19073                                  ;   on entry:
 19074                                  ;	es:di points to current bds for drive.
 19075                                  ;
 19076                                  ;   on exit:
 19077                                  ;	carry clear
 19078                                  ;	    si = 1  no change
 19079                                  ;	    si = 0  ?
 19080                                  ;	    si = -1 change
 19081                                  ;
 19082                                  ;	carry set:
 19083                                  ;	    error and ax has error code.
 19084                                  
 19085                                  read_volume_id:
 19086 00001CB1 52                      		push	dx		; preserve registers
 19087 00001CB2 51                      		push	cx
 19088 00001CB3 53                      		push	bx
 19089 00001CB4 50                      		push	ax
 19090 00001CB5 06                      		push	es		; stack the bds last
 19091 00001CB6 57                      		push	di
 19092 00001CB7 1E                      		push	ds		; point es to Bios_Data
 19093 00001CB8 07                      		pop	es
 19094 00001CB9 BF[4008]                		mov	di, tmp_vid	; "NO NAME	 "
 19095 00001CBC BE[6305]                		mov	si, nul_vid	; "NO NAME	 "
 19096                                  		; 26/12/2023
 19097 00001CBF B90B00                  		mov	cx, 11		; PCDOS 7.1 - 02/09/2023
 19098                                  		;mov	cx, 12		; initialize tmp_vid to	null vi_id
 19099                                  		
 19100                                  		;rep	movsb
 19101                                  		; 26/12/2023
 19102                                  		;rep movs byte ptr es:[di], byte ptr cs:[si]
 19103                                  		;db 0FBh,2Eh,0A4h 
 19104                                  		;cs	; nul_vid is in BIOSCODE segment 
 19105                                  		;rep movsb
 19106 00001CC2 F3                      		rep
 19107 00001CC3 2E                      		cs
 19108 00001CC4 A4                      		movsb	
 19109                                  		
 19110 00001CC5 5F                      		pop	di
 19111 00001CC6 07                      		pop	es
 19112 00001CC7 268A450B                		mov	al, [es:di+11]	; [es:di+BDS.fats]
 19113                                  					; # of fats
 19114 00001CCB 268B4D11                		mov	cx, [es:di+17]	; [es:di+BDS.fatsecs]
 19115                                  					; sectors / fat
 19116 00001CCF F6E1                    		mul	cl		; size taken by	fats
 19117 00001CD1 26034509                		add	ax, [es:di+9]	; [es:di+BDS.resectors]
 19118                                  					; add on reserved sectors
 19119                                  					;
 19120                                  					; ax is	now sector # (0	based)
 19121                                  		; 17/10/2022
 19122 00001CD5 2EA3[AF1C]              		mov	[cs:ROOTSEC], ax
 19123                                  		;mov	word ptr cs:198Fh, ax ; [cs:root_sec]
 19124                                  					; 0070h:3EFFh =	2C7h:198Fh
 19125 00001CD9 268B450C                		mov	ax, [es:di+12]	; [es:di+BDS.direntries]
 19126                                  					; # root dir entries
 19127 00001CDD B104                    		mov	cl, 4		; 16 entries/sector
 19128 00001CDF D3E8                    		shr	ax, cl		; divide by 16
 19129                                  		;mov	cx, ax		; cx is	# of sectors to	scan
 19130                                  		; 02/09/2023 (PCDOS 7.1, one byte opcode)
 19131 00001CE1 91                      		xchg	ax, cx		; cx is	# of sectors to	scan
 19132                                  next_sec:
 19133 00001CE2 51                      		push	cx		; save outer loop counter
 19134 00001CE3 2EA1[AF1C]              		mov	ax, [cs:ROOTSEC]
 19135                                  		;mov	ax, word ptr cs:198Fh ; [cs:root_sec]
 19136                                  					; get sector #
 19137 00001CE7 268B4D13                		mov	cx, [es:di+19]	; [es:di+BDS.secpertrack]
 19138                                  					; sectors / track
 19139 00001CEB 31D2                    		xor	dx, dx
 19140 00001CED F7F1                    		div	cx
 19141                                  
 19142                                  ; set up registers for call to read_sector
 19143                                  
 19144 00001CEF 42                      		inc	dx		; dx= sectors into track
 19145                                  					; ax= track count from 0
 19146 00001CF0 88D1                    		mov	cl, dl		; sector to read
 19147 00001CF2 31D2                    		xor	dx, dx
 19148 00001CF4 26F77515                		div	word [es:di+21] ; [es:di+BDS.heads]
 19149                                  					; # heads on this disc
 19150 00001CF8 88D6                    		mov	dh, dl		; head number
 19151 00001CFA 88C5                    		mov	ch, al		; track	#
 19152 00001CFC E8B9EB                  		call	read_sector	; get first sector of the root directory,
 19153                                  					; ds:bx	-> directory sector
 19154 00001CFF 723F                    		jb	short readviderr
 19155 00001D01 B91000                  		mov	cx, 16		; # of dir entries in a	block of root
 19156 00001D04 B008                    		mov	al, 8		; volume label bit
 19157                                  fvid_loop:
 19158                                  		; 02/09/2023 (PCDOS 7.1)
 19159 00001D06 382F                    		cmp	[bx], ch ; 0				
 19160                                  		;cmp	byte [bx], 0 ; end of dir?
 19161 00001D08 7433                    		jz	short no_vid	; yes, no vol id
 19162 00001D0A 803FE5                  		cmp	byte [bx], 0E5h ; empty entry?
 19163 00001D0D 7405                    		jz	short ent_loop	; yes, skip
 19164 00001D0F 84470B                  		test	[bx+11], al	; is volume label bit set in fcb?
 19165 00001D12 750F                    		jnz	short found_vid	; jmp yes
 19166                                  ent_loop:
 19167 00001D14 83C320                  		add	bx, 32		; add length of	directory entry
 19168 00001D17 E2ED                    		loop	fvid_loop
 19169 00001D19 59                      		pop	cx		; outer loop
 19170 00001D1A 2EFF06[AF1C]            		inc	word [cs:ROOTSEC]
 19171                                  		;inc	word ptr cs:198Fh ; inc word [root_sec]
 19172                                  					; next sector
 19173 00001D1F E2C1                    		loop	next_sec	; continue
 19174                                  notfound:
 19175                                  		; 02/09/2023
 19176                                  		;xor	si, si
 19177 00001D21 EB13                    		jmp	short fvid_ret
 19178                                  ; ---------------------------------------------------------------------------
 19179                                  
 19180                                  found_vid:
 19181                                  		; 02/09/2023
 19182                                  		; cf = 0  ('test' instruction clears cf)
 19183 00001D23 59                      		pop	cx		; clean stack of outer loop counter
 19184 00001D24 89DE                    		mov	si, bx		; point	to volume_id
 19185 00001D26 06                      		push	es		; preserve current bds
 19186 00001D27 57                      		push	di
 19187 00001D28 1E                      		push	ds
 19188 00001D29 07                      		pop	es		; point es to Bios_Data
 19189 00001D2A BF[4008]                		mov	di, tmp_vid	; "NO NAME	 "
 19190 00001D2D B90B00                  		mov	cx, 11		; VOLID_SIZ-1
 19191                                  					; length of string minus nul
 19192 00001D30 F3A4                    		rep movsb		; mov volume label to tmp_vid
 19193                                  		;xor	al, al
 19194                                  		; 02/09/2023
 19195 00001D32 91                      		xchg	ax, cx		; ax = 0
 19196 00001D33 AA                      		stosb			; null terminate
 19197                                  		;;xor	si, si
 19198                                  		; 02/09/2023
 19199                                  		;xchg	ax, si		; si = 0
 19200 00001D34 5F                      		pop	di		; restore current bds
 19201 00001D35 07                      		pop	es
 19202                                  fvid_ret:
 19203                                  		; 02/09/2023
 19204 00001D36 31F6                    		xor	si, si ; 0
 19205                                  				
 19206 00001D38 58                      		pop	ax
 19207                                  		; 10/12/2022
 19208                                  		; cf = 0
 19209                                  		;clc
 19210                                  rvidret:
 19211 00001D39 5B                      		pop	bx		; restore registers
 19212 00001D3A 59                      		pop	cx
 19213 00001D3B 5A                      		pop	dx
 19214 00001D3C C3                      		retn
 19215                                  ; ---------------------------------------------------------------------------
 19216                                  
 19217                                  no_vid:
 19218 00001D3D 59                      		pop	cx		; clean stack of outer loop counter
 19219                                  		;jmp	short notfound	; not found
 19220                                  		; 02/09/2023
 19221 00001D3E EBF6                    		jmp	short fvid_ret
 19222                                  ; ---------------------------------------------------------------------------
 19223                                  
 19224                                  readviderr:
 19225 00001D40 5E                      		pop	si		; trash the outer loop counter
 19226 00001D41 5E                      		pop	si		; caller's ax, return error code instead
 19227 00001D42 EBF5                    		jmp	short rvidret
 19228                                  
 19229                                  ; ---------------------------------------------------------------------------
 19230                                  		; 26/12/2023 - Retro DOS v5.0
 19231                                  		; 02/09/2023 - Retro DOS v4.2 (IO.SYS optimization)
 19232                                  		; PCDOS 7.1 - IBMBIO.COM - BIOSCODE:1DCFh 
 19233                                  preset_volid_addr:
 19234 00001D44 BE[4008]                		mov	si, tmp_vid	; "NO NAME    "
 19235                                  		; 26/12/2023
 19236                                  		; PCDOS 7.1
 19237 00001D47 83C77D                  		add	di, 125		; BDS.volid
 19238 00001D4A B90B00                  		mov	cx, 11		; VOLID_SIZ (12 for MSDOS 5.0-6.22 versions)
 19239                                  		; MSDOS 6.21 (MSDOS 5.0 & 6.?)
 19240                                  		;add	di, 75		; BDS.volid
 19241                                  		;mov	cx, 12		; VOLID_SIZ
 19242                                  		;
 19243 00001D4D FC                      		cld
 19244 00001D4E C3                      		retn
 19245                                  
 19246                                  ; =============== S U B	R O U T	I N E =======================================
 19247                                  
 19248                                  ; transfer_volume_id - copy the volume id from tmp to special drive
 19249                                  ;
 19250                                  ; inputs:	es:di has current bds
 19251                                  ; outputs:	bds for drive has volume id from tmp
 19252                                  
 19253                                  		; 27/12/2023 - Retro DOS v5.0
 19254                                  transfer_volume_id:
 19255 00001D4F 57                      		push	di		; copy the volume id from tmp to special drive
 19256                                  		;push	si
 19257 00001D50 51                      		push	cx
 19258                                  		; 27/12/2023
 19259 00001D51 56                      		push	si		
 19260                                  
 19261                                  		;mov	si, tmp_vid	; "NO NAME	 "
 19262                                  		;;add	di, BDS.volid
 19263                                  		;add	di, 75		; BDS.volid
 19264                                  		;;mov	cx, VOLID_SIZ
 19265                                  		;mov	cx, 12		; VOLID_SIZ
 19266                                  		;cld
 19267                                  		; 02/09/2023 (PCDOS 7.1)
 19268 00001D52 E8EFFF                  		call	preset_volid_addr
 19269                                  
 19270 00001D55 F3A4                    		rep movsb
 19271                                  		
 19272                                  		; 27/12/2023
 19273 00001D57 5E                      		pop	si
 19274                                  chk_volid_ok:
 19275 00001D58 59                      		pop	cx
 19276                                  		;pop	si
 19277 00001D59 5F                      		pop	di
 19278 00001D5A C3                      		retn
 19279                                  
 19280                                  ; =============== S U B	R O U T	I N E =======================================
 19281                                  
 19282                                  ;  check_volume_id - compare volume id in tmp area with
 19283                                  ;		     one expected for drive
 19284                                  ;
 19285                                  ;   inputs:	es:di has current bds for drive
 19286                                  ;   outputs:	zero true means it matched
 19287                                  
 19288                                  		; 27/12/2023 - Retro DOS v5.0
 19289                                  check_volume_id:
 19290 00001D5B 57                      		push	di
 19291 00001D5C 51                      		push	cx
 19292                                  		
 19293                                  		;mov	si, tmp_vid	; "NO NAME	 "
 19294                                  		;;add	di, BDS.volid
 19295                                  		;add	di, 75		; BDS.volid
 19296                                  		;;mov	cx, VOLID_SIZ
 19297                                  		;mov	cx, 12		; VOLID_SIZ
 19298                                  		;cld
 19299                                  		; 02/09/2023 (PCDOS 7.1)
 19300 00001D5D E8E4FF                  		call	preset_volid_addr
 19301                                  
 19302 00001D60 F3A6                    		repe cmpsb		; are the 2 volume_ids the same?
 19303                                  		
 19304                                  		; 27/12/2023
 19305                                  		;pop	cx
 19306                                  		;pop	di
 19307                                  		;retn
 19308 00001D62 EBF4                    		jmp	short chk_volid_ok
 19309                                  
 19310                                  ; =============== S U B	R O U T	I N E =======================================
 19311                                  
 19312                                  ;   fat_check - see of the fatid has changed in the specified drive.
 19313                                  ;	      - uses the fat id obtained from the boot sector.
 19314                                  ;
 19315                                  ;   inputs:	medbyt is expected fat id
 19316                                  ;		es:di points to current bds
 19317                                  ;
 19318                                  ;   output:	si = -1 if fat id different,
 19319                                  ;		si = 0 otherwise
 19320                                  ;
 19321                                  ;   no other registers changed.
 19322                                  
 19323                                  fat_check:
 19324 00001D64 50                      		push	ax
 19325 00001D65 31F6                    		xor	si, si		; say fat id's are same.
 19326 00001D67 A0[1F01]                		mov	al, [medbyt]	; 19/10/2022
 19327 00001D6A 263A4510                		cmp	al, [es:di+10h]	; [es:di+BDS.media]
 19328                                  					; compare it with the bds medbyte
 19329 00001D6E 7401                    		jz	short okret1	; carry	clear
 19330 00001D70 4E                      		dec	si
 19331                                  okret1:
 19332 00001D71 58                      		pop	ax
 19333 00001D72 C3                      		retn
 19334                                  
 19335                                  ; ---------------------------------------------------------------------------
 19336                                  
 19337                                  ; BIOSCODE:1DFEh (PCDOS 7.1 IBMBIO.COM) ; 27/12/2023
 19338                                  		;times 2 db 0
 19339                                  
 19340                                  ; BIOSCODE:1A69h (MSDOS 6.21 IO.SYS) ((& MSDOS 6.22 IO.SYS))
 19341                                  		;times 7 db 0
 19342                                  
 19343                                  ; BIOSCODE:180Bh (MSDOS 5.0 IO.SYS)	
 19344                                  
 19345                                  		; 09/12/2022
 19346                                  		;times 4 db 0	; 17/10/2022
 19347                                  		;db 4 dup(0)	; times 4 db 0
 19348                                  
 19349                                  ; ---------------------------------------------------------------------------
 19350                                  
 19351                                  		; 09/12/2022
 19352                                  		;db 0
 19353                                  
 19354                                  number2div	equ ($-BCode_start)
 19355                                  number2mod	equ (number2div % 16)
 19356                                  
 19357                                  %if (number2mod>0) & (number2mod<16) ; 17/09/2023
 19358 00001D73 00<rep Dh>              		times (16-number2mod) db 0
 19359                                  %endif
 19360                                  
 19361                                  ;align 16
 19362                                  
 19363                                  ; 09/12/2022
 19364                                  BCODE_END	equ $ - BCode_start
 19365                                  ; 29/09/2023
 19366                                  BCODEEND:
 19367                                  ;SYSINITSEG	equ IOSYSCODESEG+(BCODE_END>>4)
 19368                                  ; 13/12/2022
 19369                                  SYSINITOFFSET	equ BCODE_END
 19370                                  ; 29/09/2023
 19371                                  ;SYSINITOFFSET	equ $-$$
 19372                                  SYSINITSEG	equ IOSYSCODESEG+(SYSINITOFFSET>>4)
 19373                                  
 19374                                  ; 28/09/2023
 19375                                  S2SIZE equ $-$$
 19376                                  
 19377                                  ;--- End of DOSBIOS code segment ---------------------------------------------
 19378                                  
 19379                                  ; 16/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 19380                                  ; 01/05/2019 - Retro DOS v4.0 
 19381                                  ; ============================================================================
 19382                                  ; end of BIOSCODE
 19383                                  
 19384                                  ; ----------------------------------------------------------------------------
 19385                                  ; %include sysinit5.s	; 09/12/2022
 19386                                  ; ----------------------------------------------------------------------------
 19387                                  
 19388                                  ;=============================================================================
 19389                                  ; (IO.SYS) SYSINIT SEGMENT 
 19390                                  ;=============================================================================
 19391                                  ; 09/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 19392                                  ; 30/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 19393                                  
 19394                                  section .SYSINIT vstart=0
 19395                                  
 19396                                  ; ****************************************************************************
 19397                                  ; SYSINIT.BIN (MSDOS 6.21 IO.SYS) - RETRO DOS v4.0 by ERDOGAN TAN - 21/10/2022
 19398                                  ; ----------------------------------------------------------------------------
 19399                                  ; Last Update: 04/01/2023 (Modified IO.SYS)  ((Previous: 30/12/2022))
 19400                                  ; ----------------------------------------------------------------------------
 19401                                  ; Beginning: 03/06/2018 (Retro DOS 3.0), 21/03/2019 (Retro DOS 4.0)
 19402                                  ; ----------------------------------------------------------------------------
 19403                                  ; Assembler: NASM version 2.15
 19404                                  ; ----------------------------------------------------------------------------
 19405                                  ;	   ((nasm sysinit6.s -l sysinit6.lst -o SYSINIT6.BIN -Z error.txt)) 	
 19406                                  ; ----------------------------------------------------------------------------
 19407                                  ; Modified from 'sysinit2.s' (SYSINIT2.BIN) file of Retro DOS v3.0 (6/7/2018)
 19408                                  ; ----------------------------------------------------------------------------
 19409                                  ; Derived from 'SYSINIT1.ASM' and 'SYSINIT2.ASM' files of MSDOS 6.0
 19410                                  ; source code by Microsoft, 1991 
 19411                                  ; ----------------------------------------------------------------------------
 19412                                  ; Derived from 'SYSINIT.ASM' file of MSDOS 2.0 (IBM PCDOS v2.0) source code
 19413                                  ; by Microsoft, 12/10/1983
 19414                                  ; ****************************************************************************
 19415                                  ; main file: 'retrodos4.s'
 19416                                  ; incbin 'SYSINIT3.BIN' ; (SYINITSEG)
 19417                                  
 19418                                  ; 30/12/2022 - Retro DOS v4.2 
 19419                                  ; Retro DOS v4.0 - 2019
 19420                                  ; SYSINIT (MSDOS 6.21 IO.SYS) draft: 'sysinit3.s' (01/07/2019)
 19421                                   
 19422                                  ; 21/10/2022
 19423                                  ; ----------------------------------------------------------------------------
 19424                                  ; This source code (version) is based on SYSINIT source code of disassembled
 19425                                  ; MSDOS 5.0 IO.SYS file (SYSINIT.BIN) 
 19426                                  ; Dissassembler: Hex-Rays Interactive Disassembler (IDA)
 19427                                  ; ----------------------------------------------------------------------------
 19428                                  ; Binary file splitter & joiner: FFSJ v3.3
 19429                                  
 19430                                  ;--------------------------------------------------------------
 19431                                  ; SYSINIT.TXT (27/01/1983)
 19432                                  ;--------------------------------------------------------------
 19433                                  ;    SYSINIT is  a module linked behind the OEM bios.  It takes
 19434                                  ;over  the  system  initialization  after  the  OEM  bios   has
 19435                                  ;performed any  initialization  it  needs  to  do.   Control is
 19436                                  ;transfered with a long jump to the external  variable  SYSINIT
 19437                                  ;
 19438                                  ;
 19439                                  ;   The OEM  has  the  following  variables declared external:
 19440                                  ;
 19441                                  ;   CURRENT_DOS_LOCATION    WORD
 19442                                  ;
 19443                                  ;This word  contains  the  segment  number of the DOS before it
 19444                                  ;is relocated.  The OEM bios must set this value.
 19445                                  ;
 19446                                  ;   FINAL_DOS_LOCATION      WORD
 19447                                  ;
 19448                                  ;This word contains the segment number of the DOS after SYSINIT
 19449                                  ;moves it.  The OEM bios must set this value.
 19450                                  ;
 19451                                  ;   DEVICE_LIST             DWORD
 19452                                  ;
 19453                                  ;This  double  word  pointer  points  to  the  linked  list  of
 19454                                  ;character and block device drivers.  The  OEM  must  set  this
 19455                                  ;value.
 19456                                  ;
 19457                                  ;   MEMORY_SIZE             WORD
 19458                                  ;
 19459                                  ;This word  contains  the  number  of  RAM  paragraphs.  If the
 19460                                  ;bios doesn't set  this  variable  SYSINIT  will  automatically
 19461                                  ;calculate it.   NOTE:  systems with PARITY checked memory must
 19462                                  ;size memory in the BIOS.  SYSINITs method is to  write  memory
 19463                                  ;and read it back until it gets a mismatch.
 19464                                  ;
 19465                                  ;   DEFAULT_DRIVE           BYTE
 19466                                  ;
 19467                                  ;This is  the initial default drive when the system first comes
 19468                                  ;up.  drive a=0, drive b=1,  etc.   If  the  bios  doesn't  set
 19469                                  ;it then drive a is assumed.
 19470                                  ;
 19471                                  ;   BUFFERS                 BYTE
 19472                                  ;
 19473                                  ;This is  the  default  number of buffers for the system.  This
 19474                                  ;value may be overridden by the user in  the  CONFIG.SYS  file.
 19475                                  ;It is DBed to 2 in SYSINIT it should be greater than 1.
 19476                                  ;
 19477                                  ;   FILES                   BYTE
 19478                                  ;
 19479                                  ;This is  the  default  number  of  files for the system.  This
 19480                                  ;value may be overridden by the user in  the  CONFIG.SYS  file.
 19481                                  ;It is  DBed  to  8 in SYSINIT, values less than 5 are ignored.
 19482                                  ;
 19483                                  ;   SYSINIT                 FAR
 19484                                  ;
 19485                                  ;The entry  point  of  the  SYSINIT  module.  OEM BIOS jumps to
 19486                                  ;this label at the end of its INIT code.
 19487                                  ;
 19488                                  ;   The OEM  has  the  following  variables declared public:
 19489                                  ;
 19490                                  ;   RE_INIT                 FAR
 19491                                  ;
 19492                                  ;This is an entry point which allows the BIOS to do some INIT
 19493                                  ;work  after  the  DOS is initialized.  ALL REGISTERS MUST BE
 19494                                  ;PRESERVED.  On entry DS points to the first available memory
 19495                                  ;(after  the DOS).  DS:0 points to a 100H byte program header
 19496                                  ;prefix which represents  the  "program"  currently  running.
 19497                                  ;This  program  should  be  thought  of  as  the OEM BIOS and
 19498                                  ;SYSINIT taken together.  This is not  a  normal  program  in
 19499                                  ;that  no  memory  is  allocated to it, it is running in free
 19500                                  ;memory.
 19501                                  ;NOTES:
 19502                                  ;     At the time this routine is called SYSINIT occupies the
 19503                                  ;highest 10K of memory ("highest" is determined by the  value
 19504                                  ;of the MEMORY_SIZE variable), DO NOT DO WRITES THERE.
 19505                                  ;     Since this is called AFTER DOS is initialized, you can
 19506                                  ;make system calls.  This also implies that the code for this
 19507                                  ;routine    CANNOT   be   thrown   away   by   use   of   the
 19508                                  ;FINAL_DOS_LOCATION since the DOS has already been moved.
 19509                                  ;     If you don't want  anything done just set this to point
 19510                                  ;at a FAR RET instruction.
 19511                                  
 19512                                  ; ----------------------------------------------------------------------
 19513                                  ; TITLE   BIOS SYSTEM INITIALIZATION
 19514                                  ; ----------------------------------------------------------------------
 19515                                  
 19516                                  ;include version.inc
 19517                                  ; ----------------------------------------------------------------------
 19518                                  
 19519                                  ;FALSE   EQU     0
 19520                                  ;TRUE    EQU     0FFFFh
 19521                                  
 19522                                  ;IBMVER	    EQU     TRUE
 19523                                  ;IBMCOPYRIGHT EQU   FALSE
 19524                                  ;STACKSW    EQU	    TRUE		;Include Switchable Hardware Stacks
 19525                                  ;IBMJAPVER  EQU     FALSE		; If TRUE set KANJI true also
 19526                                  ;MSVER      EQU     FALSE
 19527                                  ;ALTVECT    EQU     FALSE		; Switch to build ALTVECT version
 19528                                  ;KANJI      EQU     FALSE
 19529                                  
 19530                                  ;(MSDOS 6.0, versiona.inc, 1991)
 19531                                  ; ----------------------------------------------------------------------
 19532                                  ;MAJOR_VERSION  EQU	6
 19533                                  ;;MINOR_VERSION	EQU	0	;6.00
 19534                                  ;MINOR_VERSION  EQU	21	;6.21  ; 21/03/2019 - Retro DOS v4.0
 19535                                  
 19536                                  ; 22/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0)
 19537                                  ; ----------------------------------------------------------------------
 19538                                  ;MAJOR_VERSION   EQU	5
 19539                                  ;MINOR_VERSION   EQU	0
 19540                                  
 19541                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21)
 19542                                  MAJOR_VERSION   EQU	6
 19543                                  MINOR_VERSION   EQU	22
 19544                                  
 19545                                  expected_version equ	(MINOR_VERSION<<8)+MAJOR_VERSION
 19546                                  
 19547                                  ;DOSREVNM equ	00000000b       ; m037 - bits 0-2 = revision number of DOS
 19548                                  				; currently 0.
 19549                                  DOSREVNM equ	00000111b	; [[[ 7 for Retro DOS v4.0 ]]] (21/03/2019)	
 19550                                  DOSINROM equ	00001000B       ; bit 3 of ver flags returned in BH
 19551                                  DOSINHMA equ	00010000B       ; bit 4 of ver flags 
 19552                                  
 19553                                  ;      if1
 19554                                  ;      %OUT  ... for DOS Version 5.00 ...
 19555                                  ;      endif
 19556                                  
 19557                                         ;******************************
 19558                                         ;Each assembler program should:
 19559                                         ;  mov ah,030h                   ;DOS Get Version function
 19560                                         ;  int 021h                      ;Version ret. in AX,minor version first
 19561                                         ;  cmp ax,expected_version       ;ALL utilities should check for an
 19562                                         ;  jne error_handler             ; EXACT version match.
 19563                                         ;******************************
 19564                                  
 19565                                  ; ----------------------------------------------------------------------
 19566                                  ; device definitions
 19567                                  
 19568                                  ;Attribute bit masks
 19569                                  DEVTYP  EQU     8000h           ;Bit 15 - 1  if Char, 0 if block
 19570                                  DEVIOCTL EQU    4000h           ;Bit 14 - CONTROL mode bit
 19571                                  ISFATBYDEV EQU  2000h           ;Bit 13 - Device uses FAT ID bytes, comp media.
 19572                                  ISCIN   EQU     0001h           ;Bit 0 - This device is the console input.
 19573                                  ISCOUT  EQU     0002h           ;Bit 1 - This device is the console output.
 19574                                  ISNULL  EQU     0004h           ;Bit 2 - This device is the null device.
 19575                                  ISCLOCK EQU     0008h           ;Bit 3 - This device is the clock device.
 19576                                  ISIBM   EQU     0010h           ;Bit 4 - This device is special
 19577                                  
 19578                                  ; The device table list has the form:
 19579                                  struc	SYSDEV
 19580 00000000 ????????                .NEXT:		resd 1		;Pointer to next device header
 19581 00000004 ????                    .ATT:		resw 1		;Attributes of the device
 19582 00000006 ????                    .STRAT:		resw 1		;Strategy entry point
 19583 00000008 ????                    .INT:		resw 1		;Interrupt entry point
 19584 0000000A ????????????????        .NAME:		resb 8		;Name of device (only first byte used for block)
 19585                                  .size:
 19586                                  endstruc
 19587                                  
 19588                                  ;Static Reguest Header
 19589                                  struc	SRHEAD
 19590 00000000 ??                      .REQLEN:	resb 1		;Length in bytes of request block
 19591 00000001 ??                      .REQUNIT:	resb 1		;Device unit number
 19592 00000002 ??                      .REQFUNC:	resb 1		;Type of request
 19593 00000003 ????                    .REQSTAT:	resw 1		;Status Word
 19594 00000005 ????????????????                	resb 8		;Reserved for queue links
 19595                                  .size:
 19596                                  endstruc
 19597                                  
 19598                                  ;Status word masks
 19599                                  STERR   EQU     8000H           ;Bit 15 - Error
 19600                                  STBUI   EQU     0200H           ;Bit 9 - Buisy
 19601                                  STDON   EQU     0100H           ;Bit 8 - Done
 19602                                  STECODE EQU     00FFH           ;Error code
 19603                                  WRECODE EQU     0
 19604                                  
 19605                                  ;Function codes
 19606                                  DEVINIT EQU     0               ;Initialization
 19607                                  DINITHL EQU     26              ;Size of init header
 19608                                  DEVMDCH EQU     1               ;Media check
 19609                                  DMEDHL  EQU     15              ;Size of media check header
 19610                                  DEVBPB  EQU     2               ;Get BPB
 19611                                  DEVRDIOCTL EQU  3               ;IOCTL read
 19612                                  DBPBHL  EQU     22              ;Size of Get BPB header
 19613                                  DEVRD   EQU     4               ;Read
 19614                                  DRDWRHL EQU     22              ;Size of RD/WR header
 19615                                  DEVRDND EQU     5               ;Non destructive read no wait (character devs)
 19616                                  DRDNDHL EQU     14              ;Size of non destructive read header
 19617                                  DEVIST  EQU     6               ;Input status
 19618                                  DSTATHL EQU     13              ;Size of status header
 19619                                  DEVIFL  EQU     7               ;Input flush
 19620                                  DFLSHL  EQU     15              ;Size of flush header
 19621                                  DEVWRT  EQU     8               ;Write
 19622                                  DEVWRTV EQU     9               ;Write with verify
 19623                                  DEVOST  EQU     10              ;Output status
 19624                                  DEVOFL  EQU     11              ;Output flush
 19625                                  DEVWRIOCTL EQU  12              ;IOCTL write
 19626                                  
 19627                                  ; ----------------------------------------------------------------------
 19628                                  struc	SYS_FCB
 19629 00000000 ??                      .fcb_drive:	resb 1
 19630 00000001 ????????????????        .fcb_name:	resb 8
 19631 00000009 ??????                  .fcb_ext:	resb 3
 19632 0000000C ????                    .fcb_EXTENT:	resw 1
 19633 0000000E ????                    .fcb_RECSIZ:	resw 1	; Size of record (user settable)
 19634 00000010 ????                    .fcb_FILSIZ:	resw 1	; Size of file in bytes; used with the following
 19635                                                          ; word
 19636 00000012 ????                    .fcb_DRVBP:	resw 1	; BP for SEARCH FIRST and SEARCH NEXT
 19637 00000014 ????                    .fcb_FDATE:	resw 1	; Date of last writing
 19638 00000016 ????                    .fcb_FTIME:	resw 1	; Time of last writing
 19639 00000018 ??                      .fcb_DEVID:	resb 1	; Device ID number, bits 0-5 if file.
 19640                                                          ; bit 7=0 for file, bit 7=1 for I/O device
 19641                                                          ; If file, bit 6=0 if dirty
 19642                                                          ; If I/O device, bit 6=0 if EOF (input)
 19643                                                          ;               Bit 5=1 if Raw mode
 19644                                                          ;               Bit 0=1 if console input device
 19645                                                          ;               Bit 1=1 if console output device
 19646                                                          ;               Bit 2=1 if null device
 19647                                                          ;               Bit 3=1 if clock device
 19648 00000019 ????                    .fcb_FIRCLUS:	resw 1	; First cluster of file
 19649 0000001B ????                    .fcb_CLUSPOS:	resw 1	; Position of last cluster accessed
 19650 0000001D ????                    .fcb_LSTCLUS:	resw 1	; Last cluster accessed and directory
 19651 0000001F ??                                   	resb 1	; pack 2 12 bit numbers into 24 bits...
 19652 00000020 ??                      .fcb_NR:	resb 1	; Next record
 19653 00000021 ????????                .fcb_RR:	resb 4	; Random record
 19654                                  .size:
 19655                                  endstruc
 19656                                  
 19657                                  ; ----------------------------------------------------------------------
 19658                                  ; Field definition for I/O buffer information
 19659                                  
 19660                                  ; 22/03/2019 - Retro DOS v4.0 (MSDOS 6.0, BUFFER.INC, 1991)
 19661                                  
 19662                                  struc buffinfo
 19663 00000000 ????                    .buf_next:	resw 1	; Pointer to next buffer in list
 19664 00000002 ????                    .buf_prev:	resw 1	; Pointer to previous buffer in list
 19665 00000004 ??                      .buf_ID:	resb 1	; Drive of buffer (bit 7 = 0)
 19666                                  			; SFT table index (bit 7 = 1)
 19667                                  			; = FFh if buffer free
 19668 00000005 ??                      .buf_flags:	resb 1	; Bit 7 = 1 if Remote file buffer
 19669                                  			;	= 0 if Local device buffer
 19670                                  			; Bit 6 = 1 if buffer dirty
 19671                                  			; Bit 5 = Reserved
 19672                                  			; Bit 4 = Search bit (bit 7 = 1)
 19673                                  			; Bit 3 = 1 if buffer is DATA
 19674                                  			; Bit 2 = 1 if buffer is DIR
 19675                                  			; Bit 1 = 1 if buffer is FAT
 19676                                  			; Bit 0 = Reserved
 19677 00000006 ????????                .buf_sector:	resd 1	; Sector number of buffer (bit 7 = 0)
 19678                                  ; The next two items are often refed as a word (bit 7 = 0)
 19679 0000000A ??                      .buf_wrtcnt:	resb 1	; For FAT sectors, # times sector written out
 19680 0000000B ????                    .buf_wrtcntinc:	resw 1	; "   "     "   , # sectors between each write
 19681 0000000D ????????                .buf_DPB :	resd 1	; Pointer to drive parameters
 19682 00000011 ????                    .buf_fill:	resw 1	; How full buffer is (bit 7 = 1)
 19683 00000013 ??                      .buf_reserved:	resb 1	; make DWORD boundary for 386
 19684                                  .size:
 19685                                  endstruc
 19686                                  
 19687                                  %define buf_offset	dword [buf_sector]
 19688                                  			;For bit 7 = 1, this is the byte
 19689                                  			;offset of the start of the buffer in
 19690                                  			;the file pointed to by buf_ID.  Thus
 19691                                  			;the buffer starts at location
 19692                                  			;buf_offset in the file and contains
 19693                                  			;buf_fill bytes.
 19694                                  
 19695                                  bufinsiz	equ	buffinfo.size ; ; Size of structure in bytes
 19696                                  
 19697                                  
 19698                                  buf_Free	equ	0FFh		; buf_id of free buffer
 19699                                  
 19700                                  ;Flag byte masks
 19701                                  buf_isnet	EQU	10000000B
 19702                                  buf_dirty	EQU	01000000B
 19703                                  ;***
 19704                                  buf_visit	EQU	00100000B
 19705                                  ;***
 19706                                  buf_snbuf	EQU	00010000B
 19707                                  
 19708                                  buf_isDATA	EQU	00001000B
 19709                                  buf_isDIR	EQU	00000100B
 19710                                  buf_isFAT	EQU	00000010B
 19711                                  buf_type_0	EQU	11110001B	; AND sets type to "none"
 19712                                  
 19713                                  buf_NetID	EQU	bufinsiz
 19714                                  
 19715                                  ; ----------------------------------------------------------------------
 19716                                  
 19717                                  ; ----------------------------------------------------------------------
 19718                                  ;**	DPB - Drive Parameter Block
 19719                                  
 19720                                  ; 25/03/2019 - Retro DOS v4.0 (MSDOS 6.0, DPB.INC, 1991)
 19721                                  
 19722                                  ;	BUGBUG - this isn't authorative - it's my probably incomplete and
 19723                                  ;	possibly inaccurate deductions from code study... - jgl
 19724                                  ;
 19725                                  ;	The DPB is DOS's main structure for describing block devices.
 19726                                  ;	It contains info about the "Drive" intermingled with info about
 19727                                  ;	the FAT file system which is presumably on the drive.  I don't know
 19728                                  ;	how those fields are used if it's not the FAT file system - BUGBUG
 19729                                  ;
 19730                                  ;	The DPBs are statically allocated and chained off of DPBHead.
 19731                                  ;	Users scan this chain looking for a match on DPB_DRIVE.
 19732                                  ;	The DPBs are built at init time from info in the SYSDEV structure.
 19733                                  
 19734                                  ; 08/06/2018 - Retro DOS v3.0 (MSDOS 3.3, DPB.INC, 24/07/1987)
 19735                                  
 19736                                  ; 12/05/2019 - Retro DOS v4.0
 19737                                  
 19738                                  struc	DPB
 19739 00000000 ??                      .DRIVE:		resb 1		; Logical drive # assoc with DPB (A=0,B=1,...)
 19740 00000001 ??                      .UNIT:		resb 1		; Driver unit number of DPB
 19741 00000002 ????                    .SECTOR_SIZE:	resw 1		; Size of physical sector in bytes
 19742 00000004 ??                      .CLUSTER_MASK:	resb 1		; Sectors/cluster - 1
 19743 00000005 ??                      .CLUSTER_SHIFT:	resb 1		; Log2 of sectors/cluster
 19744 00000006 ????                    .FIRST_FAT:	resw 1		; Starting record of FATs
 19745 00000008 ??                      .FAT_COUNT:	resb 1		; Number of FATs for this drive
 19746 00000009 ????                    .ROOT_ENTRIES:	resw 1		; Number of directory entries
 19747 0000000B ????                    .FIRST_SECTOR:	resw 1		; First sector of first cluster
 19748 0000000D ????                    .MAX_CLUSTER:	resw 1		; Number of clusters on drive + 1
 19749                                  ;.FAT_SIZE:	resb 1  ; MSDOS 3.3
 19750 0000000F ????                    .FAT_SIZE:	resw 1		; Number of records occupied by FAT
 19751 00000011 ????                    .DIR_SECTOR:	resw 1		; Starting record of directory
 19752 00000013 ????????                .DRIVER_ADDR:	resd 1		; Pointer to driver
 19753 00000017 ??                      .MEDIA:		resb 1		; Media byte
 19754 00000018 ??                      .FIRST_ACCESS:	resb 1		; This is initialized to -1 to force a media
 19755                                  				; check the first time this DPB is used
 19756 00000019 ????????                .NEXT_DPB:	resd 1		; Pointer to next Drive parameter block
 19757 0000001D ????                    .NEXT_FREE:	resw 1		; Cluster # of last allocated cluster
 19758 0000001F ????                    .FREE_CNT:	resw 1		; Count of free clusters, -1 if unknown
 19759                                  .size:
 19760                                  endstruc
 19761                                  
 19762                                  DPBSIZ  EQU     DPB.size	; Size of the structure in bytes
 19763                                  
 19764                                  DSKSIZ  EQU	DPB.MAX_CLUSTER	; Size of disk (temp used during init only)
 19765                                  
 19766                                  ; ----------------------------------------------------------------------
 19767                                  ; 26/03/2018
 19768                                  
 19769                                  ; IOCTL SUB-FUNCTIONS
 19770                                  IOCTL_GET_DEVICE_INFO	EQU	0
 19771                                  IOCTL_SET_DEVICE_INFO	EQU	1
 19772                                  IOCTL_READ_HANDLE	EQU	2
 19773                                  IOCTL_WRITE_HANDLE	EQU	3
 19774                                  IOCTL_READ_DRIVE	EQU	4
 19775                                  IOCTL_WRITE_DRIVE	EQU	5
 19776                                  IOCTL_GET_INPUT_STATUS	EQU	6
 19777                                  IOCTL_GET_OUTPUT_STATUS EQU	7
 19778                                  IOCTL_CHANGEABLE?	EQU	8
 19779                                  IOCTL_SHARING_RETRY	EQU	11
 19780                                  GENERIC_IOCTL_HANDLE	EQU	12
 19781                                  GENERIC_IOCTL		EQU	13
 19782                                  
 19783                                  ; GENERIC IOCTL SUB-FUNCTIONS
 19784                                  RAWIO			EQU	8
 19785                                  
 19786                                  ; RAWIO SUB-FUNCTIONS
 19787                                  GET_DEVICE_PARAMETERS	EQU	60H
 19788                                  SET_DEVICE_PARAMETERS	EQU	40H
 19789                                  READ_TRACK		EQU	61H
 19790                                  WRITE_TRACK		EQU	41H
 19791                                  VERIFY_TRACK		EQU	62H
 19792                                  FORMAT_TRACK		EQU	42H
 19793                                  
 19794                                  ; DEVICETYPE VALUES
 19795                                  MAX_SECTORS_IN_TRACK	EQU	63
 19796                                  DEV_5INCH		EQU	0
 19797                                  DEV_5INCH96TPI		EQU	1
 19798                                  DEV_3INCH720KB		EQU	2
 19799                                  DEV_8INCHSS		EQU	3
 19800                                  DEV_8INCHDS		EQU	4
 19801                                  DEV_HARDDISK		EQU	5
 19802                                  DEV_OTHER		EQU	7
 19803                                  ;DEV_3INCH1440KB	EQU	7
 19804                                  DEV_3INCH2880KB		EQU	9
 19805                                  ; Retro DOS v2.0 - 26/03/2018
 19806                                  ;;DEV_TAPE		EQU	6
 19807                                  ;;DEV_ERIMO		EQU	8
 19808                                  ;DEV_3INCH2880KB	EQU	9
 19809                                  DEV_3INCH1440KB		EQU	10
 19810                                  
 19811                                  ;MAX_DEV_TYPE		EQU	9	; MAXIMUM DEVICE TYPE THAT WE
 19812                                  					; CURRENTLY SUPPORT.
 19813                                  MAX_DEV_TYPE		EQU	10
 19814                                  
 19815                                  struc A_SECTORTABLE
 19816 00000000 ????                    .ST_SECTORNUMBER:	resw	1
 19817 00000002 ????                    .ST_SECTORSIZE:		resw	1
 19818                                  .size:
 19819                                  endstruc
 19820                                  
 19821                                  ; 25/03/2019 - Retro DOS v4.0  (MSDOS 6.0, BPB.INC, IOCTL.INC)
 19822                                  
 19823                                  ;**	BIOS PARAMETER BLOCK DEFINITION
 19824                                  ;
 19825                                  ;	The BPB contains information about the disk structure.  It dates
 19826                                  ;	back to the earliest FAT systems and so FAT information is
 19827                                  ;	intermingled with physical driver information.
 19828                                  ;
 19829                                  ;	A boot sector contains a BPB for its device; for other disks
 19830                                  ;	the driver creates a BPB.  DOS keeps copies of some of this
 19831                                  ;	information in the DPB.
 19832                                  ;
 19833                                  ;	The BDS structure contains a BPB within it.
 19834                                  
 19835                                  struc A_BPB
 19836 00000000 ????                    .BPB_BYTESPERSECTOR:	resw	1
 19837 00000002 ??                      .BPB_SECTORSPERCLUSTER:	resb	1
 19838 00000003 ????                    .BPB_RESERVEDSECTORS:	resw	1
 19839 00000005 ??                      .BPB_NUMBEROFFATS:	resb	1
 19840 00000006 ????                    .BPB_ROOTENTRIES: 	resw	1
 19841 00000008 ????                    .BPB_TOTALSECTORS:	resw	1
 19842 0000000A ??                      .BPB_MEDIADESCRIPTOR:	resb	1
 19843 0000000B ????                    .BPB_SECTORSPERFAT:	resw	1
 19844 0000000D ????                    .BPB_SECTORSPERTRACK:	resw	1
 19845 0000000F ????                    .BPB_HEADS:		resw	1
 19846 00000011 ????                    .BPB_HIDDENSECTORS:	resw	1
 19847 00000013 ????                    			resw	1
 19848 00000015 ????                    .BPB_BIGTOTALSECTORS:	resw	1
 19849 00000017 ????                    			resw	1
 19850 00000019 ????????????            			resb	6	; NOTE:  many times these
 19851                                  ;					; 	 6 bytes are omitted
 19852                                  ;					;	 when BPB manipulations
 19853                                  ;					;	 are performed!
 19854                                  .size:
 19855                                  endstruc
 19856                                  
 19857                                  struc A_DEVICEPARAMETERS
 19858 00000000 ??                      .DP_SPECIALFUNCTIONS:	resb	1
 19859 00000001 ??                      .DP_DEVICETYPE:		resb	1
 19860 00000002 ????                    .DP_DEVICEATTRIBUTES:	resw	1
 19861 00000004 ????                    .DP_CYLINDERS:		resw	1
 19862 00000006 ??                      .DP_MEDIATYPE:		resb	1
 19863 00000007 <res 1Fh>               .DP_BPB:		resb	A_BPB.size
 19864 00000026 ????                    .DP_TRACKTABLEENTRIES:	resw	1
 19865 00000028 <res FCh>               .DP_SECTORTABLE:	resb	MAX_SECTORS_IN_TRACK * A_SECTORTABLE.size
 19866                                  endstruc
 19867                                  
 19868                                  ; ----------------------------------------------------------------------
 19869                                  ; structure, equates for devmark for mem command.
 19870                                  
 19871                                  ; 25/03/2019 - Retro DOS v4.0 (MSDOS 6.0, DEVMARK.INC, 1991)
 19872                                  
 19873                                  struc devmark
 19874 00000000 ??                       .id:	    resb 1
 19875 00000001 ????                     .seg:	    resw 1
 19876 00000003 ????                     .size:	    resw 1
 19877 00000005 ??????                   .dum:	    resb 3
 19878 00000008 ????????????????         .filename: resb 8
 19879                                  endstruc
 19880                                  
 19881                                  devmark_stk	equ	'S'
 19882                                  devmark_device	equ	'D'
 19883                                  devmark_ifs	equ	'I'
 19884                                  devmark_buf	equ	'B'
 19885                                  devmark_cds	equ	'L' ; lastdrive
 19886                                  devmark_files	equ	'F'
 19887                                  devmark_fcbs	equ	'X'
 19888                                  devmark_inst	equ	'T' ; used for sysinit base for install= command.
 19889                                  devmark_ems_stub equ	'E'
 19890                                  
 19891                                  setbrkdone	equ	00000001b
 19892                                  for_devmark	equ	00000010b
 19893                                  not_for_devmark equ	11111101b
 19894                                  
 19895                                  ; ----------------------------------------------------------------------
 19896                                  ; Memory arena structure
 19897                                  
 19898                                  ; 24/03/2019 - Retro DOS v4.0 
 19899                                  ; (MSDOS 6.0, ARENA.INC)
 19900                                  
 19901                                  ;** Arena Header
 19902                                  
 19903                                  struc ARENA
 19904 00000000 ??                      .SIGNATURE:	resb 1		; 4D for valid item, 5A for last item
 19905 00000001 ????                    .OWNER:		resw 1		; owner of arena item
 19906 00000003 ????                    .SIZE:		resw 1		; size in paragraphs of item
 19907 00000005 ??????                  .RESERVED	resb 3		; reserved
 19908 00000008 ????????????????        .NAME:		resb 8		; owner file name
 19909                                  endstruc
 19910                                  
 19911                                  ; 12/04/2019
 19912                                  
 19913                                  arena_owner_system	EQU 0	; free block indication
 19914                                  
 19915                                  arena_signature_normal	EQU 4Dh ; valid signature, not end of arena
 19916                                  arena_signature_end	EQU 5Ah ; valid signature, last block in arena
 19917                                  
 19918                                  ; ----------------------------------------------------------------------
 19919                                  ; Process data block (otherwise known as program header)
 19920                                  
 19921                                  ; 23/03/2019 - Retro DOS v4.0
 19922                                  
 19923                                  ; (MSDOS 6.0 - PDB.INC, 1991)
 19924                                  
 19925                                  FILPERPROC	EQU     20
 19926                                  
 19927                                  struc PDB	; Process_data_block
 19928 00000000 ????                    .EXIT_CALL:	resw 1   	; INT int_abort system terminate
 19929 00000002 ????                    .BLOCK_LEN:	resw 1		; size of execution block
 19930 00000004 ??                                      resb 1
 19931 00000005 ??????????              .CPM_CALL:	resb 5		; ancient call to system
 19932 0000000A ????????                .EXIT:		resd 1		; pointer to exit routine
 19933 0000000E ????????                .CTRL_C:	resd 1		; pointer to ^C routine
 19934 00000012 ????????                .FATAL_ABORT:	resd 1		; pointer to fatal error
 19935 00000016 ????                    .PARENT_PID:	resw 1		; PID of parent (terminate PID)
 19936 00000018 <res 14h>               .JFN_TABLE:     resb FILPERPROC ; indices into system table
 19937 0000002C ????                    .ENVIRON:	resw 1		; seg addr of environment
 19938 0000002E ????????                .USER_STACK:	resd 1		; stack of self during system calls
 19939 00000032 ????                    .JFN_LENGTH:	resw 1 		; number of handles allowed
 19940 00000034 ????????                .JFN_POINTER:	resd 1 		; pointer to JFN table
 19941 00000038 ????????                .NEXT_PDB:	resd 1		; pointer to nested PDB's
 19942 0000003C ??                      .INTERCON:	resb 1 		; *** jh-3/28/90 ***
 19943 0000003D ??                      .APPEND:	resb 1		; *** Not sure if still used ***
 19944 0000003E ????                    .NOVELL_USED:	resb 2		; Novell shell (redir) uses these
 19945 00000040 ????                    .VERSION:	resw 1		; DOS version reported to this app
 19946 00000042 <res Eh>                .PAD1:		resb 14		; 	
 19947 00000050 ??????????              .CALL_SYSTEM:	resb 5		; portable method of system call
 19948 00000055 ??????????????          .PAD2:		resb 7 		; reserved so FCB 1 can be used as an extended FCB
 19949 0000005C <res 10h>               .FCB1:		resb 16		; default FCB 1
 19950 0000006C <res 10h>               .FCB2:		resb 16		; default FCB 2
 19951 0000007C ????????                .PAD3:		resb 4		; not sure if this is used by PDB_FCB2
 19952 00000080 <res 80h>               .TAIL:		resb 128	; command tail and default DTA
 19953                                  ;.size:
 19954                                  endstruc
 19955                                  
 19956                                  ; ----------------------------------------------------------------------
 19957                                  ; <system call definitions>
 19958                                  
 19959                                  ; 23/03/2019 - Retro DOS v4.0
 19960                                  
 19961                                  ; (MSDOS 6.0 - SYSCALL.INC, 1991)
 19962                                  
 19963                                  ABORT                           EQU 0   ;  0      0
 19964                                  STD_CON_INPUT                   EQU 1   ;  1      1
 19965                                  STD_CON_OUTPUT                  EQU 2   ;  2      2
 19966                                  STD_AUX_INPUT                   EQU 3   ;  3      3
 19967                                  STD_AUX_OUTPUT                  EQU 4   ;  4      4
 19968                                  STD_PRINTER_OUTPUT              EQU 5   ;  5      5
 19969                                  RAW_CON_IO                      EQU 6   ;  6      6
 19970                                  RAW_CON_INPUT                   EQU 7   ;  7      7
 19971                                  STD_CON_INPUT_NO_ECHO           EQU 8   ;  8      8
 19972                                  STD_CON_STRING_OUTPUT           EQU 9   ;  9      9
 19973                                  STD_CON_STRING_INPUT            EQU 10  ; 10      A
 19974                                  STD_CON_INPUT_STATUS            EQU 11  ; 11      B
 19975                                  STD_CON_INPUT_FLUSH             EQU 12  ; 12      C
 19976                                  DISK_RESET                      EQU 13  ; 13      D
 19977                                  SET_DEFAULT_DRIVE               EQU 14  ; 14      E
 19978                                  FCB_OPEN                        EQU 15  ; 15      F
 19979                                  FCB_CLOSE                       EQU 16  ; 16     10
 19980                                  DIR_SEARCH_FIRST                EQU 17  ; 17     11
 19981                                  DIR_SEARCH_NEXT                 EQU 18  ; 18     12
 19982                                  FCB_DELETE                      EQU 19  ; 19     13
 19983                                  FCB_SEQ_READ                    EQU 20  ; 20     14
 19984                                  FCB_SEQ_WRITE                   EQU 21  ; 21     15
 19985                                  FCB_CREATE                      EQU 22  ; 22     16
 19986                                  FCB_RENAME                      EQU 23  ; 23     17
 19987                                  GET_DEFAULT_DRIVE               EQU 25  ; 25     19
 19988                                  SET_DMA                         EQU 26  ; 26     1A
 19989                                  GET_DEFAULT_DPB                 EQU 31  ; 31     1F
 19990                                  FCB_RANDOM_READ                 EQU 33  ; 33     21
 19991                                  FCB_RANDOM_WRITE                EQU 34  ; 34     22
 19992                                  GET_FCB_FILE_LENGTH             EQU 35  ; 35     23
 19993                                  GET_FCB_POSITION                EQU 36  ; 36     24
 19994                                  SET_INTERRUPT_VECTOR            EQU 37  ; 37     25
 19995                                  CREATE_PROCESS_DATA_BLOCK       EQU 38  ; 38     26
 19996                                  FCB_RANDOM_READ_BLOCK           EQU 39  ; 39     27
 19997                                  FCB_RANDOM_WRITE_BLOCK          EQU 40  ; 40     28
 19998                                  PARSE_FILE_DESCRIPTOR           EQU 41  ; 41     29
 19999                                  GET_DATE                        EQU 42  ; 42     2A
 20000                                  SET_DATE                        EQU 43  ; 43     2B
 20001                                  GET_TIME                        EQU 44  ; 44     2C
 20002                                  SET_TIME                        EQU 45  ; 45     2D
 20003                                  SET_VERIFY_ON_WRITE             EQU 46  ; 46     2E
 20004                                  ; Extended functionality group
 20005                                  GET_DMA                         EQU 47  ; 47     2F
 20006                                  GET_VERSION                     EQU 48  ; 48     30
 20007                                  KEEP_PROCESS                    EQU 49  ; 49     31
 20008                                  GET_DPB                         EQU 50  ; 50     32
 20009                                  SET_CTRL_C_TRAPPING             EQU 51  ; 51     33
 20010                                  GET_INDOS_FLAG                  EQU 52  ; 52     34
 20011                                  GET_INTERRUPT_VECTOR            EQU 53  ; 53     35
 20012                                  GET_DRIVE_FREESPACE             EQU 54  ; 54     36
 20013                                  CHAR_OPER                       EQU 55  ; 55     37
 20014                                  INTERNATIONAL                   EQU 56  ; 56     38
 20015                                  ;   Directory Group
 20016                                  MKDIR                           EQU 57  ; 57     39
 20017                                  RMDIR                           EQU 58  ; 58     3A
 20018                                  CHDIR                           EQU 59  ; 59     3B
 20019                                  ;   File Group
 20020                                  CREAT                           EQU 60  ; 60     3C
 20021                                  OPEN                            EQU 61  ; 61     3D
 20022                                  CLOSE                           EQU 62  ; 62     3E
 20023                                  READ                            EQU 63  ; 63     3F
 20024                                  WRITE                           EQU 64  ; 64     40
 20025                                  UNLINK                          EQU 65  ; 65     41
 20026                                  LSEEK                           EQU 66  ; 66     42
 20027                                  CHMOD                           EQU 67  ; 67     43
 20028                                  IOCTL                           EQU 68  ; 68     44
 20029                                  XDUP                            EQU 69  ; 69     45
 20030                                  XDUP2                           EQU 70  ; 70     46
 20031                                  CURRENT_DIR                     EQU 71  ; 71     47
 20032                                  ;    Memory Group
 20033                                  ALLOC                           EQU 72  ; 72     48
 20034                                  DEALLOC                         EQU 73  ; 73     49
 20035                                  SETBLOCK                        EQU 74  ; 74     4A
 20036                                  ;    Process Group
 20037                                  EXEC                            EQU 75  ; 75     4B
 20038                                  EXIT                            EQU 76  ; 76     4C
 20039                                  WAITPROCESS			EQU 77  ; 77     4D
 20040                                  FIND_FIRST                      EQU 78  ; 78     4E
 20041                                  ;   Special Group
 20042                                  FIND_NEXT                       EQU 79  ; 79     4F
 20043                                  ; SPECIAL SYSTEM GROUP
 20044                                  SET_CURRENT_PDB                 EQU 80  ; 80     50
 20045                                  GET_CURRENT_PDB                 EQU 81  ; 81     51
 20046                                  GET_IN_VARS                     EQU 82  ; 82     52
 20047                                  SETDPB                          EQU 83  ; 83     53
 20048                                  GET_VERIFY_ON_WRITE             EQU 84  ; 84     54
 20049                                  DUP_PDB                         EQU 85  ; 85     55
 20050                                  RENAME                          EQU 86  ; 86     56
 20051                                  FILE_TIMES                      EQU 87  ; 87     57
 20052                                  ;
 20053                                  ALLOCOPER			EQU 88	; 88     58	
 20054                                  ; Network extention system calls
 20055                                  GetExtendedError		EQU 89	; 89	 59
 20056                                  CreateTempFile			EQU 90	; 90	 5A
 20057                                  CreateNewFile			EQU 91	; 91	 5B
 20058                                  LockOper			EQU 92	; 92	 5C Lock and Unlock
 20059                                  ServerCall			EQU 93	; 93	 5D CommitAll, ServerDOSCall,
 20060                                  					;	    CloseByName, CloseUser,
 20061                                  					;	    CloseUserProcess,
 20062                                  					;	    GetOpenFileList
 20063                                  UserOper			EQU 94	; 94	 5E Get and Set
 20064                                  AssignOper			EQU 95	; 95	 5F On, Off, Get, Set, Cancel
 20065                                  xNameTrans			EQU 96	; 96	 60
 20066                                  PathParse			EQU 97	; 97	 61
 20067                                  GetCurrentPSP			EQU 98	; 98	 62
 20068                                  Hongeul 			EQU 99	; 99	 63
 20069                                  ECS_CALL			EQU 99	; 99	 63  ;; DBCS support
 20070                                  Set_Printer_Flag		EQU 100 ; 100	 64
 20071                                  GetExtCntry			EQU 101 ; 101	 65
 20072                                  GetSetCdPg			EQU 102 ; 102	 66
 20073                                  ExtHandle			EQU 103 ; 103	 67
 20074                                  Commit				EQU 104 ; 104	 68
 20075                                  GetSetMediaID			EQU 105 ; 105	 69
 20076                                  IFS_IOCTL			EQU 107 ; 107	 6B
 20077                                  ExtOpen 			EQU 108 ; 108	 6C
 20078                                  ;
 20079                                  ;ifdef ROMEXEC
 20080                                  ;ROM_FIND_FIRST			EQU 109 ; 109    6D
 20081                                  ;ROM_FIND_NEXT			EQU 110 ; 110    6E
 20082                                  ;ROM_EXCLUDE			EQU 111 ; 111	 6F
 20083                                  ;endif
 20084                                  ;
 20085                                  Set_Oem_Handler 		EQU 248 ; 248	 F8
 20086                                  OEM_C1				EQU 249 ; 249	 F9
 20087                                  OEM_C2				EQU 250 ; 250	 FA
 20088                                  OEM_C3				EQU 251 ; 251	 FB
 20089                                  OEM_C4				EQU 252 ; 252	 FC
 20090                                  OEM_C5				EQU 253 ; 253	 FD
 20091                                  OEM_C6				EQU 254 ; 254	 FE
 20092                                  OEM_C7				EQU 255 ; 255	 FF
 20093                                  
 20094                                  ; ----------------------------------------------------------------------
 20095                                  ; SYSCONF.ASM (MSDOS 3.3 - 24/07/1987) 	
 20096                                  ; ----------------------------------------------------------------------
 20097                                  
 20098                                  ;;	IF	STACKSW
 20099                                  
 20100                                  ;;
 20101                                  ;; Internal Stack Parameters
 20102                                  ;EntrySize		equ	8
 20103                                  ;
 20104                                  ;MinCount		equ	8
 20105                                  ;DefaultCount		equ	9
 20106                                  ;MaxCount		equ	64
 20107                                  ;
 20108                                  ;MinSize 		equ	32
 20109                                  ;DefaultSize		equ	128
 20110                                  ;MaxSize 		equ	512
 20111                                  
 20112                                  ;;	ENDIF
 20113                                  
 20114                                  ; ----------------------------------------------------------------------
 20115                                  ; BIOSTRUC.INC (MSDOS 3.3 - 24/07/1987) 	
 20116                                  ; ----------------------------------------------------------------------
 20117                                  					  ;;Rev 3.30 Modification
 20118                                  ; ROM BIOS CALL PACKET STRUCTURES					  
 20119                                  									  
 20120                                  ;*******************************					  
 20121                                  ;System Service call ( Int 15h )					  
 20122                                  ;*******************************					  
 20123                                  ;Function AH = 0C0h, Return system configuration			  
 20124                                  ;For PC and PCJR on return:						  
 20125                                  ;	(AH)	= 80h							  
 20126                                  ;	(CY)	= 1							  
 20127                                  ;For PCXT, PC PORTABLE and PCAT on return:				  
 20128                                  ;	(AH)	= 86h							  
 20129                                  ;	(CY)	= 1							  
 20130                                  ;For all others:							  
 20131                                  ;	(AH)	= 0							  
 20132                                  ;	(CY)	= 0							  
 20133                                  ;	(ES:BX) = pointer to system descriptor vector in ROS		  
 20134                                  ; System descriptor :							  
 20135                                  ;	DW	xxxx		length of descriptor in bytes,		  
 20136                                  ;				minimum length = 8			  
 20137                                  ;	DB	xx		model byte				  
 20138                                  ;				0FFh	= PC				  
 20139                                  ;				0FEh	= PC/XT, Portable		  
 20140                                  ;				0FDh	= PC/JR 			  
 20141                                  ;				0FCh	= PC/AT				  
 20142                                  ;				0F9h	= Convertable			  
 20143                                  ;				0F8h	= Model 80			  
 20144                                  ;				0E0 thru 0EFh = reserved		  
 20145                                  ;									  
 20146                                  ;	DB	xx		secondary model byte			  
 20147                                  ;				000h	= PC1				  
 20148                                  ;				000h	= PC/XT, Portable		  
 20149                                  ;				000h	= PC/JR 			  
 20150                                  ;				000h	= PC/AT 			  
 20151                                  ;				001h	= PC/AT Model 339		  
 20152                                  ;				003h	= PC/RT				  
 20153                                  ;				000h	= Convertable			  
 20154                                  ;									  
 20155                                  ;	DB	xx		bios revision level			  
 20156                                  ;				00 for first release, subsequent release  
 20157                                  ;				of code with same model byte and	  
 20158                                  ;				secondary model byte require revison level
 20159                                  ;				to increase by one.			  
 20160                                  ;									  
 20161                                  ;	DB	xx		feature information byte 1		  
 20162                                  ;				X0000000 = 1, bios use DMA channel 3	  
 20163                                  ;					 = 0, DMA channel 3 not used	  
 20164                                  ;									  
 20165                                  ;				0X000000 = 1, 2nd Interrupt chip present  
 20166                                  ;					 = 0, 2nd Interrupt chip not present
 20167                                  ;									  
 20168                                  ;				00X00000 = 1, Real Time Clock present	  
 20169                                  ;					 = 0, Real Time Clock not present 
 20170                                  ;									  
 20171                                  ;				000X0000 = 1, Keyboard escape sequence(INT 15h)
 20172                                  ;						called in keyboard interrupt
 20173                                  ;						(Int 09h).		  
 20174                                  ;					 = 0, Keyboard escape sequence not
 20175                                  ;						called. 		  
 20176                                  ;				0000XXXX reserved			  
 20177                                  ;									  
 20178                                  ;	DB	xx		feature information byte 2 - reserved	  
 20179                                  ;									  
 20180                                  ;	DB	xx		feature information byte 2 - reserved	  
 20181                                  ;									  
 20182                                  ;	DB	xx		feature information byte 2 - reserved	  
 20183                                  ;									  
 20184                                  ;	DB	xx		feature information byte 2 - reserved	  
 20185                                  ;									  
 20186                                  
 20187                                  ; 22/03/2019									  
 20188                                  struc ROMBIOS_DESC		; BIOS_SYSTEM_DESCRIPTOR						  
 20189 00000000 ????                    .bios_sd_leng:		resw 1				  
 20190 00000002 ??                      .bios_sd_modelbyte:	resb 1					  
 20191                                  .bios_sd_scnd_modelbyte: 
 20192 00000003 ??                      			resb 1					  
 20193 00000004 ??                      			resb 1					  
 20194 00000005 ??                      .bios_sd_featurebyte1:	resb 1					  
 20195 00000006 ????????                			resb 4					  
 20196                                  endstruc					  
 20197                                  									  
 20198                                  ;FeatureByte1	bit map equates 					  
 20199                                  DMAchannel3		equ 10000000b					  
 20200                                  ScndIntController	equ 01000000b					  
 20201                                  RealTimeClock		equ 00100000b					  
 20202                                  KeyEscapeSeq		equ 00010000b					  
 20203                                  					;;End of Modification
 20204                                  
 20205                                  ; ----------------------------------------------------------------------
 20206                                  ; SYSVAR.INC (MSDOS 6.0 - 1991) 	
 20207                                  ; ----------------------------------------------------------------------
 20208                                  ; 22/03/2019 - Retro DOS v4.0
 20209                                  
 20210                                  ;	SCCSID = @(#)sysvar.asm 1.1 85/04/10
 20211                                  
 20212                                  struc SysInitVars
 20213                                  ; MSDOS 3.3
 20214 00000000 ????????                .SYSI_DPB:    resd 1			; DPB chain
 20215 00000004 ????????                .SYSI_SFT:    resd 1			; SFT chain
 20216 00000008 ????????                .SYSI_CLOCK:  resd 1			; CLOCK device
 20217 0000000C ????????                .SYSI_CON:    resd 1			; CON device
 20218 00000010 ????                    .SYSI_MAXSEC: resw 1			; maximum sector size
 20219 00000012 ????????                .SYSI_BUF:    resd 1			; buffer chain
 20220 00000016 ????????                .SYSI_CDS:    resd 1			; CDS list
 20221 0000001A ????????                .SYSI_FCB:    resd 1			; FCB chain
 20222 0000001E ????                    .SYSI_KEEP:   resw 1			; keep count
 20223 00000020 ??                      .SYSI_NUMIO:  resb 1			; number of block devices
 20224 00000021 ??                      .SYSI_NCDS:   resb 1			; number of CDS's
 20225 00000022 ????????                .SYSI_DEV:    resd 1			; device list
 20226                                  ; MSDOS 6.0
 20227 00000026 ????                    .SYSI_ATTR:	    resw 1		; null device attribute word
 20228 00000028 ????                    .SYSI_STRAT:	    resw 1		; null device strategy entry point
 20229 0000002A ????                    .SYSI_INTER:	    resw 1		; null device interrupt entry point
 20230 0000002C ????????????????        .SYSI_NAME:	    resb 8		; null device name
 20231                                  .SYSI_SPLICE:	    resb 0		; TRUE -> splicees being done
 20232 00000034 ????                    .SYSI_IBMDOS_SIZE:  resw 1		; DOS size in paragraphs
 20233 00000036 ????????                .SYSI_IFS_DOSCALL@: resd 1		; IFS DOS service rountine entry
 20234 0000003A ????????                .SYSI_IFS:	    resd 1	 	; IFS header chain
 20235 0000003E ????????                .SYSI_BUFFERS:	    resw 2		; BUFFERS= values (m,n)
 20236 00000042 ??                      .SYSI_BOOT_DRIVE:   resb 1		; boot drive A=1 B=2,..
 20237 00000043 ??                      .SYSI_DWMOVE:	    resb 1		; 1 if 386 machine
 20238 00000044 ????                    .SYSI_EXT_MEM:	    resw 1		; Extended memory size in KB.
 20239                                  .size:
 20240                                  endstruc
 20241                                  
 20242                                  ;This is added for more information exchage between DOS, BIOS.
 20243                                  ;DOS will give the pointer to SysInitTable in ES:DI. - J.K. 5/29/86
 20244                                  
 20245                                  ; 22/03/2019
 20246                                  struc SysInitVars_Ext
 20247 00000000 ????????                .SYSI_InitVars:	   resd 1	; Points to the above structure.
 20248 00000004 ????????                .SYSI_Country_Tab: resd 1	; DOS_Country_cdpg_info
 20249                                  endstruc
 20250                                  
 20251                                  ; 09/06/2018
 20252                                  ; 08/06/2018 - Retro DOS v3.0 (MSDOS 3.3)
 20253                                  SYSI_DPB    equ	0
 20254                                  SYSI_SFT    equ 4
 20255                                  SYSI_CLOCK  equ 8
 20256                                  SYSI_CON    equ 12
 20257                                  SYSI_MAXSEC equ 16
 20258                                  SYSI_BUF    equ 18 		
 20259                                  SYSI_CDS    equ 22
 20260                                  SYSI_FCB    equ 26
 20261                                  SYSI_KEEP   equ 30
 20262                                  SYSI_NUMIO  equ	32
 20263                                  SYSI_NCDS   equ	33
 20264                                  SYSI_DEV    equ 34
 20265                                  ; 22/03/2019 - Retro DOS v4.0 (MSDOS 6.0)
 20266                                  SYSI_ATTR	  equ 38
 20267                                  SYSI_STRAT	  equ 40
 20268                                  SYSI_INTER	  equ 42
 20269                                  SYSI_NAME	  equ 44
 20270                                  SYSI_SPLICE	  equ 52
 20271                                  SYSI_IBMDOS_SIZE  equ 53
 20272                                  SYSI_IFS_DOSCALL@ equ 55
 20273                                  SYSI_IFS	  equ 59
 20274                                  SYSI_BUFFERS	  equ 63
 20275                                  SYSI_BOOT_DRIVE   equ 67
 20276                                  SYSI_DWMOVE	  equ 68
 20277                                  SYSI_EXT_MEM	  equ 69
 20278                                  
 20279                                  ;The SYSI_BUF of SysInitVars points to the following structure
 20280                                  
 20281                                  EMS_MAP_BUFF_SIZE EQU 12	; EMS map buffer size
 20282                                  
 20283                                  struc BUFFINF 	; BUFFINFO
 20284 00000000 ????????                .Buff_Queue:	   resd	1	; Head of list of buffers
 20285 00000004 ????                    .Dirty_Buff_Count: resw 1	; number of dirty buffers in list
 20286 00000006 ????????                .Cache_ptr:	   resd 1	; pointer to secondary cache
 20287 0000000A ????                    .Cache_count:      resw 1	; number of secondary cache entries
 20288                                  
 20289 0000000C ??                      .Buff_In_HMA:	   resb 1	; flag to indicate that buffers
 20290                                  				; are in HMA
 20291 0000000D ????????                .Lo_Mem_Buff:	   resd 1	; Ptr to scratch buff in Low Mem
 20292                                  				;  used to read/write on disks
 20293 00000011 ????????                .UU_EMS_FIRST_PAGE:	resw 2
 20294 00000015 ????                    .UU_EMS_NPA640:		resw 1
 20295 00000017 ??                      .UU_EMS_mode:		resb 1	 ; no EMS = -1
 20296 00000018 ????                    .UU_EMS_handle:		resw 1	 ; EMS handle for buffers
 20297 0000001A ????                    .UU_EMS_PageFrame_Number: resw 1 ; EMS page frame number
 20298 0000001C ????                    .UU_EMS_Seg_Cnt:	resw 1	 ; EMS segment count
 20299 0000001E ????                    .UU_EMS_Page_Frame:	resw 1	 ; EMS page frame segment address
 20300 00000020 ????                    .UU_EMS_reserved:	resw 1	 ; EMS segment count
 20301 00000022 ??                      .UU_EMS_Map_Buff:	resb 1	 ; map buffer
 20302                                  .size:
 20303                                  endstruc
 20304                                  
 20305                                  ; ----------------------------------------------------------------------
 20306                                  ; CURDIR.INC (MSDOS 6.0 - 1991) 	
 20307                                  ; ----------------------------------------------------------------------
 20308                                  ; 22/03/2019 - Retro DOS v4.0
 20309                                  
 20310                                  ;**	CDS - Current Directory Structure
 20311                                  ;
 20312                                  ; CDS items are used bu the internal routines to store cluster numbers and
 20313                                  ; network identifiers for each logical name.  The ID field is used dually,
 20314                                  ; both as net ID and for a cluster number for local devices. In the case
 20315                                  ; of local devices, the cluster number will be -1 if there is a potential
 20316                                  ; of the disk being changed or if the path must be recracked.
 20317                                  ;
 20318                                  ;	Some pathnames have special preambles, such as
 20319                                  ;
 20320                                  ;		\\machine\sharename\...
 20321                                  ;	For these pathnames we can't allow ".." processing to back us
 20322                                  ;	up into the special front part of the name.  The CURDIR_END field
 20323                                  ;	holds the address of the seperator character which marks
 20324                                  ;	the split between the special preamble and the regular
 20325                                  ;	path list; ".." processing isn't allowed to back us up past
 20326                                  ;	(i.e., before) CURDIR_END
 20327                                  ;	For the root, it points at the leading /. For net
 20328                                  ;	assignments it points at the end (nul) of the initial assignment:
 20329                                  ;	A:/	\\foo\bar	    \\foo\bar\blech\bozo
 20330                                  ;	  ^		 ^		     ^
 20331                                  
 20332                                  DIRSTRLEN	EQU	64+3		; Max length in bytes of directory strings
 20333                                  TEMPLEN 	EQU	DIRSTRLEN*2
 20334                                  
 20335                                  struc 		curdir_list
 20336                                  ; MSDOS 3.3
 20337 00000000 <res 43h>               .cdir_text	resb	DIRSTRLEN	; text of assignment and curdir
 20338 00000043 ????                    .cdir_flags	resw	1		; various flags
 20339 00000045 ????????                .cdir_devptr	resd	1		; local pointer to DPB or net device
 20340 00000049 ????????                .cdir_ID	resw	2		; cluster of current dir (net ID)
 20341 0000004D ????                    .cdir_usr_word	resw	1
 20342 0000004F ????                    .cdir_end	resw	1		; end of assignment
 20343                                  ; MSDOS 6.0
 20344 00000051 ??                      .cdir_type:	resb	1		; IFS drive (2=ifs, 4=netuse)
 20345 00000052 ????????                .cdir_ifd_hdr:	resd	1		; Ptr to File System Header
 20346 00000056 ????                    .cdir_fsda:	resb	2		; File System Dependent Data Area
 20347                                  .size:
 20348                                  endstruc
 20349                                  
 20350                                  curdirlen	EQU	curdir_list.size	; Needed for screwed up
 20351                                  						; ASM87 which doesn't allow
 20352                                  						; Size directive as a macro
 20353                                  						; argument
 20354                                  %define curdir_netID	dword [curdir_list.cdir_ID]
 20355                                  
 20356                                  ;**	Flag values for CURDIR_FLAGS
 20357                                  
 20358                                  ;Flag word masks
 20359                                  curdir_isnet	EQU	1000000000000000B
 20360                                  curdir_isifs	EQU	1000000000000000B
 20361                                  curdir_inuse	EQU	0100000000000000B
 20362                                  curdir_splice	EQU	0010000000000000B
 20363                                  curdir_local	EQU	0001000000000000B
 20364                                  
 20365                                  ; ----------------------------------------------------------------------
 20366                                  ; SF.INC (MSDOS 6.0 - 1991) 	
 20367                                  ; ----------------------------------------------------------------------
 20368                                  ; 25/03/2019 - Retro DOS v4.0
 20369                                  
 20370                                  ; system file table
 20371                                  
 20372                                  ;**	System File Table SuperStructure
 20373                                  ;
 20374                                  ;	The system file table entries are allocated in contiguous groups.
 20375                                  ;	There may be more than one such groups; the SF "superstructure"
 20376                                  ;	tracks the groups.
 20377                                  
 20378                                  struc	SF
 20379 00000000 ????????                .SFLink:	resd	1
 20380 00000004 ????                    .SFCount:	resw	1		; number of entries
 20381 00000006 ????                    .SFTable:	resw	1		; beginning of array of the following
 20382                                  .size:
 20383                                  endstruc
 20384                                  
 20385                                  ;**	System file table entry
 20386                                  ;
 20387                                  ;	These are the structures which are at SFTABLE in the SF structure.
 20388                                  
 20389                                  struc	SF_ENTRY
 20390 00000000 ????                    .sf_ref_count:	resw	1		; number of processes sharing entry
 20391                                  					;   if FCB then ref count
 20392 00000002 ????                    .sf_mode: 	resw	1		; mode of access or high bit on if FCB
 20393 00000004 ??                      .sf_attr: 	resb	1		; attribute of file
 20394 00000005 ????                    .sf_flags:	resw	1		;Bits 8-15
 20395                                  					; Bit 15 = 1 if remote file
 20396                                  					;	 = 0 if local file or device
 20397                                  					; Bit 14 = 1 if date/time is not to be
 20398                                  					;   set from clock at CLOSE.  Set by
 20399                                  					;   FILETIMES and FCB_CLOSE.  Reset by
 20400                                  					;   other reseters of the dirty bit
 20401                                  					;   (WRITE)
 20402                                  					; Bit 13 = Pipe bit (reserved)
 20403                                  					;
 20404                                  					; Bits 0-7 (old FCB_devid bits)
 20405                                  					; If remote file or local file, bit
 20406                                  					; 6=0 if dirty Device ID number, bits
 20407                                  					; 0-5 if local file.
 20408                                  					; bit 7=0 for local file, bit 7
 20409                                  					;      =1 for local I/O device
 20410                                  					; If local I/O device, bit 6=0 if EOF (input)
 20411                                  					;		Bit 5=1 if Raw mode
 20412                                  					;		Bit 0=1 if console input device
 20413                                  					;		Bit 1=1 if console output device
 20414                                  					;		Bit 2=1 if null device
 20415                                  					;		Bit 3=1 if clock device
 20416 00000007 ????????                .sf_devptr:	resd	1		; Points to DPB if local file, points
 20417                                  					; to device header if local device,
 20418                                  					; points to net device header if
 20419                                  					; remote
 20420 0000000B ????                    .sf_firclus:	resw	1		; First cluster of file (bit 15 = 0)
 20421                                  ;.sf_lstclus:	resw	1 ; *	
 20422 0000000D ????                    .sf_time: 	resw	1		; Time associated with file
 20423 0000000F ????                    .sf_date: 	resw	1		; Date associated with file
 20424 00000011 ????????                .sf_size: 	resd	1		; Size associated with file
 20425 00000015 ????????                .sf_position:	resd	1		; Read/Write pointer or LRU count for FCBs
 20426                                  ;
 20427                                  ; Starting here, the next 7 bytes may be used by the file system to store an
 20428                                  ; ID
 20429                                  ;
 20430 00000019 ????                    .sf_cluspos:	resw	1		; Position of last cluster accessed
 20431 0000001B ????                    .sf_dirsec:	resw	1		; Sector number of directory sector for this file
 20432 0000001D ??                      .sf_dirpos:	resb	1		; Offset of this entry in the above
 20433                                  ;
 20434                                  ; End of 7 bytes of file-system specific info.
 20435                                  ;
 20436 0000001E <res Bh>                .sf_name:	resb	11		; 11 character name that is in the
 20437                                  					; directory entry.  This is used by
 20438                                  					; close to detect file deleted and
 20439                                  					; disk changed errors.
 20440                                  ; SHARING INFO
 20441 00000029 ????????                .sf_chain:	resd	1		; link to next SF
 20442 0000002D ????                    .sf_UID:	resw	1
 20443 0000002F ????                    .sf_PID:	resw	1
 20444 00000031 ????                    .sf_MFT:	resw	1
 20445 00000033 ????                    .sf_lstclus:	resw	1 ; *		; Last cluster accessed
 20446 00000035 ????????                .sf_IFS_HDR:	resd 	1 ; **
 20447                                  .size:
 20448                                  endstruc
 20449                                  
 20450                                  ; ----------------------------------------------------------------------
 20451                                  ; DOSCNTRY.INC (MSDOS 3.3 - 24/07/1987) 	
 20452                                  ; ----------------------------------------------------------------------
 20453                                  ; 11/06/2018 - Retro DOS v3.0
 20454                                  
 20455                                  ;Equates for COUNTRY INFORMATION.
 20456                                  SetCountryInfo		EQU	1	;country info
 20457                                  SetUcase		EQU	2	;uppercase table
 20458                                  SetLcase		EQU	3	;lowercase table (Reserved)
 20459                                  SetUcaseFile		EQU	4	;uppercase file spec table
 20460                                  SetFileList		EQU	5	;valid file character list
 20461                                  SetCollate		EQU	6	;collating sequence
 20462                                  SetDBCS 		EQU	7	;double byte character set
 20463                                  SetALL			EQU	-1	;all the entries
 20464                                  
 20465                                  ;DOS country and code page information table structure.
 20466                                  ;Internally, IBMDOS gives a pointer to this table.
 20467                                  ;IBMBIO, MODE and NLSFUNC modules communicate with IBMDOS through
 20468                                  ;this structure.
 20469                                  
 20470                                  struc country_cdpg_info ; DOS_country_cdpg_info
 20471 00000000 ????????????????        .ccInfo_reserved :	resb	8	;reserved for internal use
 20472 00000008 <res 40h>               .ccPath_CountrySys:	resb	64	;path and filename for country info
 20473 00000048 ????                    .ccSysCodePage:		resw	1	;system code page id
 20474 0000004A ????                    .ccNumber_of_entries:	resw	1 ; dw 5
 20475 0000004C ??                      .ccSetUcase:		resb	1 ; db SetUcase ; = 2
 20476 0000004D ????????                .ccUcase_ptr:		resd	1	;pointer to Ucase table
 20477                                  
 20478 00000051 ??                      .ccSetUcaseFile:	resb	1 ; db SetUcaseFile ; = 4
 20479 00000052 ????????                .ccFileUcase_ptr: 	resd	1	;pointer to File Ucase table
 20480                                  
 20481 00000056 ??                      .ccSetFileList:		resb	1 ; db SetFileList ; = 5
 20482 00000057 ????????                .ccFileChar_ptr:	resd	1	;pointer to File char list table
 20483                                  
 20484 0000005B ??                      .ccSetCollate:		resb	1 ; db SetCollate ; = 6
 20485 0000005C ????????                .ccCollate_ptr:		resd	1	;pointer to collate table
 20486                                  
 20487 00000060 ??                      .ccSetCountryInfo:	resb	1 ; db SetCountryInfo ; = 1
 20488 00000061 ????                    .ccCountryInfoLen:	resw	1	;length of country info
 20489 00000063 ????                    .ccDosCountry:		resw	1	;system country code id
 20490 00000065 ????                    .ccDosCodePage:		resw	1	;system code page id
 20491 00000067 ????                    .ccDFormat:		resw	1	;date format
 20492 00000069 ??????????              .ccCurSymbol:		resb	5 ; db "    ",0
 20493                                  					;5 byte of (currency symbol+0)
 20494 0000006E ????                    .cc1000Sep:		resb	2 ; db " ",0 ;2 byte of (1000 sep. + 0)
 20495 00000070 ????                    .ccDecSep:		resb	2 ; db " ",0 ;2 byte of (Decimal sep. + 0)
 20496 00000072 ????                    .ccDateSep:		resb	2 ; db " ",0 ;2 byte of (date sep. + 0)
 20497 00000074 ????                    .ccTimeSep:		resb 	2 ; db " ",0 ;2 byte of (time sep. + 0)
 20498 00000076 ??                      .ccCFormat:		resb	1 	;currency format flags
 20499 00000077 ??                      .ccCSigDigits:		resb	1	;# of digits in currency
 20500 00000078 ??                      .ccTFormat:		resb	1	;time format
 20501 00000079 ????????                .ccMono_Ptr:		resd	1	;monocase routine entry point
 20502 0000007D ????                    .ccListSep:		resb	2 ; db " ",0 ;data list separator
 20503 0000007F <res Ah>                .ccReserved_area: 	resw	5 ; dw 5 dup(?) ;reserved
 20504                                  .size:
 20505                                  endstruc
 20506                                  
 20507                                  NEW_COUNTRY_SIZE    equ  country_cdpg_info.size - country_cdpg_info.ccDosCountry
 20508                                  
 20509                                  ; ======================================================================
 20510                                  ; retrodos4.s (offset addresses in MSDOS.SYS or RETRODOS.SYS)
 20511                                  ; ======================================================================
 20512                                  ; 21/03/2019 - Retro DOS v4.0
 20513                                  ; 21/10/2022 - Retro DOS v4.0 (MOdified MSDOS 5.0 IO.SYS)
 20514                                  
 20515                                  ;KERNEL_SEGMENT	equ 0070h  ; (IO.SYS loading segment, BIOS_DATA segment)
 20516                                  ; 21/10/2022
 20517                                  DOSBIODATASEG equ 0070h	; (IO.SYS loading segment, BIOS_DATA segment)
 20518                                  ; 22/10/2022
 20519                                  ;DOSBIOCODESEG equ 02C7h ; (MSDOS 5.0 IO.SYS, BIOS_CODE segment)
 20520                                  ; 09/12/2022
 20521                                  DOSBIOCODESEG equ IOSYSCODESEG
 20522                                  
 20523                                  ; Note: These offset addresses must be chanqed when the code 
 20524                                  ; 	in retrodos4.s (MSDOS.SYS) file will be changed.
 20525                                  
 20526                                  ; (following addresses can be verified by searching them in retrodos4.lst) 
 20527                                  
 20528                                  ; 09/12/2022
 20529                                  %if 0
 20530                                  
 20531                                  ; 13/05/2019
 20532                                  
 20533                                  ;IsWin386         equ 08CFh
 20534                                  ;V86_Crit_SetFocus equ 08D0h
 20535                                  ; 21/10/2022
 20536                                  IsWin386          equ 08D0h
 20537                                  V86_Crit_SetFocus equ 08D1h 
 20538                                  
 20539                                  ;seg_reinit	  equ 0772h ; not used in Retro DOS v4.0
 20540                                  ; 21/10/2022 - Retro DOS v4.0 (MOdified MSDOS 5.0 IO.SYS)
 20541                                  seg_reinit	  equ 0032h ; DOSBIOCODESEG:0032h
 20542                                  
 20543                                  ;SysinitPresent	  equ 08FCh
 20544                                  ; 21/10/2022
 20545                                  SysinitPresent	  equ 08FDh
 20546                                  
 20547                                  inHMA		  equ 000Dh
 20548                                  xms		  equ 000Eh
 20549                                  ;FreeHMAPtr	  equ 08F6h
 20550                                  ;multrk_flag	  equ 0533h
 20551                                  ;ec35_flag	  equ 0535h
 20552                                  ;EOT		  equ 012Eh
 20553                                  ; 21/10/2022
 20554                                  FreeHMAPtr	  equ 08F7h
 20555                                  multrk_flag	  equ 052Fh
 20556                                  ec35_flag	  equ 0531h
 20557                                  EOT		  equ 012Ch
 20558                                  
 20559                                  ;NextStack	  equ 08BFh
 20560                                  ;IT_StackLoc	  equ 08C5h
 20561                                  ;IT_StackSize	  equ 08C9h
 20562                                  ; 21/10/2022
 20563                                  NextStack	  equ 08C0h
 20564                                  IT_StackLoc	  equ 08C6h
 20565                                  IT_StackSize	  equ 08CAh
 20566                                  
 20567                                  ;MoveDOSIntoHMA	  equ 08F8h
 20568                                  ; 21/10/2022
 20569                                  MoveDOSIntoHMA	  equ 08F9h
 20570                                  
 20571                                  ;INT19SEM equ 0644h ; 01/05/2019 - retrodos4.lst
 20572                                  ;I19_LST  equ 0645h ; 27/03/2019 - retrodos4.lst
 20573                                  ; 21/10/2022
 20574                                  INT19SEM equ 0640h ; (iosys5.txt)
 20575                                  I19_LST  equ 0641h ; (iosys5.txt)
 20576                                  
 20577                                  %endif
 20578                                  
 20579                                  ; 09/12/2022
 20580                                  seg_reinit equ _seg_reinit
 20581                                  ec35_flag  equ ec35flag		
 20582                                  INT19SEM   equ int19sem
 20583                                  I19_LST    equ i19_lst
 20584                                  
 20585                                  INT19OLD02 equ I19_LST+1 ; 0642h ; 21/10/2022
 20586                                  INT19OLD08 equ I19_LST+6
 20587                                  INT19OLD09 equ I19_LST+11
 20588                                  INT19OLD0A equ I19_LST+16
 20589                                  INT19OLD0B equ I19_LST+21
 20590                                  INT19OLD0C equ I19_LST+26
 20591                                  INT19OLD0D equ I19_LST+31
 20592                                  INT19OLD0E equ I19_LST+36
 20593                                  INT19OLD70 equ I19_LST+41
 20594                                  INT19OLD72 equ I19_LST+46
 20595                                  INT19OLD73 equ I19_LST+51
 20596                                  INT19OLD74 equ I19_LST+56
 20597                                  INT19OLD76 equ I19_LST+61
 20598                                  INT19OLD77 equ I19_LST+66 ; 0683h ; 21/10/2022
 20599                                  
 20600                                  ; 09/12/2022
 20601                                  %if 0
 20602                                  
 20603                                  ;keyrd_func	equ 04E9h
 20604                                  ;keysts_func	equ 04EAh
 20605                                  ;t_switch	equ 04F6h
 20606                                  ; 21/10/2022
 20607                                  keyrd_func	equ 04E5h
 20608                                  keysts_func	equ 04E6h
 20609                                  t_switch	equ 04F2h
 20610                                  
 20611                                  ; 22/10/2022
 20612                                  SYSINITSEG	equ 046Dh  ; SYSINIT segment
 20613                                  BCODE_END	equ (SYSINITSEG-DOSBIOCODESEG)*16 ; = 1A60h
 20614                                  BCODE_START	equ 30h  ; (offset BiosDataWord in DOSBIOCODESEG) 
 20615                                  RE_INIT		equ 089Bh ; (re_init offset in DOSBIODATASEG)
 20616                                  
 20617                                  %endif
 20618                                  
 20619                                  ; 09/12/2022
 20620                                  BCODESTART	equ BIOSDATAWORD
 20621                                  RE_INIT		equ re_init
 20622                                  
 20623                                  ; ----------------------------------------------------------------------
 20624                                  ; CONFIG.INC (MSDOS 6.0 - 1991) 	
 20625                                  ; ----------------------------------------------------------------------
 20626                                  ; 15/04/2019 - Retro DOS v4.0
 20627                                  
 20628                                  CONFIG_BEGIN        equ  '['
 20629                                  CONFIG_BREAK        equ  'C'
 20630                                  CONFIG_BUFFERS      equ  'B'
 20631                                  CONFIG_COMMENT      equ  'Y'
 20632                                  CONFIG_COUNTRY      equ  'Q'
 20633                                  CONFIG_DEVICE       equ  'D'
 20634                                  CONFIG_DEVICEHIGH   equ  'U'
 20635                                  CONFIG_DOS          equ  'H'
 20636                                  CONFIG_DRIVPARM     equ  'P'
 20637                                  CONFIG_FCBS         equ  'X'
 20638                                  CONFIG_FILES        equ  'F'
 20639                                  CONFIG_INCLUDE      equ  'J'
 20640                                  CONFIG_INSTALL      equ  'I'
 20641                                  CONFIG_INSTALLHIGH  equ  'W'
 20642                                  CONFIG_LASTDRIVE    equ  'L'
 20643                                  CONFIG_MENUCOLOR    equ  'R'
 20644                                  CONFIG_MENUDEFAULT  equ  'A'
 20645                                  CONFIG_MENUITEM     equ  'E'
 20646                                  CONFIG_MULTITRACK   equ  'M'
 20647                                  CONFIG_NUMLOCK      equ  'N'
 20648                                  CONFIG_REM          equ  '0'
 20649                                  CONFIG_SEMICOLON    equ  ';'
 20650                                  CONFIG_SET          equ  'V'
 20651                                  CONFIG_SHELL        equ  'S'
 20652                                  CONFIG_STACKS       equ  'K'
 20653                                  CONFIG_SUBMENU      equ  'O'
 20654                                  CONFIG_SWITCHES     equ  '1'
 20655                                  
 20656                                  CONFIG_UNKNOWN      equ  'Z'
 20657                                  
 20658                                  CONFIG_OPTION_QUERY equ 80h
 20659                                  
 20660                                  ; ----------------------------------------------------------------------
 20661                                  ; SYSINIT1.ASM (MSDOS 6.0 - 1991) 	
 20662                                  ; ----------------------------------------------------------------------
 20663                                  ; 21/03/2019 - Retro DOS v4.0
 20664                                  
 20665                                  true	equ	0FFFFh
 20666                                  false	equ	0
 20667                                  cr	equ	13
 20668                                  lf	equ	10
 20669                                  tab	equ	9
 20670                                  
 20671                                  multMULT	   equ	4Ah
 20672                                  multMULTGETHMAPTR  equ	1
 20673                                  multMULTALLOCHMA   equ	2
 20674                                  
 20675                                  ;NOEXEC    equ	FALSE
 20676                                  
 20677                                  stacksw    equ	true	;include switchable hardware stacks
 20678                                  mycds_size equ	88	;size of curdir_list. if it is not
 20679                                  			;the same, then will generate compile error.
 20680                                  
 20681                                  entrysize   equ     8
 20682                                  
 20683                                  mincount    equ     8
 20684                                  defaultcount equ    9
 20685                                  maxcount    equ     64
 20686                                  
 20687                                  minsize     equ     32
 20688                                  defaultsize equ     128
 20689                                  maxsize     equ     512
 20690                                  
 20691                                  ;%define allocbyte  byte [es:bp+0]
 20692                                  ;%define intlevel   byte [es:bp+1]
 20693                                  ;%define savedsp    word [es:bp+2]
 20694                                  ;%define savedss    word [es:bp+4]
 20695                                  ;%define newsp	    word [es:bp+6]
 20696                                  
 20697                                  allocbyte   equ     0
 20698                                  intlevel    equ     1
 20699                                  savedsp     equ     2
 20700                                  savedss     equ     4
 20701                                  newsp       equ     6
 20702                                  
 20703                                  free	    equ     0
 20704                                  allocated   equ     1
 20705                                  overflowed  equ     2
 20706                                  clobbered   equ     3
 20707                                  
 20708                                  ;---------------------------------------
 20709                                  ; external variable defined in ibmbio module for multi-track
 20710                                  
 20711                                  multrk_on equ	10000000b ;user specified mutitrack=on,or system turns
 20712                                  			  ; it on after handling config.sys file as a
 20713                                  			  ; default value,if multrk_flag = multrk_off1.
 20714                                  multrk_off1 equ 00000000b ;initial value. no "multitrack=" command entered.
 20715                                  multrk_off2 equ 00000001b ;user specified multitrack=off.
 20716                                  
 20717                                  ; SYSINITSEG	SEGMENT PUBLIC 'SYSTEM_INIT'
 20718                                  
 20719                                  SYSINIT$:
 20720                                  	;IF	STACKSW 
 20721                                  	; include MSSTACK.INC	;Main stack program and data definitions
 20722                                  	; include STKMES.INC	;Fatal stack error message
 20723                                  	;   public Endstackcode
 20724                                  ;Endstackcode	label byte
 20725                                  	;ENDIF
 20726                                  
 20727                                  ; 05/07/2018
 20728                                  ; ----------------------------------------------------------------------
 20729                                  ; 04/06/2018 - Retro DOS v3.0
 20730                                  
 20731                                  ; ----------------------------------------------------------------------
 20732                                  ; 21/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS - SYSINIT)
 20733                                  ; ----------------------------------------------------------------------
 20734                                  
 20735                                  ;	MSStack.inc
 20736                                  ;
 20737                                  ;	Interrupt level 2, 3, 4, 5, 6, 7,(10, 11, 12, 14, 15 - AT level)
 20738                                  ;	should follow the standard Interrupt Sharing Scheme which has
 20739                                  ;	a standard header structure.
 20740                                  ;	Fyi, the following shows the relations between
 20741                                  ;	the interrupt vector and interrupt level.
 20742                                  ; VEC(Hex)    2  8  9  A  B  C	D  E  70  72  73  74  76  77
 20743                                  ; LVL(Deci)   9  0  1  2  3  4	5  6   8  10  11  12  14  15
 20744                                  ;	MSSTACK module modifies the following interrupt vectors
 20745                                  ;	to meet the standard Interrupt Sharing standard;
 20746                                  ;	  A, B, C, D, E, 72, 73, 74, 76, 77.
 20747                                  ;	Also, for interrupt level 7 and 15, the FirstFlag in a standard header
 20748                                  ;	should be initialized to indicat whether this interrupt handler is
 20749                                  ;	the first (= 80h) or not.  The FirstFlag entry of INT77h's
 20750                                  ;	program header is initialized in STKINIT.INC module.
 20751                                  ;	FirstFlag is only meaningful for interrupt level 7 and 15.
 20752                                  ;
 20753                                  
 20754                                  ;  User specifies the number of stack elements - default = 9
 20755                                  ;						 minimum = 8
 20756                                  ;						 maximum = 64
 20757                                  ;
 20758                                  ;  Intercepts Asynchronous Hardware Interrupts only
 20759                                  ;
 20760                                  ;  Picks a stack from pool of stacks and switches to it
 20761                                  ;
 20762                                  ;  Calls the previously saved interrupt vector after pushing flags
 20763                                  ;
 20764                                  ;  On return, returns the stack to the stack pool
 20765                                  ;
 20766                                  
 20767                                  ; This is a modification of STACKS:
 20768                                  ; 1. To fix a bug which was causing the program to take up too much space.
 20769                                  ; 2. To dispense stack space from hi-mem first rather than low-mem first.
 20770                                  ;    . Clobbers the stack that got too big instead of innocent stack
 20771                                  ;    . Allows system to work if the only stack that got too big was the most
 20772                                  ;      deeply nested one
 20773                                  ; 3. Disables NMI interrupts while setting the NMI vector.
 20774                                  ; 4. Does not intercept any interupts on a PCjr.
 20775                                  ; 5. Double checks that a nested interrupt didn't get the same stack.
 20776                                  ; 6. Intercepts Ints 70, 72-77 for PC-ATs and other future products
 20777                                  
 20778                                  		;EVEN
 20779                                  ;align 2
 20780                                  		; 21/10/2022
 20781                                  
 20782 00000000 0000                    		dw	0	; spare field but leave these in order
 20783 00000002 0000                    stackcount:	dw	0
 20784 00000004 0000                    stackat: 	dw	0
 20785 00000006 0000                    stacksize:	dw	0
 20786 00000008 0000                    stacks:		dw	0
 20787 0000000A 0000                    		dw	0
 20788                                  
 20789 0000000C [0800]                  firstentry:	dw	stacks
 20790 0000000E [4800]                  lastentry:	dw	stacks+(defaultcount*entrysize)-entrysize
 20791 00000010 [4800]                  nextentry:	dw	stacks+(defaultcount*entrysize)-entrysize
 20792                                  
 20793                                  ;***********************************************************************
 20794                                  ; THESE ARE THE INDIVIDUAL INTERRUPT HANDLERS
 20795                                  
 20796                                  ; ----------------------------------------------------------------------
 20797                                  
 20798 00000012 00000000                old02:	dd	0
 20799                                  
 20800                                  int02:
 20801                                  
 20802                                  ; *********************************************************************
 20803                                  ;
 20804                                  ; this is special support for the pc convertible / nmi handler
 20805                                  ;
 20806                                  ;	on the pc convertible, there is a situation where an nmi can be 
 20807                                  ;	caused by using the "out" instructions to certain ports. when this
 20808                                  ;	occurs, the pc convertible hardware *guarantees* that **nothing** 
 20809                                  ;	can stop the nmi or interfere with getting to the nmi handler. this
 20810                                  ;	includes other type of interrupts (hardware and software), and
 20811                                  ;	also includes other type of nmi's. when any nmi has occured,
 20812                                  ;	no other interrtupt (hardware, software or nmi) can occur until
 20813                                  ;	the software takes specific steps to allow further interrupting.
 20814                                  ;
 20815                                  ;	for pc convertible, the situation where the nmi is generated by the
 20816                                  ;	"out" to a control port requires "fixing-up" and re-attempting. in
 20817                                  ;	otherwords, it is actually a "restartable exception". in this
 20818                                  ;	case, the software handler must be able to get to the stack in
 20819                                  ;	order to figure out what instruction caused the problem, where
 20820                                  ;	it was "out"ing to and what value it was "out"ing.  therefore,
 20821                                  ;	we will not switch stacks in this situation. this situation is
 20822                                  ;	detected by interrogating port 62h, and checking for a bit value
 20823                                  ;	of 80h. if set, *****do not switch stacks*****.
 20824                                  ;
 20825                                  ; *********************************************************************
 20826                                  
 20827 00000016 50                      	push	ax
 20828 00000017 06                      	push	es
 20829 00000018 B800F0                  	mov	ax,0F000h
 20830 0000001B 8EC0                    	mov	es,ax
 20831                                  	; 02/11/2022
 20832 0000001D 26803EFEFFF9            	cmp	byte [es:0FFFEh],0F9h ; mdl_convert ; check if convertible
 20833 00000023 07                      	pop	es
 20834 00000024 750C                    	jne	short normal02
 20835                                  
 20836 00000026 E462                    	in	al,62h		; PC/XT PPI port C. Bits:
 20837                                  				; 0-3: values of DIP switches
 20838                                  				; 5: 1=Timer 2 channel out
 20839                                  				; 6: 1=I/O channel check
 20840                                  				; 7: 1=RAM parity check error occurred.
 20841 00000028 A880                    	test	al,80h
 20842 0000002A 7406                    	jz	short normal02
 20843                                  special02:
 20844 0000002C 58                      	pop	ax
 20845 0000002D 2EFF2E[1200]            	jmp	far [cs:old02]
 20846                                  normal02:
 20847 00000032 58                      	pop	ax
 20848 00000033 E81101                  	call	do_int_stacks
 20849 00000036 [1200]                  	dw	old02
 20850                                  
 20851                                  ; ----------------------------------------------------------------------
 20852                                  
 20853 00000038 00000000                old08:	dd	0
 20854                                  
 20855                                  int08:
 20856 0000003C E80801                  	call	do_int_stacks
 20857 0000003F [3800]                  	dw	old08
 20858                                  
 20859                                  ; ----------------------------------------------------------------------
 20860                                  
 20861 00000041 00000000                old09:	dd	0
 20862                                  
 20863                                  int09:
 20864                                  
 20865                                  ; keyboard interrupt must have a three byte jump, a nop and a zero byte
 20866                                  ; as its first instruction for compatibility reasons
 20867                                  
 20868 00000045 EB02                    	jmp	short keyboard_lbl
 20869 00000047 90                      	nop
 20870 00000048 00                      	db	0
 20871                                  
 20872                                  keyboard_lbl:
 20873 00000049 E8FB00                  	call	do_int_stacks
 20874 0000004C [4100]                  	dw	old09
 20875                                  
 20876                                  ; ----------------------------------------------------------------------
 20877                                  
 20878 0000004E 00000000                old70:	dd	0
 20879                                  
 20880                                  int70:
 20881 00000052 E8F200                  	call	do_int_stacks
 20882 00000055 [4E00]                  	dw	old70
 20883                                  
 20884                                  ; ----------------------------------------------------------------------
 20885                                  
 20886                                  ;	irp	a,<0a,0b,0c,0d,0e,72,73,74,76,77>
 20887                                  ;public	int&a
 20888                                  ;public	old&a
 20889                                  ;public	firstflag&a
 20890                                  ;int&a	proc	far
 20891                                  ;	jmp	short entry_int&a&_stk
 20892                                  ;old&a	dd	  0		;forward pointer
 20893                                  ;	dw	  424bh 	;compatible signature for int. sharing
 20894                                  ;firstflag&a db   0		;the firstly hooked.
 20895                                  ;	jmp	short intret_&a	;reset routine. we don't care this.
 20896                                  ;	db	7 dup (0)	;reserved for future.
 20897                                  ;entry_int&a&_stk:
 20898                                  ;	call	do_int_stacks
 20899                                  ;	dw	old&a
 20900                                  ;intret_&a:
 20901                                  ;	iret
 20902                                  ;int&a	endp
 20903                                  ;	endm
 20904                                  
 20905                                  ; ----------------------------------------------------------------------
 20906                                  
 20907                                  int0A:
 20908 00000057 EB10                    	jmp	short entry_int0A_stk
 20909 00000059 00000000                old0A:	dd	0	
 20910 0000005D 4B42                    	dw	424Bh
 20911                                  firstflag0A:
 20912 0000005F 00                      	db	0
 20913 00000060 EB0C                    	jmp	short intret_0A
 20914 00000062 00<rep 7h>              	times	7 db 0
 20915                                  
 20916                                  entry_int0A_stk:
 20917 00000069 E8DB00                  	call	do_int_stacks
 20918 0000006C [5900]                  	dw	old0A
 20919                                  intret_0A:
 20920 0000006E CF                      	iret
 20921                                  
 20922                                  ; ----------------------------------------------------------------------
 20923                                  
 20924                                  int0B:
 20925 0000006F EB10                    	jmp	short entry_int0B_stk
 20926 00000071 00000000                old0B:	dd	0	
 20927 00000075 4B42                    	dw	424Bh
 20928                                  firstflag0B:
 20929 00000077 00                      	db	0
 20930 00000078 EB0C                    	jmp	short intret_0B
 20931 0000007A 00<rep 7h>              	times	7 db 0
 20932                                  
 20933                                  entry_int0B_stk:
 20934 00000081 E8C300                  	call	do_int_stacks
 20935 00000084 [7100]                  	dw	old0B
 20936                                  intret_0B:
 20937 00000086 CF                      	iret
 20938                                  
 20939                                  ; ----------------------------------------------------------------------
 20940                                  
 20941                                  int0C:
 20942 00000087 EB10                    	jmp	short entry_int0C_stk
 20943 00000089 00000000                old0C:	dd	0	
 20944 0000008D 4B42                    	dw	424Bh
 20945                                  firstflag0C:
 20946 0000008F 00                      	db	0
 20947 00000090 EB0C                    	jmp	short intret_0C
 20948 00000092 00<rep 7h>              	times	7 db 0
 20949                                  
 20950                                  entry_int0C_stk:
 20951 00000099 E8AB00                  	call	do_int_stacks
 20952 0000009C [8900]                  	dw	old0C
 20953                                  intret_0C:
 20954 0000009E CF                      	iret
 20955                                  
 20956                                  ; ----------------------------------------------------------------------
 20957                                  
 20958                                  int0D:
 20959 0000009F EB10                    	jmp	short entry_int0D_stk
 20960 000000A1 00000000                old0D:	dd	0	
 20961 000000A5 4B42                    	dw	424Bh
 20962                                  firstflag0D:
 20963 000000A7 00                      	db	0
 20964 000000A8 EB0C                    	jmp	short intret_0D
 20965 000000AA 00<rep 7h>              	times	7 db 0
 20966                                  
 20967                                  entry_int0D_stk:
 20968 000000B1 E89300                  	call	do_int_stacks
 20969 000000B4 [A100]                  	dw	old0D
 20970                                  intret_0D:
 20971 000000B6 CF                      	iret
 20972                                  
 20973                                  ; ----------------------------------------------------------------------
 20974                                  
 20975                                  int0E:
 20976 000000B7 EB10                    	jmp	short entry_int0E_stk
 20977 000000B9 00000000                old0E:	dd	0	
 20978 000000BD 4B42                    	dw	424Bh
 20979                                  firstflag0E:
 20980 000000BF 00                      	db	0
 20981 000000C0 EB0C                    	jmp	short intret_0E
 20982 000000C2 00<rep 7h>              	times	7 db 0
 20983                                  
 20984                                  entry_int0E_stk:
 20985 000000C9 E87B00                  	call	do_int_stacks
 20986 000000CC [B900]                  	dw	old0E
 20987                                  intret_0E:
 20988 000000CE CF                      	iret
 20989                                  
 20990                                  ; ----------------------------------------------------------------------
 20991                                  
 20992                                  int72:
 20993 000000CF EB10                    	jmp	short entry_int72_stk
 20994 000000D1 00000000                old72:	dd	0	
 20995 000000D5 4B42                    	dw	424Bh
 20996                                  firstflag72:
 20997 000000D7 00                      	db	0
 20998 000000D8 EB0C                    	jmp	short intret_72
 20999 000000DA 00<rep 7h>              	times	7 db 0
 21000                                  
 21001                                  entry_int72_stk:
 21002 000000E1 E86300                  	call	do_int_stacks
 21003 000000E4 [D100]                  	dw	old72
 21004                                  intret_72:
 21005 000000E6 CF                      	iret
 21006                                  
 21007                                  ; ----------------------------------------------------------------------
 21008                                  
 21009                                  int73:
 21010 000000E7 EB10                    	jmp	short entry_int73_stk
 21011 000000E9 00000000                old73:	dd	0	
 21012 000000ED 4B42                    	dw	424Bh
 21013                                  firstflag73:
 21014 000000EF 00                      	db	0
 21015 000000F0 EB0C                    	jmp	short intret_73
 21016 000000F2 00<rep 7h>              	times	7 db 0
 21017                                  
 21018                                  entry_int73_stk:
 21019 000000F9 E84B00                  	call	do_int_stacks
 21020 000000FC [E900]                  	dw	old73
 21021                                  intret_73:
 21022 000000FE CF                      	iret
 21023                                  
 21024                                  ; ----------------------------------------------------------------------
 21025                                  
 21026                                  int74:
 21027 000000FF EB10                    	jmp	short entry_int74_stk
 21028 00000101 00000000                old74:	dd	0	
 21029 00000105 4B42                    	dw	424Bh
 21030                                  firstflag74:
 21031 00000107 00                      	db	0
 21032 00000108 EB0C                    	jmp	short intret_74
 21033 0000010A 00<rep 7h>              	times	7 db 0
 21034                                  
 21035                                  entry_int74_stk:
 21036 00000111 E83300                  	call	do_int_stacks
 21037 00000114 [0101]                  	dw	old74
 21038                                  intret_74:
 21039 00000116 CF                      	iret
 21040                                  
 21041                                  ; ----------------------------------------------------------------------
 21042                                  
 21043                                  int76:
 21044 00000117 EB10                    	jmp	short entry_int76_stk
 21045 00000119 00000000                old76:	dd	0	
 21046 0000011D 4B42                    	dw	424Bh
 21047                                  firstflag76:
 21048 0000011F 00                      	db	0
 21049 00000120 EB0C                    	jmp	short intret_76
 21050 00000122 00<rep 7h>              	times	7 db 0
 21051                                  
 21052                                  entry_int76_stk:
 21053 00000129 E81B00                  	call	do_int_stacks
 21054 0000012C [1901]                  	dw	old76
 21055                                  intret_76:
 21056 0000012E CF                      	iret
 21057                                  
 21058                                  ; ----------------------------------------------------------------------
 21059                                  
 21060                                  int77:
 21061 0000012F EB10                    	jmp	short entry_int77_stk
 21062 00000131 00000000                old77:	dd	0	
 21063 00000135 4B42                    	dw	424Bh
 21064                                  firstflag77:
 21065 00000137 00                      	db	0
 21066 00000138 EB0C                    	jmp	short intret_77
 21067 0000013A 00<rep 7h>              	times	7 db 0
 21068                                  
 21069                                  entry_int77_stk:
 21070 00000141 E80300                  	call	do_int_stacks
 21071 00000144 [3101]                  	dw	old77
 21072                                  intret_77:
 21073 00000146 CF                      	iret
 21074                                  
 21075                                  ; ----------------------------------------------------------------------
 21076                                  
 21077                                  ;********************************************************************
 21078                                  ;common routines
 21079                                  ;********************************************************************
 21080                                  
 21081                                  ; do interrupt stack switching. the fake return address holds
 21082                                  ; a pointer to the far-pointer of the actual interrupt
 21083                                  ; service routine
 21084                                  
 21085                                  ; 21/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 SYSINIT)
 21086                                  ; 21/03/2019 - Retro DOS v4.0
 21087                                  
 21088                                  ;allocbyte   equ 0
 21089                                  ;intlevel    equ 1
 21090                                  ;savedsp     equ 2
 21091                                  ;savedss     equ 4
 21092                                  ;newsp       equ 6
 21093                                  
 21094                                  ; 30/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 SYSINIT)
 21095                                  ; (MSDOS 6.21 IO.SYS, SYSINIT:0147h)
 21096                                  
 21097                                  do_int_stacks:
 21098 00000147 50                      	push	ax
 21099 00000148 55                      	push	bp
 21100 00000149 06                      	push	es
 21101 0000014A 2E8E06[0A00]            	mov	es,[cs:stacks+2]	; Get segment of stacks
 21102 0000014F 2E8B2E[1000]            	mov	bp,[cs:nextentry]	; get most likely candidate
 21103 00000154 B001                    	mov	al,allocated ; 1
 21104                                  	; 21/10/2022
 21105                                  	;xchg	[es:bp+allocbyte],al 
 21106                                  	; 11/12/2022
 21107 00000156 26864600                	xchg	[es:bp],al		; grab the entry
 21108 0000015A 3C00                    	cmp	al,free ; 0		; still avail?
 21109 0000015C 7551                    	jne	short notfree02
 21110                                  
 21111 0000015E 2E832E[1000]08          	sub	word [cs:nextentry],entrysize ; set for next interrupt
 21112                                  found02:
 21113 00000164 26896602                	mov	[es:bp+savedsp],sp	; save sp value
 21114 00000168 268C5604                	mov	[es:bp+savedss],ss	; save ss also
 21115                                  
 21116 0000016C 89E8                    	mov	ax,bp			; temp save of table offset
 21117                                  
 21118 0000016E 268B6E06                	mov	bp,[es:bp+newsp]	; get new SP value
 21119                                  	; 21/10/2022
 21120                                  	;mov	bp,[es:bp+6]
 21121                                  	; 11/12/2022
 21122                                  	;cmp	[es:bp+0],ax	
 21123 00000172 26394600                	cmp	[es:bp],ax		; check for offset into table
 21124 00000176 7544                    	jne	short foundbad02
 21125                                  
 21126                                  	; 02/07/2023 (MSDOS 6.21 SYSINIT code)
 21127 00000178 8CC0                    	mov	ax,es			; point ss,sp to the new stack
 21128 0000017A 8EC5                    	mov	es,bp
 21129 0000017C 89E5                    	mov	bp,sp
 21130 0000017E 8B6E06                  	mov	bp,[bp+6]
 21131 00000181 8ED0                    	mov	ss,ax
 21132 00000183 8CC4                    	mov	sp,es
 21133 00000185 8EC0                    	mov	es,ax
 21134 00000187 2E8B6E00                	mov	bp,[cs:bp]
 21135                                  
 21136                                  	; 21/10/2022 (MSDOS 5.0 SYSINIT code)
 21137                                  	;push    bp
 21138                                  	;mov     bp,sp
 21139                                  	;mov     ax,[bp+8]
 21140                                  	;pop     bp
 21141                                  	;push    es
 21142                                  	;pop     ss
 21143                                  	;mov     sp,bp
 21144                                  	;mov     bp,ax
 21145                                  	; 11/12/2022
 21146                                  	;;mov	bp,[cs:bp+0]	
 21147                                  	;mov	bp,[cs:bp]	
 21148                                  
 21149 0000018B 9C                      	pushf				; go execute the real interrupt handler
 21150                                  	; 11/12/2022
 21151 0000018C 2EFF5E00                	call	far [cs:bp]		; which will iret back to here
 21152                                  	; 21/10/2022
 21153                                  	;call	far [cs:bp+0]
 21154                                  
 21155 00000190 89E5                    	mov	bp,sp			; retrieve the table offset for us
 21156                                  	; 11/12/2022
 21157 00000192 268B6E00                	mov	bp,[es:bp]		; but leave it on the stack
 21158                                  	; 21/10/2022
 21159                                  	;mov	bp,[es:bp+0]
 21160 00000196 268E5604                	mov	ss,[es:bp+savedss]	; get old stack back
 21161 0000019A 268B6602                	mov	sp,[es:bp+savedsp]
 21162                                  
 21163                                  	; 11/12/2022
 21164                                  	;mov	byte [es:bp+allocbyte],free ; free the entry
 21165                                  	; 21/10/2022
 21166 0000019E 26C6460000              	mov	byte [es:bp],free ; 0
 21167 000001A3 2E892E[1000]            	mov	[cs:nextentry],bp	; setup to use next time
 21168                                  
 21169 000001A8 07                      	pop	es			; saved on entry
 21170 000001A9 5D                      	pop	bp			; saved on entry
 21171 000001AA 58                      	pop	ax			; saved on entry
 21172 000001AB 83C402                  	add	sp,2			; (skip near call return addr) 
 21173 000001AE CF                      	iret				; done with this interrupt
 21174                                  
 21175                                  notfree02:
 21176 000001AF 3C01                    	cmp	al,allocated		; error flag
 21177 000001B1 7404                    	je	short findnext02	; no, continue
 21178                                  	; 11/12/2022
 21179                                  	;xchg	[es:bp+allocbyte],al	; yes, restore error value
 21180                                  	; 21/10/2022
 21181 000001B3 26864600                	xchg	[es:bp],al
 21182                                  
 21183                                  findnext02:
 21184 000001B7 E81200                  	call	longpath
 21185 000001BA EBA8                    	jmp	short found02
 21186                                  
 21187                                  foundbad02:
 21188 000001BC 2E3B2E[0C00]            	cmp	bp,[cs:firstentry]
 21189 000001C1 72F4                    	jc	short findnext02
 21190 000001C3 89C5                    	mov	bp,ax			; flag this entry
 21191                                  	; 11/12/2022
 21192                                  	;mov	byte [es:bp+allocbyte],clobbered
 21193                                  	; 21/10/2022
 21194 000001C5 26C6460003              	mov	byte [es:bp],clobbered ; 3
 21195 000001CA EBEB                    	jmp	short findnext02	; keep looking
 21196                                  
 21197                                  ; ----------------------------------------------------------------------
 21198                                  
 21199                                  ; Common routines
 21200                                  
 21201                                  longpath:
 21202                                  	; 21/03/2019
 21203 000001CC 2E8B2E[0E00]            	mov	bp,[cs:lastentry]	; start with last entry in table
 21204                                  lploopp:
 21205                                  	; 11/12/2022
 21206                                  	;cmp	byte [es:bp+allocbyte],free ; is entry free?
 21207                                  	; 21/10/2022
 21208 000001D1 26807E0000              	cmp	byte [es:bp],free
 21209 000001D6 7512                    	jne	short inuse		;  no, try next one
 21210                                  
 21211 000001D8 B001                    	mov	al,allocated
 21212                                  	; 11/12/2022
 21213                                  	;xchg	[es:bp+allocbyte],al	; allocate entry
 21214                                  	; 21/10/2022
 21215 000001DA 26864600                	xchg	[es:bp],al
 21216 000001DE 3C00                    	cmp	al,free 		; is it still free?
 21217 000001E0 7414                    	je	short found		;  yes, go use it
 21218                                  
 21219 000001E2 3C01                    	cmp	al,allocated		; is it other than Allocated or Free?
 21220 000001E4 7404                    	je	short inuse		;  no, check the next one
 21221                                  
 21222                                  	; 11/12/2022
 21223                                  	;mov	[es:bp+allocbyte],al	;  yes, put back the error state
 21224                                  	; 21/10/2022
 21225 000001E6 26884600                	mov	[es:bp],al
 21226                                  inuse:
 21227 000001EA 2E3B2E[0C00]            	cmp	bp,[cs:firstentry]
 21228 000001EF 7406                    	je	short fatal
 21229 000001F1 83ED08                  	sub	bp,entrysize
 21230 000001F4 EBDB                    	jmp	short lploopp
 21231                                  found:
 21232 000001F6 C3                      	retn
 21233                                  fatal:
 21234 000001F7 1E                      	push	ds
 21235 000001F8 B800F0                  	mov	ax,0F000h		;look at the model byte
 21236 000001FB 8ED8                    	mov	ds,ax
 21237 000001FD 803EFEFFF9              	cmp	byte [0FFFEh],0F9h ; mdl_convert ; convertible?
 21238 00000202 1F                      	pop	ds
 21239 00000203 7504                    	jne	short skip_nmis
 21240                                  
 21241 00000205 B007                    	mov	al,07h			; disable pc convertible nmis
 21242 00000207 E672                    	out	72h,al
 21243                                  
 21244                                  skip_nmis:
 21245 00000209 FA                      	cli				; disable and mask
 21246 0000020A B0FF                    	mov	al,0FFh			;   all other ints
 21247 0000020C E621                    	out	021h,al
 21248 0000020E E6A1                    	out	0A1h,al
 21249                                  
 21250 00000210 8CCE                    	mov	si,cs
 21251 00000212 8EDE                    	mov	ds,si
 21252 00000214 BE[3B02]                	mov	si,fatal_msg
 21253                                  ;SR;
 21254                                  ;   We set all foci to this VM to issue the stack failure message
 21255                                  ;
 21256 00000217 50                      	push	ax
 21257 00000218 1E                      	push	ds
 21258                                  	;;mov	ax,Bios_Data ; 0070h
 21259                                  	;mov	ax,KERNEL_SEGMENT ; 0070h
 21260                                  	; 21/10/2022
 21261 00000219 B87000                  	mov	ax,DOSBIODATASEG
 21262 0000021C 8ED8                    	mov	ds,ax
 21263                                  
 21264                                  	;test	byte [08D0h],1 	; (MSDOS 6.21, IO.SYS - SYSINIT:021Eh)
 21265 0000021E F606[1208]01            	test	byte [IsWin386],1 ; (retrodos4.sys, offset: ****h)
 21266 00000223 1F                      	pop	ds
 21267 00000224 58                      	pop	ax
 21268 00000225 7405                    	jz	short fatal_loop	; win386 not present, continue
 21269                                  
 21270                                  	;;call	far ptr 0070h:08D1h ; (MSDOS 621, IO.SYS - SYSINIT:0227h)
 21271                                  	;call	KERNEL_SEGMENT:V86_Crit_SetFocus ; set focus to this VM
 21272                                  	; 21/10/2022
 21273 00000227 9A[1308]7000            	call	DOSBIODATASEG:V86_Crit_SetFocus ; 0070h:08D1h
 21274                                  ;
 21275                                  ;SR; We do not bother about the returned status of this call. 
 21276                                  ;
 21277                                  fatal_loop:
 21278 0000022C AC                      	lodsb
 21279 0000022D 3C24                    	cmp	al,'$' ; 24h
 21280 0000022F 7408                    	je	short fatal_done
 21281                                  
 21282 00000231 B307                    	mov	bl,7
 21283                                  	; 28/09/2023 (BugFix)
 21284 00000233 B40E                    	mov	ah,14
 21285                                  	;mov	ah,0Eh
 21286 00000235 CD10                    	int	10h			; whoops, this enables ints
 21287                                  			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
 21288                                  			; AL = character, BH = display page (alpha modes)
 21289                                  			; BL = foreground color (graphics modes)
 21290 00000237 EBF3                    	jmp	short fatal_loop
 21291                                  
 21292                                  fatal_done:
 21293 00000239 EBFE                    	jmp	short fatal_done
 21294                                  
 21295                                  
 21296                                  ; 21/03/2019 - Retro DOS v4.0 (MSDOS 6.0, SYSINIT1.ASM, 1991)
 21297                                  ; ----------------------------------------------------------------------
 21298                                  ;	include msbio.cl5		; fatal stack error message
 21299                                  
 21300                                  ; MSDOS 6.21, IO.SYS, SYSINIT:023Bh
 21301                                  
 21302                                  ; STKMES.INC - MSDOS 3.3 (24/07/1987)
 21303                                  ; ----------------------------------------------------------------------
 21304                                  ; 04/06/2018 - Retro DOS v3.0
 21305                                  
 21306                                  fatal_msg:
 21307 0000023B 0D0A                    	db	0Dh,0Ah
 21308 0000023D 070D0A                  	db	7,0Dh,0Ah
 21309 00000240 496E7465726E616C20-     	db	"Internal stack overflow",0Dh,0Ah
 21309 00000249 737461636B206F7665-
 21309 00000252 72666C6F770D0A     
 21310 00000259 53797374656D206861-     	db	"System halted",0Dh,0Ah,"$" 
 21310 00000262 6C7465640D0A24     
 21311                                  
 21312                                  endstackcode:
 21313                                  
 21314                                  ; ----------------------------------------------------------------------
 21315                                  ; SYINIT1.ASM (MSDOS 6.0, 1991) 'SYSINIT' jump addr from 'MSINIT.ASM'
 21316                                  ; ----------------------------------------------------------------------
 21317                                  ; 04/06/2018 - Retro DOS v3.0 (MSDOS 3.3, SYSINIT1.ASM, 24/07/1987)
 21318                                  
 21319                                  ; 22/03/2019 - Retro DOS v4.0
 21320                                  
 21321                                  ; SYSINIT:0269h (MSDOS 6.21 IO.SYS, SYSINIT segment, offset: 0269h)
 21322                                  
 21323                                  ; ('SYSINIT:' location/address is used in 'retrodos4.s'. If following
 21324                                  ; address will be changed, it must also be changed in 'retrodos4.s'.)
 21325                                  
 21326                                  ; 21/10/2022- Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 21327                                  ; ----------------------------------------------------------------------
 21328                                  ; SYSINITSEG:0267h (MSDOS 5.0 IO.SYS, SYSINIT segment, offset: 0267h)
 21329                                  
 21330                                  SYSINIT:	
 21331 00000269 E9A001                          JMP	GOINIT
 21332                                  	;JMP	SYSIN ; 25/02/2018 - Retro DOS 2.0 modification
 21333                                  
 21334                                  ; ----------------------------------------------------------------------
 21335                                  
 21336                                  struc DDHighInfo
 21337 00000000 ????????                 .ddhigh_CSegPtr resd 1	; pointer to code segment to be relocated
 21338 00000004 ????                     .ddhigh_CSegLen resw 1	; length of code segment to be relocated
 21339 00000006 ????????                 .ddhigh_CallBak resd 1	; pointer to the call back routine
 21340                                  endstruc
 21341                                  
 21342                                  ; 22/03/2019 - Retro DOS v4.0
 21343                                  
 21344 0000026C 00                      runhigh: db	0
 21345                                  
 21346                                  ; 02/11/2022
 21347                                  ;align 4
 21348                                  
 21349                                  DOSINFO: 
 21350 0000026D 00000000                	dd	0	; address of the DOS Sysini Variables
 21351                                  ;MSDOS:
 21352                                  dos_temp_location: ; dword ; MSDOS 6.0
 21353                                  dosinit:		; MSDOS 6.0
 21354 00000271 0000                    	dw	0
 21355                                  
 21356                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 21357                                  ;FINAL_DOS_LOCATION: ; 20/04/2019 - Retro DOS v4.0
 21358                                  ;	dw	0
 21359                                  ;MSDOS 5.0 IO.SYS - SYSINIT:0271h
 21360                                  
 21361                                  CURRENT_DOS_LOCATION:
 21362 00000273 0000                    	dw	0
 21363                                  
 21364                                  ;DOSSIZE: ; Retro DOS 2.0 feature - 25/02/2018
 21365                                  ;	dw	0   ; 'MSDOS.BIN' kernel size in words
 21366                                  
 21367                                  ; 22/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 21368                                  ; (MSDOS 5.0 MSDOS.SYS size is 37394 bytes)
 21369                                  DOSSIZE	equ	0A000h	; (MSDOS 6.0 - SYSINIT1.ASM - 1991)
 21370                                  ; 03/09/2023 (PCDOS 7.1 IBMDOS.COM size is 42566 bytes, 04/12/2003)
 21371                                  ;DOSSIZE equ	0B000h	; (PCDOS 7.1 - SYSINIT) 
 21372                                  
 21373                                  DEVICE_LIST:
 21374 00000275 00000000                	dd	0
 21375                                  
 21376                                  ; 04/06/2018 - Retro DOS v3.0
 21377                                  ; 28/03/2018
 21378                                  ;; MSDOS 3.3 - SYSINIT1.ASM - 24/07/1987
 21379                                  ;
 21380                                  sysi_country:	
 21381 00000279 00000000                	dd	0 ; 5/29/86 Pointer to country table in DOS
 21382                                  
 21383                                  ; MSDOS 6.0
 21384 0000027D 00000000                dos_segreinit:	dw	0,0	; room for dword
 21385                                  
 21386 00000281 0000                    lo_doscod_size:	dw	0	; dos code size when in low mem
 21387 00000283 0000                    hi_doscod_size:	dw	0	; dos code size when in HMA
 21388                                  
 21389 00000285 0000                    def_php:	dw	0
 21390                                  
 21391                                  ; M022--
 21392                                  ; pointer for calling into Bios_Code for re-initializing segment values.
 21393                                  ;  call with ax = new segment for Bios_Code. Notice that we'll
 21394                                  ;  call it in its temporary home, cuz seg_reinit won't get moved to
 21395                                  ;  the new home.
 21396                                  
 21397                                  ;Bios_Code	equ	KERNEL_SEGMENT  ; 0070h
 21398                                  ; 21/10/2022
 21399                                  ;DOSBIOCODESEG	equ	02C7h ; (MSDOS 5.0 IO.SYS)
 21400                                  
 21401                                  ; 22/10/2022
 21402                                  seg_reinit_ptr:	; label dword
 21403 00000287 [3200]                  		dw	seg_reinit ; Bios_Code:0032h for MSDOS 6.21 IO.SYS
 21404                                  temp_bcode_seg:
 21405                                  		;dw	Bios_Code  ; 02CCh for MSDOS 6.21 IO.SYS
 21406                                  		; 22/10/2022
 21407 00000289 FF02                    		dw	DOSBIOCODESEG ; 02C7h for MSDOS 5.0 IO.SYS 		
 21408                                  
 21409                                  fake_floppy_drv:
 21410 0000028B 00                      		db	0	; set to 1 if this machine
 21411                                  				; does not have any floppies!!!
 21412                                  
 21413                                  ; Internal Stack Parameters
 21414                                  
 21415 0000028C 0900                    stack_count:	dw	defaultcount ; 9
 21416 0000028E 8000                    stack_size:	dw	defaultsize  ; 128
 21417 00000290 00000000                stack_addr:	dd	0	
 21418                                  
 21419                                  ; 05/06/2018 - Retro DOS v3.0
 21420                                  
 21421                                  ; various default values
 21422                                  
 21423 00000294 0100                    MEMORY_SIZE:	dw	1
 21424                                  
 21425                                  ; 22/03/2019 - Retro DOS v4.0 (MSDOS 6.0 source, MSDOS 6.21 disassembled src.)
 21426                                  
 21427 00000296 0000                    RPLMemTop:	dw	0  ; 22/10/2022 (MSDOS 5.0 IO.SYS SYSINIT:0294h)	
 21428 00000298 00                      DEFAULT_DRIVE:	db	0	; initialized by ibminit.
 21429 00000299 FFFF                    buffers:	dw	0FFFFh	; initialized during buffer allocation
 21430 0000029B 0000                    h_buffers:	dw	0	; # of the heuristic buffers. initially 0.
 21431 0000029D 0000                    singlebuffersize: dw	0	; maximum sector size + buffer head
 21432                                  
 21433 0000029F 08                      FILES:	db	8	; enough files for pipe
 21434 000002A0 04                      FCBS:	db	4	; performance for recycling
 21435 000002A1 00                      KEEP:	db	0	; keep original set
 21436 000002A2 05                      NUM_CDS: db	5	; 5 net drives
 21437                                  
 21438                                  ; 22/10/2022 (MSDOS 5.0 SYSINIT)
 21439                                  ;;CONFBOT: dw	0
 21440                                  ;;ALLOCLIM: dw	0
 21441                                  ;CONFBOT: ; 02/11/2022
 21442                                  ;top_of_cdss: dw 0
 21443                                  
 21444                                  ; 30/12/2022 - Retrodos v4.2 (MSDOS 6.21 SYSINIT)
 21445                                  ; (SYSINITSEG:02A3h)
 21446 000002A3 0000                    CONFBOT: dw	0
 21447 000002A5 0000                    ALLOCLIM: dw	0
 21448 000002A7 0000                    top_of_cdss: dw 0
 21449                                  
 21450                                  ; 02/11/2022 (MSDOS 5.0 SYSINIT)
 21451                                  ; 30/12/2022 (MSDOS 6.21 SYSINIT)
 21452                                  ;ALLOCLIM: dw	0	; (SYSINIT:02A3h)	
 21453                                  
 21454 000002A9 413A5C00                DirStrng: db	"A:\",0	; string for the root directory of a drive
 21455                                  
 21456                                  ; 30/12/2022 - Retro DOS v4.2 (MSDOS 6.21 SYSINIT)
 21457                                  %if 0
 21458                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 21459                                  ; (SYSINIT:02A9h)
 21460                                  
 21461                                  command_line:
 21462                                  	db	2,0
 21463                                  	db	'P'
 21464                                  	db	0
 21465                                  	times	124 db 0 ; db 124 dup(0)
 21466                                  
 21467                                  %endif
 21468                                  
 21469                                  ; (SYSINIT:0329h)
 21470 000002AD 00                      ZERO:	db	0
 21471 000002AE 00                      sepchr:	db	0
 21472 000002AF 0000                    linecount: dw	0			; line count in config.sys
 21473 000002B1 20202020200D0A24        showcount: db	'     ',cr,lf,'$'	; used to convert linecount to ascii.
 21474 000002B9 0000                    buffer_linenum: dw	0		; line count for "buffers=" command if entered.
 21475                                  
 21476 000002BB FF                      sys_model_byte:	db	0FFh		; model byte used in sysinit
 21477 000002BC 00                      sys_scnd_model_byte: db 0		; secondary model byte used in sysinit
 21478                                  
 21479 000002BD 0000                    buf_prev_off:	dw	0
 21480                                  
 21481                                          ;IF      NOT NOEXEC
 21482                                  ;COMEXE EXEC0 <0,COMMAND_LINE,DEFAULT_DRIVE,ZERO>
 21483                                          ;ENDIF
 21484                                  
 21485                                  ; 01/05/2018
 21486                                  COMEXE:
 21487 000002BF 0000                    EXEC0.ENVIRON:	dw	0	; seg addr of environment
 21488 000002C1 [3446]                  EXEC0.COM_LINE:	dw	command_line ; pointer to asciz command line
 21489 000002C3 0000                    		dw	0 	; SYSINIT segment (0473h for MSDOS 6.21 IO.SYS)
 21490 000002C5 [9802]                  EXEC0.5C_FCB:	dw	DEFAULT_DRIVE ; default fcb at 5C
 21491 000002C7 0000                    		dw	0	; SYSINIT segment (0473h for MSDOS 6.21 IO.SYS)
 21492 000002C9 [AD02]                  EXEC0.6C_FCB:	dw	ZERO	; default fcb at 6C
 21493 000002CB 0000                    		dw	0
 21494                                  
 21495                                  ; variables for install= command.
 21496                                  
 21497 000002CD 00                      multi_pass_id:	db	0		; parameter passed to multi_pass
 21498                                  					;  indicating the pass number
 21499                                  					; 0 - do scan for DOS=HIGH/LOW
 21500                                  					; 1 - load device drivers
 21501                                  					; 2 - was to load IFS
 21502                                  					;      now it is unused
 21503                                  					; 3 - do install=
 21504                                  					; >3 - nop
 21505 000002CE 0000                    install_flag:	dw	0
 21506                                  
 21507                                  have_install_cmd equ	00000001b	; config.sys has install= commands
 21508                                  has_installed	equ	00000010b	; sysinit_base installed.
 21509                                  
 21510 000002D0 0000                    config_size:	dw	0		; size of config.sys file. set by sysconf.asm
 21511 000002D2 00000000                sysinit_base_ptr: dd	0		; pointer to sysinit_base
 21512 000002D6 00000000                sysinit_ptr:	dd	0		; returning addr. from sysinit_base
 21513 000002DA 0000                    checksum:	dw	0		; used by sum_up
 21514                                  
 21515 000002DC 20<rep 14h>             ldexec_fcb:	times 20 db 20h ; db 20 dup (' ') ; big enough
 21516 000002F0 00                      ldexec_line:	db	0		; # of parm characters
 21517 000002F1 20                      ldexec_start:	db	' '
 21518 000002F2 00<rep 50h>             ldexec_parm:	times 80 db 0	; db 80 dup (0)
 21519                                  
 21520                                  ;instexe exec0	<0,ldexec_line,ldexec_fcb,ldexec_fcb>
 21521                                  
 21522                                  instexe:
 21523 00000342 0000                    iexec.environ:	dw	0		; seg addr of environment
 21524 00000344 [F002]                  iexec.ldexec_line: dw	ldexec_line ; pointer to asciz command line
 21525 00000346 0000                    		dw	0 	; SYSINIT segment (0473h for MSDOS 6.21 IO.SYS)
 21526 00000348 [DC02]                  iexec.ldexec_5c_fcb: dw	ldexec_fcb	; default fcb at 5C
 21527 0000034A 0000                    		dw	0	; SYSINIT segment (0473h for MSDOS 6.21 IO.SYS)
 21528 0000034C [DC02]                  iexec.ldexec_6c_fcb: dw	ldexec_fcb	; default fcb at 6C
 21529 0000034E 0000                    		dw	0
 21530                                  
 21531                                  ; variables for comment=
 21532                                  
 21533 00000350 00                      com_level:	db	0		; level of " " in command line
 21534 00000351 00                      cmmt:		db	0		; length of comment string token
 21535 00000352 00                      cmmt1:		db	0		; token
 21536 00000353 00                      cmmt2:		db	0		; token
 21537 00000354 00                      cmd_indicator:	db	0
 21538 00000355 00                      donotshownum:	db	0
 21539                                  
 21540 00000356 0000                    count:		dw	0
 21541 00000358 0000                    org_count:	dw	0
 21542 0000035A 0000                    chrptr:		dw	0
 21543 0000035C 0000                    cntryfilehandle: dw	0
 21544 0000035E 0000                    old_area:	dw	0
 21545 00000360 0000                    impossible_owner_size: dw 0		; paragraph
 21546                                  
 21547                                  bucketptr: ; label dword
 21548                                  bufptr:	   ; label dword		; leave this stuff in order!
 21549 00000362 0000                    memlo:	dw	0
 21550                                  prmblk:	   ; label word
 21551 00000364 0000                    memhi:	dw	0
 21552 00000366 0000                    ldoff:	dw	0
 21553 00000368 0000                    area:	dw	0
 21554                                  
 21555                                  ; Following is the request packet used to call INIT routines for 
 21556                                  ; all device drivers. Some fields may be accessed individually in
 21557                                  ; the code, and hence have individual labels, but they should not
 21558                                  ; be separated.
 21559                                  
 21560 0000036A 18                      packet:	db	24			; was 22
 21561 0000036B 00                      	db	0
 21562 0000036C 00                      	db	0			; initialize code
 21563 0000036D 0000                    	dw	0
 21564 0000036F 00<rep 8h>              	times	8 db 0	; db 8 dup (?)
 21565                                  
 21566 00000377 00                      unitcount:	db	0
 21567 00000378 00000000                break_addr:	dd	0
 21568 0000037C 00000000                bpb_addr:	dd	0
 21569                                  drivenumber:	; 22/10/2022
 21570 00000380 00                      devdrivenum:	db	0 
 21571 00000381 0000                    configmsgflag:	dw	0  ; used to control "error in config.sys line #" message
 21572                                  
 21573                                  ; end of request packet
 21574                                  
 21575                                  ;drivenumber:	db	0  ; 22/03/2019
 21576                                  
 21577                                  toomanydrivesflag:
 21578 00000383 00                      		db	0  ; >24 fixed disk partitions flag ; M029 
 21579                                  align 2
 21580                                  
 21581                                  BCodeSeg:	; 21/10/2022
 21582 00000384 FF02                    	dw	DOSBIOCODESEG ; (02C7h for MSDOS 5.0 IO.SYS)
 21583                                  	;dw	Bios_Code  ; = KERNEL_SEGMENT = 0070h (for Retro DOS v4.0)
 21584                                  			   ; BCodeSeg = 2CCh (for MSDOS 6.21 IO.SYS)
 21585                                  
 21586                                  ; 30/12/2022
 21587                                  ; MSDOS 6.21 IO.SYS, SYSINIT:0387h
 21588                                  ;
 21589                                  ; MagicBackdoor: dd 0
 21590                                  ; NullBackdoor: 
 21591                                  ;		retf
 21592                                  
 21593                                  ; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 21594                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 21595                                  ; 19/04/2019
 21596                                  _timer_lw_:
 21597 00000386 0000                    	dw	0  ; MSDOS 6.21 IO.SYS - SYSINIT:038Ch
 21598                                  
 21599                                  ;SR;
 21600                                  ; This is the communication block between the DOS and the BIOS. It starts at
 21601                                  ;the SysinitPresent flag. Any other data that needs to be communicated 
 21602                                  ;to the DOS should be added after SysinitPresent. The pointer to this block
 21603                                  ;is passed to DOS as part of the DOSINIT call.
 21604                                  ;
 21605                                  
 21606                                  BiosComBlock:
 21607                                  	;dd	Bios_Data:SysinitPresent 
 21608                                  		; 0070h:08FDh for MSDOS 6.21 IO.SYS
 21609 00000388 [DD07]                  	dw	SysinitPresent  ; (retrodos4.sys, offset: ****h)
 21610                                  	;dw	KERNEL_SEGMENT ; 0070h
 21611                                  	; 21/10/2022
 21612 0000038A 7000                    	dw	DOSBIODATASEG ; 0070h
 21613                                  
 21614                                  ;align 2
 21615                                  
 21616                                  	; 22/10/2022 - (MSDOS 5.0 IO.SYS, SYSINIT:0406h)
 21617                                  	; 30/12/2022 - (MSDOS 6.21 IO.SYS, SYSINIT:0392h)
 21618                                  tempstack:	
 21619 0000038C 00<rep 80h>             	times	128 db 0  ; db	80h dup (?)
 21620                                  
 21621                                  ; ----------------------------------------------------------------------------
 21622                                  
 21623                                  	; 22/10/2022 - Retro DOS v4.0
 21624                                  	;	; (MSDOS 5.0 IO.SYS, SYSINIT:0486h)
 21625                                  GOINIT:		; (MSDOS 6.21 IO.SYS, SYSINIT:0412h)
 21626                                  	; 12/12/2023
 21627 0000040C 0E                      	push	cs
 21628 0000040D 1F                      	pop	ds
 21629                                  
 21630                                  	; 12/12/2022
 21631                                  	; 22/03/2019 - Retro DOS v4.0
 21632                                  	; 06/07/2018
 21633                                  	; 04/06/2018 - Retro DOS v3.0
 21634                                  ; before doing anything else, let's set the model byte
 21635 0000040E B4C0                    	mov	ah,0C0h 		; get system configuration
 21636 00000410 CD15                    	int	15h			; 
 21637 00000412 7214                    	jc	short no_rom_config
 21638                                  
 21639                                  	;cmp	ah,0			; double check
 21640                                  	;jne	short no_rom_config
 21641                                  	; 03/09/2023
 21642 00000414 08E4                    	or	ah,ah
 21643 00000416 7510                    	jnz	short no_rom_config
 21644                                  
 21645                                  	; 12/12/2023 ; *
 21646                                  	; ds = cs
 21647                                  
 21648 00000418 268A4702                	mov	al,[es:bx+ROMBIOS_DESC.bios_sd_modelbyte]
 21649                                  	;mov	[cs:sys_model_byte],al 
 21650 0000041C A2[BB02]                	mov	[sys_model_byte],al ; *
 21651 0000041F 268A4703                	mov	al,[es:bx+ROMBIOS_DESC.bios_sd_scnd_modelbyte]
 21652                                  	;mov	[cs:sys_scnd_model_byte],al
 21653 00000423 A2[BC02]                	mov	[sys_scnd_model_byte],al ; *
 21654                                  	;jmp	short SYSIN
 21655                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 21656 00000426 EB29                    	jmp	short move_myself
 21657                                  
 21658                                  no_rom_config:				; Old ROM
 21659                                  	; 12/12/2023
 21660                                  	;mov	ax,0F000h
 21661                                  	;mov	ds,ax
 21662                                  	;mov	al,[0FFFEh]
 21663                                  	;mov	[cs:sys_model_byte],al	; set the model byte.
 21664                                  	; 12/12/2023
 21665                                  	; ds = cs
 21666 00000428 B800F0                  	mov	ax,0F000h
 21667 0000042B 8EC0                    	mov	es,ax
 21668 0000042D 26A0FEFF                	mov	al,[es:0FFFEh]
 21669 00000431 A2[BB02]                	mov	[sys_model_byte],al	; set the model byte.
 21670                                  	
 21671                                  ; set fake_floppy_drv if there is no diskette drives in this machine.
 21672                                  ; execute the equipment determination interrupt and then
 21673                                  ; check the returned value to see if we have any floppy drives
 21674                                  ; if we have no floppy drive we set cs:fake_floppy_drv to 1
 21675                                  ; see the at tech ref bios listings for help on the equipment
 21676                                  ; flag interrupt (11h)	
 21677                                  
 21678                                  	; 22/10/2022
 21679                                  check_for_fake_floppy:			; entry point for rom_config above
 21680 00000434 CD11                    	int	11h			; check equipment flag
 21681                                  
 21682                                  	; 12/12/2022
 21683 00000436 A801                    	test	al,1		
 21684                                  	;test	ax,1			; have any floppies?
 21685 00000438 7517                    	jnz	short move_myself	; yes,normal system
 21686                                  
 21687                                  ; Some ROM BIOSs lie that there are no floppy drives. Lets find out
 21688                                  ; whether it is an old ROM BIOS or a new one
 21689                                  ;
 21690                                  ; WARNING !!!
 21691                                  ;
 21692                                  ; This sequence of code is present in MSINIT.ASM also. Any modification
 21693                                  ; here will require an equivalent modification in MSINIT.ASM also
 21694                                  
 21695                                  	; 12/12/2023
 21696                                  	;push	es  ; not necessary
 21697                                  
 21698 0000043A 30C9                    	xor	cl,cl	
 21699 0000043C B408                    	mov	ah,8			; get disk parameters
 21700 0000043E B200                    	mov	dl,0			; of drive 0
 21701 00000440 CD13                    	int	13h
 21702                                  
 21703                                  	;pop	es  ; 12/12/2023	
 21704                                  
 21705 00000442 720D                    	jc	short move_myself	; if error lets assume that the
 21706                                  					;  ROM BIOS lied
 21707                                  	;cmp	cl,0			; double check (max sec no cannot be 0)
 21708                                  	;je	short move_myself
 21709                                  	; 03/09/2023
 21710 00000444 08C9                    	or	cl,cl
 21711 00000446 7409                    	jz	short move_myself
 21712                                  
 21713 00000448 08D2                    	or	dl,dl			; number of flp drvs == 0?
 21714 0000044A 7505                    	jnz	short move_myself	; no
 21715                                  
 21716                                  	;mov	byte [cs:fake_floppy_drv],1 ; set fake flag.
 21717                                  	; 12/12/2023
 21718                                  	; ds = cs
 21719 0000044C C606[8B02]01            	mov	byte [fake_floppy_drv],1 ; set fake flag.
 21720                                  
 21721                                  move_myself:
 21722                                  	; 12/12/2023
 21723                                  	;cld	; not necessary		; set up move
 21724                                  	;xor	si,si
 21725                                  	;mov	di,si
 21726                                  
 21727                                  	; 12/12/2023
 21728                                  	; ds = cs
 21729                                  	; 12/12/2022
 21730                                  	;push	cs
 21731                                  	;pop	ds
 21732                                  
 21733                                  	;mov	cx,[cs:MEMORY_SIZE]
 21734 00000451 8B0E[9402]              	mov	cx,[MEMORY_SIZE] ; 12/12/2022
 21735                                  
 21736                                  	; (MSDOS 6.0 - SYSINIT1.ASM - 1991)
 21737                                  ;;;	if	msver
 21738                                  ;	cmp	cx,1		; 1 means do scan
 21739                                  ;	jnz	short noscan
 21740                                  ;	mov	cx,2048		; start scanning at 32k boundary
 21741                                  ;	xor	bx,bx
 21742                                  ;
 21743                                  ;memscan:inc	cx
 21744                                  ;	jz	short setend
 21745                                  ;	mov	ds,cx
 21746                                  ;	mov	al,[bx]
 21747                                  ;	not	al
 21748                                  ;	mov	[bx],al
 21749                                  ;	cmp	al,[bx]
 21750                                  ;	not	al
 21751                                  ;	mov	[bx],al
 21752                                  ;	jz	short memscan
 21753                                  ;setend:
 21754                                  ;	mov	cs:[memory_size],cx
 21755                                  ;;;	endif
 21756                                  
 21757                                  ;noscan: 				; cx is mem size in para
 21758                                  ;;
 21759                                  ;;	cas -- a) if we got our memory size from the ROM, we should test it
 21760                                  ;;		  before we try to run.
 21761                                  ;;	       b) in any case, we should check for sufficient memory and give
 21762                                  ;;		  an appropriate error diagnostic if there isn't enough
 21763                                  ;
 21764                                  ;	push	cs
 21765                                  ;	pop	ds
 21766                                  ;
 21767                                  ;;	cas note:  It would be better to put dos + bios_code BELOW sysinit
 21768                                  ;;	  that way it would be easier to slide them down home in a minimal
 21769                                  ;;	  memory system after sysinit.  As it is, you need room to keep
 21770                                  ;;	  two full non-overlapping copies, since sysinit sits between the
 21771                                  ;;	  temporary home and the final one.  the problem with doing that
 21772                                  ;;	  is that sys*.asm are filled with "mov ax,cs, sub ax,11h" type stuff.
 21773                                  ;
 21774                                  ;	dec	cx			; one para for an arena at end of mem
 21775                                  ;					; in case of UMBs
 21776                                  
 21777                                  	; 22/10/2022
 21778                                  	; (MSDOS 5.0 IO.SYS SYSINIT:04DBh)
 21779                                  
 21780                                  	; 12/12/2022
 21781                                  	;push	cs
 21782                                  	;pop	ds
 21783                                  
 21784 00000455 49                      	dec	cx
 21785                                  
 21786                                  ;------ Check if an RPL program is present at TOM and do not tromp over it
 21787                                  
 21788 00000456 31DB                    	xor	bx,bx
 21789 00000458 8EC3                    	mov	es,bx
 21790                                  	;mov	bx,[es:(2Fh*4)] ; INT 2Fh address (0:0BCh)
 21791                                  	;mov	es,[es:((2Fh*4)+2)] ; INT 2Fh segment (0:0BEh)
 21792                                  	; 29/09/2023
 21793 0000045A 26C41EBC00              	les	bx,[es:(2Fh*4)]
 21794 0000045F 26817F035250            	cmp	word [es:bx+3],'RP'
 21795 00000465 751B                    	jne	short NoRPL
 21796 00000467 26807F054C              	cmp	byte [es:bx+5],'L'
 21797 0000046C 7514                    	jne	short NoRPL
 21798                                  
 21799 0000046E 89CA                    	mov	dx,cx			; get TOM into DX
 21800 00000470 52                      	push	dx
 21801 00000471 B8064A                  	mov	ax,4A06h
 21802                                  	;mov	ax,(multMULT<<8)+multMULTRPLTOM
 21803 00000474 CD2F                    	int	2Fh			; Get new TOM from any RPL
 21804 00000476 58                      	pop	ax
 21805 00000477 89D1                    	mov	cx,dx
 21806 00000479 39C2                    	cmp	dx,ax
 21807 0000047B 7405                    	je	short NoRPL
 21808                                  	
 21809                                  	; 11/12/2022
 21810                                  	; ds = cs
 21811 0000047D 8916[9602]              	mov	[RPLMemTop],dx
 21812                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 21813                                  	;mov	[cs:RPLMemTop],dx
 21814                                  	
 21815 00000481 49                      	dec	cx
 21816                                  NoRPL:
 21817 00000482 B8[604D]                	mov	ax,SI_end		; need this much room for sysinit
 21818                                  					; (SI_end == sysinit code size)
 21819                                  					; 03/09/2023
 21820                                  					; (58A0h for MSDOS 6.21 IO.SYS)
 21821                                  					; (5B40h for PCDOS 7.1 IBMBIO.COM)
 21822 00000485 E8C607                  	call	off_to_para
 21823 00000488 29C1                    	sub	cx,ax
 21824                                  
 21825                                  ; we need to leave room for the DOS and (if not ROMDOS) for the BIOS
 21826                                  ; code above sysinit in memory
 21827                                  ;
 21828 0000048A 81E9000A                	sub	cx,DOSSIZE/16 ; (0A00h)	; leave this much room for DOS
 21829                                  			      ; (0B00h) ; (PCDOS 7.1 IBMBIO.COM) -03/09/2023-	
 21830                                  
 21831 0000048E B8801D                  	mov	ax,BCODE_END 		; (1A60h for MSDOS 5.0 IO.SYS)
 21832                                  					; (1A70h for MSDOS 6.21 IO.SYS)
 21833                                  					; 03/09/2023
 21834                                  					; (1E00h for PCDOS 7.1 IBMBIO.COM)
 21835 00000491 E8BA07                  	call	off_to_para		; leave this much room for BIOS code
 21836 00000494 29C1                    	sub	cx,ax
 21837 00000496 8EC1                    	mov	es,cx			; segment where sysinit will be located
 21838                                  
 21839                                  	; 12/12/2023
 21840 00000498 FC                      	cld	; not necessary		; set up move
 21841 00000499 31F6                    	xor	si,si
 21842 0000049B 89F7                    	mov	di,si
 21843                                  
 21844 0000049D B9[604D]                	mov	cx,SI_end		; (sysinit code size)
 21845 000004A0 D1E9                    	shr	cx,1			; divide by 2 to get words
 21846 000004A2 F3A5                    	rep	movsw			; relocate sysinit
 21847                                  
 21848 000004A4 06                      	push	es			; push relocated segment
 21849 000004A5 B8[AA04]                	mov	ax,SYSIN
 21850 000004A8 50                      	push	ax			; push relocated entry point
 21851                                  
 21852 000004A9 CB                      	retf				; far jump to relocated sysinit
 21853                                  
 21854                                  ; ----------------------------------------------------------------------------
 21855                                  
 21856                                  ;	MOVE THE DOS TO ITS PROPER LOCATION
 21857                                  
 21858                                  	; 22/10/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS)
 21859                                  	; (SYSINIT:0533h)
 21860                                  	; 30/12/2022 - Retro DOS 4.2 (Modified MSDOS 6.21 IO.SYS)
 21861                                  	; (SYSINIT:04BFh)
 21862                                  	; 03/09/2023 - Retro DOS 4.2 (5.0 - Modified PCDOS 7.1 IBMBIO.COM)
 21863                                  	; (SYSINIT:04F3h)
 21864                                  SYSIN:
 21865                                  	; Retro DOS 4.0 - 22/03/2019
 21866                                  	; Retro DOS 2.0 - 25/02/2018
 21867                                  
 21868                                  	; 23/04/2019
 21869                                  	;;mov	ax,Bios_Data
 21870                                  	;mov	ax,KERNEL_SEGMENT ; 0070h
 21871                                  	; 21/10/2022
 21872 000004AA B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 21873 000004AD 8ED8                    	mov	ds,ax
 21874 000004AF 8C0E[DB07]              	mov	[MoveDOSIntoHMA+2],cs	; set seg of routine to move DOS
 21875 000004B3 C606[DD07]01            	mov	byte [SysinitPresent],1	; flag that MoveDOSIntoHMA can be called
 21876                                  
 21877                                  ; first move the MSDOS.SYS image up to a harmless place 
 21878                                  ; on top of our new sysinitseg
 21879                                  
 21880                                  	; 22/10/2022
 21881 000004B8 B8[604D]                	mov	ax,SI_end		; how big is sysinitseg?
 21882 000004BB E89007                  	call	off_to_para
 21883 000004BE 8CC9                    	mov	cx,cs			; pick a buffer for msdos above us
 21884 000004C0 01C8                    	add	ax,cx
 21885 000004C2 8EC0                    	mov	es,ax
 21886                                  	
 21887 000004C4 31F6                    	xor	si,si
 21888 000004C6 89F7                    	mov	di,si
 21889                                  
 21890 000004C8 2E8E1E[7302]            	mov	ds,[cs:CURRENT_DOS_LOCATION] ; where it is (set by msinit)
 21891                                  
 21892                                  	;mov	ax,cs	
 21893                                  	;mov	ds,ax
 21894                                  
 21895                                  	;;;mov	cx,20480  ; MSDOS 6.21 IO.SYS - SYSINIT:04E2h
 21896                                  	;;mov	cx,dossize/2 ; MSDOS 6.0
 21897                                  	;mov	cx,[DOSSIZE] ; words (not bytes!)  ; Retro DOS v4.0 (3.0, 2.0)
 21898                                  	;mov	es,[FINAL_DOS_LOCATION] ; on top of SYSINIT code
 21899                                  	;mov	ds,[CURRENT_DOS_LOCATION]
 21900                                  
 21901                                  	; 22/10/2022
 21902 000004CD B90050                  	mov	cx,DOSSIZE/2 ; 5000h
 21903                                  			     ; 03/09/2023
 21904                                  			     ; 5800h (PCDOS 7.1)
 21905 000004D0 F3A5                    	rep     movsw
 21906 000004D2 2E8C06[7302]            	mov	[cs:CURRENT_DOS_LOCATION],es
 21907                                  
 21908                                  ; The DOS code is ORGed at a non-zero value to allow it to be located in
 21909                                  ; HIMEM. Thus, the DOS segment location must be adjusted accordingly.
 21910                                  ; If this is ROMDOS, however, only the init code is loaded into RAM, so
 21911                                  ; this ORG is not done. The entry point is at offset zero in the segment.
 21912                                  
 21913                                  	; 22/04/2019 (MSDOS 6.0 & MSDOS 6.21 kernel address modification)
 21914                                  	;mov	ax,cs
 21915                                  	; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS, SYSINIT)
 21916                                  	;mov	ds,ax
 21917                                  
 21918                                  ; 29/04/2019 - Retro DOS v4.0 ! important MODIFICATION !
 21919                                  
 21920                                  ;	; 24/04/2019 
 21921                                  ;;ifndef ROMDOS
 21922                                  ;	mov	ax,[es:3] 		; get offset of dos
 21923                                  ;		; ax = 3DE0h for MSDOS 6.21 kernel (MSDOS.SYS, offset 3) 
 21924                                  ;	mov	[dosinit],ax		; that's the entry point offset
 21925                                  ;	call	off_to_para		; subtract this much from segment
 21926                                  ;	; 23/04/2019
 21927                                  ;	;sub	[CURRENT_DOS_LOCATION],ax
 21928                                  ;	sub	[FINAL_DOS_LOCATION],ax
 21929                                  ;;else
 21930                                  ;;	mov	word [dosinit],0	; entry to init is at zero
 21931                                  ;;
 21932                                  ;;endif ; ROMDOS
 21933                                  
 21934                                  	; 29/04/2019 - Retro DOS v4.0 ! important MODIFICATION !
 21935                                  	; (! MSDOS6.BIN starts with DOSDATA ! - Retro DOS v4.0 modification) 
 21936                                  
 21937                                  	;mov	ax,[es:0] ; DOSCODE start address = DOSDATA size (= 136Ah)
 21938                                  	;		  ; (Valid for Retro DOS v4.0 only!)
 21939                                  
 21940                                  	; 22/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS, SYSINIT)
 21941                                  	; (SYSINIT:0563h for MSDOS 5.0 IO.SYS SYSINIT)
 21942                                  	; 03/09/2023 - Retro DOS 4.2 (Modified MSDOS 6.21 IO.SYS)
 21943                                  	; (SYSINIT:04ECh for MSDOS 6.21 IO.SYS SYSINIT)
 21944                                  	; (SYSINIT:0540h for PCDOS 7.1 IBMBIO.COM SYSINIT)
 21945 000004D7 A10300                  	mov	ax, [3]		; mov ax, word ptr ds:3
 21946                                  
 21947 000004DA 2EA3[7102]              	mov	[cs:dosinit],ax ; (SYSINIT:0563h for MSDOS 5.0 IO.SYS SYSINIT)
 21948                                  	; 02/11/2022
 21949 000004DE E86D07                  	call	off_to_para		; subtract this much from segment
 21950 000004E1 2E2906[7302]            	sub	[cs:CURRENT_DOS_LOCATION],ax
 21951                                  
 21952                                  	; Current DOSCODE start address = dword [dosinit]
 21953                                  
 21954                                  ;; If this is not ROMDOS, then the BIOS code is moved to the top of memory
 21955                                  ;; until it is determined whether it will be running in HIMEM or not.
 21956                                  
 21957                                  ;ifndef ROMDOS
 21958                                  
 21959                                  ; now put Bios_Code up on top of that. Assume Bios_Code + dossize < 64k
 21960                                  
 21961                                  	; 22/10/2022
 21962 000004E6 8CC0                    	mov	ax,es
 21963 000004E8 05000A                  	add	ax,DOSSIZE/16		; get paragraph of end of dos
 21964 000004EB 8EC0                    	mov	es,ax
 21965 000004ED 2E8706[8902]            	xchg	ax,[cs:temp_bcode_seg]	; swap with original home of Bios_Code
 21966 000004F2 8ED8                    	mov	ds,ax			; point to loaded image of Bios_Code
 21967                                  
 21968                                  	;mov	si,BCODE_START ; mov si,30h
 21969                                  	; 09/12/2022
 21970 000004F4 BE[3000]                	mov	si,BCODESTART
 21971                                  	; 02/11/2022
 21972 000004F7 89F7                    	mov	di,si
 21973                                  	;mov	cx,BCODE_END   ; mov cx,1A60h ; mov cx,1A70h ; 30/12/2022
 21974                                  	;sub	cx,si
 21975                                  	; 29/09/2023
 21976                                  	BCODESIZE equ BCODEEND-BCODESTART
 21977 000004F9 B9501D                  	mov	cx,BCODESIZE
 21978 000004FC D1E9                    	shr	cx,1
 21979 000004FE F3A5                    	rep	movsw			; move Bios_Code into place
 21980                                  
 21981 00000500 8CC0                    	mov	ax,es			; tell it what segment it's in
 21982 00000502 2EFF1E[8702]            	call	far [cs:seg_reinit_ptr]	; far call to seg_reinit in Bios_Code (M022)
 21983                                  
 21984                                  ;endif	; not ROMDOS
 21985                                  
 21986                                  ; now call dosinit while it's in its temporary home
 21987                                  
 21988                                  	;mov	ax,cs
 21989                                  	;mov	ds,ax	 
 21990                                  
 21991                                  	;mov	dx,[MEMORY_SIZE]	; set for call to dosinit
 21992                                  
 21993                                  	; 22/10/2022
 21994                                  
 21995 00000507 2EC43E[8803]            	les	di,[cs:BiosComBlock]	; ptr to BIOS communication block
 21996                                  		; es = KERNEL_SEGMENT (70h), di = 'SysInitPresent' address
 21997 0000050C 2EC536[7502]            	lds	si,[cs:DEVICE_LIST]	; set for call to dosinit
 21998                                  		; ds = KERNEL_SEGMENT (70h), si = 'res_dev_list' address
 21999                                  
 22000 00000511 2E8B16[9402]            	mov	dx,[cs:MEMORY_SIZE]	; set for call to dosinit
 22001                                  
 22002 00000516 FA                      	cli
 22003 00000517 8CC8                    	mov	ax,cs
 22004 00000519 8ED0                    	mov	ss,ax
 22005                                  
 22006                                  ; 22/03/2019 - Retro DOS v4.0 (MSDOS 6.0, SYSINIT1.ASM)
 22007                                  %define locstack ($ - SYSINIT$) & 0FFFEh  ; 532h in MSDOS 6.21 IO.SYS
 22008                                  					  ; 5A6h in MSDOS 5.0 IO.SYS SYSINIT
 22009                                  ;SYSINIT:0532h: 
 22010                                  
 22011                                  ; 22/10/2022
 22012                                  ; ----------------------------------------------------------------------------
 22013                                  ;SYSINIT:05A6h:
 22014                                  ;locstack:	; (at SYSINIT:05A6h for MSDOS 5.0 IO.SYS)
 22015                                  
 22016                                  ; 03/09/2023
 22017                                  ; (locstack at SYSINIT:0586h in PCDOS 7.1 IBMBIO.COM SYSINIT)
 22018                                  
 22019                                  	;mov	sp,05A6h
 22020 0000051B BC1A05                  	mov     sp,locstack		; set stack
 22021                                  
 22022 0000051E FB                      	sti
 22023                                  
 22024                                  ;align 2
 22025                                  	; 30/03/2018
 22026                                  ;LOCSTACK:
 22027                                          ;CALL	FAR [CS:MSDOS]	; FINAL_DOS_LOCATION:0 
 22028                                  		       		;('jmp DOSINIT' in 'MSHEAD.ASM')
 22029                                  		       		;('DOSINIT:' is in 'MSINIT.ASM')
 22030                                  
 22031                                  	; 22/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 22032                                  	; 22/03/2019 - Retro DOS v4.0 (MSDOS 6.0, 6.21)
 22033                                  
 22034                                  ; This call to DOSINIT will relocate the DOS data from its present location
 22035                                  ; at the top of memory, to its final location in low memory just above the
 22036                                  ; BIOS data. It will then build important DOS data structures in low 
 22037                                  ; memory following the DOS data. It returns (among many other things) the
 22038                                  ; new starting address of free memory.
 22039                                  
 22040 0000051F 2EFF1E[7102]            	call	far [cs:dosinit]	; call dosinit	
 22041                                  			 ; es:di -> sysinitvars_ext
 22042                                  
 22043 00000524 2E8C1E[8502]            	mov	[cs:def_php],ds		; save pointer to PSP
 22044                                  	
 22045                                  	; 11/12/2022
 22046                                  	; 22/03/2019
 22047 00000529 0E                      	push	cs
 22048 0000052A 1F                      	pop	ds
 22049                                  	; 22/10/2022
 22050 0000052B A3[8302]                	mov	[hi_doscod_size],ax
 22051 0000052E 890E[8102]              	mov	[lo_doscod_size],cx
 22052 00000532 8916[7D02]              	mov	[dos_segreinit],dx
 22053                                  	
 22054                                  	; 11/12/2022
 22055                                  	; ds = cs
 22056                                  	;mov	[cs:hi_doscod_size],ax	; size of doscode (including exepatch)
 22057                                  	;mov	[cs:lo_doscod_size],cx	; (not including exepatch)
 22058                                  	;mov	[cs:dos_segreinit],dx	; save offset of segreinit
 22059                                  
 22060                                  	; 05/06/2018 - Retro DOS v3.0
 22061                                  	; ES:DI = Address of pointer to SYSINITVARS structure (MSDOS 3.3)
 22062                                  
 22063                                  	; 11/12/2022
 22064                                  	; ds = cs
 22065                                  	; 22/10/2022
 22066                                  	;mov	ax,[es:di+SysInitVars_Ext.SYSI_InitVars] ; 5/29/86
 22067 00000536 268B05                  	mov	ax,[es:di] ; 22/03/2019
 22068                                  	;mov	[cs:DOSINFO],ax
 22069 00000539 A3[6D02]                	mov	[DOSINFO],ax
 22070                                  	;mov	ax,[es:di+SysInitVars_Ext.SYSI_InitVars+2]
 22071 0000053C 268B4502                	mov	ax,[es:di+2]
 22072                                  	;mov	[cs:DOSINFO+2],ax
 22073 00000540 A3[6F02]                	mov	[DOSINFO+2],ax	; set the sysvar pointer
 22074                                  
 22075                                  	;mov	ax,[es:di+SysInitVars_Ext.SYSI_Country_Tab]
 22076 00000543 268B4504                	mov	ax,[es:di+4]
 22077                                  	;mov	[cs:sysi_country],ax
 22078 00000547 A3[7902]                	mov	[sysi_country],ax
 22079                                  	;mov	ax,[es:di+SysInitVars_Ext.SYSI_Country_Tab+2]
 22080 0000054A 268B4506                	mov	ax,[es:di+6]
 22081                                  	;mov	[cs:sysi_country+2],ax
 22082 0000054E A3[7B02]                	mov	[sysi_country+2],ax	; set the SYSI_Country pointer
 22083                                  
 22084                                  	; 20/04/2019
 22085                                  	;mov	ax,[CURRENT_DOS_LOCATION]
 22086                                  	;;mov	es,[CURRENT_DOS_LOCATION]
 22087                                  	;mov	ax,[FINAL_DOS_LOCATION] ; give dos its temporary location
 22088                                  	; 22/10/2022
 22089                                  	;mov	ax,[cs:CURRENT_DOS_LOCATION]
 22090                                  	;;;mov	[dos_segreinit+2],es
 22091                                  	;;mov	[dos_segreinit+2],ax
 22092                                  	;mov	[cs:dos_segreinit+2],ax
 22093                                  	; 11/12/2022
 22094                                  	; ds = cs
 22095 00000551 8E06[7302]              	mov	es,[CURRENT_DOS_LOCATION]
 22096 00000555 8C06[7F02]              	mov	[dos_segreinit+2],es
 22097                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 22098                                  	;mov	es,[cs:CURRENT_DOS_LOCATION]
 22099                                  	;mov	[cs:dos_segreinit+2],es
 22100                                  
 22101                                  ; ----------------------------------------------------------------------------
 22102                                  
 22103                                  ;SYSINIT:0577h:
 22104                                  	; ... RPLArena ... MSDOS 6.21 IO.SYS (SYSINIT:0577h to SYSINIT:05D1h)
 22105                                  ;SYSINIT:05D1h:	; NoRPLArena 
 22106                                  
 22107                                  	; 22/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS SYSINIT)
 22108                                  ;------ Cover up RPL code with an arena
 22109                                  ;SYSINIT:05EBh:
 22110                                  	; 11/12/2022
 22111                                  	; ds = cs
 22112 00000559 31DB                    	xor	bx,bx
 22113 0000055B 391E[9602]              	cmp	[RPLMemTop],bx ; 0
 22114                                  	;cmp	word [RPLMemTop],0
 22115                                  	;;cmp	word [cs:RPLMemTop],0
 22116 0000055F 7450                    	je	short NoRPLArena
 22117                                  
 22118                                  ;------ alloc all memory
 22119                                  
 22120                                  	; 11/12/2022
 22121                                  	;mov	bx,0FFFFh
 22122 00000561 4B                      	dec	bx
 22123                                  	; bx = 0FFFFh
 22124 00000562 B448                    	mov	ah,48h
 22125 00000564 CD21                    	int	21h
 22126                                  			; DOS - 2+ - ALLOCATE MEMORY
 22127                                  			; BX = number of 16-byte paragraphs desired
 22128 00000566 B448                    	mov	ah,48h
 22129 00000568 CD21                    	int	21h
 22130                                  
 22131 0000056A 8EC0                    	mov	es,ax			; get it into ES and save it
 22132 0000056C 06                      	push	es
 22133                                  
 22134                                  ;------ resize upto RPL mem
 22135                                  
 22136                                  	; 11/12/2022
 22137                                  	; ds = cs
 22138                                  	;sub	ax,[cs:RPLMemTop]
 22139 0000056D 2B06[9602]              	sub	ax,[RPLMemTop]
 22140 00000571 F7D8                    	neg	ax
 22141 00000573 48                      	dec	ax
 22142 00000574 89C3                    	mov	bx,ax
 22143 00000576 B44A                    	mov	ah,4Ah
 22144 00000578 CD21                    	int	21h
 22145                                    			; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
 22146                                  			; ES = segment address of block to change
 22147                                  			; BX = new size in paragraphs
 22148                                  
 22149                                  ;------ allocate the free (RPL MEM)
 22150                                  
 22151 0000057A BBFFFF                  	mov	bx,0FFFFh
 22152 0000057D B448                    	mov	ah,48h
 22153 0000057F CD21                    	int	21h
 22154 00000581 B448                    	mov	ah,48h
 22155 00000583 CD21                    	int	21h
 22156                                  
 22157                                  ;----- mark that it belongs to RPL
 22158                                  
 22159 00000585 48                      	dec	ax
 22160 00000586 8EC0                    	mov	es,ax
 22161                                  	;mov	word [es:arena_owner],8
 22162 00000588 26C70601000800          	mov	word [es:1],8
 22163                                  	;mov	word [es:arena_name],'RP'
 22164 0000058F 26C70608005250          	mov	word [es:8],'RP'
 22165                                  	;mov	word [es:arena_name+2],'L'
 22166 00000596 26C7060A004C00          	mov	word [es:10],'L'
 22167                                  	;mov	word [es:arena_name+4],0
 22168 0000059D 26C7060C000000          	mov	word [es:12],0
 22169                                  	;mov	word [es:arena_name+6],0
 22170 000005A4 26C7060E000000          	mov	word [es:14],0	
 22171                                  
 22172 000005AB 07                              pop     es                      ; get back ptr to first block
 22173 000005AC B449                            mov     ah,49h	; Dealloc	; and free it
 22174 000005AE CD21                    	int	21h		
 22175                                  					; DOS - 2+ - FREE MEMORY
 22176                                  					; ES = segment address of area to be freed
 22177                                  	; 11/12/2022
 22178 000005B0 F8                      	clc
 22179                                  
 22180                                  ; ----------------------------------------------------------------------------
 22181                                  
 22182                                  NoRPLArena:
 22183                                  	; 11/12/2022
 22184                                  	; ds = cs
 22185                                  	; 22/03/2019 - Retro DOS v4.0 (MSDOS 6.0, 6.21, IO.SYS)
 22186 000005B1 C43E[6D02]              	les	di,[DOSINFO]	; es:di -> dosinfo
 22187                                  	; 22/10/2022 - Retro DOS v4.0 (MSDOS 5.0 IO.SYS SYSINIT)
 22188                                  	;les	di,[cs:DOSINFO]	; es:di -> dosinfo
 22189                                  
 22190                                  	; 11/12/2022
 22191                                  	;clc				; get the extended memory size
 22192                                  
 22193                                  ;	execute the get extended memory size subfunction in the bios int 15h
 22194                                  ;	if the function reports an error do nothing else store the extended
 22195                                  ;	memory size reported at the appropriate location in the dosinfo buffer
 22196                                  ;	currently pointed to by es:di. use the offsets specified in the
 22197                                  ;	definition of the sysinitvars struct in inc\sysvar.inc
 22198                                  
 22199 000005B5 B488                    	mov	ah,88h
 22200 000005B7 CD15                    	int	15h			; check extended memory size
 22201 000005B9 720B                    	jc	short no_ext_memory
 22202                                  			; Get Extended Memory Size
 22203                                  			; Return: CF clear on success
 22204                                  			; AX = size of memory above 1M in K	
 22205                                  	;mov	[es:di+SYSI_EXT_MEM],ax ; save extended memory size
 22206                                  	; 22/10/2022
 22207 000005BB 26894545                	mov	[es:di+45h],ax ; save extended memory size
 22208 000005BF 09C0                    	or	ax,ax
 22209 000005C1 7403                    	jz	short no_ext_memory
 22210 000005C3 E80106                  	call	ClrVDISKHeader
 22211                                  no_ext_memory:
 22212                                  	;mov	ax,[es:di+SYSI_MAXSEC]	; get the sector size
 22213 000005C6 268B4510                	mov	ax,[es:di+10h]
 22214                                  	;add	ax,bufinsiz
 22215 000005CA 83C014                  	add	ax,20			; size of buffer header
 22216                                  	; 11/12/2022
 22217                                  	; ds = cs
 22218 000005CD A3[9D02]                	mov	[singlebuffersize],ax	; total size for a buffer
 22219                                  	;mov	[cs:singlebuffersize],ax	
 22220                                  	; 11/12/2022
 22221 000005D0 A0[9802]                	mov	al,[DEFAULT_DRIVE]	; get the 1 based boot drive number set by msinit
 22222                                  	;mov	al,[cs:DEFAULT_DRIVE]
 22223                                  	;mov	[es:di+SYSI_BOOT_DRIVE],al ; set sysi_boot_drive
 22224 000005D3 26884543                	mov	[es:di+43h],al
 22225                                  
 22226                                  ; determine if 386 system...
 22227                                  
 22228                                  	;get_cpu_type			; macro to determine cpu type
 22229                                  
 22230                                  get_cpu_type:
 22231                                  	; 11/12/2022
 22232 000005D7 9C                      	pushf
 22233                                  	;push	bx
 22234                                  	;xor	bx,bx
 22235                                  	; 11/12/2022
 22236                                  	;xor	cx,cx
 22237                                  	;
 22238 000005D8 31C0                    	xor	ax,ax
 22239                                  	; ax = 0
 22240 000005DA 50                      	push    ax
 22241 000005DB 9D                      	popf
 22242 000005DC 9C                      	pushf
 22243 000005DD 58                      	pop	ax
 22244 000005DE 2500F0                  	and	ax,0F000h
 22245                                  	;cmp	ax,0F000h
 22246 000005E1 80FCF0                  	cmp	ah,0F0h 
 22247 000005E4 7410                    	je	short cpu_8086
 22248                                  	;mov	ax,0F000h
 22249 000005E6 B4F0                    	mov	ah,0F0h
 22250                                  	; ax = 0F000h
 22251 000005E8 50                      	push	ax
 22252 000005E9 9D                      	popf
 22253 000005EA 9C                      	pushf
 22254 000005EB 58                      	pop	ax
 22255                                  	;and	ax,0F000h
 22256 000005EC 80E4F0                  	and	ah,0F0h
 22257 000005EF 7405                    	jz	short cpu_286
 22258                                  cpu_386:
 22259                                  	; 11/12/2022
 22260                                  	;;inc	bx
 22261                                  	;inc	cx
 22262                                  	; 11/12/2022
 22263                                  	;mov	byte [es:di+SYSI_DWMOVE],1
 22264 000005F1 26C6454401              	mov	byte [es:di+44h],1
 22265                                  
 22266                                  	; 03/09/2023 - Retro DOS v5.0 (PCDOS 7.1 Modified SYSINIT)
 22267                                  	; change A20 line on/off check code to the faster (for 32 bit cpu)
 22268                                  	;push	es
 22269                                  	;push	di
 22270                                  	;mov	ax,DOSBIODATASEG ; 0070h
 22271                                  	;mov	es,ax
 22272                                  	;cld
 22273                                  	;mov	di,cpu386_cmpsd ; (IsA20Off)
 22274                                  	;mov	ax,4B9h        ; mov cx,4 ; B90400
 22275                                  	;stosw
 22276                                  	;mov	ax,0F300h      ; repz  ; F3
 22277                                  	;stosw
 22278                                  	;mov	ax,0A766h      ; cmpsd ; 66A7
 22279                                  	;stosw
 22280                                  	;pop	di
 22281                                  	;pop	es
 22282                                  
 22283                                  cpu_286:
 22284                                  	;;;inc	bx
 22285                                  	;;inc	cx
 22286                                  cpu_8086:
 22287                                  	; 11/12/2022
 22288                                  	;;mov	ax,bx	
 22289                                  	;pop	bx
 22290 000005F6 9D                      	popf
 22291                                  
 22292                                  	;...
 22293                                  
 22294                                  	; 11/12/2022
 22295                                  	;or	cl,cl
 22296                                  	;jz	short not_386_system
 22297                                  	; 11/12/202
 22298                                  	;cmp	cl,2
 22299                                  	;;cmp	ax,2			; is it a 386?
 22300                                  	;jne	short not_386_system	; no: don't mess with flag
 22301                                  	;;mov	byte [es:di+SYSI_DWMOVE],1
 22302                                  	; 11/12/2022
 22303                                  	; 22/10/2022
 22304                                  	;mov	byte [es:di+44h],1
 22305                                  not_386_system:
 22306                                  	;mov	al,[es:di+SYSI_NUMIO]
 22307 000005F7 268A4520                	mov	al,[es:di+20h]
 22308                                  	; 11/12/2022
 22309                                  	; ds = cs
 22310 000005FB A2[8003]                	mov	[drivenumber],al	; save start of installable block drvs
 22311                                  	;mov	[cs:drivenumber],al
 22312                                  
 22313 000005FE 8CC8                    	mov	ax,cs
 22314 00000600 83E811                  	sub	ax,11h			; room for PSP we will copy shortly
 22315                                  	; 11/12/2022
 22316                                  	;mov	cx,[singlebuffersize]	; temporary single buffer area
 22317                                  	;;mov	cx,[cs:singlebuffersize]
 22318                                  	;shr	cx,1			
 22319                                  	;shr	cx,1			; divide size by 16...
 22320                                  	;shr	cx,1
 22321                                  	;shr	cx,1			; ...to get paragraphs...
 22322                                  	;inc	cx			; ... and round up
 22323                                  	; 11/12/2022
 22324 00000603 8B1E[9D02]              	mov	bx,[singlebuffersize]
 22325 00000607 B104                    	mov	cl,4
 22326 00000609 D3EB                    	shr	bx,cl
 22327 0000060B 43                      	inc	bx
 22328                                  
 22329                                  ;	cas note: this unorthodox paragraph rounding scheme wastes a byte
 22330                                  ;	  if [singlebuffersize] ever happens to be zero mod 16. Could this
 22331                                  ;	  ever happen? Only if the buffer overhead was zero mod 16, since
 22332                                  ;	  it is probably safe to assume that the sector size always will be.
 22333                                  ;
 22334                                  ;	 mohans also found a bug in CONFIG.SYS processing where it replaces
 22335                                  ;	  EOF's with cr,lf's, without checking for collision with [confbot].
 22336                                  ;	  perhaps the extra byte this code guarantees is what has kept that
 22337                                  ;	  other code from ever causing a problem???
 22338                                  
 22339                                  	; 11/12/2022
 22340 0000060C 29D8                    	sub	ax,bx
 22341                                  	;sub	ax,cx
 22342 0000060E A3[A702]                	mov	[top_of_cdss],ax	; temp "unsafe" location
 22343                                  	; 22/10/2022
 22344                                  	;mov	[cs:top_of_cdss],ax
 22345                                  
 22346                                  ;	chuckst -- 25 Jul 92 -- added code here to pre-allocate space
 22347                                  ;	for 26 temporary CDSs, which makes it easier to use alloclim
 22348                                  ;	for allocating memory for MagicDrv.
 22349                                  
 22350 00000611 06                      	push	es			; preserve pointer to dosinfo
 22351 00000612 57                      	push	di
 22352                                  
 22353                                  	; 22/10/2022
 22354                                  ;	mov	cx,ax			; save pointer for buffer
 22355                                  ;
 22356                                  ;;	now allocate space for 26 CDSs
 22357                                  ;
 22358                                  ;	sub	ax,((26 *(curdirlen))+15)/16
 22359                                  ;	mov	[ALLOCLIM],ax		; init top of free memory pointer
 22360                                  ;	mov	[CONFBOT],ax		; init this in case no CONFIG.SYS
 22361                                  
 22362                                  	; 30/12/2022 - Retro DOS v4.2 (MSDOS 6.21 IO.SYS)
 22363                                  	; (SYSINIT:064Ch)
 22364 00000613 89C1                    	mov	cx,ax ; (*)
 22365 00000615 2D8F00                  	sub	ax,((26 *(curdirlen))+15)/16 ; sub ax,143
 22366 00000618 A3[A502]                	mov	[ALLOCLIM],ax		; init top of free memory pointer
 22367 0000061B A3[A302]                	mov	[CONFBOT],ax		; init this in case no CONFIG.SYS
 22368                                  	 	
 22369                                  ; setup and initialize the temporary buffer at cx
 22370                                  
 22371                                  	;les	di,[es:di+SYSI_BUF]	; get the buffer chain entry pointer
 22372 0000061E 26C47D12                	les	di,[es:di+12h]
 22373                                  	; 11/12/2022
 22374 00000622 31DB                    	xor	bx,bx
 22375                                  	;xor	ax,ax
 22376                                  	;mov	[es:di+BUFFINF.Dirty_Buff_Count],ax ; 0
 22377                                  	;mov	word [es:di+4],0
 22378 00000624 26895D04                	mov	[es:di+4],bx ; 0
 22379                                  	;mov	[es:di+BUFFINF.Buff_Queue],ax ; 0
 22380                                  	;mov	word [es:di],0
 22381 00000628 26891D                  	mov	[es:di],bx ; 0
 22382                                  	;mov	[es:di+BUFFINF.Buff_Queue+2],cx ; cx = [top_of_cdss] ; 6.21
 22383                                  	;;mov	[es:di+BUFFINF.Buff_Queue+2],ax ; ax = [top_of_cdss] ; 5.0
 22384                                  	;mov	[es:di+2],ax
 22385                                  	;mov	es,ax	; [top_of_cdss] = [CONFBOT]
 22386                                  	; 30/12/2022 - Retro DOS v4.2 (MSDOS 6.21 IO.SYS, SYSINIT)
 22387 0000062B 26894D02                	mov	[es:di+2],cx ; [top_of_cdss] ; (*)	
 22388 0000062F 8EC1                    	mov	es,cx
 22389                                  
 22390                                  	; 11/12/2022
 22391                                  	;xor	ax,ax
 22392                                  	;mov	di,ax			; es:di -> single buffer
 22393 00000631 89DF                    	mov	di,bx
 22394                                  	; di = 0
 22395                                  
 22396                                  	;mov	[es:di+buffinfo.buf_next],ax ; points to itself
 22397                                  	; 11/12/2022
 22398                                  	;mov	[es:di],ax ; 0
 22399 00000633 26891D                  	mov	[es:di],bx ; 0
 22400                                  	;mov	[es:di+buffinfo.buf_prev],ax ; points to itself
 22401                                  	; 11/12/2022
 22402                                  	;mov	[es:di+2],ax ; 0
 22403 00000636 26895D02                	mov	[es:di+2],bx ; 0 
 22404                                  
 22405                                  	; 22/10/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS SYINIT)
 22406                                  	; MSDOS 5.0 IO.SYS - SYSINIT:06E0h
 22407                                  
 22408                                  	;mov	word [es:di+buffinfo.buf_ID],00FFh ; free buffer,clear flag
 22409 0000063A 26C74504FF00            	mov	word [es:di+4],00FFh
 22410                                  ;SYSINIT:06E6h
 22411                                  	;;mov	[es:di+buffinfo.buf_sector],ax ; 0
 22412                                  	;mov	word [es:di+6],0
 22413                                  	; 11/12/2022
 22414                                  	;mov	[es:di+buffinfo.buf_sector],bx ; 0
 22415 00000640 26895D06                	mov	[es:di+6],bx ; 0
 22416                                  	;;mov	[es:di+buffinfo.buf_sector+2],ax ; 0
 22417                                  	;mov	word [es:di+8],0
 22418                                  	; 11/12/2022
 22419                                  	;mov	[es:di+buffinfo.buf_sector+2],bx ; 0
 22420 00000644 26895D08                	mov	[es:di+8],bx ; 0
 22421                                  
 22422 00000648 5F                      	pop	di			; restore pointer to DOSINFO data
 22423 00000649 07                      	pop	es
 22424                                  
 22425                                  	; 11/12/2022
 22426                                  	; ds = cs
 22427                                  	; 22/10/2022
 22428                                  	;push	cs
 22429                                  	;pop	ds
 22430                                  
 22431 0000064A E80A06                  	call	TempCDS			; set up cdss so re_init and sysinit
 22432                                  					;  can make disk system calls
 22433                                  					; tempcds trashes ds
 22434                                  	; 10/05/2019
 22435 0000064D 2E8E1E[8502]            	mov	ds,[cs:def_php]		; retrieve pointer to PSP returned by DOSINIT
 22436                                  
 22437                                  	;if not ibmjapver
 22438                                  	;call	far KERNEL_SEGMENT:re_init ; re-call the bios
 22439                                  	;endif
 22440                                  
 22441                                  	; 22/10/2022
 22442                                  ;SYSINIT:06FEh:	; (MSDOS 5.0 IO.SYS, SYSINIT)
 22443                                  	; 30/12/2022
 22444                                  ;SYSINIT:0697h:	; (MSDOS 6.21 IO.SYS, SYSINIT)
 22445                                  	;call	far ptr 70h:89Bh
 22446 00000652 9A[2807]7000            	call	DOSBIODATASEG:RE_INIT
 22447                                  
 22448 00000657 FB                      	sti				; ints ok
 22449 00000658 FC                      	cld				; make sure
 22450                                  
 22451                                  ; 23/03/2019
 22452                                  
 22453                                  ;SYSINIT:069Eh	; 30/12/2022
 22454                                  
 22455                                  ; dosinit has set up a default "process" (php) at ds:0. we will move it out
 22456                                  ; of the way by putting it just below sysinit at end of memory.
 22457                                  
 22458 00000659 8CCB                    	mov	bx,cs
 22459 0000065B 83EB10                  	sub	bx,10h
 22460 0000065E 8EC3                    	mov	es,bx
 22461 00000660 31F6                    	xor	si,si
 22462 00000662 89F7                    	mov	di,si
 22463 00000664 B98000                  	mov	cx,128
 22464 00000667 F3A5                    	rep	movsw
 22465                                  
 22466                                  	;mov	[es:PDB.JFN_POINTER+2],es ; Relocate
 22467                                  	; 22/10/2022
 22468 00000669 268C063600              	mov	[es:36h],es
 22469                                  
 22470                                   	; Set Process Data Block - Program Segment Prefix address
 22471                                  	; BX = PDB/PSP segment
 22472 0000066E B450                            mov	ah,50h	; SET_CURRENT_PDB
 22473 00000670 CD21                    	int	21h			; tell DOS we moved it
 22474                                  			; DOS - 2+ internal - SET PSP SEGMENT
 22475                                  			; BX = segment address of new PSP
 22476                                  	; 22/10/2022
 22477                                  	; 27/03/2019
 22478 00000672 1E                      	push	ds ; */			; preserve DS returned by DOSINIT
 22479                                  
 22480 00000673 0E                      	push	cs	
 22481 00000674 1F                      	pop	ds
 22482                                  
 22483                                  	; set up temp. critical error handler
 22484 00000675 BA[F144]                	mov	dx,int24		; set up int 24 handler
 22485                                  	;;mov	ax,(SET_INTERRUPT_VECTOR*256)+24h
 22486                                  	;mov	ax,(SET_INTERRUPT_VECTOR<<8)|24h
 22487 00000678 B82425                  	mov	ax,2524h
 22488 0000067B CD21                    	int	21h
 22489                                  
 22490 0000067D 803E[8303]00                    cmp     byte [toomanydrivesflag],0 ; Q: >24 partitions?      M029
 22491 00000682 7405                            je      short no_err		   ;  N: continue            M029
 22492 00000684 BA[234D]                        mov     dx,TooManyDrivesMsg	   ;  Y: print error message M029
 22493                                          ; 22/10/2022
 22494                                  	;call	print 			   ;		             M029
 22495                                  	; 12/12/2022
 22496 00000687 EB03                    	jmp	short p_dosinit_msg ; 23/03/2019 - Retro DOS v4.0                    
 22497                                  no_err:
 22498                                  	; 12/05/2019
 22499                                  	;----------------------------------------------
 22500                                  	; 27/06/2018 - Retro DOS v3.0	; 23/03/2019 - Retro DOS v4.0
 22501                                  	; 22/10/2022 - Retro DOS v4.0
 22502                                  	; 12/12/2022
 22503 00000689 BA[F544]                	mov	dx,BOOTMES		; Display (fake) MSDOS version message
 22504                                  p_dosinit_msg:
 22505 0000068C E83D3E                  	call	print			; Print message
 22506                                  	;----------------------------------------------
 22507                                  	
 22508                                  	; 11/12/2022
 22509                                  	; 22/10/2022
 22510                                  	; 23/03/2019 - Retro DOS v4.0
 22511                                  	;pop	ds			; start of free memory
 22512                                  	;mov	dl,[cs:DEFAULT_DRIVE]
 22513                                  	
 22514                                  	; 11/12/2022
 22515                                  	; 27/03/2019
 22516 0000068F 8A16[9802]              	mov	dl,[DEFAULT_DRIVE]	
 22517 00000693 1F                      	pop	ds ; */
 22518                                  
 22519 00000694 08D2                    	or	dl,dl
 22520                                  	;jz	short nodrvset		; bios didn't say
 22521 00000696 7410                    	jz	short ProcessConfig  ; (Retro DOS v4.0 does not contain DBLSPACE code)
 22522                                  	;dec	dl			; A = 0
 22523                                  	; 18/12/2022
 22524 00000698 4A                      	dec	dx
 22525 00000699 B40E                    	mov	ah,0Eh	; SET_DEFAULT_DRIVE
 22526 0000069B CD21                    	int	21h			; select the disk
 22527                                  			; DOS - SELECT DISK
 22528                                  			; DL = new default drive number (0 = A, 1 = B, etc.)
 22529                                  			; Return: AL = number of logical drives
 22530                                  nodrvset:
 22531                                  	; 04/01/2023 - Retro DOS 4.2 (Modified MSDOS 6.21 IO.SYS SYINIT)
 22532                                  	; (SYSINIT:06DFh)
 22533                                  	;push	ds
 22534 0000069D 29C0                    	sub	ax,ax
 22535 0000069F 8ED8                    	mov	ds,ax ; 0 ; ROM BIOS Data Area
 22536 000006A1 A16C04                  	mov	ax,[46Ch] ; timer tick count (18.2 ticks per second)
 22537 000006A4 2EA3[8603]              	mov	[cs:_timer_lw_],ax
 22538                                  	;pop	ds
 22539                                  	; ds <> cs
 22540                                  
 22541                                  	; ---------------------
 22542                                  
 22543                                  	;ifdef	dblspace_hooks
 22544                                  	;	....
 22545                                  	;	....
 22546                                  	;endif	
 22547                                  
 22548                                  	; ---------------------
 22549                                  
 22550                                  ; MSDOS 6.21 IO.SYS, SYSINIT:0744h
 22551                                  
 22552                                  ; 23/03/2019 - Retro DOS v4.0 (MSDOS 6.0, SYSINIT1.ASM, 1991)
 22553                                  ; ----------------------------------------------------------------------------
 22554                                  ; 22/10/2022 - Retro DOS v4.0 (MSDOS 5.0 IO.SYS SYSINIT)
 22555                                  ; ----------------------------------------------------------------------------
 22556                                  ; 30/12/2022 - Retro DOS v4.2 (MSDOS 6.21 IO.SYS SYSINIT)
 22557                                  
 22558                                  ProcessConfig:
 22559                                  	;; ds = cs ; 27/03/2019
 22560                                  	; 11/12/2022
 22561                                  	; ds <> cs	
 22562                                  
 22563                                  ; (MSDOS 5.0 IO.SYS - SYSINIT:0746h)
 22564                                  
 22565 000006A8 E8E118                  	call	doconf			; do pre-scan for dos=high/low
 22566                                  
 22567                                  	; 11/12/2022
 22568                                  	; 27/03/2019
 22569                                  	; ds = cs (at return from doconf)
 22570                                  
 22571                                  ; Now, if this is not romdos, we decide what to do with the DOS code.
 22572                                  ; It will either be relocated to low memory, above the DOS data structures,
 22573                                  ; or else it will be located in HiMem, in which case a stub with the DOS
 22574                                  ; code entry points will be located in low memory. Dos_segreinit is used
 22575                                  ; to tell the DOS data where the code has been placed, and to install the
 22576                                  ; low memory stub if necessary. If the DOS is going to go into HiMem, we
 22577                                  ; must first initialize it in its present location and load the installable
 22578                                  ; device drivers. Then, if a HiMem driver has been located, we can actually
 22579                                  ; relocate the DOS code into HiMem.
 22580                                  ;
 22581                                  ; For ROMDOS, if DOS=HIGH is indicated, then we need to call dos_segreinit
 22582                                  ; to install the low memory stub (this must be done before allowing any
 22583                                  ; device drivers to hook interrupt vectors). Otherwise, we don't need to 
 22584                                  ; call dos_segreinit at all, since the interrupt vector table has already 
 22585                                  ; been patched.
 22586                                  
 22587                                  	; 22/10/2022 - Retro DOS v4.0
 22588                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:0749h)
 22589                                  	;cmp	byte [cs:runhigh],0	; Did user choose to run low ?
 22590                                  	; 11/12/2022
 22591 000006AB 803E[6C02]00            	cmp	byte [runhigh],0
 22592 000006B0 740C                    	je	short dont_install_stub	; yes, don't install dos low mem stub
 22593                                  
 22594                                  ;------ user chose to load high
 22595                                  
 22596                                  	; 22/10/2022
 22597                                  	;mov	es,[cs:CURRENT_DOS_LOCATION] ; MSDOS 6.21 (& MSDOS 6.0)
 22598                                  	; 11/12/2022
 22599                                  	; ds = cs
 22600 000006B2 8E06[7302]              	mov	es,[CURRENT_DOS_LOCATION]
 22601                                  
 22602                                  	;mov	es,[cs:FINAL_DOS_LOCATION]   ; Retro DOS v4.0
 22603                                  	; 27/03/2019
 22604                                  	;;mov	es,[FINAL_DOS_LOCATION]
 22605                                  
 22606 000006B6 31C0                    	xor	ax,ax			; ax = 0 ---> install stub
 22607                                  	; 11/12/2022
 22608                                  	; ds = cs
 22609                                  	;call	far [cs:dos_segreinit]	; call dos segreinit
 22610 000006B8 FF1E[7D02]              	call	far [dos_segreinit]
 22611                                  
 22612 000006BC EB10                    	jmp	short do_multi_pass
 22613                                  
 22614                                  ;------ User chose to load dos low
 22615                                  
 22616                                  dont_install_stub:
 22617                                  	; 22/10/2022
 22618 000006BE 31DB                    	xor	bx,bx			; M012
 22619                                  					; don't use int 21 call to alloc mem
 22620 000006C0 E8D002                  	call	MovDOSLo		; move it !
 22621                                  
 22622 000006C3 B80100                  	mov	ax,1			; dont install stub
 22623                                  	; 11/12/2022
 22624                                  	; ds = cs
 22625 000006C6 8E06[7302]              	mov	es,[CURRENT_DOS_LOCATION]
 22626                                  	;mov	es,[cs:CURRENT_DOS_LOCATION] ; set_dos_final_position set it up
 22627                                  	;;mov	es,[cs:FINAL_DOS_LOCATION]   ; Retro DOS v4.0
 22628                                  	; 27/03/2019
 22629                                  ;do_multi_pass:
 22630                                  	;;mov	es,[FINAL_DOS_LOCATION] 
 22631                                  
 22632                                  	; 11/12/2022
 22633                                  	; ds = cs
 22634                                  	;call	far [cs:dos_segreinit]	; inform dos about new seg
 22635 000006CA FF1E[7D02]              	call	far [dos_segreinit]
 22636                                  do_multi_pass:
 22637 000006CE E80C02                  	call	AllocFreeMem		; allocate all the free mem
 22638                                  					; & update [memhi] & [area]
 22639                                  					; start of free memory.
 22640                                  	;ifdef	dblspace_hooks
 22641                                  	;mov	bx,0			; magic backdoor to place int hooks
 22642                                  	;call	cs:MagicBackdoor
 22643                                  	;endif
 22644                                  
 22645                                  ; Now, process config.sys some more.  
 22646                                  ; Load the device drivers and install programs
 22647                                  
 22648                                  	; 22/10/2022
 22649                                  	;inc	byte [cs:multi_pass_id]	; multi_pass_id = 1
 22650                                  	; 11/12/2022
 22651                                  	; ds = cs
 22652 000006D1 FE06[CD02]              	inc	byte [multi_pass_id]
 22653 000006D5 E85019                  	call	multi_pass		; load device drivers
 22654 000006D8 E86C2D                  	call	ShrinkUMB
 22655 000006DB E8902D                  	call	UnlinkUMB		; unlink all UMBs	;M002
 22656                                  	; 02/11/2022
 22657                                  	;inc	byte [cs:multi_pass_id]	; multi_pass_id = 2
 22658                                  	; 11/12/2022
 22659                                  	; ds = cs
 22660 000006DE FE06[CD02]              	inc	byte [multi_pass_id]
 22661 000006E2 E84319                  	call	multi_pass		; was load ifs (now does nothing)
 22662                                  
 22663                                  	;ifdef	dblspace_hooks
 22664                                  	;call	MagicPostload		; make sure Magicdrv is final placed
 22665                                  	;endif
 22666                                  
 22667                                  	; ds = cs
 22668                                  	
 22669 000006E5 E81706                  	call	endfile			; setup fcbs, files, buffers etc
 22670                                  
 22671                                  	;ifdef	dblspace_hooks
 22672                                  	;call	MagicSetCdss		; disable CDSs of reserved drives
 22673                                  	;endif
 22674                                  
 22675                                  ;Reset SysinitPresent flag here. This is needed for the special fix for lying
 22676                                  ;to device drivers. This has been moved up to this point to avoid problems 
 22677                                  ;with overlays called from installed programs
 22678                                  
 22679                                  	; 11/12/2022
 22680                                  	; ds = cs
 22681                                  
 22682                                  	;;mov	ax,Bios_Data ; 0070h
 22683                                  	;mov	ax,KERNEL_SEGMENT
 22684                                  	; 21/10/2022
 22685 000006E8 B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 22686 000006EB 8EC0                    	mov	es,ax			; point ES to bios data
 22687                                  
 22688 000006ED 26C606[DD07]00          	mov	byte [es:SysinitPresent],0 ; clear SysinitPresent flag
 22689                                  
 22690                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 22691                                  	;test	word [cs:install_flag],have_install_cmd ; 1
 22692                                  	;test	byte [cs:install_flag],1
 22693                                  	; 11/12/2022
 22694                                  	; ds = cs
 22695 000006F3 F606[CE02]01            	test	byte [install_flag],1
 22696                                  	;test	byte [cs:install_flag],have_install_cmd
 22697                                  					; are there install commands?
 22698 000006F8 7407                    	jz	short dolast		; no, no need for further processing
 22699                                  	;inc	byte [cs:multi_pass_id]	; mult_pass_id = 3
 22700                                  	; 11/12/2022
 22701                                  	; ds =cs
 22702 000006FA FE06[CD02]              	inc	byte [multi_pass_id]
 22703 000006FE E82719                  	call	multi_pass		; execute install= commands
 22704                                  
 22705                                  dolast:
 22706                                  	
 22707                                  ; [area] has the segment address for the allocated memory of sysinit, confbot.
 22708                                  ;  free the confbot area used for config.sys and sysinit itself.
 22709                                  
 22710                                  ; Now if DOS is supposed to run high, we actually move it into high memory 
 22711                                  ; (if HiMem manager is available). For ROMDOS, we don't actually move
 22712                                  ; anything, but just set up the ROM area for suballocation (or print
 22713                                  ; a message if HiMem is not available).
 22714                                  ;
 22715                                  ; There is also this little hack for CPM style DOS calls that needs to
 22716                                  ; be done when A20 is set...
 22717                                  
 22718                                  	; 11/12/2022
 22719                                  	; ds = cs
 22720                                  
 22721                                  	; 22/10/2022
 22722                                  	;cmp	byte [cs:runhigh],0FFh	; are we still waiting to be moved?
 22723                                  	; 11/12/2022
 22724 00000701 803E[6C02]FF            	cmp	byte [runhigh],0FFh
 22725 00000706 7503                    	jne	short _@@_ ; 09/12/2022 ; no, our job is over
 22726 00000708 E83702                  	call	LoadDOSHiOrLo
 22727                                  _@@_:
 22728                                  	;cmp	byte [cs:runhigh],0	; are we running low
 22729                                  	; 11/12/2022
 22730                                  	; ds = cs
 22731 0000070B 803E[6C02]00            	cmp	byte [runhigh],0
 22732                                  	;je	short _@@@
 22733 00000710 7403                    	je	short ConfigDone	; yes, no CPM hack needed
 22734 00000712 E82305                  	call	CPMHack			; make ffff:d0 same as 0:c0
 22735                                  ;_@@@:
 22736                                  
 22737                                  ; We are now done with CONFIG.SYS processing
 22738                                  
 22739                                  ConfigDone:
 22740                                  	; 12/12/2022
 22741                                  	; 22/10/2022
 22742                                  	;mov	byte [cs:donotshownum],1 
 22743                                  					; done with config.sys.
 22744                                  					; do not show line number message.
 22745                                  	;mov	es,[cs:area]
 22746                                  	; 12/12/2022
 22747                                  	; ds = cs
 22748                                  	; 27/03/2019
 22749 00000715 C606[5503]01            	mov	byte [donotshownum],1
 22750 0000071A 8E06[6803]              	mov	es,[area]
 22751                                  
 22752 0000071E B449                            mov     ah,49h ; DEALLOC	; free allocated memory for command.com
 22753 00000720 CD21                    	int	21h
 22754                                  			; DOS - 2+ - FREE MEMORY
 22755                                  			; ES = segment address of area to be freed
 22756                                  
 22757                                  	; 22/10/2022
 22758                                  	;test	word [cs:install_flag],2
 22759                                  	;test	word [cs:install_flag],has_installed ; sysinit_base installed?
 22760                                  	;test	byte [cs:install_flag],has_installed
 22761                                  	; 11/12/2022
 22762                                  	; ds = cs
 22763 00000722 F606[CE02]02            	test	byte [install_flag],2 ; has_installed
 22764                                  	;test	byte [install_flag],has_installed
 22765 00000727 741F                    	jz	short skip_free_sysinitbase ; no.
 22766                                  
 22767                                  ; set block from the old_area with impossible_owner_size.
 22768                                  ; this will free the unnecessary sysinit_base that had been put in memory to
 22769                                  ; handle install= command.
 22770                                  
 22771                                  	; 12/12/2022
 22772                                          ;push	es		; BUGBUG 3-30-92 JeffPar: no reason to save ES
 22773                                  	;push	bx
 22774                                  	
 22775                                  	; 22/10/2022
 22776                                  	;mov	es,[cs:old_area]
 22777                                  	;mov	bx,[cs:impossible_owner_size]
 22778                                  	; 12/12/2022
 22779                                  	; ds = cs
 22780 00000729 8E06[5E03]              	mov	es,[old_area]
 22781 0000072D 8B1E[6003]              	mov	bx,[impossible_owner_size]
 22782                                  	
 22783 00000731 B44A                    	mov	ah,4Ah ; SETBLOCK
 22784 00000733 CD21                    	int	21h
 22785                                  			; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
 22786                                  			; ES = segment address of block to change
 22787                                  			; BX = new size in paragraphs
 22788 00000735 8CC0                    	mov	ax,es
 22789 00000737 48                      	dec	ax
 22790 00000738 8EC0                    	mov	es,ax			; point to arena
 22791                                  	;mov	word [es:ARENA.OWNER],8	; set impossible owner
 22792 0000073A 26C70601000800          	mov	word [es:1],8
 22793                                  	;mov	word [es:ARENA.NAME],'SD' ; 4453h ; System Data
 22794 00000741 26C70608005344          	mov	word [es:8],'SD'
 22795                                  	
 22796                                  	; 12/12/2022
 22797                                  	;pop	bx
 22798                                          ;pop	es		; BUGBUG 3-30-92 JeffPar: no reason to save ES
 22799                                  
 22800                                  skip_free_sysinitbase:
 22801                                  	; 22/10/2022
 22802                                  	;cmp	byte [cs:runhigh],0
 22803                                  	; 12/12/2022
 22804                                  	; ds = cs
 22805 00000748 803E[6C02]00            	cmp	byte [runhigh],0	
 22806 0000074D 7403                    	je	short _@@@_ ; 04/07/2023
 22807                                  
 22808 0000074F E8CD03                  	call	InstVDiskHeader	; Install VDISK header (allocates some mem from DOS)
 22809                                  
 22810                                  ; ----------------------------------------------------------------------------
 22811                                  
 22812                                  _@@@_:
 22813                                  	; 12/12/2022
 22814                                  	; ds = cs
 22815                                  	; 22/10/2022
 22816                                  	; 27/03/2019
 22817                                  	;push	cs
 22818                                  	;pop	ds			; point DS to sysinitseg
 22819                                  
 22820                                  ; set up the parameters for command
 22821                                  
 22822                                  ;	; 22/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS SYSINIT)
 22823                                  ;;ifdef	MULTI_CONFIG
 22824                                  ;	mov	byte [config_cmd],0	; set special code for query_user
 22825                                  ;       call    query_user		; to issue the AUTOEXEC prompt
 22826                                  ;	jnc	short process_autoexec	; we should process autoexec normally
 22827                                  ;	; !!!
 22828                                  ;	or	byte [bQueryOpt],4 ; MSDOS 6.21 IO.SYS - SYSINIT:081Fh
 22829                                  ;       ; !!!
 22830                                  ;	call    disable_autoexec        ; no, we should disable it
 22831                                  ;process_autoexec:
 22832                                  ;;endif	; !!!
 22833                                  ;	call	CheckQueryOpt	; MSDOS 6.21 IO.SYS - SYSINIT:0827h	
 22834                                  ;	; !!!
 22835                                  
 22836                                  	; 22/10/2022 
 22837                                  	;mov     cl,[command_line]
 22838                                          ;mov     ch,0
 22839                                          ;inc     cx
 22840                                          ;mov     si,command_line	
 22841                                  	;add     si,cx
 22842                                          ;mov     byte [si],cr	; cr-terminate command line
 22843                                  
 22844                                  	; 22/10/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS)
 22845                                  	; (SYSINIT:0809h)
 22846                                  
 22847                                  	;;;;
 22848                                  
 22849                                  	; 30/12/2022 - Retro DOS 4.2 (Modified MSDOS 6.21 IO.SYS)
 22850                                  	; (SYSINIT:0813h)
 22851                                  	; ds = cs
 22852                                  	; push	cs
 22853                                  	; pop	ds
 22854                                  
 22855 00000752 C606[B314]00            	mov	byte [config_cmd],0	; set special code for query_user
 22856 00000757 E83A39                  	call    query_user		; to issue the AUTOEXEC prompt
 22857 0000075A 7308                    	jnc	short process_autoexec	; we should process autoexec normally
 22858                                  	; !!!
 22859 0000075C 800E[FE46]04            	or	byte [bQueryOpt],4 ; MSDOS 6.21 IO.SYS - SYSINIT:081Fh
 22860                                  	; !!!
 22861 00000761 E82B3A                  	call    disable_autoexec        ; no, we should disable it
 22862                                  process_autoexec:
 22863                                  	; !!!
 22864 00000764 E8733A                  	call	CheckQueryOpt	; MSDOS 6.21 IO.SYS - SYSINIT:0827h	
 22865                                  
 22866                                  	;mov     cl,[command_line]
 22867                                  	; 30/12/2022
 22868 00000767 BE[3446]                	mov	si,command_line
 22869 0000076A 8A0C                    	mov	cl,[si]
 22870 0000076C B500                    	mov     ch,0
 22871 0000076E 41                      	inc     cx
 22872                                  	;mov	si,command_line
 22873 0000076F 01CE                    	add     si,cx
 22874 00000771 C6040D                  	mov     byte [si],cr	; cr-terminate command line
 22875                                  	
 22876                                  	;;;;		
 22877                                  
 22878                                  ; 30/12/2022 - Retro DOS v4.2
 22879                                  %if 0
 22880                                  	;mov	si,(offset command_line+1)
 22881                                  	mov	si,command_line+1
 22882                                  	push    ds
 22883                                  	pop     es
 22884                                  	mov     di,si
 22885                                  	mov     cl,0FFh ; -1
 22886                                  _@_loop:
 22887                                  	inc     cl ; +1
 22888                                  	lodsb
 22889                                  	stosb
 22890                                  	or      al,al
 22891                                  	jnz     short _@_loop
 22892                                  	dec     di
 22893                                  	mov     al,0Dh
 22894                                  	stosb			; cr-terminate command line
 22895                                  	mov     [command_line],cl ; command line length (except CR)
 22896                                  
 22897                                  %endif
 22898                                  
 22899                                  ; ----------------------------------------------------------------------------
 22900                                  
 22901                                  ;   Once we get to this point, the above code, which is below "retry"
 22902                                  ;   in memory, can be trashed (and in fact is -- see references to retry
 22903                                  ;   which follow....)
 22904                                  
 22905                                  retry:
 22906 00000774 BA[A645]                	mov	dx,commnd	; now pointing to file description
 22907                                  
 22908                                  ; we are going to open the command interpreter and size it as is done in
 22909                                  ; ldfil. the reason we must do this is that sysinit is in free memory. if
 22910                                  ; there is not enough room for the command interpreter,exec will probably
 22911                                  ; overlay our stack and code so when it returns with an error sysinit won't be
 22912                                  ; here to catch it. this code is not perfect (for instance .exe command
 22913                                  ; interpreters are possible) because it does its sizing based on the
 22914                                  ; assumption that the file being loaded is a .com file. it is close enough to
 22915                                  ; correctness to be usable.
 22916                                  
 22917                                  ; first, find out where the command interpreter is going to go.
 22918                                  
 22919 00000777 52                      	push	dx		; save pointer to name
 22920 00000778 BBFFFF                  	mov	bx,0FFFFh
 22921 0000077B B448                    	mov	ah,48h	; ALLOC
 22922 0000077D CD21                            int     21h             ; get biggest piece
 22923 0000077F B448                    	mov	ah,48h	; ALLOC
 22924 00000781 CD21                    	int	21h		; second time gets it
 22925 00000783 726B                    	jc	short memerrjx	; oooops
 22926                                  
 22927 00000785 8EC0                    	mov	es,ax
 22928 00000787 B449                    	mov	ah,49h	; DEALLOC
 22929 00000789 CD21                    	int	21h		; give it right back
 22930 0000078B 89DD                    	mov	bp,bx
 22931                                  
 22932                                  ; es:0 points to block,and bp is the size of the block in para.
 22933                                  
 22934                                  ; we will now adjust the size in bp down by the size of sysinit.
 22935                                  ; we need to do this because exec might get upset if some of the exec
 22936                                  ; data in sysinit is overlayed during the exec.
 22937                                  
 22938                                  	; 22/10/2022
 22939                                  	; (MSDOS 5.0 IO.SYS SYSINIT:083Bh)
 22940 0000078D 8B1E[9402]                      mov     bx,[MEMORY_SIZE] ; get location of end of memory
 22941 00000791 8CC8                    	mov	ax,cs		 ; get location of beginning of sysinit
 22942                                  
 22943                                  ; Note that the "config_wrkseg" environment data is a segment in
 22944                                  ; unallocated memory (as of the Dealloc of [area], above). This is ideal
 22945                                  ; in one sense, because Exec is going to make a copy of it for COMMAND.COM
 22946                                  ; anyway, and no one has responsibility for freeing "config_wrkseg". But
 22947                                  ; we need to make sure that there's no way Exec will stomp on that data
 22948                                  ; before it can copy it, and one way to do that is to make the available
 22949                                  ; memory calculation even more "paranoid", by subtracting "config_wrkseg"
 22950                                  ; from the "memory_size" segment value (which is typically A000h) instead
 22951                                  ; of the current sysinit CS....
 22952                                  ;
 22953                                  ; The reason I use the term "paranoid" is because this code should have
 22954                                  ; slid the data required by Exec up to the very top of memory, because as
 22955                                  ; it stands, you have to have sizeof(COMMAND.COM) PLUS 64K to load just
 22956                                  ; COMMAND.COM (64k is about what sysinit, and all the goop above sysinit,
 22957                                  ; consumes). Now it's just a little worse (65K or more, depending on
 22958                                  ; the size of your CONFIG.SYS, since the size of the environment workspace
 22959                                  ; is determined by the size of CONFIG.SYS.... -JTP
 22960                                  
 22961                                  	; 30/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21, IO.SYS)
 22962                                  	; (SYSINIT:0858h)
 22963 00000793 8B0E[AF14]              	mov	cx,[config_envlen]
 22964 00000797 E303                            jcxz	no_env		; use config_wrkseg only if there's env data
 22965 00000799 A1[B114]                        mov	ax,[config_wrkseg]	
 22966                                  
 22967                                  	; 22/10/2022
 22968                                  	;mov	cx,[config_envlen]
 22969                                          ;jcxz	no_env		; use config_wrkseg only if there's env data
 22970                                          ;mov	ax,[config_wrkseg]
 22971                                  ;no_env:
 22972                                  	; 22/10/2022
 22973                                  	; (MSDOS 5.0 IO.SYS SYSINIT:0841h)
 22974                                  no_env:
 22975                                  	; 30/12/2022
 22976                                  	; (MSDOS 6.21 IO.SYS SYSINIT:0861h)
 22977 0000079C 29C3                      	sub     bx,ax           ; bx is size of sysinit in para
 22978 0000079E 83C311                  	add	bx,11h		; add the sysinit php
 22979 000007A1 29DD                    	sub	bp,bx		; sub sysinit size from amount of free memory
 22980 000007A3 724B                    	jc	short memerrjx	; if there isn't even this much memory, give up
 22981                                  
 22982                                          ;mov	ax,(OPEN<<8)	; open the file being execed
 22983 000007A5 B8003D                          mov	ax,3D00h
 22984 000007A8 F9                      	stc                     ; in case of int 24
 22985 000007A9 CD21                    	int	21h
 22986 000007AB 7270                    	jc	short comerr	; ooops
 22987                                  			; DOS - 2+ - OPEN DISK FILE WITH HANDLE
 22988                                  			; DS:DX -> ASCIZ filename
 22989                                  			; AL = access mode
 22990                                  			; 0 - read
 22991                                  	; 22/10/2022
 22992                                  	; (MSDOS 5.0 IO.SYS SYSINIT:0852h)
 22993 000007AD 89C3                            mov     bx,ax           ; handle in bx
 22994                                  
 22995                                  ;   If the standard command interpreter is being used, verify it is correct
 22996                                  
 22997                                  	; 30/12/2022 - Retro DOS v4.2
 22998                                  	; (MSDOS 6.21 IO.SYS, SYSINIT:0874h)
 22999 000007AF 803E[A345]00            	cmp	byte [newcmd],0	; was a new shell selected?
 23000 000007B4 7518                    	jne	short skip_validation ; yes
 23001 000007B6 BA[7007]                	mov	dx,retry-4
 23002 000007B9 B90400                  	mov	cx,4		;
 23003 000007BC B43F                    	mov	ah,READ		;
 23004 000007BE CD21                    	int	21h		;
 23005 000007C0 803E[7007]E9            	cmp	byte [retry-4],0E9h
 23006 000007C5 7556                    	jne	short comerr
 23007                                  	; 20/04/2019 - Retro DOS v4.0
 23008                                  	; 30/12/2022 
 23009                                  	;cmp	byte [retry-1],64h ; MSDOS 6.21 IO.SYS - SYSINIT:088Ch
 23010                                  				; .. COMMAND.COM Version 6.20 (14h&0Fh)	
 23011 000007C7 803E[7307]66            	cmp	byte [retry-1],((MAJOR_VERSION&0Fh)<<4)|(MINOR_VERSION&0Fh)
 23012 000007CC 754F                    	jne	short comerr	;
 23013                                  
 23014                                  	; 22/10/2022
 23015                                  	;cmp	byte [newcmd],0	; was a new shell selected?
 23016                                  	;jne	short skip_validation ; yes
 23017                                  	;mov	dx,retry-4
 23018                                  	;mov	cx,4		;
 23019                                  	;mov	ah,READ		;
 23020                                  	;int	21h		;
 23021                                  	;cmp	byte [retry-4],0E9h
 23022                                  	;jne	short comerr
 23023                                  	;; 20/04/2019 - Retro DOS v4.0
 23024                                  	;cmp	byte [retry-1],64h ; MSDOS 6.21 IO.SYS - SYSINIT:088Ch
 23025                                  	;;cmp	byte [retry-1],((MAJOR_VERSION&0Fh)<<4)|(MINOR_VERSION&0Fh)
 23026                                  	;jne	short comerr	;
 23027                                  
 23028                                  ;skip_validation:
 23029                                  	; 22/10/2022
 23030                                  	; (MSDOS 5.0 IO.SYS SYSINIT:0854h)
 23031                                  skip_validation:
 23032                                  	; 30/12/2022
 23033                                  	; (MSDOS 6.21 IO.SYS SYSINIT:0893h)
 23034 000007CE 31C9                    	xor	cx,cx
 23035 000007D0 31D2                    	xor	dx,dx
 23036                                  	;mov	ax,(LSEEK<<8)|2
 23037 000007D2 B80242                  	mov	ax,4202h
 23038 000007D5 F9                      	stc			;in case of int 24
 23039 000007D6 CD21                    	int	21h		; get file size in dx:ax
 23040 000007D8 7243                    	jc	short comerr
 23041                                  				; convert size in dx:ax to para in ax
 23042 000007DA 83C00F                  	add	ax,15		; round up size for conversion to para
 23043 000007DD 83D200                  	adc	dx,0
 23044 000007E0 E86B04                  	call	off_to_para
 23045 000007E3 B10C                    	mov	cl,12
 23046 000007E5 D3E2                    	shl	dx,cl		; low nibble of dx to high nibble
 23047 000007E7 09D0                    	or	ax,dx		; ax is now # of para for file
 23048 000007E9 83C010                  	add	ax,10h		; 100h byte php
 23049 000007EC 39E8                    	cmp	ax,bp		; will command fit in available mem?
 23050 000007EE 7208                    	jb	short okld	; jump if yes.
 23051                                  
 23052                                  ; 30/12/2022
 23053                                  %if 0
 23054                                  	; 22/10/2022
 23055                                  memerrjx:	; (MSDOS 5.0 IO.SYS SYSINIT:0876h)
 23056                                  	;jmp	memerr	; (MSDOS 5.0 IO.SYS SYSINIT:34D5h)
 23057                                  	; 02/11/2022
 23058                                  	;jmp	mem_err
 23059                                  	; 11/12/2022
 23060                                  	; ds = cs
 23061                                  	jmp	mem_err2
 23062                                  %endif
 23063                                  	; 30/12/2022
 23064                                  	; (MSDOS 6.21, IO.SYS, SYSINIT:08B5h)
 23065                                  memerrjx:
 23066 000007F0 BA[F14A]                	mov	dx,badmem 	; "Configuration too large for memory"
 23067 000007F3 E8D63C                  	call	print
 23068 000007F6 EB3D                    	jmp     short continue
 23069                                  
 23070                                  okld:
 23071 000007F8 B43E                    	mov	ah,3Eh ; CLOSE
 23072 000007FA CD21                    	int	21h		; close file
 23073                                  
 23074                                  	; 22/10/2022
 23075 000007FC 5A                      	pop	dx	; (MSDOS 5.0 IO.SYS SYSINIT:087Dh)
 23076                                  
 23077                                  	; 24/03/2019
 23078                                  
 23079 000007FD 0E                      	push	cs		; point es to sysinitseg
 23080 000007FE 07                      	pop	es
 23081 000007FF BB[BF02]                        mov     bx,COMEXE	; point to exec block
 23082                                  	; 22/10/2022
 23083                                  	;pop	dx              ; recover pointer to name
 23084                                  
 23085                                  ;;ifdef	MULTI_CONFIG
 23086                                  
 23087                                  ;   If there's any environment data in "config_wrkseg", pass it to shell;
 23088                                  ;   there will be data if there were any valid SET commands and/or if a menu
 23089                                  ;   selection was made (in which case the CONFIG environment variable will be
 23090                                  ;   set to that selection).
 23091                                  
 23092                                  	; 23/10/2022
 23093                                  	;mov	cx,[config_envlen]
 23094                                  	;jcxz	no_envdata
 23095                                          ;mov	cx,[config_wrkseg]
 23096                                  ;no_envdata:
 23097                                  	;;mov	[bx+EXEC0.ENVIRON],cx
 23098                                  	;mov	[bx],cx
 23099                                  
 23100                                  ;;endif	;MULTI_CONFIG
 23101                                  
 23102                                  	; 30/12/2022 - Retro DOS v4.2
 23103                                  	; (MSDOS 6.21 IO.SYS SYSINIT:08C7h)
 23104 00000802 8B0E[AF14]              	mov	cx,[config_envlen]
 23105 00000806 E304                    	jcxz	no_envdata
 23106 00000808 8B0E[B114]                      mov	cx,[config_wrkseg]
 23107                                  no_envdata:
 23108                                  	;mov	[bx+EXEC0.ENVIRON],cx
 23109 0000080C 890F                    	mov	[bx],cx	
 23110                                  	
 23111                                  	; 23/10/2022
 23112                                  	; (MSDOS 5.0 IO.SYS SYSINIT:0883h)
 23113                                  
 23114                                  	;mov	[bx+EXEC0.COM_LINE+2],cs ; set segments
 23115 0000080E 8C4F04                  	mov	[bx+4],cs
 23116                                  	;mov	[bx+EXEC0.5C_FCB+2],cs
 23117 00000811 8C4F08                  	mov	[bx+8],cs
 23118                                  	;mov	[bx+EXEC0.6C_FCB+2],cs
 23119 00000814 8C4F0C                  	mov	[bx+12],cs
 23120                                  
 23121                                  	;mov	ax,(EXEC<<8) + 0
 23122                                  	; 23/10/2022
 23123                                  	;xor	ax,ax
 23124                                  	;mov	ah,4Bh
 23125                                  	; 04/07/2023
 23126                                  	;mov	ax,4B00h
 23127 00000817 B8004B                  	mov	ax,(EXEC<<8)
 23128                                  
 23129 0000081A F9                      	stc                     ; in case of int 24
 23130 0000081B CD21                            int     21h             ; go start up command
 23131                                  			; DOS - 2+ - LOAD OR EXECUTE (EXEC)
 23132                                  			; DS:DX -> ASCIZ filename
 23133                                  			; ES:BX -> parameter block
 23134                                  			; AL = subfunc: load & execute program
 23135                                  	;push	cs
 23136                                  	;pop	ds
 23137                                  
 23138                                  	; 23/10/2022
 23139                                  	;push	dx		; push to balance fall-through pop
 23140                                  
 23141                                  ; note fall through if exec returns (an error)
 23142                                  comerr:
 23143                                  	; 23/10/2022
 23144                                  ;;ifdef	MULTI_CONFIG
 23145                                  	;cmp	byte [commnd4],0
 23146                                  	;je	short comerr2	; all defaults exhausted, print err msg
 23147                                  	;cmp	byte [newcmd],0
 23148                                  	;je	short continue	; don't print err msg for defaults just yet
 23149                                  ;comerr2:
 23150                                  ;;endif
 23151                                  
 23152                                  	; 30/12/2022 - Retro DOS v4.2
 23153 0000081D 0E                      	push	cs
 23154 0000081E 1F                      	pop	ds
 23155 0000081F 803E[1746]00            	cmp	byte [commnd4],0
 23156 00000824 7407                    	je	short comerr2	; all defaults exhausted, print err msg
 23157 00000826 803E[A345]00            	cmp	byte [newcmd],0
 23158 0000082B 7408                    	je	short continue	; don't print err msg for defaults just yet
 23159                                  comerr2:
 23160 0000082D 52                      	push	dx ; 30/12/2022
 23161                                  
 23162                                  	; 23/10/2022
 23163 0000082E BA[6D4A]                        mov     dx,badcom	; want to print command error
 23164 00000831 E86C3C                  	call	badfil
 23165                                  	
 23166 00000834 5A                      	pop	dx  ; 30/12/2022
 23167                                  continue:
 23168                                  	; 23/10/2022
 23169                                  	;pop	dx
 23170                                  
 23171                                  ; 30/12/2022
 23172                                  %if 0
 23173                                  
 23174                                  ;;ifndef MULTI_CONFIG
 23175                                  	;jmp	stall
 23176                                  	; 24/10/2022
 23177                                  stall:		; (MSDOS 5.0 IO.SYS, SYSINIT:0899h)
 23178                                  	jmp	short stall
 23179                                  ;;else
 23180                                  
 23181                                  %endif
 23182                                  	
 23183                                  ; 30/12/2022 (MSDOS 6.21 SYSINIT, Retro DOS v4.2)
 23184                                  ;%if 1
 23185                                  ; 23/10/2022 (MSDOS 5.0 SYSINIT, Retrodos v4.0)
 23186                                  ;%if 0	
 23187 00000835 B419                    	mov	ah,GET_DEFAULT_DRIVE ; 19h
 23188 00000837 CD21                    	int	21h             ;
 23189 00000839 0441                    	add	al,'A'          ;
 23190 0000083B 88C2                    	mov	dl,al           ; DL == default drive letter
 23191 0000083D BE[E645]                	mov	si,commnd2
 23192 00000840 803E[A345]00            	cmp	byte [newcmd],0 ; if a SHELL= was given
 23193 00000845 7505                    	jne	short do_def2	; then try the 2nd alternate;
 23194 00000847 C60400                  	mov	byte [si],0	; otherwise, the default SHELL= was tried,
 23195 0000084A EB05                    	jmp	short do_def3   ; which is the same as our 2nd alt, so skip it
 23196                                  do_def2:			
 23197 0000084C 803C00                  	cmp	byte [si],0	; has 2nd alternate been tried?
 23198 0000084F 7554                            jne	short do_alt    ; no
 23199                                  do_def3:
 23200 00000851 BE[F745]                	mov	si,commnd3
 23201 00000854 803C00                  	cmp	byte [si],0	; has 3rd alternate been tried?
 23202 00000857 754C                    	jne	short do_alt	; no
 23203 00000859 BE[1746]                	mov	si,commnd4
 23204 0000085C 803C00                  	cmp	byte [si],0	; has 4th alternate been tried?
 23205 0000085F 7544                    	jne	short do_alt	; no
 23206 00000861 52                      	push	dx              ;
 23207 00000862 BA[C64C]                	mov	dx,badcomprmpt
 23208 00000865 E8643C                  	call	print		;
 23209 00000868 5A                      	pop	dx              ; recover default drive letter in DL
 23210                                  request_input:			;
 23211 00000869 B402                    	mov	ah,STD_CON_OUTPUT
 23212 0000086B CD21                    	int	21h             ;
 23213 0000086D 52                      	push	dx              ;
 23214 0000086E B23E                    	mov	dl,'>'          ;
 23215 00000870 CD21                    	int	21h             ;
 23216 00000872 8A1E[A545]              	mov	bl,[tmplate+1]	;
 23217 00000876 B700                    	mov	bh,0            ;
 23218 00000878 C687[A645]0D            	mov	byte [commnd+bx],0Dh
 23219 0000087D BA[A445]                	mov	dx,tmplate
 23220 00000880 B40A                    	mov	ah,STD_CON_STRING_INPUT
 23221 00000882 CD21                    	int	21h             ; read a line of input
 23222 00000884 BA[184A]                	mov	dx,crlfm	;
 23223 00000887 E8423C                  	call	print           ;
 23224 0000088A 5A                      	pop	dx              ;
 23225 0000088B 8A1E[A545]              	mov	bl,[tmplate+1]	;
 23226 0000088F 08DB                    	or	bl,bl           ; was anything typed?
 23227 00000891 74D6                    	jz	short request_input ;
 23228 00000893 C606[A345]01            	mov	byte [newcmd],1 ; disable validation for user-specified binaries
 23229 00000898 C687[A645]00            	mov	byte [commnd+bx],0 ; NULL-terminate it before execing it
 23230 0000089D C706[3446]000D          	mov	word [command_line],0D00h
 23231 000008A3 EB35                    	jmp	short do_exec   ;
 23232                                  do_alt:
 23233 000008A5 1E                      	push	ds
 23234 000008A6 07                      	pop	es
 23235 000008A7 C606[A345]00            	mov	byte [newcmd],0 ; force validation for alternate binaries
 23236 000008AC BF[A645]                	mov	di,commnd	;
 23237                                  do_alt1:
 23238 000008AF AC                      	lodsb			; copy the alternate, zapping it as we go,
 23239 000008B0 C644FF00                	mov	byte [si-1],0	; so that we know it's been tried
 23240 000008B4 AA                      	stosb 			;
 23241 000008B5 08C0                    	or	al,al		;
 23242 000008B7 75F6                    	jnz	short do_alt1	;
 23243 000008B9 BF[3446]                	mov	di,command_line
 23244 000008BC 807C023A                	cmp	byte [si+2],':'
 23245 000008C0 7503                    	jne	short do_alt2	;
 23246 000008C2 885401                  	mov	[si+1],dl	; stuff default drive into alt. command line
 23247                                  do_alt2:			;
 23248 000008C5 AC                      	lodsb			;
 23249 000008C6 AA                      	stosb			;
 23250 000008C7 08C0                    	or	al,al           ;
 23251 000008C9 75FA                    	jnz	short do_alt2   ;
 23252 000008CB C645FF0D                	mov	byte [di-1],cr  ; ODh
 23253                                  
 23254                                  ;;   Last but not least, see if we need to call disable_autoexec
 23255                                  
 23256                                  	; MSDOS 6.0 (SYSINIT1.ASM)
 23257                                  	;cmp	[command_line-1],0
 23258                                          ;jne	short do_exec   ;
 23259                                          ;mov	[command_line-1],'/'
 23260                                  	;call	disable_autoexec ;
 23261                                  
 23262                                  	; MSDOS 6.21 IO.SYS (SYSINIT:0994h)
 23263 000008CF C606[F446]00            	mov	byte [dae_flag],0 ; 24/03/2019 - Retro DOS v4.0 	
 23264 000008D4 E8B838                  	call	disable_autoexec
 23265 000008D7 E80039                  	call	CheckQueryOpt	; 24/03/2019 - Retro DOS v4.0
 23266                                  do_exec:
 23267 000008DA E997FE                  	jmp	retry		;
 23268                                  
 23269                                  ;;endif	;MULTI_CONFIG
 23270                                  
 23271                                  ;%endif ; 23/10/2022 (MSDOS 5.0 SYSINIT)
 23272                                  ;%endif ; 30/12/2022 (MSDOS 6.21 SYSINIT)
 23273                                  
 23274                                  ; 24/03/2019 - Retro DOS v4.0
 23275                                  
 23276                                  ; ----------------------------------------------------------------------
 23277                                  ; procedure : AllocFreeMem
 23278                                  ;
 23279                                  ; Allocate Max memory from DOS to find out where to load DOS.
 23280                                  ; DOS is at temporary location when this call is being made
 23281                                  ;
 23282                                  ; Inputs : None
 23283                                  ; Outputs: The biggest chunk of memory is allocated (all mem at init time)
 23284                                  ;	   [area] & [memhi] set to the para value of the start of the
 23285                                  ;	   free memory.
 23286                                  ;
 23287                                  ; Uses   : AX, BX
 23288                                  ;
 23289                                  ; ----------------------------------------------------------------------
 23290                                  	
 23291                                  	; 30/12/2022 - Retro DOS v4.2
 23292                                  	; (MSDOS 6.21 IO.SYS, SYSINIT:09A2h)
 23293                                  
 23294                                  	; 23/10/2022
 23295                                  AllocFreeMem:
 23296 000008DD BBFFFF                  	mov	bx,0FFFFh
 23297 000008E0 B448                    	mov	ah,48h ; ALLOC
 23298 000008E2 CD21                    	int	21h			; first time fails
 23299 000008E4 B448                    	mov	ah,48h ; ALLOC
 23300 000008E6 CD21                    	int	21h			; second time gets it
 23301                                  	; 11/12/2022
 23302                                  	; ds = cs
 23303                                  	;mov	[cs:area],ax
 23304                                  	;mov	[cs:memhi],ax		; memhi:memlo now points to
 23305 000008E8 A3[6803]                	mov	[area],ax
 23306 000008EB A3[6403]                	mov	[memhi],ax		; memhi:memlo now points to			
 23307 000008EE C3                      	retn				; start of free memory
 23308                                  				
 23309                                  	; include msbio.cl6
 23310                                  ; ----------------------------------------------------------------------
 23311                                  DOSLOMSG:
 23312 000008EF 484D41206E6F742061-     	db	'HMA not available: Loading DOS low',0Dh,0Ah,'$'
 23312 000008F8 7661696C61626C653A-
 23312 00000901 204C6F6164696E6720-
 23312 0000090A 444F53206C6F770D0A-
 23312 00000913 24                 
 23313                                  FEmsg:
 23314 00000914 466174616C20457272-     	db	'Fatal Error: Cannot allocate Memory for DOS',0Dh,0Ah,'$'
 23314 0000091D 6F723A2043616E6E6F-
 23314 00000926 7420616C6C6F636174-
 23314 0000092F 65204D656D6F727920-
 23314 00000938 666F7220444F530D0A-
 23314 00000941 24                 
 23315                                  
 23316                                  ; ----------------------------------------------------------------------
 23317                                  ;
 23318                                  ; procedure : LoadDOSHiOrLo
 23319                                  ;
 23320                                  ;		Tries to move DOS into HMA. If it fails then loads
 23321                                  ;		DOS into Low memory. For ROMDOS, nothing is actually
 23322                                  ;		moved; this just tries to allocate the HMA, and prints
 23323                                  ;		a message if this is not possible.
 23324                                  ;
 23325                                  ; ----------------------------------------------------------------------
 23326                                  
 23327                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 23328                                  LoadDOSHiOrLo:
 23329                                  	; 27/03/2019 - Retro DOS v4.0
 23330                                  	; ds = cs
 23331 00000942 E81F00                  	call	TryToMovDOSHi		; Try moving it into HMA (M024)
 23332                                  	;jc	short LdngLo		; If that don't work...
 23333                                  	;retn
 23334                                  	; 18/12/2022
 23335 00000945 731C                    	jnc	short LoadDosHi_ok
 23336                                  LdngLo:
 23337                                  	; 23/10/2022
 23338                                  	;push	cs
 23339                                  	;pop	ds
 23340                                  	; 11/12/2022
 23341                                  	; ds = cs
 23342 00000947 B409                    	mov	ah,9
 23343 00000949 BA[EF08]                	mov	dx,DOSLOMSG		; inform user that we are
 23344 0000094C CD21                    	int	21h			; loading low
 23345                                  
 23346                                  ;ifndef ROMDOS
 23347                                  	; actually move the dos, and reinitialize it.
 23348                                  
 23349 0000094E BB0100                  	mov	bx,1				; M012
 23350                                  						;  use int 21 alloc for mem
 23351 00000951 E83F00                  	call	MovDOSLo
 23352                                  	; 11/12/2022
 23353                                  	; ds = cs
 23354                                  	;mov	es,[cs:CURRENT_DOS_LOCATION]	; give dos its temporary loc.
 23355                                  	; 23/10/2022
 23356 00000954 8E06[7302]              	mov	es,[CURRENT_DOS_LOCATION]
 23357                                  	;;mov	es,[cs:FINAL_DOS_LOCATION]  ; 24/03/2019 - Retro DOS v4.0
 23358                                  	;mov	es,[FINAL_DOS_LOCATION] ; 27/03/2019
 23359 00000958 31C0                    	xor	ax,ax				; ax = 00 ---> install stub
 23360                                  	; 11/12/2022
 23361                                  	; ds = cs
 23362                                  	;call	far [cs:dos_segreinit]		; call dos segreinit
 23363 0000095A FF1E[7D02]              	call	far [dos_segreinit] ; 27/03/2019
 23364                                  	
 23365                                  ;endif ; ROMDOS
 23366                                  	; 23/10/2022
 23367                                  	;mov	byte [cs:runhigh],0		; mark that we are running lo
 23368                                  	; 11/12/2022
 23369                                  	; ds = cs
 23370 0000095E C606[6C02]00            	mov	byte [runhigh],0 ; 27/03/2019
 23371                                  LoadDosHi_ok:	; 18/12/2022
 23372 00000963 C3                      	retn
 23373                                  
 23374                                  ; ----------------------------------------------------------------------
 23375                                  ;
 23376                                  ; procedure : TryToMovDOSHi
 23377                                  ;
 23378                                  ;		This tries to move DOS into HMA.
 23379                                  ;		Returns CY if it failed.
 23380                                  ;		If it succeeds returns with carry cleared.
 23381                                  ;
 23382                                  ;		For ROMDOS, dos_segreinit must be called again to allow
 23383                                  ;		the A20 switching code in the low mem stub to be installed.
 23384                                  ; 
 23385                                  ; ----------------------------------------------------------------------
 23386                                  
 23387                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 23388                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:092Ah)
 23389                                  TryToMovDOSHi:
 23390                                  	; 11/12/2022
 23391                                  	; 27/03/2019 - Retro DOS v4.0
 23392                                  	; ds = cs
 23393 00000964 E81300                  	call	MovDOSHi
 23394 00000967 7210                    	jc	short ttldhx
 23395                                  
 23396                                  ;ifndef ROMDOS
 23397                                  	; 23/10/2022
 23398                                  	;mov	es,[cs:CURRENT_DOS_LOCATION] ; give dos its temporary loc.
 23399                                  	;;mov	es,[cs:FINAL_DOS_LOCATION] ; 24/03/2019 - Retro DOS v4.0
 23400                                  	; 11/12/2022
 23401                                  	; ds = cs
 23402 00000969 8E06[7302]              	mov	es,[CURRENT_DOS_LOCATION]
 23403                                  ;else
 23404                                  ;	..
 23405                                  ;endif ; ROMDOS
 23406                                  
 23407                                  	; 11/12/2022
 23408                                  	; ds = cs
 23409 0000096D 31C0                    	xor	ax,ax			; ax = 00 ---> install stub
 23410                                  	;call	far [cs:dos_segreinit]	; call dos segreinit
 23411 0000096F FF1E[7D02]              	call	far [dos_segreinit]
 23412                                  	;mov	byte [cs:runhigh],1
 23413 00000973 C606[6C02]01            	mov	byte [runhigh],1
 23414 00000978 F8                      	clc
 23415                                  ttldhx:
 23416 00000979 C3                      	retn
 23417                                  
 23418                                  ; ----------------------------------------------------------------------
 23419                                  ;
 23420                                  ; procedure : MovDOSHi
 23421                                  ;
 23422                                  ;		Tries to allocate HMA and Move DOS/BIOS code into HMA
 23423                                  ;		For ROMDOS, the code is not actually moved, but the
 23424                                  ;		HMA is allocated and prepared for sub-allocation.
 23425                                  ;
 23426                                  ;		Returns : CY if it failed
 23427                                  ;
 23428                                  ; ----------------------------------------------------------------------
 23429                                  
 23430                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 23431                                  MovDOSHi:
 23432                                  	; 14/05/2019
 23433                                  	; 27/03/2019 - Retro DOS v4.0
 23434                                  	; ds = cs
 23435 0000097A E8D600                  	call	AllocHMA			; did we get HMA?
 23436 0000097D 7213                    	jc	short mdhx			; no
 23437 0000097F B8FFFF                  	mov	ax,0FFFFh			; yes, HMA seg = 0ffffh
 23438 00000982 8EC0                    	mov	es,ax
 23439                                  
 23440                                  ;ifndef ROMDOS
 23441                                  	; actually move the BIOS and DOS
 23442                                  
 23443                                  	; NOTE: Retro DOS v4.0 does not move BIOS (IO.SYS) to HMA
 23444                                  	; 24/03/2019
 23445                                  	
 23446                                  	; 23/10/2022
 23447 00000984 E83200                  	call	MovBIOS				; First move BIOS into HMA
 23448                                  
 23449                                  	; ES:DI points to free HMA after BIOS
 23450                                  	
 23451                                  	; 14/05/2019
 23452                                  	; 24/03/2019 - Retro DOS v4.0
 23453                                  	;xor	di,di
 23454                                  	
 23455                                  	; 23/10/2022
 23456                                  	;mov	cx,[cs:hi_doscod_size]		; pass the code size of DOS
 23457                                  	; 11/12/2022
 23458                                  	; ds = cs
 23459 00000987 8B0E[8302]              	mov	cx,[hi_doscod_size]		; when it is in HMA
 23460 0000098B E81100                  	call	MovDOS				; and move it
 23461                                  
 23462                                  	; ES:DI points to free HMA after DOS
 23463                                  ;else
 23464                                  ;	; allocate space at beginning of HMA to allow for CPMHack
 23465                                  ;
 23466                                  ;	mov	di,0E0h				; room for 5 bytes at ffff:d0
 23467                                  ;
 23468                                  ;endif ; ROMDOS
 23469                                  
 23470 0000098E E85E02                  	call	SaveFreeHMAPtr			; Save the Free HMA ptr
 23471 00000991 F8                      	clc
 23472                                  mdhx:
 23473 00000992 C3                      	retn
 23474                                  
 23475                                  ; ----------------------------------------------------------------------
 23476                                  ;
 23477                                  ; procedure : MovDOSLo
 23478                                  ;
 23479                                  ;		Allocates memory from DOS and moves BIOS/DOS code into it
 23480                                  ;
 23481                                  ; ----------------------------------------------------------------------
 23482                                  
 23483                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 23484                                  
 23485                                  ;ifndef ROMDOS
 23486                                  
 23487                                  MovDOSLo:
 23488                                  	; 14/05/2019
 23489                                  	; 27/03/2019 - Retro DOS v4.0
 23490                                  	; ds = cs
 23491 00000993 E84500                  	call	AllocMemForDOS			; incestuosly!!!
 23492                                  	
 23493                                  	; 23/10/2022
 23494                                  	; 14/05/2019
 23495                                  	;inc	ax  ; skip MCB
 23496                                  	
 23497 00000996 8EC0                    	mov	es,ax				; pass the segment to MovBIOS
 23498                                  	; NOTE: Retro DOS v4.0 does not move BIOS (IO.SYS) to HMA
 23499                                  	; 24/03/2019
 23500                                  	
 23501                                  	; 23/10/2022
 23502 00000998 E81E00                  	call	MovBIOS
 23503                                  
 23504                                  ;------ ES:DI points memory immediately after BIOS
 23505                                  
 23506                                  	; 14/05/2019
 23507                                  	; NOTE: 
 23508                                  	;     Order of (RETRO) DOS kernel sections at memory:
 23509                                  	;	BIOSDATA+BIOSCODE+BIOSDATAINIT+DOSDATA+DOSCODE(LOW)
 23510                                  
 23511                                  	; 24/03/2019 - Retro DOS v4.0
 23512                                  	;xor	di,di	
 23513                                  
 23514                                  	; 23/10/2022
 23515                                  	;mov	cx,[cs:lo_doscod_size]		; DOS code size when loaded
 23516                                  	; 11/12/2022
 23517                                  	; ds = cs
 23518 0000099B 8B0E[8102]              	mov	cx,[lo_doscod_size]		; low
 23519                                  	;call	MovDOS
 23520                                  	;retn
 23521                                  	; 11/12/2022
 23522                                  	;jmp	short MovDOS
 23523                                  
 23524                                  ;endif ; ROMDOS
 23525                                  
 23526                                  ; 11/12/2022
 23527                                  
 23528                                  ; ----------------------------------------------------------------------
 23529                                  ;
 23530                                  ; procedure : MovDOS
 23531                                  ;
 23532                                  ;		Moves DOS code into requested area
 23533                                  ;
 23534                                  ;	In : ES:DI - pointer to memory where DOS is to be moved
 23535                                  ;	     CX    - size of DOS code to be moved
 23536                                  ;
 23537                                  ;	Out : ES:DI - pointer to memory immediately after DOS
 23538                                  ;
 23539                                  ; ----------------------------------------------------------------------
 23540                                  
 23541                                  	; 11/12/2022
 23542                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 23543                                  
 23544                                  ;ifndef ROMDOS
 23545                                  
 23546                                  MovDOS:
 23547                                  	; 14/05/2019
 23548                                  	; 27/03/2019 - Retro DOS v4.0
 23549                                  
 23550                                  	; 11/12/2022
 23551                                  	; ds = cs
 23552                                  
 23553                                  	; 23/10/2022
 23554                                  	;push	ds ; *//
 23555                                  	
 23556 0000099F 06                      	push	es
 23557 000009A0 57                      	push	di
 23558                                  
 23559                                  	; 11/12/2022
 23560 000009A1 1E                      	push	ds ; *// ; 11/12/202
 23561                                  
 23562                                  	; 29/04/2019
 23563 000009A2 C536[7102]              	lds	si,[dosinit] ; 11/12/2022
 23564                                  	; 23/10/2022
 23565                                  	;lds	si,[cs:dosinit]
 23566                                  	; 03/09/2023
 23567 000009A6 89F0                    	mov	ax,si
 23568                                  
 23569 000009A8 F3A4                    	rep	movsb
 23570                                  
 23571 000009AA 1F                      	pop	ds ; *// ; 11/12/2022
 23572                                  
 23573 000009AB 5B                      	pop	bx				; get back offset into which
 23574                                  						;  DOS was moved
 23575                                  	; 03/09/2023
 23576                                  	;;mov	ax,[cs:dosinit]			; get the offset at which DOS
 23577                                  						;  wants to run
 23578                                  	; 03/09/2023
 23579                                  	;mov	ax,[dosinit]
 23580                                  	; ax = [dosinit]
 23581                                  
 23582 000009AC 29D8                    	sub	ax,bx
 23583 000009AE E89D02                  	call	off_to_para
 23584 000009B1 5B                      	pop	bx				; get the segment at which
 23585                                  						;  we moved DOS into
 23586 000009B2 29C3                    	sub	bx,ax				; Adjust segment
 23587                                  	
 23588                                  	; 11/12/2022
 23589                                  	; 23/10/2022
 23590                                  	;mov	[cs:CURRENT_DOS_LOCATION],bx	; and save it
 23591                                  	;;mov	[cs:FINAL_DOS_LOCATION],bx
 23592                                  	; 11/12/2022
 23593 000009B4 891E[7302]              	mov	[CURRENT_DOS_LOCATION],bx
 23594                                  		
 23595                                  	; 27/03/2019
 23596                                  	;pop	ds ; *//
 23597                                  	; ds = cs
 23598                                  	;mov	[FINAL_DOS_LOCATION],bx
 23599                                  
 23600 000009B8 C3                      	retn
 23601                                  
 23602                                  ;endif ;ROMDOS
 23603                                  
 23604                                  ; NOTE: Retro DOS v4.0 does not move BIOS (IO.SYS) to HMA
 23605                                  ; 24/03/2019
 23606                                  ; ----------------------------------------------------------------------
 23607                                  ;
 23608                                  ; procedure : MovBIOS
 23609                                  ;
 23610                                  ;		Moves BIOS code into requested segment
 23611                                  ;
 23612                                  ;	In : ES - segment to which BIOS is to be moved
 23613                                  ;		  ( it moves always into offset BCode_Start)
 23614                                  ;
 23615                                  ;	Out : ES:DI - pointer to memory immediately after BIOS
 23616                                  ;
 23617                                  ; ----------------------------------------------------------------------
 23618                                  
 23619                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 23620                                  
 23621                                  ;ifndef ROMDOS
 23622                                  
 23623                                  MovBIOS: ; proc	near
 23624                                  	; 11/12/2022
 23625 000009B9 1E                      	push	ds ; ds = cs	
 23626                                  	;
 23627                                  	; 23/10/2022
 23628                                  	;mov	ds,[cs:temp_bcode_seg]		; current BIOS code seg
 23629                                  	; 17/09/2023
 23630 000009BA 8E1E[8902]              	mov	ds,[temp_bcode_seg]
 23631                                  	;mov	si,BCODE_START ; mov si,30h
 23632                                  	; 09/12/2022
 23633 000009BE BE[3000]                	mov	si,BCODESTART
 23634 000009C1 89F7                    	mov	di,si
 23635 000009C3 B9801D                  	mov	cx,BCODE_END ; mov cx,1A60h
 23636 000009C6 29F1                    	sub	cx,si				; size of BIOS
 23637 000009C8 D1E9                    	shr	cx,1				; Both the labels are para
 23638                                  						;  aligned
 23639 000009CA F3A5                    	rep	movsw
 23640                                  	
 23641                                  	; 11/12/2022
 23642 000009CC 1F                      	pop	ds ; ds = cs
 23643                                  	;
 23644 000009CD 06                      	push	es
 23645 000009CE 57                      	push	di				; save end of BIOS
 23646 000009CF 8CC0                    	mov	ax,es
 23647                                  	;
 23648                                  	; 11/12/2022
 23649                                  	;mov	[cs:BCodeSeg],ax		; save it for later use
 23650                                  	;;call	dword ptr cs:_seg_reinit_ptr
 23651                                  	;call	far [cs:seg_reinit_ptr]		; far call to seg_reinit (M022)
 23652                                  	; ds = cs
 23653 000009D1 A3[8403]                	mov	[BCodeSeg],ax
 23654 000009D4 FF1E[8702]              	call	far [seg_reinit_ptr]
 23655                                  	;
 23656 000009D8 5F                      	pop	di
 23657 000009D9 07                      	pop	es				; get back end of BIOS
 23658 000009DA C3                      	retn
 23659                                  
 23660                                  ;MovBIOS endp
 23661                                  
 23662                                  ;endif ; ROMDOS
 23663                                  
 23664                                  ; 11/12/2022
 23665                                  %if 0
 23666                                  
 23667                                  ; 24/03/2019
 23668                                  
 23669                                  ; ----------------------------------------------------------------------
 23670                                  ;
 23671                                  ; procedure : MovDOS
 23672                                  ;
 23673                                  ;		Moves DOS code into requested area
 23674                                  ;
 23675                                  ;	In : ES:DI - pointer to memory where DOS is to be moved
 23676                                  ;	     CX    - size of DOS code to be moved
 23677                                  ;
 23678                                  ;	Out : ES:DI - pointer to memory immediately after DOS
 23679                                  ;
 23680                                  ; ----------------------------------------------------------------------
 23681                                  
 23682                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 23683                                  
 23684                                  ;ifndef ROMDOS
 23685                                  
 23686                                  MovDOS:
 23687                                  	; 14/05/2019
 23688                                  	; 27/03/2019 - Retro DOS v4.0
 23689                                  
 23690                                  	; 11/12/2022
 23691                                  	; ds = cs
 23692                                  
 23693                                  	; 23/10/2022
 23694                                  	;push	ds ; *//
 23695                                  	
 23696                                  	push	es
 23697                                  	push	di
 23698                                  
 23699                                  	; 11/12/2022
 23700                                  	push	ds ; *// ; 11/12/202
 23701                                  
 23702                                  	; 29/04/2019
 23703                                  	lds	si,[dosinit] ; 11/12/2022
 23704                                  	; 23/10/2022
 23705                                  	;lds	si,[cs:dosinit]
 23706                                  	; 03/09/2023
 23707                                  	mov	ax,si
 23708                                  
 23709                                  	rep	movsb
 23710                                  
 23711                                  	pop	ds ; *// ; 11/12/2022
 23712                                  
 23713                                  	pop	bx				; get back offset into which
 23714                                  						;  DOS was moved
 23715                                  	;mov	ax,[dosinit] ; 03/09/2023
 23716                                  	;;mov	ax,[cs:dosinit]			; get the offset at which DOS
 23717                                  						;  wants to run
 23718                                  	sub	ax,bx
 23719                                  	call	off_to_para
 23720                                  	pop	bx				; get the segment at which
 23721                                  						;  we moved DOS into
 23722                                  	sub	bx,ax				; Adjust segment
 23723                                  	
 23724                                  	; 11/12/2022
 23725                                  	; 23/10/2022
 23726                                  	;mov	[cs:CURRENT_DOS_LOCATION],bx	; and save it
 23727                                  	;;mov	[cs:FINAL_DOS_LOCATION],bx
 23728                                  	; 11/12/2022
 23729                                  	mov	[CURRENT_DOS_LOCATION],bx
 23730                                  		
 23731                                  	; 27/03/2019
 23732                                  	;pop	ds ; *//
 23733                                  	; ds = cs
 23734                                  	;mov	[FINAL_DOS_LOCATION],bx
 23735                                  
 23736                                  	retn
 23737                                  
 23738                                  ;endif ;ROMDOS
 23739                                  
 23740                                  %endif
 23741                                  
 23742                                  ; ----------------------------------------------------------------------
 23743                                  ;
 23744                                  ; procedure : AllocMemForDOS
 23745                                  ;
 23746                                  ;		Allocate memory for DOS/BIOS code from DOS !!!
 23747                                  ;
 23748                                  ;	Out : AX - seg of allocated memoryblock
 23749                                  ;
 23750                                  ; ----------------------------------------------------------------------
 23751                                  
 23752                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 23753                                  
 23754                                  ;ifndef ROMDOS
 23755                                  
 23756                                  AllocMemForDOS:
 23757                                  	; 11/12/2022
 23758                                  	; 14/05/2019
 23759                                  	; 27/03/2019 - Retro DOS v4.0
 23760                                  	; ds = cs
 23761                                  	;mov	ax,BCode_end
 23762                                  	;sub	ax,BCode_start		; BIOS code size
 23763                                  	; 23/10/2022
 23764 000009DB B8801D                  	mov	ax,BCODE_END ; 1A60h	; 1A70h for MSDOS 6.21
 23765                                  					; 30/12/2022
 23766                                  	;sub	ax,BCODE_START ; 30h
 23767                                  	; 09/12/2022
 23768 000009DE 2D[3000]                	sub	ax,BCODESTART 
 23769                                  	; 24/03/2019 - Retro DOS v4.0 
 23770                                  	; 02/11/2022
 23771                                  	;add	ax,[cs:lo_doscod_size]	; DOS code size
 23772                                  	; 11/12/2022
 23773                                  	; ds = cs
 23774 000009E1 0306[8102]              	add	ax,[lo_doscod_size]
 23775 000009E5 83C00F                  	add	ax,15
 23776 000009E8 E86302                  	call	off_to_para			; convert to para
 23777                                  	; 23/10/2022
 23778                                  	; 14/05/2019
 23779                                  	;inc	ax ; + 1 paragraph for MCB
 23780 000009EB 09DB                    	or	bx,bx				; M012
 23781 000009ED 89C3                    	mov	bx,ax				;  can we use int 21 for alloc
 23782 000009EF 741A                    	jz	short update_arena		; M012
 23783 000009F1 B448                    	mov	ah,48h				; request DOS
 23784 000009F3 CD21                    	int	21h
 23785 000009F5 7250                    	jc	short FatalErr			; IF ERR WE ARE HOSED
 23786                                   	; 23/10/2022
 23787                                  	; 24/03/2019 - Retro DOS v4.0 (ORG 0)
 23788 000009F7 83E803                  	sub	ax,3				; Take care ORG 30h of
 23789                                  						;  BIOS code
 23790 000009FA 8EC0                    	mov	es,ax
 23791                                  	;mov	word [es:20h+ARENA.OWNER],08h	; mark it as system
 23792                                  	;mov	word [es:20h+ARENA.NAME],'SC'	;  code area
 23793                                  	; 14/05/2019
 23794                                  	;mov	word [es:ARENA.OWNER],08h	; mark it as system
 23795                                  	;mov	word [es:ARENA.NAME],'SC'	;  code area
 23796                                  	; 23/10/2022
 23797 000009FC 26C70621000800          	mov	word [es:20h+1],08h		; mark it as system
 23798 00000A03 26C70628005343          	mov	word [es:20h+8],'SC'		;  code area
 23799                                  
 23800 00000A0A C3                      	retn
 23801                                  
 23802                                  ; BUGBUG -- 5 Aug 92 -- chuckst -- Allocating space for DOS
 23803                                  ;	  using DOS itself causes an arena to be generated.
 23804                                  ;	  Unfortunately, certain programs (like PROTMAN$)
 23805                                  ;	  assume that the device drivers are loaded into
 23806                                  ;	  the first arena. For this reason, MagicDrv's
 23807                                  ;	  main device driver header arena is manually
 23808                                  ;	  truncated from the arena chain, and the space
 23809                                  ;	  for DOS is allocated using the following
 23810                                  ;	  simple code, which also assumes that the
 23811                                  ;	  first arena is the free one where DOS's low
 23812                                  ;	  stub will go.
 23813                                  ;
 23814                                  ; M012 : BEGIN
 23815                                  
 23816                                  	; 23/10/2022
 23817                                  update_arena:
 23818 00000A0B 1E                      	push	ds ; ds = cs
 23819 00000A0C 57                      	push	di
 23820 00000A0D 51                      	push	cx
 23821 00000A0E 52                      	push	dx
 23822                                  	; 23/10/2022
 23823                                  	;lds	di,[cs:DOSINFO]			; get ptr to DOS var
 23824                                  	; 11/12/2022
 23825                                  	; ds = cs 
 23826 00000A0F C53E[6D02]              	lds	di,[DOSINFO] ; 27/03/2019	
 23827 00000A13 4F                      	dec	di
 23828 00000A14 4F                      	dec	di				; Arena head is immediately
 23829                                  						;  before sysvar
 23830 00000A15 8E05                    	mov	es,[di]				; es = arena head
 23831                                  	;mov	cx,[es:ARENA.SIZE]		; cx = total low mem size
 23832 00000A17 268B0E0300              	mov	cx,[es:3]
 23833 00000A1C 39D9                    	cmp	cx,bx				; is it sufficient ?
 23834 00000A1E 7227                    	jb	short FatalErr			; no, fatal error
 23835                                  
 23836                                  	;mov	dl,[es:ARENA.SIGNATURE]
 23837 00000A20 268A160000              	mov	dl,[es:0]
 23838 00000A25 8CC0                    	mov	ax,es
 23839 00000A27 01D8                    	add	ax,bx				; ax = new arena head
 23840 00000A29 8905                    	mov	[di],ax				; store it in DOS data area
 23841 00000A2B 8ED8                    	mov	ds,ax
 23842                                  	;mov	[ARENA.SIGNATURE],dl		; type of arena
 23843 00000A2D 88160000                	mov	[0],dl
 23844                                  	;mov	word [ARENA.OWNER],0		; free
 23845 00000A31 C70601000000            	mov	word [1],0
 23846 00000A37 29D9                    	sub	cx,bx				; size of the new block
 23847                                  	;mov	[ARENA.SIZE],cx			; store it in the arena
 23848 00000A39 890E0300                	mov	[3],cx
 23849 00000A3D 8CC0                    	mov	ax,es				; return seg to the caller
 23850                                  	; 23/10/2022
 23851                                  	;; 24/03/2019 - Retro DOS v4.0 (ORG 0)	; Take care ORG 30h of
 23852 00000A3F 83E803                  	sub	ax,3				;  BIOS code
 23853 00000A42 5A                      	pop	dx
 23854 00000A43 59                      	pop	cx
 23855 00000A44 5F                      	pop	di
 23856 00000A45 1F                      	pop	ds ; ds = cs
 23857 00000A46 C3                      	retn
 23858                                  ;
 23859                                  ; M012 : END
 23860                                  ;
 23861                                  FatalErr:
 23862 00000A47 0E                      	push	cs
 23863 00000A48 1F                      	pop	ds
 23864 00000A49 BA[1409]                	mov	dx,FEmsg
 23865 00000A4C B409                    	mov	ah,9
 23866 00000A4E CD21                    	int	21h 		; DOS - PRINT STRING
 23867                                  				; DS:DX -> string terminated by "$"
 23868                                  	; 30/12/2022 (MSDOS 6.21 SYSINIT)
 23869 00000A50 E92C07                  	jmp	stall
 23870                                  	; 23/10/2022 (MSDOS 5.0 SYSINIT)
 23871                                  	;cli
 23872                                  	;hlt
 23873                                  
 23874                                  ;endif ;ROMDOS
 23875                                  
 23876                                  ; 25/03/2019 - Retro DOS v4.0
 23877                                  
 23878                                  ; ----------------------------------------------------------------------
 23879                                  ;
 23880                                  ; procedure : AllocHMA
 23881                                  ;
 23882                                  ;	grab_the_hma tries to enable a20 and make sure there is memory
 23883                                  ;	  up there. If it gets any sort of error, it will return with
 23884                                  ;	  carry set so that we can resort to running low.
 23885                                  ;
 23886                                  ;	It also returns ES: -> 0ffffh if it returns success
 23887                                  ;
 23888                                  ; ----------------------------------------------------------------------
 23889                                  
 23890                                  AllocHMA:
 23891                                  ;	cas note:  The pre-286 check is no longer needed here since the
 23892                                  ;		   presence of XMS is sufficient. However, this code hasn't
 23893                                  ;		   been deleted because it can be recycled for skipping the
 23894                                  ;		   extra pass of CONFIG.SYS and assuming we're running low
 23895                                  ;		   in the case of a pre-286.
 23896                                  
 23897                                  ;;	see if we're running on a pre-286. If not, force low.
 23898                                  ;
 23899                                  ;	xor	ax,ax
 23900                                  ;	pushf			; save flags (like int)
 23901                                  ;	push	ax
 23902                                  ;	popf
 23903                                  ;	pushf
 23904                                  ;	pop	ax
 23905                                  ;	popf			; restore original flags (like int)
 23906                                  ;	and	ax,0F000h
 23907                                  ;	cmp	ax,0F000h	; 8088/8086?
 23908                                  ;	jz	short grab_hma_error
 23909                                  
 23910                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 23911                                  	; (SYSINIT:0A26h)
 23912                                  
 23913 00000A53 1E                      	push	ds
 23914                                  	;;mov	ax,Bios_Data
 23915                                  	;mov	ax,KERNEL_SEGMENT
 23916                                  	; 21/10/2022
 23917 00000A54 B87000                  	mov	ax,DOSBIODATASEG
 23918 00000A57 8ED8                    	mov	ds,ax
 23919                                  
 23920 00000A59 E84A00                  	call	IsXMSLoaded
 23921 00000A5C 7545                    	jnz	short grabhma_error
 23922                                  
 23923 00000A5E B81043                  	mov	ax,4310h
 23924 00000A61 CD2F                    	int	2Fh		; get the vector into es:bx
 23925                                  		; - Multiplex - XMS - GET DRIVER ADDRESS
 23926                                  		; Return: ES:BX -> driver entry point
 23927                                  
 23928 00000A63 891E[0E00]              	mov	[xms],bx
 23929                                  	;mov	[0Eh],bx
 23930 00000A67 8C06[1000]              	mov	[xms+2],es
 23931                                  	;mov	[10h],es
 23932                                  
 23933 00000A6B B401                    	mov	ah,1		; request HMA
 23934 00000A6D BAFFFF                  	mov	dx,0FFFFh
 23935                                  	;call	dword ptr ds:0Eh
 23936 00000A70 FF1E[0E00]              	call	far [xms]
 23937 00000A74 48                      	dec	ax
 23938 00000A75 7409                    	jz	short allocHMA_1 ; error if not able to allocate HMA
 23939                                  
 23940                                  ;------ Himem may be lying because it has allocated mem for int 15
 23941                                  
 23942 00000A77 B488                    	mov	ah,88h
 23943 00000A79 CD15                    	int	15h
 23944                                  		; Get Extended Memory Size
 23945                                  		; Return: CF clear on success
 23946                                  		; AX = size of memory above 1M in K
 23947 00000A7B 83F840                  	cmp	ax,64		; less than 64 K of hma ?
 23948                                  	;jb	short grabhma_error
 23949                                  	; 11/12/2022
 23950 00000A7E 7224                    	jb	short grabhma_err ; cf=1
 23951                                  allocHMA_1:
 23952 00000A80 B405                    	mov	ah,5		; localenableA20
 23953                                  	;call	dword ptr ds:0Eh
 23954 00000A82 FF1E[0E00]              	call	far [xms]
 23955 00000A86 48                      	dec	ax
 23956 00000A87 751A                    	jnz	short grabhma_error ; error if couldn't enable A20
 23957                                  
 23958 00000A89 E88501                  	call	IsVDiskInstalled
 23959 00000A8C 7415                    	jz	short grabhma_error ; yes, we cant use HMA
 23960                                  
 23961 00000A8E B8FFFF                  	mov	ax,0FFFFh
 23962 00000A91 8EC0                    	mov	es,ax
 23963 00000A93 26C70610003412          	mov	word [es:10h],1234h ; see if we can really read/write there
 23964 00000A9A 26813E10003412          	cmp	word [es:10h],1234h
 23965                                  	;jne	short grabhma_error ; don't try to load there if XMS lied
 23966                                  	; 11/12/2022
 23967 00000AA1 7401                    	je	short allocHMA_ok	
 23968                                  
 23969                                  ; 11/12/2022
 23970                                  ;	; 11/12/2022
 23971                                  ;	; cf=0
 23972                                  ;	;clc
 23973                                  ;	pop	ds
 23974                                  ;	retn
 23975                                  
 23976                                  grabhma_error:
 23977 00000AA3 F9                      	stc
 23978                                  	; 11/12/022
 23979                                  grabhma_err:	; cf=1
 23980                                  allocHMA_ok:	; cf=0
 23981 00000AA4 1F                      	pop	ds
 23982 00000AA5 C3                      	retn
 23983                                  
 23984                                  ; ----------------------------------------------------------------------
 23985                                  ;
 23986                                  ; procedure : IsXMSLoaded
 23987                                  ;
 23988                                  ;             Checks whether a XMS driver is loaded
 23989                                  ;
 23990                                  ; Returns : Z flag set if XMS driver loaded
 23991                                  ;           Z flag reset if no XMS drivers are present
 23992                                  ;
 23993                                  ; ----------------------------------------------------------------------
 23994                                  
 23995                                  IsXMSLoaded:
 23996 00000AA6 B80043                  	mov	ax,4300h
 23997 00000AA9 CD2F                    	int	2Fh		; - Multiplex - XMS - INSTALLATION CHECK
 23998                                  				; Return: AL = 80h XMS driver installed
 23999                                  				; AL <> 80h no driver
 24000 00000AAB 3C80                    	cmp	al,80h		; XMS installed?
 24001 00000AAD C3                      	retn
 24002                                  
 24003                                  ; ----------------------------------------------------------------------
 24004                                  ; procedure : FTryToMovDOSHi
 24005                                  ;
 24006                                  ;		Called from HMA suballoc calls
 24007                                  ;	
 24008                                  ; ----------------------------------------------------------------------
 24009                                  
 24010                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 24011                                  	; (SYSINIT:0A84h)
 24012                                  
 24013                                  FTryToMovDOSHi:	; proc	far
 24014                                  
 24015 00000AAE 50                      	push	ax
 24016 00000AAF 53                      	push	bx
 24017 00000AB0 51                      	push	cx
 24018 00000AB1 52                      	push	dx
 24019 00000AB2 56                      	push	si
 24020 00000AB3 57                      	push	di
 24021 00000AB4 1E                      	push	ds
 24022 00000AB5 06                      	push	es
 24023                                  
 24024                                  	; 23/10/2022
 24025                                  	; 27/03/2019 - Retro DOS v4.0
 24026                                  	; 11/12/2022
 24027 00000AB6 0E                      	push	cs
 24028 00000AB7 1F                      	pop	ds
 24029                                  
 24030                                  	;cmp	byte [cs:runhigh],0FFh
 24031                                  	; 11/12/2022
 24032 00000AB8 803E[6C02]FF            	cmp	byte [runhigh],0FFh
 24033 00000ABD 7503                    	jne	short _ftymdh_1
 24034                                  
 24035                                  	; ds = cs
 24036 00000ABF E8A2FE                  	call	TryToMovDOSHi
 24037                                  _ftymdh_1:
 24038 00000AC2 07                      	pop	es
 24039 00000AC3 1F                      	pop	ds
 24040 00000AC4 5F                      	pop	di
 24041 00000AC5 5E                      	pop	si
 24042 00000AC6 5A                      	pop	dx
 24043 00000AC7 59                      	pop	cx
 24044 00000AC8 5B                      	pop	bx
 24045 00000AC9 58                      	pop	ax
 24046                                  
 24047 00000ACA CB                      	retf
 24048                                  
 24049                                  ; ----------------------------------------------------------------------
 24050                                  ;
 24051                                  ; following piece of code will be moved into a para boundary. And the para
 24052                                  ; address posted in seg of int 19h vector. Offset of int 19h will point to
 24053                                  ; VDint19. This is to protect HMA from apps which use VDISK header method
 24054                                  ; to determine free extended memory.
 24055                                  ;
 24056                                  ; For more details read "power programming" column by Ray Duncan in the
 24057                                  ; May 30 1989 issue of PC Magazine (pp 377-388) [USING EXTENDED MEMORY,PART 1]
 24058                                  ;
 24059                                  ; ----------------------------------------------------------------------
 24060                                  
 24061                                  StartVDHead:
 24062                                  ;-------------- what follows is a dummy device driver header (not used by DOS)
 24063                                  
 24064 00000ACB 00000000                	dd	0		; link to next device driver
 24065 00000ACF 0080                    	dw	8000h		; device attribute
 24066 00000AD1 0000                    	dw	0		; strategy routine offset
 24067 00000AD3 0000                    	dw	0		; interrupt routine offset
 24068 00000AD5 01                      	db	1		; number of units
 24069                                  	;db	7 dup(0) 
 24070 00000AD6 00<rep 7h>              	times	7 db 0 		; reserved area
 24071                                  VDiskSig1:
 24072 00000ADD 564449534B              	db	'VDISK'
 24073                                  
 24074                                  VLEN1	equ	($-VDiskSig1)
 24075                                  
 24076 00000AE2 202056332E33            	db	'  V3.3'	; vdisk label
 24077                                  	;db	15 dup (0)	; pad
 24078 00000AE8 00<rep Fh>              	times	15 db 0
 24079 00000AF7 0000                    	dw	0		; bits 0-15 of free HMA
 24080 00000AF9 11                      	db	11h		; bits 16-23 of free HMA (1M + 64K)
 24081                                  VDInt19:
 24082 00000AFA EA                      	db	0EAh		; jmp to old vector
 24083                                  OldVDInt19:
 24084 00000AFB 00000000                	dd	0		; Saved int 19 vector
 24085                                  
 24086                                  EndVDHead: ; label byte
 24087                                  
 24088                                  VDiskHMAHead:	
 24089 00000AFF 000000                  	db	0,0,0		; non-bootable disk
 24090                                  VDiskSig2:
 24091 00000B02 564449534B              	db	'VDISK'
 24092                                  
 24093                                  VLEN2	equ	($-VDiskSig2)
 24094                                  
 24095 00000B07 332E33                  	db	'3.3'		; OEM - signature
 24096 00000B0A 8000                    	dw	128		; number of bytes/sector
 24097 00000B0C 01                      	db	1		; sectors/cluster
 24098 00000B0D 0100                    	dw	1		; reserved sectors
 24099 00000B0F 01                      	db	1		; number of FAT copies
 24100 00000B10 4000                    	dw	64		; number of root dir entries
 24101 00000B12 0002                    	dw	512		; number of sectors
 24102 00000B14 FE                      	db	0FEh		; media descriptor
 24103 00000B15 0600                    	dw	6		; number of sectors/FAT
 24104 00000B17 0800                    	dw	8		; sectors per track
 24105 00000B19 0100                    	dw	1		; number of heads
 24106 00000B1B 0000                    	dw	0		; number of hidden sectors
 24107 00000B1D 4004                    	dw	440h		; Start of free HMA in K (1M+64K)
 24108                                  
 24109                                  EndVDiskHMAHead: ; label byte
 24110                                  
 24111                                  ; ----------------------------------------------------------------------
 24112                                  ;
 24113                                  ; procedure : InstVDiskHeader
 24114                                  ;
 24115                                  ;             Installs the VDISK header to reserve the 64k of HMA
 24116                                  ;	      It puts a 32 byte header at 10000:0 and
 24117                                  ;	      another header at (seg of int19):0
 24118                                  ;
 24119                                  ; Inputs : None
 24120                                  ;
 24121                                  ; Outputs : None
 24122                                  ;
 24123                                  ; USES : DS,SI,AX,CX,DX
 24124                                  ;
 24125                                  ; ----------------------------------------------------------------------
 24126                                  
 24127                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 24128                                  
 24129                                  InstVDiskHeader:
 24130 00000B1F 31C0                    	xor	ax,ax
 24131 00000B21 8ED8                    	mov	ds,ax			; seg of int vect table
 24132                                  
 24133                                  ;-------------- save old int 19 vector
 24134                                  
 24135                                  	; 23/10/2022
 24136 00000B23 A16400                  	mov	ax,[19h*4]
 24137                                  	;mov	[OldVDInt19],ax
 24138 00000B26 2EA3[FB0A]              	mov	[cs:OldVDInt19],ax
 24139 00000B2A A16600                  	mov	ax,[19h*4+2]
 24140                                  	;mov	[OldVDInt19+2],ax
 24141 00000B2D 2EA3[FD0A]              	mov	[cs:OldVDInt19+2],ax
 24142                                  
 24143                                  ;-------------- calculate seg of new int 19 handler
 24144                                  
 24145 00000B31 B448                    	mov	ah,48h			; allocate memory
 24146                                  	;mov	bx,(EndVDHead-StartVDHead+15)>>4
 24147                                  	; 23/10/2022
 24148 00000B33 BB0400                  	mov	bx,4
 24149 00000B36 CD21                    	int	21h
 24150                                  
 24151                                  ;	if carry, fatal hanging error!!!!!
 24152                                  
 24153 00000B38 48                      	dec	ax			; point to arena
 24154 00000B39 8EC0                    	mov	es,ax
 24155                                  	;mov	word [es:ARENA.OWNER],8	; owner = System
 24156 00000B3B 26C70601000800          	mov	word [es:1],8
 24157                                  	;mov	word [es:ARENA.NAME],'SC' ; System Code
 24158 00000B42 26C70608005343          	mov	word [es:8],'SC'
 24159 00000B49 40                      	inc	ax
 24160 00000B4A 8EC0                    	mov	es,ax			; get back to allocated memory
 24161                                  
 24162                                  ;-------------- install new int 19 vector
 24163                                  
 24164 00000B4C FA                      	cli				; no reboots at this time
 24165                                  	;mov	word [19h*4],(VDInt19-StartVDHead)
 24166 00000B4D C70664002F00            	mov	word [19h*4],47
 24167 00000B53 A36600                  	mov	[19h*4+2],ax
 24168                                  
 24169                                  ;-------------- move the code into proper place
 24170                                  
 24171                                  	;mov	cx,(EndVDHead-StartVDHead)
 24172 00000B56 B93400                  	mov	cx,52
 24173 00000B59 BE[CB0A]                	mov	si,StartVDHead
 24174 00000B5C 31FF                    	xor	di,di
 24175 00000B5E 0E                      	push	cs
 24176 00000B5F 1F                      	pop	ds
 24177 00000B60 FC                      	cld
 24178 00000B61 F3A4                    	rep	movsb
 24179 00000B63 FB                      	sti				; BUGBUG is sti OK now?
 24180                                  
 24181                                  ;-------------- mov the HMA VDisk head into HMA
 24182                                  
 24183                                  	; 23/10/2022
 24184 00000B64 57                      	push	di
 24185 00000B65 06                      	push	es
 24186                                  
 24187                                  	;mov	ax,0FFFFh
 24188                                  	;mov	es,ax
 24189                                  	; 03/09/2023
 24190 00000B66 49                      	dec	cx
 24191                                  	; cx = 0FFFFh
 24192 00000B67 8EC1                    	mov	es,cx
 24193                                  
 24194 00000B69 BF1000                  	mov	di,10h
 24195                                  	;mov	cx,(EndVDiskHMAHead-VDiskHMAHead)
 24196 00000B6C B92000                  	mov	cx,32
 24197 00000B6F BE[FF0A]                	mov	si,VDiskHMAHead
 24198 00000B72 F3A4                    	rep	movsb			; ds already set to cs
 24199                                  
 24200 00000B74 5F                      	pop	di
 24201 00000B75 07                      	pop	es
 24202                                  
 24203 00000B76 C3                      	retn
 24204                                  
 24205                                  ; ----------------------------------------------------------------------
 24206                                  ; procedure : ClrVDISKHeader
 24207                                  ;
 24208                                  ;		Clears the first 32 bytes at 1MB boundary
 24209                                  ;		So that DOS/HIMEM is not confused about the VDISK header
 24210                                  ;		left by previous DOS=HIGH session
 24211                                  ;
 24212                                  ; ----------------------------------------------------------------------
 24213                                  
 24214                                  struc desc
 24215 00000000 ????                     .seg_lim:	resw	1		; seg limit 64K 
 24216 00000002 ????                     .lo_word:	resw	1		; 24 bit seg physical 
 24217 00000004 ??                       .hi_byte:	resb 	1		; address
 24218 00000005 ??                       .acc_rights:	resb	1		; access rights ( CPL0 - R/W )
 24219 00000006 ????                     .reserved:	resw	1		;
 24220                                   .size:
 24221                                  endstruc
 24222                                  
 24223                                  		; 23/10/2022
 24224                                  bmove:		;label byte
 24225                                  
 24226                                  dummy:		;times desc.size db 0	; desc	<>
 24227 00000B77 00<rep 8h>              		times 8 db 0		 
 24228                                  gdt:		;times desc.size db 0	; desc	<>
 24229 00000B7F 00<rep 8h>              		times 8 db 0
 24230 00000B87 FFFF                    src_desc:	dw	0FFFFh		; desc	<0ffffh,0,0,93h,0>
 24231 00000B89 0000                    		dw	0
 24232 00000B8B 00                      		db	0
 24233 00000B8C 93                      		db	93h
 24234 00000B8D 0000                    		dw	0
 24235 00000B8F FFFF                    tgt_desc:	dw	0FFFFh		; desc	<0ffffh,0,10h,93h,0>  ; 1MB
 24236 00000B91 0000                    		dw	0
 24237 00000B93 10                      		db	10h
 24238 00000B94 93                      		db	93h
 24239 00000B95 0000                    		dw	0
 24240                                  
 24241                                  rombios_code:	;times desc.size db 0	; desc	<>
 24242 00000B97 00<rep 8h>              		times 8 db 0
 24243                                  temp_stack:	;times desc.size db 0	; desc	<>
 24244 00000B9F 00<rep 8h>              		times 8 db 0
 24245                                  
 24246 00000BA7 00<rep 20h>             ClrdVDISKHead:	times 32 db 0		; db 32 dup (0)
 24247                                  
 24248                                  
 24249                                  ; 25/03/2019 - Retro DOS v4.0 (MSDOS 6.21 IO.SYS, MSDOS 6.0 SYSINIT1.ASM)
 24250                                  
 24251                                  ; 30/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 24252                                  ; (SYSINIT:0CA6h)
 24253                                  
 24254                                  ClrVDISKHeader:	; proc	near
 24255                                  
 24256                                  ;; 04/07/2023 - Retro DOS v4.2 IO.SYS (optimized)
 24257                                  ;;-----------------------------------------------------------	     ;I070
 24258                                  ;; The following workaround get around a problem with the	     ;I070
 24259                                  ;; Tortugas and PS/2 30-286 BIOS when password server mode	     ;I070
 24260                                  ;; is set. On those machines the INT 15h block move code	     ;I070
 24261                                  ;; goes through the 8042 to twiddle A20 instead of port 92h.	     ;I070
 24262                                  ;; In password server mode the 8042 is disabled so the block	     ;I070
 24263                                  ;; move crashes the system. We can do this because these	     ;I070
 24264                                  ;; systems clear all of memory on a cold boot.			     ;I070
 24265                                  ;								     ;I070
 24266                                  ;	in      al,64h         		; Test for passwd servr mode ;I070
 24267                                  ;	test    al,10h			; Is keyboard inhibited?     ;I070
 24268                                  ;	jnz     short ClrVDISKok	; No, go do block move.      ;I070
 24269                                  ;					; Check for Tortugas...	     ;I070
 24270                                  ;	;;cmp	word [cs:sys_model_byte],19F8h                	     ;I070
 24271                                  ;	;cmp	word [sys_model_byte],19F8h  ; ds = cs       
 24272                                  ;	mov	ax,[sys_model_byte]
 24273                                  ;	cmp	ax,19F8h
 24274                                  ;	je      short ClrVDISKno                            	     ;I070
 24275                                  ;					; Check for mod 30-286	     ;I070
 24276                                  ;	;;cmp	word [cs:sys_model_byte],09FCh			     ;I070
 24277                                  ;	;cmp	word [sys_model_byte],09FCh	
 24278                                  ;	cmp	ax,09FCh
 24279                                  ;	jne     short ClrVDISKok			      	     ;I070
 24280                                  ;ClrVDISKno:							     ;I070	
 24281                                  ;	retn	               		; Return w/o block move.     ;I070
 24282                                  ;ClrVDISKok:							     ;I070
 24283                                  ;-----------------------------------------------------------	     ;I070
 24284                                  
 24285                                  	; 12/12/2022
 24286                                  	; ds = cs
 24287                                  
 24288                                  	; 30/12/2022 - Retro DOS v4.2
 24289                                  	; (MSDOS 6.21 IO.SYS SYSINIT:0CBFh)
 24290                                  
 24291 00000BC7 06                      	push	es
 24292 00000BC8 8CC8                    	mov	ax,cs
 24293 00000BCA 89C2                    	mov	dx,ax
 24294 00000BCC B10C                    	mov	cl,12
 24295 00000BCE D3EA                    	shr	dx,cl
 24296 00000BD0 B104                    	mov	cl,4
 24297 00000BD2 D3E0                    	shl	ax,cl
 24298 00000BD4 05[A70B]                	add	ax,ClrdVDISKHead
 24299 00000BD7 80D200                  	adc	dl,0
 24300                                  
 24301                                  	;; 23/10/2022
 24302                                  	;;mov	[cs:src_desc+desc.lo_word],ax
 24303                                  	;mov	[cs:src_desc+2],ax
 24304                                  	;;mov	[cs:src_desc+desc.hi_byte],dl
 24305                                  	;mov	[cs:src_desc+4],dl
 24306                                  	; 12/12/2022
 24307                                  	;mov	[src_desc+desc.lo_word],ax
 24308 00000BDA A3[890B]                	mov	[src_desc+2],ax
 24309                                  	;mov	[src_desc+desc.hi_byte],dl
 24310 00000BDD 8816[8B0B]              	mov	[src_desc+4],dl
 24311                                  
 24312 00000BE1 B91000                  	mov	cx,16	; 16 words
 24313 00000BE4 0E                      	push	cs
 24314 00000BE5 07                      	pop	es
 24315 00000BE6 BE[770B]                	mov	si,bmove
 24316 00000BE9 B487                    	mov	ah,87h
 24317 00000BEB CD15                    	int	15h	; EXTENDED MEMORY - BLOCK MOVE (AT,XT286,PS)
 24318                                  			; CX = number of words to move 
 24319                                  			; ES:SI -> global descriptor table
 24320                                  			; Return: CF set on error, AH = status
 24321 00000BED 07                      	pop	es
 24322 00000BEE C3                      	retn
 24323                                  
 24324                                  ; ----------------------------------------------------------------------
 24325                                  ;
 24326                                  ; procedure : SaveFreeHMAPtr
 24327                                  ;
 24328                                  ;		Save the Free HMA pointer in BIOS variable for later use.
 24329                                  ;		(INT 2f ax==4a01 call returns pointer to free HMA)
 24330                                  ;		Normalizes the pointer to ffff:xxxx format and stores only
 24331                                  ;		the offset.
 24332                                  ;
 24333                                  ; Inputs : ES:DI - pointer to free HMA
 24334                                  ; Output : FreeHMAPtr in BIOS data segment updated
 24335                                  ;
 24336                                  ; ----------------------------------------------------------------------
 24337                                  
 24338                                  SaveFreeHMAPtr:
 24339                                  	; 03/09/2023
 24340 00000BEF 1E                      	push	ds
 24341 00000BF0 B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 24342 00000BF3 8ED8                    	mov	ds,ax
 24343                                  	;
 24344 00000BF5 8CC3                    	mov	bx,es
 24345 00000BF7 B8FFFF                  	mov	ax,0FFFFh	   ; HMA segment
 24346                                  	; 03/09/2023
 24347 00000BFA A2[0D00]                	mov	[inHMA],al ; 0FFh
 24348                                  	;
 24349 00000BFD 29D8                    	sub	ax,bx
 24350 00000BFF 83C70F                  	add	di,15		   ; para round
 24351 00000C02 83E7F0                  	and	di,0FFF0h
 24352 00000C05 B104                    	mov	cl,4
 24353 00000C07 D3E0                    	shl	ax,cl
 24354 00000C09 29C7                    	sub	di,ax
 24355                                  	;
 24356                                  	; 03/09/2023
 24357                                  	;push	ds
 24358                                  	;;mov	ax,Bios_Data ; 0070h
 24359                                  	;mov	ax,KERNEL_SEGMENT ; 0070h
 24360                                  	; 21/10/2022
 24361                                  	; 03/09/2023
 24362                                  	;mov	ax,DOSBIODATASEG ; 0070h
 24363                                  	;mov	ds,ax
 24364 00000C0B 893E[D707]              	mov	[FreeHMAPtr],di	   ; (ds:8F7h for MSDOS 6.21 IO.SYS)
 24365                                  	;mov	byte [inHMA],0FFh  ; (ds:0Dh)
 24366 00000C0F 1F                      	pop	ds
 24367 00000C10 C3                      	retn
 24368                                  
 24369                                  ; ----------------------------------------------------------------------
 24370                                  ;
 24371                                  ; procedure : IsVDiskInstalled
 24372                                  ;
 24373                                  ;		Checks for the presence of VDISK header at 1MB boundary
 24374                                  ;		& INT 19 vector
 24375                                  ;
 24376                                  ; Inputs  : A20 flag should be ON
 24377                                  ; Outputs : Zero set if VDISK header found else Zero cleared
 24378                                  ;
 24379                                  ; ----------------------------------------------------------------------
 24380                                  
 24381                                  IsVDiskInstalled:
 24382 00000C11 31C0                    	xor	ax,ax
 24383 00000C13 8ED8                    	mov	ds,ax
 24384 00000C15 8E1E4E00                	mov	ds,[19*4+2]
 24385                                  	;mov	si,VDiskSig1-StartVDHead ; 12h
 24386                                  	; 23/10/2022
 24387 00000C19 BE1200                  	mov	si,12h ; 18
 24388                                  	;mov	cx,VLEN1 ; 5
 24389 00000C1C B90500                  	mov	cx,5
 24390 00000C1F 0E                      	push	cs
 24391 00000C20 07                      	pop	es
 24392 00000C21 BF[DD0A]                	mov	di,VDiskSig1
 24393 00000C24 F3A6                    	rep	cmpsb
 24394 00000C26 740F                    	je	short ivdins_retn
 24395 00000C28 B8FFFF                  	mov	ax,0FFFFh
 24396 00000C2B 8ED8                    	mov	ds,ax
 24397                                  	;mov	si,10h+(VDiskSig2-VDiskHMAHead) ; 13h
 24398 00000C2D BE1300                  	mov	si,13h
 24399 00000C30 BF[020B]                	mov	di,VDiskSig2
 24400                                  	;;mov	cx,VLEN2  ; 5
 24401                                  	;mov	cx,5
 24402                                  	; 03/09/2023
 24403 00000C33 B105                    	mov	cl,5
 24404 00000C35 F3A6                    	rep	cmpsb
 24405                                  ivdins_retn: 
 24406 00000C37 C3                      	retn			; returns the Zero flag
 24407                                  
 24408                                  ; ----------------------------------------------------------------------
 24409                                  ;
 24410                                  ; procedure : CPMHack
 24411                                  ;
 24412                                  ;		Copies the code from 0:c0 into ffff:0d0h
 24413                                  ;		for CPM compatibility
 24414                                  ;
 24415                                  ; ----------------------------------------------------------------------
 24416                                  
 24417                                  	; 11/12/2022
 24418                                  CPMHack:
 24419 00000C38 1E                      	push	ds
 24420 00000C39 B9FFFF                  	mov	cx,0FFFFh
 24421 00000C3C 8EC1                    	mov	es,cx		; ES = 0FFFFh
 24422                                  	;xor	cx,cx
 24423                                  	; 11/12/2022
 24424 00000C3E 41                      	inc	cx  ; cx = 0
 24425 00000C3F 8ED9                    	mov	ds,cx		; DS = 0
 24426 00000C41 BEC000                  	mov	si,0C0h
 24427 00000C44 BFD000                  	mov	di,0D0h
 24428                                  	;mov	cx,5
 24429 00000C47 B105                    	mov	cl,5
 24430 00000C49 FC                      	cld
 24431 00000C4A F3A4                    	rep	movsb		; move 5 bytes from 0:C0 to FFFF:D0
 24432 00000C4C 1F                      	pop	ds
 24433 00000C4D C3                      	retn
 24434                                  
 24435                                  ; ----------------------------------------------------------------------
 24436                                  ;
 24437                                  ; procedure : off_to_para
 24438                                  ;
 24439                                  ; ----------------------------------------------------------------------
 24440                                  off_to_para:
 24441 00000C4E D1E8                    	shr	ax,1
 24442 00000C50 D1E8                    	shr	ax,1
 24443 00000C52 D1E8                    	shr	ax,1
 24444 00000C54 D1E8                    	shr	ax,1
 24445 00000C56 C3                      	retn
 24446                                  
 24447                                  ; ----------------------------------------------------------------------
 24448                                  ;**	TempCDS - Create (Temporary?) CDS
 24449                                  ;
 24450                                  ;	ENTRY	?? BUGBUG
 24451                                  ;		(DS) = SysInitSeg
 24452                                  ;	EXIT	?? BUGBUG
 24453                                  ;	USES	?? BUGBUG
 24454                                  ; ----------------------------------------------------------------------
 24455                                  
 24456                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 24457                                  	; 30/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 24458                                  TempCDS:
 24459 00000C57 C43E[6D02]              	les	di,[DOSINFO]
 24460 00000C5B 268A4D20                	mov	cl,[es:di+SYSI_NUMIO]
 24461                                  	;mov	cl,[es:di+20h]
 24462 00000C5F 30ED                    	xor	ch,ch			; (cx) = # of block devices
 24463                                  
 24464 00000C61 26884D21                	mov	[es:di+SYSI_NCDS],cl	; one CDS per device
 24465                                  	;mov	[es:di+21h],cl	
 24466                                  
 24467 00000C65 88C8                    	mov	al,cl
 24468 00000C67 B458                    	mov	ah,curdirlen ; curdir_list.size ; 88
 24469                                  	;mov	ah,88
 24470 00000C69 F6E4                    	mul	ah			; (ax) = byte size for those CDSs
 24471 00000C6B E8D804                  	call	ParaRound		; (ax) = paragraph size for CDSs
 24472 00000C6E 8B36[A702]              	mov	si,[top_of_cdss] ; 31/12/2022
 24473                                  
 24474                                  ;	BUGBUG - we don't update confbot - won't someone else use it?
 24475                                  ;	chuckst -- answer: no. Confbot is used to access the CDSs,
 24476                                  ;	25 jul 92  which are stored BELOW it. Alloclim is the
 24477                                  ;		   variable which has the top of free memory for
 24478                                  ;		   device driver loads, etc.
 24479                                  
 24480 00000C72 29C6                    	sub	si,ax
 24481                                  
 24482                                  ;	chuckst, 25 Jul 92 -- note: I'm removing the code here
 24483                                  ;		that automatically updates alloclim every time we
 24484                                  ;		set up some new CDSs. Instead, I've added code
 24485                                  ;		which pre-allocates space for 26 CDSs. This
 24486                                  ;	        way we've got room for worst case CDSs before
 24487                                  ;		we place MagicDrv.sys
 24488                                  ;
 24489                                  ;	mov	[ALLOCLIM],si		; can't alloc past here!
 24490                                  
 24491                                  	; 30/12/2022
 24492                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 24493                                  	; (SYSINIT:0C52h)
 24494                                  	;mov	[ALLOCLIM],si ; (MSDOS 5.0 SYSINIT)
 24495                                  
 24496 00000C74 26897518                	mov	[es:di+SYSI_CDS+2],si
 24497                                  	;mov	[es:di+18h],si
 24498 00000C78 89F0                    	mov	ax,si
 24499 00000C7A 26C745160000            	mov	word [es:di+SYSI_CDS],0	; set address of CDS list
 24500                                  	;mov	[word es:di+16h],0
 24501                                  	;lds	si,[es:di+SYSI_DPB]	; (ds:si) = address of first DPB
 24502 00000C80 26C535                  	lds	si,[es:di]
 24503 00000C83 8EC0                    	mov	es,ax
 24504 00000C85 31FF                    	xor	di,di			; (es:di) = address of 1st CDS
 24505                                  
 24506                                  ;*	Initialize our temporary CDSs. We'll init each CDS with the
 24507                                  ;	info from the corresponding DPB.
 24508                                  ;
 24509                                  ;	(cx) = count of CDSs left to process
 24510                                  ;	(es:di) = address of next CDS
 24511                                  
 24512                                  fooset:
 24513                                  	; 23/10/2022
 24514 00000C87 2EA1[A902]              	mov	ax,[cs:DirStrng] ; "A:"
 24515 00000C8B AB                      	stosw				; setup the root as the curdir
 24516                                  	
 24517                                  	; 23/10/2022 (MSDOS 5.0 SYSINIT)
 24518                                  	;call	get_dpb_for_drive_al	; get dpb for drive in dpb
 24519                                  
 24520                                  	; 30/12/2022
 24521                                  	; (MSDOS 6.21 SYSINIT:0D8Bh)
 24522 00000C8C E85A00                  	call	get_dpb_for_drive_al	; get dpb for drive in dpb
 24523                                  
 24524                                  ;	(ds:si) = address of DPB
 24525                                  ;		 (si) = -1 if no drive
 24526                                  
 24527 00000C8F 2EA1[AB02]              	mov	ax,[cs:DirStrng+2] ; "\",0
 24528 00000C93 AB                      	stosw
 24529 00000C94 2EFE06[A902]            	inc	byte [cs:DirStrng]
 24530 00000C99 31C0                    	xor	ax,ax ; 0
 24531 00000C9B 51                      	push	cx
 24532                                  	;mov	cx,curdir_list.cdir_flags - 4 ; 63
 24533 00000C9C B93F00                  	mov	cx,63	; 23/10/2022
 24534 00000C9F F3AA                    	rep	stosb			; zero out rest of CURDIR_TEXTs
 24535                                  
 24536                                  ;	should handle the system that does not have any floppies.
 24537                                  ;	in this case,we are going to pretended there are two dummy floppies
 24538                                  ;	in the system. still they have dpb and cds,but we are going to
 24539                                  ;	0 out curdir_flags,curdir_devptr of cds so ibmdos can issue
 24540                                  ;	"invalid drive specification" message when the user try to
 24541                                  ;	access them.
 24542                                  ;
 24543                                  ;	(ax) = 0
 24544                                  ;	(es:di) = CURDIR_FLAGS in the CDS records
 24545                                  ;	(ds:si) = Next DPB (-1 if none)
 24546                                  
 24547 00000CA1 83FEFF                  	cmp	si,-1	; cmp si,0FFFFh
 24548 00000CA4 7413                    	je	short fooset_zero	; don't have any physical drive.
 24549                                  
 24550                                  ;	check to see if we are faking floppy drives. if not go to normcds.
 24551                                  ;	if we are faking floppy drives then see if this cds being initialised
 24552                                  ;	is for drive a: or b: by checking the appropriate field in the dpb
 24553                                  ;	pointed to by ds:si. if not for a: or b: then go to normcds. if
 24554                                  ;	for a: or b: then execute the code given below starting at fooset_zero.
 24555                                  ;	for dpb offsets look at inc\dpb.inc.
 24556                                  	
 24557                                  	; 03/09/2023
 24558 00000CA6 41                      	inc	cx  ; cx = 1
 24559                                  
 24560 00000CA7 2E380E[8B02]            	cmp	[cs:fake_floppy_drv],cl ; 1 ; 03/09/2023
 24561                                  	;cmp	byte [cs:fake_floppy_drv],1
 24562 00000CAC 7512                    	jne	short normcds 		; machine has floppy drives
 24563                                  	;cmp	byte [si+DPB.drive],1	; if dpb_drive = 0 (a) or 1 (b).
 24564                                  	;cmp	byte [si],1
 24565 00000CAE 380C                    	cmp	[si],cl ; 1 ; 03/09/2023
 24566 00000CB0 770E                    	ja	short normcds
 24567 00000CB2 B103                    	mov	cl,3			; the next dbp pointer
 24568                                  					; AX should be zero here
 24569 00000CB4 F3AB                    	rep	stosw
 24570 00000CB6 59                      	pop	cx
 24571 00000CB7 EB17                    	jmp	short get_next_dpb
 24572                                  
 24573                                  ;	(ax) = 0
 24574                                  
 24575                                  fooset_zero:
 24576 00000CB9 B103                    	mov	cl,3
 24577 00000CBB F3AB                    	rep	stosw
 24578 00000CBD 59                      	pop	cx
 24579 00000CBE EB10                    	jmp	short fincds
 24580                                  
 24581                                  ;*	We have a "normal" DPB and thus a normal CDS.
 24582                                  ;
 24583                                  ;	(ax) = 0
 24584                                  ;	(es:di) = CURDIR_FLAGS in the CDS records
 24585                                  ;	(ds:si) = Next DPB (-1 if none)
 24586                                  
 24587                                  normcds:
 24588 00000CC0 59                      	pop	cx
 24589                                  
 24590                                  ;	if a non-fat based media is detected (by dpb.numberoffat == 0), then
 24591                                  ;	set curdir_flags to 0. this is for signaling ibmdos and ifsfunc that
 24592                                  ;	this media is a non-fat based one.
 24593                                  
 24594                                  	;cmp	byte [si+DPB.FAT_COUNT],0 ; non fat system?
 24595                                  	; 23/10/2022
 24596                                  	;cmp	byte [si+8],0
 24597                                  	; 03/09/2023 (ax=0)
 24598 00000CC1 384408                  	cmp	[si+8],al ; 0
 24599 00000CC4 7403                    	je	short setnormcds	; yes. set curdir_flags to 0. ax = 0 now.
 24600 00000CC6 B80040                  	mov	ax,curdir_inuse ; 4000h	; else,fat system. set the flag to curdir_inuse.
 24601                                  	;mov	ax,4000h
 24602                                  setnormcds:
 24603 00000CC9 AB                      	stosw				; curdir_flags
 24604 00000CCA 89F0                    	mov	ax,si
 24605 00000CCC AB                      	stosw				; curdir_devptr
 24606 00000CCD 8CD8                    	mov	ax,ds
 24607 00000CCF AB                      	stosw
 24608                                  
 24609                                  get_next_dpb:				; entry point for fake_fooset_zero
 24610                                  	; 30/12/2022
 24611                                  	; (MSDOS 6.21 SYSINIT:0DD1h)
 24612                                  	; 23/10/2022
 24613                                  	;lds	si,[si+19h] ; (MSDOS 5.0 SYSINIT)
 24614                                  	;;lds	si,[si+DPB.NEXT_DPB] ; [si+19h]
 24615                                  fincds:	; get_next_dpb
 24616                                  	; 30/12/2022
 24617                                  	; (MSDOS 6.21 SYSINIT:0DD1h)
 24618 00000CD0 B8FFFF                  	mov	ax,-1	; mov ax,0FFFFh
 24619 00000CD3 AB                      	stosw				; curdir_id
 24620 00000CD4 AB                      	stosw				; curdir_id
 24621 00000CD5 AB                      	stosw				; curdir_user_word
 24622 00000CD6 B80200                  	mov	ax,2
 24623 00000CD9 AB                      	stosw				; curdir_end
 24624 00000CDA B000                    	mov	al,0			; clear out 7 bytes (curdir_type,
 24625 00000CDC AA                      	stosb
 24626 00000CDD AB                      	stosw				;  curdir_ifs_hdr,curdir_fsda)
 24627 00000CDE AB                      	stosw
 24628 00000CDF AB                      	stosw
 24629                                  
 24630 00000CE0 E2A5                    	loop	fooset
 24631                                  	
 24632 00000CE2 2EC606[A902]41          	mov	byte [cs:DirStrng],"A"	; "A:\"
 24633                                  	
 24634 00000CE8 C3                      	retn
 24635                                  
 24636                                  ; ----------------------------------------------------------------------
 24637                                  ;***	get_dpb_for_drive_al -- lookup the DPB for drive in al
 24638                                  ;
 24639                                  ;	entry:
 24640                                  ;	   al == ASCII CAPS drive letter
 24641                                  ;
 24642                                  ;	exit:
 24643                                  ;	   ds:si -> DPB, or si = -1 if not found
 24644                                  ; ----------------------------------------------------------------------
 24645                                  
 24646                                  ; 30/12/2022
 24647                                  ; (MSDOS 6.21 SYSINIT:0DEAh)
 24648                                  ; 23/10/2022
 24649                                  ;%if 0
 24650                                  get_dpb_for_drive_al:
 24651 00000CE9 2EC536[6D02]            	lds	si,[cs:DOSINFO]		; point to first DPB
 24652                                  	;lds	si,[si+SYSI_DPB]	; (ds:si) = address of first DPB
 24653 00000CEE C534                    	lds	si,[si]
 24654 00000CF0 2C41                    	sub	al,'A'
 24655                                  
 24656                                  get_dpb_for_drive_1:
 24657                                  	;cmp	al,[si+DPB.DRIVE]	; match?
 24658 00000CF2 3A04                    	cmp	al,[si]
 24659 00000CF4 7408                    	je	short got_dpb_for_drive	;  done if so
 24660                                  
 24661 00000CF6 C57419                  	lds	si,[si+DPB.NEXT_DPB] ; [si+19h]
 24662 00000CF9 83FEFF                  	cmp	si,-1
 24663 00000CFC 75F4                    	jne	short get_dpb_for_drive_1 ; loop until hit end of DPBs
 24664                                  
 24665                                  got_dpb_for_drive:
 24666 00000CFE C3                      	retn
 24667                                  ;%endif  ; 23/10/2022
 24668                                  
 24669                                  ;=======================================================================
 24670                                  
 24671                                  ;**	EndFile - Build DOS structures
 24672                                  ;
 24673                                  ; This procedure is called after the config.sys has been processed and
 24674                                  ; installable device drivers have been loaded (but before "install="
 24675                                  ; programs are loaded) to create the dos structures such as SFTs, buffers,
 24676                                  ; FCBs, CDSs, etc. It also loads the sysinit_base module in low memory
 24677                                  ; to allow for the safe EXECing of "install=" programs. All memory
 24678                                  ; above these structures is deallocated back to DOS.
 24679                                  ;
 24680                                  ;	ENTRY	?? BUGBUG
 24681                                  ;	EXIT	?? BUGBUG
 24682                                  ;	USES	?? BUGBUG
 24683                                  
 24684                                  ;=======================================================================
 24685                                  ; allocate files
 24686                                  ; ----------------------------------------------------------------------
 24687                                  
 24688                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 24689                                  	; (SYSINIT:0CCDh)
 24690                                  
 24691                                  	; 30/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 24692                                  	; (SYSINIT:0E00h)
 24693                                  endfile:
 24694                                  ; we are now setting up final cdss,buffers,files,fcss strings etc. we no
 24695                                  ; longer need the space taken by the temp stuff below confbot,so set alloclim
 24696                                  ; to confbot.
 24697                                  
 24698                                  ;	if this procedure has been called to take care of install= command,
 24699                                  ;	   then we have to save es,si registers.
 24700                                  
 24701                                  	; 11/12/2022
 24702                                  	; ds = cs
 24703                                  
 24704                                  	; 23/10/2022
 24705                                  	; 31/03/2019
 24706 00000CFF 1E                      	push	ds
 24707                                  
 24708                                  	;;mov	ax,Bios_Data ; 0070h
 24709                                  	;mov	ax,KERNEL_SEGMENT ; 0070h
 24710                                  	; 21/10/2022
 24711 00000D00 B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 24712 00000D03 8ED8                    	mov	ds,ax
 24713                                  
 24714                                  	;cmp	word [052Fh],0
 24715 00000D05 833E[A004]00            	cmp	word [multrk_flag],multrk_off1 ;=0,multrack= command entered?
 24716 00000D0A 7505                    	jne	short multrk_flag_done
 24717                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 24718                                  	;or	word [multrk_flag],multrk_on ; 80h  ; default will be on.
 24719                                  	; 12/12/2022
 24720 00000D0C 800E[A004]80            	or	byte [multrk_flag],multrk_on ; 80h
 24721                                  multrk_flag_done:
 24722                                  	; 23/10/2022
 24723                                  	; 31/03/2019
 24724 00000D11 1F                      	pop	ds
 24725                                  
 24726                                  	; 11/12/2022
 24727                                  	; ds = cs
 24728                                  	;mov	ax,[top_of_cdss] ; mov ax,[CONFBOT]
 24729                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 24730                                  	; (SYSINIT:0E14h)
 24731 00000D12 A1[A302]                	mov	ax,[CONFBOT]
 24732 00000D15 A3[A502]                	mov	[ALLOCLIM],ax
 24733                                  	; 23/10/2022
 24734                                  	;mov	ax, [cs:top_of_cdss]
 24735                                  	;mov	[cs:ALLOCLIM], ax 
 24736                                  
 24737                                  	; 11/12/2022
 24738                                  	; ds = cs
 24739                                  	;push	cs
 24740                                  	;pop	ds
 24741                                  	
 24742                                  	;mov	ax,[CONFBOT]
 24743                                  	;mov	[ALLOCLIM],ax
 24744                                  
 24745 00000D18 E84F35                  	call	round
 24746                                  	; 11/12/2022
 24747                                  	; ds = cs
 24748 00000D1B A0[9F02]                	mov	al,[FILES]
 24749                                  	; 23/10/2022
 24750                                  	;mov	al,[cs:FILES]
 24751 00000D1E 2C05                    	sub	al,5
 24752 00000D20 764B                    	jbe	short dofcbs
 24753                                  
 24754 00000D22 50                      	push	ax
 24755                                  	;mov	al,devmark_files ; 'F'
 24756 00000D23 B046                    	mov	al,'F'
 24757 00000D25 E86B07                  	call	setdevmark		; set devmark for sfts (files)
 24758 00000D28 58                      	pop	ax
 24759 00000D29 30E4                    	xor	ah,ah			; do not use cbw instruction!!!!!
 24760                                  					;  it does sign extend.
 24761                                  	; 11/12/2022mhhj.mnm
 24762                                  	; ds = cs
 24763 00000D2B 8B1E[6203]              	mov	bx,[memlo]
 24764 00000D2F 8B16[6403]              	mov	dx,[memhi]
 24765 00000D33 C53E[6D02]              	lds	di,[DOSINFO]		;get pointer to dos data
 24766                                  	; 23/10/2022
 24767                                  	;mov	bx,[cs:memlo]
 24768                                  	;mov	dx,[cs:memhi]
 24769                                  	;lds	di,[cs:DOSINFO]		
 24770                                  
 24771                                  	;lds	di,[di+SYSI_SFT]	;ds:bp points to sft
 24772 00000D37 C57D04                  	lds	di,[di+4]
 24773                                  
 24774                                  	;mov	[di+SF.SFLink],bx
 24775 00000D3A 891D                    	mov	[di],bx
 24776 00000D3C 895502                  	mov	[di+SF.SFLink+2],dx	;set pointer to new sft
 24777                                  
 24778 00000D3F 0E                      	push	cs
 24779 00000D40 1F                      	pop	ds
 24780                                  
 24781                                  	; 11/12/2022
 24782                                  	; ds = cs
 24783 00000D41 C43E[6203]              	les	di,[memlo]		;point to new sft
 24784                                  	; 23/10/2022
 24785                                  	;les	di,[cs:memlo]
 24786                                  
 24787                                  	;mov	word [es:di+SF.SFLink],-1
 24788 00000D45 26C705FFFF              	mov	word [es:di],-1		; 0FFFFh
 24789                                  	;mov	[es:di+SF.SFCount],ax
 24790 00000D4A 26894504                	mov	[es:di+4],ax
 24791                                  	;mov	bl,SF_ENTRY.size ; 59
 24792 00000D4E B33B                    	mov	bl,59
 24793 00000D50 F6E3                    	mul	bl			;ax = number of bytes to clear
 24794 00000D52 89C1                    	mov	cx,ax
 24795                                  	; 11/12/2022
 24796                                  	; ds = cs
 24797 00000D54 0106[6203]              	add	[memlo],ax		;allocate memory
 24798                                  	; 23/10/2022
 24799                                  	;add	[cs:memlo],ax
 24800 00000D58 B80600                  	mov	ax,6
 24801                                  	; 11/12/2022
 24802 00000D5B 0106[6203]              	add	[memlo],ax		;remember the header too
 24803                                  	;add	[cs:memlo],ax
 24804                                  	; 11/12/2022
 24805 00000D5F 800E[B814]02            	or	byte [setdevmarkflag],for_devmark ; 2
 24806                                  	; 23/10/2022
 24807                                  	;or	byte [cs:setdevmarkflag],2
 24808 00000D64 E80335                  	call	round			; check for mem error before the stosb
 24809 00000D67 01C7                    	add	di,ax
 24810 00000D69 31C0                    	xor	ax,ax
 24811 00000D6B F3AA                    	rep	stosb			;clean out the stuff
 24812                                  
 24813                                  ; allocate fcbs
 24814                                  ; ----------------------------------------------------------------------
 24815                                  
 24816                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 24817                                  	; (SYSINIT:0D48h)
 24818                                  dofcbs:
 24819                                  	; 11/12/2022
 24820                                  	; ds = cs
 24821                                  	;push	cs
 24822                                  	;pop	ds
 24823 00000D6D E8FA34                  	call	round
 24824                                  	;mov	al,devmark_fcbs	; 'X'	;='x'
 24825 00000D70 B058                    	mov	al,'X'
 24826 00000D72 E81E07                  	call	setdevmark
 24827                                  	; 11/12/2022
 24828                                  	; ds = cs
 24829 00000D75 A0[A002]                	mov	al,[FCBS]
 24830                                  	;mov	al,[cs:FCBS]
 24831 00000D78 30E4                    	xor	ah,ah			; do not use cbw instruction!!!!!
 24832                                  					;  it does sign extend.
 24833                                  	; 11/12/2022
 24834 00000D7A 8B1E[6203]              	mov	bx,[memlo]
 24835 00000D7E 8B16[6403]              	mov	dx,[memhi]
 24836 00000D82 C53E[6D02]              	lds	di,[DOSINFO]		;get pointer to dos data
 24837                                  	; 23/10/2022
 24838                                  	;mov	bx,[cs:memlo]
 24839                                  	;mov	dx,[cs:memhi]
 24840                                  	;lds	di,[cs:DOSINFO]
 24841                                  
 24842                                  	;mov	[di+SYSI_FCB],bx
 24843                                  	;mov	[di+SYSI_FCB+2],dx ;set pointer to new table
 24844                                  	; 23/10/2022
 24845 00000D86 895D1A                  	mov	[di+1Ah],bx		; [di+SYSI_FCB]
 24846 00000D89 89551C                  	mov	[di+1Ch],dx		; [di+SYSI_FCB+2]
 24847                                  
 24848 00000D8C 2E8A1E[A102]            	mov	bl,[cs:KEEP]
 24849 00000D91 30FF                    	xor	bh,bh
 24850                                  	;mov	[di+SYSI_KEEP],bx
 24851 00000D93 895D1E                  	mov	[di+1Eh],bx		; [di+SYSI_KEEP]	
 24852                                  
 24853 00000D96 0E                      	push	cs
 24854 00000D97 1F                      	pop	ds
 24855                                  	
 24856 00000D98 C43E[6203]              	les	di,[memlo]		; point to new table
 24857                                  	;mov	word [es:di+SF.SFLink],-1
 24858 00000D9C 26C705FFFF              	mov	word [es:di],-1
 24859                                  	;mov	[es:di+SF.SFCount],ax
 24860                                  	; 02/11/2022
 24861 00000DA1 26894504                	mov	[es:di+4],ax
 24862 00000DA5 B339                    	mov	bl,SF_ENTRY.size ; 59
 24863 00000DA7 89C1                    	mov	cx,ax
 24864 00000DA9 F6E3                    	mul	bl			; ax = number of bytes to clear
 24865 00000DAB 0106[6203]              	add	[memlo],ax		; allocate memory
 24866                                  	;mov	ax,6
 24867 00000DAF B80600                  	mov	ax,SF.size-2 ; 6
 24868 00000DB2 0106[6203]              	add	[memlo],ax		; remember the header too
 24869                                  	;or	byte [setdevmarkflag],for_devmark ; 2
 24870 00000DB6 800E[B814]02            	or	byte [setdevmarkflag],2
 24871 00000DBB E8AC34                  	call	round			; check for mem error before the stosb
 24872 00000DBE 01C7                    	add	di,ax			; skip over header
 24873 00000DC0 B041                    	mov	al,'A'
 24874                                  fillloop:
 24875 00000DC2 51                      	push	cx			; save count
 24876 00000DC3 B93900                  	mov	cx,SF_ENTRY.size ; 59	; number of bytes to fill
 24877 00000DC6 FC                      	cld
 24878 00000DC7 F3AA                    	rep	stosb			; filled
 24879                                  
 24880                                  	;mov	word [es:di-(SF_ENTRY.size)+SF_ENTRY.sf_ref_count],0  ; [es:di-59]
 24881                                  	;mov	word [es:di-(SF_ENTRY.size)+SF_ENTRY.sf_position],0   ; [es:di-38]	
 24882                                  	;mov	word [es:di-(SF_ENTRY.size)+SF_ENTRY.sf_position+2],0 ; [es:di-36]
 24883                                  
 24884                                  	; 18/12/2022
 24885                                  	;cx = 0
 24886 00000DC9 26894DC7                	mov	[es:di-(SF_ENTRY.size)+SF_ENTRY.sf_ref_count],cx ;0  ; [es:di-59]
 24887 00000DCD 26894DDC                	mov	[es:di-(SF_ENTRY.size)+SF_ENTRY.sf_position],cx ;0   ; [es:di-38]	
 24888 00000DD1 26894DDE                	mov	[es:di-(SF_ENTRY.size)+SF_ENTRY.sf_position+2],cx ;0 ; [es:di-36]
 24889                                  	
 24890                                  	; 23/10/2022	
 24891                                  	;mov     word [es:di-3Bh],0
 24892                                  	;mov     word [es:di-26h],0
 24893                                  	;mov     word [es:di-24h],0
 24894                                  
 24895 00000DD5 59                      	pop	cx
 24896 00000DD6 E2EA                    	loop	fillloop
 24897                                  
 24898                                  ; allocate buffers
 24899                                  ; ----------------------------------------------------------------------
 24900                                  
 24901                                  ; search through the list of media supported and allocate 3 buffers if the
 24902                                  ; capacity of the drive is > 360kb
 24903                                  
 24904                                  	; 18/12/2022
 24905                                  	; cx = 0
 24906 00000DD8 833E[9902]FF            	cmp	word [buffers],-1	; has buffers been already set?
 24907 00000DDD 7403                    	je	short dodefaultbuff
 24908 00000DDF E98000                  	jmp	dobuff			; the user entered the buffers=.
 24909                                  
 24910                                  dodefaultbuff:
 24911                                  	; 18/12/2022
 24912 00000DE2 890E[9B02]              	mov	[h_buffers],cx ; 0
 24913 00000DE6 41                      	inc	cx
 24914 00000DE7 41                      	inc	cx
 24915 00000DE8 890E[9902]              	mov	[buffers],cx ; 2	
 24916                                  	
 24917                                  	;mov	word [h_buffers],0	; default is no heuristic buffers.
 24918                                  	;mov	word [buffers],2	; default to 2 buffers
 24919                                  
 24920                                  	; 23/10/2022
 24921                                  	; 04/09/2023
 24922                                  	;push	ax
 24923                                  	;push	ds ; 26/03/2019
 24924                                  
 24925                                  	; 04/09/2023
 24926                                  	; ds = cs
 24927 00000DEC C42E[6D02]              	les	bp,[DOSINFO]		; search through the dpb's
 24928                                  	;les	bp,[cs:DOSINFO]
 24929                                  	;les	bp,[es:bp+SYSI_DPB]	; get first dpb
 24930                                  	; 11/12/2022
 24931 00000DF0 26C46E00                	les	bp,[es:bp]
 24932                                  	; 23/10/2022
 24933                                  	;les	bp,[es:bp+0]	; ! (MSDOS 5.0 IO.SYS address compability) !	
 24934                                  
 24935                                  	; 04/09/2023
 24936                                  	; ds = cs
 24937                                  	;push	cs
 24938                                  	;pop	ds
 24939                                  ;SYSINIT:0DE2h:
 24940                                  nextdpb:				; test if the drive supports removeable media
 24941                                  	;mov	bl,[es:bp+DPB.drive]
 24942                                  	; 11/12/2022
 24943 00000DF4 268A5E00                	mov	bl,[es:bp]
 24944                                  	; 23/10/2022
 24945                                  	;mov	bl,[es:bp+0]	; ! (MSDOS 5.0 IO.SYS address compability) !
 24946                                  
 24947                                  	;inc	bl
 24948                                  	; 18/12/2022
 24949 00000DF8 43                      	inc	bx
 24950                                  
 24951                                  	;mov	ax,(IOCTL<<8)|8
 24952 00000DF9 B80844                  	mov	ax,4408h
 24953 00000DFC CD21                    	int	21h		; DOS - 2+ - IOCTL -
 24954                                  
 24955                                  ; ignore fixed disks
 24956                                  
 24957 00000DFE 09C0                    	or	ax,ax			; ax is nonzero if disk is nonremoveable
 24958 00000E00 7534                    	jnz	short nosetbuf
 24959                                  
 24960                                  ; get parameters of drive
 24961                                  
 24962 00000E02 31DB                    	xor	bx,bx
 24963                                  	;;mov	bl,[es:bp+DPB.drive]
 24964                                  	; 11/12/2022
 24965 00000E04 268A5E00                	mov	bl,[es:bp]
 24966                                  	; 23/10/2022
 24967                                  	;mov	bl,[es:bp+0]	; ! (MSDOS 5.0 IO.SYS address compability) !
 24968                                  	
 24969                                  	;inc	bl
 24970                                  	; 18/12/2022
 24971 00000E08 43                      	inc	bx
 24972                                  
 24973 00000E09 BA[2E48]                	mov	dx,deviceparameters
 24974                                  	;mov	ax,(IOCTL<<8)|GENERIC_IOCTL
 24975 00000E0C B80D44                  	mov	ax,440Dh
 24976                                  	;mov	cx,(RAWIO<<8)|GET_DEVICE_PARAMETERS
 24977 00000E0F B96008                  	mov	cx,860h
 24978 00000E12 CD21                    	int	21h		; DOS - 2+ - IOCTL -
 24979 00000E14 7220                    	jc	short nosetbuf		; get next dpb if driver doesn't support
 24980                                  					; generic ioctl
 24981                                  ; determine capacity of drive
 24982                                  ; media capacity = #sectors * bytes/sector
 24983                                  
 24984                                  	;mov	bx,[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_TOTALSECTORS]
 24985                                  	; 23/10/2022
 24986 00000E16 8B1E[3D48]              	mov	bx,[deviceparameters+15] ; total sectors (16 bit)
 24987                                  	
 24988                                  ; to keep the magnitude of the media capacity within a word,
 24989                                  ; scale the sector size
 24990                                  ; (ie. 1 -> 512 bytes,2 -> 1024 bytes,...)
 24991                                  
 24992                                  	;mov	ax,[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_BYTESPERSECTOR]
 24993                                  	; 23/10/2022
 24994 00000E1A A1[3548]                	mov	ax,[deviceparameters+7] ; bytes per sector
 24995 00000E1D 31D2                    	xor	dx,dx
 24996 00000E1F B90002                  	mov	cx,512
 24997 00000E22 F7F1                    	div	cx			; scale sector size in factor of
 24998                                  					; 512 bytes
 24999 00000E24 F7E3                    	mul	bx			; ax = #sectors * size factor
 25000 00000E26 09D2                    	or	dx,dx			; just in case of large floppies
 25001 00000E28 7505                    	jnz	short setbuf
 25002 00000E2A 3DD002                  	cmp	ax,720			; 720 sectors * size factor of 1
 25003 00000E2D 7607                    	jbe	short nosetbuf
 25004                                  setbuf:
 25005                                  	; 18/12/2022
 25006                                  	; word [buffers] = 2
 25007 00000E2F C606[9902]03            	mov	byte [buffers],3
 25008                                  	;mov	word [buffers],3
 25009 00000E34 EB0D                    	jmp	short chk_memsize_for_buffers ; now check the memory size
 25010                                  					; for default buffer count
 25011                                  nosetbuf:
 25012                                  	; 23/10/2022
 25013                                  	;cmp	word [es:bp+DPB.NEXT_DPB],-1
 25014 00000E36 26837E19FF              	cmp	word [es:bp+19h], -1 ; 0FFFFh
 25015 00000E3B 7406                    	je	short chk_memsize_for_buffers
 25016                                  	;les	bp,[es:bp+DPB.NEXT_DPB] ; [es:bp+19h]
 25017 00000E3D 26C46E19                	les	bp,[es:bp+19h]
 25018 00000E41 EBB1                    	jmp	short nextdpb
 25019                                  
 25020                                  ;from dos 3.3,the default number of buffers will be changed according to the
 25021                                  ;memory size too.
 25022                                  ; default buffers = 2
 25023                                  ; if diskette media > 360 kb,then default buffers = 3
 25024                                  ; if memory size > 128 kb (2000h para),then default buffers = 5
 25025                                  ; if memory size > 256 kb (4000h para),then default buffers = 10
 25026                                  ; if memory size > 512 kb (8000h para),then default buffers = 15.
 25027                                  
 25028                                  chk_memsize_for_buffers:
 25029                                  	; 18/12/2022
 25030                                  	;cmp	word [MEMORY_SIZE],2000h
 25031                                  	;jbe	short bufset
 25032                                  	;mov	word [buffers],5
 25033                                  	;cmp	word [MEMORY_SIZE],4000h
 25034                                  	;jbe	short bufset
 25035                                  	;mov	word [buffers],10
 25036                                  	;cmp	word [MEMORY_SIZE],8000h
 25037                                  	;jbe	short bufset
 25038                                  	;mov	word [buffers],15
 25039                                  
 25040                                  	; 18/12/2022
 25041                                  	; word [buffers] = 3 or 2
 25042 00000E43 BB[9902]                	mov	bx,buffers
 25043 00000E46 A1[9402]                	mov	ax,[MEMORY_SIZE]
 25044 00000E49 48                      	dec	ax	; [MEMORY_SIZE] - 1
 25045                                  
 25046 00000E4A 80FC20                  	cmp	ah,20h	; ax >= 2000h ([MEMORY_SIZE] > 2000h) ; *
 25047 00000E4D 7213                    	jb	short bufset
 25048 00000E4F C6070F                  	mov	byte [bx],15 ; [buffers] = 15 ; ***
 25049 00000E52 80FC80                  	cmp	ah,80h	; ax >= 8000h ([MEMORY_SIZE] > 8000h) ; ***
 25050 00000E55 730B                    	jnb	short bufset
 25051 00000E57 C6070A                  	mov	byte [bx],10 ; [buffers] = 10 ; **
 25052 00000E5A 80FC40                  	cmp	ah,40h	; ax >= 4000h ([MEMORY_SIZE] > 4000h) ; **
 25053 00000E5D 7303                    	jnb	short bufset
 25054 00000E5F C60705                  	mov	byte [bx],5  ; [buffers] = 5 ; *
 25055                                  bufset:
 25056                                  	; 23/10/2022
 25057                                  	; 26/03/2019
 25058                                  	; 04/09/2023
 25059                                  	;pop	ds
 25060                                  	;pop	ax
 25061                                  
 25062                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 25063                                  ;j.k. here we should put extended stuff and new allocation scheme!!!
 25064                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 25065                                  
 25066                                  ; 26/03/2019
 25067                                  
 25068                                  ;*******************************************************************************
 25069                                  ;									       *
 25070                                  ; function: actually allocate buffers in the memory and initialize it. 	       *
 25071                                  ; input :								       *
 25072                                  ;    memhi:memlo - start of the next available memory			       *
 25073                                  ;    buffers = number of buffers					       *
 25074                                  ;    h_buffers = number of secondary buffers				       *
 25075                                  ;									       *
 25076                                  ; output:								       *
 25077                                  ;	buffinfo.cache_count - # of caches to be installed.		       *
 25078                                  ;	buffinfo set.							       *
 25079                                  ;	bufferqueue set.						       *
 25080                                  ;									       *
 25081                                  ; subroutines to be called:						       *
 25082                                  ;									       *
 25083                                  ;*******************************************************************************
 25084                                  
 25085                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 25086                                  	; (SYSINIT:0E60h)
 25087                                  dobuff:
 25088                                  	; ds = cs ; 31/03/2019
 25089                                  	; 23/10/2022
 25090                                  	;lds	bx,[cs:DOSINFO]	; ds:bx -> sysinitvar
 25091                                  	; 04/09/2023
 25092 00000E62 A1[9902]                	mov	ax,[buffers] ; 31/03/2019
 25093 00000E65 8B0E[9B02]              	mov	cx,[h_buffers] ; *
 25094 00000E69 C51E[6D02]              	lds	bx,[DOSINFO]
 25095                                  	;mov	ax,[cs:buffers]	; set sysi_buffers
 25096                                  	;mov	[bx+SYSI_BUFFERS],ax ; [bx+3Fh]
 25097 00000E6D 89473F                  	mov	[bx+3Fh],ax
 25098                                  	; 04/09/2023
 25099                                  	;mov	ax,[cs:h_buffers]
 25100                                  	;;mov	[bx+SYSI_BUFFERS+2],ax ; [bx+41h]
 25101                                  	;mov	[bx+41h],ax
 25102                                  	; 04/09/2023
 25103 00000E70 894F41                  	mov	[bx+41h],cx ; *
 25104 00000E73 C55F12                  	lds	bx,[bx+12h]
 25105                                  	;lds	bx,[bx+SYSI_BUF] ; now,ds:bx -> buffinfo
 25106 00000E76 E8F133                  	call	round		; get [memhi]:[memlo]
 25107                                  	;mov	al,devmark_buf	; ='B'
 25108 00000E79 B042                    	mov	al,'B'	
 25109 00000E7B E81506                  	call	setdevmark
 25110                                  
 25111                                  ;allocate buffers
 25112                                  
 25113 00000E7E 1E                      	push	ds			; save buffer info. ptr.
 25114 00000E7F 53                      	push	bx
 25115                                  
 25116 00000E80 E85003                  	call	set_buffer
 25117                                  
 25118 00000E83 5B                      	pop	bx
 25119 00000E84 1F                      	pop	ds
 25120                                  
 25121                                  ;now set the secondary buffer if specified.
 25122                                  
 25123 00000E85 2E833E[9B02]00          	cmp	word [cs:h_buffers],0
 25124 00000E8B 742D                    	je	short xif16
 25125 00000E8D E8DA33                  	call	round
 25126                                  	; 23/10/2022
 25127 00000E90 2E8B0E[6203]            	mov	cx,[cs:memlo]
 25128                                  	;mov	[bx+BUFFINF.Cache_ptr],cx  ; [bx+6]
 25129 00000E95 894F06                  	mov	[bx+6],cx
 25130 00000E98 2E8B0E[6403]            	mov	cx,[cs:memhi]
 25131                                  	;mov	[bx+BUFFINF.Cache_ptr+2],cx ; [bx+8]
 25132 00000E9D 894F08                  	mov	[bx+8],cx
 25133 00000EA0 2E8B0E[9B02]            	mov	cx,[cs:h_buffers]
 25134                                  	;mov	[bx+BUFFINF.Cache_count],cx ; [bx+10]
 25135 00000EA5 894F0A                  	mov	[bx+10],cx
 25136 00000EA8 B80002                  	mov	ax,512			; 512 byte
 25137 00000EAB F7E1                    	mul	cx
 25138 00000EAD 2EA3[6203]              	mov	[cs:memlo],ax
 25139                                  	;or	byte [cs:setdevmarkflag],for_devmark ; 2
 25140 00000EB1 2E800E[B814]02          	or	byte [cs:setdevmarkflag],2
 25141 00000EB7 E8B033                  	call	round
 25142                                  xif16:
 25143                                  
 25144                                  ; ----------------------------------------------------------------------
 25145                                  ; allocate cdss
 25146                                  ; ----------------------------------------------------------------------
 25147                                  
 25148                                  buf1:
 25149 00000EBA E8AD33                  	call	round
 25150                                  
 25151 00000EBD 50                      	push	ax
 25152                                  	; 23/10/2022
 25153                                  	;mov	ax,devmark_cds		;='L'
 25154 00000EBE B84C00                  	mov	ax, 'L'
 25155 00000EC1 E8CF05                  	call	setdevmark
 25156 00000EC4 58                      	pop	ax
 25157                                  
 25158 00000EC5 2EC43E[6D02]            	les	di,[cs:DOSINFO]
 25159                                  	;mov	cl,[es:di+SYSI_NUMIO]
 25160 00000ECA 268A4D20                	mov	cl,[es:di+20h]
 25161 00000ECE 2E3A0E[A202]            	cmp	cl,[cs:NUM_CDS]
 25162 00000ED3 7305                    	jae	short gotncds 		; user setting must be at least numio
 25163 00000ED5 2E8A0E[A202]            	mov	cl,[cs:NUM_CDS]
 25164                                  gotncds:
 25165 00000EDA 30ED                    	xor	ch,ch
 25166                                  	;mov	[es:di+SYSI_NCDS],cl	; [es:di+33]
 25167 00000EDC 26884D21                	mov	[es:di+21h],cl
 25168 00000EE0 2EA1[6403]              	mov	ax,[cs:memhi]
 25169                                  	;mov	[es:di+SYSI_CDS+2],ax
 25170 00000EE4 26894518                	mov	[es:di+18h],ax
 25171 00000EE8 2EA1[6203]              	mov	ax,[cs:memlo]
 25172                                  	;mov	[es:di+SYSI_CDS],ax
 25173 00000EEC 26894516                	mov	[es:di+16h],ax
 25174 00000EF0 88C8                    	mov	al,cl
 25175                                  	;mov	ah,curdirlen ; curdir_list.size
 25176 00000EF2 B458                    	mov	ah,88
 25177 00000EF4 F6E4                    	mul	ah
 25178 00000EF6 E84D02                  	call	ParaRound
 25179 00000EF9 2E0106[6403]            	add	[cs:memhi],ax
 25180                                  
 25181                                  	;or	byte [cs:setdevmarkflag],for_devmark ; 2
 25182 00000EFE 2E800E[B814]02          	or	byte [cs:setdevmarkflag],2
 25183 00000F04 E86333                  	call	round			; check for mem error before initializing
 25184                                  	;lds	si,[es:di+SYSI_DPB] ; [es:di+0]
 25185 00000F07 26C535                  	lds	si,[es:di]
 25186                                  	;les	di,[es:di+SYSI_CDS] ; [es:di+22]
 25187 00000F0A 26C47D16                	les	di,[es:di+16h]
 25188 00000F0E E876FD                  	call	fooset
 25189                                  
 25190                                  ; ----------------------------------------------------------------------
 25191                                  ; allocate space for internal stack
 25192                                  ; ----------------------------------------------------------------------
 25193                                  
 25194 00000F11 0E                      	push	cs
 25195 00000F12 1F                      	pop	ds
 25196                                  
 25197                                  ;	if the user did not entered stacks= command, as a default, do not install
 25198                                  ;	sytem stacks for pc1,pc xt,pc portable cases.
 25199                                  ;	otherwise,install it to the user specified value or to the default
 25200                                  ;	value of 9,128 for other systems.
 25201                                  
 25202 00000F13 833E[9002]FF            	cmp	word [stack_addr],-1 ; has the user entered "stacks=" command?
 25203 00000F18 740E                    	je	short doinstallstack	; then install as specified by the user
 25204 00000F1A 803E[BC02]00            	cmp	byte [sys_scnd_model_byte],0 ; pc1,xt has the secondary model byte = 0
 25205 00000F1F 7507                    	jne	short doinstallstack	; other model should have default stack of 9,128
 25206 00000F21 803E[BB02]FE            	cmp	byte [sys_model_byte],0FEh ; pc1, pc/xt or pc portable ?
 25207 00000F26 736D                    	jae	short skipstack
 25208                                  doinstallstack:
 25209 00000F28 A1[8C02]                	mov	ax,[stack_count]	; stack_count = 0?
 25210 00000F2B 09C0                    	or	ax,ax			; then, stack size must be 0 too.
 25211 00000F2D 7466                    	jz	short skipstack		; don't install stack.
 25212                                  
 25213                                  ;	dynamic relocation of stack code.
 25214                                  
 25215 00000F2F E83833                  	call	round			; [memhi] = seg. for stack code
 25216                                  					; [memlo] = 0
 25217                                  
 25218                                  ; set devmark block into memory for mem command
 25219                                  ; devmark_id = 's' for stack
 25220                                  
 25221                                  	;mov	al,devmark_stk	;='S'
 25222                                  	; 23/10/2022
 25223 00000F32 B053                    	mov	al,'S'
 25224 00000F34 E85C05                  	call	setdevmark
 25225                                  
 25226 00000F37 A1[6403]                	mov	ax,[memhi]
 25227 00000F3A 8EC0                    	mov	es,ax		; es -> seg. the stack code is going to move.
 25228                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 25229                                  	; 11/12/2022
 25230                                  	; ds = cs
 25231                                  	;push	cs
 25232                                  	;pop	ds
 25233 00000F3C 31F6                    	xor	si,si		; !!we know that stack code is at the beginning of sysinit.
 25234 00000F3E 31FF                    	xor	di,di
 25235 00000F40 B9[6902]                	mov	cx,endstackcode
 25236 00000F43 890E[6203]              	mov	[memlo],cx
 25237 00000F47 E82033                  	call	round		; have enough space for relocation?
 25238 00000F4A F3A4                    	rep	movsb
 25239                                  
 25240 00000F4C 1E                      	push	ds		; stick the location of the NextStack entry
 25241                                  	;;mov	ax,Bios_Data	; into the Win386 Instance Data tables
 25242                                  	;mov	ax,KERNEL_SEGMENT ; 70h
 25243                                  	; 21/10/2022
 25244 00000F4D B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 25245 00000F50 8ED8                    	mov	ds,ax
 25246 00000F52 C706[0208][1000]        	mov	word [NextStack],nextentry ; (8C0h for MSDOS 6.21 IO.SYS)
 25247 00000F58 8C06[0408]              	mov	[NextStack+2],es	   ; (8C2h for MSDOS 6.21 IO.SYS)
 25248                                  
 25249 00000F5C 2EA1[6203]              	mov	ax,[cs:memlo]
 25250 00000F60 2EA3[9002]              	mov	[cs:stack_addr],ax ; set for stack area initialization
 25251 00000F64 A3[0808]                	mov	[IT_StackLoc],ax  ; pass it as Instance Data, too
 25252 00000F67 2EA1[6403]              	mov	ax,[cs:memhi]	 ; this will be used by stack_init routine.
 25253 00000F6B 2EA3[9202]              	mov	[cs:stack_addr+2],ax
 25254 00000F6F A3[0A08]                	mov	[IT_StackLoc+2],ax
 25255                                  
 25256                                  ;	space for internal stack area = stack_count(entrysize + stack_size)
 25257                                  
 25258                                  	;mov	ax,entrysize ; mov ax,8
 25259                                  	; 23/10/2022
 25260 00000F72 B80800                  	mov	ax,8
 25261 00000F75 2E0306[8E02]            	add	ax,[cs:stack_size]
 25262 00000F7A 2EF726[8C02]            	mul	word [cs:stack_count]
 25263                                  
 25264 00000F7F A3[0C08]                	mov	[IT_StackSize],ax ; pass through to Instance Tables
 25265                                  
 25266 00000F82 1F                      	pop	ds		; no more need to access Instance Table
 25267                                  
 25268 00000F83 E8C001                  	call	ParaRound	; convert size to paragraphs
 25269                                  	
 25270                                  	; 11/12/2022
 25271                                  	; ds = cs
 25272                                  	;add	[cs:memhi],ax
 25273 00000F86 0106[6403]              	add	[memhi],ax
 25274                                  	;or	byte [cs:setdevmarkflag],for_devmark ; 2
 25275                                  	;or	byte [cs:setdevmarkflag],2
 25276 00000F8A 800E[B814]02            	or	byte [setdevmarkflag],2
 25277                                  	;or	byte [setdevmarkflag],for_devmark ; 2
 25278                                  				; to set the devmark_size for stack by round routine.
 25279 00000F8F E8D832                  	call	round		; check for memory error before
 25280                                  				; continuing
 25281 00000F92 E8E502                  	call	stackinit	; initialize hardware stack. 
 25282                                  				; cs=ds=sysinitseg,es=relocated stack code & data
 25283                                  skipstack:
 25284                                  	; 24/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 25285                                  	; (SYSINIT:0F99h)
 25286                                  
 25287                                  	; 11/12/2022
 25288                                  	; ds = cs
 25289                                  	;push	cs
 25290                                  	;pop	ds
 25291                                  
 25292 00000F95 A0[9F02]                	mov	al,[FILES]
 25293 00000F98 30E4                    	xor	ah,ah		; do not use cbw instruction!!!!!
 25294                                  				;  it does sign extend.
 25295 00000F9A 89C1                    	mov	cx,ax
 25296 00000F9C 31DB                    	xor	bx,bx		;close standard input
 25297 00000F9E B43E                    	mov	ah,3Eh ; CLOSE
 25298 00000FA0 CD21                    	int	21h
 25299 00000FA2 BB0200                  	mov	bx,2
 25300                                  rcclloop:			;close everybody but standard output
 25301 00000FA5 B43E                    	mov	ah,3Eh ; CLOSE	; need output so we can print message
 25302 00000FA7 CD21                    	int	21h		; in case we can't get new one open.
 25303 00000FA9 43                      	inc	bx
 25304 00000FAA E2F9                    	loop	rcclloop
 25305                                  
 25306 00000FAC BA[3E45]                	mov	dx,condev
 25307 00000FAF B002                    	mov	al,2
 25308 00000FB1 B43D                    	mov	ah,3Dh ; OPEN 	;open con for read/write
 25309 00000FB3 F9                      	stc			; set for possible int 24
 25310 00000FB4 CD21                    	int	21h
 25311 00000FB6 7305                    	jnc	short goaux
 25312 00000FB8 E8E534                  	call	badfil
 25313 00000FBB EB13                    	jmp	short goaux2
 25314                                  goaux:	
 25315 00000FBD 50                      	push	ax
 25316 00000FBE BB0100                  	mov	bx,1		;close standard output
 25317 00000FC1 B43E                    	mov	ah,3Eh ; CLOSE
 25318 00000FC3 CD21                    	int	21h
 25319 00000FC5 58                      	pop	ax
 25320                                  
 25321 00000FC6 89C3                    	mov	bx,ax		;new device handle
 25322 00000FC8 B445                    	mov	ah,45h ; XDUP
 25323 00000FCA CD21                    	int	21h		;dup to 1,stdout
 25324 00000FCC B445                    	mov	ah,45h ; XDUP
 25325 00000FCE CD21                    	int	21h		;dup to 2,stderr
 25326                                  goaux2: 
 25327 00000FD0 BA[4245]                	mov	dx,auxdev
 25328 00000FD3 B002                    	mov	al,2		;read/write access
 25329 00000FD5 E8F934                  	call	open_dev
 25330                                  
 25331 00000FD8 BA[4645]                	mov	dx,prndev
 25332 00000FDB B001                    	mov	al,1		;write only
 25333 00000FDD E8F134                  	call	open_dev
 25334                                  
 25335                                  ;global rearm command for shared interrupt devices attached in the system;
 25336                                  ;shared interrupt attachment has some problem when it issues interrupt
 25337                                  ;during a warm reboot. once the interrupt is presented by the attachment,
 25338                                  ;no further interrupts on that level will be presented until a global rearm
 25339                                  ;is issued. by the request of the system architecture group, msbio will
 25340                                  ;issue a global rearm after every device driver is loaded.
 25341                                  ;to issue a global rearm:	;for pc1,xt,palace
 25342                                  ;
 25343                                  ;			  out 02f2h,xx  ; interrupt level 2
 25344                                  ;			  out 02f3h,xx  ; interrupt level 3
 25345                                  ;			  out 02f4h,xx  ; interrupt level 4
 25346                                  ;			  out 02f5h,xx  ; interrupt level 5
 25347                                  ;			  out 02f6h,xx  ; interrupt level 6
 25348                                  ;			  out 02f7h,xx  ; interrupt level 7
 25349                                  ;
 25350                                  ;	for pc at,in addition to the above commands,
 25351                                  ;	need to handle the secondary interrupt handler
 25352                                  ;
 25353                                  ;			  out 06f2h,xx  ; interrupt level 10
 25354                                  ;			  out 06f3h,xx  ; interrupt level 11
 25355                                  ;			  out 06f4h,xx  ; interrupt level 12
 25356                                  ;			  out 06f6h,xx  ; interrupt level 14
 25357                                  ;			  out 06f7h,xx  ; interrupt level 15
 25358                                  ;
 25359                                  ;	for round-up machine
 25360                                  ;
 25361                                  ;			  none.
 25362                                  
 25363                                  ; where xx stands for any value.
 25364                                  ;
 25365                                  ; for your information,after naples level machine,the system service bios
 25366                                  ; call (int 15h),function ah=0c0h returns the system configuration parameters
 25367                                  
 25368                                  	; 24/10/2022
 25369                                  
 25370 00000FE0 50                      	push	ax
 25371 00000FE1 53                      	push	bx
 25372 00000FE2 52                      	push	dx
 25373 00000FE3 06                      	push	es
 25374                                  
 25375 00000FE4 B0FF                    	mov	al,0FFh 		;reset h/w by writing to port
 25376 00000FE6 BAF202                  	mov	dx,2F2h 		;get starting address
 25377 00000FE9 EE                      	out	dx,al			; out 02f2h,0ffh
 25378 00000FEA 42                      	inc	dx
 25379 00000FEB EE                      	out	dx,al			; out 02f3h,0ffh
 25380 00000FEC 42                      	inc	dx
 25381 00000FED EE                      	out	dx,al			; out 02f4h,0ffh
 25382 00000FEE 42                      	inc	dx
 25383 00000FEF EE                      	out	dx,al			; out 02f5h,0ffh
 25384 00000FF0 42                      	inc	dx
 25385 00000FF1 EE                      	out	dx,al			; out 02f6h,0ffh
 25386 00000FF2 42                      	inc	dx
 25387 00000FF3 EE                      	out	dx,al			; out 02f7h,0ffh
 25388                                  
 25389                                  ;sb secondary global rearm
 25390                                  
 25391 00000FF4 B800F0                  	mov	ax,0F000h		;get machine type
 25392 00000FF7 8EC0                    	mov	es,ax
 25393 00000FF9 26803EFEFFFC            	cmp	byte [es:0FFFEh],0FCh ;q:is it a at type machine
 25394 00000FFF 740D                    	je	short startrearm	; *if at no need to check
 25395                                  
 25396 00001001 B4C0                    	mov	ah,0C0h 		;get system configuration
 25397 00001003 CD15                    	int	15h			; *
 25398 00001005 7216                    	jc	short finishrearm	; *jmp if old rom
 25399                                  
 25400                                  ; test feature byte for secondary interrupt controller
 25401                                  
 25402 00001007 26F6470540              	test	byte [es:bx+5],40h
 25403                                  	; 24/10/2022
 25404                                  	;test	byte [es:bx+ROMBIOS_DESC.bios_sd_featurebyte1],ScndIntController
 25405 0000100C 740F                    	je	short finishrearm	;jmp if it is there
 25406                                  
 25407                                  startrearm:
 25408 0000100E B0FF                    	mov	al,0FFh 		;write any pattern to port
 25409 00001010 BAF206                  	mov	dx,6F2h 		;get starting address
 25410 00001013 EE                      	out	dx,al			;out 06f2h,0ffh
 25411 00001014 42                      	inc	dx			;bump address
 25412 00001015 EE                      	out	dx,al			;out 06f3h,0ffh
 25413 00001016 42                      	inc	dx			;bump address
 25414 00001017 EE                      	out	dx,al			;out 06f4h,0ffh
 25415 00001018 42                      	inc	dx			;bump address
 25416 00001019 42                      	inc	dx			;bump address
 25417 0000101A EE                      	out	dx,al			;out 06f6h,0ffh
 25418 0000101B 42                      	inc	dx			;bump address
 25419 0000101C EE                      	out	dx,al			;out 06f7h,0ffh
 25420                                  
 25421                                  finishrearm:
 25422 0000101D 07                      	pop	es
 25423 0000101E 5A                      	pop	dx
 25424 0000101F 5B                      	pop	bx
 25425 00001020 58                      	pop	ax
 25426                                  
 25427                                  ;    global rearm end *******************
 25428                                  
 25429                                  ; ----------------------------------------------------------------------
 25430                                  ; allocate sysinit_base for install= command
 25431                                  ; ----------------------------------------------------------------------
 25432                                  ; sysinit_base allocation.
 25433                                  ;   check if endfile has been called to handle install= command.
 25434                                  
 25435                                  set_sysinit_base:
 25436                                  
 25437                                  ; ----------------------------------------------------------------------
 25438                                  ;sysinit_base will be established in the secure area of
 25439                                  ;lower memory when it handles the first install= command.
 25440                                  ;sysinit_base is the place where the actual exec function will be called and
 25441                                  ;will check sysinit module in high memory if it is damaged by the application
 25442                                  ;program.  if sysinit module has been broken,then "memory error..." message
 25443                                  ;is displayed by sysinit_base.
 25444                                  ; ----------------------------------------------------------------------
 25445                                  
 25446                                  	; 24/10/2022 - Retro DOS v4.0 (MSDOS 5.0 IO.SYS, SYSINIT)
 25447                                  	; (SYSINIT:1028h)
 25448                                  
 25449                                  	; 11/12/2022
 25450                                  	; ds = cs
 25451 00001021 50                      	push	ax			; set devmark for mem command
 25452 00001022 A1[6403]                	mov	ax,[memhi]
 25453 00001025 2B06[6803]              	sub	ax,[area]
 25454 00001029 A3[6003]                	mov	[impossible_owner_size],ax ; remember the size in case.
 25455                                  	;mov	al,devmark_inst ; 'T'
 25456 0000102C B054                    	mov	al,'T'
 25457 0000102E E86204                  	call	setdevmark
 25458 00001031 58                      	pop	ax
 25459                                  
 25460 00001032 8B3E[6403]              	mov	di,[memhi]
 25461 00001036 8EC7                    	mov	es,di
 25462 00001038 893E[D402]              	mov	[sysinit_base_ptr+2],di ; save this entry for the next use.
 25463 0000103C 31FF                    	xor	di,di
 25464 0000103E 893E[D202]              	mov	[sysinit_base_ptr],di	; es:di -> destination.
 25465 00001042 BE[5211]                	mov	si,sysinit_base		; ds:si -> source code to be relocated.
 25466 00001045 B98100                  	mov	cx,end_sysinit_base-sysinit_base ; 129
 25467                                  	; 24/10/2022 
 25468                                  	;mov	cx,128	; 11DCh-115Ch 	; (MSDOS 5.0 IO.SYS, SYSINIT)
 25469 00001048 010E[6203]              	add	[memlo],cx
 25470                                  	;or	byte cs:[setdevmarkflag],for_devmark ; 2
 25471                                  	; 11/12/2022
 25472                                  	; ds = cs
 25473                                  	;or	byte [cs:setdevmarkflag],2
 25474 0000104C 800E[B814]02            	or	byte [setdevmarkflag],2
 25475                                  	;or	byte [setdevmarkflag],for_devmark
 25476 00001051 E81632                  	call	round			; check mem error. also,readjust memhi for the next use.
 25477 00001054 F3A4                    	rep	movsb			; reallocate it.
 25478                                  
 25479 00001056 C706[D602][3911]        	mov	word [sysinit_ptr],sysinitptr ; returning address from
 25480 0000105C 8C0E[D802]              	mov	[sysinit_ptr+2],cs	 ; sysinit_base back to sysinit.
 25481                                  	;or	word [install_flag],has_installed ; set the flag.
 25482                                  	;or	byte [install_flag],has_installed ; 2
 25483                                  	; 11/12/2022
 25484 00001060 800E[CE02]02            	or	byte [install_flag],2
 25485                                  	; 24/10/2022
 25486                                  	;or	word [install_flag],2	
 25487                                  
 25488                                  ; ----------------------------------------------------------------------
 25489                                  ; free the rest of the memory from memhi to confbot. still from confbot to
 25490                                  ; the top of the memory will be allocated for sysinit and config.sys if
 25491                                  ; have_install_cmd.
 25492                                  ; ----------------------------------------------------------------------
 25493                                  
 25494 00001065 E80232                  	call	round
 25495 00001068 8B1E[6403]              	mov	bx,[memhi]
 25496 0000106C A1[6803]                	mov	ax,[area]
 25497 0000106F A3[5E03]                	mov	[old_area],ax		; save [area]
 25498 00001072 8EC0                    	mov	es,ax			;calc what we needed
 25499 00001074 29C3                    	sub	bx,ax
 25500                                  	; 24/10/2022
 25501 00001076 B44A                    	mov	ah,4Ah ; SETBLOCK
 25502 00001078 CD21                    	int	21h			;give the rest back
 25503                                  		; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
 25504                                  		; ES = segment address of block to change
 25505                                  		; BX = new size in paragraphs
 25506 0000107A 06                      	push	es
 25507 0000107B 8CC0                    	mov	ax,es
 25508 0000107D 48                      	dec	ax
 25509 0000107E 8EC0                    	mov	es,ax			;point to arena
 25510                                  	;mov	word [es:ARENA.OWNER],8	;set impossible owner
 25511                                  	;;mov	word [es:ARENA.NAME],4453h	; System Data
 25512                                  	;mov	word [es:ARENA.NAME],'SD'	; System Data
 25513                                  	; 24/10/2022
 25514 00001080 26C70601000800          	mov	word [es:1],8		;set impossible owner
 25515 00001087 26C70608005344          	mov	word [es:8],'SD'	; System Data
 25516 0000108E 07                      	pop	es
 25517                                  
 25518 0000108F BBFFFF                  	mov	bx,0FFFFh
 25519 00001092 B448                    	mov	ah,48h ; ALLOC
 25520 00001094 CD21                    	int	21h
 25521 00001096 B448                    	mov	ah,48h ; ALLOC
 25522 00001098 CD21                    	int	21h			; allocate the rest of the memory
 25523                                  		; DOS - 2+ - ALLOCATE MEMORY
 25524                                  		; BX = number of 16-byte paragraphs desired
 25525 0000109A A3[6403]                	mov	[memhi],ax		; start of the allocated memory
 25526 0000109D C706[6203]0000          	mov	word [memlo],0		;  to be used next.
 25527                                  
 25528                                  ;;;; at this moment,memory from [memhi]:0 to top-of-the memory is
 25529                                  ;;;; allocated.
 25530                                  ;;;; to protect sysinit,confbot module (from confbot (or =alloclim at
 25531                                  ;;;; this time) to the top-of-the memory),here we are going to
 25532                                  ;;;; 1). "setblock" from memhi to confbot.
 25533                                  ;;;; 2). "alloc" from confbot to the top of the memory.
 25534                                  ;;;; 3). "free alloc memory" from memhi to confbot.
 25535                                  
 25536                                  ;memory allocation for sysinit,confbot module.
 25537                                  
 25538 000010A3 8EC0                    	mov	es,ax
 25539                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 25540                                  	; (SYSINIT:11DFh)
 25541 000010A5 8B1E[A302]              	mov	bx,[CONFBOT]
 25542                                  	; 24/10/2022
 25543                                  	;mov	bx,[top_of_cdss] ; mov bx,[confbot]
 25544 000010A9 29C3                    	sub	bx,ax			; confbot - memhi
 25545 000010AB 4B                      	dec	bx			; make a room for the memory block id.
 25546 000010AC 4B                      	dec	bx			; make sure!!!.
 25547 000010AD B44A                    	mov	ah,4Ah ; SETBLOCK
 25548 000010AF CD21                    	int	21h			; this will free (confbot to top of memory)
 25549                                  		; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
 25550                                  		; ES = segment address of block to change
 25551                                  		; BX = new size in paragraphs
 25552 000010B1 BBFFFF                  	mov	bx,0FFFFh
 25553 000010B4 B448                    	mov	ah,48h ; ALLOC
 25554 000010B6 CD21                    	int	21h
 25555 000010B8 B448                    	mov	ah,48h ; ALLOC
 25556 000010BA CD21                    	int	21h			; allocate (confbot to top of memory)
 25557                                  		; DOS - 2+ - ALLOCATE MEMORY
 25558                                  		; BX = number of 16-byte paragraphs desired
 25559 000010BC A3[6803]                	mov	[area],ax		; save allocated memory segment.
 25560                                  					; need this to free this area for command.com.
 25561 000010BF 8E06[6403]              	mov	es,[memhi]
 25562 000010C3 B449                    	mov	ah,49h			; free allocated memory.
 25563 000010C5 CD21                    	int	21h			; free (memhi to confbot(=area))
 25564                                  		; DOS - 2+ - FREE MEMORY
 25565                                  		; ES = segment address of area to be freed
 25566                                  endfile_ret:
 25567 000010C7 C3                      	retn
 25568                                  
 25569                                  ; End of "EndFile" DOS structure configuration.
 25570                                  
 25571                                  ; ----------------------------------------------------------------------
 25572                                  ; 26/03/2019 - Retro DOS v4.0
 25573                                  ; 24/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS, SYSINIT)	
 25574                                  ; ----------------------------------------------------------------------
 25575                                  ; Do_Install_Exec
 25576                                  ;
 25577                                  ; This procedure is used to EXEC a program being loaded via the 
 25578                                  ; "install=" mechanism in config.sys. It does this by setting up
 25579                                  ; the parameters, and then jumping to sysinit_base, which has been
 25580                                  ; setup in low memory. When complete, sysinit_base will jump back
 25581                                  ; up to this procedure (if sysinit remains uncorrupted by the installed
 25582                                  ; program).
 25583                                  
 25584                                  ;SYSINIT:10CFh:
 25585                                  
 25586                                  do_install_exec:			; now,handles install= command.
 25587                                  
 25588 000010C8 56                      	push	si			; save si for config.sys again.
 25589                                  
 25590                                  ; we are going to call load/exec function.
 25591                                  ; set es:bx to the parameter block here;;;;;;;
 25592                                  ; set ds:dx to the asciiz string. remember that we already has 0
 25593                                  ; after the filename. so parameter starts after that. if next
 25594                                  ; character is a line feed (i.e. 10),then assume that the 0
 25595                                  ; we already encountered used to be a carrage return. in this
 25596                                  ; case,let's set the length to 0 which will be followed by
 25597                                  ; carridge return.
 25598                                  
 25599                                  ; es:si -> command line in config.sys. points to the first non blank
 25600                                  ;character after =.
 25601                                  
 25602 000010C9 06                      	push	es
 25603 000010CA 1E                      	push	ds
 25604 000010CB 07                      	pop	es
 25605 000010CC 1F                      	pop	ds			; es->sysinitseg,ds->confbot seg
 25606 000010CD 89F2                    	mov	dx,si			; ds:dx->file name,0 in config.sys image.
 25607                                  
 25608 000010CF 31C9                    	xor	cx,cx
 25609 000010D1 FC                      	cld
 25610 000010D2 2EC606[F102]20          	mov	byte [cs:ldexec_start],' ' ; clear out the parm area
 25611 000010D8 BF[F202]                	mov	di,ldexec_parm
 25612                                  installfilename:			; skip the file name
 25613 000010DB AC                      	lodsb				; al = ds:si; si++
 25614                                  	; 05/09/2023
 25615 000010DC 08C0                    	or	al,al
 25616                                  	;cmp	al,0
 25617 000010DE 7402                    	je	short got_installparm
 25618 000010E0 EBF9                    	jmp	short installfilename
 25619                                  got_installparm:			; copy the parameters to ldexec_parm
 25620 000010E2 AC                      	lodsb
 25621 000010E3 268805                  	mov	[es:di],al
 25622 000010E6 3C0A                    	cmp	al,lf	; cmp al,0Ah	; line feed?
 25623 000010E8 7405                    	je	short done_installparm
 25624 000010EA FEC1                    	inc	cl			; # of char. in the parm.
 25625 000010EC 47                      	inc	di
 25626 000010ED EBF3                    	jmp	short got_installparm
 25627                                  done_installparm:
 25628 000010EF 2E880E[F002]            	mov	byte [cs:ldexec_line],cl ; length of the parm.
 25629                                  	; 05/09/2023
 25630 000010F4 08C9                    	or	cl,cl
 25631                                  	;cmp	cl,0			; if no parm,then
 25632 000010F6 7506                    	jne	short install_seg_set 	; let the parm area
 25633 000010F8 2EC606[F102]0D          	mov	byte [cs:ldexec_start],cr ; 0Dh 
 25634                                  					; starts with cr.
 25635                                  install_seg_set:
 25636                                  	; 05/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 25637 000010FE 31DB                    	xor	bx, bx
 25638                                  	;mov	word [cs:0],0		; make a null environment segment
 25639 00001100 2E891F                  	mov	[cs:bx], bx ; 05/09/2023
 25640 00001103 8CC8                    	mov	ax,cs			; by overlap jmp instruction of sysinitseg.
 25641                                  
 25642                                  ;---------------------------------------------------M067----------------
 25643                                  ;
 25644                                  ; 	the environment pointer is made 0. so the current environment ptr.
 25645                                  ; 	will be the same as pdb_environ which after dosinit is 0.
 25646                                  ;
 25647                                  ; 	mov	cs:[instexe.exec0_environ],0 ; set the environment seg.
 25648                                  ;
 25649                                  ; 	instexe.exec0_environ need not be initialized to 0 above. It was
 25650                                  ; 	done as a fix for bug #529. The actual bug was in NLSFUNC and
 25651                                  ; 	was fixed. 
 25652                                  ;
 25653                                  ; ----------------------------------------------------------------------
 25654                                  
 25655                                  ;;ifdef MULTI_CONFIG
 25656                                  
 25657                                  ; If there's any environment data in "config_wrkseg", pass to app
 25658                                  
 25659                                  ; 30/12/2022 - Retro DOS v4.0 (Modified MSDOS 6.21 IO.SYS SYSINIT)
 25660                                  ; 24/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS SYSINIT)
 25661                                  ;%if 0
 25662 00001105 89C1                    	mov	cx,ax ; *
 25663                                  	; 05/09/2023
 25664 00001107 2E391E[AF14]            	cmp	[cs:config_envlen],bx ; 0
 25665                                  	;cmp	word [cs:config_envlen],0
 25666 0000110C 7405                    	je	short no_envdata2
 25667 0000110E 2E8B0E[B114]            	mov	cx,[cs:config_wrkseg] ; *
 25668                                  no_envdata2:
 25669                                  ;;endif  ;MULTI_CONFIG
 25670                                  
 25671                                  ;%endif	; 24/10/2022
 25672                                  
 25673                                  	;mov	[cs:instexe.exec0_environ],cx ; set the environment seg.
 25674                                  	; 05/09/2023 (BugFix)
 25675                                  	; 24/10/2022
 25676 00001113 2E890E[4203]            	mov	[cs:iexec.environ],cx ; *
 25677                                  	; 02/11/2022
 25678                                  	;mov	[cs:iexec.environ],ax	; 05/09/2023
 25679                                  
 25680                                  	;mov	[cs:instexe.exec0_com_line+2],ax ; set the seg.
 25681 00001118 2EA3[4603]              	mov	[cs:iexec.ldexec_line+2],ax
 25682                                  	;mov	[cs:instexe.exec0_5c_fcb+2],ax
 25683 0000111C 2EA3[4A03]              	mov	[cs:iexec.ldexec_5c_fcb+2],ax
 25684                                  	;mov	[cs:instexe.exec0_6c_fcb+2],ax
 25685 00001120 2EA3[4E03]              	mov	[cs:iexec.ldexec_6c_fcb+2],ax
 25686 00001124 E86000                  	call	sum_up
 25687 00001127 26A3[DA02]              	mov	[es:checksum],ax	; save the value of the sum
 25688 0000112B 31C0                    	xor	ax,ax
 25689 0000112D B44B                    	mov	ah,4Bh ; EXEC		; load/exec
 25690 0000112F BB[4203]                	mov	bx,instexe		; es:bx -> parm block.
 25691 00001132 06                      	push	es			; save es,ds for load/exec
 25692 00001133 1E                      	push	ds			; these registers will be restored in sysinit_base.
 25693 00001134 2EFF2E[D202]            	jmp	far [cs:sysinit_base_ptr] ; jmp to sysinit_base to execute
 25694                                  					; load/exec function and check sum.
 25695                                  
 25696                                  ;----------------------------------------
 25697                                  
 25698                                  ;j.k. this is the returning address from sysinit_base.
 25699                                  
 25700                                  	; 24/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS SYSINIT)
 25701                                  
 25702                                  sysinitptr:				; returning far address from sysinit_base
 25703 00001139 5E                      	pop	si			; restore si for config.sys file.
 25704 0000113A 06                      	push	es
 25705 0000113B 1E                      	push	ds
 25706 0000113C 07                      	pop	es
 25707 0000113D 1F                      	pop	ds			; now ds - sysinitseg, es - confbot
 25708 0000113E 7305                            jnc     short install_exit_ret
 25709                                  
 25710 00001140 56                      	push	si			; error in loading the file for install=.
 25711 00001141 E86033                  	call	badload 		; es:si-> path,filename,0.
 25712 00001144 5E                      	pop	si
 25713                                  
 25714                                  	; 24/10/2022
 25715                                  	;jmp	short sysinitptr_retn ; (MSDOS 5.0 IO.SYS, SYSINIT:1140h)
 25716                                  	; 11/12/2022
 25717                                  	; ds = cs
 25718                                  
 25719                                  	; 30/12/2022 - Retro DOS v4.2
 25720                                  	; (MSDOS 6.21 IO.SYS, SYSINIT:1283h)
 25721                                  
 25722                                  install_exit_ret:
 25723 00001145 C3                      	retn
 25724                                  
 25725                                  ; 30/12/2022 - Retro DOS v4.2
 25726                                  %if 0
 25727                                  install_exit_ret:
 25728                                  	;retn		; retn (MSDOS 6.21 IO.SYS, SYSINIT:1283h) ; 18/12/2022
 25729                                  
 25730                                  	; 24/10/2022 (MSDOS 5.0 IO.SYS SYSINIT)
 25731                                  ;SYSINIT:1142h:
 25732                                  	mov     ah,4Dh
 25733                                  	int     21h             ; DOS - 2+ - GET EXIT CODE OF SUBPROGRAM (WAIT)
 25734                                  	cmp     ah,3
 25735                                  	jz      short sysinitptr_retn
 25736                                  	call    error_line
 25737                                  	stc
 25738                                  sysinitptr_retn:	; (SYSINIT:114Fh)
 25739                                  	retn		
 25740                                  
 25741                                  %endif ; 24/10/2022
 25742                                  
 25743                                  ; ----------------------------------------------------------------------
 25744                                  
 25745                                  ;**	ParaRound - Round Up length to paragraph multiple
 25746                                  ;
 25747                                  ;	ParaRound rounds a byte count up to a multiple of 16, then divides
 25748                                  ;	by 16 yielding a "length in paragraphs" value.
 25749                                  ;
 25750                                  ;	ENTRY	(ax) = byte length
 25751                                  ;	EXIT	(ax) = rounded up length in paragraphs
 25752                                  ;	USES	ax, flags
 25753                                  
 25754                                  ParaRound:
 25755 00001146 83C00F                  	add	ax,15
 25756 00001149 D1D8                    	rcr	ax,1
 25757 0000114B D1E8                    	shr	ax,1
 25758 0000114D D1E8                    	shr	ax,1
 25759 0000114F D1E8                    	shr	ax,1
 25760 00001151 C3                      	retn
 25761                                  
 25762                                  ; ----------------------------------------------------------------------
 25763                                  ; sysinit_base module.
 25764                                  ;
 25765                                  ; This module is relocated by the routine EndFile to a location in low
 25766                                  ; memory. It is then called by SYSINIT to perform the EXEC of programs
 25767                                  ; that are being loaded by the "install=" command. After the EXEC call
 25768                                  ; completes, this module performs a checksum on the SYSINIT code (at the
 25769                                  ; top of memory) to be sure that the EXECed program did not damage it.
 25770                                  ; If it did, then this module will print an error message and stop the
 25771                                  ; system. Otherwise, it returns control to SYSINIT.
 25772                                  ;
 25773                                  ;in: after relocation,
 25774                                  ;    ax = 4b00h - load and execute the program dos function.
 25775                                  ;    ds = confbot. segment of config.sys file image
 25776                                  ;    es = sysinitseg. segment of sysinit module itself.
 25777                                  ;    ds:dx = pointer to asciiz string of the path,filename to be executed.
 25778                                  ;    es:bx = pointer to a parameter block for load.
 25779                                  ;    SI_end (byte) - offset value of end of sysinit module label
 25780                                  ;    bigsize (word) - # of word from confbot to SI_end.
 25781                                  ;    chksum (word) - sum of every byte from confbot to SI_end in a
 25782                                  ;			word boundary moduler form.
 25783                                  ;    sysinit_ptr (dword ptr) - return address to sysinit module.
 25784                                  ;
 25785                                  ;note: sysinit should save necessary registers and when the control is back
 25786                                  
 25787                                  	; 24/10/2022
 25788                                  	; (SYSINIT:115Ch for MSDOS 5.0 SYSINIT)
 25789                                  sysinit_base:				
 25790 00001152 2E8C166200              	mov	[cs:sysinit_base_ss],ss	; save stack
 25791 00001157 2E89266400              	mov	[cs:sysinit_base_sp],sp	
 25792 0000115C CD21                    	int	21h			; load/exec dos call.
 25793 0000115E 2E8E166200              	mov	ss,[cs:sysinit_base_ss]	; restore stack
 25794 00001163 2E8B266400              	mov	sp,[cs:sysinit_base_sp]
 25795 00001168 1F                      	pop	ds			; restore confbot seg
 25796 00001169 07                      	pop	es			; restore sysinitseg
 25797 0000116A 7216                    	jc	short sysinit_base_end	; load/exec function failed.
 25798                                  					; at this time,i don't have to worry about
 25799                                  					; that sysinit module has been broken or not.
 25800 0000116C E81800                  	call	sum_up			; otherwise,check if it is good.
 25801 0000116F 263906[DA02]            	cmp	[es:checksum],ax
 25802 00001174 740C                    	je	short sysinit_base_end
 25803                                  
 25804                                  ;	memory broken. show "memory allocation error" message and stall.
 25805                                  
 25806 00001176 B409                    	mov	ah,9
 25807 00001178 0E                      	push	cs
 25808 00001179 1F                      	pop	ds
 25809                                  	; 30/12/2022
 25810                                  	; (MSDOS 6.21 IO.SYS, SYSINIT:12B8h)
 25811                                  	;mov	dx, 102
 25812 0000117A BA6600                  	mov	dx,mem_alloc_err_msgx-sysinit_base ; 65h (for MSDOS 5.0 SYSINIT)
 25813                                  					; 66h (for MSDOS 6.21 SYSINIT)
 25814 0000117D CD21                    	int	21h
 25815                                  		; DOS - PRINT STRING
 25816                                  		; DS:DX -> string terminated by "$"
 25817                                  
 25818                                  	; 30/12/2022 - Retro DOS v4.2
 25819                                  stall:
 25820                                  	; 24/10/2022
 25821                                  _stall: 
 25822                                  	; 11/12/2022
 25823 0000117F F4                      	hlt 
 25824                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 25825                                  	;hlt				;use HLT to minimize energy consumption
 25826 00001180 EBFD                            jmp	short _stall
 25827                                  
 25828                                  sysinit_base_end: 
 25829 00001182 26FF2E[D602]            	jmp	far [es:sysinit_ptr]	;return back to sysinit module
 25830                                  
 25831                                  ;-------------------------------------
 25832                                  
 25833                                  sum_up:
 25834                                  
 25835                                  ;in:   es - sysinitseg.
 25836                                  ;out:  ax - result
 25837                                  ;
 25838                                  ;remark: since this routine will only check starting from "locstack" to the end of
 25839                                  ;	 sysinit segment,the data area, and the current stack area are not
 25840                                  ;	 coverd. in this sense,this check sum routine only gives a minimal
 25841                                  ;	 gaurantee to be safe.
 25842                                  ;
 25843                                  ;first sum up confbot seg.
 25844                                  
 25845 00001187 1E                      	push	ds
 25846                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 25847                                  	; (SYSINIT:12C6h)
 25848 00001188 26A1[A302]              	mov	ax,[es:CONFBOT]
 25849                                  	; 24/10/2022
 25850                                  	;mov	ax,[es:top_of_cdss]
 25851 0000118C 8ED8                    	mov	ds,ax
 25852 0000118E 31F6                    	xor	si,si
 25853 00001190 31C0                    	xor	ax,ax
 25854 00001192 268B0E[D002]            	mov	cx,[es:config_size]	; if config_size has been broken,then this
 25855                                  					; whole test better fail.
 25856 00001197 D1E9                    	shr	cx,1			; make it a word count
 25857 00001199 7406                    	jz	short sum_sys_code	; when config.sys file not exist.
 25858                                  sum1:
 25859 0000119B 0304                    	add	ax,[si]
 25860 0000119D 46                      	inc	si
 25861 0000119E 46                      	inc	si
 25862 0000119F E2FA                    	loop	sum1
 25863                                  ;now,sum up sysinit module.
 25864                                  sum_sys_code:
 25865                                  	; 24/10/2022
 25866 000011A1 BEA011                  	mov	si,locstack ; 5A6h (MSDOS 5.0 IO.SYS, SYSINIT)
 25867                                  			    ; 532h (MSDOS 6.21 IO.SYS, SYSINIT)
 25868                                  				        ; starting after the stack.  M069
 25869                                  					;  this does not cover the possible stack code!!!
 25870                                  	;;mov	cx,22688  ; for MSDOS 6.21 IO.SYS
 25871                                  	; 02/11/2022
 25872                                  	;mov	cx,3D20h  ; (15648) for MSDOS 5.0 IO.SYS (SYSINIT)	
 25873                                  	; 30/12/2022  
 25874 000011A4 B9[604D]                	mov	cx,SI_end ; (22688) 	; SI_end is the label at the end of sysinit
 25875 000011A7 29F1                    	sub	cx,si			;  from after_checksum to SI_end
 25876 000011A9 D1E9                    	shr	cx,1
 25877                                  sum2:
 25878 000011AB 260304                  	add	ax,[es:si]
 25879 000011AE 46                      	inc	si
 25880 000011AF 46                      	inc	si
 25881 000011B0 E2F9                    	loop	sum2
 25882 000011B2 1F                      	pop	ds
 25883 000011B3 C3                      	retn
 25884                                  
 25885                                  ; 24/10/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS, SYSINIT)
 25886                                  ; 30/12/2022 - Retro DOS 4.2 (Modified MSDOS 6.21 IO.SYS, SYSINIT)
 25887                                  ; (SYSINIT:12F2h)
 25888                                  
 25889                                  sysinit_base_ss equ $-sysinit_base  ; = 61 (MSDOS 5.0 IO.SYS, SYSINIT:115Ch)
 25890                                  ;SYSINIT:11BDh:			    ; = 62 (MSDOS 6.21 IO.SYS, SYSINIT:1290h) 	
 25891 000011B4 0000                    	dw	0
 25892                                  sysinit_base_sp equ $-sysinit_base  ; = 63 (MSDOS 5.0 IO.SYS, SYSINIT:1161h)
 25893                                  ;SYSINIT:11BFh:			    ; = 64 (MSDOS 6.21 IO.SYS, SYSINIT:1292h)
 25894 000011B6 0000                    	dw	0	
 25895                                  
 25896                                  mem_alloc_err_msgx:
 25897                                  
 25898                                         ;include msbio.cl4		; memory allocation error message
 25899                                  
 25900                                  ;SYSINIT:12F6:  ; MSDOS 6.21 IO.SYS SYSINIT:12F6h
 25901 000011B8 0D0A                    	db	0Dh,0Ah
 25902 000011BA 4D656D6F727920616C-     	db 	'Memory allocation error $'
 25902 000011C3 6C6F636174696F6E20-
 25902 000011CC 6572726F722024     
 25903                                  
 25904                                  end_sysinit_base: ; label byte
 25905                                  	; 24/10/2022
 25906                                  	; (SYSINIT:11DCh for MSDOS 5.0 SYSINIT)
 25907                                  
 25908                                  ; ----------------------------------------------------------------------
 25909                                  ; Set_Buffer
 25910                                  ;
 25911                                  ;function: set buffers in the real memory.				  
 25912                                  ;	   lastly set the memhi,memlo for the next available free address.
 25913                                  ;
 25914                                  ;input:    ds:bx -> buffinfo.
 25915                                  ;	   [memhi]:[memlo = 0] = available space for the hash bucket.	  
 25916                                  ;	   singlebuffersize = buffer header size + sector size		  
 25917                                  ;
 25918                                  ;output:   buffers Queue established.	       				   
 25919                                  ;	   [memhi]:[memlo] = address of the next available free space.	   
 25920                                  ; ----------------------------------------------------------------------
 25921                                  
 25922                                  	; 25/10/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS, SYSINIT)
 25923                                  	; (SYSINIT:11DCh)
 25924                                  
 25925                                  set_buffer:
 25926 000011D3 30D2                    	xor	dl,dl				; assume buffers not in HMA
 25927 000011D5 E85500                  	call	GetBufferAddr
 25928 000011D8 7402                    	jz	short set_buff_1
 25929                                  	;mov	dl,1				; buffers in HMA
 25930                                  	; 17/09/2023
 25931 000011DA FEC2                    	inc	dl ; mov dl,1
 25932                                  set_buff_1:
 25933                                  	; 25/10/2022
 25934                                  	;mov	[bx+BUFFINF.Buff_Queue],di	; head of Buff Q
 25935 000011DC 893F                    	mov	[bx],di
 25936                                  	;mov	[bx+BUFFINF.Buff_Queue+2],es
 25937 000011DE 8C4702                  	mov	[bx+2],es
 25938                                  	;mov	word [bx+BUFFINF.Dirty_Buff_Count],0 ;set dirty_count to 0.
 25939 000011E1 C747040000              	mov	word [bx+4],0
 25940                                  
 25941 000011E6 89F8                    	mov	ax,di
 25942 000011E8 2E8B0E[9902]            	mov	cx,[cs:buffers]
 25943 000011ED 57                      	push	di				; remember first buffer
 25944                                  
 25945                                  ;	for each buffer
 25946                                  
 25947                                  nxt_buff:
 25948 000011EE E86100                  	call	set_buffer_info 		; set buf_link,buf_id...
 25949 000011F1 89C7                    	mov	di,ax
 25950 000011F3 E2F9                    	loop	nxt_buff
 25951                                  
 25952 000011F5 2E2B3E[9D02]            	sub	di,[cs:singlebuffersize]	; point to last buffer
 25953                                  
 25954 000011FA 59                      	pop	cx				; get first buffer
 25955                                  	;mov	[es:di+buffinfo.buf_next],cx	; last->next = first
 25956 000011FB 26890D                  	mov	[es:di],cx
 25957 000011FE 87CF                    	xchg	cx,di
 25958                                  	;mov	[es:di+buffinfo.buf_prev],cx	; first->prev = last
 25959                                  	; 25/10/2022
 25960 00001200 26894D02                	mov	[es:di+2],cx
 25961                                  
 25962 00001204 08D2                    	or	dl,dl				; In HMA ?
 25963 00001206 7417                    	jz	short set_buff_2		; no
 25964                                  	;mov	byte [bx+BUFFINF.Buff_In_HMA],1
 25965 00001208 C6470C01                	mov	byte [bx+12],1
 25966 0000120C 2EA1[6403]              	mov	ax,[cs:memhi]			; seg of scratch buff
 25967                                  	;mov	word [bx+BUFFINF.Lo_Mem_Buff],0	; offset of scratch buff is 0
 25968 00001210 C7470D0000              	mov	word [bx+13],0
 25969                                  	;mov	[bx+BUFFINF.Lo_Mem_Buff+2],ax
 25970 00001215 89470F                  	mov	word [bx+15],ax
 25971 00001218 2EA1[9D02]              	mov	ax,[cs:singlebuffersize]	; size of scratch buff
 25972                                  	;sub	ax,bufinsiz ; 20		; buffer head not required
 25973                                  	;; 05/09/2023
 25974                                  	;;sub	ax,24 ; bufinsiz		; (bufinsiz is 24 in PCDOS 7.1)
 25975 0000121C 83E814                  	sub	ax,20
 25976                                  set_buff_2:
 25977 0000121F 2E0106[6203]            	add	[cs:memlo],ax
 25978                                  	;or	byte [cs:setdevmarkflag],for_devmark ; 2
 25979 00001224 2E800E[B814]02          	or	byte [cs:setdevmarkflag],2
 25980                                  	;call	round
 25981                                  	;retn
 25982                                  	; 12/12/2022
 25983 0000122A E93D30                  	jmp	round
 25984                                  
 25985                                  ; ----------------------------------------------------------------------
 25986                                  ; procedure : GetBufferAddr
 25987                                  ;
 25988                                  ;	      Gets the buffer address either in HMA or in Lo Mem
 25989                                  ;
 25990                                  ; returns in es:di the buffer adress
 25991                                  ; returns NZ if allocated in HMA
 25992                                  ; ----------------------------------------------------------------------
 25993                                  
 25994                                  	; 25/10/2022 
 25995                                  GetBufferAddr:
 25996 0000122D 53                      	push	bx
 25997 0000122E 52                      	push	dx
 25998 0000122F 2EA1[9D02]              	mov	ax, [cs:singlebuffersize]
 25999 00001233 2EF726[9902]            	mul	word [cs:buffers]
 26000                                  	;add	ax,0Fh
 26001 00001238 83C00F                  	add	ax,15 
 26002                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 26003                                  	;and	ax,~15	; 0FFF0h	; para round
 26004                                  	; 12/12/2022
 26005 0000123B 24F0                    	and	al,~15	; 0F0h
 26006 0000123D 89C3                    	mov	bx,ax
 26007 0000123F B8024A                  	mov	ax,4A02h
 26008                                  	;mov	ax,((multMULT<<8)+multMULTALLOCHMA)
 26009 00001242 CD2F                    	int	2Fh
 26010 00001244 83FFFF                  	cmp	di,0FFFFh
 26011 00001247 7506                    	jne	short got_hma
 26012                                  
 26013                                  	;mov	di,0			; dont xor di,di Z flag needed
 26014                                  	; 05/09/2023
 26015                                  	; zf=1
 26016 00001249 47                      	inc	di ; 0FFFFh -> 0
 26017                                  	; zf=1
 26018                                  	
 26019                                  	;zf=1
 26020                                  	;xor	di,di	; 25/10/2022
 26021                                  	;zf=1
 26022 0000124A 2E8E06[6403]            	mov	es,[cs:memhi]
 26023                                  got_hma:
 26024 0000124F 5A                      	pop	dx
 26025 00001250 5B                      	pop	bx
 26026 00001251 C3                      	retn
 26027                                  
 26028                                  ; ----------------------------------------------------------------------
 26029                                  
 26030                                  set_buffer_info:
 26031                                  
 26032                                  ;function: set buf_link,buf_id,buf_sector
 26033                                  ;
 26034                                  ;in: es:di -> buffer header to be set.
 26035                                  ;    ax = di
 26036                                  ;
 26037                                  ;out:
 26038                                  ;    above entries set.
 26039                                  
 26040                                  	; 25/10/2022 
 26041 00001252 2EFF36[BD02]            	push	word [cs:buf_prev_off]
 26042                                  	;pop	word [es:di+buffinfo.buf_prev]
 26043 00001257 268F4502                	pop	word [es:di+2]
 26044 0000125B 2EA3[BD02]              	mov	[cs:buf_prev_off],ax
 26045 0000125F 2E0306[9D02]            	add	ax,[cs:singlebuffersize]	; adjust ax
 26046                                  	;mov	[es:di+buffinfo.buf_next],ax
 26047 00001264 268905                  	mov	[es:di],ax
 26048                                  	;mov	word [es:di+buffinfo.buf_ID],00FFh  ; new buffer free
 26049 00001267 26C74504FF00            	mov	word [es:di+4],00FFh
 26050                                  	;mov	word [es:di+buffinfo.buf_sector],0   ; to compensate the masm 3 bug
 26051 0000126D 26C745060000            	mov	word [es:di+6],0
 26052                                  	;mov	word [es:di+buffinfo.buf_sector+2],0 ; to compensate the masm 3 bug
 26053 00001273 26C745080000            	mov	word [es:di+8],0
 26054 00001279 C3                      	retn
 26055                                  
 26056                                  ; ======================================================================
 26057                                  ; MSSTACK initialization routine - MSDOS 6.0 - SYSDINIT1.ASM - 1991
 26058                                  ; ----------------------------------------------------------------------
 26059                                  ; 27/03/2019 - Retro DOS v4.0
 26060                                  
 26061                                  ; ----------------------------------------------------------------------
 26062                                  ; ibmstack initialization routine.
 26063                                  ;
 26064                                  ;	to follow the standard interrupt sharing scheme, msstack.asm
 26065                                  ;	has been modified. this initialization routine also has to
 26066                                  ;	be modified because for the interrupt level 7 and 15, firstflag
 26067                                  ;	should be set to signal that this interrupt handler is the
 26068                                  ;	first handler hooked to this interrupt vector.
 26069                                  ;	we determine this by looking at the instruction pointed by
 26070                                  ;	this vector. if it is iret, then this handler should be the
 26071                                  ;	first one. in our case, only the interrupt vector 77h is the
 26072                                  ;	interrupt level 15. (we don't hook interrupt level 7.)
 26073                                  ;
 26074                                  ;	the followings are mainly due to m.r.t; ptm fix of p886 12/3/86
 26075                                  ;	some design changes are needed to the above interrupt sharing
 26076                                  ;	method. the above sharing scheme assumes that 1). interrupt
 26077                                  ;	sharing is never done on levels that have bios support. 2). "phantom"
 26078                                  ;	interrupts would only be generated on levels 7 and 15.
 26079                                  ;	these assumptions are not true any more. we have to use the firstflag
 26080                                  ;	for every level of interrupt. we will set the firstflag on the following
 26081                                  ;	conditions:
 26082                                  ;
 26083                                  ;	 a.	 if the cs portion of the vector is 0000, then "first"
 26084                                  ;	 b. else if cs:ip points to valid shared header, then not "first"
 26085                                  ;	 c. else if cs:ip points to an iret, then "first"
 26086                                  ;	 d. else if cs:ip points to dummy, then "first"
 26087                                  ;
 26088                                  ;	where dummy is - the cs portion must be f000, and the ip portion must
 26089                                  ;	be equal to the value at f000:ff01. this location is the initial value
 26090                                  ;	from vector_table for interrupt 7, one of the preserved addresses in all
 26091                                  ;	the bioses for all of the machines.
 26092                                  ;
 26093                                  ;	system design group requests bios to handle the phantom interrupts.
 26094                                  ;
 26095                                  ;	the "phantom" interrupt is an illegal interrupt such as an interrupt
 26096                                  ;	produced by the bogus adapter card even without interrupt request is
 26097                                  ;	set.  more specifically, 1). the 8259 has a feature when running in
 26098                                  ;	edge triggered mode to latch a pulse and present the interrupt when
 26099                                  ;	the processor indicates interrupt acknowledge (inta). the interrupt
 26100                                  ;	pulse was exist at the time of inta to get a "phantom" interrupt.
 26101                                  ;	2). or, this is caused by adapter cards placing a glitch on the
 26102                                  ;	interrupt line.
 26103                                  ;
 26104                                  ;	to handle those "phantom" interrupts, the main stack code will check
 26105                                  ;	the own firstflag, and if it is not "first" (which means the forward
 26106                                  ;	pointer points to the legal shared interrupt handler), then pass the
 26107                                  ;	control. if it is the first, then the following action should be
 26108                                  ;	taken. we don't have to implement stack logic in this case.
 26109                                  ;
 26110                                  ;	to implement this logic, we rather choose a simple method.
 26111                                  ;	if ont of the above "firstflag" conditions is met, we are not
 26112                                  ;	going to hook this interrupt vector. the reason is if the original
 26113                                  ;	vector points to "iret" and do nothing, we don't need
 26114                                  ;	to implement the stack logic for it. this will simplify implementation
 26115                                  ;	while maintaining compatibility with the old version of dos.
 26116                                  ;	this implies that in the main stack code, there might be a stack code
 26117                                  ;	that will never be used, a dead code.
 26118                                  ;
 26119                                  ;in - cs, ds -> sysinitseg, es -> relocated stack code & data.
 26120                                  
 26121                                  	; 25/10/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS, SYSINIT)
 26122                                  	; (SYSINIT:1287h)
 26123                                  
 26124                                  	; 14/12/2022
 26125                                  stackinit:
 26126 0000127A 50                      	push	ax
 26127 0000127B 1E                      	push	ds
 26128 0000127C 06                      	push	es
 26129 0000127D 53                      	push	bx
 26130 0000127E 51                      	push	cx
 26131 0000127F 52                      	push	dx
 26132 00001280 57                      	push	di
 26133 00001281 56                      	push	si
 26134 00001282 55                      	push	bp
 26135                                  
 26136                                  ;currently es -> stack code area
 26137                                  
 26138                                  	; 12/12/2022
 26139                                  	; ds = cs
 26140 00001283 A1[8C02]                	mov	ax,[stack_count]
 26141 00001286 89C1                    	mov	cx,ax  ; *!*!*  
 26142                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 26143                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:1290h)
 26144                                  	;mov	ax,[cs:stack_count] ; !!	;defined in cs
 26145 00001288 26A3[0200]              	mov	[es:stackcount],ax		;defined in stack code area
 26146                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:1298h)
 26147 0000128C A1[8E02]                	mov	ax,[stack_size]	 ; !!		;in cs
 26148 0000128F 26A3[0600]              	mov	[es:stacksize],ax
 26149                                  	; 12/12/2022
 26150 00001293 A1[9002]                	mov	ax,[stack_addr]			; offset
 26151                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 26152                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:129Fh)
 26153                                  	;mov	ax,[cs:stack_addr]  ; !!
 26154 00001296 26A3[0800]              	mov	[es:stacks],ax
 26155                                  	; 12/12/2022
 26156 0000129A 89C5                    	mov	bp,ax ; *!*
 26157 0000129C A1[9202]                	mov	ax,[stack_addr+2]
 26158                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 26159                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:129Fh)
 26160                                  	;mov	ax,[cs:stack_addr+2] ; !!	; segment
 26161 0000129F 26A3[0A00]              	mov	[es:stacks+2],ax
 26162                                  
 26163                                  ; initialize the data fields with the parameters
 26164                                  
 26165                                  ; "firstentry" will always be at stacks
 26166                                  
 26167                                  	;mov	bp,[es:stacks]			; get offset of stack
 26168                                  	; 12/12/2022
 26169                                  	; bp = [es:stacks] ; *!*
 26170 000012A3 26892E[0C00]            	mov	[es:firstentry],bp
 26171                                  
 26172                                  ; the stacks will always immediately follow the table entries
 26173                                  
 26174 000012A8 B80800                  	mov	ax,entrysize ; 8
 26175                                  	;mov	cx,[es:stackcount]
 26176                                  	; 12/12/2022
 26177                                  	; cx = [es:stackcount] ; *!*!*
 26178 000012AB F7E1                    	mul	cx
 26179 000012AD 01E8                    	add	ax,bp
 26180 000012AF 26A3[0400]              	mov	[es:stackat],ax
 26181 000012B3 89C3                    	mov	bx,ax
 26182 000012B5 83EB02                  	sub	bx,2
 26183                                  
 26184                                  ; zero the entire stack area to start with
 26185                                  
 26186 000012B8 268B3E[0400]            	mov	di,[es:stackat]
 26187 000012BD 26A1[0600]              	mov	ax,[es:stacksize]
 26188 000012C1 F7E1                    	mul	cx
 26189 000012C3 89C1                    	mov	cx,ax
 26190 000012C5 31C0                    	xor	ax,ax
 26191 000012C7 06                      	push	es
 26192 000012C8 1F                      	pop	ds				;ds = relocated stack code seg.
 26193                                  
 26194                                  ;now, ds -> stack code area
 26195                                  
 26196 000012C9 8E06[0A00]              	mov	es,[stacks+2]			; get segment of stack area.
 26197 000012CD FC                      	cld
 26198 000012CE F3AA                    	rep	stosb
 26199                                  
 26200 000012D0 8B0E[0200]              	mov	cx,[stackcount]
 26201                                  
 26202                                  ; loop for "count" times, building a table entry
 26203                                  ;  cs = sysinitseg, ds = relocated stack code seg, es = segment of stack space
 26204                                  ;  cx = number of entries
 26205                                  ;  es:bp => base of stacks - 2
 26206                                  ;  es:bx => first table entry
 26207                                  
 26208                                  buildloop:
 26209                                  	; 11/12/2022
 26210                                  	;mov	byte [es:bp+allocbyte],free	; mov [es:bp+0],0
 26211                                  	; 25/10/2022
 26212                                  	;mov	byte [es:bp],free
 26213                                  	; 06/07/2023
 26214 000012D4 26884600                	mov	[es:bp],al ; 0 ; free
 26215 000012D8 26884601                	mov	[es:bp+intlevel],al	; ax = 0
 26216                                  	;mov	[es:bp+1],al
 26217 000012DC 26894602                	mov	[es:bp+savedsp],ax
 26218                                  	;mov	[es:bp2],ax
 26219 000012E0 26894604                	mov	[es:bp+savedss],ax
 26220                                  	;mov	[es:bp+4],ax
 26221 000012E4 031E[0600]              	add	bx,[stacksize]
 26222 000012E8 26895E06                	mov	[es:bp+newsp],bx		; mov [es:bp+6],bx
 26223                                  	;mov	[es:bp+6],bx
 26224 000012EC 26892F                  	mov	[es:bx],bp
 26225 000012EF 83C508                  	add	bp,entrysize ; 8
 26226                                  
 26227 000012F2 E2E0                    	loop	buildloop
 26228                                  
 26229 000012F4 83ED08                  	sub	bp,entrysize ; 8
 26230 000012F7 892E[0E00]              	mov	[lastentry],bp
 26231 000012FB 892E[1000]              	mov	[nextentry],bp
 26232                                  
 26233 000012FF 1E                      	push	ds
 26234                                  	;mov	ax,0F000h		;look at the model byte
 26235                                  	; 05/09/2023
 26236 00001300 B4F0                    	mov	ah,0F0h ; ax = 0F000h
 26237 00001302 8ED8                    	mov	ds,ax
 26238 00001304 803EFEFFF9              	cmp	byte [0FFFEh],0F9h ; mdl_convert ; convertible?
 26239 00001309 1F                      	pop	ds
 26240 0000130A 7504                    	jne	short skip_disablenmis
 26241                                  
 26242 0000130C B007                    	mov	al,07h			; disable convertible nmis
 26243 0000130E E672                    	out	72h,al
 26244                                  
 26245                                  skip_disablenmis:
 26246 00001310 31C0                    	xor	ax,ax
 26247 00001312 8EC0                    	mov	es,ax			;es - segid of vector table at 0
 26248                                  					;ds - relocated stack code segment
 26249 00001314 FA                      	cli
 26250                                  
 26251                                  	;irp	aa,<02,08,09,70>
 26252                                  	;
 26253                                  	;mov	si,aa&h*4		;pass where vector is to be adjusted
 26254                                  	;mov	di,offset int19old&aa	;we have to set old&aa for int19 handler too.
 26255                                  	;mov	bx,offset old&aa	;pass where to save original owner pointer
 26256                                  	;mov	dx,offset int&aa	;pass where new handler is
 26257                                  	;call	new_init_loop		;adjust the vector to new handler,
 26258                                  	;				;saving pointer to original owner
 26259                                  	;endm
 26260                                  
 26261                                  stkinit_02:
 26262 00001315 BE0800                  	mov	si,02h*4 ; 8
 26263 00001318 BF[B305]                	mov	di,INT19OLD02
 26264 0000131B BB[1200]                	mov	bx,old02
 26265 0000131E BA[1600]                	mov	dx,int02
 26266 00001321 E84801                  	call	new_init_loop
 26267                                  stkinit_08:
 26268 00001324 BE2000                  	mov	si,08h*4 ; 32
 26269 00001327 BF[B805]                	mov	di,INT19OLD08
 26270 0000132A BB[3800]                	mov	bx,old08
 26271 0000132D BA[3C00]                	mov	dx,int08
 26272 00001330 E83901                  	call	new_init_loop
 26273                                  stkinit_09:
 26274 00001333 BE2400                  	mov	si,09h*4 ; 36
 26275 00001336 BF[BD05]                	mov	di,INT19OLD09
 26276 00001339 BB[4100]                	mov	bx,old09
 26277 0000133C BA[4500]                	mov	dx,int09
 26278 0000133F E82A01                  	call	new_init_loop
 26279                                  stkinit_70:
 26280 00001342 BEC001                  	mov	si,70h*4 ; 448
 26281 00001345 BF[DB05]                	mov	di,INT19OLD70
 26282 00001348 BB[4E00]                	mov	bx,old70
 26283 0000134B BA[5200]                	mov	dx,int70
 26284 0000134E E81B01                  	call	new_init_loop
 26285                                  
 26286                                  	;irp	aa,<0a,0b,0c,0d,0e,72,73,74,76,77> ;shared interrupts
 26287                                  	;
 26288                                  	;mov	si,aa&h*4		;pass where vector is to be adjusted
 26289                                  	;push	ds			;save relocated stack code segment
 26290                                  	;lds	bx, es:[si]		;ds:bx -> original interrupt handler
 26291                                  	;push	ds
 26292                                  	;pop	dx			;dx = segment value
 26293                                  	;	
 26294                                  	;cmp	dx,0
 26295                                  	;jz	int&aa&_first
 26296                                  	;
 26297                                  	;cmp	byte ptr ds:[bx],0cfh	;does vector point to an iret?
 26298                                  	;jz	int&aa&_first
 26299                                  	;
 26300                                  	;cmp	word ptr ds:[bx.6],424bh ;magic offset (see int&aa, msstack.inc)
 26301                                  	;jz	int&aa&_not_first
 26302                                  	;
 26303                                  	;cmp	dx,0f000h		;rom bios segment
 26304                                  	;jnz	int&aa&_not_first
 26305                                  	;
 26306                                  	;push	es
 26307                                  	;push	dx
 26308                                  	;mov	dx,0f000h
 26309                                  	;mov	es,dx
 26310                                  	;cmp	bx,word ptr es:0ff01h
 26311                                         	;pop	dx
 26312                                  	;pop	es
 26313                                  	;jz	int&aa&_first
 26314                                  	;
 26315                                  ;int&aa&_not_first:			;not the first. we are going to hook vector.
 26316                                  	;pop	ds
 26317                                  	;mov	di, offset int19old&aa	;we have to set old&aa for int19 handler too.
 26318                                  	;mov	bx, offset old&aa	;pass where to save original owner pointer
 26319                                  	;mov	dx, offset int&aa	;pass where new handler is
 26320                                  	;call	new_init_loop		;adjust the vector to new handler, saving
 26321                                  	;				;pointer to original owner.
 26322                                  	;jmp	short int&aa&_end
 26323                                  ;int&aa&_first:				;the first. don't have to hook stack code.
 26324                                  	;pop	ds
 26325                                  ;int&aa&_end:
 26326                                  	;
 26327                                  	;endm
 26328                                  
 26329                                  stkinit_0A:
 26330 00001351 BE2800                  	mov	si,0Ah*4 ; 40
 26331                                  	
 26332                                  ; 14/12/2022
 26333                                  %if 0	
 26334                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26335                                  	push	ds
 26336                                  	
 26337                                  	lds	bx,[es:si]
 26338                                  	push	ds
 26339                                  	pop	dx
 26340                                  		
 26341                                  	cmp	dx,0
 26342                                  	je	short int_0A_first
 26343                                  	
 26344                                  	cmp	byte [bx],0CFh
 26345                                  	je	short int_0A_first
 26346                                  	
 26347                                  	cmp	word [bx+6],424Bh
 26348                                  	je	short int_0A_not_first
 26349                                  	
 26350                                  	cmp	dx,0F000h
 26351                                  	jne	short int_0A_not_first
 26352                                  	
 26353                                  	push	es
 26354                                  	push	dx
 26355                                  	mov	dx,0F000h
 26356                                  	mov	es,dx
 26357                                  	cmp	bx,[es:0FF01h]
 26358                                         	pop	dx
 26359                                  	pop	es
 26360                                  	je	short int_0A_first
 26361                                  %Endif
 26362                                  
 26363                                  	; 14/12/2022
 26364                                  	; 25/10/2022
 26365 00001354 E8EB00                  	call	int_xx_first_check ; 27/03/2019 - Retro DOS v4.0
 26366 00001357 730C                    	jnc	short int_0A_first
 26367                                  	
 26368                                  int_0A_not_first:
 26369                                  	; 14/12/2022
 26370                                  	; 25/10/2022
 26371                                  	;pop	ds
 26372 00001359 BF[C205]                	mov	di,INT19OLD0A
 26373 0000135C BB[5900]                	mov	bx,old0A
 26374 0000135F BA[5700]                	mov	dx,int0A
 26375 00001362 E80701                  	call	new_init_loop
 26376                                  	
 26377                                  	; 14/12/2022	
 26378                                  	;jmp	short int_0A_end
 26379                                  ;int_0A_first:
 26380                                  	; 25/10/2022
 26381                                  	;pop	ds
 26382                                  
 26383                                  	; 14/12/2022
 26384                                  int_0A_first:
 26385                                  int_0A_end:
 26386                                  
 26387                                  stkinit_0B:
 26388 00001365 BE2C00                  	mov	si,0Bh*4 ; 44
 26389                                  	
 26390                                  	; 14/12/2022
 26391                                  	; 25/10/2022
 26392 00001368 E8D700                  	call	int_xx_first_check ; 27/03/2019 - Retro DOS v4.0
 26393 0000136B 730C                    	jnc	short int_0B_end ; int_0B_first
 26394                                  
 26395                                  ; 14/12/2022
 26396                                  %if 0	
 26397                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26398                                  	push	ds
 26399                                  	lds	bx,[es:si]
 26400                                  	push	ds
 26401                                  	pop	dx
 26402                                  		
 26403                                  	cmp	dx,0
 26404                                  	je	short int_0B_first
 26405                                  
 26406                                  	cmp	byte [bx],0CFh
 26407                                  	je	short int_0B_first
 26408                                  	
 26409                                  	cmp	word [bx+6],424Bh
 26410                                  	je	short int_0B_not_first
 26411                                  	
 26412                                  	cmp	dx,0F000h
 26413                                  	jne	short int_0B_not_first
 26414                                  
 26415                                  	push	es
 26416                                  	push	dx
 26417                                  	mov	dx,0F000h
 26418                                  	mov	es,dx
 26419                                  	cmp	bx,[es:0FF01h]
 26420                                  	pop	dx
 26421                                  	pop	es
 26422                                  	je	short int_0B_first
 26423                                  %endif
 26424                                  
 26425                                  int_0B_not_first:
 26426                                  	; 14/12/2022
 26427                                  	; 25/10/2022
 26428                                  	;pop	ds
 26429 0000136D BF[C705]                	mov	di,INT19OLD0B
 26430 00001370 BB[7100]                	mov	bx,old0B
 26431 00001373 BA[6F00]                	mov	dx,int0B
 26432 00001376 E8F300                  	call	new_init_loop
 26433                                  
 26434                                  	; 14/12/2022
 26435                                  	;jmp	short int_0B_end
 26436                                  ;int_0B_first:
 26437                                  	; 25/10/2022
 26438                                  	;pop	ds
 26439                                  
 26440                                  int_0B_end:
 26441                                  	
 26442                                  stkinit_0C:
 26443 00001379 BE3000                  	mov	si,0Ch*4 ; 48
 26444                                  	
 26445                                  	; 14/12/2022
 26446                                  	; 25/10/2022
 26447 0000137C E8C300                  	call	int_xx_first_check
 26448 0000137F 730C                    	jnc	short int_0C_end ; int_0C_first
 26449                                  
 26450                                  ; 14/12/2022
 26451                                  %if 0	
 26452                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26453                                  	push	ds
 26454                                  	lds	bx,[es:si]
 26455                                  	push	ds
 26456                                  	pop	dx
 26457                                  		
 26458                                  	cmp	dx,0
 26459                                  	je	short int_0C_first
 26460                                  
 26461                                  	cmp	byte [bx],0CFh
 26462                                  	je	short int_0C_first
 26463                                  	
 26464                                  	cmp	word [bx+6],424Bh
 26465                                  	je	short int_0C_not_first
 26466                                  	
 26467                                  	cmp	dx,0F000h
 26468                                  	jne	short int_0C_not_first
 26469                                  
 26470                                  	push	es
 26471                                  	push	dx
 26472                                  	mov	dx,0F000h
 26473                                  	mov	es,dx
 26474                                  	cmp	bx,[es:0FF01h]
 26475                                  	pop	dx
 26476                                  	pop	es
 26477                                  	je	short int_0C_first
 26478                                  %endif
 26479                                  	
 26480                                  int_0C_not_first:
 26481                                  	; 14/12/2022
 26482                                  	; 25/10/2022
 26483                                  	;pop	ds
 26484 00001381 BF[CC05]                	mov	di,INT19OLD0C
 26485 00001384 BB[8900]                	mov	bx,old0C
 26486 00001387 BA[8700]                	mov	dx,int0C
 26487 0000138A E8DF00                  	call	new_init_loop
 26488                                  
 26489                                  	; 14/12/2022
 26490                                  	;jmp	short int_0C_end
 26491                                  ;int_0C_first:
 26492                                  	; 25/10/2022
 26493                                  	;pop	ds
 26494                                  
 26495                                  int_0C_end:
 26496                                  
 26497                                  stkinit_0D:
 26498 0000138D BE3400                  	mov	si,0Dh*4 ; 52
 26499                                  
 26500                                  	; 14/12/2022	
 26501                                  	; 25/10/2022
 26502 00001390 E8AF00                  	call	int_xx_first_check
 26503 00001393 730C                    	jnc	short int_0D_end ; int_0D_first
 26504                                  
 26505                                  ; 14/12/2022
 26506                                  %if 0	
 26507                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26508                                  	push	ds
 26509                                  	lds	bx,[es:si]
 26510                                  	push	ds
 26511                                  	pop	dx
 26512                                  		
 26513                                  	cmp	dx,0
 26514                                  	je	short int_0D_first
 26515                                  
 26516                                  	cmp	byte [bx],0CFh
 26517                                  	je	short int_0D_first
 26518                                  	
 26519                                  	cmp	word [bx+6],424Bh
 26520                                  	je	short int_0D_not_first
 26521                                  	
 26522                                  	cmp	dx,0F000h
 26523                                  	jne	short int_0D_not_first
 26524                                  
 26525                                  	push	es
 26526                                  	push	dx
 26527                                  	mov	dx,0F000h
 26528                                  	mov	es,dx
 26529                                  	cmp	bx,[es:0FF01h]
 26530                                  	pop	dx
 26531                                  	pop	es
 26532                                  	je	short int_0D_first
 26533                                  %endif
 26534                                  	
 26535                                  int_0D_not_first:
 26536                                  	; 14/12/2022
 26537                                  	; 25/10/2022
 26538                                  	;pop	ds
 26539 00001395 BF[D105]                	mov	di,INT19OLD0D
 26540 00001398 BB[A100]                	mov	bx,old0D
 26541 0000139B BA[9F00]                	mov	dx,int0D
 26542 0000139E E8CB00                  	call	new_init_loop
 26543                                  
 26544                                  	; 14/12/2022
 26545                                  	;jmp	short int_0D_end
 26546                                  	; 02/11/2022
 26547                                  ;int_0D_first:
 26548                                  	;pop	ds
 26549                                  
 26550                                  int_0D_end:
 26551                                  
 26552                                  stkinit_0E:
 26553 000013A1 BE3800                  	mov	si,0Eh*4 ; 56
 26554                                  
 26555                                  	; 14/12/2022	
 26556                                  	; 25/10/2022
 26557 000013A4 E89B00                  	call	int_xx_first_check
 26558 000013A7 730C                    	jnc	short int_0E_end ; int_0E_first
 26559                                  
 26560                                  ; 14/12/2022
 26561                                  %if 0	
 26562                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26563                                  	push	ds
 26564                                  	lds	bx,[es:si]
 26565                                  	push	ds
 26566                                  	pop	dx
 26567                                  		
 26568                                  	cmp	dx,0
 26569                                  	je	short int_0E_first
 26570                                  
 26571                                  	cmp	byte [bx],0CFh
 26572                                  	je	short int_0E_first
 26573                                  	
 26574                                  	cmp	word [bx+6],424Bh
 26575                                  	je	short int_0E_not_first
 26576                                  	
 26577                                  	cmp	dx,0F000h
 26578                                  	jne	short int_0E_not_first
 26579                                  
 26580                                  	push	es
 26581                                  	push	dx
 26582                                  	mov	dx,0F000h
 26583                                  	mov	es,dx
 26584                                  	cmp	bx,[es:0FF01h]
 26585                                  	pop	dx
 26586                                  	pop	es
 26587                                  	je	short int_0E_first
 26588                                  %endif
 26589                                  	
 26590                                  int_0E_not_first:
 26591                                  	; 14/12/2022
 26592                                  	; 25/10/2022
 26593                                  	;pop	ds
 26594 000013A9 BF[D605]                	mov	di,INT19OLD0E
 26595 000013AC BB[B900]                	mov	bx,old0E
 26596 000013AF BA[B700]                	mov	dx,int0E
 26597 000013B2 E8B700                  	call	new_init_loop
 26598                                  
 26599                                  	; 14/12/2022
 26600                                  	;jmp	short int_0E_end
 26601                                  ;int_0E_first:
 26602                                  	; 25/10/2022
 26603                                  	;pop	ds	
 26604                                  
 26605                                  int_0E_end:
 26606                                  
 26607                                  stkinit_72:
 26608 000013B5 BEC801                  	mov	si,72h*4 ; 456
 26609                                  	
 26610                                  	; 14/12/2022
 26611                                  	; 25/10/2022
 26612 000013B8 E88700                  	call	int_xx_first_check
 26613 000013BB 730C                    	jnc	short int_72_end ; int_72_first
 26614                                  
 26615                                  ; 14/12/2022
 26616                                  %if 0	
 26617                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26618                                  	push	ds
 26619                                  	lds	bx,[es:si]
 26620                                  	push	ds
 26621                                  	pop	dx
 26622                                  		
 26623                                  	cmp	dx,0
 26624                                  	je	short int_72_first
 26625                                  
 26626                                  	cmp	byte [bx],0CFh
 26627                                  	je	short int_72_first
 26628                                  	
 26629                                  	cmp	word [bx+6],424Bh
 26630                                  	je	short int_72_not_first
 26631                                  	
 26632                                  	cmp	dx,0F000h
 26633                                  	jne	short int_72_not_first
 26634                                  
 26635                                  	push	es
 26636                                  	push	dx
 26637                                  	mov	dx,0F000h
 26638                                  	mov	es,dx
 26639                                  	cmp	bx,[es:0FF01h]
 26640                                  	pop	dx
 26641                                  	pop	es
 26642                                  	je	short int_72_first
 26643                                  %endif
 26644                                  	
 26645                                  int_72_not_first:
 26646                                  	; 14/12/2022
 26647                                  	; 25/10/2022
 26648                                  	;pop	ds
 26649 000013BD BF[E005]                	mov	di,INT19OLD72
 26650 000013C0 BB[D100]                	mov	bx,old72
 26651 000013C3 BA[CF00]                	mov	dx,int72
 26652 000013C6 E8A300                  	call	new_init_loop
 26653                                  
 26654                                  	; 14/12/2022
 26655                                  	;jmp	short int_72_end
 26656                                  ;int_72_first:
 26657                                  	; 25/10/2022
 26658                                  	;pop	ds
 26659                                  
 26660                                  int_72_end:
 26661                                  
 26662                                  stkinit_73:
 26663 000013C9 BECC01                  	mov	si,73h*4 ; 460
 26664                                  	
 26665                                  	; 14/12/2022
 26666                                  	; 25/10/2022
 26667 000013CC E87300                  	call	int_xx_first_check
 26668 000013CF 730C                    	jnc	short int_73_end ; int_73_first
 26669                                  
 26670                                  ; 14/12/2022
 26671                                  %if 0	
 26672                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26673                                  	push	ds
 26674                                  	lds	bx,[es:si]
 26675                                  	push	ds
 26676                                  	pop	dx
 26677                                  		
 26678                                  	cmp	dx,0
 26679                                  	je	short int_73_first
 26680                                  
 26681                                  	cmp	byte [bx],0CFh
 26682                                  	je	short int_73_first
 26683                                  	
 26684                                  	cmp	word [bx+6],424Bh
 26685                                  	je	short int_73_not_first
 26686                                  	
 26687                                  	cmp	dx,0F000h
 26688                                  	jne	short int_73_not_first
 26689                                  
 26690                                  	push	es
 26691                                  	push	dx
 26692                                  	mov	dx,0F000h
 26693                                  	mov	es,dx
 26694                                  	cmp	bx,[es:0FF01h]
 26695                                  	pop	dx
 26696                                  	pop	es
 26697                                  	je	short int_73_first
 26698                                  %endif	
 26699                                  	
 26700                                  int_73_not_first:
 26701                                  	; 14/12/2022
 26702                                  	; 25/10/2022
 26703                                  	;pop	ds
 26704 000013D1 BF[E505]                	mov	di,INT19OLD73
 26705 000013D4 BB[E900]                	mov	bx,old73
 26706 000013D7 BA[E700]                	mov	dx,int73
 26707 000013DA E88F00                  	call	new_init_loop
 26708                                  
 26709                                  	; 14/12/2022
 26710                                  	;jmp	short int_73_end
 26711                                  ;int_73_first:
 26712                                  	; 25/10/2022
 26713                                  	;pop	ds
 26714                                  
 26715                                  int_73_end:
 26716                                  
 26717                                  stkinit_74:
 26718 000013DD BED001                  	mov	si,74h*4 ; 464
 26719                                  	
 26720                                  	; 14/12/2022
 26721                                  	; 25/10/2022
 26722 000013E0 E85F00                  	call	int_xx_first_check
 26723 000013E3 730C                    	jnc	short int_74_end ; int_74_first
 26724                                  
 26725                                  ; 14/12/2022
 26726                                  %if 0		
 26727                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26728                                  	push	ds
 26729                                  	lds	bx,[es:si]
 26730                                  	push	ds
 26731                                  	pop	dx
 26732                                  		
 26733                                  	cmp	dx,0
 26734                                  	je	short int_74_first
 26735                                  
 26736                                  	cmp	byte [bx],0CFh
 26737                                  	je	short int_74_first
 26738                                  	
 26739                                  	cmp	word [bx+6],424Bh
 26740                                  	je	short int_74_not_first
 26741                                  	
 26742                                  	cmp	dx,0F000h
 26743                                  	jne	short int_74_not_first
 26744                                  
 26745                                  	push	es
 26746                                  	push	dx
 26747                                  	mov	dx,0F000h
 26748                                  	mov	es,dx
 26749                                  	cmp	bx,[es:0FF01h]
 26750                                  	pop	dx
 26751                                  	pop	es
 26752                                  	je	short int_74_first
 26753                                  %endif
 26754                                  
 26755                                  int_74_not_first:
 26756                                  	; 14/12/2022
 26757                                  	; 25/10/2022
 26758                                  	;pop	ds
 26759 000013E5 BF[EA05]                	mov	di,INT19OLD74
 26760 000013E8 BB[0101]                	mov	bx,old74
 26761 000013EB BA[FF00]                	mov	dx,int74
 26762 000013EE E87B00                  	call	new_init_loop
 26763                                  	
 26764                                  	; 14/12/2022
 26765                                  	;jmp	short int_74_end
 26766                                  ;int_74_first:
 26767                                  	; 25/10/2022
 26768                                  	;pop	ds
 26769                                  
 26770                                  int_74_end:
 26771                                  
 26772                                  stkinit_76:
 26773 000013F1 BED801                  	mov	si,76h*4 ; 472
 26774                                  	
 26775                                  	; 14/12/2022
 26776                                  	; 25/10/2022
 26777 000013F4 E84B00                  	call	int_xx_first_check
 26778 000013F7 730E                    	jnc	short int_76_end ; int_76_first
 26779                                  
 26780                                  ; 14/12/2022
 26781                                  %if 0	
 26782                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26783                                  	push	ds
 26784                                  	lds	bx,[es:si]
 26785                                  	push	ds
 26786                                  	pop	dx
 26787                                  		
 26788                                  	cmp	dx,0
 26789                                  	je	short int_76_first
 26790                                  
 26791                                  	cmp	byte [bx],0CFh
 26792                                  	je	short int_76_first
 26793                                  	
 26794                                  	cmp	word [bx+6],424Bh
 26795                                  	je	short int_76_not_first
 26796                                  	
 26797                                  	cmp	dx,0F000h
 26798                                  	jne	short int_76_not_first
 26799                                  
 26800                                  	push	es
 26801                                  	push	dx
 26802                                  	mov	dx,0F000h
 26803                                  	mov	es,dx
 26804                                  	cmp	bx,[es:0FF01h]
 26805                                  	pop	dx
 26806                                  	pop	es
 26807                                  	je	short int_76_first
 26808                                  %endif
 26809                                  	
 26810                                  int_76_not_first:
 26811                                  	; 14/12/2022
 26812                                  	; 25/10/2022
 26813                                  	;pop	ds
 26814 000013F9 BF[EF05]                	mov	di,INT19OLD76
 26815 000013FC BB[1901]                	mov	bx,old76
 26816 000013FF BA[1701]                	mov	dx,int76
 26817 00001402 E86700                  	call	new_init_loop
 26818                                  
 26819                                  	; 14/12/2022
 26820 00001405 EB00                    	jmp	short int_76_end
 26821                                  ;int_76_first:
 26822                                  	; 25/10/2022
 26823                                  	;pop	ds
 26824                                  
 26825                                  int_76_end:
 26826                                  
 26827                                  stkinit_77:
 26828 00001407 BEDC01                  	mov	si,77h*4 ; 476
 26829                                  	
 26830                                  	; 14/12/2022
 26831                                  	; 25/10/2022
 26832 0000140A E83500                  	call	int_xx_first_check
 26833 0000140D 730C                    	jnc	short int_77_end ; int_77_first
 26834                                  
 26835                                  ; 14/12/2022
 26836                                  %if 0	
 26837                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26838                                  	push	ds
 26839                                  	lds	bx,[es:si]
 26840                                  	push	ds
 26841                                  	pop	dx
 26842                                  		
 26843                                  	cmp	dx,0
 26844                                  	je	short int_77_first
 26845                                  
 26846                                  	cmp	byte [bx],0CFh
 26847                                  	je	short int_77_first
 26848                                  	
 26849                                  	cmp	word [bx+6],424Bh
 26850                                  	je	short int_77_not_first
 26851                                  	
 26852                                  	cmp	dx,0F000h
 26853                                  	jne	short int_77_not_first
 26854                                  
 26855                                  	push	es
 26856                                  	push	dx
 26857                                  	mov	dx,0F000h
 26858                                  	mov	es,dx
 26859                                  	cmp	bx,[es:0FF01h]
 26860                                  	pop	dx
 26861                                  	pop	es
 26862                                  	je	short int_77_first
 26863                                  %endif
 26864                                  	
 26865                                  int_77_not_first:
 26866                                  	; 14/12/2022
 26867                                  	; 25/10/2022
 26868                                  	;pop	ds
 26869 0000140F BF[F405]                	mov	di,INT19OLD77
 26870 00001412 BB[3101]                	mov	bx,old77
 26871 00001415 BA[2F01]                	mov	dx,int77
 26872 00001418 E85100                  	call	new_init_loop
 26873                                  
 26874                                  	; 14/12/2022
 26875                                  	;jmp	short int_77_end
 26876                                  ;int_77_first:
 26877                                  	; 25/10/2022
 26878                                  	;pop	ds
 26879                                  
 26880                                  int_77_end:
 26881 0000141B 1E                      	push	ds
 26882 0000141C B800F0                  	mov	ax,0F000h		; look at the model byte
 26883 0000141F 8ED8                    	mov	ds,ax
 26884 00001421 803EFEFFF9              	cmp	byte [0FFFEh],0F9h ; mdl_convert ; pc convertible?
 26885 00001426 1F                      	pop	ds
 26886 00001427 7504                    	jne	short skip_enablenmis
 26887                                  
 26888 00001429 B027                    	mov	al,27h			; enable convertible nmis
 26889 0000142B E672                    	out	72h,al
 26890                                  
 26891                                  ; 25/10/2022
 26892                                  ; (MSDOS 5.0 SYSINIT:15FBh)
 26893                                  
 26894                                  skip_enablenmis:
 26895 0000142D FB                      	sti
 26896                                  	;;mov	ax,Bios_Data ; 70h
 26897                                  	;mov	ax,KERNEL_SEGMENT ; 70h
 26898                                  	; 21/10/2022
 26899 0000142E B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 26900 00001431 8ED8                    	mov	ds,ax
 26901                                  
 26902                                  	;mov	[640h],1 ; SYSINIT:1736h for MSDOS 6.21 IO.SYS
 26903                                  
 26904 00001433 C606[B105]01            	mov	byte [INT19SEM],1	; indicate that int 19h
 26905                                  					; initialization is complete
 26906                                  
 26907 00001438 5D                      	pop	bp			; restore all
 26908 00001439 5E                      	pop	si
 26909 0000143A 5F                      	pop	di
 26910 0000143B 5A                      	pop	dx
 26911 0000143C 59                      	pop	cx
 26912 0000143D 5B                      	pop	bx
 26913 0000143E 07                      	pop	es
 26914 0000143F 1F                      	pop	ds
 26915 00001440 58                      	pop	ax
 26916 00001441 C3                      	retn
 26917                                  
 26918                                  ; 14/12/2022
 26919                                  ; ----------------------------------------------------------------------
 26920                                  
 26921                                  	; 14/12/2022
 26922                                  	; 25/10/2022
 26923                                  ;%if 0
 26924                                  	; 27/03/2019 - Retro DOS v4.0
 26925                                  int_xx_first_check:
 26926 00001442 1E                      	push	ds
 26927 00001443 26C51C                  	lds	bx,[es:si]
 26928 00001446 1E                      	push	ds
 26929 00001447 5A                      	pop	dx
 26930                                  		
 26931                                  	;cmp	dx,0
 26932                                  	;je	short int_xx_first
 26933                                  	; 05/09/2023
 26934 00001448 21D2                    	and	dx,dx
 26935 0000144A 741E                    	jz	short int_xx_first	
 26936                                  
 26937 0000144C 803FCF                  	cmp	byte [bx],0CFh
 26938 0000144F 7419                    	je	short int_xx_first
 26939                                  	
 26940 00001451 817F064B42              	cmp	word [bx+6],424Bh
 26941 00001456 7411                    	je	short int_xx_not_first
 26942                                  	
 26943 00001458 81FA00F0                	cmp	dx,0F000h
 26944 0000145C 750B                    	jne	short int_xx_not_first
 26945                                  
 26946 0000145E 06                      	push	es
 26947                                  	;push	dx
 26948                                  	;mov	dx,0F000h
 26949 0000145F 8EC2                    	mov	es,dx
 26950 00001461 263B1E01FF              	cmp	bx,[es:0FF01h]
 26951                                        	;pop	dx
 26952 00001466 07                      	pop	es
 26953 00001467 7401                    	je	short int_xx_first
 26954                                  
 26955                                  int_xx_not_first:
 26956 00001469 F9                      	stc
 26957                                  int_xx_first:
 26958 0000146A 1F                      	pop	ds
 26959 0000146B C3                      	retn
 26960                                  
 26961                                  ;%endif
 26962                                  
 26963                                  ; ----------------------------------------------------------------------
 26964                                  ; 27/03/2019 - Retro DOS v4.0
 26965                                  
 26966                                  ; 25/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS, SYSINIT)
 26967                                  ; (SYSINIT:1610h)
 26968                                  
 26969                                  new_init_loop:
 26970                                  
 26971                                  ;input: si=ofset into vector table of the particular int vector being adjusted
 26972                                  ;	bx=ds:offset of oldxx, where will be saved the pointer to original owner
 26973                                  ;	dx=ds:offset of intxx, the new interrupt handler
 26974                                  ;	di=offset value of int19old&aa variable in bios.
 26975                                  ;	es=zero, segid of vector table
 26976                                  ;	ds=relocated stack code segment
 26977                                  
 26978 0000146C 268B04                  	mov	ax,[es:si]		;remember offset in vector
 26979 0000146F 8907                    	mov	[bx],ax			; to original owner in ds
 26980 00001471 268B4402                	mov	ax,[es:si+2]		;remember segid in vector
 26981 00001475 894702                  	mov	[bx+2],ax		; to original owner in ds
 26982                                  
 26983 00001478 1E                      	push	ds
 26984                                  	;;mov	ax,Bios_Data ; 70h
 26985                                  	;mov	ax,KERNEL_SEGMENT ; 70h
 26986                                  	; 21/10/2022
 26987 00001479 B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 26988 0000147C 8ED8                    	mov	ds,ax			;set int19oldxx value in bios for
 26989 0000147E 268B04                  	mov	ax,[es:si]		;int 19 handler
 26990 00001481 8905                    	mov	[di],ax
 26991 00001483 268B4402                	mov	ax,[es:si+2]
 26992 00001487 894502                  	mov	[di+2],ax
 26993 0000148A 1F                      	pop	ds
 26994                                  
 26995 0000148B 268914                  	mov	[es:si],dx  	;set vector to point to new int handler
 26996 0000148E 268C5C02                	mov	[es:si+2],ds
 26997 00001492 C3                      	retn
 26998                                  
 26999                                  ; End of STACK initialization routine
 27000                                  ; ----------------------------------------------------------------------
 27001                                  
 27002                                  ; ----------------------------------------------------------------------
 27003                                  ;set the devmark for mem command.
 27004                                  ;in: [memhi] - the address to place devmark
 27005                                  ;    [memlo] = 0
 27006                                  ;    al = id for devmark_id
 27007                                  ;out: devmark established.
 27008                                  ;     the address saved in cs:[devmark_addr]
 27009                                  ;     [memhi] increase by 1.
 27010                                  ; ----------------------------------------------------------------------
 27011                                  
 27012                                  ; 25/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS, SYSINIT)
 27013                                  ; (SYSINIT:1637h)
 27014                                  ; 04/09/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS, SYSINIT)
 27015                                  ; (SYSINIT:176Ch)
 27016                                  
 27017                                  ; 04/09/2023 - PCDOS 7.1 - IBMBIO.COM (SYSINIT:1944h)
 27018                                  
 27019                                  setdevmark:
 27020                                  
 27021                                  	; 04/09/2023
 27022                                  	;push	es
 27023                                  	;push	cx
 27024                                  
 27025 00001493 2E8B0E[6403]            	mov	cx,[cs:memhi]
 27026 00001498 2E890E[B614]            	mov	[cs:devmark_addr],cx
 27027 0000149D 8EC1                    	mov	es,cx
 27028                                  	; 25/10/2022
 27029                                  	;mov	[es:devmark.id],al
 27030 0000149F 26A20000                	mov	[es:0],al
 27031 000014A3 41                      	inc	cx
 27032                                  	;mov	[es:devmark.seg],cx
 27033 000014A4 26890E0100              	mov	[es:1],cx
 27034                                  
 27035                                  	; 04/09/2023
 27036                                  	;pop	cx
 27037                                  	;pop	es
 27038                                  	
 27039 000014A9 2EFF06[6403]            	inc	word [cs:memhi]
 27040 000014AE C3                      	retn
 27041                                  
 27042                                  ; ----------------------------------------------------------------------
 27043                                  ; SYSCONF.ASM - MSDOS 6.0 - 1991
 27044                                  ; ----------------------------------------------------------------------
 27045                                  ; 27/03/2019 - Retro DOS v4.0
 27046                                  
 27047                                  ;MULTI_CONFIG	equ 1
 27048                                  
 27049                                  HIGH_FIRST 	equ 080h		; from ARENA.INC - modifier for
 27050                                                                          ; allocation strategy call
 27051                                  
 27052                                  ;have_install_cmd equ 00000001b 	; config.sys has install= commands
 27053                                  ;has_installed	  equ 00000010b 	; sysinit_base installed.
 27054                                  
 27055                                  default_filenum equ 8
 27056                                  
 27057                                  ;stacksw	equ true		; include switchable hardware stacks
 27058                                  
 27059                                  ; external variable defined in ibmbio module for multi-track
 27060                                  
 27061                                  ;multrk_on	equ 10000000b		;user spcified mutitrack=on,or system turns
 27062                                  					; it on after handling config.sys file as a
 27063                                  					; default value,if multrk_flag = multrk_off1.
 27064                                  ;multrk_off1	equ 00000000b		;initial value. no "multitrack=" command entered.
 27065                                  ;multrk_off2	equ 00000001b		;user specified multitrack=off.
 27066                                  
 27067                                  ; if stacksw
 27068                                  
 27069                                  ; internal stack parameters
 27070                                  
 27071                                  ;entrysize	equ 8
 27072                                  
 27073                                  ;mincount	equ 8
 27074                                  ;defaultcount	equ 9
 27075                                  ;maxcount	equ 64
 27076                                  
 27077                                  ;minsize 	equ 32
 27078                                  ;defaultsize	equ 128
 27079                                  ;maxsize 	equ 512
 27080                                  
 27081                                  DOS_FLAG_OFFSET	equ 86h
 27082                                  
 27083                                  ;ifdef MULTI_CONFIG
 27084                                  ;
 27085                                  ;   config_envlen must immediately precede config_wrkseg, because they
 27086                                  ;   may be loaded as a dword ptr
 27087                                  
 27088                                  ; 30/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 27089                                  ; 25/10/2022
 27090 000014AF 0000                    config_envlen:	dw  0  			; when config_wrkseg is being used as
 27091                                                 				;  a scratch env, this is its length
 27092 000014B1 0000                    config_wrkseg:	dw  0			; config work area (above confbot)
 27093                                                     			;  segment of work area
 27094                                  
 27095 000014B3 00                      config_cmd:	db  0  			; current config cmd
 27096                                                   			;  (with CONFIG_OPTION_QUERY bit intact)
 27097 000014B4 00                      config_multi:	db  0                   ; non-zero if multi-config config.sys
 27098                                  
 27099                                  ;endif ; MULTI_CONFIG
 27100                                  
 27101 000014B5 00                      multdeviceflag:	db  0
 27102                                  
 27103 000014B6 0000                    devmark_addr:	dw  0			;segment address for devmark.
 27104                                  
 27105 000014B8 00                      setdevmarkflag: db  0			;flag used for devmark
 27106                                  
 27107                                  ; 30/12/2022
 27108                                  ; 12/12/2022
 27109 000014B9 00                      driver_units:	db  0			;total unitcount for driver
 27110                                  
 27111                                  ; 12/12/2022
 27112                                  ;ems_stub_installed:
 27113                                  ;		db  0
 27114                                  
 27115                                  ; 12/12/2022	
 27116                                  ;align 2
 27117                                  
 27118                                  badparm_ptr:	; label	dword
 27119 000014BA 0000                    badparm_off:	dw  0
 27120 000014BC 0000                    badparm_seg:	dw  0
 27121                                  
 27122                                  ;******************************************************************************
 27123                                  ;take care of config.sys file.
 27124                                  ;system parser data and code.
 27125                                  ;******************************************************************************
 27126                                  
 27127                                  ;*******************************************************************
 27128                                  ; parser options set for msbio sysconf module
 27129                                  ;*******************************************************************
 27130                                  ;
 27131                                  ;**** default assemble swiches definition **************************
 27132                                  
 27133                                  ;farsw	equ 0		; near call expected
 27134                                  ;datesw	equ 0		; check date format
 27135                                  ;timesw	equ 0		; check time format
 27136                                  ;filesw	equ 1		; check file specification
 27137                                  ;capsw	equ 0		; perform caps if specified
 27138                                  ;cmpxsw	equ 0		; check complex list
 27139                                  ;numsw	equ 1		; check numeric value
 27140                                  ;keysw	equ 0		; support keywords
 27141                                  ;swsw	equ 1		; support switches
 27142                                  ;val1sw	equ 1		; support value definition 1
 27143                                  ;val2sw	equ 0		; support value definition 2
 27144                                  ;val3sw	equ 1		; support value definition 3
 27145                                  ;drvsw	equ 1		; support drive only format
 27146                                  ;qussw	equ 0		; support quoted string format
 27147                                  
 27148                                  ; psdata_seg equ cs
 27149                                  
 27150                                  	;.xlist
 27151                                  	;include parse.asm		;together with psdata.inc
 27152                                  	;.list
 27153                                  
 27154                                  ; PSDATA.INC - MSDOS 6.0 - 1991
 27155                                  ; ======================================================================
 27156                                  ; 27/03/2019 - Retro DOS v4.0
 27157                                  
 27158                                  ; 30/03/2019
 27159                                  ; VERSION.INC (MSDOS 6.0) 
 27160                                  ; Set DBCS Blank constant
 27161                                  
 27162                                  ; ifndef DBCS
 27163                                  DB_SPACE EQU 2020h
 27164                                  DB_SP_HI EQU 20h
 27165                                  DB_SP_LO EQU 20h
 27166                                  ; else
 27167                                  
 27168                                  ;*******************************************************************
 27169                                  ; Parser include file
 27170                                  ;*******************************************************************
 27171                                  
 27172                                  ;**** Equation field
 27173                                  ;-------- Character code definition
 27174                                  
 27175                                  _$P_DBSP1	   equ	DB_SP_HI	;AN000; 1st byte of DBCS blank
 27176                                  _$P_DBSP2	   equ	DB_SP_LO	;AN000; 2nd byte of DBCS blank
 27177                                  _$P_Period	   equ	"."             ;AN020;
 27178                                  _$P_Slash	   equ	"/"             ;AN020;
 27179                                  _$P_Space	   equ	" "             ;AN000; SBCS blank
 27180                                  _$P_Comma	   equ	","             ;AN000;
 27181                                  _$P_Switch	   equ	"/"             ;AN000;
 27182                                  _$P_Keyword	   equ	"="             ;AN000;
 27183                                  _$P_Colon	   equ	":"             ;AN000;
 27184                                  _$P_Plus 	   equ	"+"             ;AN000;
 27185                                  _$P_Minus	   equ	"-"             ;AN000;
 27186                                  _$P_Rparen	   equ	")"             ;AN000;
 27187                                  _$P_Lparen	   equ	"("             ;AN000;
 27188                                  ;_$P_SQuote        equ  "'"			;AN025; deleted
 27189                                  _$P_DQuote	   equ	'"'             ;AN000;
 27190                                  _$P_NULL 	   equ	0		;AN000;
 27191                                  _$P_TAB		   equ	9		;AN000;
 27192                                  _$P_CR		   equ	0Dh		;AN000;
 27193                                  _$P_LF		   equ	0Ah		;AN000;
 27194                                  _$P_ASCII80	   equ	80h		;AN000; ASCII 80h character code
 27195                                  
 27196                                  ;-------- Masks
 27197                                  _$P_Make_Lower	   equ	20h		;AN000; make lower case character
 27198                                  _$P_Make_Upper	   equ	0FFh-_$P_Make_Lower ;AN000; make upper case character
 27199                                  
 27200                                  ;-------- DOS function call related equs
 27201                                  
 27202                                  _$P_DOS_Get_CDI	   equ	3800h		;AN000; get country dependent information
 27203                                  					; by this call, following information
 27204                                  struc _$P_CDI	
 27205 00000000 ????                     .DateF: resw 1
 27206 00000002 ??????????               .Money: resb 5
 27207 00000007 ????                     .1000:	 resb 2
 27208 00000009 ????                     .Dec:	 resb 2
 27209 0000000B ????                     .DateS: resb 2
 27210 0000000D ????                     .TimeS: resb 2
 27211 0000000F ??                          	 resb 1
 27212 00000010 ??                      	 resb 1
 27213 00000011 ??                       .TimeF: resb 1	 
 27214 00000012 ????????                	 resw 2
 27215 00000016 ????                    	 resb 2
 27216 00000018 <res Ah>                	 resw 5
 27217                                   .size:
 27218                                  endstruc
 27219                                  
 27220                                  _$P_Date_MDY	   equ	0		;AN000;
 27221                                  _$P_Date_DMY	   equ	1		;AN000;
 27222                                  _$P_Date_YMD	   equ	2		;AN000;
 27223                                  ;-------------
 27224                                  _$P_DOS_GetEV	   equ	6300h		;AN000; get DBCS EV call
 27225                                  					;AN000; DS:SI will points to DBCS EV
 27226                                  ;-------------
 27227                                  _$P_DOS_Get_TBL	   equ	65h		;AN000; get uppercase table call
 27228                                  					;AN000; following parameters are set
 27229                                  					;AN000; to get casemap table.
 27230                                  _$P_DOSTBL_Def	   equ	-1		;AN000; get default
 27231                                  _$P_DOSTBL_BL	   equ	5		;AN000; buffer length for Tbl pointer
 27232                                  _$P_DOSTBL_File	   equ	4		;AN000; get file uppercase table
 27233                                  _$P_DOSTBL_Char	   equ	2		;AN000; get character uppercase table
 27234                                  					; By this call following information
 27235                                  					; is returned.
 27236                                  struc _$P_DOS_TBL
 27237 00000000 ??                       .InfoID: resb 1			;AN000; information id for the table
 27238 00000001 ????                     .Off:	 resw 1				;AN000; offset address of the table
 27239 00000003 ????                     .Seg:	 resw 1				;AN000; segment address of the table
 27240                                  endstruc
 27241                                  
 27242                                  ; ----------------------------------------------------------------------------
 27243                                  ; PARMS 	LABEL	BYTE
 27244                                  ;		DW	PARMSX
 27245                                  ;		DB	2		; NUMBER OF STRINGS (0, 1, 2)
 27246                                  ;		DB	length		; LENGTH OF THE NEXT LIST, 0 IF NONE
 27247                                  ;		DB	" .. "          ; EXTRA DELIMITER LIST,
 27248                                  ;					; TYPICAL ARE ";", "="
 27249                                  ;					; "," & WHITESPACE ALWAYS
 27250                                  ;		DB	length		; LENGTH OF THE NEXT LIST, 0 IF NONE
 27251                                  ;		DB	" .. "          ; EXTRA END OF LINE LIST, CR, LF OR 0 ALWAYS
 27252                                  ; ----------------------------------------------------------------------------
 27253                                  
 27254                                  ;-------------------------------- PARMS block structure
 27255                                  struc _$P_PARMS_Blk
 27256 00000000 ????                     .PARMSX_Address:  resw 1		;AN000; Address of PARMSX
 27257 00000002 ??                       .Num_Extra:	   resb 1		;AN000; Number of extra stuff
 27258 00000003 ??                       .Len_Extra_Delim: resb 1		;AN000; Length of extra delimiter
 27259                                  endstruc
 27260                                  
 27261                                  _$P_Len_PARMS	   equ	4		;AN000;
 27262                                  _$P_I_Use_Default  equ	0		;AN000; no extra stuff specified
 27263                                  _$P_I_Have_Delim   equ	1		;AN000; extra delimiter specified
 27264                                  _$P_I_Have_EOL	   equ	2		;AN000; extra EOL specified
 27265                                  
 27266                                  ; ----------------------------------------------------------------------------
 27267                                  ; PARMSX	LABEL	BYTE
 27268                                  ;		DB	minp,maxp	; MIN, MAX POSITIONAL OPERANDS ALLOWED
 27269                                  ;		DW	CONTROL 	; DESCRIPTION OF POSITIONAL 1
 27270                                  ;		:			; REPEATS maxp-1 TIMES
 27271                                  ;		DB	maxs		; # OF SWITCHES
 27272                                  ;		DW	CONTROL 	; DESCRIPTION OF SWITCH 1
 27273                                  ;		:			; REPEATS maxs-1 TIMES
 27274                                  ;		DB	maxk		; # OF KEYWORD
 27275                                  ;		DW	CONTROL 	; DESCRIPTION OF KEYWORD 1
 27276                                  ;		:			; REPEATS maxk-1 TIMES
 27277                                  ; ----------------------------------------------------------------------------
 27278                                  
 27279                                  ;-------------------------------- PARMSX block structure
 27280                                  struc _$P_PARMSX_Blk		;AN000;
 27281 00000000 ??                       .MinP: resb 1			;AN000; Minimum positional number
 27282 00000001 ??                       .MaxP:	resb 1			;AN000; Maximum positional number
 27283 00000002 ????                     .1st_Control: resw 1		;AN000; Address of the 1st CONTROL block
 27284                                  endstruc
 27285                                  
 27286                                  ; ----------------------------------------------------------------------------
 27287                                  ; << Control field definition  >>
 27288                                  ;
 27289                                  ;
 27290                                  ;CONTROL   LABEL   BYTE
 27291                                  ;	   DW	   MATCH_FLAGS	   ; CONTROLS TYPE MATCHED
 27292                                  ;				   ; 8000H=NUMERIC VALUE, (VALUE LIST WILL BE CHECKED)
 27293                                  ;				   ; 4000H=SIGNED NUMERIC VALUE (VALUE LIST WILL BE CHECKED)
 27294                                  ;				   ; 2000H=SIMPLE STRING(VALUE LIST WILL BE CHECKED)
 27295                                  ;				   ; 1000H=DATE STRING (VALUE LIST WON'T BE CHECKED)
 27296                                  ;				   ; 0800H=TIME STRING (VALUE LIST WON'T BE CHECKED)
 27297                                  ;				   ; 0400H=COMPLEX LIST (VALUE LIST WON'T BE CHECKED)
 27298                                  ;				   ; 0200H=FILE SPEC (VALUE LIST WON'T BE CHECKED)
 27299                                  ;				   ; 0100H=DRIVE ONLY (VALUE LIST WON'T BE CHECKED)
 27300                                  ;				   ; 0080H=QUOTED STRING (VALUE LIST WON'T BE CHECKED)
 27301                                  ;				   ; 0010H=IGNORE ":" AT END IN MATCH
 27302                                  ;				   ; 0002H=REPEATS ALLOWED
 27303                                  ;				   ; 0001H=OPTIONAL
 27304                                  ;	   DW	   FUNCTION_FLAGS
 27305                                  ;				   ; 0001H=CAP RESULT BY FILE TABLE
 27306                                  ;				   ; 0002H=CAP RESULT BY CHAR TABLE
 27307                                  ;				   ; 0010H=REMOVE ":" AT END
 27308                                  ; (tm10)			   ; 0020H=colon is not necessary for switch
 27309                                  ;	   DW	   RESULT	   ; RESULT BUFFER
 27310                                  ;	   DW	   VALUES	   ; VALUE LISTS
 27311                                  ;	   DB	   nid		   ; NUMBER OF KEYWORD/SWITCH SYNONYMS IN FOLLOWING LIST
 27312                                  ;	   DB	   "...",0         ; IF n >0, KEYWORD 1
 27313                                  ;	   :
 27314                                  ;
 27315                                  ;Note:
 27316                                  ;    - The MATCH_FLAG is bit significant. You can set, for example, TIME bit and
 27317                                  ;      DATE bit simalteniously.
 27318                                  ;
 27319                                  ;      The parser examins each bit along with the following priority.
 27320                                  ;
 27321                                  ;      COMPLEX -> DATE -> TIME -> NUMERIC VAL -> SIGNED NUMERIC VAL -> DRIVE ->
 27322                                  ;      FILE SPEC -> SIMPLE STRING.
 27323                                  ;
 27324                                  ;    - When the FUNCTION_FLAG is 0001 or 0002, the STRING pointed to by a pointer
 27325                                  ;      in the result buffer is capitalized.
 27326                                  ;
 27327                                  ;    - Match_Flags 0001H and 0002H have meaning only for the positional.
 27328                                  ;
 27329                                  ;    - The "...",0 (bottom most line) does require '=' or '/'. When you need a
 27330                                  ;      switch, for example, '/A', then STRING points to;
 27331                                  ;
 27332                                  ;			DB    1 	; number of following synonyms
 27333                                  ;			DB   '/A',0
 27334                                  ;
 27335                                  ;      When you need a keyword, for example, 'CODEPAGE=', then "...",0 will be;
 27336                                  ;
 27337                                  ;			DB    1 	; number of following synonyms
 27338                                  ;			DB   'CODEPAGE=',0
 27339                                  ;
 27340                                  ;    - "..." must consist of upper case characters only because the parser
 27341                                  ;      performs pattern matching after converting input to upper case (by
 27342                                  ;      using the current country upper case table)
 27343                                  ;
 27344                                  ;    - One "..." can contain only one switch or keyword. If you need, for
 27345                                  ;      example /A and /B, the format will be;
 27346                                  ;
 27347                                  ;			DB    2 	; number of following synonyms
 27348                                  ;			DB    '/A',0
 27349                                  ;			DB    '/B',0
 27350                                  ; ----------------------------------------------------------------------------
 27351                                  
 27352                                  ;**** Match_Flags
 27353                                  
 27354                                  _$P_Num_Val	   equ	8000h		;AN000; Numeric Value
 27355                                  _$P_SNum_Val	   equ	4000h		;AN000; Signed numeric value
 27356                                  _$P_Simple_S	   equ	2000h		;AN000; Simple string
 27357                                  _$P_Date_S	   equ	1000h		;AN000; Date string
 27358                                  _$P_Time_S	   equ	0800h		;AN000; Time string
 27359                                  _$P_Cmpx_S	   equ	0400h		;AN000; Complex string
 27360                                  _$P_File_Spc	   equ	0200h		;AN000; File Spec
 27361                                  _$P_Drv_Only	   equ	0100h		;AN000; Drive Only
 27362                                  _$P_Qu_String	   equ	0080h		;AN000; Quoted string
 27363                                  _$P_Ig_Colon	   equ	0010h		;AN000; Ignore colon at end in match
 27364                                  _$P_Repeat	   equ	0002h		;AN000; Repeat allowed
 27365                                  _$P_Optional	   equ	0001h		;AN000; Optional
 27366                                  
 27367                                  ;**** Function flags
 27368                                  
 27369                                  _$P_CAP_File	   equ	0001h		;AN000; CAP result by file table
 27370                                  _$P_CAP_Char	   equ	0002h		;AN000; CAP result by character table
 27371                                  _$P_Rm_Colon	   equ	0010h		;AN000; Remove ":" at the end
 27372                                  _$P_colon_is_not_necessary equ 0020h	;AN000;(tm10) /+10 and /+:10
 27373                                  
 27374                                  ;-------------------------------- Control block structure
 27375                                  struc _$P_Control_Blk
 27376 00000000 ????                     .Match_Flag:	 resw 1		;AN000; Controls type matched
 27377 00000002 ????                     .Function_Flag: resw 1		;AN000; Function should be taken
 27378 00000004 ????                     .Result_Buf:	 resw 1		; Result buffer address
 27379 00000006 ????                     .Value_List:	 resw 1		;AN000; Value list address
 27380 00000008 ??                       .nid:		 resb 1		;AN000; # of keyword/SW synonyms
 27381 00000009 ??                       .KEYorSW:	 resb 1		;AN000; keyword or sw
 27382                                  endstruc
 27383                                  
 27384                                  ; ----------------------------------------------------------------------------
 27385                                  ; << Value List Definition >>
 27386                                  ;
 27387                                  ;VALUES 	LABEL	BYTE
 27388                                  ;		DB	nval			; NUMBER OF VALUE DEFINITIONS (0 - 3)
 27389                                  ;	     +-
 27390                                  ;	     |	DB	nrng			; NUMBER OF RANGES
 27391                                  ;	     | +DB	ITEM_TAG		; RETURN VALUE IF RANGE MATCHED
 27392                                  ;	     | +DD	X,Y			; RANGE OF VALUES
 27393                                  ;	     |	:
 27394                                  ;	     |	DB	nnval			; NUMBER OF CHOICES
 27395                                  ;	     | +DB	ITEM_TAG		; RETURN VALUE IF NUMBER CHOICE MATCHED
 27396                                  ;	     | +DD	VALUE			; SPECIFIC CHOICE IF NUMBER
 27397                                  ;	     |	:
 27398                                  ;	     |	DB	nstrval 		; NUMBER OF CHOICES
 27399                                  ;	     | +DB	ITEM_TAG		; RETURN VALUE IF STRING CHOICE MATCHED
 27400                                  ;	     | +DW	STRING			; SPECIFIC CHOICE IF STING
 27401                                  ;	     +-	:
 27402                                  ;
 27403                                  ;STRING 	DB	"...",0                 ; ASCIIZ STRING IMAGE
 27404                                  ;
 27405                                  ;Note:
 27406                                  ;    - ITEM_TAG must not be 0FFH, which will be used in the result buffer
 27407                                  ;      when no choice lists are provided.
 27408                                  ;
 27409                                  ;    - STRING must consist of upper case characters only because the parser
 27410                                  ;      performs pattern matching after converting input to upper case (by
 27411                                  ;      using the current country upper case table)
 27412                                  ; ----------------------------------------------------------------------------
 27413                                  
 27414                                  _$P_nval_None	   equ	0		;AN000; no value list ID
 27415                                  _$P_nval_Range	   equ	1		;AN000; range list ID
 27416                                  _$P_nval_Value	   equ	2		;AN000; value list ID
 27417                                  _$P_nval_String	   equ	3		;AN000; string list ID
 27418                                  _$P_Len_Range	   equ	9		;AN000; Length of a range choice(two DD plus one DB)
 27419                                  _$P_Len_Value	   equ	5		;AN000; Length of a value choice(one DD plus one DB)
 27420                                  _$P_Len_String	   equ	3		;AN000; Length of a string choice(one DW plus one DB)
 27421                                  _$P_No_nrng	   equ	0		;AN000; (tm07) no nrng. nnval must not be 0.
 27422                                  
 27423                                  struc _$P_Val_List
 27424 00000000 ??                       .NumofList: resb 1			;AN000; number of following choice
 27425 00000001 ????                     .Val_XL:    resw 1			;AN000; lower word of value
 27426 00000003 ????                     .Val_XH:    resw 1			;AN000; higher word of value
 27427 00000005 ????                     .Val_YL:    resw 1			;AN000; lower word of another value
 27428 00000007 ????                     .Val_YH:    resw 1			;AN000; higher word of another value
 27429                                  endstruc
 27430                                  
 27431                                  ; ----------------------------------------------------------------------------
 27432                                  ; << Result Buffer Definition  >>
 27433                                  ;
 27434                                  ;RESULT 	LABEL	BYTE			; BELOW FILLED IN FOR DEFAULTS
 27435                                  ;		DB	type			; TYPE RETURNED: 0=RESERVED,
 27436                                  ;						;	1=NUMBER, 2=LIST INDEX,
 27437                                  ;						;	3=STRING, 4=COMPLEX,
 27438                                  ;						;	5=FILESPEC, 6=DRIVE
 27439                                  ;						;	7=DATE, 8=TIME
 27440                                  ;						;	9=QUOTED STRING
 27441                                  ;		DB	ITEM_TAG		; MATCHED ITEM TAG
 27442                                  ;
 27443                                  ;		dw	synonym@		; es:@ points to found SYNONYM if provided.
 27444                                  ;
 27445                                  ;            +-
 27446                                  ;	    | DD	n			; VALUE IF NUMBER
 27447                                  ;	    | or
 27448                                  ;	    |	DW	i			; INDEX (OFFSET) INTO VALUE LIST
 27449                                  ;	    |					; (ES presents Segment address)
 27450                                  ;	    | or
 27451                                  ;	    |	DD	STRING			; OFFSET OF STRING VALUE
 27452                                  ;	    | or
 27453                                  ;	    |	DB	drv			; DRIVE NUMBER (1-A, 2-B,..., 26-Z)
 27454                                  ;	    | or
 27455                                  ;	    |	DW	YEAR	   ;(1980-2099)  IN CASE OF DATE
 27456                                  ;	    |	DB	MONTH	   ;(1-12)	 Note: Range check is not performed.
 27457                                  ;	    |	DB	DATE	   ;(1-31)	       0 is filled when the corresponding field was not specified.
 27458                                  ;	    | or
 27459                                  ;	    |	DB	HOUR	   ;(0-23)	  IN CASE OF TIME
 27460                                  ;	    |	DB	MINUTES    ;(0-59)	  Note: Range check is not performed .
 27461                                  ;	    |	DB	SECONDS    ;(0-59)		0 is filled when the corresponding field was not specified .
 27462                                  ;	    |	DB	HUNDREDTHS ;(0-99)
 27463                                  ;	    +-
 27464                                  ;
 27465                                  ;
 27466                                  ;Note: ITEM_TAG is 0FFH when the caller does not specify the choice
 27467                                  ;      list.
 27468                                  ;
 27469                                  ;      YEAR: If the input value for the year is less than 100, parser
 27470                                  ;	     adds 1900 to it.  For example, when 87 is input to parser for
 27471                                  ;	     the year value, he returns 1987.
 27472                                  ; ----------------------------------------------------------------------------
 27473                                  
 27474                                  ;-------------------------------- Result block structure
 27475                                  struc _$P_Result_Blk
 27476 00000000 ??                       .Type:        resb 1		;AN000; Type returned
 27477 00000001 ??                       .Item_Tag:    resb 1		;AN000; Matched item tag
 27478 00000002 ????                     .SYNONYM_Ptr: resw 1		;AN000; pointer to Synonym list returned
 27479 00000004 ????????                 .Picked_Val:  resb 4		;AN000; value
 27480                                  endstruc
 27481                                  
 27482                                  ;--------------------------------
 27483                                  ;**** values for the type field in the result block
 27484                                  
 27485                                  _$P_EOL		   equ	0		;AN000; End of line
 27486                                  _$P_Number	   equ	1		;AN000; Number
 27487                                  _$P_List_Idx	   equ	2		;AN000; List Index
 27488                                  _$P_String	   equ	3		;AN000; String
 27489                                  _$P_Complex	   equ	4		;AN000; Complex
 27490                                  _$P_File_Spec	   equ	5		;AN000; File Spec
 27491                                  _$P_Drive	   equ	6		;AN000; Drive
 27492                                  _$P_Date_F	   equ	7		;AN000; Date
 27493                                  _$P_Time_F	   equ	8		;AN000; Time
 27494                                  _$P_Quoted_String  equ	9		;AN000; Quoted String
 27495                                  
 27496                                  _$P_No_Tag	   equ	0FFh		;AN000; No ITEM_TAG found
 27497                                  
 27498                                  ;**** Return code
 27499                                  ;
 27500                                  ; following return code will be returned in the AX register.
 27501                                  
 27502                                  _$P_No_Error	   equ	0		;AN000; No error
 27503                                  _$P_Too_Many	   equ	1		;AN000; Too many operands
 27504                                  _$P_Op_Missing	   equ	2		;AN000; Required operand missing
 27505                                  _$P_Not_In_SW	   equ	3		;AN000; Not in switch list provided
 27506                                  _$P_Not_In_Key	   equ	4		;AN000; Not in keyword list provided
 27507                                  _$P_Out_Of_Range   equ	6		;AN000; Out of range specified
 27508                                  _$P_Not_In_Val	   equ	7		;AN000; Not in value list provided
 27509                                  _$P_Not_In_Str	   equ	8		;AN000; Not in string list provided
 27510                                  _$P_Syntax	   equ	9		;AN000; Syntax error
 27511                                  _$P_RC_EOL	   equ	-1		;AN000; End of command line
 27512                                  
 27513                                  ; DATA - Retro DOS v4.0 - 27/03/2019
 27514                                  
 27515                                  ; MSDOS 6.2 IO.SYS SYSINIT:179Ch
 27516                                  
 27517                                  ;********************** Local Data *************************************
 27518 000014BE 0000                    _$P_ORDINAL:	   dw	0		;AN000; Operand ordinal save area
 27519 000014C0 0000                    _$P_RC:		   dw	0		;AN000; Return code from parser
 27520 000014C2 0000                    _$P_SI_Save:	   dw	0		;AN000; Pointer of command buffer
 27521 000014C4 0000                    _$P_DX:		   dw	0		;AN000; Return result buffer address
 27522 000014C6 00                      _$P_Terminator:	   db	0		;AN000; Terminator code (ASCII)
 27523 000014C7 0000                    _$P_DBCSEV_OFF:	   dw	0		;AN000; Offset of DBCS EV
 27524 000014C9 0000                    _$P_DBCSEV_SEG:	   dw	0		;AN000; Segment of DBCS EV
 27525 000014CB 0000                    _$P_Flags:	   dw	0		;AN000; Parser internal flags
 27526                                  %define _$P_Flags1 _$P_Flags		;AN038; to reference first byte flags
 27527                                  %define _$P_Flags2 _$P_Flags+1		;AN038; to reference second byte flags only
 27528                                  
 27529                                  ;in second byte of _$P_Flags, referenced as _$P_Flags2:
 27530                                  _$P_equ		   equ	01h	      ;AN000; "=" packed in string buffet
 27531                                  _$P_Neg		   equ	02h	      ;AN000; Negative value
 27532                                  _$P_Time12	   equ	04h	      ;AN000; set when PM is specified
 27533                                  _$P_Key_Cmp	   equ	08h	      ;AN000; set when keyword compare
 27534                                  _$P_SW_Cmp	   equ	10h	      ;AN000; set when switch compare
 27535                                  _$P_Extra	   equ	20h	      ;AN000; set when extra delimiter found
 27536                                  _$P_SW		   equ	40h	      ;AN000; set when switch found (tm08)
 27537                                  _$P_Signed	   equ	80h	      ;AN000; signed numeric specified
 27538                                  
 27539                                  ;in first byte of _$P_Flags, referenced as _$P_Flags1:
 27540                                  _$P_time12am	   equ	01h	      ;AN038; set when AM is specified on time
 27541                                  _$P_TIME_AGAIN	   equ	02h	      ;AN039; SET WHEN READY TO RE-PARSE TIME
 27542                                  
 27543 000014CD 0000                    _$P_SaveSI_Cmpx:   dw	0		;AN000; save si for later use by complex
 27544 000014CF 0000                    _$P_KEYorSW_Ptr:   dw	0		;AN000; points next to "=" or ":" code
 27545 000014D1 0000                    _$P_Save_EOB:	   dw	0		;AN000; save pointer to EOB
 27546 000014D3 0000                    _$P_Found_SYNONYM: dw	0		;AN000; es:@ points to found synonym
 27547                                  
 27548 000014D5 00<rep 80h>             _$P_STRING_BUF:	   times 128 db 0	;AN000; Pick a operand from command line
 27549                                  _$P_STRING_BUF_END equ	$		;AN000;
 27550                                  
 27551                                  ; 25/10/2022
 27552                                  ; (MSDOS 5.0 IO.SYS, SYSINIT:16F8h)
 27553                                  
 27554 00001555 FF                      _$P_Char_CAP_Ptr:  db	0FFh		;AN000; info id
 27555 00001556 0000                    		   dw	0		;AN000; offset	of char case map table
 27556 00001558 0000                    		   dw	0		;AN000; segment of char case map table
 27557                                  ; 25/10/2022
 27558                                  ;IF CAPSW
 27559                                  ;_$P_File_CAP_Ptr: db	0FFh		;AN000; info id
 27560                                  ;		   dw	0		;AN000; offset	of file case map table
 27561                                  ;		   dw	0		;AN000; segment of file case map table
 27562                                  ;ENDIF
 27563                                  
 27564                                  ; (tm06) IF FileSW			;AN000;(Check if file spec is supported)
 27565                                  ;
 27566                                  
 27567                                  ;M029
 27568                                  ;!!!WARNING!!!
 27569                                  ; In routine SYSPARSE (parse.asm), _$P_FileSp_Char is reinitialized using 
 27570                                  ;hardcoded strings. If the chars in the string are changed here, corresponding
 27571                                  ;changes need to be made in SYSPARSE
 27572                                  
 27573                                  ;IF FileSW+DrvSW 			;AN000;(Check if file spec is supported)
 27574                                  
 27575                                  ; 25/10/2022
 27576                                  ; (MSDOS 5.0 IO.SYS, SYSINIT:16FDh)
 27577                                  
 27578 0000155A 5B5D7C3C3E2B3D3B22      _$P_FileSp_Char	   db	'[]|<>+=;"'     ;AN000; delimitter of file spec
 27579                                  _$P_FileSp_Len	   equ	$-_$P_FileSp_Char ;AN000;
 27580                                  
 27581                                  ;ENDIF					;AN000;(of FileSW)
 27582                                  
 27583                                  ; delimiter parsing
 27584                                  _$P_colon_period   equ	01h		;AN032; check for colon & period
 27585                                  _$P_period_only	   equ	02h		;AN032; check only for period
 27586                                  
 27587                                  ;filespec error flag
 27588 00001563 00                      _$P_err_flag:	   db	0		;AN033; flag set if filespec parsing error
 27589                                  					;AN033;  was detected.
 27590                                  _$P_error_filespec equ	01h		;AN033; mask to set flag
 27591                                  
 27592                                  
 27593                                  ; PARSE.ASM - MSDOS 6.0 - 1991
 27594                                  ; ======================================================================
 27595                                  ; 27/03/2019 - Retro DOS v4.0
 27596                                  
 27597                                  ;***********************************************************************
 27598                                  ; SysParse;
 27599                                  ;
 27600                                  ;  Function : Parser Entry
 27601                                  ;
 27602                                  ;  Input: DS:SI -> command line
 27603                                  ;	  ES:DI -> parameter block
 27604                                  ;	  cs -> psdata.inc
 27605                                  ;	  CX = operand ordinal
 27606                                  ;
 27607                                  ;	  Note:  ES is the segment containing all the control blocks defined
 27608                                  ;		 by the caller, except for the DOS COMMAND line parms, which
 27609                                  ;		 is in DS.
 27610                                  ;
 27611                                  ;  Output: CY = 1   error of caller, means invalid parameter block or
 27612                                  ;		    invalid value list. But this parser does NOT implement
 27613                                  ;		    this feature. Therefore CY always zero.
 27614                                  ;
 27615                                  ;	   CY = 0   AX = return code
 27616                                  ;		    BL = terminated delimiter code
 27617                                  ;		    CX = new operand ordinal
 27618                                  ;		    SI = set past scaned operand
 27619                                  ;		    DX = selected result buffer
 27620                                  ;
 27621                                  ; Use:	_$P_Skip_Delim, _$P_Chk_EOL, _$P_Chk_Delim, _$P_Chk_DBCS
 27622                                  ;	_$P_Chk_Swtch, _$P_Chk_Pos_Control, _$P_Chk_Key_Control
 27623                                  ;	_$P_Chk_Sw_Control, _$P_Fill_Result
 27624                                  ;
 27625                                  ; Vars: _$P_Ordinal(RW), _$P_RC(RW), _$P_SI_Save(RW), _$P_DX(R), _$P_Terminator(R)
 27626                                  ;	_$P_SaveSI_Cmpx(W), _$P_Flags(RW), _$P_Found_SYNONYM(R), _$P_Save_EOB(W)
 27627                                  ;
 27628                                  ;-------- Modification History -----------------------------------------
 27629                                  ;
 27630                                  ;  4/04/87 : Created by K. K,
 27631                                  ;  4/28/87 : _$P_Val_YH assemble error (tm01)
 27632                                  ;	   : JMP SHORT assemble error (tm02)
 27633                                  ;  5/14/87 : Someone doesn't want to include psdata (tm03)
 27634                                  ;  6/12/87 : _$P_Bridge is missing when TimeSw equ 0 and (CmpxSw equ 1 or
 27635                                  ;	     DateSW equ 1)	      (tm04)
 27636                                  ;  6/12/87 : _$P_SorD_Quote is missing when QusSw equ 0 and CmpxSW equ 1
 27637                                  ;				      (tm05) in PSDATA.INC
 27638                                  ;  6/12/87 : _$P_FileSp_Char and _$P_FileSP_Len are missing
 27639                                  ;	     when FileSW equ 0 and DrvSW equ 1 (tm06) in PSDATA.INC
 27640                                  ;  6/18/87 : $VAL1 and $VAL3, $VAL2 and $VAL3 can be used in the same
 27641                                  ;	     value-list block	      (tm07)
 27642                                  ;  6/20/87 : Add _$P_SW to check if there's an omiting parameter after
 27643                                  ;	     switch (keyword) or not. If there is, backup si for next call
 27644                                  ;	     (tm08)
 27645                                  ;  6/24/87 : Complex Item checking does not work correctly when CmpSW equ 1
 27646                                  ;	     and DateSW equ 0 and TimeSW equ 0 (tm09)
 27647                                  ;  6/24/87 : New function flag _$P_colon_is_not_necessary for switch
 27648                                  ;	     /+15 and /+:15 are allowed for user (tm10)
 27649                                  ;  6/29/87 : ECS call changes DS register but it causes the address problem
 27650                                  ;	     in user's routines. _$P_Chk_DBCS (tm11)
 27651                                  ;  7/10/87 : Switch with no_match flag (0x0000H) does not work correctly
 27652                                  ;					  (tm12)
 27653                                  ;  7/10/87 : Invalid switch/keyword does not work correctly
 27654                                  ;					  (tm13)
 27655                                  ;  7/10/87 : Drive_only breaks 3 bytes after the result buffer
 27656                                  ;					  (tm14)
 27657                                  ;  7/12/87 : Too_Many_Operands sets DX=0 as the PARSE result
 27658                                  ;					  (tm15)
 27659                                  ;  7/24/87 : Negative lower bound on numeric ranges cause trouble
 27660                                  
 27661                                  ;  7/24/87 : Quoted strings being returned with quotes.
 27662                                  
 27663                                  ;  7/28/87 : Kerry S (;AN018;)
 27664                                  ;	     Non optional value on switch (match flags<>0 and <>1) not flagged
 27665                                  ;	     as an error when missing.	Solution: return error 2.  Modules
 27666                                  ;	     affected: _$P_Chk_SW_Control.
 27667                                  
 27668                                  ;  7/29/87 : Kerry S (;AN019;)
 27669                                  ;	     Now allow the optional bit in match flags for switches.  This
 27670                                  ;	     allows the switch to be encountered with a value or without a
 27671                                  ;	     value and no error is returned.
 27672                                  ;
 27673                                  
 27674                                  ;  8/28/87 : Ed K, Kerry S (;AN020;)
 27675                                  ;  9/14/87   In PROC _$P_Get_DecNum, when checking for field separators
 27676                                  ;	     within a date response, instead of checking just for the one
 27677                                  ;	     character defined by the COUNTRY DEPENDENT INFO, check for
 27678                                  ;	     all three chars, "-", "/", and ".". Change _$P_Chk_Switch to allow
 27679                                  ;	     slashes in date strings when DateSw (assembler switch) is set.
 27680                                  
 27681                                  ;  9/1/87  : Kerry S (;AN021)
 27682                                  ;	     In PROC _$P_String_Comp, when comparing the switch or keyword on
 27683                                  ;	     the command line with the string in the control block the
 27684                                  ;	     comparing was stopping at a colon (switch) or equal (keyword)
 27685                                  ;	     on the command line and assuming a match.	This allowed a shorter
 27686                                  ;	     string on the command line than in the synonym list in the control
 27687                                  ;	     block.  I put in a test for a null in the control block so the
 27688                                  ;	     string in the control block must be the same length as the string
 27689                                  ;	     preceeding the colon or equal on the command line.
 27690                                  
 27691                                  ;  8/28/87 : Kerry S (;AN022;)
 27692                                  ;	     All references to data in PSDATA.INC had CS overrides.  This caused
 27693                                  ;	     problems for people who included it themselves in a segment other
 27694                                  ;	     than CS.  Added switch to allow including PSDATA.INC in any
 27695                                  ;	     segment.
 27696                                  
 27697                                  ;  9/16/87 : Ed K (;AN023;) PTM1040
 27698                                  ;	     in _$P_set_cdi PROC, it assumes CS points to psdata. Change Push CS
 27699                                  ;	     into PUSH cs.  In _$P_Get_DecNum PROC, fix AN020
 27700                                  ;	     forced both TIME and DATE to use the delims, "-","/",".".
 27701                                  ;	     Created FLag, in _$P_time_Format PROC, to request the delim in
 27702                                  ;	     BL be used if TIME is being parsed.
 27703                                  
 27704                                  ;  9/24/87 : Ed K
 27705                                  ;	     Removed the include to STRUC.INC.	Replaced the STRUC macro
 27706                                  ;	     invocations with their normally expanded code; made comments
 27707                                  ;	     out of the STRUC macro invocation statements to maintain readability.
 27708                                  
 27709                                  ;  9/24/87 : Ed K (;AN024;) PTM1222
 27710                                  ;	     When no CONTROL for a keyword found, tried to fill in RESULT
 27711                                  ;	     pointed to by non-existant CONTROL.
 27712                                  
 27713                                  ; 10/15/87 : Ed K (;AN025;) PTM1672
 27714                                  ;	     A quoted text string can be framed only by double quote.  Remove
 27715                                  ;	     support to frame quoted text string with single quote.
 27716                                  ;	     (apostrophe) _$P_SorD_Quote is removed from PSDATA.INC.
 27717                                  ;	     _$P_SQuote EQU also removed from PSDATA.INC.  Any references to
 27718                                  ;	     single quote in PROC prologues are left as is for history reasons.
 27719                                  
 27720                                  ;	     This fixes another bug, not mentioned in p1672, in that two
 27721                                  ;	     quote chars within a quoted string is supposed to be reported as
 27722                                  ;	     one quote character, but is reported as two quotes.  This changed
 27723                                  ;	     two instructions in PROC _$P_Quoted_Str.
 27724                                  
 27725                                  ;	     Also fixed are several JMP that caused a NOP, these changed to
 27726                                  ;	     have the SHORT operator to avoid the unneeded NOP.
 27727                                  
 27728                                  ;	     The code and PSDATA.INC have been aligned for ease of reading.
 27729                                  
 27730                                  ; 10/26/87 : Ed K (;AN026;) PTM2041, DATE within SWITCH, BX reference to
 27731                                  ;	     psdata buffer should have cs.
 27732                                  
 27733                                  ; 10/27/87 : Ed K (;AN027;) PTM2042 comma between keywords implies
 27734                                  ;	     positional missing.
 27735                                  
 27736                                  ; 11/06/87 : Ed K (;AN028;) PTM 2315 Parser should not use line feed
 27737                                  ;	     as a line delimiter, should use carriage return.
 27738                                  ;	     Define switch: LFEOLSW, if on, accept LF as end of line char.
 27739                                  
 27740                                  ; 11/11/87 : Ed K (;AN029;) PTM 1651 GET RID OF WHITESPACE AROUND "=".
 27741                                  
 27742                                  ; 11/18/87 : Ed K (;AN030;) PTM 2551 If filename is just "", then
 27743                                  ;	     endless loop since SI is returned still pointing to start
 27744                                  ;	     of that parm.
 27745                                  
 27746                                  ; 11/19/87 : Ed K (;AN031;) PTM 2585 date & time getting bad values.
 27747                                  ;	     Vector to returned string has CS instead of cs, but
 27748                                  ;	     when tried to fix it on previous version, changed similar
 27749                                  ;	     but wrong place.
 27750                                  
 27751                                  ; 12/09/87 : Bill L (;AN032;) PTM 2772 colon and period are now valid
 27752                                  ;	     delimiters between hours, minutes, seconds for time. And period
 27753                                  ;	     and comma are valid delimiters between seconds and 100th second.
 27754                                  
 27755                                  ; 12/14/87 : Bill L (;AN033;) PTM 2722 if illegal delimiter characters
 27756                                  ;	     in a filespec, then flag an error.
 27757                                  
 27758                                  ; 12/22/87 : Bill L (;AN034;)	    All local data to parser is now
 27759                                  ;	     indexed off of the cs equate instead of the DS register.
 27760                                  ;	     Using this method, DS can point to the segment of PSP or to psdata
 27761                                  ;  -->	     local parser data. Why were some references to local data changed
 27762                                  ;	     to do this before, but not all ?????
 27763                                  
 27764                                  ; 02/02/88 : Ed K (;AC035;) INSPECT utility, suggests optimizations.
 27765                                  
 27766                                  ; 02/05/88 : Ed K (;AN036;) P3372-UPPERCASE TRANSLATION, cs HOSED.
 27767                                  ;
 27768                                  ; 02/08/88 : Ed K (;AN037;) P3410-AVOID POP OF CS, CHECK BASESW FIRST.
 27769                                  
 27770                                  ; 02/19/88 : Ed K (;AN038;) p3524 above noon and "am" should be error
 27771                                  
 27772                                  ; 02/23/88 : Ed K (;AN039;) p3518 accept "comma" and "period" as decimal
 27773                                  ;	     separator in TIME before hundredths field.
 27774                                  ;
 27775                                  ; 08/09/90 : SA	M005	Prevented parser from recognizing '=' signs within
 27776                                  ;			strings as keywords.
 27777                                  ;
 27778                                  ;***********************************************************************
 27779                                  
 27780                                  ;IF FarSW				;AN000;(Check if need far return)
 27781                                  ;SysParse proc far			;AN000;
 27782                                  ;ELSE					;AN000;
 27783                                  ;SysParse proc near			;AN000;
 27784                                  ;ENDIF					;AN000;(of FarSW)
 27785                                  
 27786                                  ; 27/03/2019 - Retro DOS v4.0
 27787                                  ; (MSDOS 6.21 IO.SYS - SYSINIT:1842h)
 27788                                  
 27789                                  ; 25/10/2022 - Retro DOS v4.0
 27790                                  ; (MSDOS 5.0 IO.SYS - SYSINIT:1707h)
 27791                                  
 27792                                  ; 06/09/2023 - Retro DOS v4.2 IO.SYS Optimization (& Retro DOS v5.0 pre-work)
 27793                                  ; (PCDOS 7.1 IBMBIO.COM - SYSINIT:1D08h)
 27794                                  
 27795                                  SysParse:
 27796                                  	; 06/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 27797                                  	; dx = 0
 27798 00001564 1E                      	push	ds ; *!*
 27799 00001565 0E                      	push	cs
 27800 00001566 1F                      	pop	ds 
 27801                                  
 27802                                  	;mov	word [cs:_$P_Flags],0	;AC034; Clear all internal flags
 27803                                  	;cld				;AN000; confirm forward direction
 27804                                  	;mov	word [cs:_$P_ORDINAL],cx ;AC034; save operand ordinal
 27805                                  	;mov	word [cs:_$P_RC],_$P_No_Error ;AC034; Assume no error
 27806                                  	;mov	word [cs:_$P_Found_SYNONYM],0 ;AC034; initalize synonym pointer
 27807                                  	;
 27808                                  	;mov	word [cs:_$P_DX],0	;AC034; (tm15)
 27809                                  
 27810                                  	; 06/09/2023
 27811 00001567 8916[CB14]              	mov	[_$P_Flags],dx ; 0	;AC034; Clear all internal flags
 27812 0000156B FC                      	cld				;AN000; confirm forward direction
 27813 0000156C 890E[BE14]              	mov	[_$P_ORDINAL],cx	;AC034; save operand ordinal
 27814 00001570 8916[C014]              	mov	[_$P_RC],dx ; $P_No_Error ;AC034; Assume no error
 27815 00001574 8916[D314]              	mov	[_$P_Found_SYNONYM],dx	; 0 ;AC034; initalize synonym pointer
 27816 00001578 8916[C414]              	mov	[_$P_DX],dx ; 0		;AC034; (tm15)
 27817                                  
 27818                                  ;M029 -- Begin changes
 27819                                  ; The table of special chars _$P_FileSp_Char should be initialized on every
 27820                                  ;entry to SysParse. This is in the non-checksum region and any program that
 27821                                  ;corrupts this table but does not corrupt the checksum region will leave
 27822                                  ;command.com parsing in an inconsistent state.
 27823                                  ; NB: The special characters string has been hardcoded here. If any change
 27824                                  ;is made to it in psdata.inc, a corresponding change needs to be made here.
 27825                                  
 27826                                  ;IF FileSW + DrvSW
 27827                                  	;mov	word [cs:_$P_FileSp_Char], ']['
 27828                                  	;mov	word [cs:_$P_FileSp_Char+2], '<|'
 27829                                  	;mov	word [cs:_$P_FileSp_Char+4], '+>'
 27830                                  	;mov 	word [cs:_$P_FileSp_Char+6], ';='
 27831                                  
 27832                                  	; 06/09/2023
 27833 0000157C C706[5A15]5D5B          	mov	word [_$P_FileSp_Char], ']['
 27834 00001582 C706[5C15]3C7C          	mov	word [_$P_FileSp_Char+2], '<|'
 27835 00001588 C706[5E15]2B3E          	mov	word [_$P_FileSp_Char+4], '+>'
 27836 0000158E C706[6015]3B3D          	mov 	word [_$P_FileSp_Char+6], ';='
 27837                                  ;ENDIF
 27838                                  	; 06/09/2023
 27839 00001594 1F                      	pop	ds ; *!*
 27840                                  
 27841                                  ;M029 -- End of changes
 27842                                  
 27843 00001595 E87C06                  	call	_$P_Skip_Delim		;AN000; Move si to 1st non white space
 27844 00001598 7313                    	jnc	short _$P_Start		;AN000; If EOL is not encountered, do parse
 27845                                  ;--------------------------- End of Line
 27846 0000159A B8FFFF                  	mov	ax,_$P_RC_EOL		;AN000; set exit code to -1
 27847 0000159D 53                      	push	bx			;AN000;
 27848                                  	;mov	bx,[es:di+_$P_PARMS_Blk.PARMSX_Address]
 27849                                  					;AN000; Get the PARMSX address to
 27850 0000159E 268B1D                  	mov	bx,[es:di]
 27851                                  	;cmp	cl,[es:bx+_$P_PARMSX_Blk.MinP]
 27852                                  					;AN000; check ORDINAL to see if the minimum
 27853 000015A1 263A0F                  	cmp	cl,[es:bx]	
 27854 000015A4 7303                    	jae	short _$P_Fin		;AN000; positional found.
 27855                                  
 27856 000015A6 B80200                  	mov	ax,_$P_Op_Missing	;AN000; If no, set exit code to missing operand
 27857                                  _$P_Fin: 				;AN000;
 27858 000015A9 5B                      	pop	bx			;AN000;
 27859 000015AA E90A01                  	jmp	_$P_Single_Exit		;AN000; return to the caller
 27860                                  ;---------------------------
 27861                                  _$P_Start:				;AN000;
 27862 000015AD 2E8936[CD14]            	mov	[cs:_$P_SaveSI_Cmpx],si ;AN000;AC034; save ptr to command line for later use by complex,
 27863 000015B2 53                      	push	bx			;AN000; quoted string or file spec.
 27864 000015B3 57                      	push	di			;AN000;
 27865 000015B4 55                      	push	bp			;AN000;
 27866                                  	;;lea	bx,[cs:_$P_STRING_BUF] ;AC034; set buffer to copy from command string
 27867                                  	; 02/11/2022
 27868                                  	;lea	bx,[_$P_STRING_BUF]
 27869                                  	; 07/09/2023
 27870 000015B5 BB[D514]                	mov	bx,_$P_STRING_BUF
 27871 000015B8 2EF606[CC14]20          	test	byte [cs:_$P_Flags2],_$P_Extra ;AC034; 3/9 extra delimiter encountered ?
 27872 000015BE 7543                    	jnz	short _$P_Pack_End	;AN000; 3/9 if yes, no need to copy
 27873                                  
 27874                                  _$P_Pack_Loop:				;AN000;
 27875 000015C0 AC                      	lodsb				;AN000; Pick a operand from buffer
 27876 000015C1 E8F506                  	call	_$P_Chk_Switch		;AN000; Check switch character
 27877 000015C4 723C                    	jc	short _$P_Pack_End_BY_EOL ;AN020; if carry set found delimiter type slash, need backup si, else continue
 27878                                  
 27879 000015C6 E86D06                  	call	_$P_Chk_EOL		;AN000; Check EOL character
 27880 000015C9 7437                    	je	short _$P_Pack_End_BY_EOL ;AN000; need backup si
 27881                                  
 27882 000015CB E89D06                  	call	_$P_Chk_Delim		;AN000; Check delimiter
 27883 000015CE 7518                    	jne	short _$P_PL01 		;AN000; If no, process next byte
 27884                                  
 27885 000015D0 2EF606[CC14]20          	test	byte [cs:_$P_Flags2],_$P_Extra ;AC034; 3/9 If yes and white spec,
 27886                                  ; (tm08)jne	short _$P_Pack_End	;AN000; 3/9 then
 27887 000015D6 7505                    	jnz	short _$P_Pack_End_backup_si ;AN000; (tm08)
 27888                                  
 27889 000015D8 E83906                  	call	_$P_Skip_Delim		;AN000; skip subsequent white space,too
 27890 000015DB EB26                    	jmp	short _$P_Pack_End	;AN000; finish copy by placing NUL at end
 27891                                  
 27892                                  _$P_Pack_End_backup_si:			;AN000; (tm08)
 27893 000015DD 2EF606[CC14]41          	test	byte [cs:_$P_Flags2],_$P_SW+_$P_equ ;AN000;AC034;  (tm08)
 27894 000015E3 741E                    	jz	short _$P_Pack_End	;AN000; (tm08)
 27895                                  
 27896 000015E5 4E                      	dec	si			;AN000; (tm08)
 27897 000015E6 EB1B                    	jmp	short _$P_Pack_End	;AN025; (tm08)
 27898                                  
 27899                                  _$P_PL01:				;AN000;
 27900 000015E8 2E8807                  	mov	[cs:bx],al		;AN000; move byte to STRING_BUF
 27901 000015EB 3C3D                    	cmp	al,_$P_Keyword  ;'='	;AN000; if it is equal character,
 27902 000015ED 7506                    	jne	short _$P_PL00 		;AN000; then
 27903                                  
 27904 000015EF 2E800E[CC14]01          	or	byte [cs:_$P_Flags2],_$P_equ ;AC034; remember it in flag
 27905                                  _$P_PL00:				;AN000;
 27906 000015F5 43                      	inc	bx			;AN000; ready to see next byte
 27907 000015F6 E8D906                  	call	_$P_Chk_DBCS		;AN000; was it 1st byte of DBCS ?
 27908 000015F9 73C5                    	jnc	short _$P_Pack_Loop	;AN000; if no, process to next byte
 27909                                  
 27910 000015FB AC                      	lodsb				;AN000; if yes, store
 27911 000015FC 2E8807                  	mov	[cs:bx],al		;AN000;    2nd byte of DBCS
 27912 000015FF 43                      	inc	bx			;AN000; update pointer
 27913 00001600 EBBE                    	jmp	short _$P_Pack_Loop	;AN000; process to next byte
 27914                                  
 27915                                  _$P_Pack_End_BY_EOL:			;AN000;
 27916 00001602 4E                      	dec	si			;AN000; backup si pointer
 27917                                  _$P_Pack_End:				;AN000;
 27918 00001603 2E8936[C214]            	mov	[cs:_$P_SI_Save],si     ;AC034; save next pointer, SI
 27919                                  	; 07/09/2023
 27920                                  	;mov	byte [cs:bx],_$P_NULL	;AN000; put NULL at the end
 27921 00001608 30E4                    	xor	ah,ah ; 0 ; *
 27922 0000160A 2E8827                  	mov	[cs:bx],ah ; _$P_NULL	;AN000; put NULL at the end
 27923                                  	;
 27924 0000160D 2E891E[D114]            	mov	[cs:_$P_Save_EOB],bx    ;AC034; 3/17/87 keep the address for later use of complex
 27925                                  	;mov	bx,[es:di+_$P_PARMS_Blk.PARMSX_Address] ;AN000; get PARMSX address
 27926 00001612 268B1D                  	mov	bx,[es:di]
 27927                                  	;;lea	si,[cs:_$P_STRING_BUF]	;AC034;
 27928                                  	; 02/11/2022
 27929                                  	;lea	si,[_$P_STRING_BUF]
 27930                                  	; 07/09/2023
 27931 00001615 BE[D514]                	mov	si,_$P_STRING_BUF
 27932 00001618 2E803C2F                	cmp	byte [cs:si],_$P_Switch ;AN000; the operand begins w/ switch char ?
 27933 0000161C 7440                    	je	short _$P_SW_Manager	;AN000; if yes, process as switch
 27934                                  
 27935 0000161E 2E803C22                	cmp	byte [cs:si],_$P_DQuote	;M005;is it a string?
 27936 00001622 7408                    	je	short _$P_Positional_Manager ;M005;if so, process as one!
 27937                                  
 27938 00001624 2EF606[CC14]01          	test	byte [cs:_$P_Flags2],_$P_equ ;AC034; the operand includes equal char ?
 27939 0000162A 7552                    	jnz	short _$P_Key_Manager	;AN000; if yes, process as keyword
 27940                                  
 27941                                  _$P_Positional_Manager:			;AN000; else process as positional
 27942 0000162C 268A4701                	mov	al,[es:bx+_$P_PARMSX_Blk.MaxP] ;AN000; get maxp
 27943                                  	; 07/09/2023
 27944                                  	;xor	ah,ah			;AN000; ax = maxp
 27945 00001630 2E3906[BE14]            	cmp	[cs:_$P_ORDINAL],ax	;AC034; too many positional ?
 27946 00001635 7312                    	jae	short _$P_Too_Many_Error ;AN000; if yes, set exit code to too many
 27947                                  
 27948 00001637 2EA1[BE14]              	mov	ax,[cs:_$P_ORDINAL]	;AC034; see what the current ordinal
 27949 0000163B D1E0                    	shl	ax,1			;AN000; ax = ax*2
 27950 0000163D 43                      	inc	bx			;AC035; add '2' to
 27951 0000163E 43                      	inc	bx			;AC035;  BX reg
 27952                                  					;AN000; now bx points to 1st CONTROL
 27953 0000163F 01C3                    	add	bx,ax			;AN000; now bx points to specified CONTROL address
 27954 00001641 268B1F                  	mov	bx,[es:bx]		;AN000; now bx points to specified CONTROL itself
 27955 00001644 E87200                  	call	_$P_Chk_Pos_Control	;AN000; Do process for positional
 27956 00001647 EB53                    	jmp	short _$P_Return_to_Caller ;AN000; and return to the caller
 27957                                  
 27958                                  _$P_Too_Many_Error:			;AN000;
 27959 00001649 2EC706[C014]0100        	mov	word [cs:_$P_RC],_$P_Too_Many ;AC034; set exit code
 27960 00001650 EB4A                    	jmp	short _$P_Return_to_Caller ;AN000; and return to the caller
 27961                                  
 27962                                  	; 07/09/2023 - Retro DOSD v4.2 IO.SYS (Optimization)
 27963                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:1E06h)
 27964                                  get_maxp:
 27965                                  	;mov	al,[es:bx+1]
 27966 00001652 268A4701                	mov	al,[es:bx+_$P_PARMSX_Blk.MaxP] ;AN000; get maxp
 27967                                  	; 07/09/2023
 27968                                  	; ah=0 ; *
 27969                                  	;xor	ah,ah ; 0		;AN000; ax = maxp
 27970 00001656 30ED                    	xor	ch,ch ; **
 27971 00001658 40                      	inc	ax			;AN000;
 27972 00001659 D1E0                    	shl	ax,1			;AN000; ax = (ax+1)*2
 27973 0000165B 01C3                    	add	bx,ax			;AN000; now bx points to maxs
 27974 0000165D C3                      	retn
 27975                                  
 27976                                  _$P_SW_Manager:				;AN000;
 27977                                  	; 07/09/2023
 27978                                  	;mov	al,[es:bx+_$P_PARMSX_Blk.MaxP] ;AN000; get maxp
 27979                                  	;xor	ah,ah			;AN000; ax = maxp
 27980                                  	;inc	ax			;AN000;
 27981                                  	;shl	ax,1			;AN000; ax = (ax+1)*2
 27982                                  	;add	bx,ax			;AN000; now bx points to maxs
 27983 0000165E E8F1FF                  	call	get_maxp ; 07/09/2023
 27984                                  
 27985 00001661 268A0F                  	mov	cl,[es:bx]		;AN000;
 27986                                  	; 07/09/2023
 27987                                  	;xor	ch,ch ; ** (ch=0)	;AN000; cx = maxs
 27988                                  	;or	cx,cx			;AN000; at least one switch ?
 27989                                  	;jz	short _$P_SW_Not_Found 	;AN000;
 27990                                  	; 07/07/2023
 27991 00001664 E30F                    	jcxz	_$P_SW_Not_Found	; no
 27992                                  
 27993 00001666 43                      	inc	bx			;AN000; now bx points to 1st CONTROL address
 27994                                  
 27995                                  _$P_SW_Mgr_Loop: 			;AN000;
 27996 00001667 53                      	push	bx			;AN000;
 27997 00001668 268B1F                  	mov	bx,[es:bx]		;AN000; bx points to Switch CONTROL itself
 27998 0000166B E8A900                  	call	_$P_Chk_SW_Control	;AN000; do process for switch
 27999 0000166E 5B                      	pop	bx			;AN000;
 28000 0000166F 732B                    	jnc	short _$P_Return_to_Caller ;AN000; if the CONTROL is for the switch, exit
 28001                                  
 28002 00001671 43                      	inc	bx			;AC035; add '2' to
 28003 00001672 43                      	inc	bx			;AC035;  BX reg
 28004                                  					;AN000; else bx points to the next CONTROL
 28005 00001673 E2F2                    	loop	_$P_SW_Mgr_Loop		;AN000; and loop
 28006                                  
 28007                                  _$P_SW_Not_Found:			;AN000;
 28008 00001675 2EC706[C014]0300        	mov	word [cs:_$P_RC],_$P_Not_In_SW ;AC034; here no CONTROL for the switch has
 28009 0000167C EB1E                    	jmp	short _$P_Return_to_Caller ;AN000; not been found, means error.
 28010                                  
 28011                                  _$P_Key_Manager: 			;AN000;
 28012                                  	; 07/09/2023
 28013                                  	;mov	al,[es:bx+_$P_PARMSX_Blk.MaxP] ;AN000; get maxp
 28014                                  	;xor	ah,ah			;AN000; ax = maxp
 28015                                  	;inc	ax			;AN000;
 28016                                  	;shl	ax,1			;AN000; ax = (ax+1)*2
 28017                                  	;add	bx,ax			;AN000; now bx points to maxs
 28018 0000167E E8D1FF                  	call	get_maxp ; 07/09/2023
 28019                                  	
 28020 00001681 268A07                  	mov	al,[es:bx]		;AN000;
 28021 00001684 30E4                    	xor	ah,ah ; 0		;AN000; ax = maxs
 28022 00001686 D1E0                    	shl	ax,1			;AN000;
 28023 00001688 40                      	inc	ax			;AN000; ax = ax*2+1
 28024 00001689 01C3                    	add	bx,ax			;AN000; now bx points to maxk
 28025 0000168B 268A0F                  	mov	cl,[es:bx]		;AN000;
 28026                                  	; 07/09/2023
 28027                                  	;xor	ch,ch ; ** (ch=0)	;AN000; cx = maxk
 28028                                  	;or	cx,cx			;AN000; at least one keyword ?
 28029                                  	;jz	short _$P_Key_Not_Found	;AN000;
 28030                                  	; 07/07/2023
 28031 0000168E E305                    	jcxz	_$P_Key_Not_Found	; no
 28032                                  
 28033 00001690 43                      	inc	bx			;AN000; now bx points to 1st CONTROL
 28034                                  
 28035                                  _$P_Key_Mgr_Loop:			;AN000;
 28036                                  	; 07/09/2023
 28037                                  	; ('_$P_Chk_Key_Control' contains only 'stc' instruction)
 28038                                  	; (always returns with cf=1)
 28039                                  	;push	bx			;AN000;
 28040                                  	;mov	bx,[es:bx]		;AN000; bx points to keyword CONTROL itself
 28041                                  	;call	_$P_Chk_Key_Control	;AN000; do process for keyword
 28042                                  	;pop	bx			;AN000;
 28043                                  	;jnc	short _$P_Return_to_Caller ;AN000; if the CONTROL is for the keyword, exit
 28044                                  	; 07/09/2023
 28045                                  	; cf=1 (after 'call _$P_Chk_Key_Control')
 28046                                  
 28047 00001691 43                      	inc	bx			;AC035; add '2' to
 28048 00001692 43                      	inc	bx			;AC035;  BX reg
 28049                                  					;AN000; else bx points to the next CONTROL
 28050 00001693 E2FC                    	loop	_$P_Key_Mgr_Loop 	;AN000; and loop
 28051                                  
 28052                                  _$P_Key_Not_Found:			;AN000;
 28053 00001695 2EC706[C014]0400        	mov	word [cs:_$P_RC],_$P_Not_In_Key ;AC034; here no CONTROL for the keyword has
 28054                                  _$P_Return_to_Caller:			;AN000;
 28055 0000169C 5D                      	pop	bp			;AN000;
 28056 0000169D 5F                      	pop	di			;AN000;
 28057 0000169E 5B                      	pop	bx			;AN000;
 28058 0000169F 2E8B0E[BE14]            	mov	cx,[cs:_$P_ORDINAL]	;AC034; return next ordinal
 28059 000016A4 2EA1[C014]              	mov	ax,[cs:_$P_RC]		;AC034; return exit code
 28060 000016A8 2E8B36[C214]            	mov	si,[cs:_$P_SI_Save]	;AC034; return next operand pointer
 28061 000016AD 2E8B16[C414]            	mov	dx,[cs:_$P_DX]		;AC034; return result buffer address
 28062 000016B2 2E8A1E[C614]            	mov	bl,[cs:_$P_Terminator]	;AC034; return delimiter code found
 28063                                  _$P_Single_Exit: 			;AN000;
 28064 000016B7 F8                      	clc				;AN000;
 28065 000016B8 C3                      	retn				;AN000;
 28066                                  
 28067                                  ;***********************************************************************
 28068                                  ; _$P_Chk_Pos_Control
 28069                                  ;
 28070                                  ; Function: Parse CONTROL block for a positional
 28071                                  ;
 28072                                  ; Input:     ES:BX -> CONTROL block
 28073                                  ;	     cs:SI -> _$P_STRING_BUF
 28074                                  ;
 28075                                  ; Output:    None
 28076                                  ;
 28077                                  ; Use:	 _$P_Fill_Result, _$P_Check_Match_Flags
 28078                                  ;
 28079                                  ; Vars: _$P_Ordinal(W), _$P_RC(W)
 28080                                  ;***********************************************************************
 28081                                  
 28082                                  _$P_Chk_Pos_Control:
 28083 000016B9 50                      	push	ax			;AN000;
 28084                                  	;mov	ax,[es:bx+_$P_Control_Blk.Match_Flag] ;AN000;
 28085 000016BA 268B07                  	mov	ax,[es:bx]
 28086                                  	; 12/12/2022
 28087 000016BD A802                    	test	al,_$P_Repeat
 28088                                  	;test	ax,_$P_Repeat		;AN000; repeat allowed ?
 28089 000016BF 7505                    	jnz	short _$P_CPC00		;AN000; then do not increment ORDINAL
 28090                                  
 28091 000016C1 2EFF06[BE14]            	inc	word [cs:_$P_ORDINAL]	;AC034; update the ordinal
 28092                                  _$P_CPC00:				;AN000;
 28093 000016C6 2E803C00                	cmp	byte [cs:si],_$P_NULL	;AN000; no data ?
 28094 000016CA 7517                    	jne	short _$P_CPC01		;AN000;
 28095                                  
 28096                                  	; 12/12/2022
 28097 000016CC A801                    	test	al,_$P_Optional
 28098                                  	;test	ax,_$P_Optional		;AN000; yes, then is it optional ?
 28099 000016CE 7509                    	jnz	short _$P_CPC02		;AN000;
 28100                                  
 28101 000016D0 2EC706[C014]0200        	mov	word [cs:_$P_RC],_$P_Op_Missing ;AC034; no, then error 3/17/87
 28102 000016D7 EB0D                    	jmp	short _$P_CPC_Exit	;AN000;
 28103                                  
 28104                                  _$P_CPC02:				;AN000;
 28105 000016D9 50                      	push	ax			;AN000;
 28106                                  	;mov	al,_$P_String		;AN000; if it is optional return NULL
 28107                                  	;mov	ah,_$P_No_Tag		;AN000; no item tag indication
 28108                                  	; 07/07/2023
 28109 000016DA B803FF                  	mov	ax,(_$P_No_Tag<<8)|_$P_String
 28110 000016DD E89600                  	call	_$P_Fill_Result		;AN000;
 28111 000016E0 58                      	pop	ax			;AN000;
 28112 000016E1 EB03                    	jmp	short _$P_CPC_Exit	;AN000;
 28113                                  
 28114                                  _$P_CPC01:				;AN000;
 28115 000016E3 E81101                  	call	_$P_Check_Match_Flags	;AN000;
 28116                                  _$P_CPC_Exit:				;AN000;
 28117 000016E6 58                      	pop	ax			;AN000;
 28118 000016E7 C3                      	retn				;AN000;
 28119                                  
 28120                                  ;***********************************************************************
 28121                                  ; _$P_Chk_Key_Control
 28122                                  ;
 28123                                  ; Function: Parse CONTROL block for a keyword
 28124                                  ;
 28125                                  ; Input:     ES:BX -> CONTROL block
 28126                                  ;	     cs:SI -> _$P_STRING_BUF
 28127                                  ;
 28128                                  ; Output:    CY = 1 : not match
 28129                                  ;
 28130                                  ; Use:	 _$P_Fill_Result, _$P_Search_KEYorSW, _$P_Check_Match_Flags
 28131                                  ;
 28132                                  ; Vars: _$P_RC(W), _$P_SaveSI_Cmpx(W), _$P_KEYorSW_Ptr(R), _$P_Flags(W)
 28133                                  ;***********************************************************************
 28134                                  
 28135                                  ; 07/09/2023
 28136                                  ;_$P_Chk_Key_Control:
 28137                                  ;	stc				;AN000; this logic works when the KeySW
 28138                                  ;	retn				;AN000; is reset.
 28139                                  
 28140                                  ;***********************************************************************
 28141                                  ; _$P_Search_KEYorSW:
 28142                                  ;
 28143                                  ; Function: Seach specified keyword or switch from CONTROL
 28144                                  ;
 28145                                  ; Input:     ES:BX -> CONTROL block
 28146                                  ;	     cs:SI -> _$P_STRING_BUF
 28147                                  ;
 28148                                  ; Output:    CY = 1 : not match
 28149                                  ;
 28150                                  ; Use:	 _$P_String_Comp, _$P_MoveBP_NUL, _$P_Found_SYNONYM
 28151                                  ;***********************************************************************
 28152                                  
 28153                                  	; 25/10/2022 - Retro DOS v4.0
 28154                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:18B6h)
 28155                                  
 28156                                  _$P_Search_KEYorSW:			;AN000;
 28157 000016E8 55                      	push	bp			;AN000;
 28158 000016E9 51                      	push	cx			;AN000;
 28159 000016EA 268A4F08                	mov	cl,[es:bx+_$P_Control_Blk.nid] ;AN000; Get synonym count
 28160 000016EE 30ED                    	xor	ch,ch			;AN000; and set it to cx
 28161                                  	;or	cx,cx			;AN000; No synonyms specified ?
 28162                                  	;jz	short _$P_KEYorSW_Not_Found ;AN000; then indicate not found by CY
 28163                                  	; 07/07/2023
 28164 000016F0 E30D                    	jcxz	_$P_KEYorSW_Not_Found
 28165                                  
 28166                                  	;lea	bp,[es:bx+_$P_Control_Blk.KEYorSW] ;AN000; BP points to the 1st synonym
 28167                                  	; 25/10/2022
 28168 000016F2 8D6F09                  	lea	bp,[bx+_$P_Control_Blk.KEYorSW]
 28169                                  	;lea	bp,[bx+9]
 28170                                  _$P_KEYorSW_Loop:			;AN000;
 28171 000016F5 E8B903                  	call	_$P_String_Comp		;AN000; compare string in buffer w/ the synonym
 28172 000016F8 7308                    	jnc	short _$P_KEYorSW_Found	;AN000; If match, set it to synonym pointer
 28173                                  
 28174 000016FA E80E00                  	call	_$P_MoveBP_NUL		;AN000; else, bp points to the next string
 28175 000016FD E2F6                    	loop	_$P_KEYorSW_Loop 	;AN000; loop nid times
 28176                                  _$P_KEYorSW_Not_Found:			;AN000;
 28177 000016FF F9                      	stc				;AN000; indicate not found in synonym list
 28178 00001700 EB06                    	jmp	short _$P_KEYorSW_Exit	;AN000; and exit
 28179                                  
 28180                                  _$P_KEYorSW_Found:			;AN000;
 28181 00001702 2E892E[D314]            	mov	[cs:_$P_Found_SYNONYM],bp ;AC034; set synonym pointer
 28182 00001707 F8                      	clc				;AN000; indicate found
 28183                                  _$P_KEYorSW_Exit:			;AN000;
 28184 00001708 59                      	pop	cx			;AN000;
 28185 00001709 5D                      	pop	bp			;AN000;
 28186 0000170A C3                      	retn				;AN000;
 28187                                   
 28188                                  ;***********************************************************************
 28189                                  ; _$P_MoveBP_NUL
 28190                                  ;***********************************************************************
 28191                                  
 28192                                  _$P_MoveBP_NUL:
 28193                                  _$P_MBP_Loop:				;AN000;
 28194                                  	; 11/12/2022
 28195 0000170B 26807E0000              	cmp	byte [es:bp],_$P_NULL	;AN000; Increment BP that points
 28196                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 28197                                  	; (SYSINIT:18DBh)
 28198                                   	;cmp     byte [es:bp+0],0
 28199 00001710 7403                    	je	short _$P_MBP_Exit	;AN000; to the synomym list
 28200                                  
 28201 00001712 45                      	inc	bp			;AN000; until
 28202 00001713 EBF6                    	jmp	short _$P_MBP_Loop	;AN000; NULL encountered.
 28203                                  
 28204                                  _$P_MBP_Exit:				;AN000;
 28205 00001715 45                      	inc	bp			;AN000; bp points to next to NULL
 28206 00001716 C3                      	retn				;AN000;
 28207                                  
 28208                                  ;***********************************************************************
 28209                                  ; _$P_Chk_SW_Control
 28210                                  ;
 28211                                  ; Function: Parse CONTROL block for a switch
 28212                                  ;
 28213                                  ; Input:     ES:BX -> CONTROL block
 28214                                  ;	     cs:SI -> _$P_STRING_BUF
 28215                                  ;
 28216                                  ; Output:    CY = 1 : not match
 28217                                  ;
 28218                                  ; Use:	 _$P_Fill_Result, _$P_Search_KEYorSW, _$P_Check_Match_Flags
 28219                                  ;
 28220                                  ; Vars:  _$P_SaveSI_Cmpx(W), _$P_KEYorSW_Ptr(R), _$P_Flags(W)
 28221                                  ;***********************************************************************
 28222                                  
 28223                                  _$P_Chk_SW_Control:
 28224                                  
 28225                                  ;IF SwSW				;AN000;(Check if switch is supported)
 28226                                  	;or	byte [cs:_$P_Flags+1],10h
 28227 00001717 2E800E[CC14]10          	or	byte [cs:_$P_Flags2],_$P_SW_Cmp ;AC034; Indicate switch for later string comparison
 28228 0000171D E8C8FF                  	call	_$P_Search_KEYorSW	;AN000; Search the switch in the CONTROL block
 28229 00001720 7248                    	jc	short _$P_Chk_SW_Err0	;AN000; not found, then try next CONTROL
 28230                                  
 28231                                  	;and	[cs:_$P_Flags+],0EFh
 28232 00001722 2E8026[CC14]EF          	and	byte [cs:_$P_Flags2],0FFh-_$P_SW_Cmp 
 28233                                  					;AC034; reset the indicator previously set
 28234 00001728 50                      	push	ax			;AN000; 	      /switch:
 28235 00001729 2EA1[CF14]              	mov	ax,[cs:_$P_KEYorSW_Ptr] ;AC034;	      ^       ^
 28236 0000172D 29F0                    	sub	ax,si			;AN000;  SI	KEYorSW
 28237 0000172F 2E0106[CD14]            	add	[cs:_$P_SaveSI_Cmpx],ax	;AC034; update for complex list
 28238 00001734 58                      	pop	ax			;AN000;
 28239                                  
 28240 00001735 2E8B36[CF14]            	mov	si,[cs:_$P_KEYorSW_Ptr] ;AC034; set si at the end or colon
 28241 0000173A 2E803C00                	cmp	byte [cs:si],_$P_NULL	;AN000; any data after colon
 28242 0000173E 7525                    	jne	short _$P_CSW00		;AN000; if yes, process match flags
 28243                                  
 28244 00001740 2E807CFF3A              	cmp	byte [cs:si-1],_$P_Colon ;AN000; if no, the switch terminated by colon ?
 28245 00001745 7509                    	jne	short _$P_Chk_if_data_required ;AN000; if yes,
 28246                                  
 28247 00001747 2EC706[C014]0900        	mov	word [cs:_$P_RC],_$P_Syntax ;AC034; return syntax error
 28248 0000174E EB1C                    	jmp	short _$P_Chk_SW_Exit	;AN000;
 28249                                  
 28250                                  _$P_Chk_if_data_required:		;AN018; no data, no colon
 28251                                  	;cmp	word [es:bx+_$P_Control_Blk.Match_Flag],0 
 28252 00001750 26833F00                	cmp	word [es:bx],0		;AN018; should have data? zero match flag means switch followed by nothing is OK
 28253 00001754 7416                    	je	short _$P_Chk_SW_Exit	;AN018; match flags not zero so should have something if optional bit is not on
 28254                                  
 28255                                  	;test	word [es:bx+_$P_Control_Blk.Match_Flag],_$P_Optional 
 28256                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYINIT compatibility)
 28257                                  	;test	word [es:bx],1
 28258                                  	; 12/12/2022
 28259                                  	;test	word [es:bx],_$P_Optional ;AN019; see if no value is valid
 28260 00001756 26F60701                	test	byte [es:bx],_$P_Optional
 28261 0000175A 7510                    	jnz	short _$P_Chk_SW_Exit	;AN019; if so, then leave, else yell
 28262                                  
 28263 0000175C 2EC706[C014]0200        	mov	word [cs:_$P_RC],_$P_Op_Missing ;AC034; return required operand missing
 28264 00001763 EB07                    	jmp	short _$P_Chk_SW_Exit	;AN018;
 28265                                  
 28266                                  _$P_CSW00:				;AN000;
 28267 00001765 E88F00                  	call	_$P_Check_Match_Flags	;AN000; process match flag
 28268 00001768 F8                      	clc				;AN000; indicate match
 28269                                  	;jmp	short _$P_Chk_SW_Single_Exit ;AN000;
 28270                                  	; 12/12/2022
 28271 00001769 C3                      	retn
 28272                                  
 28273                                  _$P_Chk_SW_Err0: 			;AN000;
 28274 0000176A F9                      	stc				;AN000; not found in switch synonym list
 28275                                  	;jmp	short _$P_Chk_SW_Single_Exit ;AN000;
 28276                                  	; 12/12/2022
 28277 0000176B C3                      	retn	
 28278                                  
 28279                                  _$P_Chk_SW_Exit: 			;AN000;
 28280 0000176C 50                      	push	ax			;AN000;
 28281                                  	;mov	al,_$P_String		;AN000;
 28282                                  	;mov	ah,_$P_No_Tag		;AN000;
 28283                                  	; 07/07/2023
 28284 0000176D B803FF                  	mov	ax,(_$P_No_Tag<<8)|_$P_String
 28285 00001770 E80300                  	call	_$P_Fill_Result		;AN000; set result buffer
 28286 00001773 58                      	pop	ax			;AN000;
 28287 00001774 F8                      	clc				;AN000;
 28288                                  _$P_Chk_SW_Single_Exit:			;AN000;
 28289 00001775 C3                      	retn				;AN000;
 28290                                  ;ELSE					;AN000;(of IF SwSW)
 28291                                  ;	stc				;AN000; this logic works when the SwSW
 28292                                  ;	retn				;AN000; is reset.
 28293                                  
 28294                                  ;***********************************************************************
 28295                                  ; _$P_Fill_Result
 28296                                  ;
 28297                                  ; Function: Fill the result buffer
 28298                                  ;
 28299                                  ; Input:    AH = Item tag
 28300                                  ;	    AL = type
 28301                                  ;		  AL = 1: CX,DX has 32bit number (CX = high)
 28302                                  ;		  AL = 2: DX has index(offset) into value list
 28303                                  ;		  AL = 6: DL has driver # (1-A, 2-B, ... , 26 - Z)
 28304                                  ;		  AL = 7: DX has year, CL has month and CH has date
 28305                                  ;		  AL = 8: DL has hours, DH has minutes, CL has seconds,
 28306                                  ;			  amd CH has hundredths
 28307                                  ;		  AL = else: cs:SI points to returned string buffer
 28308                                  ;	    ES:BX -> CONTROL block
 28309                                  ;
 28310                                  ; Output:   None
 28311                                  ;
 28312                                  ; Use:	_$P_Do_CAPS_String, _$P_Remove_Colon, _$P_Found_SYNONYM
 28313                                  ;
 28314                                  ; Vars: _$P_DX(W)
 28315                                  ;***********************************************************************
 28316                                  
 28317                                  _$P_Fill_Result:
 28318 00001776 57                      	push	di			;AN000;
 28319 00001777 268B7F04                	mov	di,[es:bx+_$P_Control_Blk.Result_Buf]
 28320                                  					;AN000; di points to result buffer
 28321 0000177B 2E893E[C414]            	mov	[cs:_$P_DX],di		;AC034; set returned result address
 28322                                  	;mov	[es:di+_$P_Result_Blk.Type],al ;AN000; store type
 28323                                  	;mov	[es:di+_$P_Result_Blk.Item_Tag],ah ;AN000; store item tag
 28324                                  	; 07/09/2023
 28325                                  	;mov	[es:di+_$P_Result_Blk.Type], ax
 28326 00001780 268905                  	mov	[es:di],ax		; store type (al) and item tag (ah)
 28327                                  
 28328 00001783 50                      	push	ax			;AN000;
 28329 00001784 2EA1[D314]              	mov	ax,[cs:_$P_Found_SYNONYM] ;AC034; if yes,
 28330 00001788 26894502                	mov	[es:di+_$P_Result_Blk.SYNONYM_Ptr],ax 
 28331                                  					;AN000;   then set it to the result
 28332 0000178C 58                      	pop	ax			;AN000;
 28333                                  _$P_RLT04:				;AN000;
 28334 0000178D 3C01                    	cmp	al,_$P_Number		;AN000; if number
 28335 0000178F 750A                    	jne	short _$P_RLT00		;AN000;
 28336                                  
 28337                                  _$P_RLT02:				;AN000;
 28338 00001791 26895504                	mov	[es:di+_$P_Result_Blk.Picked_Val],dx ;AN000; then store 32bit
 28339 00001795 26894D06                	mov	[es:di+_$P_Result_Blk.Picked_Val+2],cx ;AN000; number
 28340 00001799 EB5A                    	jmp	short _$P_RLT_Exit	;AN000;
 28341                                  
 28342                                  _$P_RLT00:				;AN000;
 28343 0000179B 3C02                    	cmp	al,_$P_List_Idx		;AN000; if list index
 28344 0000179D 7506                    	jne	short _$P_RLT01		;AN000;
 28345                                  
 28346 0000179F 26895504                	mov	[es:di+_$P_Result_Blk.Picked_Val],dx 
 28347                                  					;AN000; then store list index
 28348 000017A3 EB50                    	jmp	short _$P_RLT_Exit	;AN000;
 28349                                  
 28350                                  _$P_RLT01:				;AN000;
 28351 000017A5 3C07                    	cmp	al,_$P_Date_F		;AN000; Date format ?
 28352 000017A7 74E8                    	je	short _$P_RLT02		;AN000;
 28353                                  
 28354 000017A9 3C08                    	cmp	al,_$P_Time_F		;AN000; Time format ?
 28355 000017AB 74E4                    	je	short _$P_RLT02		;AN000;
 28356                                  
 28357 000017AD 3C06                    	cmp	al,_$P_Drive		;AN000; drive format ?
 28358 000017AF 7506                    	jne	short _$P_RLT03		;AN000;
 28359                                  
 28360 000017B1 26885504                	mov	[es:di+_$P_Result_Blk.Picked_Val],dl ;AN000; store drive number
 28361 000017B5 EB3E                    	jmp	short _$P_RLT_Exit	;AN000;
 28362                                  
 28363                                  _$P_RLT03:				;AN000;
 28364 000017B7 3C04                    	cmp	al,_$P_Complex		;AN000; complex format ?
 28365 000017B9 750F                    	jne	short _$P_RLT05		;AN000;
 28366                                  
 28367 000017BB 2EA1[CD14]              	mov	ax,[cs:_$P_SaveSI_Cmpx] ;AC034; then get pointer in command buffer
 28368 000017BF 40                      	inc	ax			;AN000; skip left Parentheses
 28369 000017C0 26894504                	mov	[es:di+_$P_Result_Blk.Picked_Val],ax ;AN000; store offset
 28370 000017C4 268C5D06                	mov	[es:di+_$P_Result_Blk.Picked_Val+2],ds ;AN000; store segment
 28371 000017C8 EB2B                    	jmp	short _$P_RLT_Exit	;AN000;
 28372                                  
 28373                                  _$P_RLT05:				;AN000;
 28374                                  ;------------------------  AL = 3, 5, or 9
 28375 000017CA 26897504                	mov	[es:di+_$P_Result_Blk.Picked_Val],si 
 28376                                  					;AN000; store offset of STRING_BUF
 28377 000017CE 268C4D06                	mov	[es:di+_$P_Result_Blk.Picked_Val+2],cs 
 28378                                  					;AN031; store segment of STRING_BUF
 28379 000017D2 50                      	push	ax			;AN000;
 28380 000017D3 26F6470201              	test	byte [es:bx+_$P_Control_Blk.Function_Flag],_$P_CAP_File 
 28381                                  					;AN000; need CAPS by file table?
 28382 000017D8 7404                    	jz	short _$P_RLT_CAP00	;AN000;
 28383                                  
 28384 000017DA B004                    	mov	al,_$P_DOSTBL_File	;AN000; use file upper case table
 28385 000017DC EB09                    	jmp	short _$P_RLT_CAP02	;AN000;
 28386                                  
 28387                                  _$P_RLT_CAP00:				;AN000;
 28388 000017DE 26F6470202              	test	byte [es:bx+_$P_Control_Blk.Function_Flag],_$P_CAP_Char 
 28389                                  					;AN000; need CAPS by char table ?
 28390 000017E3 7405                    	jz	short _$P_RLT_CAP01	;AN000;
 28391                                  
 28392 000017E5 B002                    	mov	al,_$P_DOSTBL_Char	;AN000; use character upper case table
 28393                                  _$P_RLT_CAP02:				;AN000;
 28394 000017E7 E8DF00                  	call	_$P_Do_CAPS_String	;AN000; process CAPS along the table
 28395                                  _$P_RLT_CAP01:				;AN000;
 28396 000017EA 58                      	pop	ax			;AN000;
 28397 000017EB 26F6470210              	test	byte [es:bx+_$P_Control_Blk.Function_Flag],_$P_Rm_Colon 
 28398                                  					;AN000; removing colon at end ?
 28399 000017F0 7403                    	jz	short _$P_RLT_Exit	;AN000;
 28400                                  
 28401 000017F2 E8AE00                  	call	_$P_Remove_Colon 	;AN000; then process it.
 28402                                  _$P_RLT_Exit:				;AN000;
 28403 000017F5 5F                      	pop	di			;AN000;
 28404 000017F6 C3                      	retn				;AN000;
 28405                                  
 28406                                  ;***********************************************************************
 28407                                  ; _$P_Check_Match_Flags
 28408                                  ;
 28409                                  ; Function:  Check the match_flags and make the exit code and set the
 28410                                  ;	     result buffer
 28411                                  ;
 28412                                  ;	    Check for types in this order:
 28413                                  ;		Complex
 28414                                  ;		Date
 28415                                  ;		Time
 28416                                  ;		Drive
 28417                                  ;		Filespec
 28418                                  ;		Quoted String
 28419                                  ;		Simple String
 28420                                  ;
 28421                                  ; Input:     cs:SI -> _$P_STRING_BUF
 28422                                  ;	     ES:BX -> CONTROL block
 28423                                  ;
 28424                                  ; Output:    None
 28425                                  ;
 28426                                  ; Use:	     _$P_Value, P$_SValue, _$P_Simple_String, _$P_Date_Format
 28427                                  ;	     _$P_Time_Format, _$P_Complex_Format, _$P_File_Foemat
 28428                                  ;	     _$P_Drive_Format
 28429                                  ;***********************************************************************
 28430                                  
 28431                                  	; 25/10/2022 - Retro DOS v4.0
 28432                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:19CFh)
 28433                                  
 28434                                  	; 12/12/2022
 28435                                  _$P_Check_Match_Flags:
 28436 000017F7 2EC606[6315]00          	mov	byte [cs:_$P_err_flag],_$P_NULL 
 28437                                  					;AN033;AC034;; clear filespec error flag.
 28438 000017FD 50                      	push	ax			;AN000;
 28439                                  	;mov	ax,[es:bx+_$P_Control_Blk.Match_Flag]
 28440 000017FE 268B07                  	mov	ax,[es:bx]		;AN000; load match flag(16bit) to ax
 28441 00001801 09C0                    	or	ax,ax			;AC035; test ax for zero
 28442 00001803 7517                    	jnz	short _$P_Mat		;AN000; (tm12)
 28443 00001805 50                      	push	ax			;AN000; (tm12)
 28444 00001806 53                      	push	bx			;AN000; (tm12)
 28445 00001807 52                      	push	dx			;AN000; (tm12)
 28446 00001808 57                      	push	di			;AN000; (tm12)
 28447 00001809 2EC706[C014]0900        	mov	word [cs:_$P_RC],_$P_Syntax ;AC034; (tm12)
 28448                                  	;mov	ah,_$P_No_Tag		;AN000; (tm12)
 28449                                  	;mov	al,_$P_String		;AN000; (tm12)
 28450                                  	; 07/07/2023
 28451 00001810 B803FF                  	mov	ax,(_$P_No_Tag<<8)|_$P_String
 28452 00001813 E860FF                  	call	_$P_Fill_Result		;AN000; (tm12)
 28453 00001816 5F                      	pop	di			;AN000; (tm12)
 28454 00001817 5A                      	pop	dx			;AN000; (tm12)
 28455 00001818 5B                      	pop	bx			;AN000; (tm12)
 28456 00001819 58                      	pop	ax			;AN000; (tm12)
 28457                                  	; 12/12/2022
 28458                                  	;jmp	short _$P_Bridge 	;AC035; (tm12)
 28459                                  	; 12/12/2022
 28460                                  ;_$P_Mat: 				;AN000; (tm12)
 28461                                  	;jmp	short _$P_Match03	;AN025; (tm09)
 28462                                  _$P_Bridge:
 28463 0000181A EB6E                    	jmp	short _$P_Match_Exit	;AN000; (tm02)
 28464                                  	
 28465                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 28466                                  	; (SYSINIT:19F9h)
 28467                                  	; 12/12/2022
 28468                                  	;nop	; db 90h
 28469                                  
 28470                                  ; 12/12/2022
 28471                                  _$P_Mat:
 28472                                  _$P_Match03:				;AN000;
 28473                                  	;test	ax,_$P_Num_Val ; 8000h	;AN000; Numeric value
 28474                                  	; 07/07/2023
 28475 0000181C F6C480                  	test	ah,(_$P_Num_Val>>8) ; 80h
 28476 0000181F 7412                    	jz	short _$P_Match04	;AN000;
 28477                                  
 28478 00001821 2EC706[C014]0000        	mov	word [cs:_$P_RC],_$P_No_Error ;AC034; assume no error
 28479 00001828 E81E01                  	call	_$P_Value		;AN000; do process
 28480 0000182B 2E833E[C014]09          	cmp	word [cs:_$P_RC],_$P_Syntax ;AC034; if error, examine the next type
 28481 00001831 7557                    	jne	short _$P_Match_Exit	;AN000;
 28482                                  _$P_Match04:				;AN000;
 28483                                  	;test	ax,_$P_SNum_Val ; 4000h	;AN000; Signed numeric value
 28484                                  	; 07/07/2023
 28485 00001833 F6C440                  	test	ah,(_$P_SNum_Val>>8) ; 40h
 28486 00001836 7412                    	jz	short _$P_Match05	;AN000;
 28487                                  
 28488 00001838 2EC706[C014]0000        	mov	word [cs:_$P_RC],_$P_No_Error ;AC034; assume no error
 28489 0000183F E8E300                  	call	_$P_SValue		;AN000; do process
 28490 00001842 2E833E[C014]09          	cmp	word [cs:_$P_RC],_$P_Syntax ;AC034; if error, examine the next type
 28491 00001848 7540                    	jne	short _$P_Match_Exit	;AN000;
 28492                                  _$P_Match05:				;AN000;
 28493                                  	;test	ax,_$P_Drv_Only ; 100h	;AN000; Drive only
 28494                                  	; 07/07/2023
 28495 0000184A F6C401                  	test	ah,(_$P_Drv_Only>>8) ; 1
 28496 0000184D 7415                    	jz	short _$P_Match06	;AN000;
 28497                                  
 28498 0000184F 2EC706[C014]0000        	mov	word [cs:_$P_RC],_$P_No_Error ;AC034; assume no error
 28499 00001856 E8F602                  	call	_$P_File_Format		;AN000; 1st, call file format
 28500 00001859 E87603                  	call	_$P_Drive_Format	;AN000; check drive format, next
 28501 0000185C 2E833E[C014]09          	cmp	word [cs:_$P_RC],_$P_Syntax ;AC034; if error, examine the next type
 28502 00001862 7526                    	jne	short _$P_Match_Exit	;AN000;
 28503                                  _$P_Match06:				;AN000;
 28504                                  	;test	ax,_$P_File_Spc ; 200h	;AN000; File spec
 28505                                  	; 07/07/2023
 28506 00001864 F6C402                  	test	ah,(_$P_File_Spc>>8) ; 2
 28507 00001867 7412                    	jz	short _$P_Match07	;AN000;
 28508                                  
 28509 00001869 2EC706[C014]0000        	mov	word [cs:_$P_RC],_$P_No_Error ;AC034; assume no error
 28510 00001870 E8DC02                  	call	_$P_File_Format		;AN000; do process
 28511 00001873 2E833E[C014]09          	cmp	word [cs:_$P_RC],_$P_Syntax ;AC034; if error, examine the next type
 28512 00001879 750F                    	jne	short _$P_Match_Exit	;AN000;
 28513                                  _$P_Match07:				;AN000;
 28514                                  	;test	ax,_$P_Simple_S	; 2000h	;AN000; Simple string
 28515                                  	; 07/07/2023
 28516 0000187B F6C420                  	test	ah,(_$P_Simple_S>>8) ; 20h
 28517 0000187E 740A                    	jz	short _$P_Match09	;AN000;
 28518                                  
 28519 00001880 2EC706[C014]0000        	mov	word [cs:_$P_RC],_$P_No_Error ;AC034; assume no error
 28520 00001887 E8BE01                  	call	_$P_Simple_String	;AN000; do process
 28521                                  _$P_Match09:				;AN000;
 28522                                  _$P_Match_Exit:				;AN000;
 28523 0000188A 2E833E[6315]01          	cmp	word [cs:_$P_err_flag],_$P_error_filespec ;AC034; bad filespec ?
 28524 00001890 750F                    	jne	short _$P_Match2_Exit	;AN033; no, continue
 28525 00001892 2E833E[C014]00          	cmp	word [cs:_$P_RC],_$P_No_Error ;AN033;AC034;; check for other errors ?
 28526 00001898 7507                    	jne	short _$P_Match2_Exit	;AN033; no, continue
 28527 0000189A 2EC706[C014]0900        	mov	word [cs:_$P_RC],_$P_Syntax ;AN033;AC034;; set error flag
 28528                                  _$P_Match2_Exit: 			;AN033;
 28529 000018A1 58                      	pop	ax			;AN000;
 28530 000018A2 C3                      	retn				;AN000;
 28531                                  
 28532                                  ;***********************************************************************
 28533                                  ; _$P_Remove_Colon;
 28534                                  ;
 28535                                  ; Function: Remove colon at end
 28536                                  ;
 28537                                  ; Input:    cs:SI points to string buffer to be examineed
 28538                                  ;
 28539                                  ; Output:   None
 28540                                  ;
 28541                                  ; Use:	_$P_Chk_DBCS
 28542                                  ;***********************************************************************
 28543                                  
 28544                                  _$P_Remove_Colon:
 28545 000018A3 50                      	push	ax			;AN000;
 28546 000018A4 56                      	push	si			;AN000;
 28547                                  _$P_RCOL_Loop:				;AN000;
 28548 000018A5 2E8A04                  	mov	al,[cs:si]		;AN000; get character
 28549 000018A8 08C0                    	or	al,al			;AN000; end of string ?
 28550 000018AA 741A                    	jz	short _$P_RCOL_Exit	;AN000; if yes, just exit
 28551                                  
 28552 000018AC 3C3A                    	cmp	al,_$P_Colon		;AN000; is it colon ?
 28553 000018AE 750D                    	jne	short _$P_RCOL00	;AN000;
 28554                                  
 28555 000018B0 2E807C0100              	cmp	byte [cs:si+1],_$P_NULL ;AN000; if so, next is NULL ?
 28556 000018B5 7506                    	jne	short _$P_RCOL00	;AN000; no, then next char
 28557                                  
 28558 000018B7 2EC60400                	mov	byte [cs:si],_$P_NULL	;AN000; yes, remove colon
 28559 000018BB EB09                    	jmp	short _$P_RCOL_Exit	;AN000; and exit.
 28560                                  
 28561                                  _$P_RCOL00:				;AN000;
 28562 000018BD E81204                  	call	_$P_Chk_DBCS		;AN000; if not colon, then check if
 28563 000018C0 7301                    	jnc	short _$P_RCOL01	;AN000; DBCS leading byte.
 28564                                  
 28565 000018C2 46                      	inc	si			;AN000; if yes, skip trailing byte
 28566                                  _$P_RCOL01:				;AN000;
 28567 000018C3 46                      	inc	si			;AN000; si points to next byte
 28568 000018C4 EBDF                    	jmp	short _$P_RCOL_Loop	;AN000; loop until NULL encountered
 28569                                  
 28570                                  _$P_RCOL_Exit:				;AN000;
 28571 000018C6 5E                      	pop	si			;AN000;
 28572 000018C7 58                      	pop	ax			;AN000;
 28573 000018C8 C3                      	retn				;AN000;
 28574                                  
 28575                                  ;***********************************************************************
 28576                                  ; _$P_Do_CAPS_String;
 28577                                  ;
 28578                                  ; Function: Perform capitalization along with the file case map table
 28579                                  ;	    or character case map table.
 28580                                  ;
 28581                                  ; Input:    AL = 2 : Use character table
 28582                                  ;	    AL = 4 : Use file table
 28583                                  ;	    cs:SI points to string buffer to be capitalized
 28584                                  ;
 28585                                  ; Output:   None
 28586                                  ;
 28587                                  ; Use:	_$P_Do_CAPS_Char, _$P_Chk_DBCS
 28588                                  ;***********************************************************************
 28589                                  
 28590                                  _$P_Do_CAPS_String:
 28591 000018C9 56                      	push	si			;AN000;
 28592 000018CA 52                      	push	dx			;AN000;
 28593 000018CB 88C2                    	mov	dl,al			;AN000; save info id
 28594                                  _$P_DCS_Loop:				;AN000;
 28595 000018CD 2E8A04                  	mov	al,[cs:si]		;AN000; load charater and
 28596 000018D0 E8FF03                  	call	_$P_Chk_DBCS		;AN000; check if DBCS leading byte
 28597 000018D3 720C                    	jc	short _$P_DCS00		;AN000; if yes, do not need CAPS
 28598                                  
 28599 000018D5 08C0                    	or	al,al			;AN000; end of string ?
 28600 000018D7 740C                    	jz	short _$P_DCS_Exit	;AN000; then exit.
 28601                                  
 28602 000018D9 E80C00                  	call	_$P_Do_CAPS_Char 	;AN000; Here a SBCS char need to be CAPS
 28603 000018DC 2E8804                  	mov	[cs:si],al		;AN000; stored upper case char to buffer
 28604 000018DF EB01                    	jmp	short _$P_DCS01		;AN000; process next
 28605                                  _$P_DCS00:				;AN000;
 28606 000018E1 46                      	inc	si			;AN000; skip DBCS leading and trailing byte
 28607                                  _$P_DCS01:				;AN000;
 28608 000018E2 46                      	inc	si			;AN000; si point to next byte
 28609 000018E3 EBE8                    	jmp	short _$P_DCS_Loop	;AN000; loop until NULL encountered
 28610                                  _$P_DCS_Exit:				;AN000;
 28611 000018E5 5A                      	pop	dx			;AN000;
 28612 000018E6 5E                      	pop	si			;AN000;
 28613 000018E7 C3                      	retn
 28614                                  
 28615                                  ;***********************************************************************
 28616                                  ; _$P_Do_CAPS_Char;
 28617                                  ;
 28618                                  ; Function: Perform capitalization along with the file case map table
 28619                                  ;	    or character case map table.
 28620                                  ;
 28621                                  ; Input:    DL = 2 : Use character table
 28622                                  ;	    DL = 4 : Use file table
 28623                                  ;	    AL = character to be capitalized
 28624                                  ;
 28625                                  ; Output:   None
 28626                                  ;
 28627                                  ; Use:	INT 21h /w AH=65h
 28628                                  ;***********************************************************************
 28629                                  
 28630                                  _$P_Do_CAPS_Char:
 28631 000018E8 3C80                    	cmp	al,_$P_ASCII80	;80h	;AN000; need upper case table ?
 28632 000018EA 730B                    	jae	short _$P_DCC_Go	;AN000; no
 28633                                  
 28634 000018EC 3C61                    	cmp	al,"a"                  ;AN000; check if  "a" <= AL <= "z"
 28635 000018EE 7234                    	jb	short _$P_CAPS_Ret	;AN000;   
 28636                                  
 28637 000018F0 3C7A                    	cmp	al,"z"                  ;AN000;
 28638 000018F2 7730                    	ja	short _$P_CAPS_Ret	;AN000;
 28639                                  
 28640 000018F4 24DF                    	and	al,_$P_Make_Upper ;0DFh ;AN000; make CAPS
 28641                                  	;jmp	short _$P_CAPS_Ret	;AN000;
 28642                                  	; 07/07/2023
 28643 000018F6 C3                      	retn
 28644                                  
 28645                                  _$P_DCC_Go:				;AN000;
 28646 000018F7 53                      	push	bx			;AN000;
 28647 000018F8 06                      	push	es			;AN000;
 28648 000018F9 57                      	push	di			;AN000;
 28649                                  
 28650                                  	;;lea	di,[cs:_$P_Char_CAP_Ptr] ;AC034; or use char CAPS table ?
 28651                                  	;lea	di,[_$P_Char_CAP_Ptr]
 28652                                  	; 07/09/2023
 28653 000018FA BF[5515]                	mov	di,_$P_Char_CAP_Ptr
 28654                                  _$P_DCC00:				;AN000;
 28655 000018FD 2E3815                  	cmp	[cs:di],dl		;AN000; already got table address ?
 28656 00001900 7415                    	je	short _$P_DCC01		;AN000; no
 28657                                  
 28658                                  ;In this next section, ES will be used to pass a 5 byte workarea to INT 21h,
 28659                                  ; the GET COUNTYRY INFO call. This usage of ES is required by the function
 28660                                  ; call, regardless of what base register is currently be defined as cs.
 28661                                  
 28662 00001902 50                      	push	ax			;AN000; get CAPS table thru DOS call
 28663 00001903 51                      	push	cx			;AN000;
 28664 00001904 52                      	push	dx			;AN000;
 28665                                  
 28666 00001905 0E                      	push	cs			;AC036; pass current base seg into
 28667                                  					;(Note: this used to push CS.  BUG...
 28668 00001906 07                      	pop	es			;AN000;   ES reg, required for
 28669                                  					;get extended country information
 28670                                  	;mov	al,dl ; function	;AN000; upper case table
 28671                                  	; 07/07/2023
 28672 00001907 92                      	xchg	ax,dx
 28673 00001908 B465                    	mov	ah,_$P_DOS_Get_TBL ; 65h ;AN000; get extended CDI
 28674 0000190A BBFFFF                  	mov	bx,_$P_DOSTBL_Def ; -1	;AN000; get active CON
 28675 0000190D B90500                  	mov	cx,_$P_DOSTBL_BL ; 5	;AN000; buffer length
 28676                                  	;mov	dx,_$P_DOSTBL_Def	;AN000; get for default code page
 28677                                  	; 07/07/2023
 28678 00001910 89DA                    	mov	dx,bx ; 0FFFFh
 28679                                  					;DI already set to point to buffer
 28680 00001912 CD21                    	int	21h			;AN000; es:di point to buffer that
 28681                                  					;now has been filled in with info
 28682 00001914 5A                      	pop	dx			;AN000;
 28683 00001915 59                      	pop	cx			;AN000;
 28684 00001916 58                      	pop	ax			;AN000;
 28685                                  
 28686                                  _$P_DCC01:				;AN000;
 28687                                  
 28688                                  ;In this next section, ES will be used as the base of the XLAT table, provided
 28689                                  ; by the previous GET COUNTRY INFO DOS call. This usage of ES is made
 28690                                  ; regardless of which base reg is currently the cs reg.
 28691                                  
 28692                                  	;mov	bx,[cs:di+_$P_DOS_TBL.Off] ;AN000; get offset of table
 28693                                  	;mov	es,[cs:di+_$P_DOS_TBL.Seg] ;AN000; get segment of table
 28694                                  	; 07/07/2023
 28695 00001917 2EC45D01                	les	bx,[cs:di+_$P_DOS_TBL.Off]
 28696 0000191B 43                      	inc	bx			;AC035; add '2' to
 28697 0000191C 43                      	inc	bx			;AC035;  BX reg
 28698                                  					;AN000; skip length field
 28699 0000191D 2C80                    	sub	al,_$P_ASCII80 ; 80h	;AN000; make char to index
 28700                                  	;xlat	es:[bx] 		;AN000; perform case map
 28701 0000191F 26                      	es
 28702 00001920 D7                      	xlat
 28703 00001921 5F                      	pop	di			;AN000;
 28704 00001922 07                      	pop	es			;AN000;
 28705 00001923 5B                      	pop	bx			;AN000;
 28706                                  _$P_CAPS_Ret:				;AN000;
 28707 00001924 C3                      	retn				;AN000;
 28708                                  
 28709                                  ;***********************************************************************
 28710                                  ; _$P_Value / _$P_SValue
 28711                                  ;
 28712                                  ; Function:  Make 32bit value from cs:SI and see value list
 28713                                  ;	     and make result buffer.
 28714                                  ;	     _$P_SValue is an entry point for the signed value
 28715                                  ;	     and this will simply call _$P_Value after the handling
 28716                                  ;	     of the sign character, "+" or "-"
 28717                                  ;
 28718                                  ; Input:     cs:SI -> _$P_STRING_BUF
 28719                                  ;	     ES:BX -> CONTROL block
 28720                                  ;
 28721                                  ; Output:    None
 28722                                  ;
 28723                                  ; Use:	_$P_Fill_Result, _$P_Check_OVF
 28724                                  ;
 28725                                  ; Vars: _$P_RC(W), _$P_Flags(RW)
 28726                                  ;***********************************************************************
 28727                                  
 28728                                  	; 26/10/2022 - Retro DOS v4.0
 28729                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:1B0Bh)
 28730                                  
 28731                                  	; 07/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 28732                                  	; (MSDOS 6.21 IO.SYS - SYSINIT:1C46h)  	
 28733                                  _$P_SValue:				;AN000; when signed value here
 28734 00001925 50                      	push	ax			;AN000;
 28735 00001926 2E800E[CC14]80          	or	byte [cs:_$P_Flags2],_$P_Signed ;AC034; indicate a signed numeric
 28736 0000192C 2E8026[CC14]FD          	and	byte [cs:_$P_Flags2],0FFh-_$P_Neg ;AC034; assume positive value
 28737                                  	;and	byte [cs:_$P_Flags2],~_$P_Neg ; 07/07/2023 
 28738 00001932 2E8A04                  	mov	al,[cs:si]		;AN000; get sign
 28739 00001935 3C2B                    	cmp	al,_$P_Plus		;AN000; "+" ?
 28740 00001937 740A                    	je	short _$P_SVal00	;AN000;
 28741                                  
 28742 00001939 3C2D                    	cmp	al,_$P_Minus		;AN000; "-" ?
 28743 0000193B 7507                    	jne	short _$P_Sval01	;AN000; else
 28744                                  
 28745 0000193D 2E800E[CC14]02          	or	byte [cs:_$P_Flags2],_$P_Neg ;AC034; set this is negative value
 28746                                  _$P_SVal00:				;AN000;
 28747 00001943 46                      	inc	si			;AN000; skip sign char
 28748                                  _$P_Sval01:				;AN000;
 28749 00001944 E80200                  	call	_$P_Value		;AN000; and process value
 28750 00001947 58                      	pop	ax			;AN000;
 28751 00001948 C3                      	retn
 28752                                  
 28753                                  ;***********************************************************************
 28754                                  
 28755                                  	; 07/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 28756                                  	; (MSDOS 6.21 IO.SYS - SYSINIT:1C6Ah)
 28757                                  
 28758                                  	; 26/10/2022
 28759                                  _$P_Value:				;AN000;
 28760 00001949 50                      	push	ax			;AN000;
 28761 0000194A 51                      	push	cx			;AN000;
 28762 0000194B 52                      	push	dx			;AN000;
 28763 0000194C 56                      	push	si			;AN000;
 28764 0000194D 31C9                    	xor	cx,cx			;AN000; cx = higher 16 bits
 28765 0000194F 31D2                    	xor	dx,dx			;AN000; dx = lower 16 bits
 28766 00001951 53                      	push	bx			;AN000; save control pointer
 28767                                  _$P_Value_Loop:				;AN000;
 28768 00001952 2E8A04                  	mov	al,[cs:si]		;AN000; get character
 28769 00001955 08C0                    	or	al,al			;AN000; end of line ?
 28770 00001957 743C                    	jz	short _$P_Value00	;AN000;
 28771                                  
 28772 00001959 E8E000                  	call	_$P_0099 		;AN000; make asc(0..9) to bin(0..9)
 28773 0000195C 7233                    	jc	short _$P_Value_Err0	;AN000;
 28774                                  
 28775 0000195E 30E4                    	xor	ah,ah			;AN000;
 28776 00001960 89C5                    	mov	bp,ax			;AN000; save binary number
 28777                                  
 28778                                  ; 08/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 28779                                  ; Ref: Disassembled PCDOS 7.1 IBMBIO.COM SYSINIT code
 28780                                  ;				Erdogan Tan - July 2023 
 28781                                  %if 0
 28782                                  	shl	dx,1			;AN000; to have 2*x
 28783                                  	rcl	cx,1			;AN000; shift left w/ carry
 28784                                  	call	_$P_Check_OVF		;AN000; Overflow occurred ?
 28785                                  	jc	short _$P_Value_Err0	;AN000; then error, exit
 28786                                  
 28787                                  	mov	bx,dx			;AN000; save low(2*x)
 28788                                  	mov	ax,cx			;AN000; save high(2*x)
 28789                                  	shl	dx,1			;AN000; to have 4*x
 28790                                  	rcl	cx,1			;AN000; shift left w/ carry
 28791                                  	call	_$P_Check_OVF		;AN000; Overflow occurred ?
 28792                                  	jc	short _$P_Value_Err0	;AN000; then error, exit
 28793                                  
 28794                                  	shl	dx,1			;AN000; to have 8*x
 28795                                  	rcl	cx,1			;AN000; shift left w/ carry
 28796                                  	call	_$P_Check_OVF		;AN000; Overflow occurred ?
 28797                                  	jc	short _$P_Value_Err0	;AN000; then error, exit
 28798                                  
 28799                                  	add	dx,bx			;AN000; now have 10*x
 28800                                  	adc	cx,ax			;AN000; 32bit ADD
 28801                                  	call	_$P_Check_OVF		;AN000; Overflow occurred ?
 28802                                  	jc	short _$P_Value_Err0	;AN000; then error, exit
 28803                                  
 28804                                  	add	dx,bp			;AN000; Add the current one degree decimal
 28805                                  	adc	cx,0			;AN000; if carry, add 1 to high 16bit
 28806                                  	call	_$P_Check_OVF		;AN000; Overflow occurred ?
 28807                                  	jc	short _$P_Value_Err0	;AN000; then error, exit
 28808                                  
 28809                                  	inc	si			;AN000; update pointer
 28810                                  	jmp	short _$P_Value_Loop	;AN000; loop until NULL encountered
 28811                                  ;_$P_Value_Err0:
 28812                                  %endif
 28813                                  ;****
 28814                                  %if 1
 28815                                  ; 08/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 28816                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:2130h)
 28817                                  
 28818 00001962 30E4                    	xor	ah,ah
 28819 00001964 89C5                    	mov	bp,ax			; save binary number
 28820 00001966 E81C00                  	call	_$P_Value_2x_OVF 	; multiply cx:dx by 2 and then check overflow
 28821 00001969 89D3                    	mov	bx,dx			; ax:bx = 2*(cx:dx)
 28822 0000196B 89C8                    	mov	ax,cx
 28823 0000196D E81500                  	call	_$P_Value_2x_OVF 	; multiply cx:dx by 2 and then check overflow
 28824 00001970 E81200                  	call	_$P_Value_2x_OVF 	; multiply cx:dx by 2 and then check overflow
 28825 00001973 01DA                    	add	dx,bx			; 8*(cx:dx)+2*(cx:dx) = 10*(cx:dx)
 28826 00001975 11C1                    	adc	cx,ax
 28827 00001977 E80F00                  	call	_$P_Value_Chk_Add_OVF
 28828 0000197A 01EA                    	add	dx,bp			; Add the current one degree decimal
 28829                                  					; if carry, add 1 to high 16bit
 28830 0000197C 83D100                  	adc	cx,0
 28831 0000197F E80700                  	call	_$P_Value_Chk_Add_OVF	; Overflow occurred ?
 28832                                  					; then error, exit (without return here)
 28833 00001982 46                      	inc	si			; update pointer
 28834 00001983 EBCD                    	jmp	short _$P_Value_Loop
 28835                                  
 28836                                  _$P_Value_2x_OVF:
 28837 00001985 D1E2                    	shl	dx,1 			; to have 2*x
 28838 00001987 D1D1                    	rcl	cx,1			; shift left w/ carry
 28839                                  _$P_Value_Chk_Add_OVF:
 28840 00001989 E89E00                  	call	_$P_Check_OVF		; check overflow (for the last shift or add)
 28841 0000198C 7201                    	jc	short _$P_Value_OVF
 28842 0000198E C3                      	retn
 28843                                  _$P_Value_OVF:
 28844 0000198F 44                      	inc	sp 			; skip "call" return address to the caller
 28845 00001990 44                      	inc	sp
 28846                                  
 28847                                  ;_$P_Value_Err0:	
 28848                                  %endif
 28849                                  ;****
 28850                                  
 28851                                  _$P_Value_Err0:				;AN000;
 28852 00001991 5B                      	pop	bx			;AN000;
 28853 00001992 E98300                  	jmp	_$P_Value_Err		;AN000; Bridge
 28854                                  ;
 28855                                  _$P_Value00:				;AN000;
 28856 00001995 5B                      	pop	bx			;AN000; restore control pointer
 28857 00001996 2EF606[CC14]02          	test	byte [cs:_$P_Flags2],_$P_Neg ;AC034; here cx,dx = 32bit value
 28858 0000199C 740A                    	jz	short _$P_Value01	;AN000; was it negative ?
 28859                                  
 28860 0000199E F7D1                    	not	cx			;AN000; +
 28861 000019A0 F7D2                    	not	dx			;AN000; |- Make 2's complement
 28862 000019A2 83C201                  	add	dx,1			;AN000; |
 28863 000019A5 83D100                  	adc	cx,0			;AN000; +
 28864                                  
 28865                                  _$P_Value01:				;AN000; / nval = 0
 28866 000019A8 268B7706                	mov	si,[es:bx+_$P_Control_Blk.Value_List] ;AN000; si points to value list
 28867 000019AC 268A04                  	mov	al,[es:si]		;AN000; get nval
 28868                                  	; 07/09/2023
 28869                                  	;cmp	al,_$P_nval_None ; 0	;AN000; no value list ?
 28870                                  	;;*jne	short _$P_Value02	;AN000;
 28871                                  	;;* 07/07/2023
 28872                                  	;je	short _$P_Value05
 28873                                  	; 07/09/2023
 28874 000019AF 08C0                    	or	al,al
 28875 000019B1 7459                    	jz	short _$P_Value05 ; _$P_nval_None
 28876                                  
 28877                                  	;mov	al,_$P_Number		;AN000; Set type
 28878                                  	;mov	ah,_$P_No_Tag		;AN000; No ITEM_TAG set
 28879                                  	; 07/07/2023
 28880                                  	;*mov	ax,(_$P_No_Tag<<8)|_$P_Number
 28881                                  	;*jmp	short _$P_Value_Exit	;AN000;
 28882                                  
 28883                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS, SYSINIT compatibility)
 28884                                  	; (SYSINIT:1BA5h)
 28885                                  	; 12/12/2022
 28886                                  	;nop	; db  90h
 28887                                  
 28888                                  _$P_Value02:				;AN000; / nval = 1
 28889                                  ;IF	Val1SW				;AN000;(Check if value list id #1 is supported)
 28890                                  ;(tm07) cmp	al,_$P_nval_Range	;AN000; have range list ?
 28891                                  ;(tm07) jne	short _$P_Value03	;AN000;
 28892                                  
 28893 000019B3 46                      	inc	si			;AN000;
 28894 000019B4 268A04                  	mov	al,[es:si]		;AN000; al = number of range
 28895                                  	
 28896                                  	; 07/09/2023
 28897                                  	;cmp	al,_$P_No_nrng		;AN000; (tm07)
 28898                                  	;je	short _$P_Value03	;AN000; (tm07)
 28899 000019B7 08C0                    	or	al,al
 28900 000019B9 745D                    	jz	short _$P_Value03 ; _$P_No_nrng
 28901                                  
 28902 000019BB 46                      	inc	si			;AN000; si points to 1st item_tag
 28903                                  _$P_Val02_Loop:				;AN000;
 28904 000019BC 2EF606[CC14]80          	test	byte [cs:_$P_Flags2],_$P_Signed ;AC034;
 28905 000019C2 751E                    	jnz	short _$P_Val02_Sign	;AN000;
 28906                                  
 28907 000019C4 263B4C03                	cmp	cx,[es:si+_$P_Val_List.Val_XH] ;AN000; comp cx with XH
 28908 000019C8 7234                    	jb	short _$P_Val02_Next	;AN000;
 28909 000019CA 7706                    	ja	short _$P_Val_In	;AN000;
 28910                                  
 28911 000019CC 263B5401                	cmp	dx,[es:si+_$P_Val_List.Val_XL] ;AN000; comp dx with XL
 28912 000019D0 722C                    	jb	short _$P_Val02_Next	;AN000;
 28913                                  
 28914                                  _$P_Val_In:				;AN000;
 28915 000019D2 263B4C07                	cmp	cx,[es:si+_$P_Val_List.Val_YH] ;AN000; comp cx with YH (tm01)
 28916 000019D6 7726                    	ja	short _$P_Val02_Next	;AN000;
 28917 000019D8 7237                    	jb	short _$P_Val_Found	;AN000;
 28918                                  
 28919 000019DA 263B5405                	cmp	dx,[es:si+_$P_Val_List.Val_YL] ;AN000; comp dx with YL
 28920 000019DE 771E                    	ja	short _$P_Val02_Next	;AN000;
 28921                                  
 28922 000019E0 EB2F                    	jmp	short _$P_Val_Found	;AN000;
 28923                                  
 28924                                  _$P_Val02_Sign:				;AN000;
 28925 000019E2 263B4C03                	cmp	cx,[es:si+_$P_Val_List.Val_XH]	;AN000; comp cx with XH
 28926 000019E6 7C16                    	jl	short _$P_Val02_Next	;AN000;
 28927 000019E8 7F06                    	jg	short _$P_SVal_In	;AN000;
 28928                                  
 28929 000019EA 263B5401                	cmp	dx,[es:si+_$P_Val_List.Val_XL]	;AN000; comp dx with XL
 28930 000019EE 7C0E                    	jl	short _$P_Val02_Next	;AN000;
 28931                                  
 28932                                  _$P_SVal_In:				;AN000;
 28933 000019F0 263B4C07                	cmp	cx,[es:si+_$P_Val_List.Val_YH]	;AN000; comp cx with YH
 28934 000019F4 7F08                    	jg	short _$P_Val02_Next	;AN000;
 28935                                  
 28936 000019F6 7C19                    	jl	short _$P_Val_Found	;AN000;
 28937                                  
 28938 000019F8 263B5405                	cmp	dx,[es:si+_$P_Val_List.Val_YL]	;AN000; comp dx with YL
 28939                                  	;jg	short _$P_Val02_Next	;AN000;
 28940                                  	;jmp	short _$P_Val_Found	;AN000;
 28941                                  	; 07/07/2023
 28942 000019FC 7E13                    	jng	short _$P_Val_Found
 28943                                  
 28944                                  _$P_Val02_Next:				;AN000;
 28945 000019FE 83C609                  	add	si,_$P_Len_Range 	;AN000;
 28946 00001A01 FEC8                    	dec	al			;AN000; loop nrng times in AL
 28947 00001A03 75B7                    	jne	short _$P_Val02_Loop	;AN000;
 28948                                  					; / Not found
 28949 00001A05 2EC706[C014]0600        	mov	word [cs:_$P_RC],_$P_Out_Of_Range ;AC034;
 28950                                  	;mov	al,_$P_Number		;AN000;
 28951                                  	;mov	ah,_$P_No_Tag		;AN000; No ITEM_TAG set
 28952                                  _$P_Value05:		;* 07/07/2023
 28953                                  	; 07/07/2023
 28954 00001A0C B801FF                  	mov	ax,(_$P_No_Tag<<8)|_$P_Number
 28955 00001A0F EB11                    	jmp	short _$P_Value_Exit	;AN000;
 28956                                  
 28957                                  _$P_Val_Found:				;AN000;
 28958 00001A11 B001                    	mov	al,_$P_Number		;AN000;
 28959 00001A13 268A24                  	mov	ah,[es:si]		;AN000; found ITEM_TAG set
 28960 00001A16 EB0A                    	jmp	short _$P_Value_Exit	;AN000;
 28961                                  
 28962                                  _$P_Value03:				;AN000; / nval = 2
 28963                                  
 28964                                  ;IF	Val2SW				;AN000;(Check if value list id #2 is supported)
 28965                                  ;;;;	cmp	al,$P_nval_Value	; have match list ? ASSUME nval=2,
 28966                                  ;;;;	jne	$P_Value04		; even if it is 3 or more.
 28967                                  ;(tm07) inc	si			;AN000;
 28968                                  ;(tm07) mov	al,es:[si]		;AN000; al = nrng
 28969                                  ;	mov	ah,$P_Len_Range 	;AN000;
 28970                                  ;	mul	ah			;AN000;  Skip nrng field
 28971                                  ;	inc	ax			;AN000;
 28972                                  ;	add	si,ax			;AN000; si points to nnval
 28973                                  ;	mov	al,es:[si]		;AN000; get nnval
 28974                                  ;	inc	si			;AN000; si points to 1st item_tag
 28975                                  ;$P_Val03_Loop:				;AN000;
 28976                                  ;	cmp	cx,es:[si+$P_Val_XH]	;AN000; comp cx with XH
 28977                                  ;	jne	$P_Val03_Next		;AN000;
 28978                                  ;
 28979                                  ;	cmp	dx,es:[si+$P_Val_XL]	;AN000; comp dx with XL
 28980                                  ;	je	$P_Val_Found		;AN000;
 28981                                  ;
 28982                                  ;$P_Val03_Next:				;AN000;
 28983                                  ;	add	si,$P_Len_Value 	;AN000; points to next value choice
 28984                                  ;	dec	al			;AN000; loop nval times in AL
 28985                                  ;	jne	$P_Val03_Loop		;AN000;
 28986                                  ;					;AN000; / Not found
 28987                                  ;	mov	psdata_seg:$P_RC,$P_Not_in_Val ;AC034;
 28988                                  ;	mov	al,$P_Number		;AN000;
 28989                                  ;	mov	ah,$P_No_Tag		;AN000; No ITEM_TAG set
 28990                                  ;	jmp	short $P_Value_Exit	;AN000;
 28991                                  ;
 28992                                  ;ENDIF					;AN000;(of Val2SW)
 28993                                  ;$P_Value04:
 28994                                  
 28995                                  _$P_Value_Err:				;AN000;
 28996 00001A18 2EC706[C014]0900        	mov	word [cs:_$P_RC],_$P_Syntax ;AC034;
 28997                                  	;mov	al,_$P_String		;AN000; Set type
 28998                                  	;mov	ah,_$P_No_Tag		;AN000; No ITEM_TAG set
 28999                                  	; 07/09/2023
 29000                                  	; 07/07/2023
 29001 00001A1F B803FF                  	mov	ax,(_$P_No_Tag<<8)|_$P_String
 29002                                  _$P_Value_Exit:				;AN000;
 29003 00001A22 E851FD                  	call	_$P_Fill_Result		;AN000;
 29004 00001A25 5E                      	pop	si			;AN000;
 29005 00001A26 5A                      	pop	dx			;AN000;
 29006 00001A27 59                      	pop	cx			;AN000;
 29007 00001A28 58                      	pop	ax			;AN000;
 29008 00001A29 C3                      	retn				;AN000;
 29009                                  
 29010                                  ; 28/03/2019 - Retro DOS v4.0
 29011                                  
 29012                                  ;***********************************************************************
 29013                                  ; _$P_Check_OVF
 29014                                  ;
 29015                                  ; Function:  Check if overflow is occurred with consideration of
 29016                                  ;	     signed or un-signed numeric value
 29017                                  ;
 29018                                  ; Input:     Flag register
 29019                                  ;
 29020                                  ; Output:    CY = 1  :	Overflow
 29021                                  ;
 29022                                  ; Vars:     _$P_Flags(R)
 29023                                  ;***********************************************************************
 29024                                  
 29025                                  	; 26/10/2022
 29026                                  _$P_Check_OVF:
 29027 00001A2A 9C                      	pushf				;AN000;
 29028 00001A2B 2EF606[CC14]02          	test	byte [cs:_$P_Flags2],_$P_Neg ;AC034; is it negative value ?
 29029 00001A31 7502                    	jnz	short _$P_COVF 		;AN000; if no, check overflow
 29030                                  
 29031 00001A33 9D                      	popf				;AN000; by the CY bit
 29032 00001A34 C3                      	retn				;AN000;
 29033                                  
 29034                                  _$P_COVF:				;AN000;
 29035 00001A35 9D                      	popf				;AN000; else,
 29036 00001A36 7002                    	jo	short _$P_COVF00	;AN000; check overflow by the OF
 29037                                  
 29038 00001A38 F8                      	clc				;AN000; indicate it with CY bit
 29039 00001A39 C3                      	retn				;AN000; CY=0 means no overflow
 29040                                  
 29041                                  _$P_COVF00:				;AN000;
 29042 00001A3A F9                      	stc				;AN000; and CY=1 means overflow
 29043 00001A3B C3                      	retn				;AN000;
 29044                                  
 29045                                  ;***********************************************************************
 29046                                  ; _$P_0099;
 29047                                  ;
 29048                                  ; Function:  Make ASCII 0-9 to Binary 0-9
 29049                                  ;
 29050                                  ; Input:     AL = character code
 29051                                  ;
 29052                                  ; Output:    CY = 1 : AL is not number
 29053                                  ;	     CY = 0 : AL contains binary value
 29054                                  ;***********************************************************************
 29055                                  
 29056                                  ; 08/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 29057                                  %if 0
 29058                                  _$P_0099:
 29059                                  	cmp	al,"0"                  ;AN000;
 29060                                  	;jb	short _$P_0099Err	;AN000; must be 0 =< al =< 9
 29061                                  	; 12/12/2022
 29062                                  	jb	short _$P_0099Err2  ; cf=1
 29063                                  
 29064                                  	cmp	al,"9"                  ;AN000;
 29065                                  	ja	short _$P_0099Err	;AN000; must be 0 =< al =< 9
 29066                                  
 29067                                  	sub	al,"0"                  ;AN000; make char -> bin
 29068                                  	; 12/12/2022
 29069                                  	; cf=0	
 29070                                  	;clc				;AN000; indicate no error
 29071                                  	retn				;AN000;
 29072                                  
 29073                                  _$P_0099Err:				;AN000;
 29074                                  	stc				;AN000; indicate error
 29075                                  _$P_0099Err2: ; 12/12/2022	
 29076                                  	retn				;AN000;
 29077                                  %endif
 29078                                  
 29079                                  ; 08/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 29080                                  %if 1
 29081                                  _$P_0099:
 29082 00001A3C 3C30                    	cmp	al,"0"                  ; cmp al,30h
 29083 00001A3E 7207                    	jb	short _$P_0099Err	; must be 0 =< al =< 9
 29084 00001A40 3C3A                    	cmp	al,"9"+1                ; cmp al,3Ah  
 29085 00001A42 F5                      	cmc				; cf=0 -> cf=1
 29086 00001A43 7202                    	jb	short _$P_0099Err
 29087 00001A45 2C30                    	sub	al,"0"	; sub al,30h 	; make char -> bin
 29088                                  	; cf=0
 29089                                  _$P_0099Err:	; cf=1
 29090 00001A47 C3                      	retn
 29091                                  %endif	
 29092                                  
 29093                                  ;***********************************************************************
 29094                                  ; _$P_Simple_String
 29095                                  ;
 29096                                  ; Function:  See value list for the simple string
 29097                                  ;	     and make result buffer.
 29098                                  ;
 29099                                  ; Input:     cs:SI -> _$P_STRING_BUF
 29100                                  ;	     ES:BX -> CONTROL block
 29101                                  ;
 29102                                  ; Output:    None
 29103                                  ;
 29104                                  ; Use:	_$P_Fill_Result, _$P_String_Comp
 29105                                  ;
 29106                                  ; Vars: _$P_RC(W)
 29107                                  ;***********************************************************************
 29108                                  
 29109                                  _$P_Simple_String:
 29110 00001A48 50                      	push	ax			;AN000;
 29111 00001A49 53                      	push	bx			;AN000;
 29112 00001A4A 52                      	push	dx			;AN000;
 29113 00001A4B 57                      	push	di			;AN000;
 29114 00001A4C 268B7F06                	mov	di,[es:bx+_$P_Control_Blk.Value_List] ;AN000; di points to value list
 29115 00001A50 268A05                  	mov	al,[es:di]		;AN000; get nval
 29116 00001A53 08C0                    	or	al,al			;AN000; no value list ?
 29117 00001A55 7504                    	jnz	short _$P_Sim00		;AN000; then
 29118                                  
 29119 00001A57 B4FF                    	mov	ah,_$P_No_Tag		;AN000; No ITEM_TAG set
 29120 00001A59 EB4C                    	jmp	short _$P_Sim_Exit	;AN000; and set result buffer
 29121                                  
 29122                                  _$P_Sim00:				;AN000;
 29123                                  ;IF	Val3SW+KeySW			;AN000;(Check if keyword or value list id #3 is supported)
 29124 00001A5B 3C03                    	cmp	al,_$P_nval_String	;AN000; String choice list provided ?
 29125 00001A5D 753F                    	jne	short _$P_Sim01		;AN000; if no, syntax error
 29126                                  
 29127 00001A5F 47                      	inc	di			;AN000;
 29128 00001A60 268A05                  	mov	al,[es:di]		;AN000; al = nrng
 29129 00001A63 B409                    	mov	ah,_$P_Len_Range 	;AN000;
 29130 00001A65 F6E4                    	mul	ah			;AN000; Skip nrng field
 29131 00001A67 40                      	inc	ax			;AN000; ax = (nrng*9)+1
 29132 00001A68 01C7                    	add	di,ax			;AN000; di points to nnval
 29133 00001A6A 268A05                  	mov	al,[es:di]		;AN000; get nnval
 29134 00001A6D B405                    	mov	ah,_$P_Len_Value 	;AN000;
 29135 00001A6F F6E4                    	mul	ah			;AN000; Skip nnval field
 29136 00001A71 40                      	inc	ax			;AN000; ax = (nnval*5)+1
 29137 00001A72 01C7                    	add	di,ax			;AN000; di points to nstrval
 29138 00001A74 268A05                  	mov	al,[es:di]		;AN000; get nstrval c
 29139 00001A77 47                      	inc	di			;AC035; add '2' to
 29140 00001A78 47                      	inc	di			;AC035;  DI reg
 29141                                  					;AN000; di points to 1st string in list
 29142                                  _$P_Sim_Loop:				;AN000;
 29143 00001A79 268B2D                  	mov	bp,[es:di]		;AN000; get string pointer
 29144 00001A7C E83200                  	call	_$P_String_Comp		;AN000; compare it with operand
 29145 00001A7F 7312                    	jnc	short _$P_Sim_Found	;AN000; found on list ?
 29146                                  
 29147 00001A81 83C703                  	add	di,_$P_Len_String ; 3	;AN000; if no, point to next choice
 29148 00001A84 FEC8                    	dec	al			;AN000; loop nstval times in AL
 29149 00001A86 75F1                    	jne	short _$P_Sim_Loop	;AN000;
 29150                                  					;AN000; / Not found
 29151 00001A88 2EC706[C014]0800        	mov	word [cs:_$P_RC],_$P_Not_In_Str ;AC034;
 29152 00001A8F B4FF                    	mov	ah,_$P_No_Tag		;AN000; No ITEM_TAG set
 29153 00001A91 EB14                    	jmp	short _$P_Sim_Exit	;AN000;
 29154                                  
 29155                                  _$P_Sim_Found:				;AN000;
 29156 00001A93 268A65FF                	mov	ah,[es:di-1]		;AN000; set item_tag
 29157 00001A97 B002                    	mov	al,_$P_List_Idx		;AN000;
 29158 00001A99 268B15                  	mov	dx,[es:di]		;AN000; get address of STRING
 29159 00001A9C EB0B                    	jmp	short _$P_Sim_Exit0	;AN000;
 29160                                  ;ENDIF					;AN000;(of Val3SW+KeySW)
 29161                                  _$P_Sim01:				;AN000;
 29162 00001A9E 2EC706[C014]0900        	mov	word [cs:_$P_RC],_$P_Syntax ;AC034;
 29163 00001AA5 B4FF                    	mov	ah,_$P_No_Tag		;AN000; No ITEM_TAG set
 29164                                  _$P_Sim_Exit:				;AN000;
 29165 00001AA7 B003                    	mov	al,_$P_String		;AN000; Set type
 29166                                  _$P_Sim_Exit0:				;AN000;
 29167 00001AA9 E8CAFC                  	call	_$P_Fill_Result		;AN000;
 29168 00001AAC 5F                      	pop	di			;AN000;
 29169 00001AAD 5A                      	pop	dx			;AN000;
 29170 00001AAE 5B                      	pop	bx			;AN000;
 29171 00001AAF 58                      	pop	ax			;AN000;
 29172 00001AB0 C3                      	retn				;AN000;
 29173                                  
 29174                                  ;***********************************************************************
 29175                                  ; _$P_String_Comp:
 29176                                  ;
 29177                                  ; Function:  Compare two string
 29178                                  ;
 29179                                  ; Input:     cs:SI -> 1st string
 29180                                  ;	     ES:BP -> 2nd string  (Must be upper case)
 29181                                  ;	     ES:BX -> CONTROL block
 29182                                  ;
 29183                                  ; Output:    CY = 1 if not match
 29184                                  ;
 29185                                  ; Use:	_$P_Chk_DBCS, _$P_Do_CAPS_Char
 29186                                  ;
 29187                                  ; Vars: _$P_KEYor_SW_Ptr(W), _$P_Flags(R). _$P_KEYorSW_Ptr
 29188                                  ;***********************************************************************
 29189                                  
 29190                                  _$P_String_Comp:
 29191 00001AB1 50                      	push	ax			;AN000;
 29192 00001AB2 55                      	push	bp			;AN000;
 29193 00001AB3 52                      	push	dx			;AN000;
 29194 00001AB4 56                      	push	si			;AN000;
 29195 00001AB5 B202                    	mov	dl,_$P_DOSTBL_Char	;AN000; use character case map table
 29196                                  _$P_SCOM_Loop:				;AN000;
 29197 00001AB7 2E8A04                  	mov	al,[cs:si]		;AN000; get command character
 29198 00001ABA E81502                  	call	_$P_Chk_DBCS		;AN000; DBCS ?
 29199 00001ABD 723A                    	jc	short _$P_SCOM00	;AN000; yes,DBCS
 29200                                  
 29201 00001ABF E826FE                  	call	_$P_Do_CAPS_Char 	;AN000; else, upper case map before comparison
 29202                                  ;IF KeySW+SwSW				;AN000;(Check if keyword or switch is supported)
 29203 00001AC2 2EF606[CC14]08          	test	byte [cs:_$P_Flags2],_$P_Key_Cmp ;AC034; keyword search ?
 29204 00001AC8 740D                    	jz	short _$P_SCOM04	;AN000;
 29205                                  
 29206 00001ACA 3C3D                    	cmp	al,_$P_Keyword		;AN000; "=" is delimiter
 29207 00001ACC 751F                    	jne	short _$P_SCOM03	;AN000; IF "=" on command line AND  (bp+1=> char after the "=" in synonym list)
 29208                                  
 29209 00001ACE 26807E0100              	cmp	byte [es:bp+1],_$P_NULL ;AN021;  at end of keyword string in the control block THEN
 29210 00001AD3 756D                    	jne	short _$P_SCOM_Differ	;AN021;
 29211                                  
 29212 00001AD5 EB13                    	jmp	short _$P_SCOM05 	;AN000; keyword found in synonym list
 29213                                  
 29214                                  _$P_SCOM04:				;AN000;
 29215 00001AD7 2EF606[CC14]10          	test	byte [cs:_$P_Flags2],_$P_SW_Cmp ;AC034; switch search ?
 29216 00001ADD 740E                    	jz	short _$P_SCOM03	;AN000;
 29217                                  
 29218 00001ADF 3C3A                    	cmp	al,_$P_Colon		;AN000; ":" is delimiter, at end of switch on command line
 29219 00001AE1 750A                    	jne	short _$P_SCOM03	;AN000; continue compares
 29220                                  
 29221                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 29222                                  	;cmp	byte [es:bp+0],_$P_NULL
 29223                                  	; 11/12/2022
 29224 00001AE3 26807E0000              	cmp	byte [es:bp],_$P_NULL	;AN021; IF at end of switch on command AND
 29225 00001AE8 7558                    	jne	short _$P_SCOM_Differ	;AN021;   at end of switch string in the control block THEN
 29226                                  
 29227                                  _$P_SCOM05:				;AN000;   found a match
 29228 00001AEA 46                      	inc	si			;AN000; si points to just after "=" or ":"
 29229 00001AEB EB58                    	jmp	short _$P_SCOM_Same	;AN000; exit
 29230                                  
 29231                                  _$P_SCOM03:				;AN000;
 29232                                  ;ENDIF					;AN000;(of KeySW+SwSW)
 29233                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 29234                                  	;cmp	al,[es:bp+0]
 29235                                  	; 11/12/2022
 29236 00001AED 263A4600                	cmp	al,[es:bp]		;AN000; compare operand w/ a synonym
 29237 00001AF1 751B                    	jne	short _$P_SCOM_Differ0 	;AN000; if different, check ignore colon option
 29238                                  
 29239 00001AF3 08C0                    	or	al,al			;AN000; end of line
 29240 00001AF5 744E                    	jz	short _$P_SCOM_Same	;AN000; if so, exit
 29241                                  
 29242                                  	; 12/12/2022
 29243                                  	;inc	si			;AN000; update operand pointer
 29244                                  	;inc	bp			;AN000;    and synonym pointer
 29245                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 29246 00001AF7 EB11                    	jmp	short _$P_SCOM01 	;AN000; loop until NULL or "=" or ":" found in case
 29247                                  
 29248                                  _$P_SCOM00:				;AN000; Here al is DBCS leading byte
 29249                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 29250                                  	;cmp	al,[es:bp+0]
 29251                                  	; 11/12/2022
 29252 00001AF9 263A4600                	cmp	al,[es:bp]		;AN000; compare leading byte
 29253 00001AFD 7543                    	jne	short _$P_SCOM_Differ	;AN000; if not match, say different
 29254                                  
 29255 00001AFF 46                      	inc	si			;AN000; else, load next byte
 29256 00001B00 2E8A04                  	mov	al,[cs:si]		;AN000; and
 29257 00001B03 45                      	inc	bp			;AN000;
 29258                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 29259                                  	;cmp	al,[es:bp+0]
 29260                                  	; 11/12/2022
 29261 00001B04 263A4600                	cmp	al,[es:bp]		;AN000; compare 2nd byte
 29262 00001B08 7538                    	jne	short _$P_SCOM_Differ	;AN000; if not match, say different, too
 29263                                  
 29264                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 29265                                  	; 12/12/2022
 29266                                  _$P_SCOM01:
 29267 00001B0A 46                      	inc	si			;AN000; else update operand pointer
 29268 00001B0B 45                      	inc	bp			;AN000; 		and synonym pointer
 29269                                  ;_$P_SCOM01:				;AN000;
 29270 00001B0C EBA9                    	jmp	short _$P_SCOM_Loop	;AN000; loop until NULL or "=" or "/" found in case
 29271                                  
 29272                                  _$P_SCOM_Differ0:			;AN000;
 29273                                  ;IF SwSW				;AN000;(tm10)
 29274 00001B0E 2EF606[CC14]40          	test	byte [cs:_$P_Flags2],_$P_SW ;AC034;(tm10)
 29275 00001B14 740E                    	jz	short _$P_not_applicable ;AN000;(tm10)
 29276                                  
 29277                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 29278                                  	;test	word [es:bx+_$P_Control_Blk.Function_Flag],_$P_colon_is_not_necessary ;AN000;(tm10)
 29279                                  	; 12/12/2022
 29280 00001B16 26F6470220              	test	byte [es:bx+_$P_Control_Blk.Function_Flag],_$P_colon_is_not_necessary
 29281 00001B1B 7407                    	je	short _$P_not_applicable ;AN000;(tm10)
 29282                                  
 29283                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)	
 29284                                  	;cmp	byte [es:bp+0],_$P_NULL
 29285                                  	; 11/12/2022
 29286 00001B1D 26807E0000              	cmp	byte [es:bp],_$P_NULL	;AN000;(tm10)
 29287                                  ;(deleted ;AN025;) jne short _$P_not_applicable ;AN000;(tm10)
 29288 00001B22 7421                    	je	short _$P_SCOM_Same	;AN025;(tm10)
 29289                                  
 29290                                  _$P_not_applicable:			;AN000;(tm10)
 29291                                  ;ENDIF					;AN000;(tm10)
 29292                                  
 29293                                  	;test	word [es:bx+_$P_Control_Blk.Match_Flag],_$P_Ig_Colon 
 29294                                  					;AN000; ignore colon option specified ?
 29295                                  	;test	byte [es:bx+_$P_Control_Blk.Match_Flag],_$P_Ig_Colon
 29296                                  	; 12/12/2022
 29297 00001B24 26F60710                	test	byte [es:bx],_$P_Ig_Colon
 29298                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)	
 29299                                  	;test	word [es:bx],_$P_Ig_Colon ; 10h
 29300 00001B28 7418                    	jz	short _$P_SCOM_Differ	;AN000; if no, say different.
 29301                                  
 29302 00001B2A 3C3A                    	cmp	al,_$P_Colon		;AN000; End up with ":" and
 29303 00001B2C 7509                    	jne	short _$P_SCOM02	;AN000;    subseqently
 29304                                  
 29305                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)	
 29306                                  	;cmp	byte [es:bp+0],_$P_NULL
 29307                                  	; 11/12/2022
 29308 00001B2E 26807E0000              	cmp	byte [es:bp],_$P_NULL	;AN000; NULL ?
 29309 00001B33 750D                    	jne	short _$P_SCOM_Differ	;AN000; if no, say different
 29310                                  
 29311 00001B35 EB0E                    	jmp	short _$P_SCOM_Same	;AN000; else, say same
 29312                                  
 29313                                  _$P_SCOM02:				;AN000;
 29314 00001B37 3C00                    	cmp	al,_$P_NULL		;AN000; end up NULL and :
 29315 00001B39 7507                    	jne	short _$P_SCOM_Differ	;AN000;
 29316                                  
 29317                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)	
 29318                                  	;cmp	byte [es:bp+0],_$P_Colon
 29319                                  	; 11/12/2022
 29320 00001B3B 26807E003A              	cmp	byte [es:bp],_$P_Colon	;AN000; if no, say different
 29321 00001B40 7403                    	je	short _$P_SCOM_Same	;AN000; else, say same
 29322                                  
 29323                                  _$P_SCOM_Differ: 			;AN000;
 29324 00001B42 F9                      	stc				;AN000; indicate not found
 29325 00001B43 EB05                    	jmp	short _$P_SCOM_Exit	;AN000;
 29326                                  
 29327                                  _$P_SCOM_Same:				;AN000;
 29328                                  	; 12/12/2022
 29329                                  	; cf=0
 29330 00001B45 2E8936[CF14]            	mov	[cs:_$P_KEYorSW_Ptr],si ;AC034; for later use by keyword or switch
 29331                                  	; 12/12/2022
 29332                                  	;clc				;AN000; indicate found
 29333                                  _$P_SCOM_Exit:				;AN000;
 29334 00001B4A 5E                      	pop	si			;AN000;
 29335 00001B4B 5A                      	pop	dx			;AN000;
 29336 00001B4C 5D                      	pop	bp			;AN000;
 29337 00001B4D 58                      	pop	ax			;AN000;
 29338 00001B4E C3                      	retn
 29339                                  
 29340                                  ; 30/03/2019
 29341                                  
 29342                                  ;IF FileSW+DrvSW			;AN000;(Check if file spec or drive only is supported)
 29343                                  
 29344                                  ;***********************************************************************
 29345                                  ; _$P_File_Format;
 29346                                  ;
 29347                                  ; Function:  Check if the input string is valid file spec format.
 29348                                  ;	     And set the result buffer.
 29349                                  ;
 29350                                  ; Input:     cs:SI -> _$P_STRING_BUF
 29351                                  ;	     ES:BX -> CONTROL block
 29352                                  ;
 29353                                  ; Output:    None
 29354                                  ;
 29355                                  ; Use:	_$P_Fill_Result, _$P_Chk_DBCS, _$P_FileSp_Chk
 29356                                  ;
 29357                                  ; Vars: _$P_RC(W), _$P_SI_Save(W), _$P_Terminator(W), _$P_SaveSI_Cmpx(R)
 29358                                  ;	_$P_SaveSI_Cmpx(R)
 29359                                  ;***********************************************************************
 29360                                  
 29361                                  _$P_File_Format:
 29362 00001B4F 50                      	push	ax			;AN000;
 29363 00001B50 57                      	push	di			;AN000;
 29364 00001B51 56                      	push	si			;AN000;
 29365 00001B52 2E8B3E[CD14]            	mov	di,[cs:_$P_SaveSI_Cmpx]	;AC034; get user buffer address
 29366                                  _$P_FileF_Loop0: 			;AN000; / skip special characters
 29367 00001B57 2E8A04                  	mov	al,[cs:si]		;AN000; load character
 29368 00001B5A 08C0                    	or	al,al			;AN000; end of line ?
 29369 00001B5C 7413                    	jz	short _$P_FileF_Err	;AN000; if yes, error exit
 29370                                  
 29371 00001B5E E85D00                  	call	_$P_FileSp_Chk		;AN000; else, check if file special character
 29372 00001B61 7523                    	jne	short _$P_FileF03	;AN000; if yes,
 29373                                  
 29374 00001B63 2EC606[6315]01          	mov	byte [cs:_$P_err_flag],_$P_error_filespec 
 29375                                  					;AN033;AC034;; set error flag- bad char.
 29376 00001B69 5E                      	pop	si			;AN033;
 29377 00001B6A 2EC60400                	mov	byte [cs:si],_$P_NULL	;AN033;
 29378 00001B6E 5F                      	pop	di			;AN033;
 29379 00001B6F EB3E                    	jmp	short _$P_FileF02	;AN033;
 29380                                  
 29381                                  _$P_FileF_Err:				;AN000;
 29382 00001B71 5E                      	pop	si			;AN000;
 29383 00001B72 2EC60400                	mov	byte [cs:si],_$P_NULL	;AN000;
 29384 00001B76 5F                      	pop	di			;AN000;
 29385                                  
 29386                                  	;test	word [es:bx+_$P_Control_Blk.Match_Flag],_$P_Optional ;AN000; is it optional ?
 29387                                  	;test	byte [es:bx+_$P_Control_Blk.Match_Flag],_$P_Optional
 29388                                  	; 12/12/2022
 29389 00001B77 26F60701                	test	byte [es:bx],_$P_Optional
 29390                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)	
 29391                                  	;test	word [es:bx],_$P_Optional
 29392 00001B7B 7532                    	jnz	short _$P_FileF02	;AN000;
 29393                                  
 29394 00001B7D 2EC706[C014]0200        	mov	word [cs:_$P_RC],_$P_Op_Missing ;AC034; 3/17/87
 29395 00001B84 EB29                    	jmp	short _$P_FileF02	;AN000;
 29396                                  
 29397                                  _$P_FileF03:				;AN000;
 29398 00001B86 58                      	pop	ax			;AN000; discard save si
 29399 00001B87 56                      	push	si			;AN000; save new si
 29400                                  _$P_FileF_Loop1: 			;AN000;
 29401 00001B88 2E8A04                  	mov	al,[cs:si]		;AN000; load character (not special char)
 29402 00001B8B 08C0                    	or	al,al			;AN000; end of line ?
 29403 00001B8D 741E                    	jz	short _$P_FileF_RLT	;AN000;
 29404                                  
 29405 00001B8F E82C00                  	call	_$P_FileSp_Chk		;AN000; File special character ?
 29406 00001B92 740B                    	je	short _$P_FileF00	;AN000;
 29407                                  
 29408 00001B94 E83B01                  	call	_$P_Chk_DBCS		;AN000; no, then DBCS ?
 29409 00001B97 7302                    	jnc	short _$P_FileF01	;AN000;
 29410 00001B99 47                      	inc	di			;AN000; if yes, skip next byte
 29411 00001B9A 46                      	inc	si			;AN000;
 29412                                  _$P_FileF01:				;AN000;
 29413 00001B9B 47                      	inc	di			;AN000;
 29414 00001B9C 46                      	inc	si			;AN000;
 29415 00001B9D EBE9                    	jmp	short _$P_FileF_Loop1	;AN000;
 29416                                  ;
 29417                                  _$P_FileF00:				;AN000;
 29418 00001B9F 2EA2[C614]              	mov	[cs:_$P_Terminator],al	;AC034;
 29419 00001BA3 2EC60400                	mov	byte [cs:si],_$P_NULL	;AN000; update end of string
 29420 00001BA7 47                      	inc	di			;AN000;
 29421 00001BA8 2E893E[C214]            	mov	[cs:_$P_SI_Save],di	;AC034; update next pointer in command line
 29422                                  _$P_FileF_RLT:				;AN000;
 29423 00001BAD 5E                      	pop	si			;AN000;
 29424 00001BAE 5F                      	pop	di			;AN000;
 29425                                  _$P_FileF02:				;AN000;
 29426 00001BAF 58                      	pop	ax			;AN000; (tm14)
 29427                                  	;test	ax,_$P_File_Spc	; 200h	;AN000; (tm14)
 29428                                  	; 08/07/2023
 29429 00001BB0 F6C402                  	test	ah,(_$P_File_Spc>>8) ; 2
 29430 00001BB3 7408                    	jz	short _$P_Drv_Only_Exit	;AN000; (tm14)
 29431                                  
 29432 00001BB5 50                      	push	ax			;AN000; (tm14)
 29433                                  	;mov	ah,_$P_No_Tag		;AN000; set
 29434                                  	;mov	al,_$P_File_Spec 	;AN000; result
 29435                                  	; 08/07/2023
 29436 00001BB6 B805FF                  	mov	ax,(_$P_No_Tag<<8)|_$P_File_Spec ; 0FF05h
 29437                                  					      ; set result
 29438 00001BB9 E8BAFB                  	call	_$P_Fill_Result		;AN000; buffer to file spec
 29439 00001BBC 58                      	pop	ax			;AN000;
 29440                                  
 29441                                  _$P_Drv_Only_Exit:			;AN000; (tm14)
 29442 00001BBD C3                      	retn				;AN000;
 29443                                  
 29444                                  ;***********************************************************************
 29445                                  ; _$P_FileSp_Chk
 29446                                  ;
 29447                                  ; Function:  Check if the input byte is one of file special characters
 29448                                  ;
 29449                                  ; Input:     cs:SI -> _$P_STRING_BUF
 29450                                  ;	     AL = character code to be examineed
 29451                                  ;
 29452                                  ; Output:    ZF = 1 , AL is one of special characters
 29453                                  ;***********************************************************************
 29454                                  
 29455                                  _$P_FileSp_Chk:
 29456 00001BBE 53                      	push	bx			;AN000;
 29457 00001BBF 51                      	push	cx			;AN000;
 29458                                  	;;lea	bx,[cs:_$P_FileSp_Char] ;AC034; special character table
 29459                                  	;lea	bx,[_$P_FileSp_Char] 	; "[]|<>+=;\"" at
 29460                                  					; MSDOS 6.21 IO.SYS - SYSINIT:1838h
 29461                                  	; 07/09/2023
 29462 00001BC0 BB[5A15]                	mov	bx,_$P_FileSp_Char
 29463 00001BC3 B90900                  	mov	cx,_$P_FileSp_Len ; 9	;AN000; load length of it
 29464                                  _$P_FileSp_Loop: 			;AN000;
 29465 00001BC6 2E3A07                  	cmp	al,[cs:bx]		;AN000; is it one of special character ?
 29466 00001BC9 7404                    	je	short _$P_FileSp_Exit	;AN000;
 29467                                  
 29468 00001BCB 43                      	inc	bx			;AN000;
 29469 00001BCC E2F8                    	loop	_$P_FileSp_Loop		;AN000;
 29470                                  
 29471 00001BCE 41                      	inc	cx			;AN000; reset ZF
 29472                                  _$P_FileSp_Exit: 			;AN000;
 29473 00001BCF 59                      	pop	cx			;AN000;
 29474 00001BD0 5B                      	pop	bx			;AN000;
 29475 00001BD1 C3                      	retn
 29476                                  
 29477                                  ;ENDIF					;AN000;(of FileSW+DrvSW)
 29478                                  
 29479                                  ;IF	DrvSW				;AN000;(Check if drive only is supported)
 29480                                  
 29481                                  ;***********************************************************************
 29482                                  ; _$P_Drive_Format;
 29483                                  ;
 29484                                  ; Function:  Check if the input string is valid drive only format.
 29485                                  ;	     And set the result buffer.
 29486                                  ;
 29487                                  ; Input:     cs:SI -> _$P_STRING_BUF
 29488                                  ;	     ES:BX -> CONTROL block
 29489                                  ;
 29490                                  ; Output:    None
 29491                                  ;
 29492                                  ; Use:	_$P_Fill_Result, _$P_Chk_DBCS
 29493                                  ;
 29494                                  ; Vars: _$P_RC(W)
 29495                                  ;***********************************************************************
 29496                                  
 29497                                  _$P_Drive_Format:
 29498 00001BD2 50                      	push	ax			;AN000;
 29499 00001BD3 52                      	push	dx			;AN000;
 29500 00001BD4 2E8A04                  	mov	al,[cs:si]		;AN000;
 29501 00001BD7 08C0                    	or	al,al			;AN000; if null string
 29502 00001BD9 7436                    	je	short _$P_Drv_Exit	;AN000; do nothing
 29503                                  
 29504 00001BDB E8F400                  	call	_$P_Chk_DBCS		;AN000; is it leading byte ?
 29505 00001BDE 722A                    	jc	short _$P_Drv_Err	;AN000; (yes, error)
 29506                                  
 29507 00001BE0 2E837C013A              	cmp	word [cs:si+1],_$P_Colon ;AN000; "d",":", 0 ?
 29508 00001BE5 740D                    	je	short _$P_DrvF00	;AN000;
 29509                                  
 29510                                  	;test	word [es:bx+_$P_Control_Blk.Match_Flag],_$P_Ig_Colon 
 29511                                  	;test	byte [es:bx+_$P_Control_Blk.Match_Flag],_$P_Ig_Colon ;AN000; colon can be ignored?
 29512                                  	; 12/12/2022
 29513 00001BE7 26F60710                	test	byte [es:bx],_$P_Ig_Colon
 29514                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)	
 29515                                  	;test	word [es:bx],_$P_Ig_Colon
 29516 00001BEB 741D                    	jz	short _$P_Drv_Err	;AN000;
 29517                                  
 29518 00001BED 2E807C0100              	cmp	byte [cs:si+1],_$P_NULL ;AN000; "d",0 ?
 29519 00001BF2 7516                    	jne	short _$P_Drv_Err	;AN000;
 29520                                  
 29521                                  _$P_DrvF00:				;AN000;
 29522 00001BF4 0C20                    	or	al,_$P_Make_Lower	;AN000; lower case
 29523 00001BF6 3C61                    	cmp	al,"a"                  ;AN000; drive letter must
 29524 00001BF8 7210                    	jb	short _$P_Drv_Err	;AN000; in range of
 29525                                  
 29526 00001BFA 3C7A                    	cmp	al,"z"                  ;AN000; "a"-"z"
 29527 00001BFC 770C                    	ja	short _$P_Drv_Err	;AN000; if no, error
 29528                                  
 29529 00001BFE 2C60                    	sub	al,"a"-1                ;AN000; make text drive to binary drive
 29530 00001C00 88C2                    	mov	dl,al			;AN000; set
 29531                                  	;mov	ah,_$P_No_Tag		;AN000; result
 29532                                  	;mov	al,_$P_Drive		;AN000; buffer
 29533                                  	; 08/07/2023
 29534 00001C02 B806FF                  	mov	ax,(_$P_No_Tag<<8)|_$P_Drive ; 0FF06h
 29535                                  					      ; set result buffer
 29536 00001C05 E86EFB                  	call	_$P_Fill_Result		;AN000; to drive
 29537 00001C08 EB07                    	jmp	short _$P_Drv_Exit	;AN000;
 29538                                  
 29539                                  _$P_Drv_Err:				;AN000;
 29540 00001C0A 2EC706[C014]0900        	mov	word [cs:_$P_RC],_$P_Syntax ;AC034;
 29541                                  _$P_Drv_Exit:				;AN000;
 29542 00001C11 5A                      	pop	dx			;AN000;
 29543 00001C12 58                      	pop	ax			;AN000;
 29544 00001C13 C3                      	retn				;AN000;
 29545                                  
 29546                                  ;ENDIF					;AN000;(of DrvSW)
 29547                                  
 29548                                  ;***********************************************************************
 29549                                  ; _$P_Skip_Delim;
 29550                                  ;
 29551                                  ; Function: Skip delimiters specified in the PARMS list, white space
 29552                                  ;	    and comma.
 29553                                  ;
 29554                                  ; Input:    DS:SI -> Command String
 29555                                  ;	    ES:DI -> Parameter List
 29556                                  ;
 29557                                  ; Output:   CY = 1 if the end of line encounterd
 29558                                  ;	    CY = 0 then SI move to 1st non-delimiter character
 29559                                  ;	    AL = Last examineed character
 29560                                  ;
 29561                                  ; Use:	    _$P_Chk_EOL, _$P_Chk_Delim,
 29562                                  ;
 29563                                  ; Vars:     _$P_Flags(R)
 29564                                  ;***********************************************************************
 29565                                  
 29566                                  _$P_Skip_Delim:
 29567                                  _$P_Skip_Delim_Loop:			;AN000;
 29568 00001C14 AC                      	lodsb				;AN000;
 29569 00001C15 E81E00                  	call	_$P_Chk_EOL		;AN000; is it EOL character ?
 29570 00001C18 7416                    	jz	short _$P_Skip_Delim_CY	;AN000; if yes, exit w/ CY on
 29571                                  
 29572 00001C1A E84E00                  	call	_$P_Chk_Delim		;AN000; is it one of delimiters ?
 29573 00001C1D 7514                    	jnz	short _$P_Skip_Delim_NCY ;AN000; if no, exit w/ CY off
 29574                                  
 29575 00001C1F 2EF606[CC14]20          	test	byte [cs:_$P_Flags2],_$P_Extra ;AC034; extra delim or comma found ?
 29576 00001C25 74ED                    	jz	short _$P_Skip_Delim_Loop ;AN000; if no, loop
 29577                                  
 29578 00001C27 2EF606[CC14]41          	test	byte [cs:_$P_Flags2],_$P_SW+_$P_equ ;AC034; /x , or xxx=zzz , (tm08)
 29579                                  	;jz	short _$P_Exit_At_Extra	;AN000; no switch, no keyword (tm08)
 29580                                  	; 08/07/2023
 29581                                  	; cf=0
 29582 00001C2D 7505                    	jnz	short _$P_Skip_Delim_Exit
 29583 00001C2F C3                      	retn
 29584                                  
 29585                                  	;dec	si			;AN000; backup si for next call (tm08)
 29586                                  	;jmp	short _$P_Exit_At_Extra	;AN000; else exit w/ CY off
 29587                                  	; 12/12/2022
 29588                                  	; cf=0
 29589                                  	; 08/07/2023
 29590                                  	;jmp	short _$P_Skip_Delim_Exit
 29591                                  
 29592                                  _$P_Skip_Delim_CY:			;AN000;
 29593 00001C30 F9                      	stc				;AN000; indicate EOL
 29594 00001C31 EB01                    	jmp	short _$P_Skip_Delim_Exit ;AN000;
 29595                                  
 29596                                  _$P_Skip_Delim_NCY:			;AN000;
 29597 00001C33 F8                      	clc				;AN000; indicate non delim
 29598                                  _$P_Skip_Delim_Exit:			;AN000; in this case, need
 29599 00001C34 4E                      	dec	si			;AN000;  backup index pointer
 29600                                  	; 08/07/2023
 29601                                  	; 12/12/2022
 29602                                  ;_$P_Exit_At_Extra:	 ; cf=0
 29603 00001C35 C3                      	retn				;AN000;
 29604                                  
 29605                                  	; 12/12/2022
 29606                                  ;_$P_Exit_At_Extra:			;AN000;
 29607                                  	;clc				;AN000; indicate extra delim
 29608                                  	;retn				;AN000;
 29609                                  
 29610                                  ;***********************************************************************
 29611                                  ; _$P_Chk_EOL;
 29612                                  ;
 29613                                  ; Function: Check if AL is one of End of Line characters.
 29614                                  ;
 29615                                  ; Input:    AL = character code
 29616                                  ;	    ES:DI -> Parameter List
 29617                                  ;
 29618                                  ; Output:   ZF = 1 if one of End of Line characters
 29619                                  ;**********************************************************************
 29620                                  
 29621                                  _$P_Chk_EOL:
 29622 00001C36 53                      	push	bx			;AN000;
 29623 00001C37 51                      	push	cx			;AN000;
 29624 00001C38 3C0D                    	cmp	al,_$P_CR		;AN000; Carriage return ?
 29625 00001C3A 742C                    	je	short _$P_Chk_EOL_Exit 	;AN000;
 29626 00001C3C 3C00                    	cmp	al,_$P_NULL		;AN000; zero ?
 29627 00001C3E 7428                    	je	short _$P_Chk_EOL_Exit 	;AN000;
 29628                                  ;IF LFEOLSW				;AN028; IF LF TO BE ACCEPTED AS EOL
 29629 00001C40 3C0A                    	cmp	al,_$P_LF		;AN000; Line feed ?
 29630 00001C42 7424                    	je	short _$P_Chk_EOL_Exit 	;AN000;
 29631                                  ;ENDIF					;AN028;
 29632 00001C44 26807D0202              	cmp	byte [es:di+_$P_PARMS_Blk.Num_Extra],_$P_I_Have_EOL 
 29633                                  					;AN000; EOL character specified ?
 29634 00001C49 721D                    	jb	short _$P_Chk_EOL_Exit 	;AN000;
 29635 00001C4B 31DB                    	xor	bx,bx			;AN000;
 29636 00001C4D 268A5D03                	mov	bl,[es:di+_$P_PARMS_Blk.Len_Extra_Delim]
 29637                                  					;AN000; get length of delimiter list
 29638 00001C51 83C304                  	add	bx,_$P_Len_PARMS 	;AN000; skip it
 29639                                  	; 08/07/2023
 29640 00001C54 31C9                    	xor	cx,cx ; *
 29641 00001C56 26803900                	cmp	byte [es:bx+di],_$P_I_Use_Default ;AN000; No extra EOL character ?
 29642 00001C5A 740B                    	je	short _$P_Chk_EOL_NZ	;AN000;
 29643                                  	; 08/07/2023
 29644                                  	;;xor	cx,cx			;AN000; Get number of extra character
 29645                                  	;xor	ch,ch ; *
 29646 00001C5C 268A09                  	mov	cl,[es:bx+di]		;AN000; 
 29647                                  _$P_Chk_EOL_Loop:			;AN000;
 29648 00001C5F 43                      	inc	bx			;AN000;
 29649 00001C60 263A01                  	cmp	al,[es:bx+di]		;AN000; Check extra EOL character
 29650 00001C63 7403                    	je	short _$P_Chk_EOL_Exit 	;AN000;
 29651 00001C65 E2F8                    	loop	_$P_Chk_EOL_Loop 	;AN000;
 29652                                  	; 08/07/2023
 29653                                  	; cx=0
 29654                                  _$P_Chk_EOL_NZ:				;AN000;
 29655                                  	;cmp	al,_$P_CR		;AN000; reset ZF
 29656                                  	; 08/07/2023
 29657 00001C67 41                      	inc	cx  ; zf=0  (cx=1) ; *
 29658                                  _$P_Chk_EOL_Exit:			;AN000;
 29659 00001C68 59                      	pop	cx			;AN000;
 29660 00001C69 5B                      	pop	bx			;AN000;
 29661 00001C6A C3                      	retn
 29662                                  
 29663                                  ;***********************************************************************
 29664                                  ; _$P_Chk_Delim;
 29665                                  ;
 29666                                  ; Function: Check if AL is one of delimiter characters.
 29667                                  ;	    if AL+[si] is DBCS blank, it is replaced with two SBCS
 29668                                  ;	    blanks.
 29669                                  ;
 29670                                  ; Input:    AL = character code
 29671                                  ;	    DS:SI -> Next Character
 29672                                  ;	    ES:DI -> Parameter List
 29673                                  ;
 29674                                  ; Output:   ZF = 1 if one of delimiter characters
 29675                                  ;	    SI points to the next character
 29676                                  ; Vars:  _$P_Terminator(W), _$P_Flags(W)
 29677                                  ;***********************************************************************
 29678                                   
 29679                                  	; 08/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 29680                                  	; MSDOS 6.21 IO.SYS - SYSINIT:1FAEh
 29681                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:2451h) ; (Retro DOS v5.0)
 29682                                  
 29683                                  _$P_Chk_Delim:
 29684 00001C6B 53                      	push	bx			;AN000;
 29685 00001C6C 51                      	push	cx			;AN000;
 29686 00001C6D 2EC606[C614]20          	mov	byte [cs:_$P_Terminator],_$P_Space 
 29687                                  					;AC034; Assume terminated by space
 29688                                  	;and	byte [cs:_$P_Flags20,0DFh
 29689 00001C73 2E8026[CC14]DF          	and	byte [cs:_$P_Flags2],0FFh-_$P_Extra ;AC034;
 29690 00001C79 3C20                    	cmp	al,_$P_Space ; 20h	;AN000; Space ?
 29691 00001C7B 7423                    	je	short _$P_Chk_Delim_Exit ;AN000;
 29692                                  
 29693 00001C7D 3C09                    	cmp	al,_$P_TAB		;AN000; TAB ?
 29694 00001C7F 741F                    	je	short _$P_Chk_Delim_Exit ;AN000;
 29695                                  
 29696 00001C81 3C2C                    	cmp	al,_$P_Comma		;AN000; Comma ?
 29697 00001C83 741E                    	je	short _$P_Chk_Delim_Exit0 ;AN000;
 29698                                  
 29699                                  ; Note: _$P_Chk_Delim00 part of code is nonsense here
 29700                                  ;        because _$P_Space = _$P_DBSP1 = 20h
 29701                                  ;        Erdogan Tan - 08/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 29702                                  ;_$P_Chk_Delim00:
 29703                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:246Bh)
 29704                                  	; (MSDOS 6.21 IO.SYS - SYSINIT:1FC8h)
 29705                                  %if 0
 29706                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 29707                                  _$P_Chk_Delim00: 			;AN000;
 29708                                  	cmp	al,_$P_DBSP1	; 20h	;AN000; 1st byte of DBCS Space ?
 29709                                  	jne	short _$P_Chk_Delim01	;AN000;
 29710                                  
 29711                                  	cmp	byte [si],_$P_DBSP2 ; 20h ;AN000; 2nd byte of DBCS Space ?
 29712                                  	jne	short _$P_Chk_Delim01	;AN000;
 29713                                  
 29714                                  	mov	al,_$P_Space		;AN000;
 29715                                  	inc	si			;AN000; make si point to next character
 29716                                  	cmp	al,al			;AN000; Set ZF
 29717                                  	jmp	short _$P_Chk_Delim_Exit ;AN000;
 29718                                  %endif
 29719                                  
 29720                                  _$P_Chk_Delim01: 			;AN000;
 29721 00001C85 26807DFE01              	cmp	byte [es:di-_$P_PARMS_Blk.Num_Extra],_$P_I_Have_Delim 
 29722                                  					;AN000; delimiter character specified ?
 29723 00001C8A 7214                    	jb	short _$P_Chk_Delim_Exit ;AN000;
 29724                                  
 29725                                  	;xor	cx,cx			;AN000;
 29726 00001C8C 30ED                    	xor	ch,ch
 29727                                  	;mov	cl,[es:di+3]
 29728 00001C8E 268A4D03                	mov	cl,[es:di+_$P_PARMS_Blk.Len_Extra_Delim] 
 29729                                  					;AN000; get length of delimiter list
 29730                                  	;or	cx,cx			;AN000; No extra Delim character ?
 29731                                  	;jz	short _$P_Chk_Delim_NZ 	;AN000;
 29732                                  	; 08/07/2023
 29733 00001C92 E30B                    	jcxz	_$P_Chk_Delim_NZ
 29734                                  
 29735 00001C94 BB0300                  	mov	bx,_$P_Len_PARMS-1 ; 3	;AN000; set bx to 1st extra delimiter
 29736                                  _$P_Chk_Delim_Loop:			;AN000;
 29737 00001C97 43                      	inc	bx			;AN000;
 29738 00001C98 263A01                  	cmp	al,[es:bx+di]		;AN000; Check extra Delim character
 29739 00001C9B 7406                    	je	short _$P_Chk_Delim_Exit0 ;AN000;
 29740                                  
 29741 00001C9D E2F8                    	loop	_$P_Chk_Delim_Loop	;AN000; examine all extra delimiter
 29742                                  
 29743                                  _$P_Chk_Delim_NZ:			;AN000;
 29744                                  	;cmp	al,_$P_Space		;AN000; reset ZF
 29745                                  	; 08/07/2023
 29746                                  	; cx=0 here
 29747 00001C9F 41                      	inc	cx ; cx=1, zf=0
 29748                                  _$P_Chk_Delim_Exit:			;AN000;
 29749                                  _$P_ChkDfin:				;AN000;
 29750 00001CA0 59                      	pop	cx			;AN000;
 29751 00001CA1 5B                      	pop	bx			;AN000;
 29752 00001CA2 C3                      	retn				;AN000;
 29753                                  
 29754                                  _$P_Chk_Delim_Exit0:			;AN000;
 29755 00001CA3 2EA2[C614]              	mov	[cs:_$P_Terminator],al ;AC034; keep terminated delimiter
 29756 00001CA7 2EF606[CC14]01          	test	byte [cs:_$P_Flags2],_$P_equ ;AN027;AC034;; if terminating a key=
 29757 00001CAD 7506                    	jnz	short _$P_No_Set_Extra 	;AN027; then do not set the EXTRA bit
 29758                                  
 29759 00001CAF 2E800E[CC14]20          	or	byte [cs:_$P_Flags2],_$P_Extra 
 29760                                  					;AC034; flag terminated extra delimiter or comma
 29761                                  _$P_No_Set_Extra:			;AN027;
 29762 00001CB5 38C0                    	cmp	al,al			;AN000; set ZF
 29763 00001CB7 EBE7                    	jmp	short _$P_Chk_Delim_Exit ;AN000;
 29764                                  
 29765                                  ;***********************************************************************
 29766                                  ; _$P_Chk_Switch;
 29767                                  ;
 29768                                  ; Function: Check if AL is the switch character not in first position of
 29769                                  ;	    _$P_STRING_BUF
 29770                                  ;
 29771                                  ; Input:    AL = character code
 29772                                  ;	    BX = current pointer within _$P_String_Buf
 29773                                  ;	    SI =>next char on command line (following the one in AL)
 29774                                  ;
 29775                                  ; Output:   CF = 1 (set) if AL is switch character, and not in first
 29776                                  ;		 position, and has no chance of being part of a date string,
 29777                                  ;		 i.e. should be treated as a delimiter.
 29778                                  
 29779                                  ;	    CF = 0 (reset, cleared) if AL is not a switch char, is in the first
 29780                                  ;		 position, or is a slash but may be part of a date string, i.e.
 29781                                  ;		 should not be treated as a delimiter.
 29782                                  ;
 29783                                  ; Vars:  _$P_Terminator(W)
 29784                                  
 29785                                  ; Use:	 _$P_0099
 29786                                  ;***********************************************************************
 29787                                  
 29788                                  _$P_Chk_Switch:
 29789                                  	;;lea	bp,[cs:_$P_STRING_BUF]	;AN020;AC034
 29790                                  	;lea	bp,[_$P_STRING_BUF]	;BP=OFFSET of _$P_String_Buf even in group addressing
 29791                                  	; 08/07/2023
 29792 00001CB9 BD[D514]                	mov	bp,_$P_STRING_BUF
 29793                                  
 29794                                  ;	.IF <BX NE BP> THEN		;AN020;IF not first char THEN
 29795 00001CBC 39EB                    	cmp	bx,bp			;AN000;
 29796 00001CBE 7406                    	je	short _$P_STRUC_L2	;AN000;
 29797                                  
 29798                                  ;	.IF <AL EQ _$P_Switch> THEN	;AN020;otherwise see if a slash
 29799 00001CC0 3C2F                    	cmp	al,_$P_Switch		;AN000;
 29800 00001CC2 750C                    	jne	short _$P_STRUC_L5 	;AN000;
 29801                                  
 29802 00001CC4 F9                      	stc				;AN020;not in first position and is slash
 29803                                  	;jmp     short _$P_STRUC_L1	;AN000;
 29804                                  	; 12/12/2022
 29805 00001CC5 C3                      	retn
 29806                                  
 29807                                  ; 12/12/2022
 29808                                  ;_$P_STRUC_L5:				;AN000;
 29809                                  ;	CLC				;AN020;not a slash
 29810                                  ;;	    .ENDIF			;AN020;
 29811                                  ;;	.ELSE				;AN020;is first char in the buffer, ZF=0
 29812                                  ;	jmp	short _$P_STRUC_L1	;AN000;
 29813                                  
 29814                                  _$P_STRUC_L2:				;AN000;
 29815                                  ;	.IF <AL EQ _$P_Switch> THEN	;AN020;
 29816 00001CC6 3C2F                    	cmp     al,_$P_Switch		;AN000;
 29817 00001CC8 7506                    	jne	short _$P_STRUC_L12	;AN000;
 29818                                  
 29819 00001CCA 2E800E[CC14]40          	or	byte [cs:_$P_Flags2],_$P_SW ;AN020 ;AC034;;could be valid switch, first char and is slash
 29820                                  ;	.ENDIF				;AN020;
 29821                                  
 29822                                  	; 12/12/2022
 29823                                  	; cf=0
 29824                                  	;retn
 29825                                  
 29826                                  _$P_STRUC_L5:
 29827                                  	; 12/12/2022
 29828                                  _$P_STRUC_L12:				;AN000;
 29829 00001CD0 F8                      	clc				;AN020;CF=0 indicating first char
 29830                                  ;	.ENDIF				;AN020;
 29831                                  _$P_STRUC_L1:				;AN000;
 29832 00001CD1 C3                      	retn				;AN000;
 29833                                  
 29834                                  ;**************************************************************************
 29835                                  ; _$P_Chk_DBCS:
 29836                                  ;
 29837                                  ;  Function: Check if a specified byte is in ranges of the DBCS lead bytes
 29838                                  ;
 29839                                  ;  Input:
 29840                                  ;	  AL	= Code to be examineed
 29841                                  ;
 29842                                  ;  Output:
 29843                                  ;	  If CF is on then a lead byte of DBCS
 29844                                  ;
 29845                                  ; Use: INT 21h w/AH=63
 29846                                  ;
 29847                                  ; Vars:  _$P_DBCSEV_Seg(RW), _$P_DBCSEV_Off(RW)
 29848                                  ;***************************************************************************
 29849                                  
 29850                                  _$P_Chk_DBCS:
 29851 00001CD2 1E                      	push	ds			;AN000;
 29852 00001CD3 56                      	push	si			;AN000;
 29853 00001CD4 53                      	push	bx			;AN000; (tm11)
 29854                                  	;cmp	word [cs:_$P_DBCSEV_SEG],0 ;AC034; ALREADY SET ?
 29855                                  	;jne	short _$P_DBCS00	;AN000;
 29856                                  	; 08/07/2023
 29857 00001CD5 2E8B36[C914]            	mov	si,[cs:_$P_DBCSEV_SEG]
 29858 00001CDA 21F6                    	and	si,si ; 0 ?
 29859 00001CDC 7525                    	jnz	short _$P_DBCS00 ; already set
 29860 00001CDE 50                      	push	ax			;AN000;
 29861 00001CDF 1E                      	push	ds			;AN000; (tm11)
 29862 00001CE0 51                      	push	cx			;AN000;
 29863 00001CE1 52                      	push	dx			;AN000;
 29864 00001CE2 57                      	push	di			;AN000;
 29865 00001CE3 55                      	push	bp			;AN000;
 29866 00001CE4 06                      	push	es			;AN000;
 29867                                  	; si = 0 ; 08/07/2023
 29868                                  	;xor	si,si			;AN000;
 29869 00001CE5 8EDE                    	mov	ds,si ; 0		;AN000;
 29870 00001CE7 B80063                  	mov	ax,_$P_DOS_GetEV ; 6300h ;AN000; GET DBCS EV CALL
 29871 00001CEA CD21                    	int	21h			;AN000;
 29872                                  		; DOS - 3.2+ only - GET DOUBLE BYTE CHARACTER SET LEAD TABLE
 29873 00001CEC 8CDB                    	mov	bx,ds			;AN000; (tm11)
 29874 00001CEE 09DB                    	or	bx,bx			;AN000; (tm11)
 29875 00001CF0 07                      	pop	es			;AN000;
 29876 00001CF1 5D                      	pop	bp			;AN000;
 29877 00001CF2 5F                      	pop	di			;AN000;
 29878 00001CF3 5A                      	pop	dx			;AN000;
 29879 00001CF4 59                      	pop	cx			;AN000;
 29880 00001CF5 1F                      	pop	ds			;AN000; (tm11)
 29881 00001CF6 58                      	pop	ax			;AN000;
 29882 00001CF7 7424                    	jz	short _$P_NON_DBCS	;AN000;
 29883                                  _$P_DBCS02:				;AN000;
 29884 00001CF9 2E8936[C714]            	mov	[cs:_$P_DBCSEV_OFF],si	;AC034; save EV offset
 29885 00001CFE 2E891E[C914]            	mov	[cs:_$P_DBCSEV_SEG],bx	;AC034; save EV segment (tm11)
 29886                                  _$P_DBCS00:				;AN000;
 29887                                  	;mov	si,[cs:_$P_DBCSEV_OFF]	;AC034; load EV offset
 29888                                  	;mov	ds,[cs:_$P_DBCSEV_SEG]	;AC034; and segment
 29889                                  	; 08/07/2023
 29890 00001D03 2EC536[C714]            	lds	si,[cs:_$P_DBCSEV_OFF]
 29891                                  _$P_DBCS_LOOP:				;AN000;
 29892 00001D08 833C00                  	cmp	word [si],0		;AN000; zero vector ?
 29893 00001D0B 7410                    	je	short _$P_NON_DBCS	;AN000; then exit
 29894 00001D0D 3A04                    	cmp	al,[si] 		;AN000;
 29895 00001D0F 7208                    	jb	short _$P_DBCS01	;AN000; Check if AL is in
 29896 00001D11 3A4401                  	cmp	al,[si+1]		;AN000;   range of
 29897 00001D14 7703                    	ja	short _$P_DBCS01	;AN000;      the vector
 29898 00001D16 F9                      	stc				;AN000; if yes, indicate DBCS and exit
 29899 00001D17 EB04                    	jmp	short _$P_DBCS_EXIT	;AN000;
 29900                                  _$P_DBCS01:				;AN000;
 29901 00001D19 46                      	inc	si			;AC035; add '2' to
 29902 00001D1A 46                      	inc	si			;AC035;  SI reg
 29903                                  					;AN000; get next vector
 29904 00001D1B EBEB                    	jmp	short _$P_DBCS_LOOP	;AN000; loop until zero vector found
 29905                                  _$P_NON_DBCS:				;AN000;
 29906                                  	; 12/12/2022
 29907                                  	; cf=0
 29908                                  	;clc				;AN000; indicate SBCS
 29909                                  _$P_DBCS_EXIT:				;AN000;
 29910 00001D1D 5B                      	pop	bx			;AN000; (tm11)
 29911 00001D1E 5E                      	pop	si			;AN000;
 29912 00001D1F 1F                      	pop	ds			;AN000;
 29913 00001D20 C3                      	retn				;AN000;
 29914                                  
 29915                                  ; SYSCONF.ASM - MSDOS 6.0 - 1991
 29916                                  ; ======================================================================
 29917                                  ; 27/03/2019 - Retro DOS v4.0
 29918                                  
 29919                                  ;control block definitions for parser.
 29920                                  ;-----------------------------------------------------------------------
 29921                                  ; buffer = [n | n,m] {/e}
 29922                                  
 29923                                  ; 30/03/2019
 29924                                  
 29925                                  struc p_parms
 29926 00000000 ????                    	resw	1	; dw ?
 29927 00000002 ??                      	resb	1	; db 1	; an extra delimiter list
 29928 00000003 ??                      	resb	1	; db 1	; length is 1
 29929 00000004 ??                      	resb 	1	; db ';' ; delimiter
 29930                                  .size:
 29931                                  endstruc
 29932                                  
 29933                                  struc p_pos
 29934 00000000 ????                    	resw	1	; dw ?	; numeric value??
 29935 00000002 ????                    	resw	1	; dw ?	; function
 29936 00000004 ????                    	resw	1	; dw ?	; result value buffer
 29937                                  
 29938                                  ; note: by defining result_val before this structure, we could remove
 29939                                  ;  the "result_val" from every structure invocation
 29940                                  
 29941 00000006 ????                    	resw	1	; dw ?	; value list
 29942 00000008 ??                      	resb	1	; db 0	; no switches/keywords
 29943                                  .size:
 29944                                  endstruc
 29945                                  
 29946                                  struc	p_range
 29947 00000000 ??                      	resb	1	; db 1	; range definition
 29948 00000001 ??                      	resb 	1	; db 1	; 1 definition of range
 29949 00000002 ??                      	resb 	1	; db 1	; item tag for this range
 29950 00000003 ????????                	resd	1	; dd ?	; numeric min
 29951 00000007 ????????                	resd	1	; dd ?	; numeric max
 29952                                  .size:
 29953                                  endstruc
 29954                                  
 29955                                  ;-----------------------------------------------------------------------
 29956                                  
 29957                                  	; 26/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 29958                                  	; (SYSINIT:1F48h)
 29959                                  
 29960                                  	; 08/07/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 29961                                  	; MSDOS 6.21 IO.SYS - SYSINIT:2083h
 29962                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:251Dh) ; (Retro DOS v5.0)
 29963                                  
 29964                                  ; buffer = [n | n,m] {/e}
 29965                                  
 29966                                  ;buf_parms p_parms <buf_parmsx>
 29967                                  buf_parms: 
 29968 00001D21 [261D]                  	dw	buf_parmsx
 29969 00001D23 01                      	db	1	; an extra delimiter list
 29970 00001D24 01                      	db	1	; length is 1
 29971 00001D25 3B                      	db	';'	; delimiter
 29972                                  
 29973                                  buf_parmsx:
 29974 00001D26 0102[301D][441D]        	dw	201h,buf_pos1,buf_pos2	; min 1, max 2 positionals
 29975 00001D2C 01                      	db	1			; one switch
 29976 00001D2D [581D]                  	dw	sw_x_ctrl
 29977 00001D2F 00                      	db	0			; no keywords
 29978                                  
 29979                                  ;buf_pos1 p_pos <8000h,0,result_val,buf_range_1>  ; numeric
 29980                                  buf_pos1:
 29981 00001D30 0080                    	dw	8000h	; numeric value??
 29982 00001D32 0000                    	dw	0	; function
 29983 00001D34 [6A1D]                  	dw	result_val ; result value buffer	
 29984 00001D36 [391D]                  	dw	buf_range_1 ; value list
 29985 00001D38 00                      	db	0  	; no switches/keywords
 29986                                  
 29987                                  ;buf_range_1 p_range <,,,1,99>		; M050
 29988                                  buf_range_1:
 29989 00001D39 01                      	db	1	; range definition
 29990 00001D3A 01                      	db	1	; 1 definition of range
 29991 00001D3B 01                      	db	1	; item tag for this range
 29992 00001D3C 01000000                	dd	1	; numeric min
 29993 00001D40 63000000                	dd	99	; numeric max
 29994                                  
 29995                                  ;buf_pos2 p_pos <8001h,0,result_val,buf_range_2> ; optional num.
 29996                                  buf_pos2:
 29997 00001D44 0180                    	dw	8001h
 29998 00001D46 0000                    	dw	0
 29999 00001D48 [6A1D]                  	dw	result_val	
 30000 00001D4A [4D1D]                  	dw	buf_range_2
 30001 00001D4C 00                      	db	0
 30002                                  
 30003                                  ;buf_range_2 p_range <,,,0,8>
 30004                                  buf_range_2:
 30005 00001D4D 01                      	db	1
 30006 00001D4E 01                      	db	1
 30007 00001D4F 01                      	db	1
 30008 00001D50 00000000                	dd	0
 30009 00001D54 08000000                	dd	8
 30010                                  
 30011                                  ;sw_x_ctrl p_pos <0,0,result_val,noval,1> ; followed by one switch
 30012                                  sw_x_ctrl:
 30013 00001D58 0000                    	dw	0
 30014 00001D5A 0000                    	dw	0
 30015 00001D5C [6A1D]                  	dw	result_val	
 30016 00001D5E [691D]                  	dw	noval
 30017 00001D60 01                      	db	1	; 1 switch
 30018                                  	
 30019                                  switch_x:
 30020 00001D61 2F5800                  	db	'/X',0		; M016
 30021                                  
 30022                                  p_buffers:
 30023 00001D64 0000                    	dw	0	; local variables
 30024                                  p_h_buffers:
 30025 00001D66 0000                    	dw	0
 30026                                  	; 26/10/2022  (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 30027                                  p_buffer_slash_x:
 30028 00001D68 00                      	db	0 ; 31/03/2019
 30029                                  
 30030                                  ;-- common definitions -------------------------------------------------
 30031                                  
 30032 00001D69 00                      noval:	db	0
 30033                                  
 30034                                  result_val: 	;label	byte
 30035 00001D6A 00                      	db	0		; type returned
 30036                                  result_val_itag:
 30037 00001D6B 00                      	db	0		; item tag returned
 30038                                  result_val_swoff:
 30039 00001D6C 0000                    	dw	0		; es:offset of the switch defined
 30040                                  rv_byte:	;label	byte
 30041 00001D6E 00000000                rv_dword: dd	0		; value if number,or seg:offset to string.
 30042                                  
 30043                                  ;-----------------------------------------------------------------------
 30044                                  
 30045                                  	; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 30046                                  	; (SYSINIT:1F99h)
 30047                                  
 30048                                  ; break = [ on | off ]
 30049                                  
 30050                                  ;brk_parms p_parms  <brk_parmsx>
 30051                                  brk_parms:
 30052 00001D72 [771D]                  	dw	brk_parmsx
 30053 00001D74 01                      	db	1	; an extra delimiter list
 30054 00001D75 01                      	db	1	; length is 1
 30055 00001D76 3B                      	db	';'	; delimiter
 30056                                  
 30057                                  brk_parmsx:
 30058 00001D77 0101[7D1D]              	dw	101h,brk_pos	; min,max = 1 positional
 30059 00001D7B 00                      	db	0		; no switches
 30060 00001D7C 00                      	db	0		; no keywords
 30061                                  
 30062                                  ;brk_pos p_pos <2000h,0,result_val,on_off_string> ; simple string
 30063                                  brk_pos:
 30064 00001D7D 0020                    	dw	2000h
 30065 00001D7F 0000                    	dw	0
 30066 00001D81 [6A1D]                  	dw	result_val	
 30067 00001D83 [861D]                  	dw	on_off_string
 30068 00001D85 00                      	db	0
 30069                                  
 30070                                  on_off_string:	;label	byte
 30071 00001D86 03                      	db	3		; signals that there is a string choice
 30072 00001D87 00                      	db	0		; no range definition
 30073 00001D88 00                      	db	0		; no numeric values choice
 30074 00001D89 02                      	db	2		; 2 strings for choice
 30075 00001D8A 01                      	db	1		; the 1st string tag
 30076 00001D8B [901D]                  	dw	on_string
 30077 00001D8D 02                      	db	2		; the 2nd string tag
 30078 00001D8E [931D]                  	dw	off_string
 30079                                  
 30080                                  on_string:
 30081 00001D90 4F4E00                  	db	"ON",0
 30082                                  off_string:
 30083 00001D93 4F464600                	db	"OFF",0
 30084                                  
 30085                                  p_ctrl_break:
 30086 00001D97 00                      	db	0	; local variable
 30087                                  
 30088                                  ;-----------------------------------------------------------------------
 30089                                  
 30090                                  	; 27/10/2022
 30091                                  
 30092                                  ; country = n {m {path}}
 30093                                  ; or
 30094                                  ; country = n,,path
 30095                                  
 30096                                  ;cntry_parms p_parms <cntry_parmsx>
 30097                                  cntry_parms:
 30098 00001D98 [9D1D]                  	dw	cntry_parmsx
 30099 00001D9A 01                      	db	1
 30100 00001D9B 01                      	db	1
 30101 00001D9C 3B                      	db	';'
 30102                                  	
 30103                                  cntry_parmsx:
 30104 00001D9D 0103[A71D][BB1D]-       	dw	301h,cntry_pos1,cntry_pos2,cntry_pos3 ; min 1, max 3 pos.
 30104 00001DA3 [C41D]             
 30105 00001DA5 00                      	db	0		; no switches
 30106 00001DA6 00                      	db	0		; no keywords
 30107                                  
 30108                                  ;cntry_pos1 p_pos <8000h,0,result_val,cc_range> ; numeric value
 30109                                  cntry_pos1:
 30110 00001DA7 0080                    	dw	8000h
 30111 00001DA9 0000                    	dw	0
 30112 00001DAB [6A1D]                  	dw	result_val	
 30113 00001DAD [B01D]                  	dw	cc_range
 30114 00001DAF 00                      	db	0
 30115                                  
 30116                                  ;cc_range p_range <,,,1,999>
 30117                                  cc_range:
 30118 00001DB0 01                      	db	1
 30119 00001DB1 01                      	db	1
 30120 00001DB2 01                      	db	1
 30121 00001DB3 01000000                	dd	1
 30122 00001DB7 E7030000                	dd	999
 30123                                  
 30124                                  ;cntry_pos2 p_pos <8001h,0,result_val,cc_range> ; optional num.
 30125                                  cntry_pos2:
 30126 00001DBB 0180                    	dw	8001h
 30127 00001DBD 0000                    	dw	0
 30128 00001DBF [6A1D]                  	dw	result_val	
 30129 00001DC1 [B01D]                  	dw	cc_range
 30130 00001DC3 00                      	db	0
 30131                                  
 30132                                  ;cntry_pos3 p_pos <201h,0,result_val,noval>     ; optional filespec
 30133                                  cntry_pos3:
 30134 00001DC4 0102                    	dw	201h
 30135 00001DC6 0000                    	dw	0
 30136 00001DC8 [6A1D]                  	dw	result_val	
 30137 00001DCA [691D]                  	dw	noval
 30138 00001DCC 00                      	db	0	
 30139                                  
 30140                                  p_cntry_code:
 30141 00001DCD 0000                    	dw	0	; local variable
 30142                                  p_code_page:
 30143 00001DCF 0000                    	dw	0	; local variable
 30144                                  
 30145                                  ;-----------------------------------------------------------------------
 30146                                  
 30147                                  	; 27/10/2022
 30148                                  
 30149                                  ; files = n
 30150                                  
 30151                                  ;files_parms p_parms <files_parmsx>
 30152                                  files_parms:
 30153 00001DD1 [D61D]                  	dw	files_parmsx
 30154 00001DD3 01                      	db	1
 30155 00001DD4 01                      	db	1
 30156 00001DD5 3B                      	db	';'
 30157                                  
 30158                                  files_parmsx:
 30159 00001DD6 0101[DC1D]              	dw	101h,files_pos	; min,max 1 positional
 30160 00001DDA 00                      	db	0		; no switches
 30161 00001DDB 00                      	db	0		; no keywords
 30162                                  
 30163                                  ;files_pos p_pos <8000h,0,result_val,files_range,0> ; numeric value
 30164                                  files_pos:
 30165 00001DDC 0080                    	dw	8000h
 30166 00001DDE 0000                    	dw	0
 30167 00001DE0 [6A1D]                  	dw	result_val	
 30168 00001DE2 [E51D]                  	dw	files_range
 30169 00001DE4 00                      	db	0
 30170                                  
 30171                                  ;files_range p_range <,,,8,255>
 30172                                  files_range:
 30173 00001DE5 01                      	db	1
 30174 00001DE6 01                      	db	1
 30175 00001DE7 01                      	db	1
 30176 00001DE8 08000000                	dd	8
 30177 00001DEC FF000000                	dd	255
 30178                                  
 30179                                  p_files:
 30180 00001DF0 00                      	db	0		; local variable
 30181                                  
 30182                                  ;-----------------------------------------------------------------------
 30183                                  
 30184                                  	; 27/10/2022
 30185                                  
 30186                                  ; fcbs = n,m
 30187                                  
 30188                                  ;fcbs_parms p_parms <fcbs_parmsx>
 30189                                  fcbs_parms:
 30190 00001DF1 [F61D]                  	dw	fcbs_parmsx
 30191 00001DF3 01                      	db	1
 30192 00001DF4 01                      	db	1
 30193 00001DF5 3B                      	db	';'
 30194                                  
 30195                                  fcbs_parmsx:
 30196 00001DF6 0102[FE1D][121E]        	dw	201h,fcbs_pos_1,fcbs_pos_2 ; min,max = 2 positional
 30197 00001DFC 00                      	db	0		; no switches
 30198 00001DFD 00                      	db	0		; no keywords
 30199                                  
 30200                                  ;fcbs_pos_1 p_pos <8000h,0,result_val,fcbs_range> ; numeric value
 30201                                  fcbs_pos_1:
 30202 00001DFE 0080                    	dw	8000h
 30203 00001E00 0000                    	dw	0
 30204 00001E02 [6A1D]                  	dw	result_val	
 30205 00001E04 [071E]                  	dw	fcbs_range
 30206 00001E06 00                      	db	0
 30207                                  
 30208                                  ;fcbs_range p_range <,,,1,255>
 30209                                  fcbs_range:
 30210 00001E07 01                      	db	1
 30211 00001E08 01                      	db	1
 30212 00001E09 01                      	db	1
 30213 00001E0A 01000000                	dd	1
 30214 00001E0E FF000000                	dd	255
 30215                                  
 30216                                  ;fcbs_pos_2 p_pos <8000h,0,result_val,fcbs_keep_range> ; numeric value
 30217                                  fcbs_pos_2:
 30218 00001E12 0080                    	dw	8000h
 30219 00001E14 0000                    	dw	0
 30220 00001E16 [6A1D]                  	dw	result_val	
 30221 00001E18 [1B1E]                  	dw	fcbs_keep_range
 30222 00001E1A 00                      	db	0
 30223                                  
 30224                                  ;fcbs_keep_range p_range <,,,0,255>
 30225                                  fcbs_keep_range:
 30226 00001E1B 01                      	db	1
 30227 00001E1C 01                      	db	1
 30228 00001E1D 01                      	db	1
 30229 00001E1E 00000000                	dd	0
 30230 00001E22 FF000000                	dd	255
 30231                                  
 30232 00001E26 00                      p_fcbs:	db	0		; local variable
 30233 00001E27 00                      p_keep:	db	0		; local variable
 30234                                  
 30235                                  ;-----------------------------------------------------------------------
 30236                                  
 30237                                  	; 27/10/2022
 30238                                  
 30239                                  ; lastdrive = x
 30240                                  
 30241                                  ;ldrv_parms p_parms <ldrv_parmsx>
 30242                                  ldrv_parms:
 30243 00001E28 [2D1E]                  	dw	ldrv_parmsx
 30244 00001E2A 01                      	db	1
 30245 00001E2B 01                      	db	1
 30246 00001E2C 3B                      	db	';'
 30247                                  
 30248                                  ldrv_parmsx:
 30249 00001E2D 0101[331E]              	dw	101h,ldrv_pos	; min,max = 1 positional
 30250 00001E31 00                      	db	0		; no switches
 30251 00001E32 00                      	db	0		; no keywords
 30252                                  
 30253                                  ;ldrv_pos p_pos	<110h,10h,result_val,noval> ; drive only, ignore colon
 30254                                  ldrv_pos:				    ; remove colon at end
 30255 00001E33 1001                    	dw	110h
 30256 00001E35 1000                    	dw	10h
 30257 00001E37 [6A1D]                  	dw	result_val	
 30258 00001E39 [691D]                  	dw	noval
 30259 00001E3B 00                      	db	0
 30260                                  	
 30261 00001E3C 00                      p_ldrv:	db	0		; local variable
 30262                                  
 30263                                  ;-----------------------------------------------------------------------
 30264                                  
 30265                                  	; 27/10/2022
 30266                                  
 30267                                  ; stacks = n,m
 30268                                  
 30269                                  ;stks_parms p_parms <stks_parmsx>
 30270                                  stks_parms:
 30271 00001E3D [421E]                  	dw	stks_parmsx
 30272 00001E3F 01                      	db	1
 30273 00001E40 01                      	db	1
 30274 00001E41 3B                      	db	';'
 30275                                  
 30276                                  stks_parmsx:
 30277 00001E42 0202[4A1E][5E1E]        	dw	202h,stks_pos_1,stks_pos_2 ; min,max = 2 positionals
 30278 00001E48 00                      	db	0		; no switches
 30279 00001E49 00                      	db	0		; no keywords
 30280                                  
 30281                                  ;stks_pos_1 p_pos <8000h,0,result_val,stks_range> ; numeric value
 30282                                  stks_pos_1:
 30283 00001E4A 0080                    	dw	8000h
 30284 00001E4C 0000                    	dw	0
 30285 00001E4E [6A1D]                  	dw	result_val	
 30286 00001E50 [531E]                  	dw	stks_range
 30287 00001E52 00                      	db	0
 30288                                  
 30289                                  ;stks_range p_range <,,,0,64>
 30290                                  stks_range:
 30291 00001E53 01                      	db	1
 30292 00001E54 01                      	db	1
 30293 00001E55 01                      	db	1
 30294 00001E56 00000000                	dd	0
 30295 00001E5A 40000000                	dd	64
 30296                                  
 30297                                  ;stks_pos_2 p_pos <8000h,0,result_val,stk_size_range> ; numeric value
 30298                                  stks_pos_2:
 30299 00001E5E 0080                    	dw	8000h
 30300 00001E60 0000                    	dw	0
 30301 00001E62 [6A1D]                  	dw	result_val	
 30302 00001E64 [671E]                  	dw	stk_size_range
 30303 00001E66 00                      	db	0
 30304                                  
 30305                                  ;stk_size_range p_range <,,,0,512>
 30306                                  stk_size_range:
 30307 00001E67 01                      	db	1
 30308 00001E68 01                      	db	1
 30309 00001E69 01                      	db	1
 30310 00001E6A 00000000                	dd	0
 30311 00001E6E 00020000                	dd	512	
 30312                                  
 30313                                  p_stack_count:
 30314 00001E72 0000                    	dw	0	; local variable
 30315                                  p_stack_size:
 30316 00001E74 0000                    	dw	0	; local variable
 30317                                  
 30318                                  ;-----------------------------------------------------------------------
 30319                                  
 30320                                  	; 27/10/2022
 30321                                  
 30322                                  ; multitrack = [ on | off ]
 30323                                  
 30324                                  ;mtrk_parms p_parms <mtrk_parmsx>
 30325                                  mtrk_parms:
 30326 00001E76 [7B1E]                  	dw	mtrk_parmsx
 30327 00001E78 01                      	db	1
 30328 00001E79 01                      	db	1
 30329 00001E7A 3B                      	db	';'
 30330                                  
 30331                                  mtrk_parmsx:
 30332 00001E7B 0101[811E]              	dw	101h,mtrk_pos	; min,max = 1 positional
 30333 00001E7F 00                      	db	0		; no switches
 30334 00001E80 00                      	db	0		; no keywords
 30335                                  
 30336                                  ;mtrk_pos p_pos <2000h,0,result_val,on_off_string> ; simple string
 30337                                  mtrk_pos:
 30338 00001E81 0020                    	dw	2000h
 30339 00001E83 0000                    	dw	0
 30340 00001E85 [6A1D]                  	dw	result_val	
 30341 00001E87 [861D]                  	dw	on_off_string
 30342 00001E89 00                      	db	0
 30343                                  
 30344 00001E8A 00                      p_mtrk:	db	0		; local variable
 30345                                  
 30346                                  ;-----------------------------------------------------------------------
 30347                                  
 30348                                  	; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 30349                                  	; (SYSINIT:20B2h)
 30350                                  
 30351                                  ; switches=/k
 30352                                  
 30353                                  ;swit_parms p_parms <swit_parmsx>
 30354                                  swit_parms:
 30355 00001E8B [901E]                  	dw	swit_parmsx
 30356 00001E8D 01                      	db	1
 30357 00001E8E 01                      	db	1
 30358 00001E8F 3B                      	db	';'
 30359                                  
 30360                                  swit_parmsx:
 30361 00001E90 0000                    	dw	0		; no positionals
 30362                                  	; 08/07/2023 - Retro DOS v4.2 (MSDOS 6.21 IO.SYS, SYSINIT)
 30363 00001E92 05                      	db	5               ; # of switches
 30364                                  	; 27/10/2022 - Retro DOS v4.0 (MSDOS 5.0 IO.SYS, SYSINIT)
 30365                                  	;db	3
 30366 00001E93 [9E1E]                  	dw	swit_k_ctrl	; /k control
 30367                                  	; 01/01/2023 - Retro DOS v4.2 ; *
 30368 00001E95 [AA1E]                  	dw	swit_n_ctrl ; * ; /n control (for MULTI_CONFIG only)
 30369 00001E97 [B61E]                  	dw	swit_f_ctrl ; * ; /f control (for MULTI_CONFIG only)
 30370 00001E99 [C21E]                  	dw	swit_t_ctrl     ; /t control
 30371 00001E9B [CE1E]                  	dw	swit_w_ctrl     ; /w control
 30372 00001E9D 00                      	db	0		; no keywords
 30373                                  
 30374                                  ;swit_k_ctrl p_pos <0,0,result_val,noval,1> ; switch string follows
 30375                                  swit_k_ctrl:
 30376 00001E9E 00000000[6A1D]-         	dw	0,0,result_val,noval
 30376 00001EA4 [691D]             
 30377 00001EA6 01                      	db	1
 30378 00001EA7 2F4B00                  swit_k:	db	'/K',0
 30379                                  
 30380                                  ; 01/01/2023 - Retro DOS v4.2 (MSDOS 6.21 IO.SYS)
 30381                                  ; (SYSINIT:220Ch) ; *
 30382                                  
 30383                                  ; 27/10/2022 - Retro DOS v4.0 (MSDOS 5.0 IO.SYS, SYSINIT)
 30384                                  ;
 30385                                  ;swit_n_ctrl p_pos <0,0,result_val,noval,1> ; switch string follows
 30386                                  swit_n_ctrl: ; *
 30387 00001EAA 00000000[6A1D]-         	dw	0,0,result_val,noval
 30387 00001EB0 [691D]             
 30388 00001EB2 01                      	db	1
 30389 00001EB3 2F4E00                  swit_n: db	'/N',0
 30390                                  
 30391                                  ;swit_f_ctrl p_pos <0,0,result_val,noval,1> ; switch string follows
 30392                                  swit_f_ctrl: ; *
 30393 00001EB6 00000000[6A1D]-         	dw	0,0,result_val,noval
 30393 00001EBC [691D]             
 30394 00001EBE 01                      	db	1
 30395 00001EBF 2F4600                  swit_f: db 	'/F',0
 30396                                  
 30397                                  	; 27/10/2022
 30398                                  
 30399                                  ;swit_t_ctrl p_pos <0,0,result_val,noval,1> ; switch string follows	M059
 30400                                  swit_t_ctrl:
 30401 00001EC2 00000000[6A1D]-         	dw	0,0,result_val,noval
 30401 00001EC8 [691D]             
 30402 00001ECA 01                      	db	1
 30403 00001ECB 2F5400                  swit_t:	db	'/T',0			   ;				M059
 30404                                  ;swit_w_ctrl p_pos <0,0,result_val,noval,1> ; switch string follows	M063
 30405                                  swit_w_ctrl:
 30406 00001ECE 00000000[6A1D]-         	dw	0,0,result_val,noval
 30406 00001ED4 [691D]             
 30407 00001ED6 01                      	db	1
 30408 00001ED7 2F5700                  swit_w:	db	'/W',0			   ;				M063
 30409                                  
 30410                                  ;   There doesn't need to be p_swit_n or p_swit_f because /N and /F are
 30411                                  ;   acted upon during MULTI_CONFIG processing; we only needed entries
 30412                                  ;   in the above table to prevent the parsing code from complaining about them
 30413                                  
 30414 00001EDA 00                      p_swit_k:	db     0	; local variable
 30415 00001EDB 00                      p_swit_t:	db     0	; local variable			M059
 30416 00001EDC 00                      p_swit_w:	db     0	; local variable			M063
 30417                                  
 30418                                  ;-----------------------------------------------------------------------
 30419                                  
 30420                                  	; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 30421                                  	; (SYSINIT:20E8h)
 30422                                  
 30423                                  ; DOS = [ high | low ]
 30424                                  
 30425                                  ;dos_parms p_parms  <dos_parmsx>
 30426                                  dos_parms:
 30427 00001EDD [E21E]                  	dw	dos_parmsx
 30428 00001EDF 01                      	db	1
 30429 00001EE0 01                      	db	1
 30430 00001EE1 3B                      	db	';'
 30431                                  dos_parmsx:
 30432 00001EE2 01                      	db	1		; min parameters
 30433 00001EE3 02                      	db	2		; max parameters
 30434 00001EE4 [EA1E]                  	dw	dos_pos		; 
 30435 00001EE6 [EA1E]                  	dw	dos_pos		; 
 30436 00001EE8 00                      	db	0		; no switches
 30437 00001EE9 00                      	db	0		; no keywords
 30438                                  
 30439                                  ;dos_pos p_pos	<2000h,0,result_val,dos_strings> ; simple string
 30440                                  ;        p_pos	<2000h,0,result_val,dos_strings> ; simple string
 30441                                  dos_pos:
 30442 00001EEA 00200000[6A1D]-         	dw	2000h,0,result_val,dos_strings
 30442 00001EF0 [FC1E]             
 30443 00001EF2 00                      	db	0
 30444 00001EF3 00200000[6A1D]-         	dw	2000h,0,result_val,dos_strings
 30444 00001EF9 [FC1E]             
 30445 00001EFB 00                      	db	0	
 30446                                  
 30447                                  dos_strings:	;label	byte
 30448 00001EFC 03                      	db	3		; signals that there is a string choice
 30449 00001EFD 00                      	db	0		; no range definition
 30450 00001EFE 00                      	db	0		; no numeric values choice
 30451 00001EFF 04                      	db	4		; 4 strings for choice
 30452 00001F00 01                      	db	1		; the 1st string tag
 30453 00001F01 [0C1F]                  	dw	hi_string
 30454 00001F03 02                      	db	2		; the 2nd string tag
 30455 00001F04 [111F]                  	dw	lo_string
 30456 00001F06 03                      	db	3
 30457 00001F07 [151F]                  	dw	umb_string
 30458 00001F09 04                      	db	4
 30459 00001F0A [191F]                  	dw	noumb_string
 30460                                  
 30461 00001F0C 4849474800              hi_string:	db	"HIGH",0
 30462 00001F11 4C4F5700                lo_string:	db	"LOW",0
 30463 00001F15 554D4200                umb_string:	db	"UMB",0
 30464 00001F19 4E4F554D4200            noumb_string:	db	"NOUMB",0
 30465                                  
 30466 00001F1F 00                      p_dos_hi:	db	0	; local variable
 30467                                  				; BUGBUG : I dont know whether PARSER uses
 30468                                  				;          this variable or not
 30469                                  
 30470                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 30471                                  ; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 30472                                  ;%if 0
 30473                                  
 30474                                  ;****************************************************************** RICHID ****
 30475                                  
 30476                                  ;include	highvar.inc	; devicehigh variables (used by loadhigh also)
 30477                                  
 30478                                  ; 30/03/2019 - Retro DOS v4.0
 30479                                  ;------------------------------------------------------------------------------
 30480                                  
 30481                                  ;   Module:   HIGHVAR.INC - Data common to LOADHIGH and DEVICEHIGH, res seg
 30482                                  ;
 30483                                  ;   Date:     May 14, 1992
 30484                                  ;
 30485                                  ;******************************************************************************
 30486                                  ;
 30487                                  ;   Modification log:
 30488                                  ;
 30489                                  ;     DATE    WHO      DESCRIPTION
 30490                                  ;   --------  -------  --------------------------------------------------------
 30491                                  ;   05/14/92  t-richj  Original
 30492                                  ;   06/21/92  t-richj  Final revisions before check-in
 30493                                  ;
 30494                                  ;******************************************************************************
 30495                                  ;
 30496                                  ; There are two primary definitions which need to be made, selectively, before
 30497                                  ; this include file should be used.  These are:
 30498                                  ;    HV_Extern - If this has been defined, variables for this module will be
 30499                                  ;                declared as external.  Otherwise, variables will be declared
 30500                                  ;                public, as well as defined, here.  LoadHigh declares HV_Extern
 30501                                  ;                in stub.asm and loadhi.asm, and does not declare it in
 30502                                  ;                rdata.asm... DeviceHigh does not declare HV_Extern anywhere
 30503                                  ;                (as only one module, sysconf.asm, includes this file).
 30504                                  ;    HV_LoadHigh - This should be defined when this module is going into
 30505                                  ;                  command.com, for LoadHigh.  All of loadhi.asm, stub.asm and
 30506                                  ;                  rdata.asm define this, while io.sys' sysconf.asm does not.
 30507                                  ;
 30508                                  ;******************************************************************************
 30509                                  
 30510                                  ; To keep track of which UMBs were specified on the DH/LH command lines, and
 30511                                  ; to keep track of the minimum sizes given for each, there're two arrays kept
 30512                                  ; in { IO.SYS: sysinitseg / COMMAND.COM: DATARES }... each is MAXUMB elements
 30513                                  ; big.  16 should be around 14 too many for most users, so there's no expected
 30514                                  ; space problem (it's just such a nice round number, eh?).
 30515                                  
 30516                                  MAXUMB	equ	16
 30517                                  
 30518                                  ; Memory elements owned by the system are marked as PSP address 8 in both the
 30519                                  ; USA and Japan; Japanese systems also use 9 under more bizzarre conditions.
 30520                                  
 30521                                  FreePSPOwner	equ	0	; Free MCBs all have an owner PSP address of 0
 30522                                  SystemPSPOwner	equ	8
 30523                                  ;JapanPSPOwner	equ	9
 30524                                  
 30525                                  ; for LoadHigh and DeviceHigh:
 30526                                  ;
 30527                                  ;	fInHigh - Is set to 1 during HideUMBs(), and back to zero in
 30528                                  ;	          UnHideUMBs().
 30529                                  ;	fUmbTiny - Is set to 1 if the user has specified /S on the command-
 30530                                  ;	           line.
 30531                                  ;	SegLoad - Segment address for first UMB specified; set automatically.
 30532                                  ;	UmbLoad - The load UMB number; for example, this is 3 if the user has
 30533                                  ;	          given a command-line like "/L:3,500;4"
 30534                                  ;	UmbUsed - An array of characters, each of which is 1 iff the UMB
 30535                                  ;	          matching its index number was specified on the command-line;
 30536                                  ;	          for example, after "/L:3,500;4;7", UmbUsed[3], [4] and [7]
 30537                                  ;	          will be set to 1. All others will be set to 0.
 30538                                  ;	UmbSize - An array of words, each of which is interpereted as a size
 30539                                  ;	          specified by the user for a UMB (in the above example, all
 30540                                  ;	          elements would be zero save UmbSize[3], which would be 500.
 30541                                  ;	fm_umb - Set to the old UMB link-state (0x80 or 0x00)
 30542                                  ;	fm_strat - Set to the old memory-allocation strategy (0$00000???)
 30543                                  ;	fm_argc  - Number of arguments received by ParseVar() (see ParseVar()
 30544                                  ;	           for details).
 30545                                  
 30546 00001F20 00                      fInHigh:  db	0
 30547 00001F21 00                      fUmbTiny: db	0
 30548 00001F22 0000                    SegLoad:  dw	0
 30549 00001F24 00                      UmbLoad:  db	0
 30550 00001F25 00<rep 10h>             UmbUsed:  times MAXUMB db 0 ; times 16 db 0  ; db 16 dup(?)
 30551 00001F35 0000<rep 10h>           UmbSize:  times MAXUMB dw 0 ; times 16 dw 0  ; dw 16 dup(?)
 30552 00001F55 00                      fm_umb:   db	0
 30553 00001F56 00                      fm_strat: db	0
 30554 00001F57 00                      fm_argc:  db	0	
 30555                                  
 30556                                  ; UmbLoad is set to UNSPECIFED, below, until /L:umb is read; at which point
 30557                                  ; UmbLoad is set to the UMB number given.
 30558                                  
 30559                                  UNSPECIFIED	equ	-1
 30560                                  
 30561                                  ;%endif ; 27/10/2022
 30562                                  
 30563                                  ;****************************************************************** RICHID ****
 30564                                  
 30565                                  ; 30/03/2019 - Retro DOS v4.0 (MSDOS 6.0, SYSCONF.ASM)
 30566                                  ; ((MSDOS 6.21 IO.SYS -> SYNINIT:22BAh))
 30567                                  
 30568                                  ; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 30569                                  ; (SYSINIT:212Bh)	
 30570                                  
 30571                                  		;public	DevEntry
 30572                                  
 30573 00001F58 0000                    DevSize:	dw	0	; size of the device driver being loaded (paras)
 30574 00001F5A 0000                    DevLoadAddr:	dw	0	; Mem addr where the device driver is 2 b loaded
 30575 00001F5C 0000                    DevLoadEnd:	dw	0	; MaxAddr to which device can be loaded
 30576 00001F5E 00000000                DevEntry:	dd	0	; Entry point to the device driver
 30577 00001F62 00000000                DevBrkAddr:	dd	0	; Break address of the device driver
 30578                                  ; 30/12/2022
 30579                                  ; 27/10/2022 
 30580 00001F66 00                      ConvLoad:	db	0	; Use conventional (dos 5 style) InitDevLoad?
 30581                                  ;
 30582 00001F67 00                      DevUMB:		db	0	; byte indicating whether to load DDs in UMBs
 30583 00001F68 0000                    DevUMBAddr:	dw	0	; current UMB used for loading devices (paras)
 30584 00001F6A 0000                    DevUMBSize:	dw	0	; Size of the current UMB being used   (paras)
 30585 00001F6C 0000                    DevUMBFree:	dw	0	; Start of free mem blk in the current UMB (paras)
 30586                                  ;
 30587 00001F6E 00000000                DevXMSAddr:	dd	0
 30588                                  ;
 30589 00001F72 0000                    DevExecAddr:	dw	0	; Device load address parameter to Exec call
 30590 00001F74 0000                    DevExecReloc:	dw	0	; Device load relocation factor
 30591                                  ;
 30592 00001F76 00                      DeviceHi:	db	0	; Flag indicating whether the current device
 30593                                  				;  is being loaded into UMB
 30594 00001F77 0000                    DevSizeOption:	dw	0	; SIZE= option
 30595                                  ;
 30596 00001F79 00                      Int12Lied:	db	0	; did we trap int 12h ?
 30597 00001F7A 0000                    OldInt12Mem:	dw	0	; value in 40:13h (int 12h ram)
 30598 00001F7C 50524F544D414E24        ThreeComName:	db	'PROTMAN$' ; 3Com Device name
 30599                                  ;
 30600 00001F84 00                      FirstUMBLinked:	db	0
 30601 00001F85 0000                    DevDOSData:	dw	0	; segment of DOS Data
 30602 00001F87 00000000                DevCmdLine:	dd	0	; Current Command line
 30603 00001F8B 00                      DevSavedDelim:	db	0	; The delimiter which was replaced with null
 30604                                  				; to use the file name in the command line
 30605                                  ;
 30606                                  ;	ifdef	dblspace_hooks
 30607                                  ;MagicHomeFlag:	db	0	; set non-zero when MagicDrv is final placed
 30608                                  ;	endif
 30609                                  
 30610                                  ; ===========================================================================
 30611                                  
 30612                                  ; 31/03/2019 - Retro DOS v4.0
 30613                                  
 30614                                  ; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 30615                                  ; (SYSINIT:215Eh)
 30616                                  
 30617                                  ;----------------------------------------------------------------------------
 30618                                  ;
 30619                                  ; procedure : doconf
 30620                                  ;
 30621                                  ;             Config file is parsed initially with this routine. For the
 30622                                  ;             Subsequent passes 'multi_pass' entry is used .
 30623                                  ;
 30624                                  ;----------------------------------------------------------------------------
 30625                                  
 30626                                  	; 27/10/2022
 30627                                  doconf:
 30628 00001F8C 0E                      	push	cs
 30629 00001F8D 1F                      	pop	ds
 30630                                  
 30631 00001F8E B80037                  	mov	ax,3700h
 30632                                          ;mov	ax,(CHAR_OPER<<8)	; get switch character
 30633 00001F91 CD21                    	int	21h
 30634 00001F93 8816[3546]              	mov	[command_line+1],dl	; set in default command line
 30635                                  
 30636                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21  IO.SYS)
 30637                                  ; 27/10/2022
 30638                                  ;;ifdef	MULTI_CONFIG
 30639                                  ;	;mov	[command_line-1],dl     ; save default switchchar
 30640 00001F97 8816[3346]              	mov	[def_swchr],dl ; 31/03/2019 
 30641                                  ;;endif	;MULTI_CONFIG
 30642                                  
 30643 00001F9B BA[4A45]                	mov	dx,config ;'\CONFIG.SYS' ; now pointing to file description
 30644 00001F9E B8003D                  	mov	ax,3D00h
 30645                                  	;mov	ax,OPEN<<8		; open file "config.sys"
 30646 00001FA1 F9                      	stc				; in case of int 24h
 30647 00001FA2 CD21                    	int	21h			; function request
 30648 00001FA4 7309                    	jnc	short noprob		; brif opened okay
 30649                                  
 30650                                  ; 31/12/2022
 30651                                  ; 27/10/2022
 30652                                  ;;ifdef	MULTI_CONFIG
 30653 00001FA6 E8F418                  	call	kbd_read		; we still want to give the guy
 30654                                  ;					; a chance to select clean boot!
 30655                                  ;;endif					; (ie, no autoexec.bat processing)
 30656 00001FA9 C606[CD02]0B            	mov	byte [multi_pass_id],11	; set it to unreasonable number
 30657 00001FAE C3                      	retn
 30658                                  noprob: 				; get file size (note < 64k!!)
 30659 00001FAF 89C3                    	mov	bx,ax  ; File handle
 30660 00001FB1 31C9                    	xor	cx,cx			; 0
 30661 00001FB3 31D2                    	xor	dx,dx			; 0
 30662                                  	;mov	ax,4202h
 30663 00001FB5 B80242                  	mov	ax,(LSEEK<<8)|2
 30664 00001FB8 CD21                    	int	21h
 30665 00001FBA A3[5603]                	mov	[count],ax		; dx:ax = file size ; 08/09/2023
 30666                                  					; 08/09/2023 - Erdogan Tan - Note:
 30667 00001FBD 31D2                    	xor	dx,dx			; dx already must be 0 here ; 08/09/2023
 30668                                  					; I am not removing 'xor dx,dx' here
 30669                                  					; for MSDOS compatibility.
 30670                                  					; ((Also PCDOS 7.1 has 'xor dx,dx' here))
 30671                                  					; (Error will be same if CONGIG.SYS file
 30672                                  					;  size > 64KB) 
 30673                                  	;mov	ax,4200h
 30674 00001FBF B80042                  	mov	ax,LSEEK<<8		;reset pointer to beginning of file
 30675 00001FC2 CD21                    	int	21h
 30676                                  
 30677                                  	; 31/12/2022 - Retro DOS v4.2 
 30678 00001FC4 8B16[A502]              	mov	dx,[ALLOCLIM]		;use current alloclim value
 30679                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 30680                                  	;mov	dx,[top_of_cdss] 
 30681                                  
 30682 00001FC8 A1[5603]                	mov	ax,[count]
 30683 00001FCB A3[D002]                	mov	[config_size],ax	;save the size of config.sys file.
 30684 00001FCE E875F1                  	call	ParaRound
 30685 00001FD1 29C2                    	sub	dx,ax
 30686                                  
 30687                                  ; 31/12/2022
 30688                                  ; 27/10/2022
 30689                                  ;ifdef	MULTI_CONFIG
 30690                                  ;
 30691                                  ;  The size of the CONFIG.SYS workspace (for recreating the in-memory
 30692                                  ;  CONFIG.SYS image, and later for building the initial environment) need
 30693                                  ;  not be any larger than CONFIG.SYS itself, EXCEPT for the fact that
 30694                                  ;  we (may) add a variable to the environment that does not explicity appear
 30695                                  ;  in CONFIG.SYS, and that variable is CONFIG (as in CONFIG=COMMON).
 30696                                  ;  The default setting for CONFIG cannot result in more than 1 paragraph
 30697                                  ;  of extra space, so here we account for it (the worst case of course is
 30698                                  ;  when CONFIG.SYS is some very small size, like 0 -JTP)
 30699                                  ;
 30700 00001FD3 4A                      	dec	dx                      ;reserve 1 additional paragraph
 30701 00001FD4 8916[B114]              	mov	[config_wrkseg],dx      ;this is the segment to be used for
 30702 00001FD8 29C2                    	sub	dx,ax                   ;rebuilding the config.sys memory image
 30703                                  ;;endif	;MULTI_CONFIG
 30704                                  
 30705 00001FDA 83EA11                  	sub	dx,11h			;room for header
 30706                                  	
 30707                                  	; 31/12/2022
 30708 00001FDD 8916[A502]              	mov	[ALLOCLIM],dx		;config starts here. new alloclim value.
 30709 00001FE1 8916[A302]              	mov	[CONFBOT],dx
 30710                                  	
 30711                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 30712                                  	;mov	[top_of_cdss],dx
 30713                                  	;call    TempCDS 
 30714                                  	; 31/12/2022
 30715                                  	; 11/12/2022
 30716                                  	; ds <> cs 
 30717                                  	;mov	dx,[cs:top_of_cdss]	
 30718                                  
 30719                                  	; 08/09/2023
 30720                                  	; ds = cs
 30721 00001FE5 8B0E[5603]              	mov	cx,[count]
 30722                                  
 30723 00001FE9 8EDA                    	mov	ds,dx
 30724 00001FEB 8EC2                    	mov	es,dx
 30725                                  
 30726 00001FED 31D2                    	xor	dx,dx
 30727                                  	; 08/09/2023
 30728                                  	;mov	cx,[cs:count]
 30729 00001FEF B43F                    	mov	ah,3Fh
 30730                                  	;mov	ah,READ  ; 3Fh
 30731 00001FF1 F9                      	stc				;in case of int 24
 30732 00001FF2 CD21                    	int	21h			;function request
 30733 00001FF4 9C                      	pushf
 30734                                  
 30735                                  ; find the eof mark in the file. if present,then trim length.
 30736                                  
 30737 00001FF5 50                      	push	ax
 30738 00001FF6 57                      	push	di
 30739 00001FF7 51                      	push	cx
 30740 00001FF8 B01A                    	mov	al,1Ah			; eof mark
 30741 00001FFA 89D7                    	mov	di,dx			; point to buffer
 30742 00001FFC E305                    	jcxz	puteol			; no chars
 30743 00001FFE F2AE                    	repnz	scasb			; find end
 30744 00002000 7501                    	jnz	short puteol		; none found and count exhausted
 30745                                  
 30746                                  ; we found a 1a. back up
 30747                                  
 30748 00002002 4F                      	dec	di			; backup past 1Ah
 30749                                  
 30750                                  ;  just for the halibut, stick in an extra eol
 30751                                  
 30752                                  puteol:
 30753 00002003 B00D                    	mov	al,cr ; 0Dh
 30754 00002005 AA                      	stosb
 30755 00002006 B00A                    	mov	al,lf  ;0Ah
 30756 00002008 AA                      	stosb
 30757 00002009 29D7                    	sub	di,dx			; difference moved
 30758                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 30759                                  	;mov	[cs:count],di		; new count
 30760                                  
 30761                                  	; 11/12/2022	
 30762                                  	; 31/03/2019 - Retro DOS v4.0
 30763 0000200B 0E                      	push	cs
 30764 0000200C 1F                      	pop	ds
 30765                                  
 30766 0000200D 893E[5603]              	mov	[count],di		; new count
 30767                                  
 30768 00002011 59                      	pop	cx
 30769 00002012 5F                      	pop	di
 30770 00002013 58                      	pop	ax
 30771                                  
 30772                                  	; 11/12/2022
 30773                                  	; 27/10/2022
 30774                                  	;push	cs
 30775                                  	;pop	ds
 30776                                  
 30777 00002014 50                      	push	ax
 30778                                  	;mov	ah,CLOSE
 30779 00002015 B43E                    	mov	ah,3Eh
 30780 00002017 CD21                    	int	21h
 30781 00002019 58                      	pop	ax
 30782 0000201A 9D                      	popf
 30783 0000201B 7204                    	jc	short conferr 		;we've got a problem
 30784 0000201D 39C1                    	cmp	cx,ax			; if ax <(>) cx
 30785 0000201F 742C                    	jz	short getcom		;couldn't read the file
 30786                                  conferr:
 30787 00002021 BA[4A45]                	mov	dx,config		;print config error
 30788 00002024 E87924                  	call	badfil
 30789                                  	; 17/09/2023
 30790                                  endconv:	; 01/01/2023
 30791 00002027 C3                      	retn
 30792                                  
 30793                                  ;----------------------------------------------------------------------------
 30794                                  ;
 30795                                  ; entry : multi_pass
 30796                                  ;
 30797                                  ;             called to execute device=,install= commands
 30798                                  ;
 30799                                  ;----------------------------------------------------------------------------
 30800                                  
 30801                                  	; 27/10/2022
 30802                                  multi_pass:
 30803 00002028 0E                      	push	cs
 30804 00002029 1F                      	pop	ds
 30805                                  
 30806 0000202A 803E[CD02]0A            	cmp	byte [multi_pass_id],10
 30807                                  ;jae_endconv:
 30808 0000202F 73F6                    	jae	short endconv 		; do nothing. just return.
 30809                                  
 30810                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 30811 00002031 FF36[A302]              	push	word [CONFBOT]
 30812                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 30813                                  	;push	word [top_of_cdss]
 30814 00002035 07                      	pop	es			; es = [confbot] (CONFIG.SYS image seg)
 30815                                  
 30816 00002036 8B36[5803]              	mov	si,[org_count]
 30817 0000203A 8936[5603]              	mov	[count],si		; set count
 30818 0000203E 31F6                    	xor	si,si ; 0
 30819 00002040 8936[5A03]                      mov     [chrptr],si		; reset chrptr
 30820 00002044 8936[AF02]                      mov     [linecount],si		; reset linecount
 30821                                  
 30822 00002048 E8DC21                  	call	getchr
 30823 0000204B EB06                    	jmp	short conflp
 30824                                  
 30825                                  	; 17/09/2023
 30826                                  	; 01/01/2023
 30827                                  ;endconv:
 30828                                  	;retn	
 30829                                  
 30830                                  getcom:
 30831                                  	; 03/01/2023
 30832                                  	; ds = cs
 30833 0000204D E81416                          call    organize                ; organize the file
 30834 00002050 E8D421                  	call	getchr
 30835                                  conflp: 
 30836 00002053 72D2                    	jc	short endconv
 30837                                  
 30838 00002055 FF06[AF02]                      inc     word [linecount]	; increase linecount
 30839                                  	
 30840                                  	; 08/09/2023
 30841 00002059 30E4                    	xor	ah,ah ; 0
 30842                                  	;mov	byte [multdeviceflag],0	; reset multdeviceflag.
 30843                                  	;mov	byte [setdevmarkflag],0	; reset setdevmarkflag.
 30844 0000205B 8826[B514]              	mov	[multdeviceflag],ah ; 0
 30845 0000205F 8826[B814]              	mov	[setdevmarkflag],ah ; 0
 30846                                  
 30847 00002063 3C0A                    	cmp	al,lf			; linefeed?
 30848 00002065 7448                    	je	short blank_line	; then ignore this line.
 30849                                  
 30850                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 30851                                  ; (SYSINIT:23CCh)
 30852                                  ; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 30853                                  ;%if 0
 30854                                  
 30855                                  ;ifdef	MULTI_CONFIG
 30856                                  
 30857                                  ;   If this is a genuine CONFIG.SYS command, then there should be a line
 30858                                  ;   number immediately following it....
 30859                                  
 30860 00002067 A2[B314]                        mov     [config_cmd],al         ; save original command code
 30861                                  	;and	al,NOT CONFIG_OPTION_QUERY
 30862 0000206A 247F                    	and	al,~CONFIG_OPTION_QUERY ; and al,7Fh
 30863                                  	
 30864                                  	; 08/09/2023
 30865 0000206C 3826[B414]              	cmp	[config_multi],ah ; 0
 30866                                  	;cmp	byte [config_multi],0	; is this a multi-config config.sys?
 30867 00002070 7427                            je      short not_final		; no, line number is not embedded
 30868                                  
 30869 00002072 50                              push    ax                      ;
 30870 00002073 E8B121                          call    getchr                  ; ignore end-of-image errors,
 30871 00002076 88C4                            mov     ah,al                   ; because if there's an error
 30872 00002078 E8AC21                          call    getchr                  ; fetching the line number that's
 30873 0000207B 86C4                            xchg    al,ah                   ; supposed to be there, the next
 30874 0000207D A3[AF02]                        mov     [linecount],ax          ; getchr call will get the same error
 30875 00002080 58                              pop     ax
 30876                                  ;
 30877                                  ;   HACK: when 4DOS.COM is the shell and it doesn't have an environment from
 30878                                  ;   which to obtain its original program name, it grovels through all of
 30879                                  ;   memory to find the filename that was used to exec it; it wants to find
 30880                                  ;   the SHELL= line in the in-memory copy of CONFIG.SYS, and it knows that
 30881                                  ;   sysinit converts the SHELL= keyword to an 'S', so it expects to find an 'S'
 30882                                  ;   immediately before the filename, but since we are now storing line # info
 30883                                  ;   in the config.sys memory image, 4DOS fails to find the 'S' in the right
 30884                                  ;   spot.
 30885                                  ;
 30886                                  ;   So, on the final pass of CONFIG.SYS, copy the command code (eg, 'S')
 30887                                  ;   over the line number info, since we no longer need that info anyway. This
 30888                                  ;   relies on the fact that getchr leaves ES:SI pointing to the last byte
 30889                                  ;   retrieved.
 30890                                  ;
 30891 00002081 803E[CD02]02                    cmp	byte [multi_pass_id],2	; final pass?
 30892 00002086 7211                            jb	short not_final		; no
 30893                                          ;test	word [install_flag],have_install_cmd
 30894 00002088 F606[CE02]01            	test	byte [install_flag],have_install_cmd ; 1
 30895 0000208D 7407                            jz	short final		; no install cmds, so yes it is
 30896 0000208F 803E[CD02]03                    cmp	byte [multi_pass_id],3	; final pass?
 30897 00002094 7203                            jb	short not_final		; no
 30898                                  final:                                  ;
 30899 00002096 268804                  	mov	[es:si],al		; save backward-compatible command code
 30900                                  not_final:                              ;
 30901                                  ;endif
 30902                                  
 30903                                  ; 31/12/2022
 30904                                  ;%endif ; 27/10/2022
 30905                                  
 30906 00002099 88C4                    	mov	ah,al
 30907 0000209B E88921                  	call	getchr
 30908 0000209E 7314                    	jnc	short tryi
 30909                                  
 30910 000020A0 803E[CD02]02            	cmp	byte [multi_pass_id],2
 30911                                  	;jae	short jae_endconv	; do not show badop again for multi_pass.
 30912                                  	; 27/10/2022
 30913 000020A5 7380                    	jnb	short endconv	
 30914 000020A7 E95408                  	jmp	badop
 30915                                  	
 30916                                  coff:	
 30917                                  	; 11/12/2022
 30918                                  	; ds = cs
 30919                                  	;push	cs
 30920                                  	;pop	ds
 30921 000020AA E87121                  	call	newline
 30922 000020AD EBA4                    	jmp	short conflp	; 13/05/2019
 30923                                  
 30924                                  blank_line:
 30925 000020AF E87521                  	call	getchr
 30926 000020B2 EB9F                    	jmp	short conflp
 30927                                  
 30928                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 30929                                  ; 11/12/2022
 30930                                  ; (there is not a jump or call to here from anywhere!)
 30931                                  ;coff_p:
 30932                                  	;push	cs
 30933                                  	;pop	ds
 30934                                  
 30935                                  ;to handle install= commands,we are going to use multi-pass.
 30936                                  ;the first pass handles the other commands and only set install_flag when
 30937                                  ;it finds any install command. the second pass will only handle the
 30938                                  ;install= command.
 30939                                  
 30940                                  ;------------------------------------------------------------------------------
 30941                                  ;install command
 30942                                  ;------------------------------------------------------------------------------
 30943                                  
 30944                                  	; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 30945                                  	; (SYSINIT:2250h)
 30946                                  tryi:
 30947 000020B4 803E[CD02]00            	cmp	byte [multi_pass_id],0	; the initial pass for DOS=HI
 30948 000020B9 7503                    	jne	short not_init_pass
 30949 000020BB E97F01                  	jmp	multi_try_doshi
 30950                                  not_init_pass:
 30951 000020BE 803E[CD02]02            	cmp	byte [multi_pass_id],2	; the second pass was for ifs=
 30952                                          ; 11/12/2022
 30953                                  	;je	short multi_pass_coff2	; now it is NOPs
 30954 000020C3 74E5                    	je	short coff
 30955                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 30956                                  	;je	short multi_pass_coff	
 30957                                  					; This pass can be made use of if
 30958                                  					; we want do some config.sys process
 30959                                  					; after device drivers are loaded
 30960                                  					; and before install= commands
 30961                                  					; are processed
 30962                                  
 30963 000020C5 803E[CD02]03            	cmp	byte [multi_pass_id],3	; the third pass for install= ?
 30964 000020CA 741D                    	je	short multi_try_i
 30965 000020CC 80FC48                          cmp     ah, CONFIG_DOS  ; 'H'
 30966                                  	; 11/12/2022
 30967                                  	;je	short multi_pass_coff2
 30968 000020CF 74D9                    	je	short coff
 30969                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 30970                                  	;je	short multi_pass_coff	
 30971                                  
 30972                                  ;       make note of any INSTALL= or INSTALLHIGH= commands we find,
 30973                                  ;       but don't process them now.        
 30974                                          
 30975 000020D1 80FC49                          cmp     ah,CONFIG_INSTALL ; 'I'	; install= command?
 30976                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 30977 000020D4 7507                    	jne	short precheck_installhigh ; the first pass is for normal operation.
 30978                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 30979                                  	;jne	short tryb	
 30980                                  	
 30981                                  	;or	word [install_flag],have_install_cmd ; set the flag
 30982 000020D6 800E[CE02]01            	or	byte [install_flag],have_install_cmd ; 1
 30983                                  multi_pass_coff2:
 30984 000020DB EBCD                    	jmp	short coff ; 13/05/2019	; and handles the next command
 30985                                  
 30986                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 30987                                  ; (SYSINIT:2448h)
 30988                                  ; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 30989                                  ;%if 0
 30990                                  precheck_installhigh:
 30991 000020DD 80FC57                  	cmp     ah,CONFIG_INSTALLHIGH ; 'W' ; signifier for INSTALLHIGH
 30992 000020E0 756B                    	jne     short tryb		; carry on with normal processing
 30993                                  	;or	word [install_flag],have_install_cmd
 30994 000020E2 800E[CE02]01            	or	byte [install_flag],have_install_cmd ; 1
 30995 000020E7 EBC1                    	jmp	short coff
 30996                                  ;%endif ; 27/10/2022
 30997                                  
 30998                                  multi_try_i:
 30999 000020E9 80FC49                          cmp     ah,CONFIG_INSTALL ; 'I' ; install= command?
 31000                                  	; 31/12/2022 - Retro DOS v4.2
 31001 000020EC 750A                    	jne	short multi_try_n	; no, check for installhigh
 31002                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31003                                  	;jne	short multi_pass_filter
 31004                                  
 31005                                  ; 31/12/2022
 31006                                  ;%if 1 
 31007                                  ; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31008                                  ;%if 0
 31009                                  ;ifdef	MULTI_CONFIG
 31010 000020EE E8A31F                  	call	query_user              ; query the user if config_cmd
 31011 000020F1 7241                    	jc	short multi_pass_filter	; has the CONFIG_OPTION_QUERY bit set
 31012                                  ;endif
 31013                                  ;%endif ; 27/10/2022
 31014                                  
 31015 000020F3 E8D2EF                  	call	do_install_exec 	;install it.
 31016 000020F6 EBB2                    	jmp	short coff		;to handle next install= command.
 31017                                  
 31018                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31019                                  ; (SYSINIT:2463h)
 31020                                  ;%if 1
 31021                                  ; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31022                                  ;%if 0
 31023                                  
 31024                                  multi_try_n:
 31025 000020F8 80FC57                          cmp     ah,CONFIG_INSTALLHIGH   ; installhigh= command?
 31026 000020FB 7537                            jne	short multi_pass_filter	; no. ignore this.
 31027                                  ;ifdef	MULTI_CONFIG
 31028 000020FD E8941F                          call    query_user              ; query the user if config_cmd
 31029 00002100 7232                            jc      short multi_pass_filter	; has the CONFIG_OPTION_QUERY bit set
 31030                                  ;endif
 31031                                  
 31032                                  ;       The memory environment is in its normal DOS state, so do
 31033                                  ;       the standard calls to set the alloc strategy for loading high
 31034                                  
 31035 00002102 B80058                  	mov	ax,(ALLOCOPER<<8)|0 ; 5800h
 31036 00002105 CD21                    	int	21h			;get alloc strategy
 31037 00002107 89C3                    	mov	bx,ax
 31038 00002109 53                              push    bx                      ; save for the return
 31039                                  
 31040 0000210A 81CB8000                        or	bx,HIGH_FIRST  ; 80h	;set alloc to HighFirst
 31041 0000210E B80158                  	mov	ax,(ALLOCOPER<<8)|1 ; 5801h
 31042 00002111 CD21                    	int	21h			;set alloc strategy
 31043                                  
 31044 00002113 B80258                  	mov     ax,(ALLOCOPER<<8)|2 ; 5802h
 31045 00002116 CD21                            int     21h                     ; get link state
 31046 00002118 30E4                            xor     ah,ah                   ; clear top byte
 31047 0000211A 50                              push    ax                      ; save for return
 31048                                  
 31049 0000211B B80358                          mov	ax,(ALLOCOPER<<8)|3 ; 5803h
 31050 0000211E BB0100                  	mov	bx,1
 31051 00002121 CD21                    	int	21h			;link in UMBs
 31052                                  
 31053 00002123 E8A2EF                  	call	do_install_exec 	;install it.
 31054                                  
 31055 00002126 B80358                          mov     ax,(ALLOCOPER<<8)|3
 31056 00002129 5B                              pop     bx                      ; recover original link state
 31057 0000212A CD21                            int     21h
 31058 0000212C 5B                              pop     bx                      ; recover original alloc strategy
 31059 0000212D B80158                          mov     ax,(ALLOCOPER<<8)|1
 31060 00002130 CD21                            int     21h
 31061                                  
 31062                                  	;jmp	short coff		;to handle next install= command.
 31063                                  	; 01/01/2023
 31064 00002132 EBA7                    	jmp	short multi_pass_coff2
 31065                                  
 31066                                  ;%endif ; 27/10/2022
 31067                                  
 31068                                  multi_pass_filter:
 31069 00002134 80FC59                          cmp     ah,CONFIG_COMMENT ; 'Y' ; comment?
 31070 00002137 740A                    	je	short multi_pass_adjust
 31071 00002139 80FC5A                          cmp     ah,CONFIG_UNKNOWN ; 'Z' ; bad command?
 31072 0000213C 7405                    	je	short multi_pass_adjust
 31073 0000213E 80FC30                          cmp     ah,CONFIG_REM     ; '0' ; rem?
 31074 00002141 7508                    	jne	short multi_pass_coff 	; ignore the rest of the commands.
 31075                                  
 31076                                  multi_pass_adjust:			; these commands need to
 31077 00002143 FF0E[5A03]              	dec	word [chrptr]		;  adjust chrptr,count
 31078 00002147 FF06[5603]              	inc	word [count]		;  for newline proc.
 31079                                  
 31080                                  multi_pass_coff:
 31081                                  	; 11/12/2022
 31082                                  	;jmp	short coff		; to handle next install= commands.
 31083                                  	; 01/01/2023
 31084 0000214B EB8E                    	jmp	short multi_pass_coff2
 31085                                  
 31086                                  ;------------------------------------------------------------------------------
 31087                                  ; buffer command
 31088                                  ;------------------------------------------------------------------------------
 31089                                  
 31090                                  ;******************************************************************************
 31091                                  ;									      *
 31092                                  ; function: parse the parameters of buffers= command.			      *
 31093                                  ;									      *
 31094                                  ; input :								      *
 31095                                  ;	es:si -> parameters in command line.				      *
 31096                                  ; output:								      *
 31097                                  ;	buffers set							      *
 31098                                  ;	buffer_slash_x	flag set if /x option chosen.			      *
 31099                                  ;	h_buffers set if secondary buffer cache specified.		      *
 31100                                  ;									      *
 31101                                  ; subroutines to be called:						      *
 31102                                  ;	sysinit_parse							      *
 31103                                  ; logic:								      *
 31104                                  ; {									      *
 31105                                  ;	set di points to buf_parms;  /*parse control definition*/	      *
 31106                                  ;	set dx,cx to 0; 						      *
 31107                                  ;	reset buffer_slash_x;						      *
 31108                                  ;	while (end of command line)					      *
 31109                                  ;	{ sysinit_parse;						      *
 31110                                  ;	  if (no error) then						      *
 31111                                  ;	       if (result_val._$P_synonym_ptr == slash_e) then /*not a switch *
 31112                                  ;		    buffer_slash_x = 1					      *
 31113                                  ;	       else if	 (cx == 1) then 	    /* first positional */    *
 31114                                  ;			  buffers = result_val._$P_picked_val;		      *
 31115                                  ;		    else  h_buffers = result_val._$P_picked_val; 	      *
 31116                                  ;	  else	{show error message;error exit} 			      *
 31117                                  ;	};								      *
 31118                                  ;	if (buffer_slash_x is off & buffers > 99) then show_error;	      *
 31119                                  ; };									      *
 31120                                  ;									      *
 31121                                  ;******************************************************************************
 31122                                  
 31123                                  	; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 31124                                  	; (SYSINIT:229Ch)
 31125                                  tryb:
 31126 0000214D 80FC42                          cmp     ah,CONFIG_BUFFERS ; 'B'
 31127 00002150 755C                    	jne	short tryc
 31128                                  
 31129                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31130                                  ; (SYSINIT:24BFh)
 31131                                  ; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31132                                  ;%if 0
 31133                                  ;ifdef	MULTI_CONFIG
 31134 00002152 E83F1F                  	call	query_user		; query the user if config_cmd
 31135 00002155 7257                    	jc	short tryc		; has the CONFIG_OPTION_QUERY bit set
 31136                                  ;endif
 31137                                  ;%endif ; 27/10/2022
 31138                                  
 31139                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31140                                  	; 18/12/2022
 31141 00002157 31C9                    	xor	cx,cx
 31142                                  	;mov	byte [p_buffer_slash_x],0 ; 31/03/2019
 31143 00002159 880E[681D]              	mov	[p_buffer_slash_x],cl ; 0
 31144                                  
 31145 0000215D BF[211D]                	mov	di,buf_parms
 31146                                  	;xor	cx,cx	; 18/12/2022
 31147                                  	; 03/01/2023
 31148                                  	;mov	dx,cx
 31149                                  do7:
 31150 00002160 E87C07                  	call	sysinit_parse
 31151 00002163 7303                    	jnc	short if7		; parse error,
 31152                                  	;call	badparm_p		;  and show messages and end the search loop.
 31153                                  	;;jmp	short sr7
 31154                                  	; 31/12/2022
 31155                                  ;sr7:
 31156                                  	;jmp	coff
 31157                                  	; 03/01/2023
 31158 00002165 E9A606                  	jmp	badparm_p_coff
 31159                                  if7:
 31160 00002168 83F8FF                  	cmp	ax,_$P_RC_EOL ; 0FFFFh	; end of line?
 31161 0000216B 741A                    	je	short en7		;  then jmp to $endloop for semantic check
 31162                                  	;cmp	word [result_val_swoff],switch_x ; (/X switch)
 31163 0000216D 813E[6C1D][611D]        	cmp	word [result_val+_$P_Result_Blk.SYNONYM_Ptr],switch_x
 31164                                  	;jne	short if11
 31165                                  	; 31/12/2022
 31166 00002173 74EB                    	je	short do7 ;je short en11
 31167                                  
 31168                                  ;	mov	byte [p_buffer_slash_x],1 ; set the flag M016
 31169                                  	;jmp	short en11 ; 31/12/2022
 31170                                  if11:
 31171                                  	;mov	ax,[rv_dword]
 31172 00002175 A1[6E1D]                	mov	ax,[result_val+_$P_Result_Blk.Picked_Val]
 31173 00002178 83F901                  	cmp	cx,1
 31174 0000217B 7505                    	jne	short if13
 31175                                  
 31176 0000217D A3[641D]                	mov	[p_buffers],ax
 31177                                  	;jmp	short en11
 31178                                  	; 31/12/2022
 31179 00002180 EBDE                    	jmp	short do7
 31180                                  if13:
 31181 00002182 A3[661D]                	mov	[p_h_buffers],ax
 31182                                  en11:
 31183 00002185 EBD9                    	jmp	short do7
 31184                                  en7:
 31185 00002187 833E[641D]63            	cmp	word [p_buffers],99
 31186 0000218C 760B                    	jbe	short if18
 31187                                  
 31188                                  ;	cmp	byte [p_buffer_slash_x],0 ; M016
 31189                                  ;	jne	short if18
 31190                                  
 31191 0000218E E87907                  	call	badparm_p
 31192 00002191 C706[661D]0000          	mov	word [p_h_buffers],0
 31193 00002197 EB12                    	jmp	short sr7
 31194                                  if18:
 31195 00002199 A1[641D]                	mov	ax,[p_buffers]	; we don't have any problem.
 31196 0000219C A3[9902]                	mov	[buffers],ax	; now,let's set it really.
 31197                                  
 31198 0000219F A1[661D]                	mov	ax,[p_h_buffers]
 31199 000021A2 A3[9B02]                	mov	[h_buffers],ax
 31200                                  
 31201                                  ;	mov	al,[p_buffer_slash_x]	; M016
 31202                                  ;	mov	[buffer_slash_x],al
 31203                                  
 31204 000021A5 A1[AF02]                	mov	ax,[linecount]
 31205 000021A8 A3[B902]                	mov	[buffer_linenum],ax ; save the line number for the future use.
 31206                                  	; 31/12/2022
 31207                                  	;jmp	short sr7
 31208                                  	; 03/01/2023
 31209                                  sr7:
 31210 000021AB E9FCFE                  	jmp	coff
 31211                                  
 31212                                  ;------------------------------------------------------------------------------
 31213                                  ; break command
 31214                                  ;------------------------------------------------------------------------------
 31215                                  
 31216                                  ;****************************************************************************
 31217                                  ;									    *
 31218                                  ; function: parse the parameters of break = command.			    *
 31219                                  ;									    *
 31220                                  ; input :								    *
 31221                                  ;	es:si -> parameters in command line.				    *
 31222                                  ; output:								    *
 31223                                  ;	turn the control-c check on or off.				    *
 31224                                  ;									    *
 31225                                  ; subroutines to be called:						    *
 31226                                  ;	sysinit_parse							    *
 31227                                  ; logic:								    *
 31228                                  ; {									    *
 31229                                  ;	set di to brk_parms;						    *
 31230                                  ;	set dx,cx to 0; 						    *
 31231                                  ;	while (end of command line)					    *
 31232                                  ;	{ sysinit_parse;						    *
 31233                                  ;	  if (no error) then						    *
 31234                                  ;	       if (result_val._$P_item_tag == 1) then	  /*on		 */ *
 31235                                  ;		   set p_ctrl_break,on;					    *
 31236                                  ;	       else					  /*off 	 */ *
 31237                                  ;		   set p_ctrl_break,off;				    *
 31238                                  ;	  else {show message;error_exit};				    *
 31239                                  ;	};								    *
 31240                                  ;	if (no error) then						    *
 31241                                  ;	   dos function call to set ctrl_break check according to	    *
 31242                                  ; };									    *
 31243                                  ;									    *
 31244                                  ;****************************************************************************
 31245                                  
 31246                                  	; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 31247                                  	; (SYSINIT:22FFh)
 31248                                  tryc:
 31249 000021AE 80FC43                          cmp     ah,CONFIG_BREAK ; 'C'
 31250 000021B1 7539                    	jne	short trym
 31251                                  
 31252                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31253                                  ; (SYSINIT:2527h)
 31254                                  ; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31255                                  ;%if 0
 31256                                  ;ifdef	MULTI_CONFIG
 31257 000021B3 E8DE1E                  	call	query_user              ; query the user if config_cmd
 31258 000021B6 7234                    	jc	short trym		; has the CONFIG_OPTION_QUERY bit set
 31259                                  ;endif
 31260                                  ;%endif ; 27/10/2022
 31261                                  
 31262 000021B8 BF[721D]                	mov	di,brk_parms
 31263 000021BB 31C9                    	xor	cx,cx
 31264                                  	; 03/01/2023
 31265                                  	;mov	dx,cx
 31266                                  do22:
 31267 000021BD E81F07                  	call	sysinit_parse
 31268 000021C0 7303                    	jnc	short if22		; parse error
 31269                                  	;call	badparm_p		;  show message and end the search loop.
 31270                                  	;;jmp	short sr22
 31271                                  	; 31/12/2022
 31272                                  ;sr22:
 31273                                  	;jmp	coff
 31274                                  	; 03/01/2023
 31275 000021C2 E94906                  	jmp	badparm_p_coff
 31276                                  if22:
 31277 000021C5 83F8FF                  	cmp	ax,_$P_RC_EOL		; end of line?
 31278 000021C8 7415                    	je	short en22		; then end the $endloop
 31279                                  
 31280                                  	;cmp	byte [result_val_itag],1
 31281 000021CA 803E[6B1D]01            	cmp	byte [result_val+_$P_Result_Blk.Item_Tag],1
 31282 000021CF 7507                    	jne	short if26
 31283                                  
 31284 000021D1 C606[971D]01            	mov	byte [p_ctrl_break],1	; turn it on
 31285                                  	;jmp	short en26
 31286                                  	; 31/12/2022
 31287 000021D6 EBE5                    	jmp	short do22
 31288                                  if26:
 31289 000021D8 C606[971D]00            	mov	byte [p_ctrl_break],0	; turn it off
 31290                                  en26:
 31291 000021DD EBDE                    	jmp	short do22		; we actually set the ctrl break
 31292                                  en22:
 31293 000021DF B433                    	mov	ah,SET_CTRL_C_TRAPPING ; if we don't have any parse error.
 31294 000021E1 B001                    	mov	al,1
 31295 000021E3 8A16[971D]              	mov	dl,[p_ctrl_break]
 31296 000021E7 CD21                    	int	21h
 31297                                  	; 31/12/2022
 31298                                  	;jmp	short sr22
 31299                                  	; 03/01/2023
 31300                                  sr22:
 31301 000021E9 E9BEFE                  	jmp	coff
 31302                                  
 31303                                  ;------------------------------------------------------------------------------
 31304                                  ; multitrack command
 31305                                  ;------------------------------------------------------------------------------
 31306                                  
 31307                                  ;******************************************************************************
 31308                                  ;									      *
 31309                                  ; function: parse the parameters of multitrack= command.		      *
 31310                                  ;									      *
 31311                                  ; input :								      *
 31312                                  ;	es:si -> parameters in command line.				      *
 31313                                  ; output:								      *
 31314                                  ;	turn multrk_flag on or off.					      *
 31315                                  ;									      *
 31316                                  ; subroutines to be called:						      *
 31317                                  ;	sysinit_parse							      *
 31318                                  ; logic:								      *
 31319                                  ; {									      *
 31320                                  ;	set di to brk_parms;						      *
 31321                                  ;	set dx,cx to 0; 						      *
 31322                                  ;	while (end of command line)					      *
 31323                                  ;	{ sysinit_parse;						      *
 31324                                  ;	  if (no error) then						      *
 31325                                  ;	       if (result_val._$P_item_tag == 1) then	  /*on		 */   *
 31326                                  ;		   set p_mtrk,on;					      *
 31327                                  ;	       else					  /*off 	 */   *
 31328                                  ;		   set p_mtrk,off;					      *
 31329                                  ;	  else {show message;error_exit};				      *
 31330                                  ;	};								      *
 31331                                  ;	if (no error) then						      *
 31332                                  ;	   dos function call to set multrk_flag according to p_mtrk.	      *
 31333                                  ;									      *
 31334                                  ; };									      *
 31335                                  ;									      *
 31336                                  ;******************************************************************************
 31337                                  
 31338                                  	; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 31339                                  trym:
 31340 000021EC 80FC4D                          cmp     ah,CONFIG_MULTITRACK  ; 'M'
 31341 000021EF 7573                    	jne	short tryu
 31342                                  
 31343                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31344                                  ; (SYSINIT:2569h)
 31345                                  ; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31346                                  ;%if 0
 31347                                  ;ifdef	MULTI_CONFIG
 31348 000021F1 E8A01E                  	call	query_user      ; query the user if config_cmd
 31349 000021F4 726E                    	jc	short tryu	; has the CONFIG_OPTION_QUERY bit set
 31350                                  ;endif
 31351                                  ;%endif	; 27/10/2022
 31352                                  
 31353 000021F6 BF[761E]                	mov	di,mtrk_parms
 31354 000021F9 31C9                    	xor	cx,cx
 31355                                  	; 03/01/2023
 31356                                  	;mov	dx,cx
 31357                                  do31:
 31358 000021FB E8E106                  	call	sysinit_parse
 31359 000021FE 7303                    	jnc	short if31	; parse error
 31360                                  	;call	badparm_p	;  show message and end the search loop.
 31361                                  	;;jmp	short sr31
 31362                                  	; 31/12/2022
 31363                                  ;sr31:
 31364                                  	;jmp	coff
 31365                                  	; 03/01/2023
 31366 00002200 E90B06                  	jmp	badparm_p_coff
 31367                                  if31:
 31368 00002203 83F8FF                  	cmp	ax,_$P_RC_EOL	; end of line?
 31369 00002206 7415                    	je	short en31	; then end the $endloop
 31370                                  
 31371                                  	;cmp	byte [result_val_itag],1
 31372 00002208 803E[6B1D]01            	cmp	byte [result_val+_$P_Result_Blk.Item_Tag],1
 31373 0000220D 7507                    	jne	short if35
 31374                                  
 31375 0000220F C606[8A1E]01            	mov	byte [p_mtrk],1	; turn it on temporarily.
 31376                                  	;jmp	short en35
 31377                                  	; 31/12/2022
 31378 00002214 EBE5                    	jmp	short do31
 31379                                  if35:
 31380 00002216 C606[8A1E]00            	mov	byte [p_mtrk],0	; turn it off temporarily.
 31381                                  en35:
 31382 0000221B EBDE                    	jmp	short do31	; we actually set the multrk_flag here
 31383                                  en31:
 31384 0000221D 1E                      	push	ds
 31385                                  	;;mov	ax,Bios_Data ; 70h
 31386                                  	;mov	ax,KERNEL_SEGMENT ; 70h
 31387                                  	; 21/10/2022
 31388 0000221E B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 31389 00002221 8ED8                    	mov	ds,ax
 31390                                  
 31391 00002223 2E803E[8A1E]00          	cmp	byte [cs:p_mtrk],0
 31392 00002229 7508                    	jne	short if39
 31393                                  
 31394 0000222B C706[A004]0100          	mov	word [multrk_flag],multrk_off2	; 0001h
 31395 00002231 EB06                    	jmp	short en39
 31396                                  if39:
 31397 00002233 C706[A004]8000          	mov	word [multrk_flag],multrk_on	; 0080h
 31398                                  en39:
 31399 00002239 1F                      	pop	ds
 31400                                  	; 31/12/2022
 31401                                  	;jmp	short sr31
 31402                                  	; 03/01/2023
 31403                                  sr31:
 31404 0000223A E96DFE                  	jmp	coff
 31405                                  
 31406                                  ;----------------------------------------------------------------------------
 31407                                  ; DOS=HIGH/LOW command
 31408                                  ;----------------------------------------------------------------------------
 31409                                  
 31410                                  	; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 31411                                  multi_try_doshi:
 31412 0000223D 80FC48                          cmp     ah,CONFIG_DOS ; 'H'
 31413 00002240 7403                    	je	short it_is_h
 31414                                  skip_it:
 31415 00002242 E9EFFE                  	jmp	multi_pass_filter
 31416                                  it_is_h:				; M003 - removed initing DevUMB
 31417                                  					;	 & runhigh
 31418                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31419                                  ; (SYSINIT:25C1h)
 31420                                  ; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31421                                  ;%if 0
 31422                                  ;ifdef	MULTI_CONFIG
 31423 00002245 E84C1E                  	call	query_user              ; query the user if config_cmd
 31424 00002248 72F8                    	jc	short skip_it		; has the CONFIG_OPTION_QUERY bit set
 31425                                  ;endif
 31426                                  ;%endif ; 27/10/2022
 31427                                  
 31428 0000224A BF[DD1E]                	mov	di,dos_parms
 31429 0000224D 31C9                    	xor	cx,cx
 31430                                  	; 03/01/2023
 31431                                  	;mov	dx,cx
 31432                                  h_do_parse:
 31433 0000224F E88D06                  	call	sysinit_parse
 31434 00002252 7303                    	jnc	short h_parse_ok	
 31435                                  h_badparm:				; parse error
 31436                                  	; 03/01/2023
 31437                                  	;call	badparm_p		; show message and end the search loop.
 31438                                  	;;jmp	short h_end
 31439                                  	; 11/12/2022
 31440                                  ;h_end:
 31441                                  	;jmp	coff
 31442                                  	; 03/01/2023
 31443 00002254 E9B705                  	jmp	badparm_p_coff	
 31444                                  h_parse_ok:
 31445 00002257 83F8FF                  	cmp	ax,_$P_RC_EOL		; end of line?
 31446 0000225A 7405                    	je	short h_end		; then end the $endloop
 31447 0000225C E80207                  	call	ProcDOS
 31448 0000225F EBEE                    	jmp	short h_do_parse
 31449                                  	; 11/12/2022
 31450                                  	; 03/01/2023
 31451                                  h_end:
 31452 00002261 E946FE                  	jmp	coff
 31453                                  
 31454                                  ;-----------------------------------------------------------------------------
 31455                                  ; devicehigh command
 31456                                  ;-----------------------------------------------------------------------------
 31457                                  
 31458                                  	; 28/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 31459                                  tryu:
 31460 00002264 80FC55                          cmp     ah,CONFIG_DEVICEHIGH ; 'U'
 31461 00002267 7552                    	jne	short tryd
 31462                                  
 31463                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31464                                  ; (SYSINIT:25E9h)
 31465                                  ; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31466                                  ;%if 0
 31467                                  ;ifdef	MULTI_CONFIG
 31468 00002269 E8281E                  	call	query_user              ; query the user if config_cmd
 31469 0000226C 724D                    	jc	short tryd		; has the CONFIG_OPTION_QUERY bit set
 31470                                  ;endif
 31471                                  ;%endif ; 28/10/2022
 31472                                  
 31473                                  ; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31474                                  ;%if 0
 31475                                  	; 01/01/2023
 31476                                  	; ds = cs
 31477                                  
 31478 0000226E E88707                  	call	InitVar
 31479 00002271 E85B0F                  	call	ParseSize		; process the size= option
 31480                                  	;jnc	short tryu_0
 31481                                  	; 31/12/2022
 31482 00002274 720C                    	jc	short tryu_1 ; 31/03/2019 - Retro DOS v4.0
 31483                                  
 31484                                  ;%endif ; 28/10/2022
 31485                                  
 31486                                  ; 31/12/2022
 31487                                  %if 0
 31488                                  	; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31489                                  	;mov	[cs:badparm_off], si	; stash it there in case of an error
 31490                                  	;mov	[cs:badparm_seg], es
 31491                                  	; 11/12/2022
 31492                                  	; ds = cs
 31493                                  	mov	[badparm_off], si
 31494                                  	mov	[badparm_seg], es
 31495                                  
 31496                                  	; 31/12/2022
 31497                                  	;call	ParseSize
 31498                                  	;jnc	short tryu_2	; 28/10/2022
 31499                                  	
 31500                                  	;call	badparm_p
 31501                                  	;jmp	coff
 31502                                  	; 03/01/2023
 31503                                  	jmp	badparm_p_coff
 31504                                  %endif
 31505                                  
 31506                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31507                                  ; (SYSINIT:2606h)
 31508                                  ; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31509                                  ;%if 0
 31510                                  tryu_0:
 31511                                  	;mov	ax,[cs:DevSizeOption]
 31512                                  	; 31/12/2022
 31513 00002276 A1[771F]                	mov	ax,[DevSizeOption] ; ds = cs
 31514 00002279 09C0                    	or	ax,ax
 31515 0000227B 7510                    	jnz	short tryu_2
 31516                                  
 31517 0000227D E80A08                  	call	ParseVar
 31518 00002280 730B                    	jnc	short tryu_2
 31519                                  tryu_1:
 31520                                  	; 31/12/2022
 31521                                  	; ds = cs
 31522 00002282 8936[BA14]              	mov	[badparm_off], si
 31523 00002286 8C06[BC14]              	mov	[badparm_seg], es
 31524                                  	;mov	[cs:badparm_off], si	; If ParseVar up there failed, then
 31525                                  	;mov	[cs:badparm_seg], es	; ES:SI points to its problem area...
 31526                                  	
 31527                                  	;call	badparm_p		; so all we have to do is choke and
 31528                                  	;jmp	coff			; die, rather verbosely.
 31529                                  	; 03/01/2023
 31530 0000228A E98105                  	jmp	badparm_p_coff
 31531                                  
 31532                                  ;%endif ; 28/10/2022
 31533                                  
 31534                                  tryu_2:	
 31535 0000228D 56                      	push	si
 31536 0000228E 06                      	push	es
 31537                                  
 31538                                  	; 08/09/2023 - Retro DOS 4.2 IO.SYS (Optimization)
 31539                                  	; MSDOS 6.21 IO.SYS - SYSINIT:2623h
 31540                                  	; PCDOS 7.1 IBMBIO.COM - SYSINIT:2B17h
 31541                                  tryu_3:
 31542 0000228F 268A04                  	mov	al,[es:si]
 31543 00002292 3C0D                    	cmp	al,cr
 31544 00002294 740C                    	je	short tryu_4
 31545                                  	; 08/09/2023 - Retro DOS 5.0 (PCDOS 7.1 IBMBIO.COM)
 31546                                  	;je	short tryu_5
 31547 00002296 3C0A                    	cmp	al,lf
 31548 00002298 7408                    	je	short tryu_4
 31549 0000229A E8651F                  	call	delim
 31550 0000229D 7403                    	jz	short tryu_4
 31551 0000229F 46                      	inc	si
 31552 000022A0 EBED                    	jmp	short tryu_3
 31553                                  
 31554                                  	; 08/09/2023 - Retro DOS 5.0 (PCDOS 7.1 IBMBIO.COM)
 31555                                  ;tryu_5:
 31556                                  ;	mov     al, 20h ; ' '   ; blank instead of cr
 31557                                  
 31558                                  tryu_4:	
 31559                                  	; 11/12/2022
 31560                                  	; ds = cs
 31561 000022A2 A2[8B1F]                	mov	[DevSavedDelim],al
 31562                                  	;mov	[cs:DevSavedDelim],al	; Save the delimiter before replacing
 31563                                  					;  it with null
 31564                                  	; 18/12/2022
 31565 000022A5 29DB                    	sub	bx,bx
 31566 000022A7 26881C                  	mov	[es:si],bl ; 0
 31567                                   	;mov	byte [es:si],0
 31568                                  
 31569 000022AA 07                      	pop	es
 31570 000022AB 5E                      	pop	si
 31571                                  
 31572                                  ;------------------------------------------------------------------------------
 31573                                  ; BEGIN PATCH TO CHECK FOR NON-EXISTANT UMBs   -- t-richj 7-21-92
 31574                                  ;------------------------------------------------------------------------------
 31575                                  
 31576                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31577                                  ; (SYSINIT:2642h)
 31578                                  ; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31579                                  ;%if 0
 31580                                  ; 10/07/2023 - Retro DOS v4.2 IO.SYS (optimized)
 31581                                  ; MSDOS 6.21 IO.SYS - SYSINIT:2642h
 31582                                  %if 1
 31583                                  	; 01/01/2023
 31584                                  	; ds = cs
 31585 000022AC E8480C                  	call	UmbTest			; See if UMBs are around...
 31586                                  	; 01/01/2023
 31587                                  	;jnc	short NrmTst		; ...yep. So do that normal thang.
 31588                                  	
 31589                                  	;mov	byte [cs:DeviceHi],0	; ...nope... so load low.
 31590                                  	; 31/12/2022
 31591                                  	; ds = cs, bx = 0
 31592                                  	;mov	byte [DeviceHi],bl ; 0
 31593                                  	;jmp	short LoadDevice
 31594                                  	; 01/01/2023
 31595 000022AF 7222                    	jc	short LoadDevice ; bl = 0
 31596                                  %endif
 31597                                  ;%endif
 31598                                  
 31599                                  ;------------------------------------------------------------------------------
 31600                                  ; END PATCH TO CHECK FOR NON-EXISTANT UMBs   -- t-richj 7-21-92
 31601                                  ;------------------------------------------------------------------------------
 31602                                  
 31603                                  NrmTst:
 31604                                  	; 11/12/2022
 31605                                  	; ds = cs
 31606                                  	;;mov	byte [cs:DeviceHi],0
 31607                                  	;mov	byte [DeviceHi],0
 31608                                  	; 18/12/2022
 31609                                  	; bx = 0
 31610 000022B1 381E[671F]              	cmp	[DevUMB],bl ; 0
 31611                                  	;cmp	byte [DevUMB],0
 31612                                  	;;cmp	byte [cs:DevUMB],0	; do we support UMBs
 31613 000022B5 741C                    	je	short LoadDevice	; no, we don't
 31614                                  	;mov	byte [cs:DeviceHi],1
 31615                                  	; 11/12/2022
 31616                                  	;mov	byte [DeviceHi],1
 31617                                  	; 18/12/2022
 31618 000022B7 FEC3                    	inc	bl ; mov bl,1 ; (*)
 31619                                  	; 11/12/2022
 31620                                  	;jmp	short LoadDevice2	; 11/12/2022
 31621 000022B9 EB18                    	jmp	short LoadDevice
 31622                                  
 31623                                  ;------------------------------------------------------------------------------
 31624                                  ; device command
 31625                                  ;------------------------------------------------------------------------------
 31626                                  
 31627                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31628                                  	; (SYSINIT:2665h)
 31629                                  
 31630                                  	; 28/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 31631                                  	; (SYSINIT:2401h)
 31632                                  tryd:
 31633                                  	; 11/12/2022
 31634                                  	;xor 	bx,bx ; 31/12/2022
 31635                                  	;
 31636 000022BB 80FC44                          cmp     ah,CONFIG_DEVICE ; 'D'
 31637 000022BE 7403                    	je	short gotd
 31638                                  skip_it2:
 31639 000022C0 E99302                  	jmp	tryq
 31640                                  gotd:
 31641                                  
 31642                                  ; 31/12/2022 - Retro DOS v4.2
 31643                                  ; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31644                                  ;%if 0
 31645                                  ;ifdef	MULTI_CONFIG
 31646 000022C3 E8CE1D                  	call	query_user              ; query the user if config_cmd
 31647 000022C6 72F8                    	jc	short skip_it2		; has the CONFIG_OPTION_QUERY bit set
 31648                                  ;endif
 31649                                  ;%endif ; 28/10/2022
 31650                                  
 31651                                  	; 31/12/2022
 31652 000022C8 29DB                    	sub	bx,bx
 31653                                  	; bx = 0
 31654                                  	; 11/12/2022
 31655                                  	; ds = cs
 31656                                  	;mov	byte [DeviceHi],0
 31657                                  	;mov	word [DevSizeOption],0
 31658 000022CA 891E[771F]              	mov	[DevSizeOption],bx ; 0
 31659 000022CE C606[8B1F]20            	mov	byte [DevSavedDelim],' '
 31660                                  	;mov	byte [cs:DeviceHi],0	; not to be loaded in UMB ;M007
 31661                                  	;mov	word [cs:DevSizeOption],0
 31662                                  	;mov	byte [cs:DevSavedDelim],' ' ; In case of DEVICE= the null has to
 31663                                  					;  be replaced with a ' '
 31664                                  LoadDevice:                             ; device= or devicehigh= command.
 31665                                  	; 11/12/2022
 31666                                  	;mov	byte [DeviceHi],0
 31667 000022D3 881E[761F]              	mov	byte [DeviceHi],bl	; 0 or 1 (*)
 31668                                  LoadDevice2:
 31669                                  	; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)        
 31670                                  	;
 31671                                  	;push    cs
 31672                                          ;pop     ds
 31673                                  	;
 31674                                  	;mov	[bpb_addr],si		; pass the command line to the device
 31675                                  	;mov	[bpb_addr+2],es
 31676                                  	;
 31677                                  	;mov	[DevCmdLine],si		; save it for ourself
 31678                                  	;mov	[DevCmdLine+2],es
 31679                                  	;
 31680                                  	;mov	byte [driver_units],0	; clear total block units for driver	
 31681                                  
 31682                                  	; 11/12/2022
 31683                                  	; ds = cs
 31684                                  	;mov	bx,cs
 31685                                  	;mov	ds,bx
 31686                                  
 31687                                  	;mov	[cs:bpb_addr],si	; pass the command line to the device
 31688 000022D7 8936[7C03]              	mov	[bpb_addr],si
 31689                                  	;mov	[cs:bpb_addr+2],es
 31690 000022DB 8C06[7E03]              	mov	[bpb_addr+2],es
 31691                                  
 31692                                  	;mov	[cs:DevCmdLine],si	; save it for ourself
 31693 000022DF 8936[871F]              	mov	[DevCmdLine],si
 31694                                  	;mov	[cs:DevCmdLine+2],es	
 31695 000022E3 8C06[891F]              	mov	[DevCmdLine+2],es
 31696                                  
 31697                                  	; 31/12/2022 - Retro DOS v4.2
 31698 000022E7 C606[B914]00            	mov	byte [driver_units],0	; clear total block units for driver	
 31699                                  
 31700 000022EC E87B1F                  	call	round
 31701                                  	
 31702 000022EF E8E90D                  	call	SizeDevice
 31703 000022F2 723F                    	jc	short BadFile
 31704                                  
 31705                                  	; 11/12/2022
 31706                                  	; ds = cs
 31707                                  
 31708                                  ; - Begin DeviceHigh primary logic changes ------------------------------------
 31709                                  
 31710                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31711                                  ; (SYSINIT:26A4h)
 31712                                  
 31713                                  ; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31714                                  ;%if 0
 31715 000022F4 C606[661F]01            	mov	byte [ConvLoad],1	; Doesn't matter if DeviceHi==0
 31716                                  
 31717                                  	; 22/07/2023
 31718                                  	;mov	al,[DeviceHi]		; If not using upper memory,
 31719 000022F9 800E[761F]00            	or	byte [DeviceHi],0	; Skip all this and go on to
 31720                                  	; 10/07/2023
 31721                                  	;or	al,al
 31722 000022FE 741E                    	jz	short DevConvLoad	; the actual load.
 31723                                  
 31724                                  	;call	GetLoadUMB		; Returns first UMB spec'ed in AX
 31725 00002300 A0[241F]                	mov	al,[UmbLoad]	; 19/04/2019 - Retro DOS v4.0
 31726                                  
 31727 00002303 3CFF                    	cmp	al,-1			; If umb0 not specified, it's old style
 31728 00002305 7417                    	jz	short DevConvLoad	; so load high even if SIZE= is smaller
 31729                                  
 31730 00002307 FE0E[661F]              	dec	byte [ConvLoad] ; 0 	; They specified /L, so use new loader
 31731                                  
 31732 0000230B E8B109                  	call	GetLoadSize		; Returns size of first UMB specified
 31733 0000230E 09C0                    	or	ax,ax
 31734 00002310 7406                    	jz	short tryd_1		; If size is not specified..
 31735                                  
 31736 00002312 3B06[581F]              	cmp	ax,[DevSize]		; /L:...,Size < DevSize?
 31737 00002316 7D06                    	jge	short DevConvLoad
 31738                                  tryd_1:
 31739 00002318 A1[581F]                	mov	ax,[DevSize]		; Size < DevSize, so write DevSize as
 31740 0000231B E8AD09                  	call	StoLoadSize		; minsize for load UMB.
 31741                                  
 31742                                  ;%endif ; 28/10/2022
 31743                                  
 31744                                  ; - End DeviceHigh primary logic changes --------------------------------------
 31745                                  
 31746                                  DevConvLoad:
 31747                                  	; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31748 0000231E E8BE0C                  	call	InitDevLoad
 31749                                  
 31750                                  	; 11/12/2022
 31751                                  	; ds = cs
 31752 00002321 A1[5A1F]                	mov	ax,[DevLoadAddr]
 31753 00002324 0306[581F]              	add	ax,[DevSize]
 31754 00002328 7206                    	jc	short NoMem
 31755 0000232A 3906[5C1F]              	cmp	[DevLoadEnd],ax
 31756 0000232E 7315                    	jae	short LoadDev
 31757                                  	
 31758                                  	; 11/12/2022
 31759                                  	;mov	ax,[cs:DevLoadAddr]
 31760                                  	;add	ax,[cs:DevSize]
 31761                                  	;jc	short NoMem
 31762                                  	;cmp	[cs:DevLoadEnd],ax
 31763                                  	;jae	short LoadDev
 31764                                  NoMem:
 31765                                  	; 11/12/2022
 31766                                  	; ds = cs
 31767                                  	;jmp	mem_err
 31768 00002330 E9761F                  	jmp	mem_err2
 31769                                  
 31770                                  BadFile:
 31771                                  	; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31772                                  	;;call	RetFromUM		; Does nothing if didn't call HideUMBs
 31773                                  	;;cmp	byte [es:si],' '
 31774                                          ;;jae	short tryd_2
 31775                                  	; 31/12/2022	
 31776                                  	;cmp	byte [es:si],0Dh	; cr
 31777                                          ;jne	short tryd_2
 31778                                  	;jmp	badop
 31779                                  	; 31/12/2022
 31780                                  	; ds = cs
 31781                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31782                                  	; (SYSINIT:26E6h)
 31783 00002333 E8060E                  	call	RetFromUM		; Does nothing if didn't call HideUMBs
 31784 00002336 26803C20                	cmp	byte [es:si],' ' 
 31785                                  	;cmp	byte [es:si],20h ; space
 31786 0000233A 7303                    	jnb	short tryd_2
 31787 0000233C E9BF05                  	jmp	badop
 31788                                  tryd_2:
 31789 0000233F E86221                  	call	badload
 31790 00002342 E965FD                  	jmp	coff
 31791                                  
 31792                                  LoadDev:
 31793 00002345 06                      	push	es
 31794 00002346 1F                      	pop	ds
 31795                                  
 31796 00002347 89F2                    	mov	dx,si			;ds:dx points to file name
 31797 00002349 E8D40D                  	call	ExecDev			; load device driver using exec call
 31798                                  badldreset:
 31799 0000234C 1E                      	push	ds
 31800 0000234D 07                      	pop	es			;es:si back to config.sys
 31801 0000234E 0E                      	push	cs
 31802 0000234F 1F                      	pop	ds			;ds back to sysinit
 31803 00002350 72E1                    	jc	short BadFile
 31804                                  goodld:
 31805                                  	; 11/12/2022
 31806                                  	; ds = cs
 31807                                  
 31808 00002352 06                      	push	es ; +	; 31/12/2022
 31809 00002353 56                      	push	si ; ++
 31810 00002354 E8F60D                  	call	RemoveNull
 31811 00002357 06                      	push	es
 31812 00002358 56                      	push	si
 31813                                  
 31814 00002359 0E                      	push	cs
 31815 0000235A 07                      	pop	es
 31816                                  
 31817 0000235B 1E                      	push	ds ; **  ; ds = cs
 31818 0000235C 56                      	push	si
 31819                                  
 31820                                  	;lds	si,[cs:DevEntry]	; peeks the header attribute
 31821                                  	; 31/12/2022
 31822                                  	; ds = cs
 31823 0000235D C536[5E1F]              	lds	si,[DevEntry]
 31824                                  
 31825                                  	;test	word [si+4],8000h
 31826                                  	; 11/12/2022
 31827 00002361 F6440580                	test	byte [si+SYSDEV.ATT+1],DEVTYP>>8
 31828                                  	;test	word [si+SYSDEV.ATT],DEVTYP ; block device driver?
 31829 00002365 7514                    	jnz	short got_device_com_cont   ; no.
 31830                                  
 31831 00002367 2EC536[6D02]            	lds	si,[cs:DOSINFO]		; ds:si -> sys_var
 31832                                  	;cmp	byte [si+32],26
 31833 0000236C 807C201A                	cmp	byte [si+SYSI_NUMIO],26	; no more than 26 drive number
 31834 00002370 7209                    	jb	short got_device_com_cont
 31835                                  
 31836 00002372 5E                      	pop	si
 31837 00002373 1F                      	pop	ds ; **
 31838                                  
 31839 00002374 5E                      	pop	si			; clear the stack
 31840 00002375 07                      	pop	es
 31841                                  
 31842                                  	; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31843                                  	;call	RetFromUM
 31844                                  	; 31/12/2022
 31845                                  	; ds = cs ; **
 31846 00002376 E8C30D                  	call	RetFromUM		; Do this before we leave
 31847                                  
 31848                                  	;jmp	short badnumblock
 31849                                  	; 31/12/2022
 31850 00002379 EB73                    	jmp	short badnumblock2  ; ds = cs
 31851                                  
 31852                                  got_device_com_cont:
 31853 0000237B 5E                      	pop	si
 31854 0000237C 1F                      	pop	ds
 31855                                  
 31856                                  	; 11/12/2022
 31857                                  	; ds = cs
 31858                                  
 31859 0000237D E80406                  	call	LieInt12Mem
 31860 00002380 E86306                  	call	UpdatePDB		; update the PSP:2 value M020
 31861                                  
 31862                                  	; 11/12/2022
 31863                                  	; ds = cs
 31864                                  	; 08/09/2023
 31865 00002383 31C0                    	xor	ax, ax ; 0
 31866 00002385 3806[B514]              	cmp	byte [multdeviceflag],al ; 0
 31867                                  	;cmp	byte [multdeviceflag],0
 31868                                  	;cmp	byte [cs:multdeviceflag],0 ; Pass limit only for the 1st device
 31869                                  					;  driver in the file ; M027
 31870 00002389 750B                    	jne	short skip_pass_limit	;		      ; M027
 31871                                  
 31872                                  	; 11/12/2022
 31873                                  	; ds = cs
 31874                                  	;mov	word [cs:break_addr],0	; pass the limit to the DD
 31875                                  	;mov	bx,[cs:DevLoadEnd]
 31876                                  	;mov	[cs:break_addr+2],bx
 31877                                  
 31878                                  	;mov	word [break_addr],0
 31879                                  	; 08/09/2023
 31880 0000238B A3[7803]                	mov	[break_addr],ax ; 0
 31881 0000238E 8B1E[5C1F]              	mov	bx,[DevLoadEnd]
 31882 00002392 891E[7A03]              	mov	[break_addr+2],bx
 31883                                  
 31884                                  skip_pass_limit:
 31885                                  ;	Note: sysi_numio (in DOS DATA) currently reflects the REAL
 31886                                  ;	number of installed devices (including DblSpace drives) where
 31887                                  ;	"drivenumber" is the number that the next block device will
 31888                                  ;	be assigned to. Because some naughty device drivers (like
 31889                                  ;	interlnk) look at the internal DOS variable instead of the
 31890                                  ;	value we pass it, we'll temporarily stick our value into
 31891                                  ;	DOS DATA while we're initializing the device drivers.
 31892                                  ;
 31893                                  ;	Note that this will make it impossible for this device
 31894                                  ;	driver to access the DblSpace drive letters, whether
 31895                                  ;	they are swapped-hosts or unswapped compressed drives,
 31896                                  ;	during its initialization phase.
 31897                                  
 31898                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31899                                  ; (SYSINIT:2752h)
 31900                                  ; 29/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31901                                  ;%if 0
 31902                                  	; 31/12/2022
 31903                                  	;push	ds
 31904                                  	
 31905                                  	;lds	bx,[cs:DOSINFO]		; ds:bx -> sys_var
 31906                                  	; 31/12/2022
 31907                                  	; ds = cs
 31908                                  	; 08/09/2023
 31909                                  	;lds	bx,[DOSINFO]		; ds:bx -> sys_var
 31910                                  
 31911                                  	;mov	al,[cs:drivenumber]	; temporarily use this next drv value
 31912                                  	;mov	[cs:devdrivenum],al	; pass drive number in packet to driver
 31913                                  	;mov	ah,al
 31914                                  
 31915                                  	; 08/09/2023
 31916                                  	; ds = cs
 31917 00002396 A0[8003]                	mov	al,[drivenumber]	; temporarily use this next drv value		
 31918 00002399 A2[8003]                	mov	[devdrivenum],al	; pass drive number in packet to driver
 31919 0000239C 88C4                    	mov	ah,al
 31920 0000239E C51E[6D02]              	lds	bx,[DOSINFO]		; ds:bx -> sys_var
 31921                                  
 31922 000023A2 874720                  	xchg	ax,[bx+SYSI_NUMIO]	; swap with existing values
 31923                                  	; 31/12/2022
 31924                                  	;pop	ds
 31925                                  	
 31926 000023A5 50                      	push	ax			; save real sysi_numio/ncds in ax
 31927                                  
 31928                                  ;%endif ; 29/10/2022
 31929                                  
 31930                                  	; 29/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 31931                                  	; (SYSINIT:24B9h)
 31932                                  
 31933 000023A6 BB0600                  	mov	bx,SYSDEV.STRAT ; 6
 31934 000023A9 E8061F                  	call	calldev 		; calldev (sdevstrat);
 31935 000023AC BB0800                  	mov	bx,SYSDEV.INT ; 8
 31936 000023AF E8001F                  	call	calldev 		; calldev (sdevint);
 31937                                  
 31938                                  	; 11/12/2022
 31939                                  	; ds <> cs (from calldev) ; 31/12/2022
 31940                                  
 31941                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31942                                  ; (SYSINIT:2773h)
 31943                                  ; 29/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31944                                  ;%if 0
 31945 000023B2 58                      	pop	ax			; get real sysi_numio value
 31946                                  	; 31/12/2022
 31947                                  	;push	ds
 31948 000023B3 2EC51E[6D02]            	lds	bx,[cs:DOSINFO]		; ds:bx -> sys_var
 31949 000023B8 894720                  	mov	[bx+SYSI_NUMIO],ax	; restore previous/real value
 31950                                  	; 31/12/2022
 31951                                  	;pop	ds
 31952                                  
 31953                                  ;%endif ; 29/10/2022
 31954                                  
 31955                                  	; 11/12/2022
 31956 000023BB 0E                      	push	cs
 31957 000023BC 1F                      	pop	ds
 31958                                  
 31959 000023BD E8F405                  	call	TrueInt12Mem
 31960                                  
 31961                                  	; 11/12/2022
 31962                                  	; ds = cs
 31963                                  	;mov	ax,[cs:break_addr]	; move break addr from the req packet
 31964                                  	;mov	[cs:DevBrkAddr],ax
 31965                                  	;mov	ax,[cs:break_addr+2]
 31966                                  	;mov	[cs:DevBrkAddr+2],ax
 31967 000023C0 A1[7803]                	mov	ax,[break_addr]	
 31968 000023C3 A3[621F]                	mov	[DevBrkAddr],ax
 31969 000023C6 A1[7A03]                	mov	ax,[break_addr+2]
 31970 000023C9 A3[641F]                	mov	[DevBrkAddr+2],ax
 31971                                  
 31972                                  	; 29/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31973                                  	;call	RetFromUM		; There we go... all done.
 31974                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31975                                  	; (SYSINIT:2791h)
 31976 000023CC E86D0D                  	call	RetFromUM		; There we go... all done.	
 31977                                  
 31978                                  	; 31/12/2022
 31979                                  	; ds = cs
 31980                                  
 31981                                  	; 11/12/2022
 31982 000023CF 803E[671F]00            	cmp	byte [DevUMB],0	
 31983                                  	;cmp	byte [cs:DevUMB],0
 31984 000023D4 7403                    	je	short tryd_3
 31985 000023D6 E8580F                  	call	AllocUMB
 31986                                  	; 31/12/2022
 31987                                  	; ds = cs
 31988                                  tryd_3:
 31989                                  
 31990                                  ;ifndef ROMDOS
 31991                                  ;------ If we are waiting to be moved into hma lets try it now !!!
 31992                                  
 31993                                  	; 11/12/2022
 31994                                  	; ds = cs
 31995                                  	
 31996                                  	;cmp	byte [cs:runhigh],0FFh
 31997 000023D9 803E[6C02]FF            	cmp	byte [runhigh],0FFh ; 11/12/2022
 31998 000023DE 7503                    	jne	short tryd_4
 31999                                  	
 32000                                  	; 11/12/2022
 32001                                  	; ds = cs
 32002 000023E0 E881E5                  	call	TryToMovDOSHi		; move DOS into HMA if reqd
 32003                                  tryd_4:
 32004                                  ;endif ; ROMDOS
 32005                                  
 32006 000023E3 5E                      	pop	si
 32007 000023E4 1F                      	pop	ds
 32008 000023E5 C60400                  	mov	byte [si],0		; *p = 0;
 32009                                  
 32010 000023E8 0E                      	push	cs
 32011 000023E9 1F                      	pop	ds
 32012                                  
 32013 000023EA EB1F                    	jmp	short was_device_com
 32014                                  
 32015                                  ;----------------------------------------------------------------------------
 32016                                  
 32017                                  ; 02/04/2019 - Retro DOS v4.0
 32018                                  
 32019                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32020                                  ; (SYSINIT:27B3h)
 32021                                  
 32022                                  badnumblock:
 32023 000023EC 0E                      	push	cs
 32024 000023ED 1F                      	pop	ds
 32025                                  badnumblock2:	; 31/12/2022 (ds=cs)
 32026 000023EE BA[184B]                	mov	dx,badblock
 32027 000023F1 E8D820                  	call	print
 32028                                  
 32029                                  ;------ fall thru -----------------------------------------------------------
 32030                                  
 32031                                  	; 31/12/2022 - Retro DOS v4.2
 32032                                  
 32033                                  erase_dev_do:				; modified to show message "error in config.sys..."
 32034                                  	
 32035                                  	;call	CheckDoubleSpace ; MSDOS 6.21 IO.SYS SYSINIT:27BBh
 32036                                  				; (Note: 'call CheckDoubleSpace'
 32037                                  				; has been removed at 'erase_dev_do:' pos
 32038                                  				; in PCDOS 7.1 IBMBIO.COM - SYSINIT:2CBAh)
 32039                                  				; Erdogan Tan - 10/07/2023
 32040 000023F4 5E                      	pop	si ; ++
 32041 000023F5 07                      	pop	es ; + ; 31/12/2022
 32042                                  
 32043 000023F6 0E                      	push	cs
 32044 000023F7 1F                      	pop	ds
 32045                                  
 32046                                  skip1_resetmemhi:
 32047                                  	; 11/12/2022
 32048                                  	; ds = cs
 32049 000023F8 833E[8103]00            	cmp	word [configmsgflag],0
 32050                                  	;cmp	word [cs:configmsgflag],0
 32051 000023FD 7409                    	je	short no_error_line_msg
 32052                                  
 32053 000023FF E83005                  	call	error_line		; no "error in config.sys" msg for device driver. dcr d493
 32054                                  	; 11/12/2022
 32055                                  	; ds = cs
 32056                                  	;mov	word [cs:configmsgflag],0
 32057 00002402 C706[8103]0000          	mov	word [configmsgflag],0	; set the default value again.
 32058                                  
 32059                                  no_error_line_msg:
 32060 00002408 E99FFC                  	jmp	coff
 32061                                  
 32062                                  ;----------------------------------------------------------------------------
 32063                                  
 32064                                  was_device_com:
 32065                                  	; 14/12/2022
 32066                                  	; ds = cs
 32067 0000240B A1[641F]                	mov	ax,[DevBrkAddr+2]
 32068                                  	;mov	ax,[cs:DevBrkAddr+2] ; 13/05/2019
 32069 0000240E 3B06[5C1F]              	cmp	ax,[DevLoadEnd]
 32070                                  	;cmp	ax,[cs:DevLoadEnd]
 32071 00002412 7605                    	jbe	short breakok
 32072                                  
 32073 00002414 5E                      	pop	si
 32074 00002415 07                      	pop	es
 32075 00002416 E91AFF                  	jmp	BadFile
 32076                                  
 32077                                  breakok:
 32078                                  	; 14/12/2022
 32079                                  	; ds = cs
 32080 00002419 C43E[6D02]              	les	di,[DOSINFO] 
 32081 0000241D C516[5E1F]              	lds	dx,[DevEntry]
 32082                                  	;lds	dx,[cs:DevEntry]	;set ds:dx to header
 32083 00002421 89D6                    	mov	si,dx
 32084                                  
 32085                                  	; 14/11/2022
 32086                                  	;les	di,[cs:DOSINFO] 	;es:di point to dos info
 32087                                  
 32088                                  	; 14/12/2022
 32089                                  	; ds <> cs
 32090                                  	
 32091                                  	;mov	ax,[si+4]
 32092 00002423 8B4404                  	mov	ax,[si+SYSDEV.ATT]	;get attributes
 32093                                  	; 12/12/2022
 32094 00002426 F6C480                  	test	ah,DEVTYP>>8 ; 80h 
 32095                                  	;test	ax,DEVTYP ; 8000h	;test if block dev
 32096 00002429 7426                    	jz	short isblock
 32097                                  
 32098                                  ;------ lets deal with character devices
 32099                                  
 32100 0000242B 2E800E[B814]02          	or	byte [cs:setdevmarkflag],for_devmark ; 2
 32101 00002431 E84C0D                  	call	DevSetBreak		;go ahead and alloc mem for device
 32102                                  jc_edd:
 32103 00002434 72BE                    	jc	short erase_dev_do	;device driver's init routine failed.
 32104                                  
 32105                                  	; 12/12/2022
 32106 00002436 A801                    	test	al,ISCIN
 32107                                  	;test	ax,ISCIN ; 1		;is it a console in?
 32108 00002438 7408                    	jz	short tryclk
 32109                                  
 32110 0000243A 2689550C                	mov	[es:di+SYSI_CON],dx   ; es:di+12
 32111 0000243E 268C5D0E                	mov	[es:di+SYSI_CON+2],ds ; es:di+14
 32112                                  tryclk: 
 32113                                  	; 12/12/2022
 32114 00002442 A808                    	test	al,ISCLOCK
 32115                                  	;test	ax,ISCLOCK ; 8		;is it a clock device?
 32116 00002444 7408                    	jz	short golink
 32117                                  
 32118 00002446 26895508                	mov	[es:di+SYSI_CLOCK],dx	; es:di+8
 32119 0000244A 268C5D0A                	mov	[es:di+SYSI_CLOCK+2],ds ; es:di+10
 32120                                  golink: 
 32121 0000244E E9B500                  	jmp	linkit
 32122                                  
 32123                                  ;------ deal with block device drivers
 32124                                  
 32125                                  isblock:
 32126 00002451 2EA0[7703]              	mov	al,[cs:unitcount]	;if no units found,erase the device
 32127 00002455 08C0                    	or	al,al
 32128 00002457 749B                    	jz	short erase_dev_do
 32129                                  	;mov	[si+10],al
 32130 00002459 88440A                  	mov	[si+SYSDEV.NAME],al	; number of units in name field
 32131                                  	; 29/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32132                                  	;add	[cs:driver_units],al
 32133                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32134 0000245C 2E0006[B914]            	add	[cs:driver_units],al	; keep total for all drivers in file
 32135                                  perdrv:
 32136 00002461 98                      	cbw				; warning no device > 127 units
 32137 00002462 89C1                    	mov	cx,ax
 32138 00002464 88E6                    	mov	dh,ah
 32139                                  	;mov	dl,[es:di+32]
 32140 00002466 268A5520                	mov	dl,[es:di+SYSI_NUMIO]	;get number of devices
 32141 0000246A 88D4                    	mov	ah,dl
 32142 0000246C 00C4                    	add	ah,al			; check for too many devices
 32143 0000246E 80FC1A                  	cmp	ah,26			; 'A' - 'Z' is 26 devices
 32144 00002471 7603                    	jbe	short ok_block
 32145 00002473 E976FF                  	jmp	badnumblock
 32146                                  
 32147                                  ok_block:
 32148 00002476 2E800E[B814]02          	or	byte [cs:setdevmarkflag],for_devmark ; 2
 32149 0000247C E8010D                  	call	DevSetBreak		; alloc the device
 32150 0000247F 72B3                    	jc	short jc_edd
 32151 00002481 26004520                	add	[es:di+SYSI_NUMIO],al	; update the amount
 32152                                  
 32153 00002485 2E0006[8003]            	add	[cs:drivenumber],al	; remember amount for next device
 32154 0000248A 2EC51E[7C03]            	lds	bx,[cs:bpb_addr]	; point to bpb array
 32155                                  perunit:
 32156 0000248F 2EC42E[6D02]            	les	bp,[cs:DOSINFO]
 32157                                  	;les	bp,[es:bp+SYSI_DPB]	; get first dpb
 32158                                  	; 11/12/2022
 32159 00002494 26C46E00                	les	bp,[es:bp]
 32160                                  	; 29/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32161                                  	;les	bp,[es:bp+0]		; [es:bp+SYSI_DPB]
 32162                                  scandpb:
 32163                                  	;cmp	word [es:bp+25],-1
 32164 00002498 26837E19FF              	cmp	word [es:bp+DPB.NEXT_DPB],-1
 32165 0000249D 7406                    	je	short foundpb
 32166                                  	;les	bp,[es:bp+25]
 32167 0000249F 26C46E19                	les	bp,[es:bp+DPB.NEXT_DPB]
 32168 000024A3 EBF3                    	jmp	short scandpb
 32169                                  foundpb:
 32170 000024A5 2EA1[621F]              	mov	ax,[cs:DevBrkAddr]
 32171 000024A9 26894619                	mov	[es:bp+DPB.NEXT_DPB],ax
 32172 000024AD 2EA1[641F]              	mov	ax,[cs:DevBrkAddr+2]
 32173 000024B1 2689461B                	mov	[es:bp+DPB.NEXT_DPB+2],ax
 32174                                  
 32175 000024B5 2EC42E[621F]            	les	bp,[cs:DevBrkAddr]
 32176 000024BA 2E8306[621F]21          	add	word [cs:DevBrkAddr],DPBSIZ ; 33
 32177                                  				; 08/09/2023
 32178                                  				; (61 in PCDOS 7.1 IBMBIO.COM)
 32179 000024C0 E89C0C                  	call	RoundBreakAddr
 32180                                  
 32181 000024C3 26C74619FFFF            	mov	word [es:bp+DPB.NEXT_DPB],-1
 32182 000024C9 26C64618FF              	mov	byte [es:bp+DPB.FIRST_ACCESS],-1
 32183                                  
 32184 000024CE 8B37                    	mov	si,[bx] 		;ds:si points to bpb
 32185 000024D0 43                      	inc	bx
 32186 000024D1 43                      	inc	bx			;point to next guy
 32187                                  	;mov	[es:bp+DPB.DRIVE],dx
 32188                                  	; 11/12/2022
 32189 000024D2 26895600                	mov	[es:bp],dx ; 13/05/2019
 32190                                  	; 29/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32191                                  	;mov	[es:bp+0],dx		; [es:bp+DPB.DRIVE]
 32192                                  
 32193 000024D6 B453                    	mov	ah,SETDPB ; 53h		;hidden system call
 32194 000024D8 CD21                    	int	21h
 32195                                  			; DOS - 2+ internal - TRANSLATE BIOS PARAMETER BLOCK
 32196                                  			; DS:SI -> BPB (BIOS Parameter Block)
 32197                                  			; ES:BP -> buffer for DOS Drive Parameter Block
 32198                                  
 32199                                  	;mov	ax,[es:bp+2]
 32200 000024DA 268B4602                	mov	ax,[es:bp+DPB.SECTOR_SIZE]
 32201 000024DE 06                      	push	es
 32202 000024DF 2EC43E[6D02]            	les	di,[cs:DOSINFO] 	;es:di point to dos info
 32203                                  	;cmp	ax,[es:di+10h]
 32204 000024E4 263B4510                	cmp	ax,[es:di+SYSI_MAXSEC]
 32205 000024E8 07                      	pop	es
 32206                                  	;jna	short iblk_1
 32207                                  	;jmp	short bad_bpb_size_sector
 32208                                  	; 29/10/2022
 32209 000024E9 775D                    	ja	short bad_bpb_size_sector
 32210                                  iblk_1:
 32211 000024EB 1E                      	push	ds
 32212 000024EC 52                      	push	dx
 32213                                  
 32214 000024ED 2EC516[5E1F]            	lds	dx,[cs:DevEntry]
 32215                                  	;mov	[es:bp+13h],dx
 32216 000024F2 26895613                	mov	[es:bp+DPB.DRIVER_ADDR],dx
 32217                                  	;mov	[es:bp+15h],ds
 32218 000024F6 268C5E15                	mov	[es:bp+DPB.DRIVER_ADDR+2],ds
 32219                                  
 32220 000024FA 5A                      	pop	dx
 32221 000024FB 1F                      	pop	ds
 32222                                  
 32223 000024FC 42                      	inc	dx
 32224 000024FD FEC6                    	inc	dh
 32225 000024FF E28E                    	loop	perunit
 32226                                  
 32227 00002501 0E                      	push	cs
 32228 00002502 1F                      	pop	ds
 32229                                  
 32230 00002503 E851E7                  	call	TempCDS 		; set cds for new drives
 32231                                  	; 31/12/2022
 32232                                  	; ds <> cs
 32233                                  linkit:
 32234 00002506 2EC43E[6D02]            	les	di,[cs:DOSINFO] 	;es:di = dos table
 32235 0000250B 268B4D22                	mov	cx,[es:di+SYSI_DEV]	;dx:cx = head of list
 32236 0000250F 268B5524                	mov	dx,[es:di+SYSI_DEV+2]
 32237                                  
 32238 00002513 2EC536[5E1F]            	lds	si,[cs:DevEntry]	;ds:si = device location
 32239 00002518 26897522                	mov	[es:di+SYSI_DEV],si	;set head of list in dos
 32240 0000251C 268C5D24                	mov	[es:di+SYSI_DEV+2],ds
 32241 00002520 8B04                    	mov	ax,[si]			;get pointer to next device
 32242 00002522 2EA3[5E1F]              	mov	[cs:DevEntry],ax	;and save it
 32243                                  
 32244 00002526 890C                    	mov	[si],cx			;link in the driver
 32245 00002528 895402                  	mov	[si+2],dx
 32246                                  enddev:
 32247 0000252B 5E                      	pop	si
 32248 0000252C 07                      	pop	es
 32249 0000252D 40                      	inc	ax			;ax = ffff (no more devs if yes)?
 32250 0000252E 740B                    	jz	short coffj3
 32251                                  
 32252 00002530 2EFE06[B514]            	inc	byte [cs:multdeviceflag] ; possibly multiple device driver.
 32253 00002535 E86A0C                  	call	DevBreak		; M009
 32254                                  	; 11/12/2022
 32255                                  	; ds = cs (DevBreak)
 32256                                  
 32257                                  	; 03/04/2019 - Retro DOS v4.0
 32258                                  	; MSDOS 6.21 IO.SYS - SYSINIT:290Dh
 32259 00002538 E917FE                  	jmp	goodld			; otherwise pretend we loaded it in
 32260                                  coffj3: 
 32261                                  	; 18/12/2022
 32262                                  	; ax = 0
 32263 0000253B 2EA2[B514]              	mov	[cs:multdeviceflag],al ; 0
 32264                                  	;mov	byte [cs:multdeviceflag],0 ; reset the flag
 32265 0000253F E8600C                  	call	DevBreak
 32266                                  	; 11/12/2022
 32267                                  	; ds = cs (DevBreak)
 32268                                  	
 32269                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32270                                  	; (SYSINIT:2919h)
 32271                                  	; 11/07/2023
 32272 00002542 E88203                  	call	CheckProtmanArena
 32273                                  	
 32274                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS compatibility)
 32275                                  	;;call	CheckProtmanArena	; adjust alloclim if Protman$ just
 32276                                  ;					;  created a bogus arena to try
 32277                                  ;					;  to protect some of its resident-
 32278                                  ;					;  init code.
 32279                                  	;call	CheckDoubleSpace
 32280 00002545 E962FB                  	jmp	coff
 32281                                  
 32282                                  ;----------------------------------------------------------------------------
 32283                                  
 32284                                  ;CheckDoubleSpace:
 32285                                  ;;;;	ifdef	dblspace_hooks
 32286                                  ;
 32287                                  ;;	Now check for two special MagicDrv cases:
 32288                                  ;;
 32289                                  ;;       a) the last driver load was MagicDrv final placement:
 32290                                  ;;	   -> add number of MagicDrv reserved drives to drivenumber
 32291                                  ;;
 32292                                  ;;       b) MagicDrv is currently in temporary home:
 32293                                  ;;          -> call it to give it a chance to mount and shuffle drives
 32294                                  ;
 32295                                  ;	cmp	byte [cs:MagicHomeFlag],0 ; already home?
 32296                                  ;	jnz	short no_more_magic_calls ;  nothing more to do if so
 32297                                  ;
 32298                                  ;;	Now inquire of driver whether it is present, and final located
 32299                                  ;
 32300                                  ;	mov	ax,multMagicdrv ; 4A11h
 32301                                  ;	mov	bx,MD_VERSION ; 0
 32302                                  ;	int	2fh			; ch = number of MagicDrv drive letters
 32303                                  ;	or	ax,ax			; is it there?
 32304                                  ;	jnz	short no_more_magic_calls ; done if not
 32305                                  ;
 32306                                  ;	test	dx,8000h		; is it final placed?
 32307                                  ;	jnz	short magic_not_yet_home ;  skip if not
 32308                                  ;
 32309                                  ;;	Okay, now the driver is final placed!  Set the flag so we
 32310                                  ;;	don't keep checking it, and add its number of drive letters
 32311                                  ;;	to drivenumber.
 32312                                  ;
 32313                                  ;	mov	byte [cs:MagicHomeFlag],0ffh ; set the flag!
 32314                                  ;	add	[cs:drivenumber],ch	; add number of MagicDrv volumes to
 32315                                  ;;					;  the drive number we'll pass to the
 32316                                  ;;					;  next loadable block device.
 32317                                  ;
 32318                                  ;	jmp	short no_more_magic_calls ; and finished.
 32319                                  ;
 32320                                  ;magic_not_yet_home:
 32321                                  ;	push	es
 32322                                  ;	push	si
 32323                                  ;
 32324                                  ;	mov	cx,[cs:memhi]		; pass it a work buffer
 32325                                  ;	mov	dx,[cs:ALLOCLIM]	;   address in cx (segment)
 32326                                  ;	sub	dx,cx			;   for len dx (paragraphs)
 32327                                  ;
 32328                                  ;	mov	bx,2
 32329                                  ;	mov	al,[cs:driver_units]	; shuffle magicdrives and new drives
 32330                                  ;;					;   by this many units
 32331                                  ;
 32332                                  ;;BUGBUG 29-Oct-1992 bens Take this 55h out after Beta 4
 32333                                  ;	mov	ah,55h			; backdoor won't shuffle unless it
 32334                                  ;;					;  sees this, to prevent bad things
 32335                                  ;;					;  from happening if people run the
 32336                                  ;;					;  new driver with an old (dos) BIOS
 32337                                  ;	call	far [cs:MagicBackdoor]
 32338                                  ;
 32339                                  ;	pop	si
 32340                                  ;	pop	es
 32341                                  ;
 32342                                  ;no_more_magic_calls:
 32343                                  ;
 32344                                  ;;;;	endif
 32345                                  ;	retn
 32346                                  
 32347                                  ; 03/04/2019 - Retro DOS v4.0
 32348                                  
 32349                                  bad_bpb_size_sector:
 32350 00002548 5E                      	pop	si
 32351 00002549 07                      	pop	es
 32352 0000254A BA[3A4A]                	mov	dx,badsiz_pre
 32353 0000254D BB[184A]                	mov	bx,crlfm
 32354 00002550 E8571F                  	call	prnerr
 32355                                  
 32356 00002553 E954FB                  	jmp	coff
 32357                                  
 32358                                  ;------------------------------------------------------------------------------
 32359                                  ; country command
 32360                                  ;      the syntax is:
 32361                                  ;	country=country id {,codepage {,path}}
 32362                                  ;	country=country id {,,path}	:default codepage id in dos
 32363                                  ;------------------------------------------------------------------------------
 32364                                  
 32365                                  	; 30/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 32366                                  	; (SYSINIT:2663h)
 32367                                  tryq:
 32368 00002556 80FC51                          cmp     ah,CONFIG_COUNTRY ; 'Q'
 32369 00002559 7403                    	je	short tryq_cont
 32370                                  skip_it3:
 32371 0000255B E90D01                  	jmp	tryf
 32372                                  tryq_cont:
 32373                                  
 32374                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32375                                  ; (SYSINIT:297Eh)
 32376                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32377                                  ;%if 0
 32378                                  ;ifdef	MULTI_CONFIG
 32379 0000255E E8331B                  	call	query_user		; query the user if config_cmd
 32380 00002561 72F8                    	jc	short skip_it3		; has the CONFIG_OPTION_QUERY bit set
 32381                                  ;endif
 32382                                  ;%endif ; 02/11/2022
 32383                                  
 32384                                  	; 31/12/2022
 32385                                  	;xor	bx,bx
 32386 00002563 31C9                    	xor	cx,cx
 32387                                  	; 14/12/2022
 32388                                  	; ds = cs
 32389                                  	; bx = 0
 32390                                  	;mov	byte [cs:cntry_drv],0	; reset the drive,path to default value.
 32391                                  	;mov	word [cs:p_code_page],0
 32392                                  	; 31/12/2022
 32393                                  	; cx = 0
 32394                                  	;mov	[cntry_drv],bl ; 0
 32395                                  	;mov	[p_code_page],bx ; 0
 32396 00002565 880E[5645]              	mov	[cntry_drv],cl ; 0
 32397 00002569 890E[CF1D]              	mov	[p_code_page],cx ; 0	
 32398                                  
 32399 0000256D BF[981D]                	mov	di,cntry_parms
 32400                                  	;xor	cx,cx	; 31/12/2022
 32401                                  	; 03/01/2023
 32402                                  	;mov	dx,cx
 32403                                  do52:
 32404 00002570 E86C03                  	call	sysinit_parse
 32405 00002573 730B                    	jnc	short if52		; parse error,check error code and
 32406                                  
 32407 00002575 E8E000                  	call	cntry_error		; show message and end the search loop.
 32408                                  	; 14/12/2022
 32409                                  	; ds = cs
 32410 00002578 C706[CD1D]FFFF          	mov	word [p_cntry_code],-1
 32411                                  	;mov	word [cs:p_cntry_code],-1 ; signals that parse error.
 32412 0000257E EB34                    	jmp	short sr52
 32413                                  if52:
 32414 00002580 83F8FF                  	cmp	ax,_$P_RC_EOL ; 0FFFFh	; end of line?
 32415 00002583 742F                    	jz	short sr52		; then end the search loop
 32416                                  
 32417                                  	;cmp	byte [cs:result_val+_$P_Result_Blk.Type],_$P_number ; numeric?
 32418                                  	; 14/12/2022
 32419                                  	; ds = cs
 32420 00002585 803E[6A1D]01            	cmp	byte [result_val],_$P_Number	
 32421                                  	;cmp	byte [cs:result_val],_$P_Number
 32422 0000258A 7512                    	jnz	short if56
 32423                                  
 32424                                  	;;mov	ax,[cs:rw_dword]
 32425                                  	;mov	ax,[cs:result_val+_$P_Result_Blk.Picked_Val]
 32426                                  	; 14/12/2022
 32427 0000258C A1[6E1D]                	mov	ax,[result_val+_$P_Result_Blk.Picked_Val]
 32428 0000258F 83F901                  	cmp	cx,1
 32429 00002592 7505                    	jne	short if57
 32430                                  
 32431                                  	;mov	[cs:p_cntry_code],ax
 32432                                  	; 14/12/2022
 32433 00002594 A3[CD1D]                	mov	[p_cntry_code],ax
 32434                                  
 32435                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32436                                  	;jmp	short en57
 32437                                  	; 12/12/2022
 32438                                  	;jmp	short en56
 32439 00002597 EBD7                    	jmp	short do52
 32440                                  if57:
 32441                                  	;mov	[cs:p_code_page],ax
 32442                                  	; 14/12/2022
 32443                                  	; ds = cs
 32444 00002599 A3[CF1D]                	mov	[p_code_page],ax
 32445                                  en57:
 32446                                  	;jmp	short en56		; path entered
 32447                                  	; 12/12/2022
 32448 0000259C EBD2                    	jmp	short do52
 32449                                  if56:
 32450 0000259E 1E                      	push	ds
 32451 0000259F 06                      	push	es
 32452 000025A0 56                      	push	si
 32453 000025A1 57                      	push	di
 32454                                  
 32455 000025A2 0E                      	push	cs
 32456 000025A3 07                      	pop	es
 32457                                  
 32458                                  	;lds	si,[cs:rv_dword]	; move the path to known place.
 32459                                  	; 14/12/2022
 32460 000025A4 C536[6E1D]              	lds	si,[rv_dword]
 32461 000025A8 BF[5645]                	mov	di,cntry_drv
 32462 000025AB E8EB1E                  	call	move_asciiz
 32463                                  
 32464 000025AE 5F                      	pop	di
 32465 000025AF 5E                      	pop	si
 32466 000025B0 07                      	pop	es
 32467 000025B1 1F                      	pop	ds
 32468                                  en56:
 32469 000025B2 EBBC                    	jmp	short do52
 32470                                  sr52:
 32471                                  	; 14/12/2022
 32472                                  	; ds = cs
 32473 000025B4 833E[CD1D]FF            	cmp	word [p_cntry_code],-1
 32474                                  	;cmp	word [cs:p_cntry_code],-1	; had a parse error?
 32475 000025B9 7509                    	jne	short tryq_open
 32476 000025BB E9ECFA                  	jmp	coff
 32477                                  
 32478                                  tryqbad:				;"invalid country code or code page"
 32479 000025BE F9                      	stc
 32480 000025BF BA[814A]                	mov     dx,badcountry
 32481 000025C2 EB79                    	jmp     tryqchkerr
 32482                                  
 32483                                  tryq_open:
 32484                                  	; 14/12/2022
 32485                                  	; ds = cs
 32486 000025C4 803E[5645]00            	cmp	byte [cntry_drv],0
 32487                                  	;cmp	byte [cs:cntry_drv],0
 32488 000025C9 7405                    	je	short tryq_def
 32489 000025CB BA[5645]                	mov	dx,cntry_drv
 32490 000025CE EB03                    	jmp	short tryq_openit
 32491                                  
 32492                                  tryq_def:
 32493 000025D0 BA[5845]                	mov	dx,cntry_root
 32494                                  tryq_openit:
 32495 000025D3 B8003D                  	mov	ax,3D00h		;open a file
 32496 000025D6 F9                      	stc
 32497 000025D7 CD21                    	int	21h
 32498 000025D9 7242                    	jc	short tryqfilebad	;open failure
 32499                                  
 32500                                  	; 14/12/2022
 32501                                  	; ds = cs
 32502 000025DB A3[5C03]                	mov	[cntryfilehandle],ax
 32503                                  	;mov	[cs:cntryfilehandle],ax	;save file handle
 32504 000025DE 89C3                    	mov	bx,ax
 32505 000025E0 A1[CD1D]                	mov	ax,[p_cntry_code]
 32506 000025E3 8B16[CF1D]              	mov	dx,[p_code_page]
 32507                                  	;mov	ax,[cs:p_cntry_code]
 32508                                  	;mov	dx,[cs:p_code_page]	;now,ax=country id,bx=filehandle
 32509                                  	;mov	cx,[cs:memhi]
 32510 000025E7 8B0E[6403]              	mov	cx,[memhi]
 32511 000025EB 81C18001                	add	cx,384			;need 6k buffer to handle country.sys
 32512                                  					;M023
 32513                                  	; 14/12/2022
 32514                                  	; ds = cs
 32515 000025EF 3B0E[A502]              	cmp	cx,[ALLOCLIM]
 32516                                  	;cmp	cx,[cs:ALLOCLIM]
 32517 000025F3 7745                    	ja	short tryqmemory	;cannot allocate the buffer for country.sys
 32518                                  
 32519 000025F5 BE[5645]                	mov	si,cntry_drv		;ds:si -> cntry_drv
 32520 000025F8 803C00                  	cmp	byte [si],0 		;default path?
 32521 000025FB 7502                    	jne	short tryq_set_for_dos
 32522                                  
 32523 000025FD 46                      	inc	si
 32524 000025FE 46                      	inc	si			;ds:si -> cntry_root
 32525                                  
 32526                                  tryq_set_for_dos:
 32527                                  	; 14/12/2022
 32528                                  	; ds = cs
 32529 000025FF C43E[7902]              	les	di,[sysi_country]
 32530                                  	;les	di,[cs:sysi_country]	;es:di -> country info tab in dos
 32531 00002603 57                      	push	di			;save di
 32532                                  	;add	di,8
 32533 00002604 83C708                  	add	di,country_cdpg_info.ccPath_CountrySys ; 8
 32534 00002607 E88F1E                  	call	move_asciiz		;set the path to country.sys in dos.
 32535 0000260A 5F                      	pop	di			;es:di -> country info tab again.
 32536                                  
 32537                                  	; 14/12/2022	
 32538 0000260B 8B0E[6403]              	mov	cx,[memhi]
 32539                                  	;mov	cx,[cs:memhi]
 32540 0000260F 8ED9                    	mov	ds,cx
 32541 00002611 31F6                    	xor	si,si			;ds:si -> 2k buffer to be used.
 32542 00002613 E81F1D                  	call	setdoscountryinfo	;now do the job!!!
 32543                                  	; ds <> cs ; 14/12/2022
 32544 00002616 7325                    	jnc	short tryqchkerr	;read error or could not find country,code page combination
 32545                                  
 32546 00002618 83F9FF                  	cmp	cx,-1			;could not find matching country_id,code page?
 32547 0000261B 74A1                    	je	short tryqbad 		;then "invalid country code or code page"
 32548                                  
 32549                                  tryqfilebad:
 32550 0000261D 0E                      	push	cs
 32551 0000261E 07                      	pop	es
 32552 0000261F 2E803E[5645]00          	cmp	byte [cs:cntry_drv],0	;is the default file used?
 32553 00002625 7405                    	je	short tryqdefbad
 32554                                  
 32555 00002627 BE[5645]                	mov	si,cntry_drv
 32556 0000262A EB03                    	jmp	short tryqbadload
 32557                                  
 32558                                  tryqdefbad:				;default file has been used.
 32559 0000262C BE[5845]                	mov	si,cntry_root		;es:si -> \country.sys in sysinit_seg
 32560                                  tryqbadload:
 32561 0000262F E8721E                  	call	badload 		;ds will be restored to sysinit_seg
 32562                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32563                                  	; (SYSINIT:2A69h)
 32564 00002632 8B0E[A302]              	mov	cx,[CONFBOT] ; ds = cs (from badload)
 32565                                  	;mov	cx,[cs:CONFBOT]
 32566                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32567                                  	;mov	cx,[cs:top_of_cdss]
 32568                                  	; 11/12/2022
 32569                                  	; ds = cs
 32570                                  	;mov	cx,[top_of_cdss]  ; mov cx,[CONFBOT]	
 32571 00002636 8EC1                    	mov	es,cx			;restore es -> confbot.
 32572 00002638 EB13                    	jmp	short coffj4
 32573                                  
 32574                                  tryqmemory:
 32575 0000263A BA[C44A]                	mov	dx,insufmemory
 32576                                  tryqchkerr:
 32577                                  	;mov	cx,[cs:CONFBOT]
 32578                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32579                                  	;mov	cx,[cs:top_of_cdss]
 32580                                  	; 12/12/2022
 32581 0000263D 0E                      	push	cs
 32582 0000263E 1F                      	pop	ds
 32583                                  	; 31/12/2022 - Retro DOS v4.2
 32584 0000263F 8B0E[A302]              	mov	cx,[CONFBOT] ; (MSDOS 6.21 IO.SYS, SYSINIT)
 32585                                  	;mov	cx,[top_of_cdss]  ; mov cx,[CONFBOT]
 32586 00002643 8EC1                    	mov	es,cx			;restore es -> confbot seg
 32587                                  	;push	cs
 32588                                  	;pop	ds			;restore ds to sysinit_seg
 32589 00002645 7306                    	jnc	short coffj4		;if no error,then exit
 32590                                  
 32591 00002647 E8821E                  	call	print			;else show error message
 32592 0000264A E8E502                  	call	error_line
 32593                                  coffj4:
 32594                                  	;mov	bx,[cs:cntryfilehandle]
 32595                                  	; 11/12/2022
 32596                                  	; ds = cs
 32597 0000264D 8B1E[5C03]              	mov	bx,[cntryfilehandle]
 32598 00002651 B43E                    	mov	ah,3Eh
 32599 00002653 CD21                    	int	21h			;close file. don't care even if it fails.
 32600 00002655 E952FA                  	jmp	coff
 32601                                  
 32602                                  ;--------------------------------------------
 32603                                  
 32604                                  cntry_error:
 32605                                  
 32606                                  ;function: show "invalid country code or code page" messages,or
 32607                                  ;		"error in country command" depending on the error code
 32608                                  ;		in ax returned by sysparse;
 32609                                  ;in:	ax - error code
 32610                                  ;	ds - sysinitseg
 32611                                  ;	es - confbot
 32612                                  ;out:	show message.  dx destroyed.
 32613                                  
 32614 00002658 83F806                  	cmp	ax,_$P_Out_Of_Range ; 6
 32615 0000265B 7505                    	jne	short if64
 32616 0000265D BA[814A]                	mov	dx,badcountry		;"invalid country code or code page"
 32617 00002660 EB03                    	jmp	short en64
 32618                                  if64:
 32619 00002662 BA[A74A]                	mov	dx,badcountrycom	;"error in contry command"
 32620                                  en64:
 32621 00002665 E8641E                  	call	print
 32622                                  	;call	error_line
 32623                                  	;retn
 32624                                  	; 11/12/2022
 32625 00002668 E9C702                  	jmp	error_line
 32626                                  
 32627                                  ;------------------------------------------------------------------------------
 32628                                  ; files command
 32629                                  ;------------------------------------------------------------------------------
 32630                                  
 32631                                  ;******************************************************************************
 32632                                  ; function: parse the parameters of files= command.			      *
 32633                                  ;									      *
 32634                                  ; input :								      *
 32635                                  ;	es:si -> parameters in command line.				      *
 32636                                  ; output:								      *
 32637                                  ;	variable files set.						      *
 32638                                  ;									      *
 32639                                  ; subroutines to be called:						      *
 32640                                  ;	sysinit_parse							      *
 32641                                  ; logic:								      *
 32642                                  ; {									      *
 32643                                  ;	set di points to files_parms;					      *
 32644                                  ;	set dx,cx to 0; 						      *
 32645                                  ;	while (end of command line)					      *
 32646                                  ;	{ sysinit_parse;						      *
 32647                                  ;	  if (no error) then						      *
 32648                                  ;	     files = result_val._$P_picked_val				      *
 32649                                  ;	  else								      *
 32650                                  ;	     error exit;						      *
 32651                                  ;	};								      *
 32652                                  ; };									      *
 32653                                  ;									      *
 32654                                  ;******************************************************************************
 32655                                  
 32656                                  tryf:
 32657 0000266B 80FC46                          cmp     ah,CONFIG_FILES ;  'F'
 32658 0000266E 7528                    	jne	short tryl
 32659                                  
 32660                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32661                                  ; (SYSINIT:2AABh)
 32662                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32663                                  ;%if 0
 32664                                  ;ifdef	MULTI_CONFIG
 32665 00002670 E8211A                  	call	query_user              ; query the user if config_cmd
 32666 00002673 7223                    	jc	short tryl		; has the CONFIG_OPTION_QUERY bit set
 32667                                  ;endif
 32668                                  ;%endif ; 30/10/2022
 32669                                  
 32670                                  	; 14/12/2022
 32671                                  	; ds = cs
 32672                                  
 32673 00002675 BF[D11D]                	mov	di,files_parms
 32674 00002678 31C9                    	xor	cx,cx
 32675                                  	; 03/01/2023
 32676                                  	;mov	dx,cx
 32677                                  do67:
 32678 0000267A E86202                  	call	sysinit_parse
 32679 0000267D 7303                    	jnc	short if67		; parse error
 32680                                  	;call	badparm_p		;  and show messages and end the search loop.
 32681                                  	;jmp	short sr67
 32682                                  	; 03/01/2023
 32683 0000267F E98C01                  	jmp	badparm_p_coff
 32684                                  if67:
 32685 00002682 83F8FF                  	cmp	ax,_$P_RC_EOL		; end of line?
 32686 00002685 7408                    	je	short en67		; then end the $endloop
 32687                                  
 32688                                  	; 14/12/2022
 32689                                  	; ds = cs
 32690                                  	;;mov	al,[cs:rv_dword]
 32691                                  	;mov	al,[cs:result_val+_$P_Result_Blk.Picked_Val]
 32692                                  	;mov	[cs:p_files],al		; save it temporarily
 32693                                  	;mov	al,[rv_dword]
 32694 00002687 A0[6E1D]                	mov	al,[result_val+_$P_Result_Blk.Picked_Val]
 32695 0000268A A2[F01D]                	mov	[p_files],al
 32696                                  
 32697 0000268D EBEB                    	jmp	short do67
 32698                                  en67:
 32699                                  	; 14/12/2022
 32700                                  	; ds = cs
 32701 0000268F A0[F01D]                	mov	al,[p_files]
 32702 00002692 A2[9F02]                	mov	[FILES],al	
 32703                                  	;mov	al,[cs:p_files]
 32704                                  	;mov	[cs:FILES],al		; no error. really set the value now.
 32705                                  sr67:
 32706 00002695 E912FA                  	jmp	coff
 32707                                  
 32708                                  ; 04/04/2019 - Retro DOS v4.0
 32709                                  
 32710                                  ;------------------------------------------------------------------------------
 32711                                  ; lastdrive command
 32712                                  ;------------------------------------------------------------------------------
 32713                                  
 32714                                  ;******************************************************************************
 32715                                  ; function: parse the parameters of lastdrive= command. 		      *
 32716                                  ;									      *
 32717                                  ; input :								      *
 32718                                  ;	es:si -> parameters in command line.				      *
 32719                                  ; output:								      *
 32720                                  ;	set the variable num_cds.					      *
 32721                                  ;									      *
 32722                                  ; subroutines to be called:						      *
 32723                                  ;	sysinit_parse							      *
 32724                                  ; logic:								      *
 32725                                  ; {									      *
 32726                                  ;	set di points to ldrv_parms;					      *
 32727                                  ;	set dx,cx to 0; 						      *
 32728                                  ;	while (end of command line)					      *
 32729                                  ;	{ sysinit_parse;						      *
 32730                                  ;	  if (no error) then						      *
 32731                                  ;	     set num_cds to the returned value; 			      *
 32732                                  ;	  else	/*error exit*/						      *
 32733                                  ;	     error exit;						      *
 32734                                  ;	};								      *
 32735                                  ; };									      *
 32736                                  ;									      *
 32737                                  ;******************************************************************************
 32738                                  
 32739                                  tryl:
 32740 00002698 80FC4C                          cmp     ah,CONFIG_LASTDRIVE ; 'L'
 32741 0000269B 7528                    	jne	short tryp
 32742                                  
 32743                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32744                                  ; (SYSINIT:2AE0h)
 32745                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32746                                  ;%if 0
 32747 0000269D E8F419                  	call	query_user      ; query the user if config_cmd
 32748 000026A0 7223                    	jc	short tryp	; has the CONFIG_OPTION_QUERY bit set
 32749                                  ;endif
 32750                                  ;%endif ; 30/10/2022
 32751                                  
 32752                                  	; 14/12/2022
 32753                                  	; ds = cs
 32754                                  
 32755 000026A2 BF[281E]                	mov	di,ldrv_parms
 32756 000026A5 31C9                    	xor	cx,cx
 32757                                  	; 03/01/2023
 32758                                  	;mov	dx,cx
 32759                                  do73:
 32760 000026A7 E83502                  	call	sysinit_parse
 32761 000026AA 7303                    	jnc	short if73	; parse error
 32762                                  	;call	badparm_p	;  and show messages and end the search loop.
 32763                                  	;jmp	short sr73
 32764                                  	; 03/01/2023
 32765 000026AC E95F01                  	jmp	badparm_p_coff
 32766                                  if73:
 32767 000026AF 83F8FF                  	cmp	ax,_$P_RC_EOL	; end of line?
 32768 000026B2 7408                    	je	short en73	; then end the $endloop
 32769                                  
 32770                                  	; 14/12/2022
 32771                                  	; ds = cs
 32772                                  	;;mov	al,[cs:rv_dword]
 32773                                  	;mov	al,[cs:rv_byte]	; pick up the drive number
 32774                                  	;mov	[cs:p_ldrv],al	; save it temporarily
 32775                                  
 32776                                  	;mov	al,[rv_dword]
 32777 000026B4 A0[6E1D]                	mov	al,[rv_byte]
 32778 000026B7 A2[3C1E]                	mov	[p_ldrv],al
 32779                                  
 32780 000026BA EBEB                    	jmp	short do73
 32781                                  en73:
 32782                                  	; 14/12/2022
 32783                                  	; ds = cs
 32784 000026BC A0[3C1E]                	mov	al,[p_ldrv]
 32785 000026BF A2[A202]                	mov	[NUM_CDS],al
 32786                                  	;mov	al,[cs:p_ldrv]
 32787                                  	;mov	[cs:NUM_CDS],al	; no error. really set the value now.
 32788                                  sr73:
 32789 000026C2 E9E5F9                  	jmp	coff
 32790                                  
 32791                                  ;--------------------------------------------------------------------------
 32792                                  ; setting drive parameters
 32793                                  ;--------------------------------------------------------------------------
 32794                                  
 32795                                  tryp:
 32796 000026C5 80FC50                          cmp     ah,CONFIG_DRIVPARM ; 'P'
 32797 000026C8 7516                    	jne	short tryk
 32798                                  
 32799                                  ; 31/12/2022 - Retro DOS v4.2
 32800                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32801                                  ;%if 0
 32802                                  ;ifdef	MULTI_CONFIG
 32803 000026CA E8C719                  	call	query_user      ; query the user if config_cmd
 32804 000026CD 7211                    	jc	short tryk	; has the CONFIG_OPTION_QUERY bit set
 32805                                  ;endif
 32806                                  ;%endif ; 30/10/2022
 32807                                  
 32808 000026CF E8AB0E                  	call	parseline
 32809 000026D2 7209                    	jc	short trypbad
 32810 000026D4 E8C40D                  	call	setparms
 32811 000026D7 E8060E                  	call	diddleback
 32812                                  
 32813                                  ; No error check here, because setparms and diddleback have no error 
 32814                                  ; returns, and setparms as coded now can return with carry set. 
 32815                                  ;       jc	short trypbad
 32816                                  
 32817                                  	; 12/12/2022
 32818                                  	; cf = 0
 32819                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32820                                  	;jc	short trypbad
 32821                                  	
 32822 000026DA E9CDF9                  	jmp	coff
 32823                                  trypbad:
 32824 000026DD E91E02                  	jmp	badop
 32825                                  
 32826                                  ;--------------------------------------------------------------------------
 32827                                  ; setting internal stack parameters
 32828                                  ; stacks=m,n where
 32829                                  ;	m is the number of stacks (range 8 to 64,default 9)
 32830                                  ;	n is the stack size (range 32 to 512 bytes,default 128)
 32831                                  ; j.k. 5/5/86: stacks=0,0 implies no stack installation.
 32832                                  ;	any combinations that are not within the specified limits will
 32833                                  ;	result in "unrecognized command" error.
 32834                                  ;--------------------------------------------------------------------------
 32835                                  
 32836                                  ;**************************************************************************
 32837                                  ;									  *
 32838                                  ; function: parse the parameters of stacks= command.			  *
 32839                                  ;	    the minimum value for "number of stacks" and "stack size" is  *
 32840                                  ;	    8 and 32 each.  in the definition of sysparse value list,they *
 32841                                  ;	    are set to 0.  this is for accepting the exceptional case of  *
 32842                                  ;	    stacks=0,0 case (,which means do not install the stack.)	  *
 32843                                  ;	    so,after sysparse is done,we have to check if the entered	  *
 32844                                  ;	    values (stack_count,stack_size) are within the actual range,  *
 32845                                  ;	    (or if "0,0" pair has been entered.)			  *
 32846                                  ; input :								  *
 32847                                  ;	es:si -> parameters in command line.				  *
 32848                                  ; output:								  *
 32849                                  ;	set the variables stack_count,stack_size.			  *
 32850                                  ;									  *
 32851                                  ; subroutines to be called:						  *
 32852                                  ;	sysinit_parse							  *
 32853                                  ; logic:								  *
 32854                                  ; {									  *
 32855                                  ;	set di points to stks_parms;					  *
 32856                                  ;	set dx,cx to 0; 						  *
 32857                                  ;	while (end of command line)					  *
 32858                                  ;	{ sysinit_parse;						  *
 32859                                  ;	  if (no error) then						  *
 32860                                  ;	     { if (cx == 1) then /* first positional = stack count */	  *
 32861                                  ;		   p_stack_count = result_val._$P_picked_val;		  *
 32862                                  ;	       if (cx == 2) then /* second positional = stack size */	  *
 32863                                  ;		   p_stack_size = result_val._$P_picked_val;		  *
 32864                                  ;	     }								  *
 32865                                  ;	  else	/*error exit*/						  *
 32866                                  ;	     error exit;						  *
 32867                                  ;	};								  *
 32868                                  ;	here check p_stack_count,p_stack_size if it meets the condition;  *
 32869                                  ;	if o.k.,then set stack_count,stack_size;			  *
 32870                                  ;	 else error_exit;						  *
 32871                                  ; };									  *
 32872                                  ;**************************************************************************
 32873                                  
 32874                                  tryk:
 32875                                          ;if      stacksw
 32876                                  
 32877 000026E0 80FC4B                          cmp     ah,CONFIG_STACKS ; 'K'
 32878 000026E3 7402                    	je	short do_tryk
 32879                                  skip_it4:
 32880 000026E5 EB79                    	jmp	short trys	; 15/12/2022
 32881                                  do_tryk:
 32882                                  
 32883                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32884                                  ; (SYSINIT:2B33h)
 32885                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32886                                  ;%if 0
 32887                                  ;ifdef	MULTI_CONFIG
 32888 000026E7 E8AA19                         call	query_user              ; query the user if config_cmd
 32889 000026EA 72F9                           jc	short skip_it4		; has the CONFIG_OPTION_QUERY bit set
 32890                                  ;endif
 32891                                  ;%endif	; 30/10/2022
 32892                                  
 32893                                  	; 14/12/2022
 32894                                  	; ds = cs
 32895                                  
 32896 000026EC BF[3D1E]                	mov	di,stks_parms
 32897 000026EF 31C9                    	xor	cx,cx
 32898                                  	; 03/01/2023
 32899                                  	;mov	dx,cx
 32900                                  do79:
 32901 000026F1 E8EB01                  	call	sysinit_parse
 32902 000026F4 730B                    	jnc	short if79		; parse error
 32903                                  
 32904 000026F6 BA[334B]                	mov	dx,badstack		; "invalid stack parameter"
 32905 000026F9 E8D01D                  	call	print			;  and show messages and end the search loop.
 32906 000026FC E83302                  	call	error_line
 32907                                  	;jmp	sr79
 32908                                  	; 11/12/2022
 32909 000026FF EB39                    	jmp	short sr79
 32910                                  if79:
 32911 00002701 83F8FF                  	cmp	ax,_$P_RC_EOL		; end of line?
 32912 00002704 7412                    	je	short en79		; then end the $endloop
 32913                                  
 32914                                  	; 14/12/2022
 32915                                  	; ds = cs
 32916                                  
 32917                                  	;;mov	ax,[cs:rv_dword]
 32918                                  	;mov	ax,[cs:result_val+_$P_Result_Blk.Picked_Val]
 32919                                  	;mov	ax,[rv_dword]
 32920 00002706 A1[6E1D]                	mov	ax,[result_val+_$P_Result_Blk.Picked_Val]
 32921                                  
 32922 00002709 83F901                  	cmp	cx,1
 32923 0000270C 7505                    	jne	short if83
 32924                                  
 32925                                  	; 14/12/2022
 32926                                  	;mov	[cs:p_stack_count],ax
 32927                                  	;jmp	short en83
 32928 0000270E A3[721E]                	mov	[p_stack_count],ax
 32929 00002711 EBDE                    	jmp	short do79
 32930                                  if83:
 32931                                  	; 14/12/2022
 32932                                  	;mov	[cs:p_stack_size],ax
 32933 00002713 A3[741E]                	mov	[p_stack_size],ax
 32934                                  en83:
 32935 00002716 EBD9                    	jmp	short do79
 32936                                  en79:
 32937                                  	; 14/12/2022
 32938                                  	; ds = cs
 32939 00002718 A1[721E]                	mov	ax,[p_stack_count]
 32940 0000271B 09C0                    	or	ax,ax
 32941 0000271D 741E                    	jz	short if87		
 32942                                  
 32943                                  	; 14/12/2022
 32944                                  	;cmp	word [p_stack_count],0
 32945                                  	;;cmp	word [cs:p_stack_count],0
 32946                                  	;je	short if87
 32947                                  
 32948                                  	; 14/12/2022
 32949 0000271F 83F808                  	cmp	ax,mincount ; 8
 32950                                  	;cmp	word [cs:p_stack_count],mincount ; 8
 32951                                  	; 15/12/2022
 32952 00002722 721F                    	jb	short en87
 32953 00002724 833E[741E]20            	cmp	word [p_stack_size],minsize ; 32
 32954                                  	;cmp	word [cs:p_stack_size],minsize ; 32
 32955                                  	; 15/12/2022
 32956 00002729 7218                    	jb	short en87
 32957                                  if94:
 32958                                  	; 14/12/2022
 32959                                  	; ds = cs
 32960                                  	; ax = [p_stack_count]
 32961                                  	;mov	ax,[p_stack_count]
 32962                                  	;;mov	ax,[cs:p_stack_count]
 32963 0000272B A3[8C02]                	mov	[stack_count],ax
 32964                                  	;mov	[cs:stack_count],ax
 32965                                  	;mov	ax,[cs:p_stack_size]
 32966 0000272E A1[741E]                	mov	ax,[p_stack_size]
 32967                                  	;mov	[cs:stack_size],ax
 32968 00002731 A3[8E02]                	mov	[stack_size],ax
 32969                                  	;mov	word [cs:stack_addr],-1	; stacks= been accepted.
 32970 00002734 C706[9002]FFFF          	mov	word [stack_addr],-1
 32971                                  sr79:
 32972 0000273A E96DF9                  	jmp	coff
 32973                                  
 32974                                  if87:
 32975                                  	; 14/12/2022
 32976 0000273D 3906[741E]              	cmp	[p_stack_size],ax ; 0
 32977 00002741 74E8                    	je	short if94 ; ax = [p_stack_count] = 0
 32978                                  	;cmp	word [cs:p_stack_size],0
 32979                                  	;je	short if94
 32980                                  en87:
 32981                                  	; 15/12/2022
 32982                                  	; ([p_stack_count] is invalid, use default values)
 32983                                  	; 14/12/2022
 32984                                  	; ds = cs
 32985 00002743 C706[8C02]0900          	mov	word [stack_count],defaultcount ; 9
 32986 00002749 C706[8E02]8000          	mov	word [stack_size],defaultsize ; 128
 32987 0000274F C706[9002]0000          	mov	word [stack_addr],0
 32988                                  	;mov	word [cs:stack_count],defaultcount ; 9
 32989                                  	;				; reset to default value.
 32990                                  	;mov	word [cs:stack_size],defaultsize ; 128
 32991                                  	;mov	word [cs:stack_addr],0
 32992                                  
 32993 00002755 BA[334B]                	mov	dx,badstack
 32994 00002758 E8711D                  	call	print
 32995 0000275B E8D401                  	call	error_line
 32996 0000275E EBDA                    	jmp	short sr79
 32997                                  
 32998                                  ; 15/12/2022
 32999                                  %if 0
 33000                                  	mov	di,stks_parms
 33001                                  	xor	cx,cx
 33002                                  	; 03/01/2023
 33003                                  	;mov	dx,cx
 33004                                  do79:
 33005                                  	call	sysinit_parse
 33006                                  	jnc	short if79		; parse error
 33007                                  
 33008                                  	mov	dx,badstack		; "invalid stack parameter"
 33009                                  	call	print			;  and show messages and end the search loop.
 33010                                  	call	error_line
 33011                                  	;jmp	sr79
 33012                                  	; 11/12/2022
 33013                                  	jmp	short sr79
 33014                                  if79:
 33015                                  	cmp	ax,_$P_RC_EOL		; end of line?
 33016                                  	je	short en79		; then end the $endloop
 33017                                  
 33018                                  	;mov	ax,[cs:rv_dword]
 33019                                  	mov	ax,[cs:result_val+_$P_Result_Blk.Picked_Val]
 33020                                  	cmp	cx,1
 33021                                  	jne	short if83
 33022                                  
 33023                                  	mov	[cs:p_stack_count],ax
 33024                                  	jmp	short en83
 33025                                  if83:
 33026                                  	mov	[cs:p_stack_size],ax
 33027                                  en83:
 33028                                  	jmp	short do79
 33029                                  en79:
 33030                                  	cmp	word [cs:p_stack_count],0
 33031                                  	je	short if87
 33032                                  
 33033                                  	cmp	word [cs:p_stack_count],mincount ; 8
 33034                                  	jb	short ll88
 33035                                  	cmp	word [cs:p_stack_size],minsize ; 32
 33036                                  	jnb	short if88
 33037                                  ll88:
 33038                                  	mov	word [cs:p_stack_count],-1 ; invalid
 33039                                  if88:
 33040                                  	jmp	short en87
 33041                                  
 33042                                  	; 11/12/2022
 33043                                  if94:
 33044                                  	mov	ax,[cs:p_stack_count]
 33045                                  	mov	[cs:stack_count],ax
 33046                                  	mov	ax,[cs:p_stack_size]
 33047                                  	mov	[cs:stack_size],ax
 33048                                  	mov	word [cs:stack_addr],-1	; stacks= been accepted.
 33049                                  sr79:
 33050                                  	jmp	coff
 33051                                  
 33052                                  if87:
 33053                                  	cmp	word [cs:p_stack_size],0
 33054                                  	je	short en87
 33055                                  	mov	word [cs:p_stack_count],-1 ; invalid
 33056                                  en87:
 33057                                  	cmp	word [cs:p_stack_count],-1 ; invalid?
 33058                                  	jne	short if94
 33059                                  
 33060                                  	mov	word [cs:stack_count],defaultcount ; 9
 33061                                  					; reset to default value.
 33062                                  	mov	word [cs:stack_size],defaultsize ; 128
 33063                                  	mov	word [cs:stack_addr],0
 33064                                  
 33065                                  	mov	dx,badstack
 33066                                  	call	print
 33067                                  	call	error_line
 33068                                  	jmp	short sr79
 33069                                  
 33070                                  %endif
 33071                                  
 33072                                  ; 11/12/2022
 33073                                  %if 0 
 33074                                  if94:
 33075                                  	mov	ax,[cs:p_stack_count]
 33076                                  	mov	[cs:stack_count],ax
 33077                                  	mov	ax,[cs:p_stack_size]
 33078                                  	mov	[cs:stack_size],ax
 33079                                  	mov	word [cs:stack_addr],-1	; stacks= been accepted.
 33080                                  sr79:
 33081                                  	jmp	coff
 33082                                  %endif
 33083                                  	;endif
 33084                                  
 33085                                  ;------------------------------------------------------------------------
 33086                                  ; shell command
 33087                                  ;------------------------------------------------------------------------
 33088                                  
 33089                                  trys:
 33090 00002760 80FC53                          cmp     ah,CONFIG_SHELL ; 'S'
 33091 00002763 755A                    	jne	short tryx
 33092                                  
 33093                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 33094                                  ; (SYSINIT:2BE1h)
 33095                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33096                                  ;%if 0
 33097                                  ;ifdef	MULTI_CONFIG
 33098 00002765 E82C19                  	call	query_user              ; query the user if config_cmd
 33099 00002768 7255                    	jc	short tryx		; has the CONFIG_OPTION_QUERY bit set
 33100                                  	;mov	byte [cs:newcmd],1
 33101                                  	; 27/09/2023
 33102 0000276A C606[A345]01            	mov	byte [newcmd],1 ; (ds = cs)
 33103                                  ;endif
 33104                                  ;%endif ; 30/10/2022
 33105                                  
 33106                                  	;;mov	word [cs:command_line],0 ; zap length,first byte of command-line
 33107                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33108                                  	;mov	byte [cs:command_line+1],0
 33109                                  	; 15/12/2022
 33110                                  	; ds = cs
 33111                                  	; 08/09/2023
 33112                                  	;mov	byte [command_line+1],0
 33113 0000276F C706[3446]0000          	mov	word [command_line],0	; zap length,first byte of command-line
 33114                                  
 33115 00002775 BF[A745]                        mov     di,commnd+1		; we already have the first char
 33116 00002778 8845FF                          mov     [di-1],al               ; of the new shell in AL, save it now
 33117                                  storeshell:
 33118 0000277B E8A91A                  	call	getchr
 33119 0000277E 08C0                            or      al,al                   ; this is the normal case: "organize"
 33120 00002780 741C                            jz	short getshparms	; put a ZERO right after the filename
 33121                                  
 33122 00002782 3C20                            cmp     al," "                  ; this may happen if there are no args
 33123 00002784 7209                            jb	short endofshell	; I suppose...
 33124 00002786 8805                    	mov	[di],al
 33125 00002788 47                      	inc	di
 33126                                          ;cmp    di,commnd+63		; this makes sure we don't overflow
 33127                                          ;jb	short storeshell	; commnd (the filename)
 33128                                          ;jmp	short endofshell
 33129                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33130                                  	;jmp	short storeshell
 33131                                  	; 03/01/2023
 33132 00002789 81FF[E545]              	cmp	di,commnd+63		; this makes sure we don't overflow
 33133 0000278D 72EC                            jb	short storeshell	; commnd (the filename)
 33134                                  	;jmp	short endofshell
 33135                                  
 33136                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33137                                  ;getshparms:
 33138                                  ;	mov     byte [di],0		; zero-terminate the filename
 33139                                  ;	mov     di,command_line+1	; prepare to process the command-line
 33140                                  ;
 33141                                  ;parmloop:
 33142                                  ;	call	getchr
 33143                                  ;	cmp	al," "
 33144                                  ;	jb	short endofparms
 33145                                  ;	mov	[di],al
 33146                                  ;	inc	di
 33147                                  ;	cmp     di,command_line+126
 33148                                  ;	jb	short parmloop
 33149                                  ;endofparms:
 33150                                  ;	mov     cx,di
 33151                                  ;	sub     cx,command_line+1
 33152                                  ;	mov     [cs:command_line],cl
 33153                                  ;
 33154                                  ;endofshell:
 33155                                  ;	mov     byte [di],0		; zero-terminate the filename (or
 33156                                  ;					; the command-line as the case may be)
 33157                                  ;skipline:
 33158                                  ;       cmp     al,lf	; 0Ah		; the safest way to eat the rest of
 33159                                  ;       je	short endofline		; the line: watch for ever-present LF
 33160                                  ;call	getchr
 33161                                  ;       jnc	short skipline		; keep it up as long as there are chars
 33162                                  ;
 33163                                  ;endofline:
 33164                                  ;       jmp     conflp
 33165                                  
 33166                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33167                                  endofshell:
 33168 0000278F C60500                       	mov     byte [di],0		; zero-terminate the filename (or
 33169                                  					; the command-line as the case may be)
 33170                                  	; 11/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 33171                                  	; MSDOS 6.21 IO.SYS - SYSINIT:2C33h
 33172                                  	; PCDOS 7.1 IBMBIO.COM - SYSINIT:314Eh
 33173                                  	;call	getchr
 33174                                  skipline:		; MSDOS 6.21 IO.SYS - SYSINIT:2C33h
 33175 00002792 3C0A                    	cmp     al,lf	; 0Ah		; the safest way to eat the rest of
 33176 00002794 7405                    	je	short endofline		; the line: watch for ever-present LF
 33177 00002796 E88E1A                  	call	getchr
 33178                                  	; 03/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.1 IO.SYS)
 33179                                  	; (SYSINIT:2C3Ah)
 33180 00002799 73F7                    	jnb	short skipline
 33181                                  
 33182                                  endofline:
 33183 0000279B E9B5F8                  	jmp     conflp
 33184                                  
 33185                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33186                                  getshparms:
 33187                                  	; 18/12/2022
 33188                                  	; al = 0
 33189 0000279E 8805                    	mov	[di],al ; 0
 33190                                  	;mov	byte [di],0		; zero-terminate the filename
 33191 000027A0 BF[3546]                	mov     di,command_line+1	; prepare to process the command-line
 33192                                  parmloop:
 33193 000027A3 E8811A                  	call	getchr
 33194 000027A6 3C20                    	cmp	al," " ; 20h
 33195                                  	;jb	short endofshell
 33196                                  	; 03/01/2023
 33197 000027A8 7209                    	jb	short endofparms
 33198                                  
 33199 000027AA 8805                    	mov	[di],al
 33200 000027AC 47                      	inc	di
 33201                                  	;jmp	short parmloop
 33202                                  	; 03/01/2023 - Retro DOS v4.2
 33203 000027AD 81FF[B246]              	cmp     di,command_line+126
 33204 000027B1 72F0                    	jb	short parmloop
 33205                                  
 33206                                  	; 03/01/2023 - Retro DOS v4.2
 33207                                  endofparms:
 33208 000027B3 89F9                    	mov	cx,di
 33209 000027B5 81E9[3546]              	sub	cx,command_line+1
 33210                                  	;mov	[cs:command_line],cl
 33211                                  	; 03/01/2023
 33212 000027B9 880E[3446]              	mov	[command_line],cl
 33213 000027BD EBD0                    	jmp	short endofshell
 33214                                  
 33215                                  ;------------------------------------------------------------------------
 33216                                  ; fcbs command
 33217                                  ;------------------------------------------------------------------------
 33218                                  
 33219                                  ;************************************************************************
 33220                                  ; function: parse the parameters of fcbs= command.			*
 33221                                  ;									*
 33222                                  ; input :								*
 33223                                  ;	es:si -> parameters in command line.				*
 33224                                  ; output:								*
 33225                                  ;	set the variables fcbs,keep.					*
 33226                                  ;									*
 33227                                  ; subroutines to be called:						*
 33228                                  ;	sysinit_parse							*
 33229                                  ; logic:								*
 33230                                  ; {									*
 33231                                  ;	set di points to fcbs_parms;					*
 33232                                  ;	set dx,cx to 0; 						*
 33233                                  ;	while (end of command line)					*
 33234                                  ;	{ sysparse;							*
 33235                                  ;	  if (no error) then						*
 33236                                  ;	     { if (cx == 1) then /* first positional = fcbs */		*
 33237                                  ;		   fcbs = result_val._$P_picked_val;			*
 33238                                  ;	       if (cx == 2) then /* second positional = keep */ 	*
 33239                                  ;		   keep = result_val._$P_picked_val;			*
 33240                                  ;	     }								*
 33241                                  ;	  else	/*error exit*/						*
 33242                                  ;	     error exit;						*
 33243                                  ;	};								*
 33244                                  ; };									*
 33245                                  ;************************************************************************
 33246                                  
 33247                                  tryx:
 33248 000027BF 80FC58                          cmp     ah,CONFIG_FCBS  ; 'X'
 33249                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 33250 000027C2 7534                    	jne	short try1
 33251                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33252                                  	;jne	short tryy	; comment command
 33253                                  
 33254                                  ; 31/12/2022 - Retro DOS v4.2
 33255                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33256                                  ;%if 0
 33257                                  ;ifdef	MULTI_CONFIG
 33258 000027C4 E8CD18                  	call	query_user      ; query the user if config_cmd
 33259 000027C7 722F                    	jc	short try1	; has the CONFIG_OPTION_QUERY bit set
 33260                                  ;endif
 33261                                  ;%endif ; 30/10/2022
 33262                                  
 33263 000027C9 BF[F11D]                	mov	di,fcbs_parms
 33264 000027CC 31C9                    	xor	cx,cx
 33265                                  	; 03/01/2023
 33266                                  	;mov	dx,cx
 33267                                  do98:
 33268 000027CE E80E01                  	call	sysinit_parse
 33269                                          ; 03/01/2023
 33270                                  	;jnc	short if98	; parse error
 33271                                          ;call	badparm_p	;  and show messages and end the search loop.
 33272                                  	;jmp	short sr98
 33273                                  	;------------------------
 33274                                  	; 03/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 33275 000027D1 723B                    	jc	short badparm_p_coff
 33276                                  if98:
 33277 000027D3 83F8FF                  	cmp	ax,_$P_RC_EOL	; end of line?
 33278 000027D6 7412                    	je	short en98	; then end the $endloop
 33279                                  
 33280                                  	;;mov	al,[cs:rv_dword]
 33281                                  	;mov	al,[cs:result_val+_$P_Result_Blk.Picked_Val]
 33282                                  	; 15/12/2022
 33283                                  	; ds = cs
 33284 000027D8 A0[6E1D]                	mov	al,[result_val+_$P_Result_Blk.Picked_Val]
 33285 000027DB 83F901                  	cmp	cx,1		; the first positional?
 33286 000027DE 7505                    	jne	short if102
 33287                                  	;mov	[cs:p_fcbs],al
 33288                                  	; 15/12/2022
 33289 000027E0 A2[261E]                	mov	[p_fcbs],al
 33290                                  	;jmp	short en102
 33291 000027E3 EBE9                    	jmp	short do98
 33292                                  if102:
 33293                                  	;mov	[cs:p_keep],al
 33294                                  	; 15/12/2022
 33295 000027E5 A2[271E]                	mov	[p_keep],al
 33296                                  en102:
 33297 000027E8 EBE4                    	jmp	short do98
 33298                                  en98:
 33299                                  	; 15/12/2022
 33300                                  	; ds = cs
 33301 000027EA A0[261E]                	mov	al,[p_fcbs]
 33302 000027ED A2[A002]                	mov	[FCBS],al
 33303 000027F0 C606[A102]00            	mov	byte [KEEP],0
 33304                                  	;mov	al,[cs:p_fcbs]	 ; M017
 33305                                  	;mov	[cs:FCBS],al	 ; M017
 33306                                  	;mov	byte [cs:KEEP],0 ; M017
 33307                                  sr98:
 33308 000027F5 E9B2F8                  	jmp	coff
 33309                                  
 33310                                  ; 31/12/2022 - Retro DOS v4.2
 33311                                  %if 0
 33312                                  
 33313                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33314                                  ;-------------------------------------------------------------------------
 33315                                  ; comment= do nothing. just decrease chrptr,and increase count for correct
 33316                                  ;		line number
 33317                                  ;-------------------------------------------------------------------------
 33318                                  
 33319                                  tryy:
 33320                                  	cmp     ah,CONFIG_COMMENT ; 'Y'
 33321                                  	jne	short try0
 33322                                  
 33323                                  donothing:
 33324                                  	; 15/12/2022
 33325                                  	; ds = cs
 33326                                  	dec	word [chrptr]
 33327                                  	inc	word [count]
 33328                                  	; 02/11/2022
 33329                                  	;dec	word [cs:chrptr]
 33330                                  	;inc	word [cs:count]
 33331                                  
 33332                                  	jmp	coff
 33333                                  
 33334                                  ;------------------------------------------------------------------------
 33335                                  ; rem command
 33336                                  ;------------------------------------------------------------------------
 33337                                  
 33338                                  try0:				; do nothing with this line.
 33339                                  	cmp     ah,CONFIG_REM ; '0'
 33340                                  	je	short donothing
 33341                                  
 33342                                  %endif
 33343                                  
 33344                                  ; 07/04/2019 - Retro DOS v4.0
 33345                                  
 33346                                  ;-----------------------------------------------------------------------
 33347                                  ; switches command
 33348                                  ;-----------------------------------------------------------------------
 33349                                  
 33350                                  ;***********************************************************************
 33351                                  ;								       *
 33352                                  ; function: parse the option switches specified.		       *
 33353                                  ; note - this command is intended for the future use also.	       *
 33354                                  ; when we need to set system data flag,use this command.	       *
 33355                                  ;								       *
 33356                                  ; input :							       *
 33357                                  ;	es:si -> parameters in command line.			       *
 33358                                  ; output:							       *
 33359                                  ;	p_swit_k set if /k option chosen.			       *
 33360                                  ;								       *
 33361                                  ; subroutines to be called:					       *
 33362                                  ;	sysinit_parse						       *
 33363                                  ; logic:							       *
 33364                                  ; {								       *
 33365                                  ;	set di points to swit_parms;  /*parse control definition*/     *
 33366                                  ;	set dx,cx to 0; 					       *
 33367                                  ;	while (end of command line)				       *
 33368                                  ;	{ sysinit_parse;					       *
 33369                                  ;	  if (no error) then					       *
 33370                                  ;	       if (result_val._$P_synonym_ptr == swit_k) then	       *
 33371                                  ;		    p_swit_k = 1				       *
 33372                                  ;	       endif						       *
 33373                                  ;	  else {show error message;error exit}			       *
 33374                                  ;	};							       *
 33375                                  ; };								       *
 33376                                  ;								       *
 33377                                  ;***********************************************************************
 33378                                  
 33379                                  SUPPRESS_WINA20	EQU 00000010b	; M025 ; (DOSSYM.INC, MSDOS 6.0)
 33380                                  
 33381                                  try1:
 33382 000027F8 80FC31                          cmp     ah,CONFIG_SWITCHES ; '1'
 33383 000027FB 7402                    	je	short do_try1	; switches= command entered?
 33384                                  skip_it5:
 33385                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 33386                                  	; (SYSINIT:2C8Ah)
 33387 000027FD EB7F                    	jmp	tryv
 33388                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33389                                  	;jmp	tryz
 33390                                  
 33391                                  do_try1:
 33392                                  
 33393                                  ; 31/12/2022 - Retro DOS v4.2
 33394                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33395                                  ;%if 0
 33396                                  ;ifdef	MULTI_CONFIG
 33397 000027FF E89218                  	call	query_user      ; query the user if config_cmd
 33398 00002802 72F9                    	jc	short skip_it5	; has the CONFIG_OPTION_QUERY bit set
 33399                                  ;endif
 33400                                  ;%endif ; 30/10/2022
 33401                                  
 33402 00002804 BF[8B1E]                	mov	di,swit_parms
 33403 00002807 31C9                    	xor	cx,cx
 33404                                  	; 03/01/2023
 33405                                  	;mov	dx,cx
 33406                                  do110:
 33407 00002809 E8D300                  	call	sysinit_parse
 33408 0000280C 7306                    	jnc	short if110	; parse error
 33409                                  	;call	badparm_p	;  and show messages and end the search loop.
 33410                                  	;jmp	short sr110
 33411                                  	; -----------------------
 33412                                  	; 03/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 33413                                  badparm_p_coff:
 33414 0000280E E8F900                  	call	badparm_p
 33415 00002811 E996F8                  	jmp	coff
 33416                                  	;------------------------
 33417                                  if110:
 33418 00002814 83F8FF                  	cmp	ax,_$P_RC_EOL	; end of line?
 33419 00002817 742D                    	je	short en110	; then jmp to $endloop for semantic check
 33420                                  
 33421                                  	; 15/12/2022
 33422                                  	; ds = cs
 33423                                  	;;cmp	word [cs:result_val_swoff],swit_k
 33424                                  	;cmp	word [cs:result_val+_$P_Result_Blk.SYNONYM_Ptr],swit_k 
 33425 00002819 813E[6C1D][A71E]        	cmp	word [result_val+_$P_Result_Blk.SYNONYM_Ptr],swit_k 
 33426 0000281F 7507                    	jne	short if115	;				;M059
 33427                                  	; 15/12/2022
 33428 00002821 C606[DA1E]01            	mov	byte [p_swit_k],1
 33429                                  	;mov	byte [cs:p_swit_k],1	; set the flag
 33430 00002826 EBE1                    	jmp	short do110
 33431                                  if115:	
 33432                                  	; 15/12/2022						;M059
 33433                                  	;;cmp	word [cs:result_val_swoff],swit_t
 33434                                  	;cmp	word [cs:result_val+_$P_Result_Blk.SYNONYM_Ptr],swit_t	;M059
 33435 00002828 813E[6C1D][CB1E]        	cmp	word [result_val+_$P_Result_Blk.SYNONYM_Ptr],swit_t
 33436 0000282E 7507                    	jne	short if116					;M059 M063
 33437                                  	; 15/12/2022
 33438 00002830 C606[DB1E]01            	mov	byte [p_swit_t],1
 33439                                  	;mov	byte [cs:p_swit_t],1				;M059
 33440 00002835 EBD2                    	jmp	short do110					;M059
 33441                                  if116:
 33442                                  	; 15/12/2022
 33443                                  	;;cmp	word [cs:result_val_swoff],swit_w
 33444                                  	;cmp	word [cs:result_val+_$P_Result_Blk.SYNONYM_Ptr],swit_w	;M063
 33445 00002837 813E[6C1D][D71E]        	cmp	word [result_val+_$P_Result_Blk.SYNONYM_Ptr],swit_w
 33446 0000283D 75CA                    	jne	short do110					;M063
 33447                                  	; 15/12/2022
 33448 0000283F C606[DC1E]01            	mov	byte [p_swit_w],1
 33449                                  	;mov	byte [cs:p_swit_w],1				;M063
 33450 00002844 EBC3                    	jmp	short do110					;M063
 33451                                  en110:
 33452                                  	; 15/12/2022
 33453                                  	; ds = cs
 33454 00002846 803E[DA1E]01            	cmp	byte [p_swit_k],1
 33455                                  	;cmp	byte [cs:p_swit_k],1	; if /k entered,
 33456 0000284B 1E                      	push	ds
 33457                                  	;;mov	ax,Bios_Data
 33458                                  	;mov	ax,KERNEL_SEGMENT ; 0070h
 33459                                  	; 21/10/2022
 33460 0000284C B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 33461 0000284F 8ED8                    	mov	ds,ax
 33462 00002851 750A                    	jne	short if117
 33463 00002853 C606[7E04]00            	mov	byte [keyrd_func],0 ; 4E5h ; use the conventional keyboard functions
 33464 00002858 C606[7F04]01            	mov	byte [keysts_func],1 ; 4E6h (for MSDOS 6.21 IO.SYS)
 33465                                  if117:
 33466                                  	; 15/12/2022
 33467                                  	; ds <> cs
 33468 0000285D 2EA0[DB1E]              	mov	al,[cs:p_swit_t]				;M059
 33469 00002861 A2[8B04]                	mov	[t_switch],al	; 4F2h (for MSDOS 6.21 IO.SYS)	;M059
 33470                                  
 33471 00002864 2E803E[DC1E]00          	cmp	byte [cs:p_swit_w],0				;M063
 33472 0000286A 740E                    	je	short skip_dos_flag				;M063
 33473 0000286C 06                      	push	es
 33474 0000286D 53                      	push	bx
 33475 0000286E B452                    	mov	ah,GET_IN_VARS ; 52h				;M063
 33476 00002870 CD21                    	int	21h						;M063
 33477                                  			; DOS - 2+ internal - GET LIST OF LISTS
 33478                                  			; Return: ES:BX -> DOS list of lists
 33479                                  	;or	bytes [es:86h],2
 33480 00002872 26800E860002            	or	byte [es:DOS_FLAG_OFFSET],SUPPRESS_WINA20 ; 2	;M063
 33481 00002878 5B                      	pop	bx
 33482 00002879 07                      	pop	es
 33483                                  skip_dos_flag:							;M063
 33484 0000287A 1F                      	pop	ds
 33485                                  sr110:
 33486 0000287B E92CF8                  	jmp	coff
 33487                                  
 33488                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 33489                                  ; (SYSINIT:2D14h)
 33490                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33491                                  ;%if 0
 33492                                  
 33493                                  tryv:
 33494                                  
 33495                                  ;ifdef	MULTI_CONFIG
 33496                                  ;------------------------------------------------------------------------
 33497                                  ; set command (as in "set var=value<cr/lf>")
 33498                                  ;------------------------------------------------------------------------
 33499                                  
 33500 0000287E 80FC56                  	cmp	ah,CONFIG_SET  ; 'V'
 33501 00002881 750F                    	jne	short tryn
 33502 00002883 E80E18                  	call	query_user      ; query the user if config_cmd
 33503 00002886 720A                    	jc	short tryn 	; has the CONFIG_OPTION_QUERY bit set
 33504 00002888 E80514                  	call	copy_envvar     ; copy var at ES:SI to "config_wrkseg"
 33505 0000288B 73EE                    	jnc	short sr110	; no error
 33506                                  err:    
 33507 0000288D E8A200                  	call	error_line      ; whoops, display error in line XXX
 33508 00002890 EBE9                    	jmp	short sr110     ; jump to coff (to skip to next line)
 33509                                  
 33510                                  ;------------------------------------------------------------------------
 33511                                  ; numlock command (as in "numlock=on|off")
 33512                                  ;------------------------------------------------------------------------
 33513                                  tryn:
 33514 00002892 80FC4E                  	cmp	ah,CONFIG_NUMLOCK  ;'N'
 33515 00002895 750C                    	jne	short tryy      
 33516 00002897 E8FA17                  	call	query_user      ; query the user if config_cmd
 33517 0000289A 7207                    	jc	short tryy	; has the CONFIG_OPTION_QUERY bit set
 33518 0000289C E88610                  	call	set_numlock
 33519 0000289F 72EC                    	jc	short err
 33520 000028A1 EBD8                    	jmp	short sr110	; all done
 33521                                  
 33522                                  ;endif	;MULTI_CONFIG
 33523                                  
 33524                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33525                                  ;-------------------------------------------------------------------------
 33526                                  ; comment= do nothing. just decrease chrptr,and increase count for correct
 33527                                  ;		line number
 33528                                  ;-------------------------------------------------------------------------
 33529                                  
 33530                                  	; 31/12/2022
 33531                                  tryy:
 33532 000028A3 80FC59                  	cmp     ah,CONFIG_COMMENT ; 'Y'
 33533 000028A6 750B                    	jne	short try0
 33534                                  
 33535                                  donothing:
 33536                                  	; 15/12/2022
 33537                                  	; ds = cs
 33538 000028A8 FF0E[5A03]              	dec	word [chrptr]
 33539 000028AC FF06[5603]              	inc	word [count]
 33540                                  	; 02/11/2022
 33541                                  	;dec	word [cs:chrptr]
 33542                                  	;inc	word [cs:count]
 33543                                  
 33544 000028B0 E9F7F7                  	jmp	coff
 33545                                  
 33546                                  ;------------------------------------------------------------------------
 33547                                  ; rem command
 33548                                  ;------------------------------------------------------------------------
 33549                                  
 33550                                  try0:				; do nothing with this line.
 33551 000028B3 80FC30                  	cmp     ah,CONFIG_REM ; '0'
 33552 000028B6 74F0                    	je	short donothing
 33553                                  
 33554                                  ;%endif	; 30/10/2022
 33555                                  
 33556                                  ; 30/10/2022
 33557                                  ; (MSSOS 5.0 IO.SYS - SYSINIT:29D7h)
 33558                                  
 33559                                  ;------------------------------------------------------------------------
 33560                                  ; bogus command
 33561                                  ;------------------------------------------------------------------------
 33562                                  
 33563                                  tryz:
 33564 000028B8 80FCFF                          cmp     ah,0FFh		;null command? (BUGBUG - who sets FFh anyway?)
 33565                                  	; 31/12/2022
 33566 000028BB 74EB                    	je	short donothing
 33567                                  	; 02/11/2022
 33568                                  	;je	short tryz_donothing
 33569                                  
 33570 000028BD FF0E[5A03]              	dec	word [chrptr]
 33571 000028C1 FF06[5603]              	inc	word [count]
 33572 000028C5 EB37                    	jmp	short badop
 33573                                  
 33574                                  ; 31/12/2022
 33575                                  ;	; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 33576                                  ;tryz_donothing:
 33577                                  ;	jmp	donothing
 33578                                  
 33579                                  ; 07/04/2019 - Retro DOS v4.0
 33580                                  
 33581                                  ;------------------------------------------------------------------------------
 33582                                  
 33583                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 33584                                  ; (SYSINIT:2D5Dh)
 33585                                  
 33586                                  ; 11/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 33587                                  
 33588                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33589                                  ;
 33590                                  ;***	CheckProtmanArena -- special hack for adjusting alloclim with Protman$
 33591                                  ;
 33592                                  ;	adjusts alloclim if Protman$ reduced our arena through a manual hack.
 33593                                  ;
 33594                                  CheckProtmanArena:
 33595                                  	; 08/09/2023
 33596                                  	; ds = cs
 33597 000028C7 06                      	push	es
 33598                                  	;mov	ax,[cs:area]	; get our arena header
 33599 000028C8 A1[6803]                	mov	ax,[area] ; 08/09/2023
 33600 000028CB 48                      	dec	ax
 33601 000028CC 8EC0                    	mov	es,ax
 33602                                  	;add	ax,[es:ARENA.SIZE]
 33603 000028CE 2603060300              	add	ax,[es:3]	; find end of arena
 33604 000028D3 40                      	inc	ax
 33605                                  	; 08/09/2023
 33606 000028D4 3B06[A502]              	cmp	ax,[ALLOCLIM]
 33607                                  	;cmp	ax,[cs:ALLOCLIM] ; is it less than alloclim?
 33608 000028D8 7703                    	ja	short CheckProtmanDone
 33609                                  
 33610                                  	;mov	[cs:ALLOCLIM],ax ; reduce alloclim then
 33611                                  	; 08/09/2023
 33612 000028DA A3[A502]                	mov	[ALLOCLIM],ax
 33613                                  CheckProtmanDone:
 33614 000028DD 07                      	pop	es
 33615 000028DE C3                      	retn
 33616                                  
 33617                                  ;------------------------------------------------------------------------------
 33618                                  
 33619                                  sysinit_parse:
 33620                                  
 33621                                  ;------------------------------------------------------------------------------
 33622                                  ;set up registers for sysparse
 33623                                  ;in)	es:si -> command line in confbot
 33624                                  ;	di -> offset of the parse control definition.
 33625                                  ;
 33626                                  ;out)	calls sysparse.
 33627                                  ;	carry will set if parse error.
 33628                                  ;	*** the caller should check the eol condition by looking at ax
 33629                                  ;	*** after each call.
 33630                                  ;	*** if no parameters are found,then ax will contain a error code.
 33631                                  ;	*** if the caller needs to look at the synomym@ of the result,
 33632                                  ;	***  the caller should use cs:@ instead of es:@.
 33633                                  ;	cx register should be set to 0 at the first time the caller calls this
 33634                                  ;	 procedure.
 33635                                  ;	ax - exit code
 33636                                  ;	bl - terminated delimeter code
 33637                                  ;	cx - new positional ordinal
 33638                                  ;	si - set to pase scanned operand
 33639                                  ;	dx - selected result buffer
 33640                                  ;------------------------------------------------------------------------------
 33641                                  
 33642                                  	; 03/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 33643                                  	; (SYSINIT:2D78h)
 33644                                  
 33645                                  	; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 33646                                  	; ds = cs
 33647 000028DF 8C06[BC14]              	mov	[badparm_seg],es	;save the pointer to the parm
 33648 000028E3 8936[BA14]              	mov	[badparm_off],si	;we are about to parse for badparm msg.
 33649                                  
 33650                                  	; 24/10/2022
 33651 000028E7 06                      	push	es			;save es,ds
 33652 000028E8 1E                      	push	ds
 33653                                  
 33654 000028E9 06                      	push	es
 33655 000028EA 1F                      	pop	ds			;now ds:si -> command line
 33656                                  
 33657 000028EB 0E                      	push	cs
 33658 000028EC 07                      	pop	es			;now es:di -> control definition
 33659                                  
 33660                                  	; 09/09/2023
 33661                                  	;mov	[cs:badparm_seg],ds	;save the pointer to the parm
 33662                                  	;mov	[cs:badparm_off],si	;we are about to parse for badparm msg.
 33663                                  	
 33664                                  	;mov	dx,0
 33665                                  	; 04/01/2023
 33666 000028ED 29D2                    	sub	dx,dx ; 0
 33667 000028EF E872EC                  	call	SysParse
 33668                                  	;cmp	ax,_$P_No_Error	; 0	;no error
 33669                                  	; 06/09/2023
 33670 000028F2 21C0                    	and	ax,ax
 33671                                  
 33672                                  ;**cas note: when zero true after cmp, carry clear
 33673                                  
 33674                                  	;je	short ll4
 33675                                  	; 24/10/2022 (MSDOS 5.0 IO.SYS compatibility, SYSINIT:2A02h)
 33676                                  	; 12/12/2022
 33677 000028F4 7405                    	je	short en4 ; cf=0
 33678 000028F6 83F8FF                  	cmp	ax,_$P_RC_EOL ; 0FFFFh	;or the end of line?
 33679                                  	;jne	short if4
 33680                                  	; 12/12/2022
 33681 000028F9 7400                    	je	short en4 ; cf=0
 33682                                  	; 06/09/2023
 33683                                  	; cf=1
 33684                                  
 33685                                  ; 12/12/2022
 33686                                  ;ll4:
 33687                                  ;	; 12/12/2022
 33688                                  ;	; cf=0
 33689                                  ;	;clc
 33690                                  ;	jmp	short en4
 33691                                  
 33692                                  if4:
 33693                                  	; 24/10/2022
 33694                                  	; 06/09/2023 (cf=1)
 33695                                  	;stc
 33696                                  en4:
 33697 000028FB 1F                      	pop	ds
 33698 000028FC 07                      	pop	es
 33699 000028FD C3                      	retn
 33700                                  
 33701                                  ; 11/12/2022
 33702                                  %if 0
 33703                                  
 33704                                  ;----------------------------------------------------------------------------
 33705                                  ;
 33706                                  ; procedure : badop_p
 33707                                  ;
 33708                                  ;             same thing as badop,but will make sure to set ds register back
 33709                                  ;             to sysinitseg and return back to the caller.
 33710                                  ;
 33711                                  ;----------------------------------------------------------------------------
 33712                                  
 33713                                  badop_p:
 33714                                  	push	cs
 33715                                  	pop	ds		;set ds to configsys seg.
 33716                                  	mov	dx,badopm
 33717                                  	call	print
 33718                                          ;call	error_line
 33719                                  	;retn
 33720                                  	; 11/12/2022
 33721                                  	jmp	error_line
 33722                                  
 33723                                  %endif
 33724                                  
 33725                                  ;----------------------------------------------------------------------------
 33726                                  ;
 33727                                  ; label : badop
 33728                                  ;
 33729                                  ;----------------------------------------------------------------------------
 33730                                  
 33731                                  badop:	
 33732 000028FE BA[F449]                	mov	dx,badopm	;want to print command error "unrecognized command..."
 33733 00002901 E8C81B                  	call	print
 33734 00002904 E82B00                  	call	error_line	;show "error in config.sys ..." .
 33735 00002907 E9A0F7                  	jmp	coff
 33736                                  
 33737                                  ;----------------------------------------------------------------------------
 33738                                  ;
 33739                                  ; procedure : badparm_p
 33740                                  ;
 33741                                  ;             show "bad command or parameters - xxxxxx"
 33742                                  ;             in badparm_seg,badparm_off -> xxxxx
 33743                                  ;
 33744                                  ;----------------------------------------------------------------------------
 33745                                  
 33746                                  	; 24/10/2022
 33747                                  badparm_p:
 33748                                  	; 11/12/2022
 33749                                  	; ds = cs
 33750                                  	; 11/12/2022
 33751                                  	;push	ds ; *
 33752 0000290A 52                      	push	dx
 33753 0000290B 56                      	push	si
 33754                                  
 33755                                  	; 11/12/2022
 33756                                  	; ds = cs
 33757                                  	;push	cs
 33758                                  	;pop	ds
 33759                                  
 33760 0000290C BA[1B4A]                	mov	dx,badparm
 33761 0000290F E8BA1B                  	call	print			; "bad command or parameters - "
 33762 00002912 C536[BA14]              	lds	si,[badparm_ptr]
 33763                                  
 33764                                  ;	print "xxxx" until cr.
 33765                                  
 33766                                  do1:
 33767 00002916 8A14                    	mov	dl,[si]			; get next character
 33768 00002918 80FA0D                  	cmp	dl,cr ; 0Dh		; is a carriage return?
 33769 0000291B 7407                    	je	short en1		; exit loop if so
 33770                                  
 33771 0000291D B402                    	mov	ah,2 ; STD_CON_OUTPUT	; function 2
 33772 0000291F CD21                    	int	21h			; display character
 33773 00002921 46                      	inc	si			; next character
 33774 00002922 EBF2                    	jmp	short do1
 33775                                  en1:
 33776 00002924 0E                      	push	cs
 33777 00002925 1F                      	pop	ds
 33778                                  
 33779 00002926 BA[184A]                	mov	dx,crlfm
 33780 00002929 E8A01B                  	call	print
 33781 0000292C E80300                  	call	error_line
 33782                                  
 33783 0000292F 5E                      	pop	si
 33784 00002930 5A                      	pop	dx
 33785                                  	; 11/12/2022
 33786                                  	;pop	ds ; *
 33787                                  badparmp_ret:
 33788 00002931 C3                      	retn
 33789                                  
 33790                                  ; 10/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 33791                                  %if 0
 33792                                  
 33793                                  ;----------------------------------------------------------------------------
 33794                                  ;
 33795                                  ; procedure : getchr
 33796                                  ;
 33797                                  ;----------------------------------------------------------------------------
 33798                                  
 33799                                  	; 24/10/2022
 33800                                  getchr:
 33801                                  	; 12/12/2022
 33802                                  	;push	cx
 33803                                  	;mov	cx,[count]
 33804                                  	;jcxz	nochar
 33805                                  	; 12/12/2022
 33806                                  	cmp	word [count],1 
 33807                                  	jb	short nochar ; cf=1 ([count] = 0)
 33808                                  	
 33809                                  	mov	si,[chrptr]
 33810                                  	mov	al,[es:si]
 33811                                  	dec	word [count]
 33812                                  	inc	word [chrptr]
 33813                                  	; 12/12/202
 33814                                  	; cf=0
 33815                                  	;clc
 33816                                  ;get_ret:
 33817                                  	;pop	cx
 33818                                  	;retn
 33819                                  nochar: 
 33820                                  	; 12/12/2022
 33821                                  	; cf=1
 33822                                  	;stc
 33823                                  	;jmp	short get_ret
 33824                                  	
 33825                                  	retn
 33826                                  
 33827                                  %endif
 33828                                  
 33829                                  ; 11/12/2022
 33830                                  %if 0
 33831                                  
 33832                                  ;----------------------------------------------------------------------------
 33833                                  ;
 33834                                  ; procedure : incorrect_order
 33835                                  ;
 33836                                  ;             show "incorrect order in config.sys ..." message.
 33837                                  ;
 33838                                  ;----------------------------------------------------------------------------
 33839                                  
 33840                                  incorrect_order:
 33841                                  	mov	dx,badorder
 33842                                  	call	print
 33843                                  	call	showlinenum
 33844                                  	retn
 33845                                  
 33846                                  %endif
 33847                                  
 33848                                  ;----------------------------------------------------------------------------
 33849                                  ;
 33850                                  ; procedure : error_line
 33851                                  ;
 33852                                  ;             show "error in config.sys ..." message.
 33853                                  ;
 33854                                  ;----------------------------------------------------------------------------
 33855                                  
 33856                                  	; 11/12/2022
 33857                                  	; 24/10/2022
 33858                                  error_line:
 33859                                  	; 11/12/2022
 33860                                  	; ds = cs
 33861                                  	;push	cs
 33862                                  	;pop	ds
 33863                                  
 33864 00002932 BA[504B]                	mov	dx,errorcmd
 33865 00002935 E8941B                  	call	print
 33866                                  	;call	showlinenum
 33867                                  	;retn
 33868                                  	; 11/12/2022
 33869                                  	;jmp	short showlinenum
 33870                                  
 33871                                  ;----------------------------------------------------------------------------
 33872                                  ;
 33873                                  ; procedure : showlinenum
 33874                                  ;
 33875                                  ; convert the binary linecount to decimal ascii string in showcount
 33876                                  ; and display showcount at the current curser position.
 33877                                  ; in.) linecount
 33878                                  ;
 33879                                  ; out) the number is printed.
 33880                                  ;
 33881                                  ;----------------------------------------------------------------------------
 33882                                  
 33883                                  	; 11/12/2022
 33884                                  	; ds = cs
 33885                                  	; 24/10/2022
 33886                                  showlinenum:
 33887 00002938 06                      	push	es
 33888                                  	; 11/12/2022
 33889                                  	;push	ds
 33890 00002939 57                      	push	di
 33891                                  
 33892 0000293A 0E                      	push	cs
 33893 0000293B 07                      	pop	es		; es=cs
 33894                                  
 33895                                  	; 11/12/2022
 33896                                  	;push	cs
 33897                                  	;pop	ds
 33898                                  
 33899 0000293C BF[B502]                	mov	di,showcount+4	; di -> the least significant decimal field.
 33900 0000293F B90A00                  	mov	cx,10		; decimal divide factor
 33901                                  	;mov	ax,[cs:linecount]
 33902                                  	; 11/12/2022
 33903 00002942 A1[AF02]                	mov	ax,[linecount]
 33904                                  sln_loop:
 33905                                  	; 11/12/2022
 33906 00002945 39C8                    	cmp	ax,cx ; < 10 ?
 33907                                  	;cmp	ax,10		; < 10?
 33908 00002947 720C                    	jb	short sln_last  ; yes
 33909                                  
 33910 00002949 31D2                    	xor	dx,dx
 33911 0000294B F7F1                    	div	cx	; cx = 10
 33912 0000294D 80CA30                  	or	dl,30h		; add "0" (= 30h) to make it an ascii.
 33913                                  				; convert to ascii numeric char ("0" to "9")
 33914 00002950 8815                    	mov	[di],dl
 33915 00002952 4F                      	dec	di
 33916 00002953 EBF0                    	jmp	short sln_loop
 33917                                  
 33918                                  sln_last:
 33919 00002955 0C30                    	or	al,30h	; "0"   ; convert to ascii numeric char ("0" to "9")
 33920 00002957 8805                    	mov	[di],al
 33921 00002959 89FA                    	mov	dx,di
 33922 0000295B E86E1B                  	call	print		; show it.
 33923 0000295E 5F                      	pop	di
 33924                                  	; 11/12/2022
 33925                                  	;pop	ds
 33926 0000295F 07                      	pop	es
 33927 00002960 C3                      	retn
 33928                                  
 33929                                  ; 07/04/2019 - Retro DOS v4.0
 33930                                  ; (MSDOS 6.21 IO.SYS, SYSINIT:2E44h)
 33931                                  
 33932                                  ;----------------------------------------------------------------------------
 33933                                  ;
 33934                                  ; procedure : ProcDOS
 33935                                  ;
 33936                                  ;	Process the result of DOS= parsing
 33937                                  ;
 33938                                  ;	result_val._$P_item_tag	= 1 for DOS=HIGH
 33939                                  ;				= 2 for DOS=LOW
 33940                                  ;				= 3 for DOS=UMB
 33941                                  ;				= 4 for DOS=NOUMB
 33942                                  ;----------------------------------------------------------------------------
 33943                                  
 33944                                  	; 01/11/2022 - Retro DOS v4.0 (Modififed MSDOS 5.0 IO.SYS)
 33945                                  	; (SYTSINIT:2AB5h)
 33946                                  ProcDOS:
 33947                                  	; 01/01/2023
 33948                                  	; ds = cs
 33949 00002961 30E4                    	xor	ah,ah
 33950                                  	;;mov	al,[cs:result_val_itag]
 33951                                  	;mov	al,[cs:result_val+_$P_Result_Blk.Item_Tag]
 33952                                  	; 01/01/2023
 33953 00002963 A0[6B1D]                	mov	al,[result_val+_$P_Result_Blk.Item_Tag]
 33954 00002966 48                      	dec	ax
 33955 00002967 7415                    	jz	short pd_hi
 33956 00002969 48                      	dec	ax
 33957 0000296A 740E                    	jz	short pd_lo
 33958 0000296C 48                      	dec	ax
 33959 0000296D 7405                    	jz	short pd_umb
 33960                                  	;;mov	byte [cs:DevUMB],0
 33961                                  	; 18/12/2022
 33962                                  	;mov	byte [cs:DevUMB],ah ; 0
 33963                                  	; 01/01/2023
 33964 0000296F 8826[671F]              	mov	byte [DevUMB],ah ; 0
 33965 00002973 C3                      	retn
 33966                                  pd_umb:
 33967                                  	; 01/01/2023
 33968 00002974 C606[671F]FF            	mov	byte [DevUMB],0FFh
 33969                                  	;mov	byte [cs:DevUMB],0FFh
 33970 00002979 C3                      	retn
 33971                                  pd_lo:
 33972                                  	; 01/01/2023
 33973 0000297A A2[6C02]                	mov	[runhigh],al ; 0
 33974                                  	; 18/12/2022
 33975                                  	;mov	[cs:runhigh],al ; 0
 33976                                  	;;mov	byte [cs:runhigh],0
 33977 0000297D C3                      	retn
 33978                                  pd_hi:
 33979                                  	; 01/01/2023
 33980 0000297E C606[6C02]FF            	mov	byte [runhigh],0FFh
 33981                                  	;mov	byte [cs:runhigh],0FFh
 33982                                  limx:	; 11/12/2022
 33983 00002983 C3                      	retn
 33984                                  
 33985                                  ;----------------------------------------------------------------------------
 33986                                  ;
 33987                                  ; procedure : LieInt12Mem
 33988                                  ;
 33989                                  ;	Input : DevEntry points to Device Start address (offset == 0)
 33990                                  ;		alloclim set to the limit of low memory.
 33991                                  ;
 33992                                  ;	Output : none
 33993                                  ;
 33994                                  ;	Changes the ROM BIOS variable which stores the total low memory
 33995                                  ;	If a 3com device driver (any character device with name 'PROTMAN$')
 33996                                  ;	is being loaded alloclim is converted into Ks and stored in 40:13h
 33997                                  ;	Else if a device driver being loaded into UMB the DevLoadEnd is
 33998                                  ;	converted into Ks and stored in 40:13h
 33999                                  ;
 34000                                  ;----------------------------------------------------------------------------
 34001                                  
 34002                                  LieInt12Mem:
 34003                                  	; 11/12/2022
 34004                                  	; ds = cs
 34005 00002984 A1[A502]                	mov	ax,[ALLOCLIM]
 34006                                  	;mov	ax,[cs:ALLOCLIM]	; lie INT 12h as alloclim
 34007                                  					; assuming that it is 3Com
 34008 00002987 E84400                  	call	IsIt3Com		; Is it 3Com driver?
 34009 0000298A 740A                    	jz	short lim_set		; yes, lie to him differently
 34010                                  	; 13/05/2019
 34011                                  	;cmp	byte [cs:DeviceHi],0	; Is the DD being loaded in UMB
 34012                                  	;je	short limx		; no, don't lie
 34013                                  	;mov	ax,[cs:DevLoadEnd]	; lie INT 12h as end of UMB
 34014                                  	; 11/12/2022
 34015                                  	; ds = cs
 34016 0000298C 803E[761F]00            	cmp	byte [DeviceHi],0
 34017 00002991 74F0                    	je	short limx
 34018 00002993 A1[5C1F]                	mov	ax,[DevLoadEnd]
 34019                                  lim_set:
 34020                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 34021                                  	; 11/12/2022
 34022                                  	;call	SetInt12Mem
 34023                                  ;limx:
 34024                                  	;retn
 34025                                  	
 34026                                  	;jmp	short SetInt12Mem 
 34027                                  
 34028                                  ;----------------------------------------------------------------------------
 34029                                  ;
 34030                                  ; procedure : SetInt12Mem
 34031                                  ;
 34032                                  ;	Input : AX = Memory size to be set (in paras)
 34033                                  ;	Output : none
 34034                                  ;
 34035                                  ;	Sets the variable 40:13 to the memory size passed in AX
 34036                                  ;	It saves the old value in 40:13 in OldInt12Mem,
 34037                                  ;	It also sets a flag Int12Lied to 0ffh, which is checked before
 34038                                  ;	restoring the value of 40:13
 34039                                  ;
 34040                                  ;----------------------------------------------------------------------------
 34041                                  
 34042                                  	; 01/11/2022
 34043                                  SetInt12Mem:
 34044 00002996 1E                      	push	ds
 34045 00002997 BB4000                  	mov	bx,40h
 34046 0000299A 8EDB                    	mov	ds,bx			; ROM BIOS Data Segment
 34047 0000299C 8B1E1300                	mov	bx,[13h]		; INT 12 memory variable
 34048 000029A0 2E891E[7A1F]            	mov	[cs:OldInt12Mem],bx	; save it
 34049 000029A5 B106                    	mov	cl,6
 34050 000029A7 D3E8                    	shr	ax,cl			; convert paras into Ks
 34051 000029A9 A31300                  	mov	[13h],ax		; Lie
 34052 000029AC 2EC606[791F]FF          	mov	byte [cs:Int12Lied],0FFh ; mark that we are lying
 34053 000029B2 1F                      	pop	ds
 34054                                  ;limx:
 34055 000029B3 C3                      	retn
 34056                                  
 34057                                  ;----------------------------------------------------------------------------
 34058                                  ;
 34059                                  ; procedure : TrueInt12Mem
 34060                                  ;
 34061                                  ;	Input : Int12Lied = 0 if we are not lying currently
 34062                                  ;			  = 0ffh if we are lying
 34063                                  ;		OldInt12Mem = Saved value of 40:13h
 34064                                  ;
 34065                                  ;	Output : none
 34066                                  ;
 34067                                  ;	Resets the INT 12 Memory variable if we were lying about int 12
 34068                                  ;	and resets the flag which indicates that we were lying
 34069                                  ;
 34070                                  ;----------------------------------------------------------------------------
 34071                                  
 34072                                  TrueInt12Mem:
 34073                                  	; 11/12/2022
 34074                                  	; ds = cs
 34075 000029B4 803E[791F]00            	cmp	byte [Int12Lied],0
 34076                                  	;cmp	byte [cs:Int12Lied],0	; were we lying so far?
 34077                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS, SYS.INIT:2B1Dh)
 34078                                  	;mov	byte [cs:Int12Lied],0	; reset it anyway
 34079 000029B9 7412                    	je	short timx		; no, we weren't
 34080                                  	; 18/12/2022
 34081 000029BB B84000                  	mov	ax,40h
 34082 000029BE 8826[791F]              	mov	[Int12Lied],ah ; 0
 34083                                  	;mov	byte [Int12Lied],0
 34084                                  	;mov	byte [cs:Int12Lied],0
 34085 000029C2 1E                      	push	ds
 34086                                  	;mov	ax,40h
 34087 000029C3 8ED8                    	mov	ds,ax
 34088 000029C5 2EA1[7A1F]              	mov	ax,[cs:OldInt12Mem]
 34089 000029C9 A31300                  	mov	[13h],ax		; restore INT 12h memory
 34090 000029CC 1F                      	pop	ds
 34091                                  timx:
 34092 000029CD C3                      	retn
 34093                                  
 34094                                  ;----------------------------------------------------------------------------
 34095                                  ;
 34096                                  ; procedure : IsIt3Com?
 34097                                  ;
 34098                                  ;	Input : DevEntry = Seg:0 of device driver
 34099                                  ;	Output : Zero flag set if device name is 'PROTMAN$'
 34100                                  ;		 else Zero flag is reset
 34101                                  ;
 34102                                  ;----------------------------------------------------------------------------
 34103                                  
 34104                                  IsIt3Com:
 34105                                  	; 11/12/2022
 34106                                  	; ds = cs
 34107 000029CE 1E                      	push	ds
 34108 000029CF 06                      	push	es
 34109 000029D0 56                      	push	si
 34110                                  	; 11/12/2022
 34111 000029D1 C536[5E1F]              	lds	si,[DevEntry]
 34112                                  	;lds	si,[cs:DevEntry]	; ptr to device header
 34113 000029D5 83C60A                  	add	si,SYSDEV.NAME ; 10 	; ptr device name
 34114 000029D8 0E                      	push	cs
 34115 000029D9 07                      	pop	es
 34116 000029DA BF[7C1F]                	mov	di,ThreeComName
 34117 000029DD B90800                  	mov	cx,8			; name length
 34118 000029E0 F3A6                    	rep	cmpsb
 34119 000029E2 5E                      	pop	si
 34120 000029E3 07                      	pop	es
 34121 000029E4 1F                      	pop	ds
 34122 000029E5 C3                      	retn
 34123                                  
 34124                                  ;M020 : BEGIN
 34125                                  ;----------------------------------------------------------------------------
 34126                                  
 34127                                  UpdatePDB:
 34128 000029E6 1E                      	push	ds
 34129 000029E7 B462                    	mov	ah,62h
 34130 000029E9 CD21                    	int	21h	; DOS - 3+ - GET PSP ADDRESS
 34131 000029EB 8EDB                    	mov	ds,bx
 34132 000029ED 2E8B1E[A502]            	mov	bx,[cs:ALLOCLIM]
 34133                                  	;mov	[2],bx
 34134 000029F2 891E0200                	mov	[PDB.BLOCK_LEN],bx
 34135 000029F6 1F                      	pop	ds
 34136 000029F7 C3                      	retn
 34137                                  
 34138                                  ; M020 : END
 34139                                  
 34140                                  ;----------------------------------------------------------------------------
 34141                                  
 34142                                  ; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 34143                                  ;%if 0
 34144                                  
 34145                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 34146                                  ; (SYSINIT:2EEEh)
 34147                                  
 34148                                  ;include highload.inc	; Routines for devicehigh parsing, control of HIDDEN
 34149                                  ;include highexit.inc	; umb's, etc
 34150                                  
 34151                                  ; ----------------------------------------------------------------------
 34152                                  ; HIGHLOAD.INC (MSDOS 6.0 - 1991) 	
 34153                                  ; ----------------------------------------------------------------------
 34154                                  ; 07/04/2019 - Retro DOS v4.0
 34155                                  
 34156                                  ;******************************************************************************
 34157                                  ;
 34158                                  ; This file contains routines needed to parse and implement user-given
 34159                                  ; command-line options of the form "/S/L:3,0x500;2;7,127;0x0BE4". InitVar()
 34160                                  ; and Parsevar() are used to parse this data and place it in encoded form into
 34161                                  ; the variables in highvar.inc, for use by the rest of the routines.
 34162                                  ;
 34163                                  ; DeviceHigh accepts this command-line (handled in sysconf.asm, not here):
 34164                                  ;    DEVICEHIGH SIZE=hhhhhh module opts
 34165                                  ; Or, DeviceHigh and LoadHigh accept any of the following:
 34166                                  ;    DH/LH module opts
 34167                                  ;    DH/LH [/S][/L:umb[,size][;umb[,size]]*] module opts
 34168                                  ;    DH/LH [/L:umb[,size][;umb[,size]]*][/S] module opts
 34169                                  ; The initial UMB,SIZE pair designates the module's load address; the remainder
 34170                                  ; of the UMB and SIZE pairs are used to indicate specific UMBs to be left
 34171                                  ; available during the load.
 34172                                  ;
 34173                                  ; When an actual load is ready to be performed, a call to HideUMBs() will
 34174                                  ; temporarily allocate (as owner 8+"HIDDEN  ") all free elements in any
 34175                                  ; upper-memory block which was not specified by the user... in addition, if
 34176                                  ; UMBs were marked to shrink (/S option) to a certain size ("umb,size"), any
 34177                                  ; elements in that umb SAVE the lower-half of the newly-shrunken one are also
 34178                                  ; allocated. After the load, the function UnHideUMBs() (in highexit.inc) will
 34179                                  ; free any UMBs so allocated.
 34180                                  ;
 34181                                  ; When a device driver loads, there is the additional problem of allocating its
 34182                                  ; initial load site; this should be restricted to the first UMB specified on
 34183                                  ; the command-line. The function FreezeUM temporarily allocates all remaining
 34184                                  ; free upper-memory elements (as owner 8+"FROZEN  "), except those in the load
 34185                                  ; UMB. Then the initial allocation may be made, and a call to UnFreeze will
 34186                                  ; return any so-allocated memory elements to FREE, for the true load. Note
 34187                                  ; that UnFreeze leaves HIDDEN elements allocated; it only frees FROZEN ones.
 34188                                  ;
 34189                                  ;******************************************************************************
 34190                                  
 34191                                  SWTCH	equ	'/'		; Switch character
 34192                                  
 34193                                  DOS_CHECK_STRATEGY  equ	5800h	; Int 21h, Func 58h, Svc 0 = check alloc strat
 34194                                  DOS_SET_STRATEGY    equ	5801h	; Int 21h, Func 58h, Svc 1 = set alloc strategy
 34195                                  DOS_CHECK_UMBLINK   equ	5802h	; Int 21h, Func 58h, Svc 2 = check link state
 34196                                  DOS_GET_UMBLINK	    equ 5802h ; 20/04/2019
 34197                                  DOS_SET_UMBLINK     equ	5803h	; Int 21h, Func 58h, Svc 3 = set link state
 34198                                  DOS_GET_DOS_LISTS   equ	  52h	; Int 21h, Func 52h = return list of lists
 34199                                  DOS_UMB_HEAD        equ	  8Ch	; Offset from ES (after func52h) to get UMBHead
 34200                                  
 34201                                  CR	equ	0Dh		; Carriage Return
 34202                                  LF	equ	0Ah		; Line Feed
 34203                                  TAB	equ	09h		; Tab character (^I)
 34204                                  
 34205                                  ; -----------------------------------------------------------------------------
 34206                                  ;*** InitVar - initializes all the variables used in ParseVar and HideUMBs
 34207                                  ; -----------------------------------------------------------------------------
 34208                                  ; ENTRY:       None
 34209                                  ; EXIT:        Variables listed in highvar.inc are initialized
 34210                                  ; ERROR EXIT:  None
 34211                                  ; USES:        Flags, variables in highvar.inc
 34212                                  ; -----------------------------------------------------------------------------
 34213                                  ; Note that element 0 references UMB 0 (conventional), not UMB 1. Its contents
 34214                                  ; are largely ignored, but it is initialized nonetheless.
 34215                                  ; -----------------------------------------------------------------------------
 34216                                  
 34217                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 34218                                  ; (SYSINIT:2EEEh)
 34219                                  
 34220                                  InitVar:
 34221                                  	; 01/01/2023
 34222                                  	; ds = cs
 34223                                  
 34224                                  	;pushreg <ax, cx, di, es>
 34225                                  	; 03/01/2023
 34226                                  	;push	ax
 34227                                  	;push	cx
 34228                                  	;push	di
 34229 000029F8 06                      	push	es
 34230                                  
 34231                                  	;dataseg es			;Point ES into appropriate data segment
 34232 000029F9 0E                      	push	cs
 34233 000029FA 07                      	pop	es
 34234                                  
 34235 000029FB 31C0                    	xor	ax,ax
 34236                                  	;mov	[es:fUmbTiny],al	;Shrink UMBs? (made 1 if /S given)
 34237                                  	;mov	[es:fInHigh],al		;Set to 1 when DH/LH has been called
 34238                                  	;mov	[es:SegLoad],ax		;Load Address (seg), used for DH only
 34239                                  	;mov	byte [es:UmbLoad],UNSPECIFIED ; 0FFh
 34240                                  	;				;Later is the # of the 1st spec'd UMB
 34241                                  	;mov	[es:fm_argc], al	;Start with zero args having been read
 34242                                  
 34243                                  	; 01/01/2023
 34244                                  	; ds = cs
 34245 000029FD A2[211F]                	mov	[fUmbTiny],al		;Shrink UMBs? (made 1 if /S given)
 34246 00002A00 A2[201F]                	mov	[fInHigh],al		;Set to 1 when DH/LH has been called
 34247 00002A03 A3[221F]                	mov	[SegLoad],ax		;Load Address (seg), used for DH only
 34248 00002A06 C606[241F]FF            	mov	byte [UmbLoad],UNSPECIFIED ; 0FFh
 34249                                  					;Later is the # of the 1st spec'd UMB
 34250 00002A0B A2[571F]                	mov	[fm_argc], al		;Start with zero args having been read
 34251                                  
 34252 00002A0E FC                      	cld
 34253                                  
 34254 00002A0F B91000                  	mov	cx,MAXUMB ; 16		;For each entry
 34255 00002A12 BF[251F]                	mov	di,UmbUsed		;on the UmbUsed array,
 34256 00002A15 F3AA                    	rep	stosb			;	Store 0
 34257                                  
 34258                                  	;mov	cx,MAXUMB ; 16		;Okay... for each entry
 34259                                  	; 01/01/2033
 34260 00002A17 B110                    	mov	cl,MAXUMB ; 16
 34261 00002A19 BF[351F]                	mov	di,UmbSize		;on the UmbSize array,
 34262 00002A1C F3AB                    	rep	stosw			;	Store 0
 34263                                  
 34264                                  	;normseg es			; Return ES
 34265                                  
 34266                                  	;popreg	<es, di, cx, ax>
 34267 00002A1E 07                      	pop	es
 34268                                  	; 03/01/2023
 34269                                  	;pop	di
 34270                                  	;pop	cx
 34271                                  	;pop	ax	 	
 34272                                  
 34273 00002A1F C3                      	retn
 34274                                  
 34275                                  ; -----------------------------------------------------------------------------
 34276                                  ;*** FixMem - scans the upper memory chain and concatenates adjacent free MCBs
 34277                                  ; -----------------------------------------------------------------------------
 34278                                  ; ENTRY   : None
 34279                                  ; EXIT    : None
 34280                                  ; ERROR   : None
 34281                                  ; USES    : Flags, fm_umb, fm_strat
 34282                                  ; -----------------------------------------------------------------------------
 34283                                  
 34284                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 34285                                  	; (SYSINIT:2F22h)
 34286                                  FixMem:
 34287                                  	; 01/01/2023
 34288                                  	;push	ax
 34289                                  	;push	bx
 34290                                  	;push	cx
 34291                                  	;push	dx
 34292 00002A20 06                      	push	es
 34293                                  
 34294 00002A21 E84900                  	call	fm_link		; Link in UMBs
 34295                                  
 34296 00002A24 E80002                  	call	UmbHead		; Get first upper-memory MCB address (0x9FFF)
 34297 00002A27 723F                    	jc	short fmX	; (if couldn't get it, leave now).
 34298                                  
 34299 00002A29 8EC0                    	mov	es,ax		; It returns in AX, so move it to ES.
 34300                                  
 34301                                  ; - Walk MCB Chain ------------------------------------------------------------
 34302                                  
 34303 00002A2B 31D2                    	xor	dx,dx		; We're keeping the address of the last MCB
 34304 00002A2D 89D1                    	mov 	cx,dx		; in CX... and the last owner
 34305 00002A2F 42                      	inc	dx		; in dx as we go through the loop:
 34306                                  
 34307                                  ; ------------------------------------------
 34308                                  ; FM10--DX  = last MCB's owner's PSP address
 34309                                  ;       CX  = last MCB's address (segment)
 34310                                  ; ------------------------------------------
 34311                                  
 34312 00002A30 26A00000                fm10:	mov	al,[es:ARENA.SIGNATURE] ; if 'Z', don't repeat loop
 34313 00002A34 268B1E0100              	mov	bx,[es:ARENA.OWNER]	; if not zero, do nothing
 34314 00002A39 09D3                    	or	bx,dx			; dx was owner of previous MCB
 34315 00002A3B 7516                    	jnz	short fm30		; If not both zero, don't cat.
 34316                                  
 34317                                  	; - Coalesce memory blocks at ES:00 and CX:00 -------------------------
 34318                                  
 34319 00002A3D 268B1E0300              fm20:	mov	bx,[es:ARENA.SIZE]	; Grab this block's Size,
 34320 00002A42 8EC1                    	mov	es,cx			; Go back to prev MCB's address
 34321 00002A44 26A20000                	mov	[es:ARENA.SIGNATURE],al ; & move the SECOND sig here
 34322                                  
 34323 00002A48 26031E0300              	add	bx,[es:ARENA.SIZE]	; Size += first MCB's size
 34324                                  	;add	bx,1			; And add one for the header
 34325                                  	; 11/07/2023
 34326 00002A4D 43                      	inc	bx
 34327 00002A4E 26891E0300              	mov	[es:ARENA.SIZE],bx	; Write the size
 34328                                  
 34329                                  	; ---------------------------------------------------------------------
 34330                                  
 34331 00002A53 8CC1                    fm30:	mov	cx,es			; Save MCB address
 34332 00002A55 268B160100              	mov	dx,[es:ARENA.OWNER]	; And remember its owner
 34333                                  
 34334 00002A5A 8CC3                    	mov	bx,es			; Move to the next MCB
 34335                                  	;add	bx,[es:3]
 34336 00002A5C 26031E0300              	add	bx,[es:ARENA.SIZE]
 34337 00002A61 43                      	inc	bx
 34338 00002A62 8EC3                    	mov	es,bx
 34339                                  
 34340                                  	;cmp	al,'Z'
 34341 00002A64 3C5A                    	cmp	al,arena_signature_end
 34342 00002A66 75C8                    	jne	short fm10		; If signature != 'Z', there are more.
 34343                                  fmX:	
 34344 00002A68 E81300                  	call	fm_unlink		; Unlink UMBs
 34345                                  
 34346 00002A6B 07                      	pop	es
 34347                                  	; 01/01/2023
 34348                                  	;pop	dx
 34349                                  	;pop	cx
 34350                                  	;pop	bx
 34351                                  	;pop	ax
 34352                                  
 34353 00002A6C C3                      	retn
 34354                                  
 34355                                  ; -----------------------------------------------------------------------------
 34356                                  ;*** fm_link - links UMBs not already linked in
 34357                                  ; -----------------------------------------------------------------------------
 34358                                  ; ENTRY:    None
 34359                                  ; EXIT:     fm_umb == 0 if not linked in previously, 1 if already linked in
 34360                                  ; ERROR:    None
 34361                                  ; USES:     AX, BX, fm_umb
 34362                                  ; -----------------------------------------------------------------------------
 34363                                  
 34364                                  	; 01/01/2023 - Retro DOS v4.2
 34365                                  fm_link:
 34366 00002A6D B80258                  	mov	ax,DOS_CHECK_UMBLINK ; 5802h
 34367 00002A70 CD21                    	int	21h			; Current link-state is now in al
 34368                                  
 34369                                  	;putdata fm_umb,al		; So store it in fm_umb for later
 34370                                  	;
 34371                                  	;push	es
 34372                                  	;push	cs
 34373                                  	;pop	es
 34374                                  	;mov	[es:fm_umb],al
 34375                                  	;pop	es
 34376                                  	
 34377                                  	; 01/01/2023
 34378                                  	; ds = cs
 34379                                  	;mov	[cs:fm_umb],al
 34380 00002A72 A2[551F]                	mov	[fm_umb],al
 34381                                  
 34382 00002A75 B80358                  	mov	ax,DOS_SET_UMBLINK ; 5803h
 34383 00002A78 BB0100                  	mov	bx,1
 34384 00002A7B CD21                    	int	21h
 34385 00002A7D C3                      	retn
 34386                                  
 34387                                  ; -----------------------------------------------------------------------------
 34388                                  ;*** fm_unlink - unlinks UMBs if fm_umb is set to 0
 34389                                  ; -----------------------------------------------------------------------------
 34390                                  ; ENTRY:    fm_umb == 1 : leave linked, else unlink
 34391                                  ; EXIT:     None
 34392                                  ; ERROR:    None
 34393                                  ; USES:     AX, BX
 34394                                  ; -----------------------------------------------------------------------------
 34395                                  
 34396                                  	; 01/01/2023 - Retro DOS v4.2
 34397                                  fm_unlink:
 34398 00002A7E 31DB                    	xor	bx,bx
 34399                                  	
 34400                                  	;getdata bl,fm_umb		; fm_umb already has the old link-state
 34401                                  	;
 34402                                  	;push	ds
 34403                                  	;push	cs
 34404                                  	;pop	ds
 34405                                  	;mov	bl,[fm_umb]	
 34406                                  	;pop	ds
 34407                                  	
 34408                                  	; 01/01/2023
 34409                                  	; ds = cs
 34410                                  	;mov	bl,[cs:fm_umb]
 34411 00002A80 8A1E[551F]              	mov	bl,[fm_umb]
 34412                                  
 34413 00002A84 B80358                  	mov	ax,DOS_SET_UMBLINK ; 5803h
 34414 00002A87 CD21                    	int	21h			; so just use that, and call int 21h
 34415 00002A89 C3                      	retn
 34416                                  
 34417                                  ; 08/04/2019 - Retro DOS v4.0
 34418                                  
 34419                                  ; -----------------------------------------------------------------------------
 34420                                  ;*** ParseVar - parses [/S][/L:umb[,size][;umb[,size]]*] and builds the table
 34421                                  ; laid out in highvar.inc
 34422                                  ; -----------------------------------------------------------------------------
 34423                                  ; ENTRY:    ES:SI points to command tail of LoadHigh/DeviceHigh (whitespace ok)
 34424                                  ; EXIT:     ES:SI points to first character in child program name
 34425                                  ; ERROR:    ES:SI points to character which caused error, carry set, AX == code
 34426                                  ; USES:     ES:SI, AX, flags, variables in highvar.inc
 34427                                  ; -----------------------------------------------------------------------------
 34428                                  ; Error codes (in AX if carry set on return):
 34429                                  ;
 34430                                  PV_InvArg	equ	1	; Invalid argument passed
 34431                                  PV_BadUMB	equ	2	; Bad UMB number passed (duplicate?)
 34432                                  PV_InvSwt	equ	3	; Unrecognized switch passed
 34433                                  ;
 34434                                  ; This routine exects ES:SI to point to a string much like the following:
 34435                                  ;    "/S/L:1,200;2 module options"
 34436                                  ; Optionally, the string can begin with whitespace; neither /S nor /L is
 34437                                  ; required, though that's what this routine is supposed to parse.
 34438                                  ;
 34439                                  optS		equ	'S'	; /S
 34440                                  optL		equ	'L'	; /L:...
 34441                                  ;
 34442                                  ; -----------------------------------------------------------------------------
 34443                                  ; LoadHigh has a list of arguments, returned by cparse, which is used to create
 34444                                  ; a command-line for spawning a child process. For a typical LH command, say,
 34445                                  ;     lh /l:1,1000;2 print/d:lpt2
 34446                                  ; the arguments would look like (one per line):
 34447                                  ;     lh
 34448                                  ;     /l
 34449                                  ;     1
 34450                                  ;     1000
 34451                                  ;     2
 34452                                  ;     print
 34453                                  ;     /d
 34454                                  ;     :lpt2
 34455                                  ; In short, if "print" were, say, "43", there'd be no way to determine which
 34456                                  ; arg was the filename. So, inside this routine, we keep a running counter
 34457                                  ; of the number of arguments LH will need to skip in order to get to the
 34458                                  ; program name. The "lh" is implicit--it'll always have to skip that. So if
 34459                                  ; there's no "/l" or "/s", fm_argc will be 0 ... other than that, 1 is added
 34460                                  ; for:
 34461                                  ;    Each /L
 34462                                  ;    Each /S (there should be only one)
 34463                                  ;    Each UMB number (they follow ":" or ";")
 34464                                  ;    Each UMB size   (they follow ",")
 34465                                  ; So, in the above example, fm_argc would be 4-- and LH would skip right to
 34466                                  ; "print".  Note that InitVar initializes fm_argc to zero.
 34467                                  ; -----------------------------------------------------------------------------
 34468                                  
 34469                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 34470                                  	; (SYSINIT:2F9Fh)
 34471                                  
 34472                                  ParseVar:
 34473                                  	;pushreg <di, ds, es>
 34474                                  	; 01/01/2023
 34475                                  	;push	di ; * ; (not required) ; 01/01/2023
 34476 00002A8A 1E                      	push	ds
 34477 00002A8B 06                      	push	es
 34478                                  
 34479 00002A8C 06                      	push	es		; Make DS:SI point to it, as well as ES:SI
 34480 00002A8D 1F                      	pop	ds		; (regardless if we're in devhigh or loadhigh)
 34481 00002A8E FC                      	cld
 34482                                  
 34483                                  ; ------------------------------------------------
 34484                                  ; PV10--ES:SI = any whitespace on the command-line
 34485                                  ; ------------------------------------------------
 34486                                  
 34487 00002A8F AC                      pv10:	lodsb			; here, ES:SI=="  /L..."--must eat whitespace
 34488 00002A90 E8A200                  	call	isWhite
 34489 00002A93 74FA                    	jz	short pv10	;       ES:SI==" /L..."--keep eating.
 34490                                  	;cmp	al,'/'
 34491 00002A95 3C2F                    	cmp	al,SWTCH
 34492 00002A97 7404                    	je	short pv20	;       ES:SI=="/L..."--go process a switch
 34493                                  
 34494 00002A99 4E                      	dec	si		; Backup--it's now "odule options", and we need
 34495 00002A9A F8                      	clc			; that "m" we just read (or whatever it is).
 34496 00002A9B EB2B                    	jmp	short pvX	; Then return with carry clear == we're done.
 34497                                  pv20:	
 34498 00002A9D AC                      	lodsb			; Just read 'S' or 'L', hopefully
 34499                                  	;toUpper al		; So we make it upper-case, and...
 34500 00002A9E 24DF                    	and	al,0DFh
 34501                                  	;cmp	al,'S'
 34502 00002AA0 3C53                    	cmp	al,optS		; just read 'S'?
 34503 00002AA2 750D                    	jne	short pv30
 34504                                  
 34505                                  	;call	incArgc		; If it's /S, it's another arg for LH to skip.
 34506 00002AA4 2EFE06[571F]            	inc	byte [cs:fm_argc] ; 19/04/2019
 34507                                  
 34508                                  	;putdata fUmbTiny,1	; /S, so ES:SI=="  /L..." or " module opts", or
 34509                                  	;
 34510                                  	;push	es
 34511                                  	;push	cs
 34512                                  	;pop	es
 34513                                  	;mov	[es:fUmbTiny],1	
 34514                                  	;pop	es
 34515                                  
 34516 00002AA9 2EC606[211F]01          	mov	byte [cs:fUmbTiny],1
 34517                                  
 34518 00002AAF EBDE                    	jmp	short pv10	; possibly even "/L...".
 34519                                  
 34520                                  pv30:	;cmp	al,'L'
 34521 00002AB1 3C4C                    	cmp	al,optL		; If it's not 'L' either, then it's a bad
 34522 00002AB3 750D                    	jne	short pvE1	; switch!
 34523                                  
 34524                                  	;call	incArgc		; If it's /L, it's another arg for LH to skip.
 34525 00002AB5 2EFE06[571F]            	inc	byte [cs:fm_argc] ; 19/04/2019
 34526                                  
 34527 00002ABA E80E00                  	call	parseL
 34528 00002ABD 73D0                    	jnc	short pv10	; If no carry, go back and look for more
 34529                                  
 34530 00002ABF 4E                      	dec	si		; Else, back up and exit.
 34531 00002AC0 EB03                    	jmp	short pvErr	; AX has already been set by parseL
 34532                                  
 34533                                  pvE1:	;mov	ax,3
 34534 00002AC2 B80300                  	mov	ax,PV_InvSwt	; Unrecognized switch passed
 34535 00002AC5 4E                      pvErr:	dec	si
 34536 00002AC6 4E                      	dec	si
 34537 00002AC7 F9                      	stc
 34538                                  pvX:	;popreg	<es, ds, di>
 34539 00002AC8 07                      	pop	es
 34540 00002AC9 1F                      	pop	ds
 34541                                  	; 01/01/2023
 34542                                  	;pop	di ; * ; (not required) ; 01/01/2023
 34543 00002ACA C3                      	retn
 34544                                  
 34545                                  ; -----------------------------------------------------------------------------
 34546                                  ;*** parseL - parses ":nnnn[,nnnn][;nnnn[,nnnn]]*" for ParseVar
 34547                                  ; -----------------------------------------------------------------------------
 34548                                  ; ENTRY:    ES:SI points to colon
 34549                                  ; EXIT:     ES:SI points to first character not parsed
 34550                                  ; ERROR:    Carry set; rewind three characters and return (see ParseVar)
 34551                                  ; USES:     ES:SI, flags, AX, CX, DX, variables in highvar.inc
 34552                                  ; -----------------------------------------------------------------------------
 34553                                  ; If the string here is terminated with anything other than whitespace or a
 34554                                  ; switchchar (perhaps it's /S or another /L:... ), then we return with carry
 34555                                  ; set, indicating that they've screwed up the syntax. The 3-character rewind
 34556                                  ; makes sure the app /L: is reported as being the culprit.
 34557                                  ; -----------------------------------------------------------------------------
 34558                                  
 34559                                  parseL:
 34560 00002ACB AC                      	lodsb
 34561 00002ACC 3C3A                    	cmp	al,':'		; Make sure they did /L:
 34562 00002ACE 754E                    	jne	short plE1	; If they didn't, return with carry set.
 34563                                  
 34564                                  ; ------------------------------------------
 34565                                  ; PL10--ES:SI = a UMB number, after /L: or ;
 34566                                  ; ------------------------------------------
 34567                                  
 34568 00002AD0 E8DB00                  pl10:	call	GetXNum		; After this, it's ",size" or ";umb" or " mod"
 34569 00002AD3 724F                    	jc	short plE2	; And error if it's a bad number.
 34570 00002AD5 E89D01                  	call	convUMB		; Convert any address to a UMB number
 34571                                  
 34572 00002AD8 88C1                    	mov	cl,al		; Remember the UMB number
 34573 00002ADA E87600                  	call	stowUMB		; Mark this UMB # as used;
 34574 00002ADD 7245                    	jc	short plE2	; If it was already marked, it'll error
 34575                                  
 34576                                  	;call	incArgc		; Each UMB number is another arg for LH to skip
 34577 00002ADF 2EFE06[571F]            	inc	byte [cs:fm_argc] ; 08/04/2019 - Retro DOS v4.0
 34578                                  
 34579 00002AE4 AC                      	lodsb
 34580 00002AE5 3C3B                    	cmp	al,';'		; Did "umb;" ?
 34581 00002AE7 74E7                    	je	short pl10	; Yep: go back and get another UMB.
 34582                                  
 34583 00002AE9 E84900                  	call	isWhite		; Did "umb " ?
 34584 00002AEC 743B                    	jz	short plX	; Yep: return (it'll go back to whitespace)
 34585                                  
 34586 00002AEE E83900                  	call	isEOL		; Did "umb" ?
 34587 00002AF1 7435                    	jz	short plSwX	; If so, backup and exit like everything's ok
 34588                                  
 34589                                  	;cmp	al,'/'
 34590 00002AF3 3C2F                    	cmp	al,SWTCH 	; Did "umb/" ? (as in, "/L:1,100;2/S")
 34591 00002AF5 7431                    	je	short plSwX	; If so, back up ES:SI one character and return
 34592                                  
 34593 00002AF7 3C2C                    	cmp	al,','		; Did "umb," ?
 34594 00002AF9 7523                    	jne	short plE1	; Just what the heck DID they do? Return error.
 34595                                  
 34596                                  ; --- Read a size -------------------------------------------------------------
 34597                                  
 34598 00002AFB E8B000                  	call	GetXNum		; Stop on "size;" or "size " or anything else
 34599 00002AFE 721E                    	jc	short plE1	; And error if it's a bad size.
 34600                                  
 34601 00002B00 E81601                  	call	toPara		; Convert from bytes to paragraphs
 34602                                  
 34603 00002B03 E8CE01                  	call	stowSiz		; CL still has the UMB number for this routine
 34604                                  
 34605                                  	;call	incArgc		; Each UMB size is another arg for LH to skip
 34606 00002B06 2EFE06[571F]            	inc	byte [cs:fm_argc] ; 08/04/2019 - Retro DOS v4.0
 34607                                  
 34608 00002B0B AC                      	lodsb
 34609 00002B0C 3C3B                    	cmp	al,';'		; They did "umb,size;", so get another UMB.
 34610 00002B0E 74C0                    	je	short pl10	;
 34611                                  
 34612 00002B10 E82200                  	call	isWhite		; Did it end with whitespace?
 34613 00002B13 7414                    	jz	short plX	; If so, we're done here--go back.
 34614                                  
 34615 00002B15 E81200                  	call	isEOL		; Did they do "umb,size" and end??? (stupid)
 34616 00002B18 740E                    	jz	short plSwX	; If so, backup and exit like everything's ok
 34617                                  
 34618                                  	;cmp	al,'/'
 34619 00002B1A 3C2F                    	cmp	al,SWTCH	; Did they do "umb,size/" ?
 34620 00002B1C 740A                    	je	short plSwX	; If so, again, we're done here.
 34621                                  plE1:	
 34622                                  	;mov	ax,1
 34623 00002B1E B80100                  	mov	ax,PV_InvArg	; If not, we don't know WHAT they did...
 34624 00002B21 4E                      	dec	si
 34625 00002B22 F9                      	stc
 34626 00002B23 C3                      	retn
 34627                                  
 34628                                  plE2:	;mov	ax,2
 34629 00002B24 B80200                  	mov	ax,PV_BadUMB	; In this case, they've specified a UMB twice
 34630                                  	; 12/12/2022
 34631                                  	; cf=1
 34632                                  	;stc
 34633 00002B27 C3                      	retn
 34634                                  plSwX:	
 34635 00002B28 4E                      	dec	si		; If we hit a '/' character, back up one char
 34636                                  				; so the whitespace checker will see it too.
 34637                                  plX:	; 12/12/2022
 34638                                  	; cf=0
 34639                                  	;clc			; Then just return with carry clear, so
 34640 00002B29 C3                      	retn			; ParseVar will go about its business.
 34641                                  
 34642                                  ; -----------------------------------------------------------------------------
 34643                                  ;*** incArgc - increments fm_argc, for use with LoadHigh command-line parsing
 34644                                  ; -----------------------------------------------------------------------------
 34645                                  ; ENTRY:    None
 34646                                  ; EXIT:     None
 34647                                  ; ERROR:    None
 34648                                  ; USES:     fm_argc, flags
 34649                                  ; -----------------------------------------------------------------------------
 34650                                  
 34651                                  ;incArgc:
 34652                                  	;push	ax
 34653                                  
 34654                                  	;;getdata al, fm_argc	; Obtain previous value of fm_argc,
 34655                                  
 34656                                  	;mov	al,[cs:fm_argc]
 34657                                  
 34658                                  	;inc	al		; Increment it,
 34659                                  
 34660                                  	;;putdata fm_argc, al	; And store it right back.
 34661                                  
 34662                                  	;mov	[cs:fm_argc],al
 34663                                  
 34664                                  	;pop	ax
 34665                                  	;retn
 34666                                  
 34667                                  ; -----------------------------------------------------------------------------
 34668                                  ;*** isEOL - returns with ZF set if AL contains CR or LF, or 0
 34669                                  ; -----------------------------------------------------------------------------
 34670                                  ; ENTRY:    AL contains character to test
 34671                                  ; EXIT:     ZF set if AL contains CR or LF, or 0
 34672                                  ; ERROR:    None
 34673                                  ; USES:     ZF
 34674                                  ; -----------------------------------------------------------------------------
 34675                                  
 34676                                  isEOL:
 34677 00002B2A 3C00                    	cmp	al,0		; Null-terminator
 34678 00002B2C 7406                    	je	short ieX
 34679 00002B2E 3C0D                    	cmp	al,CR ; 0Dh	; Carriage Return
 34680 00002B30 7402                    	je	short ieX
 34681 00002B32 3C0A                    	cmp	al,LF ; 0Ah	; LineFeed
 34682                                  ieX:	
 34683 00002B34 C3                      	retn
 34684                                  
 34685                                  ; -----------------------------------------------------------------------------
 34686                                  ;*** isWhite - returns with ZF set if AL contains whitespace (or "=")
 34687                                  ; -----------------------------------------------------------------------------
 34688                                  ; ENTRY:    AL contains character to test
 34689                                  ; EXIT:     ZF set if AL contains space, tab, or equals
 34690                                  ; ERROR:    None
 34691                                  ; USES:     ZF
 34692                                  ; -----------------------------------------------------------------------------
 34693                                  
 34694                                  isWhite:
 34695 00002B35 3C20                    	cmp	al,' '		; Space
 34696 00002B37 7406                    	je	short iwX
 34697 00002B39 3C3D                    	cmp	al,'='		; Equals (treat as whitespace)
 34698 00002B3B 7402                    	je	short iwX
 34699 00002B3D 3C09                    	cmp	al,tab ; 9	; Tab
 34700                                  iwX:	
 34701 00002B3F C3                      	retn
 34702                                  
 34703                                  ; -----------------------------------------------------------------------------
 34704                                  ;*** unMarkUMB - marks a given UMB as unused, even if previously marked used
 34705                                  ; -----------------------------------------------------------------------------
 34706                                  ; ENTRY:    AL contains UMB number
 34707                                  ; EXIT:     None
 34708                                  ; ERROR:    None
 34709                                  ; USES:     Flags, variables in highvar.inc
 34710                                  ; -----------------------------------------------------------------------------
 34711                                  
 34712                                  	; 02/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 34713                                  
 34714                                  unMarkUMB:
 34715                                  	; 02/01/2023
 34716                                  	;push	ax
 34717                                  	;push	bx
 34718                                  	;push	di
 34719                                  	;push	es
 34720                                  	;
 34721                                  	;push	cs
 34722                                  	;pop	es
 34723                                  
 34724 00002B40 30E4                    	xor	ah,ah
 34725 00002B42 89C3                    	mov	bx,ax
 34726                                  
 34727                                  	; 19/04/2019
 34728                                  	
 34729                                  	;;mov	byte [es:bx+UmbUsed],0
 34730                                  	;mov	[es:bx+UmbUsed],ah ; 0
 34731                                  	; 02/01/2023
 34732                                  	; ds= cs
 34733                                  	;mov	[cs:bx+UmbUsed],ah ; 0
 34734 00002B44 88A7[251F]              	mov	[bx+UmbUsed],ah ; 0
 34735                                  
 34736 00002B48 3806[241F]              	cmp	[UmbLoad],al
 34737                                  	;cmp	[cs:UmbLoad],al
 34738                                  	;;cmp	[es:UmbLoad],al
 34739 00002B4C 7504                    	jne	short umu10
 34740                                  
 34741                                  	;;mov	[es:UmbLoad],0	; If unmarked the load UMB, load into convent.
 34742                                  	;mov	[es:UmbLoad],ah ; 0
 34743                                  	; 02/01/2023
 34744                                  	; ds = cs
 34745                                  	;mov	[cs:UmbLoad],ah ; 0
 34746 00002B4E 8826[241F]              	mov	[UmbLoad],ah ; 0
 34747                                  umu10:	
 34748                                  	;pop	es
 34749                                  	;pop	di
 34750                                  	;pop	bx
 34751                                  	;pop	ax
 34752 00002B52 C3                      	retn
 34753                                  
 34754                                  ; -----------------------------------------------------------------------------
 34755                                  ;*** stowUMB - marks a given UMB as used, if it hasn't been so marked before
 34756                                  ;            -- accepts a UMB # in AL, and makes sure it hasn't yet been
 34757                                  ; listed in the /L:... chain. If it's the first one specified, it sets UmbLoad
 34758                                  ; to that UMB #... and in any case, it marks the UMB as specified.
 34759                                  ; -----------------------------------------------------------------------------
 34760                                  ; ENTRY:    AL contains UMB number, as specified by the user
 34761                                  ; EXIT:     None
 34762                                  ; ERROR:    Carry set if UMB # is less than 0 or >= MAXUMB (see highvar.inc)
 34763                                  ; USES:     AX, Flags, variables in highvar.inc
 34764                                  ; -----------------------------------------------------------------------------
 34765                                  
 34766                                  	; 01/01/2023 - Retro DOS v4.2
 34767                                  stowUMB:
 34768 00002B53 3C10                    	cmp	al,MAXUMB ; 16
 34769 00002B55 7202                    	jb	short su10
 34770 00002B57 F9                      	stc
 34771 00002B58 C3                      	retn			; Ooops-- UMB # >= MAXUMB
 34772                                  su10:	
 34773                                  	; 01/01/2023
 34774                                  	;push	bx
 34775                                  	;push	di
 34776                                  	;push	si
 34777                                  	;push	ds
 34778                                  	;push	es
 34779                                  	;push	cs
 34780                                  	;pop	es
 34781                                  	;push	cs
 34782                                  	;pop	ds
 34783                                  
 34784                                  	; 01/01/2023
 34785                                  	; ds <> cs
 34786                                  	;cmp	byte [cs:UmbLoad],0FFh
 34787 00002B59 2E803E[241F]FF          	cmp	byte [cs:UmbLoad],UNSPECIFIED
 34788                                  				; If this, we haven't been here before
 34789 00002B5F 7504                    	jne	short su20
 34790 00002B61 2EA2[241F]              	mov	[cs:UmbLoad],al	; So remember this UMB as the load UMB slot.
 34791                                  
 34792                                  	;;cmp	byte [UmbLoad],0FFh
 34793                                  	;cmp	byte [UmbLoad],UNSPECIFIED ; If this, we haven't been here before
 34794                                  	;jne	short su20
 34795                                  	;mov	[UmbLoad],al	; So remember this UMB as the load UMB slot.
 34796                                  su20:	
 34797 00002B65 08C0                    	or	al,al		; If they gave UMB 0, there's really nothing
 34798 00002B67 740E                    	jz	short su30	; that we should do here.
 34799                                  
 34800                                  	;mov	bl,al
 34801                                  	;xor	bh,bh
 34802                                  	;mov	ax,1		; Now, AX = 1, and BX = UMB Number
 34803                                  	; 01/01/2023
 34804 00002B69 30E4                    	xor	ah,ah
 34805 00002B6B 89C3                    	mov	bx,ax
 34806 00002B6D B001                    	mov	al,1
 34807                                  
 34808                                  	;xchg	[es:bx+UmbUsed],al
 34809                                  	; 01/01/2023
 34810 00002B6F 2E8687[251F]            	xchg	[cs:bx+UmbUsed],al
 34811                                  
 34812                                  	;or	al,al		; If it was already 1, then al==1... and that
 34813                                  	;jz	short su30	; means an error.
 34814                                  	;
 34815                                  	;stc			; OOOPS! This one's been used before. :(
 34816                                  	
 34817                                  	; 01/01/2023
 34818 00002B74 3C01                    	cmp	al,1
 34819 00002B76 F5                      	cmc 	; if al > 0 -> cf = 1
 34820                                  su30:	
 34821                                  	; 01/01/2023
 34822                                  	;pop	es
 34823                                  	;pop	ds
 34824                                  	;pop	si
 34825                                  	;pop	di
 34826                                  	;pop	bx
 34827 00002B77 C3                      	retn
 34828                                  
 34829                                  ; 08/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 34830                                  %if 0
 34831                                  ; -----------------------------------------------------------------------------
 34832                                  ;*** stowSiz - marks a given UMB as having a given minimum size
 34833                                  ; -----------------------------------------------------------------------------
 34834                                  ; ENTRY:    CL contains UMB number, AX contains size
 34835                                  ; EXIT:     None
 34836                                  ; ERROR:    None
 34837                                  ; USES:     AX, DX, Flags, variables in highvar.inc
 34838                                  ; -----------------------------------------------------------------------------
 34839                                  
 34840                                  ; 13/05/2019
 34841                                  
 34842                                  	; 01/01/2023 - Retro DOS v4.2
 34843                                  stowSiz:
 34844                                  	; 01/01/2023
 34845                                  	;push	bx
 34846                                  	;;push	di ; ?
 34847                                  	;push	es
 34848                                  
 34849                                  	;push	cs
 34850                                  	;pop	es	
 34851                                  
 34852                                  	mov	bl,cl			; Now bl==UMB number, AX==size
 34853                                  	mov	bh,0			;     bx==UMB number, AX==size
 34854                                  	shl	bl,1			;     bx==offset into array, AX=size
 34855                                  	;mov	[es:bx+UmbSize],ax	; Store the size
 34856                                  	; 01/01/2023
 34857                                  	mov	[cs:bx+UmbSize],ax	; Store the size
 34858                                  
 34859                                  	; 01/01/2023
 34860                                  	;pop	es
 34861                                  	;;pop	di ; ?
 34862                                  	;pop	bx
 34863                                  
 34864                                  	retn
 34865                                  %endif
 34866                                  
 34867                                  ; -----------------------------------------------------------------------------
 34868                                  ;*** toDigit - converts a character-digit to its binary counterpart
 34869                                  ;            -- verifies that CL contains a valid character-digit; if so, it
 34870                                  ; changes CL to its counterpart binary digit ((CL-'0') or (CL-'A'+10)).
 34871                                  ; A-F are considered valid if gnradix is 16.
 34872                                  ; -----------------------------------------------------------------------------
 34873                                  ; ENTRY:    CL contains a digit ('0' to '9' or, if gnradix==16, 'A' to 'F')
 34874                                  ; EXIT:     CL contains digit in binary (0 to 9 or, if gnradix==16, 0 to 15)
 34875                                  ; ERROR:    Carry set indicates invalid digit; carry clear indicates good digit
 34876                                  ; USES:     CL, Flags
 34877                                  ; -----------------------------------------------------------------------------
 34878                                  ; If the string is preceeded with "0x", the value is read as hexadecimal; else,
 34879                                  ; as decimal. After a read, you may check the radix by examining gnradix--it
 34880                                  ; will be 10 or 16.
 34881                                  ; -----------------------------------------------------------------------------
 34882                                  
 34883                                  gnradix:
 34884 00002B78 0000                    	dw	0		; Must be a word--16x16 multiplication
 34885                                  
 34886                                  toDigit:
 34887 00002B7A 2E833E[782B]10          	cmp	word [cs:gnradix],16
 34888 00002B80 751C                    	jne	short td20	; Don't check hex digits if radix isn't 16
 34889                                  
 34890                                  toDigit_hex:
 34891 00002B82 80F961                  	cmp	cl,'a'	; 61h
 34892 00002B85 7209                    	jb	short td10
 34893 00002B87 80F966                  	cmp	cl,'f'	; 66h
 34894 00002B8A 7720                    	ja	short tdE	; Nothing valid above 'f' at all...
 34895 00002B8C 80E957                  	sub	cl,'a'-10 ; 57h	; Make 'a'==10 and return.
 34896                                  	;clc			; <- CLC is implicit from last SUB
 34897 00002B8F C3                      	retn
 34898                                  td10:	
 34899 00002B90 80F941                  	cmp	cl,'A'  ; 41h
 34900 00002B93 7209                    	jb	short td20	; Below 'A'? Not a letter...
 34901 00002B95 80F946                  	cmp	cl,'F'	; 46h
 34902 00002B98 7712                    	ja	short tdE	; Above 'F'? Not a digit.
 34903 00002B9A 80E937                  	sub	cl,'A'-10 ; 37h	; Make 'A'==10 and return.
 34904                                  	;clc			; <- CLC is implicit from last SUB
 34905 00002B9D C3                      	retn
 34906                                  toDigit_dec:
 34907                                  td20:	
 34908 00002B9E 80F930                  	cmp	cl,'0'		; If less than zero,
 34909                                  	;jb	short tdE	; Done.
 34910 00002BA1 720A                    	jb	short tdEr ; 08/04/2019
 34911 00002BA3 80F939                  	cmp	cl,'9'		; Or, if greater than nine,
 34912 00002BA6 7704                    	ja	short tdE	; Done.
 34913 00002BA8 80E930                  	sub	cl,'0'	; 30h	; Okay--make '0'==0 and return.
 34914                                  	;clc			; <- CLC is implicit from last SUB
 34915 00002BAB C3                      	retn
 34916                                  tdE:	
 34917 00002BAC F9                      	stc
 34918                                  tdEr:		; 08/04/2019 - Retro DOS v4.0	
 34919 00002BAD C3                      	retn
 34920                                  
 34921                                  ; -----------------------------------------------------------------------------
 34922                                  ;*** GetXNum - reads a 32-bit ASCII number at ES:SI and returns it in DX:AX
 34923                                  ; -----------------------------------------------------------------------------
 34924                                  ; ENTRY:    ES:SI points to an ascii string to scan
 34925                                  ; EXIT:     ES:SI moved to first invalid digit, DX:AX contains value read
 34926                                  ; ERROR:    Carry set if # is too big, or has no digits (EOL possibly)
 34927                                  ; USES:     ES:SI, DX, AX, Flags, gnradix
 34928                                  ; -----------------------------------------------------------------------------
 34929                                  ; If the string is preceeded with "0x", the value is read as hexadecimal; else,
 34930                                  ; as decimal. After a read, you may check the radix by examining gnradix--it
 34931                                  ; will be 10 or 16.
 34932                                  ; -----------------------------------------------------------------------------
 34933                                  
 34934                                  ; 08/04/2019 - Retro DOS v4.0
 34935                                  
 34936                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 34937                                  ; (SYSINIT:3109h)
 34938                                  
 34939                                  GetXNum:
 34940                                  	;pushreg <bx, cx, ds>
 34941                                  	; 01/01/2023
 34942                                  	;push	bx
 34943 00002BAE 51                      	push	cx ; *
 34944                                  	;push	ds
 34945                                  
 34946 00002BAF FC                      	cld
 34947 00002BB0 31C0                    	xor	ax,ax
 34948 00002BB2 31DB                    	xor	bx,bx
 34949 00002BB4 31C9                    	xor	cx,cx
 34950 00002BB6 31D2                    	xor	dx,dx			; Start with 0 (makes sense)
 34951                                  
 34952 00002BB8 2EC706[782B]0A00        	mov	word [cs:gnradix],10	; And default to a radix of 10 (dec)
 34953                                  
 34954 00002BBF 268A0C                  	mov	cl,[es:si]		; Now AX=0, BX=0, CH=0/CL=char, DX=0
 34955                                  	;call	toDigit
 34956 00002BC2 E8D9FF                  	call	toDigit_dec
 34957                                  	;jc	short gxnE		; If it's not a digit, leave now.
 34958                                  	; 01/01/2023
 34959 00002BC5 7233                    	jc	short gxnX
 34960                                  
 34961 00002BC7 08C9                    	or	cl,cl
 34962 00002BC9 7517                    	jnz	short gxn20		; Doesn't have '0x'
 34963 00002BCB 268A4C01                	mov	cl,[es:si+1]
 34964 00002BCF 80F978                  	cmp	cl,'x'			; Either 'x'...
 34965 00002BD2 7405                    	je	short gxn10
 34966 00002BD4 80F958                  	cmp	cl,'X'			; ...or 'X' means it's hexadecimal
 34967 00002BD7 7509                    	jne	short gxn20
 34968                                  
 34969                                  gxn10:	
 34970 00002BD9 2EC706[782B]1000        	mov	word [cs:gnradix], 16
 34971 00002BE0 46                      	inc	si			; Since we read "0x", march over it.
 34972 00002BE1 46                      	inc	si
 34973                                  
 34974                                  ; ------------------------------------------------------
 34975                                  ; GXN20--ES:SI = a digit in a number; if not, we're done
 34976                                  ;        DX:AX = current total
 34977                                  ;        BX    = 0
 34978                                  ;        CH    = 0
 34979                                  ; ------------------------------------------------------
 34980                                  
 34981                                  gxn20:	
 34982 00002BE2 268A0C                  	mov	cl,[es:si]	; Now DX:AX=current total, CH=0/CL=char
 34983 00002BE5 46                      	inc	si
 34984                                  
 34985 00002BE6 E891FF                  	call	toDigit		; Accepts only valid digits, A-F -> 10-16
 34986 00002BE9 720D                    	jc	short gxnQ	; <- Ah... wasn't a digit. Stop.
 34987                                  
 34988 00002BEB E80E00                  	call	mul32		; Multiply DX:AX by gnradix
 34989 00002BEE 720A                    	jc	short gxnX	; (if it's too big, error out)
 34990                                  
 34991 00002BF0 01C8                    	add	ax,cx		; Add the digit
 34992 00002BF2 11DA                    	adc	dx,bx		; (BX is 0!)--Adds 1 if last add wrapped
 34993                                  	;jc	short gxnX	; If _that_ wrapped, it's too big.
 34994                                  	;jmp	short gxn20
 34995 00002BF4 73EC                    	jnc	short gxn20
 34996                                  gxnE:	
 34997                                  	;stc			; In this case, we need to set the carry
 34998 00002BF6 EB02                    	jmp	short gxnX	; and leave--there were no digits given.
 34999                                  gxnQ:	
 35000 00002BF8 4E                      	dec	si		; Don't read in the offensive character.
 35001 00002BF9 F8                      	clc			; And clear carry, so they know it's okay.
 35002                                  gxnX:	
 35003                                  	; 01/01/2023
 35004                                  	;pop	ds
 35005 00002BFA 59                      	pop	cx ; *
 35006                                  	;pop	bx
 35007 00002BFB C3                      	retn
 35008                                  
 35009                                  ; -----------------------------------------------------------------------------
 35010                                  ;*** mul32 - multiplies the number in DX:AX by gnradix
 35011                                  ; -----------------------------------------------------------------------------
 35012                                  ; ENTRY:   DX:AX = the number to be multiplied, BX = 0, gnradix = multiplier
 35013                                  ; EXIT:    DX:AX has been multiplied by gnradix if carry clear; BX still 0
 35014                                  ; ERROR:   Carry set if number was too large
 35015                                  ; USES:    Flags, AX, DX
 35016                                  ; -----------------------------------------------------------------------------
 35017                                  
 35018                                  mul32:
 35019 00002BFC 50                      	push	ax		; DX=old:hi, AX=old:lo, TOS=old:lo, BX=0
 35020 00002BFD 89D0                    	mov	ax,dx		; DX=old:hi, AX=old:hi, TOS=old:lo, BX=0
 35021 00002BFF 2EF726[782B]            	mul	word [cs:gnradix] ; DX=?, AX=new:hi, TOS=old:lo, BX=0
 35022 00002C04 7211                    	jc	short m32E	; Too big?
 35023                                  
 35024 00002C06 89C2                    	mov	dx,ax		; DX=new:hi, AX=new:hi, TOS=old:lo, BX=0
 35025 00002C08 58                      	pop	ax		; DX=new:hi, AX=old:lo, TOS=orig, BX=0
 35026                                  
 35027 00002C09 87D3                    	xchg	dx,bx		; DX=0, AX=old:lo, TOS=orig, BX=new:hi
 35028 00002C0B 2EF726[782B]            	mul	word [cs:gnradix] ; DX=carry, AX=new:lo, TOS=orig, BX=new:hi
 35029 00002C10 87D3                    	xchg	dx,bx		; DX=new:hi, AX=new:lo, TOS=orig, BX=carry
 35030 00002C12 01DA                    	add	dx,bx		; DX=new:hi, AX=new:lo, TOS=orig, BX=carry
 35031 00002C14 31DB                    	xor	bx,bx		; DX=new:hi, AX=new:lo, TOS=orig, BX=0
 35032 00002C16 C3                      	retn
 35033                                  m32E:	
 35034 00002C17 58                      	pop	ax
 35035 00002C18 C3                      	retn
 35036                                  
 35037                                  ; -----------------------------------------------------------------------------
 35038                                  ;*** toPara - divides DX:AX by 16; result in AX only (discards extra DX data)
 35039                                  ; -----------------------------------------------------------------------------
 35040                                  ; ENTRY:   DX:AX = the number to be divided
 35041                                  ; EXIT:    Interpereting DX:AX as bytes, AX=paragraph equivalent, 0xFFFF max
 35042                                  ; ERROR:   None
 35043                                  ; USES:    Flags, AX, DX
 35044                                  ; -----------------------------------------------------------------------------
 35045                                  ; Note: The 386 has a 32-bit SHR, which would work perfectly for this... but we
 35046                                  ;       can't ensure a 386 host machine. Sorry.
 35047                                  ; -----------------------------------------------------------------------------
 35048                                  
 35049                                  	; 01/01/2023 - Retro DOS v4.2
 35050                                  toPara:
 35051 00002C19 51                      	push	cx		; DX:AX=HHHH hhhh hhhh hhhh:LLLL llll llll llll
 35052                                  
 35053 00002C1A B104                    	mov	cl,4		;
 35054 00002C1C D3E8                    	shr	ax,cl		; DX:AX=HHHH hhhh hhhh hhhh:0000 LLLL llll llll
 35055 00002C1E 92                      	xchg	ax,dx		; DX:AX=0000 LLLL llll llll:HHHH hhhh hhhh hhhh
 35056 00002C1F B10C                    	mov	cl,12
 35057 00002C21 D3E0                    	shl	ax,cl		; DX:AX=0000 LLLL llll llll:hhhh 0000 0000 0000
 35058 00002C23 09D0                    	or	ax,dx		;    AX=hhhh LLLL llll llll
 35059                                  
 35060 00002C25 59                      	pop	cx
 35061 00002C26 C3                      	retn
 35062                                  
 35063                                  ; -----------------------------------------------------------------------------
 35064                                  ;*** UmbHead - returns in AX the address of the first UMB block (0x9FFF)
 35065                                  ; -----------------------------------------------------------------------------
 35066                                  ; ENTRY:  Nothing
 35067                                  ; EXIT:   AX contains 0x9FFF for most systems
 35068                                  ; ERROR:  Carry set if pointer is 0xFFFF (if not set up yet--DH runs into this)
 35069                                  ; USES:   Flags, AX
 35070                                  ; -----------------------------------------------------------------------------
 35071                                  ; Early in the boot-cycle, the pointer used to obtain this value isn't set up;
 35072                                  ; to be precise, before a UMB provider is around. In this event, the pointer
 35073                                  ; is always set to 0xFFFF; it changes once a provider is around. On most
 35074                                  ; machines (all of 'em I've seen), it changes to 0x9FFF at that point.
 35075                                  ; -----------------------------------------------------------------------------
 35076                                  
 35077                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 35078                                  UmbHead:
 35079                                  	; 13/05/2019 (because of callers, pushs & pops are not needed here)
 35080                                  
 35081                                  	;push	si ; ?
 35082                                  	;push	ds ; ? 
 35083                                  	;push	es
 35084                                  	;push	bx ; *	
 35085                                  
 35086                                  	; 09/04/2019
 35087                                  	; !!! No need to save es,bx,ds,si above !!! (es,bx are changed here)
 35088                                  
 35089 00002C27 B452                    	mov	ah,GET_IN_VARS		; Call int 21h, function 52h...
 35090 00002C29 CD21                    	int	21h
 35091                                  
 35092 00002C2B 26A18C00                	mov	ax,[es:DOS_UMB_HEAD]	; And read what's in ES:[008C]
 35093                                  	
 35094                                  	; 01/01/2023
 35095 00002C2F 83F8FF                  	cmp	ax,0FFFFh
 35096 00002C32 F5                      	cmc
 35097                                  	; if AX=0FFFFh -> CF=1
 35098 00002C33 C3                      	retn
 35099                                  
 35100                                  ; 01/01/2023
 35101                                  ;%if 0
 35102                                  ;	cmp	ax,0FFFFh
 35103                                  ;	je	short uhE		; If it's 0xFFFF, it's an error...
 35104                                  ;
 35105                                  ;	clc				; Else, it isn't (CLC done by prev cmp)
 35106                                  ;	;jmp	short uhX
 35107                                  ;	; 12/12/2022
 35108                                  ;	retn
 35109                                  ;uhE:	
 35110                                  ;	stc
 35111                                  ;uhX:	
 35112                                  ;	;pop	bx ; *
 35113                                  ;	;pop	es
 35114                                  ;	;pop	ds ; ?
 35115                                  ;	;pop	si ; ?
 35116                                  ;	retn
 35117                                  ;%endif
 35118                                  
 35119                                  ; -----------------------------------------------------------------------------
 35120                                  ;*** isSysMCB - sets ZF if ES points to an MCB owned by "SC" + (8 or 9)
 35121                                  ; -----------------------------------------------------------------------------
 35122                                  ; ENTRY:  ES:0 should point to a valid MCB
 35123                                  ; EXIT:   ZF set if owned by SC+8 or SC+9 (for japan)
 35124                                  ; USES:   Flags
 35125                                  ; -----------------------------------------------------------------------------
 35126                                  
 35127                                  isSysMCB:
 35128                                  	;push	ax
 35129                                  
 35130                                  	;mov	ax,[es:ARENA.OWNER]	; Check the owner...
 35131                                  	;cmp	ax,SystemPSPOwner	; 8 (for US OR Japan) is valid
 35132                                  	;je	short ism10
 35133                                  	;cmp	ax,JapanPSPOwner	; 9 (for Japan) is valid
 35134                                  	;;je	short ism10
 35135                                  	;;jmp	short ismX		; Anything else isn't.
 35136                                  	;jne	short ismX
 35137 00002C34 26833E010008            	cmp	word [es:ARENA.OWNER],SystemPSPOwner ; 8  ; 09/04/2019
 35138 00002C3A 7507                    	jne	short ismX 
 35139                                  ism10:	
 35140                                  	;mov	ax,[es:ARENA.NAME]	; Check the name...
 35141                                  	;cmp	ax,'SC' ; 4353h
 35142 00002C3C 26813E08005343          	cmp	word [es:ARENA.NAME],'SC'
 35143                                  ismX:	
 35144                                  	;pop	ax
 35145 00002C43 C3                      	retn
 35146                                  
 35147                                  ; 09/04/2019 - Retro DOS v4.0
 35148                                  
 35149                                  ; -----------------------------------------------------------------------------
 35150                                  ;*** AddrToUmb - converts a segment address in AX to its appropriate UMB number
 35151                                  ; -----------------------------------------------------------------------------
 35152                                  ; ENTRY:  AX contains a segment address
 35153                                  ; EXIT:   AX will contain the UMB number which contains the address (0==conv)
 35154                                  ; ERROR:  If the address is above UM Range, AX will return as FFFF.
 35155                                  ; USES:   Flags, AX
 35156                                  ; -----------------------------------------------------------------------------
 35157                                  ; An address in the following areas is treated as:
 35158                                  ;    0      <-> umbhead (0x9FFF)          = Conventional memory
 35159                                  ;    0x9FFF <-> addr of first UM sys MCB  = UMB #1
 35160                                  ;      ...
 35161                                  ;    addr of last UM sys MCB <-> TOM      = invalid; returns #0xFFFF
 35162                                  ; -----------------------------------------------------------------------------
 35163                                  
 35164                                  	; 01/01/2023 - Retro DOS v4.2
 35165                                  AddrToUmb:
 35166                                  	; 01/01/2023
 35167                                  	;push	cx
 35168                                  	;push	dx
 35169 00002C44 06                      	push	es
 35170                                  
 35171 00002C45 89C2                    	mov	dx,ax		; DX = address to search for
 35172                                  
 35173 00002C47 E8DDFF                  	call	UmbHead		; AX = first segment
 35174 00002C4A 7222                    	jc	short atuE	; If it couldn't get it, error out.
 35175                                  
 35176                                  	; 22/07/2023
 35177                                  	;mov	es,ax ; *	; ES = first UMB segment
 35178 00002C4C 31C9                    	xor	cx,cx ; 0	; Pretend we're on UMB 0 for now... (cx = UMB#)
 35179                                  
 35180                                  	; 22/07/2023
 35181                                  atu10:
 35182 00002C4E 8EC0                    	mov	es,ax ; * ; ** ; 22/07/2023
 35183                                  ; ----------------------------------------
 35184                                  ; ATU10--ES - Current MCB address
 35185                                  ;        DX - Address given for conversion
 35186                                  ;        CX - Current UMB #
 35187                                  ; ----------------------------------------
 35188                                  
 35189                                  ;atu10:	
 35190                                  	;mov	ax,es ; * ; 18/07/2023
 35191 00002C50 39D0                            cmp	ax,dx		; Present segment >= given segment?
 35192 00002C52 731D                    	jae	short atuX	; Yep--done.
 35193                                  
 35194 00002C54 E8DDFF                  	call	isSysMCB	; Returns with ZF set if this is a system MCB
 35195 00002C57 7501                    	jnz	short atu20
 35196                                  
 35197 00002C59 41                      	inc	cx		; If it _was_ a system MCB, we're in a new UMB.
 35198                                  atu20:	
 35199                                  	;mov	al,[es:ARENA.SIGNATURE]
 35200                                  	;cmp	al,arena_signature_end  ; 'Z'
 35201                                  	; 22/07/2023
 35202                                  	; ax = es
 35203                                  	;mov	ax,es ; **
 35204 00002C5A 2603060300              	add	ax,[es:ARENA.SIZE]
 35205 00002C5F 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],arena_signature_end
 35206 00002C65 7403                    	je	short atu30		; 'Z' means this was the last MCB... that's it.
 35207                                  
 35208                                  	;NextMCB es,ax
 35209                                  
 35210                                  	;mov	ax,es ; **
 35211                                  	;;add	ax,[es:3]
 35212                                  	;add	ax,[es:ARENA.SIZE]
 35213 00002C67 40                      	inc	ax
 35214                                  	; 22/07/2023
 35215                                  	;mov	es,ax ; *
 35216 00002C68 EBE4                    	jmp	short atu10
 35217                                  
 35218                                  ; -----------------------------------------------------------------------------
 35219                                  ; if we get to atu30, they specified a number that was past the last MCB.
 35220                                  ; make sure it's not _inside_ that MCB before we return an error condition.
 35221                                  ; -----------------------------------------------------------------------------
 35222                                  
 35223                                  atu30:	
 35224                                  	; 22/07/2023
 35225                                  	; ax = es + [es:ARENA.SIZE] 
 35226                                  	;mov	ax,es ; **
 35227                                  	;add	ax,[es:ARENA.SIZE] ; **
 35228 00002C6A 39D0                    	cmp	ax,dx		; Present >= given?
 35229 00002C6C 7303                    	jae	short atuX	; Yep! It _was_ inside.
 35230                                  atuE:	
 35231 00002C6E 31C9                    	xor	cx,cx ; 0	; Else, fall through with UMB # == -1
 35232 00002C70 49                      	dec	cx		; (that makes it return 0xFFFF and sets CF)
 35233                                  atuX:	
 35234 00002C71 89C8                    	mov	ax,cx		; Return the UMB number in AX
 35235                                  	
 35236 00002C73 07                      	pop	es	
 35237                                  	; 01/01/2023
 35238                                  	;pop	dx
 35239                                  	;pop	cx
 35240 00002C74 C3                      	retn
 35241                                  
 35242                                  ; -----------------------------------------------------------------------------
 35243                                  ;*** convUMB - checks after GetXNum to convert an address to a UMB number
 35244                                  ;            -- if GetXNum read a hex number, we interperete that as a segment
 35245                                  ; address rather than a UMB number... and use that address to look up a UMB.
 35246                                  ; This routine checks for that condition and calls AddrToUmb if necessary.
 35247                                  ; -----------------------------------------------------------------------------
 35248                                  ; ENTRY:  AX contains a UMB number or segment, gnradix has been set by GetXNum
 35249                                  ; EXIT:   AX will contain a UMB number
 35250                                  ; ERROR:  None
 35251                                  ; USES:   Flags, AX
 35252                                  ; -----------------------------------------------------------------------------
 35253                                  
 35254                                  	; 01/01/2023 - Retro DOS v4.2
 35255                                  convUMB:
 35256 00002C75 2E833E[782B]10          	cmp	word [cs:gnradix],16
 35257 00002C7B 7507                    	jne	short cu10	; If it didn't read in hex, it's not an address
 35258 00002C7D E8C4FF                  	call	AddrToUmb	; Else, convert the address to a UMB number
 35259                                  	;cmp	ax,0FFFFh
 35260                                  	;jne	short cu10
 35261                                  	;inc	ax		; If too high, ignore it (make it conventional)
 35262                                  	; 01/01/2023
 35263 00002C80 40                      	inc	ax
 35264 00002C81 7401                    	jz	short cu10	; If too high, ignore it (make it conventional)
 35265 00002C83 48                      	dec	ax
 35266                                  cu10:	
 35267 00002C84 C3                      	retn
 35268                                  
 35269                                  ; 01/01/2023 - Retro DOS v4.2
 35270                                  ;%if 0
 35271                                  ;
 35272                                  ;; -----------------------------------------------------------------------------
 35273                                  ;;*** setUMBs - links umbs and sets allocation strategy for a load
 35274                                  ;;            -- if LoadHigh, the allocation strategy MAY be LOW_FIRST instead
 35275                                  ;; of the usual HIGH_FIRST. See the code.
 35276                                  ;; -----------------------------------------------------------------------------
 35277                                  ;; ENTRY:  None
 35278                                  ;; EXIT:   None
 35279                                  ;; ERROR:  None
 35280                                  ;; USES:   Flags, fm_umb, fm_strat
 35281                                  ;; -----------------------------------------------------------------------------
 35282                                  ;
 35283                                  ;setUMBs:
 35284                                  ;	push	ax
 35285                                  ;	push	bx
 35286                                  ;	call	fm_link
 35287                                  ;	pop	bx
 35288                                  ;	pop	ax
 35289                                  ;	retn
 35290                                  ;
 35291                                  ;%endif
 35292                                  
 35293                                  ; 18/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 35294                                  ; loadLow subroutine is not used anywhere of IO.SYS 6.22 (& 5.0)
 35295                                  %if 0
 35296                                  
 35297                                  ; -----------------------------------------------------------------------------
 35298                                  ;*** loadLow - returns AL==0 if UMB0 == 0, else AL==1
 35299                                  ; -----------------------------------------------------------------------------
 35300                                  ; ENTRY:  None
 35301                                  ; EXIT:   AL==0 if mem strategy should be set to LOW_FIRST, else AL==1
 35302                                  ;         Carry set if UMB0 not specified (_NOT_ an error)
 35303                                  ; ERROR:  None
 35304                                  ; USES:   Flags, fm_strat, fm_umb
 35305                                  ; -----------------------------------------------------------------------------
 35306                                  ; We want to set the memory strategy to LOW_FIRST if the user specified a
 35307                                  ; load UMB, and it is 0. That 0 can be either from the user having _specified_
 35308                                  ; zero (/L:0;...), or from having specified a too-big min size (/L:1,99999999)
 35309                                  ; such that the load UMB is too small, and shouldn't be used.
 35310                                  ; -----------------------------------------------------------------------------
 35311                                  
 35312                                  loadLow:
 35313                                  	;push	ds
 35314                                  	;push	cs		; Point DS into appropriate data segment
 35315                                  	;pop	ds	
 35316                                  
 35317                                  	;mov	al,[UmbLoad]
 35318                                  	mov	al,[cs:UmbLoad]
 35319                                  	cmp	al,UNSPECIFIED ; 0FFh, -1
 35320                                  	jne	short ll10
 35321                                  
 35322                                  	stc
 35323                                  ll15:
 35324                                  	mov	al,1		; Return with AL==1 && STC if no UMBs specified
 35325                                  	;stc
 35326                                  	;jmp	short llX
 35327                                  	retn
 35328                                  ll10:	
 35329                                  	or	al,al		; AL=the load UMB: Is it == 0?
 35330                                  	;jz	short llX	; Yep... CF==0 (from OR) && AL=0, so just exit
 35331                                  
 35332                                  	jnz	short ll15	; 09/04/2019 - Retro DOS v4.0
 35333                                  	retn
 35334                                  
 35335                                  	;mov	al,1
 35336                                  	;clc
 35337                                  ;llX:
 35338                                  	;pop	ds		; Return DS to where it was
 35339                                  	;retn
 35340                                  
 35341                                  %endif
 35342                                  
 35343                                  ; -----------------------------------------------------------------------------
 35344                                  ;*** HideUMBs - links UMBs and hides upper-memory as appropriate
 35345                                  ; -----------------------------------------------------------------------------
 35346                                  ; ENTRY:  None
 35347                                  ; EXIT:   None
 35348                                  ; ERROR:  None
 35349                                  ; USES:   Flags, fm_strat, fm_umb
 35350                                  ; -----------------------------------------------------------------------------
 35351                                  
 35352                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 35353                                  	; (SYSINIT:322Fh)
 35354                                  HideUMBs:
 35355                                  	; 01/01/2023
 35356                                  	;push	ax
 35357                                  	;push	cx
 35358                                  	;push	ds
 35359 00002C85 06                      	push	es
 35360                                  
 35361                                  	; 01/01/2023
 35362                                  	; ds = cs
 35363                                  
 35364 00002C86 E86E02                  	call	UmbTest		; See if we REALLY linked in anything...
 35365 00002C89 7232                    	jc	short husX	; ...if not, there's nothing for us to do.
 35366                                  
 35367 00002C8B E892FD                  	call	FixMem		; Concatenate adjacent free MCBs in upper mem
 35368                                  	
 35369                                  	;call	setUMBs		; Link UMBs and set memory-allocation strategy
 35370                                  	; 01/01/2023
 35371 00002C8E E8DCFD                  	call	fm_link
 35372                                  
 35373                                  	;putdata fInHigh,1	; Remember that we're now running high
 35374                                  	;mov	byte [cs:fInHigh],1
 35375                                  	; 01/01/2023
 35376 00002C91 C606[201F]01            	mov	byte [fInHigh],1
 35377                                  
 35378                                  	;call	GetLoadUMB	; See if they gave us a list to leave free
 35379                                  	;mov	al,[cs:UmbLoad] ; 09/04/2019 - Retro DOS v4.0
 35380                                  	; 01/01/2023
 35381 00002C96 A0[241F]                	mov	al,[UmbLoad]
 35382                                  
 35383 00002C99 3CFF                    	cmp	al,UNSPECIFIED	; If they didn't,
 35384 00002C9B 7420                    	je	short husX	; then we shouldn't do this loop:
 35385                                  
 35386 00002C9D 31C9                    	xor	cx,cx
 35387                                  
 35388                                  ; -----------------------------------------------
 35389                                  ; HUS10-CX - UMB number (after inc, 1==first UMB)
 35390                                  ; -----------------------------------------------
 35391                                  
 35392 00002C9F 41                      hus10:	inc	cx		; For each UMB:
 35393                                  	; 01/01/2023
 35394 00002CA0 80F910                  	cmp	cl,MAXUMB
 35395                                  	;cmp	cx,MAXUMB ; 16
 35396 00002CA3 730E                    	jae	short hus20
 35397                                  
 35398 00002CA5 88C8                    	mov	al,cl		; (stopping as soon as we're outside of the
 35399 00002CA7 06                      	push	es
 35400 00002CA8 E8A200                  	call	findUMB		; valid range of UMBs)
 35401 00002CAB 07                      	pop	es		; push/pop: trash what findumb finds. :-)
 35402 00002CAC 7205                    	jc	short hus20
 35403                                  	
 35404                                  	; 02/01/2023
 35405                                  	;push	cx ; *
 35406 00002CAE E84F01                  	call	_hideUMB_	; hide what we need to hide.
 35407                                  	;pop	cx ; *
 35408                                  
 35409 00002CB1 EBEC                    	jmp	short hus10
 35410                                  hus20:	
 35411                                  	;call	GetLoadUMB	; Now check if they offered /L:0
 35412                                  	; 01/01/2023
 35413                                  	; ds = cs
 35414                                  	;mov	al,[UmbLoad]
 35415                                  	;;mov	al,[cs:UmbLoad] ; 09/04/2019 - Retro DOS v4.0	
 35416 00002CB3 800E[241F]00            	or	byte [UmbLoad],0
 35417                                  	;or	al,al		; --Is the load UMB 0? (-1==unspecified)
 35418 00002CB8 7503                    	jnz	short husX	; If not, we're done.
 35419                                  
 35420 00002CBA E86802                  	call	hl_unlink	; If so, however, fix UMBs and strategy.
 35421                                  husX:	
 35422 00002CBD 07                      	pop	es
 35423                                  	; 01/01/2023
 35424                                  	;pop	ds
 35425                                  	;pop	cx
 35426                                  	;pop	ax
 35427 00002CBE C3                      	retn
 35428                                  
 35429                                  ; -----------------------------------------------------------------------------
 35430                                  ;*** GetLoadUMB - Returns the load UMB number in AL (-1 if not specified)
 35431                                  ; -----------------------------------------------------------------------------
 35432                                  ; ENTRY:  None
 35433                                  ; EXIT:   AL == load UMB
 35434                                  ; ERROR:  None
 35435                                  ; USES:   Flags, AX
 35436                                  ; -----------------------------------------------------------------------------
 35437                                  
 35438                                  ;GetLoadUMB:
 35439                                  ;	;getdata al, UmbLoad
 35440                                  ;	push	ds
 35441                                  ;	push	cs
 35442                                  ;	pop	ds
 35443                                  ;	mov	al,[UmLoad]
 35444                                  ;	pop	ds
 35445                                  ;	retn
 35446                                  
 35447                                  ; -----------------------------------------------------------------------------
 35448                                  ;*** GetLoadSize - Returns the load UMB minimum size (0 if not specified)
 35449                                  ; -----------------------------------------------------------------------------
 35450                                  ; ENTRY:  None
 35451                                  ; EXIT:   AX == load UMB minimum size
 35452                                  ; ERROR:  None
 35453                                  ; USES:   Flags, AX
 35454                                  ; -----------------------------------------------------------------------------
 35455                                  
 35456                                  ; 08/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 35457                                  %if 0
 35458                                  	; 01/01/2023 - Retro DOS v4.2
 35459                                  GetLoadSize:
 35460                                  	; 09/04/2019 - Retro DOS v4.0
 35461                                  	;mov	al,[cs:UmbLoad]
 35462                                  	; 01/01/2023
 35463                                  	; ds = cs
 35464                                  	mov	al,[UmbLoad] 
 35465                                  	;jmp	short GetSize
 35466                                  
 35467                                  	;push	bx
 35468                                  	;;push	si
 35469                                  	;push	ds
 35470                                  	;push	cs
 35471                                  	;pop	ds
 35472                                  
 35473                                  	;mov	al,[UmbLoad]
 35474                                  
 35475                                  	;xor	ah,ah			;    ax==UMB
 35476                                  	;mov	bx,UmbSize		;    bx==array
 35477                                  	;shl	al,1	                ;    ax==offset
 35478                                  	;;add	ax,bx			;    ax==element index
 35479                                  	;;mov	si,ax			; ds:si==element index
 35480                                  
 35481                                  	;;lodsw				;    hh
 35482                                  
 35483                                  	;add	bx,ax
 35484                                  	;mov	ax,[bx]
 35485                                  
 35486                                  	;pop	ds
 35487                                  	;;pop	si
 35488                                  	;pop	bx
 35489                                  	;retn
 35490                                  %endif
 35491                                  
 35492                                  ; -----------------------------------------------------------------------------
 35493                                  ;*** GetSize - Returns the UMB in AL's minimum size (0 if not specified)
 35494                                  ; -----------------------------------------------------------------------------
 35495                                  ; ENTRY:  AL == a UMB number
 35496                                  ; EXIT:   AX == UMB minimum size, as specified by the user
 35497                                  ; ERROR:  None
 35498                                  ; USES:   Flags, AX
 35499                                  ; -----------------------------------------------------------------------------
 35500                                  
 35501                                  ; 08/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 35502                                  GetLoadSize:
 35503                                  	; ds = cs
 35504                                  	;mov	al,[UmbLoad]
 35505                                  	; al = [UmbLoad] 
 35506                                  	; ....
 35507                                  
 35508                                  	; 01/01/2023 - Retro DOS v4.2
 35509                                  GetSize:
 35510                                  	; 09/04/2019 - Retro DOS v4.0
 35511                                  
 35512                                  	;push	bx ; 01/01/2023
 35513                                  	;push	si
 35514                                  	;push	ds
 35515                                  	;push	cs
 35516                                  	;pop	ds
 35517                                  
 35518 00002CBF 30E4                    	xor	ah,ah			;    ax==UMB
 35519 00002CC1 BB[351F]                	mov	bx,UmbSize		;    bx==array
 35520 00002CC4 D0E0                    	shl	al,1	                ;    ax==offset
 35521                                  	;add	ax,bx			;    ax==element index
 35522                                  	;mov	si,ax			; ds:si==element index
 35523                                  
 35524                                  	;lodsw				;    ax==size
 35525                                  
 35526 00002CC6 01C3                    	add	bx,ax
 35527                                  	; 01/01/2023
 35528                                  	; ds = cs
 35529 00002CC8 8B07                    	mov	ax,[bx]
 35530                                  	;mov	ax,[cs:bx]
 35531                                  
 35532                                  	;pop	ds
 35533                                  	;pop	si
 35534                                  	;pop	bx ; 01/01/2023
 35535                                  sls10:	; 08/09/2023
 35536 00002CCA C3                      	retn
 35537                                  
 35538                                  ; -----------------------------------------------------------------------------
 35539                                  ;*** StoLoadUMB - Overrides the load UMB number with what's in AL
 35540                                  ; -----------------------------------------------------------------------------
 35541                                  ; ENTRY:   AL == new load UMB
 35542                                  ; EXIT:    None
 35543                                  ; ERROR:   None
 35544                                  ; USES:    Flags, AX
 35545                                  ; -----------------------------------------------------------------------------
 35546                                  ; CAUTION: Should only be used if /L:... was used. Logically, that is the only
 35547                                  ;          time you would ever need this, so that's okay.
 35548                                  ; -----------------------------------------------------------------------------
 35549                                  
 35550                                  ; StoLoadUMB subroutine is not used anywhere
 35551                                  ; of PCDOS 7.1 IBMBIO.COM (& MSDOS 6.21 IO.SYS)
 35552                                  ; Erdogan Tan - 18/07/2023
 35553                                  
 35554                                  ;StoLoadUMB:
 35555                                  ;	;putdata UmbLoad, al
 35556                                  ;	push	es
 35557                                  ;	push	cs
 35558                                  ;	pop	es		; mov [cs:UmbLoad], al !!!! ; 08/09/2023
 35559                                  ;	mov	[es:UmbLoad],al
 35560                                  ;	pop	es
 35561                                  ;	retn
 35562                                  
 35563                                  ; -----------------------------------------------------------------------------
 35564                                  ;*** StoLoadSize - Overrides the load UMB minimum size with what's in AX
 35565                                  ; -----------------------------------------------------------------------------
 35566                                  ; ENTRY:  AL == new load size
 35567                                  ; EXIT:   None
 35568                                  ; ERROR:  None
 35569                                  ; USES:   Flags, AX
 35570                                  ; -----------------------------------------------------------------------------
 35571                                  	; 08/09/2023 - Retro DOS v4.2 IO.SYS (Optimization) 
 35572                                  	; 01/01/2023 - Retro DOS v4.2
 35573                                  StoLoadSize:
 35574                                  	; 01/01/2023
 35575                                  	;push	dx
 35576                                  
 35577                                  	;getdata dl, UmbLoad		; Put UMB# in DL and size in AX
 35578                                  	;
 35579                                  	;push	ds
 35580                                  	;push	cs
 35581                                  	;pop	ds
 35582                                  	;mov	dl,[UmbLoad]
 35583                                  	;pop	ds	
 35584                                  
 35585                                  	; 08/09/2023
 35586                                  	; MSDOS 6.21 IO.SYS - SYSINIT:32B6h
 35587                                  	; PCDOS 7.1 IBMBIO.COM - SYSINIT:3831h
 35588                                  
 35589                                  	;;mov	dl,[UmbLoad]		; BUG ! CL would/must be used here
 35590                                  					; instead of DL (*) ; 18/07/2023
 35591                                  	;mov	dl,[cs:UmbLoad] ; Retro DOS v4.0, v4.1, v4.2
 35592                                  	;cmp	dl,UNSPECIFIED ; 0FFh
 35593                                  	;je	short sls10
 35594                                  			
 35595                                  		; BUG ! stowSiz uses CL instead of DL !
 35596                                  		; (CL is set in ParseL which calls stowSiz)
 35597                                  		; (This BUG existing in PCDOS 7.1 IBMBIO.COM also)
 35598                                  		; Erdogan Tan - 18/07/2023
 35599                                  
 35600                                  	; 08/09/2023 (BugFix)
 35601                                  	;mov	cl,[cs:UmbLoad]
 35602                                  	; 08/09/2023 
 35603                                  	; ds = cs
 35604 00002CCB 8A0E[241F]              	mov	cl,[UmbLoad]
 35605 00002CCF 80F9FF                  	cmp	cl,UNSPECIFIED ; 0FFh
 35606 00002CD2 74F6                    	je	short sls10
 35607                                  
 35608                                  	; 08/09/2023
 35609                                  ;	call	stowSiz			; We've got a function to do just this
 35610                                  ;sls10:	
 35611                                  ;	; 01/01/2023
 35612                                  ;	;pop	dx
 35613                                  ;	retn
 35614                                  	
 35615                                  	; 08/09/2023
 35616                                  	;;jmp	stowSiz
 35617                                  	;jmp	short stowSiz
 35618                                  
 35619                                  ; 08/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 35620                                  %if 1
 35621                                  ; -----------------------------------------------------------------------------
 35622                                  ;*** stowSiz - marks a given UMB as having a given minimum size
 35623                                  ; -----------------------------------------------------------------------------
 35624                                  ; ENTRY:    CL contains UMB number, AX contains size
 35625                                  ; EXIT:     None
 35626                                  ; ERROR:    None
 35627                                  ; USES:     AX, DX, Flags, variables in highvar.inc
 35628                                  ; -----------------------------------------------------------------------------
 35629                                  
 35630                                  ; 13/05/2019
 35631                                  
 35632                                  	; 01/01/2023 - Retro DOS v4.2
 35633                                  stowSiz:
 35634                                  	; 01/01/2023
 35635                                  	;push	bx
 35636                                  	;;push	di ; ?
 35637                                  	;push	es
 35638                                  
 35639                                  	;push	cs
 35640                                  	;pop	es	
 35641                                  
 35642 00002CD4 88CB                    	mov	bl,cl			; Now bl==UMB number, AX==size
 35643 00002CD6 B700                    	mov	bh,0			;     bx==UMB number, AX==size
 35644 00002CD8 D0E3                    	shl	bl,1			;     bx==offset into array, AX=size
 35645                                  	;mov	[es:bx+UmbSize],ax	; Store the size
 35646                                  	; 01/01/2023
 35647 00002CDA 2E8987[351F]            	mov	[cs:bx+UmbSize],ax	; Store the size
 35648                                  
 35649                                  	; 01/01/2023
 35650                                  	;pop	es
 35651                                  	;;pop	di ; ?
 35652                                  	;pop	bx
 35653                                  
 35654 00002CDF C3                      	retn
 35655                                  %endif
 35656                                  
 35657                                  ; -----------------------------------------------------------------------------
 35658                                  ;*** hideUMB - marks as HIDDEN all FREE elements in UMB passed as AL
 35659                                  ; -----------------------------------------------------------------------------
 35660                                  ; ENTRY:    AL must indicate a valid UMB; 0==conv && is invalid.
 35661                                  ; EXIT:     None; free elements in UMB marked as hidden
 35662                                  ; ERROR:    None
 35663                                  ; USES:     Flags
 35664                                  ; -----------------------------------------------------------------------------
 35665                                  
 35666                                  	; 01/01/2023 - Retro DOS v4.2
 35667                                  hideUMB:
 35668                                  	; 02/01/2023
 35669 00002CE0 52                      	push	dx ; (*)
 35670                                  	; 01/01/2023
 35671                                  	;push	ax
 35672 00002CE1 06                      	push	es
 35673                                  
 35674 00002CE2 E86800                  	call	findUMB	; (*)	; Returns with carry if err, else ES == MCB
 35675 00002CE5 7224                    	jc	short huX
 35676                                  
 35677                                  ; ------------------------------------------------
 35678                                  ; HU10--ES - MCB inside UMB; if it's a system MCB,
 35679                                  ;            we're not in the same UMB, so exit.
 35680                                  ; ------------------------------------------------
 35681                                  
 35682 00002CE7 E84AFF                  hu10:	call	isSysMCB	; Returns with ZF set if owner is SYSTEM
 35683 00002CEA 741F                    	jz	short huX	; If it is, we've finished the UMB.
 35684                                  	;call	isFreeMCB	; Returns with ZF set if owner is 0
 35685 00002CEC 26830E010000            	or	word [es:ARENA.OWNER],0
 35686 00002CF2 7503                    	jnz	short hu20
 35687                                  
 35688 00002CF4 E81700                  	call	hideMCB
 35689                                  hu20:	
 35690                                  	;mov	al,[es:ARENA.SIGNATURE]
 35691                                  	;cmp	al,arena_signature_end  ;'Z'
 35692                                  	; 19/07/2023
 35693 00002CF7 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],'Z'
 35694 00002CFD 740C                    	jz	short huX	; 'Z' means this was the last MCB... that's it.
 35695                                  
 35696                                  	;NextMCB es,ax		; Go on forward.
 35697 00002CFF 8CC0                    	mov     ax,es
 35698                                  	;add	ax,[es:3]
 35699 00002D01 2603060300              	add     ax,[es:ARENA.SIZE]
 35700 00002D06 40                      	inc     ax
 35701 00002D07 8EC0                    	mov     es,ax
 35702                                  
 35703 00002D09 EBDC                    	jmp	short hu10
 35704                                  huX:	
 35705 00002D0B 07                      	pop	es
 35706                                  	; 01/01/2023
 35707                                  	;pop	ax
 35708                                  	; 02/01/2023
 35709 00002D0C 5A                      	pop	dx ; (*)
 35710 00002D0D C3                      	retn
 35711                                  
 35712                                  ; 02/01/2023
 35713                                  %if 0
 35714                                  
 35715                                  ; -----------------------------------------------------------------------------
 35716                                  ;*** isTiny - returns with ZF set if user didn't specify /S
 35717                                  ; -----------------------------------------------------------------------------
 35718                                  ; ENTRY:    None
 35719                                  ; EXIT:     ZF set if user DIDN'T specify /S
 35720                                  ; ERROR:    None
 35721                                  ; USES:     Flags
 35722                                  ; -----------------------------------------------------------------------------
 35723                                  
 35724                                  	; 02/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 35725                                  isTiny:
 35726                                  	; 02/01/2023
 35727                                  	;push	ax
 35728                                  
 35729                                  	;getdata al,fUmbTiny
 35730                                  	;
 35731                                  	;push	ds
 35732                                  	;push	cs
 35733                                  	;pop	ds
 35734                                  	;mov	al,[fUmbTiny]
 35735                                  	;pop	ds
 35736                                  
 35737                                  	; 09/09/2023
 35738                                  	;mov	al,[cs:fUmbTiny]
 35739                                  	; 02/01/2023
 35740                                  	; ds = cs
 35741                                  	mov	al,[fUmbTiny]
 35742                                  
 35743                                  	or	al,al
 35744                                  	; 02/01/2023
 35745                                  	;pop	ax
 35746                                  	retn
 35747                                  
 35748                                  %endif
 35749                                  
 35750                                  ; -----------------------------------------------------------------------------
 35751                                  ;*** isFreeMCB - returns with ZF set if current MCB (ES:0) is FREE
 35752                                  ; -----------------------------------------------------------------------------
 35753                                  ; ENTRY:    ES:0 should point to an MCB
 35754                                  ; EXIT:     ZF set if MCB is free, else !ZF
 35755                                  ; ERROR:    None
 35756                                  ; USES:     Flags
 35757                                  ; -----------------------------------------------------------------------------
 35758                                  
 35759                                  ;isFreeMCB:
 35760                                  ;	or	word [es:ARENA.OWNER],0
 35761                                  ;	retn
 35762                                  
 35763                                  ; -----------------------------------------------------------------------------
 35764                                  ;*** hideMCB - marks as HIDDEN the MCB at ES:0
 35765                                  ; -----------------------------------------------------------------------------
 35766                                  ; ENTRY:    ES:0 should point to an MCB
 35767                                  ; EXIT:     None; MCB marked as HIDDEN
 35768                                  ; ERROR:    None
 35769                                  ; USES:     None
 35770                                  ; -----------------------------------------------------------------------------
 35771                                  
 35772                                  hideMCB:
 35773 00002D0E 26C70601000800          	mov	word [es:ARENA.OWNER],SystemPSPOwner ; 8
 35774 00002D15 26C70608004849          	mov	word [es:ARENA.NAME+0], 'HI' ; 4948h
 35775 00002D1C 26C7060A004444          	mov	word [es:ARENA.NAME+2], 'DD' ; 4444h
 35776 00002D23 26C7060C00454E          	mov	word [es:ARENA.NAME+4], 'EN' ; 4E45h
 35777 00002D2A 26C7060E002020          	mov	word [es:ARENA.NAME+6], '  ' ; 2020h	
 35778 00002D31 C3                      	retn
 35779                                  
 35780                                  ; -----------------------------------------------------------------------------
 35781                                  ;*** unHideMCB - marks as FREE the MCB at ES:0
 35782                                  ; -----------------------------------------------------------------------------
 35783                                  ; ENTRY:    ES:0 should point to an MCB
 35784                                  ; EXIT:     None; MCB marked as FREE
 35785                                  ; ERROR:    None
 35786                                  ; USES:     None
 35787                                  ; -----------------------------------------------------------------------------
 35788                                  
 35789                                  	; 03/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 35790                                  
 35791                                  unHideMCB:
 35792                                  	; 03/01/2023
 35793                                  	;push	ax
 35794 00002D32 26C70601000000          	mov	word [es:ARENA.OWNER],FreePSPOwner ; 0
 35795 00002D39 B82020                  	mov	ax,'  ' ; 2020h
 35796 00002D3C 26A30800                	mov	[es:ARENA.NAME+0],ax
 35797 00002D40 26A30A00                	mov	[es:ARENA.NAME+2],ax
 35798 00002D44 26A30C00                	mov	[es:ARENA.NAME+4],ax
 35799 00002D48 26A30E00                	mov	[es:ARENA.NAME+6],ax
 35800                                  	; 03/01/2023
 35801                                  	;pop	ax
 35802 00002D4C C3                      	retn
 35803                                  
 35804                                  ; -----------------------------------------------------------------------------
 35805                                  ;*** findUMB - makes ES:0 point to the first MCB in UMB given as AL
 35806                                  ;            -- returns UmbHEAD pointer (0x9FFF) if passed AL==0
 35807                                  ; -----------------------------------------------------------------------------
 35808                                  ; ENTRY:    AL should be to a valid UMB number
 35809                                  ; EXIT:     ES:0 points to first MCB in UMB (_not_ the 8+SC MCB that heads it)
 35810                                  ; ERROR:    Carry set if couldn't reach UMB (too high)
 35811                                  ; USES:     Flags, ES
 35812                                  ; -----------------------------------------------------------------------------
 35813                                  
 35814                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 35815                                  	; (SYSINIT:3344h)
 35816                                  findUMB:
 35817                                  	; 01/01/2023
 35818                                  	;push	ax
 35819                                  	; 02/01/2023
 35820 00002D4D 51                      	push	cx ; *
 35821                                  	;push	dx
 35822                                  
 35823 00002D4E 30E4                    	xor	ah,ah		; Zap ah, so al==ax
 35824                                  
 35825 00002D50 89C2                    	mov	dx,ax		; Store the to-be-found UMB number in DX
 35826                                  
 35827 00002D52 E8D2FE                  	call	UmbHead		; Returns first UMB segment in AX
 35828                                  	; 22/07/2023
 35829                                  	;mov	es,ax ; *
 35830 00002D55 31C9                    	xor	cx,cx		; Pretend we're on UMB 0 for now...
 35831                                  
 35832                                  	; 22/07/2023
 35833                                  fu10:
 35834 00002D57 8EC0                    	mov	es,ax ; * ; **
 35835                                  ; ---------------------------------------------
 35836                                  ; FU10--CX - This UMB number; 0 == conventional
 35837                                  ;       DX - The UMB number they're looking for
 35838                                  ;       ES - The current MCB address
 35839                                  ; ---------------------------------------------
 35840                                  
 35841                                  ;fu10:	
 35842 00002D59 39D1                    	cmp	cx,dx		; If CX==DX, we've found the UMB we're
 35843 00002D5B 7417                    	je	short fuX	; searching for--so exit.
 35844                                  
 35845 00002D5D E8D4FE                  	call	isSysMCB	; Returns with ZF set if owner is SYSTEM
 35846 00002D60 7501                    	jnz	short fu20
 35847                                  
 35848 00002D62 41                      	inc	cx		; If it _was_ SYSTEM, we're in a new UMB.
 35849                                  fu20:	
 35850                                  	;mov	al,[es:ARENA.SIGNATURE]
 35851                                  	;cmp	al,arena_signature_end ; 'Z'
 35852                                  	; 19/07/2023
 35853 00002D63 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],arena_signature_end 
 35854 00002D69 7408                    	je	short fuE	; 'Z' means this was the last MCB... that's it.
 35855                                  
 35856                                  	;NextMCB es,ax		; Go on forward.
 35857                                  	; 22/07/2023
 35858                                  	; ax = es
 35859                                  	;mov	ax,es ; * ; 22/07/2023
 35860                                  	;add	ax,[es:3]
 35861 00002D6B 2603060300              	add	ax,[es:ARENA.SIZE]
 35862 00002D70 40                      	inc	ax
 35863                                  	; 22/07/2023
 35864                                  	;mov	es,ax ; **
 35865 00002D71 EBE4                    	jmp	short fu10
 35866                                  fuE:	
 35867 00002D73 F9                      	stc
 35868                                  fuX:
 35869                                  	; 01/01/2023
 35870                                  	;pop	dx
 35871                                  	; 02/01/2023
 35872 00002D74 59                      	pop	cx ; *
 35873                                  	;pop	ax		; The address is already in ES.
 35874 00002D75 C3                      	retn
 35875                                  
 35876                                  ; -----------------------------------------------------------------------------
 35877                                  ;*** BigFree - makes ES:0 point to the largest free MCB in UMB given as AL
 35878                                  ; -----------------------------------------------------------------------------
 35879                                  ; ENTRY:    AL should be to a valid UMB number
 35880                                  ; EXIT:     ES:0 points to largest free MCB in UMB, AX returns its size
 35881                                  ; ERROR:    Carry set if couldn't reach UMB (0 or too high)
 35882                                  ; USES:     Flags, ES
 35883                                  ; -----------------------------------------------------------------------------
 35884                                  
 35885                                  	; 01/01/2023 - Retro DOS v4.2
 35886                                  BigFree:
 35887                                  	; 01/01/2023
 35888                                  	;push	bx
 35889 00002D76 51                      	push	cx
 35890                                  
 35891 00002D77 E8D3FF                  	call	findUMB			; Returns with CF if err, else ES==MCB
 35892 00002D7A 723A                    	jc	short bfX
 35893                                  
 35894 00002D7C 31DB                    	xor	bx,bx			; Segment address of largest free MCB
 35895 00002D7E 31C9                    	xor	cx,cx			; Size of largest free MCB
 35896                                  
 35897                                  ; ---------------------------------------------
 35898                                  ; BF10--ES - Current MCB address
 35899                                  ;       BX - Address of largest free MCB so far
 35900                                  ;       CX - Size of largest free MCB so far
 35901                                  ; ---------------------------------------------
 35902                                  
 35903                                  bf10:	
 35904 00002D80 E8B1FE                  	call	isSysMCB		; If we've left the MCB, we're done.
 35905 00002D83 7428                    	jz	short bf30
 35906                                  
 35907                                  	;call	isFreeMCB		; Returns with ZF set if owner is 0
 35908 00002D85 26830E010000            	or	word [es:ARENA.OWNER],0
 35909 00002D8B 750C                    	jnz	short bf20
 35910                                  
 35911 00002D8D 26A10300                	mov	ax,[es:ARENA.SIZE]
 35912                                  	;cmp	cx,[es:ARENA.SIZE]	; Compare sizes...
 35913 00002D91 39C1                    	cmp	cx,ax
 35914                                  	;jg	short bf20		; Unless we're bigger,
 35915                                  	; 19/07/2023
 35916 00002D93 7D04                    	jge	short bf20
 35917                                  
 35918 00002D95 8CC3                    	mov	bx,es			; Store this new element's address,
 35919                                  	;mov	cx,[es:ARENA.SIZE]	; and its size.
 35920 00002D97 89C1                    	mov	cx,ax
 35921                                  bf20:	
 35922                                  	;mov	al,[es:ARENA.SIGNATURE]
 35923                                  	;cmp	al,arena_signature_end	; 'Z'
 35924                                  	; 19/07/2023
 35925                                  	;cmp	byte [es:0],'Z'
 35926 00002D99 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],arena_signature_end
 35927 00002D9F 740C                    	jz	short bf30		; 'Z' means this was the last MCB.
 35928                                  
 35929                                  	;NextMCB es,ax			; Go on forward.
 35930 00002DA1 8CC0                    	mov     ax,es
 35931                                  	;add	ax,[es:3]
 35932 00002DA3 2603060300              	add     ax,[es:ARENA.SIZE]
 35933 00002DA8 40                      	inc     ax
 35934 00002DA9 8EC0                    	mov     es,ax
 35935                                  
 35936 00002DAB EBD3                    	jmp	short bf10
 35937                                  
 35938 00002DAD 8EC3                    bf30:	mov	es,bx			; Return the address
 35939 00002DAF 89C8                    	mov	ax,cx			; Return the size
 35940 00002DB1 09DB                    	or	bx,bx
 35941 00002DB3 7501                    	jnz	short bfX
 35942                                  bfE:	
 35943 00002DB5 F9                      	stc				; (if size==0, there's nothing free)
 35944                                  bfX:
 35945 00002DB6 59                      	pop	cx
 35946                                  	; 01/01/2023
 35947                                  	;pop	bx
 35948 00002DB7 C3                      	retn
 35949                                  
 35950                                  ; -----------------------------------------------------------------------------
 35951                                  ;*** isSpecified - sets ZF if UMB in AL wasn't specified in DH/LH line.
 35952                                  ; -----------------------------------------------------------------------------
 35953                                  ; ENTRY:    AL should be to a valid UMB number
 35954                                  ; EXIT:     ZF set if UMB wasn't specified, ZF clear if it was
 35955                                  ; ERROR:    None
 35956                                  ; USES:     Flags
 35957                                  ; -----------------------------------------------------------------------------
 35958                                  
 35959                                  	; 02/01/2023 - Retro DOS v4.2
 35960                                  
 35961                                  isSpecified:
 35962                                  	; 02/01/2023
 35963                                  	;push	ax
 35964                                  
 35965 00002DB8 30FF                    	xor	bh,bh
 35966 00002DBA 88C3                    	mov	bl,al
 35967                                  
 35968                                  	;getdata al,DS:UmbUsed[bx]
 35969                                  	;
 35970                                  	;push	ds
 35971                                  	;push	cs
 35972                                  	;pop	ds
 35973                                  	;mov	al,[bx+UmbUsed]
 35974                                  	;pop	ds
 35975                                  	
 35976                                  	;mov	al,[cs:bx+UmbUsed]
 35977                                  	; 02/01/2023
 35978                                  	; ds = cs
 35979 00002DBC 8A87[251F]              	mov	al,[bx+UmbUsed]
 35980                                  
 35981 00002DC0 08C0                    	or	al,al			; Sets ZF if al==0 (ie, if unspecified)
 35982                                  
 35983                                  	; 09/09/2023
 35984                                  	; 02/01/2023
 35985                                  	;pop	ax
 35986                                  
 35987 00002DC2 C3                      	retn
 35988                                  
 35989                                  ; -----------------------------------------------------------------------------
 35990                                  ;*** shrinkMCB - breaks an MCB into two pieces, the lowest one's size==AX
 35991                                  ; -----------------------------------------------------------------------------
 35992                                  ; ENTRY:    AX == new size, ES:0 == current MCB
 35993                                  ; EXIT:     None; MCB broken if carry clear
 35994                                  ; ERROR:    Carry set if MCB isn't as large as AX+0x20 (not a useful split)
 35995                                  ; USES:     Flags
 35996                                  ; -----------------------------------------------------------------------------
 35997                                  ; If the size of the to-be-split MCB isn't at least 0x20 bytes greater than
 35998                                  ; the specified new size, the split is useless; if it's only 0x10 bytes, that
 35999                                  ; 0x10 will be used to make a header that mentions a 0-byte free space, and
 36000                                  ; that just sucks up 0x10 bytes for nothing. So we make 0x20 bytes the
 36001                                  ; minimum for performing a split.
 36002                                  ; -----------------------------------------------------------------------------
 36003                                  
 36004                                  MIN_SPLIT_SIZE	equ 20h
 36005                                  
 36006                                  	; 02/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 36007                                  
 36008                                  shrinkMCB:
 36009                                  	;pushreg <bx,cx,es>
 36010                                  	; 02/01/2023
 36011                                  	;push	bx
 36012 00002DC3 51                      	push	cx
 36013 00002DC4 06                      	push	es
 36014                                  
 36015 00002DC5 89C3                    	mov	bx,ax			; Move things around... and
 36016                                  	; 02/01/2023
 36017                                  	;mov	ax,es			; save this one for later.
 36018                                  
 36019 00002DC7 268B0E0300              	mov	cx,[es:ARENA.SIZE]
 36020                                  	; 02/01/2023
 36021 00002DCC 89C8                    	mov	ax,cx 
 36022                                  
 36023 00002DCE 83E820                  	sub	ax,MIN_SPLIT_SIZE ; 32
 36024                                  	;sub	cx,MIN_SPLIT_SIZE ; 32
 36025                                  	;;cmp	bx,cx			; {New size} vs {Current Size-20h}
 36026                                  	;ja	short smE		; if wanted_size > cur-20h, abort.
 36027                                  	; 18/12/2022
 36028                                  	;cmp	cx,bx
 36029                                  	; 02/01/2023
 36030 00002DD1 39D8                    	cmp	ax,bx
 36031 00002DD3 7228                    	jb	short smE ; (*)
 36032                                  
 36033 00002DD5 268A160000              	mov	dl,[es:ARENA.SIGNATURE]
 36034                                  	
 36035                                  	;mov	cx,[es:ARENA.SIZE]
 36036                                  	; 02/01/2023
 36037 00002DDA 8CC0                    	mov	ax,es
 36038                                  
 36039 00002DDC 26891E0300              	mov	[es:ARENA.SIZE],bx
 36040 00002DE1 26C60600004D            	mov	byte [es:ARENA.SIGNATURE],'M'
 36041                                  
 36042 00002DE7 01D8                    	add	ax,bx
 36043 00002DE9 40                      	inc	ax
 36044 00002DEA 8EC0                    	mov	es,ax			; Move to new arena area
 36045                                  
 36046 00002DEC 89C8                    	mov	ax,cx
 36047 00002DEE 29D8                    	sub	ax,bx
 36048                                  	; 12/12/2022
 36049                                  	; ax > 0
 36050 00002DF0 48                      	dec	ax			; And prepare the new size
 36051                                  
 36052                                  	; 18/12/2022
 36053 00002DF1 2688160000              	mov	[es:ARENA.SIGNATURE],dl
 36054                                  	;mov	word [es:ARENA.OWNER],0 ; (**)
 36055 00002DF6 26A30300                	mov	[es:ARENA.SIZE],ax
 36056                                  	;mov	ax,'  ' ; 2020h
 36057                                  	;mov	[es:ARENA.NAME+0],ax ; (**)
 36058                                  	;mov	[es:ARENA.NAME+2],ax ; (**)
 36059                                  	;mov	[es:ARENA.NAME+4],ax ; (**)
 36060                                  	;mov	[es:ARENA.NAME+6],ax ; (**)
 36061                                  
 36062                                  	; 18/12/2022
 36063 00002DFA E8A801                  	call	freeMCB	; (**)
 36064                                  
 36065                                  	; 12/12/2022
 36066                                  	; cf=0
 36067                                  	;clc
 36068                                  	; 18/12/2022
 36069                                  	;jmp	short smX
 36070                                  smE:	
 36071                                  	; 18/12/2022
 36072                                  	; cf=1 (*)
 36073                                  	;stc
 36074                                  smX:	
 36075                                  	;popreg	<es,cx,bx>
 36076 00002DFD 07                      	pop	es
 36077 00002DFE 59                      	pop	cx
 36078                                  	; 02/01/2023
 36079                                  	;pop	bx
 36080 00002DFF C3                      	retn
 36081                                  
 36082                                  ; -----------------------------------------------------------------------------
 36083                                  ;*** hideUMB? - hides as appropriate the UMB in CL
 36084                                  ; -----------------------------------------------------------------------------
 36085                                  ; ENTRY:    CL should be to a valid UMB number, and AX to its address (findUMB)
 36086                                  ; EXIT:     None; UMB is hidden as necessary
 36087                                  ; ERROR:    None
 36088                                  ; USES:     Flags, AX, CX
 36089                                  ; -----------------------------------------------------------------------------
 36090                                  ; PRIMARY LOGIC:
 36091                                  ;
 36092                                  ; If the UMB is specified in the DH/LH statement, then:
 36093                                  ;    If the largest free segment is too small (check specified size), then:
 36094                                  ;       Pretend it wasn't ever specified, and fall out of this IF.
 36095                                  ;    Else, if largest free segment is LARGER than specified size, then:
 36096                                  ;       If /S was given on the command-line, then:
 36097                                  ;          Break that element into two pieces
 36098                                  ;          Set a flag that we're shrinking
 36099                                  ;       Endif
 36100                                  ;    Endif
 36101                                  ; Endif
 36102                                  ; If the UMB is NOT specified (or was removed by the above):
 36103                                  ;    Hide all free elements in the UMB
 36104                                  ;    If the flag that we're shrinking was set, then:
 36105                                  ;       UN-hide the lower portion of the shrunken UMB
 36106                                  ;    ENDIF
 36107                                  ; ENDIF
 36108                                  ; -----------------------------------------------------------------------------
 36109                                  
 36110                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 36111                                  	; (SYSINIT:3426h)
 36112                                  _hideUMB_:
 36113                                  	; 02/01/2023
 36114                                  	; ds = cs
 36115                                  
 36116                                  	; 01/01/2023
 36117                                  	;push	bx
 36118                                  	;push	dx
 36119 00002E00 06                      	push	es
 36120                                  
 36121 00002E01 88C8                    	mov	al,cl
 36122 00002E03 E8B2FF                  	call	isSpecified	; Returns ZF set if al's umb was NOT specified
 36123 00002E06 742D                    	jz	short hu_20
 36124                                  
 36125 00002E08 88C8                    	mov	al,cl		; Retrieve the size of the largest
 36126 00002E0A E869FF                  	call	BigFree		; free element in AX; put its address in ES
 36127 00002E0D 7226                    	jc	short hu_20	; Oops. Errors mean skip this part.
 36128                                  
 36129 00002E0F 50                      	push	ax		; TOS==size of BigFree in UMB (popped as BX)
 36130 00002E10 88C8                    	mov	al,cl		; Retrieve the user's specified
 36131 00002E12 E8AAFE                  	call	GetSize		; minimum size for this umb (into AX)
 36132 00002E15 5B                      	pop	bx		; Now BX==BigFree, AX==Specified Size
 36133                                  
 36134 00002E16 09C0                    	or	ax,ax		; If they didn't specify one,
 36135 00002E18 741B                    	jz	short hu_20	; Skip over all this.
 36136                                  
 36137 00002E1A 39D8                    	cmp	ax,bx		; Ah... if (specified > max free)
 36138 00002E1C 7607                    	jbe	short hu_10
 36139                                  
 36140 00002E1E 88C8                    	mov	al,cl		;  Then mark that UMB as unused. Nya nya.
 36141 00002E20 E81DFD                  	call	unMarkUMB
 36142 00002E23 EB10                    	jmp	short hu_20
 36143                                  hu_10:	
 36144                                  	;call	isTiny		; Returns ZF clear if user specified /S
 36145                                  	;jz	short hu_20
 36146                                  	; 02/01/2023
 36147                                  ;isTiny:
 36148                                  	;mov	al,[fUmbTiny] ; ds = cs
 36149                                  	;or	al,al
 36150 00002E25 800E[211F]00            	or	byte [fUmbTiny],0
 36151 00002E2A 7409                    	jz	short hu_20
 36152                                  
 36153 00002E2C E894FF                  	call	shrinkMCB	; They specified /S, so shrink the MCB to AX
 36154 00002E2F 7204                    	jc	short hu_20	; Ah... if didn't shrink after all, skip this:
 36155                                  
 36156 00002E31 8CC2                    	mov	dx,es
 36157 00002E33 EB09                    	jmp	short hu_30	; Skip the spec check.. we wanna hide this one.
 36158                                  
 36159 00002E35 89C8                    hu_20:	mov	ax,cx
 36160 00002E37 E87EFF                  	call	isSpecified	; If they specified this UMB, we're done...
 36161 00002E3A 7510                    	jnz	short hu_X	; so leave.
 36162                                  
 36163 00002E3C 31D2                    	xor	dx,dx
 36164                                  hu_30:	
 36165 00002E3E 88C8                    	mov	al,cl
 36166                                  
 36167 00002E40 E89DFE                  	call	hideUMB		; Hides everything in UMB #al
 36168                                  
 36169 00002E43 09D2                    	or	dx,dx		; Did we shrink a UMB? If not, DX==0,
 36170 00002E45 7405                    	jz	short hu_X	; So we should leave.
 36171                                  
 36172 00002E47 8EC2                    	mov	es,dx		; Ah, but if it isn't, DX==the MCB's address;
 36173 00002E49 E8E6FE                  	call	unHideMCB	; Un-hides the lower portion of that MCB.
 36174                                  hu_X:	
 36175 00002E4C 07                      	pop	es
 36176                                  	; 01/01/2023
 36177                                  	;pop	dx
 36178                                  	;pop	bx
 36179 00002E4D C3                      	retn
 36180                                  
 36181                                  ; -----------------------------------------------------------------------------
 36182                                  ;*** UnFreeze - Marks FROZEN elements as FREE
 36183                                  ; -----------------------------------------------------------------------------
 36184                                  ; Entry:  None
 36185                                  ; Exit:   None; all 8+FROZEN elements are marked as FREE, from any UMB.
 36186                                  ; Error:  None
 36187                                  ; Uses:   Flags
 36188                                  ; -----------------------------------------------------------------------------
 36189                                  
 36190                                  	; 03/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 36191                                  UnFreeze:
 36192                                  	; 03/01/2023
 36193                                  	;push	ax
 36194 00002E4E 06                      	push	es
 36195                                  
 36196 00002E4F E8D5FD                  	call	UmbHead		; Returns with carry if err, else ES == MCB
 36197 00002E52 721C                    	jc	short ufX
 36198                                  
 36199                                  	; 22/07/2023
 36200                                  uf10:
 36201 00002E54 8EC0                    	mov	es,ax ; *
 36202                                  
 36203                                  ; ------------------------------
 36204                                  ; UF10--ES - Current MCB address
 36205                                  ; ------------------------------
 36206                                  
 36207                                  ;uf10:	
 36208 00002E56 E81900                  	call	isFrozMCB	; Returns with ZF set if MCB is FROZEN
 36209 00002E59 7505                    	jnz	short uf20
 36210 00002E5B E8D4FE                  	call	unHideMCB
 36211                                  	; 09/09/2023
 36212                                  	; ax <> es
 36213 00002E5E 8CC0                    	mov	ax,es ; *
 36214                                  uf20:	
 36215                                  	;mov	al,[es:ARENA.SIGNATURE]
 36216                                  	;cmp	al,arena_signature_end ; 'Z'
 36217                                  	; 22/07/2023
 36218 00002E60 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],arena_signature_end ; 'Z'
 36219 00002E66 7408                    	jz	short ufX	; 'Z' means this was the last MCB.. that's it.
 36220                                  
 36221                                  	;NextMCB es,ax		; Go on forward.
 36222                                  	; 22/07/2023
 36223                                  	; ax = es
 36224                                  	;mov	ax,es ; *
 36225                                  	;add	ax,[es:3]
 36226 00002E68 2603060300              	add	ax,[es:ARENA.SIZE]
 36227 00002E6D 40                      	inc	ax
 36228                                  	; 22/07/2023
 36229                                  	;mov	es,ax
 36230 00002E6E EBE4                    	jmp	short uf10
 36231                                  ufX:	
 36232 00002E70 07                      	pop	es
 36233                                  	; 03/01/2023
 36234                                  	;pop	ax
 36235 00002E71 C3                      	retn
 36236                                  
 36237                                  ; -----------------------------------------------------------------------------
 36238                                  ;*** isFrozMCB - returns with ZF set if current MCB (ES:0) is FROZEN
 36239                                  ; -----------------------------------------------------------------------------
 36240                                  ; ENTRY:    ES:0 should point to an MCB
 36241                                  ; EXIT:     ZF set if MCB is frozen, else !ZF
 36242                                  ; ERROR:    None
 36243                                  ; USES:     Flags
 36244                                  ; -----------------------------------------------------------------------------
 36245                                  
 36246                                  isFrozMCB:
 36247                                  	;push	ax
 36248                                  
 36249                                  	;mov	ax,[es:ARENA.OWNER]	; Check the owner...
 36250                                  	;cmp	ax,SystemPSPOwner	; 8 (for US OR Japan) is valid
 36251 00002E72 26833E010008            	cmp	word [es:ARENA.OWNER],SystemPSPOwner
 36252 00002E78 7522                    	jne	short ifmX
 36253                                  
 36254                                  	;mov	ax,[es:ARENA.NAME+0]
 36255                                  	;cmp	ax,'FR' ; 5246h
 36256 00002E7A 26813E08004652          	cmp	word [es:ARENA.NAME+0],'FR'
 36257 00002E81 7519                    	jne	short ifmX
 36258                                  	;mov	ax,[es:ARENA.NAME+2]
 36259                                  	;cmp	ax,'OZ' ; 5A4Fh
 36260 00002E83 26813E0A004F5A          	cmp	word [es:ARENA.NAME+2],'OZ'
 36261 00002E8A 7510                    	jne	short ifmX
 36262                                  	;mov	ax,[es:ARENA.NAME+4]
 36263                                  	;cmp	ax,'EN' ; 4E45h
 36264 00002E8C 26813E0C00454E          	cmp	word [es:ARENA.NAME+4],'EN'
 36265 00002E93 7507                    	jne	short ifmX
 36266                                  	;mov	ax,[es:ARENA.NAME+6]
 36267                                  	;cmp	ax,'  ' ; 2020h
 36268 00002E95 26813E0E002020          	cmp	word [es:ARENA.NAME+6],'  '
 36269                                  ifmX:	
 36270                                  	;pop	ax
 36271 00002E9C C3                      	retn
 36272                                  
 36273                                  ; -----------------------------------------------------------------------------
 36274                                  ;*** frezMCB - marks as 8+FROZEN the MCB at ES:0
 36275                                  ; -----------------------------------------------------------------------------
 36276                                  ; ENTRY:    ES:0 should point to an MCB
 36277                                  ; EXIT:     None; MCB frozen
 36278                                  ; ERROR:    None
 36279                                  ; USES:     None
 36280                                  ; -----------------------------------------------------------------------------
 36281                                  
 36282                                  frezMCB:
 36283 00002E9D 26C70601000800          	mov	word [es:ARENA.OWNER],SystemPSPOwner ; 8
 36284 00002EA4 26C70608004652          	mov	word [es:ARENA.NAME+0],'FR'
 36285 00002EAB 26C7060A004F5A          	mov	word [es:ARENA.NAME+2],'OZ'
 36286 00002EB2 26C7060C00454E          	mov	word [es:ARENA.NAME+4],'EN'
 36287 00002EB9 26C7060E002020          	mov	word [es:ARENA.NAME+6],'  '
 36288 00002EC0 C3                      	retn
 36289                                  
 36290                                  ; -----------------------------------------------------------------------------
 36291                                  ;*** FreezeUM - Marks FROZEN all UM elements now FREE, save those in load UMB
 36292                                  ; -----------------------------------------------------------------------------
 36293                                  ; Entry:  None
 36294                                  ; Exit:   None; all free elements not in load UMB marked as 8+FROZEN
 36295                                  ; Error:  None
 36296                                  ; Uses:   Flags
 36297                                  ; -----------------------------------------------------------------------------
 36298                                  
 36299                                  	; 01/01/2023 - Retro DOS v4.2  
 36300                                  FreezeUM:
 36301                                  	; 01/01/2023
 36302                                  	;push	ax
 36303                                  	;push	cx
 36304                                  	;push	dx
 36305 00002EC1 06                      	push	es
 36306                                  
 36307                                  	;;call	GetLoadUMB
 36308                                  	; 01/01/2023
 36309                                  	; ds = cs
 36310                                  	;mov	al,[cs:UmbLoad] ; 19/04/2019 - Retro DOS v4.0
 36311 00002EC2 A0[241F]                	mov	al,[UmbLoad] 	
 36312                                  
 36313 00002EC5 30E4                    	xor	ah,ah		; Zap ah, so al==ax
 36314 00002EC7 89C2                    	mov	dx,ax		; Store the load UMB in DX, so we can skip it
 36315                                  
 36316 00002EC9 E85BFD                  	call	UmbHead		; Returns first UMB segment in AX
 36317                                  	; 22/07/2023
 36318                                  	;mov	es,ax ; *
 36319 00002ECC 31C9                    	xor	cx,cx		; Pretend we're on UMB 0 for now...
 36320                                  
 36321                                  	; 22/07/2023
 36322                                  fum10:
 36323 00002ECE 8EC0                    	mov	es,ax ; *
 36324                                  
 36325                                  ; -----------------------------------------
 36326                                  ; FUM10--ES - Current MCB address
 36327                                  ;        CX - Current UMB number
 36328                                  ;        DX - UMB number to skip (load UMB)
 36329                                  ; -----------------------------------------
 36330                                  
 36331                                  ;fum10:	
 36332 00002ED0 E861FD                  	call	isSysMCB	; Returns with ZF set if owner is SYSTEM
 36333 00002ED3 7501                    	jnz	short fum20
 36334                                  
 36335 00002ED5 41                      	inc	cx		; If it _was_ SYSTEM, we're in a new UMB.
 36336                                  fum20:	
 36337 00002ED6 39D1                    	cmp	cx,dx		; If this is the load UMB, we don't want to
 36338 00002ED8 740B                    	je	short fum30	; freeze anything... so skip that section.
 36339                                  
 36340                                  	;call	isFreeMCB	; Oh. If it's not free, we can't freeze it
 36341 00002EDA 26830E010000            	or	word [es:ARENA.OWNER],0
 36342 00002EE0 7503                    	jnz	short fum30	; either.
 36343                                  
 36344 00002EE2 E8B8FF                  	call	frezMCB
 36345                                  fum30:	
 36346                                  	;mov	al,[es:ARENA.SIGNATURE]
 36347                                  	;cmp	al,arena_signature_end ; 'Z'
 36348                                  	; 22/07/2023
 36349 00002EE5 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],arena_signature_end ; 'Z'
 36350 00002EEB 7408                    	je	short fumX	; 'Z' means this was the last MCB.. that's it.
 36351                                  
 36352                                  	;NextMCB es, ax		; Go on forward.
 36353                                  	; 22/07/2023
 36354                                  	; ax = es
 36355                                  	;mov	ax,es
 36356                                  	;add	ax,[es:3]
 36357 00002EED 2603060300              	add	ax,[es:ARENA.SIZE]
 36358 00002EF2 40                      	inc	ax
 36359                                  	; 22/07/2023
 36360                                  	;mov	es,ax ; *
 36361 00002EF3 EBD9                    	jmp	short fum10
 36362                                  
 36363 00002EF5 07                      fumX:	pop	es
 36364                                  	; 01/01/2023
 36365                                  	;pop	dx
 36366                                  	;pop	cx
 36367                                  	;pop	ax
 36368 00002EF6 C3                      	retn
 36369                                  
 36370                                  ; -----------------------------------------------------------------------------
 36371                                  ;*** UmbTest - returns with carry set if UMBs are not available, else CF==false
 36372                                  ; -----------------------------------------------------------------------------
 36373                                  ; ENTRY:    None
 36374                                  ; EXIT:     Carry is clear if UMBs are available, or set if they are not
 36375                                  ; ERROR:    None
 36376                                  ; USES:     CF (AX,BX,DS,ES pushed 'cause they're used by others)
 36377                                  ; -----------------------------------------------------------------------------
 36378                                  
 36379                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 36380                                  UmbTest:
 36381                                  	; 01/01/2023
 36382                                  	;push	ax
 36383 00002EF7 53                      	push	bx ; *
 36384                                  	;push	ds
 36385 00002EF8 06                      	push	es ; **
 36386                                  
 36387                                  	; 01/01/2023
 36388                                  	; ds = cs
 36389                                  
 36390 00002EF9 E871FB                  	call	fm_link			; Link in UMBs (if not already linked)
 36391 00002EFC E80800                  	call	WalkMem			; Check to see if they're really linked
 36392 00002EFF 9C                      	pushf				; And remember what we found out
 36393 00002F00 E87BFB                  	call	fm_unlink		; Unlink UMBs (if WE have linked 'em)
 36394 00002F03 9D                      	popf				; And restore what we found out.
 36395                                  
 36396 00002F04 07                      	pop	es ; **
 36397                                  	; 01/01/2023
 36398                                  	;pop	ds
 36399 00002F05 5B                      	pop	bx ; *
 36400                                  	;pop	ax
 36401 00002F06 C3                      	retn
 36402                                  
 36403                                  ; -----------------------------------------------------------------------------
 36404                                  ;*** WalkMem - travels memory chain and returns carry clear if UMBs are linked
 36405                                  ; -----------------------------------------------------------------------------
 36406                                  ; ENTRY:    None
 36407                                  ; EXIT:     Carry SET if MCB chain stops before 9FFF, CLEAR if stops >= 9FFF.
 36408                                  ; ERROR:    None
 36409                                  ; USES:     Flags
 36410                                  ; -----------------------------------------------------------------------------
 36411                                  
 36412                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 36413                                  	; (SYSINIT:3541h)
 36414                                  
 36415                                  WalkMem:
 36416                                  	;push	ax ; ?
 36417                                  	;push	bx ; ?
 36418                                  	;;push	ds ; ? ; 01/01/2023 (MSDOS 6.21 IO.SYS, SYSINIT:352Fh)
 36419                                  	;push	es ; ? no need to save contents of these registers ?
 36420                                  		   	
 36421 00002F07 B452                    	mov	ah,GET_IN_VARS		; Call int 21h, function 52h...
 36422 00002F09 CD21                    	int	21h
 36423                                  
 36424 00002F0B 268B47FE                	mov	ax,[es:bx-2]
 36425                                  	; 22/07/2023
 36426                                  um10:
 36427 00002F0F 8EC0                    	mov	es,ax ; * ; **
 36428                                  
 36429                                  ; ------------------------------
 36430                                  ; UM10: ES = Current MCB pointer
 36431                                  ; ------------------------------
 36432                                  
 36433                                  ;um10:
 36434                                  	;mov	al,[es:ARENA.SIGNATURE]
 36435                                  	;cmp	al,arena_signature_end ; 'Z'
 36436                                  	; 22/07/2023
 36437 00002F11 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],arena_signature_end ; 'Z'
 36438 00002F17 7408                    	je	short um20		; If signature == 'Z', hay no more.
 36439                                  
 36440                                  	;NextMCB es,bx			; Move to the next MCB
 36441                                  
 36442                                  	;mov	bx,es
 36443                                  	;;add	bx,[es:3]
 36444                                  	;add	bx,[es:ARENA.SIZE]
 36445                                  	;inc	bx
 36446                                  	;mov	es,bx
 36447                                  	; 22/07/2023
 36448                                  	; ax = es
 36449                                  	;mov	ax,es ; *
 36450 00002F19 2603060300              	add	ax,[es:ARENA.SIZE]
 36451 00002F1E 40                      	inc	ax
 36452                                  	;mov	es,ax ; **
 36453                                  	
 36454 00002F1F EBEE                    	jmp	short um10		; And restart the loop.
 36455                                  um20:	
 36456                                  	; 22/07/2023
 36457                                  	; ax = es
 36458                                  	;mov	ax,es
 36459                                  
 36460 00002F21 3DFF9F                  	cmp	ax,9FFFh		; This sets CF if ax < 9FFF.
 36461                                  
 36462                                  	;pop	es ; ?
 36463                                  	;;pop	ds ; ? ; 01/01/2023 (MSDOS 6.21 IO.SYS, SYSINIT:353Dh)
 36464                                  	;pop	bx ; ?
 36465                                  	;pop	ax ; ?
 36466                                  	
 36467 00002F24 C3                      	retn
 36468                                  
 36469                                  ; -----------------------------------------------------------------------------
 36470                                  ;*** hl_unlink - unlinks UMBs if fm_umb is set to 0; restores strategy too
 36471                                  ; -----------------------------------------------------------------------------
 36472                                  ; ENTRY:    fm_umb == 1 : leave linked, else unlink
 36473                                  ; EXIT:     None
 36474                                  ; ERROR:    None
 36475                                  ; USES:     AX, BX
 36476                                  ; -----------------------------------------------------------------------------
 36477                                  
 36478                                  	; 01/01/2023 - Retro DOS v4.2
 36479                                  hl_unlink:
 36480 00002F25 30FF                    	xor	bh,bh
 36481                                  
 36482                                  	;getdata bl,fm_umb		; Restore original link-state
 36483                                  	;
 36484                                  	;push	ds
 36485                                  	;push	cs
 36486                                  	;pop	ds
 36487                                  	;mov	bl,[fm_umb]
 36488                                  	;pop	ds
 36489                                  
 36490                                  	; 01/01/2023
 36491                                  	; ds = cs
 36492                                  	;mov	bl,[cs:fm_umb]
 36493 00002F27 8A1E[551F]              	mov	bl,[fm_umb]
 36494                                  
 36495 00002F2B B80358                  	mov	ax,DOS_SET_UMBLINK ; 5803h
 36496 00002F2E CD21                    	int	21h
 36497 00002F30 C3                      	retn
 36498                                  
 36499                                  ; ----------------------------------------------------------------------
 36500                                  ; HIGHEXIT.INC (MSDOS 6.0 - 1991) 	
 36501                                  ; ----------------------------------------------------------------------
 36502                                  ; 09/04/2019 - Retro DOS v4.0
 36503                                  
 36504                                  ;   Module:   HIGHEXIT.INC - Code executed after LoadHigh or DeviceHigh
 36505                                  ;   Date:     May 14, 1992
 36506                                  
 36507                                  ;   Modification log:
 36508                                  ;
 36509                                  ;     DATE    WHO      DESCRIPTION
 36510                                  ;   --------  -------  --------------------------------------------------------
 36511                                  ;   05/14/92  t-richj  Original
 36512                                  ;   06/21/92  t-richj  Final revisions before check-in
 36513                                  
 36514                                  UMB_HeadIdx	equ	8Ch	; Offset from ES (after func52h) to get UMBHead
 36515                                  
 36516                                  ; -----------------------------------------------------------------------------
 36517                                  ;*** UnHideUMBs - Marks HIDDEN elements as FREE
 36518                                  ; -----------------------------------------------------------------------------
 36519                                  ; ENTRY:  None; perhaps, earlier, HideUMBs was called... if not, we have
 36520                                  ;               very little to do, as no elelments will be marked as HIDDEN.
 36521                                  ; EXIT:   Sets InHigh to zero; carry clear if HideUMBs was called earlier.
 36522                                  ; ERROR:  None
 36523                                  ; USES:   fInHigh (from highvar.inc), carry flag
 36524                                  ; -----------------------------------------------------------------------------
 36525                                  
 36526                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 36527                                  	; (SYSINIT:357Bh)
 36528                                  
 36529                                  UnHideUMBs:
 36530 00002F31 50                      	push	ax		; Save ax for what we're about to do
 36531                                  
 36532                                  ; -----------------------------------------------------------------------------
 36533                                  ; BUGBUG t-richj 11-8-92: The following six lines were commented out for a good
 36534                                  ;    length of time. Those six constitute a check of whether or not we should
 36535                                  ;    indeed clean up the upper-memory chain; without such a check, COMMAND.COM
 36536                                  ;    will destroy the current link-state and memory-allocation strategy after
 36537                                  ;    every command execution.
 36538                                  ; -----------------------------------------------------------------------------
 36539                                  
 36540                                  	;getdata al,fInHigh	; Get InHigh from data segment
 36541                                  	;
 36542                                  	;push	ds
 36543                                  	;push	cs
 36544                                  	;pop	ds
 36545                                  	;mov	al,[fInHigh]
 36546                                  	;pop	ds	
 36547                                  
 36548                                  	;mov	al,[cs:fInHigh]
 36549                                  	; 31/12/2022
 36550                                  	; ds = cs
 36551 00002F32 A0[201F]                	mov	al,[fInHigh]	
 36552                                  
 36553 00002F35 08C0                    	or	al,al
 36554 00002F37 7503                    	jnz	short uhu10	; If didn't call loadhigh/devicehigh earlier,
 36555                                  
 36556 00002F39 58                      	pop	ax		; then there's nothing to do here... so
 36557 00002F3A F9                      	stc			; restore everything and return. Just like
 36558 00002F3B C3                      	retn			; that.
 36559                                  uhu10:	
 36560 00002F3C E88E00                  	call	linkumb		; Make sure UMBs are linked in.
 36561 00002F3F E81200                  	call	FreeUMBs
 36562                                  
 36563                                  	;putdata fInHigh,0	; We're leaving, so update fInHigh.
 36564                                  	;
 36565                                  	;push	es
 36566                                  	;push	cs
 36567                                  	;pop	es
 36568                                  	;mov	byte [es:fInHigh],0
 36569                                  	;pop	ds
 36570                                  
 36571                                  	; 31/12/2022
 36572                                  	; ds = cs	
 36573                                  	;mov	byte [cs:fInHigh],0
 36574 00002F42 C606[201F]00            	mov	byte [fInHigh],0
 36575                                  
 36576                                  	;call	he_unlink	; Unlink UMBs
 36577                                  	; 31/12/2022
 36578                                  ;;he_unlink:			; unlinks UMBs if fm_umb is set to 0
 36579 00002F47 30FF                    	xor	bh,bh
 36580                                  
 36581                                  	;getdata bl,fm_umb	; Restore original link-state
 36582                                  	;mov	bl,[cs:fm_umb]	
 36583 00002F49 8A1E[551F]              	mov	bl,[fm_umb]
 36584                                  
 36585 00002F4D B80358                  	mov	ax,DOS_SET_UMBLINK ; 5803h
 36586 00002F50 CD21                    	int	21h
 36587                                  	;;retn
 36588                                  
 36589 00002F52 58                      	pop	ax
 36590                                  	; 12/12/2022
 36591                                  	;clc	; 12/12/2022 (this clc may not be necessary!?)
 36592 00002F53 C3                      	retn
 36593                                  
 36594                                  ; 31/12/2022
 36595                                  ;%if 0
 36596                                  ;
 36597                                  ;; -----------------------------------------------------------------------------
 36598                                  ;;*** he_unlink - unlinks UMBs if fm_umb is set to 0
 36599                                  ;; -----------------------------------------------------------------------------
 36600                                  ;; ENTRY:    fm_umb == 1 : leave linked, else unlink
 36601                                  ;; EXIT:     None
 36602                                  ;; ERROR:    None
 36603                                  ;; USES:     AX, BX
 36604                                  ;; -----------------------------------------------------------------------------
 36605                                  ;
 36606                                  ;he_unlink:
 36607                                  ;	xor	bh, bh
 36608                                  ;
 36609                                  ;	;getdata bl, fm_umb	; Restore original link-state
 36610                                  ;	mov	bl,[cs:fm_umb]	
 36611                                  ;
 36612                                  ;	mov	ax,DOS_SET_UMBLINK ; 5803h
 36613                                  ;	int	21h
 36614                                  ;	retn
 36615                                  ;
 36616                                  ;%endif
 36617                                  
 36618                                  ; -----------------------------------------------------------------------------
 36619                                  ;*** freeUMBs - frees all HIDDEN memory elements in upper-memory.
 36620                                  ; -----------------------------------------------------------------------------
 36621                                  ; ENTRY:    None
 36622                                  ; EXIT:     None; HIDDEN memory elements returned to FREE
 36623                                  ; ERROR:    None (ignore CF)
 36624                                  ; USES:     Flags
 36625                                  ; -----------------------------------------------------------------------------
 36626                                  
 36627                                  FreeUMBs:
 36628 00002F54 50                      	push	ax
 36629 00002F55 06                      	push	es
 36630                                  
 36631 00002F56 E86700                  	call	HeadUmb		; Returns with carry if err, else ES == MCB
 36632 00002F59 721C                    	jc	short fusX
 36633                                  fus10:
 36634 00002F5B 8EC0                    	mov	es,ax		; Prepare for the loop; ES = current MCB addr.
 36635                                  ;fus10:	
 36636 00002F5D E81A00                  	call	isHideMCB	; Returns with ZF set if owner is 0
 36637 00002F60 7505                    	jnz	short fus20
 36638 00002F62 E84000                  	call	freeMCB
 36639                                  	; 09/09/2023
 36640                                  	; ax <> es
 36641 00002F65 8CC0                    	mov	ax,es
 36642                                  fus20:	   
 36643                                  	;mov	al,[es:ARENA.SIGNATURE]
 36644                                  	;cmp	al,arena_signature_end ; 'Z'
 36645                                  	; 22/07/2023
 36646 00002F67 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],arena_signature_end ; 'Z'
 36647 00002F6D 7408                    	jz	short fusX	; That means this was the last MCB--that's it.
 36648                                  	
 36649                                  	; 22/07/2023
 36650                                  	; ax = es
 36651                                  	;mov	ax,es
 36652 00002F6F 2603060300              	add	ax,[es:ARENA.SIZE]
 36653 00002F74 40                      	inc	ax
 36654                                  	; 22/07/2023
 36655                                  	;mov	es,ax
 36656 00002F75 EBE4                    	jmp	short fus10	; Go on forward.
 36657                                  fusX:	
 36658 00002F77 07                      	pop	es
 36659 00002F78 58                      	pop	ax
 36660 00002F79 C3                      	retn
 36661                                  
 36662                                  ; -----------------------------------------------------------------------------
 36663                                  ;*** isHideMCB - returns with ZF set if current MCB (ES:0) is HIDDEN
 36664                                  ; -----------------------------------------------------------------------------
 36665                                  ; ENTRY:    ES:0 should point to an MCB
 36666                                  ; EXIT:     ZF set if MCB is hidden, else !ZF
 36667                                  ; ERROR:    None
 36668                                  ; USES:     Flags
 36669                                  ; -----------------------------------------------------------------------------
 36670                                  
 36671                                  isHideMCB:
 36672                                  	;push	ax
 36673                                  
 36674 00002F7A 26833E010008            	cmp	word [es:ARENA.OWNER],SystemPSPOwner ; If the owner's SYSTEM
 36675 00002F80 7522                    	jne	short ihm_x			     ; then check for HIDDEN
 36676                                  
 36677                                  	;mov	ax,[es:ARENA.NAME]
 36678                                  	;cmp	ax,'HI' ; 4948h
 36679 00002F82 26813E08004849          	cmp	word [es:ARENA.NAME+0],'HI'
 36680 00002F89 7519                    	jne	short ihm_x
 36681                                  	;mov	ax,[es:ARENA.NAME+2]
 36682                                  	;cmp	ax,'DD' ; 4444h
 36683 00002F8B 26813E0A004444          	cmp	word [es:ARENA.NAME+2],'DD'
 36684 00002F92 7510                    	jne	short ihm_x
 36685                                  	;mov	ax,[es:ARENA.NAME+4]
 36686                                  	;cmp	ax,'EN' ; 4E45h
 36687 00002F94 26813E0C00454E          	cmp	word [es:ARENA.NAME+4],'EN'
 36688 00002F9B 7507                    	jne	short ihm_x
 36689                                  	;mov	ax,[es:ARENA.NAME+6]
 36690                                  	;cmp	ax,'  ' ; 2020h
 36691 00002F9D 26813E0E002020          	cmp	word [es:ARENA.NAME+6],'  '
 36692                                  ihm_x:	
 36693                                  	;pop	ax
 36694 00002FA4 C3                      	retn
 36695                                  
 36696                                  ; -----------------------------------------------------------------------------
 36697                                  ;*** freeMCB - marks as free the MCB at ES:0
 36698                                  ; -----------------------------------------------------------------------------
 36699                                  ; ENTRY:    ES:0 should point to an MCB
 36700                                  ; EXIT:     None; MCB free'd
 36701                                  ; ERROR:    None
 36702                                  ; USES:     AX
 36703                                  ; -----------------------------------------------------------------------------
 36704                                  
 36705                                  freeMCB:
 36706 00002FA5 26C70601000000          	mov	word [es:ARENA.OWNER],0
 36707 00002FAC B82020                  	mov	ax,'  ' ; mov ax,2020h ; 31/12/2022
 36708 00002FAF 26A30800                	mov	[es:ARENA.NAME+0],ax
 36709 00002FB3 26A30A00                	mov	[es:ARENA.NAME+2],ax
 36710 00002FB7 26A30C00                	mov	[es:ARENA.NAME+4],ax
 36711 00002FBB 26A30E00                	mov	[es:ARENA.NAME+6],ax
 36712 00002FBF C3                      	retn
 36713                                  
 36714                                  ; -----------------------------------------------------------------------------
 36715                                  ;*** HeadUmb - returns in AX the address of the first UMB block (0x9FFF)
 36716                                  ; -----------------------------------------------------------------------------
 36717                                  ; ENTRY:  Nothing
 36718                                  ; EXIT:   AX contains 0x9FFF for most systems
 36719                                  ; ERROR:  Carry set if pointer is 0xFFFF (if not set up yet--DH runs into this)
 36720                                  ; USES:   Flags, AX
 36721                                  ; -----------------------------------------------------------------------------
 36722                                  
 36723                                  HeadUmb:
 36724                                  	; 13/05/2019
 36725                                  
 36726                                  	;push	si ; ?
 36727                                  	;push	ds ; ?
 36728                                  	;push	es
 36729                                  	;push	bx ; *
 36730                                  
 36731                                  	; 09/04/2019
 36732                                  	; !!! No need to save es,bx,ds,si above !!! (es,bx are changed here)
 36733                                  
 36734 00002FC0 B452                    	mov	ah,GET_IN_VARS		; Call int 21h, function 52h...
 36735 00002FC2 CD21                    	int	21h
 36736                                  			; DOS - 2+ internal - GET LIST OF LISTS
 36737                                  			; Return: ES:BX -> DOS list of lists
 36738                                  	;mov	ax,[es:8Ch]
 36739 00002FC4 26A18C00                	mov	ax,[es:UMB_HeadIdx]	; And read what's in ES:008C
 36740 00002FC8 83F8FF                  	cmp	ax,0FFFFh
 36741                                  	;je	short xhu_e		; If it's 0xFFFF, it's an error...
 36742                                  
 36743                                  	;clc				; Else, it isn't.
 36744                                  	;jmp	short xhu_x
 36745                                  xhu_e:	
 36746                                  	;stc
 36747 00002FCB F5                      	cmc	; 09/04/2019 - Retro DOS v4.0 ; *
 36748                                  xhu_x:	
 36749                                  	;pop	bx ; *
 36750                                  	;pop	es	
 36751                                  	;pop	ds ; ?
 36752                                  	;pop	si ; ?
 36753 00002FCC C3                      	retn
 36754                                  
 36755                                  ; -----------------------------------------------------------------------------
 36756                                  ;*** linkumb - links UMBs not already linked in; updates fm_umb as needed
 36757                                  ; -----------------------------------------------------------------------------
 36758                                  ; ENTRY:    None
 36759                                  ; EXIT:     fm_umb == 0 if not linked in previously, 1 if already linked in
 36760                                  ; ERROR:    None
 36761                                  ; USES:     AX, BX, fm_umb
 36762                                  ; -----------------------------------------------------------------------------
 36763                                  
 36764                                  linkumb:
 36765 00002FCD B80258                  	mov	ax,DOS_GET_UMBLINK ; 5802h
 36766 00002FD0 CD21                    	int	21h			; Current link-state is now in al
 36767                                  
 36768 00002FD2 08C0                    	or	al,al			; BUGBUG: proper check?
 36769 00002FD4 7508                    	jnz	short lumbX		; Jumps if UMBs already linked in
 36770                                  
 36771 00002FD6 B80358                  	mov	ax,DOS_SET_UMBLINK ; 5803h
 36772 00002FD9 BB0100                  	mov	bx,1
 36773 00002FDC CD21                    	int	21h
 36774                                  lumbX:
 36775 00002FDE C3                      	retn
 36776                                  
 36777                                  ;%endif
 36778                                  
 36779                                  ; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 36780                                  ; (SYSINIT:2B5Fh)
 36781                                  
 36782                                  ; ----------------------------------------------------------------------
 36783                                  ; SYSCONF.ASM (MSDOS 6.0 - 1991) 	
 36784                                  ; ----------------------------------------------------------------------
 36785                                  ; 09/04/2019 - Retro DOS v4.0
 36786                                  
 36787                                  ;----------------------------------------------------------------------------
 36788                                  ;
 36789                                  ; procedure : InitDevLoad
 36790                                  ;
 36791                                  ;	Input : DeviceHi = 0 indicates load DD in low memory
 36792                                  ;			 = 1 indicates load in UMB:
 36793                                  ;		           ConvLoad = 0 indicates a new-style load (see below)
 36794                                  ;		                    = 1 indicates a DOS 5-style load
 36795                                  ;		DevSize  = Size of the device driver file in paras
 36796                                  ;
 36797                                  ;	Output : none
 36798                                  ;
 36799                                  ;	Initializes DevLoadAddr, DevLoadEnd & DevEntry.
 36800                                  ;	Also sets up a header for the Device driver entry for mem utility
 36801                                  ;
 36802                                  ;----------------------------------------------------------------------------
 36803                                  ; For a "new-style load", we break off the current DevEntry and link the umbs
 36804                                  ; as we see fit, using HideUMBs (and UnHideUMBs at exit, though _it_ decides
 36805                                  ; whether it's entitled to do anything). HideUMBs uses the chart built by
 36806                                  ; ParseVar to determine which UMBs to leave FREE, and which not.
 36807                                  ;----------------------------------------------------------------------------
 36808                                  
 36809                                  	; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 36810                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 36811                                  	; (SYSINIT:364Ah)
 36812                                  InitDevLoad:
 36813                                  	; 01/01/2023
 36814                                  	;push	es ; *
 36815                                  
 36816                                  	; 11/12/2022
 36817                                  	; ds = cs
 36818 00002FDF 803E[761F]00            	cmp	byte [DeviceHi],0
 36819                                  	;cmp	byte [cs:DeviceHi],0	; Are we loading in UMB ?
 36820                                  	;je	short InitForLo		; no, init for lo mem
 36821 00002FE4 7439                    	je	short initforlo_x ; 09/04/2019
 36822                                  
 36823                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 36824                                  ; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 36825                                  ; %if 0
 36826                                  	; 01/01/2023
 36827 00002FE6 803E[661F]01            	cmp	byte [ConvLoad],1
 36828                                  	;cmp	byte [cs:ConvLoad],1	; Are we loading as per DOS 5?
 36829 00002FEB 7413                    	je	short InitForConv
 36830                                  
 36831                                  ; There are two stages to preparing upper-memory; first, we mark as 8+HIDDEN
 36832                                  ; any areas not specified on the /L:... chain. Second, we mark as 8+FROZEN
 36833                                  ; any areas left in upper-memory, except for elements in the load UMB...
 36834                                  ; we then malloc space as per Dos-5 style, and mark as free any spaces which
 36835                                  ; are 8+FROZEN (but leave 8+HIDDEN still hidden). The load is performed,
 36836                                  ; and UnHideUMBs later on marks all 8+HIDDEN as free.
 36837                                  
 36838 00002FED E85704                  	call	ShrinkUMB		; Stop using the old device arena
 36839                                  
 36840 00002FF0 E892FC                  	call	HideUMBs		; Mark up the UM area as we see fit
 36841 00002FF3 E8CBFE                  	call	FreezeUM		; Hide everything BUT the load area
 36842 00002FF6 E85700                  	call	GetUMBForDev		; And grab that load area as needed
 36843 00002FF9 9C                      	pushf
 36844 00002FFA E851FE                  	call	UnFreeze		; Then unhide everything frozen
 36845 00002FFD 9D                      	popf
 36846                                  	;jc	short InitForLo		; (if carry, it's loading low)
 36847                                  	;jmp	short InitForHi
 36848                                  	; 06/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 36849 00002FFE EB0B                    	jmp	short idl0
 36850                                  
 36851                                  ;%endif ; 01/11/2022
 36852                                  
 36853                                  	; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 36854                                  	; (SYSINIT:2B67h)
 36855                                  InitForConv:
 36856                                  	; 11/12/2022
 36857                                  	; ds = cs
 36858 00003000 E83700                  	call	SpaceInUMB		; Do we have space left in the
 36859                                  					;  current UMB ?
 36860 00003003 7308                    	jnc	short InitForHi		; yes, we have
 36861 00003005 E83F04                  	call	ShrinkUMB		; shrink the current UMB in use
 36862 00003008 E84500                  	call	GetUMBForDev		; else try to allocate new UMB
 36863                                  idl0: ; 06/07/2023
 36864 0000300B 720D                    	jc	short InitForLo		; we didn't succeed, so load
 36865                                  					;  in low memory
 36866                                  InitForHi:
 36867                                  	; 11/12/2022
 36868                                  	; ds = cs
 36869                                  	;mov	ax,[cs:DevUMBFree]	; get Para addr of free mem
 36870                                  	;mov	dx,[cs:DevUMBAddr]	; UMB start addr
 36871                                  	;add	dx,[cs:DevUMBSize]	; DX = UMB End addr
 36872 0000300D A1[6C1F]                	mov	ax,[DevUMBFree]
 36873 00003010 8B16[681F]              	mov	dx,[DevUMBAddr]
 36874 00003014 0316[6A1F]              	add	dx,[DevUMBSize]
 36875 00003018 EB0C                    	jmp	short idl1
 36876                                  
 36877                                  InitForLo:
 36878                                  	; 11/12/2022
 36879                                  	; ds = cs
 36880                                  	;mov	byte [cs:DeviceHi],0	; in case we failed to load
 36881 0000301A C606[761F]00            	mov	byte [DeviceHi],0
 36882                                  initforlo_x:
 36883                                  	; 11/12/2022
 36884                                  	; ds = cs
 36885                                  					;  into UMB indicate that
 36886                                  					;  we are loading low
 36887                                  	;mov	ax,[cs:memhi]		; AX = Start of Low memory
 36888                                  	;mov	dx,[cs:ALLOCLIM]	; DX = End of Low memory
 36889 0000301F A1[6403]                	mov	ax,[memhi]
 36890 00003022 8B16[A502]              	mov	dx,[ALLOCLIM]
 36891                                  idl1:
 36892 00003026 E86600                  	call	DevSetMark		; setup a sub-arena for DD
 36893                                  	; 11/12/2022
 36894                                  	; ds = cs
 36895                                  	;mov	[cs:DevLoadAddr],ax	; init the Device load address
 36896                                  	;mov	[cs:DevLoadEnd],dx	; init the limit of the block
 36897                                  	;mov	word [cs:DevEntry],0	; init Entry point to DD
 36898                                  	;mov	[cs:DevEntry+2],ax
 36899 00003029 A3[5A1F]                	mov	[DevLoadAddr],ax
 36900 0000302C 8916[5C1F]              	mov	[DevLoadEnd],dx
 36901 00003030 C706[5E1F]0000          	mov	word [DevEntry],0
 36902 00003036 A3[601F]                	mov	[DevEntry+2],ax
 36903                                  	; 01/01/2023
 36904                                  	;pop	es ; *
 36905 00003039 C3                      	retn
 36906                                  
 36907                                  ;----------------------------------------------------------------------------
 36908                                  ;
 36909                                  ; procedure : SpaceInUMB?
 36910                                  ;
 36911                                  ;	Input : DevUMBAddr, DevUMBSize, DevUMBFree & DevSize
 36912                                  ;	Output : Carry set if no space in UMB
 36913                                  ;		 Carry clear if Space is available for the device in
 36914                                  ;		   current UMB
 36915                                  ;
 36916                                  ;----------------------------------------------------------------------------
 36917                                  
 36918                                  SpaceInUMB:
 36919                                  	; 11/12/2022
 36920                                  	; ds = cs
 36921                                  	;mov	ax,[cs:DevUMBSize]
 36922                                  	;add	ax,[cs:DevUMBAddr]	; End of UMB
 36923                                  	;sub	ax,[cs:DevUMBFree]	; - Free = Remaining space
 36924 0000303A A1[6A1F]                	mov	ax,[DevUMBSize]
 36925 0000303D 0306[681F]              	add	ax,[DevUMBAddr]		; End of UMB
 36926 00003041 2B06[6C1F]              	sub	ax,[DevUMBFree]		; - Free = Remaining space
 36927                                  	; 11/12/2022
 36928                                  	;or	ax,ax			; Nospace ?
 36929                                  	;jnz	short spcinumb1
 36930                                  	;stc
 36931                                  	;retn
 36932                                  	; 11/12/2022
 36933 00003045 83F801                  	cmp	ax,1
 36934 00003048 7205                    	jb	short spcinumb2	; cf=1
 36935                                  spcinumb1:
 36936 0000304A 48                      	dec	ax			; space for sub-arena
 36937                                  	; 11/12/2022
 36938                                  	; ds = cs
 36939 0000304B 3B06[581F]              	cmp	ax,[DevSize]
 36940                                  	;cmp	ax,[cs:DevSize]		; do we have space ?
 36941                                  spcinumb2:
 36942 0000304F C3                      	retn
 36943                                  
 36944                                  ;----------------------------------------------------------------------------
 36945                                  ;
 36946                                  ; procedure : PrepareMark
 36947                                  ;
 36948                                  ;	Input : AX==Address of MCB (not addr of free space), BX==Size
 36949                                  ;	Output : None; MCB marked appropriately and DevUMB* set as needed.
 36950                                  ;
 36951                                  ;----------------------------------------------------------------------------
 36952                                  
 36953                                  ;	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 36954                                  ;
 36955                                  ;PrepareMark:
 36956                                  ;	push	ds
 36957                                  ;	mov	ds,ax
 36958                                  ;	mov	word [ARENA.OWNER],8
 36959                                  ;	mov	word [ARENA.NAME],'SD' ; 4453h
 36960                                  ;	pop	ds
 36961                                  ;
 36962                                  ;	inc	ax
 36963                                  ;	mov	[cs:DevUMBAddr],ax
 36964                                  ;	mov	[cs:DevUMBFree],ax
 36965                                  ;	mov	[cs:DevUMBSize],bx	; update the UMB Variables
 36966                                  ;	retn
 36967                                  
 36968                                  ;----------------------------------------------------------------------------
 36969                                  ;
 36970                                  ; procedure : GetUMBForDev
 36971                                  ;
 36972                                  ;	Input : DevSize
 36973                                  ;	Output : Carry set if couldn't allocate a UMB to fit the
 36974                                  ;		 the device.
 36975                                  ;		 If success carry clear
 36976                                  ;
 36977                                  ;	Allocates the biggest UMB for loading devices and updates
 36978                                  ;	DevUMBSize, DevUMBAddr & DevUMBFree if it succeeded in allocating
 36979                                  ;	UMB.
 36980                                  ;
 36981                                  ;	This routine relies on the fact that all of the low memory
 36982                                  ;	is allocated, and any DOS alloc calls should return memory
 36983                                  ;	from the UMB pool.
 36984                                  ;
 36985                                  ;----------------------------------------------------------------------------
 36986                                  
 36987                                  	; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 36988                                  	; (SYSINIT:2BC6h)
 36989                                  
 36990                                  GetUMBForDev:
 36991                                  	; 11/12/2022
 36992                                  	; ds = cs
 36993 00003050 BBFFFF                  	mov	bx,0FFFFh
 36994 00003053 B80048                  	mov	ax,4800h
 36995 00003056 CD21                    	int	21h
 36996                                  		; DOS - 2+ - ALLOCATE MEMORY
 36997                                  		; BX = number of 16-byte paragraphs desired
 36998                                  
 36999 00003058 09DB                    	or	bx,bx
 37000                                  	;jz	short gufd_err
 37001                                  	; 09/09/2023
 37002 0000305A 742E                    	jz	short gufd_error ; bx = 0
 37003                                  
 37004 0000305C 4B                      	dec	bx
 37005                                  	; 11/12/2022
 37006                                  	; ds = cs
 37007 0000305D 391E[581F]              	cmp	[DevSize],bx
 37008                                  	;cmp	[cs:DevSize],bx
 37009 00003061 7725                    	ja	short gufd_err
 37010                                  
 37011 00003063 43                      	inc	bx
 37012                                  
 37013 00003064 B80048                  	mov	ax,4800h
 37014 00003067 CD21                    	int	21h
 37015 00003069 721D                    	jc	short gufd_err
 37016                                  
 37017                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37018                                  	;dec	ax
 37019                                  	;call	PrepareMark
 37020                                  	;
 37021                                  PrepareMark:
 37022 0000306B 1E                      	push	ds
 37023 0000306C 48                      	dec	ax
 37024 0000306D 8ED8                    	mov	ds,ax
 37025 0000306F C70601000800            	mov	word [ARENA.OWNER],8
 37026 00003075 C70608005344            	mov	word [ARENA.NAME],'SD' ; 4453h
 37027 0000307B 40                      	inc	ax
 37028 0000307C 1F                      	pop	ds
 37029                                  	; 11/12/2022
 37030                                  	; ds = cs
 37031                                  	;mov	[cs:DevUMBSize],bx	; update the UMB Variables
 37032                                  	;mov	[cs:DevUMBAddr],ax
 37033                                  	;mov	[cs:DevUMBFree],ax
 37034                                  gufd_x:		; 09/09/2023
 37035 0000307D 891E[6A1F]              	mov	[DevUMBSize],bx		; update the UMB Variables
 37036 00003081 A3[681F]                	mov	[DevUMBAddr],ax
 37037 00003084 A3[6C1F]                	mov	[DevUMBFree],ax
 37038                                  	;
 37039                                  	; 11/12/2022
 37040                                  	; cf=0
 37041                                  	;clc				; mark no error
 37042 00003087 C3                      	retn
 37043                                  
 37044                                  	; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 37045                                  %if 1
 37046                                  gufd_err:
 37047 00003088 31DB                    	xor	bx,bx ; 0
 37048                                  gufd_error:
 37049 0000308A 31C0                    	xor	ax,ax ; 0
 37050 0000308C F9                      	stc	; cf=1
 37051 0000308D EBEE                    	jmp	short gufd_x	
 37052                                  %endif
 37053                                  
 37054                                  ; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 37055                                  %if 0
 37056                                  gufd_err:
 37057                                  	xor	ax,ax ; 0
 37058                                  	; 11/12/2022
 37059                                  	; ds = cs
 37060                                  	;mov	[cs:DevUMBSize],ax	; erase the previous values
 37061                                  	;mov	[cs:DevUMBAddr],ax
 37062                                  	;mov	[cs:DevUMBFree],ax
 37063                                  	mov	[DevUMBSize],ax		; erase the previous values
 37064                                  	mov	[DevUMBAddr],ax
 37065                                  	mov	[DevUMBFree],ax
 37066                                  	stc
 37067                                  	retn
 37068                                  %endif
 37069                                  
 37070                                  ;----------------------------------------------------------------------------
 37071                                  ;
 37072                                  ; procedure : DevSetMark
 37073                                  ;
 37074                                  ;	Input : AX - Free segment were device is going to be loaded
 37075                                  ;	Output : AX - Segment at which device can be loaded (AX=AX+1)
 37076                                  ;
 37077                                  ;	Creates a sub-arena for the device driver
 37078                                  ;	puts 'D' marker in the sub-arena
 37079                                  ;	Put the owner of the sub-arena as (AX+1)
 37080                                  ;	Copies the file name into sub-arena name field
 37081                                  ;
 37082                                  ;	Size field of the sub-arena will be set only at succesful
 37083                                  ;	completion of Device load.
 37084                                  ;
 37085                                  ;----------------------------------------------------------------------------
 37086                                  
 37087                                  	; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 37088                                  	; (SYSINIT:2C13h)
 37089                                  
 37090                                  DevSetMark:
 37091 0000308F 06                      	push	es
 37092                                  	; 03/01/2023
 37093                                  	;push	di
 37094 00003090 1E                      	push	ds
 37095 00003091 56                      	push	si
 37096 00003092 8EC0                    	mov	es,ax
 37097 00003094 26C606000044            	mov	byte [es:devmark.id],devmark_device ; 'D'
 37098 0000309A 40                      	inc	ax
 37099 0000309B 26A30100                	mov	[es:devmark.seg],ax
 37100                                  
 37101                                  ;-------------- Copy file name
 37102                                  
 37103 0000309F 50                      	push	ax			; save load address
 37104                                  	
 37105                                  	; 09/09/2023
 37106                                  	; ds = cs
 37107                                  	;lds	si,[cs:bpb_addr]	; command line is still there
 37108 000030A0 C536[7C03]              	lds	si,[bpb_addr]
 37109                                  
 37110 000030A4 89F7                    	mov	di,si
 37111 000030A6 FC                      	cld
 37112                                  dsm_again:
 37113 000030A7 AC                      	lodsb
 37114 000030A8 3C3A                    	cmp	al,':'
 37115 000030AA 7504                    	jne	short isit_slash
 37116 000030AC 89F7                    	mov	di,si
 37117 000030AE EBF7                    	jmp	short dsm_again
 37118                                  isit_slash:
 37119 000030B0 3C5C                    	cmp	al,'\'
 37120 000030B2 7504                    	jne	short isit_null
 37121 000030B4 89F7                    	mov	di,si
 37122 000030B6 EBEF                    	jmp	short dsm_again
 37123                                  isit_null:
 37124 000030B8 08C0                    	or	al,al
 37125 000030BA 75EB                    	jnz	short dsm_again
 37126 000030BC 89FE                    	mov	si,di
 37127                                  
 37128 000030BE BF0800                  	mov	di,devmark.filename ; 8
 37129 000030C1 B90800                  	mov	cx,8			; maximum 8 characters
 37130                                  dsm_next_char:
 37131 000030C4 AC                      	lodsb
 37132 000030C5 08C0                    	or	al,al
 37133 000030C7 7407                    	jz	short blankout
 37134 000030C9 3C2E                    	cmp	al,'.'
 37135 000030CB 7403                    	je	short blankout
 37136 000030CD AA                      	stosb
 37137 000030CE E2F4                    	loop	dsm_next_char
 37138                                  blankout:
 37139 000030D0 E304                    	jcxz	dsm_exit
 37140 000030D2 B020                    	mov	al,' '
 37141 000030D4 F3AA                    	rep	stosb			; blank out the rest
 37142                                  dsm_exit:
 37143 000030D6 58                      	pop	ax			; restore load address
 37144 000030D7 5E                      	pop	si
 37145 000030D8 1F                      	pop	ds
 37146                                  	; 03/01/2023
 37147                                  	;pop	di
 37148 000030D9 07                      	pop	es
 37149 000030DA C3                      	retn
 37150                                  
 37151                                  ;----------------------------------------------------------------------------
 37152                                  ;
 37153                                  ; procedure : SizeDevice
 37154                                  ;
 37155                                  ;	Input : ES:SI - points to device file to be sized
 37156                                  ;
 37157                                  ;	Output : Carry set if file cannot be opened or if it is an OS2EXE file
 37158                                  ;
 37159                                  ;	Calculates the size of the device file in paras and stores it
 37160                                  ;	in DevSize
 37161                                  ;
 37162                                  ;----------------------------------------------------------------------------
 37163                                  
 37164                                  	; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 37165                                  SizeDevice:
 37166                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37167                                  	; 11/12/2022 ; *
 37168 000030DB 1E                      	push	ds ; *
 37169 000030DC 06                      	push	es
 37170 000030DD 1F                      	pop	ds
 37171 000030DE 89F2                    	mov	dx,si			; ds:dx -> file name
 37172 000030E0 B8003D                  	mov	ax,3D00h		; open
 37173 000030E3 CD21                    	int	21h
 37174 000030E5 7237                    	jc	short sd_err		; open failed
 37175                                  
 37176 000030E7 89C3                    	mov	bx,ax			; BX - file handle
 37177 000030E9 B80242                  	mov	ax,4202h		; seek
 37178 000030EC 31C9                    	xor	cx,cx
 37179 000030EE 89CA                    	mov	dx,cx			; to end of file
 37180 000030F0 CD21                    	int	21h
 37181 000030F2 7223                    	jc	short sd_close		; did seek fail (impossible)
 37182 000030F4 83C00F                  	add	ax,15			; para convert
 37183 000030F7 83D200                  	adc	dx,0
 37184 000030FA F7C2F0FF                	test	dx,0FFF0h		; size > 0ffffh paras ?
 37185                                  	;jz	short szdev1		; no
 37186                                  	; 22/07/2023
 37187 000030FE 7409                    	jz	short sd_ctp
 37188 00003100 2EC706[581F]FFFF        	mov	word [cs:DevSize],0FFFFh ; invalid device size
 37189                                  					; assuming that we fail later
 37190 00003107 EB0E                    	jmp	short sd_close
 37191                                  sd_ctp:	
 37192                                  	; 22/07/2023
 37193                                  ;szdev1:
 37194 00003109 B104                    	mov	cl,4			; convert it to paras
 37195 0000310B D3E8                    	shr	ax,cl
 37196 0000310D B10C                    	mov	cl,12
 37197 0000310F D3E2                    	shl	dx,cl
 37198 00003111 09D0                    	or	ax,dx ; * ; cf=0
 37199                                  	;
 37200                                  	; 22/07/2023 - Retro DOS v4.2 IO.SYS (optimized)
 37201                                  	; MSDOS 6.21 IO.SYS - SYSINIT:37A6h 
 37202                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37203                                  	;cmp	ax,[cs:DevSizeOption]
 37204                                  	;ja	short szdev2
 37205                                  	;mov	ax,[cs:DevSizeOption]
 37206                                  	; 12/12/2022
 37207                                  	;clc
 37208                                  ;szdev2:
 37209 00003113 2EA3[581F]              	mov	[cs:DevSize],ax		; save file size (in paragraps)
 37210                                  	; 22/07/2023
 37211                                  	;clc ; cf=0 ; *	; CLC is not needed here
 37212                                  			; (OR instruction clears CF) - E.TAN 22/07/2023
 37213                                  
 37214                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37215                                  	; 12/12/2022
 37216                                  	; cf=0
 37217                                  	;clc
 37218                                  sd_close:
 37219 00003117 9C                      	pushf				; let close not spoil our
 37220                                  					;  carry flag
 37221 00003118 B8003E                  	mov	ax,3E00h		; close
 37222 0000311B CD21                    	int	21h			; we are not checking for err
 37223 0000311D 9D                      	popf
 37224                                  sd_err:
 37225                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37226                                  	; 11/12/2022 ; *
 37227 0000311E 1F                      	pop     ds ; *
 37228 0000311F C3                      	retn
 37229                                  
 37230                                  ;----------------------------------------------------------------------------
 37231                                  ;
 37232                                  ; procedure : ExecDev
 37233                                  ;
 37234                                  ;	Input : ds:dx -> device to be executed
 37235                                  ;		DevLoadAddr - contains where device has to be loaded
 37236                                  ;
 37237                                  ;	Output : Carry if error
 37238                                  ;		 Carry clear if no error
 37239                                  ;
 37240                                  ;	Loads a device driver using the 4b03h function call
 37241                                  ;
 37242                                  ;----------------------------------------------------------------------------
 37243                                  
 37244                                  	; 01/11/2022
 37245                                  ExecDev:
 37246 00003120 2E8B1E[5A1F]            	mov	bx,[cs:DevLoadAddr]
 37247 00003125 2E891E[721F]            	mov	[cs:DevExecAddr],bx	; Load the parameter block
 37248                                  					;  block for exec with
 37249                                  					;  load address
 37250 0000312A 2E891E[741F]            	mov	[cs:DevExecReloc],bx
 37251 0000312F 8CCB                    	mov	bx,cs
 37252 00003131 8EC3                    	mov	es,bx
 37253 00003133 BB[721F]                	mov	bx,DevExecAddr		; es:bx points to parameters
 37254                                  	;mov	al,3	; (load program only)
 37255                                  	;mov	ah,EXEC ; 4Bh
 37256                                  	; 04/07/2023
 37257 00003136 B8034B                  	mov	ax,(EXEC<<8)|03h
 37258 00003139 CD21                    	int	21h			; load in the device driver
 37259                                   		; DOS - 2+ - LOAD OR EXECUTE (EXEC)
 37260                                  		; DS:DX -> ASCIZ filename
 37261                                  		; ES:BX -> parameter block
 37262                                  		; AL = subfunction 
 37263 0000313B C3                      	retn
 37264                                  
 37265                                  ;----------------------------------------------------------------------------
 37266                                  ;
 37267                                  ; procedure : RetFromUM
 37268                                  ;
 37269                                  ;	Input : None
 37270                                  ;	Output : ConvLoad set if didn't previously call HideUMBs
 37271                                  ;		 ConvLoad clear if did.
 37272                                  ;
 37273                                  ;	Prepares memory for more devices after returning from loading one
 37274                                  ;	using the DOS 6 options (/L:... etc).
 37275                                  ;
 37276                                  ;----------------------------------------------------------------------------
 37277                                  
 37278                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 37279                                  ;  (SYSINIT:37D1h)
 37280                                  
 37281                                  ; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37282                                  ;%if 0
 37283                                  RetFromUM:
 37284                                  	; 31/12/2022
 37285                                  	; ds = cs
 37286 0000313C 9C                      	pushf
 37287                                  	;mov	byte [cs:ConvLoad],1
 37288 0000313D C606[661F]01            	mov	byte [ConvLoad],1
 37289 00003142 E8ECFD                  	call	UnHideUMBs
 37290 00003145 7204                    	jc	short rfUM1		; Skip this if didn't HideUMBs
 37291                                  	; 31/12/2022
 37292                                  	; ds = cs
 37293                                  	;;mov	byte [cs:ConvLoad],0
 37294                                  	;mov	byte [ConvLoad],0
 37295                                  	; 09/09/2023
 37296 00003147 FE0E[661F]              	dec	byte [ConvLoad] ; -> 0
 37297                                  rfUM1:	
 37298 0000314B 9D                      	popf
 37299 0000314C C3                      	retn
 37300                                  
 37301                                  ;%endif ; 01/11/2022
 37302                                  
 37303                                  ;----------------------------------------------------------------------------
 37304                                  ;
 37305                                  ; procedure : RemoveNull
 37306                                  ;
 37307                                  ;	Input : ES:SI points to a null terminated string
 37308                                  ;
 37309                                  ;	Output : none
 37310                                  ;
 37311                                  ;	Replaces the null at the end of a string with blank
 37312                                  ;
 37313                                  ;----------------------------------------------------------------------------
 37314                                  
 37315                                  	; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 37316                                  	; (SYSINIT:2CCEh)
 37317                                  RemoveNull:
 37318                                  	; 11/12/2022
 37319                                  	; ds = cs
 37320                                  rn_next:
 37321 0000314D 268A1C                  	mov	bl,[es:si]
 37322 00003150 08DB                    	or	bl,bl			; null ?
 37323 00003152 7403                    	jz	short rn_gotnull
 37324 00003154 46                      	inc	si			; advance the pointer
 37325 00003155 EBF6                    	jmp	short rn_next
 37326                                  rn_gotnull:
 37327                                  	; 11/12/2022
 37328 00003157 8A1E[8B1F]              	mov	bl,[DevSavedDelim]
 37329                                  	;mov	bl,[cs:DevSavedDelim]
 37330 0000315B 26881C                  	mov	[es:si],bl		; replace null with blank
 37331                                  	; 02/11/2022
 37332                                  ; 11/12/2022
 37333                                  rba_ok:		; 10/04/2019
 37334 0000315E C3                      	retn
 37335                                  
 37336                                  ;----------------------------------------------------------------------------
 37337                                  ;
 37338                                  ; procedure : RoundBreakAddr
 37339                                  ;
 37340                                  ;	Input : DevBrkAddr
 37341                                  ;	Output : DevBrkAddr
 37342                                  ;
 37343                                  ;	Rounds DevBrkAddr to a para address so that it is of the form xxxx:0
 37344                                  ;
 37345                                  ;----------------------------------------------------------------------------
 37346                                  
 37347                                  RoundBreakAddr:
 37348 0000315F 2EA1[621F]              	mov	ax,[cs:DevBrkAddr]
 37349 00003163 E8E0DF                  	call	ParaRound
 37350 00003166 2E0106[641F]            	add	[cs:DevBrkAddr+2],ax
 37351 0000316B 2EC706[621F]0000        	mov	word [cs:DevBrkAddr],0
 37352 00003172 2EA1[5C1F]              	mov	ax,[cs:DevLoadEnd]
 37353 00003176 2E3906[641F]            	cmp	[cs:DevBrkAddr+2],ax
 37354 0000317B 76E1                    	jbe	short rba_ok
 37355 0000317D E92711                  	jmp	mem_err
 37356                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37357                                  	; 11/12/2022
 37358                                  ;rba_ok:
 37359                                  ;	retn
 37360                                  
 37361                                  ;----------------------------------------------------------------------------
 37362                                  ;
 37363                                  ; procedure : DevSetBreak
 37364                                  ;
 37365                                  ;	Input : DevBrkAddr
 37366                                  ;	Output : Carry set if Device returned Init failed
 37367                                  ;		 Else carry clear
 37368                                  ;
 37369                                  ;----------------------------------------------------------------------------
 37370                                  
 37371                                  DevSetBreak:
 37372 00003180 50                      	push	ax
 37373                                  
 37374 00003181 2EA1[641F]              	mov	ax,[cs:DevBrkAddr+2]	 ;remove the init code
 37375 00003185 2E803E[B514]00          	cmp	byte [cs:multdeviceflag],0
 37376 0000318B 750F                    	jne	short set_break_continue ;do not check it.
 37377 0000318D 2E3B06[5A1F]            	cmp	ax,[cs:DevLoadAddr]
 37378 00003192 7508                    	jne	short set_break_continue ;if not same, then o.k.
 37379                                  
 37380                                  	;cmp	word [cs:DevBrkAddr],0
 37381                                  	;je	short break_failed	;[DevBrkAddr+2]=[memhi] & [DevBrkAddr]=0
 37382                                  	; 12/12/2022
 37383 00003194 2E833E[621F]01          	cmp	word [cs:DevBrkAddr],1
 37384 0000319A 7204                    	jb	short break_failed
 37385                                  
 37386                                  set_break_continue:
 37387 0000319C E8C0FF                  	call	RoundBreakAddr
 37388                                  	; 12/12/2022
 37389 0000319F F8                      	clc
 37390                                  break_failed:
 37391 000031A0 58                      	pop	ax
 37392                                  	;clc
 37393 000031A1 C3                      	retn
 37394                                  
 37395                                  	; 12/12/2022
 37396                                  ;break_failed:
 37397                                  	;pop	ax
 37398                                  	;stc
 37399                                  	;retn
 37400                                  
 37401                                  ;----------------------------------------------------------------------------
 37402                                  ;
 37403                                  ; procedure : DevBreak
 37404                                  ;
 37405                                  ;	Input : DevLoadAddr & DevBrkAddr
 37406                                  ;	Output : none
 37407                                  ;
 37408                                  ;	Marks a succesful install of a device driver
 37409                                  ;	Sets device size field in sub-arena &
 37410                                  ;	Updates Free ptr in UMB or adjusts memhi
 37411                                  ;
 37412                                  ;----------------------------------------------------------------------------
 37413                                  
 37414                                  	; 11/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 37415                                  DevBreak:
 37416                                  	;push	ds ; 11/12/2022
 37417                                  
 37418                                  	; 11/12/2022
 37419 000031A2 0E                      	push	cs
 37420 000031A3 1F                      	pop	ds
 37421                                  	;mov	ax,[cs:DevLoadAddr]
 37422                                  	;mov	bx,[cs:DevBrkAddr+2]
 37423 000031A4 A1[5A1F]                	mov	ax,[DevLoadAddr]
 37424 000031A7 8B1E[641F]              	mov	bx,[DevBrkAddr+2]
 37425                                  	; 11/12/2022
 37426 000031AB 1E                      	push	ds
 37427                                  
 37428 000031AC 48                      	dec	ax			; seg of sub-arena
 37429 000031AD 8ED8                    	mov	ds,ax
 37430 000031AF 40                      	inc	ax			; Back to Device segment
 37431 000031B0 29D8                    	sub	ax,bx
 37432 000031B2 F7D8                    	neg	ax			; size of device in paras
 37433 000031B4 A30300                  	mov	[devmark.size],ax	; store it in sub-arena
 37434                                  	
 37435                                  	; 11/12/2022
 37436 000031B7 1F                      	pop	ds
 37437                                  	; ds = cs
 37438                                   	
 37439 000031B8 803E[761F]00            	cmp	byte [DeviceHi],0
 37440                                  	;cmp	byte [cs:DeviceHi],0
 37441 000031BD 7405                    	je	short db_lo
 37442                                  	;mov	[cs:DevUMBFree],bx	; update Free ptr in UMB
 37443                                  	;jmp	short db_exit
 37444                                  	; 11/12/2022
 37445 000031BF 891E[6C1F]              	mov	[DevUMBFree],bx
 37446 000031C3 C3                      	retn	
 37447                                  db_lo:
 37448                                  	; 11/12/2022
 37449                                  	; ds = cs
 37450                                  	;mov	[cs:memhi],bx
 37451                                  	;mov	word [cs:memlo],0
 37452 000031C4 891E[6403]              	mov	[memhi],bx
 37453 000031C8 C706[6203]0000          	mov	word [memlo],0 ; 18/12/2022
 37454                                  db_exit:
 37455                                  	;pop	ds ; 11/12/2022
 37456                                  	; 17/09/2023
 37457                                  ;sd_ret:	; 09/09/2023
 37458 000031CE C3                      	retn
 37459                                  
 37460                                  ; 10/04/2019 - Retro DOS v4.0
 37461                                  
 37462                                  ;----------------------------------------------------------------------------
 37463                                  ;
 37464                                  ; procedure : ParseSize
 37465                                  ;
 37466                                  ;	Parses the command line for SIZE= command
 37467                                  ;
 37468                                  ;	ES:SI = command line to parsed
 37469                                  ;
 37470                                  ;	returns ptr to command line after SIZE= option in ES:SI
 37471                                  ;	updates the DevSizeOption variable with value supplied
 37472                                  ;	in SIZE=option
 37473                                  ;	Returns carry if the SIZE option was invalid
 37474                                  ;
 37475                                  ;----------------------------------------------------------------------------
 37476                                  
 37477                                  	; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 37478                                  	; (SYSINIT:2D5Ah)
 37479                                  
 37480                                  	; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization) ((&BugFix))
 37481                                  	; (MSDOS 6.21 IO.SYS - SYSINIT:3871h) - Retro DOS v4.2 -
 37482                                  	; (PCDOS 7.1 IO.SYS - SYSINIT:3D6Eh)  - Retro DOS v5.0 -
 37483                                  ParseSize:
 37484                                  	;push	bx
 37485                                  	;mov	bx,si
 37486                                  
 37487                                  	; 09/09/2023
 37488 000031CF 56                      	push	si ; * ; mov bx,si
 37489                                  
 37490                                  	; 11/12/2022
 37491                                  	; ds = cs
 37492                                  	;mov	word [cs:DevSizeOption],0 ; init the value
 37493                                  	;mov	[cs:DevCmdLine],si
 37494                                  	;mov	[cs:DevCmdLine+2],es
 37495 000031D0 C706[771F]0000          	mov	word [DevSizeOption],0 ; init the value
 37496 000031D6 8936[871F]              	mov	[DevCmdLine],si
 37497 000031DA 8C06[891F]              	mov	[DevCmdLine+2],es	
 37498 000031DE E82400                  	call	SkipDelim
 37499 000031E1 26813C5349              	cmp	word [es:si],'SI' ; 4953h
 37500 000031E6 7528                    	jne	short ps_no_size
 37501 000031E8 26817C025A45            	cmp	word [es:si+2],'ZE' ; 455Ah
 37502 000031EE 7520                    	jne	short ps_no_size
 37503 000031F0 268A4404                	mov	al,[es:si+4]
 37504 000031F4 E80B10                  	call	delim
 37505                                  	;jne	short ps_no_size
 37506                                  	; 22/07/2023
 37507 000031F7 7518                    	jne	short ps_no_size_2 ; cf=0 here
 37508 000031F9 83C605                  	add	si,5
 37509 000031FC E81400                  	call	GetHexNum
 37510 000031FF 7210                    	jc	short ps_err
 37511                                  	; 11/12/2022
 37512                                  	; ds = cs
 37513                                  	;mov	[cs:DevSizeOption],ax
 37514 00003201 A3[771F]                	mov	[DevSizeOption],ax
 37515                                  	
 37516                                  	; 09/09/2023
 37517 00003204 58                      	pop	ax  ; * (discard previous si value on top of stack)
 37518                                  
 37519                                  ;	call	SkipDelim
 37520                                  ;	
 37521                                  ;	; 22/07/2023
 37522                                  ;;ps_no_size_2:
 37523                                  ;	; cf = 0
 37524                                  ;	retn
 37525                                  
 37526                                  	; 09/09/2023
 37527                                  	;jmp	short SkipDelim
 37528                                  
 37529                                  ; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 37530                                  %if 1
 37531                                  	; 01/11/2022
 37532                                  SkipDelim:
 37533                                  sd_next_char:
 37534 00003205 268A04                  	mov	al,[es:si]
 37535 00003208 E8F70F                  	call	delim
 37536 0000320B 7505                    	jnz	short sd_ret ; cf=0 ; 09/09/2023
 37537 0000320D 46                      	inc	si
 37538 0000320E EBF5                    	jmp	short sd_next_char ; 01/11/2022
 37539                                  	; 11/12/2022
 37540                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37541                                  ;sd_ret:
 37542                                  	;retn
 37543                                  %endif
 37544                                  
 37545                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37546                                  	;mov	bx,si
 37547                                  ps_no_size:
 37548                                  	;mov	si,bx
 37549                                  	;pop	bx
 37550 00003210 F8                      	clc	; cf=0
 37551                                  	;retn
 37552                                  	; 11/12/2022
 37553                                  ps_err:		; cf=1
 37554                                  ps_no_size_2:	; 09/09/2023 (cf=0)
 37555                                  	; 09/09/2023
 37556 00003211 5E                      	pop	si ; * ; mov si,bx
 37557                                  	; 17/09/2023
 37558                                  sd_ret:	; cf=?
 37559 00003212 C3                      	retn
 37560                                  
 37561                                  ;ps_err:
 37562                                  	; 02/11/2022
 37563                                  	;pop	bx
 37564                                  	;stc
 37565                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37566                                  	; 11/12/2022
 37567                                  	; cf=1
 37568                                  	;stc
 37569                                  	; 11/12/2022
 37570                                  ;sd_ret: 
 37571                                  	; 22/07/2023
 37572                                  	; 12/04/2019
 37573                                  	;retn
 37574                                  
 37575                                  ; 12/04/2019 - Retro DOS v4.0
 37576                                  
 37577                                  ;----------------------------------------------------------------------------
 37578                                  ;
 37579                                  ; procedure : SkipDelim
 37580                                  ;
 37581                                  ;	Skips delimiters in the string pointed to by ES:SI
 37582                                  ;	Returns ptr to first non-delimiter character in ES:SI
 37583                                  ;
 37584                                  ;----------------------------------------------------------------------------
 37585                                  
 37586                                  ; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 37587                                  %if 0
 37588                                  	; 01/11/2022
 37589                                  SkipDelim:
 37590                                  sd_next_char:
 37591                                  	mov	al,[es:si]
 37592                                  	call	delim
 37593                                  	jnz	short sd_ret
 37594                                  	inc	si
 37595                                  	jmp	short sd_next_char ; 01/11/2022
 37596                                  	; 11/12/2022
 37597                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37598                                  ;sd_ret:
 37599                                  	;retn
 37600                                  %endif
 37601                                  
 37602                                  ;----------------------------------------------------------------------------
 37603                                  ;
 37604                                  ; procedure : GetHexNum
 37605                                  ;
 37606                                  ;	Converts an ascii string terminated by a delimiter into binary.
 37607                                  ;	Assumes that the ES:SI points to a Hexadecimal string
 37608                                  ;
 37609                                  ;	Returns in AX the number of paras equivalent to the
 37610                                  ;	hex number of bytes specified by the hexadecimal string.
 37611                                  ;
 37612                                  ;	Returns carry in case it encountered a non-hex character or
 37613                                  ;	if it encountered crlf
 37614                                  ;
 37615                                  ;----------------------------------------------------------------------------
 37616                                  
 37617                                  ; 13/05/2019
 37618                                  
 37619                                  	; 03/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 37620                                  	; (SYSINIT:38C5h)
 37621                                  
 37622                                  	; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 37623                                  	; (SYSINIT:2DA5h)
 37624                                  GetHexNum:
 37625 00003213 31C0                    	xor	ax,ax
 37626 00003215 31D2                    	xor	dx,dx
 37627                                  ghn_next:
 37628 00003217 268A1C                  	mov	bl,[es:si]
 37629 0000321A 80FB0D                  	cmp	bl,cr  ; 0Dh
 37630 0000321D 7436                    	je	short ghn_err
 37631 0000321F 80FB0A                  	cmp	bl,lf  ; 0Ah
 37632 00003222 7431                    	je	short ghn_err
 37633 00003224 50                      	push	ax
 37634 00003225 88D8                    	mov	al,bl
 37635 00003227 E8D80F                  	call	delim
 37636 0000322A 58                      	pop	ax
 37637                                  	; 03/01/2023
 37638 0000322B B90400                  	mov	cx,4
 37639 0000322E 7410                    	jz	short ghn_into_paras
 37640 00003230 E82400                  	call	GetNibble
 37641                                  	;jc	short ghn_err
 37642                                  	; 11/12/2022
 37643 00003233 7221                    	jc	short ghn_ret ; cf=1
 37644                                  	; 03/01/2023
 37645                                  	;mov	cx,4
 37646                                  ghn_shift1:
 37647 00003235 D1E0                    	shl	ax,1
 37648 00003237 D1D2                    	rcl	dx,1
 37649 00003239 E2FA                    	loop	ghn_shift1
 37650 0000323B 08D8                    	or	al,bl
 37651 0000323D 46                      	inc	si
 37652 0000323E EBD7                    	jmp	short ghn_next
 37653                                  ghn_into_paras:
 37654 00003240 83C00F                  	add	ax,15
 37655 00003243 83D200                  	adc	dx,0
 37656 00003246 F7C2F0FF                	test	dx,0FFF0h
 37657 0000324A 7509                    	jnz	short ghn_err
 37658                                  	; 03/01/2023
 37659                                  	;mov	cx,4
 37660                                  ghn_shift2:
 37661 0000324C F8                      	clc
 37662 0000324D D1DA                    	rcr	dx,1
 37663 0000324F D1D8                    	rcr	ax,1
 37664 00003251 E2F9                    	loop	ghn_shift2
 37665 00003253 F8                      	clc
 37666 00003254 C3                      	retn
 37667                                  	; 11/12/2022
 37668                                  ghn_err:
 37669                                  gnib_err:
 37670 00003255 F9                      	stc
 37671                                  ghn_ret:
 37672                                  gnib_ret:
 37673 00003256 C3                      	retn
 37674                                  
 37675                                  ;----------------------------------------------------------------------------
 37676                                  ;
 37677                                  ; procedure : GetNibble
 37678                                  ;
 37679                                  ;	Convert one nibble (hex digit) in BL into binary
 37680                                  ;
 37681                                  ;	Returns binary value in BL
 37682                                  ;
 37683                                  ;	Returns carry if BL contains non-hex digit
 37684                                  ;
 37685                                  ;----------------------------------------------------------------------------
 37686                                  
 37687                                  GetNibble:
 37688 00003257 80FB30                  	cmp	bl,'0'
 37689                                  	;jb	short gnib_err
 37690                                  	; 11/12/2022
 37691 0000325A 72FA                    	jb	short gnib_ret ; cf=1
 37692 0000325C 80FB39                  	cmp	bl,'9'
 37693 0000325F 7704                    	ja	short is_it_hex
 37694 00003261 80EB30                  	sub	bl,'0'		; clc
 37695 00003264 C3                      	retn
 37696                                  is_it_hex:
 37697 00003265 80FB41                  	cmp	bl,'A'
 37698                                  	;jb	short gnib_err
 37699                                  	; 11/12/2022
 37700 00003268 72EC                    	jb	short gnib_ret ; cf=1
 37701 0000326A 80FB46                  	cmp	bl,'F'
 37702 0000326D 77E6                    	ja	short gnib_err ; 11/12/2022
 37703 0000326F 80EB37                  	sub	bl,'A'- 10	; clc
 37704 00003272 C3                      	retn
 37705                                  
 37706                                  	; 11/12/2022
 37707                                  ;gnib_err:
 37708                                  ;	stc
 37709                                  ;gnib_ret:
 37710                                  ;	retn
 37711                                  
 37712                                  ;============================================================================
 37713                                  
 37714                                  ; 12/04/2019 - Retro DOS v4.0
 37715                                  
 37716                                  ; umb.inc (MSDOS 6.0, 1991)
 37717                                  DOS_ARENA	equ 24h		; offset of arena_head var in DOS data segm.
 37718                                  UMB_ARENA	equ 8Ch		; offset of umb_head in DOS data
 37719                                  
 37720                                  XMM_REQUEST_UMB	equ 10h
 37721                                  XMM_RELEASE_UMB	equ 11h
 37722                                  
 37723                                  ; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 37724                                  
 37725                                  ;---------------------------------------------------------------------------
 37726                                  ;
 37727                                  ; Procedure Name	: umb_insert
 37728                                  ;
 37729                                  ; Inputs		: DOSDATA:UMB_HEAD = start of umb chain
 37730                                  ;			: BX = seg address of UMB to be linked in
 37731                                  ;			: DX = size of UMB to be linked in paras
 37732                                  ;			; DS = data
 37733                                  ;
 37734                                  ; Outputs		: links the UMB into the arena chain
 37735                                  ;
 37736                                  ; Uses			: AX, CX, ES, DX, BX
 37737                                  ;
 37738                                  ;---------------------------------------------------------------------------
 37739                                  
 37740                                  umb_insert:
 37741 00003273 1E                      	push	ds
 37742                                  
 37743                                  	; 31/12/2022
 37744                                  	; ds = cs
 37745                                  
 37746                                  	;mov	ds,[cs:DevDOSData]
 37747 00003274 8E1E[851F]              	mov	ds,[DevDOSData] ; 31/12/2022 
 37748                                  	;mov	ds,[8Ch]
 37749 00003278 8E1E8C00                	mov	ds,[UMB_ARENA]		; es = UMB_HEAD
 37750 0000327C 8CD8                    	mov	ax,ds
 37751 0000327E 8EC0                    	mov	es,ax
 37752                                  ui_next:
 37753 00003280 39D8                    	cmp	ax,bx			; Q: is current block above
 37754                                  					;    new block
 37755 00003282 770F                    	ja	short ui_insert		; Y: insert it
 37756                                  					; Q: is current block the
 37757                                  					;    last
 37758 00003284 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],arena_signature_end ; 'Z'
 37759 0000328A 745C                    	je	short ui_append		; Y: append new block to chain
 37760                                  					; N: get next block
 37761 0000328C 8ED8                    	mov	ds,ax			; M005
 37762                                  	;call	get_next		; ax = es = next block
 37763 0000328E E83B01                  	call	_get_next_ ; 13/04/2019 - Retro DOS v4.0
 37764 00003291 EBED                    	jmp	short ui_next
 37765                                  
 37766                                  ui_insert:
 37767 00003293 8CD9                    	mov	cx,ds			; ds = previous arena
 37768 00003295 41                      	inc	cx			; top of previous block
 37769                                  
 37770 00003296 29D9                    	sub	cx,bx
 37771 00003298 F7D9                    	neg	cx			; cx = size of used block
 37772                                  	;mov	byte [0],'M'
 37773 0000329A C60600004D              	mov	byte [ARENA.SIGNATURE],arena_signature_normal ; 'M'
 37774                                  	;mov	word [1],8
 37775 0000329F C70601000800            	mov	word [ARENA.OWNER],8	; mark as system owned
 37776                                  	;mov	[3],cx
 37777 000032A5 890E0300                	mov	[ARENA.SIZE],cx	
 37778                                  	;mov	word [8],4353h ; 'SC'
 37779 000032A9 C70608005343            	mov	word [ARENA.NAME],'SC' ; 4353h
 37780                                  
 37781                                  ; prepare the arena at start of new block
 37782                                  
 37783 000032AF 8EC3                    	mov	es,bx
 37784 000032B1 26C60600004D            	mov	byte [es:ARENA.SIGNATURE],arena_signature_normal ; 'M'
 37785 000032B7 26C70601000000          	mov	word [es:ARENA.OWNER],arena_owner_system ; 0
 37786                                  					; mark as free
 37787 000032BE 83EA02                  	sub	dx,2			; make room for arena at
 37788                                  					; start & end of new block
 37789 000032C1 2689160300              	mov	[es:ARENA.SIZE],dx
 37790                                  
 37791                                  ; prepare arena at end of new block
 37792                                  	
 37793 000032C6 01D3                    	add	bx,dx
 37794 000032C8 43                      	inc	bx
 37795 000032C9 8EC3                    	mov	es,bx			; es=arena at top of new block
 37796 000032CB 43                      	inc	bx			; bx=top of new block
 37797                                  
 37798                                  					; ax contains arena just above
 37799                                  					; this block
 37800 000032CC 29D8                    	sub	ax,bx			; ax = size of used block
 37801                                  	
 37802 000032CE 26C60600004D            	mov	byte [es:ARENA.SIGNATURE],arena_signature_normal
 37803 000032D4 26C70601000800          	mov	word [es:ARENA.OWNER],8	; mark as system owned
 37804 000032DB 26A30300                	mov	[es:ARENA.SIZE],ax	
 37805 000032DF 26C70608005343          	mov	word [es:ARENA.NAME],'SC' ; 4353h
 37806                                  
 37807 000032E6 EB47                    	jmp	short ui_done
 37808                                  
 37809                                  ui_append:
 37810                                  					; es = arena of last block	
 37811 000032E8 2603060300              	add	ax,[es:ARENA.SIZE]	; ax=top of last block-1 para
 37812 000032ED 26832E030001            	sub	word [es:ARENA.SIZE],1	; reflect the space we are
 37813                                  					; going to rsrv on top of this 
 37814                                  					; block for the next arena.
 37815                                  	; 13/05/2019
 37816 000032F3 26C60600004D            	mov	byte [es:ARENA.SIGNATURE],arena_signature_normal
 37817                                  
 37818 000032F9 89C1                    	mov	cx,ax			; cx=top of prev block-1
 37819 000032FB 40                      	inc	ax
 37820 000032FC 29D8                    	sub	ax,bx			; ax=top of prev block - 
 37821                                  					;    seg. address of new block
 37822 000032FE F7D8                    	neg	ax
 37823                                  
 37824 00003300 8EC1                    	mov	es,cx			; ds = arena of unused block
 37825                                  
 37826 00003302 26C60600004D            	mov	byte [es:ARENA.SIGNATURE],arena_signature_normal
 37827 00003308 26C70601000800          	mov	word [es:ARENA.OWNER],8	; mark as system owned
 37828 0000330F 26A30300                	mov	[es:ARENA.SIZE],ax	
 37829 00003313 26C70608005343          	mov	word [es:ARENA.NAME],'SC'
 37830                                  
 37831                                  ; prepare the arena at start of new block
 37832 0000331A 8EC3                    	mov	es,bx
 37833 0000331C 26C60600005A            	mov	byte [es:ARENA.SIGNATURE],arena_signature_end
 37834 00003322 26C70601000000          	mov	word [es:ARENA.OWNER],arena_owner_system
 37835                                  					; mark as free
 37836 00003329 4A                      	dec	dx			; make room for arena
 37837 0000332A 2689160300              	mov	[es:ARENA.SIZE],dx	
 37838                                  ui_done:
 37839                                  uc_done: ; 31/12/2022 ; *!
 37840 0000332F 1F                      	pop	ds
 37841                                  	; ds = cs ; 31/12/2022
 37842                                  ;uc_done:	; 18/12/2022
 37843                                  au_exit:	; 09/09/2023
 37844 00003330 C3                      	retn
 37845                                  
 37846                                  ;----------------------------------------------------------------------------
 37847                                  ;
 37848                                  ; procedure : AllocUMB
 37849                                  ;
 37850                                  ;	Allocate all UMBs and link it to DOS arena chain
 37851                                  ;
 37852                                  ;----------------------------------------------------------------------------
 37853                                  
 37854                                  AllocUMB:
 37855                                  	; 31/12/2022
 37856                                  	; ds = cs
 37857 00003331 E84700                  	call	InitAllocUMB		; link in the first UMB
 37858 00003334 72FA                    	jc	short au_exit		; quit on error
 37859                                  au_next:
 37860 00003336 E87000                  	call	umb_allocate		; allocate
 37861 00003339 7205                    	jc	short au_coalesce
 37862 0000333B E835FF                  	call	umb_insert		; & insert till no UMBs
 37863 0000333E EBF6                    	jmp	short au_next
 37864                                  au_coalesce:
 37865                                  	; 09/09/2023
 37866                                  ;	call	umb_coalesce		; coalesce all UMBs
 37867                                  ;au_exit:
 37868                                  ;	; 31/12/2022
 37869                                  ;	; ds = cs
 37870                                  ;	retn
 37871                                  
 37872                                  	; 09/09/2023
 37873                                  	;jmp	short umb_coalesce
 37874                                  
 37875                                  ; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 37876                                  
 37877                                  ; 13/04/2019 - Retro DOS v4.0
 37878                                  
 37879                                  ;----------------------------------------------------------------------------
 37880                                  ;
 37881                                  ;**	umb_coalesce - Combine free blocks ahead with current block
 37882                                  ;
 37883                                  ;	Coalesce adds the block following the argument to the argument block,
 37884                                  ;	if it's free.  Coalesce is usually used to join free blocks, but
 37885                                  ;	some callers (such as $setblock) use it to join a free block to it's
 37886                                  ;	preceeding allocated block.
 37887                                  ;
 37888                                  ;	EXIT	'C' clear if OK
 37889                                  ;		  (ds) unchanged, this block updated
 37890                                  ;		  (ax) = address of next block, IF not at end
 37891                                  ;		'C' set if arena trashed
 37892                                  ;	USES	cx, di, ds, es
 37893                                  ;
 37894                                  ;----------------------------------------------------------------------------
 37895                                  
 37896                                  umb_coalesce:
 37897                                  	; 31/12/2022
 37898                                  	; ds = cs
 37899 00003340 1E                      	push	ds ; *!
 37900                                  
 37901 00003341 31FF                    	xor	di, di
 37902                                  
 37903                                  	;mov	es,[cs:DevDOSData]
 37904                                  	; 31/12/2022
 37905 00003343 8E06[851F]              	mov	es,[DevDOSData]
 37906 00003347 268E068C00              	mov	es,[es:UMB_ARENA]	; es = UMB_HEAD
 37907                                  uc_nextfree:
 37908 0000334C 8CC0                    	mov	ax,es
 37909 0000334E 8ED8                    	mov	ds,ax
 37910                                  	;cmp	[es:1],di
 37911 00003350 26393E0100              	cmp	[es:ARENA.OWNER],di	; Q: is current arena free
 37912 00003355 7407                    	je	short uc_again		; Y: try to coalesce with next block
 37913                                  					; N: get next arena
 37914 00003357 E86B00                  	call	get_next		; es, ax = next arena
 37915 0000335A 72D3                    	jc	short uc_done	; *!
 37916 0000335C EBEE                    	jmp	short uc_nextfree
 37917                                  uc_again:
 37918 0000335E E86400                  	call	get_next		; es, ax = next arena
 37919 00003361 72CC                    	jc	short uc_done	; *!
 37920                                  uc_check:
 37921 00003363 26393E0100              	cmp     [es:ARENA.OWNER],di	; Q: is arena free
 37922 00003368 75E2                    	jne	short uc_nextfree	; N: get next free arena
 37923                                  					; Y: coalesce
 37924 0000336A 268B0E0300              	mov     cx,[es:ARENA.SIZE]      ; cx <- next block size
 37925 0000336F 41                      	inc     cx                      ; cx <- cx + 1 (for header size)
 37926                                  	;add	[3],cx
 37927 00003370 010E0300                	add     [ARENA.SIZE],cx		; current size <- current size + cx
 37928 00003374 268A0D                  	mov     cl,[es:di]              ; move up signature
 37929 00003377 880D                    	mov     [di],cl
 37930 00003379 EBE3                    	jmp     short uc_again		; try again
 37931                                  
 37932                                  	; 18/12/2022
 37933                                  ;uc_done:
 37934                                  	;retn
 37935                                  
 37936                                  ;----------------------------------------------------------------------------
 37937                                  ;
 37938                                  ; procedure : InitAllocUMB
 37939                                  ;
 37940                                  ;----------------------------------------------------------------------------
 37941                                  
 37942                                  InitAllocUMB:
 37943                                  	; 31/12/2022
 37944                                  	; ds = cs
 37945 0000337B E828D7                  	call	IsXMSLoaded
 37946 0000337E 7527                    	jnz	short iau_err		; quit on no XMS driver
 37947 00003380 B452                    	mov	ah,52h
 37948 00003382 CD21                    	int	21h			; get DOS DATA seg
 37949                                  	; 31/12/2022
 37950                                  	; ds = cs
 37951                                  	;mov	[cs:DevDOSData],es	; & save it for later
 37952 00003384 8C06[851F]              	mov	[DevDOSData],es		; & save it for later
 37953 00003388 B81043                  	mov	ax,4310h
 37954 0000338B CD2F                    	int	2Fh
 37955                                  	;mov	[cs:DevXMSAddr],bx	; get XMS driver address
 37956                                  	;mov	[cs:DevXMSAddr+2],es
 37957 0000338D 891E[6E1F]              	mov	[DevXMSAddr],bx		; get XMS driver address
 37958 00003391 8C06[701F]              	mov	[DevXMSAddr+2],es	
 37959                                  	; 31/12/2022
 37960 00003395 803E[841F]00            	cmp	byte [FirstUMBLinked],0 
 37961                                  	;cmp	byte [cs:FirstUMBLinked],0 ; have we already linked a UMB?
 37962                                  	;jne	short ia_1		; quit if we already did it
 37963                                  	; 12/12/2022
 37964 0000339A 770A                    	ja	short ia_1 ; cf=0
 37965 0000339C E83900                  	call	LinkFirstUMB		; else link the first UMB
 37966                                  	;jc	short iau_err
 37967                                  	; 12/12/2022
 37968 0000339F 7207                    	jc	short iau_err2  ; cf=1
 37969                                  	; 31/12/2022
 37970                                  	; ds = cs
 37971 000033A1 C606[841F]FF            	mov	byte [FirstUMBLinked],0FFh ; mark that 1st UMB linked
 37972                                  	;mov	byte [cs:FirstUMBLinked],0FFh ; mark that 1st UMB linked
 37973                                  ia_1:
 37974                                  	; 12/12/2022
 37975                                  	; cf=0
 37976                                  	;clc
 37977 000033A6 C3                      	retn
 37978                                  iau_err:
 37979 000033A7 F9                      	stc
 37980                                  iau_err2:
 37981 000033A8 C3                      	retn
 37982                                  
 37983                                  ;-------------------------------------------------------------------------
 37984                                  ;
 37985                                  ; Procedure Name	: umb_allocate
 37986                                  ;
 37987                                  ; Inputs		: DS = data
 37988                                  ;
 37989                                  ; Outputs		: if UMB available
 37990                                  ;				Allocates the largest available UMB and 
 37991                                  ;			  	BX = segment of allocated block
 37992                                  ;				DX = size of allocated block
 37993                                  ;				NC
 37994                                  ;			  else 
 37995                                  ;				CY
 37996                                  ;
 37997                                  ; Uses			: BX, DX
 37998                                  ;
 37999                                  ;-------------------------------------------------------------------------
 38000                                  
 38001                                  umb_allocate:
 38002                                  	; 31/12/2022
 38003                                  	; ds = cs
 38004 000033A9 50                      	push	ax
 38005 000033AA B410                    	mov	ah,XMM_REQUEST_UMB ; 16
 38006 000033AC BAFFFF                  	mov	dx,0FFFFh		; try to allocate largest
 38007                                  					;   possible
 38008                                  	; 31/12/2022
 38009 000033AF FF1E[6E1F]              	call	far [DevXMSAddr]
 38010                                  	;call	far [cs:DevXMSAddr]
 38011                                  					; dx now contains the size of
 38012                                  					; the largest UMB
 38013 000033B3 09D2                    	or	dx,dx
 38014 000033B5 740B                    	jz	short ua_err
 38015                                  	
 38016 000033B7 B410                    	mov	ah,XMM_REQUEST_UMB ; 16
 38017                                  
 38018                                  	; 31/12/2022
 38019 000033B9 FF1E[6E1F]              	call	far [DevXMSAddr]
 38020                                  	;call	far [cs:DevXMSAddr]
 38021                                  
 38022 000033BD 83F801                  	cmp	ax,1			; Q: was the reqst successful
 38023                                  	;jne	short ua_err		; N: error
 38024                                  	; 27/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 38025 000033C0 7601                    	jna	short ua_done ; if ax=1 then cf=0, else cf=1 (ax=0)
 38026                                  ua_err:
 38027 000033C2 F9                      	stc	
 38028                                  
 38029                                  	;clc
 38030                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38031                                  	; 12/12/2022
 38032                                  	; cf=0
 38033                                  	;clc 
 38034                                  ua_done:
 38035 000033C3 58                      	pop	ax
 38036 000033C4 C3                      	retn
 38037                                  	; 27/07/2023
 38038                                  ;ua_err:
 38039                                  	;stc
 38040                                  	;jmp	short ua_done
 38041                                  
 38042                                  ;----------------------------------------------------------------------------
 38043                                  ;
 38044                                  ;**	get_next - Find Next item in Arena
 38045                                  ;
 38046                                  ;	ENTRY	dS - pointer to block head
 38047                                  ;	EXIT	AX,ES - pointers to next head
 38048                                  ;		'C' set if arena damaged
 38049                                  ;
 38050                                  ;----------------------------------------------------------------------------
 38051                                  
 38052                                  	; 01/11/2022
 38053                                  get_next:
 38054 000033C5 803E00005A              	cmp	byte [0],arena_signature_end ; 'Z'
 38055 000033CA 740A                    	je	short gn_err
 38056                                  _get_next_:
 38057 000033CC 8CD8                    	mov     ax,ds                   ; ax=current block
 38058 000033CE 03060300                	add     ax,[ARENA.SIZE]		; ax=ax + current block length
 38059 000033D2 40                      	inc     ax                      ; remember that header!
 38060 000033D3 8EC0                    	mov	es,ax
 38061                                  	;clc
 38062                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38063                                  	; 11/12/2022
 38064                                  	; cf=0
 38065                                  	;clc
 38066 000033D5 C3                      	retn
 38067                                  gn_err:
 38068 000033D6 F9                      	stc
 38069                                  	; 11/12/2022	
 38070                                  lfu_err:	 ; cf=1
 38071 000033D7 C3                      	retn
 38072                                  
 38073                                  ;----------------------------------------------------------------------------
 38074                                  ;
 38075                                  ; procedure : LinkFirstUMB
 38076                                  ;
 38077                                  ;----------------------------------------------------------------------------
 38078                                  
 38079                                  	; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 38080                                  	; (SYSINIT:2F81h)
 38081                                  LinkFirstUMB:
 38082                                  	; 31/12/2022
 38083                                  	; ds = cs
 38084 000033D8 E8CEFF                  	call	umb_allocate
 38085 000033DB 72FA                    	jc	short lfu_err  ; ds = cs ; 31/12/2022
 38086                                  
 38087                                  ; bx = segment of allocated UMB
 38088                                  ; dx = size of UMB
 38089                                  
 38090                                  	; 31/12/2022
 38091                                  	; ds = cs
 38092                                  
 38093 000033DD CD12                    	int	12h			; ax = size of memory
 38094 000033DF B106                    	mov	cl,6
 38095 000033E1 D3E0                    	shl	ax,cl			; ax = size in paragraphs
 38096                                  
 38097 000033E3 89C1                    	mov	cx,ax			; cx = size in paras
 38098 000033E5 29D8                    	sub	ax,bx			; ax = - size of unused block
 38099                                  
 38100 000033E7 F7D8                    	neg	ax
 38101                                  
 38102                                  	;sub	cx,1			; cx = first umb_arena
 38103                                  	; 09/09/2023
 38104 000033E9 49                      	dec	cx
 38105 000033EA 8EC1                    	mov	es,cx			; es = first umb_arena
 38106                                  	
 38107 000033EC 26C60600004D            	mov	byte [es:ARENA.SIGNATURE],arena_signature_normal ; 'M'
 38108 000033F2 26C70601000800          	mov	word [es:ARENA.OWNER],8	; mark as system owned
 38109                                  					
 38110 000033F9 26A30300                	mov	[es:ARENA.SIZE],ax	
 38111 000033FD 26C70608005343          	mov	word [es:ARENA.NAME],'SC' ; 4353h
 38112                                  
 38113                                  ; put in the arena for the first UMB
 38114                                  
 38115 00003404 8EC3                    	mov	es,bx			; es has first free umb seg
 38116 00003406 26C60600005A            	mov	byte [es:ARENA.SIGNATURE],arena_signature_end ; 'Z'
 38117 0000340C 26C70601000000          	mov	word [es:ARENA.OWNER],arena_owner_system ; 0	
 38118                                  					; mark as free 
 38119 00003413 4A                      	dec	dx			; make room for arena
 38120 00003414 2689160300              	mov	[es:ARENA.SIZE],dx	
 38121                                  
 38122                                  	;mov	es,[cs:DevDOSData]
 38123                                  	; 31/12/2022
 38124 00003419 8E06[851F]              	mov	es,[DevDOSData] ; ds = cs
 38125                                  	; 18/09/2023
 38126 0000341D 26890E8C00              	mov	[es:UMB_ARENA],cx
 38127                                  	;mov	di,UMB_ARENA ; 8Ch
 38128                                  	;mov	[es:di],cx		; initialize umb_head in DOS
 38129                                  					;  data segment with the arena
 38130                                  					;  just below Top of Mem
 38131                                  
 38132                                  ; we must now scan the arena chain and update the size of the last arena
 38133                                  
 38134                                  	;mov	di,DOS_ARENA ; 24h
 38135                                  	;mov	es,[es:di]		; es = start arena
 38136                                  	; 18/09/2023
 38137 00003422 268E062400              	mov	es,[es:DOS_ARENA]
 38138 00003427 31FF                    	xor	di,di
 38139                                  ;scan_next
 38140                                  ; 09/12/2022
 38141                                  scannext:
 38142 00003429 26803D5A                	cmp	byte [es:di],arena_signature_end  ; 'Z'
 38143 0000342D 740C                    	je	short got_last
 38144                                  	
 38145 0000342F 8CC0                    	mov	ax,es
 38146 00003431 2603060300              	add	ax,[es:ARENA.SIZE]
 38147 00003436 40                      	inc	ax
 38148 00003437 8EC0                    	mov	es,ax
 38149                                  	;jmp	short scan_next
 38150                                  	; 09/12/2022
 38151 00003439 EBEE                    	jmp	short scannext
 38152                                  got_last:
 38153                                  	;sub	word [es:ARENA.SIZE],1
 38154                                  	; 09/09/2023
 38155 0000343B 26FF0E0300              	dec	word [es:ARENA.SIZE]
 38156                                  
 38157 00003440 26C60600004D            	mov	byte [es:ARENA.SIGNATURE],arena_signature_normal ; 'M'
 38158                                  	;clc
 38159                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38160                                  	; 11/12/2022
 38161                                  	; cf=0
 38162                                  	;clc
 38163 00003446 C3                      	retn
 38164                                  
 38165                                  ; 11/12/2022
 38166                                  ;;lfu_err:
 38167                                  ;	;stc
 38168                                  ;	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38169                                  ;	; 11/12/2022
 38170                                  ;	; cf=1
 38171                                  ;	;stc
 38172                                  ;	retn
 38173                                  
 38174                                  ;----------------------------------------------------------------------------
 38175                                  ;
 38176                                  ; procedure : ShrinkUMB
 38177                                  ;
 38178                                  ;	Shrinks the current UMB in use, so that the unused portions
 38179                                  ;	of the UMB is given back to the DOS free mem pool
 38180                                  ;
 38181                                  ;----------------------------------------------------------------------------
 38182                                  
 38183                                  ShrinkUMB:
 38184                                  	; 12/12/2022
 38185                                  	; ds = cs
 38186 00003447 833E[681F]00            	cmp	word [DevUMBAddr],0
 38187                                  	;cmp	word [cs:DevUMBAddr],0
 38188 0000344C 741F                    	je	short su_exit
 38189 0000344E 06                      	push	es
 38190                                  	; 01/01/2023
 38191                                  	;push	bx
 38192                                  	; 12/12/2022
 38193                                  	;mov	bx,[cs:DevUMBFree]
 38194                                  	;sub	bx,[cs:DevUMBAddr]
 38195                                  	;mov	es,[cs:DevUMBAddr]
 38196 0000344F 8B1E[6C1F]              	mov	bx,[DevUMBFree]
 38197 00003453 2B1E[681F]              	sub	bx,[DevUMBAddr]
 38198 00003457 8E06[681F]              	mov	es,[DevUMBAddr]
 38199                                  	
 38200 0000345B B8004A                  	mov	ax,4A00h
 38201 0000345E CD21                    	int	21h
 38202                                  		; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
 38203                                  		; ES = segment address of block to change
 38204                                  		; BX = new size in paragraphs
 38205 00003460 8CC0                    	mov	ax,es
 38206 00003462 48                      	dec	ax
 38207 00003463 8EC0                    	mov	es,ax
 38208 00003465 26C70601000800          	mov	word [es:ARENA.OWNER],8
 38209                                  	; 01/01/2023
 38210                                  	;pop	bx
 38211 0000346C 07                      	pop	es
 38212                                  su_exit:
 38213 0000346D C3                      	retn
 38214                                  
 38215                                  ;----------------------------------------------------------------------------
 38216                                  ;
 38217                                  ; procedure : UnlinkUMB
 38218                                  ;
 38219                                  ;	Unlinks the UMBs from the DOS arena chain
 38220                                  ;
 38221                                  ;----------------------------------------------------------------------------
 38222                                  
 38223                                  UnlinkUMB:
 38224                                  	; 12/12/2022
 38225                                  	; ds = cs
 38226 0000346E 1E                      	push	ds
 38227 0000346F 06                      	push	es
 38228                                  	; 12/12/2022
 38229 00003470 803E[841F]00            	cmp	byte [FirstUMBLinked],0
 38230                                  	;cmp	byte [cs:FirstUMBLinked],0
 38231 00003475 7420                    	je	short ulu_x		; nothing to unlink
 38232                                  	; 12/12/2022
 38233 00003477 8E06[851F]              	mov	es,[DevDOSData]
 38234                                  	;mov	es,[cs:DevDOSData]	; get DOS data seg
 38235 0000347B 268E1E2400              	mov	ds,[es:DOS_ARENA]
 38236 00003480 268B3E8C00              	mov	di,[es:UMB_ARENA]
 38237                                  ulu_next:
 38238 00003485 E83DFF                  	call	get_next
 38239 00003488 720D                    	jc	short ulu_x
 38240 0000348A 39C7                    	cmp	di,ax			; is the next one UMB ?
 38241 0000348C 7404                    	je	short ulu_found
 38242 0000348E 8ED8                    	mov	ds,ax
 38243 00003490 EBF3                    	jmp	short ulu_next
 38244                                  ulu_found:
 38245                                  	;mov	byte [0],'Z'
 38246 00003492 C60600005A              	mov     byte [ARENA.SIGNATURE],arena_signature_end ; 'Z'
 38247                                  ulu_x:
 38248 00003497 07                      	pop	es
 38249 00003498 1F                      	pop	ds
 38250 00003499 C3                      	retn
 38251                                  
 38252                                  ; ----------------------------------------------------------------------
 38253                                  ; SYSINIT2.ASM - MSDOS 6.0 - 1991
 38254                                  ; ----------------------------------------------------------------------
 38255                                  ; 14/04/2019 - Retro DOS v4.0
 38256                                  
 38257                                  ; Multiple configuration block support  Created 16-Mar-1992 by JeffPar
 38258                                  ;
 38259                                  ; Summary:
 38260                                  ;
 38261                                  ;   The procedure "organize" crunches the in-memory copy of config.sys
 38262                                  ;   into lines delimited by CR/LF (sometimes no CR, but *always* an LF)
 38263                                  ;   with the leading "keyword=" replaced by single character codes (eg, B
 38264                                  ;   for BUFFERS, D for DEVICE, Z for any unrecognized keyword); see comtab
 38265                                  ;   and/or config.inc for the full list.
 38266                                  ;
 38267                                  ;   [blockname] and INCLUDE are the major syntactical additions for multi-
 38268                                  ;   configuration support. blockname is either MENU, which contains one
 38269                                  ;   or more MENUITEM lines, an optional MENUDEFAULT (which includes optional
 38270                                  ;   time-out), or any user-defined keyword, such as NETWORK, CD-ROM, etc.
 38271                                  ;   INCLUDE allows the current block to name another block for inclusion
 38272                                  ;   during the processing phase of CONFIG.SYS. An INCLUDE is only honored
 38273                                  ;   once, precluding nasty infinite-loop scenarios. If blocks are present
 38274                                  ;   without a MENU block, then only lines inside COMMON blocks are processed.
 38275                                  ;
 38276                                  ; Example:
 38277                                  ;
 38278                                  ;   [menu]
 38279                                  ;   menuitem=misc,Miscellaneous
 38280                                  ;   menuitem=network,Network Configuration
 38281                                  ;   menudefault=network,15
 38282                                  ;
 38283                                  ;   [network]
 38284                                  ;   include misc
 38285                                  ;   device=foo
 38286                                  ;
 38287                                  ;   [misc]
 38288                                  ;   device=bar
 38289                                  ;   include alternate
 38290                                  ;
 38291                                  ;   [alternate]
 38292                                  ;   device=tar
 38293                                  ;
 38294                                  ;
 38295                                  ;   When the menu is displayed
 38296                                  ;
 38297                                  ;    1. Miscellaneous
 38298                                  ;    2. Network Configuration
 38299                                  ;
 38300                                  ;   #2 is highlighted as the default option, and will be automatically
 38301                                  ;   selected after 15 seconds. It will invoke the following lines in the
 38302                                  ;   following order:
 38303                                  ;
 38304                                  ;       DEVICE=BAR
 38305                                  ;       DEVICE=TAR
 38306                                  ;       DEVICE=FOO
 38307                                  ;
 38308                                  
 38309                                  ;MULTI_CONFIG equ 1
 38310                                  
 38311                                  ; the following depend on the positions of the various letters in switchlist
 38312                                  
 38313                                  switchnum	equ 11111000b ; 0F8h	; which switches require number
 38314                                  
 38315                                  flagec35	equ 00000100b ; 4	; electrically compatible 3.5 inch disk drive
 38316                                  flagdrive	equ 00001000b ; 8 
 38317                                  flagcyln	equ 00010000b ; 16
 38318                                  flagseclim	equ 00100000b ; 32
 38319                                  flagheads	equ 01000000b ; 64
 38320                                  flagff		equ 10000000b ; 128
 38321                                  
 38322                                  ;----------------------------------------------------------------------------
 38323                                  ; 19/04/2019 - Retro DOS v4.0
 38324                                  
 38325                                  ; MSDOS 6.21 IO.SYS - SYSINIT:3E78h
 38326                                  
 38327                                  ; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 38328                                  ; MSDOS 5.0 IO.SYS - SYSINIT:3054h
 38329                                  
 38330 0000349A 00                      insert_blank:	db 	0
 38331                                  
 38332                                  ;----------------------------------------------------------------------------
 38333                                  ;
 38334                                  ; procedure : setparms
 38335                                  ;
 38336                                  ; the following set of routines is used to parse the drivparm = command in
 38337                                  ; the config.sys file to change the default drive parameters.
 38338                                  ;
 38339                                  ;----------------------------------------------------------------------------
 38340                                  
 38341                                  setparms:
 38342 0000349B 1E                      	push	ds
 38343 0000349C 50                      	push	ax
 38344 0000349D 53                      	push	bx
 38345 0000349E 51                      	push	cx
 38346 0000349F 52                      	push	dx
 38347                                  
 38348 000034A0 0E                      	push	cs
 38349 000034A1 1F                      	pop	ds
 38350                                  
 38351 000034A2 31DB                    	xor	bx,bx
 38352 000034A4 8A1E[5649]              	mov	bl,[drive]
 38353                                  	; 18/12/2022
 38354 000034A8 43                      	inc	bx
 38355                                  	;inc	bl			; get it correct for ioctl call
 38356                                  					; (1=a,2=b...)
 38357 000034A9 BA[2E48]                	mov	dx,deviceparameters
 38358                                  	;mov	ah,IOCTL ; 44h
 38359                                  	;mov	al,GENERIC_IOCTL ; 0Dh
 38360                                  	; 04/07/2023
 38361 000034AC B80D44                  	mov	ax,(IOCTL<<8)|GENERIC_IOCTL
 38362                                  	;mov	ch,RAWIO ; 8
 38363                                  	;mov	cl,SET_DEVICE_PARAMETERS ; 40h
 38364                                  	; 04/07/2023
 38365 000034AF B94008                  	mov	cx,(RAWIO<<8)|SET_DEVICE_PARAMETERS 
 38366 000034B2 CD21                    	int	21h
 38367                                  
 38368                                  ; 27/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 38369 000034B4 8A26[5749]              	mov	ah,[switches]
 38370                                  	;mov	al,[deviceparameters+20]
 38371 000034B8 A0[4248]                	mov	al,[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERTRACK]
 38372 000034BB 8A0E[5649]              	mov	cl,[drive]
 38373                                  ;
 38374                                  ;; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38375                                  ;	;;mov	ax,Bios_Data		; get Bios_Data segment
 38376                                  ;	;mov	ax,KERNEL_SEGMENT ; 70h
 38377                                  ;	; 21/10/2022
 38378                                  ;	;mov	ax,DOSBIODATASEG ; 0070h	
 38379                                  ;	;mov	ds,ax			; set Bios_Data segment
 38380                                  ;
 38381                                  ;	; 27/07/2023
 38382                                  ;	;;test	word [cs:switches],flagec35 ; 4
 38383                                  ;	;test	byte [cs:switches],flagec35
 38384                                  ;	;jz	short not_ec35
 38385                                  ;
 38386                                  ;	; 27/07/2023
 38387                                  ;	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38388                                  ;	;;test	word [switches],flagec35 ; 4
 38389                                  ;	; 12/12/2022
 38390                                  ;	;test	byte [switches],flagec35 ; 4
 38391                                  ;	;jz	short eot_ok
 38392                                  ;	
 38393                                  	;mov	cl,[cs:drive]		; which drive was this for?
 38394                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38395                                  	;mov	cl,[drive]
 38396                                  	; 27/07/2023
 38397                                  	;mov	ax,DOSBIODATASEG ; 0070h	
 38398                                  	;mov	ds,ax
 38399                                  
 38400 000034BF BA7000                  	mov	dx,DOSBIODATASEG
 38401 000034C2 8EDA                    	mov	ds,dx
 38402                                  
 38403 000034C4 F6C404                  	test	ah,flagec35	; test byte [cs:switches],flagec35
 38404 000034C7 7408                    	jz	short not_ec35
 38405                                  
 38406                                  	;mov	al,1			; assume drive 0
 38407                                  	;shl	al,cl			; set proper bit depending on drive
 38408                                  	;;or	[531h],al ; (MSDOS 6.21 IO.SYS Offset SYINIT:3EACh)
 38409                                  	;or	[ec35_flag],al		; set the bit in the permanent flags
 38410                                  	; 27/07/2023
 38411 000034C9 B401                    	mov	ah,1
 38412 000034CB D2E4                    	shl	ah,cl
 38413 000034CD 0826[A204]              	or	[ec35_flag],ah
 38414                                  
 38415                                  ; 07/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 38416                                  ;	MSDOS 6.21 IO.SYS - SYINIT:3EB0h	
 38417                                  ; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38418                                  not_ec35:
 38419                                  ;	Now adjust the BIOS's EOT variable if our new drive has more
 38420                                  ;	sectors per track than any old ones.
 38421                                  
 38422                                  	; 27/07/2023
 38423                                  	;;mov	al,[cs:deviceparameters+20]
 38424                                  	;mov	al,[cs:deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERTRACK]
 38425                                  	
 38426                                  	;cmp	al,[12Ch] ; (MSDOS 6.21 IO.SYS Offset SYINIT:3EB4h)
 38427 000034D1 3A06[2C01]              	cmp	al,[eot]
 38428 000034D5 7603                    	jbe	short eot_ok
 38429 000034D7 A2[2C01]                	mov	[eot],al
 38430                                  eot_ok:
 38431 000034DA 5A                      	pop	dx			; fix up all the registers
 38432 000034DB 59                      	pop	cx
 38433 000034DC 5B                      	pop	bx
 38434 000034DD 58                      	pop	ax
 38435 000034DE 1F                      	pop	ds ; 13/05/2019
 38436 000034DF C3                      	retn
 38437                                  
 38438                                  ;----------------------------------------------------------------------------
 38439                                  ;
 38440                                  ; procedure : diddleback
 38441                                  ;
 38442                                  ; replace default values for further drivparm commands
 38443                                  ;
 38444                                  ;----------------------------------------------------------------------------
 38445                                  
 38446                                  diddleback:
 38447 000034E0 1E                      	push	ds
 38448 000034E1 0E                      	push	cs
 38449 000034E2 1F                      	pop	ds
 38450                                  	;mov	word [deviceparameters+4],80
 38451 000034E3 C706[3248]5000          	mov	word [deviceparameters+A_DEVICEPARAMETERS.DP_CYLINDERS],80
 38452                                  	;mov	byte [deviceparameters+1],2
 38453 000034E9 C606[2F48]02            	mov	byte [deviceparameters+A_DEVICEPARAMETERS.DP_DEVICETYPE],DEV_3INCH720KB ; 2
 38454                                  	;mov	word [deviceparameters+2],0
 38455 000034EE C706[3048]0000          	mov	word [deviceparameters+A_DEVICEPARAMETERS.DP_DEVICEATTRIBUTES],0
 38456 000034F4 C706[5749]0000          	mov	word [switches],0	    ; zero all switches
 38457 000034FA 1F                      	pop	ds
 38458 000034FB C3                      	retn
 38459                                  
 38460                                  
 38461                                  ; 03/01/2023
 38462                                  %if 0
 38463                                  
 38464                                  ; 15/04/2019 - Retro DOS v4.0
 38465                                  
 38466                                  ;----------------------------------------------------------------------------
 38467                                  ;
 38468                                  ; procedure : parseline
 38469                                  ;
 38470                                  ; entry point is parseline. al contains the first character in command line.
 38471                                  ;
 38472                                  ;----------------------------------------------------------------------------
 38473                                  
 38474                                  	; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 38475                                  	; (SYSINIT:3EDFh)
 38476                                  
 38477                                  	; 01/11/2022 - Retrodos v4.0 (Modified MSDOS 5.0 IO.SYS)
 38478                                  	; (SYSINIT:30ACh)
 38479                                  parseline:
 38480                                  	; 03/01/2023
 38481                                  	; ds = cs ; *
 38482                                  
 38483                                  	;push	ds ; *
 38484                                  
 38485                                  	;push	cs ; *
 38486                                  	;pop	ds ; *
 38487                                  
 38488                                  nextswtch:
 38489                                  	cmp	al,cr			; carriage return?
 38490                                  	je	short done_line
 38491                                  	cmp	al,lf			; linefeed?
 38492                                  	je	short put_back		; put it back and done
 38493                                  
 38494                                  ; anything less or equal to a space is ignored.
 38495                                  
 38496                                  	cmp	al,' '                  ; space?
 38497                                  	jbe	short getnext		; skip over space
 38498                                  	cmp	al,'/'
 38499                                  	je	short getparm
 38500                                  	stc				; mark error invalid-character-in-input
 38501                                  	;jmp	short exitpl
 38502                                  	; 03/01/2023
 38503                                  swterr:
 38504                                  	retn
 38505                                  
 38506                                  getparm:
 38507                                  	call	check_switch
 38508                                  	mov	[switches],bx		; save switches read so far
 38509                                  	jc	short swterr
 38510                                  getnext:
 38511                                  	call	getchr
 38512                                  	;jc	short done_line
 38513                                  	;jmp	short nextswtch
 38514                                  	; 03/01/2023
 38515                                  	jnc	short nextswtch
 38516                                  ;swterr:
 38517                                  	;jmp	short exitpl		; exit if error
 38518                                  
 38519                                  done_line:
 38520                                  	; 12/12/2022
 38521                                  	test	byte [switches],flagdrive ; 8
 38522                                  	;test	word [switches],flagdrive ; 8 ; see if drive specified
 38523                                  	jnz	short okay
 38524                                  	stc				; mark error no-drive-specified
 38525                                  	;jmp	short exitpl
 38526                                  	; 03/01/2023
 38527                                  	retn
 38528                                  
 38529                                  okay:
 38530                                  	mov	ax,[switches]
 38531                                  	and	ax,0003h	    ; get flag bits for changeline and non-rem
 38532                                  	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_DEVICEATTRIBUTES],ax
 38533                                  	mov	word [deviceparameters+A_DEVICEPARAMETERS.DP_TRACKTABLEENTRIES],0
 38534                                  	;clc			    ; everything is fine
 38535                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38536                                  	; 12/12/2022
 38537                                  	; cf=0
 38538                                  	;clc
 38539                                  	;call	setdeviceparameters
 38540                                  	; 03/01/2023
 38541                                  	jmp	setdeviceparameters
 38542                                  ;exitpl:
 38543                                  	; 03/01/2023
 38544                                  	; ds = cs
 38545                                  	;pop	ds ; *
 38546                                  	retn
 38547                                  put_back:
 38548                                  	inc	word [count]		; one more char to scan
 38549                                  	dec	word [chrptr]		; back up over linefeed
 38550                                  	jmp	short done_line
 38551                                  
 38552                                  %endif
 38553                                  
 38554                                  ;----------------------------------------------------------------------------
 38555                                  ;
 38556                                  ; procedure : check_switch
 38557                                  ;
 38558                                  ; processes a switch in the input. it ensures that the switch is valid, and
 38559                                  ; gets the number, if any required, following the switch. the switch and the
 38560                                  ; number *must* be separated by a colon. carry is set if there is any kind of
 38561                                  ; error.
 38562                                  ;
 38563                                  ;----------------------------------------------------------------------------
 38564                                  
 38565                                  ; 09/09/2023
 38566                                  
 38567                                  err_swtch:
 38568 000034FC 31CB                    	xor	bx,cx			; remove this switch from the records
 38569                                  err_check:
 38570 000034FE F9                      	stc
 38571                                  err_chk:
 38572                                  done_swtch:	; 09/09/2023 (cf=0)
 38573 000034FF C3                      	retn
 38574                                  
 38575                                  	; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 38576                                  
 38577                                  check_switch:
 38578 00003500 E8240D                  	call	getchr
 38579                                  	;jc	short err_check
 38580 00003503 72FA                    	jc	short err_chk
 38581 00003505 24DF                            and     al,0DFh                 ; convert it to upper case
 38582 00003507 3C41                    	cmp	al,'A'
 38583                                  	;jb	short err_check
 38584 00003509 72F4                    	jb	short err_chk ; 15/04/2019 - Retro DOS v4.0
 38585 0000350B 3C5A                    	cmp	al,'Z'
 38586 0000350D 77EF                    	ja	short err_check
 38587                                  
 38588 0000350F 06                      	push	es
 38589                                  
 38590 00003510 0E                      	push	cs
 38591 00003511 07                      	pop	es
 38592                                  
 38593                                  	;mov	cl,[switchlist]		; get number of valid switches
 38594                                  	;mov	ch,0
 38595                                  	;mov	di,1+switchlist		; point to string of valid switches
 38596                                  	; 09/09/2023
 38597 00003512 BF[EA49]                	mov	di,switchlist
 38598 00003515 8A0D                    	mov	cl,[di]
 38599 00003517 B500                    	mov	ch,0
 38600 00003519 47                      	inc	di	; 1+switchlist
 38601                                  
 38602 0000351A F2AE                    	repne	scasb
 38603                                  
 38604 0000351C 07                      	pop	es
 38605 0000351D 75DF                    	jnz	short err_check
 38606                                  
 38607 0000351F B80100                  	mov	ax,1
 38608 00003522 D3E0                    	shl	ax,cl			; set bit to indicate switch
 38609 00003524 8B1E[5749]              	mov	bx,[switches]		; get switches so far
 38610 00003528 09C3                    	or	bx,ax			; save this with other switches
 38611 0000352A 89C1                    	mov	cx,ax
 38612                                  	; 12/12/2022
 38613 0000352C A8F8                    	test	al,switchnum ; 0F8h
 38614                                  	;test	ax,switchnum ; 0F8h	; test against switches that require number to follow
 38615 0000352E 74CF                    	jz	short done_swtch
 38616                                  
 38617 00003530 E8F40C                  	call	getchr
 38618 00003533 72C7                    	jc	short err_swtch
 38619                                  
 38620 00003535 3C3A                    	cmp	al,':'
 38621 00003537 75C3                    	jne	short err_swtch
 38622                                  
 38623 00003539 E8EB0C                  	call	getchr
 38624 0000353C 53                      	push	bx			; preserve switches
 38625                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38626                                  	;mov	byte [cs:sepchr],' '	; allow space separators
 38627                                  	; 12/12/2022
 38628                                  	; ds = cs
 38629 0000353D C606[AE02]20            	mov	byte [sepchr],' '
 38630 00003542 E8980D                  	call	getnum
 38631                                  	;mov	byte [cs:sepchr],0
 38632                                  	; 12/12/2022
 38633 00003545 C606[AE02]00            	mov	byte [sepchr],0
 38634 0000354A 5B                      	pop	bx			; restore switches
 38635                                  
 38636                                  ; because getnum does not consider carriage-return or line-feed as ok, we do
 38637                                  ; not check for carry set here. if there is an error, it will be detected
 38638                                  ; further on (hopefully).
 38639                                  
 38640                                  	; 09/09/2023
 38641                                  	;call	process_num
 38642                                  	;jmp	short process_num
 38643                                  
 38644                                  ;done_swtch:
 38645                                  ;	;clc
 38646                                  ;	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38647                                  ;	; 12/12/2022
 38648                                  ;	; cf=0
 38649                                  ;	;clc
 38650                                  ;	retn
 38651                                  
 38652                                  ;----------------------------------------------------------------------------
 38653                                  ;
 38654                                  ; procedure : process_num
 38655                                  ;
 38656                                  ; this routine takes the switch just input, and the number following (if any),
 38657                                  ; and sets the value in the appropriate variable. if the number input is zero
 38658                                  ; then it does nothing - it assumes the default value that is present in the
 38659                                  ; variable at the beginning. zero is ok for form factor and drive, however.
 38660                                  ;
 38661                                  ;----------------------------------------------------------------------------
 38662                                  
 38663                                  	; 02/11/2022 - Retrodos v4.0 (Modified MSDOS 5.0 IO.SYS)
 38664                                  	; (SYSINIT:3156h)
 38665                                  process_num:
 38666 0000354B 850E[5749]              	test	[switches],cx		; if this switch has been done before,
 38667 0000354F 752B                    	jnz	short done_ret		; ignore this one.
 38668                                  	; 12/12/2022
 38669 00003551 F6C108                  	test	cl,flagdrive ; 8
 38670                                  	;test	cx,flagdrive ; 8
 38671 00003554 7404                    	jz	short try_f
 38672 00003556 A2[5649]                	mov	byte [drive],al
 38673                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38674                                  	;jmp	short done_ret
 38675                                  	; 12/12/2022
 38676                                  	; cf=0
 38677 00003559 C3                      	retn	; 13/05/2019
 38678                                  try_f:
 38679                                  	; 12/12/2022
 38680 0000355A F6C180                  	test	cl,flagff ; 80h
 38681                                  	;test	cx,flagff ; 80h
 38682 0000355D 7404                    	jz	short try_t
 38683                                  
 38684                                  ; ensure that we do not get bogus form factors that are not supported
 38685                                  
 38686                                  	;mov	[deviceparameters+1],al
 38687 0000355F A2[2F48]                	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_DEVICETYPE],al
 38688                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38689                                  	;jmp	short done_ret
 38690                                  	; 12/12/2022
 38691                                  	; cf=0
 38692 00003562 C3                      	retn	; 13/05/2019
 38693                                  try_t:
 38694 00003563 09C0                    	or	ax,ax
 38695 00003565 7415                    	jz	short done_ret		; if number entered was 0, assume default value
 38696                                  	; 12/12/2022
 38697 00003567 F6C110                  	test	cl,flagcyln ; 10h
 38698                                  	;test	cx,flagcyln ; 10h
 38699 0000356A 7404                    	jz	short try_s
 38700                                  
 38701                                  	;mov	[deviceparameters+4],ax
 38702 0000356C A3[3248]                	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_CYLINDERS],ax
 38703                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38704                                  	;jmp	short done_ret
 38705                                  	; 12/12/2022
 38706                                  	; cf=0
 38707 0000356F C3                      	retn	; 13/05/2019
 38708                                  try_s:
 38709                                  	; 12/12/2022
 38710 00003570 F6C120                  	test	cl,flagseclim ; 20h
 38711                                  	;test	cx,flagseclim ; 20h
 38712 00003573 7404                    	jz	short try_h
 38713 00003575 A3[5449]                	mov	[slim],ax
 38714                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38715                                  	;jmp	short done_ret
 38716                                  	; 12/12/2022
 38717                                  	; cf=0
 38718 00003578 C3                      	retn	; 13/05/2019
 38719                                  
 38720                                  ; must be for number of heads
 38721                                  
 38722                                  try_h:
 38723 00003579 A3[5249]                	mov	[hlim],ax
 38724                                  done_ret:
 38725                                  	;clc
 38726                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38727                                  	; 12/12/2022
 38728                                  	; cf=0 (test instruction resets cf)
 38729                                  	;clc
 38730 0000357C C3                      	retn
 38731                                  
 38732                                  
 38733                                  ; 03/01/2023 - Retro DOS v4.2
 38734                                  %if 1
 38735                                  
 38736                                  ; 15/04/2019 - Retro DOS v4.0
 38737                                  
 38738                                  ;----------------------------------------------------------------------------
 38739                                  ;
 38740                                  ; procedure : parseline
 38741                                  ;
 38742                                  ; entry point is parseline. al contains the first character in command line.
 38743                                  ;
 38744                                  ;----------------------------------------------------------------------------
 38745                                  
 38746                                  	; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 38747                                  	; (SYSINIT:3EDFh)
 38748                                  
 38749                                  	; 01/11/2022 - Retrodos v4.0 (Modified MSDOS 5.0 IO.SYS)
 38750                                  	; (SYSINIT:30ACh)
 38751                                  parseline:
 38752                                  	; 03/01/2023
 38753                                  	; ds = cs ; *
 38754                                  
 38755                                  	;push	ds ; *
 38756                                  
 38757                                  	;push	cs ; *
 38758                                  	;pop	ds ; *
 38759                                  
 38760                                  nextswtch:
 38761 0000357D 3C0D                    	cmp	al,cr			; carriage return?
 38762 0000357F 741C                    	je	short done_line
 38763 00003581 3C0A                    	cmp	al,lf			; linefeed?
 38764 00003583 7421                    	je	short put_back		; put it back and done
 38765                                  
 38766                                  ; anything less or equal to a space is ignored.
 38767                                  
 38768 00003585 3C20                    	cmp	al,' '                  ; space?
 38769 00003587 760F                    	jbe	short getnext		; skip over space
 38770 00003589 3C2F                    	cmp	al,'/'
 38771 0000358B 7402                    	je	short getparm
 38772 0000358D F9                      	stc				; mark error invalid-character-in-input
 38773                                  	;jmp	short exitpl
 38774                                  	; 03/01/2023
 38775                                  swterr:
 38776 0000358E C3                      	retn
 38777                                  
 38778                                  getparm:
 38779 0000358F E86EFF                  	call	check_switch
 38780 00003592 891E[5749]              	mov	[switches],bx		; save switches read so far
 38781 00003596 72F6                    	jc	short swterr
 38782                                  getnext:
 38783 00003598 E88C0C                  	call	getchr
 38784                                  	;jc	short done_line
 38785                                  	;jmp	short nextswtch
 38786                                  	; 03/01/2023
 38787 0000359B 73E0                    	jnc	short nextswtch
 38788                                  ;swterr:
 38789                                  	;jmp	short exitpl		; exit if error
 38790                                  
 38791                                  done_line:
 38792                                  	; 12/12/2022
 38793 0000359D F606[5749]08            	test	byte [switches],flagdrive ; 8
 38794                                  	;test	word [switches],flagdrive ; 8 ; see if drive specified
 38795 000035A2 750C                    	jnz	short okay
 38796 000035A4 F9                      	stc				; mark error no-drive-specified
 38797                                  	;jmp	short exitpl
 38798                                  	; 03/01/2023
 38799 000035A5 C3                      	retn
 38800                                  
 38801                                  ;exitpl:
 38802                                  	; 03/01/2023
 38803                                  	; ds = cs
 38804                                  	;;pop	ds ; *
 38805                                  	;retn
 38806                                  
 38807                                  put_back:
 38808 000035A6 FF06[5603]              	inc	word [count]		; one more char to scan
 38809 000035AA FF0E[5A03]              	dec	word [chrptr]		; back up over linefeed
 38810 000035AE EBED                    	jmp	short done_line
 38811                                  
 38812                                  okay:
 38813 000035B0 A1[5749]                	mov	ax,[switches]
 38814 000035B3 83E003                  	and	ax,0003h	    ; get flag bits for changeline and non-rem
 38815 000035B6 A3[3048]                	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_DEVICEATTRIBUTES],ax
 38816 000035B9 C706[5448]0000          	mov	word [deviceparameters+A_DEVICEPARAMETERS.DP_TRACKTABLEENTRIES],0
 38817                                  	;clc			    ; everything is fine
 38818                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38819                                  	; 12/12/2022
 38820                                  	; cf=0
 38821                                  	;clc
 38822                                  	;call	setdeviceparameters
 38823                                  	; 03/01/2023
 38824                                  	;jmp	short setdeviceparameters
 38825                                  
 38826                                  %endif
 38827                                  
 38828                                  ;	M047 -- Begin modifications (too numerous to mark specifically)
 38829                                  
 38830                                  ;----------------------------------------------------------------------------
 38831                                  ;
 38832                                  ; procedure : setdeviceparameters
 38833                                  ;
 38834                                  ; setdeviceparameters sets up the recommended bpb in each bds in the
 38835                                  ; system based on the form factor. it is assumed that the bpbs for the
 38836                                  ; various form factors are present in the bpbtable. for hard files,
 38837                                  ; the recommended bpb is the same as the bpb on the drive.
 38838                                  ; no attempt is made to preserve registers since we are going to jump to
 38839                                  ; sysinit straight after this routine.
 38840                                  ;
 38841                                  ;	if we return carry, the DRIVPARM will be aborted, but presently
 38842                                  ;	  we always return no carry
 38843                                  ;
 38844                                  ;	note:  there is a routine by the same name in msdioctl.asm
 38845                                  ;
 38846                                  ;----------------------------------------------------------------------------
 38847                                  
 38848                                  ; 15/04/2019 - Retro DOS v4.0
 38849                                  
 38850                                  	; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 38851                                  
 38852                                  	; 03/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 38853                                  	; (SYSINIT:3FC4h)
 38854                                  
 38855                                  	; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 38856                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:4236h)
 38857                                  
 38858                                  setdeviceparameters:
 38859                                  	; 03/01/2023
 38860                                  	; ds = cs
 38861                                  
 38862 000035BF 06                      	push	es
 38863                                  
 38864 000035C0 0E                      	push	cs
 38865 000035C1 07                      	pop	es
 38866                                  
 38867 000035C2 31DB                    	xor	bx,bx
 38868 000035C4 8A1E[2F48]              	mov	bl,[deviceparameters+A_DEVICEPARAMETERS.DP_DEVICETYPE]
 38869 000035C8 80FB00                  	cmp	bl,DEV_5INCH ; 0
 38870 000035CB 7506                    	jne	short got_80
 38871                                  
 38872 000035CD C706[3248]2800          	mov	word [deviceparameters+A_DEVICEPARAMETERS.DP_CYLINDERS],40
 38873                                  							; 48 tpi=40 cyl
 38874                                  got_80:
 38875 000035D3 D1E3                    	shl	bx,1			; get index into bpb table
 38876 000035D5 8BB7[D649]              	mov	si,[bpbtable+bx]	; get address of bpb
 38877                                  
 38878                                  	;mov	di,deviceparameters+7	
 38879                                  	; 02/11/2022
 38880 000035D9 BF[3548]                	mov	di,deviceparameters+A_DEVICEPARAMETERS.DP_BPB ; es:di -> bpb
 38881 000035DC B91F00                  	mov	cx,A_BPB.size ; 31
 38882                                  	; 09/09/2023
 38883                                  	;mov	cx,59 ; PCDOS 7.1 IBMBIO.COM A_BPB.size
 38884 000035DF FC                      	cld
 38885                                  	;repe	movsb
 38886                                  	; 02/11/2022
 38887 000035E0 F3A4                    	rep	movsb
 38888                                  
 38889 000035E2 07                      	pop	es
 38890                                  
 38891                                  	; 12/12/2022
 38892 000035E3 F606[5749]20            	test	byte [switches],flagseclim ; 20h
 38893                                  	;test	word [switches],flagseclim ; 20h
 38894 000035E8 7406                    	jz	short see_heads
 38895                                  
 38896 000035EA A1[5449]                	mov	ax,[slim]
 38897                                  	;mov	[deviceparameters+20],ax
 38898 000035ED A3[4248]                	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERTRACK],ax
 38899                                  
 38900                                  see_heads:
 38901                                  	; 12/12/2022
 38902 000035F0 F606[5749]40            	test	byte [switches],flagheads ; 40h
 38903                                  	;test	word [switches],flagheads ; 40h
 38904 000035F5 7406                    	jz	short heads_not_altered
 38905                                  
 38906 000035F7 A1[5249]                	mov	ax,[hlim]
 38907                                  	;mov	[deviceparameters+22],ax	
 38908 000035FA A3[4448]                	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_HEADS],ax
 38909                                  
 38910                                  heads_not_altered:
 38911                                  
 38912                                  ; set up correct media descriptor byte and sectors/cluster
 38913                                  ;   sectors/cluster is always 2 except for any one sided disk or 1.44M
 38914                                  
 38915                                  	;mov	byte [deviceparameters+9],2
 38916                                  	; 02/11/2022
 38917                                  	;mov	byte [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERCLUSTER],2
 38918                                  	; 03/01/2023
 38919 000035FD B80200                  	mov	ax,2	
 38920 00003600 A2[3748]                	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERCLUSTER],al ; 2
 38921                                  
 38922 00003603 B3F0                    	mov	bl,0F0h			; get default mediabyte
 38923                                  
 38924                                  ;	preload the mediadescriptor from the bpb into bh for convenient access
 38925                                  
 38926                                  	;mov	bh,[deviceparameters+17]
 38927                                  	; 02/11/2022
 38928 00003605 8A3E[3F48]              	mov	bh,[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_MEDIADESCRIPTOR]
 38929                                  	
 38930                                  	; 03/01/2023
 38931                                  	; ax = 2
 38932 00003609 3906[4448]              	cmp	[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_HEADS],ax ; >2 heads?
 38933                                  	;cmp	word [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_HEADS],2 ; >2 heads?
 38934 0000360D 773C                    	ja	short got_correct_mediaid ; just use default if heads>2
 38935                                  
 38936 0000360F 7524                    	jne	short only_one_head	; one head, do one head stuff
 38937                                  
 38938                                  ;	two head drives will use the mediadescriptor from the bpb
 38939                                  
 38940 00003611 88FB                    	mov	bl,bh			; get mediadescriptor from bpb
 38941                                  
 38942                                  ;	two sided drives have two special cases to look for. One is
 38943                                  ;	   a 320K diskette (40 tracks, 8 secs per track). It uses
 38944                                  ;	   a mediaid of 0fch. The other is 1.44M, which uses only
 38945                                  ;	   one sector/cluster.
 38946                                  
 38947                                  ;	any drive with 18secs/trk, 2 heads, 80 tracks, will be assumed
 38948                                  ;	   to be a 1.44M and use only 1 sector per cluster. Any other
 38949                                  ;	   type of 2 headed drive is all set.
 38950                                  
 38951 00003613 833E[4248]12            	cmp	word [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERTRACK],18
 38952 00003618 7509                    	jne	short not_144m
 38953 0000361A 833E[3248]50            	cmp	word [deviceparameters+A_DEVICEPARAMETERS.DP_CYLINDERS],80
 38954 0000361F 7502                    	jne	short not_144m
 38955                                  
 38956                                  ;	We've got cyl=80, heads=2, secpertrack=18. Set cluster size to 1.
 38957                                  
 38958 00003621 EB24                    	jmp	short got_one_secperclus_drive
 38959                                  
 38960                                  ;	check for 320K
 38961                                  
 38962                                  not_144m:
 38963 00003623 833E[3248]28            	cmp	word [deviceparameters+A_DEVICEPARAMETERS.DP_CYLINDERS],40
 38964 00003628 7521                    	jne	short got_correct_mediaid
 38965 0000362A 833E[4248]08            	cmp	word [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERTRACK],8
 38966 0000362F 751A                    	jne	short got_correct_mediaid
 38967                                  
 38968 00003631 B3FC                    	mov	bl,0FCh
 38969 00003633 EB16                    	jmp	short got_correct_mediaid
 38970                                  
 38971                                  only_one_head:
 38972                                  
 38973                                  ;	if we don't have a 360K drive, then just go use 0f0h as media descr.
 38974                                  
 38975 00003635 803E[2F48]00            	cmp	byte [deviceparameters+A_DEVICEPARAMETERS.DP_DEVICETYPE],DEV_5INCH ; 0
 38976 0000363A 740B                    	je	short got_one_secperclus_drive
 38977                                  
 38978                                  ;	single sided 360K drive uses either 0fch or 0feh, depending on
 38979                                  ;	  whether sectorspertrack is 8 or 9. For our purposes, anything
 38980                                  ;	  besides 8 will be considered 0fch
 38981                                  
 38982 0000363C B3FC                    	mov	bl,0FCh			; single sided 9 sector media id
 38983 0000363E 833E[4248]08            	cmp	word [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERTRACK],8
 38984                                  	; 12/12/2022
 38985 00003643 7502                    	jne	short got_one_secperclus_drive ; okay if anything besides 8
 38986                                  
 38987 00003645 B3FE                    	mov	bl,0FEh			; 160K mediaid
 38988                                  
 38989                                  ;	we've either got a one sided drive, or a 1.44M drive
 38990                                  ;	  either case we'll use 1 sector per cluster instead of 2
 38991                                  
 38992                                  got_one_secperclus_drive:
 38993                                  	; 03/01/2023
 38994                                  	; ax = 2
 38995 00003647 48                      	dec	ax  ; ax = 1
 38996 00003648 A2[3748]                	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERCLUSTER],al ; 1
 38997                                  	;mov	byte [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERCLUSTER],1
 38998                                  
 38999                                  got_correct_mediaid:
 39000 0000364B 881E[3F48]              	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_MEDIADESCRIPTOR],bl
 39001                                  
 39002                                  ;	 Calculate the correct number of Total Sectors on medium
 39003                                  
 39004 0000364F A1[3248]                	mov	ax,[deviceparameters+A_DEVICEPARAMETERS.DP_CYLINDERS]
 39005 00003652 F726[4448]              	mul	word [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_HEADS]
 39006 00003656 F726[4248]              	mul	word [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERTRACK]
 39007 0000365A A3[3D48]                	mov	word [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_TOTALSECTORS],ax
 39008 0000365D F8                      	clc				; we currently return no errors
 39009                                  
 39010 0000365E C3                      	retn
 39011                                  
 39012                                  ;	M047 -- end rewritten routine
 39013                                  
 39014                                  ;----------------------------------------------------------------------------
 39015                                  ;
 39016                                  ; procedure : organize
 39017                                  ;
 39018                                  ;----------------------------------------------------------------------------
 39019                                  
 39020                                  ; 09/09/2023 - Retrodos v4.2 IO.SYS (Optimization)
 39021                                  %if 1
 39022                                  end_commd_line:
 39023 0000365F AA                      	stosb				; store line feed char in buffer for the linecount.
 39024                                  	;mov	byte [cs:com_level],0	; reset the command level.
 39025                                  	; 03/01/2023
 39026                                  	; ds = cs
 39027                                  	;mov	byte [com_level],0
 39028                                  	;jmp	short org1
 39029                                  	; 09/09/2023
 39030 00003660 EB0E                    	jmp	short org0
 39031                                  nochar1:
 39032 00003662 F9                      	stc
 39033 00003663 C3                      	retn
 39034                                  %endif
 39035                                  	; 02/11/2022 - Retrodos v4.0 (Modified MSDOS 5.0 IO.SYS)
 39036                                  	; (SYSINIT:3234h)
 39037                                  
 39038                                  	; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 39039                                  	; (SYSINIT:4067h)
 39040                                  
 39041                                  	; 09/09/2023 - Retrodos v4.2 IO.SYS (Optimization)
 39042                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:42D9h)
 39043                                  
 39044                                  organize:
 39045                                  	; 03/01/2023
 39046                                  	; ds = cs
 39047 00003664 8B0E[5603]              	mov	cx,[count]
 39048                                  	;mov	cx,[cs:count]
 39049 00003668 E3F8                    	jcxz	nochar1
 39050                                  
 39051                                  ;ifndef	MULTI_CONFIG
 39052                                  ;
 39053                                  ;;   In MULTI_CONFIG, we map to upper case on a line-by-line basis,
 39054                                  ;;   because we the case of values in SET commands preserved
 39055                                  ;
 39056                                  ;	call	mapcase
 39057                                  ;endif
 39058                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39059                                  	; 03/01/2023 - Retro DOS v4.2
 39060                                  	;call	mapcase
 39061                                  
 39062 0000366A 31F6                    	xor	si,si
 39063 0000366C 89F7                    	mov	di,si
 39064 0000366E 31C0                    	xor	ax,ax
 39065                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)	
 39066                                  	;;mov	byte [cs:com_level],0
 39067                                  	; 12/12/2022
 39068                                  	;mov	[cs:com_level],al ; 0
 39069                                  	; 03/01/2023
 39070                                  	; ds = cs
 39071                                  	; 09/09/2023
 39072                                  	;mov	[com_level],al ; 0
 39073                                  org0:
 39074 00003670 C606[5003]00            	mov	byte [com_level],0 ; 09/09/2023
 39075                                  org1:
 39076 00003675 E8EF01                  	call	skip_comment
 39077 00003678 74E5                    	jz	short end_commd_line	; found a comment string and skipped.
 39078 0000367A E8D001                  	call	get2			; not a comment string. then get a char.
 39079 0000367D 3C0A                    	cmp	al,lf ; 0Ah
 39080 0000367F 74DE                    	je	short end_commd_line	; starts with a blank line.
 39081 00003681 3C20                    	cmp	al,' ' ; 20h
 39082 00003683 76F0                    	jbe	short org1		; skip leading control characters
 39083                                  	; 09/09/2023
 39084                                  	;jmp	short findit
 39085                                  
 39086                                  ; 09/09/2023
 39087                                  %if 0
 39088                                  end_commd_line:
 39089                                  	stosb				; store line feed char in buffer for the linecount.
 39090                                  	;mov	byte [cs:com_level],0	; reset the command level.
 39091                                  	; 03/01/2023
 39092                                  	; ds = cs
 39093                                  	mov	byte [com_level],0
 39094                                  	jmp	short org1
 39095                                  
 39096                                  nochar1:
 39097                                  	stc
 39098                                  	retn
 39099                                  %endif
 39100                                  
 39101                                  findit:
 39102 00003685 51                      	push	cx
 39103 00003686 56                      	push	si
 39104 00003687 57                      	push	di
 39105 00003688 89F5                    	mov	bp,si
 39106 0000368A 4D                      	dec	bp
 39107 0000368B BE[4B47]                        mov     si,comtab		; prepare to search command table
 39108 0000368E B500                    	mov	ch,0
 39109                                  findcom:
 39110 00003690 89EF                    	mov	di,bp
 39111 00003692 8A0C                    	mov	cl,[si]
 39112 00003694 46                      	inc	si
 39113 00003695 E345                    	jcxz	nocom
 39114                                  
 39115                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39116                                  
 39117                                  ; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 39118                                  
 39119                                  ;ifdef	MULTI_CONFIG
 39120                                  
 39121                                  ;   Simplify future parsing by collapsing ";" onto "REM", and at the same
 39122                                  ;   time skip the upcoming delimiter test (since ";" need not be followed by
 39123                                  ;   anything in particular)
 39124                                  
 39125 00003697 26803D3B                	cmp	byte [es:di],CONFIG_SEMICOLON  ; ';'
 39126 0000369B 7430                    	je	short semicolon
 39127                                  loopcom:
 39128                                  	;mov	al,[es:di]
 39129                                  	;inc	di
 39130                                  	;and	al,~20h ; 0DFh		; force upper case
 39131                                  	;inc	si                      ; compare to byte @es:di
 39132                                  	;cmp	al,[si-1]
 39133                                  	; 28/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 39134 0000369D 268A25                  	mov	ah,[es:di]
 39135 000036A0 47                      	inc	di
 39136 000036A1 80E4DF                  	and	ah,~20h ; 0DFh		
 39137 000036A4 AC                      	lodsb			; mov al,[si]
 39138                                  				; inc si
 39139                                  	;cmp	al,ah
 39140                                  	;loope	loopcom
 39141                                  	; 28/07/2023
 39142 000036A5 30C4                    	xor	ah,al		; result: ah = 0 (*) if ah = al
 39143 000036A7 E1F4                    	loopz	loopcom
 39144                                  ;else
 39145                                  ;	repe	cmpsb
 39146                                  ;endif
 39147                                  	; 02/11/2022
 39148                                  	; 03/01/2023 - Retro DOS v4.2
 39149                                  	;repe	cmpsb
 39150                                  
 39151                                  	; 28/07/2023
 39152                                  	;lahf
 39153 000036A9 01CE                            add     si,cx                   ; bump to next position without affecting flags
 39154                                  	;sahf
 39155 000036AB AC                              lodsb                           ; get indicator letter
 39156                                  	;jnz	short findcom
 39157                                          ; 28/07/2023
 39158 000036AC 08E4                    	or	ah,ah			; (*)
 39159 000036AE 75E0                    	jnz	short findcom		
 39160                                  	
 39161 000036B0 26803D0D                	cmp     byte [es:di],cr		; the next char might be cr,lf
 39162 000036B4 7421                    	je	short gotcom0 		; such as in "rem",cr,lf case.
 39163 000036B6 26803D0A                	cmp	byte [es:di],lf
 39164 000036BA 741B                    	je	short gotcom0
 39165                                  
 39166                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39167                                  
 39168                                  ; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 39169                                  
 39170                                  ;ifdef	MULTI_CONFIG
 39171                                  
 39172                                  ; Skip the delimiter test for the BEGIN identifier (it doesn't have one).
 39173                                  
 39174 000036BC 3C5B                    	cmp	al,CONFIG_BEGIN  ; '['
 39175 000036BE 7417                    	je	short gotcom0
 39176                                  ;endif
 39177 000036C0 50                      	push	ax
 39178 000036C1 268A05                  	mov	al,[es:di]		; now the next char. should be a delim.
 39179                                  
 39180                                  ;ifdef	MULTI_CONFIG
 39181                                  
 39182                                  ;   If keyword is *immediately* followed by a question mark (?), then
 39183                                  ;   set the high bit of the ASCII command code (CONFIG_OPTION_QUERY) that is
 39184                                  ;   stored in the CONFIG.SYS memory image.
 39185                                  
 39186 000036C4 3C3F                    	cmp	al,'?'                  ; explicit interactive command?
 39187 000036C6 7509                    	jne	short no_query		; no
 39188 000036C8 58                      	pop	ax                      ; yes, so retrieve the original code
 39189                                  	;or	al,80h ; 03/01/2023
 39190 000036C9 0C80                    	or	al,CONFIG_OPTION_QUERY  ; and set the QUERY bit
 39191 000036CB EB0A                    	jmp	short gotcom0           ;
 39192                                  semicolon:
 39193 000036CD B030                    	mov	al,CONFIG_REM ; '0'
 39194 000036CF EB06                    	jmp	short gotcom0
 39195                                  no_query:
 39196                                  ;endif  ;MULTI_CONFIG
 39197                                  
 39198                                  	; 02/11/2022
 39199                                  	; 03/01/2023 - Retro DOS v4.2
 39200                                  	;push	ax
 39201                                  	;mov	al,[es:di]		; now the next char. should be a delim.
 39202                                  
 39203 000036D1 E82E0B                  	call	delim
 39204                                  no_delim:
 39205 000036D4 58                      	pop	ax
 39206 000036D5 75B9                    	jnz	short findcom
 39207                                  gotcom0:
 39208 000036D7 5F                      	pop	di
 39209 000036D8 5E                      	pop	si
 39210 000036D9 59                      	pop	cx
 39211 000036DA EB10                    	jmp	short gotcom
 39212                                  nocom:
 39213 000036DC 5F                      	pop	di
 39214 000036DD 5E                      	pop	si
 39215 000036DE 59                      	pop	cx
 39216 000036DF B05A                            mov     al,CONFIG_UNKNOWN  ; 'Z'
 39217 000036E1 AA                      	stosb				; save indicator char.
 39218                                  _skipline:
 39219 000036E2 E86801                  	call	get2
 39220 000036E5 3C0A                    	cmp	al,lf ; 0Ah		; skip this bad command line
 39221 000036E7 75F9                            jne     short _skipline
 39222                                  	;jmp	short end_commd_line	; handle next command line
 39223                                  	; 09/09/2023
 39224 000036E9 E973FF                  	jmp	end_commd_line
 39225                                  gotcom:
 39226 000036EC AA                              stosb                           ; save indicator char in buffer
 39227                                  
 39228                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39229                                  
 39230                                  ; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 39231                                  
 39232                                  ;ifdef	MULTI_CONFIG
 39233                                  
 39234                                  ;   Don't pollute "cmd_indicator" with the CONFIG_OPTION_QUERY bit though;
 39235                                  ;   it screws up the direct comparisons below.
 39236                                  
 39237 000036ED 247F                    	and	al,~CONFIG_OPTION_QUERY ; 7Fh
 39238                                  ;endif
 39239                                  	;mov	[cs:cmd_indicator],al	; save it for the future use.
 39240                                  	; 03/01/2023
 39241                                  	; ds = cs
 39242 000036EF A2[5403]                	mov	[cmd_indicator],al	; save it for the future use.
 39243                                  
 39244                                  ;ifdef	MULTI_CONFIG
 39245                                  
 39246                                  ;   There is no whitespace/delimiter between the "begin block" character
 39247                                  ;   ([) and the name of block (eg, [menu]), therefore skip this delimiter
 39248                                  ;   skipping code
 39249                                  
 39250 000036F2 3C5B                    	cmp	al,CONFIG_BEGIN
 39251 000036F4 7455                    	je	short org31
 39252 000036F6 3C4F                    	cmp	al,CONFIG_SUBMENU ; 'O'
 39253 000036F8 740F                    	je	short no_mapcase
 39254 000036FA 3C45                    	cmp	al,CONFIG_MENUITEM ; 'E'
 39255 000036FC 740B                    	je	short no_mapcase
 39256 000036FE 3C41                    	cmp	al,CONFIG_MENUDEFAULT ; 'A'
 39257 00003700 7407                    	je	short no_mapcase
 39258 00003702 3C4A                    	cmp	al,CONFIG_INCLUDE ; 'J'
 39259 00003704 7403                    	je	short no_mapcase
 39260 00003706 E8350B                  	call	mapcase			; map case of rest of line to UPPER
 39261                                  no_mapcase:
 39262                                  ;endif
 39263                                  	;; 02/11/2022
 39264                                  	;;mov	[cs:cmd_indicator],al	; save it for the future use.
 39265                                  	;; 03/01/2023
 39266                                  	;; ds = cs
 39267                                  	;mov	[cmd_indicator],al
 39268                                  org2:	
 39269 00003709 E84101                  	call    get2                    ; skip the command name until delimiter
 39270 0000370C 3C0A                            cmp     al,lf 	    ; 0Ah
 39271 0000370E 740F                    	je	short org21
 39272 00003710 3C0D                    	cmp	al,cr 	    ; 0Dh	
 39273 00003712 740B                    	je	short org21
 39274                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39275                                  	; 03/01/2023 - Retro DOS v4.2
 39276 00003714 3C2F                    	cmp	al, '/'			; T-RICHJ: Added to allow DEVHIGH/L:...
 39277 00003716 7407                    	je	short org21		; T-RICHJ: to be parsed properly.
 39278                                  
 39279 00003718 E8E70A                  	call	delim
 39280 0000371B 75EC                            jnz	short org2
 39281 0000371D EB02                    	jmp	short org3
 39282                                  org21:					;if cr or lf then
 39283 0000371F 4E                      	dec	si			; undo si, cx register
 39284 00003720 41                      	inc	cx			;  and continue
 39285                                  org3:	
 39286                                  	;cmp	byte [cs:cmd_indicator],CONFIG_COMMENT ; 'Y'
 39287                                  	;je	short get_cmt_token
 39288                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39289                                  	; 03/01/2023 - Retro DOS v4.2	
 39290                                  	;cmp	byte [cs:cmd_indicator],CONFIG_DEVICE ; 'D'
 39291                                  	;je	short org_file
 39292                                  	;cmp	byte [cs:cmd_indicator],CONFIG_INSTALL ; 'I'
 39293                                  	;je	short org_file
 39294                                  	;cmp	byte [cs:cmd_indicator],CONFIG_INSTALLHIGH ; 'W'
 39295                                  	;je	short org_file
 39296                                  	; 02/11/2022
 39297                                  	; 03/01/2023 - Retro DOS v4.2
 39298                                  	;;cmp	byte [cs:cmd_indicator],CONFIG_DEVICE ; 'D'
 39299                                  	;;je	short org_file
 39300                                  	;cmp	byte [cs:cmd_indicator],CONFIG_SHELL ; 'S'
 39301                                  	;je	short org_file
 39302                                          ;cmp	byte [cs:cmd_indicator],CONFIG_SWITCHES ; '1'
 39303                                  	;je	short org_switch
 39304                                  
 39305                                  	; 03/01/2023
 39306                                  	; ds = cs
 39307                                  
 39308 00003721 803E[5403]59            	cmp	byte [cmd_indicator],CONFIG_COMMENT ; 'Y'
 39309 00003726 745D                    	je	short get_cmt_token
 39310                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39311                                  	; 03/01/2023 - Retro DOS v4.2	
 39312 00003728 803E[5403]44            	cmp	byte [cmd_indicator],CONFIG_DEVICE ; 'D'
 39313 0000372D 7430                    	je	short org_file
 39314 0000372F 803E[5403]49            	cmp	byte [cmd_indicator],CONFIG_INSTALL ; 'I'
 39315 00003734 7429                    	je	short org_file
 39316 00003736 803E[5403]57            	cmp	byte [cmd_indicator],CONFIG_INSTALLHIGH ; 'W'
 39317 0000373B 7422                    	je	short org_file
 39318                                  	; 02/11/2022
 39319                                  	; 03/01/2023 - Retro DOS v4.2
 39320                                  	;cmp	byte [cmd_indicator],CONFIG_DEVICE ; 'D'
 39321                                  	;je	short org_file
 39322 0000373D 803E[5403]53                    cmp	byte [cmd_indicator],CONFIG_SHELL ; 'S'
 39323 00003742 741B                    	je	short org_file
 39324 00003744 803E[5403]31                    cmp	byte [cmd_indicator],CONFIG_SWITCHES ; '1'
 39325 00003749 7403                    	je	short org_switch
 39326                                  	
 39327                                  org31:
 39328 0000374B E99500                  	jmp	org4
 39329                                  
 39330                                  org_switch:
 39331 0000374E E81601                  	call	skip_comment
 39332 00003751 7472                    	jz	short end_commd_line_brdg
 39333                                  
 39334 00003753 E8F700                  	call	get2
 39335 00003756 E8B10A                  	call	org_delim
 39336 00003759 74F3                    	jz	short org_switch
 39337                                  
 39338 0000375B AA                      	stosb
 39339 0000375C E99300                  	jmp	org5
 39340                                  
 39341                                  org_file:			; get the filename and put 0 at end
 39342 0000375F E80501                  	call	skip_comment
 39343 00003762 7464                    	jz	short org_put_zero
 39344                                  
 39345 00003764 E8E600                  	call	get2		; not a comment
 39346 00003767 E8980A                  	call	delim
 39347 0000376A 74F3                    	jz	short org_file	; skip the possible delimiters
 39348                                  
 39349 0000376C AA                      	stosb			; copy the first non delim char found in buffer
 39350                                  
 39351                                  org_copy_file:
 39352 0000376D E8F700                  	call	skip_comment	; comment char in the filename?
 39353 00003770 7456                    	jz	short org_put_zero ; then stop copying filename at that point
 39354                                  
 39355 00003772 E8D800                  	call	get2
 39356 00003775 3C2F                    	cmp	al,'/'		; a switch char? (device=filename/xxx)
 39357 00003777 7457                    	je	short end_file_slash ; this will be the special case.
 39358                                  
 39359 00003779 AA                      	stosb			; save the char. in buffer
 39360 0000377A E8850A                  	call	delim
 39361 0000377D 7459                    	jz	short end_copy_file
 39362                                  
 39363 0000377F 3C20                    	cmp	al, ' '
 39364 00003781 77EA                    	ja	short org_copy_file ; keep copying
 39365 00003783 EB53                    	jmp	short end_copy_file ; otherwise, assume end of the filename.
 39366                                  
 39367                                  get_cmt_token:			; get the token. just max. 2 char.
 39368 00003785 E8C500                  	call	get2
 39369 00003788 3C20                    	cmp	al,' '		; skip white spaces or "=" char.
 39370 0000378A 74F9                    	je	short get_cmt_token ; (we are allowing the other special
 39371 0000378C 3C09                    	cmp	al,tab ; 9 	;  characters can used for comment id.
 39372 0000378E 74F5                    	je	short get_cmt_token ;  character.)
 39373 00003790 3C3D                    	cmp	al,'='		; = is special in this case.
 39374 00003792 74F1                    	je	short get_cmt_token
 39375 00003794 3C0D                    	cmp	al,cr
 39376 00003796 7426                    	je	short get_cmt_end ; cannot accept the carriage return
 39377 00003798 3C0A                    	cmp	al,lf
 39378 0000379A 7422                    	je	short get_cmt_end
 39379                                  
 39380                                  	; 03/01/2023
 39381                                  	; ds = cs
 39382                                  	;mov	[cs:cmmt1],al	; store it
 39383                                  	;mov	byte [cs:cmmt],1 ; 1 char. so far.
 39384 0000379C A2[5203]                	mov	[cmmt1],al	; store it
 39385 0000379F C606[5103]01            	mov	byte [cmmt],1	; 1 char. so far.
 39386 000037A4 E8A600                  	call	get2
 39387 000037A7 3C20                    	cmp	al,' ' ; 20h
 39388 000037A9 7413                    	je	short get_cmt_end
 39389 000037AB 3C09                    	cmp	al,tab ; 9
 39390 000037AD 740F                    	je	short get_cmt_end
 39391 000037AF 3C0D                    	cmp	al,cr  ; 0Dh
 39392 000037B1 740B                    	je	short get_cmt_end
 39393 000037B3 3C0A                    	cmp	al,lf  ; 0Ah
 39394 000037B5 740E                    	je	short end_commd_line_brdg
 39395                                  
 39396                                  	;mov	[cs:cmmt2],al
 39397                                  	;inc	byte [cs:cmmt]
 39398                                  	; 03/01/2023
 39399 000037B7 A2[5303]                	mov	[cmmt2],al
 39400 000037BA FE06[5103]              	inc	byte [cmmt]
 39401                                  
 39402                                  get_cmt_end:
 39403 000037BE E88C00                  	call	get2
 39404 000037C1 3C0A                    	cmp	al,lf
 39405 000037C3 75F9                    	jne	short get_cmt_end	; skip it.
 39406                                  end_commd_line_brdg: 
 39407 000037C5 E997FE                  	jmp	end_commd_line		; else jmp to end_commd_line
 39408                                  
 39409                                  org_put_zero:				; make the filename in front of
 39410 000037C8 26C60500                	mov	byte [es:di],0		;  the comment string to be an asciiz.
 39411 000037CC 47                      	inc	di
 39412 000037CD E98FFE                  	jmp	end_commd_line		;  (maybe null if device=/*)
 39413                                  
 39414                                  end_file_slash: 			; al = "/" option char.
 39415 000037D0 26C60500                	mov	byte [es:di],0		; make a filename an asciiz
 39416 000037D4 47                      	inc	di			; and
 39417 000037D5 AA                      	stosb				; store "/" after that.
 39418 000037D6 EB1A                    	jmp	short org5		; continue with the rest of the line
 39419                                  
 39420                                  end_copy_file:
 39421 000037D8 26C645FF00              	mov	byte [es:di-1],0	; make it an asciiz and handle the next char.
 39422 000037DD 3C0A                    	cmp	al,lf
 39423 000037DF 74E4                    	je	short end_commd_line_brdg
 39424 000037E1 EB0F                    	jmp	short org5
 39425                                  
 39426                                  org4:					; org4 skips all delimiters after the command name except for '/'
 39427 000037E3 E88100                  	call	skip_comment
 39428 000037E6 74DD                    	jz	short end_commd_line_brdg
 39429                                  
 39430 000037E8 E86200                  	call	get2
 39431 000037EB E81C0A                  	call	org_delim		; skip delimiters except '/' (mrw 4/88)
 39432 000037EE 74F3                    	jz	short org4
 39433 000037F0 EB08                    	jmp	short org51
 39434                                  
 39435                                  org5:					; rest of the line
 39436 000037F2 E87200                  	call	skip_comment		; comment?
 39437 000037F5 74CE                    	jz	short end_commd_line_brdg
 39438 000037F7 E85300                  	call	get2			; not a comment.
 39439                                  
 39440                                  org51:
 39441 000037FA AA                      	stosb				; copy the character
 39442 000037FB 3C22                    	cmp	al,'"' 	; 22h		; a quote ?
 39443 000037FD 743A                    	je	short at_quote
 39444 000037FF 3C20                    	cmp	al,' '  ; 20h
 39445 00003801 77EF                    	ja	short org5
 39446                                  	
 39447                                  	; 09/09/2023
 39448                                  	; (Note: PCDOS 7.1 IBMBIO.COM does not contain M051 modification)
 39449                                  
 39450                                  					; M051 - Start
 39451                                  	; 03/01/2023
 39452                                  	; ds = cs
 39453 00003803 803E[5403]55                    cmp	byte [cmd_indicator],CONFIG_DEVICEHIGH
 39454                                  	;cmp	byte [cs:cmd_indicator],CONFIG_DEVICEHIGH ; Q: is this devicehigh
 39455 00003808 7514                    	jne	short not_dh		; N: 
 39456 0000380A 3C0A                    	cmp	al,lf			; Q: is this line feed
 39457 0000380C 7416                    	je	short org_dhlf		; Y: stuff a blank before the lf
 39458 0000380E 3C0D                    	cmp	al,cr			; Q: is this a cr
 39459 00003810 75E0                    	jne	short org5		; N: 
 39460 00003812 26C645FF20              	mov	byte [es:di-1],' '	; overwrite cr with blank
 39461 00003817 AA                      	stosb				; put cr after blank
 39462 00003818 FE06[9A34]              	inc	byte [insert_blank]
 39463                                  	;inc	byte [cs:insert_blank]	; indicate that blank has been 
 39464                                  					; inserted
 39465 0000381C EBD4                    	jmp	short org5
 39466                                  not_dh:					; M051 - End
 39467                                  
 39468 0000381E 3C0A                    	cmp	al,lf			; line feed?
 39469 00003820 740F                    	je	short org1_brdg		; handles the next command line.
 39470 00003822 EBCE                    	jmp	short org5		; handles next char in this line.
 39471                                  
 39472                                  org_dhlf:				; M051 - Start
 39473                                  	; 03/01/2023
 39474                                  	; ds = cs
 39475 00003824 803E[9A34]01            	cmp	byte [insert_blank],1
 39476                                  	;cmp	byte [cs:insert_blank],1 ; Q:has a blank already been inserted
 39477 00003829 7406                    	je	short org1_brdg		; Y:
 39478 0000382B 26C645FF20              	mov	byte [es:di-1],' '	; overwrite lf with blank
 39479 00003830 AA                      	stosb				; put lf after blank
 39480                                  					; M051 - End
 39481                                  org1_brdg:
 39482 00003831 C606[9A34]00            	mov	byte [insert_blank],0 
 39483                                  	;mov	byte [cs:insert_blank],0 ; M051: clear blank indicator for 
 39484                                  					; M051: devicehigh
 39485 00003836 E93CFE                  	jmp	org1
 39486                                  
 39487                                  at_quote:
 39488 00003839 803E[5003]00            	cmp	byte [com_level],0
 39489                                  	;cmp	byte [cs:com_level],0
 39490 0000383E 7407                    	je	short up_level
 39491                                  	;mov	byte [cs:com_level],0	; reset it.
 39492 00003840 C606[5003]00            	mov	byte [com_level],0
 39493 00003845 EBAB                    	jmp	short org5
 39494                                  
 39495                                  up_level:
 39496                                  	;inc	byte [cs:com_level]	; set it.
 39497 00003847 FE06[5003]              	inc	byte [com_level]
 39498 0000384B EBA5                    	jmp	short org5
 39499                                  
 39500                                  ;----------------------------------------------------------------------------
 39501                                  ;
 39502                                  ; procedure : get2
 39503                                  ;
 39504                                  ;----------------------------------------------------------------------------
 39505                                  
 39506                                  	; 02/11/2022 - Retrodos v4.0 (Modified MSDOS 5.0 IO.SYS)
 39507                                  	; (SYSINIT:33FAh)
 39508                                  
 39509                                  	; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 39510                                  	; (SYSINIT:4270h)
 39511                                  get2:
 39512 0000384D E304                    	jcxz	noget
 39513                                  	;
 39514                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39515                                  	;;lods	byte ptr es:[si]
 39516                                  	; 12/12/2022
 39517 0000384F 26                      	es	
 39518 00003850 AC                      	lodsb
 39519                                  	;mov	al, [es:si]
 39520                                  	;inc	si
 39521                                  	;
 39522 00003851 49                      	dec	cx
 39523 00003852 C3                      	retn
 39524                                  noget:
 39525 00003853 59                      	pop	cx
 39526                                  	; 03/01/2023
 39527                                  	; ds = cs
 39528                                  	;mov	[cs:count],di ; 13/05/2019
 39529                                  	;mov	[cs:org_count],di
 39530 00003854 893E[5603]              	mov	[count],di
 39531 00003858 893E[5803]              	mov	[org_count],di
 39532 0000385C 31F6                    	xor	si,si
 39533                                  	;mov	[cs:chrptr],si
 39534 0000385E 8936[5A03]              	mov	[chrptr],si
 39535                                  
 39536                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39537                                  
 39538                                  ; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 39539                                  
 39540                                  ;ifndef MULTI_CONFIG
 39541                                  ;	retn
 39542                                  ;else
 39543                                  
 39544                                  ;   This was the rather kludgy way out of procedure "organize", but instead
 39545                                  ;   of returning to doconf, we now want to check config.sys BEGIN/END blocks
 39546                                  ;   and the new boot menu stuff...
 39547                                  
 39548 00003862 89F9                    	mov     cx,di
 39549 00003864 E9E300                  	jmp     menu_check
 39550                                  
 39551                                  ;endif
 39552                                  	; 02/11/2022
 39553                                  	; 03/01/2023 - Retro DOS v4.2
 39554                                  	;retn
 39555                                  
 39556                                  ;----------------------------------------------------------------------------
 39557                                  ;
 39558                                  ; procedure : skip_comment
 39559                                  ;
 39560                                  ;skip the commented string until lf, if current es:si-> a comment string.
 39561                                  ;in) es:si-> string
 39562                                  ;	 cx -> length.
 39563                                  ;out) zero flag not set if not found a comment string.
 39564                                  ;	  zero flag set if found a comment string and skipped it. al will contain
 39565                                  ;	  the line feed character at this moment when return.
 39566                                  ;	  ax register destroyed.
 39567                                  ;	  if found, si, cx register adjusted accordingly.
 39568                                  ;
 39569                                  ;----------------------------------------------------------------------------
 39570                                  
 39571                                  	; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 39572                                  	; (SYSINIT:428Dh)
 39573                                  
 39574                                  skip_comment:
 39575 00003867 E3EA                    	jcxz	noget		; get out of the organize routine.
 39576                                  
 39577                                  	; 03/01/2023
 39578                                  	; ds = cs	
 39579                                  
 39580 00003869 803E[5003]00            	cmp	byte [com_level],0
 39581                                  	;cmp	byte [cs:com_level],0 ; only check it if parameter level is 0.
 39582 0000386E 752C                    	jne	short no_commt	 ; (not inside quotations)
 39583                                  
 39584 00003870 803E[5103]01            	cmp	byte [cmmt],1
 39585                                  	;cmp	byte [cs:cmmt],1
 39586 00003875 7225                    	jb	short no_commt
 39587                                  
 39588 00003877 268A04                  	mov	al,[es:si]
 39589                                  	
 39590 0000387A 3806[5203]              	cmp	[cmmt1],al
 39591                                  	;cmp	[cs:cmmt1],al
 39592 0000387E 751C                    	jne	short no_commt
 39593                                  
 39594 00003880 803E[5103]02            	cmp	byte [cmmt],2
 39595                                  	;cmp	byte [cs:cmmt],2
 39596 00003885 750A                    	jne	short skip_cmmt
 39597                                  
 39598 00003887 268A4401                	mov	al,[es:si+1]
 39599                                  	
 39600 0000388B 3806[5303]              	cmp	[cmmt2],al
 39601                                  	;cmp	[cs:cmmt2],al
 39602 0000388F 750B                    	jne	short no_commt
 39603                                  skip_cmmt:
 39604 00003891 E3C0                    	jcxz	noget		; get out of organize routine.
 39605 00003893 268A04                  	mov	al,[es:si]
 39606 00003896 46                      	inc	si
 39607 00003897 49                      	dec	cx
 39608 00003898 3C0A                    	cmp	al,lf		; line feed?
 39609 0000389A 75F5                    	jne	short skip_cmmt
 39610                                  no_commt:
 39611 0000389C C3                      	retn
 39612                                  
 39613                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 39614                                  ; (SYSINIT:42C8h)
 39615                                  
 39616                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39617                                  ;%if 0
 39618                                  
 39619                                  ;ifdef	MULTI_CONFIG
 39620                                  
 39621                                  ;----------------------------------------------------------------------------
 39622                                  ;
 39623                                  ;   kbd_read: wait for keystroke
 39624                                  ;
 39625                                  ;   INPUT
 39626                                  ;       DS == CS == sysinitseg
 39627                                  ;
 39628                                  ;   OUTPUT
 39629                                  ;       Carry SET to clean boot, CLEAR otherwise
 39630                                  ;
 39631                                  ;   OTHER REGS USED
 39632                                  ;       All
 39633                                  ;
 39634                                  ;   HISTORY
 39635                                  ;       Created 16-Nov-1992 by JeffPar
 39636                                  ;
 39637                                  ;----------------------------------------------------------------------------
 39638                                  
 39639                                  kbd_read:
 39640 0000389D F606[FA46]02                    test    byte [bDisableUI],2
 39641 000038A2 7520                            jnz     short kbd_nodelay
 39642                                  
 39643 000038A4 1E                              push    ds              ; the bios timer tick count is incremented
 39644 000038A5 29C0                            sub     ax,ax           ; 18.2 times per second;
 39645 000038A7 8ED8                            mov     ds,ax           ; watch the timer tick count for 37 transitions
 39646                                  	;mov	dx,[046Ch]	; get initial value
 39647                                  kbd_loop:
 39648 000038A9 B401                            mov     ah,1            ;
 39649 000038AB CD16                            int     16h             ; peek the keyboard
 39650 000038AD 7514                            jnz	short kbd_loopdone ; something's there, get out
 39651 000038AF B402                            mov     ah,2            ; peek the shift states
 39652 000038B1 CD16                            int     16h             ;
 39653 000038B3 A803                            test    al,03h          ; either right or left shift key bits set?
 39654 000038B5 750C                            jnz	short kbd_loopdone ; yes
 39655 000038B7 A16C04                          mov     ax,[046Ch]	;
 39656                                  	;sub	ax,dx           ; get difference
 39657                                  	; 15/04/2019 - Retro DOS v4.0
 39658 000038BA 2E2B06[8603]            	sub	ax,[cs:_timer_lw_] ; MSDOS 6.21 IO.SYS - SYSINIT:42E5h        
 39659                                  
 39660 000038BF 3C25                    	cmp     al,37           ; reached limit?  ; (2 seconds)
 39661 000038C1 72E6                            jb	short kbd_loop	; not yet
 39662                                  kbd_loopdone:
 39663 000038C3 1F                              pop     ds              ; delay complete!
 39664                                  kbd_nodelay:
 39665 000038C4 29DB                            sub     bx,bx           ; assume clean boot
 39666 000038C6 B402                            mov     ah,2            ; peek the shift states
 39667 000038C8 CD16                            int     16h             ;
 39668 000038CA A803                            test    al,03h          ; either right or left shift key bits set?
 39669 000038CC 7407                            jz      short kbd_notshift ; no
 39670 000038CE 43                              inc     bx              ; yes
 39671 000038CF 43                              inc     bx
 39672                                  	; MSDOS 6.21 IO.SYS - SYSINIT:4301h
 39673 000038D0 800E[FE46]04            	or	byte [bQueryOpt],4
 39674                                  kbd_notshift:                   ;
 39675 000038D5 B401                            mov     ah,1            ; peek the keyboard
 39676 000038D7 CD16                            int     16h             ;
 39677 000038D9 743E                            jz	short kbd_test	; no key present
 39678 000038DB 08C0                            or      al,al           ; is it a function key?
 39679 000038DD 753A                            jnz	short kbd_test	; no
 39680                                  
 39681                                  	; MSDOS 6.21 IO.SYS - SYSINIT:430Bh
 39682 000038DF 80FC62                          cmp     ah,62h          ; CTRL F5
 39683 000038E2 7405                            je	short kbd_cfg_bypass
 39684                                  	
 39685 000038E4 80FC3F                          cmp     ah,3Fh          ; F5 function key?
 39686 000038E7 750D                            jne	short kbd_notf5	; no
 39687                                  kbd_cfg_bypass:
 39688 000038E9 BA[8E4B]                        mov     dx,_$CleanMsg
 39689 000038EC E8DD0B                          call    print
 39690                                  	; MSDOS 6.21 IO.SYS - SYSINIT:431Bh
 39691 000038EF 800E[FE46]04            	or	byte [bQueryOpt],4 
 39692 000038F4 EB16                            jmp     short kbd_eat   ; yes, clean boot selected
 39693                                  kbd_notf5:
 39694                                  	; MSDOS 6.21 IO.SYS - SYSINIT:4322h
 39695 000038F6 80FC65                          cmp     ah,65h          ; CTRL F8
 39696 000038F9 7405                            je	short kbd_cfg_confirm
 39697                                  
 39698 000038FB 80FC42                          cmp     ah,42h          ; F8 function key?
 39699 000038FE 7523                            jne	short kbd_exit	; no
 39700                                  kbd_cfg_confirm:
 39701 00003900 BA[CC4B]                        mov     dx,_$InterMsg
 39702 00003903 E8C60B                          call    print           ;
 39703 00003906 B301                            mov     bl,1            ; yes, interactive-boot option enabled
 39704 00003908 881E[FE46]                      mov     [bQueryOpt],bl  ; change default setting
 39705                                  kbd_eat:                        ;
 39706 0000390C B400                            mov     ah,0            ;
 39707 0000390E CD16                            int     16h             ; eat the key we assumed was a signal
 39708 00003910 C606[0447]FF                    mov	byte [secElapsed],-1
 39709 00003915 09DB                            or      bx,bx           ;
 39710 00003917 7405                            jz	short kbd_clean	;
 39711                                  kbd_test:                       ;
 39712 00003919 80FB02                          cmp     bl,2            ;
 39713 0000391C 7205                            jb	short kbd_exit	;
 39714                                  kbd_clean:                      ;
 39715 0000391E E86E08                          call    disable_autoexec; yes, tell COMMAND to skip autoexec.bat
 39716 00003921 F9                              stc                     ; set carry to indicate abort
 39717 00003922 C3                              retn			;
 39718                                  kbd_exit:                       ;
 39719 00003923 F8                              clc                     ; clear carry to indicate success
 39720 00003924 C3                              retn			;
 39721                                  
 39722                                  ;----------------------------------------------------------------------------
 39723                                  ;
 39724                                  ;   set_numlock: set numlock LED
 39725                                  ;
 39726                                  ;   INPUT
 39727                                  ;       ES:SI -> numlock setting (ie, "ON" or "OFF")
 39728                                  ;
 39729                                  ;   OUTPUT
 39730                                  ;       None
 39731                                  ;
 39732                                  ;   OTHER REGS USED
 39733                                  ;       None
 39734                                  ;
 39735                                  ;   HISTORY
 39736                                  ;       Created 16-Nov-1992 by JeffPar
 39737                                  ;
 39738                                  ;----------------------------------------------------------------------------
 39739                                  
 39740                                  	; 04/01/2023 - Retro DOS v4.2
 39741                                  
 39742                                  set_numlock:
 39743                                          ; 04/01/2023
 39744                                  	;push	ax
 39745 00003925 1E                              push    ds
 39746 00003926 29C0                            sub     ax,ax
 39747 00003928 8ED8                            mov     ds,ax
 39748 0000392A 268B04                          mov     ax,[es:si]      ; get 1st 2 bytes of value (ON or OF)
 39749 0000392D 2E3B06[6C4B]                    cmp     ax,[cs:OnOff+2]	; should we turn it off?
 39750 00003932 7507                            jne	short not_off	; no
 39751 00003934 80261704DF                      and     byte [0417h],~20h ; 0DFh
 39752 00003939 EB0D                            jmp     short set_done
 39753                                  not_off:
 39754 0000393B 2E3B06[6A4B]                    cmp     ax,[cs:OnOff]	; should we turn it on?
 39755 00003940 F9                              stc
 39756 00003941 7505                            jne	short set_done	; no
 39757 00003943 800E170420                      or      byte [0417h],20h
 39758                                  set_done:
 39759 00003948 1F                              pop     ds
 39760                                  	; 04/01/2023
 39761                                  	;pop	ax
 39762 00003949 C3                              retn
 39763                                  
 39764                                  ; 16/04/2019 - Retro DOS v4.0
 39765                                  
 39766                                  ;----------------------------------------------------------------------------
 39767                                  ;
 39768                                  ;   menu_check: check for presence of menu (and other) configuration blocks
 39769                                  ;
 39770                                  ;   INPUT
 39771                                  ;       CX == "organized" config.sys memory image length
 39772                                  ;    ES:SI -> "organized" config.sys memory image
 39773                                  ;       DS == CS == sysinitseg
 39774                                  ;
 39775                                  ;   OUTPUT
 39776                                  ;       Same as above; the idea is that menu_check simply transforms
 39777                                  ;       a block-structured config.sys image into a conventional image,
 39778                                  ;       based on the user's block selection and any other boot-time options
 39779                                  ;       the user may have employed...
 39780                                  ;
 39781                                  ;   OTHER REGS USED
 39782                                  ;       All
 39783                                  ;
 39784                                  ;   NOTES
 39785                                  ;       [count] and [org_count] are set to the new config.sys image length
 39786                                  ;
 39787                                  ;   HISTORY
 39788                                  ;       Created 16-Mar-1992 by JeffPar
 39789                                  ;
 39790                                  ;----------------------------------------------------------------------------
 39791                                  
 39792                                  	; 04/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 39793                                  	; (SYSINIT:4378h)
 39794                                  
 39795                                  menu_check:
 39796                                  
 39797                                  ;   Search for SWITCHES, determine if /N or /F are present; if so, then
 39798                                  ;   disable clean/interactive boot options
 39799                                  
 39800 0000394A 51                              push    cx              ;
 39801 0000394B 56                              push    si              ;
 39802 0000394C 29DB                            sub     bx,bx           ; remains ZERO until first block
 39803                                  swchk_loop:                     ;
 39804 0000394E E83507                          call    get_char        ; get first char of current line
 39805 00003951 724C                            jc	short swchk_end	; hit eof
 39806 00003953 3C5B                            cmp     al,CONFIG_BEGIN ; '['
 39807 00003955 7503                            jne	short swchk_next1 ;
 39808 00003957 43                              inc     bx              ; remember that we've seen a block
 39809 00003958 EB40                            jmp     short swchk_nextline
 39810                                  swchk_next1:                    ;
 39811 0000395A 3C4E                            cmp     al,CONFIG_NUMLOCK
 39812 0000395C 750E                            jne	short swchk_next2 ;
 39813 0000395E 09DB                            or      bx,bx           ; only do NUMLOCK commands that exist
 39814 00003960 7538                            jnz	short swchk_nextline ; before the first block
 39815 00003962 E8C0FF                          call    set_numlock     ; REM it out so we don't act on it later, too
 39816 00003965 26C644FF30                      mov     byte [es:si-1],CONFIG_REM
 39817 0000396A EB2E                            jmp     short swchk_nextline
 39818                                  swchk_next2:                    ;
 39819 0000396C 3C31                            cmp     al,CONFIG_SWITCHES
 39820 0000396E 752A                            jne	short swchk_nextline ; this line ain't it
 39821                                  swchk_scan:                     ;
 39822 00003970 E81307                          call    get_char        ; look for /N or /F
 39823                                  swchk_scan1:                    ;
 39824 00003973 3C0A                            cmp     al,LF           ; end of line?
 39825 00003975 7423                            je	short swchk_nextline ; yes
 39826 00003977 3C2F                            cmp     al,'/'          ; switch-char?
 39827 00003979 75F5                            jne	short swchk_scan ; no
 39828 0000397B E80807                          call    get_char        ;
 39829 0000397E 24DF                            and     al,~20h ; 0DFh	; convert to upper case
 39830 00003980 3A06[B41E]                      cmp     al,[swit_n+1]
 39831 00003984 7507                            jne	short swchk_scan2 ; no
 39832 00003986 800E[FA46]01                    or      byte [bDisableUI],1
 39833 0000398B EBE3                            jmp	short swchk_scan ; continue looking for switches of interest
 39834                                  swchk_scan2:                    ;
 39835 0000398D 3A06[C01E]                      cmp     al,[swit_f+1]
 39836 00003991 75E0                            jne	short swchk_scan1 ; no
 39837 00003993 800E[FA46]02                    or      byte [bDisableUI],2
 39838 00003998 EBD6                            jmp     short swchk_scan ; continue looking for switches of interest
 39839                                  swchk_nextline:                 ;
 39840 0000399A E8C306                          call    skip_opt_line   ;
 39841 0000399D EBAF                            jmp     short swchk_loop ;
 39842                                  swchk_end:                      ;
 39843 0000399F 5E                              pop     si              ;
 39844 000039A0 59                              pop     cx              ;
 39845                                  
 39846                                  ;   Do the keyboard tests for clean/interactive boot now, but only if
 39847                                  ;   the DisableUI flag is still clear
 39848                                  
 39849 000039A1 F606[FA46]01                    test    byte [bDisableUI],1
 39850 000039A6 7508                            jnz	short menu_search
 39851                                  ;
 39852                                  ;   Wait for 2 seconds first, UNLESS the /F bit was set in bDisableUI, or
 39853                                  ;   there is anything at all in the keyboard buffer
 39854                                  ;
 39855 000039A8 E8F2FE                          call    kbd_read
 39856 000039AB 7303                            jnc	short menu_search
 39857 000039AD E9EE01                          jmp	menu_abort
 39858                                  
 39859                                  ;   Search for MENU block; it is allowed to be anywhere in config.sys
 39860                                  
 39861                                  menu_search:
 39862 000039B0 29DB                            sub     bx,bx           ; if no MENU, default to zero for no_selection
 39863 000039B2 BF[3F47]                        mov     di,szMenu	;
 39864 000039B5 E80304                          call    find_block      ; find the MENU block
 39865 000039B8 7337                            jnc	short menu_found ;
 39866 000039BA C606[3747]00                    mov     byte [szBoot],0
 39867 000039BF E90C02                          jmp	no_selection ; not found
 39868                                  
 39869                                  ;   Process the requested menu color(s)
 39870                                  
 39871                                  menu_color:
 39872 000039C2 51                      	push	cx              ;
 39873 000039C3 52                      	push	dx              ;
 39874                                  	;;mov	dx,0007h        ; default color setting
 39875                                  	; 10/09/2023
 39876                                  	;mov	dl,7 ; !*!
 39877 000039C4 E89E06                  	call	get_number	; get first number
 39878 000039C7 80E30F                  	and	bl,0Fh  ; !**!	; first # is foreground color (for low nibble)
 39879 000039CA 88DD                    	mov	ch,bl           ; save it in CH
 39880                                  	; 01/08/2023 - Retro DOS v4.2 IO.SYS (optimization) by Erdogan Tan 
 39881                                  	; (high nibble of dl is 0)
 39882                                  	;and	dl,0F0h	; !*!	; (low nibble of dl would be zero)
 39883                                  	;or	dl,bl		; (low nibble of dl is 7) ! 14/08/2023
 39884 000039CC 88DA                    	mov	dl,bl	; 14/08/2023
 39885 000039CE E83108                  	call	delim           ; did we hit a delimiter
 39886 000039D1 750E                    	jne	short check_color ; no, all done
 39887 000039D3 E88F06                  	call	get_number	; get next number
 39888 000039D6 80E30F                  	and	bl,0Fh		; second # is background color (for high nibble)
 39889 000039D9 88DE                    	mov	dh,bl           ; save it in DH
 39890                                  	; 10/09/2023
 39891                                  	;and	dl,0Fh	; !**!	;
 39892 000039DB B104                    	mov	cl,4            ;
 39893 000039DD D2E3                    	shl	bl,cl           ;
 39894 000039DF 08DA                    	or	dl,bl           ;
 39895                                  check_color:
 39896 000039E1 38F5                    	cmp	ch,dh           ; are foreground/background the same?
 39897 000039E3 7503                    	jne	short set_color	; no
 39898 000039E5 80F208                  	xor	dl,08h          ; yes, so modify the fgnd intensity
 39899                                  set_color:
 39900 000039E8 8816[F546]              	mov	[bMenuColor],dl ;
 39901 000039EC 5A                      	pop	dx              ;
 39902 000039ED 59                      	pop	cx              ;
 39903 000039EE E9A900                  	jmp	menu_nextitem
 39904                                  
 39905                                  ;   Back to our regularly scheduled program (the COLOR and other goop
 39906                                  ;   above is there simply to alleviate short jump problems)
 39907                                  
 39908                                  menu_found:
 39909 000039F1 C606[FF46]01                    mov     byte [bDefBlock],1
 39910                                          ;mov	word [offDefBlock],0
 39911 000039F6 C606[0347]FF                    mov     byte [secTimeOut],-1
 39912 000039FB 8026[FE46]FD                    and     byte [bQueryOpt],~2 ; 0FDh
 39913                                  	; 10/09/2023
 39914 00003A00 29D2                    	sub	dx,dx
 39915 00003A02 8916[0147]              	mov	[offDefBlock],dx ; 0
 39916                                  
 39917 00003A06 E85706                          call    skip_opt_line   ; skip to next line
 39918                                  	; 10/09/2023
 39919                                  	;sub	dx,dx		; initialize total block count (0 => none yet)
 39920                                  
 39921                                  ;   Process the menu block now
 39922                                  
 39923                                  menu_process:
 39924 00003A09 E87A06                          call    get_char        ; get first char of current line
 39925 00003A0C 722E                            jc	short to_menu_getdefault ; could happen if menu block at end (rare)
 39926 00003A0E 247F                            and     al,~CONFIG_OPTION_QUERY ; 7Fh
 39927 00003A10 3C5B                            cmp     al,CONFIG_BEGIN ; BEGIN implies END
 39928 00003A12 7428                            je	short to_menu_getdefault
 39929 00003A14 3C4F                            cmp     al,CONFIG_SUBMENU
 39930 00003A16 744D                            je	short menu_item	; go process sub-menu
 39931 00003A18 3C45                            cmp     al,CONFIG_MENUITEM
 39932 00003A1A 7449                            je	short menu_item	; go process menu item
 39933 00003A1C 3C41                            cmp     al,CONFIG_MENUDEFAULT
 39934 00003A1E 741E                            je	short menu_default ; go process menu default
 39935 00003A20 3C52                            cmp     al,CONFIG_MENUCOLOR
 39936 00003A22 749E                            je	short menu_color ; go process menu color
 39937 00003A24 3C4E                            cmp     al,CONFIG_NUMLOCK
 39938 00003A26 740F                            je	short menu_numlock ;
 39939 00003A28 3C30                            cmp     al,CONFIG_REM   ; allow remarks in menu block
 39940 00003A2A 746E                            je	short menu_nextitem ;
 39941 00003A2C E8C307                          call    any_delim       ; allow blank lines and such
 39942 00003A2F 7469                            je	short menu_nextitem ;
 39943 00003A31 F9                              stc                     ;
 39944 00003A32 E82607                          call    print_error     ; non-MENU command!
 39945 00003A35 EB63                            jmp     short menu_nextitem
 39946                                  menu_numlock:
 39947 00003A37 E8EBFE                          call    set_numlock
 39948 00003A3A EB5E                            jmp     short menu_nextitem
 39949                                  to_menu_getdefault:
 39950 00003A3C EB62                            jmp     short menu_getdefault
 39951                                  
 39952                                  ;   Save the offset of the default block name, we'll need it later
 39953                                  
 39954                                  menu_default:
 39955 00003A3E 8936[0147]                      mov     [offDefBlock],si; save address of default block name
 39956 00003A42 803E[0447]00                    cmp     byte [secElapsed],0
 39957 00003A47 751A                            jne	short timeout_skip ; secElapsed is only zero for the FIRST menu,
 39958 00003A49 E8EA05                          call    skip_token      ; and for subsequent menus IF nothing was typed;
 39959 00003A4C 724C                            jc	short menu_nextitem ; secElapsed becomes -1 forever as soon as
 39960 00003A4E E8FB05                          call    skip_delim      ; something is typed
 39961 00003A51 7247                            jc	short menu_nextitem ;
 39962 00003A53 89DE                            mov     si,bx           ;
 39963 00003A55 E80D06                          call    get_number      ; get number (of seconds for timeout)
 39964 00003A58 80FB5A                          cmp     bl,90           ; limit it to a reasonable number
 39965                                  	;jb	short timeout_ok ; (besides, 99 is the largest # my simple
 39966 00003A5B 7602                            jna	short timeout_ok ; 01/08/2023
 39967 00003A5D B35A                    	mov     bl,90           ;  display function can handle)
 39968                                  timeout_ok:                     ;
 39969 00003A5F 881E[0347]                      mov     [secTimeOut],bl ;
 39970                                  timeout_skip:
 39971 00003A63 EB35                            jmp     short menu_nextitem
 39972                                  
 39973                                  ;   Verify that this is a valid menu item by searching for the named block
 39974                                  
 39975                                  menu_item:
 39976                                  	;cmp	dl,9	; 04/01/2023
 39977 00003A65 80FA09                          cmp     dl,MAX_MULTI_CONFIG ; have we reached the max # of items yet?
 39978 00003A68 7330                            jae	short menu_nextitem ;
 39979 00003A6A 89F7                            mov     di,si           ; DS:DI -> block name to search for
 39980 00003A6C E83303                          call    srch_block      ;
 39981 00003A6F 7406                            je	short menu_itemfound ;
 39982 00003A71 F9                              stc                     ;
 39983 00003A72 E8E606                          call    print_error     ; print error and pause
 39984 00003A75 EB23                            jmp     short menu_nextitem ; if not found, ignore this menu item
 39985                                  
 39986                                  ;   srch_block, having succeeded, returns DI -> past the token that it
 39987                                  ;   just matched, which in this case should be a descriptive string; ES:SI
 39988                                  ;   and CX are unmodified
 39989                                  
 39990                                  menu_itemfound:
 39991 00003A77 42                              inc     dx              ; otherwise, increment total block count
 39992 00003A78 89D3                            mov     bx,dx           ; and use it to index the arrays of offsets
 39993 00003A7A 8887[0547]                      mov	[abBlockType+bx],al
 39994 00003A7E 01DB                            add     bx,bx           ; of recorded block names and descriptions
 39995                                  
 39996                                  ;   There should be a description immediately following the block name on
 39997                                  ;   MENUITEM line; failing that, we'll just use the block name as the
 39998                                  ;   description...
 39999                                  
 40000 00003A80 89B7[0F47]                      mov     [aoffBlockName+bx],si
 40001 00003A84 89B7[2347]                      mov     [aoffBlockDesc+bx],si
 40002 00003A88 89DF                            mov     di,bx           ; skip_delim modifies BX, so stash it in DI
 40003 00003A8A E8A905                          call    skip_token      ;
 40004 00003A8D 720B                            jc	short menu_nextitem ; hit eol/eof
 40005 00003A8F E8BA05                          call    skip_delim      ;
 40006 00003A92 7206                            jc	short menu_nextitem ; hit eol/eof
 40007 00003A94 87DF                            xchg    bx,di           ;
 40008 00003A96 89BF[2347]                      mov     [aoffBlockDesc+bx],di
 40009                                  
 40010                                  menu_nextitem:
 40011 00003A9A E8C305                          call    skip_opt_line   ;
 40012 00003A9D E969FF                          jmp     menu_process    ; go back for more lines
 40013                                  
 40014                                  ;   Display menu items now, after determining which one is default
 40015                                  
 40016                                  menu_getdefault:
 40017 00003AA0 08D2                            or      dl,dl           ; where there any valid blocks at all?
 40018 00003AA2 7505                            jnz	short menu_valid ; yes
 40019 00003AA4 29DB                            sub     bx,bx           ; no, so force autoselect of 0
 40020 00003AA6 E9ED00                          jmp     menu_autoselect ; (meaning: process common blocks only)
 40021                                  menu_valid:
 40022 00003AA9 29DB                            sub     bx,bx           ;
 40023 00003AAB 8816[0047]                      mov     [bMaxBlock],dl  ; first, record how many blocks we found
 40024 00003AAF 8B3E[0147]                      mov     di,[offDefBlock];
 40025 00003AB3 09FF                            or      di,di           ; does a default block exist?
 40026 00003AB5 741C                            jz	short menu_nodefault ; no
 40027 00003AB7 43                              inc     bx              ; yes, walk name table, looking for default
 40028                                  menu_chkdefault:
 40029 00003AB8 53                              push    bx              ;
 40030 00003AB9 01DB                            add     bx,bx           ;
 40031 00003ABB 8BB7[0F47]                      mov     si,[aoffBlockName+bx]
 40032 00003ABF B98000                          mov     cx,128          ; arbitrary maximum length of a name
 40033 00003AC2 1E                              push    ds              ;
 40034 00003AC3 06                              push    es              ;
 40035 00003AC4 1F                              pop     ds              ;
 40036 00003AC5 E81A03                          call    comp_names      ; is this block the same as the default?
 40037 00003AC8 1F                              pop     ds              ;
 40038 00003AC9 5B                              pop     bx              ;
 40039 00003ACA 7409                            je	short menu_setdefault ; yes
 40040 00003ACC 43                              inc     bx              ;
 40041 00003ACD 3A1E[0047]                      cmp     bl,[bMaxBlock]  ; all done searching?
 40042 00003AD1 76E5                            jbe	short menu_chkdefault ; not yet
 40043                                  menu_nodefault:
 40044 00003AD3 B301                            mov     bl,1            ; if no default, force default to #1
 40045                                  menu_setdefault:
 40046 00003AD5 881E[FF46]                      mov     [bDefBlock],bl  ; yes, this will be the initial current block
 40047                                  
 40048                                  ;   If the timeout was explicitly set to 0 (or technically, anything that
 40049                                  ;   failed to resolve to a number, like "NONE" or "EAT POTATOES"), then we're
 40050                                  ;   supposed to skip menu display and run with the specified default block;
 40051                                  ;   however, if the user hit Enter prior to boot, thereby requesting fully
 40052                                  ;   INTERACTIVE boot, then we shall display the menu block anyway (though still
 40053                                  ;   with no timeout)
 40054                                  
 40055 00003AD9 803E[0347]00                    cmp     byte [secTimeOut],0 ; is timeout zero? (ie, assume default)
 40056 00003ADE 750A                            jne	short menu_display ; no
 40057 00003AE0 F606[FE46]01                    test    byte [bQueryOpt],1 ; yes, but was INTERACTIVE requested?
 40058 00003AE5 7503                            jnz	short menu_display ; yes, so *don't* assume default after all
 40059 00003AE7 E9C700                          jmp     not_topmenu	;
 40060                                  
 40061                                  ;   Reset the mode, so that we know screen is clean and cursor is home
 40062                                  
 40063                                  menu_display:
 40064 00003AEA B40F                            mov     ah,0Fh          ; get current video mode
 40065 00003AEC CD10                            int     10h             ;
 40066 00003AEE B400                            mov     ah,00h          ; just re-select that mode
 40067 00003AF0 CD10                            int     10h             ;
 40068 00003AF2 06                              push    es              ;
 40069 00003AF3 B84000                          mov     ax,40h          ; reach down into the ROM BIOS data area
 40070 00003AF6 8EC0                            mov     es,ax           ; and save the current (default) video page
 40071 00003AF8 26A14E00                        mov     ax,[es:004Eh]   ; start address and page #, in case the
 40072 00003AFC A3[FC46]                        mov     [wCRTStart],ax  ; undocumented QUIET option was enabled
 40073 00003AFF 26A06200                        mov     al,[es:0062h]   ;
 40074 00003B03 A2[FB46]                        mov     [bCRTPage],al   ;
 40075 00003B06 A1[F646]                        mov     ax,[bMenuPage]	; select new page for menu
 40076 00003B09 CD10                            int     10h             ;
 40077 00003B0B B80006                          mov     ax,0600h        ; clear entire screen
 40078 00003B0E 8A3E[F546]                      mov     bh,[bMenuColor] ; using this color
 40079 00003B12 29C9                            sub     cx,cx           ; upper left row/col
 40080                                          ;mov	dl,[es:CRT_Cols] 
 40081 00003B14 268A164A00                      mov	dl,[es:4Ah]
 40082 00003B19 FECA                    	dec     dl              ;
 40083                                          ;mov	dh,[es:CRT_Rows];
 40084 00003B1B 268A368400                      mov	dh,[es:84h]
 40085 00003B20 08F6                    	or      dh,dh           ; # of rows valid?
 40086 00003B22 7504                            jnz	short menu_clear ; hopefully
 40087 00003B24 8A36[F946]                      mov     dh,[bLastRow]   ; no, use a default
 40088                                  menu_clear:
 40089 00003B28 CD10                            int     10h             ; clear the screen using the req. attribute
 40090 00003B2A 07                              pop     es              ;
 40091 00003B2B 8836[F946]                      mov     [bLastRow],dh   ; save DH
 40092 00003B2F BA[094C]                        mov     dx,_$MenuHeader
 40093 00003B32 E89709                          call    print           ; cursor now on row 3 (numbered from 0)
 40094                                  
 40095 00003B35 F606[FA46]01                    test    byte [bDisableUI],1
 40096 00003B3A 751F                            jnz     short menu_nostatus
 40097 00003B3C 8A3E[F646]                      mov     bh,[bMenuPage]  ;
 40098 00003B40 8A36[F946]                      mov     dh,[bLastRow]   ; restore DH
 40099 00003B44 B200                            mov     dl,0            ; print the status line on row DH, col 0,
 40100 00003B46 B402                            mov     ah,02h          ; now that we can trash the cursor position
 40101 00003B48 CD10                            int     10h             ;
 40102 00003B4A BA[554C]                        mov     dx,_$StatusLine
 40103 00003B4D E87C09                          call    print           ;
 40104 00003B50 B403                            mov     ah,3            ; get cursor position
 40105 00003B52 CD10                            int     10h             ;
 40106 00003B54 80EA02                          sub     dl,2            ;
 40107 00003B57 8816[F846]                      mov     [bLastCol],dl   ; save column where status char will go
 40108                                  
 40109                                  menu_nostatus:
 40110 00003B5B BB0100                          mov     bx,1            ; now prepare to display all the menu items
 40111                                  menu_disploop:
 40112 00003B5E E8B002                          call    print_item	; print item #BL
 40113 00003B61 43                              inc     bx              ; why "inc bx"? because it's a 1-byte opcode
 40114 00003B62 3A1E[0047]                      cmp     bl,[bMaxBlock]  ; all done?
 40115 00003B66 76F6                            jbe	short menu_disploop ; not yet
 40116                                  
 40117                                  ;   Set cursor position to just below the menu items
 40118                                  
 40119 00003B68 B200                            mov     dl,0            ; select column
 40120 00003B6A 88DE                            mov     dh,bl           ;
 40121 00003B6C 80C604                          add     dh,4            ; select row below menu
 40122 00003B6F 8A3E[F646]                      mov     bh,[bMenuPage]  ;
 40123 00003B73 B402                            mov     ah,02h          ; set cursor position beneath the block list
 40124 00003B75 CD10                            int     10h             ;
 40125                                  
 40126 00003B77 BA[424C]                        mov     dx,_$MenuPrmpt
 40127 00003B7A E84F09                          call    print           ;
 40128 00003B7D E82903                          call    select_item     ; make a selection, return # in BX
 40129 00003B80 BA[184A]                        mov     dx,crlfm	
 40130 00003B83 E84609                          call    print           ;
 40131 00003B86 FF36[FA46]                      push    word [bDisableUI]
 40132 00003B8A 800E[FA46]01                    or      byte [bDisableUI],1
 40133 00003B8F E86704                          call    show_status     ; clear the status line now
 40134 00003B92 8F06[FA46]                      pop     word [bDisableUI]
 40135                                  
 40136                                  ;   Now begins the "re-organization" process...
 40137                                  
 40138                                  menu_autoselect:
 40139 00003B96 83FBFF                          cmp     bx,-1 ; 0FFFFh	; clean boot requested?
 40140 00003B99 7508                            jne	short normal_boot ; no
 40141 00003B9B E8F105                          call    disable_autoexec; basically, add a /D to the command.com line
 40142                                  menu_abort:
 40143 00003B9E 29C9                            sub     cx,cx           ; then immediately exit with 0 config.sys image
 40144 00003BA0 E9E400                          jmp	menu_exit	;
 40145                                  
 40146                                  normal_boot:
 40147 00003BA3 83FBFE                          cmp     bx,-2 ; 0FFFEh	; back to top-level menu?
 40148 00003BA6 7509                            jne	short not_topmenu ; no
 40149 00003BA8 8B0E[5603]                      mov     cx,[count]      ; yes, start all over
 40150 00003BAC 29F6                            sub     si,si           ;
 40151 00003BAE E9FFFD                          jmp     menu_search
 40152                                  
 40153                                  not_topmenu:
 40154 00003BB1 80BF[0547]4F                    cmp     byte [abBlockType+bx],CONFIG_SUBMENU
 40155 00003BB6 7510                            jne	short not_submenu
 40156 00003BB8 01DB                            add     bx,bx           ;
 40157 00003BBA 8BBF[0F47]                      mov     di,[aoffBlockName+bx]
 40158 00003BBE E8E101                          call    srch_block      ; THIS CANNOT FAIL!
 40159 00003BC1 89FE                            mov     si,di           ;
 40160 00003BC3 89D9                            mov     cx,bx           ; ES:SI and CX are ready for another round
 40161 00003BC5 E929FE                          jmp     menu_found
 40162                                  
 40163                                  not_submenu:
 40164 00003BC8 01DB                            add     bx,bx           ; get BX -> name of selected block
 40165 00003BCA 8B9F[0F47]                      mov     bx,[aoffBlockName+bx]
 40166                                  
 40167                                  ;   BX should now either be ZERO (meaning no block has been selected) or
 40168                                  ;   the offset relative to ES of the block name to be processed (along with
 40169                                  ;   all the "common" lines of course)
 40170                                  
 40171                                  no_selection:
 40172 00003BCE 891E[0147]                      mov     [offDefBlock],bx; save selection
 40173 00003BD2 8B0E[5603]                      mov     cx,[count]      ; reset ES:SI and CX for reprocessing
 40174 00003BD6 29F6                            sub     si,si           ;
 40175 00003BD8 1E                              push    ds              ;
 40176 00003BD9 8E1E[B114]                      mov     ds,[config_wrkseg]; this is where we'll store new config.sys image
 40177 00003BDD 29FF                            sub     di,di           ;
 40178                                  
 40179                                  ;   ES:SI-> config.sys, DS:DI -> new config.sys workspace
 40180                                  ;
 40181                                  ;   Work our way through the config.sys image again, this time copying
 40182                                  ;   all lines that are (A) "common" lines outside any block or (B) lines
 40183                                  ;   within the requested block. Lines inside INCLUDEd blocks are transparently
 40184                                  ;   copied by copy_block in a recursive fashion; the amount of recursion is
 40185                                  ;   limited by the fact INCLUDE statements are REMed by copy_block as they are
 40186                                  ;   processed and by the number of unique INCLUDE stmts in config.sys...
 40187                                  ;
 40188                                  ;   BUGBUG 20-Mar-1992 JeffPar: If we can figure out the lower bound of the
 40189                                  ;   stack we're running on, then we should check it inside copy_block
 40190                                  
 40191                                  copyblock_loop:
 40192 00003BDF 53                              push    bx              ; save selected block name
 40193 00003BE0 E82F01                          call    copy_block      ; process (named or common) block
 40194 00003BE3 5B                              pop     bx              ;
 40195 00003BE4 7232                            jc	short move_config ; hit eof
 40196                                  
 40197                                  ;   copy_block can only return for two reasons: it hit eof or a new block
 40198                                  
 40199                                  copyblock_begin:
 40200                                  
 40201                                  ; 10/09/2023
 40202                                  %if 0
 40203                                          push    ax              ;
 40204                                          push    cx              ;
 40205                                          push    si              ;
 40206                                          push    di              ; always do "common" blocks
 40207                                          mov     di,szCommon
 40208                                          push    ds              ;
 40209                                          push    cs              ;
 40210                                          pop     ds              ;
 40211                                          call    comp_names      ;
 40212                                          pop     ds              ;
 40213                                          pop     di              ;
 40214                                          pop     si              ;
 40215                                          pop     cx              ;
 40216                                          pop     ax              ;
 40217                                          je	short copyblock_check
 40218                                  %endif
 40219                                  	; 10/09/2023
 40220 00003BE6 57                      	push	di
 40221 00003BE7 BF[4447]                	mov	di,szCommon	; always do "common" blocks
 40222 00003BEA E81602                  	call	comp_names_x	; (comp_names_safe)
 40223 00003BED 5F                      	pop	di
 40224 00003BEE 740F                    	je	short copyblock_check
 40225                                  
 40226 00003BF0 09DB                            or      bx,bx           ; is there a block name to check?
 40227 00003BF2 7414                            jz	short copyblock_skip ; no
 40228 00003BF4 57                              push    di              ;
 40229 00003BF5 89DF                            mov     di,bx           ; check block against given block name
 40230 00003BF7 1E                              push    ds              ;
 40231 00003BF8 06                              push    es              ;
 40232 00003BF9 1F                              pop     ds              ;
 40233 00003BFA E8E501                          call    comp_names      ; is this the block we really want to do?
 40234 00003BFD 1F                              pop     ds              ;
 40235 00003BFE 5F                              pop     di              ;
 40236                                  copyblock_check:
 40237 00003BFF 7217                            jc	short move_config ; hit eof
 40238 00003C01 7505                            jne	short copyblock_skip ;
 40239 00003C03 E85A04                          call    skip_opt_line   ;
 40240 00003C06 EBD7                            jmp	short copyblock_loop
 40241                                  
 40242                                  copyblock_skip:                 ;
 40243 00003C08 E85504                          call    skip_opt_line   ; this ain't the block we wanted, so skip it
 40244 00003C0B E87804                          call    get_char        ;
 40245 00003C0E 7208                            jc	short move_config ; hit eof
 40246 00003C10 247F                            and     al,~CONFIG_OPTION_QUERY ; 7Fh
 40247 00003C12 3C5B                            cmp     al,CONFIG_BEGIN ;
 40248 00003C14 74D0                            je	short copyblock_begin
 40249 00003C16 EBF0                            jmp     short copyblock_skip ; anything else is just skipped
 40250                                  ;
 40251                                  ;   To create as little risk to the rest of SysInit as little as possible,
 40252                                  ;   and to free the workspace at "config_wrkseg" for creating an environment,
 40253                                  ;   copy the new config.sys image to "confbot"
 40254                                  ;
 40255                                  move_config:
 40256 00003C18 89F9                            mov     cx,di           ; now copy workspace at DS:DI to "confbot"
 40257 00003C1A 51                              push    cx              ;
 40258                                  ;
 40259                                  ;   But first, copy the CONFIG=<configuration><0> string to the workspace,
 40260                                  ;   since the configuration name only currently exists in the "confbot" area
 40261                                  ;
 40262                                   	;mov	cx,7
 40263 00003C1B B90700                  	mov     cx,szMenu-szBoot-1
 40264 00003C1E BE[3747]                        mov     si,szBoot	; first copy the CONFIG= part
 40265 00003C21 47                              inc     di              ; skip a byte, in case absolutely nothing
 40266                                                                  ; was copied to the workspace, because we always
 40267                                                                  ; zero the first byte of the workspace (below)
 40268                                  copy_boot: 
 40269                                  	;lods    byte ptr cs:[si];
 40270 00003C22 2E                              cs
 40271 00003C23 AC                      	lodsb
 40272 00003C24 8805                    	mov     [di],al         ;
 40273 00003C26 47                              inc     di              ;
 40274 00003C27 E2F9                            loop    copy_boot       ;
 40275                                  
 40276 00003C29 06                              push    es              ; then copy the configuration name
 40277                                          ;mov	cx,128-7	; put an upper limit on the name, to be safe
 40278                                  	; 04/01/2023
 40279 00003C2A B179                    	mov	cl,128-7
 40280 00003C2C 2E8B36[0147]            	mov     si,[cs:offDefBlock]; ES:SI -> default block name
 40281 00003C31 09F6                            or      si,si           ; valid?
 40282 00003C33 7505                            jnz	short l1	; yes
 40283 00003C35 0E                              push    cs              ;
 40284 00003C36 07                              pop     es              ;
 40285 00003C37 BE[4447]                        mov     si,szCommon
 40286 00003C3A 268A04                  l1:     mov     al,[es:si]      ;
 40287 00003C3D E8B205                          call    any_delim       ;
 40288 00003C40 7406                            je	short l2	;
 40289 00003C42 8805                            mov     [di],al         ;
 40290 00003C44 46                              inc     si              ;
 40291 00003C45 47                              inc     di              ;
 40292 00003C46 E2F2                            loop    l1              ;
 40293 00003C48 C6050A                  l2:     mov     byte [di],lf	; terminate the configuration string
 40294 00003C4B 07                              pop     es              ;
 40295                                  
 40296                                  ;   Now we can copy "config_wrkseg" (DS) to "confbot" (ES)
 40297                                  
 40298 00003C4C 29FF                            sub     di,di           ;
 40299 00003C4E 2E893E[AF14]                    mov     [cs:config_envlen],di
 40300 00003C53 29F6                            sub     si,si           ;
 40301 00003C55 59                              pop     cx              ; recover the size of "config_wrkseg"
 40302                                  
 40303 00003C56 51                              push    cx              ;
 40304 00003C57 F3A4                            rep     movsb           ; moved!
 40305 00003C59 59                              pop     cx              ;
 40306 00003C5A 8CD8                            mov     ax,ds           ;
 40307 00003C5C 1F                              pop     ds              ;
 40308                                  
 40309                                  ;   Now that the config_wrkseg is available once again, we shall
 40310                                  ;   use it to create an environment. The first thing to go in will be
 40311                                  ;   the "CONFIG=configuration" thing. It is also important to zero
 40312                                  ;   the first byte of the workspace, so that copy_envvar knows the buffer
 40313                                  ;   is empty.
 40314                                  
 40315 00003C5D 06                              push    es              ;
 40316 00003C5E 8EC0                            mov     es,ax           ;
 40317 00003C60 46                              inc     si              ; ES:SI -> "CONFIG=configuration"
 40318 00003C61 26C606000000                    mov     byte [es:0],0	; empty the environment block
 40319 00003C67 E82600                          call    copy_envvar     ; copy envvar at ES:SI to "config_wrkseg"
 40320 00003C6A 07                              pop     es
 40321                                  
 40322                                  ;   Before returning, restore the default video page setting but do NOT
 40323                                  ;   do it using INT 10h's Set Active Page function, because if the menu was
 40324                                  ;   displayed on a different page, then it's because we don't want to see
 40325                                  ;   all the device driver/TSR goop (which goes to the default page)
 40326                                  
 40327                                  menu_done:
 40328 00003C6B 803E[F646]00                    cmp     byte [bMenuPage],0
 40329 00003C70 7415                            je	short menu_exit	;
 40330 00003C72 06                              push    es              ;
 40331 00003C73 B84000                          mov     ax,40h          ;
 40332 00003C76 8EC0                            mov     es,ax           ;
 40333 00003C78 A1[FC46]                        mov     ax,[wCRTStart]  ;
 40334 00003C7B 26A34E00                        mov     [es:004Eh],ax   ;
 40335 00003C7F A0[FB46]                        mov     al,[bCRTPage]   ;
 40336 00003C82 26A26200                        mov     [es:0062h],al   ;
 40337 00003C86 07                              pop     es              ;
 40338                                  menu_exit:
 40339 00003C87 890E[5603]                      mov     [count],cx      ; set new counts
 40340 00003C8B 890E[5803]                      mov     [org_count],cx  ;
 40341                                          ; 10/09/2023 (*)
 40342                                  	; MSDOS 6.21 IO.SYS - SYSINIT:46D3h
 40343                                  	; PCDOS 7.1 IBMBIO.COM - SYSINIT:491Ah
 40344                                  	;sub	si,si           ; always return ES:SI pointing to config.sys
 40345 00003C8F C3                      	retn
 40346                                  
 40347                                  ; (*) NOTE: MSDOS 6.0 source code (SYSINIT2.ASM) contains 'sub si,si' at this
 40348                                  ;	position (then 'retn' just after it)
 40349                                  ;	but MSDOS 6.21 and PCDOS 7.1 SYSINITs contain only 'retn' here.
 40350                                  
 40351                                  ;----------------------------------------------------------------------------
 40352                                  ;
 40353                                  ;   copy_envvar: copy the envvar at ES:SI to "config_wrkseg"
 40354                                  ;
 40355                                  ;   INPUT
 40356                                  ;    ES:SI -> environment variable (in the form "var=string<cr/lf>")
 40357                                  ;
 40358                                  ;   OUTPUT
 40359                                  ;       config_envlen (ie, where to put next envvar) updated appropriately
 40360                                  ;       carry set if error (eg, missing =); clear otherwise
 40361                                  ;
 40362                                  ;   OTHER REGS USED
 40363                                  ;       None
 40364                                  ;
 40365                                  ;   NOTES
 40366                                  ;       None
 40367                                  ;
 40368                                  ;   HISTORY
 40369                                  ;       Created 29-Mar-1992 by JeffPar
 40370                                  ;
 40371                                  ;----------------------------------------------------------------------------
 40372                                  
 40373                                  	; 04/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 40374                                  	; (SYSINIT:46D4h)
 40375                                  
 40376                                  copy_envvar:
 40377 00003C90 51                              push    cx              ;
 40378 00003C91 56                              push    si              ;
 40379 00003C92 1E                              push    ds              ;
 40380 00003C93 06                              push    es              ;
 40381 00003C94 06                              push    es              ;
 40382 00003C95 8E06[B114]                      mov     es,[config_wrkseg] ; ES:DI to point to next available byte
 40383 00003C99 1F                              pop     ds                 ; DS:SI to point to envvar
 40384                                  
 40385                                  ;   Have to calculate the length of the variable name (and if we hit
 40386                                  ;   the end of the line before we hit '=', then it's curtains for this
 40387                                  ;   config.sys line)
 40388                                  ;
 40389                                  ;   The check for NULL is important because copy_envvar is also used to copy
 40390                                  ;   the initial CONFIG= setting, which will have been zapped by a NULL if no
 40391                                  ;   menu block existed (in order to prevent the creation of an environment)
 40392                                  
 40393 00003C9A 29C9                            sub     cx,cx           ;
 40394                                  copy_varlen:                    ;
 40395 00003C9C AC                              lodsb                   ;
 40396 00003C9D 08C0                            or      al,al           ; NULL?
 40397                                          ;stc	; 10/09/2023 (x)
 40398 00003C9F 746B                            jz	short copy_envexit ; yes, abort
 40399 00003CA1 3C0D                            cmp     al,cr           ;
 40400                                          ;stc	; 10/09/2023 (x)
 40401 00003CA3 7467                            je	short copy_envexit
 40402 00003CA5 3C0A                            cmp     al,lf           ;
 40403                                          ;stc	; 10/09/2023 (x)
 40404 00003CA7 7463                            je	short copy_envexit
 40405 00003CA9 41                              inc     cx              ;
 40406 00003CAA 3C3D                            cmp     al,'='          ;
 40407 00003CAC 75EE                            jne	short copy_varlen
 40408 00003CAE B000                            mov     al,0            ;
 40409 00003CB0 8A24                            mov     ah,[si]         ; save char after '='
 40410 00003CB2 29CE                            sub     si,cx           ; back up to given varname
 40411 00003CB4 49                              dec     cx              ; CX == # of bytes in varname
 40412 00003CB5 29FF                            sub     di,di           ; start looking for DS:SI at ES:0
 40413                                  copy_varsrch:
 40414 00003CB7 263805                          cmp     byte [es:di],al
 40415 00003CBA 7425                            je	short copy_envprep ; search failed, just copy var
 40416 00003CBC 89FB                            mov     bx,di           ; ES:BX -> start of this varname
 40417 00003CBE 51                              push    cx              ;
 40418 00003CBF 56                              push    si              ;
 40419 00003CC0 F3A6                            repe    cmpsb           ;
 40420 00003CC2 5E                              pop     si              ;
 40421 00003CC3 59                              pop     cx              ;
 40422 00003CC4 7531                            jne	short copy_varnext ; no match, skip to next varname
 40423 00003CC6 26803D3D                        cmp     byte [es:di],'='
 40424 00003CCA 752B                            jne     short copy_varnext ; no match, there's more characters
 40425                                  
 40426                                  ;   Previous occurrence of variable has been found; determine the
 40427                                  ;   entire length and then destroy it
 40428                                  
 40429 00003CCC B9FFFF                          mov     cx,-1           ;
 40430 00003CCF F2AE                            repne   scasb           ; guaranteed to get null (since we put it there)
 40431 00003CD1 56                              push    si              ;
 40432 00003CD2 89FE                            mov     si,di           ;
 40433 00003CD4 89DF                            mov     di,bx           ;
 40434 00003CD6 2E8B0E[AF14]                    mov     cx,[cs:config_envlen]
 40435 00003CDB 29F1                            sub     cx,si           ; destroy variable now
 40436                                  	;rep movs byte ptr es:[di],byte ptr es:[si]
 40437                                  	;;db 0F3h,26h,0A4h ; MSDOS 6.21 IO.SYS - SYSINIT:4724h
 40438                                  
 40439 00003CDD F3                      	rep	; 0F3h
 40440 00003CDE 26                      	es	; 26h
 40441 00003CDF A4                      	movsb	; 0A4h
 40442                                  
 40443 00003CE0 5E                      	pop     si
 40444                                  copy_envprep:
 40445 00003CE1 80FC0D                          cmp     ah,cr          ; if there is nothing after the '='
 40446 00003CE4 741D                            je	short copy_envdel ; then just exit with variable deleted
 40447 00003CE6 80FC0A                          cmp     ah,lf           ;
 40448 00003CE9 7418                            je	short copy_envdel
 40449                                          ;jmp	short copy_envloop
 40450                                  	; 04/01/2023
 40451                                  copy_envloop:                  ;
 40452 00003CEB AC                      	lodsb                   ;
 40453 00003CEC 3C0D                    	cmp	al,cr           ;
 40454 00003CEE 7410                    	je	short copy_envdone
 40455 00003CF0 3C0A                    	cmp	al,lf           ;
 40456 00003CF2 740C                    	je	short copy_envdone
 40457 00003CF4 AA                      	stosb                   ;
 40458 00003CF5 EBF4                    	jmp	short copy_envloop
 40459                                  
 40460                                  copy_varnext:                   ;
 40461 00003CF7 51                              push    cx              ;
 40462 00003CF8 B9FFFF                          mov     cx,-1           ;
 40463 00003CFB F2AE                            repne   scasb           ;
 40464 00003CFD 59                              pop     cx              ;
 40465 00003CFE EBB7                            jmp	short copy_varsrch
 40466                                  
 40467                                  	; 04/01/2023
 40468                                  ;copy_envloop:                  ;
 40469                                  ;	lodsb                   ;
 40470                                  ;	cmp	al,cr           ;
 40471                                  ;	je	short copy_envdone
 40472                                  ;	cmp	al,lf           ;
 40473                                  ;	je	short copy_envdone
 40474                                  ;	stosb                   ;
 40475                                  ;	jmp	short copy_envloop
 40476                                  
 40477                                  copy_envdone:                   ;
 40478 00003D00 28C0                            sub     al,al           ; do SUB to clear carry as well
 40479 00003D02 AA                              stosb                   ; always null-terminate these puppies
 40480                                  copy_envdel:                    ;
 40481 00003D03 268805                          mov     [es:di],al      ; and stick another null to terminate the env.
 40482 00003D06 2E893E[AF14]                    mov     [cs:config_envlen],di
 40483                                  	; 10/09/2023 (x) - Erdogan Tan
 40484 00003D0B F9                      	stc ; in order to clear carry flag via cmc (compact code trick!)
 40485                                  copy_envexit:                   ;
 40486 00003D0C F5                      	cmc ; (x) ; reverse carry flag status (je -> cf=1)
 40487 00003D0D 07                              pop     es              ;
 40488 00003D0E 1F                              pop     ds              ;
 40489 00003D0F 5E                              pop     si              ;
 40490 00003D10 59                              pop     cx              ;
 40491                                  
 40492                                  copy_done:	; 18/12/2022
 40493 00003D11 C3                              retn
 40494                                  
 40495                                  ;----------------------------------------------------------------------------
 40496                                  ;
 40497                                  ;   copy_block: copy the current block to the new config.sys workspace
 40498                                  ;
 40499                                  ;   INPUT
 40500                                  ;       CX == remaining bytes in "organized" config.sys memory image
 40501                                  ;    ES:SI -> remaining bytes in "organized" config.sys memory image
 40502                                  ;    DS:DI -> new config.sys workspace (equal in size to the original
 40503                                  ;             config.sys image) where the current block is to be copied
 40504                                  ;
 40505                                  ;   OUTPUT
 40506                                  ;       Same as above
 40507                                  ;       AL also equals the last character read from the organized image
 40508                                  ;
 40509                                  ;   OTHER REGS USED
 40510                                  ;       All
 40511                                  ;
 40512                                  ;   NOTES
 40513                                  ;       None
 40514                                  ;
 40515                                  ;   HISTORY
 40516                                  ;       Created 16-Mar-1992 by JeffPar
 40517                                  ;
 40518                                  ;----------------------------------------------------------------------------
 40519                                  
 40520                                  	; 04/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 40521                                  	; (SYSINIT:4759h)
 40522                                  
 40523                                  copy_block:
 40524 00003D12 E87103                          call    get_char        ; check for include
 40525 00003D15 72FA                            jc	short copy_done	;
 40526 00003D17 247F                    	and     al,~CONFIG_OPTION_QUERY ; 7Fh
 40527 00003D19 3C5B                    	cmp     al,CONFIG_BEGIN ; another BEGIN implies END as well
 40528 00003D1B 74F4                            je	short copy_done ;
 40529                                  
 40530 00003D1D 3C4A                            cmp     al,CONFIG_INCLUDE ; 'J'
 40531 00003D1F 88E0                            mov     al,ah           ; AL == the original line code
 40532 00003D21 753A                            jne	short copy_line	; not an "include" line
 40533                                  
 40534                                  ;   We have hit an "INCLUDE" line; first, REM out the line so that we
 40535                                  ;   never try to include the block again (no infinite include loops please),
 40536                                  ;   then search for the named block and call copy_block again.
 40537                                  
 40538 00003D23 26C644FF30                      mov     byte [es:si-1],CONFIG_REM ; '0'
 40539 00003D28 57                              push    di              ;
 40540                                  
 40541 00003D29 BF[3F47]                        mov     di,szMenu
 40542 00003D2C E8D400                          call    comp_names_safe ; don't allow INCLUDE MENU
 40543 00003D2F 7426                            je	short copy_skip	;
 40544                                  
 40545 00003D31 BF[4447]                        mov     di,szCommon
 40546 00003D34 E8CC00                          call    comp_names_safe ; don't allow INCLUDE COMMON
 40547 00003D37 741E                            je	short copy_skip	;
 40548                                  
 40549 00003D39 89F7                            mov     di,si           ; try to find the block
 40550 00003D3B E86400                          call    srch_block      ;
 40551 00003D3E 89FA                            mov     dx,di           ;
 40552                                  	; 10/09/2023
 40553                                  	;pop    di              ;
 40554 00003D40 7514                            jne	short copy_error ; no such block
 40555 00003D42 5F                      	pop	di  ; 10/09/2023
 40556 00003D43 51                              push    cx              ;
 40557 00003D44 89D9                            mov     cx,bx           ;
 40558 00003D46 56                              push    si              ;
 40559 00003D47 4A                              dec     dx              ;
 40560 00003D48 89D6                            mov     si,dx           ;
 40561 00003D4A E80E03                          call    skip_line       ; skip the rest of the "block name" line
 40562 00003D4D E8C2FF                          call    copy_block      ; and copy in the rest of that block
 40563 00003D50 5E                              pop     si              ;
 40564 00003D51 59                              pop     cx              ;
 40565 00003D52 28C0                            sub     al,al           ; force skip_opt_line to skip...
 40566 00003D54 EB2B                            jmp     short copy_nextline
 40567                                  
 40568                                  copy_error:
 40569                                  	; 10/09/2023
 40570 00003D56 F8                      	clc
 40571                                  copy_skip:
 40572 00003D57 5F                              pop     di
 40573                                  ;copy_error:
 40574                                  	; 10/09/2023 (cf=0)
 40575                                  	;clc                    ;
 40576 00003D58 E80004                          call    print_error     ; note that carry is clear, no pause
 40577 00003D5B EB24                            jmp     short copy_nextline
 40578                                  
 40579                                  ;   Copy the line at ES:SI to the current location at DS:DI
 40580                                  
 40581                                  copy_line:
 40582 00003D5D 8805                            mov     [di],al         ;
 40583 00003D5F 47                              inc     di              ;
 40584 00003D60 3C20                            cmp     al,' '          ; is this is a "real" line with a "real" code?
 40585 00003D62 721D                            jb	short copy_nextline ; no
 40586 00003D64 2E803E[B414]00                  cmp     byte [cs:config_multi],0
 40587 00003D6A 7409                            je	short copy_loop	; not a multi-config config.sys, don't embed #s
 40588 00003D6C E81700                          call    get_linenum	; BX == line # of line @ES:SI
 40589 00003D6F 891D                            mov     [di],bx         ; stash it immediately following the line code
 40590 00003D71 47                              inc     di              ;
 40591 00003D72 47                              inc     di              ;
 40592 00003D73 EB08                            jmp     short copy_next ;
 40593                                  copy_loop:                      ;
 40594 00003D75 E80E03                          call    get_char        ;
 40595 00003D78 7297                            jc	short copy_done ; end of file
 40596 00003D7A 8805                            mov     [di],al         ;
 40597 00003D7C 47                              inc     di              ;
 40598                                  copy_next:
 40599 00003D7D 3C0A                            cmp     al,lf ; 0Ah	; done with line?
 40600 00003D7F 75F4                            jne	short copy_loop	; nope
 40601                                  
 40602                                  copy_nextline:
 40603 00003D81 E8DC02                          call    skip_opt_line   ;
 40604 00003D84 EB8C                            jmp     short copy_block
 40605                                  
 40606                                  	; 18/12/2022
 40607                                  ;copy_done:
 40608                                          ;retn
 40609                                  
 40610                                  ;----------------------------------------------------------------------------
 40611                                  ;
 40612                                  ;   get_linenum: return line # (in BX) of current line (@ES:SI)
 40613                                  ;
 40614                                  ;   INPUT
 40615                                  ;    ES:SI -> some line in the config.sys memory image
 40616                                  ;
 40617                                  ;   OUTPUT
 40618                                  ;       BX == line # (relative to 1)
 40619                                  ;
 40620                                  ;   OTHER REGS USED
 40621                                  ;       DX
 40622                                  ;
 40623                                  ;   NOTES
 40624                                  ;       None
 40625                                  ;
 40626                                  ;   HISTORY
 40627                                  ;       Created 16-Mar-1992 by JeffPar
 40628                                  ;
 40629                                  ;----------------------------------------------------------------------------
 40630                                  
 40631                                  get_linenum:
 40632 00003D86 50                              push    ax              ;
 40633 00003D87 29DB                            sub     bx,bx           ; BX == line # (to be returned)
 40634 00003D89 51                              push    cx              ;
 40635 00003D8A 89F2                            mov     dx,si           ; DX == the offset we're looking for
 40636 00003D8C 56                              push    si              ;
 40637 00003D8D 2E8B0E[5603]                    mov     cx,[cs:count]   ;
 40638 00003D92 29F6                            sub     si,si           ; prepare to scan entire file
 40639                                  get_linenum_loop:               ;
 40640 00003D94 E8C402                          call    skip_line       ;
 40641 00003D97 7205                            jc	short get_linenum_done
 40642 00003D99 43                              inc     bx              ;
 40643 00003D9A 39D6                            cmp     si,dx           ; have we exceeded the desired offset yet?
 40644 00003D9C 72F6                            jb	short get_linenum_loop ; no
 40645                                  get_linenum_done:               ;
 40646 00003D9E 5E                              pop     si              ;
 40647 00003D9F 59                              pop     cx              ;
 40648 00003DA0 58                              pop     ax              ;
 40649 00003DA1 C3                              retn
 40650                                  
 40651                                  ;----------------------------------------------------------------------------
 40652                                  ;
 40653                                  ;   srch_block: searches entire config.sys for block name @ES:DI
 40654                                  ;
 40655                                  ;   INPUT
 40656                                  ;       ES -> config.sys image
 40657                                  ;    ES:DI -> block name to find
 40658                                  ;
 40659                                  ;   OUTPUT
 40660                                  ;       ZF flag set, if found
 40661                                  ;    ES:DI -> just past the name in the block heading, if found
 40662                                  ;       BX == # bytes remaining from that point, if found
 40663                                  ;
 40664                                  ;   OTHER REGS USED
 40665                                  ;       None
 40666                                  ;
 40667                                  ;   NOTES
 40668                                  ;       This differs from "find_block" in that it searches the ENTIRE
 40669                                  ;       config.sys image, not merely the remaining portion, and that it
 40670                                  ;       takes a pointer to block name that is *elsewhere* in the image
 40671                                  ;       (ie, ES) as opposed to some string constant in our own segment (DS).
 40672                                  ;
 40673                                  ;   HISTORY
 40674                                  ;       Created 16-Mar-1992 by JeffPar
 40675                                  ;
 40676                                  ;----------------------------------------------------------------------------
 40677                                  
 40678                                  srch_block:	          ; returns BX -> named block in CONFIG.SYS
 40679 00003DA2 50                              push    ax              ;
 40680 00003DA3 51                              push    cx              ;
 40681 00003DA4 2E8B0E[5603]                    mov     cx,[cs:count]   ;
 40682 00003DA9 56                              push    si              ;
 40683 00003DAA 29F6                            sub     si,si           ;
 40684 00003DAC 1E                              push    ds              ;
 40685 00003DAD 06                              push    es              ;
 40686 00003DAE 1F                              pop     ds              ;
 40687 00003DAF E80900                          call    find_block      ;
 40688 00003DB2 89F7                            mov     di,si           ;
 40689 00003DB4 89CB                            mov     bx,cx           ;
 40690 00003DB6 1F                              pop     ds              ;
 40691 00003DB7 5E                              pop     si              ;
 40692 00003DB8 59                              pop     cx              ;
 40693 00003DB9 58                              pop     ax              ;
 40694                                  find_exit: ; 16/04/2019
 40695 00003DBA C3                              retn			;
 40696                                  
 40697                                  ;----------------------------------------------------------------------------
 40698                                  ;
 40699                                  ;   find_block: searches rest of config.sys for block name @DS:DI
 40700                                  ;
 40701                                  ;   INPUT
 40702                                  ;    DS:DI -> block name to find
 40703                                  ;    ES:SI -> remainder of config.sys image
 40704                                  ;       CX == remaining size of config.sys image
 40705                                  ;
 40706                                  ;   OUTPUT
 40707                                  ;       ZF flag set, if found (also, CF set if EOF)
 40708                                  ;    ES:SI -> where the search stopped (at end of block name or EOF)
 40709                                  ;       CX == # bytes remaining from that point
 40710                                  ;
 40711                                  ;   OTHER REGS USED
 40712                                  ;       AX
 40713                                  ;
 40714                                  ;   NOTES
 40715                                  ;       This differs from "srch_block" in that it searches only the
 40716                                  ;       remaining portion of the config.sys image and leaves SI and CX
 40717                                  ;       pointing to where the search left off, and that it takes a pointer
 40718                                  ;       to search string in our own segment (DS:DI instead of ES:DI).
 40719                                  ;
 40720                                  ;   HISTORY
 40721                                  ;       Created 16-Mar-1992 by JeffPar
 40722                                  ;
 40723                                  ;----------------------------------------------------------------------------
 40724                                  
 40725                                  find_block:
 40726 00003DBB E8C802                          call    get_char        ; get line code
 40727 00003DBE 72FA                            jc	short find_exit	; end of file
 40728 00003DC0 247F                            and     al,~CONFIG_OPTION_QUERY
 40729 00003DC2 3C5B                            cmp     al,CONFIG_BEGIN ; beginning of a block?
 40730 00003DC4 740C                            je	short check_line ; no
 40731 00003DC6 3C4A                            cmp     al,CONFIG_INCLUDE
 40732 00003DC8 7513                            jne	short next_line	;
 40733 00003DCA 2E800E[B414]01                  or	byte [cs:config_multi],1
 40734 00003DD0 EB0B                            jmp     short next_line ;
 40735                                  check_line:
 40736 00003DD2 2E800E[B414]01                  or      byte [cs:config_multi],1
 40737 00003DD8 E80700                          call    comp_names      ; compare block names
 40738 00003DDB 76DD                            jbe	short find_exit	; end of file, or names matched
 40739                                  next_line:
 40740 00003DDD E88002                          call    skip_opt_line   ; no, so skip to next line
 40741 00003DE0 EBD9                            jmp	short find_block  ;
 40742                                  ;find_exit:
 40743                                  ;	retn
 40744                                  
 40745                                  ;----------------------------------------------------------------------------
 40746                                  ;
 40747                                  ;   comp_names: compares keyword @DS:DI to position in config.sys @ES:SI
 40748                                  ;
 40749                                  ;   INPUT
 40750                                  ;    DS:DI -> keyword to compare
 40751                                  ;    ES:SI -> position in config.sys
 40752                                  ;       CX == remaining bytes in config.sys
 40753                                  ;
 40754                                  ;   OUTPUT
 40755                                  ;       ZF flag set, if match (also, CF set if EOF)
 40756                                  ;    ES:SI -> where the comparison stopped (at end of block name or EOF)
 40757                                  ;       CX == # bytes remaining from that point
 40758                                  ;
 40759                                  ;   OTHER REGS USED
 40760                                  ;       AX
 40761                                  ;
 40762                                  ;   NOTES
 40763                                  ;       None
 40764                                  ;
 40765                                  ;   HISTORY
 40766                                  ;       Created 16-Mar-1992 by JeffPar
 40767                                  ;
 40768                                  ;----------------------------------------------------------------------------
 40769                                  
 40770                                  comp_names:
 40771 00003DE2 57                              push    di              ;
 40772                                  comp_loop:                      ;
 40773 00003DE3 E8A002                          call    get_char        ;
 40774 00003DE6 7210                            jc	short comp_exit	;
 40775 00003DE8 E80704                          call    any_delim       ; is next character a delimiter?
 40776 00003DEB 8A25                            mov     ah,[di]         ; (get next character we're supposed to match)
 40777 00003DED 740B                            je	short comp_almost ; yes, it *could* be a match
 40778 00003DEF 47                              inc     di              ;
 40779 00003DF0 25DFDF                          and     ax,~2020h ; 0DFDFh 
 40780                                  				; BUGBUG -- assumes both names are alphanumeric -JTP
 40781 00003DF3 38E0                            cmp     al,ah           ; match?
 40782 00003DF5 74EC                            je	short comp_loop ; yes, keep looking at the characters
 40783 00003DF7 F8                              clc                     ; prevent erroneous eof indication: clear carry
 40784                                  comp_exit:                      ;
 40785 00003DF8 5F                              pop     di              ;
 40786 00003DF9 C3                              retn			;
 40787                                  comp_almost:                    ;
 40788 00003DFA 86C4                            xchg    al,ah           ; we don't know for sure if it's a match
 40789 00003DFC E8F303                          call    any_delim       ; until we verify that the second string has
 40790 00003DFF 86C4                            xchg    al,ah           ; been exhausted also...
 40791 00003E01 EBF5                            jmp     short comp_exit ; if we are, this call to any_delim will tell...
 40792                                  
 40793                                  ;----------------------------------------------------------------------------
 40794                                  
 40795                                  	; 10/09/2023 - Retrodos v4.2 IO.SYS (Optimization)
 40796                                  comp_names_x:
 40797                                  	;
 40798                                  comp_names_safe:
 40799 00003E03 50                              push    ax
 40800 00003E04 51                              push    cx
 40801 00003E05 56                              push	si
 40802 00003E06 1E                              push    ds
 40803 00003E07 0E                              push    cs
 40804 00003E08 1F                              pop     ds
 40805 00003E09 E8D6FF                          call    comp_names
 40806 00003E0C 1F                              pop     ds
 40807 00003E0D 5E                      	pop	si
 40808 00003E0E 59                              pop     cx
 40809 00003E0F 58                              pop     ax
 40810 00003E10 C3                              retn
 40811                                  
 40812                                  ;----------------------------------------------------------------------------
 40813                                  ;
 40814                                  ;   print_item: display menu item #BL
 40815                                  ;
 40816                                  ;   INPUT
 40817                                  ;       BL == menu item # to display
 40818                                  ;
 40819                                  ;   OUTPUT
 40820                                  ;       Menu item displayed, with appropriate highlighting if BL == bDefBlock
 40821                                  ;
 40822                                  ;   OTHER REGS USED
 40823                                  ;       None
 40824                                  ;
 40825                                  ;   NOTES
 40826                                  ;       This function saves/restores the current cursor position, so you
 40827                                  ;       needn't worry about it.
 40828                                  ;
 40829                                  ;   HISTORY
 40830                                  ;       Created 16-Mar-1992 by JeffPar
 40831                                  ;
 40832                                  ;----------------------------------------------------------------------------
 40833                                  
 40834                                  	; 04/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 40835                                  	; (SYSINIT:485Ah)
 40836                                  
 40837                                  print_item:		; prints menu item #BL (1 to N)
 40838 00003E11 50                              push    ax              ;
 40839 00003E12 53                              push    bx              ;
 40840 00003E13 51                              push    cx              ;
 40841 00003E14 52                              push    dx              ;
 40842 00003E15 56                              push    si              ;
 40843 00003E16 B403                            mov     ah,03h          ; get cursor position
 40844 00003E18 8A3E[F646]                      mov     bh,[bMenuPage]  ; always page zero
 40845 00003E1C CD10                            int     10h             ; DH/DL = row/column
 40846 00003E1E 52                              push    dx              ; save it
 40847 00003E1F B402                            mov     ah,02h          ; set cursor position
 40848 00003E21 88DE                            mov     dh,bl           ;
 40849 00003E23 80C603                          add     dh,3            ;
 40850 00003E26 B205                            mov     dl,5            ;
 40851 00003E28 CD10                            int     10h             ; set cursor position for correct row/col
 40852 00003E2A 88D8                            mov     al,bl           ;
 40853 00003E2C 0430                            add     al,'0'          ; convert menu item # to ASCII digit
 40854 00003E2E 8A26[F546]                      mov     ah,[bMenuColor] ; normal attribute
 40855 00003E32 3A1E[FF46]                      cmp     bl,[bDefBlock]  ; are we printing the current block?
 40856 00003E36 7510                            jne	short print_other ; no
 40857 00003E38 80CC70                          or      ah,70h          ; yes, set bgnd color to white
 40858 00003E3B 88E5                            mov     ch,ah           ;
 40859 00003E3D B104                            mov     cl,4            ;
 40860 00003E3F D2C5                            rol     ch,cl           ;
 40861 00003E41 38E5                            cmp     ch,ah           ; are fgnd/bgnd the same?
 40862 00003E43 7503                            jne	short print_other ; no
 40863 00003E45 80F408                          xor     ah,08h          ; yes, so modify the fgnd intensity
 40864                                  print_other:                    ;
 40865 00003E48 B700                            mov     bh,0            ;
 40866 00003E4A 01DB                            add     bx,bx           ;
 40867 00003E4C 8BBF[2347]                      mov     di,[aoffBlockDesc+bx]
 40868 00003E50 88E3                            mov     bl,ah           ; put the attribute in the correct register now
 40869 00003E52 8A3E[F646]                      mov     bh,[bMenuPage]  ; get correct video page #
 40870 00003E56 B409                            mov     ah,09h          ; write char/attr
 40871 00003E58 B90100                          mov     cx,1            ;
 40872 00003E5B CD10                            int     10h             ;
 40873 00003E5D FEC2                            inc     dl              ; increment column
 40874 00003E5F B402                            mov     ah,02h          ;
 40875 00003E61 CD10                            int     10h             ;
 40876                                          ;mov	ax,0900h+'.'    ;
 40877 00003E63 B82E09                          mov	ax,092Eh
 40878 00003E66 CD10                    	int     10h             ; display '.'
 40879 00003E68 FEC2                            inc     dl              ; increment column
 40880 00003E6A B402                            mov     ah,02h          ;
 40881 00003E6C CD10                            int     10h             ;
 40882                                          ;mov	ax,0900h+' '    ;
 40883 00003E6E B82009                          mov	ax,0920h
 40884 00003E71 CD10                    	int     10h             ; display ' '
 40885 00003E73 FEC2                            inc     dl              ; increment column
 40886 00003E75 B402                            mov     ah,02h          ;
 40887 00003E77 CD10                            int     10h             ;
 40888 00003E79 06                              push    es              ;
 40889                                  print_loop:                     ;
 40890 00003E7A 268A05                          mov     al,[es:di]	; get a character of the description
 40891 00003E7D 47                              inc     di              ;
 40892 00003E7E 3C09                            cmp     al,TAB ; 9	; substitute spaces for tabs
 40893 00003E80 7502                            jne	short print_nontab ;
 40894 00003E82 B020                            mov     al,' '          ;
 40895                                  print_nontab:                   ;
 40896 00003E84 3C20                            cmp     al,' '          ;
 40897 00003E86 7215                            jb	short print_done ; stop at the 1st character < space
 40898 00003E88 3C24                            cmp     al,'$'          ;
 40899 00003E8A 7411                            je	short print_done ; also stop on $
 40900 00003E8C B409                            mov     ah,09h          ; display function #
 40901 00003E8E CD10                            int     10h             ;
 40902 00003E90 FEC2                            inc     dl              ; increment column
 40903 00003E92 80FA4E                          cmp     dl,78           ; far enough?
 40904 00003E95 7306                            jae	short print_done ; yes
 40905 00003E97 B402                            mov     ah,02h          ;
 40906 00003E99 CD10                            int     10h             ;
 40907 00003E9B EBDD                            jmp	short  print_loop
 40908                                  print_done:                     ;
 40909 00003E9D 07                              pop     es              ;
 40910 00003E9E 5A                              pop     dx              ;
 40911 00003E9F B402                            mov     ah,02h          ;
 40912 00003EA1 CD10                            int     10h             ; restore previous row/col
 40913 00003EA3 5E                              pop     si              ;
 40914 00003EA4 5A                              pop     dx              ;
 40915 00003EA5 59                              pop     cx              ;
 40916 00003EA6 5B                              pop     bx              ;
 40917 00003EA7 58                              pop     ax              ;
 40918 00003EA8 C3                              retn			;
 40919                                  
 40920                                  ;----------------------------------------------------------------------------
 40921                                  ;
 40922                                  ;   select_item: wait for user to select menu item, with time-out
 40923                                  ;
 40924                                  ;   INPUT
 40925                                  ;       None
 40926                                  ;
 40927                                  ;   OUTPUT
 40928                                  ;       BX == menu item # (1-N), or -1 for clean boot
 40929                                  ;       Selected menu item highlighted
 40930                                  ;       Cursor positioned beneath menu, ready for tty-style output now
 40931                                  ;
 40932                                  ;   OTHER REGS USED
 40933                                  ;       None
 40934                                  ;
 40935                                  ;   NOTES
 40936                                  ;       None
 40937                                  ;
 40938                                  ;   HISTORY
 40939                                  ;       Created 16-Mar-1992 by JeffPar
 40940                                  ;
 40941                                  ;----------------------------------------------------------------------------
 40942                                  
 40943                                  select_item:		; returns digit value in BX (trashes AX/CX/DX)
 40944 00003EA9 8A1E[FF46]                      mov     bl,[bDefBlock]  ; BL will be the default block #
 40945 00003EAD 88D8                            mov     al,bl           ;
 40946 00003EAF E83701                          call    disp_num        ;
 40947 00003EB2 E84401                          call    show_status     ; display current interactive status
 40948 00003EB5 803E[0347]FF                    cmp     byte [secTimeOut],-1
 40949 00003EBA 7452                            je	short input_key	; no time-out, just go to input
 40950 00003EBC B42C                            mov     ah,GET_TIME ; 2Ch
 40951 00003EBE CD21                            int     21h             ;
 40952 00003EC0 88F7                            mov     bh,dh           ; BH = initial # of seconds
 40953                                  check_time:
 40954 00003EC2 A0[0347]                        mov     al,[secTimeOut] ;
 40955 00003EC5 2A06[0447]                      sub     al,[secElapsed] ;
 40956 00003EC9 730D                            jae	short show_time	;
 40957 00003ECB 800E[FE46]02                    or      byte [bQueryOpt],2 ; disable all further prompting
 40958 00003ED0 C606[0447]00                    mov     byte [secElapsed],0
 40959 00003ED5 E9F600                          jmp	select_done	; time's up!
 40960                                  show_time:
 40961 00003ED8 53                              push    bx              ;
 40962 00003ED9 88C3                            mov     bl,al           ; save # in BL
 40963 00003EDB 8A3E[F646]                      mov     bh,[bMenuPage]  ;
 40964 00003EDF B403                            mov     ah,03h          ; get cursor position
 40965 00003EE1 CD10                            int     10h             ;
 40966 00003EE3 52                              push    dx              ;
 40967 00003EE4 80C208                  	add	dl,8		; move cursor to the right
 40968 00003EE7 B402                            mov     ah,02h          ; set cursor position
 40969 00003EE9 CD10                            int     10h             ;
 40970 00003EEB BA[B54C]                        mov     dx,_$TimeOut
 40971 00003EEE E8DB05                          call    print           ; print the "Time remaining: " prompt
 40972 00003EF1 88D8                            mov     al,bl           ; recover # from BL
 40973 00003EF3 98                              cbw                     ; this works because AL is always <= 90
 40974 00003EF4 B10A                            mov     cl,10           ;
 40975 00003EF6 F6F1                            div     cl              ; AL = tens digit, AH = ones digit
 40976 00003EF8 88E1                            mov     cl,ah           ;
 40977 00003EFA 0430                            add     al,'0'          ;
 40978 00003EFC B40E                            mov     ah,0Eh          ;
 40979 00003EFE CD10                            int     10h             ; write TTY tens digit
 40980 00003F00 88C8                            mov     al,cl           ;
 40981 00003F02 0430                            add     al,'0'          ;
 40982 00003F04 B40E                            mov     ah,0Eh          ;
 40983 00003F06 CD10                            int     10h             ; write TTY ones digit
 40984 00003F08 5A                              pop     dx
 40985 00003F09 B402                            mov     ah,02h          ; set cursor position back to where it was
 40986 00003F0B CD10                            int     10h             ;
 40987 00003F0D 5B                              pop     bx              ;
 40988                                  input_key:
 40989 00003F0E B406                            mov     ah,RAW_CON_IO ; 6
 40990 00003F10 B2FF                            mov     dl,0FFh         ; input request
 40991 00003F12 CD21                            int     21h             ;
 40992 00003F14 751F                            jnz	short got_key	;
 40993 00003F16 803E[0347]FF                    cmp     byte [secTimeOut],-1; is there a time-out?
 40994 00003F1B 74F1                            je	short input_key	; no, just go back to input
 40995 00003F1D B42C                            mov     ah,GET_TIME     ;
 40996 00003F1F CD21                            int     21h             ; DH = seconds
 40997 00003F21 88F4                            mov     ah,dh           ;
 40998 00003F23 28FE                            sub     dh,bh           ; should generally be zero or one
 40999 00003F25 88E7                            mov     bh,ah           ;
 41000 00003F27 7302                            jnc	short got_time	;
 41001 00003F29 B601                            mov     dh,1            ; it wrapped back to zero, so assume one
 41002                                  got_time:
 41003 00003F2B 08F6                            or      dh,dh           ; any change?
 41004 00003F2D 74DF                            jz	short input_key	; no
 41005 00003F2F 0036[0447]                      add     [secElapsed],dh ;
 41006 00003F33 EB8D                            jmp	short check_time ;
 41007                                  got_key:
 41008 00003F35 50                              push    ax              ;
 41009 00003F36 B8FFFF                          mov     ax,-1           ; zap both secTimeOut and secElapsed
 41010 00003F39 8706[0347]                      xchg    [secTimeOut],ax
 41011 00003F3D 3CFF                            cmp     al,-1           ; was time-out already disabled?
 41012 00003F3F 740E                            je	short timeout_disabled ; yes
 41013 00003F41 53                              push    bx              ; let's disable # seconds display
 41014 00003F42 B8200A                          mov     ax,0A20h        ; write multiple spaces
 41015 00003F45 8B1E[F546]                      mov     bx,[bMenuColor]
 41016 00003F49 B95000                          mov     cx,80           ; 80 of them, to be safe
 41017 00003F4C CD10                            int     10h             ; to completely obliterate # seconds display
 41018 00003F4E 5B                              pop     bx   		;
 41019                                  
 41020                                  timeout_disabled:
 41021 00003F4F 58                              pop     ax              ;
 41022 00003F50 08C0                            or      al,al           ; extended key pressed?
 41023 00003F52 755A                            jnz	short normal_key ; no
 41024 00003F54 CD21                            int     21h             ; get the next part of the key then
 41025 00003F56 74B6                            jz	short input_key	; hmmm, what happened to the second part?
 41026                                  
 41027 00003F58 3C48                            cmp     al,48h          ; up arrow?
 41028 00003F5A 7510                            jne	short not_up	; no
 41029 00003F5C 80FB01                          cmp     bl,1            ; are we as up as up can get?
 41030 00003F5F 76AD                            jbe	short input_key	; yes, ignore it
 41031 00003F61 FE0E[FF46]                      dec     byte [bDefBlock] ;
 41032 00003F65 E8A9FE                          call    print_item      ; re-print the current item
 41033 00003F68 FECB                            dec     bl              ; and then print the new current item
 41034 00003F6A EB12                            jmp     short print1
 41035                                  not_up:
 41036 00003F6C 3C50                            cmp     al,50h          ; down arrow?
 41037 00003F6E 7518                            jne	short not_down	; no
 41038 00003F70 3A1E[0047]                      cmp     bl,[bMaxBlock]  ; are we as down as down can get?
 41039 00003F74 7310                            jae	short to_input_key ; yes, ignore it
 41040 00003F76 FE06[FF46]                      inc     byte [bDefBlock] ;
 41041 00003F7A E894FE                          call    print_item      ; re-print the current item
 41042 00003F7D 43                              inc     bx              ; and then print the new current item
 41043                                  print1: 
 41044 00003F7E 88D8                    	mov     al,bl           ;
 41045                                  print2: 
 41046 00003F80 E88EFE                  	call    print_item      ;
 41047 00003F83 E86300                          call    disp_num        ;
 41048                                  to_input_key:
 41049 00003F86 EB86                            jmp	short input_key ; 10/09/2023
 41050                                  not_down:
 41051 00003F88 F606[FA46]01                    test    byte [bDisableUI],1
 41052 00003F8D 75F7                            jnz	short to_input_key ; don't allow F8 or F5
 41053 00003F8F 3C42                            cmp     al,42h          ; F8 function key?
 41054 00003F91 750B                            jne	short not_f8	; no
 41055 00003F93 8036[FE46]01                    xor     byte [bQueryOpt],1
 41056 00003F98 E85E00                          call    show_status     ;
 41057 00003F9B E970FF                          jmp     input_key	;
 41058                                  not_f8:
 41059 00003F9E 3C3F                            cmp     al,3Fh          ; F5 function key?
 41060 00003FA0 75E4                            jne	short to_input_key ; no
 41061                                  	; 02/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 41062                                  	; MSDOS 6.21 IO.SYS - SYSINIT:49EBh
 41063                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:4C32h)
 41064 00003FA2 800E[FE46]04            	or	byte [bQueryOpt],4 ; no more queries
 41065 00003FA7 BBFFFF                          mov     bx,-1           ; special return code (-1) indicating clean boot
 41066 00003FAA B020                            mov     al,' '          ; don't want to display anything really;
 41067 00003FAC EB26                            jmp     short disp_input ; just want to display the cr/lf sequence...
 41068                                  
 41069                                  normal_key:
 41070 00003FAE 3C0D                            cmp     al,0Dh          ; Enter?
 41071 00003FB0 741C                            je	short select_done ; yes
 41072 00003FB2 3C08                            cmp     al,08h          ; backspace?
 41073 00003FB4 7504                            jne	short not_backspace ; no
 41074 00003FB6 BBFEFF                          mov     bx,-2 ; 0FFFEh	; yes, special return code
 41075 00003FB9 C3                              retn			;
 41076                                  not_backspace:
 41077 00003FBA 2C30                            sub     al,'0'          ; is greater than '0'?
 41078 00003FBC 76C8                            jbe	short to_input_key ; no
 41079 00003FBE 3A06[0047]                      cmp     al,[bMaxBlock]  ; is less than or equal to the maximum digit?
 41080 00003FC2 77C2                            ja	short to_input_key ; no
 41081 00003FC4 A2[FF46]                        mov	[bDefBlock],al  ;
 41082 00003FC7 E847FE                          call    print_item      ; redisplay the current selection
 41083 00003FCA 88C3                            mov     bl,al           ; set new selection
 41084 00003FCC EBB2                            jmp	short print2
 41085                                  
 41086                                  select_done:
 41087 00003FCE B700                            mov     bh,0            ; return a full 16-bit value (for indexing)
 41088 00003FD0 88D8                            mov     al,bl           ;
 41089 00003FD2 0430                            add     al,'0'          ; convert it into a digit, then display it
 41090                                  
 41091                                  	; fall into disp_input
 41092                                  
 41093                                  ; 16/04/2019 - Retro DOS v4.0
 41094                                  
 41095                                  ;----------------------------------------------------------------------------
 41096                                  ;
 41097                                  ;   disp_input: display a single character + cr/lf
 41098                                  ;
 41099                                  ;   INPUT
 41100                                  ;       AL == character to display
 41101                                  ;
 41102                                  ;   OUTPUT
 41103                                  ;       None
 41104                                  ;
 41105                                  ;   OTHER REGS USED
 41106                                  ;       None
 41107                                  ;
 41108                                  ;   NOTES
 41109                                  ;       This function is used not only for the menu input selection but
 41110                                  ;       also for the interactive line prompting (the y/n/a thing).
 41111                                  ;
 41112                                  ;   HISTORY
 41113                                  ;       Created 16-Mar-1992 by JeffPar
 41114                                  ;
 41115                                  ;----------------------------------------------------------------------------
 41116                                  
 41117                                  disp_input:
 41118 00003FD4 50                      	push	ax
 41119                                  	;cmp	al,' '
 41120                                  	;jae	short disp_ok
 41121                                  	;mov	al,' '
 41122                                  	; 10/09/2023 - Retro DOS v4.2 IO:SYS (Optimization)
 41123 00003FD5 B220                    	mov	dl,' ' ; 20h
 41124 00003FD7 38D0                    	cmp	al,dl
 41125 00003FD9 7602                    	jna	short disp_input_ok
 41126                                  disp_ok:
 41127 00003FDB 88C2                    	mov	dl,al
 41128                                  disp_input_ok:
 41129 00003FDD B402                    	mov	ah,STD_CON_OUTPUT ; 2
 41130 00003FDF CD21                    	int	21h
 41131 00003FE1 BA[184A]                	mov	dx,crlfm
 41132 00003FE4 E8E504                  	call	print
 41133 00003FE7 58                      	pop	ax
 41134 00003FE8 C3                      	retn
 41135                                  
 41136                                  ;----------------------------------------------------------------------------
 41137                                  
 41138                                  disp_num:
 41139 00003FE9 53                              push    bx
 41140 00003FEA 0430                            add     al,'0'
 41141 00003FEC B40A                            mov     ah,0Ah
 41142 00003FEE 8B1E[F546]                      mov     bx,[bMenuColor]
 41143 00003FF2 B90100                          mov     cx,1
 41144 00003FF5 CD10                            int     10h
 41145 00003FF7 5B                              pop     bx
 41146 00003FF8 C3                              retn
 41147                                  
 41148                                  ;----------------------------------------------------------------------------
 41149                                  ;
 41150                                  ;   show_status: display current interactive mode setting (on/off/none)
 41151                                  ;
 41152                                  ;   INPUT
 41153                                  ;       None
 41154                                  ;
 41155                                  ;   OUTPUT
 41156                                  ;       None
 41157                                  ;
 41158                                  ;   OTHER REGS USED
 41159                                  ;       None
 41160                                  ;
 41161                                  ;   NOTES
 41162                                  ;       None
 41163                                  ;
 41164                                  ;   HISTORY
 41165                                  ;       Created 16-Mar-1992 by JeffPar
 41166                                  ;
 41167                                  ;----------------------------------------------------------------------------
 41168                                  
 41169                                  show_status:
 41170 00003FF9 53                              push    bx              ; BL = video page #
 41171 00003FFA 8B1E[F546]                      mov     bx,[bMenuColor]
 41172 00003FFE B403                            mov     ah,03h          ; get cursor position
 41173 00004000 CD10                            int     10h             ;
 41174 00004002 52                              push    dx              ; save it
 41175 00004003 B402                            mov     ah,02h          ; set cursor position
 41176 00004005 8B16[F846]                      mov     dx,[bLastCol]   ; set correct row/col
 41177 00004009 F606[FA46]01                    test    byte [bDisableUI],1
 41178 0000400E 740C                            jz	short show_onoff ; just show on/off
 41179 00004010 B200                            mov     dl,0            ;
 41180 00004012 CD10                            int     10h             ;
 41181 00004014 B8200A                          mov     ax,0A20h        ; write multiple spaces
 41182 00004017 B95000                          mov     cx,80           ; 80 of them, to be exact
 41183                                  	; 10/09/2023
 41184                                  	;int	10h             ; to obliterate the status line
 41185 0000401A EB11                            jmp     short show_done ;
 41186                                  show_onoff: 
 41187 0000401C CD10                            int     10h
 41188                                  		; - VIDEO - WRITE CHARACTERS ONLY AT CURSOR POSITION
 41189                                  		; AL = character, BH = display page - alpha mode
 41190                                  		; BL = color of character (graphics mode, PCjr only)
 41191                                  		; CX = number of times to write character
 41192                                  
 41193 0000401E A0[B14C]                        mov     al,[_$NO]	; assume OFF
 41194 00004021 803E[FE46]01                    cmp     byte [bQueryOpt],1 ; is interactive mode on?
 41195 00004026 7503                            jne	short show_noton ; no
 41196 00004028 A0[AD4C]                        mov     al,[_$YES]	; yes
 41197                                  show_noton:                     ;
 41198 0000402B B40E                            mov     ah,0Eh          ; write TTY
 41199                                  show_done:	; 10/09/2023
 41200 0000402D CD10                            int     10h             ;
 41201                                  ;show_done:                     ;
 41202 0000402F 5A                              pop     dx              ;
 41203 00004030 B402                            mov     ah,02h          ;
 41204 00004032 CD10                            int     10h             ; restore original cursor position
 41205 00004034 5B                              pop     bx              ;
 41206 00004035 C3                              retn			;
 41207                                  
 41208                                  ; 16/04/2019 - Retro DOS v4.0
 41209                                  
 41210                                  ;----------------------------------------------------------------------------
 41211                                  ;
 41212                                  ;   skip_token: advances ES:SI/CX past the current token
 41213                                  ;
 41214                                  ;   INPUT
 41215                                  ;    ES:SI -> position in config.sys
 41216                                  ;       CX == remaining bytes in config.sys
 41217                                  ;
 41218                                  ;   OUTPUT
 41219                                  ;       CF set if EOL/EOF hit
 41220                                  ;       AL == 1st char of delimiter
 41221                                  ;    ES:SI -> just past the delimiter
 41222                                  ;       CX == # bytes remaining from that point
 41223                                  ;
 41224                                  ;   OTHER REGS USED
 41225                                  ;       AX
 41226                                  ;
 41227                                  ;   NOTES
 41228                                  ;       None
 41229                                  ;
 41230                                  ;   HISTORY
 41231                                  ;       Created 16-Mar-1992 by JeffPar
 41232                                  ;
 41233                                  ;----------------------------------------------------------------------------
 41234                                  
 41235                                  skip_token:
 41236 00004036 E84D00                          call    get_char
 41237 00004039 7210                            jc	short skip_token_done
 41238 0000403B E8B401                          call    any_delim
 41239 0000403E 75F6                            jne	short skip_token
 41240                                  skip_check_eol:
 41241 00004040 3C0D                            cmp     al,cr ; 0Dh
 41242 00004042 7406                            je	short skip_token_eol
 41243 00004044 3C0A                            cmp     al,lf ; 0Ah
 41244 00004046 7402                            je	short skip_token_eol
 41245 00004048 F8                              clc
 41246                                          ;jmp	short skip_token_done
 41247 00004049 C3                      	retn
 41248                                  skip_token_eol:
 41249 0000404A F9                              stc
 41250                                  skip_token_done:
 41251 0000404B C3                              retn
 41252                                  
 41253                                  ;----------------------------------------------------------------------------
 41254                                  ;
 41255                                  ;   skip_delim: advances ES:SI/CX past the current delimiter
 41256                                  ;
 41257                                  ;   INPUT
 41258                                  ;    ES:SI -> position in config.sys
 41259                                  ;       CX == remaining bytes in config.sys
 41260                                  ;
 41261                                  ;   OUTPUT
 41262                                  ;       CF set if EOF hit
 41263                                  ;       AL == 1st char of token
 41264                                  ;    ES:SI -> just past the token
 41265                                  ;       CX == # bytes remaining from that point
 41266                                  ;    ES:BX -> new token (since ES:SI is already pointing 1 byte past token)
 41267                                  ;
 41268                                  ;   OTHER REGS USED
 41269                                  ;       AX
 41270                                  ;
 41271                                  ;   NOTES
 41272                                  ;       None
 41273                                  ;
 41274                                  ;   HISTORY
 41275                                  ;       Created 16-Mar-1992 by JeffPar
 41276                                  ;
 41277                                  ;----------------------------------------------------------------------------
 41278                                  
 41279                                  skip_delim:	; returns carry set if eol/eof
 41280 0000404C E83700                          call    get_char        ;
 41281 0000404F 8D5CFF                          lea     bx,[si-1]       ; also returns BX -> next token
 41282 00004052 72F7                            jc	short skip_token_done ;
 41283 00004054 E8AB01                          call    delim           ;
 41284 00004057 74F3                            je	short skip_delim ;
 41285 00004059 EBE5                            jmp	short skip_check_eol  ; 13/05/2019
 41286                                  
 41287                                  ;----------------------------------------------------------------------------
 41288                                  ;
 41289                                  ;   skip_opt_line: same as skip_line provided AL != LF
 41290                                  ;
 41291                                  ;   INPUT
 41292                                  ;       AL == last character read
 41293                                  ;    ES:SI -> position in config.sys
 41294                                  ;       CX == remaining bytes in config.sys
 41295                                  ;
 41296                                  ;   OUTPUT
 41297                                  ;       CF set if EOF hit
 41298                                  ;       AL == 1st char of new line
 41299                                  ;    ES:SI -> just past 1st char of new line
 41300                                  ;       CX == # bytes remaining from that point
 41301                                  ;
 41302                                  ;   OTHER REGS USED
 41303                                  ;       AX
 41304                                  ;
 41305                                  ;   NOTES
 41306                                  ;       In other words, the purpose here is to skip to the next line,
 41307                                  ;       unless ES:SI is already sitting at the front of the next line (which
 41308                                  ;       it would be if the last character fetched -- AL -- was a linefeed)
 41309                                  ;
 41310                                  ;   HISTORY
 41311                                  ;       Created 16-Mar-1992 by JeffPar
 41312                                  ;
 41313                                  ;----------------------------------------------------------------------------
 41314                                  
 41315                                  ; 03/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 41316                                  ;skip_opt_line:
 41317                                  ;	cmp     al,lf ; 0Ah
 41318                                  ;	je	short skip_line_done
 41319                                       
 41320                                  	; fall into skip_line
 41321                                  
 41322                                  ;----------------------------------------------------------------------------
 41323                                  ;
 41324                                  ;   skip_line: skip to the next line
 41325                                  ;
 41326                                  ;   INPUT
 41327                                  ;    ES:SI -> position in config.sys
 41328                                  ;       CX == remaining bytes in config.sys
 41329                                  ;
 41330                                  ;   OUTPUT
 41331                                  ;       CF set if EOF hit
 41332                                  ;    ES:SI -> just past 1st char of new line
 41333                                  ;       CX == # bytes remaining from that point
 41334                                  ;
 41335                                  ;   OTHER REGS USED
 41336                                  ;       AX
 41337                                  ;
 41338                                  ;   NOTES
 41339                                  ;       None
 41340                                  ;
 41341                                  ;   HISTORY
 41342                                  ;       Created 16-Mar-1992 by JeffPar
 41343                                  ;
 41344                                  ;----------------------------------------------------------------------------
 41345                                  
 41346                                  skip_line:
 41347 0000405B E82800                          call    get_char
 41348 0000405E 7204                            jc	short skip_line_done
 41349                                  skip_opt_line:	; 03/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 41350 00004060 3C0A                            cmp     al,lf ; 0Ah
 41351 00004062 75F7                            jne	short skip_line
 41352                                  skip_line_done:
 41353                                  num_done:	; 18/12/2022
 41354 00004064 C3                              retn
 41355                                  
 41356                                  ;----------------------------------------------------------------------------
 41357                                  ;
 41358                                  ;   get_number: return binary equivalent of numeric string
 41359                                  ;
 41360                                  ;   INPUT
 41361                                  ;    ES:SI -> position in config.sys
 41362                                  ;       CX == remaining bytes in config.sys
 41363                                  ;
 41364                                  ;   OUTPUT
 41365                                  ;       AL == non-digit encountered
 41366                                  ;       BX == binary #
 41367                                  ;    ES:SI -> just past 1st non-digit
 41368                                  ;       CX == # bytes remaining from that point
 41369                                  ;
 41370                                  ;   OTHER REGS USED
 41371                                  ;       AX
 41372                                  ;
 41373                                  ;   NOTES
 41374                                  ;       None
 41375                                  ;
 41376                                  ;   HISTORY
 41377                                  ;       Created 16-Mar-1992 by JeffPar
 41378                                  ;
 41379                                  ;----------------------------------------------------------------------------
 41380                                  
 41381                                  ; 13/05/2019
 41382                                  
 41383                                  get_number:
 41384 00004065 29DB                            sub     bx,bx           ; BX = result
 41385                                  num_loop:
 41386 00004067 E81C00                          call    get_char        ;
 41387 0000406A 72F8                            jc	short num_done	;
 41388 0000406C 3C30                            cmp     al,'0'          ; convert to value
 41389 0000406E 72F4                            jb	short num_done	; no more number
 41390 00004070 3C39                            cmp     al,'9'          ;
 41391 00004072 77F0                            ja	short num_done	;
 41392 00004074 50                              push    ax              ;
 41393 00004075 B80A00                          mov     ax,10           ;
 41394 00004078 52                              push    dx              ;
 41395 00004079 F7E3                            mul     bx              ;
 41396 0000407B 5A                              pop     dx              ;
 41397 0000407C 89C3                            mov     bx,ax           ;
 41398 0000407E 58                              pop     ax              ;
 41399 0000407F 2C30                            sub     al,'0'          ;
 41400 00004081 98                              cbw                     ;
 41401 00004082 01C3                            add     bx,ax           ;
 41402 00004084 EBE1                            jmp	short num_loop	;
 41403                                  
 41404                                  	; 18/12/2022
 41405                                  ;num_done:
 41406                                          ;retn
 41407                                  
 41408                                  ;----------------------------------------------------------------------------
 41409                                  ;
 41410                                  ;   get_char: return next character, advance ES:SI, and decrement CX
 41411                                  ;
 41412                                  ;   INPUT
 41413                                  ;    ES:SI -> position in config.sys
 41414                                  ;       CX == remaining bytes in config.sys
 41415                                  ;
 41416                                  ;   OUTPUT
 41417                                  ;       AL == next character
 41418                                  ;    ES:SI -> just past next character
 41419                                  ;       CX == # bytes remaining from that point
 41420                                  ;
 41421                                  ;   OTHER REGS USED
 41422                                  ;       AX
 41423                                  ;
 41424                                  ;   NOTES
 41425                                  ;       None
 41426                                  ;
 41427                                  ;   HISTORY
 41428                                  ;       Created 16-Mar-1992 by JeffPar
 41429                                  ;
 41430                                  ;----------------------------------------------------------------------------
 41431                                  
 41432                                  get_char:
 41433 00004086 83E901                          sub     cx,1            ; use SUB to set carry,zero
 41434 00004089 7205                            jb	short get_fail	; out of data
 41435                                          ;lods	byte ptr es:[si] ;
 41436 0000408B 26                      	es	
 41437 0000408C AC                      	lodsb
 41438 0000408D 88C4                            mov     ah,al           ;
 41439 0000408F C3                              retn			;
 41440                                  get_fail:                       ; restore CX to zero
 41441 00004090 B90000                          mov     cx,0            ; leave carry set, zero not set
 41442                                  nearby_ret:
 41443 00004093 C3                              retn
 41444                                  
 41445                                  ;----------------------------------------------------------------------------
 41446                                  ;
 41447                                  ;   query_user: ask user whether to execute current config.sys command
 41448                                  ;
 41449                                  ;   INPUT
 41450                                  ;       AL == current command code
 41451                                  ;    ES:SI -> current command line in config.sys
 41452                                  ;    config_cmd == current command code, but with QUERY bit intact
 41453                                  ;                  (00h used to generate "Process AUTOEXEC.BAT" prompt)
 41454                                  ;
 41455                                  ;   OUTPUT
 41456                                  ;       CF set if command should be ignored (it is also REM'ed out)
 41457                                  ;
 41458                                  ;   OTHER REGS USED
 41459                                  ;       BX, CX, DX, DI
 41460                                  ;
 41461                                  ;   NOTES
 41462                                  ;       None
 41463                                  ;
 41464                                  ;   HISTORY
 41465                                  ;       Created 16-Mar-1992 by JeffPar
 41466                                  ;
 41467                                  ;----------------------------------------------------------------------------
 41468                                  
 41469                                  	; 31/12/2022 - Retro UNIX 386 v4.2 (Modified MSDOS 6.21 IO.SYS)
 41470                                  	; (SYSINIT:4AE5h)
 41471                                  
 41472                                  	; 12/12/2022
 41473                                  query_user:
 41474 00004094 F606[FE46]04                    test    byte [bQueryOpt],4	; answer no to everything?
 41475                                  	; 01/01/2023
 41476 00004099 7403                    	jz	short qu_1		;
 41477 0000409B E9B900                  	jmp	skip_all
 41478                                  	; 12/12/2022
 41479                                  	;;jmp	short skip_all		;
 41480                                  	;jnz	short skip_all
 41481                                  qu_1:
 41482 0000409E F606[FE46]02            	test    byte [bQueryOpt],2	; answer yes to everything?
 41483 000040A3 75EE                            jnz	short nearby_ret	; yes (and return carry clear!)
 41484 000040A5 50                              push    ax                      ;
 41485 000040A6 A0[B314]                        mov     al,[config_cmd]         ;
 41486 000040A9 F606[FE46]01                    test    byte [bQueryOpt],1	; query every command?
 41487 000040AE 7506                            jnz	short query_all		; yes
 41488 000040B0 A880                            test    al,CONFIG_OPTION_QUERY  ;
 41489                                  	; 01/01/2023
 41490 000040B2 7502                    	jnz	short query_all		;
 41491                                  	; 12/12/2022
 41492                                  	;;jmp	short do_cmd		;
 41493                                  	;jz	short do_cmd ; cf=0
 41494                                  
 41495                                  	; 01/01/2023
 41496 000040B4 58                      	pop	ax
 41497 000040B5 C3                      	retn
 41498                                  
 41499                                  query_all:
 41500                                  
 41501                                  ;   Search for the command code (AL) in "comtab", and then print
 41502                                  ;   out the corresponding keyword, followed by the rest of the actual
 41503                                  ;   line pointed to by ES:SI
 41504                                  
 41505 000040B6 56                              push    si                      ; save pointer to rest of CONFIG.SYS line
 41506 000040B7 BA[074D]                        mov     dx,_$AutoPrmpt    	;
 41507 000040BA 247F                            and     al,~CONFIG_OPTION_QUERY ; 7Fh
 41508 000040BC 7450                            jz	short generic_prompt	; config_cmd must have been 0
 41509                                  
 41510 000040BE 88C6                            mov     dh,al                   ; save config_cmd in DH
 41511 000040C0 29DB                            sub     bx,bx                   ;
 41512 000040C2 BF[4B47]                        mov     di,comtab		;
 41513                                  find_match:                             ;
 41514 000040C5 8A1D                            mov     bl,[di]                 ; get size of current keyword
 41515 000040C7 08DB                            or      bl,bl                   ;
 41516 000040C9 7425                            jz	short line_print	; end of table
 41517 000040CB 47                              inc     di                      ;
 41518 000040CC 3A01                            cmp     al,[di+bx]              ; match?
 41519 000040CE 7405                            je	short cmd_match		; yes
 41520 000040D0 8D7901                          lea     di,[di+bx+1]            ; otherwise, skip this command code
 41521                                  	; 13/05/2019	
 41522 000040D3 EBF0                            jmp	short find_match	; loop
 41523                                  cmd_match:                              ;
 41524 000040D5 8A4DFF                          mov     cl,[di-1]               ;
 41525 000040D8 B500                            mov	ch,0                    ;
 41526 000040DA B402                            mov     ah,STD_CON_OUTPUT ; 2
 41527                                  cmd_print:                              ;
 41528 000040DC 8A05                            mov     al,[di]                 ;
 41529 000040DE 47                              inc     di                      ;
 41530 000040DF 88C2                            mov     dl,al                   ;
 41531 000040E1 CD21                            int     21h                     ;
 41532 000040E3 E2F7                            loop    cmd_print               ;
 41533 000040E5 B23D                            mov     dl,'='                  ;
 41534 000040E7 80FE56                          cmp     dh,CONFIG_SET  ; 'V'    ; for SET commands, don't display a '='
 41535 000040EA 7502                            jne	short cmd_notset	;
 41536 000040EC B220                            mov     dl,' '                  ;
 41537                                  cmd_notset:
 41538 000040EE CD21                            int     21h                     ; '=' looks funny on SET commands
 41539                                  line_print:                             ;
 41540                                  	;lods	byte ptr es:[si]        ;
 41541 000040F0 26                              es
 41542 000040F1 AC                      	lodsb
 41543 000040F2 08C0                    	or      al,al                   ;
 41544 000040F4 7502                            jnz	short non_null		;
 41545 000040F6 B020                            mov     al,' '                  ;
 41546                                  non_null:                               ;
 41547 000040F8 3C20                            cmp     al,' '                  ; control code?
 41548 000040FA 720F                            jb	short prompt_user	; yes, assume end of line
 41549 000040FC 7505                            jne	short non_space		;
 41550                                          ; 10/09/2023
 41551 000040FE 263804                  	cmp	[es:si],al ; 20h
 41552                                  	;cmp	byte [es:si],' '	;
 41553 00004101 7208                            jb	short prompt_user	;
 41554                                  non_space:                              ;
 41555 00004103 88C2                            mov     dl,al                   ;
 41556 00004105 B402                            mov     ah,STD_CON_OUTPUT ; 2	;
 41557 00004107 CD21                            int     21h                     ;
 41558 00004109 EBE5                            jmp	short line_print	;
 41559                                  
 41560                                  prompt_user:                            ;
 41561 0000410B BA[A54C]                        mov     dx,_$InterPrmpt		;
 41562                                  
 41563                                  generic_prompt:
 41564 0000410E E8BB03                          call    print                   ;
 41565                                  input_loop:                             ;
 41566 00004111 B400                            mov     ah,0                    ; read a key
 41567 00004113 CD16                            int     16h                     ;
 41568 00004115 08C0                            or      al,al                   ; is it a function key?
 41569 00004117 750F                            jnz	short not_func		; no
 41570 00004119 80FC3F                          cmp     ah,3Fh                  ; F5 function key?
 41571 0000411C 75F3                            jne	short input_loop	; no
 41572 0000411E A0[B14C]                        mov     al,[_$NO] 		;
 41573 00004121 800E[FE46]04                    or      byte [bQueryOpt],4	; no more queries
 41574 00004126 EB21                            jmp     short legal_char        ;
 41575                                  not_func:
 41576 00004128 24DF                            and     al,~20h ; 0DFh		; converting to upper case
 41577 0000412A 3A06[B14C]                      cmp     al,[_$NO]		; verify character is legal
 41578 0000412E 7419                            je	short legal_char	;
 41579 00004130 3A06[AD4C]                      cmp     al,[_$YES]		;
 41580 00004134 7413                            je	short legal_char	;
 41581 00004136 803E[B314]00                    cmp     byte [config_cmd],0	;
 41582 0000413B 74D4                            je	short input_loop	; don't allow Esc on this query
 41583 0000413D 3C1B                            cmp     al,1Bh                  ; Esc?
 41584 0000413F 75D0                            jne	short input_loop	;
 41585 00004141 800E[FE46]02                    or      byte [bQueryOpt],2	; no more interactive boot prompts
 41586 00004146 A0[AD4C]                        mov     al,[_$YES]
 41587                                  legal_char:                             ;
 41588 00004149 E888FE                          call    disp_input              ;
 41589 0000414C 5E                              pop     si                      ; restore pointer to rest of CONFIG.SYS line
 41590                                  
 41591 0000414D 3A06[B14C]                      cmp     al,[_$NO]		; process line?
 41592 00004151 7403                            je	short skip_cmd		; no
 41593                                  	; 12/12/2022
 41594 00004153 F8                      	clc
 41595                                  do_cmd:
 41596 00004154 58                      	pop     ax			;
 41597                                  	; 12/12/2022
 41598                                  	; cf=0
 41599                                  	;clc				; just do the command
 41600 00004155 C3                      	retn
 41601                                  
 41602                                  skip_cmd:
 41603 00004156 58                      	pop     ax			;
 41604                                  skip_all:
 41605 00004157 B430                    	mov     ah,CONFIG_REM ; '0'	; fake out the rest of sysinit's processing
 41606 00004159 F9                      	stc
 41607 0000415A C3                      	retn
 41608                                  
 41609                                  ;----------------------------------------------------------------------------
 41610                                  ;
 41611                                  ;   print_error: displays multi-config error conditions
 41612                                  ;
 41613                                  ;   INPUT
 41614                                  ;    Carry set to pause, clear to not
 41615                                  ;    ES:SI -> current command line in config.sys
 41616                                  ;
 41617                                  ;   OUTPUT
 41618                                  ;       None
 41619                                  ;
 41620                                  ;   OTHER REGS USED
 41621                                  ;       None
 41622                                  ;
 41623                                  ;   NOTES
 41624                                  ;       None
 41625                                  ;
 41626                                  ;   HISTORY
 41627                                  ;       Created 16-Mar-1992 by JeffPar
 41628                                  ;
 41629                                  ;----------------------------------------------------------------------------
 41630                                  
 41631                                  print_error:
 41632 0000415B 50                              push    ax
 41633 0000415C 53                              push    bx
 41634 0000415D 51                              push    cx
 41635 0000415E 52                              push    dx
 41636 0000415F 1E                              push    ds
 41637 00004160 0E                              push    cs
 41638 00004161 1F                              pop     ds
 41639 00004162 9C                              pushf
 41640 00004163 E820FC                          call    get_linenum
 41641 00004166 891E[AF02]                      mov     [linecount],bx
 41642 0000416A E8C5E7                          call    error_line
 41643 0000416D 9D                              popf
 41644 0000416E 7319                            jnc	short pe_ret
 41645 00004170 BA[6F4B]                        mov     dx,_$PauseMsg
 41646 00004173 E85603                          call    print
 41647 00004176 B8070C                          mov     ax,0C07h		; flush input buffer, then wait for key
 41648 00004179 CD21                            int     21h			; wait for a key
 41649 0000417B 08C0                            or      al,al			; extended key?
 41650 0000417D 7504                            jnz	short pe_1		; no
 41651 0000417F B407                            mov     ah,07h			; yes
 41652 00004181 CD21                            int     21h			; eat it too
 41653                                  pe_1:     
 41654 00004183 BA[184A]                	mov     dx,crlfm
 41655 00004186 E84303                          call    print
 41656                                  pe_ret: 
 41657 00004189 1F                      	pop     ds
 41658 0000418A 5A                              pop     dx
 41659 0000418B 59                              pop     cx
 41660 0000418C 5B                              pop     bx
 41661 0000418D 58                              pop     ax
 41662 0000418E C3                      	retn
 41663                                  
 41664                                  ;----------------------------------------------------------------------------
 41665                                  
 41666                                  ;   This function is very simple: it merely prepends a "/D" to the
 41667                                  ;   command-line for the shell; this (undocumented) switch disables
 41668                                  ;   AUTOEXEC.BAT processing and the date/time prompt that is usually
 41669                                  ;   displayed when there's no AUTOEXEC.BAT.
 41670                                  
 41671                                  disable_autoexec:
 41672                                  	; MSDOS 6.21 IO.SYS -  SYSINIT:4BE2h
 41673                                  	; 17/04/2019 - Retro DOS v4.0
 41674                                  
 41675 0000418F F606[FE46]04            	test	byte [bQueryOpt],4
 41676 00004194 7443                    	jz	short disable_exit
 41677 00004196 F606[F446]01            	test	byte [dae_flag],1
 41678 0000419B 753C                    	jnz	short disable_exit
 41679 0000419D 800E[F446]01            	or	byte [dae_flag],1
 41680                                          ;or	byte [bQueryOpt],2 ; MSDOS 6.0 
 41681 000041A2 810E[FE46]0201          	or      word [bQueryOpt],102h	; [bDefBlock] = 1
 41682 000041A8 BA4420                  	mov     dx,'D ' ; 2044h
 41683                                  dae_1:
 41684                                  	; 03/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 41685 000041AB A0[3346]                        mov	al,[def_swchr]
 41686                                  	;mov	al,[command_line-1]     ; get default switchchar
 41687 000041AE 08C0                            or      al,al                   ; anything there?
 41688 000041B0 7427                            jz	short disable_exit	; no, disable_autoexec already called
 41689 000041B2 8A1E[3446]                      mov     bl,[command_line]       ;
 41690 000041B6 B700                            mov     bh,0                    ; BX == command-line length
 41691 000041B8 89D9                            mov     cx,bx                   ;
 41692 000041BA 80C303                          add     bl,3                    ;
 41693 000041BD 80FB7E                          cmp     bl,126                  ;
 41694 000041C0 7717                            ja	short disable_exit	;
 41695 000041C2 881E[3446]                      mov     [command_line],bl       ; update length
 41696 000041C6 81C3[3546]                      add     bx,command_line+1	; make sure we move the NULL too
 41697 000041CA 41                              inc     cx                      ; (just for consistency sake)
 41698                                  disable_loop:                           ;
 41699 000041CB 8A67FD                          mov     ah,[bx-3]               ;
 41700 000041CE 8827                            mov     [bx],ah                 ;
 41701 000041D0 4B                              dec     bx                      ;
 41702 000041D1 E2F8                            loop    disable_loop            ;
 41703 000041D3 8847FE                          mov     [bx-2],al               ;
 41704                                  	;mov	word [bx-1],'D ' ; 2044h ; /D is stuffed into place now
 41705 000041D6 8957FF                  	mov	[bx-1],dx  ; MSDOS 6.21 IO.SYS - SYSINIT:4C29h		
 41706                                          ;mov	byte [command_line-1],0 ;
 41707                                  disable_exit:                           ;
 41708 000041D9 C3                              retn
 41709                                  
 41710                                  CheckQueryOpt:	; MSDOS 6.21 IO.YSYS - SYSINIT:4C2Dh
 41711 000041DA 803E[FE46]01            	cmp     byte [bQueryOpt],1
 41712 000041DF 75F8                    	jnz     short disable_exit
 41713 000041E1 F606[F446]02            	test	byte [dae_flag],2
 41714 000041E6 75F1                    	jnz     short disable_exit
 41715 000041E8 800E[F446]02            	or      byte [dae_flag],2
 41716                                  	;mov	dx,' Y' ; (MASM syntax) ; 2059h
 41717                                  	; 10/09/2023 (BugFix)
 41718 000041ED BA5920                  	mov	dx,'Y ' ; (NASM syntax) ; 2059h
 41719 000041F0 EBB9                    	jmp     short dae_1
 41720                                  
 41721                                  ;endif  ;MULTI_CONFIG
 41722                                  
 41723                                  ;%endif	; 02/11/2022
 41724                                  
 41725                                  
 41726                                  ; 19/04/2019 - Retro DOS v4.0
 41727                                  
 41728                                  ;----------------------------------------------------------------------------
 41729                                  ;
 41730                                  ; procedure : delim
 41731                                  ;
 41732                                  ;----------------------------------------------------------------------------
 41733                                  
 41734                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 41735                                  ; (SYSINIT:4C45h)
 41736                                  
 41737                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 41738                                  ;%if 0
 41739                                  ;;ifdef	MULTI_CONFIG
 41740                                  ;
 41741                                  any_delim:
 41742 000041F2 3C0D                    	cmp	al,cr
 41743 000041F4 7427                    	je	short delim_ret
 41744 000041F6 3C0A                    	cmp	al,lf
 41745 000041F8 7423                    	je	short delim_ret
 41746 000041FA 3C5B                    	cmp	al,'['
 41747 000041FC 741F                    	je	short delim_ret
 41748 000041FE 3C5D                    	cmp	al,']'
 41749 00004200 741B                    	je	short delim_ret
 41750                                  ;
 41751                                  ;;endif ;MULTI_CONFIG
 41752                                  ;%endif ; 02/11/2022
 41753                                  
 41754                                  	; 02/11/2022 - Retrodos v4.0 (Modified MSDOS 5.0 IO.SYS)
 41755                                  	; (SYSINIT:3450h)	
 41756                                  delim:
 41757 00004202 3C2F                    	cmp	al,'/'		; ibm will assume "/" as an delimeter.
 41758 00004204 7417                    	je	short delim_ret
 41759                                  
 41760 00004206 3C00                    	cmp	al,0		; special case for sysinit!!!
 41761 00004208 7413                    	je	short delim_ret
 41762                                  
 41763                                  org_delim:			; used by organize routine except for getting
 41764 0000420A 3C20                    	cmp	al,' '          ; the filename.
 41765 0000420C 740F                    	je	short delim_ret
 41766 0000420E 3C09                            cmp     al,tab ; 9
 41767 00004210 740B                    	je	short delim_ret
 41768 00004212 3C3D                    	cmp	al,'='
 41769 00004214 7407                    	je	short delim_ret
 41770 00004216 3C2C                    	cmp	al,','
 41771 00004218 7403                    	je	short delim_ret
 41772 0000421A 3C3B                    	cmp	al,';'
 41773                                  
 41774                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 41775                                  
 41776                                  ; 04/01/2023 - Retro DOS v4.2
 41777                                  ;ifdef	MULTI_CONFIG
 41778                                  ;   Make sure there's no chance of a false EOF indication
 41779 0000421C F8                      	clc
 41780                                  ;endif
 41781                                  	; 02/11/2022
 41782                                  delim_ret:
 41783                                  	; 04/01/2023
 41784                                  	; cf = 0
 41785                                  nl_ret:	; 10/09/2023
 41786 0000421D C3                      	retn
 41787                                  
 41788                                  ;----------------------------------------------------------------------------
 41789                                  ;
 41790                                  ; procedure : newline
 41791                                  ;
 41792                                  ;  newline returns with first character of next line
 41793                                  ;
 41794                                  ;----------------------------------------------------------------------------
 41795                                  
 41796                                  newline:
 41797 0000421E E80600                  	call	getchr			;skip non-control characters
 41798 00004221 72FA                    	jc	short nl_ret
 41799 00004223 3C0A                    	cmp	al,lf			;look for line feed
 41800 00004225 75F7                    	jne	short newline
 41801                                  
 41802                                  	; 10/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 41803                                  	;call	getchr
 41804                                  ;nl_ret:
 41805                                  	;retn
 41806                                  	; 10/09/2023
 41807                                  	;jmp	short getchr
 41808                                  
 41809                                  ; 10/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 41810                                  %if 1
 41811                                  
 41812                                  ;----------------------------------------------------------------------------
 41813                                  ;
 41814                                  ; procedure : getchr
 41815                                  ;
 41816                                  ;----------------------------------------------------------------------------
 41817                                  
 41818                                  	; 24/10/2022
 41819                                  getchr:
 41820                                  	; 12/12/2022
 41821                                  	;push	cx
 41822                                  	;mov	cx,[count]
 41823                                  	;jcxz	nochar
 41824                                  	; 12/12/2022
 41825 00004227 833E[5603]01            	cmp	word [count],1 
 41826 0000422C 720F                    	jb	short nochar ; cf=1 ([count] = 0)
 41827                                  	
 41828 0000422E 8B36[5A03]              	mov	si,[chrptr]
 41829 00004232 268A04                  	mov	al,[es:si]
 41830 00004235 FF0E[5603]              	dec	word [count]
 41831 00004239 FF06[5A03]              	inc	word [chrptr]
 41832                                  	; 12/12/202
 41833                                  	; cf=0
 41834                                  	;clc
 41835                                  ;get_ret:
 41836                                  	;pop	cx
 41837                                  	;retn
 41838                                  nochar: 
 41839                                  	; 12/12/2022
 41840                                  	; cf=1
 41841                                  	;stc
 41842                                  	;jmp	short get_ret
 41843                                  	
 41844 0000423D C3                      	retn
 41845                                  %endif
 41846                                  
 41847                                  ;----------------------------------------------------------------------------
 41848                                  ; 
 41849                                  ; procedure : mapcase
 41850                                  ;
 41851                                  ;----------------------------------------------------------------------------
 41852                                  
 41853                                  	; 02/11/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS)
 41854                                  
 41855                                  	; 04/01/2023 - Retro DOS 4.2 (Modified MSDOS 6.21 IO.SYS)
 41856                                  	; (SYSINIT:4C7Eh)
 41857                                  mapcase:
 41858 0000423E 51                      	push	cx
 41859 0000423F 56                      	push	si
 41860 00004240 1E                      	push	ds
 41861                                  
 41862 00004241 06                      	push	es
 41863 00004242 1F                      	pop	ds
 41864                                  
 41865                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 41866                                  
 41867                                  ; 04/01/2023 - Retro DOS 4.2
 41868                                  
 41869                                  ;ifdef	MULTI_CONFIG
 41870 00004243 88C3                    	mov	bl,al			; same cmd code this line
 41871                                  ;else
 41872                                  ;	xor	si,si
 41873                                  ;endif
 41874                                  	; 02/11/2022
 41875                                  	; 04/01/2023 - Retro DOS 4.2
 41876                                  	;xor	si, si
 41877                                  
 41878                                  convloop:
 41879 00004245 AC                      	lodsb
 41880 00004246 3C61                    	cmp	al,'a'
 41881 00004248 7209                    	jb	short noconv
 41882 0000424A 3C7A                    	cmp	al,'z'
 41883 0000424C 7705                    	ja	short noconv
 41884 0000424E 2C20                    	sub	al,20h
 41885 00004250 8844FF                  	mov	[si-1],al
 41886                                  noconv:
 41887                                  
 41888                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 41889                                  
 41890                                  ; 04/01/2023 - Retro DOS 4.2
 41891                                  ;ifdef	MULTI_CONFIG
 41892                                  
 41893                                  ;   When MULTI_CONFIG enabled, "mapcase" is used to map everything to
 41894                                  ;   upper-case a line at a time, after we've been able to figure out whether
 41895                                  ;   the line is a SET command or not (since we don't want to upper-case
 41896                                  ;   anything after the "=" in a SET)
 41897                                  ;
 41898 00004253 80FB56                  	cmp	bl,CONFIG_SET  ; 'V'	; preserve case for part of the line?
 41899 00004256 7504                    	jne	short check_eol		; no, just check for end-of-line
 41900 00004258 3C3D                    	cmp	al,'='                  ; separator between SET var and value?
 41901 0000425A 740A                    	je	short convdone		; yes
 41902                                  check_eol:
 41903 0000425C 3C0D                    	cmp	al,cr
 41904 0000425E 7406                    	je	short convdone
 41905 00004260 3C0A                    	cmp	al,lf
 41906 00004262 7402                    	je	short convdone
 41907                                  ;endif
 41908                                  	; 02/11/2022
 41909 00004264 E2DF                    	loop	convloop
 41910                                  convdone:
 41911 00004266 1F                      	pop	ds
 41912 00004267 5E                      	pop	si
 41913 00004268 59                      	pop	cx
 41914 00004269 C3                      	retn
 41915                                  
 41916                                  ;----------------------------------------------------------------------------
 41917                                  ;
 41918                                  ; procedure : round
 41919                                  ;
 41920                                  ; round the values in memlo and memhi to paragraph boundary.
 41921                                  ; perform bounds check.
 41922                                  ;
 41923                                  ;----------------------------------------------------------------------------
 41924                                  
 41925                                  round:
 41926                                  	; 10/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 41927 0000426A 1E                      	push	ds
 41928 0000426B 0E                      	push	cs
 41929 0000426C 1F                      	pop	ds
 41930                                  
 41931 0000426D 50                      	push	ax
 41932                                  	;mov	ax,[cs:memlo]
 41933 0000426E A1[6203]                	mov	ax,[memlo]
 41934                                  
 41935 00004271 E8D2CE                  	call	ParaRound		; para round up
 41936                                  
 41937                                  	;add	[cs:memhi],ax
 41938 00004274 0106[6403]              	add	[memhi],ax
 41939                                  	;mov	word [cs:memlo],0
 41940 00004278 C706[6203]0000          	mov	word [memlo],0
 41941                                  	;mov	ax,[cs:memhi]		; ax = new memhi
 41942 0000427E A1[6403]                	mov	ax,[memhi]
 41943                                  	;cmp	ax,[cs:ALLOCLIM]	; if new memhi >= alloclim, error
 41944 00004281 3B06[A502]              	cmp	ax,[ALLOCLIM]
 41945                                  	;jae	short mem_err
 41946                                  	; 17/09/2023
 41947 00004285 7322                    	jae	short mem_err2 ; ds = cs	
 41948                                  	;test	byte [cs:setdevmarkflag],for_devmark ; 2
 41949 00004287 F606[B814]02            	test	byte [setdevmarkflag],for_devmark ; 2
 41950 0000428C 7416                    	jz	short skip_set_devmarksize
 41951 0000428E 06                      	push	es
 41952 0000428F 56                      	push	si
 41953                                  	;mov	si,[cs:devmark_addr]
 41954 00004290 8B36[B614]              	mov	si,[devmark_addr]
 41955 00004294 8EC6                    	mov	es,si
 41956 00004296 29F0                    	sub	ax,si
 41957 00004298 48                      	dec	ax
 41958                                  	;mov	[es:3],ax
 41959 00004299 26A30300                	mov	[es:devmark.size],ax	; paragraph
 41960                                  	;and	byte [cs:setdevmarkflag],not_for_devmark ; 0FDh
 41961 0000429D 8026[B814]FD            	and	byte [setdevmarkflag],not_for_devmark ; 0FDh
 41962 000042A2 5E                      	pop	si
 41963 000042A3 07                      	pop	es
 41964                                  skip_set_devmarksize:
 41965 000042A4 58                      	pop	ax
 41966                                  
 41967                                  	; 10/09/2023
 41968 000042A5 1F                      	pop	ds
 41969                                  
 41970                                  	; 11/12/2022
 41971                                  	; cf = 0
 41972                                  	; 02/11/2022
 41973                                  	;clc	; ? (not needed here)	; clear carry
 41974 000042A6 C3                      	retn
 41975                                  
 41976                                  ;----------------------------------------------------------------------------
 41977                                  
 41978                                  mem_err:
 41979                                  	; 11/12/2022
 41980 000042A7 0E                      	push	cs
 41981 000042A8 1F                      	pop	ds
 41982                                  mem_err2:
 41983 000042A9 BA[F14A]                	mov	dx,badmem
 41984                                  	;push	cs
 41985                                  	;pop	ds
 41986 000042AC E81D02                  	call	print
 41987 000042AF E9CDCE                  	jmp	stall
 41988                                  
 41989                                  ;----------------------------------------------------------------------------
 41990                                  ;
 41991                                  ; procedure : calldev
 41992                                  ;
 41993                                  ;----------------------------------------------------------------------------
 41994                                  
 41995                                  	; 02/11/2022 - Retrodos v4.0 (Modified MSDOS 5.0 IO.SYS)
 41996                                  	; (SYSINIT:34E0h)
 41997                                  calldev:
 41998 000042B2 2E8E1E[601F]            	mov	ds,[cs:DevEntry+2]
 41999 000042B7 2E031E[5E1F]            	add	bx,[cs:DevEntry]	; do a little relocation
 42000 000042BC 8B07                    	mov	ax,[bx]
 42001                                  
 42002 000042BE 2EFF36[5E1F]            	push	word [cs:DevEntry]
 42003 000042C3 2EA3[5E1F]              	mov	[cs:DevEntry],ax
 42004 000042C7 BB[6A03]                	mov	bx,packet
 42005 000042CA 2EFF1E[5E1F]            	call	far [cs:DevEntry]
 42006 000042CF 2E8F06[5E1F]            	pop	word [cs:DevEntry]
 42007 000042D4 C3                      	retn
 42008                                  
 42009                                  ;----------------------------------------------------------------------------
 42010                                  ;
 42011                                  ; procedure : todigit
 42012                                  ;
 42013                                  ;----------------------------------------------------------------------------
 42014                                  
 42015                                  todigit:
 42016 000042D5 2C30                    	sub	al,'0'
 42017                                  	;jb	short notdig  ; 02/11/2022
 42018                                  	; 12/12/2022
 42019 000042D7 7203                    	jb	short notdig2
 42020                                  	;cmp	al,9
 42021                                  	;ja	short notdig
 42022                                  	;clc
 42023                                  	;retn
 42024                                  	; 12/12/2022
 42025 000042D9 3C0A                    	cmp	al,10
 42026 000042DB F5                      	cmc
 42027                                  notdig:
 42028                                  	;stc
 42029                                  notdig2:
 42030 000042DC C3                      	retn
 42031                                  
 42032                                  ;----------------------------------------------------------------------------
 42033                                  ;
 42034                                  ; procedure : getnum
 42035                                  ;
 42036                                  ; getnum parses a decimal number.
 42037                                  ; returns it in ax, sets zero flag if ax = 0 (may be considered an
 42038                                  ; error), if number is bad carry is set, zero is set, ax=0.
 42039                                  ;
 42040                                  ;----------------------------------------------------------------------------
 42041                                  
 42042                                  getnum:
 42043 000042DD 53                      	push	bx
 42044 000042DE 31DB                    	xor	bx,bx			; running count is zero
 42045                                  b2:
 42046 000042E0 E8F2FF                  	call	todigit 		; do we have a digit ?
 42047 000042E3 7247                    	jc	short badnum		; no, bomb
 42048                                  
 42049 000042E5 93                      	xchg	ax,bx			; put total in ax
 42050 000042E6 53                      	push	bx			; save digit (0 to 9)
 42051                                  	;mov	bx,10			; base of arithmetic
 42052                                  	; 12/12/2022
 42053 000042E7 B30A                    	mov	bl,10
 42054 000042E9 F7E3                    	mul	bx			; shift by one decimal digit
 42055 000042EB 5B                      	pop	bx			; get back digit (0 to 9)
 42056 000042EC 00D8                    	add	al,bl			; get total
 42057 000042EE 80D400                  	adc	ah,0			; make that 16 bits
 42058 000042F1 7239                    	jc	short badnum		; too big a number
 42059                                  
 42060 000042F3 93                      	xchg	ax,bx			; stash total
 42061                                  
 42062 000042F4 E830FF                  	call	getchr			; get next digit
 42063 000042F7 722D                    	jc	short b1		; no more characters
 42064 000042F9 3C20                    	cmp	al,' ' 			; space?
 42065 000042FB 741F                    	je	short b15		; then end of digits
 42066 000042FD 3C2C                    	cmp	al,',' 			; ',' is a seperator!!!
 42067 000042FF 741B                    	je	short b15		; then end of digits.
 42068 00004301 3C09                    	cmp	al, tab ; 9		; tab
 42069 00004303 7417                    	je	short b15
 42070 00004305 2E3A06[AE02]            	cmp	al,[cs:sepchr]		; allow 0 or special separators
 42071 0000430A 7410                    	je	short b15
 42072 0000430C 3C2F                    	cmp	al,'/'			; see if another switch follows
 42073                                  	; 12/12/2022
 42074                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42075                                  	;nop				; cas - remnant of old bad code
 42076                                  	;nop
 42077 0000430E 740C                    	je	short b15
 42078 00004310 3C0A                    	cmp	al,lf			; line-feed?
 42079 00004312 7408                    	je	short b15
 42080 00004314 3C0D                    	cmp	al,cr			; carriage return?
 42081 00004316 7404                    	je	short b15
 42082 00004318 08C0                    	or	al,al			; end of line separator?
 42083 0000431A 75C4                    	jnz	short b2		; no, try as a valid char...
 42084                                  b15:
 42085 0000431C 2EFF06[5603]            	inc	word [cs:count]		; one more character to s...
 42086 00004321 2EFF0E[5A03]            	dec	word [cs:chrptr]	; back up over separator
 42087                                  b1:
 42088 00004326 89D8                    	mov	ax,bx			; get proper count
 42089 00004328 09C0                    	or	ax,ax			; clears carry, sets zero accordingly
 42090 0000432A 5B                      	pop	bx
 42091 0000432B C3                      	retn
 42092                                  badnum:
 42093                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42094                                  	;mov	byte [cs:sepchr],0
 42095 0000432C 31C0                    	xor	ax,ax			; set zero flag, and ax = 0
 42096                                  	; 12 /12/2022
 42097 0000432E 2EA2[AE02]              	mov	[cs:sepchr],al ; 0
 42098 00004332 5B                      	pop	bx
 42099 00004333 F9                      	stc				; and carry set
 42100 00004334 C3                      	retn
 42101                                  
 42102                                  ;****************************************************************************
 42103                                  
 42104                                  setdoscountryinfo:
 42105                                  
 42106                                  ;----------------------------------------------------------------------------
 42107                                  ;input: es:di -> pointer to dos_country_cdpg_info
 42108                                  ;	ds:0  -> buffer.
 42109                                  ;	si = 0
 42110                                  ;	ax = country id
 42111                                  ;	dx = code page id. (if 0, then use ccsyscodepage as a default.)
 42112                                  ;	bx = file handle
 42113                                  ;	this routine can handle maximum 438 country_data entries.
 42114                                  ;
 42115                                  ;output: dos_country_cdpg_info set.
 42116                                  ;	 carry set if any file read failure or wrong information in the file.
 42117                                  ;	 carry set and cx = -1 if cannot find the matching country_id, 
 42118                                  ;	 codepage_id in the file.
 42119                                  ;----------------------------------------------------------------------------
 42120                                  
 42121                                  	; 04/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 42122                                  	; (SYSINIT:4D83h)
 42123                                  
 42124                                  	; 10/09/2023 - Retrodos v4.2 IO.SYS (Optimization)
 42125                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:4FCAh)
 42126                                  
 42127 00004335 57                      	push	di
 42128 00004336 50                      	push	ax
 42129 00004337 52                      	push	dx
 42130                                  
 42131 00004338 31C9                    	xor	cx,cx
 42132 0000433A 31D2                    	xor	dx,dx
 42133 0000433C B80002                  	mov	ax,512			;read 512 bytes
 42134 0000433F E84301                  	call	readincontrolbuffer	;read the file header
 42135 00004342 724A                    	jc	short setdosdata_fail
 42136                                  
 42137 00004344 06                      	push	es
 42138 00004345 56                      	push	si
 42139                                  
 42140 00004346 0E                      	push	cs
 42141 00004347 07                      	pop	es
 42142                                  
 42143 00004348 BF[9945]                	mov	di,country_file_signature ; db 0FFh,'COUNTRY'
 42144 0000434B B90800                  	mov	cx,8			;length of the signature
 42145 0000434E F3A6                    	repz	cmpsb
 42146                                  
 42147 00004350 5E                      	pop	si
 42148 00004351 07                      	pop	es
 42149 00004352 753A                    	jnz	short setdosdata_fail 	;signature mismatch
 42150                                  
 42151 00004354 83C612                  	add	si,18			;si -> county info type
 42152 00004357 803C01                  	cmp	byte [si],1		;only accept type 1 (currently only 1 header type)
 42153 0000435A 7532                    	jne	short setdosdata_fail 	;cannot proceed. error return
 42154                                  
 42155 0000435C 46                      	inc	si			;si -> file offset
 42156 0000435D 8B14                    	mov	dx,[si]			;get the info file offset.
 42157 0000435F 8B4C02                  	mov	cx,[si+2]
 42158 00004362 B80018                  	mov	ax,6144			;read 6144 bytes.
 42159 00004365 E81D01                  	call	readincontrolbuffer	;read info
 42160 00004368 7224                    	jc	short setdosdata_fail
 42161                                  
 42162 0000436A 8B0C                    	mov	cx,[si]			;get the # of country, codepage combination entries
 42163 0000436C 81F9B601                	cmp	cx,438			;cannot handle more than 438 entries.
 42164 00004370 771C                    	ja	short setdosdata_fail
 42165                                  
 42166 00004372 46                      	inc	si
 42167 00004373 46                      	inc	si			;si -> entry information packet
 42168 00004374 5A                      	pop	dx			;restore code page id
 42169 00004375 58                      	pop	ax			;restore country id
 42170 00004376 5F                      	pop	di
 42171                                  
 42172                                  setdoscntry_find:			;search for desired country_id,codepage_id.
 42173 00004377 3B4402                  	cmp	ax,[si+2]		;compare country_id
 42174 0000437A 7509                    	jne	short setdoscntry_next
 42175                                  
 42176                                  	;cmp	dx,0			;no user specified code page ?
 42177                                  	;je	short setdoscntry_any_codepage ;then no need to match code page id.
 42178                                  	; 10/09/2023
 42179 0000437C 09D2                    	or	dx,dx ; cmp dx,0
 42180 0000437E 7413                    	jz	short setdoscntry_any_codepage
 42181 00004380 3B5404                  	cmp	dx,[si+4]		;compare code page id
 42182 00004383 7411                    	je	short setdoscntry_got_it
 42183                                  
 42184                                  setdoscntry_next:
 42185 00004385 0334                    	add	si,[si]			;next entry
 42186 00004387 46                      	inc	si
 42187 00004388 46                      	inc	si			;take a word for size of entry itself
 42188 00004389 E2EC                    	loop	setdoscntry_find
 42189                                  
 42190                                  	;mov	cx,-1			;signals that bad country id entered.
 42191                                  	; 10/09/2023
 42192 0000438B 49                      	dec	cx ; 0 -> -1
 42193                                  setdoscntry_fail:
 42194 0000438C F9                      	stc
 42195 0000438D C3                      	retn
 42196                                  
 42197                                  setdosdata_fail:
 42198 0000438E 5E                      	pop	si
 42199 0000438F 59                      	pop	cx
 42200 00004390 5F                      	pop	di
 42201 00004391 EBF9                    	jmp	short setdoscntry_fail
 42202                                  
 42203                                  setdoscntry_any_codepage:		;use the code_page_id of the country_id found.
 42204 00004393 8B5404                  	mov	dx,[si+4]
 42205                                  
 42206                                  setdoscntry_got_it:			;found the matching entry
 42207 00004396 2E8916[A145]            	mov	[cs:cntrycodepage_id],dx ;save code page id for this country.
 42208 0000439B 8B540A                  	mov	dx,[si+10]		;get the file offset of country data
 42209 0000439E 8B4C0C                  	mov	cx,[si+12]
 42210 000043A1 B80002                  	mov	ax,512 			;read 512 bytes
 42211 000043A4 E8DE00                  	call	readincontrolbuffer
 42212 000043A7 72E3                    	jc	short setdoscntry_fail
 42213                                  
 42214 000043A9 8B0C                    	mov	cx,[si]			;get the number of entries to handle.
 42215 000043AB 46                      	inc	si
 42216 000043AC 46                      	inc	si			;si -> first entry
 42217                                  
 42218                                  setdoscntry_data:
 42219 000043AD 57                      	push	di			;es:di -> dos_country_cdpg_info
 42220 000043AE 51                      	push	cx			;save # of entry left
 42221 000043AF 56                      	push	si			;si -> current entry in control buffer
 42222                                  
 42223 000043B0 8A4402                  	mov	al,[si+2]		;get data entry id
 42224 000043B3 E8A400                  	call	getcountrydestination	;get the address of destination in es:di
 42225 000043B6 727C                    	jc	short setdoscntry_data_next ;no matching data entry id in dos
 42226                                  
 42227 000043B8 8B5404                  	mov	dx,[si+4]		;get offset of data
 42228 000043BB 8B4C06                  	mov	cx,[si+6]
 42229 000043BE B80042                  	mov	ax,4200h
 42230 000043C1 F9                      	stc
 42231 000043C2 CD21                    	int	21h			;move pointer
 42232 000043C4 72C8                    	jc	short setdosdata_fail
 42233                                  
 42234 000043C6 BA0002                  	mov	dx,512			;start of data buffer
 42235 000043C9 B91400                  	mov	cx,20			;read 20 bytes only. we only need to
 42236 000043CC B43F                    	mov	ah,3Fh			;look at the length of the data in the file.
 42237 000043CE F9                      	stc
 42238 000043CF CD21                    	int	21h			;read the country.sys data
 42239 000043D1 72BB                    	jc	short setdosdata_fail 	;read failure
 42240                                  
 42241 000043D3 39C8                    	cmp	ax,cx
 42242 000043D5 75B7                    	jne	short setdosdata_fail ; 13/05/2019
 42243                                  
 42244 000043D7 8B5404                  	mov	dx,[si+4]		;get offset of data again.
 42245 000043DA 8B4C06                  	mov	cx,[si+6]
 42246 000043DD B80042                  	mov	ax,4200h
 42247 000043E0 F9                      	stc
 42248 000043E1 CD21                    	int	21h			;move pointer back again
 42249 000043E3 72A9                    	jc	short setdosdata_fail
 42250                                  
 42251 000043E5 56                      	push	si
 42252 000043E6 BE0802                  	mov	si,(512+8)		;get length of the data from the file
 42253 000043E9 8B0C                    	mov	cx,[si]
 42254 000043EB 5E                      	pop	si
 42255 000043EC BA0002                  	mov	dx,512			;start of data buffer
 42256 000043EF 83C10A                  	add	cx,10			;signature + a word for the length itself
 42257 000043F2 B43F                    	mov	ah,3Fh			;read the data from the file.
 42258 000043F4 F9                      	stc
 42259 000043F5 CD21                    	int	21h
 42260 000043F7 7295                    	jc	short setdosdata_fail
 42261                                  
 42262 000043F9 39C8                    	cmp	ax,cx
 42263 000043FB 7591                    	jne	short setdosdata_fail
 42264                                  
 42265 000043FD 8A4402                  	mov	al,[si+2]		;save data id for future use.
 42266 00004400 BE0802                  	mov	si,(512+8)		;si-> data buffer + id tag field
 42267 00004403 8B0C                    	mov	cx,[si]			;get the length of the file
 42268 00004405 41                      	inc	cx			;take care of a word for lenght of tab
 42269 00004406 41                      	inc	cx			;itself.
 42270 00004407 81F9F805                	cmp	cx,(2048-512-8)	; 1528	;fit into the buffer?
 42271 0000440B 7781                    	ja	short setdosdata_fail
 42272                                  
 42273                                  	;if	bugfix
 42274 0000440D E83100                  	call	setdbcs_before_copy
 42275                                  	;endif
 42276                                  
 42277 00004410 3C01                    	cmp	al,SetCountryInfo ; 1	;is the data for setcountryinfo table?
 42278 00004412 7511                    	jne	short setdoscntry_mov 	;no, don't worry
 42279                                  
 42280 00004414 26FF7518                	push	word [es:di+country_cdpg_info.ccMono_Ptr-country_cdpg_info.ccCountryInfoLen]  
 42281                                  	;push	word [es:di+24]		;cannot destroy ccmono_ptr address. save them.
 42282 00004418 26FF751A                	push	word [es:di+country_cdpg_info.ccMono_Ptr-country_cdpg_info.ccCountryInfoLen+2] 
 42283                                  	;push	word [es:di+26]		;at this time di -> cccountryinfolen
 42284                                  	
 42285 0000441C 57                      	push	di			;save di
 42286                                  
 42287                                  	;push	ax
 42288                                  	;mov	ax,[cs:cntrycodepage_id] ;do not use the code page info in country_info
 42289                                  	;mov	[si+4],ax		;use the saved one for this !!!!
 42290                                  	;pop	ax
 42291                                  	; 10/09/2023
 42292 0000441D 2EFF36[A145]            	push	word [cs:cntrycodepage_id]
 42293 00004422 8F4404                  	pop	word [si+4]
 42294                                  
 42295                                  setdoscntry_mov:
 42296 00004425 F3A4                    	rep	movsb			;copy the table into dos
 42297 00004427 3C01                    	cmp	al,SetCountryInfo	;was the ccmono_ptr saved?
 42298 00004429 7509                    	jne	short setdoscntry_data_next
 42299                                  
 42300 0000442B 5F                      	pop	di			;restore di
 42301 0000442C 268F451A                	pop	word [es:di+country_cdpg_info.ccMono_Ptr-country_cdpg_info.ccCountryInfoLen+2]
 42302                                  	;pop	word [es:di+26]		;restore
 42303 00004430 268F4518                	pop	word [es:di+country_cdpg_info.ccMono_Ptr-country_cdpg_info.ccCountryInfoLen] 
 42304                                  	;pop	word [es:di+24]
 42305                                  
 42306                                  setdoscntry_data_next:
 42307 00004434 5E                      	pop	si			;restore control buffer pointer
 42308 00004435 59                      	pop	cx			;restore # of entries left
 42309 00004436 5F                      	pop	di			;restore pointer to dso_country_cdpg
 42310 00004437 0334                    	add	si,[si]			;try to get the next entry
 42311 00004439 46                      	inc	si
 42312 0000443A 46                      	inc	si			;take a word of entry length itself
 42313 0000443B 49                      	dec	cx
 42314                                  	; 10/09/2023
 42315 0000443C 741B                    	jz	short setdoscntry_ok 
 42316                                  	;cmp	cx,0
 42317                                  	;je	short setdoscntry_ok
 42318 0000443E E96CFF                  	jmp	setdoscntry_data
 42319                                  
 42320                                  	; 18/12/2022
 42321                                  ;setdoscntry_ok:
 42322                                  	;retn
 42323                                  
 42324                                  ;----------------------------------------------------------------------------
 42325                                  
 42326                                  	;if	bugfix
 42327                                  
 42328                                  	; 10/09/2023 - Retrodos v4.2 IO.SYS (Optimization)
 42329                                  
 42330                                  setdbcs_before_copy:
 42331 00004441 3C07                    	cmp	al,SetDBCS ; 7		; dbcs vector set?
 42332 00004443 7514                    	jne	short sdbcsbc		; jump if not
 42333                                  	
 42334                                  	; 10/09/2023
 42335 00004445 50                      	push	ax
 42336 00004446 31C0                    	xor	ax,ax
 42337 00004448 263905                  	cmp	[es:di],ax ; 0
 42338 0000444B 740B                    	je	short sdbcsbc_pop
 42339                                  	
 42340                                  	;cmp	word [es:di],0		; zero byte data block?
 42341                                  	;je	short sdbcsbc		; jump if so
 42342                                  
 42343 0000444D 57                      	push	di
 42344                                  	; 10/09/2023
 42345                                  	;push	ax
 42346 0000444E 51                      	push	cx
 42347 0000444F 268B0D                  	mov	cx,[es:di]		; load block length
 42348                                  	;add	di,2			; points actual data
 42349 00004452 47                      	inc	di
 42350 00004453 47                      	inc	di
 42351                                  	;xor	al,al			; fill bytes
 42352 00004454 F3AA                    	rep	stosb			; clear data block
 42353 00004456 59                      	pop	cx
 42354                                  	;pop	ax
 42355 00004457 5F                      	pop	di
 42356                                  
 42357                                  sdbcsbc_pop:	; 10/09/2023
 42358 00004458 58                      	pop	ax
 42359                                  sdbcsbc:
 42360                                  setdoscntry_ok:	; 18/12/2022
 42361 00004459 C3                      	retn
 42362                                  
 42363                                  	;endif
 42364                                  
 42365                                  ;----------------------------------------------------------------------------
 42366                                  
 42367                                  getcountrydestination:
 42368                                  
 42369                                  ;----------------------------------------------------------------------------
 42370                                  ;get the destination address in the dos country info table.
 42371                                  ;
 42372                                  ;input: al - data id
 42373                                  ;	es:di -> dos_country_cdpg_info
 42374                                  ;on return:
 42375                                  ;	es:di -> destination address of the matching data id
 42376                                  ;	carry set if no matching data id found in dos.
 42377                                  ;----------------------------------------------------------------------------
 42378                                  
 42379                                  	; 04/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 42380                                  	; (SYSINIT:4EB2h)
 42381                                  
 42382                                  	; 10/09/2023 - Retrodos v4.2 IO.SYS (Optimization)
 42383                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:50F9h)
 42384                                  
 42385 0000445A 51                      	push	cx
 42386                                  	;add	di,74
 42387 0000445B 83C74A                  	add	di,country_cdpg_info.ccNumber_of_entries	
 42388                                  					;skip the reserved area, syscodepage etc.
 42389 0000445E 268B0D                  	mov	cx,[es:di]		;get the number of entries
 42390 00004461 47                      	inc	di
 42391 00004462 47                      	inc	di			;si -> the first start entry id
 42392                                  
 42393                                  getcntrydest:
 42394 00004463 263805                  	cmp	byte [es:di],al
 42395 00004466 7413                    	je	short getcntrydest_ok
 42396                                  
 42397 00004468 26803D01                	cmp	byte [es:di],SetCountryInfo ;was it setcountryinfo entry?
 42398 0000446C 7405                    	je	short getcntrydest_1
 42399                                  
 42400 0000446E 83C705                  	add	di,5			;next data id
 42401 00004471 EB03                    	jmp	short getcntrydest_loop
 42402                                  
 42403                                  getcntrydest_1:
 42404                                  	;add	di,41
 42405 00004473 83C729                  	add	di,NEW_COUNTRY_SIZE+3	;next data id
 42406                                  getcntrydest_loop:
 42407 00004476 E2EB                    	loop	getcntrydest
 42408 00004478 F9                      	stc
 42409                                  	;jmp	short getcntrydest_exit
 42410                                  getcntrydest_exit:
 42411                                  	; 10/09/2023
 42412 00004479 59                      	pop	cx
 42413 0000447A C3                      	retn
 42414                                  
 42415                                  getcntrydest_ok:
 42416                                  	; 10/09/2023
 42417 0000447B 47                      	inc	di
 42418                                  
 42419                                  ;	cmp	al,SetCountryInfo ; 1	;select country info?
 42420                                  ;	jne	short getcntrydest_ok1
 42421                                  ;
 42422                                  ;	;inc	di			;now di -> cccountryinfolen
 42423                                  ;	jmp	short getcntrydest_exit
 42424                                  
 42425                                  	; 10/09/2023
 42426 0000447C 3C01                    	cmp	al,SetCountryInfo ; 1	;select country info?
 42427 0000447E 74F9                    	je	short getcntrydest_exit
 42428                                  
 42429                                  getcntrydest_ok1:
 42430                                  	;les	di,[es:di+1]		;get the destination in es:di
 42431                                  	; 10/09/2023
 42432 00004480 26C43D                  	les	di,[es:di]
 42433                                  ;getcntrydest_exit:
 42434 00004483 59                      	pop	cx
 42435 00004484 C3                      	retn
 42436                                  
 42437                                  ;----------------------------------------------------------------------------
 42438                                  
 42439                                  readincontrolbuffer:
 42440                                  
 42441                                  ;----------------------------------------------------------------------------
 42442                                  ;move file pointer to cx:dx
 42443                                  ;read ax bytes into the control buffer. (should be less than 2 kb)
 42444                                  ;si will be set to 0 hence ds:si points to the control buffer.
 42445                                  ;
 42446                                  ;entry:  cx,dx offset from the start of the file where the read/write pointer
 42447                                  ;	 be moved.
 42448                                  ;	 ax - # of bytes to read
 42449                                  ;	 bx - file handle
 42450                                  ;	 ds - buffer seg.
 42451                                  ;return: the control data information is read into ds:0 - ds:0200.
 42452                                  ;	 cx,dx value destroyed.
 42453                                  ;	 carry set if error in reading file.
 42454                                  ;----------------------------------------------------------------------------
 42455                                  
 42456 00004485 50                      	push	ax			;# of bytes to read
 42457 00004486 B80042                  	mov	ax,4200h
 42458 00004489 F9                      	stc
 42459 0000448A CD21                    	int	21h			;move pointer
 42460 0000448C 59                      	pop	cx			;# of bytes to read
 42461 0000448D 7209                    	jc	short ricb_exit
 42462                                  
 42463 0000448F 31D2                    	xor	dx,dx			;ds:dx -> control buffer
 42464 00004491 31F6                    	xor	si,si
 42465 00004493 B43F                    	mov	ah,3Fh			;read into the buffer
 42466 00004495 F9                      	stc
 42467 00004496 CD21                    	int	21h			;should be less than 1024 bytes.
 42468                                  ricb_exit:
 42469 00004498 C3                      	retn
 42470                                  
 42471                                  ;----------------------------------------------------------------------------
 42472                                  
 42473                                  ;! set_country_path procedure is not called from anywhere !
 42474                                  ; Erdogan Tan - 04/08/2023
 42475                                  %if 0
 42476                                  
 42477                                  set_country_path:
 42478                                  
 42479                                  ;----------------------------------------------------------------------------
 42480                                  ;in:  ds - sysinitseg, es - confbot, si -> start of the asciiz path string
 42481                                  ;     dosinfo_ext, cntry_drv, cntry_root, cntry_path
 42482                                  ;     assumes current directory is the root directory.
 42483                                  ;out: ds:di -> full path (cntry_drv).
 42484                                  ;     set the cntry_drv string from the country=,,path command.
 42485                                  ;     ds, es, si value saved.
 42486                                  ;----------------------------------------------------------------------------
 42487                                  
 42488                                  	; 04/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 42489                                  	; (SYSINIT:4EF4h)
 42490                                  
 42491                                  	; 10/09/2023 - Retrodos v4.2 IO.SYS (Optimization)
 42492                                  	; (Retrodos v5.0 Pre-Works)
 42493                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:513Bh)
 42494                                  
 42495                                  	push	si
 42496                                  
 42497                                  	push	ds			;switch ds, es
 42498                                  	push	es
 42499                                  	pop	ds
 42500                                  	pop	es			;now ds -> confbot, es -> sysinitseg
 42501                                  
 42502                                  	call	chk_drive_letter	;current ds:[si] is a drive letter?
 42503                                  	jc	short scp_default_drv 	;no, use current default drive.
 42504                                  
 42505                                  	mov	al,[si]
 42506                                  	inc	si
 42507                                  	inc	si			;si -> next char after ":"
 42508                                  	jmp	short scp_setdrv
 42509                                  
 42510                                  scp_default_drv:
 42511                                  	mov	ah,19h
 42512                                  	int	21h
 42513                                  	add	al,"A"			;convert it to a character.
 42514                                  
 42515                                  scp_setdrv:
 42516                                  	mov	[cs:cntry_drv],al	;set the drive letter.
 42517                                  	mov	di,cntry_path
 42518                                  	mov	al,[si]
 42519                                  	cmp	al, "\"
 42520                                  	je	short scp_root_dir
 42521                                  
 42522                                  	cmp	al,"/"			;let's accept "/" as an directory delim
 42523                                  	;je	short scp_root_dir
 42524                                  	;jmp	short scp_path
 42525                                  	; 04/01/2023
 42526                                  	jne	short scp_path
 42527                                  
 42528                                  scp_root_dir:
 42529                                  	dec	di			;di -> cntry_root
 42530                                  scp_path:
 42531                                  	call	move_asciiz		;copy it
 42532                                  
 42533                                  	mov	di,cntry_drv
 42534                                  scpath_exit:
 42535                                  
 42536                                  	push	ds			;switch ds, es
 42537                                  	push	es
 42538                                  	pop	ds
 42539                                  	pop	es			;ds, es value restored
 42540                                  
 42541                                  	pop	si
 42542                                  	retn
 42543                                  
 42544                                  ;----------------------------------------------------------------------------
 42545                                  
 42546                                  chk_drive_letter:
 42547                                  
 42548                                  ;check if ds:[si] is a drive letter followed by ":".
 42549                                  ;assume that every alpha character is already converted to upper case.
 42550                                  ;carry set if not.
 42551                                  
 42552                                  	; 04/01/2023 - Retrodos v4.2
 42553                                  
 42554                                  	push	ax
 42555                                  	cmp	byte [si],"A"
 42556                                  	;jb	short cdletter_no
 42557                                  	jb	short cdletter_exit
 42558                                  	cmp	byte [si],"Z"
 42559                                  	ja	short cdletter_no
 42560                                  	cmp	byte [si+1],":"
 42561                                  	;jne	short cdletter_no
 42562                                  	;jmp	short cdletter_exit
 42563                                  	; 04/01/2023
 42564                                  	je	short cdletter_exit
 42565                                  
 42566                                  cdletter_no:
 42567                                  	stc
 42568                                  cdletter_exit:
 42569                                  	pop	ax
 42570                                  	retn
 42571                                  
 42572                                  %endif
 42573                                  
 42574                                  ;----------------------------------------------------------------------------
 42575                                  
 42576                                  move_asciiz:
 42577                                  
 42578                                  ;in: ds:si -> source es:di -> target
 42579                                  ;out: copy the string until 0.
 42580                                  ;assumes there exists a 0.
 42581                                  
 42582                                  	; 10/09/2023 - Retrodos v4.2 IO.SYS (Optimization)
 42583                                  	; (MSDOS 6.21 IO.SYS - SYSINIT:4F40h)
 42584                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:5187h)
 42585                                  
 42586                                  masciiz_loop:
 42587                                  	; 10/09/2023
 42588 00004499 F604FF                  	test	byte [si],0FFh
 42589 0000449C A4                      	movsb
 42590                                  	;cmp	byte [si-1],0	; was it 0?
 42591                                  	;jne	short masciiz_loop
 42592 0000449D 75FA                    	jnz	short masciiz_loop ; 10/09/2023
 42593 0000449F C3                      	retn
 42594                                  
 42595                                  ;----------------------------------------------------------------------------
 42596                                  
 42597                                  ;	ds:dx points to string to output (asciz)
 42598                                  ;
 42599                                  ;	prints <badld_pre> <string> <badld_post>
 42600                                  
 42601                                  badfil:
 42602 000044A0 0E                      	push	cs
 42603 000044A1 07                      	pop	es
 42604                                  
 42605 000044A2 89D6                    	mov	si,dx
 42606                                  badload:
 42607 000044A4 BA[5B4A]                	mov	dx,badld_pre	; want to print config error
 42608 000044A7 BB[184A]                	mov	bx,crlfm
 42609                                  prnerr:
 42610 000044AA 0E                      	push	cs
 42611 000044AB 1F                      	pop	ds ; *
 42612 000044AC E81D00                  	call	print
 42613                                  prn1:
 42614 000044AF 268A14                  	mov	dl,[es:si]
 42615 000044B2 08D2                    	or	dl,dl
 42616 000044B4 7407                    	jz	short prn2
 42617 000044B6 B402                    	mov	ah,STD_CON_OUTPUT ; 2 
 42618 000044B8 CD21                    	int	21h
 42619 000044BA 46                      	inc	si
 42620 000044BB EBF2                    	jmp	short prn1
 42621                                  prn2:
 42622 000044BD 89DA                    	mov	dx,bx
 42623 000044BF E80A00                  	call	print
 42624                                  	; 11/12/2022
 42625                                  	; ds = cs ; *
 42626 000044C2 803E[5503]01            	cmp	byte [donotshownum],1
 42627                                  				; suppress line number when handling command.com
 42628                                  	;cmp	byte [cs:donotshownum],1 
 42629 000044C7 7407                    	je	short prnexit
 42630                                  	
 42631                                  	; 18/12/2022
 42632                                  	;call	error_line
 42633 000044C9 E966E4                  	jmp	error_line
 42634                                  ;prnexit:
 42635                                  	;retn
 42636                                  
 42637                                  ;----------------------------------------------------------------------------
 42638                                  
 42639                                  print:
 42640 000044CC B409                    	mov	ah,STD_CON_STRING_OUTPUT ; 9
 42641 000044CE CD21                    	int	21h
 42642                                  prnexit:	; 18/12/2022
 42643 000044D0 C3                      	retn
 42644                                  
 42645                                  ;----------------------------------------------------------------------------
 42646                                  
 42647                                  ;  open device pointed to by dx, al has access code
 42648                                  ;   if unable to open do a device open null device instead
 42649                                  
 42650                                  	; 02/11/2022 - Retrodos v4.0 (Modified MSDOS 5.0 IO.SYS)
 42651                                  	; (SYSINIT:3764h)
 42652                                  open_dev:
 42653 000044D1 E80500                  	call	open_file
 42654 000044D4 7309                    	jnc	short open_dev3
 42655                                  
 42656                                  open_dev1:
 42657 000044D6 BA[3A45]                	mov	dx,nuldev
 42658                                  	; 18/12/2022
 42659                                  	;call	open_file
 42660                                  ;of_retn:
 42661                                  	;retn
 42662                                  	; 18/12/2022
 42663                                  	;jmp	short open_file
 42664                                  open_file:
 42665 000044D9 B43D                    	mov	ah,OPEN	; 3Dh
 42666 000044DB F9                      	stc
 42667 000044DC CD21                    	int	21h
 42668                                  of_retn:	; 18/12/2022
 42669 000044DE C3                      	retn
 42670                                  
 42671                                  open_dev3:
 42672 000044DF 89C3                    	mov	bx,ax			; handle from open to bx
 42673                                  	;;xor	ax,ax			; get device info
 42674                                  	;;mov	ah,IOCTL ; 44h
 42675                                  	;mov	ax,(IOCTL<<8) ; 13/05/2019
 42676                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42677                                  	;xor	ax,ax
 42678                                  	;mov	ah,44h	; IOCTL
 42679                                  	; 11/12/2022
 42680 000044E1 B80044                  	mov	ax,4400h ; IOCTL<<8 
 42681                                  
 42682 000044E4 CD21                    	int	21h
 42683                                  
 42684 000044E6 F6C280                  	test	dl,10000000b ; 80h
 42685 000044E9 75F3                    	jnz	short of_retn
 42686                                  
 42687 000044EB B43E                    	mov	ah,CLOSE ; 3Eh
 42688 000044ED CD21                    	int	21h
 42689 000044EF EBE5                    	jmp	short open_dev1
 42690                                  
 42691                                  ;----------------------------------------------------------------------------
 42692                                  
 42693                                  ; 18/12/2022
 42694                                  %if 0
 42695                                  open_file:
 42696                                  	mov	ah,OPEN	; 3Dh
 42697                                  	stc
 42698                                  	int	21h
 42699                                  	retn
 42700                                  %endif
 42701                                  
 42702                                  ;----------------------------------------------------------------------------
 42703                                  
 42704                                  ; test int24. return back to dos with the fake user response of "fail"
 42705                                  
 42706                                  int24:
 42707 000044F1 B003                    	mov	al,3			; fail the system call
 42708 000044F3 CF                      	iret				; return back to dos.
 42709                                  
 42710                                  ; 19/04/2019 - Retro DOS v4.0
 42711                                  
 42712                                  ;----------------------------------------------------------------------------
 42713                                  ; DATA
 42714                                  ;----------------------------------------------------------------------------
 42715                                  
 42716                                  ;include copyrigh.inc			; copyright statement
 42717                                  
 42718                                  ; MSDOS 6.21 IO.SYS - SYSINIT:4FA3h
 42719                                  
 42720                                  ;MsDosVersion6Copyr:
 42721                                  ;	db	'MS DOS Version 6 (C)Copyright 1981-1993 Microsoft Corp '
 42722                                  ;	db	'Licensed Material - Property of Microsoft All rights reserved '
 42723                                  
 42724                                  ; 22/10/2022
 42725                                  ; MSDOS 5.0 IO.SYS - SYSINIT:378Ch
 42726                                  
 42727                                  ; 28/12/2022
 42728                                  %if 0
 42729                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42730                                  MsDosVersion5Copyr:
 42731                                  	db	'MS DOS Version 5.00 (C)Copyright 1981-1991 Microsoft Corp '
 42732                                  	db	'Licensed Material - Property of Microsoft All rights reserved '
 42733                                  %endif
 42734                                  
 42735                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42736                                  ; 22/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 42737                                  ; 20/04/2019 - Retro DOS v4.0
 42738                                  ;BOOTMES:
 42739                                  ;	db      13
 42740                                  ;	db      10
 42741                                  ;	db      "MS-DOS version "
 42742                                  ;	db      MAJOR_VERSION + "0"
 42743                                  ;	db      "."
 42744                                  ;	db      (MINOR_VERSION / 10) + "0"
 42745                                  ;	db      (MINOR_VERSION % 10) + "0"
 42746                                  ;	db      13,10
 42747                                  ;	;db	"Copyright 1981-1993 Microsoft Corp.",13,10,"$"
 42748                                  ;	; 22/10/2022
 42749                                  ;	db	"Copyright 1981-1991 Microsoft Corp.",13,10,"$"
 42750                                  ;	;
 42751                                  ;	db	0
 42752                                  
 42753                                  	; 01/01/2023 - Retro DOS v4.2
 42754                                  
 42755                                  	; 28/12/2022 - Retro DOS v4.1
 42756                                  ;MsDosVersion5Copyr:
 42757                                  ;  	db	13,10,"MS DOS Version 5.0"
 42758                                  ;	db	13,10,"Copyright 1981-1991 Microsoft Corp.",13,10,"$",0	
 42759                                  
 42760                                  	; 12/12/2022
 42761 000044F4 00                      	db	0
 42762                                  ; 12/12/2022
 42763                                  BOOTMES:
 42764 000044F5 0D0A                    	db	13,10
 42765                                  	;;db 	"Retro DOS v4.0 (Modified MSDOS 5.0) "
 42766                                  	; 28/12/2022
 42767                                  	;db 	"Retro DOS v4.1 (Modified MSDOS 5.0) "
 42768                                  	; 01/01/2023
 42769 000044F7 526574726F20444F53-     	db 	"Retro DOS v4.2 (Modified MSDOS 6.22) "
 42769 00004500 2076342E3220284D6F-
 42769 00004509 646966696564204D53-
 42769 00004512 444F5320362E323229-
 42769 0000451B 20                 
 42770                                  	
 42771 0000451C 0D0A                    	db	13,10
 42772 0000451E 6279204572646F6761-     	db	"by Erdogan Tan [2023] "
 42772 00004527 6E2054616E205B3230-
 42772 00004530 32335D20           
 42773 00004534 0D0A                    	db	13,10
 42774 00004536 0D0A2400                	db	13,10,"$",0
 42775                                  
 42776 0000453A 4E554C00                nuldev:	db	"NUL",0
 42777 0000453E 434F4E00                condev:	db	"CON",0
 42778 00004542 41555800                auxdev:	db	"AUX",0
 42779 00004546 50524E00                prndev:	db	"PRN",0
 42780                                  
 42781                                  ;IFDEF	CONFIGPROC
 42782 0000454A 5C434F4E4649472E53-     config:	db	"\CONFIG.SYS",0
 42782 00004553 595300             
 42783                                  
 42784 00004556 413A                    cntry_drv:  db	"A:"
 42785 00004558 5C                      cntry_root: db	"\"
 42786 00004559 434F554E5452592E53-     cntry_path: db	"COUNTRY.SYS",0
 42786 00004562 595300             
 42787                                  	    ;db	52 dup (0)
 42788 00004565 00<rep 34h>             	    times 52 db 0	
 42789                                  
 42790                                  country_file_signature:
 42791 00004599 FF434F554E545259        	db	0FFh,'COUNTRY'
 42792                                  
 42793                                  cntrycodepage_id: 
 42794 000045A1 0000                    	dw	0 	
 42795                                  
 42796                                  ;ENDIF ; CONFIGPROC
 42797                                  
 42798                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 42799                                  ; (SYSINIT:5081h)
 42800                                  
 42801                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42802                                  ;ifdef	MULTI_CONFIG
 42803 000045A3 00                      newcmd:  db	0			; non-zero if non-std shell specified
 42804 000045A4 40                      tmplate: db	64                      ; must precede commnd
 42805                                  ;endif
 42806                                  
 42807                                  ;ifdef ROMEXEC
 42808                                  ;	db      7                       ; size of commnd line (excl. null)
 42809                                  ;commnd: db	"COMMAND",0
 42810                                  ;	db	56 dup (0)
 42811                                  ;else
 42812                                  	; 02/11/2022
 42813 000045A5 0C                      	db	12                      ; size of commnd line (excl. null)
 42814 000045A6 5C434F4D4D414E442E-     commnd:	db	"\COMMAND.COM",0
 42814 000045AF 434F4D00           
 42815                                  	;db	51 dup (0)
 42816 000045B3 00<rep 33h>             	times	51 db 0
 42817                                  ;endif
 42818                                  
 42819                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42820                                  ;ifdef	MULTI_CONFIG
 42821 000045E6 5C434F4D4D414E442E-     commnd2: db 	"\COMMAND.COM",0	; alternate commands to exec,
 42821 000045EF 434F4D00           
 42822 000045F3 022F5000                	 db	2,"/P",0 		; followed by their respective alternate
 42823 000045F7 5C4D53444F535C434F-     commnd3: db	"\MSDOS\COMMAND.COM",0	; command lines
 42823 00004600 4D4D414E442E434F4D-
 42823 00004609 00                 
 42824 0000460A 0B413A5C4D53444F53-     	 db	11,"A:\MSDOS /P",0 	;(the drive letter are dynamically replaced)
 42824 00004613 202F5000           
 42825 00004617 5C444F535C434F4D4D-     commnd4: db	"\DOS\COMMAND.COM",0 	;
 42825 00004620 414E442E434F4D00   
 42826 00004628 09413A5C444F53202F-     	 db	9,"A:\DOS /P",0		;
 42826 00004631 5000               
 42827                                  def_swchr:	
 42828 00004633 00                      	 db	0			; default switchchar (referenced as command_line-1)
 42829                                  ;endif
 42830                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42831                                  command_line:
 42832 00004634 022F50                  	db	2,"/P"			; default command.com args
 42833                                  	;db	125 dup (0)
 42834 00004637 00<rep 7Dh>             	times	125 db 0
 42835                                  
 42836                                  pathstring:
 42837                                  	;db	64 dup (0)
 42838 000046B4 00<rep 40h>             	times	64 db 0
 42839                                  
 42840                                  
 42841                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 42842                                  ; (SYSINIT:51D3h)
 42843                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42844                                  ;%if 0
 42845                                  
 42846                                  dae_flag:
 42847 000046F4 00                      	db	0 ; MSDOS 6.21 IO.SYS - SYSINIT:51D2h 	
 42848                                  
 42849                                  ;ifdef	MULTI_CONFIG
 42850                                  
 42851                                  ; 04/03/2022- Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS, SYSINIT)
 42852                                  MAX_MULTI_CONFIG equ 9	; max # of multi-config menu items supported
 42853                                  
 42854                                  ;   Beware of byte pairs accessed as words (see all "KEEP AFTER" notes below)
 42855                                  
 42856 000046F5 07                      bMenuColor:	db      07h ; 1Fh       ; default fgnd/bgnd color
 42857 000046F6 00                      bMenuPage:	db      0               ; menu video page (KEEP AFTER bMenuColor)
 42858 000046F7 05                      		db      5               ; video page function # (KEEP AFTER bMenuPage)
 42859 000046F8 00                      bLastCol:	db      0               ; ending column on status line
 42860 000046F9 18                      bLastRow:	db      24              ; row # of status line (KEEP AFTER bLastCol)
 42861 000046FA 00                      bDisableUI:	db      0               ; 1=disable clean/interactive
 42862                                                                          ; 2=disable default 2-second delay
 42863 000046FB 00                      bCRTPage:	db      0               ; value saved from BIOS data area
 42864 000046FC 0000                    wCRTStart:	dw      0               ; value saved from BIOS data area
 42865 000046FE 00                      bQueryOpt:	db      0               ; 0=off, 1=prompt all, 2=prompt none, 4=skip all
 42866 000046FF 01                      bDefBlock:	db      1               ; default block #
 42867 00004700 00                      bMaxBlock:	db      0               ; maximum block #
 42868 00004701 0000                    offDefBlock:	dw      0               ; offset of name of default block (if any)
 42869 00004703 FF                      secTimeOut:	db      -1 ; 0FFh       ; # of seconds for timeout (-1 == indefinite)
 42870 00004704 00                      secElapsed:	db      0               ; # of seconds elapsed so far (KEEP AFTER secTimeOut)
 42871 00004705 00<rep Ah>              abBlockType:	times MAX_MULTI_CONFIG+1 db 0 ; array of block types
 42872 0000470F 0000<rep Ah>            aoffBlockName:	times MAX_MULTI_CONFIG+1 dw 0 ; array of offsets of block names
 42873 00004723 0000<rep Ah>            aoffBlockDesc:	times MAX_MULTI_CONFIG+1 dw 0 ; array of offsets of block descriptions
 42874                                  
 42875 00004737 434F4E4649473D00        szBoot:		db      "CONFIG=",0
 42876 0000473F 4D454E5500              szMenu:		db      "MENU",0
 42877 00004744 434F4D4D4F4E00          szCommon:	db      "COMMON",0
 42878                                  
 42879                                  ;endif	;MULTI_CONFIG
 42880                                  
 42881                                  	; 10/09/2023
 42882                                  	; MSDOS 6.21 IO.SYS - SYSINIT:5229h 	
 42883                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:546Eh)	
 42884                                  
 42885                                  comtab:	 ; label byte
 42886                                  
 42887                                  ;            cmd len    command         cmd code
 42888                                  ;            -------    -------         --------
 42889                                  
 42890                                  ;ifdef MULTI_CONFIG
 42891 0000474B 015B5B                          db      1,      "[",            CONFIG_BEGIN
 42892                                  ;endif
 42893 0000474E 05425245414B43                  db      5,      "BREAK",        CONFIG_BREAK
 42894 00004755 074255464645525342              db      7,      "BUFFERS",      CONFIG_BUFFERS
 42895 0000475E 07434F4D4D454E5459              db      7,      "COMMENT",      CONFIG_COMMENT
 42896 00004767 07434F554E54525951              db      7,      "COUNTRY",      CONFIG_COUNTRY
 42897 00004770 0644455649434544                db      6,      "DEVICE",       CONFIG_DEVICE
 42898 00004778 0A4445564943454849-             db      10,     "DEVICEHIGH",   CONFIG_DEVICEHIGH
 42898 00004781 474855             
 42899 00004784 03444F5348                      db      3,      "DOS",          CONFIG_DOS
 42900 00004789 08445249565041524D-             db      8,      "DRIVPARM",     CONFIG_DRIVPARM
 42900 00004792 50                 
 42901 00004793 044643425358                    db      4,      "FCBS",         CONFIG_FCBS
 42902 00004799 0546494C455346                  db      5,      "FILES",        CONFIG_FILES
 42903                                  ;ifdef MULTI_CONFIG
 42904 000047A0 07494E434C5544454A              db      7,      "INCLUDE",      CONFIG_INCLUDE
 42905                                  ;endif
 42906 000047A9 07494E5354414C4C49              db      7,      "INSTALL",      CONFIG_INSTALL
 42907 000047B2 0B494E5354414C4C48-             db      11,     "INSTALLHIGH",  CONFIG_INSTALLHIGH
 42907 000047BB 49474857           
 42908 000047BF 094C41535444524956-             db      9,      "LASTDRIVE",    CONFIG_LASTDRIVE
 42908 000047C8 454C               
 42909                                  ;ifdef MULTI_CONFIG
 42910 000047CA 075355424D454E554F              db      7,      "SUBMENU",      CONFIG_SUBMENU
 42911 000047D3 094D454E55434F4C4F-             db      9,      "MENUCOLOR",    CONFIG_MENUCOLOR
 42911 000047DC 5252               
 42912 000047DE 0B4D454E5544454641-             db      11,     "MENUDEFAULT",  CONFIG_MENUDEFAULT
 42912 000047E7 554C5441           
 42913 000047EB 084D454E554954454D-             db      8,      "MENUITEM",     CONFIG_MENUITEM
 42913 000047F4 45                 
 42914                                  ;endif
 42915 000047F5 0A4D554C5449545241-             db      10,     "MULTITRACK",   CONFIG_MULTITRACK
 42915 000047FE 434B4D             
 42916                                  ;ifdef MULTI_CONFIG
 42917 00004801 074E554D4C4F434B4E              db      7,      "NUMLOCK",      CONFIG_NUMLOCK
 42918                                  ;endif
 42919 0000480A 0352454D30                      db      3,      "REM",          CONFIG_REM
 42920                                  ;ifdef MULTI_CONFIG
 42921 0000480F 0353455456                      db      3,      "SET",          CONFIG_SET
 42922                                  ;endif
 42923 00004814 055348454C4C53                  db      5,      "SHELL",        CONFIG_SHELL
 42924                                  ;if    STACKSW
 42925 0000481B 06535441434B534B                db      6,      "STACKS",       CONFIG_STACKS
 42926                                  ;endif
 42927 00004823 085357495443484553-             db      8,      "SWITCHES",     CONFIG_SWITCHES
 42927 0000482C 31                 
 42928 0000482D 00                      	db	0
 42929                                  
 42930                                  	; 10/09/2023
 42931                                  ;aDosdata:  ; PCDOS 7.1 IBMBIO.COM - SYSINIT:5550h 	
 42932                                  	;db	7,	"DOSDATA"	CONFIG_DOSDATRA ;  'T'
 42933                                  	;db	0
 42934                                  
 42935                                  ;%endif ; 02/11/2022
 42936                                  
 42937                                  ; 01/01/2023 - Retro DOS v4.2
 42938                                  %if 0
 42939                                  
 42940                                  comtab:
 42941                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42942                                  	; (SYSINIT:38EDh)
 42943                                  	db      7,      "BUFFERS",      CONFIG_BUFFERS
 42944                                  	db      5,      "BREAK",        CONFIG_BREAK
 42945                                  	db      6,      "DEVICE",       CONFIG_DEVICE
 42946                                  	db      10,     "DEVICEHIGH",   CONFIG_DEVICEHIGH
 42947                                  	db      5,      "FILES",        CONFIG_FILES
 42948                                  	db      4,      "FCBS",         CONFIG_FCBS
 42949                                  	db      9,      "LASTDRIVE",    CONFIG_LASTDRIVE
 42950                                  	db      10,     "MULTITRACK",   CONFIG_MULTITRACK
 42951                                  	db      8,      "DRIVPARM",     CONFIG_DRIVPARM
 42952                                  	db      6,      "STACKS",       CONFIG_STACKS
 42953                                  	db      7,      "COUNTRY",      CONFIG_COUNTRY
 42954                                  	db      5,      "SHELL",        CONFIG_SHELL
 42955                                  	db      7,      "INSTALL",      CONFIG_INSTALL
 42956                                  	db      7,      "COMMENT",      CONFIG_COMMENT
 42957                                  	db      3,      "REM",          CONFIG_REM
 42958                                  	db      8,      "SWITCHES",     CONFIG_SWITCHES
 42959                                  	db      3,      "DOS",          CONFIG_DOS
 42960                                  	db	0
 42961                                  
 42962                                  %endif
 42963                                  
 42964                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 42965                                  ; (SYSINIT:530Ch)
 42966                                  
 42967                                  deviceparameters:	
 42968                                  	; A_DEVICEPARAMETERS <0,dev_3inch720kb,0,80>
 42969                                  devp.specialfunc:	; deviceparameters +
 42970 0000482E 00                      	db	0	; A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS
 42971                                  devp.devtype:
 42972 0000482F 02                      	db	2	; A_DEVICEPARAMETERS.DP_DEVICETYPE
 42973                                  devp.devattr:
 42974 00004830 0000                    	dw	0	; A_DEVICEPARAMETERS.DP_DEVICEATTRIBUTES
 42975                                  devp.cylinders:
 42976 00004832 5000                    	dw	80	; A_DEVICEPARAMETERS.DP_CYLINDERS
 42977                                  
 42978                                  ; 04/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 42979                                  
 42980                                  	;times	286	db 0
 42981                                  devp.mediatype:		; A_DEVICEPARAMETERS.DP_MEDIATYPE
 42982 00004834 00                      	db	0
 42983                                  devp.bpb:		; A_DEVICEPARAMETERS.DP_BPB
 42984                                  devp.bps:		; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_BYTESPERSECTOR
 42985 00004835 0000                    	dw	0
 42986                                  devp.secperclus:	; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERCLUSTER	
 42987 00004837 00                      	db	0	
 42988 00004838 0000                    	dw	0	; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_RESERVEDSECTORS
 42989 0000483A 00                      	db	0	; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_NUMBEROFFATS
 42990 0000483B 0000                    	dw	0	; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_ROOTENTRIES
 42991                                  devp.totalsecs:		; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_TOTALSECTORS
 42992 0000483D 0000                    	dw	0
 42993                                  devp.mediaid:		; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_MEDIADESCRIPTOR
 42994 0000483F 00                      	db	0
 42995 00004840 0000                    	dw	0	; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERFAT
 42996                                  devp.spt:		; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERTRACK
 42997 00004842 0000                    	dw	0
 42998                                  devp.heads:		; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_HEADS
 42999 00004844 0000                    	dw	0	
 43000                                  
 43001                                  	;times	68 db 0	; PCDOS 7.1  (FAT32 BPB)
 43002                                  	;times	14 db 0	; MSDOS 6.21
 43003 00004846 0000                    	dw	0	; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_HIDDENSECTORS
 43004 00004848 0000                    	dw	0
 43005 0000484A 0000                    	dw	0	; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_BIGTOTALSECTORS
 43006 0000484C 0000                    	dw	0
 43007 0000484E 00<rep 6h>              	times	6 db 0	
 43008                                  
 43009                                  devp.trktblents:
 43010 00004854 0000                    	dw	0	; A_DEVICEPARAMETERS.DP_TRACKTABLEENTRIES
 43011                                  devp.sectbl:		; A_DEVICEPARAMETERS.DP_SECTORTABLE
 43012 00004856 00<rep FCh>             	times	252 db 0 ; MAX_SECTORS_IN_TRACK * A_SECTORTABLE.size
 43013                                  			; 63*4 bytes		
 43014                                  
 43015                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 43016                                  ; (SYSINIT:5430h)
 43017                                  	
 43018 00004952 0200                    hlim:	dw	2
 43019 00004954 0900                    slim:	dw	9
 43020                                  
 43021 00004956 00                      drive:	db	0
 43022                                  
 43023                                  switches:
 43024 00004957 0000                    	dw	0
 43025                                  
 43026                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 43027                                  ; (SYSINIT:5437h)
 43028                                  
 43029                                  ; the following are the recommended bpbs for the media that
 43030                                  ; we know of so far.
 43031                                  
 43032                                  ; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 43033                                  ; MSDOS 5.0 IO.SYS - SYSINIT:3AA9h
 43034                                  
 43035                                  ; 48 tpi diskettes
 43036                                  
 43037 00004959 0002                    bpb48t	dw	512
 43038 0000495B 02                      	db	2
 43039 0000495C 0100                    	dw	1
 43040 0000495E 02                      	db	2
 43041 0000495F 7000                    	dw	112
 43042 00004961 D002                    	dw	2*9*40 ; 720
 43043 00004963 FD                      	db	0FDh
 43044 00004964 0200                    	dw	2
 43045 00004966 0900                    	dw	9
 43046 00004968 0200                    	dw	2
 43047 0000496A 00000000                	dd	0
 43048 0000496E 00000000                        dd      0
 43049                                  
 43050                                  ; 96tpi diskettes
 43051                                  
 43052 00004972 0002                    bpb96t:	dw	512
 43053 00004974 01                      	db	1
 43054 00004975 0100                    	dw	1
 43055 00004977 02                      	db	2
 43056 00004978 E000                    	dw	224
 43057 0000497A 6009                    	dw	2*15*80 ; 2400
 43058 0000497C F9                      	db	0F9h
 43059 0000497D 0700                    	dw	7
 43060 0000497F 0F00                    	dw	15
 43061 00004981 0200                    	dw	2
 43062 00004983 00000000                	dd	0
 43063 00004987 00000000                        dd      0
 43064                                  
 43065                                  ; 3 1/2 inch diskette bpb
 43066                                  
 43067 0000498B 0002                    bpb35:	dw	512
 43068 0000498D 02                      	db	2
 43069 0000498E 0100                    	dw	1
 43070 00004990 02                      	db	2
 43071 00004991 7000                    	dw	112
 43072 00004993 A005                    	dw	2*9*80 ; 1440
 43073 00004995 F9                      	db	0F9h
 43074 00004996 0300                    	dw	3
 43075 00004998 0900                    	dw	9
 43076 0000499A 0200                    	dw	2
 43077 0000499C 00000000                	dd	0
 43078 000049A0 00000000                        dd      0
 43079                                        
 43080 000049A4 0002                    bpb35h:	dw	512
 43081 000049A6 01                      	db	1
 43082 000049A7 0100                    	dw	1
 43083 000049A9 02                      	db	2
 43084 000049AA E000                    	dw	224
 43085 000049AC 400B                    	dw	2*18*80 ; 2880
 43086 000049AE F0                      	db	0F0h
 43087 000049AF 0900                    	dw	9
 43088 000049B1 1200                    	dw	18
 43089 000049B3 0200                    	dw	2
 43090 000049B5 00000000                	dd	0
 43091 000049B9 00000000                        dd      0
 43092                                  
 43093                                  ; m037 - BEGIN
 43094                                  
 43095 000049BD 0002                    bpb288:	dw	512
 43096 000049BF 02                      	db	2
 43097 000049C0 0100                    	dw	1
 43098 000049C2 02                      	db	2
 43099 000049C3 F000                    	dw	240
 43100 000049C5 8016                    	dw	2*36*80 ; 5760
 43101 000049C7 F0                      	db	0F0h
 43102 000049C8 0900                    	dw	9
 43103 000049CA 2400                    	dw	36
 43104 000049CC 0200                    	dw	2
 43105 000049CE 00000000                	dd	0
 43106 000049D2 00000000                        dd      0
 43107                                  
 43108                                  ; m037 - END
 43109                                  
 43110                                  ; 12/05/2019
 43111                                  
 43112                                  align 2
 43113                                  
 43114                                  ; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 43115                                  ; MSDOS 5.0 IO.SYS - SYSINIT:3B26h
 43116                                  
 43117 000049D6 [5949]                  bpbtable:   dw	    bpb48t		; 48tpi drives
 43118 000049D8 [7249]                  	    dw	    bpb96t		; 96tpi drives
 43119 000049DA [8B49]                  	    dw	    bpb35		; 3.5" drives
 43120                                  ; the following are not supported, so default to 3.5" media layout
 43121 000049DC [8B49]                  	    dw	    bpb35		; not used - 8" drives
 43122 000049DE [8B49]                  	    dw	    bpb35		; not used - 8" drives
 43123 000049E0 [8B49]                  	    dw	    bpb35		; not used - hard files
 43124 000049E2 [8B49]                  	    dw	    bpb35		; not used - tape drives
 43125 000049E4 [A449]                  	    dw	    bpb35h		; 3-1/2" 1.44mb drive
 43126 000049E6 [8B49]                  	    dw	    bpb35		; ERIMO				m037
 43127 000049E8 [BD49]                  	    dw	    bpb288		; 2.88 MB diskette drives	m037
 43128                                  
 43129                                  switchlist: 
 43130 000049EA 08464853544449434E      	db	8,"FHSTDICN"	     ; preserve the positions of n and c.
 43131                                  
 43132                                  ;----------------------------------------------------------------------------
 43133                                  ; Messages
 43134                                  ;----------------------------------------------------------------------------
 43135                                  
 43136                                  ; 19/04/2019 - Retro DOS v4.0
 43137                                  
 43138                                  ; MSDOS 6.21 IO.SYS - SYSINIT:54D1h
 43139                                  
 43140 000049F3 00                      	db 	0
 43141                                  
 43142                                  ; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 43143                                  ; MSDOS 5.0 IO.SYS - SYSINIT:3B44h
 43144                                  
 43145                                  badopm:
 43146 000049F4 0D0A                    	db	0Dh,0Ah 
 43147 000049F6 556E7265636F676E69-     	db	'Unrecognized command in CONFIG.SYS'
 43147 000049FF 7A656420636F6D6D61-
 43147 00004A08 6E6420696E20434F4E-
 43147 00004A11 4649472E535953     
 43148                                  crlfm:
 43149 00004A18 0D0A24                  	db	0Dh,0Ah,'$'
 43150                                  badparm:
 43151 00004A1B 0D0A                    	db	0Dh,0Ah
 43152 00004A1D 42616420636F6D6D61-     	db	'Bad command or parameters - $'
 43152 00004A26 6E64206F7220706172-
 43152 00004A2F 616D6574657273202D-
 43152 00004A38 2024               
 43153                                  badsiz_pre:
 43154 00004A3A 0D0A                    	db	0Dh,0Ah
 43155 00004A3C 536563746F72207369-     	db	'Sector size too large in file $'
 43155 00004A45 7A6520746F6F206C61-
 43155 00004A4E 72676520696E206669-
 43155 00004A57 6C652024           
 43156                                  badld_pre:
 43157 00004A5B 0D0A                    	db	0Dh,0Ah
 43158 00004A5D 426164206F72206D69-     	db	'Bad or missing $'
 43158 00004A66 7373696E672024     
 43159                                  badcom:
 43160 00004A6D 436F6D6D616E642049-     	db	'Command Interpreter',0
 43160 00004A76 6E7465727072657465-
 43160 00004A7F 7200               
 43161                                  badcountry:
 43162 00004A81 0D0A                    	db	0Dh,0Ah
 43163 00004A83 496E76616C69642063-     	db	'Invalid country code or code page',0Dh,0Ah,'$'
 43163 00004A8C 6F756E74727920636F-
 43163 00004A95 6465206F7220636F64-
 43163 00004A9E 6520706167650D0A24 
 43164                                  badcountrycom:
 43165 00004AA7 0D0A                    	db	0Dh,0Ah
 43166 00004AA9 4572726F7220696E20-     	db	'Error in COUNTRY command',0Dh,0Ah,'$'
 43166 00004AB2 434F554E5452592063-
 43166 00004ABB 6F6D6D616E640D0A24 
 43167                                  insufmemory:
 43168 00004AC4 0D0A                    	db	0Dh,0Ah
 43169 00004AC6 496E73756666696369-     	db	'Insufficient memory for COUNTRY.SYS file',0Dh,0Ah,'$'
 43169 00004ACF 656E74206D656D6F72-
 43169 00004AD8 7920666F7220434F55-
 43169 00004AE1 4E5452592E53595320-
 43169 00004AEA 66696C650D0A24     
 43170                                  badmem:
 43171 00004AF1 0D0A                    	db	0Dh,0Ah
 43172 00004AF3 436F6E666967757261-     	db	'Configuration too large for memory',0Dh,0Ah,'$'
 43172 00004AFC 74696F6E20746F6F20-
 43172 00004B05 6C6172676520666F72-
 43172 00004B0E 206D656D6F72790D0A-
 43172 00004B17 24                 
 43173                                  badblock:
 43174 00004B18 0D0A                    	db	0Dh,0Ah
 43175 00004B1A 546F6F206D616E7920-     	db	'Too many block devices',0Dh,0Ah,'$'
 43175 00004B23 626C6F636B20646576-
 43175 00004B2C 696365730D0A24     
 43176                                  badstack:
 43177 00004B33 0D0A                    	db	0Dh,0Ah
 43178 00004B35 496E76616C69642053-     	db	'Invalid STACK parameters',0Dh,0Ah,'$'
 43178 00004B3E 5441434B2070617261-
 43178 00004B47 6D65746572730D0A24 
 43179                                  	; 18/12/2022
 43180                                  ;badorder:
 43181                                  	;db	0Dh,0Ah
 43182                                  	;db	'Incorrect order in CONFIG.SYS line $'
 43183                                  errorcmd:
 43184 00004B50 4572726F7220696E20-     	db	'Error in CONFIG.SYS line $'
 43184 00004B59 434F4E4649472E5359-
 43184 00004B62 53206C696E652024   
 43185                                  
 43186                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 43187                                  ; (SYSINIT:566Eh)
 43188                                  
 43189                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 43190                                  ;%if 0
 43191                                  
 43192 00004B6A 4F4E                    OnOff:	db	'ON'
 43193 00004B6C 4F4646                  OnOff2:	db	'OFF'
 43194                                  
 43195                                  	; 04/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 43196                                  	; (SYSINIT:5673h)
 43197                                  ;StartMsg:
 43198                                  ;	db	'Starting MS-DOS...',0Dh,0Ah
 43199                                  ;	db	0Ah,0
 43200                                  
 43201                                  	; 17/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
 43202                                  	; (SYSINIT:58F7h)
 43203                                  ;StartMsg:
 43204                                  ;	db	'Starting PC DOS...',0Dh,0Ah
 43205                                  ;	db	0Ah,0
 43206                                  
 43207                                  _$PauseMsg:
 43208                                  	; 17/12/2023
 43209                                  	;db	'Press any key to continue . . .',0Dh,0Ah,'$'
 43210                                  	; 04/08/2023 (PCDOS 7.10 - IBMBIO.COM SYSINIT:590Dh)
 43211 00004B6F 507265737320616E79-     	db	'Press any key to continue...',0Dh,0Ah,'$'
 43211 00004B78 206B657920746F2063-
 43211 00004B81 6F6E74696E75652E2E-
 43211 00004B8A 2E0D0A24           
 43212                                  _$CleanMsg:
 43213                                  	;db	'MS-DOS is bypassing your CONFIG.SYS and AUTOEXEC.BAT files.',0Dh,0Ah,'$'
 43214                                  	; 17/12/2023
 43215 00004B8E 504320444F53206973-     	db	'PC DOS is bypassing your CONFIG.SYS and AUTOEXEC.BAT files.',0Dh,0Ah,'$'
 43215 00004B97 20627970617373696E-
 43215 00004BA0 6720796F757220434F-
 43215 00004BA9 4E4649472E53595320-
 43215 00004BB2 616E64204155544F45-
 43215 00004BBB 5845432E4241542066-
 43215 00004BC4 696C65732E0D0A24   
 43216                                  _$InterMsg:
 43217                                  	;db	'MS-DOS will prompt you to confirm each CONFIG.SYS command.',0Dh,0Ah,'$'
 43218                                  	; 17/12/2023
 43219 00004BCC 504320444F53207769-     	db	'PC DOS will prompt you to confirm each CONFIG.SYS command.',0Dh,0Ah,'$'
 43219 00004BD5 6C6C2070726F6D7074-
 43219 00004BDE 20796F7520746F2063-
 43219 00004BE7 6F6E6669726D206561-
 43219 00004BF0 636820434F4E464947-
 43219 00004BF9 2E53595320636F6D6D-
 43219 00004C02 616E642E0D0A24     
 43220                                  _$MenuHeader:
 43221 00004C09 0D0A                    	db	0Dh,0Ah
 43222                                  	; 17/12/2023
 43223                                  	;db	'  MS-DOS 6.2 Startup Menu',0Dh,0Ah
 43224                                  	;db	'  '
 43225                                  	;times	23 db (0CDh)  ; ALT 205 ; '=======================' ; 06/08/2023
 43226                                  	;db 	0Dh,0Ah,'$'
 43227                                  	; 04/08/2023 (PCDOS 7.10 - IBMBIO.COM SYSINIT:59A7h)
 43228 00004C0B 2020504320444F5320-     	db	'  PC DOS 7.1 Startup Menu',0Dh,0Ah
 43228 00004C14 372E31205374617274-
 43228 00004C1D 7570204D656E750D0A 
 43229 00004C26 2020                    	db	'  '
 43230 00004C28 CD<rep 17h>             	times	23 db (0CDh)  ; ALT 205 ; '=======================' ; 06/08/2023
 43231 00004C3F 0D0A24                  	db 	0Dh,0Ah,'$'
 43232                                  _$MenuPrmpt:
 43233 00004C42 2020456E7465722061-     	db	'  Enter a choice: $'
 43233 00004C4B 2063686F6963653A20-
 43233 00004C54 24                 
 43234                                  _$StatusLine:
 43235 00004C55 46353D427970617373-     	db	'F5=Bypass startup files F8=Confirm each line of CONFIG.SYS '
 43235 00004C5E 207374617274757020-
 43235 00004C67 66696C65732046383D-
 43235 00004C70 436F6E6669726D2065-
 43235 00004C79 616368206C696E6520-
 43235 00004C82 6F6620434F4E464947-
 43235 00004C8B 2E53595320         
 43236 00004C90 616E64204155544F45-     	db	'and AUTOEXEC.BAT [ ]$'
 43236 00004C99 5845432E424154205B-
 43236 00004CA2 205D24             
 43237                                  _$InterPrmpt:
 43238 00004CA5 205B592C4E5D3F24        	db	' [Y,N]?$'
 43239                                  	; 04/08/2023
 43240                                  	;db	' [Y,N,ESC]?$' ; PCDOS 7.1 - IBMBIO.COM 
 43241 00004CAD 59455324                _$YES:	db	'YES$'
 43242 00004CB1 4E4F2024                _$NO:	db	'NO $'
 43243                                  _$TimeOut:
 43244 00004CB5 54696D652072656D61-     	db	'Time remaining: $'
 43244 00004CBE 696E696E673A2024   
 43245                                  badcomprmpt:
 43246 00004CC6 456E74657220636F72-     	db	'Enter correct name of Command Interpreter (eg, C:\COMMAND.COM)'
 43246 00004CCF 72656374206E616D65-
 43246 00004CD8 206F6620436F6D6D61-
 43246 00004CE1 6E6420496E74657270-
 43246 00004CEA 726574657220286567-
 43246 00004CF3 2C20433A5C434F4D4D-
 43246 00004CFC 414E442E434F4D29   
 43247 00004D04 0D0A24                  	db	0Dh,0Ah,'$'
 43248                                  _$AutoPrmpt:
 43249 00004D07 50726F636573732041-     	db	'Process AUTOEXEC.BAT [Y,N]?$'
 43249 00004D10 55544F455845432E42-
 43249 00004D19 4154205B592C4E5D3F-
 43249 00004D22 24                 
 43250                                  
 43251                                  ;%endif ; 02/11/2022
 43252                                  
 43253                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 43254                                  ; (SYSINIT:5840h)
 43255                                  
 43256                                  ; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 43257                                  ; MSDOS 5.0 IO.SYS - SYSINIT:3CE0h
 43258                                  
 43259                                  TooManyDrivesMsg:
 43260 00004D23 5741524E494E472120-     	db	'WARNING! Logical drives past Z: exist and will be ignored',0Dh,0Ah,'$'
 43260 00004D2C 4C6F676963616C2064-
 43260 00004D35 726976657320706173-
 43260 00004D3E 74205A3A2065786973-
 43260 00004D47 7420616E642077696C-
 43260 00004D50 6C2062652069676E6F-
 43260 00004D59 7265640D0A24       
 43261                                  
 43262                                  ;MSDOS 6.21 IO.SYS - SYSINIT:587Ch
 43263                                  	;db	'Wrong DBLSPACE.BIN version',0Dh,0Ah,'$'
 43264                                  	;db	7 dup(0)
 43265                                  
 43266                                  	;times	7 db 0
 43267                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 43268                                  ;MSDOS 5.0 IO.SYS - SYSINIT:3D1Ch
 43269                                  	; 09/12/2022
 43270                                  	;times 4 db 0
 43271                                  
 43272                                  ;----------------------------------------------------------------------------
 43273                                  		; 09/12/2022
 43274                                  		;db 0
 43275                                  
 43276                                  number3div	equ ($-SYSINIT$)
 43277                                  number3mod	equ (number3div % 16)
 43278                                  
 43279                                  %if (number3mod>0) & (number3mod<16) ; 17/09/2023
 43280 00004D5F 00                      		times (16-number3mod) db 0
 43281                                  %endif
 43282                                  
 43283                                  ;---------------------------------------------------------------------------- 
 43284                                  ; 09/12/2022 - MSDOS 5.0 IO.SYS:3D20h ;;; SI_end = 3D20h for MSDOS 5.0 IO.SYS 
 43285                                  ;---------------------------------------------------------------------------- 
 43286                                  
 43287                                  ;MSDOS 6.21 IO.SYS - SYSINIT:5899h
 43288                                  
 43289                                  ;----------------------------------------------------------------------------
 43290                                  ; 20/04/2019 - Retro DOS v4.0
 43291                                  
 43292                                  ; 09/12/2022
 43293                                  ;
 43294                                  ;bss_start:
 43295                                  ;
 43296                                  ;ABSOLUTE bss_start
 43297                                  ;
 43298                                  ;alignb 16
 43299                                  
 43300                                  SI_end:  ; SI_end equ $
 43301                                  
 43302                                  ;----------------------------------------------------------------------------
 43303                                  
 43304                                  ;sysinitseg	ends
 43305                                  
 43306                                  ; ***************************************************************************
 43307                                  
 43308                                  ; 04/01/2023 - MSDOS 6.21 SYSINIT:SI_end = SYSINIT:58A0h (IOSYS:9F46h)
 43309                                  ; 09/12/2022 - MSDOS 5.0 SYSINIT:SI_end = SYSINIT:3D20h
 43310                                  
 43311                                  SYSINITSIZE	equ SI_end - SYSINIT$
 43312                                  DOSLOADSEG	equ SYSINITSEG+((SYSINITSIZE+15)/16)
 43313                                  
 43314                                  ;----------------------------------------------------------------------------
 43315                                  ; End of Retro DOS v5.0 IBMDOS.COM (IO.SYS) source by Erdogan Tan (2023)
 43316                                  ;----------------------------------------------------------------------------
 43317                                  
 43318                                  ; 21/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0)
 43319                                  ; 02/10/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
 43320                                  ;----------------------------------------------------------------------------
 43321                                  ;----------------------------------------------------------------------------
 43322                                  
 43323                                  ; ----------------------------------------------------------------------------
 43324                                  ; START OF PCDOS 7.1 -IBMDOS.COM- KERNEL CODE (MSDOS.SYS) -will be relocated-
 43325                                  ; ----------------------------------------------------------------------------
 43326                                  ; 02/10/2023 - Retro DOS v5.0
 43327                                  ; 04/01/2023 - Retro DOS v4.2
 43328                                  ; 29/12/2022 - Retro DOS v4.1
 43329                                  ; 18/03/2019 - Retro DOS v4.0 
 43330                                  ; 11/06/2018 - Retro DOS v3.0 
 43331                                  
 43332                                  ;MSDOS_BIN_OFFSET:
 43333                                  IBMDOS_BIN_OFFSET: ; this offset must be paragraph aligned
 43334                                  		;; 28/06/2019 ('msdos6.s') 
 43335                                  		;incbin	'MSDOS6.BIN' ; Retro DOS 4.0 - MSDOS 6.21 KERNEL
 43336                                  		
 43337                                  		; 29/12/2022
 43338                                  		;incbin	'MSDOS51.BIN' ; Retro DOS 4.1 - MSDOS 5.0+ KERNEL
 43339                                  
 43340                                  		; 29/09/2023 (PARASTART=3DE0h)
 43341                                  		; 27/09/2023 (BugFix) ((PARASTART=3DD0h))
 43342                                  		; 04/01/2023
 43343                                  		;incbin	'MSDOS6.BIN' ; Retro DOS 4.2 - MSDOS 6.21+ KERNEL		
 43344                                  		
 43345                                  		; 02/10/2023 - Retro DOS v5.0 - PCDOS 7.1 KERNEL		 
 43346 00004D60 <bin A646h>             		incbin	'IBMDOS7.BIN'
 43347                                  
 43348                                  		;; 28/12/2022 (BugFix)
 43349                                  		;; 22/12/2022
 43350                                  		;; 21/12/2022 ('msdos5.s')
 43351                                  		;incbin 'MSDOS5.BIN'  ; Retro DOS 4.0 - MSDOS 5.0+ KERNEL
 43352                                  
 43353                                  ; 28/09/2023	
 43354                                  ;msdos_bin_size equ $ - MSDOS_BIN_OFFSET
 43355                                  
 43356                                  align 2
 43357                                  
 43358                                  ; 21/12/2022
 43359                                  ;;END_OF_KERNEL:
 43360                                  ;END_OF_KERNEL equ $
 43361                                  
 43362                                  ; 28/09/2023
 43363                                  S3SIZE equ $-$$
 43364                                  KERNEL_SIZE equ S1SIZE+S2SIZE+S3SIZE
 43365                                  
 43366                                  ;=============================================================================
 43367                                  ;	END
 43368                                  ;=============================================================================
 43369                                  ; Retro DOS v5.0 by Erdogan Tan (Redevelopment of PC-DOS 7.1 KERNEL via NASM)
 43370                                  ; ------------------------------
 43371                                  ; OCTOBER 2023, ISTANBUL - TURKIYE.
