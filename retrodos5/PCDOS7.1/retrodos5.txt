     1                                  ; ****************************************************************************
     2                                  ; RETRODOS.SYS (PCDOS 7.1 Kernel) - RETRO DOS v5.0 by ERDOGAN TAN - 12/09/2023
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 30/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 26/12/2018 (Retro DOS 4.0), 01/10/2022 (Retro DOS 4.2)
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.15
     9                                  ; ----------------------------------------------------------------------------
    10                                  ;	   ((nasm retrodos5.s -l retrodos5.txt -o PCDOS.SYS -Z error.txt)) 
    11                                  ; ----------------------------------------------------------------------------
    12                                  
    13                                  ; 12/09/2023 - Retro DOS v5.0 Kernel -dosbios- ('ibmbio7.s')
    14                                  ; Modified from 'iosys6.s' (11/09/2023, Retro DOS v4.2 Kernel's IO.SYS) file
    15                                  ; as below:
    16                                  ;
    17                                  ;    1) Retro DOS v4.2 IO.SYS is based on disassembled source code
    18                                  ;	of MSDOS 6.21 IO.SYS, derived using MSDOS 6.0 source code.
    19                                  ;
    20                                  ;    2) Labels, names, comments, explanations and structure definitions
    21                                  ;	about procedures and code details are almost entirely taken from
    22                                  ;	the original MSDOS 6.0 source code, except for the details that
    23                                  ;	Erdogan Tan personally experienced. Some of them are incompatible
    24                                  ;	with PCDOS 7.1 code. But they have not been deleted to preserve
    25                                  ;	the originality of the descriptions.)
    26                                  ;
    27                                  ;    3)'ibmbio7.s' contains the BIOSLOADER (MSLOADER) section located in
    28                                  ;	the 1st 4 sectors of the IBMBIO.COM file on disk. This is a method
    29                                  ;	from older DOS versions (3 sectors for MSDOS 6.22).
    30                                  ;	The MSDOS/PCDOS boot sector code only reads these MSLOADER/BIOSLOADER
    31                                  ;	sectors and transfers control to the MSLOADER/BIOSLOADER code.
    32                                  ;	BUT!!! The Retro DOS v3 (& v5) boot sector code loads the entire
    33                                  ;	MSDOS.SYS/PCDOS.SYS -combined- kernel file into memory at once.
    34                                  ;	So, hence the Retro DOS boot sector code, 'retrodos5.s' file
    35                                  ;       contains slightly different IO.SYS/IBMBIO.COM INITialization code
    36                                  ;	than the original PCDOS/MSDOS. It does not include 
    37                                  ;	the MSLOADER/BIOSLOADER section. The 'retrodos5.s' and 'ibmbio7.s'
    38                                  ;	files are almost identical except their INIT codes.)
    39                                  ;
    40                                  ; ('iosys6.s' has been converted to 'ibmbio7.s' and 'retrodos42.s' has been
    41                                  ; converted to 'retrodos5.s'. 'ibmbio7.s' is IBMBIO.COM source code file
    42                                  ; while 'retrodos5.s' is source code of Retro DOS v5 kernel file 'PCDOS.SYS'.
    43                                  ; 'retrodos5.s' includes 'ibmdos7.bin' or IBMDOS.COM as binary file.)
    44                                  		
    45                                  ; ----------------------------------------------------------------------------
    46                                  
    47                                  ; 20/12/2022 - Modifications for initiating IO.SYS by Retro DOS v2 boot sector
    48                                  ;
    49                                  ;	       (Retro DOS v2 BS loads IO.SYS & MSDOS.SYS as single kernel file
    50                                  ;	       with name of 'MSDOS.SYS'. Retro DOS init code -for IO.SYS init-
    51                                  ;	       is different than original MSDOS IO.SYS LOADER and INIT code.)
    52                                  ;
    53                                  ;	       ((RETRODOS.SYS/MSDOS.SYS can be loaded by a fake IO.SYS for
    54                                  ;		using it with MSDOS 5.0 boot sector & as bootable MSDOS disk.
    55                                  ;		For that, fake IO.SYS must load 'MSDOS.SYS' at 1000h:0000h.))		-	
    56                                  ; 		
    57                                  ; 18/12/2022 - Modified MSDOS 5.0 IO.SYS (for using with MSDOS 5 boot sector)
    58                                  ; 09/12/2022 - Multisection binary file format (BIOSDATA & BIOSCODE sections)
    59                                  ; 01/10/2022 - Erdogan Tan (Istanbul)
    60                                  
    61                                  ;Note: This code is a part of Retro DOS 4.0 kernel source code
    62                                  ;     (as included binary, 'IOSYS5.BIN') 
    63                                  ;     Equivalent of MSDOS 5.0 IO.SYS, BIOSCODE and BIOSDATA and SYSINIT
    64                                  ;						        (except MSLOAD code)
    65                                        
    66                                  ;------- Retro DOS v2 (v3) boot sector loads RETRODOS.SYS (MSDOS.SYS)
    67                                  ;	 at 1000h:0000h and loader (initialization) part of RETRODOS kernel
    68                                  ;	 moves IO.SYS (DOSBIOSCODE & DOSBIOSDATA, 'IOSYS5.BIN') to 70h:0000h.
    69                                  ;	 Then SYSINIT code to the next segment (46Dh for original MSDOS 5.0)..
    70                                  ;	 SYSINIT code relocates itself and DOSBIOSCODE and MSDOS.SYS
    71                                  ;	 (MSDOS5.BIN) according to request/setting in 'config.sys' file.
    72                                  
    73                                  ; ----------------------------------------------------------------------------
    74                                  
    75                                  ;=============================================================================
    76                                  ; Modified from 'retrodos3.s', Retro DOS v3.0 Kernel (IBMBIO.COM) Source code
    77                                  ; by Erdogan Tan, 10/09/2018
    78                                  ;=============================================================================
    79                                  
    80                                  ; MSBIO (IO.SYS 6.0) source files:
    81                                  ; 	MSBIO1.ASM,MSCHAR.ASM,MSDISK.ASM,MSDIOCTL.ASM,MSINT13.ASM,MSBIO2.ASM
    82                                  ;	MSINIT.ASM,SYSINIT1.ASM,SYSCONF.ASM,SYSPRE.ASM,SYSINIT2.ASM 
    83                                  ;	SYSIMES.ASM,POWER.ASM,PTIME.ASM,MSEND.ASM
    84                                  
    85                                  ;=============================================================================
    86                                  ; MSBIO
    87                                  ;=============================================================================
    88                                  ;msbio1+mschar+msdisk+msdioctl+msint13+msbio2+
    89                                  ;msinit+sysinit1+sysconf+syspre+sysinit2+sysimes+power+ptime+
    90                                  ;msend,msbio,msbio;
    91                                  
    92                                  ;=============================================================================
    93                                  ; RETRO DOS kernel versions by Erdogan Tan (2018-2022)
    94                                  ;=============================================================================
    95                                  
    96                                  ;Retro DOS v1.0 == MSDOS 1.25 -- derived from MSDOS 1.25 source code 
    97                                  ;Retro DOS v2.0 == MSDOS 2.11 -- derived from MSDOS 2.11 source code 
    98                                  ;Retro DOS v3.0 == MSDOS 3.30 -- derived from MSDOS 3.3 & 6.0 source code 
    99                                  ;Retro DOS v4.0 == MSDOS 6.21 -- derived from MSDOS 6.0 source code (2019) (*)
   100                                  ;Retro DOS v4.0 == MSDOS 5.0+ -- derived from MSDOS 6.0 source code (2022) (**)
   101                                  ;Retro DOS v4.1 == MSDOS 5.0+ -- will be optimized -shortened- version (2023)
   102                                  ;Retro DOS v4.2 == MSDOS 6.21 -- will be MSDOS 6.21 (6.22) compatible (2023)(?)
   103                                  ;Retro DOS v5.0 == PCDOS 7.10 -- will be derived from IBM PCDOS 7.1 source code
   104                                  
   105                                  ;(*) unfinished, draft, canceled (failed in 2019)
   106                                  ;(**) MSDOS 5.0 IO.SYS & SYSINIT, MSDOS 5.0-6.22 mixed MSDOS.SYS (successed)
   107                                  ;(?) MSDOS 6.21 IO.SYS & SYSINIT, MSDOS 6.21 MSDOS.SYS except doublespace
   108                                  
   109                                  ;Disassembly: (reverse engineering via IDA Pro Free)
   110                                  
   111                                  ;Retro DOS v1.0 <-- IBM PCDOS 1.1
   112                                  ;Retro DOS v2.0 <-- IBM PCDOS 2.1 & MSDOS 2.11
   113                                  ;Retro DOS v3.0 <-- IBM PCDOS 3.3 & MSDOS 3.3
   114                                  ;Retro DOS v4.0 <-- MSDOS 6.21 ; 2018-2019 (*)
   115                                  ;Retro DOS v4.0 <-- MSDOS 5.0 ; 2022 (**)
   116                                  ;Retro DOS v5.0 <-- IBM PCDOS 7.1 
   117                                  
   118                                  ;-----------------------------------------------------------------------------
   119                                  ; MSDOS 6.21 IO.SYS (13/02/1994)
   120                                  ;-----------------------------------------------------------------------------
   121                                  
   122                                  SECTOR_SIZE     equ     0200h		; size of a sector
   123                                  PAUSE_KEY       equ     7200h		; scancode + charcode of PAUSE key
   124                                  KEYBUF_NEXT     equ     041Ah		; next character in keyboard buffer
   125                                  KEYBUF_FREE     equ     041Ch		; next free slot in keyboard buffer
   126                                  KEYBUF          equ     041Eh		; keyboard buffer data
   127                                  LOGICAL_DRIVE   equ     0504h		; linear address of logical drive byte
   128                                  ;DOS_SEGMENT	equ     00BFh ; v1.1	; segment in which DOS will run
   129                                  DOS_SEGMENT	equ     00C4h		; Retro DOS v1.0 - 13/02/2018
   130                                  BIO_SEGMENT     equ     0060h		; segment in which BIO is running
   131                                  
   132                                  ; 24/02/2018 (Retro DOS 2.0 - MSDOS 3.3 "DISKPRM.INC" - 24/07/1987)
   133                                  ; The following structure defines the disk parameter table
   134                                  ; pointed to by Interrupt vector 1EH (location 0:78H)
   135                                  
   136                                  struc	DISK_PARMS
   137 00000000 ??                      .DISK_SPECIFY_1:  resb	1
   138 00000001 ??                      .DISK_SPECIFY_2:  resb	1
   139 00000002 ??                      .DISK_MOTOR_WAIT: resb  1	; Wait till motor off
   140 00000003 ??                      .DISK_SECTOR_SIZ: resb 	1	; Bytes/Sector (2 = 512)
   141 00000004 ??                      .DISK_EOT:	  resb  1	; Sectors per track (MAX)
   142 00000005 ??                      .DISK_RW_GAP:	  resb  1	; Read Write Gap
   143 00000006 ??                      .DISK_DTL:	  resb	1
   144 00000007 ??                      .DISK_FORMT_GAP:  resb  1	; Format Gap Length
   145 00000008 ??                      .DISK_FILL:	  resb  1	; Format Fill Byte
   146 00000009 ??                      .DISK_HEAD_STTL:  resb  1	; Head Settle Time (MSec)
   147 0000000A ??                      .DISK_MOTOR_STRT: resb  1	; Motor start delay
   148                                  .size:
   149                                  endstruc
   150                                  
   151                                  ; 09/03/2019 - Retro DOS v4.0
   152                                  ; -------------------------------------------------------------------------
   153                                  ; MSEQU.INC, MSDOS 6.0, 1991
   154                                  
   155                                  ftoobig 	equ	80h
   156                                  fbig		equ	40h
   157                                  ; 12/09/2023
   158                                  fbigbig		equ	20h  ; Retro DOS 5.0 ; PCDOS 7.1 ; FAT32 FS flag
   159                                  romstatus	equ	1
   160                                  romread 	equ	2
   161                                  romwrite	equ	3
   162                                  romverify	equ	4
   163                                  romformat	equ	5
   164                                  
   165                                  ; 26/12/2018 (Retro DOS 4.0 - MSDOS 6.0 "MSBDS.INC" - 1991)
   166                                  ; -------------------------------------------------------------------------
   167                                  ; 24/02/2018 (Retro DOS 2.0 - MSDOS 3.3 "MSBDS.INC" - 24/07/1987)
   168                                  ;
   169                                  ;  BDS is the Bios Data Structure.
   170                                  ;
   171                                  ;  There is one BDS for each logical drive in the system. All the BDS's
   172                                  ;  are linked together in a list with the pointer to the first BDS being
   173                                  ;  found in START_BDS. The BDS hold various values important to the disk
   174                                  ;  drive. For example there is a field for last time accesses. As actions
   175                                  ;  take place in the system the BDS are update to reflect the actions.
   176                                  ;  For example is there is a read to a disk the last access field for the
   177                                  ;  BDS for that drive is update to the current time.
   178                                  ;
   179                                  ; Values for various flags in BDS.flags.
   180                                  ;
   181                                  
   182                                  fnon_removable	    equ     01h 	;For non-removable media
   183                                  fchangeline	    equ     02h 	;If changeline supported on drive
   184                                  return_fake_bpb     equ     04h 	; When set, don't do a build BPB
   185                                  					; just return the fake one
   186                                  good_tracklayout    equ     08h 	; The track layout has no funny sectors
   187                                  fi_am_mult	    equ     10h 	;If more than one logical for this physical
   188                                  fi_own_physical     equ     20h 	;Signify logical owner of this physical
   189                                  fchanged	    equ     40h 	;Indicates media changed
   190                                  set_dasd_true	    equ     80h 	; Set DASD before next format
   191                                  fchanged_by_format  equ    100h		;Media changed by format
   192                                  ; MSDOS 6.0
   193                                  unformatted_media   equ    200h 	;Fixed disk only
   194                                  
   195                                  ;
   196                                  ; Various form factors to describe media
   197                                  ;
   198                                  
   199                                  ff48tpi 	    equ     0
   200                                  ff96tpi 	    equ     1
   201                                  ffSmall 	    equ     2
   202                                  ffHardFile	    equ     5
   203                                  ffOther 	    equ     7
   204                                  ; MSDOS 6.0 ("MSBDS.INC", 1991)
   205                                  ff288		    equ     9	; 2.88 MB drive
   206                                  ; Retro DOS v4.0 feature only !
   207                                  ;ff144		    equ	   10	; 1.44 MB drive			
   208                                  
   209                                  ; 12/09/2023
   210                                  ; Retro DOS v4 (MDOS 5.0-6.22) BDS structure
   211                                  ; -------------------------------------------------------------------------
   212                                  ; 100 bytes
   213                                   
   214                                  %if 0
   215                                  
   216                                  ; 26/05/2019
   217                                  
   218                                  struc	BDS	; BDS_Type
   219                                  .link:		resd 1		; Link to next BDS
   220                                  .drivenum:	resb 1		; Physical drive number
   221                                  .drivelet:	resb 1		; DOS drive number
   222                                  
   223                                  	;We want to embed a BPB declaration here, but we can't initialize
   224                                  	;it properly if we do, so we duplicate the byte/word/dword architecture
   225                                  	;of the BPB declaration.
   226                                  .BPB:	
   227                                  .bytespersec:	resw 1		; bytes per sectors ; def = 512
   228                                  .secperclus:	resb 1		; sectors per cluster
   229                                  .resectors:	resw 1		; reserved sectors
   230                                  .fats:		resb 1		; number of fats
   231                                  .direntries:	resw 1		; number of root directory entries
   232                                  .totalsecs16:	resw 1		; total sectors on medium
   233                                  .media:		resb 1		; media descriptor byte ; def = 0F8h
   234                                  .fatsecs: 	resw 1		; number of fat sectors
   235                                  .secpertrack:	resw 1		; sectors per track
   236                                  .heads:		resw 1		; number of heads
   237                                  ;.hiddensecs:	resw 1		; hidden sectors
   238                                  ; MSDOS 6.0
   239                                  .hiddensecs:	resd 1		; hidden sectors	
   240                                  .totalsecs32:	resd 1		; big total sectors		
   241                                  ;
   242                                  .fatsiz:	resb 1		; flags...
   243                                  .opcnt:		resw 1		; open ref. count
   244                                  ;.volid:	resb 12		; volume ID of medium
   245                                  .formfactor:	resb 1		; form factor index
   246                                  .flags:		resw 1		; various flags ; def: 0020h
   247                                  .cylinders:	resw 1		; number of cylinders
   248                                  ;
   249                                  .R_BPB:  			; recommended BPB
   250                                  .rbytespersec:	resw 1		
   251                                  .rsecperclus:	resb 1
   252                                  .rresectors: 	resw 1
   253                                  .rfats:		resb 1
   254                                  .rdirentries:	resw 1
   255                                  .rtotalsecs16:	resw 1
   256                                  .rmedia: 	resb 1
   257                                  .rfatsecs:	resw 1
   258                                  .rsecpertrack: 	resw 1
   259                                  .rheads:	resw 1
   260                                  .rhidsecs: 	resd 1
   261                                  .rtotalsecs32: 	resd 1
   262                                  .rreserved:	resb 6		; not used (reserved)
   263                                  ;
   264                                  .track:		resb 1		; last track accessed on drive
   265                                  .bdsm_ismini:
   266                                  .tim_lo:	resw 1		; time of last access. keep
   267                                  .bdsm_hidden_trks:
   268                                  .tim_hi:	resw 1		; these contiguous.
   269                                  .volid:		resb 12		; volume id of medium
   270                                  	       ;db "NO NAME    ",0
   271                                  .vol_serial:	resd 1	; current volume serial number from boot record
   272                                  .filesys_id:	resb 9	; current file system id from boot record
   273                                  	       ;db "FAT12   ",0
   274                                  .size:			
   275                                  endstruc
   276                                  
   277                                  %endif
   278                                  
   279                                  ; 12/09/2023 - Retro DOS 5.0 - PCDOS 7.1 (FAT32 compatible) BDS structure
   280                                  ; -------------------------------------------------------------------------
   281                                  ; 150 bytes
   282                                  
   283                                  %if 1
   284                                  
   285                                  struc	BDS	; BDS_Type
   286 00000000 ????????                .link:		resd 1		; Link to next BDS
   287 00000004 ??                      .drivenum:	resb 1		; Physical drive number
   288 00000005 ??                      .drivelet:	resb 1		; DOS drive number
   289                                  
   290                                  	;We want to embed a BPB declaration here, but we can't initialize
   291                                  	;it properly if we do, so we duplicate the byte/word/dword architecture
   292                                  	;of the BPB declaration.
   293                                  .BPB:	
   294 00000006 ????                    .bytespersec:	resw 1		; bytes per sectors ; def = 512
   295 00000008 ??                      .secperclus:	resb 1		; sectors per cluster
   296 00000009 ????                    .resectors:	resw 1		; reserved sectors
   297 0000000B ??                      .fats:		resb 1		; number of fats
   298 0000000C ????                    .direntries:	resw 1		; number of root directory entries
   299 0000000E ????                    .totalsecs16:	resw 1		; total sectors on medium
   300 00000010 ??                      .media:		resb 1		; media descriptor byte ; def = 0F8h
   301 00000011 ????                    .fatsecs16: 	resw 1		; number of fat sectors
   302 00000013 ????                    .secpertrack:	resw 1		; sectors per track
   303 00000015 ????                    .heads:		resw 1		; number of heads
   304 00000017 ????????                .hiddensecs:	resd 1		; hidden sectors	
   305 0000001B ????????                .totalsecs32:	resd 1		; big total sectors
   306                                  ; ----------- FAT32 extensions to BDS ----------- Retro DOS 5.0 -----------
   307 0000001F ????????                .fatsecs32:	resd 1		; BPB_FATSz32   ; FAT32 FAT size in sectors
   308 00000023 ????                    .extflags:	resw 1		; BPB_ExtFlags  ; FAT32 Extended Flags
   309 00000025 ????                    .fsver:		resw 1		; BPB_FSVer	; FAT32 volume version number
   310 00000027 ????????                .rootdirclust:	resd 1		; BPB_RootClus  ; FAT32 root dir's 1st clust num
   311 0000002B ????                    .fsinfo:	resw 1		; BPB_FSInfo	; FAT32 FSINFO sector number
   312 0000002D ????                    .bkbootsec:	resw 1		; BPB_BkBootSec ; FAT32 backup boot sector number
   313 0000002F <res Ch>                .reserved:	resb 12		; BPB_Reserved	; FAT32 reserved field = 0, 12 bytes
   314                                  ; -----------------------------------------------		
   315 0000003B ??                      .fatsiz:	resb 1		; flags...
   316 0000003C ????                    .opcnt:		resw 1		; open ref. count
   317 0000003E ??                      .formfactor:	resb 1		; form factor index
   318 0000003F ????                    .flags:		resw 1		; various flags ; def: 0020h
   319 00000041 ????                    .cylinders:	resw 1		; number of cylinders
   320                                  ;
   321                                  .R_BPB:  			; recommended BPB
   322 00000043 ????                    .rbytespersec:	resw 1		
   323 00000045 ??                      .rsecperclus:	resb 1
   324 00000046 ????                    .rresectors: 	resw 1
   325 00000048 ??                      .rfats:		resb 1
   326 00000049 ????                    .rdirentries:	resw 1
   327 0000004B ????                    .rtotalsecs16:	resw 1
   328 0000004D ??                      .rmedia: 	resb 1
   329 0000004E ????                    .rfatsecs:	resw 1
   330 00000050 ????                    .rsecpertrack: 	resw 1
   331 00000052 ????                    .rheads:	resw 1
   332 00000054 ????????                .rhidsecs: 	resd 1
   333 00000058 ????????                .rtotalsecs32: 	resd 1
   334                                  ; ----------- FAT32 extensions to BDS ----------- Retro DOS 5.0
   335 0000005C ????????                .rfatsecs32:	resd 1		; 
   336 00000060 ????                    .rextflags:	resw 1		; 
   337 00000062 ????                    .rfsver:	resw 1		; 
   338 00000064 ????????                .rrootdirclust:	resd 1		; 
   339 00000068 ????                    .rfsinfo:	resw 1		; default/initial value = -1
   340 0000006A ????                    .rbkbootsec:	resw 1		; default/initial value = -1
   341 0000006C <res Ch>                .rreserved:	resb 12		; default value = 0
   342                                  ; -----------------------------------------------
   343                                  ;
   344 00000078 ??                      .track:		resb 1		; last track accessed on drive (def=-1)
   345                                  .bdsm_ismini:
   346 00000079 ????                    .tim_lo:	resw 1		; time of last access. keep
   347                                  .bdsm_hidden_trks:
   348 0000007B ????                    .tim_hi:	resw 1		; these contiguous.
   349 0000007D <res Ch>                .volid:		resb 12		; volume id of medium
   350                                  	       ;db "NO NAME    ",0
   351 00000089 ????????                .vol_serial:	resd 1	; current volume serial number from boot record
   352 0000008D <res 9h>                .filesys_id:	resb 9	; current file system id from boot record
   353                                  	       ;db "FAT12   ",0
   354                                  .size:			
   355                                  endstruc
   356                                  
   357                                  %endif
   358                                  ; -------------------------------------------------------------------------
   359                                  
   360                                  ;The assembler will generate bad data for "size bds_volid",
   361                                  ;so we'll define an equate here.
   362                                  
   363                                  VOLID_SIZ	equ	12
   364                                  
   365                                  ;bdsm_ismini	equ	bds_tim_lo	; overlapping bds_tim_lo
   366                                  ;bdsm_hidden_trks equ	bds_tim_hi	; overlapping bds_tim_hi
   367                                  
   368                                  max_mini_dsk_num equ 23	; max # of mini disk ibmbio can support
   369                                  
   370                                  ; 29/12/2018
   371                                  ; Retro DOS v4.0
   372                                  ;
   373                                  ; MSDOS 6.0 - BOOTFORM.INC
   374                                  
   375                                  BOOT_SIZE	    EQU	 512
   376                                  EXT_BOOT_SIGNATURE  EQU	 29h ; 41 ; Extended boot signature
   377                                  
   378                                  %define BOOT_SIGNATURE	[BOOT_SIZE-2]
   379                                  
   380                                  struc EBPB ; EXT_BPB_INFO
   381 00000000 ????                    .BYTESPERSECTOR:    resw 1
   382 00000002 ??                      .SECTORSPERCLUSTER: resb 1
   383 00000003 ????                    .RESERVEDSECTORS:   resw 1
   384 00000005 ??                      .NUMBEROFFATS:	    resb 1
   385 00000006 ????                    .ROOTENTRIES:	    resw 1
   386 00000008 ????                    .TOTALSECTORS:	    resw 1
   387 0000000A ??                      .MEDIADESCRIPTOR:   resb 1
   388 0000000B ????                    .SECTORSPERFAT:	    resw 1
   389 0000000D ????                    .SECTORSPERTRACK:   resw 1
   390 0000000F ????                    .HEADS:		    resw 1
   391 00000011 ????????                .HIDDENSECTORS:	    resd 1
   392 00000015 ????????                .BIGTOTALSECTORS:   resd 1
   393                                  .size:
   394                                  endstruc
   395                                  
   396                                  ;EXT_PHYDRV, EXT_CURHD included in the header for OS2.
   397                                  struc EXT_BOOT ; EXT_IBMBOOT_HEADER
   398 00000000 ??????                  .JUMP:		resb 3
   399 00000003 ????????????????        .OEM:		resb 8
   400 0000000B <res 19h>               .BPB:		resb EBPB.size ; 25 bytes
   401 00000024 ??                      .PHYDRV:	resb 1
   402 00000025 ??                      .CURHD:		resb 1
   403 00000026 ??                      .SIG:		resb 1
   404 00000027 ????????                .SERIAL:	resd 1
   405 0000002B <res Bh>                .VOL_LABEL:	resb 11
   406 00000036 ????????????????        .SYSTEM_ID:	resb 8
   407                                  .size:
   408                                  endstruc
   409                                  
   410                                  ; 12/09/2023
   411                                  ; ----------------------------
   412                                  ; Retro DOS v5.0 (PCDOS 7.1) - FAT32 Boot Sector Parameters
   413                                  
   414                                  struc XBPB ; FAT32_BPB_INFO ; 12/09/2023
   415 00000000 ????                    .BYTESPERSECTOR:    resw 1
   416 00000002 ??                      .SECTORSPERCLUSTER: resb 1
   417 00000003 ????                    .RESERVEDSECTORS:   resw 1
   418 00000005 ??                      .NUMBEROFFATS:	    resb 1
   419 00000006 ????                    .ROOTENTRIES:	    resw 1
   420 00000008 ????                    .TOTALSECTORS:	    resw 1
   421 0000000A ??                      .MEDIADESCRIPTOR:   resb 1
   422 0000000B ????                    .SECTORSPERFAT:	    resw 1
   423 0000000D ????                    .SECTORSPERTRACK:   resw 1
   424 0000000F ????                    .HEADS:		    resw 1
   425 00000011 ????????                .HIDDENSECTORS:	    resd 1
   426 00000015 ????????                .BIGTOTALSECTORS:   resd 1
   427                                  ;............ FAT32 ......  + 28
   428 00000019 ????????                .FATSIZE32:	    resd 1
   429 0000001D ????                    .EXTFLAGS:	    resw 1
   430 0000001F ????                    .FSVER:		    resw 1
   431 00000021 ????????                .ROOTDIRCLUSTER:    resd 1
   432 00000025 ????                    .FSINFOSECTOR:	    resw 1  ; (offset from FAT32 bs)
   433 00000027 ????                    .BACKUPBOOTSECTOR:  resw 1  ; (offset from FAT32 bs)
   434 00000029 <res Ch>                .RESERVEDBYTES:	    resb 12 ; (zero bytes)	       			
   435                                  .size:
   436                                  endstruc
   437                                  
   438                                  struc FAT32_EXT_BOOT ; FAT32_IBMBOOT_HEADER ; 12/09/2023
   439 00000000 ??????                  .JUMP:		resb 3
   440 00000003 ????????????????        .OEM:		resb 8
   441 0000000B <res 35h>               .BPB:		resb XBPB.size ; 53 bytes (25+28)
   442 00000040 ??                      .PHYDRV:	resb 1
   443 00000041 ??                      .CURHD:		resb 1
   444 00000042 ??                      .SIG:		resb 1
   445 00000043 ????????                .SERIAL:	resd 1
   446 00000047 <res Bh>                .VOL_LABEL:	resb 11
   447 00000052 ????????????????        .SYSTEM_ID:	resb 8
   448                                  .size:
   449                                  endstruc
   450                                  
   451                                  ; ----------------------------
   452                                  
   453                                  ; 23/03/2018
   454                                  
   455                                  ;STATIC REQUEST HEADER (DEVSYM.INC, MSDOS 6.0, 1991)
   456                                  STRUC SRHEAD
   457 00000000 ??                      .REQLEN:	resb 1		;LENGTH IN BYTES OF REQUEST BLOCK
   458 00000001 ??                      .REQUNIT:	resb 1		;DEVICE UNIT NUMBER
   459 00000002 ??                      .REQFUNC:	resb 1		;TYPE OF REQUEST
   460 00000003 ????                    .REQSTAT:	resw 1		;STATUS WORD
   461 00000005 ????????????????        	       	resb 8		;RESERVED FOR QUEUE LINKS
   462                                  .size:
   463                                  endstruc
   464                                  
   465                                  ; GENERIC IOCTL REQUEST STRUCTURE (DEVSYM.INC, MSDOS 6.0, 1991)
   466                                  ;	SEE THE DOS 4.0 DEVICE DRIVER SPEC FOR FURTHER ELABORATION.
   467                                  ;
   468                                  struc IOCTL_REQ
   469 00000000 <res Dh>                		resb SRHEAD.size	
   470                                  			    	;GENERIC IOCTL ADDITION.
   471 0000000D ??                      .MAJORFUNCTION:	resb 1		;FUNCTION CODE
   472 0000000E ??                      .MINORFUNCTION:	resb 1		;FUNCTION CATEGORY
   473 0000000F ????                    .REG_SI:	resw 1
   474 00000011 ????                    .REG_DI:	resw 1
   475 00000013 ????????                .GENERICIOCTL_PACKET: resd 1	; POINTER TO DATA BUFFER
   476                                  endstruc
   477                                  
   478                                  ; GENERIC IOCTL CATEGORY CODES  (IOCTL.INC, MSDOS 6.0, 1991)
   479                                  IOC_OTHER	EQU	0	; Other device control J.K. 4/29/86
   480                                  IOC_SE		EQU	1	; SERIAL DEVICE CONTROL
   481                                  IOC_TC		EQU	2	; TERMINAL CONTROL
   482                                  IOC_SC		EQU	3	; SCREEN CONTROL
   483                                  IOC_KC		EQU	4	; KEYBOARD CONTROL
   484                                  IOC_PC		EQU	5	; PRINTER CONTROL
   485                                  IOC_DC		EQU	8	; DISK CONTROL (SAME AS RAWIO)
   486                                  
   487                                  ; DEFINITIONS FOR IOCTL_REQ.MINORFUNCTION
   488                                  GEN_IOCTL_WRT_TRK   EQU   40H
   489                                  GEN_IOCTL_RD_TRK    EQU   60H
   490                                  GEN_IOCTL_FN_TST    EQU   20H	; USED TO DIFF. BET READS AND WRTS
   491                                  
   492                                  ;struc A_RETRYCOUNT  ; (IOCTL.INC, MSDOS 6.0, 1991)
   493                                  ;.RC_COUNT:	resw 	1
   494                                  ;endstruc
   495                                  
   496                                  ; 29/05/2019 - Retro DOS v4.0 (DEVSYM.INC, MSDOS 6.0, 1991)
   497                                  
   498                                  ;	THE DEVICE TABLE LIST HAS THE FORM:
   499                                  
   500                                  ;struc SYSDEV
   501                                  ; .NEXT:  resd 1	;POINTER TO NEXT DEVICE HEADER
   502                                  ; .ATT:	  resw 1	;ATTRIBUTES OF THE DEVICE
   503                                  ; .STRAT: resw 1	;STRATEGY ENTRY POINT
   504                                  ; .INT:	  resw 1	;INTERRUPT ENTRY POINT
   505                                  ; .NAME:  resb 8	;NAME OF DEVICE (ONLY FIRST BYTE USED FOR BLOCK)
   506                                  ; .size:
   507                                  ;endstruc
   508                                  
   509                                  ; 27/03/2018 - DEVSYM.INC - MSDOS 3.3 - 24/07/1987
   510                                  
   511                                  ;
   512                                  ; ATTRIBUTE BIT MASKS
   513                                  ;
   514                                  ; CHARACTER DEVICES:
   515                                  ;
   516                                  ; BIT 15 -> MUST BE 1
   517                                  ;     14 -> 1 IF THE DEVICE UNDERSTANDS IOCTL CONTROL STRINGS
   518                                  ;     13 -> 1 IF THE DEVICE SUPPORTS OUTPUT-UNTIL-BUSY
   519                                  ;     12 -> UNUSED
   520                                  ;     11 -> 1 IF THE DEVICE UNDERSTANDS OPEN/CLOSE
   521                                  ;     10 -> MUST BE 0
   522                                  ;      9 -> MUST BE 0
   523                                  ;      8 -> UNUSED
   524                                  ;      7 -> UNUSED
   525                                  ;      6 -> UNUSED
   526                                  ;      5 -> UNUSED
   527                                  ;      4 -> 1 IF DEVICE IS RECIPIENT OF INT 29H
   528                                  ;      3 -> 1 IF DEVICE IS CLOCK DEVICE
   529                                  ;      2 -> 1 IF DEVICE IS NULL DEVICE
   530                                  ;      1 -> 1 IF DEVICE IS CONSOLE OUTPUT
   531                                  ;      0 -> 1 IF DEVICE IS CONSOLE INPUT
   532                                  ;
   533                                  ; BLOCK DEVICES:
   534                                  ;
   535                                  ; BIT 15 -> MUST BE 0
   536                                  ;     14 -> 1 IF THE DEVICE UNDERSTANDS IOCTL CONTROL STRINGS
   537                                  ;     13 -> 1 IF THE DEVICE DETERMINES MEDIA BY EXAMINING THE FAT ID BYTE.
   538                                  ;	    THIS REQUIRES THE FIRST SECTOR OF THE FAT TO *ALWAYS* RESIDE IN
   539                                  ;	    THE SAME PLACE.
   540                                  ;     12 -> UNUSED
   541                                  ;     11 -> 1 IF THE DEVICE UNDERSTANDS OPEN/CLOSE/REMOVABLE MEDIA
   542                                  ;     10 -> MUST BE 0
   543                                  ;      9 -> MUST BE 0
   544                                  ;      8 -> UNUSED
   545                                  ;      7 -> UNUSED
   546                                  ;      6 -> IF DEVICE HAS SUPPORT FOR GETMAP/SETMAP OF LOGICAL DRIVES.
   547                                  ;	    IF THE DEVICE UNDERSTANDS GENERIC IOCTL FUNCTION CALLS.
   548                                  ;      5 -> UNUSED
   549                                  ;      4 -> UNUSED
   550                                  ;      3 -> UNUSED
   551                                  ;      2 -> UNUSED
   552                                  ;      1 -> UNUSED
   553                                  ;      0 -> UNUSED
   554                                  ;
   555                                  
   556                                  DEVTYP	       EQU   8000H	    ; BIT 15 - 1 IF CHAR, 0 IF BLOCK
   557                                  CHARDEV        EQU   8000H
   558                                  DEVIOCTL       EQU   4000H	    ; BIT 14 - CONTROL MODE BIT
   559                                  ISFATBYDEV     EQU   2000H	    ; BIT 13 - DEVICE USES FAT ID BYTES,
   560                                  				    ;  COMP MEDIA.
   561                                  OUTTILBUSY     EQU   2000H	    ; OUTPUT UNTIL BUSY IS ENABLED
   562                                  ISNET	       EQU   1000H	    ; BIT 12 - 1 IF A NET DEVICE, 0 IF
   563                                  				    ;  NOT.  CURRENTLY BLOCK ONLY.
   564                                  DEVOPCL        EQU   0800H	    ; BIT 11 - 1 IF THIS DEVICE HAS
   565                                  				    ;  OPEN,CLOSE AND REMOVABLE MEDIA
   566                                  				    ;  ENTRY POINTS, 0 IF NOT
   567                                  
   568                                  EXTENTBIT      EQU   0400H	    ; BIT 10 - CURRENTLY 0 ON ALL DEVS
   569                                  				    ;  THIS BIT IS RESERVED FOR FUTURE USE
   570                                  				    ;  TO EXTEND THE DEVICE HEADER BEYOND
   571                                  				    ;  ITS CURRENT FORM.
   572                                  
   573                                  ; NOTE BIT 9 IS CURRENTLY USED ON IBM SYSTEMS TO INDICATE "DRIVE IS SHARED".
   574                                  ;    SEE IOCTL FUNCTION 9. THIS USE IS NOT DOCUMENTED, IT IS USED BY SOME
   575                                  ;    OF THE UTILITIES WHICH ARE SUPPOSED TO FAIL ON SHARED DRIVES ON SERVER
   576                                  ;    MACHINES (FORMAT,CHKDSK,RECOVER,..).
   577                                  
   578                                  ; 18/03/2019 - Retro DOS v4.0
   579                                  IOQUERY	       EQU   0080H	    ;Bit 7 - Supports generic IOCtl query M017
   580                                  
   581                                  DEV320	       EQU   0040H	    ;BIT 6 - FOR BLOCK DEVICES, THIS
   582                                  				    ;DEVICE SUPPORTS SET/GET MAP OF
   583                                  				    ;LOGICAL DRIVES, AND SUPPORTS
   584                                  				    ;GENERIC IOCTL CALLS.
   585                                  				    ;FOR CHARACTER DEVICES, THIS
   586                                  				    ;DEVICE SUPPORTS GENERIC IOCTL.
   587                                  				    ;THIS IS A DOS 3.2 DEVICE DRIVER.
   588                                  ISSPEC	       EQU   0010H	    ;BIT 4 - THIS DEVICE IS SPECIAL
   589                                  ISCLOCK        EQU   0008H	    ;BIT 3 - THIS DEVICE IS THE CLOCK DEVICE.
   590                                  ISNULL	       EQU   0004H	    ;BIT 2 - THIS DEVICE IS THE NULL DEVICE.
   591                                  ISCOUT	       EQU   0002H	    ;BIT 1 - THIS DEVICE IS THE CONSOLE OUTPUT.
   592                                  ISCIN	       EQU   0001H	    ;BIT 0 - THIS DEVICE IS THE CONSOLE INPUT.
   593                                  ; 23/07/2019 - Retro DOS v4.0
   594                                  EXTDRVR	       EQU   0002h ; (MSDOS 6.0, DEVSYM.INC, 1991)
   595                                  
   596                                  ; 27/05/2018 - Retro DOS v3.0 
   597                                  ; [MSDOS 3.3, MSDISK.ASM]
   598                                  
   599                                  struc INT13FRAME
   600 00000000 ????                    .oldbp:	resw 1
   601 00000002 ????                    .oldax:	resw 1
   602 00000004 ????                    .oldbx:	resw 1
   603 00000006 ????                    .oldcx:	resw 1
   604 00000008 ????                    .olddx:	resw 1
   605 0000000A ????????                .olddd:	resd 1
   606 0000000E ????                    .oldf:	resw 1
   607                                  .size:
   608                                  endstruc
   609                                  
   610                                  ; 02/06/2018 - Retro DOS v3.0
   611                                  ; [MSDOS 3.3, BIOSTRUC.INC]
   612                                  
   613                                  struc ROMBIOS_DESC		; BIOS_SYSTEM_DESCRIPTOR						  
   614 00000000 ????                    .bios_sd_leng:		resw 1				  
   615 00000002 ??                      .bios_sd_modelbyte:	resb 1					  
   616                                  .bios_sd_scnd_modelbyte: 
   617 00000003 ??                      			resb 1					  
   618 00000004 ??                      			resb 1					  
   619 00000005 ??                      .bios_sd_featurebyte1:	resb 1					  
   620 00000006 ????????                			resb 4					  
   621                                  endstruc
   622                                  
   623                                  ;-----------------------------------------------------------------------------
   624                                  ; MSDIOCTL.ASM - MSDOS 6.0 - 1991
   625                                  ;-----------------------------------------------------------------------------
   626                                  ; 11/03/2019 - Retro DOS v4.0
   627                                  
   628                                  ; 18/03/2019
   629                                  DSK_TIMEOUT_ERR 	EQU	80h	; Time out error (no media present).
   630                                  DSK_CHANGELINE_ERR	EQU	06h	; Change line error
   631                                  DSK_ILLEGAL_COMBINATION EQU	0Ch	; Return code of ah=18h function.
   632                                  MULTI_TRK_ON		EQU	10000000b ; User specified multitrack=on,
   633                                  					  ; or system turns
   634                                  ; IOCTL.INC - MSDOS 6.0 - 1991
   635                                  ; ............................................................................
   636                                  
   637                                  ;*** J.K.
   638                                  ;General Guide -
   639                                  ;Category Code:
   640                                  ; 0... .... DOS Defined
   641                                  ; 1... .... User defined
   642                                  ; .xxx xxxx Code
   643                                  
   644                                  ;Function Code:
   645                                  ; 0... .... Return error if unsupported
   646                                  ; 1... .... Ignore if unsupported
   647                                  ; .0.. .... Intercepted by DOS
   648                                  ; .1.. .... Passed to driver
   649                                  ; ..0. .... Sends data/commands to device
   650                                  ; ..1. .... Quries data/info from device
   651                                  ; ...x .... Subfunction
   652                                  ;
   653                                  ; Note that "Sends/queries" data bit is intended only to regularize the
   654                                  ; function set.  It plays no critical role; some functions may contain both
   655                                  ; command and query elements. The convention is that such commands are
   656                                  ; defined as "sends data".
   657                                  
   658                                  ;*****************************;*
   659                                  ; BLOCK DRIVERS 	      ;*
   660                                  ;*****************************;*
   661                                  
   662                                  ; IOCTL SUB-FUNCTIONS
   663                                  IOCTL_GET_DEVICE_INFO	EQU	0
   664                                  IOCTL_SET_DEVICE_INFO	EQU	1
   665                                  IOCTL_READ_HANDLE	EQU	2
   666                                  IOCTL_WRITE_HANDLE	EQU	3
   667                                  IOCTL_READ_DRIVE	EQU	4
   668                                  IOCTL_WRITE_DRIVE	EQU	5
   669                                  IOCTL_GET_INPUT_STATUS	EQU	6
   670                                  IOCTL_GET_OUTPUT_STATUS EQU	7
   671                                  IOCTL_CHANGEABLE?	EQU	8
   672                                  IOCTL_DeviceLocOrRem?	EQU	9
   673                                  IOCTL_HandleLocOrRem?	EQU	0Ah   ;10
   674                                  IOCTL_SHARING_RETRY	EQU	0Bh   ;11
   675                                  GENERIC_IOCTL_HANDLE	EQU	0Ch   ;12
   676                                  GENERIC_IOCTL		EQU	0Dh   ;13
   677                                  IOCTL_GET_DRIVE_MAP 	EQU	0Eh   ;14
   678                                  IOCTL_SET_DRIVE_MAP	EQU	0Fh   ;15
   679                                  IOCTL_QUERY_HANDLE	EQU	10h   ;16
   680                                  IOCTL_QUERY_BLOCK	EQU	11h   ;17
   681                                  
   682                                  ; GENERIC IOCTL SUB-FUNCTIONS
   683                                  RAWIO			EQU	8
   684                                  
   685                                  ; RAWIO SUB-FUNCTIONS
   686                                  GET_DEVICE_PARAMETERS	EQU	60H
   687                                  SET_DEVICE_PARAMETERS	EQU	40H
   688                                  READ_TRACK		EQU	61H
   689                                  WRITE_TRACK		EQU	41H
   690                                  VERIFY_TRACK		EQU	62H
   691                                  FORMAT_TRACK		EQU	42H
   692                                  GET_MEDIA_ID		EQU	66h	;AN000;AN003;changed from 63h
   693                                  SET_MEDIA_ID		EQU	46h	;AN000;AN003;changed from 43h
   694                                  GET_ACCESS_FLAG 	EQU	67h	;AN002;AN003;Unpublished function.Changed from 64h
   695                                  SET_ACCESS_FLAG 	EQU	47h	;AN002;AN003;Unpublished function.Changed from 44h
   696                                  SENSE_MEDIA_TYPE	EQU	68H	;Added for 5.00
   697                                  
   698                                  
   699                                  ; SPECIAL FUNCTION FOR GET DEVICE PARAMETERS
   700                                  BUILD_DEVICE_BPB	EQU	000000001B
   701                                  
   702                                  ; SPECIAL FUNCTIONS FOR SET DEVICE PARAMETERS
   703                                  INSTALL_FAKE_BPB	EQU	000000001B
   704                                  ONLY_SET_TRACKLAYOUT	EQU	000000010B
   705                                  TRACKLAYOUT_IS_GOOD	EQU	000000100B
   706                                  
   707                                  ; SPECIAL FUNCTION FOR FORMAT TRACK
   708                                  STATUS_FOR_FORMAT	EQU	000000001B
   709                                  DO_FAST_FORMAT		EQU	000000010B ;AN001;
   710                                  ; CODES RETURNED FROM FORMAT STATUS CALL
   711                                  FORMAT_NO_ROM_SUPPORT	EQU	000000001B
   712                                  FORMAT_COMB_NOT_SUPPORTED EQU	000000010B
   713                                  
   714                                  ; DEVICETYPE VALUES
   715                                  MAX_SECTORS_IN_TRACK	EQU	63	; MAXIMUM SECTORS ON A DISK.(Was 40 in DOS 3.2)
   716                                  DEV_5INCH		EQU	0
   717                                  DEV_5INCH96TPI		EQU	1
   718                                  DEV_3INCH720KB		EQU	2
   719                                  DEV_8INCHSS		EQU	3
   720                                  DEV_8INCHDS		EQU	4
   721                                  DEV_HARDDISK		EQU	5
   722                                  DEV_OTHER		EQU	7
   723                                  ;DEV_3INCH1440KB	EQU	7
   724                                  DEV_3INCH2880KB		EQU	9
   725                                  ; Retro DOS v2.0 - 26/03/2018
   726                                  ;;DEV_TAPE		EQU	6
   727                                  ;;DEV_ERIMO		EQU	8
   728                                  ;DEV_3INCH2880KB	EQU	9
   729                                  DEV_3INCH1440KB		EQU	10
   730                                  
   731                                  ;MAX_DEV_TYPE		EQU	9	; MAXIMUM DEVICE TYPE THAT WE
   732                                  					; CURRENTLY SUPPORT.
   733                                  MAX_DEV_TYPE		EQU	10
   734                                  
   735                                  struc A_SECTORTABLE
   736 00000000 ????                    .ST_SECTORNUMBER:	resw	1
   737 00000002 ????                    .ST_SECTORSIZE:		resw	1
   738                                  .size:
   739                                  endstruc
   740                                  
   741                                  ; MSDOS 6.0 - BPB.INC - 1991
   742                                  ; ####
   743                                  ;**	BIOS PARAMETER BLOCK DEFINITION
   744                                  ;
   745                                  ;	The BPB contains information about the disk structure. It dates
   746                                  ;	back to the earliest FAT systems and so FAT information is
   747                                  ;	intermingled with physical driver information.
   748                                  ;
   749                                  ;	A boot sector contains a BPB for its device; for other disks
   750                                  ;	the driver creates a BPB. DOS keeps copies of some of this
   751                                  ;	information in the DPB.
   752                                  ;
   753                                  ;	The BDS structure contains a BPB within it.
   754                                  ;
   755                                  
   756                                  struc A_BPB
   757 00000000 ????                    .BPB_BYTESPERSECTOR:	resw	1
   758 00000002 ??                      .BPB_SECTORSPERCLUSTER:	resb	1
   759 00000003 ????                    .BPB_RESERVEDSECTORS:	resw	1
   760 00000005 ??                      .BPB_NUMBEROFFATS:	resb	1
   761 00000006 ????                    .BPB_ROOTENTRIES: 	resw	1
   762 00000008 ????                    .BPB_TOTALSECTORS:	resw	1
   763 0000000A ??                      .BPB_MEDIADESCRIPTOR:	resb	1
   764 0000000B ????                    .BPB_SECTORSPERFAT:	resw	1
   765 0000000D ????                    .BPB_SECTORSPERTRACK:	resw	1
   766 0000000F ????                    .BPB_HEADS:		resw	1
   767 00000011 ????                    .BPB_HIDDENSECTORS:	resw	1
   768 00000013 ????                    			resw	1
   769 00000015 ????                    .BPB_BIGTOTALSECTORS:	resw	1
   770 00000017 ????                    			resw	1
   771 00000019 ????????????            			resb	6	; NOTE:  many times these
   772                                  ;					; 	 6 bytes are omitted
   773                                  ;					;	 when BPB manipulations
   774                                  ;					;	 are performed!
   775                                  .size:
   776                                  endstruc
   777                                  ; ####
   778                                  
   779                                  struc A_DEVICEPARAMETERS
   780 00000000 ??                      .DP_SPECIALFUNCTIONS:	resb	1
   781 00000001 ??                      .DP_DEVICETYPE:		resb	1
   782 00000002 ????                    .DP_DEVICEATTRIBUTES:	resw	1
   783 00000004 ????                    .DP_CYLINDERS:		resw	1
   784 00000006 ??                      .DP_MEDIATYPE:		resb	1
   785 00000007 <res 1Fh>               .DP_BPB:		resb	A_BPB.size
   786 00000026 ????                    .DP_TRACKTABLEENTRIES:	resw	1
   787 00000028 <res FCh>               .DP_SECTORTABLE:	resb	MAX_SECTORS_IN_TRACK * A_SECTORTABLE.size
   788                                  endstruc
   789                                  
   790                                  struc A_TRACKREADWRITEPACKET
   791 00000000 ??                      .TRWP_SPECIALFUNCTIONS:	resb	1
   792 00000001 ????                    .TRWP_HEAD:		resw	1
   793 00000003 ????                    .TRWP_CYLINDER:		resw	1
   794 00000005 ????                    .TRWP_FIRSTSECTOR:	resw	1
   795 00000007 ????                    .TRWP_SECTORSTOREADWRITE: resw	1
   796 00000009 ????????                .TRWP_TRANSFERADDRESS:	resd	1
   797                                  endstruc
   798                                  
   799                                  ;AN001; - FP_TRACKCOUNT is only meaningful when FP_SPECIALFUNCTIONS bit 1 = 1.
   800                                  struc A_FORMATPACKET
   801 00000000 ??                      .FP_SPECIALFUNCTIONS:	resb	1  ; db ?
   802 00000001 ????                    .FP_HEAD: 		resw	1  ; dw ? 
   803 00000003 ????                    .FP_CYLINDER:		resw	1  ; dw ?
   804 00000005 ????                    .FP_TRACKCOUNT:		resw	1  ; dw 1 ; !
   805                                  endstruc
   806                                  
   807                                  struc A_VERIFYPACKET
   808 00000000 ??                      .VP_SPECIALFUNCTIONS:	resb	1
   809 00000001 ????                    .VP_HEAD: 		resw	1
   810 00000003 ????                    .VP_CYLINDER:		resw	1
   811                                  endstruc
   812                                  
   813                                  struc A_MEDIA_ID_INFO
   814 00000000 ????                    .MI_LEVEL:		resw	1  ; dw 0 ; !		;J.K. 87 Info. level
   815 00000002 ????????                .MI_SERIAL:		resd	1  ; dd ?		;J.K. 87 Serial #
   816 00000006 <res Bh>                .MI_LABEL:		resb	11 ; db 11 DUP (' ') ;!	;J.K. 87 volume label
   817 00000011 ????????????????        .MI_SYSTEM:		resb 	8  ; db 8 DUP (' ')  ;!	;J.K. 87 File system type
   818                                  endstruc
   819                                  
   820                                  struc A_DISKACCESS_CONTROL	   ;AN002; Unpublished function. Only for Hard file.
   821 00000000 ??                      .DAC_SPECIALFUNCTIONS:	resb 	1  ; db 0 ; ! ;AN002; Always 0
   822 00000001 ??                      .DAC_ACCESS_FLAG: 	resb 	1  ; db 0 ; ! 
   823                                  				   ; Non Zero - allow disk I/O to unformatted hard file
   824                                  endstruc			   ; 0 - Disallow disk I/O to unformatted hard file
   825                                  
   826                                  
   827                                  struc A_MEDIA_SENSE			; Media sense structure added 5.00
   828 00000000 ??                      .MS_ISDEFAULT:		resb	1	; If 1 type returned is drv default
   829 00000001 ??                      .MS_DEVICETYPE:		resb	1	; Drive type 
   830 00000002 ??                      .MS_RESERVED1:		resb	1	; RESERVED
   831 00000003 ??                      .MS_RESERVED2:		resb 	1	; RESERVED 
   832                                  endstruc
   833                                  
   834                                  ;********************************;*
   835                                  ; CHARACTER DEVICES (PRINTERS)	 ;*
   836                                  ;********************************;*
   837                                  
   838                                  ;RAWIO SUB-FUNCTIONS
   839                                  GET_RETRY_COUNT 	EQU	65H
   840                                  SET_RETRY_COUNT 	EQU	45H
   841                                  
   842                                  struc A_RETRYCOUNT
   843 00000000 ????                    .RC_COUNT:		resw 1
   844                                  endstruc
   845                                  
   846                                  ;********************************;*		;J.K. 4/29/86
   847                                  ; CHARACTER DEVICES (SCREEN)	 ;*
   848                                  ;********************************;*		;J.K. 4/29/86
   849                                  ;
   850                                  ;SC_MODE_INFO	 struc
   851                                  ;SC_INFO_LENGTH 	 DW	 9
   852                                  ;SC_MODE		 DB	 0
   853                                  ;SC_COLORS		 DW	 0
   854                                  ;SC_WIDTH		 DW	 0
   855                                  ;SC_LENGTH		 DW	 0
   856                                  ;SC_MODE_INFO	 ends
   857                                  ;
   858                                  ;SC_INFO_PACKET_LENGTH	 EQU	 9		 ;LENGTH OF THE INFO PACKET.
   859                                  
   860                                  ;SUBFUNCTIONS FOR CON$GENIOCTL
   861                                  ;GET_SC_MODE		 EQU	 60h
   862                                  ;SET_SC_MODE		 EQU	 40h
   863                                  ;The following subfunctions are reserved for installable CODE PAGE switch
   864                                  ;console devices. - J.K. 4/29/86
   865                                  ;Get_active_codepage	 equ	 6Ah
   866                                  ;Invoke_active_codepage  equ	 4Ah
   867                                  ;Start_designate_codepage equ	 4Ch
   868                                  ;End_designate_codepage  equ	 4Dh
   869                                  ;Get_list_of_designated_codepage equ 6Bh
   870                                  ;J.K. 4/29/86 *** End of Con$genioctl equates & structures
   871                                  
   872                                  ;-----------------------------------------------------------------------------
   873                                  ; MULT.INC - MSDOS 6.0 - 1991
   874                                  ;-----------------------------------------------------------------------------
   875                                  ; 18/03/2019
   876                                  
   877                                  ; The current set of defined multiplex channels is (* means documented):
   878                                  ;
   879                                  ;   Channel(h)  Issuer          Receiver    Function
   880                                  ;      00       server          PSPRINT     print job control
   881                                  ;     *01       print/apps      PRINT       Queueing of files
   882                                  ;      02       BIOS            REDIR       signal open/close of printers
   883                                  ;
   884                                  ;      05       command         REDIR       obtain text of net int 24 message
   885                                  ;     *06       server/assign   ASSIGN      Install check
   886                                  ;
   887                                  ;      08       external driver IBMBIO      interface to internal routines
   888                                  ;
   889                                  ;      10       sharer/server   Sharer      install check
   890                                  ;      11       DOS/server      Redir       install check/redirection funcs
   891                                  ;      12       sharer/redir    DOS         dos functions and structure maint
   892                                  ;      13       MSNET           MSNET       movement of NCBs
   893                                  ;      13       external driver IBMBIO      Reset_Int_13, allows installation
   894                                  ;                                           of alternative INT_13 drivers after
   895                                  ;                                           boot_up
   896                                  ;      14 (IBM) DOS             NLSFUNC     down load NLS country info,DOS 3.3
   897                                  ;      14 (MS)  APPS            POPUP       MSDOS 4 popup screen functions
   898                                  ;      15       APPS            MSCDEX      CD-ROM extensions interface
   899                                  ;      16       WIN386          WIN386      Windows communications
   900                                  ;      17       Clipboard       WINDOWS     Clipboard interface
   901                                  ;     *18       Applications    MS-Manger   Toggle interface to manager
   902                                  ;      19       Shell
   903                                  ;      1A       Ansi.sys
   904                                  ;      1B       Fastopen,Vdisk   IBMBIO     EMS INT 67H stub handler
   905                                  ;
   906                                  ;      40h      OS/2
   907                                  ;      41h      Lanman
   908                                  ;      42h      Lanman
   909                                  ;      43h      Himem
   910                                  ;                               AL = 20h    reserved for Mach 20 Himem support
   911                                  ;                               AL = 30h    reserved for Himem external A20 code
   912                                  ;      44h      Dosextender
   913                                  ;      45H      Windows profiler
   914                                  ;      46h      Windows/286 DOS extender
   915                                  ;      47h      Basic Compiler Vn. 7.0
   916                                  ;      48h      Doskey
   917                                  ;      49h      DOS 5.x install 
   918                                  ;      4Ah      Multi Purpose
   919                                  ;                multMULTSWPDSK         0 - Swap Disk in drive A (BIOS)
   920                                  ;                multMULTGETHMAPTR      1 - Get available HMA & ptr
   921                                  ;                multMULTALLOCHMA       2 - Allocate HMA (bx == no of bytes)
   922                                  ;                multMULTTASKSHELL      5 - Shell/switcher API
   923                                  ;                multMULTRPLTOM         6 - Top Of Memory for RPL support
   924                                  ;
   925                                  ;                multSmartdrv           10h
   926                                  ;                multMagicdrv           11h
   927                                  ;      4Bh      Task Switcher API
   928                                  ;
   929                                  ;      4Ch      APPS            APM             Advanced power management
   930                                  ;      4Dh      Kana Kanji Converter, MSKK
   931                                  ;
   932                                  ;      51h      ODI real mode support driver (for Chicago)
   933                                  ;
   934                                  ;      53h      POWER.EXE - used for broadcasting APM events    ; M036
   935                                  ;      54h      POWER.EXE - used for POWER API                  ; M036
   936                                  ;
   937                                  ;      55h      COMMAND.COM
   938                                  ;                multCOMFIRST           0 - API to determine whether 1st
   939                                  ;                                           instance of command.com
   940                                  ;                multCOMFIRSTROM        1 - API to determine whether 1st
   941                                  ;                                           instance of ROM COMMAND
   942                                  ;      56h      Sewell Development
   943                                  ;               INTERLNK
   944                                  ;
   945                                  ;      57h      Iomega Corp.
   946                                  ;
   947                                  ;      AB       Unspecified IBM use
   948                                  ;      AC       Graphics
   949                                  ;      AD       NLS (toronto)
   950                                  ;      AE
   951                                  ;      AF       Mode
   952                                  ;      B0       GRAFTABL        GRAFTABL
   953                                  ;
   954                                  ;      D7       Banyan VINES
   955                                  
   956                                  multMULT	  equ	4Ah
   957                                  
   958                                  multMULTSWPDSK	  equ	0	; Swap Disk in drive A (BIOS)
   959                                  multMULTGETHMAPTR equ	1	; Get available HMA & ptr
   960                                  multMULTALLOCHMA  equ	2	; Allocate HMA (bx == no of bytes)
   961                                  multMULTTASKSHELL equ	5	; Shell/switcher API
   962                                  multMULTRPLTOM	  equ	6	; Top Of Memory for RPL support
   963                                  
   964                                  ;-----------------------------------------------------------------------------
   965                                  ; WIN386.INC - MSDOS 6.0 - 1991
   966                                  ;-----------------------------------------------------------------------------
   967                                  ; 18/03/2019
   968                                  
   969                                  ; WIN386.INC
   970                                  ;
   971                                  ;  Symbols and structures relating to WIN386 support.
   972                                  ;
   973                                  ;  Used by files in both the DOS and the BIOS.
   974                                  ;
   975                                  ;  Created: 7-13-89 by MRW
   976                                  ;
   977                                  
   978                                  ; WIN386 broadcast int 2fh multiplex number and subfunction numbers
   979                                  
   980                                  MultWin386		equ     16h	; Int 2f multiplex number
   981                                  
   982                                  Win386_Init		equ	05h	; Win386 initialization
   983                                  Win386_Exit		equ	06h	; Win386 exit
   984                                  Win386_Devcall		equ	07h	; Win386 device call out
   985                                  Win386_InitDone		equ	08h	; Win386 initialization is complete
   986                                  
   987                                  ; ============================================================================
   988                                  
   989                                  ;-----------------------------------------------------------------------------
   990                                  ;
   991                                  ; +-------------------------------------------------------------------------+
   992                                  ; |   This file	has been generated by The Interactive Disassembler (IDA)    |
   993                                  ; |	      Copyright	(c) 2013 Hex-Rays, <support@hex-rays.com>	    |
   994                                  ; |			 Licensed to: Freeware version			    |
   995                                  ; +-------------------------------------------------------------------------+
   996                                  ;
   997                                  ;-----------------------------------------------------------------------------
   998                                  
   999                                  ;		.386
  1000                                  ;		.model flat
  1001                                  
  1002                                  ; ============================================================================
  1003                                  
  1004                                  ; 02/10/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
  1005                                  ; 10/12/2022
  1006                                  ; 09/12/2022
  1007                                  ; 21/10/2022
  1008                                  ; 19/10/2022
  1009                                  ; 17/10/2022, 18/10/2022
  1010                                  ; 15/10/2022, 16/10/2022
  1011                                  ; 03/10/2022
  1012                                  ; 02/10/2022
  1013                                  ; 01/10/2022 - Erdogan Tan
  1014                                  
  1015                                  ; [[ Most of comments here are from the original MSDOS 6.0 source code ]]
  1016                                  
  1017                                  ;-----------------------------------------------------------------------------
  1018                                  ; Start of PC-DOS 7.1 IBMBIO.COM  (IO.SYS)
  1019                                  ;-----------------------------------------------------------------------------
  1020                                  
  1021                                  		; [ORG 0]		; segment 0x0070h
  1022                                  
  1023                                  ;=============================================================================
  1024                                  ; DOS BIOS (IO.SYS) DATA SEGMENT 
  1025                                  ;=============================================================================
  1026                                  ; 09/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
  1027                                  ; 30/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
  1028                                  ; 02/10/2023 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
  1029                                  
  1030                                  section .BIOSDATA vstart=0
  1031                                  
  1032                                  ;--- DOSBIOS data segment ----------------------------------------------------
  1033                                  ;-----------------------------------------------------------------------------
  1034                                  
  1035                                  ;Bios_Data segment
  1036                                  
  1037                                  BData_start:				
  1038 00000000 E9691B                  hdrv_pat:	jmp	init		; MSBIO1.ASM, MSSBDATA.INC
  1039                                  ; ----------------------------------------------------------------------------
  1040                                  
  1041 00000003 0000                    DosDataSg:	dw 0
  1042                                  
  1043                                  ; DOS's int 2f handler will exit via a jump through here.
  1044                                  ; This is how the BIOS hooks int2f
  1045                                  
  1046                                  ;BIOSDATA:0005h: ; 10/05/2023 (Note the 'bios_i2f equ 5' in 'msdos6.s')
  1047                                  			
  1048 00000005 EA                      bios_i2f:	db 0EAh			; far jump to int_2f (segment may not be at 70h)
  1049                                  		; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  1050                                  		; PCDOS 7.1 IBMBIO.COM - BIODATA:0006h
  1051                                  		;dw int_2f
  1052                                  		;dw 70h			; BIOSDATA segment (KERNEL_SEGMENT)
  1053 00000006 [2F16]                  		dw i2f_handler	
  1054                                  bios_i2f_seg:	; 10/08/2023
  1055 00000008 FF02                    		dw DOSBIOCODESEG	; 02CCh for MSDOS 6.21 IO.SYS (25Ch+070h)
  1056                                  					; 0364h PCDOS 7.1 IBMBIO.COM  (2F4h+070h)
  1057                                  
  1058 0000000A 0000                    romstartaddr:	dw 0			; The start address for the romfind routines
  1059                                  					; This is to maintain binary compatibility
  1060                                  					; with DISK based DOS 5.0
  1061                                  
  1062                                  ; This is a byte used for special key handling in the resident
  1063                                  ; console device driver. It must be here so that it can be included
  1064                                  ; in the WIN386 instance table (in INC\LMSTUB.ASM).
  1065                                  
  1066 0000000C 00                      altah:		db 0			; special key handling
  1067                                  			
  1068 0000000D 00                      inHMA:		db 0			; flag indicates we're running from HMA
  1069 0000000E 00000000                xms:		dd 0			; entry point to xms if above is true
  1070                                  
  1071                                  ; PTRSAV - pointer save
  1072                                  ;
  1073                                  ; This variable holds the pointer to the Request Header passed by a program
  1074                                  ; wishing to use a device driver. When the strategy routine is called it 
  1075                                  ; puts the address of the Request header in this variable and returns.
  1076                                  		
  1077 00000012 00000000                ptrsav:		dd 0			
  1078                                  auxbuf:		;db 4 dup(0)		; set of 1 byte buffers for com 1,2,3, and 4
  1079 00000016 00000000                		db 0, 0, 0, 0 ; 19/10/2022
  1080 0000001A 0000                    zeroseg:	dw 0			; easy way to load segment registers with zero			
  1081 0000001C 0000                    i13_ds:		dw 0			; ds register for int13 call through	
  1082 0000001E 0000                    prevoper:	dw 0			; holds int 13 request (i.e. register ax).			
  1083 00000020 00                      number_of_sec:	db 0			; holds number of secs. to read on an ecc error
  1084 00000021 0000                    auxnum:		dw 0			; which aux device was requested			
  1085                                  
  1086                                  ;-----------------------------------------------------------------------------
  1087                                  
  1088                                  res_dev_list:
  1089                                  
  1090                                  ; Device Header for the CON Device Driver
  1091                                  
  1092                                  CONHeader:				; HEADER FOR DEVICE "CON"
  1093 00000023 [3500]                  		dw auxdev2
  1094 00000025 7000                    		dw 70h	
  1095 00000027 1380                    word_727:	dw 8013h
  1096 00000029 [1506]                  		dw strategy
  1097 0000002B [2006]                  		dw con_entry
  1098 0000002D 434F4E2020202020        aCon:		db 'CON     '           
  1099 00000035 [4700]                  auxdev2:	dw prndev2		; HEADER FOR DEVICE "AUX"	
  1100 00000037 7000                    		dw 70h
  1101 00000039 0080                    		dw 8000h
  1102 0000003B [1506]                  		dw strategy
  1103 0000003D [4106]                  		dw aux0_entry
  1104 0000003F 4155582020202020        aAux:		db 'AUX     '
  1105 00000047 [5900]                  prndev2:	dw timdev		; HEADER FOR DEVICE "PRN"
  1106 00000049 7000                    		dw 70h
  1107 0000004B C0A0                    word_74B:	dw 0A0C0h
  1108 0000004D [1506]                  		dw strategy
  1109 0000004F [2506]                  		dw prn0_entry
  1110 00000051 50524E2020202020        aPrn:		db 'PRN     '		; HEADER FOR DEVICE "CLOCK$"
  1111 00000059 [6B00]                  timdev:		dw dskdev	
  1112 0000005B 7000                    		dw 70h
  1113 0000005D 0880                    		dw 8008h
  1114 0000005F [1506]                  		dw strategy
  1115 00000061 [5906]                  		dw tim_entry
  1116 00000063 434C4F434B242020        aClock:		db 'CLOCK$  '
  1117 0000006B [7B00]                  dskdev:		dw com1dev		; HEADER FOR DISK DEVICES
  1118 0000006D 7000                    		dw 70h
  1119                                  		;dw 8C2h
  1120                                  		; 02/10/2023 - Retro DOS v5.0
  1121 0000006F C248                    		dw 48C2h		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:006Fh 
  1122                                  		;dw offset strategy
  1123                                  		;dw offset dsk_entry
  1124                                  		; 19/10/2022
  1125 00000071 [1506]                  		dw strategy
  1126 00000073 [5E06]                  		dw dsk_entry
  1127                                  
  1128                                  ; maximum number of drives
  1129                                  
  1130 00000075 04                      drvmax:		db 4			
  1131 00000076 FE                      step_drv:	db 0FEh	 ; -2		; last drive accessed		
  1132 00000077 00                      fhave96:	db 0			; flag to indicate presence of
  1133                                  					; 96tpi support		
  1134 00000078 00                      single:		db 0			; used to detect single drive systems		
  1135 00000079 00                      fhavek09:	db 0			; indicates if this is a k09 or not
  1136                                  					; used by console driver.			
  1137 0000007A 00                      fsetowner:	db 0			; = 1 if we are setting the owner of a
  1138                                  					; drive. (examined by checksingle).
  1139                                  		
  1140 0000007B [8D00]                  com1dev:	dw lpt1dev		; Device Header for device "COM1"	
  1141 0000007D 7000                    		dw 70h
  1142 0000007F 0080                    		dw 8000h
  1143 00000081 [1506]                  		dw strategy
  1144 00000083 [4106]                  		dw aux0_entry
  1145 00000085 434F4D3120202020        aCom1:		db 'COM1    '
  1146 0000008D [9F00]                  lpt1dev:	dw lpt2dev		; Device Header for device LPT1	
  1147 0000008F 7000                    		dw 70h
  1148 00000091 C0A0                    		dw 0A0C0h
  1149 00000093 [1506]                  		dw strategy
  1150 00000095 [2C06]                  		dw prn1_entry
  1151 00000097 4C50543120202020        aLpt1:		db 'LPT1    '
  1152 0000009F [B800]                  lpt2dev:	dw lpt3dev		; Device Header for device LPT2	
  1153 000000A1 7000                    		dw 70h
  1154 000000A3 C0A0                    		dw 0A0C0h
  1155 000000A5 [1506]                  		dw strategy
  1156 000000A7 [3306]                  		dw prn2_entry
  1157 000000A9 4C5054322020202000-     aLpt2:		db 'LPT2    ',0,0,0
  1157 000000B2 0000               
  1158                                  
  1159                                  ;M058; Start of changes
  1160                                  ; Orig13 needs to be at offset 0B4h for the CMS floppy driver to work.
  1161                                  ;These guys patch Orig13 with their own int 13h hook and so this offset
  1162                                  ;cannot change for them to work. Even ProComm does this.
  1163                                  
  1164 000000B4 00000000                Orig13:		dd 0			; to make Orig13 offset 0B4h		
  1165                                  
  1166 000000B8 [CA00]                  lpt3dev:	dw com2dev		; Device Header for device LPT3	
  1167 000000BA 7000                    		dw 70h
  1168 000000BC C0A0                    		dw 0A0C0h
  1169 000000BE [1506]                  		dw strategy
  1170 000000C0 [3A06]                  		dw prn3_entry
  1171 000000C2 4C50543320202020        aLpt3:		db 'LPT3    '
  1172 000000CA [DC00]                  com2dev:	dw com3dev		; Device Header for device "COM2"
  1173 000000CC 7000                    		dw 70h
  1174 000000CE 0080                    		dw 8000h
  1175 000000D0 [1506]                  		dw strategy
  1176 000000D2 [4706]                  		dw aux1_entry
  1177                                  		; 19/10/2022
  1178 000000D4 434F4D3220202020        aCom2:		db 'COM2    '
  1179                                  com3dev:	;dw offset com4dev	; Device Header for device "COM3"
  1180 000000DC [EE00]                  		dw com4dev
  1181 000000DE 7000                    		dw 70h
  1182 000000E0 0080                    		dw 8000h
  1183                                  		;dw offset strategy
  1184                                  		;dw offset aux2_entry
  1185 000000E2 [1506]                  		dw strategy
  1186 000000E4 [4D06]                  		dw aux2_entry	
  1187 000000E6 434F4D3320202020        aCom3:		db 'COM3    '
  1188 000000EE FFFF                    com4dev:	dw 0FFFFh		; Device Header for device "COM4"	
  1189 000000F0 7000                    		dw 70h
  1190 000000F2 0080                    		dw 8000h
  1191 000000F4 [1506]                  		dw strategy
  1192 000000F6 [5306]                  		dw aux3_entry
  1193 000000F8 434F4D3420202020        		db 'COM4    '
  1194                                  
  1195                                  ;-----------------------------------------------------------------------------
  1196                                  
  1197 00000100 10                      RomVectors:	db 10h			
  1198 00000101 00000000                Old10:		dd 0
  1199 00000105 13                      		db 13h
  1200 00000106 00000000                Old13:		dd 0			
  1201 0000010A 15                      		db 15h
  1202 0000010B 00000000                Old15:		dd 0			
  1203 0000010F 19                      		db 19h
  1204 00000110 00000000                Old19:		dd 0
  1205 00000114 1B                      		db 1Bh
  1206 00000115 00000000                Old1B:		dd 0
  1207                                  
  1208                                  ;EndRomVectors	equ $
  1209                                  
  1210                                  ;NUMROMVECTORS	equ ((EndRomVectors - RomVectors)/5)
  1211                                  
  1212                                  ;-----------------------------------------------------------------------------
  1213                                  
  1214 00000119 [5203]                  start_bds:	dw bds1			; Start	of linked list of BDS's
  1215 0000011B 7000                    		dw 70h			; KERNEL_SEGMENT
  1216                                  
  1217                                  ; (MSDOS 3.3) NOTE:
  1218                                  ; Some floppy drives do not have changeline support. The result is a
  1219                                  ; large amount of inefficiency in the code. A media-check always returns
  1220                                  ; "I don`t know". This cause DOS to reread the FAT on every access and
  1221                                  ; always discard any cached data.
  1222                                  ;    We get around this inefficiency by implementing a "Logical Door Latch".
  1223                                  ; The following three items are used to do this. The logical door latch is
  1224                                  ; based on the premise that it is not physically possible to change floppy
  1225                                  ; disks in a drive in under two seconds (most people take about 10). The
  1226                                  ; logical door latch is implemented by saving the time of the last successful
  1227                                  ; disk operation (in the value TIM_DRV). When a new request is made the
  1228                                  ; current time is compared to the saved time. If less than two seconds have
  1229                                  ; passed then the value "No Change" is returned. If more than two seconds
  1230                                  ; have passed the value "Don't Know" is returned.
  1231                                  ;    There is one complecation to this algorithm. Some programs change the
  1232                                  ; value of the timer. In this unfortunate case we have an invalid timer.
  1233                                  ; This possibility is detected by counting the number of disk operations
  1234                                  ; which occur without any time passing. If this count exceeds the value of
  1235                                  ; "AccessMax" we assume the counter is invalid and always return "Don't
  1236                                  ; Know". The variable "AccessCount" is used to keep track of the number
  1237                                  ; of disk operation which occur without the time changing.
  1238                                  
  1239 0000011D 00                      accesscount:	db 0			
  1240 0000011E FF                      tim_drv:	db 0FFh			
  1241 0000011F 00                      medbyt:		db 0
  1242                                  wrtverify:	; 15/10/2022			
  1243 00000120 02                      rflag:		db 2			; 2 for	read, 3	for write
  1244 00000121 00                      verify:		db 0			; 1 if verify after write
  1245 00000122 0000                    seccnt:		dw 0			
  1246 00000124 00                      		db 0			; -- pad where hardnum was
  1247 00000125 01                      dsktnum:	db 1			; number of diskette drives			
  1248                                  
  1249                                  ; (MSDOS 3.3) NOTE:
  1250                                  ; Some of the older versions of the IBM rom-bios always assumed a seek would
  1251                                  ; have to be made to read the diskette. Consequently a large head settle
  1252                                  ; time was always used in the I/O operations. To get around this problem
  1253                                  ; we need to continually adjust the head settle time. The following
  1254                                  ; algorithm is used:
  1255                                  ;
  1256                                  ;   Get the current head settle value.
  1257                                  ;   If it is 1, then
  1258                                  ;	set slow = 15
  1259                                  ;   else
  1260                                  ;	set slow = value
  1261                                  ;   ...
  1262                                  ;   if we are seeking and writing then
  1263                                  ;	use slow
  1264                                  ;   else
  1265                                  ;	use fast
  1266                                  ;   ...
  1267                                  ;   restore current head settle value
  1268                                  
  1269 00000126 00                      motorstartup:	db 0			; value from table
  1270 00000127 00                      settlecurrent:	db 0			; value from table
  1271 00000128 00                      settleslow:	db 0			; slow settle value
  1272 00000129 00                      nextspeed:	db 0			; value	of speed to be used
  1273 0000012A 00                      save_head_sttl:	db 0			; used by read_sector routine
  1274 0000012B 00                      save_eot:	db 0			; saved	eot from the default DPT
  1275 0000012C 09                      eot:		db 9			
  1276 0000012D 00000000                dpt:		dd 0			; pointer to Disk Parameter Table
  1277 00000131 00                      cursec:		db 0			; current sector
  1278 00000132 00                      curhd:		db 0			; current head
  1279 00000133 0000                    curtrk:		dw 0			; current track
  1280 00000135 0000                    spsav:		dw 0			; save the stack pointer
  1281 00000137 08                      formt_eot:	db 8			; eot used for format
  1282 00000138 00                      hdnum:		db 0			; head number
  1283 00000139 0000                    trknum:		dw 0			; track	being manipulated
  1284 0000013B 50                      gap_patch:	db 50h			; format gap patched into dpt
  1285                                  
  1286                                  ;-----------------------------------------------------------------------------
  1287                                  
  1288                                  ; disk errors returned from the IBM rom
  1289                                  
  1290 0000013C CC                      errin:		db 0CCh			; write fault (hard disk)
  1291 0000013D 80                      		db 80h			; write fault (hard disk)
  1292 0000013E 40                      		db 40h			; seek failed
  1293 0000013F 10                      		db 10h			; uncorrectable CRC or ECC error on read
  1294 00000140 08                      		db 8			; dma overrun
  1295 00000141 06                      		db 6			; disk changed (floppy)
  1296 00000142 04                      		db 4			; sector not found/read error
  1297 00000143 03                      		db 3			; disk write-protected
  1298                                  		; 02/10/2023 - Retro DOS 5.0 (PCDOS 7.1 IBMBIO.COM)
  1299 00000144 01                      		db 1			; invalid function in AH or invalid parameter
  1300 00000145 B2                      		db 0B2h			; volume not removable	
  1301                                  		;
  1302 00000146 00                      lsterr:		db 0			; all other errors
  1303                                  
  1304                                  ; returned error codes corresponding to above
  1305                                  
  1306 00000147 0A                      errout:		db 10			; write	fault error
  1307 00000148 02                      		db 2			; no response (timeout)
  1308 00000149 06                      		db 6			; seek failure
  1309 0000014A 04                      		db 4			; bad crc
  1310 0000014B 04                      		db 4			; dma overrun
  1311 0000014C 0F                      		db 15			; invalid media	change
  1312 0000014D 08                      		db 8			; sector not found
  1313 0000014E 00                      		db 0			; write	attempt	to write-protect disk
  1314                                  		; 02/10/2023
  1315 0000014F 03                      		db 3			; unknown command error
  1316 00000150 03                      		db 3			; unknown command error
  1317                                  		;
  1318 00000151 0C                      		db 12			; general error
  1319                                  
  1320                                  ;-----------------------------------------------------------------------------
  1321                                  ; PCDOS 7.1 IBMBIO.COM - BIOSDATA:0152h
  1322                                  
  1323                                  ; 02/10/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
  1324                                  %if 1
  1325                                  disksector:	;times 174 db 0
  1326                                  NUM174 equ 512-$
  1327 00000152 00<rep AEh>             		times NUM174 db 0
  1328                                  JB_sign	:	;dw 424Ah		; 'BJ' (nasm) ; 'JB' (masm)
  1329 00000200 4A                      		dec	dx
  1330 00000201 42                      		inc	dx	
  1331 00000202 E9FBFD                  		jmp	BData_start	; db 0E9h, 0FBh, 0FDh
  1332                                  
  1333 00000205 402349424D3A31322E-     IBMBIOCOM$:	db '@#IBM:12.01.2003.build_1.32#@ IBMBIO.COM(USA)',0
  1333 0000020E 30312E323030332E62-
  1333 00000217 75696C645F312E3332-
  1333 00000220 23402049424D42494F-
  1333 00000229 2E434F4D2855534129-
  1333 00000232 00                 
  1334                                  		
  1335                                  		;times 287 db 0
  1336 00000233 00<rep 11Fh>            		times (disksector+512-$) db 0  ; 287
  1337                                  %endif
  1338                                  
  1339                                  ;-----------------------------------------------------------------------------
  1340                                  
  1341                                  ; 30/12/2018 - Retro DOS v4.0
  1342                                  
  1343                                  ; read in boot sector here, read done in readboot.
  1344                                  ; also read sector for dma check for hard disk.
  1345                                  ;
  1346                                  ; This buffer is word aligned because certain AMI BIOSs have a bug
  1347                                  ; in them which causes the byte after the buffer to be trashed
  1348                                  ; on floppy reads to odd-byte boundaries. Although no general effort 
  1349                                  ; is made to enforce this in the bigger picture, this one small sacrifice
  1350                                  ; makes that system more-or-less work.
  1351                                  
  1352                                  ; 02/10/2023
  1353                                  %if 0
  1354                                  
  1355                                  disksector:	;db 512 dup(0)		; read in boot sector here
  1356                                  		; 19/10/2022
  1357                                  		times 512 db 0
  1358                                  %endif
  1359                                  
  1360                                  ;-----------------------------------------------------------------------------
  1361                                  
  1362                                  ; 02/10/2023 - Retro DOS v5.0
  1363                                  ; 30/12/2018 - Retro DOS v4.0
  1364                                  ;-----------------------------------------------------------------------------
  1365                                  ; 25/05/2018 (04/04/2018)
  1366                                  ;*****************************************************************************
  1367                                  ;	"bds" contains information for each drive in the system.
  1368                                  ;	various values are patched whenever actions are performed.
  1369                                  ;	sectors/alloc. unit in bpb initially set to -1 to signify that
  1370                                  ;	the bpb has not been filled. link also set to -1 to signify end
  1371                                  ;	of list. # of cylinders in maxparms initialized to -1 to indicate
  1372                                  ;	that the parameters have not been set.
  1373                                  
  1374                                  bds1:		;dw offset bds2
  1375 00000352 [E803]                  		dw bds2	; 19/10/2022
  1376 00000354 7000                    		dw 70h			; dword	link to	next structure
  1377 00000356 00                      		db 0			; int 13h drive	number
  1378 00000357 00                      		db 0			; logical drive	letter
  1379 00000358 0002                    fdrive1:	dw 512			
  1380                                  					; physical sector size in bytes
  1381 0000035A FF                      		db 0FFh			; sectors/allocation unit
  1382 0000035B 0100                    		dw 1			; reserved sectors for dos
  1383 0000035D 02                      		db 2			; no of	file allocation	tables
  1384 0000035E 4000                    		dw 64			; number of root directory entries
  1385 00000360 6801                    		dw 360			; number sectors (at 512 bytes each)
  1386 00000362 00                      		db 0			; media	descriptor, initially 0
  1387 00000363 0200                    		dw 2			; number of fat	sectors
  1388 00000365 0900                    		dw 9			; sector limit (sectors	per track)
  1389 00000367 0100                    		dw 1			; head limit (number of	heads -	1)
  1390                                  		;
  1391                                  		; 02/10/2023
  1392                                  		; MSDOS 5.0-6.22 (& PCDOS 7.0)
  1393                                  		;dw 0			; hidden sector	count (low word)
  1394                                  		;dw 0			; hidden sector	(high)
  1395                                  		;dw 0			; number sectors (low)
  1396                                  		;dw 0			; number sectors (high)
  1397                                  		;db 0			; true => large	fats
  1398                                  		; 02/10/2023
  1399                                  		; PCDOS 7.1 (FAT32 support)
  1400 00000369 00000000                		dd 0			; hidden sector count
  1401 0000036D 00000000                		dd 0			; number of sectors (32 bit)
  1402 00000371 00000000                		dd 0			; BPB_FATSz32 ; FAT32 FAT size in sectors ; 4 bytes
  1403                                  					;   BS_DrvNum ; FAT INT 13h drive number ; 1 byte
  1404                                  					;   BS_Reserved1 ; FAT reserved byte = 0 ; 1 byte
  1405                                  					;   BS_BootSig ; FAT Extended boot signature = 29h ; 1 byte
  1406                                  					;   BS_VolID ; FAT Volume serial number ; 4 bytes
  1407 00000375 0000                    		dw 0			; BPB_ExtFlags ; FAT32 Extended Flags
  1408 00000377 0000                    		dw 0			; BPB_FSVer ; FAT32 fs/volume version
  1409 00000379 00000000                		dd 0			; BPB_RootClus ; FAT32 root directory's first cluster number
  1410 0000037D FFFF                    		dw 0FFFFh		; BPB_FSInfo ; FAT32 FSINFO sector number = -1 (initial)
  1411 0000037F FFFF                    		dw 0FFFFh		; BPB_BkBootSec ; FAT32 backup boot sector number = -1 (initial)
  1412 00000381 00<rep Ch>              		times 12 db 0		; BPB_Reserved  ; FAT32 reserved field = 0, 12 bytes
  1413 0000038D 00                      		db 0			; true => large	fats
  1414                                  		;
  1415 0000038E 0000                    		dw 0			; open ref. count
  1416 00000390 03                      		db 3			; form factor
  1417 00000391 2000                    		dw 20h			; various flags
  1418 00000393 2800                    		dw 40			; number of cylinders
  1419 00000395 0002                    recommended_bps: dw 512			; recommended bps for this drive
  1420 00000397 01                      		db 1
  1421 00000398 0100                    		dw 1
  1422 0000039A 02                      		db 2
  1423 0000039B E000                    		dw 224			; number of root directory entries
  1424 0000039D 6801                    		dw 360
  1425 0000039F F0                      		db 0F0h			; media	descriptor, initially 0F0h
  1426 000003A0 0200                    		dw 2
  1427 000003A2 0900                    		dw 9
  1428 000003A4 0200                    		dw 2
  1429                                  		;
  1430                                  		; 02/10/2023
  1431                                  		;dw 0
  1432                                  		;dw 0
  1433                                  		;dw 0
  1434                                  		;dw 0
  1435                                  		;;db 6 dup(0)
  1436                                  		;times 6 db 0		; 19/10/2022
  1437 000003A6 00000000                		dd 0
  1438 000003AA 00000000                		dd 0
  1439 000003AE 00000000                		dd 0
  1440 000003B2 0000                    		dw 0
  1441 000003B4 0000                    		dw 0
  1442 000003B6 00000000                		dd 0
  1443 000003BA FFFF                    		dw 0FFFFh
  1444 000003BC FFFF                    		dw 0FFFFh	
  1445                                  		;db 12 dup(0)
  1446 000003BE 00<rep Ch>              		times 12 db 0		; 02/10/2023
  1447                                  		;
  1448 000003CA FF                      		db 0FFh			; last track accessed on this drive
  1449 000003CB FFFF                    		dw 0FFFFh		; keep these two contiguous (?)
  1450 000003CD FFFF                    		dw 0FFFFh
  1451 000003CF 4E4F204E414D452020-     		db 'NO NAME    ',0      ; volume id for this disk
  1451 000003D8 202000             
  1452 000003DB 00000000                		dd 0			; current volume serial	from boot record
  1453 000003DF 464154313220202000      		db 'FAT12   ',0         ; current file system id from boot record
  1454                                  ; ----
  1455                                  
  1456                                  ; 02/10/2023
  1457                                  ; PCDOS 7.1
  1458                                  %if 1
  1459                                  
  1460                                  bds2:		; 02/10/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
  1461 000003E8 FFFF                    		dw 0FFFFh ; -1
  1462 000003EA 7000                    		dw 70h
  1463 000003EC 00                      		db 0
  1464 000003ED 00                      		db 0
  1465 000003EE 0002                    fdrive2:	dw 512
  1466 000003F0 FF                      		db 0FFh
  1467 000003F1 0100                    		dw 1
  1468 000003F3 02                      		db 2
  1469 000003F4 4000                    		dw 64
  1470 000003F6 6801                    		dw 360
  1471 000003F8 00                      		db 0
  1472 000003F9 0200                    		dw 2
  1473 000003FB 0900                    		dw 9
  1474 000003FD 0100                    		dw 1
  1475 000003FF 00000000<rep 5h>        		times 5 dd 0
  1476 00000413 FFFFFFFF                		dd 0FFFFFFFFh
  1477 00000417 00000000<rep 3h>        		times 3 dd 0
  1478 00000423 00                      		db 0
  1479 00000424 0000                    		dw 0
  1480 00000426 03                      		db 3
  1481 00000427 2000                    		dw 20h
  1482 00000429 2800                    		dw 40
  1483                                  recbpb2:
  1484 0000042B 0002                    		dw 512
  1485 0000042D 01                                      db 1
  1486 0000042E 0100                                    dw 1
  1487 00000430 02                                      db 2
  1488 00000431 E000                                    dw 224
  1489 00000433 6801                                    dw 360
  1490 00000435 F0                                      db 0F0h
  1491 00000436 0200                                    dw 2
  1492 00000438 0900                                    dw 9
  1493 0000043A 0200                                    dw 2
  1494 0000043C 00000000<rep 5h>        		times 5 dd 0
  1495 00000450 FFFFFFFF                		dd 0FFFFFFFFh
  1496 00000454 00000000<rep 3h>                        times 3 dd 0
  1497 00000460 FF                                      db 0FFh
  1498 00000461 FFFFFFFF                                dd 0FFFFFFFFh
  1499 00000465 4E4F204E414D452020-                     db 'NO NAME    ',0
  1499 0000046E 202000             
  1500 00000471 00000000                                dd 0
  1501 00000475 464154313220202000                      db 'FAT12   ',0
  1502                                  %endif
  1503                                  
  1504                                  ; ----
  1505                                  
  1506                                  ; 02/10/2023
  1507                                  ; MSDOS 5.0 - 6.22 (& PCDOS 7.0)
  1508                                  %if 0
  1509                                  
  1510                                  bds2:		dw bds3		
  1511                                  		dw 70h
  1512                                  		db 0
  1513                                  		db 0
  1514                                  fdrive2:	dw 512			
  1515                                  		db 0FFh, 1, 0, 2, 40h, 0, 68h, 1, 0, 2,	0, 9, 0, 1, 0
  1516                                  		db 0, 0, 0, 0, 0, 0, 0,	0, 0, 0, 0, 3, 20h, 0, 28h, 0
  1517                                  		db 0, 2, 1, 1, 0, 2, 0E0h, 0, 68h, 1, 0F0h, 2, 0, 9, 0
  1518                                  		db 2, 0, 0, 0, 0, 0, 0,	0, 0, 0, 0, 0, 0, 0, 0,	0, 0FFh
  1519                                  		db 0FFh, 0FFh, 0FFh, 0FFh, 4Eh,	4Fh, 20h, 4Eh, 41h, 4Dh
  1520                                  		db 45h,	20h, 20h, 20h, 20h, 0, 0, 0, 0,	0, 46h,	41h, 54h
  1521                                  		db 31h,	32h, 20h, 20h, 20h, 0
  1522                                  
  1523                                  bds3:		dw bds4		
  1524                                  		dw 70h
  1525                                  		db 0
  1526                                  		db 0
  1527                                  fdrive3:	dw 512			
  1528                                  		db 0FFh, 1, 0, 2, 40h, 0, 68h, 1, 0, 2,	0, 9, 0, 1, 0
  1529                                  		db 0, 0, 0, 0, 0, 0, 0,	0, 0, 0, 0, 3, 20h, 0, 28h, 0
  1530                                  		db 0, 2, 1, 1, 0, 2, 0E0h, 0, 68h, 1, 0F0h, 2, 0, 9, 0
  1531                                  		db 2, 0, 0, 0, 0, 0, 0,	0, 0, 0, 0, 0, 0, 0, 0,	0, 0FFh
  1532                                  		db 0FFh, 0FFh, 0FFh, 0FFh, 4Eh,	4Fh, 20h, 4Eh, 41h, 4Dh
  1533                                  		db 45h,	20h, 20h, 20h, 20h, 0, 0, 0, 0,	0, 46h,	41h, 54h
  1534                                  		db 31h,	32h, 20h, 20h, 20h, 0
  1535                                  ; ----
  1536                                  
  1537                                  bds4:		dw 0FFFFh		
  1538                                  		dw 70h
  1539                                  		db 0
  1540                                  		db 0
  1541                                  fdrive4:	dw 512			
  1542                                  		db 0FFh, 1, 0, 2, 40h, 0, 68h, 1, 0, 2,	0, 9, 0, 1, 0
  1543                                  		db 0, 0, 0, 0, 0, 0, 0,	0, 0, 0, 0, 3, 20h, 0, 28h, 0
  1544                                  		db 0, 2, 1, 1, 0, 2, 0E0h, 0, 68h, 1, 0F0h, 2, 0, 9, 0
  1545                                  		db 2, 0, 0, 0, 0, 0, 0,	0, 0, 0, 0, 0, 0, 0, 0,	0, 0FFh
  1546                                  		db 0FFh, 0FFh, 0FFh, 0FFh, 4Eh,	4Fh, 20h, 4Eh, 41h, 4Dh
  1547                                  		db 45h,	20h, 20h, 20h, 20h, 0, 0, 0, 0,	0, 46h,	41h, 54h
  1548                                  		db 31h,	32h, 20h, 20h, 20h, 0
  1549                                  
  1550                                  ;-----------------------------------------------------------------------------
  1551                                  
  1552                                  sm92:		db 3			; .spf
  1553                                  		db 9			; .spt
  1554                                  		db 112	; 70h		; .cdire
  1555                                  		dw 1440	; 2*9*80	; .csec
  1556                                  		db 2			; .spau
  1557                                  		db 2			; .chead
  1558                                  
  1559                                  %endif
  1560                                  
  1561 0000047E 00                      keyrd_func:	db 0			
  1562 0000047F 01                      keysts_func:	db 1			
  1563 00000480 00                      printdev:	db 0			; printer device index
  1564                                  
  1565                                  wait_count:	;dw 4 dup(50h)		; retry	counts for printers
  1566 00000481 5000<rep 4h>            		times 4 dw 50h		; 19/10/2022
  1567                                  
  1568 00000489 0000                    daycnt:		dw 0			
  1569 0000048B 00                      t_switch:	db 0			; flag for updating daycnt
  1570 0000048C 00                      havecmosclock:	db 0			
  1571 0000048D 13                      base_century:	db 19			
  1572 0000048E 50                      base_year:	db 80			
  1573                                  
  1574 0000048F 1F                      month_tab:	db 31
  1575 00000490 1C                      february:	db 28 ; 08/08/2023
  1576 00000491 1F1E1F1E1F1F1E1F1E-     		db 31, 30, 31, 30, 31, 31, 30, 31, 30, 31
  1576 0000049A 1F                 
  1577                                  
  1578                                  ; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  1579                                  %if 0  
  1580                                  bintobcd:	dw bin_to_bcd		; points to bin_to_bcd proc in msinit
  1581                                  		dw 70h ; 17/10/2022	
  1582                                  daycnttoday:	dw daycnt_to_day	; points to daycnt_to_day in msinit
  1583                                  		dw 70h ; 17/10/2022
  1584                                  %endif
  1585 0000049B 00                      set_id_flag:	db 0			; flag for getbp routine
  1586                                  
  1587                                  ; 02/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  1588                                  ;fat_12_id:	db 'FAT12   ',0         
  1589                                  ;fat_16_id:	db 'FAT16   ',0         
  1590                                  ;vol_no_name:	db 'NO NAME    ',0      
  1591                                  ;temp_h:	dw 0			; temporary for	32 bit calculation
  1592                                  
  1593 0000049C 0000                    start_sec_h:	dw 0			; starting sector number high word
  1594 0000049E 0000                    saved_word:	dw 0			; tempory saving place for a word
  1595 000004A0 0000                    multrk_flag:	dw 0			
  1596 000004A2 00                      ec35flag:	db 0			; flags	for 3.5	inch disk drives
  1597 000004A3 0000                    vretry_cnt:	dw 0			
  1598 000004A5 0000                    soft_ecc_cnt:	dw 0			
  1599 000004A7 00                      multitrk_format_flag: db 0		; multi	track format request flag
  1600 000004A8 0000                    xfer_seg:	dw 0			; temp for transfer segment
  1601                                  
  1602                                  ; variables for msdioctl.asm module
  1603                                  
  1604                                  ; tracktable contains a 4-tuples (c,h,r,n) for each sector in a track
  1605                                  ; c = cylinder number,h = head number,r = sector id,n = bytes per sector
  1606                                  ;	n	bytes per sector
  1607                                  ;      ---	----------------
  1608                                  ;	0	      128
  1609                                  ;	1	      256
  1610                                  ;	2	      512
  1611                                  ;	3	     1024
  1612                                  
  1613                                  ;max_sectors_curr_sup equ 63		; current maximum sec/trk that
  1614                                  ;					; we support (was 40 in dos 3.2)
  1615                                  
  1616 000004AA 2400                    sectorspertrack: dw 36			
  1617 000004AC 00000102                tracktable:	db 0, 0, 1, 2		
  1618 000004B0 00000202                		db 0, 0, 2, 2
  1619 000004B4 00000302                		db 0, 0, 3, 2
  1620 000004B8 00000402                		db 0, 0, 4, 2
  1621 000004BC 00000502                		db 0, 0, 5, 2
  1622 000004C0 00000602                		db 0, 0, 6, 2
  1623 000004C4 00000702                		db 0, 0, 7, 2
  1624 000004C8 00000802                		db 0, 0, 8, 2
  1625 000004CC 00000902                		db 0, 0, 9, 2
  1626 000004D0 00000A02                		db 0, 0, 10, 2
  1627 000004D4 00000B02                		db 0, 0, 11, 2
  1628 000004D8 00000C02                		db 0, 0, 12, 2
  1629 000004DC 00000D02                		db 0, 0, 13, 2
  1630 000004E0 00000E02                		db 0, 0, 14, 2
  1631 000004E4 00000F02                		db 0, 0, 15, 2
  1632 000004E8 00001002                		db 0, 0, 16, 2
  1633 000004EC 00001102                		db 0, 0, 17, 2
  1634 000004F0 00001202                		db 0, 0, 18, 2
  1635 000004F4 00001302                		db 0, 0, 19, 2
  1636 000004F8 00001402                		db 0, 0, 20, 2
  1637 000004FC 00001502                		db 0, 0, 21, 2
  1638 00000500 00001602                		db 0, 0, 22, 2
  1639 00000504 00001702                		db 0, 0, 23, 2
  1640 00000508 00001802                		db 0, 0, 24, 2
  1641 0000050C 00001902                		db 0, 0, 25, 2
  1642 00000510 00001A02                		db 0, 0, 26, 2
  1643 00000514 00001B02                		db 0, 0, 27, 2
  1644 00000518 00001C02                		db 0, 0, 28, 2
  1645 0000051C 00001D02                		db 0, 0, 29, 2
  1646 00000520 00001E02                		db 0, 0, 30, 2
  1647 00000524 00001F02                		db 0, 0, 31, 2
  1648 00000528 00002002                		db 0, 0, 32, 2
  1649 0000052C 00002102                		db 0, 0, 33, 2
  1650 00000530 00002202                		db 0, 0, 34, 2
  1651 00000534 00002302                		db 0, 0, 35, 2
  1652 00000538 00002402                		db 0, 0, 36, 2
  1653                                  
  1654                                  ; 02/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  1655                                  ; PCDOS 7.1 IBMBIO.COM - BIOSDATA:053Ch
  1656                                  
  1657                                  		;times 108 db 0		; 19/10/2022
  1658                                  		;;db 108 dup(0)		; 4*max_sectors_curr_sup - ($ -	tracktable) dup	(0)
  1659                                  					; times	((4*63)	- 144) db 0
  1660                                  dskdrvs:	
  1661 0000053C [5803]                  		dw fdrive1
  1662 0000053E [EE03]                  		dw fdrive2 
  1663                                  	
  1664                                  		;dw 52 dup(0)
  1665 00000540 00<rep 68h>             		times 104 db 0		; times (((4*63)-144)-4) db 0
  1666                                  					; 4*max_sectors_curr_sup-($-tracktable)-4 dup (0)			
  1667                                  
  1668                                  ;-----------------------------------------------------------------------------
  1669                                  
  1670                                  ; this is a real ugly place to put this
  1671                                  ; it should really go in the bds
  1672                                  
  1673 000005A8 00                      mediatype:	db 0			
  1674 000005A9 00                      media_set_for_format: db 0		; 1 if we have done an int 13h set media
  1675                                  					; type for format call
  1676 000005AA 00                      had_format_error: db 0			; 1 if the previous format operation
  1677                                  					; failed.
  1678                                  
  1679                                  ; temp disk base table. it holds the the current dpt which is then replaced by
  1680                                  ; the one passed by "new roms" before we perform a format operation. the old
  1681                                  ; dpt is restored in restoreolddpt. the first entry (disk_specify_1) is -1 if
  1682                                  ; this table does not contain the previously saved dpt.
  1683                                  		
  1684 000005AB FFFFFFFF                tempdpt:	dd 0FFFFFFFFh ; -1	; temp disk base table
  1685 000005AF FF                      model_byte:	db 0FFh			; model	byte set at init time
  1686 000005B0 00                      secondary_model_byte: db 0
  1687                                  		
  1688 000005B1 00                      int19sem:	db 0			; indicate that all int 19h
  1689                                  					; initialization is complete
  1690                                  		
  1691                                  ;; we assume the following remain contiguous and their order doesn't change
  1692                                  ;i19_lst:
  1693                                  ;	irp	aa,<02,08,09,0a,0b,0c,0d,0e,70,72,73,74,76,77>
  1694                                  ;	public	int19old&aa
  1695                                  ;		db	aa&h	; store the number as a byte
  1696                                  ;int19old&aa	dd	-1	; original hardware int. vectors for int 19h.
  1697                                  ;	endm
  1698                                  
  1699                                  ; 21/10/2022
  1700                                  
  1701 000005B2 02                      i19_lst:	db 2			
  1702                                  					; Int19old&aa
  1703 000005B3 FFFFFFFF                int19old02:	dd 0FFFFFFFFh ; -1
  1704 000005B7 08                      		db 8
  1705 000005B8 FFFFFFFF                int19old08:	dd 0FFFFFFFFh		; original hardware int. vectors for int 19h
  1706 000005BC 09                      		db 9
  1707 000005BD FFFFFFFF                int19old09:	dd 0FFFFFFFFh
  1708 000005C1 0A                      		db 0Ah
  1709 000005C2 FFFFFFFF                int19old0A:	dd 0FFFFFFFFh
  1710 000005C6 0B                      		db 0Bh
  1711 000005C7 FFFFFFFF                int19old0B:	dd 0FFFFFFFFh
  1712 000005CB 0C                      		db 0Ch
  1713 000005CC FFFFFFFF                int19old0C:	dd 0FFFFFFFFh
  1714 000005D0 0D                      		db 0Dh
  1715 000005D1 FFFFFFFF                int19old0D:	dd 0FFFFFFFFh
  1716 000005D5 0E                      		db 0Eh
  1717 000005D6 FFFFFFFF                int19old0E:	dd 0FFFFFFFFh
  1718 000005DA 70                      		db 70h
  1719 000005DB FFFFFFFF                int19old70:	dd 0FFFFFFFFh
  1720 000005DF 72                      		db 72h
  1721 000005E0 FFFFFFFF                int19old72:	dd 0FFFFFFFFh
  1722 000005E4 73                      		db 73h
  1723 000005E5 FFFFFFFF                int19old73:	dd 0FFFFFFFFh
  1724 000005E9 74                      		db 74h
  1725 000005EA FFFFFFFF                int19old74:	dd 0FFFFFFFFh
  1726 000005EE 76                      		db 76h
  1727 000005EF FFFFFFFF                int19old76:	dd 0FFFFFFFFh
  1728 000005F3 77                      		db 77h
  1729 000005F4 FFFFFFFF                int19old77:	dd 0FFFFFFFFh
  1730                                  
  1731                                  ;num_i19	equ ($ - i19_lst)/5  ; 18/03/2019
  1732                                  
  1733                                  ;-----------------------------------------------------------------------------
  1734                                  
  1735                                  ; 02/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  1736                                  ; 
  1737                                  ;dskdrvs:	dw fdrive1	
  1738                                  ;		dw fdrive2
  1739                                  ;		dw fdrive3
  1740                                  ;		dw fdrive4
  1741                                  ;
  1742                                  ;;M011 -- made all hard drive stuff variable
  1743                                  ;		;dw 22 dup(0)		; up to	26 drives for mini disks
  1744                                  ;		times 22 dw 0	; 19/10/2022
  1745                                  
  1746                                  ;-----------------------------------------------------------------------------
  1747                                  
  1748                                  ; 01/10/2022 - Retro DOS v4.0 (MSDOS v5.0 -actual-)
  1749                                  ; 30/12/2018 - Retro DOS v4.0 (MSDOS v6.21 -draft-)
  1750                                  ; 01/06/2018 - Retro DOS v3.0 (MSDOS v3.3)
  1751                                  
  1752                                  ;variables for dynamic relocatable modules
  1753                                  ;these should be stay resident.
  1754                                  
  1755 000005F8 00000000                int6c_ret_addr:	dd 0			; return address from int 6Ch
  1756                                  					; for p12 machine
  1757                                  
  1758                                  ; data structures for real-time date and time
  1759                                  			
  1760 000005FC 00000000                bin_date_time:	db 0, 0, 0, 0		; century, year, month,	day
  1761                                  
  1762                                  ; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  1763                                  %if 0
  1764                                  month_table:	dw 0			; january
  1765                                  		dw 31			; february
  1766                                  		dw 59
  1767                                  		dw 90
  1768                                  		dw 120
  1769                                  		dw 151
  1770                                  		dw 181
  1771                                  		dw 212
  1772                                  		dw 243
  1773                                  		dw 273
  1774                                  		dw 304
  1775                                  		dw 334			; december
  1776                                  %endif
  1777                                  
  1778 00000600 0000                    daycnt2:	dw 0			
  1779                                  ; 08/08/2023
  1780                                  ;feb29:		db 0			; february 29 in a leap	year flag
  1781                                  
  1782                                  ;-----------------------------------------------------------------------------
  1783                                  ;
  1784                                  ; 01/10/2022 - (New/Actual) Retro DOS v4.0 (will run as MSDOS 5.0)	
  1785                                  ; by Erdogan Tan (Istanbul) ! free source code !
  1786                                  ; 31/12/2018 - (old/draft) Retro DOS v4.0 (will/would run as MSDOS 6.21)
  1787                                  
  1788                                  ; ----------------------------------------------------------------------------
  1789                                  
  1790                                  ;************************************************************************
  1791                                  ;*									*
  1792                                  ;*	Entry points into Bios_Code routines. The segment values	*
  1793                                  ;*	  are plugged in by seg_reinit.					*
  1794                                  ;*									*
  1795                                  ;************************************************************************
  1796                                  
  1797                                  ; 01/10/2022 - Retro DOS v4.0 - IO.SYS (MSDOS v5.0)
  1798                                  ; BIOSCODE_SEGMENT equ 2C7h
  1799                                  ; BIOSDATA_SEGMENT equ 70h ; KERNEL_SEGMENT equ 70h
  1800                                  
  1801                                  ; 01/10/2022 - Erdogan Tan
  1802                                  ; (disassembled MSDOS 5.0 IO.SYS code here with fixed function/routine
  1803                                  ;  addresses, they will be changed to table labels later)
  1804                                  
  1805                                  ; 09/12/2022
  1806                                  %if 0
  1807                                  cdev:		dw 43h,	2C7h		; chardev_entry
  1808                                  					; at 2C7h:43h =	70h:25B3h
  1809                                  ttticks:	dw 396h, 2C7h		; time_to_ticks
  1810                                  					; at 2C7h:396h = 70h:2906h
  1811                                  bcode_i2f:	dw 1302h, 2C7h		; i2f_handler
  1812                                  					; at 2C7h:1302h	= 70h:3872h
  1813                                  i13x:		dw 154Bh, 2C7h		; i13z
  1814                                  					; at 2C7h:154Bh	= 70h:3ABBh
  1815                                  %endif
  1816                                  
  1817                                  ; 30/12/2022
  1818                                  ; (IOSYSCODESEG is 2CCh for MSDOS 6.21 IO.SYS)
  1819                                  
  1820                                  ; 02/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  1821                                  ; PCDOS 7.1 IBMBIO.COM - BIOSDATA:0602h
  1822                                  ; (IOSYSCODESEG is 364h for PCDOS 7.1 IBMBIO.COM)
  1823                                  
  1824                                  ; 09/12/2022
  1825 00000602 [4700]FF02              cdev:		dw chardev_entry, IOSYSCODESEG
  1826 00000606 [A003]FF02              ttticks:	dw time_to_ticks, IOSYSCODESEG
  1827                                  ; 07/08/2023
  1828                                  ;bcode_i2f:	dw i2f_handler, IOSYSCODESEG
  1829 0000060A [5B18]FF02              i13x:		dw i13z, IOSYSCODESEG
  1830                                  
  1831                                  end_BC_entries:	; 15/10/2022
  1832                                  
  1833                                  ;************************************************************************
  1834                                  ;*									*
  1835                                  ;*	cbreak - break key handling - simply set altah=3 and iret	*
  1836                                  ;*									*
  1837                                  ;************************************************************************
  1838                                  
  1839                                  cbreak:					
  1840 0000060E 2EC606[0C00]03          		mov	byte [cs:altah], 3 ; break key handling
  1841                                  					; indicate break key set
  1842                                  intret:					
  1843 00000614 CF                      		iret
  1844                                  
  1845                                  ; =============== S U B	R O U T	I N E ========================================
  1846                                  
  1847                                  
  1848                                  ;************************************************************************
  1849                                  ;*									*
  1850                                  ;*	strategy - store es:bx (device driver request packet)		*
  1851                                  ;*		     away at [ptrsav] for next driver function call	*
  1852                                  ;*									*
  1853                                  ;************************************************************************
  1854                                  
  1855                                  strategy:	; proc far		
  1856 00000615 2E891E[1200]            		mov	[cs:ptrsav], bx ; store es:bx (device driver request packet)
  1857                                  					; away at [ptrsav] for next driver function call
  1858 0000061A 2E8C06[1400]            		mov	[cs:ptrsav+2], es
  1859 0000061F CB                      		retf
  1860                                  
  1861                                  ; ----------------------------------------------------------------------------
  1862                                  
  1863                                  ;************************************************************************
  1864                                  ;*									*
  1865                                  ;*	device driver entry points. these are the initial		*
  1866                                  ;*	  'interrupt' hooks out of the device driver chain.		*
  1867                                  ;*	  in the case of our resident drivers, they'll just		*
  1868                                  ;*	  stick a fake return address on the stack which		*
  1869                                  ;*	  points to dispatch tables and possibly some unit		*
  1870                                  ;*	  numbers, and then call through a common entry point		*
  1871                                  ;*	  which can take care of a20 switching				*
  1872                                  ;*									*
  1873                                  ;************************************************************************
  1874                                  
  1875                                  ; 01/10/2022 - Erdogan Tan
  1876                                  ; (disassembled MSDOS 5.0 IO.SYS code here with fixed table
  1877                                  ;  addresses, they will be changed to table labels later)
  1878                                  
  1879                                  ; 09/12/2022
  1880                                  
  1881                                  ; 02/10/2023 - Retro DOS v5.0
  1882                                  ; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:0620h, BIOSCODE = 0364h)
  1883                                  
  1884                                  con_entry:				
  1885 00000620 E84000                  		call	cdev_entry
  1886                                  ; ----------------------------------------------------------------------------
  1887                                  		;dw 0E4h		; con_table
  1888 00000623 [E400]                  		dw con_table		; 364h:0E4h (PCDOS 7.1)
  1889                                  					; 2C7h:0E4h = 70h:2654h
  1890                                  ; ----------------------------------------------------------------------------
  1891                                  
  1892                                  prn0_entry:				
  1893 00000625 E83B00                  		call	cdev_entry
  1894                                  ; ----------------------------------------------------------------------------
  1895                                  		;dw 0FBh		; prn_table
  1896 00000628 [FB00]                  		dw prn_table
  1897                                  					; 2C7h:0FBh = 70h:266Bh
  1898 0000062A 0000                    		db 0, 0
  1899                                  ; ----------------------------------------------------------------------------
  1900                                  
  1901                                  prn1_entry:				
  1902 0000062C E83400                  		call	cdev_entry
  1903                                  ; ----------------------------------------------------------------------------
  1904                                  		;dw 0FBh		; prn_table
  1905 0000062F [FB00]                  		dw prn_table
  1906                                  					; 2C7h:0FBh = 70h:266Bh
  1907 00000631 0001                    		db 0, 1
  1908                                  ; ----------------------------------------------------------------------------
  1909                                  
  1910                                  prn2_entry:				
  1911 00000633 E82D00                  		call	cdev_entry
  1912                                  ; ----------------------------------------------------------------------------
  1913                                  		;dw 0FBh		; prn_table
  1914 00000636 [FB00]                  		dw prn_table
  1915                                  					; 2C7h:0FBh = 70h:266Bh
  1916 00000638 0102                    		db 1, 2
  1917                                  ; ----------------------------------------------------------------------------
  1918                                  
  1919                                  prn3_entry:				
  1920 0000063A E82600                  		call	cdev_entry
  1921                                  ; ----------------------------------------------------------------------------
  1922                                  		;dw 0FBh		; prn_table
  1923 0000063D [FB00]                  		dw prn_table
  1924                                  					; 2C7h:0FBh = 70h:266Bh
  1925 0000063F 0203                    		db 2, 3
  1926                                  ; ----------------------------------------------------------------------------
  1927                                  
  1928                                  aux0_entry:				
  1929 00000641 E81F00                  		call	cdev_entry
  1930                                  ; ----------------------------------------------------------------------------
  1931                                  		;dw 130h		; aux_table
  1932 00000644 [3001]                  		dw aux_table
  1933                                  					; 2C7h:130h = 70h:26A0h
  1934 00000646 00                      		db 0
  1935                                  ; ----------------------------------------------------------------------------
  1936                                  
  1937                                  aux1_entry:				
  1938 00000647 E81900                  		call	cdev_entry
  1939                                  ; ----------------------------------------------------------------------------
  1940                                  		;dw 130h		; aux_table
  1941 0000064A [3001]                  		dw aux_table		; 364h:130h = 70h:3070h (PCDOS 7.1)
  1942                                  					; 2C7h:130h = 70h:26A0h
  1943 0000064C 01                      		db 1
  1944                                  ; ----------------------------------------------------------------------------
  1945                                  
  1946                                  aux2_entry:				
  1947 0000064D E81300                  		call	cdev_entry
  1948                                  ; ----------------------------------------------------------------------------
  1949                                  		;dw 130h		; aux_table
  1950 00000650 [3001]                  		dw aux_table
  1951                                  					; 2C7h:130h = 70h:26A0h
  1952 00000652 02                      		db 2
  1953                                  ; ----------------------------------------------------------------------------
  1954                                  
  1955                                  aux3_entry:				
  1956 00000653 E80D00                  		call	cdev_entry
  1957                                  ; ----------------------------------------------------------------------------
  1958                                  		;dw 130h		; aux_table
  1959 00000656 [3001]                  		dw aux_table
  1960                                  					; 2C7h:130h = 70h:26A0h
  1961 00000658 03                      		db 3
  1962                                  ; ----------------------------------------------------------------------------
  1963                                  
  1964                                  tim_entry:				
  1965 00000659 E80700                  		call	cdev_entry
  1966                                  ; ----------------------------------------------------------------------------
  1967                                  		;dw 147h		; tim_table
  1968 0000065C [4701]                  		dw tim_table		; 364h:147h = 70h:3087h (PCDOS 7.1)
  1969                                  					; 2C7h:147h = 70h:26B7h
  1970                                  ; ----------------------------------------------------------------------------
  1971                                  
  1972                                  ; 15/10/2022
  1973                                  ;DSKTBL	equ dsktbl - DOSBIOSEG_2C7h	; dsktbl - 2C70h
  1974                                  ; 09/12/2022
  1975                                  DSKTBL equ dsktbl
  1976                                  
  1977                                  dsk_entry:				
  1978 0000065E E80200                  		call	cdev_entry
  1979                                  ; ----------------------------------------------------------------------------
  1980                                  		;dw 4A2h		; dsktbl
  1981 00000661 [6F05]                  		dw DSKTBL		; 09/12/2022
  1982                                  					; 2C7h:4A2h = 70h:2A12h
  1983                                  					; 02/10/2023 (PCDOS 7.1 IBMBIO.COM)
  1984                                  					; 364h:579h = 70h:34B9h
  1985                                  
  1986                                  ; =============== S U B	R O U T	I N E ========================================
  1987                                  
  1988                                  ;************************************************************************
  1989                                  ;*									*
  1990                                  ;*	Ensure A20 is enabled before jumping into code in HMA.		*
  1991                                  ;*	This code assumes that if Segment of Device request packet is	*
  1992                                  ;*	DOS DATA segment then the Device request came from DOS & that	*
  1993                                  ;*	A20 is already on.						*
  1994                                  ;*									*
  1995                                  ;************************************************************************
  1996                                  
  1997                                  cdev_entry:	; proc near		
  1998 00000663 2E803E[0D00]00          		cmp	byte [cs:inHMA],0
  1999 00000669 740D                    		jz	short ce_enter_codeseg
  2000                                  				; optimized for DOS in HMA
  2001 0000066B 50                      		push	ax
  2002 0000066C 2EA1[0300]              		mov	ax,[cs:DosDataSg]
  2003 00000670 2E3906[1400]            		cmp	[cs:ptrsav+2],ax
  2004 00000675 58                      		pop	ax
  2005 00000676 7505                    		jnz	short not_from_dos
  2006                                  				; jump is coded this way to fall thru
  2007                                  				; in 99.99% of the cases
  2008                                  ce_enter_codeseg:
  2009 00000678 2EFF2E[0206]            		jmp	far [cs:cdev]			
  2010                                  		;jmp	dword ptr cs:cdev
  2011                                  ;-----------------------------------------------------------------------------
  2012                                  
  2013                                  not_from_dos:				
  2014 0000067D E8AA00                  		call	EnsureA20On
  2015 00000680 EBF6                    		jmp	short ce_enter_codeseg
  2016                                  
  2017                                  ;************************************************************************
  2018                                  ;*									*
  2019                                  ;*	outchr - this is our int 29h handler. it writes the		*
  2020                                  ;*	   character in al on the display using int 10h ttywrite	*
  2021                                  ;*									*
  2022                                  ;************************************************************************
  2023                                  
  2024                                  	; 02/10/2023
  2025                                  	; PCDOS 7.1 IBMBIO.COM - BIOSDATA:0682h
  2026                                  outchr:					
  2027 00000682 50                      		push	ax		; int 29h handler
  2028 00000683 56                      		push	si
  2029 00000684 57                      		push	di
  2030 00000685 55                      		push	bp
  2031 00000686 53                      		push	bx
  2032                                  		;;;
  2033                                  		; 02/10/2023 - Retro DOS v5.0 (Modified POCDOS 7.1) 
  2034                                  		;mov	ah,0Eh
  2035                                  		;mov	bx,7
  2036                                  		;int	10h	; - VIDEO - WRITE CHARACTER AND	ADVANCE	CURSOR (TTY WRITE)
  2037                                  		;		; AL = character, BH = display page (alpha modes)
  2038                                  		;		; BL = foreground color	(graphics modes)
  2039                                  		; 02/10/2023
  2040                                  		;push	ds ; *
  2041 00000687 31DB                    		xor	bx,bx ; 0
  2042 00000689 2E381E[1208]            		cmp	[cs:IsWin386], bl ; (are we in) Windows ?
  2043 0000068E 7510                    		jnz	short win_outchr ; *
  2044 00000690 1E                      		push	ds ; *
  2045 00000691 8EDB                    		mov	ds,bx ; 0
  2046 00000693 B40E                    		mov	ah,0Eh
  2047 00000695 B307                    		mov	bl,7
  2048                                  		;jnz	short win_outchr ; Running on Windows
  2049 00000697 9C                      		pushf			; far call (simulate INT)	
  2050 00000698 FA                      		cli	; disable interrupts
  2051 00000699 FF1E4000                		call	far [40h]	; far call to INT 10h vector
  2052 0000069D 1F                      		pop	ds ; *
  2053 0000069E EB02                    		jmp	short outchr_ok
  2054                                  win_outchr:
  2055 000006A0 CD10                    		int	10h
  2056                                  outchr_ok:
  2057                                  		;pop	ds ; *
  2058                                  		;;;
  2059 000006A2 5B                      		pop	bx
  2060 000006A3 5D                      		pop	bp
  2061 000006A4 5F                      		pop	di
  2062 000006A5 5E                      		pop	si
  2063 000006A6 58                      		pop	ax
  2064 000006A7 CF                      		iret
  2065                                  
  2066                                  ;-----------------------------------------------------------------------------
  2067                                  
  2068                                  	; 02/10/2023 - Retro DOS v5.0
  2069                                  	; PCDOS 7.1 IBMBIO.COM - BIOSDATA:06A8h
  2070                                  
  2071 000006A8 50                      		db 50h ; P		; 'PCI' signature
  2072 000006A9 43                      		db 43h ; C
  2073 000006AA 49                      		db 49h ; I
  2074                                  
  2075 000006AB 00000000                Orig1A:		dd 0
  2076                                  
  2077                                  ; =============== S U B R O U T I N E =======================================
  2078                                  
  2079                                  	; 02/10/2023 - Retro DOS v5.0
  2080                                  	; PCDOS 7.1 IBMBIO.COM - BIOSDATA:06AFh
  2081                                  
  2082                                  Int1A:
  2083 000006AF 80FC04                  		cmp	ah,4		; (Y2K-fix)
  2084 000006B2 7405                    		je	short int1a_1	; Read the date from the computer's real-time clock
  2085 000006B4 2EFF2E[AB06]            		jmp	far [cs:Orig1A]
  2086                                  int1a_1:
  2087 000006B9 55                      		push	bp
  2088                                  int1a_2:
  2089 000006BA 89E5                    		mov	bp,sp
  2090 000006BC 55                      		push	bp
  2091 000006BD 9C                      		pushf
  2092 000006BE 2EFF1E[AB06]            		call	far [cs:Orig1A]
  2093 000006C3 7220                    		jc	short int1a_4
  2094                                  
  2095                                  		;cmp	cl,0		; Year (BCD)
  2096                                  		; 02/10/2023
  2097 000006C5 08C9                    		or	cl,cl
  2098 000006C7 7515                    		jnz	short int1a_3
  2099 000006C9 80FD19                  		cmp	ch,19h		; Century (BCD)
  2100 000006CC 7510                    		jne	short int1a_3
  2101 000006CE B520                    		mov	ch,20h
  2102 000006D0 B405                    		mov	ah,5		; Set the date on the computer's real-time clock
  2103 000006D2 51                        		push	cx
  2104 000006D3 52                      		push	dx		; dh = Month (BCD), dl = Day (BCD)
  2105 000006D4 9C                      		pushf
  2106 000006D5 2EFF1E[AB06]            		call	far [cs:Orig1A]
  2107 000006DA 5A                      		pop	dx
  2108 000006DB 59                      		pop	cx
  2109 000006DC 7207                    		jc	short int1a_4
  2110                                  int1a_3:
  2111 000006DE 5D                      		pop	bp
  2112 000006DF 806606FE                		and	byte [bp+6],0FEh ; clear carry flag
  2113 000006E3 EB05                                    jmp	short int1a_5
  2114                                  int1a_4:
  2115 000006E5 5D                      		pop	bp
  2116 000006E6 804E0601                		or	byte [bp+6],1	; set carry flag
  2117                                  int1a_5:
  2118 000006EA 5D                      		pop	bp
  2119 000006EB CF                      		iret
  2120                                  
  2121                                  		; 02/10/2023
  2122 000006EC 90                      		nop	; (not necessary, i have used this 'nop' to locate 'block13:'
  2123                                  			; at BIOSDATA:06EDh, just as in the original PCDOS 7.1 IBMBIO.COM)
  2124                                  	
  2125                                  ;-----------------------------------------------------------------------------
  2126                                  
  2127                                  ;************************************************************************
  2128                                  ;*									*
  2129                                  ;*	block13 - our int13 hooker					*
  2130                                  ;*									*
  2131                                  ;************************************************************************
  2132                                  
  2133                                  	; 02/10/2023 - Retro DOS v5.0
  2134                                  	; PCDOS 7.1 IBMBIO.COM - BIOSDATA:06EDh
  2135                                  
  2136                                  block13:				
  2137 000006ED 2E803E[0D00]00          		cmp	byte [cs:inHMA],0
  2138 000006F3 7403                    		jz	short skipa20
  2139                                  		
  2140                                  		;call	IsA20Off	; A20 Off?
  2141                                  		;jnz	short skipa20
  2142                                  		;call	EnableA20	; assure a20 enabled
  2143                                  		; 02/10/2023 -  Retro DOS v5.0 (Modified PCDOS 7.1)
  2144 000006F5 E83200                  		call	EnsureA20On	; assure a20 enabled
  2145                                  skipa20:				
  2146 000006F8 2E8C1E[1C00]            		mov	[cs:i13_ds],ds	; save caller's ds for call-through
  2147 000006FD 9C                      		pushf			; fake interrupt
  2148 000006FE 2EFF1E[0A06]            		call	far [cs:i13x]
  2149                                  		;call	dword ptr cs:i13x
  2150                                  					; call through Bios_Code entry table
  2151 00000703 2E8E1E[1C00]            		mov	ds,[cs:i13_ds]
  2152 00000708 CA0200                  		retf	2
  2153                                  
  2154                                  ; =============== S U B	R O U T	I N E =======================================
  2155                                  
  2156                                  ; the int13 hook calls back here to call-through to the ROM
  2157                                  ; this is necessary because some people have extended their
  2158                                  ; ROM BIOSs to use ds as a parameter/result register and
  2159                                  ; our int13 hook relies heavily on ds to access Bios_Data
  2160                                  
  2161                                  call_orig13:	; proc far		
  2162 0000070B 8E1E[1C00]              		mov	ds,[i13_ds]	; get caller's ds register
  2163 0000070F 9C                      		pushf			; simulate an int13
  2164 00000710 2EFF1E[B400]            		call	far [cs:Orig13]
  2165                                  		;call	cs:Orig13
  2166 00000715 2E8C1E[1C00]            		mov	[cs:i13_ds],ds
  2167 0000071A 0E                      		push	cs
  2168 0000071B 1F                      		pop	ds		; restore ds ->	Bios_Data before return
  2169                                  
  2170 0000071C 9C                      		pushf
  2171                                  		; 10/12/2022
  2172                                  		; ds = cs
  2173 0000071D 803E[0D00]00            		cmp	byte [inHMA],0	; 16/10/2022
  2174                                  		;cmp	byte [cs:inHMA],0
  2175 00000722 7403                    		jz	short corig13_popf_retf
  2176                                  		; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  2177                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:0725h	
  2178                                  		;call	IsA20Off
  2179                                  		;jnz	short corig13_popf_retf
  2180                                  		;call	EnableA20
  2181 00000724 E80300                  		call	EnsureA20On ; 07/08/2023
  2182                                  corig13_popf_retf:	
  2183 00000727 9D                      		popf
  2184                                  		; 20/09/2023
  2185                                  re_init:	; 07/08/2023
  2186 00000728 CB                      		retf
  2187                                  
  2188                                  		; 02/10/2023
  2189 00000729 90                      		nop	; (not necessary, i have used this 'nop' to locate 'EnsureA20On:'
  2190                                  			; at BIOSDATA:072Ah, just as in the original PCDOS 7.1 IBMBIO.COM)
  2191                                  
  2192                                  ;-----------------------------------------------------------------------------
  2193                                  
  2194                                  ; BIOSDATA:07BBh (MSDOS 6.21, IO.SYS)
  2195                                  ; BIOSDATA:07BBh (MSDOS 5.0, IO.SYS) ; 16/10/2022
  2196                                  
  2197                                  ; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  2198                                  ;HiMem:		dd 0FFFF0090h		
  2199                                  ;LoMem:		dd 80h
  2200                                  
  2201                                  ; ----------------------------------------------------------------------------			
  2202                                  
  2203                                  ; =============== S U B	R O U T	I N E ========================================
  2204                                  
  2205                                  
  2206                                  ;************************************************************************
  2207                                  ;*									*
  2208                                  ;*	EnsureA20On - ensure that a20 is enabled if we're running	*
  2209                                  ;*	  in the HMA before interrupt entry points into Bios_Code	*
  2210                                  ;*									*
  2211                                  ;************************************************************************
  2212                                  
  2213                                  EnsureA20On:	; proc near		
  2214 0000072A E80E00                  		call	IsA20Off
  2215                                  		;jz	short EnableA20
  2216                                  		;retn
  2217                                  		; 18/12/2022
  2218 0000072D 750B                    		jnz	short A20On_retn	
  2219                                  
  2220                                  ; =============== S U B	R O U T	I N E ========================================
  2221                                  
  2222                                  
  2223                                  EnableA20:	; proc near		
  2224 0000072F 50                      		push	ax
  2225 00000730 53                      		push	bx
  2226 00000731 B405                    		mov	ah,5	 ; local enable a20
  2227                                  		;call	cs:xms
  2228 00000733 2EFF1E[0E00]            		call	far [cs:xms] ; 16/10/2022
  2229 00000738 5B                      		pop	bx
  2230 00000739 58                      		pop	ax
  2231                                  A20On_retn:	; 18/12/2022	
  2232 0000073A C3                      		retn
  2233                                  
  2234                                  ; =============== S U B	R O U T	I N E ========================================
  2235                                  
  2236                                  
  2237                                  IsA20Off:	; proc near		
  2238 0000073B 1E                      		push	ds
  2239 0000073C 06                      		push	es
  2240 0000073D 51                      		push	cx
  2241 0000073E 56                      		push	si
  2242 0000073F 57                      		push	di
  2243                                  		; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  2244                                  		;lds	si,[cs:HiMem]
  2245                                  		;les	di,[cs:LoMem]
  2246                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:0740h
  2247 00000740 31FF                    		xor	di,di
  2248 00000742 8EC7                    		mov	es,di
  2249 00000744 4F                      		dec	di
  2250 00000745 BE9000                  		mov	si,90h	; 0FFFFh:0090h ; HiMem
  2251 00000748 8EDF                    		mov	ds,di
  2252 0000074A BF8000                  		mov	di,80h	; 0000h:0080h ; LoMem
  2253                                  		; 02/10/2023 - Retro DOS v5.0 IBMBIO.COM (PCDOS 7.1)
  2254                                  		; (following cpu instructions will be modified by 'SYSIN'
  2255                                  		; if the cpu is a 386/32bit, for checking A20 line faster) 
  2256                                  cpu386_cmpsd:
  2257 0000074D 90                      		nop
  2258 0000074E B90800                  		mov	cx,8
  2259 00000751 F3A7                    		repe cmpsw
  2260                                  				; zf = 0 -> A20 line is ON
  2261                                  				; zf = 1 -> A20 line is OFF
  2262 00000753 5F                      		pop	di
  2263 00000754 5E                      		pop	si
  2264 00000755 59                      		pop	cx
  2265 00000756 07                      		pop	es
  2266 00000757 1F                      		pop	ds
  2267 00000758 C3                      		retn
  2268                                  
  2269                                  ; ----------------------------------------------------------------------------
  2270                                  
  2271                                  ; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  2272                                  %if 0
  2273                                  DisableA20:
  2274                                  		push	ax
  2275                                  		push	bx
  2276                                  		mov	ah,6		; local disable A20
  2277                                  		call	far [cs:xms]
  2278                                  		;call	cs:xms
  2279                                  		pop	bx
  2280                                  		pop	ax
  2281                                  		retn
  2282                                  %endif
  2283                                  
  2284                                  ; ----------------------------------------------------------------------------
  2285                                  
  2286                                  ;************************************************************************
  2287                                  ;*									*
  2288                                  ;*	int19 - bootstrap interrupt -- we must restore a bunch of the	*
  2289                                  ;*	  interrupt vectors before resuming the original int19 code	*
  2290                                  ;*									*
  2291                                  ;************************************************************************
  2292                                  
  2293                                  		; 02/10/2023 - Retro DOS v5.0
  2294                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:0759h
  2295                                  int19:
  2296 00000759 0E                      		push	cs
  2297 0000075A 1F                      		pop	ds
  2298                                  		; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  2299                                  		;mov	es,[zeroseg]	; 16/10/2022
  2300                                  		;mov	cx,5		; NUMROMVECTORS
  2301 0000075B 31C9                    		xor	cx,cx
  2302 0000075D 8EC1                    		mov	es,cx
  2303 0000075F B105                    		mov	cl,5
  2304                                  		;mov	si,offset RomVectors
  2305 00000761 BE[0001]                		mov	si,RomVectors	; 19/10/2022
  2306                                  next_int:				
  2307 00000764 AC                      		lodsb			; get int number
  2308 00000765 98                      		cbw			; assume < 128
  2309 00000766 D1E0                    		shl	ax,1
  2310 00000768 D1E0                    		shl	ax,1		; int *	4
  2311                                  		; 07/08/2023
  2312                                  		;mov	di,ax
  2313                                  		;lodsw
  2314                                  		;stosw
  2315                                  		;lodsw
  2316                                  		;stosw			; install the saved vector
  2317                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:076Ah
  2318 0000076A 97                      		xchg	ax,di
  2319 0000076B A5                      		movsw
  2320 0000076C A5                      		movsw
  2321 0000076D E2F5                    		loop	next_int
  2322                                  		;cmp	byte [int19sem], 0 ; 19/10/2022
  2323 0000076F 380E[B105]              		cmp	[int19sem], cl ; 0 ; 07/08/2023
  2324 00000773 7419                    		jz	short doint19
  2325 00000775 BE[B205]                		mov	si,i19_lst	; stacks code has changed these hardware interrupt vectors
  2326                                  					; stkinit in sysinit1 will initialize int19oldxx values
  2327                                  		;mov	cx,14		; num_i19
  2328                                  		; 07/08/2023
  2329 00000778 B10E                    		mov	cl,14	
  2330                                  i19_restore_loop:			
  2331 0000077A AC                      		lodsb			; get interrupt	number
  2332 0000077B 98                      		cbw			; assume < 128
  2333                                  		;mov	di,ax
  2334                                  		;lodsw			; get original vector offset
  2335                                  		;mov	bx,ax		; save it
  2336                                  		;lodsw
  2337                                  		; 07/08/2023
  2338 0000077C 97                      		xchg	ax,di
  2339 0000077D AD                      		lodsw
  2340 0000077E 93                      		xchg	ax,bx
  2341 0000077F AD                      		lodsw
  2342                                  		;cmp	bx,0FFFFh	; check	for 0ffffh (unlikely segment)
  2343 00000780 43                      		inc	bx ; 07/08/2023
  2344 00000781 7409                    		jz	short i19_restor_1 ; opt no need to check selector too
  2345                                  		;cmp	ax,0FFFFh	; opt 0ffffh is	unlikely offset
  2346                                  		;jz	short i19_restor_1
  2347 00000783 4B                      		dec	bx ; 07/08/2023
  2348 00000784 01FF                    		add	di,di
  2349 00000786 01FF                    		add	di,di
  2350 00000788 93                      		xchg	ax,bx
  2351 00000789 AB                      		stosw
  2352 0000078A 93                      		xchg	ax,bx
  2353 0000078B AB                      		stosw			; put the vector back
  2354                                  
  2355                                  i19_restor_1:				
  2356 0000078C E2EC                    		loop	i19_restore_loop
  2357                                  
  2358                                  doint19:				
  2359                                  		;cmp	byte [inHMA],0	; ; Is dos running from	HMA
  2360 0000078E 380E[0D00]              		cmp	[inHMA],cl ; 0	; 07/08/2023
  2361 00000792 7403                    		jz	short SkipVDisk
  2362 00000794 E82A00                  		call	EraseVDiskHead	; Then erase our VDISK header at 1MB boundary
  2363                                  					; Some m/c's (AST 386 & HP QS/16 do not clear
  2364                                  					; the memory above 1MB during a	warm boot.
  2365                                  SkipVDisk:				
  2366 00000797 CD19                    		int	19h		; DISK BOOT
  2367                                  					; causes reboot	of disk	system
  2368                                  
  2369                                  ; =============== S U B	R O U T	I N E ========================================
  2370                                  
  2371                                  ;-----------------------------------------------------------------------------
  2372                                  ;
  2373                                  ; procedure : int15
  2374                                  ;
  2375                                  ;		Int15 handler for recognizing ctrl-alt-del seq
  2376                                  ;		If it recognizes ctrl-alt-del and if DOS was
  2377                                  ;		is running high, it Erases the VDISK header
  2378                                  ;		present at 1MB boundary
  2379                                  ;
  2380                                  ;-----------------------------------------------------------------------------
  2381                                  
  2382                                  ; 16/10/2022
  2383                                  ;DELKEY		equ	53h
  2384                                  ;ROMDATASEG	equ	40h
  2385                                  KBFLAG		equ	17h
  2386                                  ;CTRLSTATE	equ	04h
  2387                                  ;ALTSTATE	equ	08h
  2388                                  
  2389                                  		; 02/10/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  2390                                  Int15:		
  2391                                  		;cmp	ax,4F00h+DELKEY
  2392 00000799 3D534F                  		cmp	ax,4F53h	; del keystroke ?
  2393                                  		; 02/10/2023 - Retro DOS v5.0
  2394                                  		; 07/08/2023
  2395 0000079C 7405                    		jz	short int15_1
  2396                                  		;jnz	short Old15_j	; 07/08/2023 
  2397                                  Old15_j:
  2398 0000079E 2EFF2E[0B01]            		jmp	far [cs:Old15]	; 16/10/2022
  2399                                  
  2400                                  ; ----------------------------------------------------------------------------
  2401                                  int15_1:				
  2402 000007A3 1E                      		push	ds
  2403 000007A4 50                      		push	ax
  2404                                  		; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  2405                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:07A5h
  2406                                  		;mov	ax,40h		; ROMDATASEG
  2407                                  		;mov	ds,ax
  2408                                  		;;mov	al,ds:17h	; [KBFLAG]
  2409                                  		;; 16/10/2022
  2410                                  		;mov	al,[KBFLAG]
  2411 000007A5 31C0                    		xor	ax,ax
  2412 000007A7 8ED8                    		mov	ds,ax
  2413 000007A9 A01704                  		mov	al,[0417h]	; KBFLAG = 0417h (PCDOS 7.1 IBMBIO.COM)
  2414 000007AC 240C                    		and	al,0Ch		; (CTRLSTATE | ALTSTATE)
  2415 000007AE 3C0C                    		cmp	al,0Ch		; (CTRLSTATE | ALTSTATE)
  2416 000007B0 750A                    		jnz	short int15_2
  2417                                  		; 07/08/2023
  2418                                  		;push	cs
  2419                                  		;pop	ds
  2420                                  		;cmp	byte [inHMA],0	; is DOS running from HMA
  2421 000007B2 2E3826[0D00]            		cmp	byte [cs:inHMA],ah ; 0
  2422 000007B7 7403                    		jz	short int15_2
  2423 000007B9 E80500                  		call	EraseVDiskHead
  2424                                  int15_2:				
  2425 000007BC 58                      		pop	ax
  2426 000007BD 1F                      		pop	ds
  2427 000007BE F9                      		stc
  2428                                  		; 02/10/2023 - Retro DOS v5.0
  2429 000007BF EBDD                    		jmp	short Old15_j
  2430                                  
  2431                                  		; 02/10/2023
  2432                                  ;Old15_j:	; 07/08/2023
  2433                                  ;		jmp	far [cs:Old15]	; 16/10/2022
  2434                                  ;		;jmp	cs:Old15
  2435                                  	
  2436                                  ; =============== S U B	R O U T	I N E ========================================
  2437                                  
  2438                                  ;-----------------------------------------------------------------------------
  2439                                  ;
  2440                                  ; procedure : EraseVDiskHead
  2441                                  ;
  2442                                  ;		Erases the VDisk Header present in the 1MB boundary
  2443                                  ;
  2444                                  ;-----------------------------------------------------------------------------
  2445                                  
  2446                                  EraseVDiskHead:	; proc near
  2447                                  		; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  2448                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:07C1h
  2449                                  		;push	ax
  2450 000007C1 51                      		push	cx
  2451 000007C2 57                      		push	di
  2452 000007C3 06                      		push	es
  2453 000007C4 E863FF                  		call	EnsureA20On
  2454                                  		;mov	ax,0FFFFh	; HMA seg
  2455                                  		;mov	es,ax
  2456                                  		; 03/10/2023 - Retro DOS v5.0
  2457 000007C7 6AFF                    		push	0FFFFh
  2458 000007C9 07                      		pop	es
  2459 000007CA BF1000                  		mov	di,10h		; point	to VDISK header
  2460                                  		; 07/08/2023
  2461                                  		;mov	cx,10h		; size of vdisk	header
  2462 000007CD 89F9                    		mov	cx,di ; 16
  2463                                  		; 03/10/2023
  2464 000007CF 31C0                    		xor	ax,ax
  2465                                  		;inc	ax ; ax = 0
  2466 000007D1 F3AB                    		rep stosw		; clear	it
  2467 000007D3 07                      		pop	es
  2468 000007D4 5F                      		pop	di
  2469 000007D5 59                      		pop	cx
  2470                                  		;pop	ax ; 07/08/2023
  2471 000007D6 C3                      		retn
  2472                                  
  2473                                  ; ----------------------------------------------------------------------------
  2474                                  
  2475                                  ; 03/10/2023 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
  2476                                  ; 17/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
  2477                                  
  2478                                  ; 09/12/2022
  2479                                  ;SYSINITSEG	equ 46Dh  ; SYSINIT segment
  2480                                  ;DOSLOADSEG	equ 83Fh  ; MSDOS.SYS (kernel) loading segment		
  2481                                  ; (followings are in sysinit segment)
  2482                                  ;FTryToMovDOSHi	equ 0A84h ; (procedure in SYSINIT segment)
  2483                                  FTRYTOMOVDOSHI	equ FTryToMovDOSHi ; SYSINIT section
  2484                                  ;DEVICELIST	equ 273h
  2485                                  DEVICELIST	equ DEVICE_LIST	; SYSINIT section 	
  2486                                  ;MEMORYSIZE	equ 292h	
  2487                                  MEMORYSIZE	equ MEMORY_SIZE	; SYSINIT section
  2488                                  ;DEFAULTDRIVE	equ 296h
  2489                                  DEFAULTDRIVE	equ DEFAULT_DRIVE ; SYSINIT section
  2490                                  ;;currentdoslocation equ 271h
  2491                                  ;CURRENTDOSLOCATION equ 271h
  2492                                  CURRENTDOSLOCATION equ CURRENT_DOS_LOCATION  ; SYSINIT section
  2493                                  ;SYSINITSTART	equ 267h
  2494                                  SYSINITSTART	equ SYSINIT  ; SYSINIT section
  2495                                  ; 18/10/2022
  2496                                  ;toomanydrivesflag equ 3FFh 
  2497                                  TOOMANYDRIVESFLAG equ toomanydrivesflag ; SYSINIT section	
  2498                                  
  2499                                  ; ----------------------------------------------------------------------------
  2500                                  
  2501                                  ; 03/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  2502                                  ; PCDOS 7.1 IBMBIO.COM - BIOSDATA:07D7h
  2503                                  
  2504                                  %if 1
  2505                                  
  2506 000007D7 FFFF                    FreeHMAPtr:	dw 0FFFFh		
  2507                                  ;MoveDOSIntoHMA: dd 46D0A84h 		; FTryToMovDOSHi
  2508                                  					; (procedure in	SYSINIT	segment)
  2509                                  ; 17/10/2022
  2510 000007D9 [E30A]                  MoveDOSIntoHMA:	dw FTRYTOMOVDOSHI	; 09/12/2022
  2511 000007DB D704                    		dw SYSINITSEG		; 08/08/2023
  2512                                  					; 0544h for PCDOS 7.1 IBMBIO.COM
  2513                                  					; 0473h for MSDOS 6.21 IO.SYS
  2514                                  ;SR;
  2515                                  ; A communication block has been setup between the DOS and the BIOS. All
  2516                                  ;the data starting from SysinitPresent will be part of the data block. 
  2517                                  ;Right now, this is the only data being communicated. It can be expanded 
  2518                                  ;later to add more stuff
  2519                                  
  2520 000007DD 00                      SysinitPresent:	db 0
  2521                                  
  2522                                  %endif
  2523                                  
  2524                                  ; ----------------------------------------------------------------------------
  2525                                  
  2526                                  ;************************************************************************
  2527                                  ;*									*
  2528                                  ;*	the int2f handler chains up to Bios_Code through here.		*
  2529                                  ;*	  it returns through one of the three functions that follow.	*
  2530                                  ;*	  notice that we'll assume we're being entered from DOS, so	*
  2531                                  ;*	  that we're guaranteed to be A20 enabled if needed		*
  2532                                  ;*									*
  2533                                  ;************************************************************************
  2534                                  
  2535                                  ; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  2536                                  %if 0	; 20/09/2023
  2537                                  int_2f:		
  2538                                  		jmp	far [cs:bcode_i2f] ; 16/10/2022
  2539                                  		;jmp	dword ptr cs:bcode_i2f ; far [cs:bcode_i2f]
  2540                                  
  2541                                  ; ----------------------------------------------------------------------------
  2542                                  
  2543                                  ; re-enter here to transition out of hma mode and jmp to dsk_entry
  2544                                  ; note:  is it really necessary to transiton out and then back in?
  2545                                  ;	 It's not as if this is a really speed critical function.
  2546                                  ;	 might as well do whatever's most compact.
  2547                                  
  2548                                  i2f_dskentry:
  2549                                  		jmp	dsk_entry
  2550                                  
  2551                                  ; ----------------------------------------------------------------------------
  2552                                  
  2553                                  ;************************************************************************
  2554                                  ;*									*
  2555                                  ;*	re_init - called back by sysinit after a bunch of stuff		*
  2556                                  ;*		is done. presently does nothing. affects no		*
  2557                                  ;*		registers!						*
  2558                                  ;*									*
  2559                                  ;************************************************************************
  2560                                  
  2561                                  ; 09/12/2022
  2562                                  ; re_init_:
  2563                                  re_init:				; called back by sysinit after
  2564                                  		retf			; a bunch of stuff is done.
  2565                                  					; presently does nothing
  2566                                  %endif
  2567                                  
  2568                                  ; ----------------------------------------------------------------------------
  2569                                  
  2570                                  ;SR; WIN386 support
  2571                                  
  2572                                  ; WIN386 instance data structure
  2573                                  ;
  2574                                  ; Here is a Win386 startup info structure which we set up and to which
  2575                                  ; we return a pointer when Win386 initializes.
  2576                                  
  2577 000007DE 0300                    Win386_SI:	db 3,0			; SI_Version
  2578                                  					; Startup Info for Win386
  2579 000007E0 00000000                SI_Next:	dd 0			; pointer to next info structure
  2580 000007E4 00000000                		dd 0			; a field we don't need
  2581 000007E8 00000000                		dd 0			; another field	we don't need
  2582 000007EC [F007]                  SI_Instance:	dw Instance_Table
  2583 000007EE 7000                    		dw 70h	; Bios_Data	; far pointer to instance table
  2584                                  
  2585                                  ; This table gives Win386 the instance data in the BIOS and ROM-BIOS data
  2586                                  ; areas. Note that the address and size of the hardware stacks must
  2587                                  ; be calculated and inserted at boot time.
  2588                                  
  2589 000007F0 00005000                Instance_Table:	dw 0,50h		; print	screen status...
  2590 000007F4 0200                    		dw 2			; ... 2	bytes
  2591 000007F6 0E005000                		dw 0Eh,50h		; ROM Basic data...
  2592 000007FA 1400                    		dw 14h			; ... 14H bytes
  2593 000007FC [0C00]                  		dw altah		; a con	device buffer...
  2594 000007FE 7000                    		dw 70h			; Bios_Data segment
  2595 00000800 0100                    		dw 1			; ... 1 byte
  2596                                  
  2597                                  NextStack:
  2598                                  
  2599                                  ; NOTE:  If stacks are disabled by STACKS=0,0, the following
  2600                                  ;	instance items WILL NOT be filled in by SYSINIT.
  2601                                  ;	That's just fine as long as these are the last items
  2602                                  ;	in the instance list since the first item is initialized
  2603                                  ;	to 0000 at load time.
  2604                                  
  2605 00000802 00000000                		dw 0,0			; pointer to next stack	to be used...
  2606 00000806 0200                    		dw 2			; ... 2 bytes
  2607 00000808 00000000                IT_StackLoc:	dd 0			; location of hardware stacks
  2608 0000080C 0000                    IT_StackSize:	dw 0			; size of hardware stacks
  2609 0000080E 00000000                		dd 0			; terminate the	instance table
  2610                                  
  2611                                  					;SR;
  2612 00000812 00                      IsWin386:	db 0			; Flag to indicate whether
  2613                                  					; Win386 is running or not
  2614                                  ;-----------------------------------------------------------------------------
  2615                                  
  2616                                  ;This routine was originally in BIOS_CODE but this causes a lot of problems
  2617                                  ;when we call it including checking of A20. The code being only about 
  2618                                  ;30 bytes, we might as well put it in BIOS_DATA
  2619                                  
  2620                                  V86_Crit_SetFocus:			
  2621 00000813 57                      		push	di
  2622 00000814 06                      		push	es
  2623 00000815 53                      		push	bx
  2624 00000816 50                      		push	ax
  2625 00000817 31FF                    		xor	di,di
  2626 00000819 8EC7                    		mov	es,di
  2627 0000081B BB1500                  		mov	bx,15h		; Device ID of DOSMGR device
  2628 0000081E B88416                  		mov	ax,1684h	; Get API entry	point
  2629 00000821 CD2F                    		int	2Fh		; - Multiplex -	MS WINDOWS - GET DEVICE	API ENTRY POINT
  2630                                  					; BX = virtual device (VxD) ID,	ES:DI =	0000h:0000h
  2631                                  					; Return: ES:DI	-> VxD API entry point,	or 0:0 if the VxD does not support an API
  2632 00000823 8CC0                    		mov	ax, es
  2633 00000825 09F8                    		or	ax, di
  2634 00000827 740A                    		jz	short Skip	; Here,	es:di is address of API	routine.
  2635                                  					; Set up stack frame to	simulate a call.
  2636 00000829 0E                      		push	cs
  2637                                  		;;mov	ax,offset Skip
  2638                                  		;mov	ax,Skip
  2639                                  		;push	ax
  2640                                  		; 03/10/2023 - Retro DOS v5.0
  2641 0000082A 68[3308]                		push	Skip
  2642 0000082D 06                      		push	es
  2643 0000082E 57                      		push	di		; API far call address
  2644 0000082F B80100                  		mov	ax,1		; SetFocus function number
  2645 00000832 CB                      		retf			; do the call
  2646                                  ;-----------------------------------------------------------------------------
  2647                                  
  2648                                  Skip:					
  2649 00000833 58                      		pop	ax
  2650 00000834 5B                      		pop	bx
  2651 00000835 07                      		pop	es
  2652 00000836 5F                      		pop	di
  2653 00000837 CB                      		retf
  2654                                  
  2655                                  ;End WIN386 support
  2656                                  
  2657                                  ; ----------------------------------------------------------------------------
  2658                                  
  2659                                  ; 03/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  2660                                  %if 0
  2661                                  
  2662                                  FreeHMAPtr:	dw 0FFFFh		
  2663                                  ;MoveDOSIntoHMA: dd 46D0A84h 		; FTryToMovDOSHi
  2664                                  					; (procedure in	SYSINIT	segment)
  2665                                  ; 17/10/2022
  2666                                  MoveDOSIntoHMA:	dw FTRYTOMOVDOSHI	; 09/12/2022
  2667                                  		dw SYSINITSEG		; 08/08/2023
  2668                                  					; 0544h for PCDOS 7.1 IBMBIO.COM
  2669                                  					; 0473h for MSDOS 6.21 IO.SYS
  2670                                  ;SR;
  2671                                  ; A communication block has been setup between the DOS and the BIOS. All
  2672                                  ;the data starting from SysinitPresent will be part of the data block. 
  2673                                  ;Right now, this is the only data being communicated. It can be expanded 
  2674                                  ;later to add more stuff
  2675                                  
  2676                                  SysinitPresent:	db 0
  2677                                  		
  2678                                  endfloppy:	db 0, 0
  2679                                  
  2680                                  %endif
  2681                                  	
  2682                                  	; 03/10/2023 - Retro DOS v5.0 IBMBIO.COM
  2683                                  
  2684                                  	endfloppy:
  2685 00000838 00                      		db 0
  2686                                  
  2687                                  	; 03/10/2023
  2688                                  
  2689                                  numxdiv	equ ($-BData_start)
  2690                                  numxmod	equ (numxdiv % 16)
  2691                                  
  2692                                  %if (numxmod>0) & (numxmod<16)
  2693 00000839 00<rep 7h>              		times (16-numxmod) db 0
  2694                                  %endif
  2695                                  
  2696                                  ; ----------------------------------------------------------------------------			
  2697                                  
  2698                                  ; Bios_Data ends
  2699                                  	
  2700                                  ; Possibly disposable BIOS data
  2701                                  ; This data follows the	regular	BIOS data,
  2702                                  ; and is part of the same group.
  2703                                  
  2704                                  ; 03/10/2023 - Retro DOS v5.0 IBMBIO.COM
  2705                                  ;nul_vid:	db 'NO NAME    ',0      
  2706                                  					; null volume id
  2707                                  ;tmp_vid:	db 'NO NAME    ',0      
  2708                                  					; vid scratch buffer
  2709                                  ; 03/10/2023
  2710 00000840 4E4F204E414D452020-     tmp_vid:	db 'NO NAME    '
  2710 00000849 2020               
  2711                                  
  2712 0000084B 80                      harddrv:	db 80h			
  2713                                  
  2714                                  end96tpi:
  2715                                  
  2716                                  ; 03/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  2717                                  ; PCDOS 7.1 IBMBIO.COM - BIOSDATA:084Ch ('bdss:' address)
  2718                                  
  2719                                  ;;*********************************************************************
  2720                                  ;;memory allocation for bdss
  2721                                  ;;*********************************************************************
  2722                                  ;
  2723                                  ;;max_mini_dsk_num equ 23	; max # of mini disk ibmbio can support
  2724                                  ;
  2725                                  ;;bdss	BDS_STRUC (2+max_mini_dsk_num) dup (<>)	; currently max. 25
  2726                                  ;
  2727                                  ;bdss:	times BDS.size*(2+max_mini_dsk_num) db 0
  2728                                  
  2729                                  ; 14/10/2023
  2730                                  
  2731 0000084C FFFF                    bdss:		dw 0FFFFh	; max_mini_dsk_num equ 23
  2732                                  				; BDS_STRUC (2+max_mini_dsk_num) dup (<>)
  2733                                  				; currently max. 25
  2734                                  				; (MSDOS 6 BDS structure size = 100 bytes)
  2735                                  				; (PCDOS 7.1 BDS structure size = 150 bytes)
  2736                                  				; BDS.link
  2737 0000084E 0000                    		dw 0
  2738 00000850 50                      		db 80		; BDS.drivenum
  2739 00000851 03                      		db 3		; BDS.drivelet
  2740 00000852 0002                    		dw 512		; BDS.BPB (BDS offset 6)
  2741                                  				; 53 bytes BPB for FAT32 fs
  2742                                  				; 25 bytes BPB for FAT16 and FAT12 fs
  2743                                  				; .bytespersec
  2744 00000854 01                      		db 1		; .secperclus
  2745 00000855 0100                    		dw 1		; .resectors
  2746 00000857 02                      		db 2		; .fats
  2747 00000858 1000                    		dw 16		; .direntries
  2748 0000085A 0000                    		dw 0		; .totalsec16
  2749 0000085C F8                      		db 0F8h		; .media
  2750 0000085D 0100                    		dw 1		; .fatsecs16
  2751 0000085F 0000                    		dw 0		; .secpertrack
  2752 00000861 0000                    		dw 0		; .heads
  2753 00000863 00000000                		dd 0		; .hiddensectors
  2754 00000867 00000000                		dd 0		; .totalsecs32
  2755                                  				; (End of FAT12/FAT16 BPB)
  2756                                  				;
  2757                                  				; FAT32 extensions to BDS
  2758 0000086B 00000000                		dd 0		; .fatsecs32 ; BPB_FATSz32 (BDS offset 31)
  2759 0000086F 0000                    		dw 0		; .extflags ; BPB_ExtFlags
  2760 00000871 0000                    		dw 0		; .fsver ; BPB_FSVer
  2761 00000873 00000000                		dd 0		; .rootdirclust ; BPB_RootClus (BDS offset 39)
  2762 00000877 FFFF                    		dw 0FFFFh	; .fsinfo ; BPB_FSInfo ; initialized to -1
  2763 00000879 FFFF                    		dw 0FFFFh	; .bkbootsec ; BPB_BkBootSec ; initialized to -1
  2764 0000087B 000000000000000000-     		db 12 dup(0)	; .reserved ; BPB_Reserved (12 zero bytes)
  2764 00000884 000000             
  2765 00000887 00                      		db 0		; BDS.fatsiz (BDS offset 59)
  2766 00000888 0000                    		dw 0		; BDS.opcnt
  2767 0000088A 03                      		db 3
  2768 0000088B 2000                    		dw 20h		; BDS.flags (BDS offset 63)
  2769 0000088D 2800                    		dw 40
  2770 0000088F 000000000000000000-     		db 37 dup(0)
  2770 00000898 000000000000000000-
  2770 000008A1 000000000000000000-
  2770 000008AA 000000000000000000-
  2770 000008B3 00                 
  2771 000008B4 FFFFFFFF                		dd 0FFFFFFFFh
  2772 000008B8 000000000000000000-     		db 12 dup(0)
  2772 000008C1 000000             
  2773 000008C4 FF                      		db -1		; BDS.track (BDS offset 120)
  2774 000008C5 0100                    		dw 1		; BDS.tim_lo ; BDS.bdsm_ismini
  2775 000008C7 0000                    		dw 0		; BDS.tim_hi
  2776 000008C9 4E4F204E414D452020-     		db 'NO NAME    ',0	; BDS.volid
  2776 000008D2 202000             
  2777 000008D5 00000000                		dd 0		  	; BDS.vol_serial (BDS offset 137)
  2778 000008D9 464154313220202000      		db 'FAT12   ',0		; BDS.filesys_id
  2779                                  
  2780 000008E2 FFFF                    bds_1:		dw 0FFFFh
  2781 000008E4 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2781 000008ED 0210000000F8       
  2782 000008F3 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2782 000008FC 000000000000000000 
  2783 00000905 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2783 0000090E FFFFFF0000         
  2784 00000913 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2784 0000091C 0000000003200028   
  2785 00000924 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2785 0000092D 000000000000000000 
  2786 00000936 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2786 0000093F 000000000000000000 
  2787 00000948 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2787 00000951 0000000000         
  2788 00000956 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2788 0000095F 4E4F204E41         
  2789 00000964 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2789 0000096D 00004641           
  2790 00000971 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2791                                  
  2792 00000978 FFFF                    bds_2:		dw 0FFFFh
  2793 0000097A 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2793 00000983 0210000000F8       
  2794 00000989 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2794 00000992 000000000000000000 
  2795 0000099B 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2795 000009A4 FFFFFF0000         
  2796 000009A9 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2796 000009B2 0000000003200028   
  2797 000009BA 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2797 000009C3 000000000000000000 
  2798 000009CC 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2798 000009D5 000000000000000000 
  2799 000009DE 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2799 000009E7 0000000000         
  2800 000009EC 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2800 000009F5 4E4F204E41         
  2801 000009FA 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2801 00000A03 00004641           
  2802 00000A07 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2803                                  
  2804 00000A0E FFFF                    bds_3:		dw 0FFFFh
  2805 00000A10 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2805 00000A19 0210000000F8       
  2806 00000A1F 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2806 00000A28 000000000000000000 
  2807 00000A31 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2807 00000A3A FFFFFF0000         
  2808 00000A3F 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2808 00000A48 0000000003200028   
  2809 00000A50 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2809 00000A59 000000000000000000 
  2810 00000A62 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2810 00000A6B 000000000000000000 
  2811 00000A74 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2811 00000A7D 0000000000         
  2812 00000A82 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2812 00000A8B 4E4F204E41         
  2813 00000A90 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2813 00000A99 00004641           
  2814 00000A9D 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2815                                  
  2816 00000AA4 FFFF                    bds_4:		dw 0FFFFh
  2817 00000AA6 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2817 00000AAF 0210000000F8       
  2818 00000AB5 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2818 00000ABE 000000000000000000 
  2819 00000AC7 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2819 00000AD0 FFFFFF0000         
  2820 00000AD5 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2820 00000ADE 0000000003200028   
  2821 00000AE6 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2821 00000AEF 000000000000000000 
  2822 00000AF8 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2822 00000B01 000000000000000000 
  2823 00000B0A 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2823 00000B13 0000000000         
  2824 00000B18 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2824 00000B21 4E4F204E41         
  2825 00000B26 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2825 00000B2F 00004641           
  2826 00000B33 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2827                                  
  2828 00000B3A FFFF                    		dw 0FFFFh
  2829 00000B3C 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2829 00000B45 0210000000F8       
  2830 00000B4B 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2830 00000B54 000000000000000000 
  2831 00000B5D 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2831 00000B66 FFFFFF0000         
  2832 00000B6B 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2832 00000B74 0000000003200028   
  2833 00000B7C 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2833 00000B85 000000000000000000 
  2834 00000B8E 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2834 00000B97 000000000000000000 
  2835 00000BA0 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2835 00000BA9 0000000000         
  2836 00000BAE 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2836 00000BB7 4E4F204E41         
  2837 00000BBC 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2837 00000BC5 00004641           
  2838 00000BC9 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2839                                  
  2840 00000BD0 FFFF                    		dw 0FFFFh
  2841 00000BD2 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2841 00000BDB 0210000000F8       
  2842 00000BE1 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2842 00000BEA 000000000000000000 
  2843 00000BF3 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2843 00000BFC FFFFFF0000         
  2844 00000C01 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2844 00000C0A 0000000003200028   
  2845 00000C12 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2845 00000C1B 000000000000000000 
  2846 00000C24 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2846 00000C2D 000000000000000000 
  2847 00000C36 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2847 00000C3F 0000000000         
  2848 00000C44 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2848 00000C4D 4E4F204E41         
  2849 00000C52 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2849 00000C5B 00004641           
  2850 00000C5F 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2851                                  
  2852 00000C66 FFFF                    		dw 0FFFFh
  2853 00000C68 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2853 00000C71 0210000000F8       
  2854 00000C77 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2854 00000C80 000000000000000000 
  2855 00000C89 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2855 00000C92 FFFFFF0000         
  2856 00000C97 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2856 00000CA0 0000000003200028   
  2857 00000CA8 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2857 00000CB1 000000000000000000 
  2858 00000CBA 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2858 00000CC3 000000000000000000 
  2859 00000CCC 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2859 00000CD5 0000000000         
  2860 00000CDA 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2860 00000CE3 4E4F204E41         
  2861 00000CE8 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2861 00000CF1 00004641           
  2862 00000CF5 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2863                                  
  2864 00000CFC FFFF                    		dw 0FFFFh
  2865 00000CFE 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2865 00000D07 0210000000F8       
  2866 00000D0D 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2866 00000D16 000000000000000000 
  2867 00000D1F 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2867 00000D28 FFFFFF0000         
  2868 00000D2D 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2868 00000D36 0000000003200028   
  2869 00000D3E 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2869 00000D47 000000000000000000 
  2870 00000D50 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2870 00000D59 000000000000000000 
  2871 00000D62 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2871 00000D6B 0000000000         
  2872 00000D70 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2872 00000D79 4E4F204E41         
  2873 00000D7E 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2873 00000D87 00004641           
  2874 00000D8B 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2875                                  
  2876 00000D92 FFFF                    		dw 0FFFFh
  2877 00000D94 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2877 00000D9D 0210000000F8       
  2878 00000DA3 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2878 00000DAC 000000000000000000 
  2879 00000DB5 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2879 00000DBE FFFFFF0000         
  2880 00000DC3 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2880 00000DCC 0000000003200028   
  2881 00000DD4 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2881 00000DDD 000000000000000000 
  2882 00000DE6 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2882 00000DEF 000000000000000000 
  2883 00000DF8 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2883 00000E01 0000000000         
  2884 00000E06 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2884 00000E0F 4E4F204E41         
  2885 00000E14 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2885 00000E1D 00004641           
  2886 00000E21 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2887                                  
  2888 00000E28 FFFF                    		dw 0FFFFh
  2889 00000E2A 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2889 00000E33 0210000000F8       
  2890 00000E39 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2890 00000E42 000000000000000000 
  2891 00000E4B 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2891 00000E54 FFFFFF0000         
  2892 00000E59 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2892 00000E62 0000000003200028   
  2893 00000E6A 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2893 00000E73 000000000000000000 
  2894 00000E7C 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2894 00000E85 000000000000000000 
  2895 00000E8E 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2895 00000E97 0000000000         
  2896 00000E9C 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2896 00000EA5 4E4F204E41         
  2897 00000EAA 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2897 00000EB3 00004641           
  2898 00000EB7 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2899                                  
  2900 00000EBE FFFF                    		dw 0FFFFh
  2901 00000EC0 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2901 00000EC9 0210000000F8       
  2902 00000ECF 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2902 00000ED8 000000000000000000 
  2903 00000EE1 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2903 00000EEA FFFFFF0000         
  2904 00000EEF 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2904 00000EF8 0000000003200028   
  2905 00000F00 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2905 00000F09 000000000000000000 
  2906 00000F12 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2906 00000F1B 000000000000000000 
  2907 00000F24 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2907 00000F2D 0000000000         
  2908 00000F32 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2908 00000F3B 4E4F204E41         
  2909 00000F40 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2909 00000F49 00004641           
  2910 00000F4D 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2911 00000F54 FFFF                    		dw 0FFFFh
  2912 00000F56 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2912 00000F5F 0210000000F8       
  2913 00000F65 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2913 00000F6E 000000000000000000 
  2914 00000F77 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2914 00000F80 FFFFFF0000         
  2915 00000F85 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2915 00000F8E 0000000003200028   
  2916 00000F96 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2916 00000F9F 000000000000000000 
  2917 00000FA8 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2917 00000FB1 000000000000000000 
  2918 00000FBA 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2918 00000FC3 0000000000         
  2919 00000FC8 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2919 00000FD1 4E4F204E41         
  2920 00000FD6 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2920 00000FDF 00004641           
  2921 00000FE3 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2922                                  
  2923 00000FEA FFFF                    		dw 0FFFFh
  2924 00000FEC 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2924 00000FF5 0210000000F8       
  2925 00000FFB 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2925 00001004 000000000000000000 
  2926 0000100D 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2926 00001016 FFFFFF0000         
  2927 0000101B 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2927 00001024 0000000003200028   
  2928 0000102C 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2928 00001035 000000000000000000 
  2929 0000103E 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2929 00001047 000000000000000000 
  2930 00001050 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2930 00001059 0000000000         
  2931 0000105E 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2931 00001067 4E4F204E41         
  2932 0000106C 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2932 00001075 00004641           
  2933 00001079 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2934                                  
  2935 00001080 FFFF                    		dw 0FFFFh
  2936 00001082 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2936 0000108B 0210000000F8       
  2937 00001091 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2937 0000109A 000000000000000000 
  2938 000010A3 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2938 000010AC FFFFFF0000         
  2939 000010B1 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2939 000010BA 0000000003200028   
  2940 000010C2 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2940 000010CB 000000000000000000 
  2941 000010D4 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2941 000010DD 000000000000000000 
  2942 000010E6 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2942 000010EF 0000000000         
  2943 000010F4 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2943 000010FD 4E4F204E41         
  2944 00001102 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2944 0000110B 00004641           
  2945 0000110F 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2946                                  
  2947 00001116 FFFF                    		dw 0FFFFh
  2948 00001118 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2948 00001121 0210000000F8       
  2949 00001127 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2949 00001130 000000000000000000 
  2950 00001139 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2950 00001142 FFFFFF0000         
  2951 00001147 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2951 00001150 0000000003200028   
  2952 00001158 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2952 00001161 000000000000000000 
  2953 0000116A 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2953 00001173 000000000000000000 
  2954 0000117C 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2954 00001185 0000000000         
  2955 0000118A 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2955 00001193 4E4F204E41         
  2956 00001198 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2956 000011A1 00004641           
  2957 000011A5 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2958                                  
  2959 000011AC FFFF                    		dw 0FFFFh
  2960 000011AE 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2960 000011B7 0210000000F8       
  2961 000011BD 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2961 000011C6 000000000000000000 
  2962 000011CF 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2962 000011D8 FFFFFF0000         
  2963 000011DD 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2963 000011E6 0000000003200028   
  2964 000011EE 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2964 000011F7 000000000000000000 
  2965 00001200 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2965 00001209 000000000000000000 
  2966 00001212 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2966 0000121B 0000000000         
  2967 00001220 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2967 00001229 4E4F204E41         
  2968 0000122E 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2968 00001237 00004641           
  2969 0000123B 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2970                                  
  2971 00001242 FFFF                    		dw 0FFFFh
  2972 00001244 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2972 0000124D 0210000000F8       
  2973 00001253 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2973 0000125C 000000000000000000 
  2974 00001265 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2974 0000126E FFFFFF0000         
  2975 00001273 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2975 0000127C 0000000003200028   
  2976 00001284 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2976 0000128D 000000000000000000 
  2977 00001296 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2977 0000129F 000000000000000000 
  2978 000012A8 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2978 000012B1 0000000000         
  2979 000012B6 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2979 000012BF 4E4F204E41         
  2980 000012C4 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2980 000012CD 00004641           
  2981 000012D1 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2982                                  
  2983 000012D8 FFFF                    		dw 0FFFFh
  2984 000012DA 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2984 000012E3 0210000000F8       
  2985 000012E9 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2985 000012F2 000000000000000000 
  2986 000012FB 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2986 00001304 FFFFFF0000         
  2987 00001309 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2987 00001312 0000000003200028   
  2988 0000131A 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2988 00001323 000000000000000000 
  2989 0000132C 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2989 00001335 000000000000000000 
  2990 0000133E 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  2990 00001347 0000000000         
  2991 0000134C 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  2991 00001355 4E4F204E41         
  2992 0000135A 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  2992 00001363 00004641           
  2993 00001367 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  2994                                  
  2995 0000136E FFFF                    		dw 0FFFFh
  2996 00001370 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  2996 00001379 0210000000F8       
  2997 0000137F 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  2997 00001388 000000000000000000 
  2998 00001391 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  2998 0000139A FFFFFF0000         
  2999 0000139F 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  2999 000013A8 0000000003200028   
  3000 000013B0 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3000 000013B9 000000000000000000 
  3001 000013C2 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3001 000013CB 000000000000000000 
  3002 000013D4 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  3002 000013DD 0000000000         
  3003 000013E2 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  3003 000013EB 4E4F204E41         
  3004 000013F0 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  3004 000013F9 00004641           
  3005 000013FD 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  3006                                  
  3007 00001404 FFFF                    		dw 0FFFFh
  3008 00001406 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  3008 0000140F 0210000000F8       
  3009 00001415 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3009 0000141E 000000000000000000 
  3010 00001427 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  3010 00001430 FFFFFF0000         
  3011 00001435 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  3011 0000143E 0000000003200028   
  3012 00001446 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3012 0000144F 000000000000000000 
  3013 00001458 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3013 00001461 000000000000000000 
  3014 0000146A 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  3014 00001473 0000000000         
  3015 00001478 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  3015 00001481 4E4F204E41         
  3016 00001486 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  3016 0000148F 00004641           
  3017 00001493 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  3018                                  
  3019 0000149A FFFF                    		dw 0FFFFh
  3020 0000149C 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  3020 000014A5 0210000000F8       
  3021 000014AB 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3021 000014B4 000000000000000000 
  3022 000014BD 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  3022 000014C6 FFFFFF0000         
  3023 000014CB 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  3023 000014D4 0000000003200028   
  3024 000014DC 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3024 000014E5 000000000000000000 
  3025 000014EE 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3025 000014F7 000000000000000000 
  3026 00001500 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  3026 00001509 0000000000         
  3027 0000150E 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  3027 00001517 4E4F204E41         
  3028 0000151C 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  3028 00001525 00004641           
  3029 00001529 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  3030 00001530 FFFF                    		dw 0FFFFh
  3031 00001532 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  3031 0000153B 0210000000F8       
  3032 00001541 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3032 0000154A 000000000000000000 
  3033 00001553 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  3033 0000155C FFFFFF0000         
  3034 00001561 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  3034 0000156A 0000000003200028   
  3035 00001572 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3035 0000157B 000000000000000000 
  3036 00001584 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3036 0000158D 000000000000000000 
  3037 00001596 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  3037 0000159F 0000000000         
  3038 000015A4 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  3038 000015AD 4E4F204E41         
  3039 000015B2 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  3039 000015BB 00004641           
  3040 000015BF 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  3041                                  
  3042 000015C6 FFFF                    		dw 0FFFFh
  3043 000015C8 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  3043 000015D1 0210000000F8       
  3044 000015D7 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3044 000015E0 000000000000000000 
  3045 000015E9 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  3045 000015F2 FFFFFF0000         
  3046 000015F7 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  3046 00001600 0000000003200028   
  3047 00001608 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3047 00001611 000000000000000000 
  3048 0000161A 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3048 00001623 000000000000000000 
  3049 0000162C 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  3049 00001635 0000000000         
  3050 0000163A 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  3050 00001643 4E4F204E41         
  3051 00001648 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  3051 00001651 00004641           
  3052 00001655 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  3053                                  
  3054 0000165C FFFF                    bds_24:		dw 0FFFFh
  3055 0000165E 000050030002010100-     		db 0, 0, 50h, 3, 0, 2, 1, 1, 0, 2, 10h, 0, 0, 0, 0F8h
  3055 00001667 0210000000F8       
  3056 0000166D 010000000000000000-     		db 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3056 00001676 000000000000000000 
  3057 0000167F 0000000000000000FF-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0
  3057 00001688 FFFFFF0000         
  3058 0000168D 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 20h, 0, 28h
  3058 00001696 0000000003200028   
  3059 0000169E 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3059 000016A7 000000000000000000 
  3060 000016B0 000000000000000000-     		db 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  3060 000016B9 000000000000000000 
  3061 000016C2 0000FFFFFFFF000000-     		db 0, 0, 0FFh, 0FFh, 0FFh, 0FFh, 0, 0, 0, 0, 0, 0, 0, 0
  3061 000016CB 0000000000         
  3062 000016D0 00000000FF01000000-     		db 0, 0, 0, 0, 0FFh, 1, 0, 0, 0, 4Eh, 4Fh, 20h, 4Eh, 41h
  3062 000016D9 4E4F204E41         
  3063 000016DE 4D4520202020000000-     		db 4Dh, 45h, 20h, 20h, 20h, 20h, 0, 0, 0, 0, 0, 46h, 41h
  3063 000016E7 00004641           
  3064 000016EB 54313220202000          		db 54h, 31h, 32h, 20h, 20h, 20h, 0
  3065                                  
  3066                                  ;---------------------------------------------------------------------------
  3067                                  ; Possibly disposable data, goes at end of data group
  3068                                  ;***************************************************************************
  3069                                  
  3070                                  ; Possibly disposable data, goes at end of data group
  3071                                  
  3072                                  ;***	ibm_disk_io - main routine, fixes at rom bug
  3073                                  ;
  3074                                  ;	entry:	(ah) = function, 02 or 0a for read.
  3075                                  ;		(dl) = drive number (80h or 81h).
  3076                                  ;		(dh) = head number.
  3077                                  ;		(ch) = cylinder number.
  3078                                  ;		(cl) = sector number (high 2 bits has cylinder number).
  3079                                  ;		(al) = number of sectors.
  3080                                  ;		(es:bx) = address of read buffer.
  3081                                  ;		for more on register contents see rom bios listing.
  3082                                  ;		stack set up for return by an iret.
  3083                                  ;
  3084                                  ;	exit:	(ah) = status of current operation.
  3085                                  ;		(cy) = 1 if failed, 0 if successful.
  3086                                  ;		for other register contents see rom bios listing.
  3087                                  ;
  3088                                  ;	uses:	
  3089                                  ;
  3090                                  ;
  3091                                  ;	warning: uses old13 vector for non-read calls.
  3092                                  ;		does direct calls to the at rom.
  3093                                  ;		does segment arithmatic.
  3094                                  ;
  3095                                  ;	effects: performs disk i/o operation.
  3096                                  
  3097                                  ; 16/10/2022
  3098                                  ; 28/05/2019
  3099                                  cmd_block equ 42h ; ROMBIOS DATA segment (40h) offset 42h ; 13/12/2022
  3100                                  
  3101                                  ;* offsets into cmd_block for registers
  3102                                  
  3103                                  pre_comp equ 0	;write pre-compensation
  3104                                  sec_cnt	 equ 1	;sector count
  3105                                  sec_num	 equ 2	;sector number
  3106                                  cyl_low	 equ 3	;cylinder number, low part
  3107                                  cyl_high equ 4	;cylinder number, high part
  3108                                  drv_head equ 5	;drive/head (bit 7 = ecc mode, bit 5 = 512 byte sectors, 
  3109                                  		;            bit 4 = drive number, bits 3-0 have head number)
  3110                                  cmd_reg  equ 6	;command register
  3111                                  
  3112                                  ; 01/10/2022
  3113                                  disk_status1	equ 74h
  3114                                  hf_num		equ 75h
  3115                                  control_byte	equ 76h
  3116                                  
  3117                                  ; 14/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  3118                                  ; PCDOS 7.1 IBMBIO.COM - BIOSDATA:16F2h
  3119                                  
  3120                                  ibm_disk_io:				
  3121 000016F2 80FA80                  		cmp	dl, 80h		; main routine,	fixes at rom bug
  3122 000016F5 720A                    		jb	short atd1	; pass through floppy disk calls. 
  3123 000016F7 80FC02                  		cmp	ah, 2
  3124 000016FA 740A                    		jz	short atd2	; intercept call 02 (read sectors).
  3125 000016FC 80FC0A                  		cmp	ah, 0Ah
  3126 000016FF 7405                    		jz	short atd2	; and call 0Ah (read long).
  3127                                  atd1:
  3128 00001701 2EFF2E[0601]            		jmp	far [cs:Old13]					
  3129                                  		;jmp	cs:Old13	; use rom int 13h handler
  3130                                  ;-----------------------------------------------------------------------------
  3131                                  
  3132                                  atd2:					
  3133 00001706 53                      		push	bx
  3134 00001707 51                      		push	cx
  3135 00001708 52                      		push	dx
  3136 00001709 57                      		push	di
  3137 0000170A 1E                      		push	ds
  3138 0000170B 06                      		push	es
  3139 0000170C 50                      		push	ax
  3140 0000170D B84000                  		mov	ax, 40h		; bioseg (rombios data segment)
  3141                                  					; establish bios segment addressing
  3142 00001710 8ED8                    		mov	ds, ax
  3143                                  		; 16/10/2022
  3144 00001712 C606740000              		mov	byte [disk_status1], 0
  3145                                  		;mov	byte ptr ds:74h, 0 ; [disk_status1]
  3146                                  					; initially no error code.
  3147 00001717 80E27F                  		and	dl, 7Fh		; mask to hard disk number
  3148 0000171A 3A167500                		cmp	dl, [hf_num]
  3149                                  		;cmp	dl, ds:75h	; [hf_num] ; 40h:75h
  3150 0000171E 7207                    		jb	short atd3	; disk number in range
  3151                                  		;mov	byte ptr ds:74h, 1 ; bad_disk
  3152 00001720 C606740001              		mov	byte [disk_status1], 1
  3153 00001725 EB20                    		jmp	short atd4	; disk number out of range error,
  3154                                  					; return
  3155                                  ; ----------------------------------------------------------------------------
  3156                                  
  3157                                  atd3:					
  3158 00001727 53                      		push	bx
  3159 00001728 8CC0                    		mov	ax, es
  3160 0000172A C1EB04                  		shr	bx, 4		; make es:bx to seg:000x form.
  3161 0000172D 01D8                    		add	ax, bx
  3162 0000172F 8EC0                    		mov	es, ax
  3163 00001731 5B                      		pop	bx
  3164 00001732 83E30F                  		and	bx, 0Fh
  3165 00001735 0E                      		push	cs
  3166 00001736 E8DF00                  		call	check_dma
  3167 00001739 720C                    		jb	short atd4	; abort if dma across segment boundary
  3168 0000173B 58                      		pop	ax
  3169 0000173C 50                      		push	ax
  3170 0000173D E81A00                  		call	setcmd		; set up command block for disk op
  3171 00001740 BAF603                  		mov	dx, 3F6h	; hf_reg_port 
  3172 00001743 EE                      		out	dx, al		; write out command modifier
  3173 00001744 E86B00                  		call	docmd		; carry out command
  3174                                  ; ----------------------------------------------------------------------------
  3175                                  
  3176                                  atd4:	
  3177                                  
  3178                                  ;  new code - let logical or clear carry and then set carry if ah!=0
  3179                                  ;	      and save a couple bytes while were at it.
  3180                                  				
  3181 00001747 58                      		pop	ax
  3182                                  		;mov	ah, ds:74h	; [disk_status1]
  3183 00001748 8A267400                		mov	ah, [disk_status1]
  3184 0000174C 08E4                    		or	ah, ah
  3185 0000174E 7401                    		jz	short atd5
  3186 00001750 F9                      		stc
  3187                                  atd5:					
  3188 00001751 07                      		pop	es
  3189 00001752 1F                      		pop	ds
  3190 00001753 5F                      		pop	di
  3191 00001754 5A                      		pop	dx
  3192 00001755 59                      		pop	cx
  3193 00001756 5B                      		pop	bx
  3194 00001757 CA0200                  		retf	2		; far return, dropping flags
  3195                                  
  3196                                  ; =============== S U B	R O U T	I N E ========================================
  3197                                  
  3198                                  ;***	setcmd - set up cmd_block for the disk operation
  3199                                  ;
  3200                                  ;	entry:	(ds) = bios data segment.
  3201                                  ;		(es:bx) in seg:000x form.
  3202                                  ;		other registers as in int 13h call
  3203                                  ;	
  3204                                  ;	exit:	cmd_block set up for disk read call.
  3205                                  ;		control_byte set up for disk operation.
  3206                                  ;		(al) = control byte modifier
  3207                                  ;
  3208                                  ;	sets the fields of cmd_block using the register contents
  3209                                  ;	and the contents of the disk parameter block for the given drive.
  3210                                  ;
  3211                                  ;	warning: (ax) destroyed.
  3212                                  ;		does direct calls to the at rom.
  3213                                  
  3214                                  setcmd:		; proc near		
  3215                                  		;mov	ds:43h,	al	; [cmd_block+sec_cnt]
  3216                                  		; 16/10/2022
  3217 0000175A A24300                  		mov	[cmd_block+sec_cnt], al
  3218                                  		;mov	byte ptr ds:48h, 20h ; [cmd_block+cmd_reg]
  3219 0000175D C606480020              		mov	byte [cmd_block+cmd_reg], 20h ; assume function 02h (read)
  3220 00001762 80FC02                  		cmp	ah, 2
  3221 00001765 7405                    		jz	short setc1	; cmd_reg = 20h	if function 02h	(read)
  3222 00001767 C606480022              		mov	byte [cmd_block+cmd_reg], 22h
  3223                                  		;mov	byte ptr ds:48h, 22h ; [cmd_block+cmd_reg]
  3224                                  					; cmd_reg = 22h	if function 0Ah	(read long)
  3225                                  setc1:					
  3226 0000176C 88C8                    		mov	al, cl
  3227 0000176E 243F                    		and	al, 3Fh		; mask sector number
  3228                                  		;mov	ds:44h,	al	; [cmd_block+sec_num]
  3229                                  		;mov	ds:45h,	ch	; [cmd_block+cyl_low]
  3230 00001770 A24400                  		mov	[cmd_block+sec_num], al ; mov [44h],al
  3231 00001773 882E4500                		mov	[cmd_block+cyl_low], ch ; mov [45h],ch
  3232 00001777 88C8                    		mov	al, cl
  3233 00001779 C0E806                  		shr	al, 6		; get two high bits of cylinder	number
  3234                                  		;mov	ds:46h,	al	; [cmd_block+cyl_high]
  3235 0000177C A24600                  		mov	[cmd_block+cyl_high], al ; mov [46h],al
  3236 0000177F 89D0                    		mov	ax, dx
  3237 00001781 C0E004                  		shl	al, 4		; drive	number
  3238 00001784 80E40F                  		and	ah, 0Fh
  3239 00001787 08E0                    		or	al, ah		; head number
  3240 00001789 0CA0                    		or	al, 0A0h	; set ecc and 512 bytes	per sector
  3241                                  		;mov	ds:47h,	al	; [cmd_block+drv_head]
  3242 0000178B A24700                  		mov	[cmd_block+drv_head], al  ; mov [47h],al 
  3243 0000178E 06                      		push	es
  3244 0000178F 53                      		push	bx
  3245 00001790 0E                      		push	cs
  3246 00001791 E85C00                  		call	get_vec
  3247 00001794 268B4705                		mov	ax, [es:bx+5]	; [es:bx+fdp_precomp]
  3248                                  			 		; write pre-comp from disk parameters
  3249 00001798 C1E802                  		shr	ax, 2
  3250                                  		;mov	ds:42h,	al	; [cmd_block+pre_comp]
  3251 0000179B A24200                  		mov	[cmd_block+pre_comp], al ; mov [42h],al
  3252                                  					; only use low part
  3253 0000179E 268A4708                		mov	al, [es:bx+8]	; [es:bx+fdp_control]
  3254                                  					; control byte modifier
  3255 000017A2 5B                      		pop	bx
  3256 000017A3 07                      		pop	es
  3257                                  		;mov	ah, ds:76h	; [control_byte]
  3258 000017A4 8A267600                		mov	ah, [control_byte] ; mov ah,[76h]
  3259 000017A8 80E4C0                  		and	ah, 0C0h	; keep disable retry bits	
  3260 000017AB 08C4                    		or	ah, al
  3261                                  		;mov	ds:76h,	ah
  3262 000017AD 88267600                		mov	[control_byte], ah ; mov [76h],al
  3263 000017B1 C3                      		retn
  3264                                  
  3265                                  ; =============== S U B	R O U T	I N E ========================================
  3266                                  
  3267                                  ;***	docmd - carry out read operation to at hard disk
  3268                                  ;
  3269                                  ;	entry:	(es:bx) = address for read in data.
  3270                                  ;		cmd_block set up for disk read.
  3271                                  ;
  3272                                  ;	exit:	buffer at (es:bx) contains data read.
  3273                                  ;		disk_status1 set to error code (0 if success).
  3274                                  ;
  3275                                  ;	
  3276                                  ;
  3277                                  ;	warning: (ax), (bl), (cx), (dx), (di) destroyed.
  3278                                  ;		no check is made for dma boundary overrun.
  3279                                  ;
  3280                                  ;	effects: programs disk controller.
  3281                                  ;		performs disk input.
  3282                                  
  3283                                  docmd:		; proc near		
  3284 000017B2 89DF                    		mov	di, bx
  3285 000017B4 0E                      		push	cs
  3286 000017B5 E84000                  		call	command
  3287 000017B8 7535                    		jnz	short doc3
  3288                                  doc1:					
  3289 000017BA 0E                      		push	cs
  3290 000017BB E84200                  		call	waitt		; wait for controller to complete read
  3291 000017BE 752F                    		jnz	short doc3
  3292 000017C0 B90001                  		mov	cx, 256		; 256 words per sector
  3293 000017C3 BAF001                  		mov	dx, 1F0h	; hf_port
  3294 000017C6 FC                      		cld			; string op goes up
  3295 000017C7 FA                      		cli			; disable interrupts
  3296                                  					; (bug was forgetting this)
  3297                                  
  3298                                  ;	M062 -- some of these old machines have intermittent failures
  3299                                  ;		when the read is done at full speed. Instead of using
  3300                                  ;		a string rep instruction, we'll use a loop. There is
  3301                                  ;		a slight performance hit, but it only affects these
  3302                                  ;		very old machines with an exact date code match, and
  3303                                  ;		it makes said machines more reliable
  3304                                  ;
  3305                                  ;M062	repz	insw		;read in sector
  3306                                  
  3307                                  rsct_loop:				
  3308 000017C8 6D                      		insw
  3309 000017C9 E2FD                    		loop	rsct_loop
  3310 000017CB FB                      		sti
  3311                                  		; 16/10/2022
  3312 000017CC F606480002              		test	byte [cmd_block+cmd_reg], 02h
  3313                                  		;test	byte ptr ds:48h, 2 ; [cmd_block+cmd_reg]
  3314                                  					; (ds =	40h)
  3315 000017D1 7410                    		jz	short doc2	; no ecc bytes to read.
  3316 000017D3 0E                      		push	cs
  3317 000017D4 E83100                  		call	wait_drq	; wait for controller to complete read
  3318 000017D7 7216                    		jb	short doc3
  3319 000017D9 B90400                  		mov	cx, 4		; 4 bytes of ecc
  3320 000017DC BAF001                  		mov	dx, 1F0h	; hf_port
  3321 000017DF FA                      		cli
  3322 000017E0 F36C                    		rep insb		; read in ecc
  3323 000017E2 FB                      		sti
  3324                                  doc2:					
  3325 000017E3 0E                      		push	cs
  3326 000017E4 E82900                  		call	check_status
  3327 000017E7 7506                    		jnz	short doc3	; operation failed
  3328                                  		;dec	byte ptr ds:43h	; [cmd_block+sec_cnt]
  3329 000017E9 FE0E4300                		dec	byte [cmd_block+sec_cnt]
  3330 000017ED 75CB                    		jnz	short doc1	; loop while more sectors to read
  3331                                  doc3:					
  3332 000017EF C3                      		retn
  3333                                  
  3334                                  ; =============== S U B	R O U T	I N E ========================================
  3335                                  
  3336                                  ;***	define where the rom routines are actually located
  3337                                  ;	   in the buggy old AT BIOS that we might need to
  3338                                  ;	   install a special level of int13 handler for
  3339                                  
  3340                                  ; 16/10/2022
  3341                                  
  3342                                  romsegment 	equ 0F000h  ; segment
  3343                                  romcommand 	equ 2E1Eh   ; offset in romsegment
  3344                                  romwait		equ 2E7Fh   ; offset in romsegment
  3345                                  romwait_drq 	equ 2EE2h   ; offset in romsegment
  3346                                  romcheck_status equ 2EF8h   ; offset in romsegment
  3347                                  romcheck_dma 	equ 2F69h   ; offset in romsegment	
  3348                                  romget_vec	equ 2F8Eh   ; offset in romsegment
  3349                                  romfret		equ 0FF65h  ; far return in rom	
  3350                                  
  3351                                  ;***	get_vec - get pointer to hard disk parameters.
  3352                                  ;
  3353                                  ;	entry:	(dl) = low bit has hard disk number (0 or 1).
  3354                                  ;
  3355                                  ;	exit:	(es:bx) = address of disk parameters table.
  3356                                  ;
  3357                                  ;	uses:	ax for segment computation.
  3358                                  ;
  3359                                  ;	loads es:bx from interrupt table in low memory, vector 46h (disk 0)
  3360                                  ;	or 70h (disk 1).
  3361                                  ;	
  3362                                  ;	warning: (ax) destroyed.
  3363                                  ;		this does a direct call to the at rom.
  3364                                  
  3365                                  get_vec:	; proc near		
  3366                                  		;push	0FF65h		; romfret ; far	return in rom
  3367                                  		;jmp	far ptr	0F000h:2F8Eh
  3368                                  		; 16/10/2022
  3369 000017F0 6865FF                  		push	romfret		; far return in rom
  3370 000017F3 EA8E2F00F0              		jmp	romsegment:romget_vec
  3371                                  
  3372                                  ; =============== S U B	R O U T	I N E ========================================
  3373                                  
  3374                                  ;***	command - send contents of cmd_block to disk controller.
  3375                                  ;
  3376                                  ;	entry:	control_byte 
  3377                                  ;		cmd_block - set up with values for hard disk controller.
  3378                                  ;
  3379                                  ;	exit:	disk_status1 = error code.
  3380                                  ;		nz if error, zr for no error.
  3381                                  ;
  3382                                  ;
  3383                                  ;	warning: (ax), (cx), (dx) destroyed.
  3384                                  ;		does a direct call to the at rom.
  3385                                  ;
  3386                                  ;	effects: programs disk controller.
  3387                                  
  3388                                  command:	; proc near		
  3389                                  		;push	0FF65h		; romfret ; far	return in rom
  3390                                  		;jmp	far ptr	0F000h:2E1Eh
  3391                                  		; 16/10/2022
  3392 000017F8 6865FF                  		push	romfret		; far return in rom
  3393 000017FB EA1E2E00F0              		jmp	romsegment:romcommand
  3394                                  
  3395                                  ; =============== S U B	R O U T	I N E ========================================
  3396                                  
  3397                                  ;***	waitt - wait for disk interrupt
  3398                                  ;
  3399                                  ;	entry:	nothing.
  3400                                  ;
  3401                                  ;	exit:	disk_status1 = error code.
  3402                                  ;		nz if error, zr if no error.
  3403                                  ;
  3404                                  ;
  3405                                  ;	warning: (ax), (bl), (cx) destroyed.
  3406                                  ;		does a direct call to the at rom.
  3407                                  ;		
  3408                                  ;	effects: calls int 15h, function 9000h.
  3409                                  
  3410                                  waitt:		; proc near		
  3411                                  		;push	0FF65h		; romfret ; far	return in rom
  3412                                  		;jmp	far ptr	0F000h:2E7Fh
  3413                                  		; 16/10/2022
  3414 00001800 6865FF                  		push	romfret		; far return in rom
  3415 00001803 EA7F2E00F0              		jmp	romsegment:romwait
  3416                                  
  3417                                  ; =============== S U B	R O U T	I N E ========================================
  3418                                  
  3419                                  ;***	wait_drq - wait for data request.
  3420                                  ;
  3421                                  ;	entry:	nothing.
  3422                                  ;
  3423                                  ;	exit:	disk_status1 = error code.
  3424                                  ;		cy if error, nc if no error.
  3425                                  ;
  3426                                  ;	warning: (al), (cx), (dx) destroyed.
  3427                                  ;		does a direct call to the at rom.
  3428                                  
  3429                                  wait_drq:	; proc near		
  3430                                  		;push	0FF65h		; romfret ; far	return in rom
  3431                                  		;jmp	far ptr	0F000h:2EE2h
  3432                                  		; 16/10/2022
  3433 00001808 6865FF                  		push	romfret		; far return in rom
  3434 0000180B EAE22E00F0              		jmp	romsegment:romwait_drq
  3435                                  
  3436                                  ; =============== S U B	R O U T	I N E ========================================
  3437                                  
  3438                                  ;***	check_status - check hard disk status.
  3439                                  ;
  3440                                  ;	entry:	nothing.
  3441                                  ;
  3442                                  ;	exit:	disk_status1 = error code.
  3443                                  ;		nz if error, zr if no error.
  3444                                  ;
  3445                                  ;	warning: (ax), (cx), (dx) destroyed.
  3446                                  ;		does a direct call to the at rom.
  3447                                  
  3448                                  check_status:	; proc near		
  3449                                  		;push	0FF65h		; romfret ; far	return in rom
  3450                                  		;jmp	far ptr	0F000h:2EF8h
  3451                                  		; 16/10/2022
  3452 00001810 6865FF                  		push	romfret		; far return in rom
  3453 00001813 EAF82E00F0              		jmp	romsegment:romcheck_status
  3454                                  
  3455                                  ; =============== S U B	R O U T	I N E ========================================
  3456                                  
  3457                                  ;***	check_dma - check for dma overrun 64k segment.
  3458                                  ;
  3459                                  ;	entry:	(es:bx) = addr. of memory buffer in seg:000x form.
  3460                                  ;		cmd_block set up for operation.
  3461                                  ;
  3462                                  ;	exit:	disk_status1 - error code.
  3463                                  ;		cy if error, nc if no error.
  3464                                  ;
  3465                                  ;	warning: does a direct call to the at rom.
  3466                                  
  3467                                  check_dma:	; proc near		
  3468                                  		;push	0FF65h		; romfret ; far	return in rom
  3469                                  		;jmp	far ptr	0F000h:2F69h
  3470                                  		; 16/10/2022
  3471 00001818 6865FF                  		push	romfret		; far return in rom
  3472 0000181B EA692F00F0              		jmp	romsegment:romcheck_dma
  3473                                  
  3474                                  ;-----------------------------------------------------------------------------
  3475                                  
  3476                                  endatrom:
  3477                                  
  3478                                  ; ----------------------------------------------------------------------------
  3479                                  
  3480                                  ;; M015 -- begin changes
  3481                                  ;;
  3482                                  ;; Certain old COMPAQ '286 machines have a bug in their ROM BIOS.
  3483                                  ;; When Int13 is done with AH > 15h and DL >= 80h, they trash
  3484                                  ;; the byte at DS:74h, assuming that DS points to ROM_DATA.
  3485                                  ;; If our init code detects this error, it will install this
  3486                                  ;; special Int13 hook through the same mechanism that was set
  3487                                  ;; up for the IBM patch above. This code is also dynamically
  3488                                  ;; relocated by MSINIT.
  3489                                  
  3490                                  compaq_disk_io:
  3491 00001820 80FC15                  		cmp	ah, 15h		; compaq_disk_io proc far
  3492                                  					;
  3493                                  					; the following	label defines the end of the at	rom patch.
  3494                                  					; this is used at configuration	time.
  3495                                  					;
  3496                                  					; warning!!!
  3497                                  					; this code will be dynamically	relocated by msinit
  3498 00001823 7705                    		ja	short mebbe_hookit ; only deal with functions > 15h
  3499                                  no_hookit:				
  3500                                  		;jmp	cs:Old13
  3501                                  		; 16/10/2022
  3502 00001825 2EFF2E[0601]            		jmp	far [cs:Old13]
  3503                                  
  3504                                  ; ----------------------------------------------------------------------------
  3505                                  
  3506                                  mebbe_hookit:
  3507 0000182A 80FA80                  		cmp	dl, 80h
  3508 0000182D 72F6                    		jb	short no_hookit
  3509 0000182F 1E                      		push	ds
  3510                                  		
  3511                                  		; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  3512                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:1830h
  3513                                  		;push	ax
  3514                                  		;mov	ax, 40h
  3515                                  		;mov	ds, ax
  3516                                  		;pop	ax
  3517 00001830 6A40                    		push	40h
  3518 00001832 1F                      		pop	ds
  3519                                  
  3520 00001833 9C                      		pushf
  3521                                  		;call	cs:Old13
  3522                                  		; 16/10/2022
  3523 00001834 2EFF1E[0601]            		call	far [cs:Old13]
  3524 00001839 1F                      		pop	ds
  3525 0000183A CA0200                  		retf	2
  3526                                  
  3527                                  ; ----------------------------------------------------------------------------
  3528                                  
  3529 0000183D 00                      end_compaq_i13hook: db 0			
  3530                                  
  3531                                  ; =============== S U B	R O U T	I N E ========================================
  3532                                  
  3533                                  ; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  3534                                  %if 0  
  3535                                  
  3536                                  ; CMOS Clock setting support routines used by MSCLOCK.		
  3537                                  ; Warning!!! This code will be dynamically relocated by MSINIT.
  3538                                  
  3539                                  daycnt_to_day:	; proc far
  3540                                  
  3541                                  ; entry: [daycnt] = number of days since 1-1-80
  3542                                  ;
  3543                                  ; return: ch - century in bcd
  3544                                  ;	  cl - year in bcd
  3545                                  ;	  dh - month in bcd
  3546                                  ;	  dl - day in bcd
  3547                                  
  3548                                  		; 16/10/2022		
  3549                                  		push	word [cs:daycnt] ; save daycnt
  3550                                  		cmp	word [cs:daycnt], 7305	; (365*20+(20/4))
  3551                                  					; # days from 1-1-1980 to 1-1-2000
  3552                                  		jnb	short century20
  3553                                  		mov	byte [cs:base_century], 19
  3554                                  		mov	byte [cs:base_year], 80
  3555                                  		jmp	short years
  3556                                  ; ----------------------------------------------------------------------------
  3557                                  		
  3558                                  century20:				
  3559                                  		mov	byte [cs:base_century], 20
  3560                                  		mov	byte [cs:base_year], 0
  3561                                  		sub	word [cs:daycnt], 7305	; (365*20+(20/4))
  3562                                  					; adjust daycnt
  3563                                  years:					
  3564                                  		xor	dx, dx
  3565                                  		mov	ax, [cs:daycnt]
  3566                                  		mov	bx, 1461	; (366+365*3)
  3567                                  					; # of days in a Leap year block
  3568                                  		div	bx		; AX = # of leap block,	DX = daycnt
  3569                                  		mov	[cs:daycnt], dx	; save daycnt left
  3570                                  		mov	bl, 4
  3571                                  		mul	bl		; AX = # of years. Less	than 100
  3572                                  		add	[cs:base_year], al ; So, ah = 0. Adjust year
  3573                                  		inc	word [cs:daycnt]	; set daycnt to	1 base
  3574                                  		cmp	word [cs:daycnt], 366	; daycnt=remainder of leap year	bk
  3575                                  		jbe	short leapyear	; within 366+355+355+355 days.
  3576                                  		inc	byte [cs:base_year]	; if daycnt <= 366, then leap year
  3577                                  		sub	word [cs:daycnt], 366	; else daycnt--, base_year++ ;
  3578                                  		mov	cx, 3		; And next three years are normal
  3579                                  regularyear:				
  3580                                  		cmp	word [cs:daycnt], 365	; for(i=1; i>3 or daycnt <=365;	i++)
  3581                                  		jbe	short yeardone	; {if (daycnt >	365)
  3582                                  		inc	byte [cs:base_year]	;   { daycnt -=	365
  3583                                  		sub	word [cs:daycnt], 365	;   }
  3584                                  		loop	regularyear	; }
  3585                                  					;
  3586                                  					; should never fall through loop
  3587                                  leapyear:				
  3588                                  		mov	byte [cs:month_tab+1], 29 ; leap year.
  3589                                  					; change month table.
  3590                                  yeardone:				
  3591                                  		xor	bx, bx
  3592                                  		xor	dx, dx
  3593                                  		mov	ax, [cs:daycnt]
  3594                                  		;mov	si, offset month_tab
  3595                                  		mov	si, month_tab	; 19/10/2022
  3596                                  		mov	cx, 12
  3597                                  months:					
  3598                                  		inc	bl
  3599                                  
  3600                                  		; !!! -- 16/10/2022 -- (if DS=CS, what for CS: prefixes are used !?)
  3601                                  		;mov	dl, [cs:si]
  3602                                  		; !!! -- 16/10/2022 -- (may be to keep code addrs as unchanged/fix!?)
  3603                                  		; ds = cs !? ((ofcourse ds must be same with cs here))
  3604                                  		;mov	dl, [si] ; 20/03/2019 (MSDOS 6.21 IO.SYS, BIOSDATA:14C0h)
  3605                                  		;mov	dl, [si] ; 16/10/2022 (MSDOS 5.0 IO.SYS, BIOSDATA:14C0h)
  3606                                  		
  3607                                  		mov	dl, [si] ; ?	; mov dl, [cs:si]
  3608                                  		cmp	ax, dx		; cmp daycnt for each month till fit
  3609                                  					; dh=0
  3610                                  		jbe	short month_done
  3611                                  		inc	si		; next month
  3612                                  		sub	ax, dx		; adjust daycnt
  3613                                  		loop	months		;
  3614                                  					; should never fall through loop
  3615                                  month_done:				
  3616                                  		mov	byte [cs:month_tab+1], 28
  3617                                  					; restore month table value
  3618                                  		mov	dl, bl
  3619                                  		mov	dh, [cs:base_year]
  3620                                  		mov	cl, [cs:base_century] ; al=day,dl=month,dh=year,cl=cntry
  3621                                  		call	far [cs:bintobcd]
  3622                                  		;call	cs:bintobcd	; convert "day"	to bcd
  3623                                  					; dl = bcd day,	al = month
  3624                                  		xchg	dl, al
  3625                                  		call	far [cs:bintobcd]
  3626                                  		;call	cs:bintobcd	; dh = bcd month, al = year
  3627                                  		xchg	dh, al
  3628                                  		call	far [cs:bintobcd]
  3629                                  		;call	cs:bintobcd	; cl = bcd year, al = century
  3630                                  		xchg	cl, al
  3631                                  		call	far [cs:bintobcd]
  3632                                  		;call	cs:bintobcd	; ch = bcd century
  3633                                  		mov	ch, al
  3634                                  		pop	word [cs:daycnt] ; restore original value
  3635                                  		retf
  3636                                  
  3637                                  enddaycnttoday:	
  3638                                  
  3639                                  %endif
  3640                                  
  3641                                  ; =============== S U B	R O U T	I N E ========================================
  3642                                  
  3643                                  ; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  3644                                  %if 0  
  3645                                  
  3646                                  bin_to_bcd:	; proc far		; real time clock support
  3647                                  
  3648                                  ;convert a binary input in al (less than 63h or 99 decimal)
  3649                                  ;into a bcd value in al. ah destroyed.	
  3650                                  		
  3651                                  		push	cx		
  3652                                  		aam			; al=high digit	bcd, ah=low digit bcd
  3653                                  		mov	cl, 4
  3654                                  		shl	ah, cl		; mov the high digit to	high nibble
  3655                                  		or	al, ah
  3656                                  		pop	cx
  3657                                  		retf
  3658                                  %endif
  3659                                  
  3660                                  ; ----------------------------------------------------------------------------
  3661                                  
  3662                                  ; the k09 requires the routines for reading the clock because of the suspend/
  3663                                  ; resume facility. the system clock needs to be reset after resume.
  3664                                  
  3665                                  ; the following routine is executed at resume time when the system
  3666                                  ; powered on after suspension. it reads the real time clock and
  3667                                  ; resets the system time and date, and then irets.
  3668                                  
  3669                                  ; warning!!! this code will be dynamically relocated by msinit.
  3670                                  
  3671                                  	; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  3672                                  	; PCDOS 7.1 IBMBIO.COM - BIOSDATA:183Eh
  3673                                  
  3674                                  	; 14/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  3675                                  int_6Ch:
  3676 0000183E 0E                      		push	cs
  3677 0000183F 1F                      		pop	ds
  3678                                  		;cmp	byte [cs:inHMA], 0  
  3679 00001840 803E[0D00]00            		cmp	byte [inHMA], 0
  3680 00001845 7405                    		jz      short int6c
  3681 00001847 BB[2A07]                		mov     bx, EnsureA20On
  3682 0000184A FFD3                    		call    bx
  3683                                  int6c:					
  3684                                  		;push	cs
  3685                                  		;pop	ds
  3686 0000184C 8F06[F805]              		pop	word [int6c_ret_addr]	; pop off return address
  3687 00001850 8F06[FA05]              		pop	word [int6c_ret_addr+2]
  3688 00001854 9D                      		popf
  3689 00001855 E81300                  		call	read_real_date	; get the date from the clock
  3690 00001858 FA                      		cli
  3691 00001859 8936[8904]              		mov	[daycnt], si	; update dos copy of date
  3692 0000185D FB                      		sti
  3693 0000185E E8B900                  		call	read_real_time	; get the time from the	rtc
  3694 00001861 FA                      		cli
  3695 00001862 B401                    		mov	ah, 1
  3696 00001864 CD1A                    		int	1Ah		; CLOCK	- SET TIME OF DAY
  3697                                  					; CX:DX	= clock	count
  3698                                  					; Return: time of day set
  3699 00001866 FB                      		sti
  3700                                  		;jmp	int6c_ret_addr	; long jump
  3701                                  		; 16/10/2022
  3702 00001867 FF2E[F805]              		jmp	far [int6c_ret_addr] ; long jump
  3703                                  
  3704                                  ; =============== S U B	R O U T	I N E ========================================
  3705                                  
  3706                                  ;   read_real_date reads real-time clock for date and returns the number
  3707                                  ;   of days elapsed since 1-1-80 in si
  3708                                  
  3709                                  read_real_date:	; proc near		
  3710 0000186B 50                      		push	ax
  3711 0000186C 51                      		push	cx
  3712 0000186D 52                      		push	dx
  3713 0000186E 30E4                    		xor	ah, ah		; throw	away clock roll	over
  3714 00001870 CD1A                    		int	1Ah		; CLOCK	- GET TIME OF DAY
  3715                                  					; Return: CX:DX	= clock	count
  3716                                  					; AL = 00h if clock was	read or	written	(via AH=0,1) since the previous
  3717                                  					; midnight
  3718                                  					; Otherwise, AL	> 0
  3719 00001872 5A                      		pop	dx
  3720 00001873 59                      		pop	cx
  3721 00001874 58                      		pop	ax
  3722 00001875 50                      		push	ax
  3723 00001876 53                      		push	bx
  3724 00001877 51                      		push	cx
  3725 00001878 52                      		push	dx
  3726                                  		;mov	word [cs:daycnt2], 1
  3727                                  		; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  3728                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:187Ah
  3729 00001879 C706[0006]0100          		mov	word [daycnt2], 1
  3730                                  					; REAL TIME CLOCK ERROR	FLAG (+1 DAY)
  3731 0000187F B404                    		mov	ah, 4
  3732 00001881 CD1A                    		int	1Ah		; CLOCK	- READ DATE FROM REAL TIME CLOCK (AT,XT286,CONV,PS)
  3733                                  					; Return: DL = day in BCD
  3734                                  					; DH = month in	BCD
  3735                                  					; CL = year in BCD
  3736                                  					; CH = century (19h or 20h)
  3737 00001883 7303                    		jnb	short read_ok
  3738 00001885 E98300                  		jmp	r_d_ret
  3739                                  ;-----------------------------------------------------------------------------
  3740                                  
  3741                                  read_ok:
  3742 00001888 882E[FC05]              		mov	[bin_date_time], ch
  3743 0000188C 880E[FD05]              		mov	[bin_date_time+1], cl
  3744 00001890 8836[FE05]              		mov	[bin_date_time+2], dh
  3745 00001894 8816[FF05]              		mov	[bin_date_time+3], dl
  3746                                  		;mov	word [cs:daycnt2], 2 ; READ OF R-T CLOCK SUCCESSFUL
  3747                                  		; 08/08/2023
  3748                                  		;mov	byte [daycnt2], 2
  3749 00001898 FE06[0006]              		inc	byte [daycnt2] ; 2
  3750 0000189C E83401                  		call	bcd_verify	; verify bcd values in range
  3751 0000189F 726A                    		jb	short r_d_ret	; some value out of range
  3752                                  		;mov	word [cs:daycnt2], 3
  3753                                  		; 08/08/2023
  3754                                  		;mov	byte [daycnt2], 3
  3755 000018A1 FE06[0006]              		inc	byte [daycnt2] ; 3
  3756 000018A5 E8DB00                  		call	date_verify
  3757 000018A8 7261                    		jb	short r_d_ret
  3758                                  		;mov	word [cs:daycnt2], 0
  3759                                  		; 08/08/2023
  3760 000018AA C606[0006]00            		mov	byte [daycnt2], 0
  3761 000018AF E8A100                  		call	in_bin
  3762 000018B2 A0[FD05]                		mov	al, [bin_date_time+1]
  3763 000018B5 98                      		cbw
  3764 000018B6 803E[FC05]14            		cmp	byte [bin_date_time], 20 ; 20th century?
  3765 000018BB 7503                    		jnz	short century_19 ; no
  3766 000018BD 83C064                  		add	ax, 100		; add in a century
  3767                                  century_19:				
  3768 000018C0 83E850                  		sub	ax, 80		; subtract off 1-1-80
  3769 000018C3 B104                    		mov	cl, 4		; leap year every 4
  3770 000018C5 F6F1                    		div	cl		; al= #	leap year blocks, ah= remainder
  3771 000018C7 88E3                    		mov	bl, ah		; save odd years
  3772 000018C9 98                      		cbw			; zero ah
  3773 000018CA B9B505                  		mov	cx, 1461	; 366+(3*365)
  3774                                  					; # of days in leap year blocks
  3775 000018CD F7E1                    		mul	cx
  3776                                  		;mov	[cs:daycnt2], ax ; SAVE COUNT OF DAYS
  3777                                  		; 08/08/2023
  3778 000018CF A3[0006]                		mov	[daycnt2], ax
  3779 000018D2 88D8                    		mov	al, bl		; get odd years	count
  3780 000018D4 98                      		cbw
  3781 000018D5 09C0                    		or	ax, ax
  3782 000018D7 740B                    		jz	short leap_year
  3783 000018D9 B96D01                  		mov	cx, 365		; days in year
  3784 000018DC F7E1                    		mul	cx
  3785                                  		;add	[cs:daycnt2], ax ; ADD ON DAYS IN ODD YEARS
  3786                                  		; 08/08/2023
  3787 000018DE 0106[0006]              		add	[daycnt2], ax
  3788 000018E2 EB07                    		jmp	short leap_adjustment ;	account	for leap year
  3789                                  					; possibly account for a leap day
  3790                                  ;-----------------------------------------------------------------------------
  3791                                  
  3792                                  leap_year:
  3793 000018E4 803E[FE05]02            		cmp	byte [bin_date_time+2], 2 ; is	month february?
  3794 000018E9 7604                    		jbe	short no_leap_adjustment ; jan or feb. no leap day yet.
  3795                                  leap_adjustment:
  3796                                  		;inc	word [cs:daycnt2] ; account for leap day
  3797                                  		; 08/08/2023
  3798 000018EB FF06[0006]              		inc	word [daycnt2]
  3799                                  no_leap_adjustment:			
  3800 000018EF 8A0E[FF05]              		mov	cl, [bin_date_time+3] ; get days of month
  3801 000018F3 30ED                    		xor	ch, ch
  3802 000018F5 49                      		dec	cx		; because of offset from day 1,	not day	0
  3803                                  		;add	[cs:daycnt2], cx ; GET DAYS IN MONTHS PRECEEDING
  3804                                  		; 08/08/2023
  3805 000018F6 010E[0006]              		add	[daycnt2], cx
  3806 000018FA 8A0E[FE05]              		mov	cl, [bin_date_time+2] ; get month
  3807                                  		; 08/08/2023
  3808                                  		;xor	ch, ch
  3809 000018FE 49                      		dec	cx		; january starts at offset 0
  3810                                  		
  3811                                  		; 08/08/2023
  3812                                  		;shl	cx, 1		; word offset
  3813                                  		;;mov	si, month_table
  3814                                  		;add	si, cx
  3815                                  		;; 16/10/2022
  3816                                  		;; ds must be same with cs here, if so..
  3817                                  		;; what for cs: prefixes are used !?)
  3818                                  		;; mov	ax, [cs:si]
  3819                                  		;; mov	ax, [si] ; 16/10/2022 (MSDOS 5.0 IO.SYS - BIOSDATA:15D5h)
  3820                                  		;mov	ax, [si]	; mov ax, [cs:si]
  3821                                  		;			; get #	days in	previous months
  3822                                  		;add	[cs:daycnt2], ax
  3823                                  
  3824                                  		; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  3825                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:1907h
  3826 000018FF B400                    		mov	ah, 0
  3827 00001901 BE[8F04]                		mov	si, month_tab
  3828                                  r_d_sum_loop:
  3829 00001904 AC                      		lodsb
  3830 00001905 0106[0006]              		add	[daycnt2], ax
  3831 00001909 E2F9                    		loop	r_d_sum_loop
  3832                                  r_d_ret:
  3833                                  		;mov	si, [cs:daycnt2]
  3834                                  		; 08/08/2023
  3835 0000190B 8B36[0006]              		mov	si, [daycnt2]
  3836 0000190F 5A                      		pop	dx
  3837 00001910 59                      		pop	cx
  3838 00001911 5B                      		pop	bx
  3839 00001912 58                      		pop	ax
  3840 00001913 C3                      		retn
  3841                                  
  3842                                  ;-----------------------------------------------------------------------------
  3843                                  r_t_retj:				
  3844 00001914 31C9                    		xor	cx, cx
  3845 00001916 31D2                    		xor	dx, dx
  3846 00001918 EB38                    		jmp	short r_t_ret
  3847                                  
  3848                                  ; =============== S U B	R O U T	I N E ========================================
  3849                                  
  3850                                  ; read_real_time reads the time from the rtc. on exit, it has the number of
  3851                                  ; ticks (at 18.2 ticks per sec.) in cx:dx.
  3852                                  
  3853                                  read_real_time:	; proc near		
  3854 0000191A B402                    		mov	ah, 2
  3855 0000191C CD1A                    		int	1Ah		; CLOCK	- READ REAL TIME CLOCK (AT,XT286,CONV,PS)
  3856                                  					; Return: CH = hours in	BCD
  3857                                  					; CL = minutes in BCD
  3858                                  					; DH = seconds in BCD
  3859 0000191E 72F4                    		jb	short r_t_retj
  3860 00001920 882E[FC05]              		mov	[bin_date_time], ch ; hours
  3861 00001924 880E[FD05]              		mov	[bin_date_time+1], cl ; minutes
  3862 00001928 8836[FE05]              		mov	[bin_date_time+2], dh ; seconds
  3863 0000192C C606[FF05]00            		mov	byte [bin_date_time+3], 0 ; unused for time
  3864 00001931 E89F00                  		call	bcd_verify
  3865 00001934 72DE                    		jb	short r_t_retj
  3866 00001936 E88500                  		call	time_verify
  3867 00001939 72D9                    		jb	short r_t_retj
  3868 0000193B E81500                  		call	in_bin		; from bcd to bin
  3869 0000193E 8A2E[FC05]              		mov	ch, [bin_date_time]
  3870 00001942 8A0E[FD05]              		mov	cl, [bin_date_time+1]
  3871 00001946 8A36[FE05]              		mov	dh, [bin_date_time+2]
  3872 0000194A 8A16[FF05]              		mov	dl, [bin_date_time+3]
  3873                                  		; 16/10/2022
  3874                                  		; 17/09/2022
  3875                                  		; 31/05/2019
  3876 0000194E FF1E[0606]              		call	far [ttticks] 
  3877                                  		;call	dword ptr ttticks ; note: indirect far call
  3878                                  					; cx:dx	= number of ticks
  3879                                  					; (at 18.2 ticks per sec.)
  3880                                  r_t_ret:				
  3881 00001952 C3                      		retn
  3882                                  
  3883                                  ; =============== S U B	R O U T	I N E =======================================
  3884                                  
  3885                                  ;   in_bin converts bin_date_time values from bcd to bin
  3886                                  
  3887                                  in_bin:		; proc near
  3888 00001953 A0[FC05]                		mov	al, [bin_date_time] ; century or hours
  3889 00001956 E81F00                  		call	bcd_to_bin
  3890 00001959 A2[FC05]                		mov	[bin_date_time], al
  3891 0000195C A0[FD05]                		mov	al, [bin_date_time+1] ; years or minutes
  3892 0000195F E81600                  		call	bcd_to_bin
  3893 00001962 A2[FD05]                		mov	[bin_date_time+1], al
  3894 00001965 A0[FE05]                		mov	al, [bin_date_time+2] ; months or seconds
  3895 00001968 E80D00                  		call	bcd_to_bin
  3896 0000196B A2[FE05]                		mov	[bin_date_time+2], al
  3897 0000196E A0[FF05]                		mov	al, [bin_date_time+3] ; days (not used for time)
  3898 00001971 E80400                  		call	bcd_to_bin
  3899 00001974 A2[FF05]                		mov	[bin_date_time+3], al
  3900 00001977 C3                      		retn
  3901                                  
  3902                                  ; =============== S U B	R O U T	I N E =======================================
  3903                                  
  3904                                  ;   bcd_to_bin converts two bcd nibbles in al (value <= 99.) to
  3905                                  ;   a binary representation in al
  3906                                  ;   ah is destroyed
  3907                                  
  3908                                  bcd_to_bin:	; proc near
  3909 00001978 88C4                    		mov	ah, al
  3910 0000197A 240F                    		and	al, 0Fh
  3911 0000197C B104                    		mov	cl, 4
  3912 0000197E D2EC                    		shr	ah, cl
  3913 00001980 D50A                    		aad
  3914 00001982 C3                      		retn
  3915                                  
  3916                                  ; =============== S U B	R O U T	I N E ========================================
  3917                                  
  3918                                  ;   date_verify loosely checks bcd date values to be in range
  3919                                  ;   in bin_date_time
  3920                                  
  3921                                  date_verify:	; proc near
  3922 00001983 803E[FC05]20            		cmp	byte [bin_date_time], 20h ; century check
  3923 00001988 7732                    		ja	short date_error
  3924 0000198A 740E                    		jz	short century_20 ; jmp in 21th century
  3925 0000198C 803E[FC05]19            		cmp	byte [bin_date_time], 19h ; century check
  3926                                  		;jb	short date_error
  3927                                  		; 12/12/2022
  3928 00001991 722A                    		jb	short date_err2
  3929 00001993 803E[FD05]80            		cmp	byte [bin_date_time+1], 80h ; year check
  3930                                  		;jb	short date_error
  3931                                  		; 12/12/2022
  3932 00001998 7223                    		jb	short date_err2
  3933                                  century_20:
  3934 0000199A 803E[FD05]99            		cmp	byte [bin_date_time+1], 99h ; year check
  3935 0000199F 771B                    		ja	short date_error
  3936 000019A1 803E[FE05]12            		cmp	byte [bin_date_time+2], 12h ; month check
  3937 000019A6 7714                    		ja	short date_error
  3938 000019A8 803E[FE05]00            		cmp	byte [bin_date_time+2], 0
  3939                                  		;jbe	short date_error
  3940 000019AD 760D                    		jna	short date_error
  3941 000019AF 803E[FF05]31            		cmp	byte [bin_date_time+3], 31h ; day check
  3942 000019B4 7706                    		ja	short date_error
  3943                                  		;cmp	byte [bin_date_time+3], 0 ; day check
  3944                                  		;;jbe	short date_error
  3945                                  		;jna	short date_error
  3946                                  		; 12/12/2022
  3947                                  		; cf=0
  3948                                  		;clc
  3949                                  		; 12/12/2022
  3950 000019B6 803E[FF05]01            		cmp	byte [bin_date_time+3], 1 ; day check
  3951 000019BB C3                      		retn
  3952                                  ;-----------------------------------------------------------------------------
  3953                                  
  3954                                  date_error:
  3955 000019BC F9                      		stc
  3956                                  date_err2:
  3957 000019BD C3                      		retn
  3958                                  
  3959                                  ; =============== S U B	R O U T	I N E ========================================
  3960                                  
  3961                                  ; time_verify very loosely checks bcd date values to be in range
  3962                                  ; in bin_date_time
  3963                                  
  3964                                  time_verify:	; proc near
  3965 000019BE 803E[FC05]24            		cmp	byte [bin_date_time], 24h ; hour check
  3966 000019C3 770C                    		ja	short time_error
  3967 000019C5 803E[FD05]59            		cmp	byte [bin_date_time+1], 59h ; minute check
  3968 000019CA 7705                    		ja	short time_error
  3969                                  		; 12/12/2022h
  3970                                  		;cmp	byte [bin_date_time+2], 59h ; second check
  3971                                  		;ja	short time_error
  3972                                  		;clc
  3973                                  		;retn
  3974                                  		; 12/12/2022
  3975 000019CC 803E[FE05]5A            		cmp	byte [bin_date_time+2], 5Ah	
  3976                                  time_error:
  3977                                  bv_error:
  3978 000019D1 F5                      		cmc	; cf=0 -> cf=1, cf=1 -> cf=0
  3979 000019D2 C3                      		retn
  3980                                  
  3981                                  ; ----------------------------------------------------------------------------
  3982                                  
  3983                                  ;time_error:				
  3984                                  		;stc
  3985                                  		;retn
  3986                                  
  3987                                  ; =============== S U B	R O U T	I N E ========================================
  3988                                  
  3989                                  ;   bcd_verify checks values in bin_date_time to be valid
  3990                                  ;   bcd numerals.  carry set if any nibble out of range
  3991                                  
  3992                                  bcd_verify:	; proc near
  3993 000019D3 B90400                  		mov	cx, 4		; 4 bytes to check
  3994 000019D6 BB[FC05]                		mov	bx, bin_date_time
  3995                                  bv_loop:
  3996 000019D9 8A07                    		mov	al, [bx]	; get a	bcd number (0..99)
  3997 000019DB 88C4                    		mov	ah, al
  3998 000019DD 250FF0                  		and	ax, 0F00Fh	; 10's place in high ah, 1's in al
  3999                                  					; is 1's place in range?
  4000 000019E0 3C0A                    		cmp	al, 10
  4001 000019E2 77ED                    		ja	short bv_error	; jmp out of range
  4002 000019E4 D0EC                    		shr	ah, 1
  4003 000019E6 D0EC                    		shr	ah, 1
  4004 000019E8 D0EC                    		shr	ah, 1
  4005 000019EA D0EC                    		shr	ah, 1
  4006 000019EC 80E40F                  		and	ah, 0Fh		; get rid of any erroneous bits
  4007 000019EF 80FC0A                  		cmp	ah, 10		; is 10's place in range
  4008 000019F2 77DD                    		ja	short bv_error	; jmp out of range
  4009 000019F4 43                      		inc	bx		; next byte
  4010 000019F5 49                      		dec	cx
  4011 000019F6 75E1                    		jnz	short bv_loop
  4012 000019F8 F8                      		clc			; set success flag
  4013 000019F9 C3                      		retn
  4014                                  ; ----------------------------------------------------------------------------
  4015                                  
  4016                                  		; 12/12/2022
  4017                                  ;bv_error:
  4018                                  		;stc			; set error flag
  4019                                  		;retn
  4020                                  
  4021                                  ; ----------------------------------------------------------------------------
  4022                                  
  4023                                  endk09:
  4024                                  
  4025                                  ; ----------------------------------------------------------------------------
  4026                                  
  4027                                  ;------------------------------------------------------------------------
  4028                                  ;									:
  4029                                  ;	System initialization						:
  4030                                  ;									:
  4031                                  ;	The entry conditions are established by the bootstrap		:
  4032                                  ;	loader and are considered unknown. The following jobs		:
  4033                                  ;	will be performed by this module:				:
  4034                                  ;									:
  4035                                  ;	1.	All device initialization is performed			:
  4036                                  ;	2.	A local stack is set up and DS:SI are set		:
  4037                                  ;		to point to an initialization table. Then		:
  4038                                  ;		an inter-segment call is made to the first		:
  4039                                  ;		byte of the dos 					:
  4040                                  ;	3.	Once the dos returns from this call the ds		:
  4041                                  ;		register has been set up to point to the start		:
  4042                                  ;		of free memory. The initialization will then		:
  4043                                  ;		load the command program into this area 		:
  4044                                  ;		beginning at 100 hex and transfer control to		:
  4045                                  ;		this program.						:
  4046                                  ;									:
  4047                                  ;------------------------------------------------------------------------
  4048                                  
  4049                                  ; 01/10/2022
  4050                                  ; 08/01/2018 - Retro DOS v4.0
  4051                                  ; 14/10/2023 - Retro DOS v5.0
  4052                                  
  4053                                  ; drvfat must be the first location of freeable space!
  4054                                  
  4055                                  align 2
  4056                                  		;db 90h
  4057                                  
  4058                                  ; 20/12/2022 - Retro DOS v4.0 (MSDOS 5.0 combined/single kernel file)
  4059                                  ; ((no need to read/load 'MSDOS.SYS', it is already loaded))
  4060                                  ; (((bios_l,bios_h,doscnt,fatloc,md_sectorsize,temp_cluster,last_fat_sec_num
  4061                                  ;   would be used to read 'MSDOS.SYS' from disk, now they are not needed)))
  4062                                  	
  4063 000019FA 0000                    drvfat:		dw 0			; drive	and fat	id of dos
  4064                                  ;First_Data_Sector:	; 14/10/2023
  4065                                  ;bios_l:	dw 0			; first	sector of data (low word)
  4066                                  ;bios_h:	dw 0			; first	sector of data (high word)
  4067                                  ;doscnt:	dw 0			; how many sectors to read
  4068 000019FC 00                      fbigfat:	db 0			; flags	for drive
  4069                                  ;fatloc:	dw 0			; seg addr of fat sector
  4070 000019FD 0000                    init_bootseg:	dw 0			; seg addr of buffer for reading boot record
  4071 000019FF 80                      rom_drv_num:	db 80h			; rom drive number
  4072                                  ;md_sectorsize:	dw 200h			; used by get_fat_sector proc.
  4073                                  ;temp_cluster:	dw 0			; used by get_fat_sector proc.
  4074                                  ;last_fat_sec_num: dw 0FFFFh		; used by get_fat_sector proc.
  4075                                  
  4076                                  ; the following two bytes are used to save the info returned by int 13, ah = 8
  4077                                  ; call to determine drive parameters.
  4078                                  
  4079 00001A00 02                      num_heads:	db 2			; number of heads returned by rom
  4080                                  		;db 0	; 08/08/2023
  4081 00001A01 09                      sec_trk:	db 9			; sec/trk returned by rom
  4082 00001A02 28                      num_cyln:	db 40			; number of cylinders returned by rom
  4083                                  		;db 0	; 08/08/2023
  4084 00001A03 00                      fakefloppydrv:	db 0			; if 1,	then no	diskette drives	in the system.
  4085                                  
  4086                                  ; 14/10/2023 - Retro DOS v5.0
  4087                                  ; PCDOS 7.1 - IBMBIO.COM - BIOSDATA:1A26h
  4088                                  
  4089                                  Orig_Int1Eh_Table:
  4090 00001A04 00000000                		dd 0
  4091                                  
  4092                                  ; ----------------------------------------------------------------------------
  4093                                  
  4094                                  
  4095                                  ; 14/10/2023 - Retro DOS v5.0
  4096                                  %if 0
  4097                                  
  4098                                  disktable:	dw 512,	0100h, 64, 0	; warning !!! old values
  4099                                  		dw 2048, 0201h, 112, 0
  4100                                  		dw 8192, 0402h, 256, 0
  4101                                  		dw 32680, 0803h, 512, 0	; warning !!! old values
  4102                                  		dw 65535, 1004h, 1024, 0
  4103                                  					; default disktable under
  4104                                  					; the assumption of total fat size <= 128 kb,
  4105                                  					; and the maximum size of fat entry = 16 bit.
  4106                                  %endif
  4107                                  
  4108                                  
  4109                                  ; 14/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  4110                                  ; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:1A2Ah)
  4111                                  
  4112                                  		; 08/08/2023
  4113                                  		; disktable.totalsectors: resd 1
  4114                                  		; disktable.shiftcount:   resb 1
  4115                                  		; disktable.secperclus:   resb 1
  4116                                  		; disktable.rdirentries:  resw 1
  4117                                  		; disktable.bigflag:      resw 1
  4118 00001A08 0000A87F0308000200-     disktable2:	dw 0, 32680, 0803h, 512, 0 ; for compatibility.
  4118 00001A11 00                 
  4119                                  					   ; (32680 sectors, 16340 KB)
  4120 00001A12 040000000204000240-     		dw 4, 0, 0402h, 512, 40h   ; covers upto 134 mb media.
  4120 00001A1B 00                 
  4121                                  					   ; fbig = 40h  ; (40000h sectors = 128 MB)
  4122 00001A1C 080000000308000240-     		dw 8, 0, 0803h, 512, 40h   ; upto 268 mb ; (80000h sectors = 256 MB)
  4122 00001A25 00                 
  4123 00001A26 100000000410000240-     		dw 16, 0, 1004h, 512, 40h  ; upto 536 mb ; (100000h sectors = 512 MB)
  4123 00001A2F 00                 
  4124 00001A30 200000000520000240-     		dw 32, 0, 2005h, 512, 40h  ; upto 1072 mb ; (200000h sectors = 1024 MB)
  4124 00001A39 00                 
  4125 00001A3A 400000000640000240-     		dw 64, 0, 4006h, 512, 40h  ; upto 2144 mb ; (400000h sectors = 2048 MB)
  4125 00001A43 00                 
  4126                                  		; 14/10/2023
  4127                                  		;dw 128, 0, 8007h, 512, 40h ; upto 4288 mb ; (800000h sectors = 4096 MB)
  4128 00001A44 FFFFFFFF0308000060-     		dw 0FFFFh, 0FFFFh, 0803h, 0, 60h
  4128 00001A4D 00                 
  4129                                  					; cluster shift 3, sec per clust = 8
  4130                                  					; > 2144 MB ; FAT32 (fbigbig = 20h)
  4131                                  					; (fbig and fbigbig flags are set)		
  4132                                  			
  4133                                  ; ----------------------------------------------------------------------------
  4134                                  
  4135                                  ;******************************************************
  4136                                  ;variables for mini disk initialization
  4137                                  ;******************************************************
  4138                                  
  4139                                  ; 01/10/2022
  4140                                  ; [ Note: Minidisk == logical dos drive (in extended dos partition) ] 
  4141                                  
  4142 00001A4E 00                      rom_minidisk_num: db 0			; temp variable	for phys unit
  4143 00001A4F 00                      hnum:		db 0			; real number of hardfiles
  4144 00001A50 [3C05]                  last_dskdrv_table: dw dskdrvs		; index	into dskdrv table
  4145 00001A52 [4C08]                  end_of_bdss:	dw bdss			; offset value of the ending address
  4146                                  					; of bds table. needed to figure out
  4147                                  					; the dosdatasg address.
  4148 00001A54 0000                    mini_hdlim:	dw 0			
  4149 00001A56 0000                    mini_seclim:	dw 0
  4150                                  
  4151                                  ; 14/10/2023 - Retro DOS v5.0 IBMBIO.COM (Modified PCDOS 7.1)
  4152                                  ; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:1A7Ah) ((ld_p_number))
  4153                                  ; ((Note: 2BADh will be overwritten in 'find_mini_partition', not used.
  4154                                  ;   PCDOS 7.1 IBMBIO.COM contains this number, may be signature))
  4155                                  
  4156                                  ; 19/12/2023
  4157                                  ;ld_p_number:	dw 2BADh     ; (logical disk partition index/sequence number)
  4158                                  
  4159                                  ;end of mini disk init variables **********************
  4160                                  
  4161                                  ; ----------------------------------------------------------------------------
  4162                                  			
  4163 00001A58 30312F31302F383400      bios_date:	db '01/10/84',0 	; used for checking at rom bios	date.
  4164                                  
  4165                                  ; 13/12/2022
  4166                                  %if 0
  4167                                  
  4168                                  ;align 2
  4169                                  		db  90h	
  4170                                  
  4171                                  ; the following are the recommended bpbs for the media that we know of so far.
  4172                                  
  4173                                  ;struc bpbx
  4174                                  ;   resw 1 ; 512
  4175                                  ;   resb 1
  4176                                  ;   resw 1 ; 1
  4177                                  ;   resb 1 ; 2
  4178                                  ;   resw 1
  4179                                  ;   resw 1
  4180                                  ;   resb 1
  4181                                  ;   resw 1
  4182                                  ;   resw 1
  4183                                  ;   resw 1 ; 2
  4184                                  ;   resw 1
  4185                                  ;   resw 1 ; hidden sector high
  4186                                  ;   resd 1 ; extended total sectors
  4187                                  ;.size:
  4188                                  ;endstruc
  4189                                  
  4190                                  ; 08/01/2019 - Retro DOS v4.0
  4191                                  
  4192                                  ; 20/04/2019
  4193                                  
  4194                                  ; 01/10/2022 - Retro DOS v4.0 (MSDOS 5.0) IO.SYS
  4195                                  
  4196                                  ; 09/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  4197                                  ; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:1A86h)
  4198                                  
  4199                                  ; 09/12/2022
  4200                                  BPB48T:
  4201                                  ;bpb48t:	; bpbx <512, 2, 1, 2, 112, 720, 0FDh, 2, 9, 2, 0, 0, 0, 0> 
  4202                                  		; 48 tpi diskettes	;
  4203                                  		dw	512		; physical sector size in bytes
  4204                                  		db	2		; sectors/allocation unit
  4205                                  		dw	1		; reserved sectors for dos
  4206                                  		db	2		; number of allocation tables
  4207                                  		dw	112		; number of directory entries
  4208                                  		dw	720 ; 2*9*40	; number of sectors (at 512 bytes each)
  4209                                  		db	0FDh		; media descriptor
  4210                                  		dw	2		; number of fat sectors
  4211                                  		dw	9		; sectors per track
  4212                                  		dw	2		; heads
  4213                                  		dw	0		; hidden sector count (low word)
  4214                                  		dw	0		; hidden sector (high)
  4215                                  		dw	0		; number of sectors (low)
  4216                                  		dw	0		; number of sectors (high)
  4217                                  		; 09/12/2023
  4218                                  		; FAT32 extensions (to BDS)
  4219                                  		times	28 db 0
  4220                                  		;
  4221                                  		db 90h
  4222                                  ;align 2
  4223                                  BPB96T:
  4224                                  ;bpb96t:	; bpbx <512, 1, 1, 2, 224, 2400, 0F9h, 7, 15, 2, 0, 0, 0, 0> 
  4225                                  		; 96 tpi diskettes	;
  4226                                  		dw	512		; physical sector size in bytes
  4227                                  		db	1		; sectors/allocation unit
  4228                                  		dw	1		; reserved sectors for dos
  4229                                  		db	2		; number of allocation tables
  4230                                  		dw	224		; number of directory entries
  4231                                  		dw	2400 ; 2*15*80	; number of sectors (at 512 bytes each)
  4232                                  		db	0F9h		; media descriptor
  4233                                  		dw	7		; number of fat sectors
  4234                                  		dw	15		; sectors per track
  4235                                  		dw	2		; heads
  4236                                  		dw	0		; hidden sector count (low word)
  4237                                  		dw	0		; hidden sector (high)
  4238                                  		dw	0		; number of sectors (low)
  4239                                  		dw	0		; number of sectors (high)
  4240                                  		; 09/12/2023
  4241                                  		; FAT32 extensions (to BDS)
  4242                                  		times	28 db 0
  4243                                  		;
  4244                                  		db 90h
  4245                                  ;align 2
  4246                                  BPB35:
  4247                                  ;bpb35:		; bpbx <512, 2, 1, 2, 112, 1440, 0F9h, 3, 9, 2, 0, 0, 0, 0> 
  4248                                  		; 3.5" diskettes - 720 KB ;		
  4249                                  		dw	512		; physical sector size in bytes
  4250                                  		db	2		; sectors/allocation unit
  4251                                  		dw	1		; reserved sectors for dos
  4252                                  		db	2		; number of allocation tables
  4253                                  		dw	112		; number of directory entries
  4254                                  		dw	1440 ; 2*9*80	; number of sectors (at 512 bytes each)
  4255                                  		db	0F9h		; media descriptor
  4256                                  		dw	3		; number of fat sectors
  4257                                  		dw	9		; sectors per track
  4258                                  		dw	2		; heads
  4259                                  		dw	0		; hidden sector count (low word)
  4260                                  		dw	0		; hidden sector (high)
  4261                                  		dw	0		; number of sectors (low)
  4262                                  		dw	0		; number of sectors (high)
  4263                                  		; 09/12/2023
  4264                                  		; FAT32 extensions (to BDS)
  4265                                  		times	28 db 0
  4266                                  		;
  4267                                  		db 90h
  4268                                  ;align 2
  4269                                  
  4270                                  ;align 2
  4271                                  ;BPB144:
  4272                                  ;bpb144:	; Retro DOS v4.0 feature only !	; 1.44MB diskettes
  4273                                  ;
  4274                                  ;		dw	512		; physical sector size in bytes
  4275                                  ;		db	1		; sectors/allocation unit
  4276                                  ;		dw	1		; reserved sectors for dos
  4277                                  ;		db	2		; number of allocation tables
  4278                                  ;		dw	224		; number of directory entries
  4279                                  ;		dw	2880 ; 2*18*80	; number of sectors (at 512 bytes each)
  4280                                  ;		db	0F0h		; media descriptor
  4281                                  ;		dw	9		; number of fat sectors
  4282                                  ;		dw	18		; sectors per track
  4283                                  ;		dw	2		; heads
  4284                                  ;		dw	0		; hidden sector count (low word)
  4285                                  ;		dw	0		; hidden sector (high)
  4286                                  ;		dw	0		; number of sectors (low)
  4287                                  ;		dw	0		; number of sectors (high)
  4288                                  ;
  4289                                  ;		db 90h
  4290                                  ;align 2
  4291                                  
  4292                                  BPB288:
  4293                                  ;bpb288:	; bpbx <512, 2, 1, 2, 240, 5760, 0F0h, 9, 36, 2, 0, 0, 0, 0>
  4294                                  		; 3.5" diskettes - 2.88 MB ;	 
  4295                                  		dw	512		; physical sector size in bytes
  4296                                  		db	2		; sectors/allocation unit
  4297                                  		dw	1		; reserved sectors for dos
  4298                                  		db	2		; number of allocation tables
  4299                                  		dw	240		; number of directory entries
  4300                                  		dw	5760 ; 2*36*80	; number of sectors (at 512 bytes each)
  4301                                  		db	0F0h		; media descriptor
  4302                                  		dw	3		; number of fat sectors
  4303                                  		dw	9		; sectors per track
  4304                                  		dw	2		; heads
  4305                                  		dw	0		; hidden sector count (low word)
  4306                                  		dw	0		; hidden sector (high)
  4307                                  		dw	0		; number of sectors (low)
  4308                                  		dw	0		; number of sectors (high)
  4309                                  		; 09/12/2023
  4310                                  		; FAT32 extensions (to BDS)
  4311                                  		times	28 db 0
  4312                                  		;
  4313                                  		db 90h
  4314                                  ;align 2
  4315                                  
  4316                                  %endif
  4317                                  
  4318                                  ; ----------------------------------------------------------------------------
  4319                                  					; align	2
  4320                                  ; 09/12/2022
  4321                                  %if 0
  4322                                  bpbtable:	dw bpb48t		; 48tpi	drives
  4323                                  		dw bpb96t		; 96tpi	drives
  4324                                  		dw bpb35		; 3.5" drives
  4325                                  		dw bpb35		; unused 8" diskette
  4326                                  		dw bpb35		; unused 8" diskette
  4327                                  		dw bpb35		; used for hard	disk
  4328                                  		dw bpb35		; used for tape	drive
  4329                                  		dw bpb35		; FFOTHER
  4330                                  		dw bpb35		; ERIMO
  4331                                  		dw bpb288		; 2.88MB drive
  4332                                  		;
  4333                                  		;dw bpb144		; 1.44MB drive - Retro DOS v4.0 feature !
  4334                                  %endif
  4335                                  
  4336                                  ; 13/12/2022
  4337                                  %if 0
  4338                                  BPBTABLE:	dw BPB48T		; 48tpi	drives
  4339                                  		dw BPB96T		; 96tpi	drives
  4340                                  		dw BPB35		; 3.5" drives
  4341                                  		dw BPB35		; unused 8" diskette
  4342                                  		dw BPB35		; unused 8" diskette
  4343                                  		dw BPB35		; used for hard	disk
  4344                                  		dw BPB35		; used for tape	drive
  4345                                  		dw BPB35		; FFOTHER
  4346                                  		dw BPB35		; ERIMO
  4347                                  		dw BPB288		; 2.88MB drive
  4348                                  		;
  4349                                  		;dw BPB144		; 1.44MB drive - Retro DOS v4.0 feature !
  4350                                  
  4351                                  %endif
  4352                                  
  4353                                  ; ----------------------------------------------------------------------------
  4354                                  
  4355                                  ;	entry point to call utility functions in Bios_Code. At this time,
  4356                                  ;	  we aren't doing any A20 switching. During MSINIT time Bios_Code
  4357                                  ;	  will not yet be moved to its final resting place, so we know
  4358                                  ;	  it'll be low.
  4359                                  ;
  4360                                  ;	to use this function, do a "push cs" and load bp with the offset of
  4361                                  ;	  the function you want to call in Bios_Code. This routine will
  4362                                  ;	  push the address of a retf in Bios_Code onto the stack which
  4363                                  ;	  will get executed when the utility function finishes. It will
  4364                                  ;	  then transfer control to Bios_Code:bp using a couple of pushes
  4365                                  ;	  and a retf
  4366                                  
  4367                                  ; 16/10/2022
  4368                                  ;BC_RETF equ bc_retf - DOSBIOSEG_2C7h
  4369                                  ; 09/12/2022
  4370                                  BC_RETF equ bc_retf
  4371                                  
  4372                                  ; 09/12/2023
  4373                                  ;PCDOS 7.1 IBMBIO.COM bc_retf offset = 0CAh (in BIOSCODE segment = 364h)
  4374                                  
  4375                                  addr_of_bcretf:	;dw 0C8h		; dw bc_retf
  4376                                  					; 2C7h:0C8h = 70h:2638h
  4377                                  					; 09/12/2023
  4378                                  					; 364h:0CAh = 70h:300Ah ; PCDOS 7.1
  4379 00001A61 [CA00]                  		dw BC_RETF		; dw 0CAh
  4380                                  
  4381                                  ; ----------------------------------------------------------------------------
  4382                                  
  4383                                  call_bios_code:	; proc far			
  4384 00001A63 2EFF36[611A]            		push	word [cs:addr_of_bcretf] 
  4385                                  					; set up near return to far return
  4386 00001A68 2EFF36[0406]            		push	word [cs:cdev+2] ; push Bios_Code segment
  4387 00001A6D 55                      		push	bp		; save offset of utility function
  4388 00001A6E CB                      		retf			; far jump to (DOS)BIOS code
  4389                                  
  4390                                  ; ----------------------------------------------------------------------------
  4391                                  		
  4392                                  ;		; 11/12/2023 - Retro DOS v5.0 IBMBIO.COM/IO.SYS
  4393                                  ;		; 20/12/2022
  4394                                  ;flp_drvs:	db 0
  4395                                  ;		; 11/12/2023
  4396                                  ;		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:1B81h)
  4397                                  ;firstcluster_hw: 
  4398                                  ;		db 0
  4399                                  ;Boot_Drv:	db 0
  4400                                  
  4401                                  ; ----------------------------------------------------------------------------
  4402                                  
  4403                                  ; 09/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  4404                                  ;-----------------------------------------------------------------------------
  4405                                  ; PCDOS 7.1 CD BOOT option code 
  4406                                  ;-----------------------------------------------------------------------------
  4407                                  ; (PCDOS 7.1 IBMBIO.COM, BIOSDATA:1B84h)
  4408                                  
  4409                                  cd_boot_option:
  4410                                  		; 10/12/2023 - Retro DOS v5.0 (combined kernel)
  4411                                  		;push	ax
  4412                                  		;push	ds
  4413                                  		;push	es
  4414 00001A6F 52                      		push	dx  ; driver number (dl), media byte (dh)
  4415                                  cdbo_1:
  4416 00001A70 B401                    		mov	ah, 1
  4417 00001A72 CD16                    		int	16h			; KEYBOARD - status
  4418 00001A74 7406                    		jz	short cdbo_2
  4419 00001A76 30E4                    		xor	ah,ah
  4420 00001A78 CD16                    		int	16h			; KEYBOARD - READ CHAR FROM BUFFER, WAIT IF EMPTY
  4421                                  						; Return: AH = scan code, AL = character
  4422 00001A7A EBF4                    		jmp	short cdbo_1
  4423                                  cdbo_2:
  4424 00001A7C 0E                      		push	cs
  4425 00001A7D 1F                      		pop	ds
  4426 00001A7E BE[411B]                		mov	si, cd_boot_msg		; "Press the ENTER key to boot from CD"...
  4427 00001A81 AC                      		lodsb
  4428                                  cdbo_3:
  4429 00001A82 BB0700                  		mov	bx, 7
  4430 00001A85 B40E                    		mov	ah, 0Eh
  4431 00001A87 CD10                    		int	10h			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
  4432                                  						; AL = character, BH = display page (alpha modes)
  4433                                  						; BL = foreground color (graphics modes)
  4434 00001A89 AC                      		lodsb
  4435 00001A8A 08C0                    		or	al, al
  4436 00001A8C 75F4                    		jnz	short cdbo_3
  4437 00001A8E B84000                  		mov	ax, 40h
  4438 00001A91 8ED8                    		mov	ds, ax
  4439                                  		;mov	bx, [6Ch]		; 0:46Ch = Daily timer counter (4 bytes)
  4440                                  		; 09/12/2023
  4441 00001A93 8B166C00                		mov	dx, [6Ch]
  4442 00001A97 8B366E00                		mov	si, [6Eh]
  4443                                  wait_for_key:
  4444                                  		;push	bx
  4445                                  		;mov	bx, 7
  4446                                  		; bx = 7
  4447 00001A9B B8080E                  		mov	ax, 0E08h
  4448 00001A9E CD10                    		int	10h			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
  4449                                  						; AL = character, BH = display page (alpha modes)
  4450                                  						; BL = foreground color (graphics modes)
  4451 00001AA0 B8200E                  		mov	ax, 0E20h
  4452 00001AA3 CD10                    		int	10h			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
  4453                                  						; AL = character, BH = display page (alpha modes)
  4454                                  						; BL = foreground color (graphics modes)
  4455 00001AA5 B8080E                  		mov	ax, 0E08h
  4456 00001AA8 CD10                    		int	10h			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
  4457                                  						; AL = character, BH = display page (alpha modes)
  4458                                  						; BL = foreground color (graphics modes)
  4459                                  		;pop	bx
  4460                                  		;add	bx, 18			; 18.2 ticks per second
  4461                                  		; 09/12/2023
  4462 00001AAA 83C212                  		add	dx, 18
  4463 00001AAD 83D600                  		adc	si, 0			; next second (if carry flag is 1)
  4464                                  continue_to_wait:
  4465 00001AB0 B401                    		mov	ah, 1
  4466 00001AB2 CD16                    		int	16h			; KEYBOARD - status
  4467 00001AB4 7418                    		jz	short cdbo_5
  4468 00001AB6 B400                    		mov	ah, 0
  4469 00001AB8 CD16                    		int	16h			; KEYBOARD - READ CHAR FROM BUFFER, WAIT IF EMPTY
  4470                                  						; Return: AH = scan code, AL = character
  4471                                  
  4472                                  		; 09/12/2023
  4473                                  		;cmp	ax, 11Bh ; ESC key
  4474                                  		;jz	short cdb0_7
  4475                                  ;cdbo_4:
  4476                                  		;push	ax ; *
  4477 00001ABA 89C2                    		mov	dx, ax ; *
  4478                                  
  4479                                  		; CRLF (next line)
  4480                                  		;mov	bx, 7
  4481                                  		; bx = 7
  4482 00001ABC B80D0E                  		mov	ax, 0E0Dh
  4483 00001ABF CD10                    		int	10h			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
  4484                                  						; AL = character, BH = display page (alpha modes)
  4485                                  						; BL = foreground color (graphics modes)
  4486 00001AC1 B80A0E                  		mov	ax, 0E0Ah
  4487 00001AC4 CD10                    		int	10h			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
  4488                                  						; AL = character, BH = display page (alpha modes)
  4489                                  						; BL = foreground color (graphics modes)
  4490                                  		; 09/12/2023
  4491                                  		;pop	ax ; *
  4492                                  			
  4493 00001AC6 81FA1B01                		cmp	dx, 11Bh
  4494                                  		;cmp	ax, 11Bh ; ESC key (to cancel CD/DVD boot)
  4495 00001ACA 7415                    		je	short cdbo_7
  4496                                  		; 10/12/2023
  4497                                  cdbo_4:
  4498 00001ACC 5A                      		pop	dx  ; driver number (dl), media byte (dh)
  4499                                  		; 10/12/2023
  4500                                  		;pop	es
  4501                                  		;pop	ds
  4502                                  		;pop	ax
  4503 00001ACD C3                      		retn
  4504                                  cdbo_5:
  4505 00001ACE 3B366E00                		cmp	si, [6Eh]
  4506 00001AD2 7504                    		jnz	short cdbo_6
  4507                                  		; 09/12/2023
  4508 00001AD4 3B166C00                		cmp	dx, [6Ch]
  4509                                  		;cmp	bx, [6Ch]
  4510                                  cdbo_6:
  4511 00001AD8 73D6                    		jnb	short continue_to_wait
  4512 00001ADA 2EFE0E[401B]            		dec	byte [cs:time_counter]
  4513 00001ADF 75BA                    		jnz	short wait_for_key
  4514                                  cdbo_7:
  4515                                  		; 09/12/2023
  4516                                  		; CRLF (next line)
  4517                                  		;
  4518                                  		;mov	bx, 7
  4519                                  		;mov	ax, 0E0Dh
  4520                                  		;int	10h			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
  4521                                  		;				; AL = character, BH = display page (alpha modes)
  4522                                  		;				; BL = foreground color (graphics modes)
  4523                                  		;mov	ax, 0E0Ah
  4524                                  		;int	10h			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
  4525                                  		;				; AL = character, BH = display page (alpha modes)
  4526                                  		;				; BL = foreground color (graphics modes)
  4527                                  		
  4528 00001AE1 0E                      		push	cs
  4529 00001AE2 1F                      		pop	ds
  4530                                  		; 09/12/2023
  4531 00001AE3 1E                      		push	ds
  4532 00001AE4 07                      		pop	es
  4533                                  		; es = ds = cs
  4534                                  
  4535 00001AE5 B8004B                  		mov	ax, 4B00h
  4536                                  		;xor	dl, dl
  4537                                  		; 09/12/2023
  4538 00001AE8 31D2                    		xor	dx, dx
  4539                                  		; dl = disk drive = 0  ; fd
  4540                                  		;mov	si, 1C93h
  4541 00001AEA BE[2D1B]                		mov	si, empty_dap_buff
  4542 00001AED CD13                    		int	13h			; DISK - Bootable CD-ROM - AL = TERMINATE DISK EMULATION
  4543                                  		; DS:SI = Specification packet filled		
  4544                                  
  4545                                  		;mov	dx, 80h
  4546                                  		;xor	ax, ax
  4547                                  		; 09/12/2023
  4548 00001AEF B81300                  		mov	ax, 19
  4549 00001AF2 89F7                    		mov	di, si	
  4550                                  		;mov	byte [si], 13h
  4551                                  		;mov	[si+1], al
  4552 00001AF4 AB                      		stosw	
  4553                                  		;mov	[si+2], dx
  4554 00001AF5 B080                    		mov	al, 80h
  4555 00001AF7 AB                      		stosw
  4556 00001AF8 89C2                    		mov	dx, ax
  4557                                  		;mov	[si+4], ax
  4558                                  		;mov	[si+6], ax
  4559                                  		;mov	[si+8], ax
  4560                                  		;mov	[si+0Ah], ax
  4561                                  		;mov	[si+0Ch], ax
  4562                                  		;mov	[si+0Eh], ax
  4563                                  		;mov	[si+10h], al
  4564                                  		;mov	[si+11h], al
  4565                                  		;mov	[si+12h], al
  4566 00001AFA B90F00                  		mov	cx, 15
  4567 00001AFD F3AA                    		rep	stosb
  4568                                  		; dl = disk drive = 80h ; hd
  4569 00001AFF B8004B                  		mov	ax, 4B00h
  4570 00001B02 CD13                    		int	13h			; DISK - Bootable CD-ROM - AL = TERMINATE DISK EMULATION
  4571 00001B04 31C0                    		xor	ax, ax
  4572                                  		; 09/12/2023
  4573                                  		;mov	dx, 80h
  4574                                  		; dx = 80h
  4575 00001B06 CD13                    		int	13h			; DISK - RESET DISK SYSTEM
  4576                                  						; DL = drive (if bit 7 is set both hard disks and floppy disks reset)
  4577                                  		; 09/12/2023
  4578                                  		;push	cs
  4579                                  		;pop	es
  4580                                  		; es = ds = cs		
  4581                                  
  4582 00001B08 B80102                  		mov	ax, 201h
  4583                                  		;mov	bx, 152h
  4584 00001B0B BB[5201]                		mov	bx, disksector
  4585                                  		;mov	cx, 1
  4586                                  		; 09/12/2023
  4587 00001B0E 41                      		inc	cx ; cx = 1
  4588                                  		;mov	dx, 80h
  4589                                  		; dx = 80h
  4590 00001B0F CD13                    		int	13h			; DISK - READ SECTORS INTO MEMORY
  4591                                  						; AL = number of sectors to read, CH = track, CL = sector
  4592                                  						; DH = head, DL = drive, ES:BX -> buffer to fill
  4593                                  						; Return: CF set on error, AH = status, AL = number of sectors read
  4594                                  		;jc	short cdbo_8
  4595                                  		; 10/12/2023
  4596 00001B11 72B9                    		jc	short cdbo_4		
  4597                                  
  4598 00001B13 2681BFFE0155AA          		cmp	word [es:bx+1FEh], 0AA55h
  4599                                  		;jz 	short cdbo_9
  4600                                  		; 10/12/2023
  4601 00001B1A 75B0                    		jnz	short cdbo_4
  4602                                  ;cdbo_8:
  4603                                  ;		; 10/12/2023
  4604                                  ;		;jmp	short cdbo_4
  4605                                  ;		pop	dx  ; boot drive number (dl), media byte (dh)	
  4606                                  ;		retn
  4607                                  ;cdbo_9:
  4608                                  		; 10/12/2023
  4609                                  		; dx = 80h
  4610                                  
  4611                                  		; 10/12/2023
  4612                                  		; (stack clearing -pop- is not necessary here, 
  4613                                  		;  Retro DOS v4-v5 boot sector will set stack pointer again)
  4614                                   
  4615                                  		;pop	ax  ; discard dx on top of stack (clear stack)
  4616                                  		;;pop	dx  ; boot drive number (dl), media byte (dh)
  4617                                  		;	    ;		
  4618                                  		;	    ; (Retro DOS v4-v5 boot sector uses DL
  4619                                  		;	    ;  by assuming it contains boot drive number
  4620                                  		;	    ;  from INT 19h.)
  4621                                  		;pop	ax  ; discard near call return address		
  4622                                  		
  4623                                  		; 09/12/2023
  4624                                  		;push	cs
  4625                                  		;pop	ds
  4626                                  		; ds = cs
  4627 00001B1C 31C0                    		xor	ax, ax	; 0
  4628 00001B1E BF007C                  		mov	di, 7C00h
  4629 00001B21 8EC0                    		mov	es, ax
  4630 00001B23 89DE                    		mov	si, bx
  4631 00001B25 06                      		push	es
  4632 00001B26 57                      		push	di
  4633 00001B27 B90001                  		mov	cx, 100h ; 256
  4634                                  		; 10/12/2023
  4635                                  		; cld is not necessary here 
  4636                                  		;	(direction flag is already cleared)
  4637                                  		;cld
  4638 00001B2A F3A5                    		rep movsw
  4639                                  		
  4640                                  		; 10/12/2023
  4641                                  		;mov	ds, ax
  4642                                  		;mov	si, 78h
  4643                                  		;mov	ax, [cs:Orig_Int1Eh_Table]
  4644                                  		;mov	[si], ax
  4645                                  		;mov	ax, [cs:Orig_Int1Eh_Table+2]
  4646                                  		;mov	[si+2], ax
  4647                                  		
  4648 00001B2C CB                      		retf
  4649                                  
  4650                                  ; ----------------------------------------------------------------------------
  4651                                  dap_buffer: ; 16/12/2023
  4652                                  
  4653 00001B2D 13                      empty_dap_buff:	db 19
  4654                                  		;db 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0  ; db 18 dup(0)
  4655 00001B2E 00<rep 12h>             		times 18 db 0
  4656 00001B40 05                      time_counter:	db 5	; 5 seconds
  4657 00001B41 0D0A                    cd_boot_msg:	db 0Dh,0Ah
  4658                                  		;db 'Press the ENTER key to boot from CD or DVD......',0
  4659                                  		; 09/12/2023
  4660 00001B43 507265737320616E79-     		db 'Press any key to boot from CD or DVD ...',0
  4660 00001B4C 206B657920746F2062-
  4660 00001B55 6F6F742066726F6D20-
  4660 00001B5E 4344206F7220445644-
  4660 00001B67 202E2E2E00         
  4661                                  
  4662                                  ; ----------------------------------------------------------------------------
  4663                                  
  4664                                  ; 10/12/2023 - Retro DOS v5.0 (PCDOS 7.1)
  4665                                  
  4666                                  ; 01/10/2022 - Retro DOS v4.0 (MSDOS 5.0, classic/old MICROSOFT DOS method)
  4667                                  ; 20/12/2022 - Retro DOS v4.0 (combined kernel files, original/new method) (*)
  4668                                  ;      (*) (for using Retro DOS kernel 'MSDOS.SYS' with Retro DOS boot sector)
  4669                                  
  4670                                  ;-----------------------------------------------------------------------------
  4671                                  ; entry point from boot sector
  4672                                  ;-----------------------------------------------------------------------------
  4673                                  
  4674                                  init:		; 27/12/2018
  4675                                  		; MSDOS 6.0 (MSINIT.ASM)
  4676                                  		;=============================================================
  4677                                  		;
  4678                                  		; entry from boot sector. the register contents are:
  4679                                  		;
  4680                                  		;   dl = int 13 drive number we booted from
  4681                                  		;   ch = media byte
  4682                                  		;   bx = first data sector on disk.
  4683                                  		;   ax = first data sector (high)
  4684                                  		;   di = sectors/fat for the boot media.
  4685                                  
  4686                                  		; 10/12/2023
  4687                                  		; Retro DOS v5.0 (IBMBIO.COM)
  4688                                  		;=============================================================
  4689                                  		; PCDOS 7.1 IBMBIO.COM - registers from MSLOAD section
  4690                                                  ; DL = [BootDrive]
  4691                                  		; CH = [MediaByte]
  4692                                  		; AX:BX = First data Sector
  4693                                  		; DS:SI = Original INT 1Eh table address
  4694                                  		;
  4695                                  		; Stack: INT 1Eh vector (0:78h) !not used! (dword [sp])
  4696                                  		;	 INT 1Eh table address !not used! (dword [sp+4])
  4697                                  		; DI = 78h !not used!
  4698                                  
  4699                                  		; 07/04/2018
  4700                                  		;=============================================================
  4701                                  		; Retro DOS v2.0 - registers from FD Boot Sector 
  4702                                                  ; DL = [bsDriveNumber]
  4703                                  		; DH = [bsMedia]
  4704                                  		; AX = [bsSectors] ; Total sectors
  4705                                  		; DS = 0, SS = 0
  4706                                  		; BP = 7C00h
  4707                                  
  4708                                  		; 29/09/2023
  4709                                  		; SP = 0FFFEh (for Retro DOS v2&v3 boot sector) 
  4710                                  		;    = 07C00h (for MSDOS 5.0 boot sector)
  4711                                  
  4712                                  		; 10/12/2023 - Retro DOS v5.0
  4713                                  		; ------------------------------------------------------------
  4714                                  		; INPUT (registers from Retro DOS v4-v5 boot sector):
  4715                                  		;  DL = [bsDriveNumber]
  4716                                  		;  DH = [bsMedia]
  4717                                  		;  SS = 0
  4718                                  		;  BP = 7C00h (boot sector address)
  4719                                  		;
  4720                                  		; If the boot drive is a CD (CDROM) or DVD
  4721                                  		;    and CD boot option is enabled/requested:
  4722                                  		;    AX = 'CD'
  4723                                  		; If the boot drive is a FD or HD 
  4724                                  		;    or CD boot option is not enabled/requested:
  4725                                  		;    AX <> 'CD'
  4726                                  
  4727                                  ; 20/12/2022
  4728                                  ; Changing original MSDOS 5.0 IO.SYS init code with Retro DOS v4.0 init code.		
  4729                                  %if 0	
  4730                                  		cli
  4731                                  
  4732                                  		push	ax
  4733                                  		xor	ax, ax
  4734                                  		mov	ds, ax
  4735                                  		pop	ax
  4736                                  %endif
  4737                                  
  4738                                  ; 20/12/2022 - Retro DOS v4.0 (combined kernel)
  4739                                  ; 10/12/2023 - Retro DOS v5.0 (combined kernel)
  4740                                  
  4741                                  KERNEL_SEGMENT equ 70h	; (DOS BIOSDATA SEGMENT)
  4742                                  BSSECPERTRACK equ 18h	; boot sector offset 18h (for Retro DOS & MSDOS)	
  4743                                  
  4744                                  ;-----------------------------------------------------------------------------
  4745                                  ; initialization - stage 1
  4746                                  ;-----------------------------------------------------------------------------
  4747                                  ; 02/06/2018 - Retro DOS v3.0
  4748                                  
  4749                                  		; 10/12/2023
  4750 00001B6C FC                      		cld	; may not be necessary
  4751                                  		
  4752                                  		; 21/12/2022
  4753                                  		; Move Retro DOS v2.0 boot sector parameters to 0060h:0
  4754                                  		;mov	bx, 60h
  4755                                  		;mov	es, bx
  4756                                  		;mov	si, bp
  4757                                  		;sub	di, di
  4758                                  		;mov	cx, 35 ; 70 bytes, 35 words
  4759                                  		;;mov	cl, 35
  4760                                  		;rep	movsw
  4761                                  
  4762                                  		; 10/12/2023 - Retro DOS v5.0
  4763 00001B6D 3D4344                  		cmp	ax, 'CD' ; is CD boot option enabled or not ?
  4764 00001B70 7503                    		jne	short init0
  4765                                  
  4766 00001B72 E8FAFE                  		call	cd_boot_option
  4767                                  init0:
  4768 00001B75 0E                      		push	cs
  4769 00001B76 1F                      		pop	ds
  4770                                  
  4771                                  		; 10/12/2023 - Retro DOS v5.0 IO.SYS/IBMBIO.COM
  4772                                  		;mov	[Boot_Drv], dl
  4773                                  
  4774                                  		; 20/03/2019 - Retro DOS v4.0
  4775                                  		;cli		; turn interrupts off while manupulating stack
  4776                                  		;mov	ss, cx	; set stack segment register
  4777                                  
  4778 00001B77 BC0007                  		mov	sp, 0700h ; move stack pointer to safe place
  4779                                  
  4780                                  		;sti		; turn interrupts on
  4781                                  
  4782                                  		; 27/03/2018
  4783                                  		;mov	cx, KERNEL_SIZE	; words !
  4784                                  
  4785                                  		; 20/03/2019
  4786 00001B7A B90080                  		mov	cx, 32768 ; 65536 bytes
  4787                                  
  4788                                  		; 21/12/2022
  4789                                  		; 07/04/2018
  4790 00001B7D BB7000                  		mov	bx, KERNEL_SEGMENT ; 0070h
  4791                                  		;mov	bl, KERNEL_SEGMENT
  4792 00001B80 8EC3                    		mov	es, bx
  4793 00001B82 31FF                    		xor	di, di
  4794 00001B84 89FE                    		mov	si, di
  4795                                  		
  4796                                  		; Move KERNEL file from 1000h:0 to 0070h:0
  4797                                  		; (Retro DOS v2 BS loads 'MSDOS.SYS' at 1000h:0000h)
  4798 00001B86 F3A5                    		rep	movsw
  4799                                  
  4800                                  		; 20/03/2019 - Retro DOS v4.0
  4801 00001B88 53                      		push	bx
  4802                                  		;push	init0
  4803 00001B89 68[8D1B]                		push	init1	; 10/12/2023
  4804 00001B8C CB                      		retf
  4805                                  ;init0:
  4806                                  		; 10/12/2023 - Retro DOS 5.0	
  4807                                  init1:
  4808                                  		; 20/12/2022
  4809                                  		; (combined kernel file > 64KB)
  4810                                  
  4811                                  		; 20/03/2019
  4812 00001B8D B520                    		mov	ch, 20h
  4813 00001B8F 8ED9                    		mov	ds, cx ; 2000h
  4814                                  		;mov	cx, 1070h
  4815 00001B91 B97010                  		mov	cx, KERNEL_SEGMENT+1000h ; 20/12/2022
  4816 00001B94 8EC1                    		mov	es, cx
  4817                                  		
  4818                                  		; 21/12/2022
  4819                                  		;KERNEL_SIZE equ END_OF_KERNEL - BData_start
  4820                                  		; 28/09/2023
  4821                                  		NXWORDCOUNT equ ((KERNEL_SIZE+1)>>1)-32768
  4822                                  
  4823                                  		;mov	cx, KERNEL_SIZE - 32768
  4824                                  		; 28/09/2023 (BugFix)
  4825 00001B96 B92B1D                  		mov	cx, NXWORDCOUNT
  4826                                  		;mov	cx, NXBYTECOUNT
  4827                                  		;shr	cx, 1 ; 28/09/2023
  4828                                  		;xor	si, si
  4829                                  		;xor	di, di
  4830 00001B99 F3A5                    		rep	movsw
  4831                                  
  4832                                  		; 28/09/2023
  4833                                  		;; 17/06/2018 
  4834                                  		;mov	ds, bx
  4835                                  		;; 21/03/2019
  4836                                  		;mov	es, bx
  4837                                  ;init0:
  4838                                  ;		;push	es
  4839                                  ;		push	bx ; 20/03/2019
  4840                                  ;		push	init1 ; 07/04/2018
  4841                                  ;		retf	; jump to 0070h:init1
  4842                                  ;init:
  4843                                  ;init1:
  4844                                  		; 10/12/2023
  4845                                  init2:
  4846                                  		; 20/12/2022
  4847                                  		; Change INT 1Eh diskette parameters table and INT 1Eh address
  4848                                  		; for full MSDOS compatibility.
  4849                                  
  4850                                  		; 10/12/2023
  4851                                  		;cli	; not necessary for INT 1Eh
  4852                                  
  4853 00001B9B 8EC1                    		mov	es, cx ; 0
  4854 00001B9D 8ED9                    		mov	ds, cx ; 0
  4855                                  
  4856 00001B9F B82205                  		mov	ax, SEC9
  4857                                  
  4858                                  		;mov	bx, 1Eh*4  ; [0078h] ; INT 1Eh vector/pointer
  4859 00001BA2 B378                    		mov	bl, 1Eh*4
  4860                                  				; INT 1Eh points to diskette parms table
  4861                                  
  4862                                  		; check if the table is already at 0:SEC9 (0:0522h)
  4863                                   		; (do not move the DPT if is not original ROMBIOS table)
  4864                                  
  4865                                  		;;or	[bx+2],cx [(1Eh*4)+2] ; [007Ah] ; segment
  4866                                  		;;jnz	short mov_dpt
  4867                                  
  4868                                  		;cmp	ax, [bx]  ; [1Eh*4] = 0522h ?
  4869                                  		;je	short dont_mov_dpt
  4870                                  
  4871                                  		;mov	si, [bx] ; [1Eh*4]		
  4872                                  ;mov_dpt:
  4873                                  		;mov	ds, [bx+2] ; [(1Eh*4)+2] ; [007Ah] ; segment
  4874 00001BA4 C537                    		lds	si, [bx]
  4875                                  		
  4876                                  		; 10/12/2023 - Retro DOS v5.0
  4877                                  		;mov	[cs:Orig_Int1Eh_Table+2], ds
  4878                                  		;mov	[cs:Orig_Int1Eh_Table], si
  4879                                  
  4880 00001BA6 89C7                    		mov	di, ax  ; SEC9
  4881 00001BA8 B10B                    		mov	cl, 11
  4882                                  		;cld
  4883 00001BAA F3A4                    		rep	movsb
  4884                                  
  4885                                  		; Set INT 1Eh vector/pointer to the new DPT address
  4886 00001BAC 8ED9                    		mov	ds, cx ; 0
  4887 00001BAE 8907                    		mov	[bx], ax ; SEC9	; [007Eh] ; 1Eh*4  ; offset
  4888 00001BB0 894F02                  		mov	[bx+2], cx ; 0  ; [007Ah] ; 1Eh*4+2 ; segment
  4889                                  ;dont_mov_dpt:
  4890                                  
  4891                                  ; 20/12/2022 - Retro DOS v4.0
  4892                                  %if 0
  4893                                  		; 27/12/2018 - Retro DOS v4.0
  4894                                  		; 'Starting MS-DOS...' message
  4895                                  		; (MSDOS 6.21, IO.SYS Segment: 423h, Offset: 5673h)
  4896                                  		; (0070h:96A3h)
  4897                                  
  4898                                    	    	mov     si, SYSINIT_START+StartMsg ; 18/03/2019
  4899                                  		mov     ah, 0Eh
  4900                                  		;bh = 0
  4901                                          	mov     bl, 7		; "normal" attribute and page
  4902                                  startmsg_nxt_chr:  
  4903                                  		lodsb
  4904                                  		or	al, al
  4905                                          	jz	short startmsg_ok
  4906                                         
  4907                                  		int	10h		; video write
  4908                                          	jmp	short startmsg_nxt_chr
  4909                                  
  4910                                  ;flp_drvs:	db  0 	; 27/12/2018 - Retro DOS v4.0
  4911                                  
  4912                                  startmsg_ok:
  4913                                  
  4914                                  %endif
  4915                                  
  4916                                  ;-----------------------------------------------------------------------------
  4917                                  ; initialization - stage 2
  4918                                  ;-----------------------------------------------------------------------------
  4919                                  ; 20/12/2022 - Retro DOS v4.0 (combined kernel)
  4920                                  
  4921                                  
  4922                                  ; 19/03/2018
  4923                                  ; Retro DOS v2.0 (24/02/2018)
  4924                                  ; [REF: MSDOS 3.3, MSBIO, "MSINIT.ASM"  (24/07/1987)]
  4925                                  
  4926                                  ;------------------------------------------------------------------------
  4927                                  ;									:
  4928                                  ;	System initialization						:
  4929                                  ;									:
  4930                                  ;	The entry conditions are established by the bootstrap		:
  4931                                  ;	loader and are considered unknown. The following jobs		:
  4932                                  ;	will be performed by this module:				:
  4933                                  ;									:
  4934                                  ;	1.	All device initialization is performed			:
  4935                                  ;	2.	A local stack is set up and DS:SI are set		:
  4936                                  ;		to point to an initialization table. Then		:
  4937                                  ;		an inter-segment call is made to the first		:
  4938                                  ;		byte of the dos 					:
  4939                                  ;	3.	Once the dos returns from this call the ds		:
  4940                                  ;		register has been set up to point to the start		:
  4941                                  ;		of free memory. The initialization will then		:
  4942                                  ;		load the command program into this area 		:
  4943                                  ;		beginning at 100 hex and transfer control to		:
  4944                                  ;		this program.						:
  4945                                  ;									:
  4946                                  ;------------------------------------------------------------------------
  4947                                  		
  4948                                  		; 20/12/2022
  4949                                  		; ----------------------
  4950                                  		; Registers
  4951                                  		; ----------------------
  4952                                  		; DL = [bsDriveNumber]
  4953                                  		; DH = [bsMedia]
  4954                                  		; DS = 0, ES = 0, SS = 0
  4955                                  		; BP = 7C00h
  4956                                  		; SP = 700h
  4957                                  		; ----------------------
  4958                                  		; CX = 0				
  4959                                  
  4960                                  ; 02/10/2022 - 20/12/2022
  4961                                  ; ------------------------------------------------------------------------------
  4962                                  ; Note: Retro DOS v4.0 Kernel does not use/contain MSLOAD part of IO.SYS (5.0)
  4963                                  ; 	Because, Retro DOS v2 boot sector loads complete/entire MSDOS.SYS
  4964                                  ;	(RETRODOS.SYS) Kernel file (IO.SYS & MSDOS.SYS together).
  4965                                  ;	As result of boot sector ve init differences, Retro DOS init code (here)
  4966                                  ;	moves kernel to segment 70h at first, then sets diskette parameters
  4967                                  ;	at segment 50h (while MSDOS 5.0 boot sector and then MSLOAD sets this).
  4968                                  ; ------------------------------------------------------------------------------
  4969                                  
  4970                                  ; msload will check the extended boot record and set ax, bx accordingly.
  4971                                  ;
  4972                                  ;;	msload passes a 32 bit sector number hi word in ax and low in bx
  4973                                  ;;	save this in cs:bios_h and cs:bios_l. this is for the start of
  4974                                  ;;	data sector of the bios.
  4975                                  ;
  4976                                  ;		mov	[cs:bios_h], ax	; (start of) dos bios (IO.SYS) data sector
  4977                                  ;		mov	[cs:bios_l], bx
  4978                                  
  4979                                  ; with the following information from msload, we don't need the
  4980                                  ;     boot sector any more.-> this will solve the problem of 29 kb size
  4981                                  ;     limitation of msbio.com file.
  4982                                  
  4983                                  		; 10/12/2023
  4984                                  		; 21/12/2022
  4985                                  		;cli
  4986                                  
  4987 00001BB3 0E                      		push	cs		; Save a peck of interrupt vectors...
  4988 00001BB4 07                      		pop	es
  4989                                  		;push	cx
  4990                                  		;push	di
  4991                                  
  4992                                  		; 20/12/2022
  4993 00001BB5 B105                    		mov	cl, 5
  4994                                  		;mov	cx, 5		; NUMROMVECTORS
  4995                                  					; no. of rom vectors to	be saved
  4996                                  		;mov	si, offset RomVectors ; point to list of int vectors
  4997 00001BB7 BE[0001]                		mov	si, RomVectors
  4998                                  
  4999                                  		; 10/12/2023
  5000 00001BBA FA                      		cli
  5001                                  next_int_:		
  5002 00001BBB 2E                      		cs	; 16/10/2022
  5003 00001BBC AC                      		lodsb		
  5004                                  		;lods	byte ptr cs:[si] ; cs lodsb
  5005 00001BBD 98                      		cbw			; ax = interrupt number
  5006 00001BBE D1E0                    		shl	ax, 1
  5007 00001BC0 D1E0                    		shl	ax, 1		; int no * 4
  5008 00001BC2 89C7                    		mov	di, ax		; interrupt vector address
  5009 00001BC4 87F7                    		xchg	si, di		; rombios interrupt vector address in si
  5010                                  					; saving address in di
  5011                                  		;lodsw			; movsw
  5012                                  		;stosw
  5013                                  		;lodsw			; movsw
  5014                                  		;stosw			; save the vector
  5015                                  		; 20/12/2022
  5016 00001BC6 A5                      		movsw
  5017 00001BC7 A5                      		movsw		
  5018                                  
  5019 00001BC8 87F7                    		xchg	si, di
  5020 00001BCA E2EF                    		loop	next_int_
  5021                                  		
  5022                                  		;pop	di
  5023                                  		;pop	cx
  5024                                  
  5025                                  ; we need to save int13 in two places in case we are running on an at.
  5026                                  ; on ats we install the ibm supplied rom_bios patch which hooks
  5027                                  ; int13 ahead of orig13. since int19 must unhook int13 to point to the
  5028                                  ; rom int13 routine, we must have that rom address also stored away.
  5029                                  
  5030                                  		; 20/12/2022
  5031                                  		;mov	ax, [cs:Old13]	; save old13 in orig13 also
  5032                                  		;mov	[cs:Orig13], ax
  5033                                  		;mov	ax, [cs:Old13+2]
  5034                                  		;mov	[cs:Orig13+2], ax
  5035                                  
  5036                                  		; 10/12/2023
  5037                                  		;cli
  5038                                  
  5039                                  		; 16/10/2022
  5040 00001BCC C7064C00[ED06]          		mov	word [13h*4], block13
  5041                                  		;mov	word ptr ds:4Ch, offset	block13	; 13h*4
  5042                                  					; set up int 13	for new	action
  5043 00001BD2 8C0E4E00                		mov	[13h*4+2], cs
  5044                                  		;mov	word ptr ds:4Eh, cs ; 13h*4+2
  5045 00001BD6 C7065400[9907]          		mov	word [15h*4], Int15
  5046                                  		;mov	word ptr ds:54h, offset	Int15 ;	15h*4
  5047                                  					; set up int 15	for new	action
  5048 00001BDC 8C0E5600                		mov	[15h*4+2], cs
  5049                                  		;mov	word ptr ds:56h, cs ; 15h*4+2
  5050 00001BE0 C7066400[5907]          		mov	word [19h*4], int19
  5051                                  		;mov	word ptr ds:64h, offset	int19 ;	19h*4
  5052                                  					; set up int 19	for new	action
  5053 00001BE6 8C0E6600                		mov	[19h*4+2], cs
  5054                                  		;mov	word ptr ds:66h, cs ; 19h*4+2
  5055                                  
  5056                                  		; 10/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  5057 00001BEA A16800                  		mov	ax, [68h]	 ; 1Ah*4
  5058 00001BED 8B3E6A00                		mov	di, [6Ah]	 ; 1Ah*4+2
  5059 00001BF1 C7066800[AF06]          		mov	word [68h], Int1A
  5060 00001BF7 8C0E6A00                		mov	[6Ah], cs
  5061                                  
  5062                                  		; 20/12/2022
  5063 00001BFB 0E                      		push	cs
  5064 00001BFC 1F                      		pop	ds
  5065                                  		
  5066 00001BFD A1[0601]                		mov	ax, [Old13]	; save old13 in orig13 also
  5067 00001C00 A3[B400]                		mov	[Orig13], ax
  5068 00001C03 A1[0801]                		mov	ax, [Old13+2]
  5069 00001C06 A3[B600]                		mov	[Orig13+2], ax
  5070                                  					; ;
  5071 00001C09 FB                      		sti
  5072 00001C0A CD11                    		int	11h		; EQUIPMENT DETERMINATION
  5073                                  					; Return: AX = equipment flag bits
  5074                                  		; 10/12/2023
  5075                                  		;jmp	short chk_fd_count
  5076                                  		; (PCDOS 7.1 IBMBIO.COM, BIOSDATA:1DF7h) ; *!!*
  5077                                  		; ((signature))
  5078                                  		;push	dx		; 52h ; 'R'
  5079                                  		;push	ax		; 50h ; 'P'
  5080                                  		;push	bx		; 53h ; 'S'
  5081                                  
  5082                                  ; we have to support a system that does not have any diskette
  5083                                  ; drives but only hardfiles. this system will ipl from the hardfile.
  5084                                  ; if the equipment flag bit 0 is 1, then the system has diskette drive(s).
  5085                                  ; otherwise, the system has only hardfiles.
  5086                                  ;
  5087                                  ; important thing is that still, for compatibility reason, the drive letter
  5088                                  ; for the hardfiles start from "c".  so, we still need to allocate dummy bds
  5089                                  ; drive a and drive b. at sysinit time, we are going to set cds table entry
  5090                                  ; of dpb pointer for these drives to 0, so any user attempt to access this
  5091                                  ; drives will get "invalid drive letter ..." message. we are going to
  5092                                  ; establish "fakefloppydrv" flag. ***sysinit module should call int 11h to
  5093                                  ; determine whether there are any diskette drivers in the system or not.!!!***
  5094                                  
  5095                                  ; check the register returned by the equipment determination interrupt
  5096                                  ; we have to handle the case of no diskettes in the system by faking
  5097                                  ; two dummy drives.
  5098                                  ;
  5099                                  ; if the register indicates that we do have floppy drives we don't need
  5100                                  ; to do anything special.
  5101                                  ;
  5102                                  ; if the register indicates that we don't have any floppy drives then
  5103                                  ; what we need to do is set the fakefloppydrv variable, change the
  5104                                  ; register to say that we do have floppy drives and then go to execute
  5105                                  ; the code which starts at notsingle. this is because we can skip the
  5106                                  ; code given below which tries to find if there are one or two drives
  5107                                  ; since we already know about this.
  5108                                  
  5109                                  chk_fd_count:	; 10/12/2023
  5110                                  		;or	ax, 1	; *!!*
  5111                                  
  5112                                  		; 06/05/2019 - Retro DOS v4.0
  5113 00001C0C 88C1                    		mov	cl, al
  5114                                  
  5115                                  		; 12/12/2022
  5116 00001C0E A801                    		test	al, 1
  5117                                  		;test	ax, 1		; floppy drives	present	?
  5118 00001C10 751E                    		jnz	short normalfloppydrv ;	yes.
  5119                                  
  5120                                  ; Some ROM BIOSs lie that there are no floppy drives. Lets find out
  5121                                  ; whether it is an old ROM BIOS or a new one
  5122                                  ;
  5123                                  ; WARNING !!!
  5124                                  ;
  5125                                  ; This sequence of code is present in SYSINIT1.ASM also. Any modification
  5126                                  ; here will require an equivalent modification in SYSINIT1.ASM also
  5127                                  
  5128                                  		; 20/12/2022
  5129                                  		;push	ax
  5130                                  		;push	bx
  5131                                  		;push	cx
  5132 00001C12 52                      		push	dx
  5133                                  		;push	di
  5134 00001C13 06                      		push	es
  5135                                  
  5136 00001C14 B408                    		mov	ah, 8
  5137 00001C16 B200                    		mov	dl, 0
  5138 00001C18 CD13                    		int	13h		; DISK - DISK -	GET CURRENT DRIVE PARAMETERS (XT,AT,XT286,CONV,PS)
  5139                                  					; DL = drive number
  5140                                  					; Return: CF set on error, AH =	status code, BL	= drive	type
  5141                                  					; DL = number of consecutive drives
  5142                                  					; DH = maximum value for head number, ES:DI -> drive parameter
  5143 00001C1A 7202                    		jc	short _gdskp_error
  5144                                  		;;mov	[cs:flp_drvs], dl
  5145                                  		; 20/12/2022
  5146                                  		; ds = cs
  5147                                  		;mov	[flp_drvs], dl
  5148 00001C1C 88D1                    		mov	cl, dl
  5149                                  _gdskp_error:	
  5150                                  		; 20/12/2022			
  5151 00001C1E 07                      		pop	es
  5152                                  		;pop	di
  5153 00001C1F 5A                      		pop	dx
  5154                                  		;pop	cx
  5155                                  		;pop	bx
  5156                                  		;pop	ax
  5157                                  		
  5158 00001C20 720E                    		jc	short normalfloppydrv
  5159                                  					; if error it is an old ROM BIOS
  5160                                  					; so, lets assume that ROM BIOS lied
  5161                                  		; 20/12/2022
  5162                                  		; ds = cs
  5163                                  		;cmp	byte [flp_drvs], 0
  5164                                  		;;cmp	byte [cs:flp_drvs], 0 ; number of drvs == 0?
  5165                                  		;jz	short _set_fake_flpdrv
  5166                                  		;;mov	al, [cs:flp_drvs]
  5167                                  		;mov	al, [flp_drvs]
  5168                                  		;;dec	al		; make it zero based
  5169                                  		;; 18/12/2022
  5170                                  		;dec	ax
  5171                                  		;jmp	short got_num_flp_drvs
  5172                                  		
  5173                                  		; 20/12/2022
  5174 00001C22 08C9                    		or	cl, cl ; [flp_drvs]
  5175 00001C24 7403                    		jz	short _set_fake_flpdrv		
  5176 00001C26 49                      		dec	cx	
  5177 00001C27 EB0B                    		jmp	short got_num_flp_drvs
  5178                                  ; ----------------------------------------------------------------------------
  5179                                  
  5180                                  _set_fake_flpdrv:
  5181                                  		; 20/12/2022
  5182                                  		; ds = cs
  5183                                  		;inc	cl	; cl = 1
  5184                                  		; 10/12/2023
  5185 00001C29 41                      		inc	cx	; cl = 1
  5186 00001C2A 880E[031A]              		mov	[fakefloppydrv], cl ; 1
  5187                                  		;mov	byte [fakefloppydrv], 1		
  5188                                  		;;mov	byte [cs:fakefloppydrv], 1
  5189                                  					; we don't have any floppy drives.
  5190                                  		; 20/12/2022
  5191                                  		;mov	ax, 1
  5192 00001C2E EB0A                    		jmp	short settwodrive ; well then set it for two drives!
  5193                                  ; ----------------------------------------------------------------------------
  5194                                  
  5195                                  normalfloppydrv:			; yes, bit 0 is 1.			
  5196                                  		; 20/12/2022
  5197                                  		;rol	al, 1		; there	exist floppy drives.
  5198                                  		;rol	al, 1		; put bits 6 & 7 into bits 0 & 1
  5199 00001C30 D0C1                    		rol	cl, 1
  5200 00001C32 D0C1                    		rol	cl, 1
  5201                                  got_num_flp_drvs:			
  5202                                  		;;and	ax, 3		; only look at bits 0 &	1
  5203                                  		; 18/12/2022
  5204                                  		;and	al, 3
  5205                                  		; 20/12/2022
  5206 00001C34 80E103                  		and	cl, 3
  5207 00001C37 7505                    		jnz	short notsingle	; zero means single drive system
  5208                                  		; 20/12/2022
  5209 00001C39 41                      		inc	cx
  5210                                  		;inc	ax		; pretend it's a two drive system
  5211                                  settwodrive:				; set this to two fakedrives
  5212                                  		; 20/12/2022
  5213                                  		; ds = cs
  5214 00001C3A FE06[7800]              		inc	byte [single]
  5215                                  		;inc	byte [cs:single] ; remember this
  5216                                  notsingle:	
  5217                                  		; 20/12/2022			
  5218                                  		;inc	ax		; ax has number	of drives, 2-4
  5219                                  		;			; is also 0 indexed boot drive if we
  5220                                  		;			; booted off hard file
  5221                                  		;mov	cl, al		; ch is	fat id,	cl # floppies
  5222                                  		
  5223                                  		; 20/12/2022
  5224                                  		;inc	cl	; cl >= 2
  5225                                  		; 10/12/2023
  5226 00001C3E 41                      		inc	cx	; cl >= 2
  5227                                  
  5228                                  ; 16/10/2022
  5229                                  ; MSDOS 3.3 - "MSEQU.INC" (24/07/1987)
  5230                                  INITSPOT EQU	534h	; IBM wants 4 zeros here
  5231                                  BRKADR	 EQU	1BH * 4	; 6CH, 1BH break vector address
  5232                                  TIMADR	EQU	1CH * 4	; 70H, 1CH timer interrupt
  5233                                  DSKADR	EQU	1EH * 4	; address of ptr to disk parameters
  5234                                  SEC9	EQU	522h	; address of disk parameters
  5235                                  CHROUT	EQU	29h
  5236                                  LSTDRV	EQU     504h
  5237                                  
  5238                                  ; determine whether we booted from floppy or hard disk...
  5239                                  
  5240                                  		; 20/12/2022
  5241 00001C3F 88C8                    		mov	al, cl	; 26/05/2019
  5242                                  
  5243 00001C41 F6C280                  		test	dl, 80h		; boot from floppy ?
  5244 00001C44 7502                    		jnz	short gothrd	; no.
  5245 00001C46 31C0                    		xor	ax, ax		; indicate boot	from drive a
  5246                                  		; 10/12/2023
  5247                                  		;mov	[Boot_Drv], al
  5248                                  gothrd:					
  5249                                  
  5250                                  ; MSDOS 6.0
  5251                                  ;   ax = 0-based drive we booted from
  5252                                  ;   bios_l, bios_h set.
  5253                                  ;   cl = number of floppies including fake one
  5254                                  ;   ch = media byte
  5255                                  
  5256                                  ; Retro DOS 4.0 - 27/12/2018 
  5257                                  ;  (from Retro DOS v2.0 boot sector)
  5258                                  ;   dl = int 13 drive number we booted from
  5259                                  ;   dh = media byte
  5260                                  
  5261                                  		; 20/12/2022
  5262 00001C48 88F5                    		mov	ch, dh		; 01/07/2018
  5263                                  
  5264                                  		; cl = number of floppies
  5265                                  		; ch = media byte
  5266                                  
  5267                                  		; set up local stack
  5268                                  
  5269                                  		; 20/12/2022
  5270                                  		;xor	dx, dx		; ax = 0-based drive we	booted from
  5271                                  					; bios_l, bios_h set.
  5272                                  					; cl = number of floppies including fake one
  5273                                  					; ch = media byte
  5274                                  		; 20/12/2022
  5275                                  		; es = ds = cs
  5276                                  		; ss = 0
  5277                                  		; sp = 700h
  5278                                  
  5279                                  		; 20/12/2022
  5280                                  		;cli
  5281                                  		;mov	ss, dx		; set stack segment and stack pointer
  5282                                  		;mov	sp, 700h
  5283                                  		;sti
  5284                                  
  5285 00001C4A 51                      		push	cx ; (***) 	; save number of floppies and media byte
  5286                                  		
  5287 00001C4B 88EC                    		mov	ah, ch		; FAT ID to AH
  5288 00001C4D 50                      		push	ax ; (**)	; save boot drive number and media byte
  5289                                  		
  5290                                  ; let model_byte, secondary_model_byte be set here!!!
  5291                                  
  5292 00001C4E B4C0                    		mov	ah, 0C0h
  5293 00001C50 CD15                    		int	15h	; SYSTEM - GET CONFIGURATION (XT after 1/10/86,AT mdl 3x9,CONV,XT286,PS)
  5294 00001C52 7215                    		jb	short no_rom_system_conf ; just	use Model_Byte
  5295 00001C54 80FC00                  		cmp	ah, 0
  5296 00001C57 7510                    		jnz	short no_rom_system_conf
  5297                                  
  5298                                  ;		; 20/12/2022
  5299                                  ;		; (Programmer's Guide to the AMIBIOS, page 268)
  5300                                  ;		; (https://stanislavs.org/helppc/int_15-c0.html)
  5301                                  ;
  5302                                  ;		INT 15h, ah = C0h - Return System Configuration Parameters (PS/2 only)
  5303                                  ;
  5304                                  ;		on return:
  5305                                  ;		CF = 0 if successful
  5306                                  ;		   = 1 if error
  5307                                  ;		AH = when CF set, 80h for PC & PCjr, 86h for XT
  5308                                  ;	     	    (BIOS after 11/8/82) and AT (BIOS after 1/10/84)
  5309                                  ;
  5310                                  ;		ES:BX = pointer to system descriptor table in ROM of the format:
  5311                                  ;
  5312                                  ;		Offset Size	     Description
  5313                                  ;
  5314                                  ;		  00   word   length of descriptor (8 minimum)
  5315                                  ;		  02   byte   model byte (same as F000:FFFE, not reliable)
  5316                                  ;		  03   byte   secondary model byte
  5317                                  ;		  04   byte   BIOS revision level (zero based)
  5318                                  ;		  05   byte   feature information, see below
  5319                                  ;		  06   dword  reserved
  5320                                  
  5321                                  		; 20/12/2022
  5322                                  		; ds = cs
  5323 00001C59 268A4702                		mov	al, [es:bx+2]	; [es:bx+ROMBIOS_DESC.bios_sd_modelbyte]
  5324 00001C5D A2[AF05]                		mov	[model_byte], al
  5325                                  		;mov	[cs:model_byte], al
  5326                                  					; get/save model byte
  5327 00001C60 268A4703                		mov	al, [es:bx+3]	; [es:bx+ROMBIOS_DESC.bios_sd_scnd_modelbyte]
  5328 00001C64 A2[B005]                		mov	[secondary_model_byte], al
  5329                                  		;mov	[cs:secondary_model_byte], al
  5330                                  					; get/save secondary model byte
  5331 00001C67 EB0C                    		jmp	short turn_timer_on
  5332                                  ;-----------------------------------------------------------------------------
  5333                                  
  5334                                  no_rom_system_conf:			
  5335 00001C69 BEFFFF                  		mov	si, 0FFFFh
  5336 00001C6C 8EC6                    		mov	es, si
  5337                                  		; 20/12/2022
  5338 00001C6E 26A00E00                		mov	al, [es:0Eh]	; get model byte (from 0FFFFh:0Eh)
  5339 00001C72 A2[AF05]                		mov	[model_byte], al
  5340                                  		;mov	[cs:model_byte], al ; save model byte
  5341                                  turn_timer_on:				
  5342 00001C75 B020                    		mov	al, 20h	; ' '   ; turn on the timer
  5343 00001C77 E620                    		out	20h, al		; Interrupt controller,	8259A.
  5344                                  					; AKPORT
  5345                                  
  5346                                  ; some olivetti m24 machines have an 8530 serial communications
  5347                                  ; chip installed at io address 50h and 52h. if we're running
  5348                                  ; on one of those, we must inhibit the normal aux port initialization
  5349                                  
  5350                                  		; 20/12/2022
  5351                                  		; ds = cs
  5352 00001C79 803E[AF05]00            		cmp	byte [model_byte], 0
  5353                                  		;cmp	byte [cs:model_byte], 0 ; next to last	byte in	rom bios
  5354 00001C7E 7510                    		jnz	short not_olivetti_m24 ; skip for all other machines
  5355                                  					; (except olivetti m24)
  5356 00001C80 E466                    		in	al, 66h		; is 8530 installed?
  5357 00001C82 A820                    		test	al, 20h
  5358 00001C84 740A                    		jz	short not_olivetti_m24 ; we're done if not
  5359 00001C86 B00F                    		mov	al, 0Fh		; double check
  5360 00001C88 E650                    		out	50h, al
  5361 00001C8A E450                    		in	al, 50h
  5362 00001C8C A801                    		test	al, 1		; this test was	copied from olivetti
  5363 00001C8E 7414                    		jz	short skip_aux_port_init ; take	this branch if 8530 installed
  5364                                  
  5365                                  not_olivetti_m24:
  5366 00001C90 B003                    		mov	al, 3		; init com4
  5367 00001C92 E8DE09                  		call	aux_init
  5368 00001C95 B002                    		mov	al, 2		; init com3
  5369 00001C97 E8D909                  		call	aux_init
  5370 00001C9A B001                    		mov	al, 1		; init com2
  5371 00001C9C E8D409                  		call	aux_init
  5372 00001C9F 30C0                    		xor	al, al		; init com1
  5373 00001CA1 E8CF09                  		call	aux_init
  5374                                  
  5375                                  skip_aux_port_init:			
  5376 00001CA4 B002                    		mov	al, 2		; init lpt3
  5377 00001CA6 E8C209                  		call	print_init
  5378 00001CA9 B001                    		mov	al, 1		; init lpt2
  5379 00001CAB E8BD09                  		call	print_init
  5380 00001CAE 30C0                    		xor	al, al		; init lpt1
  5381 00001CB0 E8B809                  		call	print_init
  5382                                  
  5383                                  		; 11/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  5384                                  		;mov	di, 534h	; offset INITSPOT
  5385                                  		;;mov	di, INITSPOT	; 0534h
  5386                                  		;			; IBMDOS.COM's first cluster - high word
  5387                                  		;			; 520h (the 2nd entry of root dir) + 14h
  5388                                  		;mov	ax, [di]
  5389                                  		;mov	[firstcluster_hw], ax
  5390                                  
  5391 00001CB3 31D2                    		xor	dx, dx	; 0
  5392 00001CB5 8EDA                    		mov	ds, dx		; to initialize	print screen vector
  5393 00001CB7 8EC2                    		mov	es, dx
  5394 00001CB9 31C0                    		xor	ax, ax
  5395                                  		; 16/10/2022
  5396 00001CBB BF3405                  		mov	di, INITSPOT	; 0534h
  5397                                  		;mov	di, 534h	; INITSPOT (0000h:0534h)
  5398                                  					; IBM wants 4 zeros here
  5399 00001CBE AB                      		stosw
  5400 00001CBF AB                      		stosw
  5401 00001CC0 8CC8                    		mov	ax, cs		; fetch	segment
  5402 00001CC2 C7066C00[0E06]          		mov	word [BRKADR], cbreak
  5403                                  		;mov	word ptr ds:6Ch, offset	cbreak ; [BRKADR]
  5404                                  					; break	entry point
  5405 00001CC8 A36E00                  		mov	[BRKADR+2], ax		
  5406                                  		;mov	ds:6Eh,	ax	; vector for break
  5407 00001CCB C706A400[8206]          		mov	word [CHROUT*4], outchr
  5408                                  		;mov	word ptr ds:0A4h, offset outchr	; [CHROUT*4]
  5409 00001CD1 A3A600                  		mov	[CHROUT*4+2], ax
  5410                                  		;mov	ds:0A6h, ax	; [CHROUT*4+2]
  5411                                  
  5412 00001CD4 BF0400                  		mov	di, 4
  5413 00001CD7 BB[1406]                		mov	bx, intret ; 19/10/2022
  5414                                  		;mov	bx, offset intret ; intret (cs:intret)
  5415                                  					; will initialize rest of interrupts
  5416 00001CDA 93                      		xchg	ax, bx
  5417 00001CDB AB                      		stosw			; location 4
  5418 00001CDC 93                      		xchg	ax, bx		; cs:
  5419 00001CDD AB                      		stosw			; int 1	; location 6
  5420 00001CDE 83C704                  		add	di, 4
  5421 00001CE1 93                      		xchg	ax, bx
  5422 00001CE2 AB                      		stosw			; location 12
  5423 00001CE3 93                      		xchg	ax, bx		; cs:
  5424 00001CE4 AB                      		stosw			; int 3	; location 14
  5425 00001CE5 93                      		xchg	ax, bx
  5426 00001CE6 AB                      		stosw			; location 16
  5427 00001CE7 93                      		xchg	ax, bx		; cs:
  5428 00001CE8 AB                      		stosw			; int 4	; location 18
  5429                                  
  5430                                  ;		; 20/12/2022
  5431                                  ;		; (https://stanislavs.org/helppc/bios_data_area.html)
  5432                                  ;		Address Size	Description	(BIOS/DOS Data Area)
  5433                                  ;	
  5434                                  ;		50:00	byte	Print screen status byte
  5435                                  ;				 00 = PrtSc not active,
  5436                                  ;				 01 = PrtSc in progress
  5437                                  ;				 FF = error
  5438                                  ;		50:01  3 bytes	Used by BASIC
  5439                                  ;		50:04	byte	DOS single diskette mode flag, 0=A:, 1=B:
  5440                                  ;		50:05  10bytes	POST work area
  5441                                  ;		50:0F	byte	BASIC shell flag; set to 2 if current shell
  5442                                  ;		50:10	word	BASICs default DS value (DEF SEG)
  5443                                  ;		50:12	dword	Pointer to BASIC INT 1C interrupt handler
  5444                                  ;		50:16	dword	Pointer to BASIC INT 23 interrupt handler
  5445                                  ;		50:1A	dword	Pointer to BASIC INT 24 disk error handler
  5446                                  ;		50:20	word	DOS dynamic storage
  5447                                  ;		50:22  14bytes	DOS diskette initialization table (INT 1E)
  5448                                  ;		50:30	4bytes	MODE command
  5449                                  ;		70:00		I/O drivers from IO.SYS/IBMBIO.COM
  5450                                  
  5451 00001CE9 89160005                		mov	[0500h], dx ; 0
  5452                                  		;mov	ds:500h, dx	; set print screen & break = 0
  5453 00001CED 89160405                		mov	[LSTDRV], dx	; [0504h]
  5454                                  		;mov	ds:504h, dx	; clean	out last drive spec
  5455                                  
  5456                                  ; we need to initialize the cs:motorstartup variable from the disk
  5457                                  ; parameter table at sec9. the offsets in this table are defined in
  5458                                  ; the disk_parms struc in msdskprm.inc. 2 locs
  5459                                  
  5460 00001CF1 A02C05                  		mov	al, [SEC9+0Ah]	; 16/10/2022 
  5461                                  		;mov	al, ds:52Ch	; [SEC9+DISK_PARMS.DISK_MOTOR_STRT]
  5462                                  					; [522h+0Ah]
  5463                                  		; 20/12/2022
  5464                                  		; ds = 0
  5465                                  
  5466 00001CF4 2EA2[2601]              		mov	[cs:motorstartup], al
  5467 00001CF8 2E803E[AF05]FD          		cmp	byte [cs:model_byte], 0FDh ; is this an old rom?
  5468 00001CFE 720B                    		jb	short no_diddle	; no
  5469 00001D00 C7062B050F02            		mov	word [SEC9+09h], 20Fh
  5470                                  		;mov	word ptr ds:52Bh, 20Fh ; [SEC9+DISK_PARMS.DISK_HEAD_STTL], 0200h+NORMSETTLE
  5471                                  					; set head settle and motor start on pc-1 pc-2 pc-xt hal0
  5472 00001D06 C6062205DF              		mov	byte [SEC9+0], 0DFh
  5473                                  		;mov	byte ptr ds:522h, 0DFh ; [SEC9+DISK_PARMS.DISK_SPECIFY_1]
  5474                                  					;  set 1st specify byte	on pc-1	pc-2 pc-xt hal0
  5475                                  no_diddle:				
  5476 00001D0B CD12                    		int	12h		; MEMORY SIZE -
  5477                                  					; Return: AX = number of contiguous 1K blocks of memory
  5478 00001D0D B106                    		mov	cl, 6
  5479 00001D0F D3E0                    		shl	ax, cl		; convert memory size to 16-byte blocks	(segment no.)
  5480                                  		
  5481                                  		; 20/12/2022
  5482                                  		; 03/07/2018 - 27/12/2018
  5483                                  		;pop	cx ; (**)
  5484                                  		;mov	[cs:drvfat], cx
  5485                                  		
  5486 00001D11 50                      		push	ax ; (*)	; save real top	of memory
  5487                                  
  5488                                  		; 27/12/2018 - (MSDOS 6.0, 6.21)
  5489                                  
  5490                                  ;M068 - BEGIN
  5491                                  ;------ Check if an RPL program is present at TOM and do not tromp over it
  5492                                  
  5493                                  		; 20/12/2022
  5494                                  		; ds = 0
  5495                                  
  5496                                  		;push	ds
  5497                                  		;push	bx		; pushes not required but since this
  5498                                  					; happens to be a last minute change
  5499                                  					; & since it is only init code.
  5500                                  		;xor	bx, bx
  5501                                  		;mov	ds, bx
  5502                                  		
  5503                                  		;;mov	bx, ds:0BCh	; [2Fh*4]
  5504                                  		;mov	bx, [2Fh*4]
  5505                                  		;;mov	ds, word ptr ds:0BEh ; [2Fh*4+2]
  5506                                  		;mov	ds, [2Fh*4+2]
  5507                                  		; 29/09/2023
  5508 00001D12 C51EBC00                		lds	bx, [2Fh*4]
  5509                                  
  5510 00001D16 817F035250              		cmp	word [bx+3], 'RP' ; 'RPL'
  5511                                  		;cmp	word ptr [bx+3], 'PR' ; 'RPL'
  5512 00001D1B 750F                    		jnz	short SkipRPL
  5513 00001D1D 807F054C                		cmp	byte [bx+5], 'L'
  5514                                  		;cmp	byte ptr [bx+5], 'L'
  5515 00001D21 7509                    		jnz	short SkipRPL
  5516 00001D23 89C2                    		mov	dx, ax		; get TOM into DX
  5517 00001D25 B8064A                  		mov	ax, 4A06h	; (multMULT shl	8) + multMULTRPLTOM
  5518 00001D28 CD2F                    		int	2Fh		; Get new TOM from any RPL
  5519 00001D2A 89D0                    		mov	ax, dx
  5520                                  SkipRPL:	
  5521                                  		; 20/12/2022		
  5522                                  		;pop	bx
  5523                                  		;pop	ds
  5524                                  
  5525                                  ;M068 - END
  5526                                  		; 20/12/2022
  5527                                  		; 27/12/2018
  5528 00001D2C 0E                      		push	cs
  5529 00001D2D 1F                      		pop	ds
  5530                                  
  5531                                  		; 18/03/2019 - Retro DOS v4.0
  5532                                  		;sub	ax, 64		; room for fatloc segment. (1 kb buffer)
  5533                                  		;mov	[cs:fatloc], ax	; location to read fat
  5534                                  
  5535                                  		; 01/07/2018
  5536                                  		; 08/04/2018
  5537                                  		; 28/03/2018
  5538                                  		; MSDOS 6.0 - MSINIT.ASM, 1991
  5539 00001D2E 83E840                  		sub	ax, 64
  5540 00001D31 A3[FD19]                		mov	[init_bootseg], ax ; 20/12/2022
  5541                                  		;mov	[cs:init_bootseg], ax
  5542                                  
  5543                                  		; 27/12/2018 - Retro DOS v4.0
  5544                                  		;;pop	ax ; (*)	; get back real top of memory
  5545                                  		;pop	dx ; (*)
  5546                                  		; 29/09/2023 - Retro DOS v4.2 (BugFix)
  5547 00001D34 58                      		pop	ax ; (*)	; get back real top of memory		
  5548                                  
  5549                                  
  5550                                  		; 20/12/2022
  5551                                  		; 27/12/2018
  5552 00001D35 59                      		pop	cx ; (**)
  5553 00001D36 890E[FA19]              		mov	[drvfat], cx	; save drive to load dos, and fat id
  5554                                  
  5555                                  		; 20/12/2022
  5556                                  
  5557                                  		;mov	dx, 46Dh	; SYSINIT segment
  5558                                  		;mov	dx, 544h	; 10/12/2023 (PCDOS 7.1 IBMBIO.COM)
  5559 00001D3A BAD704                  		mov	dx, SYSINITSEG	; 17/10/2022
  5560 00001D3D 8EDA                    		mov	ds, dx
  5561                                  
  5562                                  ; set pointer to resident device driver chain
  5563                                  
  5564                                  		; 17/10/2022
  5565 00001D3F C706[7502][2300]        		mov	word [DEVICELIST], res_dev_list
  5566                                  		;mov	word [273h], res_dev_list
  5567                                  		;;mov	word ptr ds:273h, offset res_dev_list
  5568                                  					; [SYSINIT+DEVICE_LIST]
  5569 00001D45 8C0E[7702]              		mov	[DEVICELIST+2], cs		
  5570                                  		;mov	[275h], cs
  5571                                  		;;mov	word ptr ds:275h, cs ; [SYSINIT+DEVICE_LIST+2]
  5572                                  
  5573 00001D49 A3[9402]                		mov	[MEMORYSIZE], ax
  5574                                  		;mov	[292h], ax
  5575                                  		;;mov	ds:292h, ax	; [SYSINIT+MEMORY_SIZE]
  5576                                  
  5577 00001D4C FEC1                    		inc	cl
  5578 00001D4E 880E[9802]              		mov	[DEFAULTDRIVE], cl
  5579                                  		;mov	[296h], cl
  5580                                  		;;mov	ds:296h, cl	; [SYSINIT+DEFAULT_DRIVE]
  5581                                  
  5582                                  		;mov	word [CURRENTDOSLOCATION], 0AF8h ; 10/12/2023
  5583 00001D52 C706[7302]B109          		mov	word [CURRENTDOSLOCATION], DOSLOADSEG
  5584                                  		;mov	word [271h], 83Fh ; (MSDOS.SYS segment)
  5585                                  		;;mov	word ptr ds:271h, 83Fh ; [SYSINIT+CURRENT_DOS_LOCATION]
  5586                                  					; dos_load_seg
  5587                                  
  5588                                  ; important: some old ibm hardware generates spurious int 0F's due to bogus
  5589                                  ; printer cards. we initialize this value to point to an iret only if
  5590                                  ;
  5591                                  ; 1) the original segment points to storage inside valid ram.
  5592                                  ;
  5593                                  ; 2) the original segment is 0F000:xxxx
  5594                                  
  5595                                  		;;;mov	ax, 46Dh	; SYSINIT segment
  5596                                  		;;mov	ax, 544h	; 10/12/2023
  5597                                  		;mov	ax, SYSINITSEG	; 17/10/2022
  5598                                  		;mov	es, ax
  5599                                  		; 20/12/2022
  5600                                  		;push	ds ; SYSINITSEG
  5601                                  		;pop	es
  5602 00001D58 8EC2                    		mov	es, dx ; SYSINITSEG
  5603 00001D5A 31C0                    		xor	ax, ax ; 0
  5604 00001D5C 8ED8                    		mov	ds, ax		; segment 0
  5605                                  		;mov	ax, ds:3Eh	; [0Fh*4+2]
  5606 00001D5E A13E00                  		mov	ax, [0Fh*4+2]	; segment for INT 0Fh
  5607                                  		; 18/10/2022
  5608 00001D61 263B06[9402]            		cmp	ax, [es:MEMORYSIZE] ; es:292h
  5609                                  		;cmp	ax, es:292h	; [ES:MEMORY_SIZE]  ; (condition 1)
  5610 00001D66 7605                    		jbe	short resetintf
  5611 00001D68 3D00F0                  		cmp	ax, 0F000h	; (condition 2)
  5612 00001D6B 750A                    		jnz	short keepintf
  5613                                  resetintf:	
  5614 00001D6D C7063C00[1406]          		mov	word [0Fh*4], intret			
  5615                                  		;mov	word ptr ds:3Ch, offset	intret ; [0Fh*4]
  5616 00001D73 8C0E3E00                		mov	word [0Fh*4+2], cs
  5617                                  		;mov	word ptr ds:3Eh, cs ; [0Fh*4+2]
  5618                                  keepintf:				
  5619                                  ; end important
  5620                                  
  5621                                  ; 17/10/2022
  5622                                  ; 28/12/2018 - Retro DOS v4.0
  5623                                  
  5624                                  ; (MSDOS 6.0, MSINIT.ASM, 1991)
  5625                                  ;
  5626                                  ; we will check if the system has ibm extended keyboard by
  5627                                  ; looking at a byte at 40:96. if bit 4 is set, then extended keyboard
  5628                                  ; is installed, and we are going to set keyrd_func to 10h, keysts_func to 11h
  5629                                  ; for the extended keyboard function. use cx as the temporary register.
  5630                                  
  5631                                  		; 20/12/2022
  5632                                  		; ds = 0
  5633                                  		;xor	cx, cx
  5634                                  		;mov	ds, cx
  5635                                  
  5636 00001D77 8A0E9604                		mov	cl, [496h]	; get keyboard flag
  5637                                  
  5638                                  		; 20/12/2022
  5639                                  		; 20/03/2019
  5640 00001D7B 0E                      		push	cs
  5641 00001D7C 1F                      		pop	ds
  5642                                  
  5643                                  		;test	cl, 00010000b ; 10h
  5644 00001D7D F6C110                  		test	cl, 10h		; extended keyboard ?
  5645 00001D80 740A                    		jz	short org_key	; no, original keyboard
  5646                                  
  5647                                  		; 20/12/2022
  5648                                  		;  ds = cs
  5649 00001D82 C606[7E04]10            		mov	byte [keyrd_func], 10h ; extended keyboard
  5650 00001D87 C606[7F04]11            		mov	byte [keysts_func], 11h
  5651                                  		;mov	byte [cs:keyrd_func], 10h ; extended keyboard
  5652                                  		;mov	byte [cs:keysts_func], 11h
  5653                                  					; change for extended keyboard functions
  5654                                  org_key:
  5655                                  
  5656                                  ; 02/06/2018 - Retro DOS v3.0
  5657                                  
  5658                                  ;**************************************************************
  5659                                  ;	will initialize the number of drives
  5660                                  ;	after the equipment call (int 11h) bits 6&7 will tell
  5661                                  ;	the indications are as follows:
  5662                                  ;
  5663                                  ;	bits	7	6	drives
  5664                                  ;		0	0	1
  5665                                  ;		0	1	2
  5666                                  ;		1	0	3
  5667                                  ;		1	1	4
  5668                                  ;**************************************************************
  5669                                  		
  5670                                  		; 20/12/2022
  5671                                  		; ds = cs		
  5672                                  		;push	cs
  5673                                  		;pop	ds
  5674                                  		; 21/12/2022
  5675                                  		;push	cs
  5676                                  		;pop	es
  5677                                  
  5678 00001D8C E8C50A                  		call	cmos_clock_read	; If cmos clock	exists,
  5679                                  					; then set the system time according to	that.
  5680                                  					; also,	reset the cmos clock rate.
  5681                                  		; 18/10/2022
  5682                                  		;mov	word ptr BData_start, offset harddrv ;
  5683                                  					; set up pointer to hdrive
  5684                                  		; 02/10/2022
  5685 00001D8F C706[0000][4B08]        		mov	word [hdrv_pat], harddrv 
  5686                                  		
  5687                                  		; 20/12/2022
  5688                                  		; 28/12/2018 - Retro DOS v4.0 (MSDOS 6.21)			
  5689 00001D95 58                      		pop	ax ; (***)	; number of floppies and FAT ID
  5690 00001D96 30E4                    		xor	ah, ah		; chuck	fat id byte
  5691 00001D98 A2[7500]                		mov	[drvmax], al	; remember which drive is hard disk
  5692 00001D9B A2[2501]                		mov	[dsktnum], al	; and set initial number of drives
  5693 00001D9E D1E0                    		shl	ax, 1
  5694 00001DA0 0106[501A]              		add	[last_dskdrv_table], ax
  5695                                  
  5696                                  		; 10/12/2023 - Retro DOS v5.0 IO.SYS (IBMBIO.COM)
  5697                                  		; ((MSDOS 6.22 IO.SYS & PCDOS 7.1 IBMBIO.COM))
  5698                                  		; ........
  5699 00001DA4 1E                      		push    ds
  5700 00001DA5 B800F0                  		mov     ax, 0F000h
  5701 00001DA8 8ED8                    		mov     ds, ax
  5702                                  
  5703 00001DAA 813EEAFF434F            		cmp	word [0FFEAh], 'CO' ; 'COMPAQ'
  5704 00001DB0 751F                    		jne	short skip_mode2
  5705 00001DB2 813EECFF4D50            		cmp	word [0FFECh], 'MP'
  5706 00001DB8 7517                    		jne	short skip_mode2
  5707 00001DBA 813EEEFF4151            		cmp	word [0FFEEh], 'AQ'
  5708 00001DC0 750F                    		jne	short skip_mode2
  5709                                  
  5710 00001DC2 B800E4                  		mov	ax, 0E400h	; get advanced system info (COMPAQ ROMBIOS)
  5711 00001DC5 CD15                    		int	15h
  5712 00001DC7 7208                    		jc	short skip_mode2
  5713                                  		; 10/12/2023
  5714                                  		; PCDOS 7.1 IBMBIO.COM
  5715                                  		;or	bx, 0           ; or bx,40h ; enable mode 2
  5716                                  					; (MSDOS 6.0)
  5717                                  		; MSDOS 6.22 IO.SYS
  5718 00001DC9 83CB40                  		or	bx, 40h		; enable mode 2 (dual harddisk controller)
  5719 00001DCC B880E4                  		mov	ax, 0E480h      ; set advanced system info (COMPAQ ROMBIOS)
  5720 00001DCF CD15                    		int	15h
  5721                                  skip_mode2:
  5722 00001DD1 1F                      		pop	ds
  5723                                  		; ........
  5724                                  
  5725 00001DD2 B280                    		mov	dl, 80h
  5726 00001DD4 B408                    		mov	ah, 8
  5727 00001DD6 CD13                    		int	13h		; DISK - DISK -	GET CURRENT DRIVE PARAMETERS (XT,AT,XT286,CONV,PS)
  5728                                  					; DL = drive number
  5729                                  					; Return: CF set on error, AH =	status code, BL	= drive	type
  5730                                  					; DL = number of consecutive drives
  5731                                  					; DH = maximum value for head number, ES:DI -> drive parameter
  5732 00001DD8 7204                    		jc	short enddrv
  5733 00001DDA 8816[4F1A]              		mov	[hnum], dl	; save number of hard disk drives
  5734                                  enddrv:
  5735                                  		; 21/12/2022
  5736 00001DDE 0E                      		push	cs
  5737 00001DDF 07                      		pop	es
  5738                                  
  5739                                  ; scan the list of drives to determine their type. we have three flavors of
  5740                                  ; diskette drives:
  5741                                  ;
  5742                                  ;   48tpi drives    we do nothing special for them
  5743                                  ;   96tpi drives    mark the fact that they have changeline support.
  5744                                  ;   3.5"  drives    mark changeline support and small.
  5745                                  ;
  5746                                  ; the following code uses registers for certain values:
  5747                                  ;
  5748                                  ;   dl - physical drive
  5749                                  ;   ds:di - points to current bds
  5750                                  ;   cx - flag bits for bds
  5751                                  ;   dh - form factor for the drive (1 - 48tpi, 2 - 96tpi, 3 - 3.5" medium)
  5752                                  					
  5753 00001DE0 30D2                    		xor	dl, dl
  5754                                  
  5755                                  		; 20/12/2022
  5756                                  		; ds = cs
  5757                                  		; 17/06/2018		 
  5758                                  		;push	cs
  5759                                  		;pop	ds
  5760                                  
  5761 00001DE2 C606[2C01]09            		mov	byte [eot], 9
  5762 00001DE7 BF[1901]                		mov	di, start_bds 	; if we	are faking floppy drives we need
  5763                                  					; to set aside two bdss	for the	two fake floppy	drives
  5764                                  
  5765                                  ; 02/10/2022 - Retro DOS v4.0 (MSDOS 5.0 IO.SYS)
  5766                                  ; 28/12/2018 - Retro DOS v4.0 (MSDOS 6.0, MSINIT.ASM)
  5767                                  
  5768                                  ; check to see if we are faking floppy drives. if not we don't
  5769                                  ; do anything special. if we are faking floppy drives we need
  5770                                  ; to set aside two bdss for the two fake floppy drives. we
  5771                                  ; don't need to initalise any fields though. so starting at start_bds
  5772                                  ; use the link field in the bds structure to go to the second bds
  5773                                  ; in the list and initalise it's link field to -1 to set the end of
  5774                                  ; the list. then jump to the routine at dohard to allocate/initialise
  5775                                  ; the bds for harddrives.
  5776                                  
  5777 00001DEA 803E[031A]01            		cmp	byte [fakefloppydrv], 1
  5778 00001DEF 750B                    		jnz	short loop_drive
  5779 00001DF1 8B3D                    		mov	di, [di]	; [di+BDS.link]
  5780                                  					; di <-	first bds link
  5781 00001DF3 8B3D                    		mov	di, [di]	; [di+BDS.link]
  5782                                  					; di <-	second bds link
  5783 00001DF5 C705FFFF                		mov	word [di], 0FFFFh ; -1 ; set end of link
  5784 00001DF9 E98801                  		jmp	dohard		; allocate/initialise bds for harddrives
  5785                                  ;-----------------------------------------------------------------------------
  5786                                  
  5787                                  loop_drive:				
  5788 00001DFC 3A16[7500]              		cmp	dl, [drvmax]
  5789 00001E00 7203                    		jb	short got_more
  5790 00001E02 E97B01                  		jmp	done_drives
  5791                                  ;-----------------------------------------------------------------------------
  5792                                  
  5793                                  got_more:	
  5794                                  		; 12/12/2023
  5795                                  		;xor	cx, cx		; zero all flags
  5796 00001E05 8B3D                    		mov	di, [di]	; [di+BDS.link]
  5797                                  					; get next bds
  5798                                  		; ........
  5799                                  		; 10/12/2023 - Retro DOS v5.0
  5800                                  		; (PCDOS 7.1 IBMBIO.COM BIOSDATA:2046h) 
  5801 00001E07 83FFFF                  		cmp	di, 0FFFFh      ; end of link ?
  5802 00001E0A 7516                    		jne	short not_last_bds
  5803 00001E0C 88D0                    		mov	al, dl          ; drive number (0 based)
  5804 00001E0E 98                      		cbw
  5805 00001E0F 01C0                    		add	ax, ax
  5806 00001E11 05[3C05]                		add	ax, dskdrvs
  5807 00001E14 A3[501A]                		mov	[last_dskdrv_table], ax
  5808 00001E17 8B3E[521A]              		mov	di, [end_of_bdss]
  5809 00001E1B E8000A                  		call	xinstall_bds
  5810 00001E1E FE0E[7500]              		dec	byte [drvmax]
  5811                                  not_last_bds:
  5812                                  		; ........
  5813                                  
  5814 00001E22 B600                    		mov	dh, 0		; ff48tpi
  5815                                  					; set form factor to 48	tpi
  5816 00001E24 C606[021A]28            		mov	byte [num_cyln], 40 ; 40 tracks per side
  5817                                  		
  5818                                  		; 20/12/2022
  5819                                  		;push	ds ; 11/05/2019	
  5820 00001E29 57                      		push	di
  5821 00001E2A 52                      		push	dx
  5822                                  		;push	cx ; not necessary (10/12/2023)
  5823 00001E2B 06                      		push	es ; ((*)) ; 20/12/2022
  5824                                  
  5825                                  		; ...........
  5826                                  		; 10/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  5827                                  		;xor	bx, bx
  5828                                  		;xor	cx, cx
  5829 00001E2C 52                      		push	dx  ; dl = drive number	
  5830                                  		
  5831 00001E2D B408                    		mov	ah, 8
  5832 00001E2F CD13                    		int	13h		; DISK - DISK -	GET CURRENT DRIVE PARAMETERS (XT,AT,XT286,CONV,PS)
  5833                                  					; DL = drive number
  5834                                  					; Return: CF set on error, AH =	status code, BL	= drive	type
  5835                                  					; DL = number of consecutive drives
  5836                                  					; DH = maximum value for head number, ES:DI -> drive parameter
  5837                                  		;jc	short noparmsfromrom
  5838                                  		; 10/12/2023
  5839 00001E31 58                      		pop	ax  ; al = drive number
  5840 00001E32 7303                    		jnc	short chk_drv_type
  5841 00001E34 E9E600                  		jmp	noparmsfromrom
  5842                                  
  5843                                  chk_drv_type:
  5844                                  		; 10/12/2023
  5845                                  		; ch = low eight bits of maximum cylinder number
  5846                                  		; cl = maximum sector number (bits 5-0)
  5847                                  		;      high two bits of maximum cylinder number (bits 7-6)
  5848                                  		;
  5849 00001E37 80FB10                  		cmp	bl, 10h		; ATAPI Removable Media Device
  5850 00001E3A 7554                    		jne	short not_atapi_removable
  5851                                  		
  5852                                  		; save ds:si
  5853 00001E3C 1E                      		push	ds
  5854                                  		;push	si	; not necessary (10/12/2023)
  5855                                  		
  5856 00001E3D 88C2                    		mov	dl, al
  5857 00001E3F 83EC1A                  		sub	sp, 26
  5858 00001E42 31C0                    		xor	ax, ax ; 0
  5859 00001E44 50                      		push	ax
  5860 00001E45 B81E00                  		mov	ax, 30
  5861 00001E48 50                      		push	ax
  5862 00001E49 89E6                    		mov	si, sp		; DS:SI = segment:offset pointer to Result Buffer
  5863 00001E4B 16                      		push	ss
  5864 00001E4C 1F                      		pop	ds
  5865 00001E4D B448                    		mov	ah, 48h
  5866 00001E4F CD13                    		int	13h		; DISK - IBM/MS Extension
  5867                                  					; GET DRIVE PARAMETERS (DL - drive, DS:SI - buffer)
  5868 00001E51 7239                    		jb	short ext_gdp_err
  5869 00001E53 8B4408                  		mov	ax, [si+8]	; physical number of heads
  5870 00001E56 A3[001A]                		mov	[num_heads], ax
  5871 00001E59 8B4404                  		mov	ax, [si+4]	; physical number of cylinders
  5872 00001E5C A3[021A]                		mov	[num_cyln], ax
  5873 00001E5F 8A440C                  		mov	al, [si+0Ch]	; physical number of sectors per track
  5874 00001E62 A2[011A]                		mov	[sec_trk], al
  5875 00001E65 3A06[2C01]              		cmp	al, [eot]
  5876 00001E69 7603                    		jbe	short _eotok
  5877 00001E6B A2[2C01]                		mov	[eot], al
  5878                                  
  5879                                  _eotok:		; 10/12/2023
  5880                                  		;xor	al, al
  5881 00001E6E 31C9                    		xor	cx, cx ; 0
  5882 00001E70 F6440210                		test	byte [si+2], 10h ; information flags
  5883                                  					; bit 4 = Device has change line support
  5884 00001E74 7403                    		jz	short not_chgline_sup
  5885                                  		;or	al, 2		; change line support
  5886 00001E76 80C902                  		or	cl, 2
  5887                                  not_chgline_sup:
  5888 00001E79 83C41E                  		add	sp, 30
  5889                                  		;pop	si	; (10/12/2023)
  5890 00001E7C 1F                      		pop	ds
  5891                                  		;
  5892 00001E7D 07                      		pop	es	; es=cs=ds (21/12/2022)
  5893                                  		;pop	cx	; (10/12/2023)
  5894 00001E7E 5A                      		pop	dx
  5895 00001E7F 5F                      		pop	di
  5896                                  		;pop	ds	; (21/12/2022)
  5897                                  
  5898                                  		; 10/12/2023
  5899 00001E80 F6C102                  		test	cl, 2
  5900                                  		;test	al, 2
  5901                                  		;jz	short gotother_j
  5902 00001E83 7450                    		jz	short gotother
  5903                                  		;or	cl, al
  5904 00001E85 C606[7700]01            		mov	byte [fhave96], 1 ; Device has change line support
  5905                                  gotother_j:
  5906 00001E8A EB49                    		jmp	short gotother
  5907                                  ext_gdp_err:
  5908 00001E8C 83C41E                  		add	sp, 30
  5909                                  		;pop	si	; (10/12/2023)
  5910 00001E8F 1F                      		pop	ds
  5911                                  
  5912                                  		; 10/12/2023
  5913                                  not_atapi_removable:
  5914                                  		; ...........
  5915                                  
  5916                                  
  5917                                  ; if cmos is bad, it gives es,ax,bx,cx,dh,di=0. cy=0.
  5918                                  ; in this case, we are going to put bogus informations to bds table.
  5919                                  ; we are going to set ch=39,cl=9,dh=1 to avoid divide overflow when
  5920                                  ; they are calculated at the later time. this is just for the diagnostic
  5921                                  ; diskette which need msbio,msdos to boot up before it sets cmos.
  5922                                  ; this should only happen with drive b.
  5923                                  
  5924 00001E90 80FD00                  		cmp	ch, 0		; if ch=0, then	cl,dh=0	too.
  5925 00001E93 7505                    		jnz	short pfr_ok
  5926                                  
  5927                                  		;mov	ch, 39		; rom gave wrong info.
  5928                                  		;mov	cl, 9		; let's default to 360k.
  5929                                  		; 20/12/2022
  5930 00001E95 B90927                  		mov	cx, 2709h
  5931                                  
  5932 00001E98 B601                    		mov	dh, 1
  5933                                  pfr_ok:					
  5934                                  		;inc	dh		; make number of heads 1-based
  5935                                  		;mov	[num_heads], dh	; save parms returned by rom
  5936                                  		; 10/12/2023
  5937 00001E9A 86D6                    		xchg	dl, dh
  5938 00001E9C 30F6                    		xor	dh, dh
  5939 00001E9E 42                      		inc	dx		; make number of heads 1-based
  5940 00001E9F 8916[001A]              		mov	[num_heads], dx
  5941                                  
  5942                                  		;inc	ch		; make number of cylinders 1-based
  5943                                  		;and	cl, 3Fh
  5944                                  		;mov	[sec_trk], cl
  5945                                  		;mov	[num_cyln], ch	; assume less than 256 cylinders!!
  5946                                  		; 10/12/2023
  5947 00001EA3 88CA                    		mov	dl, cl
  5948 00001EA5 80E23F                  		and	dl, 3Fh
  5949 00001EA8 8816[011A]              		mov	[sec_trk], dl
  5950 00001EAC 86CD                    		xchg	cl, ch
  5951 00001EAE D0C5                    		rol	ch, 1
  5952 00001EB0 D0C5                    		rol	ch, 1
  5953 00001EB2 80E503                  		and	ch, 3
  5954 00001EB5 41                      		inc	cx		; make number of cylinders 1-based
  5955 00001EB6 890E[021A]              		mov	[num_cyln], cx
  5956                                  
  5957                                  ; make sure that eot contains the max number of sec/trk in system of floppies
  5958                                  
  5959                                  		;mov	cl, [sec_trk] ; 10/12/2023
  5960                                  		;cmp	cl, [eot]	; may set carry
  5961                                  		;;jbe	short eot_ok
  5962                                  		;; 09/12/2022
  5963                                  		;;jne	short eotok  ; wrong ! 14/08/2023
  5964                                  		;; 14/08/2023
  5965                                  		;jbe	short eotok
  5966                                  		;mov	[eot], cl
  5967                                  		; 10/12/2023
  5968 00001EBA 3A16[2C01]              		cmp	dl, [eot] ; dl = [sec_trk]
  5969 00001EBE 7604                    		jbe	short eotok
  5970 00001EC0 8816[2C01]              		mov	[eot], dl
  5971                                  ;eot_ok:
  5972                                  eotok:
  5973                                  		; 10/12/2023
  5974                                  		; !!!
  5975                                  		; (following pops are moved to 'chk_changeline' procedure)
  5976                                  		;
  5977                                  		; 20/12/2022
  5978                                  		;pop	es ; ((*)) es = cs = ds
  5979                                  		;;pop	cx	; 10/12/2023
  5980                                  		;pop	dx
  5981                                  		;pop	di
  5982                                  
  5983                                  		; 20/12/2022
  5984                                  		;pop	ds
  5985                                  
  5986                                  ; Check	for presence of	changeline
  5987                                  
  5988                                  ; 10/12/2023
  5989                                  %if 0
  5990                                  		; 10/12/2023
  5991                                  		;xor	cx, cx	; 0
  5992                                  		;push	cx
  5993                                  		push	dx
  5994                                  
  5995                                  		mov	ah, 15h
  5996                                  		int	13h		; DISK - DISK -	GET TYPE (AT,XT2,XT286,CONV,PS)
  5997                                  					; DL = drive ID
  5998                                  					; Return: CF set on error, AH =	disk type (3 = hard drive)
  5999                                  					; CX:DX	= number of sectors on the media
  6000                                  		; 10/12/2023
  6001                                  		pop	dx
  6002                                  		;pop	cx
  6003                                  		mov	cx, 0 ; 12/12/2023
  6004                                  		jc	short changeline_done
  6005                                  		cmp	ah, 2		; check	for presence of	changeline
  6006                                  		jnz	short changeline_done
  6007                                  
  6008                                  ; we have a drive with change line support.
  6009                                  
  6010                                  		or	cl, 2		; fchangeline
  6011                                  					; signal type
  6012                                  		mov	byte [fhave96], 1 ; remember that we have 96tpi disks
  6013                                  %endif
  6014                                  		; 10/12/2023
  6015 00001EC4 E83800                  		call	chk_changeline
  6016                                  		;jc	short changeline_done
  6017                                  
  6018                                  ; we now try to set up the form factor for the types of media that we know
  6019                                  ; and can recognise. for the rest, we set the form factor as "other".
  6020                                  
  6021                                  changeline_done:
  6022                                  
  6023                                  ; 40 cylinders and 9 or less sec/trk, treat as 48 tpi medium.
  6024                                  			
  6025 00001EC7 803E[021A]28            		cmp	byte [num_cyln], 40
  6026 00001ECC 750B                    		jnz	short try_80
  6027 00001ECE 803E[011A]09            		cmp	byte [sec_trk], 9
  6028 00001ED3 765F                    		jbe	short nextdrive
  6029                                  gotother:
  6030                                  		; 10/12/2023
  6031                                  		; ch = 0, cl = 2 or 0
  6032                                  				
  6033 00001ED5 B607                    		mov	dh, 7 		; ffOther
  6034                                  					; we have a "strange" medium 
  6035 00001ED7 EB5B                    		jmp	short nextdrive
  6036                                  ;-----------------------------------------------------------------------------
  6037                                  
  6038                                  ; 80 cylinders and 9 sectors/track => 720 kb device
  6039                                  ; 80 cylinders and 15 sec/trk => 96 tpi medium
  6040                                  
  6041                                  try_80:					
  6042 00001ED9 803E[021A]50            		cmp	byte [num_cyln], 80
  6043 00001EDE 75F5                    		jnz	short gotother
  6044 00001EE0 B609                    		mov	dh, 9 ; ff288	; assume 2.88 MB drive
  6045 00001EE2 803E[011A]24            		cmp	byte [sec_trk], 36 ; is it ?
  6046 00001EE7 744B                    		jz	short nextdrive	; yeah,	go update
  6047                                  
  6048                                  		; 12/05/2019 (ff144 type will not be used -compatibility problem-)
  6049                                  		; 08/01/2018 - Retro DOS v4.0 feature only ! for 1.44MB diskettes
  6050                                  		;mov	dh, ff144
  6051                                  		;cmp	byte [sec_trk], 18
  6052                                  		;je	short nextdrive
  6053                                  
  6054 00001EE9 803E[011A]0F            		cmp	byte [sec_trk], 15
  6055 00001EEE 740B                    		jz	short got96
  6056                                  		
  6057 00001EF0 803E[011A]09            		cmp	byte [sec_trk], 9
  6058 00001EF5 75DE                    		jnz	short gotother
  6059                                  		
  6060 00001EF7 B602                    		mov	dh, 2 		; ffSmall
  6061 00001EF9 EB39                    		jmp	short nextdrive
  6062                                  ; ----------------------------------------------------------------------------
  6063                                  
  6064                                  got96:					
  6065 00001EFB B601                    		mov	dh, 1		; ff96tpi
  6066 00001EFD EB35                    		jmp	short nextdrive
  6067                                  
  6068                                  ; ----------------------------------------------------------------------------
  6069                                  		
  6070                                  		; 10/12/2023 - Retro DOS v5.0 IO.SYS/IBMBIO.COM
  6071                                  		; check change line feature (and set fhave96 if there is)
  6072                                  		; (common procedure for 'eotok:' and 'noparmsfromrom:')
  6073                                  chk_changeline:
  6074 00001EFF 59                      		pop	cx ; near call return address
  6075                                  
  6076                                  		; (pop es, dx, di for 'eotok' and 'noparmsfromrom' procs)
  6077 00001F00 07                      		pop	es ; es=cs=ds ; 21/12/2022
  6078                                  		;pop	cx	; (10/12/2023)
  6079 00001F01 5A                      		pop	dx
  6080 00001F02 5F                      		pop	di ; BDS address/offset
  6081                                  		
  6082 00001F03 51                      		push	cx ; near call return address
  6083                                  
  6084                                  		;xor	cx, cx ; 0
  6085                                  		;push	cx
  6086 00001F04 52                      		push	dx
  6087                                  
  6088 00001F05 B415                    		mov	ah, 15h
  6089 00001F07 CD13                    		int	13h		; DISK - DISK -	GET TYPE (AT,XT2,XT286,CONV,PS)
  6090                                  					; DL = drive ID
  6091                                  					; Return: CF set on error, AH =	disk type (3 = hard drive)
  6092                                  					; CX:DX	= number of sectors on the media
  6093 00001F09 5A                      		pop	dx
  6094                                  		;pop	cx
  6095 00001F0A B90000                  		mov	cx, 0
  6096 00001F0D 720D                    		jc	short chk_chgl_1
  6097                                  
  6098 00001F0F 80FC02                  		cmp	ah, 2		; is there changeline?
  6099 00001F12 7508                    		jne	short chk_chgl_2 ; *
  6100                                  
  6101 00001F14 80C902                  		or	cl, 2
  6102                                  		;or	cl, ah ; 2
  6103 00001F17 C606[7700]01            		mov	byte [fhave96], 1 ; fchangeline
  6104                                  		; cf = 0
  6105                                  chk_chgl_1:
  6106                                  chk_chgl_2:
  6107 00001F1C C3                      		retn
  6108                                  
  6109                                  ;chk_chgl_2:	; *
  6110                                  ;		; 10/12/2023
  6111                                  ;		; ah = 1 ; harddisk type (ah = 3) return not possible here for floppies 
  6112                                  ;		;stc
  6113                                  ;		; cf = 1
  6114                                  ;		retn
  6115                                  
  6116                                  ; ----------------------------------------------------------------------------
  6117                                  
  6118                                  ; we have an old rom, so we either have a 48tpi or 96tpi drive. if the drive
  6119                                  ; has changeline, we assume it is a 96tpi, otherwise we treat it as a 48tpi.
  6120                                  
  6121                                  noparmsfromrom:
  6122                                  		; 10/12/2023
  6123                                  		; !!!
  6124                                  		; (following pops are moved to 'chk_changeline' procedure)
  6125                                  		;
  6126                                  		; 20/12/2022
  6127                                  		;pop	es ; ((*))
  6128                                  		;;pop	cx	; (10/12/2023)
  6129                                  		;pop	dx
  6130                                  		;pop	di
  6131                                  		
  6132                                  		; 20/12/2022
  6133                                  		;pop	ds
  6134                                  ; 10/12/2023
  6135                                  %if 0
  6136                                  		; 10/12/2023
  6137                                  		;xor	cx, cx ; 0
  6138                                  		;push	cx
  6139                                  		push	dx
  6140                                  
  6141                                  
  6142                                  		mov	ah, 15h
  6143                                  		int	13h		; DISK - DISK -	GET TYPE (AT,XT2,XT286,CONV,PS)
  6144                                  					; DL = drive ID
  6145                                  					; Return: CF set on error, AH =	disk type (3 = hard drive)
  6146                                  					; CX:DX	= number of sectors on the media
  6147                                  		; 10/12/2023
  6148                                  		pop	dx
  6149                                  		;pop	cx
  6150                                  		mov	cx, 0 ; 12/12/2023
  6151                                  		jc	short nextdrive
  6152                                  
  6153                                  		cmp	ah, 2		; is there changeline?
  6154                                  		jnz	short nextdrive
  6155                                  
  6156                                  		or	cl, 2
  6157                                  		mov	byte [fhave96], 1 ; fchangeline
  6158                                  %endif
  6159                                  		; 10/12/2023
  6160 00001F1D E8DFFF                  		call	chk_changeline
  6161 00001F20 7212                    		jc	short nextdrive
  6162                                  		
  6163                                  		; change line support, [fhave96] = 1
  6164                                  		
  6165 00001F22 C606[021A]50            		mov	byte [num_cyln], 80
  6166 00001F27 B601                    		mov	dh, 1		; ff96tpi
  6167 00001F29 B00F                    		mov	al, 15
  6168 00001F2B 3A06[2C01]              		cmp	al, [eot]
  6169 00001F2F 7603                    		jbe	short nextdrive
  6170 00001F31 A2[2C01]                		mov	[eot], al
  6171                                  ; ----------------------------------------------------------------------------
  6172                                  
  6173                                  ;eot_ok2:
  6174                                  nextdrive:
  6175                                  		; 10/12/2023
  6176                                  		; ch = 0, cl = 2 or 0	
  6177                                  				
  6178 00001F34 80C920                  		or	cl, 20h	; fi_own_physical
  6179                                  					; set this true	for all	drives
  6180 00001F37 88D7                    		mov	bh, dl		; save int13 drive number
  6181                                  
  6182                                  ; we need to do special things if we have a single drive system and are setting
  6183                                  ; up a logical drive. it needs to have the same int13 drive number as its
  6184                                  ; counterpart, but the next drive letter. also reset ownership flag.
  6185                                  ; we detect the presence of this situation by examining the flag single for the
  6186                                  ; value 2.
  6187 00001F39 803E[7800]02            		cmp	byte [single], 2
  6188 00001F3E 7505                    		jnz	short not_special
  6189 00001F40 FECF                    		dec	bh		; int13	drive number same for logical drive
  6190 00001F42 80F120                  		xor	cl, 20h	; fi_own_physical
  6191                                  					; reset	ownership flag for logical drive
  6192                                  not_special:
  6193                                  
  6194                                  ; the values that we put in for BDS_RBPB.BPB_HEADS and
  6195                                  ; BDS_RBPB.BPB_SECTORSPERTRACK will only remain if the
  6196                                  ; form factor is of type "ffother".
  6197                                  				
  6198                                  		;xor	ax, ax		; fill BDS for drive
  6199                                  		;mov	al, [num_heads]
  6200                                  		; 10/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM) ; *
  6201 00001F45 A1[001A]                		mov	ax, [num_heads]
  6202                                  		;mov	[di+36h], ax	; [di+BDS.rheads]
  6203 00001F48 894552                  		mov	[di+52h], ax	; [di+BDS.rheads] ; *
  6204 00001F4B 31C0                    		xor	ax, ax		; *
  6205 00001F4D A0[011A]                		mov	al, [sec_trk]
  6206                                  		;mov	[di+34h], ax	; [di+BDS.rsecpertrack]
  6207 00001F50 894550                  		mov	[di+50h], ax	; [di+BDS.rsecpertrack] ; *
  6208                                  		;mov	[di+23h], cx	; [di+BDS.flags]
  6209 00001F53 894D3F                  		mov	[di+3Fh], cx	; [di+BDS.flags] ; *
  6210                                  		;mov	[di+22h], dh	; [di+BDS.formfactor]
  6211 00001F56 88753E                  		mov	[di+3Eh], dh	; [di+BDS.formfactor] ; *
  6212 00001F59 885505                  		mov	[di+5],	dl	; [di+BDS.drivelet]
  6213 00001F5C 887D04                  		mov	[di+4],	bh	; [di+BDS.drivenum]
  6214                                  		;mov	bl, [num_cyln]
  6215                                  		;mov	[di+25h], bl	; [di+BDS.cylinders]
  6216                                  		; 10/12/2023
  6217 00001F5F A1[021A]                		mov	ax, [num_cyln]
  6218 00001F62 894541                  		mov	[di+41h], ax	; [di+BDS.cylinders] ; *
  6219                                  
  6220 00001F65 803E[7800]01            		cmp	byte [single], 1 ; Special case for single drive system
  6221 00001F6A 7510                    		jnz	short no_single
  6222                                  		;mov	byte [single], 2 ; Don't forget we have
  6223                                  					; single drive system
  6224                                  		; 10/12/2023
  6225 00001F6C FE06[7800]              		inc	byte [single]	; [single] = 2
  6226                                  		; 18/12/2022
  6227 00001F70 80C910                  		or	cl, 10h
  6228                                  		;or	cx, 10h		; fi_am_mult
  6229                                  					; set that this	is one of several drives
  6230                                  		;or	[di+23h], cx	; [di+BDS.flags]
  6231 00001F73 094D3F                  		or	[di+3Fh], cx	; [di+BDS.flags] ; *
  6232                                  					; save flags
  6233 00001F76 8B3D                    		mov	di, [di]	; [di+BDS.link]
  6234                                  					; move to next BDS in list
  6235 00001F78 FEC2                    		inc	dl		; add a	number
  6236 00001F7A EBB8                    		jmp	short nextdrive	; Use same info	for BDS	as previous
  6237                                  ; ----------------------------------------------------------------------------
  6238                                  
  6239                                  no_single:				
  6240                                  		;inc	dl
  6241                                  		; 18/12/2022
  6242 00001F7C 42                      		inc	dx
  6243 00001F7D E97CFE                  		jmp	loop_drive
  6244                                  ; ----------------------------------------------------------------------------
  6245                                  
  6246                                  		; 11/12/2023 - Retro DOS v5.0 IO.SYS/IBMBIO.COM
  6247                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:21E8h)
  6248                                  done_drives:	
  6249                                  		;mov	word [di+BDS.link], -1
  6250 00001F80 C705FFFF                		mov	word [di], -1	; set link to null
  6251                                  
  6252                                  ; set up all the hard drives in	the system
  6253                                  
  6254                                  		; 20/12/2022
  6255                                  		; 28/12/2018 - Retro DOS v4.0 (MSDOS 6.21)
  6256                                  dohard:					
  6257 00001F84 8A36[4F1A]              		mov	dh, [hnum]
  6258 00001F88 08F6                    		or	dh, dh		; done if no hardfiles
  6259 00001F8A 7459                    		jz	short static_configure
  6260 00001F8C B280                    		mov	dl, 80h
  6261                                  dohard1:				
  6262 00001F8E 52                      		push	dx
  6263 00001F8F 8B3E[521A]              		mov	di, [end_of_bdss]
  6264 00001F93 8A1E[7500]              		mov	bl, [drvmax]
  6265 00001F97 B700                    		mov	bh, 0		; first	primary	partition (or active)
  6266 00001F99 E89F01                  		call	sethard
  6267 00001F9C 7208                    		jb	short hardfile_err
  6268 00001F9E E86808                  		call	dmax_check	; error	if already 26 drives
  6269 00001FA1 7303                    		jnb	short hardfile_err
  6270 00001FA3 E87808                  		call	xinstall_bds	; insert new bds into linked list
  6271                                  hardfile_err:				
  6272 00001FA6 5A                      		pop	dx
  6273                                  		;inc	dl		; next hard drive
  6274                                  		; 12/12/2023
  6275 00001FA7 42                      		inc	dx
  6276 00001FA8 FECE                    		dec	dh
  6277 00001FAA 75E2                    		jnz	short dohard1
  6278                                  
  6279                                  ; end of physical drive	initialization
  6280                                  
  6281                                  ; *** do not change the position of the following statement.
  6282                                  ; *** domini routine will use [drvmax] value for the start of the logical
  6283                                  ; *** drive number of mini disk(s).
  6284                                  					
  6285 00001FAC E8CD06                  		call	domini		; for setting up mini disks, if found
  6286                                  
  6287                                  ; -- begin added section
  6288                                  
  6289 00001FAF 8A36[4F1A]              		mov	dh, [hnum]	; we already know this is >0
  6290 00001FB3 B280                    		mov	dl, 80h
  6291                                  dohardx1:				
  6292 00001FB5 B701                    		mov	bh, 1		; do all subsequent primary partitions
  6293                                  dohardx2:				
  6294 00001FB7 52                      		push	dx
  6295 00001FB8 53                      		push	bx
  6296 00001FB9 8B3E[521A]              		mov	di, [end_of_bdss]
  6297 00001FBD 8A1E[7500]              		mov	bl, [drvmax]
  6298 00001FC1 E87701                  		call	sethard
  6299 00001FC4 720E                    		jb	short dohardx4	; move to next hardfile if error
  6300 00001FC6 E84008                  		call	dmax_check	; make sure <=26 drives
  6301 00001FC9 7309                    		jnb	short dohardx4	; skip if error
  6302 00001FCB E85008                  		call	xinstall_bds	; insert new bds into linked list
  6303 00001FCE 5B                      		pop	bx		; get partition number
  6304 00001FCF 5A                      		pop	dx		; restore physical drive counts
  6305 00001FD0 FEC7                    		inc	bh
  6306 00001FD2 EBE3                    		jmp	short dohardx2	; keep looping until we fail
  6307                                  ; ----------------------------------------------------------------------------
  6308                                  
  6309                                  dohardx4:				
  6310 00001FD4 5B                      		pop	bx		; unjunk partition number from stack
  6311 00001FD5 5A                      		pop	dx		; restore physical drive counts
  6312                                  		;inc	dl		; next hard drive
  6313                                  		; 12/12/2023
  6314 00001FD6 42                      		inc	dx
  6315 00001FD7 FECE                    		dec	dh
  6316 00001FD9 75DA                    		jnz	short dohardx1
  6317                                  
  6318                                  ; -- end changed section
  6319                                  
  6320                                  ;******************************************************************************
  6321                                  ; if more than 2 diskette drives on the system, then it is necessary to remap
  6322                                  ; the bds chain to adjust the logical drive num (drive letter) with greater
  6323                                  ; than two diskette drives
  6324                                  ;
  6325                                  ; new scheme:	if more than 2 disktte drives, first map the bds structure
  6326                                  ;		as usual and then rescan the bds chain to adjust the  drive
  6327                                  ;		letters. to do this, scan for disk drives and assign logical
  6328                                  ;		drive number starting from 2 and then rescan diskette drives
  6329                                  ;		and assign next to the last logical drive number of last disk
  6330                                  ;		drive to the 3rd and 4th diskette drives.
  6331                                  ;******************************************************************************
  6332                                  
  6333 00001FDB 803E[2501]02            		cmp	byte [dsktnum], 2 ; >2 diskette drives
  6334                                  		;jbe	short static_configure ; no - no need for remapping
  6335 00001FE0 7603                    		jbe	short no_remap
  6336 00001FE2 E8DA00                  		call	remap		; remap	bds chain to adjust driver letters
  6337                                  no_remap:
  6338                                  
  6339                                  ; End of drive initialization.
  6340                                  
  6341                                  ; ----------------------------------------------------------------------------
  6342                                  
  6343                                  ;we now decide, based on the configurations available so far, what
  6344                                  ;code or data we need to keep as a stay resident code. the following table
  6345                                  ;shows the configurations under consideration. they are listed in the order
  6346                                  ;of their current position memory.
  6347                                  ;
  6348                                  ;configuration will be done in two ways:
  6349                                  ;
  6350                                  ;first, we are going to set "static configuration". static configuration will
  6351                                  ;consider from basic configuration to endof96tpi configuration. the result
  6352                                  ;of static configuration will be the address the dynamic configuration will
  6353                                  ;use to start with.
  6354                                  ;
  6355                                  ;secondly, "dynamic configuration" will be performed. dynamic configuration
  6356                                  ;involves possible relocation of code or data. dynamic configuration routine
  6357                                  ;will take care of bdsm tables and at rom fix module thru k09 suspend/resume
  6358                                  ;code individually. after these operation, [dosdatasg] will be set.
  6359                                  ;this will be the place sysinit routine will relocate msdos module for good.
  6360                                  
  6361                                  ; -- begin changed section
  6362                                  ;
  6363                                  ;   1.	 basic configuration for msbio (endfloppy)
  6364                                  ;   2.   end96tpi	; a system that supports "change line error"
  6365                                  ;   3.	 end of bdss	; end of bdss for hard disks
  6366                                  ;   4.	 endatrom	;some of at rom fix module.
  6367                                  ;   5.	 endcmosclockset;supporting program for cmos clock write.
  6368                                  ;   6.	 endk09 	;k09 cmos clock module to handle suspend/resume operation.
  6369                                  ;
  6370                                  
  6371                                  ; 02/10/2022 - Retro DOS v4.0 (MSDOS v5.0 IO.SYS)
  6372                                  
  6373                                  static_configure:			
  6374 00001FE5 8B3E[521A]              		mov	di, [end_of_bdss]
  6375 00001FE9 81FF[4C08]              		cmp	di, bdss	; 19/10/2022
  6376                                  		;cmp	di, offset bdss	; did we allocate any hard drive bdss?
  6377 00001FED 750D                    		jnz	short dynamic_configure	; that's the end, then
  6378                                  		; 18/10/2022
  6379 00001FEF BF[4C08]                		mov	di, end96tpi
  6380                                  		;mov	di, offset harddrv ; end96tpi
  6381                                  					; keep everything up to end96tpi
  6382 00001FF2 803E[7700]00            		cmp	byte [fhave96], 0
  6383 00001FF7 7503                    		jnz	short dynamic_configure
  6384                                  		
  6385 00001FF9 BF[3808]                		mov	di, endfloppy
  6386                                  dynamic_configure:
  6387                                  		; 20/12/2022
  6388                                  		;push	cs
  6389                                  		;pop	es
  6390                                  		
  6391                                  		; 10/12/2023
  6392 00001FFC FC                      		cld	; clear direction flag is not necessary here !?
  6393                                  			; because there will not be a running program
  6394                                  			; which will set direction flag as backward (std)
  6395                                  
  6396                                  ; -- end changed section
  6397                                  
  6398                                  		; 20/12/2022
  6399                                  		; ds = cs <> es
  6400                                  		; ss = 0
  6401                                  		; sp = 700h
  6402                                  
  6403                                  		; 13/12/2023
  6404 00001FFD BE00F0                  		mov	si, 0F000h
  6405 00002000 8EC6                    		mov	es, si		; ES ->	ROM BIOS segment
  6406                                  
  6407 00002002 803E[AF05]FC            		cmp	byte [model_byte], 0FCh ; AT ?
  6408                                  		;jnz	short checkcmosclock
  6409                                  		; 10/12/2023
  6410 00002007 751E                    		jnz	short checkcompaqbug ; no
  6411 00002009 803E[4F1A]00            		cmp	byte [hnum], 0	; No hard file?
  6412                                  		;jz	short checkcmosclock
  6413 0000200E 7417                    		jz	short checkcompaqbug
  6414 00002010 97                      		xchg	ax, di		; save allocation pointer in ax
  6415                                  		; 13/12/2023
  6416                                  		;mov	si, 0F000h
  6417                                  		;mov	es, si		; ES ->	ROM BIOS segment
  6418 00002011 BE[581A]                		mov	si, bios_date	; "01/10/84"
  6419 00002014 BFF5FF                  		mov	di, 0FFF5h	; ROM BIOS string is at	F000:FFF5
  6420 00002017 B90900                  		mov	cx, 9		; bdate_l
  6421                                  					; Only patch ROM for bios 01/10/84
  6422 0000201A F3A6                    		repe cmpsb		; check	for date + zero	on end
  6423 0000201C 97                      		xchg	ax, di		; restore allocation pointer
  6424                                  
  6425                                  ; M015 -- begin changes
  6426                                  
  6427                                  		;jnz	short checkcmosclock
  6428                                  		; 02/10/2022
  6429 0000201D 7508                    		jnz	short checkcompaqbug
  6430                                  
  6431                                  ; install at rom fix
  6432                                  
  6433                                  		; 19/10/2022
  6434                                  		;mov	cx, offset endatrom
  6435 0000201F B9[2018]                		mov	cx, endatrom
  6436                                  		;mov	si, offset ibm_disk_io
  6437 00002022 BE[F216]                		mov	si, ibm_disk_io
  6438 00002025 EB46                    		jmp	short install_int13_patch
  6439                                  ; ----------------------------------------------------------------------------
  6440                                  
  6441                                  ; M065 -- begin changes
  6442                                  ;
  6443                                  ; On certain systems with Western Digital disk controllers, the
  6444                                  ; following detection scheme caused an unpredictable and serious
  6445                                  ; failure. In particular, they've implemented a nonstandard
  6446                                  ; Int13(ah=16h) which reconfigures the hard drive, depending on
  6447                                  ; what happens to be at es:[bx] and other memory locations indexed
  6448                                  ; off of it.
  6449                                  ;
  6450                                  ; Compaq was unable to tell us exactly which kind of systems have
  6451                                  ; the bug, except that they guarantee that the bug was fixed in
  6452                                  ; ROM BIOSs dated 08/04/86 and later. We'll check for the COMPAQ
  6453                                  ; string, and then look for date codes before 08/04/86 to decide
  6454                                  ; when to install the hook.
  6455                                  
  6456                                  ;checkcmosclock:
  6457                                  ; 02/10/2022				
  6458                                  checkcompaqbug:
  6459                                  		; 20/12/2022
  6460                                  		; es = 0F000h
  6461                                  		;mov	ax, 0F000h	; point	to ROM BIOS
  6462                                  		;mov	es, ax
  6463                                  
  6464                                  		; 19/10/2022
  6465 00002027 26813EEAFF434F          		cmp	word [es:0FFEAh], 'CO'
  6466                                  		;cmp	word ptr es:0FFEAh, 'OC' ; look for COMPAQ
  6467 0000202E 754B                    		jnz	short not_compaq_patch
  6468 00002030 26813EECFF4D50          		cmp	word [es:0FFECh], 'MP'
  6469                                  		;cmp	word ptr es:0FFECh, 'PM'
  6470 00002037 7542                    		jnz	short not_compaq_patch
  6471 00002039 26813EEEFF4151          		cmp	word [es:0FFEEh], 'AQ'
  6472                                  		;cmp	word ptr es:0FFEEh, 'QA'
  6473 00002040 7539                    		jnz	short not_compaq_patch
  6474                                  
  6475                                  ; We're running on a COMPAQ. Now look at the date code.
  6476                                  
  6477 00002042 26A1FBFF                		mov	ax, [es:0FFFBh]	; get year
  6478 00002046 86E0                    		xchg	ah, al
  6479                                  
  6480                                  ; 11/12/2023
  6481                                  ; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:22B9h)
  6482                                  %if 0
  6483                                  		cmp	ax, 3836h       ; '68' (NASM syntax) (('86' in MASM syntax))
  6484                                  		ja	short not_compaq_patch
  6485                                  		jz	short chkcompaqbug1
  6486                                  		cmp	ax, 3739h       ; '97'
  6487                                  		jbe	short not_compaq_patch
  6488                                  		stc
  6489                                  chkcompaqbug1:
  6490                                  		jb	short do_compaq_patch
  6491                                  		mov	ax, [es:0FFF5h]
  6492                                  		xchg	ah, al
  6493                                  		cmp	ax, 3038h       ; '80'
  6494                                  		ja	short not_compaq_patch
  6495                                  		jb	short do_compaq_patch
  6496                                  		mov	ax, [es:0FFF8h]
  6497                                  		xchg	ah, al
  6498                                  		cmp	ax, 3034h       ; '40'
  6499                                  		jnb	short not_compaq_patch
  6500                                  do_compaq_patch:
  6501                                  %endif
  6502                                  		; 11/12/2023
  6503                                  		; (MSDOS 6.22 IO.SYS - BIOSDATA:1C85h)
  6504                                  
  6505 00002048 3D3638                  		cmp	ax, 3836h ; 02/10/2022 (NASM syntax)
  6506                                  		;cmp	ax, '86'        ; 3836h
  6507                                  					; is it	86?
  6508 0000204B 772E                    		ja	short not_compaq_patch
  6509 0000204D 7218                    		jb	short do_compaq_patch
  6510 0000204F 26A1F5FF                		mov	ax, [es:0FFF5h]	; get month
  6511 00002053 86E0                    		xchg	ah, al
  6512 00002055 3D3830                  		cmp	ax, 3038h ; 02/10/2022 (NASM syntax)
  6513                                  		;cmp	ax, '08'        ; 3038h
  6514                                  					; is it	08?
  6515 00002058 7721                    		ja	short not_compaq_patch
  6516 0000205A 720B                    		jb	short do_compaq_patch
  6517 0000205C 26A1F8FF                		mov	ax, [es:0FFF8h]	; get day
  6518 00002060 86E0                    		xchg	ah, al
  6519 00002062 3D3430                  		cmp	ax, 3034h ; 02/10/2022 (NASM syntax)
  6520                                  		;cmp	ax, '04'        ; 3034h
  6521                                  					; is it	04?
  6522 00002065 7314                    		jnb	short not_compaq_patch
  6523                                  
  6524                                  do_compaq_patch:			
  6525 00002067 B9[3D18]                		mov	cx, end_compaq_i13hook
  6526                                  		;mov	si, endatrom
  6527                                  		; 11/12/2023
  6528 0000206A BE[2018]                		mov	si, compaq_disk_io ; endatrom
  6529                                  
  6530                                  install_int13_patch:			
  6531 0000206D 0E                      		push	cs
  6532 0000206E 07                      		pop	es
  6533                                  		; 18/10/2022
  6534 0000206F 893E[B400]              		mov	[Orig13], di	; set new rom bios int 13 vector
  6535 00002073 8C0E[B600]              		mov	[Orig13+2], cs
  6536 00002077 29F1                    		sub	cx, si		; size of rom fix module
  6537 00002079 F3A4                    		rep movsb		; relocate it
  6538                                  
  6539                                  ; M065 -- end changes
  6540                                  
  6541                                  ; ----------------------------------------------------------------------------
  6542                                  not_compaq_patch:			; M065
  6543                                  		; 17/10/2022
  6544                                  checkcmosclock:	
  6545                                  		; 18/10/2022		
  6546 0000207B 0E                      		push	cs
  6547 0000207C 07                      		pop	es
  6548                                  
  6549                                  		; 20/12/2022
  6550                                  		; ds = cs = es
  6551                                  		; ss = 0
  6552                                  		; sp = 700h
  6553                                  
  6554                                  ; 09/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  6555                                  %if 0
  6556                                  		cmp	byte [havecmosclock], 1 ; cmos clock exists?
  6557                                  		jnz	short checkk09	; no
  6558                                  
  6559                                  		mov	word [daycnttoday], di
  6560                                  		;mov	word ptr ds:daycnttoday, di ; set the address for mschar
  6561                                  		mov	cx, 209	 ; enddaycnttoday - daycnt_to_day
  6562                                  		mov	si, daycnt_to_day
  6563                                  		rep movsb
  6564                                  		mov	word [bintobcd], di
  6565                                  		;mov	word ptr ds:bintobcd, di ; set the address for msclock
  6566                                  					; let original segment stay
  6567                                  		;mov	cx, 11	; endcmosclockset - bin_to_bcd
  6568                                  		; 08/08/2023
  6569                                  		mov	cl, 11
  6570                                  		mov	si, bin_to_bcd
  6571                                  		rep movsb
  6572                                  %endif
  6573                                  
  6574                                  ; 09/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  6575                                  ; PCDOS 7.1 IBMBIO.COM - BIOSDATA:22F4h
  6576                                  		;push	cs
  6577                                  		;pop	es
  6578                                  checkk09:				
  6579 0000207D 57                      		push	di ; ? ; save ? ; 21/12/2022
  6580                                  
  6581                                  ; 13/12/2023 - Retro DOS v4.2 IO.SYS
  6582                                  ; (MSDOS 6.22 IO.SYS - BIOSDATA:1CDAh)
  6583                                  %if 0		
  6584                                  
  6585                                  		mov	ax, 4101h	; wait for bh=es:[di]
  6586                                  		mov	bl, 1		; wait for 1 clock tick
  6587                                  		mov	bh, [es:di]
  6588                                  		stc			; Assume we will fail
  6589                                  		int	15h		; SYSTEM - WAIT	ON EXTERNAL EVENT (CONVERTIBLE)
  6590                                  					; AL = condition type, BH = condition compare or mask value
  6591                                  					; BL = timeout value times 55 milliseconds, 00h	means no timeout
  6592                                  					; DX = I/O port	address	if AL bit 4 set
  6593                                  					; 11/12/2023
  6594                                  					; ES:DI = user byte if AL bit 4 clear
  6595                                  %endif
  6596                                  		; 13/12/2023 - Retro DOS v5.0 IBMBIO.COM/IO.SYS
  6597                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:1CDAh)
  6598                                  	
  6599                                  		; ........
  6600                                  
  6601 0000207E B80041                  		mov	ax, 4100h	; wait for any external event (al=0)
  6602 00002081 B304                    		mov	bl, 4		; wait for 4 clock ticks
  6603 00002083 F9                      		stc			; Assume we will fail
  6604 00002084 CD15                    		int	15h		; SYSTEM - WAIT ON EXTERNAL EVENT (CONVERTIBLE)
  6605                                  					; AL = condition type, BH = condition compare or mask value
  6606                                  					; BL = timeout value times 55 milliseconds, 00h means no timeout
  6607                                  					; DX = I/O port address if AL bit 4 set
  6608                                  		; ........
  6609                                  
  6610 00002086 5F                      		pop	di ; ?
  6611 00002087 721B                    		jc	short configdone ; 21/12/2022
  6612                                  
  6613 00002089 C606[7900]01            		mov	byte [fhavek09], 1
  6614                                  					; remember we have a k09 type
  6615 0000208E 1E                      		push	ds
  6616 0000208F 31C0                    		xor	ax, ax
  6617 00002091 8ED8                    		mov	ds, ax
  6618                                  		
  6619 00002093 893EB001                		mov	[6Ch*4], di
  6620                                  		;mov	ds:1B0h, di	; [6Ch*4]
  6621                                  					; new int 6Ch handler
  6622                                  		;mov	word ptr ds:1B2h, cs ; [6Ch*4+2]
  6623 00002097 8C0EB201                		mov	word [6Ch*4+2], cs
  6624 0000209B 1F                      		pop	ds
  6625                                  		; 20/12/2022
  6626                                  		; ds = cs = es
  6627                                  		;mov	si, int6c
  6628                                  		;mov	cx, endk09-int6c ; 459
  6629                                  		;;mov	cx, 459		; endk09 - int6c
  6630                                  					; size of k09 routine
  6631                                  		; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  6632                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:2315h
  6633 0000209C BE[3E18]                		mov	si, int_6Ch
  6634 0000209F B9BC01                  		mov	cx, endk09-int_6Ch ; 461 in PCDOS 7.1 IBMBIO.COM
  6635 000020A2 F3A4                    		rep movsb		;
  6636                                  					; set up config	stuff for sysinit
  6637                                  ; ----------------------------------------------------------------------------
  6638                                  ; Set up config stuff for SYSINIT
  6639                                  
  6640                                  ; 17/10/2022
  6641                                  ;SETDRIVE equ SetDrive - DOSBIOSEG_2C7h ; (4D7h for MSDOS 5.0 IO.SYS)
  6642                                  ;GETBP equ GetBp - DOSBIOSEG_2C7h ; (606h for MSDOS 5.0 IO.SYS)
  6643                                  ; 09/12/2022
  6644                                  SETDRIVE equ SetDrive
  6645                                  GETBP equ GetBp
  6646                                  		
  6647                                  		; 17/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
  6648                                  configdone:	
  6649                                  		; 21/12/2022			
  6650                                  		; 20/03/2019
  6651                                  		;push	cs		; di is	final ending address of	msbio.
  6652                                  		;pop	ds
  6653                                  		
  6654 000020A4 83C70F                  		add	di, 15		; round	(up) to	paragraph
  6655                                  		; 10/12/2022
  6656                                  		;shr	di, 1
  6657                                  		;shr	di, 1
  6658                                  		;shr	di, 1
  6659                                  		;shr	di, 1
  6660 000020A7 B104                    		mov	cl, 4
  6661 000020A9 D3EF                    		shr	di, cl		
  6662                                  		; 10/12/2022
  6663 000020AB 83C770                  		add	di, 70h	 ; KERNEL_SEGMENT (in fact: IO.SYS loading segment)
  6664                                  		; 19/10/2022 - Temporary !
  6665                                  		;db	81h, 0C7h, 70h, 0 ; add di, 0070h
  6666 000020AE 893E[0300]              		mov	[DosDataSg], di	; where	the dos	data segment will be
  6667                                  
  6668                                  ; 21/12/2022 - Retro DOS v4.0 (MSDOS 5.0 combined/single kernel file)
  6669                                  
  6670                                  ; 19/03/2018 - No need to read remain clusters of MSDOS kernel because
  6671                                  	     ; Retro DOS v2.0 boot sector has loaded all of the kernel file before.
  6672                                  	     
  6673                                  	     ; ("MSINIT.ASM" contains kernel file reading code here, below...)
  6674                                  
  6675                                  ; 11/12/2023 - Retro DOS v5.0 (PCDOS 7.1 combined/single kernel file)
  6676                                  
  6677                                  	     ; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2332h)
  6678                                  
  6679                                  	     ; (("IBMDOS.COM" kernel file reading code here, below...))	
  6680                                  
  6681                                  ; ----------------------------------------------------------------------------
  6682                                  ; ----------------------------------------------------------------------------
  6683                                  %if 0
  6684                                  		mov	ax, [drvfat]	; get drive and	fat id
  6685                                  		; 22/12/2022
  6686                                  		; Note: SETDRIVES uses AL (drive number) only
  6687                                  		mov	bp, SETDRIVE
  6688                                  		;mov	bp, 5AEh ; 11/12/2023 (PCDOS 7.1 IBMBIO.COM)
  6689                                  		;;mov	bp, 4D7h	; set_drive (in	dosbios	code segment)
  6690                                  					; at 2C7h:4D7h = 70h:2A47h
  6691                                  		push	cs		; simulate far call
  6692                                  		call	call_bios_code	; get bds for drive
  6693                                  		mov	bp, GETBP	; ensure valid bpb is present
  6694                                  		;mov	bp, 6E4h ; 11/12/2023 (PCDOS 7.1 IBMBIO.COM)
  6695                                  		;;mov	bp, 606h	; GetBp (2C7h:606h = 70h:2B76h)
  6696                                  		push	cs
  6697                                  		call	call_bios_code
  6698                                  
  6699                                  	; resort to funky old segment definitions for now
  6700                                  
  6701                                  		; 22/12/2022
  6702                                  		;push	es		; copy bds to ds:di
  6703                                  		;pop	ds
  6704                                  
  6705                                  	; the following read of es:0000 was spurious anyway. Should look into it.
  6706                                  	;
  6707                                  	; hmmmmmm. j.k. took out a call to getfat right here a while
  6708                                  	;	  back. Apparently it was what actually setup es: for the following
  6709                                  	; cas----
  6710                                  
  6711                                  		; 22/12/2022
  6712                                  		;xor	di, di
  6713                                  		;mov	al, [es:di]	; get fat id byte
  6714                                  		;;mov	byte ptr es:drvfat+1, al ; save fat byte
  6715                                  		;mov	[es:drvfat+1], al
  6716                                  		;mov	ax, [es:drvfat]
  6717                                  		
  6718                                  		; 22/12/2022
  6719                                  		; ds = cs
  6720                                  	;;;	mov	al, [drvfat]
  6721                                  
  6722                                  	; cas -- why do a SECOND setdrive here???
  6723                                  
  6724                                  		; 22/12/2022
  6725                                  		;push	es		; save whatever's in es
  6726                                  		;push	ds		; copy bds to es:di
  6727                                  		;pop	es
  6728                                  		;push	cs		; copy Bios_Data to ds
  6729                                  		;pop	ds
  6730                                  	
  6731                                  	; 22/12/2022
  6732                                  	;;;	mov	bp, SETDRIVE
  6733                                  	;;;	;mov	bp, 4D7h	; SetDrive (2C7h:47Dh = 70h:2A47h)
  6734                                  	;;;	push	cs		; simulate far call
  6735                                  	;;;	call	call_bios_code	; get correct bds for this drive
  6736                                  	
  6737                                  		; 22/12/2022
  6738                                  		;push	es		; copy bds back to ds:di
  6739                                  		;pop	ds
  6740                                  		;pop	es		; pop whatever was in es
  6741                                  
  6742                                  	; Now we load in the MSDOS.SYS file
  6743                                  
  6744                                  	; 22/12/2022
  6745                                  	; -----
  6746                                  	;	mov	bx, [di+6]	; [di+BDS.BDS_BPB.BPB_BYTESPERSECTOR]
  6747                                  	;	mov	[cs:md_sectorsize], bx	; used by get_fat_sector proc.
  6748                                  	;	mov	bl, [di+1Fh]	; [di+BDS.fatsiz]
  6749                                  	;				; get size of fat on media
  6750                                  	;	;mov	es:16DEh, bl
  6751                                  	;	mov	[es:fbigfat], bl
  6752                                  	;	mov	cl, [di+8]
  6753                                  	;	mov	ax, [di+17h] ; [di+BDS.BDS_BPB.BPB_HIDDENSECTORS]
  6754                                  	;	;sub	es:16D8h, ax
  6755                                  	;	sub	[es:bios_l], ax	; subtract hidden sectors since we
  6756                                  	;				; need a logical sector number that will
  6757                                  	;				; be used by getclus(diskrd procedure)
  6758                                  	;	mov	ax, [di+19h] ; [di+BDS.BDS_BPB.BPB_HIDDENSECTORS+2]
  6759                                  	;	;sbb	es:16DAh, ax
  6760                                  	;	sbb	[es:bios_h], ax	; subtract upper 16 bits of sector num
  6761                                  	; -----
  6762                                  		
  6763                                  		; 11/12/2023 - Retro DOS v5.0 IO.SYS/IBMBIO.COM
  6764                                  	; -----	; 22/12/2022
  6765                                  		mov	bx, [es:di+6]	; [di+BDS.BDS_BPB.BPB_BYTESPERSECTOR]
  6766                                  		mov	[md_sectorsize], bx ; used by get_fat_sector proc.
  6767                                  		; 11/12/2023 ; *
  6768                                  		mov	bl, [es:di+3Bh]	; [di+BDS.fatsiz] ; *
  6769                                  		;mov	bl, [es:di+1Fh]	; [di+BDS.fatsiz]
  6770                                  					; get size of fat on media
  6771                                  		mov	[fbigfat], bl
  6772                                  		mov	cl, [es:di+8]
  6773                                  		mov	ax, [es:di+17h] ; [di+BDS.BDS_BPB.BPB_HIDDENSECTORS]
  6774                                  		sub	[First_Data_Sector], ax ; *
  6775                                  		;sub	[bios_l], ax	; subtract hidden sectors since we
  6776                                  					; need a logical sector number that will
  6777                                  					; be used by getclus(diskrd procedure)
  6778                                  		mov	ax, [es:di+19h] ; [di+BDS.BDS_BPB.BPB_HIDDENSECTORS+2]
  6779                                  		sbb	[First_Data_Sector+2], ax ; *
  6780                                  		;sbb	[bios_h], ax	; subtract upper 16 bits of sector num
  6781                                  	; ------
  6782                                  
  6783                                  		xor	ch, ch	 ; cx = sectors/cluster
  6784                                  
  6785                                  	; the boot program has left the directory at 0:500h
  6786                                  
  6787                                  		; 11/12/2023 - - Retro DOS v5.0 IBMBIO.COM/IO.SYS
  6788                                  		;push	di
  6789                                  		push	ds
  6790                                  		;xor	di, di
  6791                                  		;mov	ds, di
  6792                                  		xor	bx, bx ; 0
  6793                                  		mov	ds, bx
  6794                                  		mov	bx, [53Ah]
  6795                                  		;mov	bx, ds:53Ah    	; (First cluster of the 2nd dir entry
  6796                                  				   	; of root directory in the buffer at 500h)
  6797                                  		pop	ds
  6798                                  		mov     si, [firstcluster_hw] ; 11/12/2023 
  6799                                  				   	; (32 bit cluster number for FAT32 fs)
  6800                                  		;pop	ds
  6801                                  		;pop	di
  6802                                  
  6803                                  		; 12/12/2023
  6804                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2397h)
  6805                                  		; ...........
  6806                                  		; ds = cs
  6807                                  		mov	al, [fbigfat]
  6808                                  		push	ax              ; (*) save fbigfat flags
  6809                                  		mov	al, [drvfat]
  6810                                  		or	al, [Boot_Drv]
  6811                                  		jnz	short boot_drv_fixed ; hard disk
  6812                                  boot_drv_removable:			; calculate cluster count and set fbig or fbigbig flag
  6813                                  		push	bx              ; for removable drives
  6814                                  		push	cx
  6815                                  		; 28/12/2023
  6816                                  		;push	dx ; (not necessary)
  6817                                  	
  6818                                  		; 12/12/2023
  6819                                  		push	es
  6820                                  		pop	ds
  6821                                  
  6822                                  		mov	ax, [di+0Eh]    ; [di+BDS.totalsecs16]
  6823                                  		xor	dx, dx
  6824                                  		or	ax, ax
  6825                                  		jnz	short prep_totalsecs_ok
  6826                                  		mov	ax, [di+1Bh]    ; [di+BDS.totalsecs32]
  6827                                  		mov	dx, [di+1Dh]
  6828                                  prep_totalsecs_ok:
  6829                                  		sub	ax, [di+9]      ; [di+BDS.resectors]
  6830                                  		sbb	dx, 0
  6831                                  		push	ax
  6832                                  		push	dx
  6833                                  		mov	bx, [di+11h]    ; [di+BDS.fatsecs16]
  6834                                  		xor	ax, ax
  6835                                  		or	bx, bx
  6836                                  		jnz	short prep_fatsecs_ok
  6837                                  		mov	bx, [di+1Fh]    ; [di+BDS.fatsecs32]
  6838                                  		mov	ax, [di+21h]
  6839                                  prep_fatsecs_ok:
  6840                                  		mov	cl, [di+0Bh]    ; ax:bx = 32 bit count of FAT sectors
  6841                                  				        ; [di+BDS.fats]
  6842                                  		xor	ch, ch
  6843                                  		mul	cx
  6844                                  		xchg	ax, cx
  6845                                  		mul	bx
  6846                                  		add	cx, dx
  6847                                  		mov	bx, ax          ; cx:bx = total (2*) fat sectors
  6848                                  		pop	dx
  6849                                  		pop	ax              ; dx:ax = totals sectors - reserved sectors
  6850                                  		sub	ax, bx
  6851                                  		sbb	dx, cx          ; dx:ax = data sectors (includes root dir sectors)
  6852                                  		mov	bx, [di+0Ch]    ; [di+BDS.direntries]
  6853                                  		add	bx, 15          ; 16 directory entries per sector
  6854                                  				        ; (round up sector count by adding 15)
  6855                                  		mov	cl, 4           ; (rounded) dir entries / 16
  6856                                  		shr	bx, cl
  6857                                  		xor	cx, cx
  6858                                  		sub	ax, bx
  6859                                  		sbb	dx, cx          ; dx:ax = data sectors (except root directory sectors)
  6860                                  					; (will be used for cluster count calculation)
  6861                                  		mov	cl, [di+8]      ; [di+BDS.secperclus]
  6862                                  
  6863                                  		; 12/12/2023
  6864                                  		push	cs
  6865                                  		pop	ds
  6866                                  
  6867                                  		push	ax              ; 32 bit division (data sectors / sector per cluster)
  6868                                  		mov	ax, dx
  6869                                  		xor	dx, dx
  6870                                  		div	cx
  6871                                  		mov	bx, ax
  6872                                  		pop	ax
  6873                                  		div	cx
  6874                                  		or	bx, bx          ; 32 bit cluster count if bx > 0
  6875                                  		jnz	short set_fbigbig_flag ; too big cluster number
  6876                                  		cmp	ax, 0FFF6h
  6877                                  		jb	short set_fbig_flag
  6878                                  set_fbigbig_flag:
  6879                                  		or	byte [fbigfat], 20h ; FAT32 ; fbigbig
  6880                                  		jmp	short set_fbig_flag_ok
  6881                                  ; ---------------------------------------------------------------------------
  6882                                  
  6883                                  set_fbig_flag:
  6884                                  		cmp	ax, 0FF6h       ; 4096-10
  6885                                  				        ; is this 16-bit fat?
  6886                                  		jb	short set_fbig_flag_ok ; no, small fat
  6887                                  		or	byte [fbigfat], 40h ; FAT16 ; fbig
  6888                                  set_fbig_flag_ok:
  6889                                  		; 28/12/2023
  6890                                  		;pop	dx
  6891                                  		pop	cx
  6892                                  		pop	bx
  6893                                  boot_drv_fixed:
  6894                                  		xor	di, di
  6895                                  
  6896                                  		; cx = sectors/cluster
  6897                                  		; si:bx = first cluster
  6898                                  		; di = 0
  6899                                  
  6900                                  		; ...........
  6901                                  loadit:
  6902                                  		mov	ax, SYSINITSEG	; 46Dh
  6903                                  		;mov	ax, 544h	; 11/12/2023 - PCDOS 7.1 IBMBIO.COM
  6904                                  		;;mov	ax, 46Dh	; sysinit segment
  6905                                  		mov	es, ax
  6906                                  		mov	es, [es:CURRENTDOSLOCATION] ; 09/12/2022
  6907                                  		;mov	es, [es:271h]
  6908                                  
  6909                                  		call	getclus		; read cluster at ES:DI (DI is updated)
  6910                                  
  6911                                  ; ----------------------------------------------------------------------------
  6912                                  
  6913                                  		; 13/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  6914                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2431h)
  6915                                  
  6916                                  		;test	byte [cs:fbigfat], 20h ; fbigbig ; FAT32 fs flag
  6917                                  		test	byte [fbigfat], 20h ; fbigbig ; FAT32 fs flag
  6918                                  		jz	short iseof
  6919                                  
  6920                                  eofbigbig:	; si:bx = 32 bit cluster number
  6921                                  		cmp	si, 0FFFh
  6922                                  		jnz	short iseofx
  6923                                  		cmp	bx, 0FFF7h
  6924                                  		jmp	short iseofx
  6925                                  
  6926                                  ; ----------------------------------------------------------------------------
  6927                                  		; 13/12/2023
  6928                                  iseof:
  6929                                  		;;test	byte [cs:fbigfat], fbig
  6930                                  		;test	byte [cs:fbigfat], 40h ; fbig
  6931                                  		; 12/12/2023
  6932                                  		; ds = cs
  6933                                  		test	byte [fbigfat], 40h ; fbig
  6934                                  		jnz	short eofbig
  6935                                  		cmp	bx, 0FF7h
  6936                                  		jmp	short iseofx
  6937                                  ; ----------------------------------------------------------------------------
  6938                                  
  6939                                  eofbig:
  6940                                  		cmp	bx, 0FFF7h
  6941                                  iseofx:
  6942                                  		jb	short loadit	; keep loading until cluster = eof
  6943                                  %endif
  6944                                  ; ----------------------------------------------------------------------------
  6945                                  ; ----------------------------------------------------------------------------
  6946                                  
  6947 000020B2 E80105                  		call	setdrvparms	;
  6948                                  
  6949                                  		; 28/12/2023
  6950 000020B5 58                      		pop	ax		; (*) restore fbigfat flags
  6951                                  					; (after loading DOS kernel)
  6952 000020B6 2EA2[FC19]              		mov	[cs:fbigfat], al
  6953                                  
  6954                                  		;;;jmp	far ptr	46Dh:267h ; jmp	SYSINIT_SEG:SYSINIT_START
  6955                                  		;;jmp	far 46Dh:267h
  6956                                  		; 12/12/2023
  6957                                  		;jmp	far 544h:269h	; (PCDOS 7.1 IBMBIO.COM)
  6958                                  
  6959 000020BA EA[6902]D704            		jmp	SYSINITSEG:SYSINITSTART
  6960                                  
  6961                                  ; =============== S U B	R O U T	I N E ========================================
  6962                                  
  6963                                  ; Following are subroutines to support resident device driver initialization
  6964                                  ;
  6965                                  ;M011 -- note:  deleted setup_bdsms and reset_bdsms here
  6966                                  
  6967                                  ;	M035 -- begin changed section
  6968                                  
  6969                                  ;******************************************************************************
  6970                                  ; module name: remap
  6971                                  ;
  6972                                  ; descriptive name: all the code for himem that could be separated from msbio
  6973                                  ;
  6974                                  ; function:  remap the bds chain to adjusted logical drive numbers (drive
  6975                                  ;	     letters) if more than two diskette drives on the system.
  6976                                  ;
  6977                                  ;     scheme:  if more than 2 diskette drives, first map the bds structure
  6978                                  ;	       as usual and then rescan the bds chain to adjust the drive
  6979                                  ;	       letters. to do this, scan for disk drives and assign logical
  6980                                  ;	       drive number starting from 2 and then rescan diskette drives
  6981                                  ;	       and assign next to the last logical drive number of last disk
  6982                                  ;	       drive to the 3rd and 4th diskette drives.
  6983                                  
  6984                                  ; input:       none
  6985                                  ; exit:	drive letters have been remapped in bds chain
  6986                                  ; exit error:  none
  6987                                  ; called from: msinit
  6988                                  ;
  6989                                  ; notes:  this function  will be called only if more than 2 diskettes are
  6990                                  ;	  found in the system
  6991                                  ;	  this function assumes that there are no more than 26 drives assigned
  6992                                  ;	    this is guaranteed by the code that creates bdss for partitions
  6993                                  ;	  this function assumes that the first entries in the chain are
  6994                                  ;	   floppy drives, and all the rest are hard drives
  6995                                  ;	  will alter the boot drive if necessary to reflect remapping
  6996                                  ;
  6997                                  ;******************************************************************************
  6998                                  
  6999                                  ; 17/10/2022
  7000                                  ; 02/10/2022
  7001                                  		; 15/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  7002                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2464h)
  7003                                  		; (MSDOS 6.22 IO.SYS - BIOSDATA:1D9Eh)
  7004                                  
  7005                                  remap:		; proc near
  7006                                  
  7007                                  		; 15/12/2023
  7008                                  		; ds = cs
  7009                                  		;mov	di, [cs:start_bds] ; get first bds
  7010 000020BF 8B3E[1901]              		mov	di, [start_bds]
  7011                                  
  7012                                  ; search for 1st fixed disk physical drive num
  7013                                  
  7014                                  drive_loop:
  7015 000020C3 807D0480                		cmp	byte [di+4], 80h ; [di+BDS.drivenum]
  7016                                  					; first	hard disk??
  7017 000020C7 7409                    		jz	short fdrv_found ; yes,	continue
  7018 000020C9 8B3D                    		mov	di, [di]	; [di+BDS.link]
  7019                                  					; get next bds,	assume segment
  7020 000020CB 83FFFF                  		cmp	di, -1 ; 0FFFFh	; last bds?
  7021 000020CE 75F3                    		jnz	short drive_loop ; loop	if not
  7022 000020D0 EB49                    		jmp	short rmap_exit	; yes, no hard drive on	system
  7023                                  
  7024                                  ;------------------------------------------------------------------------------
  7025                                  ;first disk drive bds, now change the logical drive num to 2 and the subsequent
  7026                                  ;logical drive nums to 3, 4, 5 etc.
  7027                                  ;------------------------------------------------------------------------------
  7028                                  
  7029                                  fdrv_found:
  7030 000020D2 B002                    		mov	al, 2		; start	with logical drv num=2
  7031                                  fdrv_loop:
  7032 000020D4 884505                  		mov	[di+5],	al	; [di+BDS.drivelet]
  7033 000020D7 8B3D                    		mov	di, [di]	; [di+BDS.link]
  7034                                  					; ds:di--> next	bds
  7035                                  		;inc	al		; set num for next drive
  7036                                  		; 18/12/2022
  7037 000020D9 40                      		inc	ax
  7038 000020DA 83FFFF                  		cmp	di, 0FFFFh	; last hard drive ?
  7039 000020DD 75F5                    		jnz	short fdrv_loop	; no - assign more disk drives
  7040                                  
  7041                                  ;------------------------------------------------------------------------------
  7042                                  ; now, rescan and find bds of 3rd floppy drive and assign next drive letter
  7043                                  ; in al to 3rd. if the current drive letter is past z, then do not allocate
  7044                                  ; any more.
  7045                                  ;------------------------------------------------------------------------------
  7046                                  
  7047                                  		;mov	di, [cs:start_bds] ; [start_bds]
  7048                                  		; 15/12/2023
  7049 000020DF 8B3E[1901]              		mov	di, [start_bds]	; get first bds
  7050 000020E3 8B3D                    		mov	di, [di]	; [di+BDS.link]
  7051                                  					; ds:di-->bds2
  7052                                  		;mov	ah, [cs:dsktnum] ; get number of floppies to remap
  7053 000020E5 8A26[2501]              		mov	ah, [dsktnum]
  7054 000020E9 80EC02                  		sub	ah, 2		; adjust for a:	& b:
  7055                                  remap_loop1:
  7056 000020EC 8B3D                    		mov	di, [di]	; [di+BDS.link]
  7057                                  					; set new num to next floppy
  7058 000020EE 884505                  		mov	[di+5],	al	; [di+BDS.drivelet]
  7059 000020F1 FEC0                    		inc	al		; new number for next floppy
  7060 000020F3 FECC                    		dec	ah		; count down extra floppies
  7061 000020F5 75F5                    		jnz	short remap_loop1
  7062                                  
  7063                                  ; now we've got to adjust the boot drive if we reassigned it
  7064                                  
  7065                                  		; 15/12/2023
  7066                                  		;mov	al, [cs:drvfat]
  7067 000020F7 A0[FA19]                		mov	al, [drvfat]
  7068 000020FA 3C02                    		cmp	al, 2		; is it	a: or b: ?
  7069 000020FC 721D                    		jb	short rmap_exit
  7070                                  		;sub	al, [cs:dsktnum]
  7071 000020FE 2A06[2501]              		sub	al, [dsktnum]	; is it one of the other floppies?
  7072 00002102 7204                    		jb	short remap_boot_flop ;	brif so
  7073                                  
  7074                                  ; we've got to remap the boot hard drive
  7075                                  ; subtract the number of EXTRA floppies from it
  7076                                  
  7077 00002104 0402                    		add	al, 2		; bootdrv -= (dsktnum-2)
  7078 00002106 EB04                    		jmp	short remap_change_boot_drv
  7079                                  ; ---------------------------------------------------------------------------
  7080                                  
  7081                                  ; we've got to remap the boot floppy.
  7082                                  ; add the number of hard drive partitions to it
  7083                                  
  7084                                  remap_boot_flop:
  7085                                  		;add	al, [cs:drvmax]	; bootdrv += (drvmax-dsktnum)
  7086                                  		; 15/12/2023
  7087 00002108 0206[7500]              		add	al, [drvmax]
  7088                                  remap_change_boot_drv:			
  7089                                  		;mov	[cs:drvfat], al ; alter msdos.sys load drive
  7090 0000210C A2[FA19]                		mov	[drvfat], al
  7091 0000210F FEC0                    		inc	al
  7092 00002111 1E                      		push	ds
  7093 00002112 BFD704                  		mov	di, SYSINITSEG	; 46Dh
  7094                                  		;mov	di, 544h	; PCDOS 7.1 IBMBIO.COM
  7095                                  		;;mov	di, 46Dh	; SYSINIT segment
  7096 00002115 8EDF                    		mov	ds, di
  7097 00002117 A2[9802]                		mov	[DEFAULTDRIVE], al
  7098                                  		;mov	ds:296h, al	; [SYSINIT+DEFAULT_DRIVE]
  7099                                  					; pass it to sysinit as	well
  7100 0000211A 1F                      		pop	ds ; ds = cs
  7101                                  rmap_exit:
  7102 0000211B C3                      		retn
  7103                                  
  7104                                  ; =============== S U B	R O U T	I N E =======================================
  7105                                  
  7106                                  ; 17/10/2022
  7107                                  ; 02/10/2022 - Retro DOS v4.0 (MSDOS 5.0 -actual-)
  7108                                  ; 28/12/2018 - Retro DOS v4.0 (MSDOS 6.21 -draft-)
  7109                                  ; 02/06/2018 - Retro DOS v3.0 (MSDOS 3.3)	
  7110                                  ; 19/03/2018 - Retro DOS v2.0 (MSDOS 2.11)
  7111                                  ;**************************************************
  7112                                  ; getboot - get the boot sector for a hard disk
  7113                                  ;
  7114                                  ; Reads the boot sector from a specified drive into
  7115                                  ; a buffer at the top of memory.
  7116                                  ;
  7117                                  ; dl = int13 drive number to read boot sector for
  7118                                  ;**************************************************
  7119                                  
  7120                                  ; 17/10/2022
  7121                                  bootbias equ 200h
  7122                                  
  7123                                  getboot:	; proc near
  7124                                  
  7125                                  		; 15/12/2023 - Retro DOS v5.0 
  7126                                  		;	 (Modified PCDOS 7.1) IBMBIO.COM/IO.SYS
  7127                                  		; ds = cs
  7128                                  		
  7129                                  		; 08/04/2018
  7130                                  		; Retro DOS v2.0 (IBMBIO.COM, IBMDOS 2.1)
  7131                                  		; 28/03/2018 - MSDOS 6.0 - MSINIT.ASM, 1991
  7132                                  		; 02/10/2022 - Retro DOS v4.0
  7133                                  		;	      (disassembled IO.SYS code of MSDOS 5.0)
  7134                                  
  7135                                  		;mov	ax, [cs:init_bootseg] ; 17/10/2022
  7136                                  		; 15/12/2023
  7137 0000211C A1[FD19]                		mov	ax, [init_bootseg]
  7138 0000211F 8EC0                    		mov	es, ax
  7139                                  
  7140                                  		; 17/10/2022
  7141 00002121 BB0002                  		mov	bx, bootbias ; 200h
  7142                                  		;mov	bx, 200h	; bootbias
  7143                                  					; load BX, ES:BX is where sector goes
  7144 00002124 B80102                  		mov	ax, 201h
  7145 00002127 30F6                    		xor	dh, dh
  7146 00002129 B90100                  		mov	cx, 1
  7147 0000212C CD13                    		int	13h		; DISK - READ SECTORS INTO MEMORY
  7148                                  					; AL = number of sectors to read, CH = track, CL = sector
  7149                                  					; DH = head, DL	= drive, ES:BX -> buffer to fill
  7150                                  					; Return: CF set on error, AH =	status,	AL = number of sectors read
  7151 0000212E 7209                    		jc	short erret
  7152                                  		; 17/10/2022
  7153 00002130 26813EFE0355AA          		cmp	word [es:bootbias+1FEh], 0AA55h
  7154                                  		;cmp	word ptr es:3FEh, 0AA55h ; [es:bootbias+1FEh]
  7155                                  					; Dave Litton magic word?
  7156 00002137 7401                    		jz	short norm_ret	; yes
  7157                                  erret:
  7158 00002139 F9                      		stc
  7159                                  norm_ret:
  7160 0000213A C3                      		retn
  7161                                  
  7162                                  ; =============== S U B	R O U T	I N E =======================================
  7163                                  
  7164                                  ; 28/12/2018 - Retro DOS v4.0 
  7165                                  
  7166                                  ;***************************************************************************
  7167                                  ;   sethard - generate bpb for a variable sized hard file. ibm has a
  7168                                  ;   partitioned hard file; we must read physical sector 0 to determine where
  7169                                  ;   our own logical sectors start. we also read in our boot sector to
  7170                                  ;   determine version number
  7171                                  ;
  7172                                  ;   inputs:	dl is rom drive number (80...)
  7173                                  ;		bh is partition number (0....) 
  7174                                  ;		ds:di points to bds
  7175                                  ;   outputs:	carry clear -> bpb is filled in
  7176                                  ;		carry set   -> bpb is left uninitialized due to error
  7177                                  ;	trashes (at least) si, cx
  7178                                  ;	MUST PRESERVE ES:!!!!
  7179                                  ;***************************************************************************
  7180                                  
  7181                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  7182                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:24E9h)
  7183                                  
  7184                                  sethard:	; proc near
  7185                                  		; 12/08/2023
  7186                                  		; ds = cs = BIOSDATA
  7187 0000213B 57                      		push	di
  7188 0000213C 53                      		push	bx
  7189                                  		;push	ds  ; ds = cs = BIOSDATA ; 12/08/2023
  7190 0000213D 06                      		push	es
  7191 0000213E 885D05                  		mov	[di+5],	bl	; [di+BDS.drivelet]
  7192 00002141 885504                  		mov	[di+4],	dl	; [di+BDS.drivenum]
  7193                                  		; 16/12/2023
  7194 00002144 804D3F01                		or	byte [di+3Fh], 1 ; PCDOS 7.1
  7195                                  		;or	byte [di+23h], 1 ; [di+BDS.flags]
  7196                                  					; fnon_removable
  7197 00002148 C6453E05                		mov	byte [di+3Eh], 5 ; PCDOS 7.1
  7198                                  		;mov	byte [di+22h], 5 ; [di+BDS.formfactor]
  7199                                  					; ffHardFile
  7200 0000214C C606[FC19]00            		mov	byte [fbigfat], 0 ; assume 12 bit FAT
  7201 00002151 88FE                    		mov	dh, bh		; partition number
  7202 00002153 52                      		push	dx
  7203 00002154 B408                    		mov	ah, 8
  7204 00002156 CD13                    		int	13h		; DISK - DISK -	GET CURRENT DRIVE PARAMETERS (XT,AT,XT286,CONV,PS)
  7205                                  					; DL = drive number
  7206                                  					; Return: CF set on error, AH =	status code, BL	= drive	type
  7207                                  					; DL = number of consecutive drives
  7208                                  					; DH = maximum value for head number, ES:DI -> drive parameter
  7209                                  		;inc	dh
  7210                                  		; 16/12/2023 - Retro DOS v5.0
  7211 00002158 88F2                    		mov	dl, dh
  7212 0000215A B600                    		mov	dh, 0
  7213 0000215C 42                      		inc	dx
  7214                                  		;mov	[di+15h], dh	; [di+BDS.heads] ; get number of heads
  7215 0000215D 895515                  		mov	[di+15h], dx
  7216 00002160 5A                      		pop	dx
  7217 00002161 7253                    		jc	short setret	; error	if no hard disk
  7218                                  		; 16/12/2023
  7219                                  		;jc	short setret_j
  7220                                  		
  7221 00002163 80E13F                  		and	cl, 3Fh
  7222 00002166 884D13                  		mov	[di+13h], cl	; [di+BDS.secpertrack]
  7223 00002169 52                      		push	dx		; save partition number
  7224 0000216A E8AFFF                  		call	getboot
  7225 0000216D 5A                      		pop	dx		; restore partition number
  7226 0000216E 7246                    		jc	short setret
  7227                                  		; 16/12/2023
  7228                                  		;jnc	short chk_act_part
  7229                                  ;setret_j:
  7230                                  		;jmp	setret
  7231                                  
  7232                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  7233                                  chk_act_part:
  7234 00002170 31DB                    		xor	bx, bx ; 0
  7235                                  		;;mov	[cs:ep_start_sector], bx
  7236                                  		;;mov	[cs:ep_start_sector+2], bx
  7237                                  		;mov	[cs:ep_hidden_secs], bx
  7238                                  		;mov	[cs:ep_hidden_secs+2], bx
  7239                                  		; 16/12/2023
  7240                                  		; ds = cs
  7241                                  		; 20/12/2023
  7242                                  		;mov	[ep_start_sector], bx
  7243                                  		;mov	[ep_start_sector+2], bx
  7244 00002172 891E[D821]              		mov	[ep_hidden_secs], bx
  7245 00002176 891E[DA21]              		mov	[ep_hidden_secs+2], bx
  7246                                  		
  7247 0000217A BBC203                  		mov	bx, 3C2h	; 1C2h+bootbias
  7248                                  
  7249                                  ; The first 'active' partition is 00, the second is 01....
  7250                                  ;   then the remainder of the 'primary' but non-active partitions
  7251                                  
  7252                                  act_part:
  7253 0000217D 26F647FC80              		test	byte [es:bx-4], 80h ; is the partition active?
  7254 00002182 740B                    		jz	short no_act	; no
  7255                                  ; 16/12/2023
  7256                                  %if 0		
  7257                                  		; 16/12/2023
  7258                                  		; reject if partitiontype != 1, 4, 6, 0Bh, 0Ch, 0Eh
  7259                                  		cmp	byte [es:bx], 1 ; FAT12
  7260                                  		jz	short got_good_act
  7261                                  		cmp	byte [es:bx], 4	; FAT16 CHS (<= 32MB)
  7262                                  		jz	short got_good_act
  7263                                  		
  7264                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  7265                                  		cmp	byte [es:bx], 0Bh ; FAT32 CHS
  7266                                  		jz	short got_good_act
  7267                                  		cmp	byte [es:bx], 0Ch ; FAT32 LBA
  7268                                  		jz	short got_good_act
  7269                                  		cmp	byte [es:bx], 0Eh ; FAT16 LBA
  7270                                  		jz	short got_good_act
  7271                                  
  7272                                  		cmp	byte [es:bx], 6	; FAT16 BIG CHS (> 32MB)
  7273                                  		jnz	short no_act
  7274                                  ;%else
  7275                                  		; 16/12/2023
  7276                                  		mov	al, [es:bx]	 ; partition type
  7277                                  
  7278                                  		; reject if partitiontype != 1, 4, 6, 0Bh, 0Ch, 0Eh
  7279                                  		cmp	al, 1		; FAT12
  7280                                  		je	short got_good_act
  7281                                  		cmp	al, 4		; FAT16 CHS (<= 32MB)
  7282                                  		je	short got_good_act
  7283                                  		
  7284                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  7285                                  		cmp	al, 0Bh		; FAT32 CHS
  7286                                  		je	short got_good_act
  7287                                  		cmp	al, 0Ch		; FAT32 LBA
  7288                                  		je	short got_good_act
  7289                                  		cmp	al, 0Eh		; FAT16 LBA
  7290                                  		je	short got_good_act
  7291                                  
  7292                                  		cmp	al, 6		; FAT16 BIG CHS (> 32MB)
  7293                                  		jne	short no_act
  7294                                  %endif		
  7295                                  		; 16/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
  7296                                  		; check if it is a primary dos partition
  7297                                  
  7298 00002184 E83300                  		call	chk_partition_type
  7299 00002187 7506                    		jne	short no_act
  7300                                  
  7301                                  got_good_act:				; 11/08/2023
  7302 00002189 08F6                    		or	dh, dh		; is this our target partition #?
  7303                                  					; (0 = first primary dos or active partition)
  7304 0000218B 744F                    		jz	short set2	; WE GOT THE ONE WANTED!!
  7305 0000218D FECE                    		dec	dh		; count	down
  7306                                  no_act:					
  7307 0000218F 83C310                  		add	bx, 16
  7308 00002192 81FB0204                		cmp	bx, 402h	; 202h+bootbias
  7309                                  					; last entry done?
  7310 00002196 75E5                    		jnz	short act_part	; no, process next entry
  7311                                  
  7312 00002198 BBC203                  		mov	bx, 3C2h	; 1C2h+bootbias
  7313                                  					; restore original value of bx
  7314                                  
  7315                                  ; Now scan the non-active partitions
  7316                                  
  7317                                  get_primary:
  7318 0000219B 26F647FC80              		test	byte [es:bx-4], 80h
  7319 000021A0 750B                    		jnz	short not_prim	; we've already scanned
  7320                                  					; the ACTIVE ones
  7321                                  ; 16/12/2023
  7322                                  %if 0
  7323                                  		; 16/12/2023
  7324                                  		; see if partitiontype == 1, 4, 6, 0Bh, 0Ch, 0Eh
  7325                                  		cmp	byte [es:bx], 1	; FAT12
  7326                                  		jz	short got_prim
  7327                                  		cmp	byte [es:bx], 4	; FAT16 CHS (<= 32MB)
  7328                                  		jz	short got_prim
  7329                                  
  7330                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  7331                                  		cmp	byte [es:bx], 0Bh ; FAT32 CHS
  7332                                  		jz	short got_prim
  7333                                  		cmp	byte [es:bx], 0Ch ; FAT32 LBA
  7334                                  		jz	short got_prim
  7335                                  		cmp	byte [es:bx], 0Eh ; FAT16 LBA
  7336                                  		jz	short got_prim
  7337                                  
  7338                                  		cmp	byte [es:bx], 6	; FAT16 BIG CHS (> 32MB)
  7339                                  		jnz	short not_prim
  7340                                  ;%else
  7341                                  		; 16/12/2023
  7342                                  		mov	al, [es:bx]	 ; partition type
  7343                                  
  7344                                  		; see if partitiontype == 1, 4, 6, 0Bh, 0Ch, 0Eh
  7345                                  		cmp	al, 1		; FAT12
  7346                                  		je	short got_prim
  7347                                  		cmp	al, 4		; FAT16 CHS (<= 32MB)
  7348                                  		je	short got_prim
  7349                                  		
  7350                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  7351                                  		cmp	al, 0Bh		; FAT32 CHS
  7352                                  		je	short got_prim
  7353                                  		cmp	al, 0Ch		; FAT32 LBA
  7354                                  		je	short got_prim
  7355                                  		cmp	al, 0Eh		; FAT16 LBA
  7356                                  		je	short got_prim
  7357                                  
  7358                                  		cmp	al, 6		; FAT16 BIG CHS (> 32MB)
  7359                                  		jne	short not_prim
  7360                                  %endif
  7361                                  		; 16/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
  7362                                  		; check if it is a primary dos partition
  7363                                  
  7364 000021A2 E81500                  		call	chk_partition_type
  7365 000021A5 7506                    		jne	short not_prim
  7366                                  
  7367                                  got_prim:
  7368 000021A7 08F6                    		or	dh, dh		; is this our target partition?
  7369 000021A9 7431                    		jz	short set2
  7370 000021AB FECE                    		dec	dh
  7371                                  not_prim:
  7372 000021AD 83C310                  		add	bx, 16
  7373 000021B0 81FB0204                		cmp	bx, 402h	; 202h+bootbias
  7374 000021B4 75E5                    		jnz	short get_primary ; loop till we've gone through table
  7375                                  setret:					
  7376 000021B6 F9                      		stc			; error	return
  7377 000021B7 E9C503                  		jmp	ret_hard_err
  7378                                  
  7379                                  ; ---------------------------------------------------------------------------
  7380                                  		
  7381                                  		; 16/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
  7382                                  
  7383                                  chk_partition_type:
  7384                                  		; 16/12/2023
  7385 000021BA 268A07                  		mov	al, [es:bx]	 ; partition type
  7386                                  
  7387                                  		; see if partitiontype == 1, 4, 6, 0Bh, 0Ch, 0Eh
  7388 000021BD 3C01                    		cmp	al, 1		; FAT12
  7389 000021BF 7412                    		je	short chk_ptype_retn
  7390 000021C1 3C04                    		cmp	al, 4		; FAT16 CHS (<= 32MB)
  7391 000021C3 740E                    		je	short chk_ptype_retn
  7392                                  		
  7393                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  7394 000021C5 3C0B                    		cmp	al, 0Bh		; FAT32 CHS
  7395 000021C7 740A                    		je	short chk_ptype_retn
  7396 000021C9 3C0C                    		cmp	al, 0Ch		; FAT32 LBA
  7397 000021CB 7406                    		je	short chk_ptype_retn
  7398 000021CD 3C0E                    		cmp	al, 0Eh		; FAT16 LBA
  7399 000021CF 7402                    		je	short chk_ptype_retn
  7400                                  
  7401 000021D1 3C06                    		cmp	al, 6		; FAT16 BIG CHS (> 32MB)
  7402                                  chk_ptype_retn:
  7403                                  		; zf = 1 -> primary DOS partition
  7404                                  		; zf = 0 -> not a primary DOS partition
  7405 000021D3 C3                      		retn
  7406                                  
  7407                                  ; ---------------------------------------------------------------------------
  7408                                  
  7409                                  		; 16/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
  7410                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:25B6h)
  7411                                  ep_start_sector:
  7412 000021D4 00000000                		dd 0
  7413 000021D8 00000000                ep_hidden_secs:	dd 0
  7414                                  
  7415                                  ; ---------------------------------------------------------------------------
  7416                                  
  7417                                  ;  until we get the real logical boot record and get the bpb,
  7418                                  ;  BDS_BPB.BPB_BIGTOTALSECTORS will be used instead of BDS_BPB.BPB_TOTALSECTORS
  7419                                  ;  for the convenience of the computation.
  7420                                  ;
  7421                                  ;  at the end of this procedure, if a bpb information is gotten from
  7422                                  ;  the valid boot record, then we are going to use those bpb information
  7423                                  ;  without change.
  7424                                  ;
  7425                                  ;  otherwise, if (hidden sectors + total sectors) <= a word, then we will move
  7426                                  ;  BDS_BPB.BPB_BIGTOTALSECTORS (low) to BDS_BPB.BPB_TOTALSECTORS and zero out
  7427                                  ;  BDS_BPB.BPB_BIGTOTALSECTORS entry to make it a conventional bpb format.
  7428                                  
  7429                                  set2:		
  7430                                  		; 12/08/2023
  7431                                  		; ds = cs = BIOSDATA segment (0070h)
  7432 000021DC 8816[FF19]              		mov	[rom_drv_num], dl
  7433                                  		;mov	[cs:rom_drv_num], dl
  7434                                  			; save the rom bios drive number we are handling now.
  7435 000021E0 268B4704                		mov	ax, [es:bx+4]	; hidden sectors (start	sector)
  7436 000021E4 268B5706                		mov	dx, [es:bx+6]
  7437                                  
  7438                                  ; decrement the sector count by 1 to make it zero based. exactly 64k
  7439                                  ; sectors should be allowed	
  7440                                  
  7441 000021E8 83E801                  		sub	ax, 1
  7442 000021EB 83DA00                  		sbb	dx, 0
  7443 000021EE 26034708                		add	ax, [es:bx+8]	; sectors in partition
  7444 000021F2 2613570A                		adc	dx, [es:bx+10]
  7445 000021F6 7305                    		jnc	short okdrive
  7446 000021F8 800E[FC19]80            		or	byte [fbigfat], 80h ; ftoobig
  7447                                  
  7448                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  7449                                  		;;;
  7450                                  okdrive:
  7451                                  		;add	ax, [cs:ep_hidden_secs]
  7452                                  		;adc	dx, [cs:ep_hidden_secs+2]
  7453                                  		; ds = cs
  7454 000021FD 0306[D821]              		add	ax, [ep_hidden_secs]
  7455 00002201 1316[DA21]              		adc	dx, [ep_hidden_secs+2]
  7456 00002205 7305                    		jnc	short okdrive_1
  7457 00002207 800E[FC19]80            		or	byte [fbigfat], 80h ; ftoobig
  7458                                  okdrive_1:
  7459 0000220C 26803F0C                		cmp	byte [es:bx], 0Ch ; FAT32 LBA partition ID
  7460 00002210 7418                    		je	short set_lba_flag
  7461 00002212 26803F0E                		cmp	byte [es:bx], 0Eh ; FAT16 LBA partition ID
  7462 00002216 7412                    		je	short set_lba_flag
  7463 00002218 3B5513                  		cmp	dx, [di+13h]	; if dx > [di+BDS.secpertrack] then
  7464 0000221B 730D                    		jnb	short set_lba_flag ; set LBA r/w flag
  7465 0000221D F77513                  		div	word [di+13h]
  7466 00002220 31D2                    		xor	dx, dx
  7467 00002222 F77515                  		div	word [di+15h]
  7468 00002225 3D0004                  		cmp	ax, 400h	; if ax (cylinder number) >= 1024
  7469                                  					;  set LBA r/w flag
  7470 00002228 7204                     		jb	short set3
  7471                                  set_lba_flag:
  7472 0000222A 804D4004                                or	byte [di+40h], 4 ; fLBArw ; LBA r/w flag
  7473                                  		;;;
  7474                                  ;okdrive:
  7475                                  		; 16/12/2023
  7476                                  set3:		
  7477                                  		;mov	ax, [es:bx+4]
  7478                                  		;mov	[di+17h], ax	; [di+BDS.hiddensecs]
  7479                                  		;			; BPB_HIDDENSECTORS = p->partitionbegin
  7480                                  		;mov	ax, [es:bx+6]
  7481                                  		;mov	[di+19h], ax	; [di+BDS.hiddensecs+2]
  7482                                  
  7483                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  7484                                  		;;;
  7485 0000222E 268B4704                		mov	ax, [es:bx+4]	; start sector (LBA) of the partition
  7486 00002232 268B5706                		mov	dx, [es:bx+6]
  7487                                  		;add	ax, [cs:ep_hidden_secs]
  7488                                  		;adc	dx, [cs:ep_hidden_secs+2]
  7489                                  		; ds = cs
  7490 00002236 0306[D821]              		add	ax, [ep_hidden_secs]
  7491                                  					; + hidden secs of the extd dos partion
  7492 0000223A 1316[DA21]              		adc	dx, [ep_hidden_secs+2]
  7493 0000223E 894517                  		mov	[di+17h], ax	; [di+BDS.hiddensecs]
  7494 00002241 895519                  		mov	[di+19h], dx	; [di+BDS.hiddensecs+2]
  7495 00002244 31C0                    		xor	ax, ax ; 0
  7496 00002246 89457B                  		mov	[di+7Bh], ax	; [di+BDS.bdsm_hidden_trks]
  7497 00002249 89450E                  		mov	[di+0Eh], ax	; [di+BDS.totalsec16]	
  7498                                  		;;;
  7499                                  
  7500 0000224C 268B570A                		mov	dx, [es:bx+10]	; # of sectors (high)
  7501 00002250 268B4708                		mov	ax, [es:bx+8]	; # of sectors (low)
  7502 00002254 89551D                  		mov	[di+1Dh], dx	; [di+BDS.totalsecs32+2]
  7503 00002257 89451B                  		mov	[di+1Bh], ax	; [di+BDS.totalsecs32]
  7504                                  					; bpb->maxsec =	p->partitionlength
  7505                                  		;cmp	dx, 0
  7506                                  		;ja	short okdrive_1
  7507                                  		; 16/12/2023
  7508 0000225A 09D2                    		or	dx, dx
  7509 0000225C 7505                    		jnz	short set3_read
  7510 0000225E 83F840                  		cmp	ax, 64		; if (p->partitionlength < 64)
  7511                                  		;jb	short setret	; return -1;
  7512 00002261 7264                    		jb	short set3_err
  7513                                  ;okdrive_1:
  7514                                  		; 16/12/2023
  7515                                  set3_read:
  7516 00002263 8B5519                  		mov	dx, [di+19h]	; [di+BDS.hiddensecs+2]
  7517 00002266 8B4517                  		mov	ax, [di+17h]	; [di+BDS.hiddensecs]
  7518 00002269 31DB                    		xor	bx, bx		; boot sector number - for mini	disk
  7519                                  					; usually equal	to the # of sec/trk.
  7520 0000226B 8A5D13                  		mov	bl, [di+13h]	; [di+BDS.secpertrack]
  7521 0000226E 50                      		push	ax
  7522 0000226F 89D0                    		mov	ax, dx
  7523 00002271 31D2                    		xor	dx, dx
  7524 00002273 F7F3                    		div	bx		; (sectors)dx:ax / (BDS.secpertrack)bx =
  7525                                  					; (track)temp_h:ax + (sector)dx
  7526                                  ; 16/12/2023
  7527                                  %if 0
  7528                                  		; 17/10/2022
  7529                                  		;mov	[cs:temp_h], ax
  7530                                  		; 12/08/2023 (ds=cs)
  7531                                  		mov	[temp_h], ax
  7532                                  		pop	ax
  7533                                  		div	bx
  7534                                  		mov	cl, dl
  7535                                  		inc	cl
  7536                                  		xor	bx, bx
  7537                                  		mov	bl, [di+15h]	; [di+BDS.heads]
  7538                                  		push	ax
  7539                                  		xor	dx, dx
  7540                                  		;mov	ax, [cs:temp_h]
  7541                                  		mov	ax, [temp_h] ; 12/08/2023
  7542                                  		div	bx
  7543                                  		;mov	[cs:temp_h], ax
  7544                                  		mov	[temp_h], ax ; 12/08/2023
  7545                                  		pop	ax
  7546                                  		div	bx		; dl is head, ax is cylinder
  7547                                  		; 12/08/2023 (ds=cs)
  7548                                  		cmp	word [temp_h], 0
  7549                                  		;cmp	word [cs:temp_h], 0
  7550                                  		ja	short setret_brdg ; exceeds the	limit of int 13h
  7551                                  		cmp	ax, 1024
  7552                                  		ja	short setret_brdg ; exceeds the	limit of int 13h
  7553                                  			; Retro DOS v3.2 note by Erdogan Tan - 28/07/2019
  7554                                  			; **MSDOS code accepts if ax = 1024 but it is nonsense here
  7555                                  			; ('ja' must be 'jnb')
  7556                                  okdrive_2:
  7557                                   		; 28/07/2019
  7558                                  ; dl is head.
  7559                                  ; ax is cylinder
  7560                                  ; cl is sector number (assume less than 2**6 = 64 for int 13h)
  7561                                  
  7562                                  ;*** for mini disks ***
  7563                                  
  7564                                  		cmp	word [di+47h], 1 ; [di+BDS.bdsm_ismini]
  7565                                  					; check for mini disk
  7566                                  		jnz	short oknotmini	; not mini disk.
  7567                                  		add	ax, [di+49h]	; [di+BDS.bdsm_hidden_trks]
  7568                                  					; set the physical track number
  7569                                  oknotmini:
  7570                                  %endif
  7571                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  7572                                  		;;;
  7573                                  		;mov	[cs:saved_word], ax
  7574 00002275 A3[9E04]                		mov	[saved_word], ax
  7575 00002278 58                      		pop	ax
  7576 00002279 F7F3                    		div	bx
  7577 0000227B 88D1                    		mov	cl, dl
  7578 0000227D FEC1                    		inc	cl
  7579 0000227F 8B5D15                  		mov	bx, [di+15h]	; [di+BDS.heads]
  7580 00002282 50                      		push	ax
  7581 00002283 31D2                    		xor	dx, dx
  7582                                  		;mov	ax, [cs:saved_word]
  7583 00002285 A1[9E04]                		mov	ax, [saved_word]
  7584 00002288 F7F3                    		div	bx
  7585                                  		;mov	[cs:saved_word], ax
  7586 0000228A A3[9E04]                		mov	[saved_word], ax ; not necessary !? (ax must be 0)
  7587 0000228D 58                      		pop	ax
  7588 0000228E F7F3                    		div	bx		; dl is head, ax is cylinder
  7589                                  		; 16/12/2023
  7590 00002290 0E                      		push	cs
  7591 00002291 07                      		pop	es ; (*)
  7592 00002292 BB[5201]                		mov	bx, disksector ; (**)
  7593                                  		;
  7594 00002295 F6454004                		test	byte [di+40h], 4 ; fLBArw ; LBA read/write flag
  7595 00002299 742F                    		jz	short set3_chs_read
  7596                                  set3_lba_read:
  7597                                  
  7598                                  ; 16/12/2023
  7599                                  %if 0
  7600                                  		;push	cs
  7601                                  		;pop	es ; (*)
  7602                                  		;mov	bx, disksector ; (**)
  7603                                  
  7604                                  		;push	ds
  7605                                  		;push	si
  7606                                  		xor	ax, ax	; 0
  7607                                  		push	ax
  7608                                  		push	ax
  7609                                  		mov	ax, [di+19h]	; [di+BDS.hiddensectors+2]
  7610                                  		push	ax
  7611                                  		mov	ax, [di+17h]	; [di+BDS.hiddensectors]
  7612                                  		push	ax
  7613                                  		push	es		; buffer address
  7614                                  		push	bx
  7615                                  		mov	ax, 1		; sector (read) count
  7616                                  		push	ax
  7617                                  		;mov	ax, 16		; DAP size
  7618                                  		mov	al, 16
  7619                                  		push	ax
  7620                                  		mov	dl, [rom_drv_num] ; ds = cs
  7621                                  		mov	ax, ss
  7622                                  		mov	ds, ax ; ds = ss
  7623                                  		mov	si, sp
  7624                                  		;mov	dl, [cs:rom_drv_num]
  7625                                  		mov	ah, 42h
  7626                                  		int	13h		; DISK - IBM/MS Extension
  7627                                  					; EXTENDED READ (DL - drive, DS:SI - disk address packet)
  7628                                  		;pop	si
  7629                                  		;pop	ds
  7630                                  		jnc	short set3_lba_read_ok
  7631                                  		add	sp, 16
  7632                                  		;pop	si
  7633                                  		;pop	ds
  7634                                  set3_err:
  7635                                  		;jmp	setret
  7636                                  		jmp	ret_hard_err
  7637                                  
  7638                                  set3_lba_read_ok
  7639                                  		add	sp, 16
  7640                                  		;pop	si
  7641                                  		;pop	ds
  7642                                  		jmp	short set3_read_ok
  7643                                  %else
  7644                                  		; 16/12/2023
  7645                                  		;push	si ; * ; (not necessary)
  7646                                  		;mov	si, empty_dap_buff ; dap_buffer
  7647 0000229B BE[2D1B]                		mov	si, dap_buffer ; empty_dap_buff 
  7648 0000229E 56                      		push	si
  7649 0000229F 87F7                    		xchg	si, di
  7650                                  		; si = BDS
  7651                                  		; di = DAP buffer
  7652 000022A1 B81000                  		mov	ax, 16
  7653 000022A4 AB                      		stosw		; DAP size
  7654 000022A5 B001                    		mov	al, 1
  7655 000022A7 AB                      		stosw		; sector (read) count
  7656                                  		; buffer address
  7657 000022A8 89D8                    		mov	ax, bx	; offset disksector
  7658 000022AA AB                      		stosw
  7659 000022AB 8CC0                    		mov	ax, es	; es=ds=cs = BIOSDATA segment
  7660 000022AD AB                      		stosw
  7661                                  		; sector address (bits 0 to 31)	
  7662 000022AE 8B4417                  		mov	ax, [si+17h] ; [di+BDS.hiddensectors]
  7663 000022B1 AB                      		stosw
  7664 000022B2 8B4419                  		mov	ax, [si+19h] ; [di+BDS.hiddensectors+2]
  7665 000022B5 AB                      		stosw
  7666                                  		; sector address bits 32 to 63 (0)
  7667 000022B6 31C0                    		xor	ax, ax ; 0
  7668 000022B8 AB                      		stosw
  7669 000022B9 AB                      		stosw
  7670                                  		;xchg	di, si
  7671 000022BA 89F7                    		mov	di, si
  7672                                  		; di = BDS
  7673 000022BC 5E                      		pop	si ; DAP buffer address	
  7674                                  		
  7675 000022BD 8A16[FF19]              		mov	dl, [rom_drv_num] ; ds = cs
  7676 000022C1 B442                    		mov	ah, 42h
  7677 000022C3 CD13                    		int	13h		; DISK - IBM/MS Extension
  7678                                  					; EXTENDED READ (DL - drive, DS:SI - disk address packet)
  7679                                  		;pop	si ; *
  7680 000022C5 7324                    		jnc	short set3_read_ok
  7681                                  set3_err:
  7682                                  		;jmp	setret
  7683 000022C7 E9B502                  		jmp	ret_hard_err
  7684                                  %endif
  7685                                  
  7686                                  set3_chs_read:
  7687 000022CA 837D7901                		cmp	word [di+79h], 1 ; [di+BDS.bdsm_ismini] ; check for mini disk
  7688 000022CE 7503                    		jnz	short oknotmini
  7689 000022D0 03457B                  		add	ax, [di+7Bh]	; [di+BDS.bdsm_hidden_trks]
  7690                                  		;;;
  7691                                  
  7692                                  oknotmini:
  7693                                  ;*** end of added logic for mini disk
  7694                                  				
  7695 000022D3 D0CC                    		ror	ah, 1		; move high two bits of cyl to high
  7696 000022D5 D0CC                    		ror	ah, 1		; two bits of upper byte
  7697 000022D7 80E4C0                  		and	ah, 0C0h	; turn off remainder of bits
  7698 000022DA 08E1                    		or	cl, ah		; move two bits to correct spot
  7699 000022DC 88C5                    		mov	ch, al		; ch iscylinder (low 8 bits)
  7700                                  					; cl is sector + 2 high bits of cylinder
  7701 000022DE 88D6                    		mov	dh, dl		; dh is	head
  7702                                  		
  7703                                  		; 12/08/2023 (ds=cs)
  7704 000022E0 8A16[FF19]              		mov	dl, [rom_drv_num]
  7705                                  		;mov	dl, [cs:rom_drv_num] ; dl is drive number
  7706                                  
  7707                                  ; cl is sector + 2 high bits of cylinder
  7708                                  ; ch is low 8 bits of cylinder
  7709                                  ; dh is head
  7710                                  ; dl is drive
  7711                                  
  7712                                  ; for convenience, we are going to read the logical boot sector
  7713                                  ; into cs:disksector area.
  7714                                  
  7715                                  ; read in boot sector using bios disk interrupt. the buffer where it
  7716                                  ; is to be read in is cs:disksector.
  7717                                  
  7718                                  		; 16/12/2023
  7719                                  		; es=ds=cs = BIOSDATA segment
  7720                                  		; bx = disksector ; (**)
  7721                                  
  7722                                  		;push	cs
  7723                                  		;pop	es ; (*)
  7724                                  		
  7725                                  		;mov	bx, disksector	; for convenience,
  7726                                  					; we are going to read the logical boot sector
  7727                                  					; into cs:disksector area.
  7728 000022E4 B80102                  		mov	ax, 201h
  7729 000022E7 CD13                    		int	13h		; DISK - READ SECTORS INTO MEMORY
  7730                                  					; AL = number of sectors to read, CH = track, CL = sector
  7731                                  					; DH = head, DL	= drive, ES:BX -> buffer to fill
  7732                                  					; Return: CF set on error, AH =	status,	AL = number of sectors read
  7733                                  		; 16/12/2023
  7734 000022E9 72DC                    		jc	short set3_err
  7735                                  
  7736                                  ; cs:disksec contains the boot sector. in theory, (ha ha) the bpb in this thing
  7737                                  ; is correct. we can, therefore, suck out all the relevant statistics on the
  7738                                  ; media if we recognize the version number.
  7739                                  
  7740                                  set3_read_ok:
  7741                                  		; 11/08/2023
  7742                                  		;mov	bx, disksector	; BIOSDATA:014Eh ; MSDOS 6.21 ; 11/08/2023
  7743                                  					; BIOSDATA:0152h ; PCDOS 7.1 IBMBIO.COM
  7744                                  		; 18/12/2023
  7745                                  		;push	bx ; +
  7746                                  		;push	ax ; (not necessary)
  7747                                  
  7748                                  		; 16/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  7749                                  		;;;
  7750 000022EB 81BFFE0155AA            		cmp	word [bx+1FEh], 0AA55h
  7751 000022F1 7541                    		jne	short invalid_boot_record
  7752                                  		; 16/12/2023
  7753                                  		; 12/08/2023
  7754                                  		; ds = cs = BIOSDATA segment ('disksector:' is in BIOSDATA) 
  7755 000022F3 803FE9                  		cmp	byte [bx], 0E9h	; is it a near jump?
  7756 000022F6 740B                    		je	short check_1_ok ; yes
  7757 000022F8 803FEB                  		cmp	byte [bx], 0EBh	; is it a short jump?
  7758 000022FB 7537                    		jne	short invalid_boot_record ; no
  7759 000022FD 807F0290                		cmp	byte [bx+2], 90h ; yes, is the next one a nop?
  7760 00002301 7531                    		jne	short invalid_boot_record ; no, invalid bs ; 11/08/2023
  7761                                  check_1_ok:
  7762 00002303 837F1600                		cmp     word [bx+16h], 0 ; [bx+BPB_FATSz16]
  7763                                  		;jz	short check_1	; 16 bit FAT size is 0 if it is FAT32 bs
  7764                                  		; 16/12/2023
  7765 00002307 740E                    		jz	short check_2	; FAT32 bs
  7766                                  
  7767                                  		; FAT16 or FAT12 bs
  7768                                  
  7769                                  		;push	ds
  7770                                  		;push	si  ; (not necessary)
  7771 00002309 57                      		push	di
  7772                                  		; es=ds=cs = BIOSDATA segment
  7773                                  		;push	es
  7774                                  		;pop	ds
  7775                                  
  7776                                  		;mov	cx, 28
  7777 0000230A B90E00                  		mov	cx, 14 ; *
  7778 0000230D 8D7724                  		lea	si, [bx+24h]	; move offset 36 to 63
  7779                                  					;      to offset 64 (28 bytes)
  7780 00002310 8D7F40                  		lea	di, [bx+40h]	; boot sector offset 64
  7781 00002313 FC                      		cld	; (not necessary, 'std' is not used before here)
  7782                                  		;rep movsb
  7783 00002314 F3A5                    		rep movsw ; *
  7784 00002316 5F                      		pop	di
  7785                                  		;pop	si
  7786                                  		;pop	ds
  7787                                  		;;;
  7788                                  ; 16/12/2023
  7789                                  %if 0
  7790                                  ;check_1:
  7791                                  		; 12/08/2023
  7792                                  		; ds = cs = BIOSDATA segment ('disksector:' is in BIOSDATA) 
  7793                                  		cmp	byte [bx], 0E9h
  7794                                  		;cmp	byte [cs:bx], 0E9h ; is it a near jump?
  7795                                  		je	short check_1_ok ; yes
  7796                                  		cmp	byte [bx], 0EBh
  7797                                  		;cmp	byte [cs:bx], 0EBh ; is it a short jump?
  7798                                  		jne	short invalid_boot_record ; no
  7799                                  		cmp	byte [bx+2], 90h
  7800                                  		;cmp	byte [cs:bx+2], 90h ; yes, is the next one a nop?
  7801                                  		jne	short invalid_boot_record ; no, invalid bs ; 11/08/2023
  7802                                  check_1_ok:
  7803                                  %endif
  7804                                  
  7805                                  ; 18/12/2023
  7806                                  %if 0
  7807                                  		; 14/08/2023
  7808                                  check_2:
  7809                                  		mov	bx, disksector+11 ; disksector+EXT_BOOT.BPB
  7810                                  		;mov	bx, 159h	; disksector+EXT_BOOT.BPB
  7811                                  					; point to the bpb in the boot record
  7812                                  		;mov	al, [cs:bx+10]	; [bx+EBPB.MEDIADESCRIPTOR]
  7813                                  		mov	al, [bx+10] ; 12/08/2023 
  7814                                  					; get the mediadescriptor byte
  7815                                  		and	al, 0F0h	; mask off low nibble
  7816                                  		cmp	al, 0F0h	; is high nibble = 0Fh?
  7817                                  		jne	short invalid_boot_record ; no, invalid boot record
  7818                                  		;cmp	word [cs:bx], 512 ; [bx+EBPB.BYTESPERSECTOR]
  7819                                  		cmp	word [bx], 512 ; 12/08/2023
  7820                                  		jne	short invalid_boot_record ; invalidate non 512 byte sectors
  7821                                  
  7822                                  check2_ok:				; yes, mediadescriptor ok.
  7823                                  		mov	al, [bx+2] ; 12/08/2023
  7824                                  		;mov	al, [cs:bx+2]	; now make sure that
  7825                                  					; the sectorspercluster is
  7826                                  					; a power of 2
  7827                                  					;
  7828                                  					; [bx+EBPB.SECTORSPERCLUSTER]
  7829                                  					; get the sectorspercluster
  7830                                  %endif
  7831                                  		;;;
  7832                                  check_2:
  7833                                  		; 18/12/2023
  7834                                  		; bx = disksector
  7835 00002317 8A4715                  		mov	al, [bx+21]	; [bx+EXT_BOOT.BPB+EBPB.MEDIADESCRIPTOR]
  7836                                  					; get the mediadescriptor byte
  7837 0000231A 24F0                    		and	al, 0F0h	; mask off low nibble
  7838 0000231C 3CF0                    		cmp	al, 0F0h	; is high nibble = 0Fh?
  7839 0000231E 7514                    		jne	short invalid_boot_record ; no, invalid boot record
  7840 00002320 817F0B0002              		cmp	word [bx+11], 512 ; [bx+EXT_BOOT.BPB+EBPB.BYTESPERSECTOR]
  7841 00002325 750D                    		jne	short invalid_boot_record ; invalidate non 512 byte sectors
  7842                                  
  7843                                  check2_ok:	; yes, mediadescriptor ok.
  7844 00002327 8A470D                  		mov	al, [bx+13]	; now make sure that
  7845                                  					; the sectorspercluster is
  7846                                  					; a power of 2
  7847                                  					;
  7848                                  					; [bx++EXT_BOOT.BPB+EBPB.SECTORSPERCLUSTER]
  7849                                  					; get the sectorspercluster
  7850                                  		;;;
  7851                                  
  7852 0000232A 08C0                    		or	al, al		; is it zero?
  7853 0000232C 7406                    		jz	short invalid_boot_record ; yes, invalid boot record
  7854                                  
  7855                                  ck_power_of_two:
  7856 0000232E D0E8                    		shr	al, 1		; shift until first bit emerges
  7857 00002330 73FC                    		jnc	short ck_power_of_two
  7858 00002332 7406                    		jz	short valid_boot_record
  7859                                  
  7860                                  invalid_boot_record:
  7861                                  		; 18/12/2023
  7862                                  		;pop	ax
  7863                                  		;pop	bx ; +
  7864 00002334 E95E01                  		jmp	unknown		; jump to invalid boot record
  7865                                  					; unformatted or illegal media.
  7866                                  ; 16/12/2023
  7867                                  ; ---------------------------------------------------------------------------
  7868                                  ;	; 12/08/2023
  7869                                  ;setret_brdg:
  7870                                  ;		jmp	setret
  7871                                  ; ---------------------------------------------------------------------------
  7872                                  
  7873                                  unknown3_0_j:
  7874 00002337 E95F01                  		jmp	unknown3_0	; legally formatted media,
  7875                                  					; although, content might be bad.
  7876                                  ; ---------------------------------------------------------------------------
  7877                                  
  7878                                  valid_boot_record:
  7879                                  		; 18/12/2023
  7880                                  		;pop	ax
  7881                                  		;pop	bx ; +
  7882                                  		
  7883                                  		; 18/12/2023
  7884                                  		; bx = offset disksector ; +
  7885                                  
  7886                                  ; Signature found. Now check version.
  7887                                  
  7888                                  		; 14/08/2023
  7889 0000233A 817F08322E              		cmp	word [bx+8], '2.'
  7890                                  		;cmp	word [cs:bx+8], '2.' ; 03/10/2022 (NASM syntax)
  7891                                  		;;cmp	word ptr cs:[bx+8], 2E32h ; '2.'
  7892 0000233F 7506                    		jne	short try5
  7893 00002341 807F0A30                		cmp	byte [bx+10], '0'
  7894                                  		;cmp	byte [cs:bx+0Ah], '0' ; 03/10/2022 (NASM syntax)
  7895                                  		;;cmp	byte ptr cs:[bx+0Ah], 30h ; '0'
  7896                                  		; 12/08/2023
  7897                                  		;jnz	short try5
  7898                                  		;jmp	short copybpb
  7899 00002345 7425                    		je	short copybpb
  7900                                  
  7901                                  ;; --------------------------------------------------------------------------
  7902                                  ;;	; 12/08/2023
  7903                                  ;;setret_brdg:
  7904                                  ;;		jmp	setret
  7905                                  ;; --------------------------------------------------------------------------
  7906                                  ;
  7907                                  ;unknown3_0_j:
  7908                                  ;		jmp	unknown3_0	; legally formatted media,
  7909                                  ;					; although, content might be bad.
  7910                                  ; ---------------------------------------------------------------------------
  7911                                  
  7912                                  try5:
  7913 00002347 E83902                  		call	cover_fdisk_bug
  7914                                  
  7915                                  ; see if it is an os2 signature
  7916                                  
  7917                                  		; 12/08/2023
  7918                                  		; ds = cs = BIOSDATA segment
  7919 0000234A 817F08302E              		cmp	word [bx+8], '0.'
  7920                                  		;cmp	word [cs:bx+8], '0.' ; 03/10/2022 (NASM syntax)
  7921                                  		;;cmp	word ptr cs:[bx+8], 2E30h ; '0.'
  7922 0000234F 750C                    		jne	short no_os2
  7923 00002351 8A4707                  		mov	al, [bx+7] ; 12/08/2023
  7924                                  		;mov	al, [cs:bx+7]	; 17/10/2022 (NASM syntax)
  7925 00002354 2C31                    		sub	al, '1'
  7926                                  		;sub	al, 31h		; '1'
  7927 00002356 24FE                    		and	al, 0FEh
  7928 00002358 7412                    		jz	short copybpb	; accept either	'1' or '2'
  7929 0000235A E93801                  		jmp	unknown
  7930                                  ; ---------------------------------------------------------------------------
  7931                                  
  7932                                  ; no os2 signature, this is to check for real dos versions
  7933                                  
  7934                                  no_os2:
  7935                                  		; 12/08/2023
  7936                                  		; ds = cs = BIOSDATA
  7937 0000235D 817F08332E              		cmp	word [bx+8], '3.'			
  7938                                  		;cmp	word [cs:bx+8], '3.' ; 03/10/2022 (NASM syntax)
  7939                                  		;;cmp	word ptr cs:[bx+8], 2E33h ; '3.'
  7940 00002362 72D3                    		jb	short unknown3_0_j ; must be 2.1 boot record.
  7941                                  					; do not trust it, but still legal.
  7942 00002364 7506                    		jnz	short copybpb	; honor	os2 boot record
  7943                                  					; or dos 4.0 version
  7944 00002366 807F0A31                		cmp	byte [bx+10], '1' ; 12/08/2023
  7945                                  		;cmp	byte [cs:bx+10], '1'
  7946                                  		;;cmp	byte ptr cs:[bx+0Ah], 31h ; '1'
  7947 0000236A 72CB                    		jb	short unknown3_0_j ; if version >= 3.1, then o.k.
  7948                                  copybpb:
  7949                                  
  7950                                  ; 03/10/2022
  7951                                  
  7952                                  ; we have a valid boot sector. use the bpb in it to build the
  7953                                  ; bpb in bios. it is assumed that only
  7954                                  ;	BDS_BPB.BPB_SECTORSPERCLUSTER
  7955                                  ;	BDS_BPB.BPB_ROOTENTRIES, and
  7956                                  ;	BDS_BPB.BPB_SECTORSPERFAT
  7957                                  ; need to be set (all other values in already). fbigfat is also set.
  7958                                  
  7959                                  ; if it is non fat based system, then just copy the bpb from the boot sector
  7960                                  ; into the bpb in bds table, and also set the boot serial number, volume id,
  7961                                  ; and system id according to the boot record.
  7962                                  ; for the non_fat system, don't need to set the other value. so just do goodret.
  7963                                  
  7964                                  		; 17/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
  7965                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2787h)
  7966                                  		;;;
  7967                                  		; 17/12/2023
  7968 0000236C BE[5D01]                		mov	si, disksector+11
  7969                                  		;sub	ch, ch ; ; (ch may be > 0)
  7970 0000236F 29C9                    		sub	cx, cx ; 0 
  7971                                  		;mov	cl, [disksector+16] ; BPB_NumFATs
  7972 00002371 8A4C05                  		mov	cl, [si+5] ; number of FATs
  7973                                  
  7974                                  		; NOTE: This check is not proper for FAT32 boot sector (standard spec)
  7975                                  		; (after PCDOS 7.1). So, it is not existing in Windows ME IO.SYS
  7976                                  		; Erdogan Tan - 01/09/2023 ((IBMBIO.COM 7.1 disassembly note))
  7977                                  
  7978                                  		;;cmp	word ptr cs:disksector+4Dh, 0 ; ???
  7979                                  		;cmp	word [disksector+4Dh], 0
  7980                                  		;jnz	short check_3
  7981                                  
  7982                                  		; 17/12/2023
  7983                                  		; check extended boot signature (0x29)
  7984                                  		;
  7985                                  		; (***) NOTE: 28 bytes of FAT16/FAT12 boot sector from offset 36
  7986                                  		; have been moved to offset 64 (see label 'check_1_ok:' above) 
  7987                                  		; ((now, BS_BootSig is at offset 66 even if it was at offset 38))
  7988                                  		
  7989                                  		;cmp	cs:disksector+42h, 29h	; BS_BootSig (FAT32)
  7990 00002374 803E[9401]29            		cmp	byte [disksector+42h], 29h ; BS_BootSig (***)
  7991                                  		;jmp	short check_4
  7992                                  check_3:
  7993                                  		;;cmp	cs:disksector+26h, 29h	; BS_BootSig (FAT16/FAT12)
  7994                                  		;cmp	byte [disksector+26h], 29h ; (***)
  7995                                  check_4:
  7996 00002379 7538                    		jnz	short copybpb_fat	; conventional fat system
  7997                                  
  7998                                  ; 17/12/2023
  7999                                  %if 0
  8000                                  		; 10/12/2022
  8001                                  		; (number of FATs optimization)
  8002                                  		mov	si, disksector+11 ; disksector+0Bh
  8003                                  		;;mov	cl, [cs:disksector+10h] ; Number of FATs (may be 2 or 1)
  8004                                  		;mov	cl, [cs:si+05h]
  8005                                  		; 12/08/2023
  8006                                  		; ds = cs = BIOSDATA segment (0070h)
  8007                                  		mov	cl, [si+05h] ; number of FATs
  8008                                  
  8009                                  		cmp	byte [si+1Bh], 29h ; 12/08/2023
  8010                                  		;cmp	byte [cs:si+1Bh], 29h ; 10/12/2022	
  8011                                  		;;cmp	byte [cs:disksector+26h], 29h ; 17/10/2022
  8012                                  					; [disksector+EXT_BOOT.SIG]
  8013                                  					; EXT_BOOT_SIGNATURE
  8014                                  		jnz	short copybpb_fat ; conventional fat system
  8015                                  
  8016                                  		; 03/10/2022
  8017                                  		; 29/12/2018 - Retro DOS v4.0 modification note:
  8018                                  		; Regarding 'fat_big_small' part of this (MSDOS 6.0) code
  8019                                  		;	     number of FATs must be 2 ; =*?=
  8020                                  		; (Otherwise, '# of data sectors' would be calculated as wrong!!!)
  8021                                  		;
  8022                                  		;cmp	byte [disksector+EXT_BOOT.BPB+EBPB.NUMBEROFFATS], 2 ; =*?=
  8023                                  
  8024                                  		; 10/12/2022
  8025                                  		;cmp	byte [cs:disksector+10h], 0
  8026                                  					; [disksector+EXT_BOOT.BPB+EBPB.NUMBEROFFATS]
  8027                                  		;jnz	short copybpb_fat ; a fat system.
  8028                                  		or	cl, cl	 ; [cs:disksector+10h]
  8029                                  		jnz	short copybpb_fat ; a fat system.
  8030                                  %endif
  8031                                  
  8032                                  		; 17/12/2023 - Retro DOS v5.0
  8033                                  		;;cmp	byte [cs:disksector+10h], 0 ; BPB.fats
  8034                                  		;cmp	byte [disksector+10h], 0 ; BPB_NUmFATs
  8035                                  		;jnz	short copybpb_fat ; a fat system
  8036                                  		; 17/12/2023
  8037                                  		; cl = [disksector+10h]
  8038 0000237B 20C9                    		and	cl, cl ; 0 ?
  8039 0000237D 7534                    		jnz	short copybpb_fat ; a fat system
  8040                                  
  8041                                  ; non fat based	media.
  8042                                  
  8043 0000237F 57                      		push	di  ; BDS
  8044                                  		; 12/08/2023
  8045                                  		;push	ds  ; ds = cs = BIOSDATA segment
  8046                                  		
  8047                                  		; 17/12/2023
  8048                                  		; es = ds = cs
  8049                                  		;push	ds
  8050                                  		;pop	es
  8051                                  
  8052                                  		; 12/08/2023
  8053                                  		; ds = cs
  8054                                  		;push	cs
  8055                                  		;pop	ds
  8056                                  
  8057                                  		; 10/12/2022
  8058                                  		; (number of FATs optimization)
  8059                                  		; SI = disksector+11
  8060                                  		; 17/10/2022
  8061                                  		;;mov	si, 159h	; disksector+EXT_BOOT.BPB
  8062                                  		;mov	si, disksector+11
  8063 00002380 83C706                  		add	di, 6		; add di,BDS.BPB
  8064                                  
  8065                                  ; just for completeness, we'll make sure that total_sectors and
  8066                                  ; big_total_sectors aren't both zero. I've seen examples of
  8067                                  ; this on DOS 3.30 boot records. I don't know exactly how it
  8068                                  ; got that way. If it occurs, then use the values from the
  8069                                  ; partition table.
  8070                                  
  8071                                  		; 17/12/2023
  8072                                  		; cx = 0
  8073                                  		; 18/12/2022
  8074                                  		;sub	cx, cx
  8075                                  
  8076                                  		;cmp	word [cs:si+8], 0 	; [cs:si+EBPB.TOTALSECTORS]
  8077                                  		;jnz	short already_nonz 
  8078                                  		;			; how about big_total?
  8079                                  		;cmp	word [cs:si+15h], 0	; [cs:si+EBPB.BIGTOTALSECTORS]
  8080                                  		;jnz	short already_nonz ; we're okay if any are != 0
  8081                                  		;cmp	word [cs:si+17h], 0	; [cs:si+EBPB.BIGTOTALSECTORS+2]
  8082                                  		;jnz	short already_nonz
  8083                                  
  8084                                  		; 12/08/2023
  8085                                  		; ds = cs = BIOSDATA segment (0070h)
  8086                                  
  8087                                  		; 17/12/2023
  8088                                  		; 12/08/2023
  8089 00002383 394C08                  		cmp	[si+8], cx ; 0		; [si+EBPB.TOTALSECTORS]
  8090 00002386 751C                    		jnz	short already_nonz
  8091                                  				    	; how about big_total?
  8092 00002388 394C15                  		cmp	[si+15h], cx ; 0	; [si+EBPB.BIGTOTALSECTORS]
  8093 0000238B 7517                    		jnz	short already_nonz ; we're okay if any are != 0
  8094 0000238D 394C17                  		cmp	[si+17h], cx ; 0	; [si+EBPB.BIGTOTALSECTORS+2]
  8095 00002390 7512                    		jnz	short already_nonz
  8096                                  
  8097                                  ; now let's copy the values from the partition table (now in the BDS)
  8098                                  ; into the BPB in the boot sector buffer, before they get copied back.
  8099                                  
  8100 00002392 8B4508                  		mov	ax, [di+8]	; [di+BDS.totalsecs16]
  8101                                  		; 12/08/2023
  8102                                  		;mov	[cs:si+8], ax	; [cs:si+EBPB.TOTALSECTORS]
  8103 00002395 894408                  		mov	[si+8], ax
  8104 00002398 8B4515                  		mov	ax, [di+15h]	; [di+BDS.totalsecs32]
  8105                                  		;mov	[cs:si+15h], ax	; [cs:si+EBPB.BIGTOTALSECTORS]
  8106 0000239B 894415                  		mov	[si+15h], ax
  8107 0000239E 8B4517                  		mov	ax, [di+17h]	; [di+BDS.totalsecs32+2]
  8108                                  		;mov	[cs:si+17h], ax	; [cs:si+EBPB.BIGTOTALSECTORS+2]
  8109 000023A1 894417                  		mov	[si+17h], ax
  8110                                  
  8111                                  already_nonz:
  8112                                  		; 18/12/2022
  8113                                  		; cx = 0
  8114                                  		;mov	cl, 25
  8115                                  		;;mov	cx, 25		; A_BPB.size - 6 ; Use SMALL version!
  8116                                  		; 17/12/2023 - Retro DOS v5.0
  8117 000023A4 B135                    		mov	cl, 53	; PCDOS 7.1 IBMBIO.COM
  8118                                  				; BDS.BPB size (25 + 28 for FAT32 parms)
  8119 000023A6 F3A4                    		rep movsb
  8120                                  		;pop	ds
  8121                                  		; 12/08/2023
  8122                                  		; ds = cs
  8123                                  		;pop	bp  ; ds (on top of stack) = BIOSDATA
  8124 000023A8 5F                      		pop	di  ; BDS
  8125                                  		;push	es
  8126                                  		;push	ds
  8127                                  		;pop	es
  8128                                  		;push	cs
  8129                                  		;pop	ds
  8130                                  		; 12/08/2023
  8131                                  		;mov	es, bp
  8132                                  		; ds = cs = es
  8133                                  		
  8134                                  		; 14/08/2023
  8135 000023A9 BD[4F08]                		mov	bp, MOVMEDIAIDS ; mov_media_ids
  8136                                  		; 18/12/2022
  8137                                  		;mov	bp, mov_media_ids
  8138                                  		;;mov	bp, 751h	; mov_media_ids
  8139                                  					; at 2C7h:751h = 70h:2CC1h
  8140                                  					; set volume id, systemid, serial.
  8141 000023AC 0E                      		push	cs		; simulate far call
  8142 000023AD E8B3F6                  		call	call_bios_code
  8143                                  		; 12/08/2023
  8144                                  		; ds = cs = es
  8145                                  		;push	es
  8146                                  		;pop	ds
  8147                                  		;pop	es
  8148 000023B0 E9C501                  		jmp	goodret
  8149                                  
  8150                                  ; ---------------------------------------------------------------------------
  8151                                  
  8152                                  ; ****** cas ---
  8153                                  ; IBM DOS 3.30 doesn't seem to mind that the TOTAL_SECTORS and
  8154                                  ; BIG_TOTAL_SECTORS field in the boot sector are 0000. This
  8155                                  ; happens with some frequency -- perhaps through some OS/2 setup
  8156                                  ; program. We haven't actually been COPYING the TOTAL_SECTORS
  8157                                  ; from the boot sector into the DPB anyway, we've just been using
  8158                                  ; it for calculating the fat size. Pretty scary, huh? For now,
  8159                                  ; we'll go ahead and copy it into the DPB, except in the case
  8160                                  ; that it equals zero, in which case we just use the values in
  8161                                  ; the DPB from the partition table.
  8162                                  
  8163                                  ; 17/10/2022
  8164                                  ;MOVMEDIAIDS equ mov_media_ids - DOSBIOSEG_2C7h ; (751h for MSDOS 5.0 IO.SYS)
  8165                                  ;CLEARIDS equ clear_ids - DOSBIOSEG_2C7h ; (5D9h for MSDOS 5.0 IO.SYS)		    		
  8166                                  ; 09/12/2022
  8167                                  MOVMEDIAIDS equ mov_media_ids
  8168                                  CLEARIDS equ clear_ids
  8169                                  ; 11/09/2023
  8170                                  CLEARIDS_X equ clear_ids_x
  8171                                  
  8172                                  copybpb_fat:
  8173                                  		; 17/12/2023
  8174                                  		; ch = 0, cl = number of FATs
  8175                                  		; 10/12/2022
  8176                                  		; (number of FATs optimization)
  8177                                  		; SI = disksector+11
  8178                                  		; 17/10/2022
  8179                                  		;mov	si, disksector+11
  8180                                  		;;mov	si, 159h	; disksector+EXT_BOOT.BPB
  8181                                  					; cs:si	-> bpb in boot
  8182                                  		; 17/12/2023
  8183                                  		; dx = 0
  8184                                  		;xor	dx, dx
  8185                                  
  8186                                  		; 12/08/2023
  8187                                  		; ds = cs = BIOSDATA segment (0070h)
  8188 000023B3 8B4408                  		mov	ax, [si+8]
  8189                                  		;mov	ax, [cs:si+8]	; [cs:si+EBPB.TOTALSECTORS]
  8190                                  					; get totsec from boot sec
  8191 000023B6 09C0                    		or	ax, ax
  8192 000023B8 7514                    		jnz	short copy_totsec ; if non zero, use that
  8193 000023BA 8B4415                  		mov	ax, [si+15h] ; 12/08/2023
  8194                                  		;mov	ax, [cs:si+15h]	; [cs:si+EBPB.BIGTOTALSECTORS]
  8195                                  					; get the big version
  8196                                  					; (32 bit total	sectors)
  8197 000023BD 8B5417                  		mov	dx, [si+17h] ; 12/08/2023
  8198                                  		;mov	dx, [cs:si+17h]	; [cs:si+EBPB.BIGTOTALSECTORS+2]
  8199                                  		; 10/12/2022
  8200                                  		; (number of FATs optimization)
  8201                                  		; CL = number of FATs (2 or 1) 
  8202 000023C0 89D3                    		mov	bx, dx		; see if it is a big zero
  8203 000023C2 09C3                    		or	bx, ax
  8204 000023C4 7508                    		jnz	short copy_totsec
  8205                                  			; screw it. it was bogus.
  8206 000023C6 8B451B                  		mov	ax, [di+1Bh]	; [di+BDS.totalsecs32]
  8207 000023C9 8B551D                  		mov	dx, [di+1Dh]	; [di+BDS.totalsecs32+2]
  8208 000023CC EB06                    		jmp	short fat_big_small
  8209                                  
  8210                                  		;mov	cx, dx
  8211                                  		;or	cx, ax		; see if it is a big zero
  8212                                  		;jz	short totsec_already_set ; screw it. it	was bogus.
  8213                                  copy_totsec:				
  8214 000023CE 89451B                  		mov	[di+1Bh], ax	; [di+BDS.totalsecs32]
  8215                                  					; make DPB match boot sec
  8216 000023D1 89551D                  		mov	[di+1Dh], dx	; [di+BDS.totalsecs32+2]
  8217                                  
  8218                                  		; 10/12/2022
  8219                                  ;totsec_already_set:			
  8220                                  		;mov	ax, [di+1Bh]	; [di+BDS.totalsecs32]
  8221                                  		;mov	dx, [di+1Dh]	; [di+BDS.totalsecs32+2]
  8222                                  
  8223                                  ; determine fat entry size.
  8224                                  
  8225                                  fat_big_small:
  8226                                  
  8227                                  ;at this moment dx;ax = total sector number
  8228                                  
  8229                                  ;Do not assume 1 reserved sector. Update the reserved sector field in BDS 
  8230                                  ;from the BPB on the disk
  8231                                  		
  8232                                  		; 12/08/2023
  8233                                  		; ds = cs = BIOSDATA segment (0070h)
  8234                                  				
  8235 000023D4 8B5C03                  		mov	bx, [si+3]
  8236                                  		;mov	bx, [cs:si+3]	; [cs:si+EBPB.RESERVEDSECTORS]
  8237                                  					; get #reserved_sectors	from BPB
  8238 000023D7 895D09                  		mov	[di+9],	bx	; [di+BDS.resectors]
  8239                                  					; update BDS field
  8240 000023DA 29D8                    		sub	ax, bx
  8241 000023DC 83DA00                  		sbb	dx, 0		; update the count
  8242                                  		; 12/08/2023
  8243 000023DF 8B5C0B                  		mov	bx, [si+0Bh]
  8244                                  		;mov	bx, [cs:si+0Bh]	; [cs:si+EBPB.SECTORSPERFAT]
  8245                                  					; bx = sectors/fat
  8246 000023E2 895D11                  		mov	[di+11h], bx	; [di+BDS.fatsecs]
  8247                                  					; set in bds bpb
  8248                                  		; 17/12/2023 - Retro DOS v5.0
  8249                                  		;	      (PCDOS 7.1 IBMBIO.COM)
  8250 000023E5 53                      		push	bx ; FAT sectors
  8251 000023E6 09DB                    		or	bx, bx
  8252 000023E8 753A                    		jnz	short fat_16bit	
  8253                                  
  8254                                  ; 17/12/2023
  8255                                  %if 0		
  8256                                  		sub	ax, [si+19h]	; FAT32 file system (PCDOS 7.1 BUG!)
  8257                                  					; BPB.FATSz32
  8258                                  		sbb	dx, [si+1Bh]	; BPB.FATSz32+2 (PCDOS 7.1 BUG!)
  8259                                  		; dx:ax = partition size - (one FAT sectors + reserved sects)  
  8260                                  		mov	bx, [si+19h]	; BPB.FATSz32
  8261                                  		mov	[di+1Fh], bx	; [di+BDS.fatsecs32]
  8262                                  		mov	bx, [si+1Bh]	; BPB.FATSz32+2
  8263                                  		mov	[di+21h], bx	; [di+BDS.fatsecs32+2]
  8264                                  		mov	bx, [si+1Dh]	; BPB.BPB_ExtFlags
  8265                                  		mov	[di+23h], bx	; [di+BDS.extflags]
  8266                                  		mov	bx, [si+1Fh]	; BPB.FSVer
  8267                                  		mov	[di+25h], bx	; [di+BDS.fsver]
  8268                                  		mov	bx, [si+21h]	; BPB.RootClus
  8269                                  		mov	[di+27h], bx	; [di+BDS.rootdirclust]
  8270                                  		mov	bx, [si+23h]	; BPB.RootClus+2
  8271                                  		mov	[di+29h], bx	; [di+BDS.rootdirclust+2]
  8272                                  		mov	bx, [si+25h]	; BPB.FSInfo
  8273                                  		mov	[di+2Bh], bx	; [di+BDS.fsinfo]
  8274                                  		mov	bx, [si+27h]	; BPB.FSInfo+2
  8275                                  		mov	[di+2Dh], bx	; [di+BDS.fsinfo+2]
  8276                                  		jmp	short fat_32bit	; PCDOS 7.1 BUG! Erdogan Tan - 8/8/2023
  8277                                  					; correct code (would be):
  8278                                  					;   mov cl, [cs:si+05h] ; BPB_NumFATs
  8279                                  					; sub_fat32_size:
  8280                                  					;   sub ax, [cs:si+19h] ; BPB_FATSz32
  8281                                  					;   sbb dx, [cs:si+1Bh] ; BPB_FATSz32+2
  8282                                  					;   dec cl
  8283                                  					;   jg short sub_fat32_size
  8284                                  					;   jmp short fat_32bit
  8285                                  %endif
  8286                                  		; 17/12/2023
  8287                                  		; cl = BPB_NumFATs (2 or 1)
  8288                                  		; ch = 0
  8289 000023EA 8B5C19                  		mov	bx, [si+19h]	; BPB.FATSz32
  8290                                  sub_fat32_size:
  8291 000023ED 29D8                    		sub	ax, bx
  8292 000023EF 1B541B                  		sbb	dx, [si+1Bh]	; BPB.FATSz32+2
  8293                                  		;dec	cl
  8294 000023F2 49                      		dec	cx
  8295 000023F3 7FF8                    		jg	short sub_fat32_size
  8296                                  
  8297 000023F5 895D1F                  		mov	[di+1Fh], bx	; [di+BDS.fatsecs32]
  8298 000023F8 8B5C1B                  		mov	bx, [si+1Bh]	; BPB.FATSz32+2
  8299 000023FB 895D21                  		mov	[di+21h], bx	; [di+BDS.fatsecs32+2]
  8300                                  
  8301 000023FE 8B5C1D                  		mov	bx, [si+1Dh]	; BPB.BPB_ExtFlags
  8302 00002401 895D23                  		mov	[di+23h], bx	; [di+BDS.extflags]
  8303 00002404 8B5C1F                  		mov	bx, [si+1Fh]	; BPB.FSVer
  8304 00002407 895D25                  		mov	[di+25h], bx	; [di+BDS.fsver]
  8305 0000240A 8B5C21                  		mov	bx, [si+21h]	; BPB.RootClus
  8306 0000240D 895D27                  		mov	[di+27h], bx	; [di+BDS.rootdirclust]
  8307 00002410 8B5C23                  		mov	bx, [si+23h]	; BPB.RootClus+2
  8308 00002413 895D29                  		mov	[di+29h], bx	; [di+BDS.rootdirclust+2]
  8309 00002416 8B5C25                  		mov	bx, [si+25h]	; BPB.FSInfo
  8310 00002419 895D2B                  		mov	[di+2Bh], bx	; [di+BDS.fsinfo]
  8311 0000241C 8B5C27                  		mov	bx, [si+27h]	; BPB.FSInfo+2
  8312 0000241F 895D2D                  		mov	[di+2Dh], bx	; [di+BDS.fsinfo+2]
  8313 00002422 EB08                    		jmp	short fat_32bit
  8314                                  		
  8315                                  fat_16bit:
  8316                                  		; 17/12/2023 - Retro DOS v5.0
  8317                                  		;	      (PCDOS 7.1 IBMBIO.COM)
  8318                                  		; 10/12/2022
  8319                                  		; (number of FATs optimization)
  8320                                  		; CL = number of FATs (2 or 1)
  8321                                  		; CH = 0 ; 17/12/2023 
  8322                                  		;dec	cl ; *
  8323                                  		; 18/12/2022
  8324 00002424 49                      		dec	cx ; *
  8325 00002425 D3E3                    		shl	bx, cl
  8326                                  		;shl	bx, 1	; =*?=	; always 2 fats
  8327                                  		
  8328 00002427 29D8                    		sub	ax, bx		; sub #	fat sectors
  8329 00002429 83DA00                  		sbb	dx, 0
  8330                                  fat_32bit:	
  8331                                  		; 17/12/2023
  8332 0000242C 8B5C06                  		mov	bx, [si+6] ; 12/08/2023
  8333                                  		;mov	bx, [cs:si+6]	; [cs:si+EBPB.ROOTENTRIES]
  8334                                  					; # root entries
  8335 0000242F 895D0C                  		mov	[di+0Ch], bx	; [di+BDS.direntries]
  8336                                  					; set in bds bpb
  8337 00002432 B104                    		mov	cl, 4
  8338 00002434 D3EB                    		shr	bx, cl		; div by 16 ents/sector
  8339 00002436 29D8                    		sub	ax, bx		; sub #	dir sectors
  8340 00002438 83DA00                  		sbb	dx, 0		;
  8341                                  					; dx:ax	now contains the
  8342                                  					; # of data sectors
  8343                                  		; 17/12/2023
  8344                                  		; ch = 0
  8345                                  		;xor	cx, cx ; *
  8346 0000243B 8A4C02                  		mov	cl, [si+2] ; 12/08/2023
  8347                                  		;mov	cl, [cs:si+2]	; [cs:si+EBPB.SECTORSPERCLUSTER]
  8348                                  					; sectors per cluster
  8349 0000243E 884D08                  		mov	[di+8],	cl	; [di+BDS.secperclus]
  8350                                  					; set in bios bpb
  8351 00002441 50                      		push	ax
  8352 00002442 89D0                    		mov	ax, dx
  8353 00002444 31D2                    		xor	dx, dx
  8354 00002446 F7F1                    		div	cx		; cx = sectors per cluster
  8355                                  		; 12/08/2023 (ds=cs)
  8356                                  		;mov	[temp_h], ax
  8357                                  		;;mov	[cs:temp_h], ax	; [temp_h]:ax now contains the
  8358                                  					; # clusters.
  8359                                  		; 17/12/2023
  8360 00002448 A3[9E04]                		mov	[saved_word], ax ; hw of cluster number
  8361 0000244B 58                      		pop	ax
  8362 0000244C F7F1                    		div	cx
  8363                                  		; 17/12/2023
  8364                                  		;;cmp	word [cs:temp_h], 0
  8365                                  		;cmp	word [temp_h], 0  ; 12/08/2023
  8366                                  		;cmp	word [saved_word], 0 ; (*)
  8367                                  		;ja	short toobig_ret ; too big cluster number
  8368                                  
  8369                                  		; 17/12/2023
  8370                                  		;;;
  8371 0000244E 5B                      		pop	bx ; FAT sectors (16 bit)
  8372                                  		;and	bx, bx ; 0 ?
  8373 0000244F 09DB                    		or	bx, bx ; 0 ?
  8374 00002451 751F                    		jnz	short chk_clnum_hw
  8375                                  				 ; 16 bit fat sectors > 0 ; FAT12 or FAT16 fs
  8376                                  
  8377 00002453 813E[9E04]FF0F          		cmp	word [saved_word], 0FFFh 
  8378 00002459 7503                    		jne	short fat32_clust_limit
  8379 0000245B 83F8F6                  		cmp	ax, 0FFF6h	; FAT32 cluster number limit: 0FFFFFF6h
  8380                                  fat32_clust_limit:
  8381 0000245E 772D                    		ja	short short toobig_ret ; too big cluster number
  8382 00002460 391E[9E04]              		cmp	[saved_word], bx ; 0 ?
  8383                                  	 	;jnz	short fat16_clust_limit
  8384 00002464 7505                    		jnz	short set_fbigbig_flag ; 17/12/2023
  8385                                  fat16_clust_limit:	; 17/12/2023
  8386 00002466 83F8F6                  		cmp	ax, 0FFF6h	; FAT16 cluster number limit: 0FFF6h
  8387                                  ;fat16_clust_limit:
  8388 00002469 760E                    		jna     short fat12_clust_limit ; jbe
  8389                                  set_fbigbig_flag:	; 17/12/2023
  8390 0000246B 800E[FC19]20            		or	byte [fbigfat], 20h ; fbigbig ; FAT32 fs
  8391 00002470 EB11                    		jmp	short copymediaid
  8392                                  chk_clnum_hw:
  8393 00002472 833E[9E04]00            		cmp	word [saved_word], 0 ; (*)
  8394 00002477 7714                    		ja	short toobig_ret ; too big cluster number
  8395                                  		;;;
  8396                                  fat12_clust_limit:
  8397 00002479 3DF60F                  		cmp	ax, 0FF6h	; 4096-10
  8398                                  					; is this 16-bit fat?
  8399 0000247C 7205                    		jb	short copymediaid ; no,	small fat
  8400                                  		; 17/10/2022
  8401 0000247E 800E[FC19]40            		or	byte [fbigfat], 40h ; fbig ; FAT16 fs
  8402                                  		;or	ds:fbigfat, 40h	; fbig
  8403                                  					; 16 bit fat
  8404                                  copymediaid:
  8405                                  		; 17/12/2023
  8406                                  		; es = ds = cs
  8407                                  		
  8408                                  		;push	es
  8409                                  		;push	ds
  8410                                  		;pop	es
  8411                                  		
  8412                                  		; 12/08/2023
  8413                                  		; ds = cs = BIOSDATA
  8414                                  		;push	cs
  8415                                  		;pop	ds
  8416                                  		; 17/10/2022
  8417 00002483 BD[4F08]                		mov	bp, MOVMEDIAIDS
  8418                                  		;mov	bp, 865h	; (PCDOS 7.1 IBMBIO.COM)
  8419                                  		;;mov	bp, 751h	; mov_media_ids
  8420                                  					; at 2C7h:751h = 70h:2CC1h
  8421                                  					; copy filesys_id, volume label
  8422 00002486 0E                      		push	cs		; simulate far call
  8423 00002487 E8D9F5                  		call	call_bios_code
  8424                                  
  8425                                  		; 12/08/2023
  8426                                  		;push	es
  8427                                  		;pop	ds
  8428                                  		; 17/12/2023	
  8429                                  		;pop	es
  8430                                  
  8431 0000248A E9CD00                  		jmp	massage_bpb	; now final check for bpb info
  8432                                  					; and return.
  8433                                  ; ---------------------------------------------------------------------------
  8434                                  
  8435                                  toobig_ret:
  8436                                  		; 12/08/2023 (ds=cs=BIOSDATA)
  8437 0000248D 800E[FC19]80            		or	byte [fbigfat], 80h ; ftoobig
  8438                                  		;or	byte [cs:fbigfat], 80h ; ftoobig 
  8439                                  					; too big (32 bit clust #) for FAT16
  8440 00002492 E9E300                  		jmp	goodret		; still	drive letter is	assigned
  8441                                  					; but useless. to big for
  8442                                  					; current pc dos fat file system
  8443                                  ; ---------------------------------------------------------------------------
  8444                                  
  8445                                  unknown:
  8446                                  		; 17/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  8447 00002495 804D4002                		or	byte [di+40h], 2 ; [di+BDS.flags+1]
  8448                                  					 ; unformatted_media
  8449                                  		; 12/12/2022
  8450                                  		;or	byte [di+24h], 02h
  8451                                  		;;or	word [di+23h], 200h ; [di+BDS.flags]
  8452                                  					; unformatted_media
  8453                                  					; Set unformatted media	flag.
  8454                                  
  8455                                  ; the boot signature may not be	recognizable,
  8456                                  ; but we should	try and	read it	anyway.
  8457                                  
  8458                                  unknown3_0:
  8459 00002499 8B551D                  		mov	dx, [di+1Dh]	; skip setting unformatted_media bit
  8460                                  					; [di+BDS.totalsecs32+2]
  8461 0000249C 8B451B                  		mov	ax, [di+1Bh]	; [di+BDS.totalsecs32]
  8462 0000249F BE[081A]                		mov	si, disktable2
  8463                                  scan:					; 08/08/2023
  8464                                  		;cmp	dx, [cs:si]	; total sectors hw
  8465                                  		; 12/08/2023 (ds=cs)
  8466 000024A2 3B14                    		cmp	dx, [si] 
  8467 000024A4 720C                     		jb	short gotparm
  8468 000024A6 7705                    		ja	short scan_next
  8469                                  		;cmp	ax, [cs:si+2]	; total sectors lw
  8470 000024A8 3B4402                  		cmp	ax, [si+2]
  8471 000024AB 7605                    		jbe	short gotparm
  8472                                  scan_next:				
  8473 000024AD 83C60A                  		add	si, 10		; 5*2
  8474 000024B0 EBF0                    		jmp	short scan	; covers upto 512 mb media
  8475                                  ; ---------------------------------------------------------------------------
  8476                                  
  8477                                  gotparm:
  8478 000024B2 8A4C08                  		mov	cl, [si+8]	; fat size for fbigfat flag
  8479                                  		;or	ds:fbigfat, cl
  8480                                  		; 17/10/2022
  8481 000024B5 080E[FC19]              		or	[fbigfat], cl	; (fbig flag, 40h or 0) ; 08/08/2023
  8482                                  		; 12/08/2023
  8483                                  		; ds = cs = BIOSDATA
  8484 000024B9 8B4C04                  		mov	cx, [si+4]
  8485                                  		;mov	cx, [cs:si+4]	; ch = number of sectors per cluster
  8486                                  					; cl = log base 2 of ch
  8487 000024BC 8B5406                  		mov	dx, [si+6]
  8488                                  		;mov	dx, [cs:si+6]	; dx = number of root dir entries
  8489                                  
  8490                                  ; now calculate size of fat table
  8491                                  
  8492 000024BF 89550C                  		mov	[di+0Ch], dx	; [di+BDS.direntries]
  8493                                  					; save number of (root)	dir entries
  8494 000024C2 8B551D                  		mov	dx, [di+1Dh]	; [di+BDS.totalsecs32+2]
  8495 000024C5 8B451B                  		mov	ax, [di+1Bh]	; [di+BDS.totalsecs32]
  8496 000024C8 886D08                  		mov	[di+8],	ch	; [di+BDS.secperclus]
  8497                                  					; save sectors per cluster
  8498                                  		
  8499                                  		; 17/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  8500 000024CB F606[FC19]60            		test	byte [fbigfat], 60h ; fbig+fbigbig ; FAT16 or FAT32
  8501                                  		; 11/09/2023
  8502                                  		; 17/10/2022
  8503                                  		;test	byte [fbigfat], 40h
  8504                                  		;;test	ds:fbigfat, 40h	; fbig
  8505                                  					; if (fbigfat)
  8506 000024D0 751E                    		jnz	short dobig	; goto dobig; (16 bit fat)
  8507                                  
  8508                                  ; we don't need to change "small fat" logic since it is guaranteed
  8509                                  ; that double word total sector will not use 12 bit fat (unless
  8510                                  ; it's sectors/cluster >= 16 which will never be in this case.)
  8511                                  ; so in this case we assume dx = 0 !!
  8512                                  
  8513 000024D2 31DB                    		xor	bx, bx		; 12 bit fat (FAT12 fs)
  8514 000024D4 88EB                    		mov	bl, ch
  8515 000024D6 4B                      		dec	bx
  8516 000024D7 01C3                    		add	bx, ax		; dx=0
  8517 000024D9 D3EB                    		shr	bx, cl		; bx = 1+(bpb->maxsec+BDS.secperclus-1)/
  8518 000024DB 43                      		inc	bx		; BDS.secperclus
  8519 000024DC 80E3FE                  		and	bl, 0FEh	; bx &= ~1; (=number of clusters)
  8520 000024DF 89DE                    		mov	si, bx
  8521 000024E1 D1EB                    		shr	bx, 1
  8522 000024E3 01F3                    		add	bx, si		; number of FAT bytes ; 08/08/2023
  8523 000024E5 81C3FF01                		add	bx, 511		; bx +=	511 + bx/2
  8524 000024E9 D0EF                    		shr	bh, 1		; bh >>= 1; (=bx/512)
  8525 000024EB 887D11                  		mov	[di+11h], bh	; [di+BDS.fatsecs]
  8526                                  					; save number of fat sectors
  8527 000024EE EB6A                    		jmp	short massage_bpb
  8528                                  ; ---------------------------------------------------------------------------
  8529                                  
  8530                                  ; for bigfat we do need to extend this logic to 32 bit sector calculation.
  8531                                  
  8532                                  dobig:					
  8533 000024F0 B104                    		mov	cl, 4		; 16 (2^4) directory entries per sector
  8534 000024F2 52                      		push	dx		; save total sectors (high)
  8535 000024F3 8B550C                  		mov	dx, [di+0Ch]	; [di+BDS.direntries]
  8536 000024F6 D3EA                    		shr	dx, cl		; root dir sectors = BDS.direntries / 16;
  8537 000024F8 29D0                    		sub	ax, dx
  8538 000024FA 5A                      		pop	dx
  8539 000024FB 83DA00                  		sbb	dx, 0		; dx:ax	= total	sectors	- root dir sectors
  8540 000024FE 83E801                  		sub	ax, 1
  8541 00002501 83DA00                  		sbb	dx, 0		; dx:ax	= t - r	- d
  8542                                  					; total	secs - reserved	secs - root dir	secs
  8543 00002504 B302                    		mov	bl, 2
  8544 00002506 8A7D08                  		mov	bh, [di+8]	; [di+BDS.secperclus]
  8545                                  					; bx = 256 * BDS.secperclus + 2
  8546                                  
  8547                                  ; I don't understand why to add bx here!!!
  8548                                  
  8549                                  		; 29/12/2018 - Erdogan Tan (Retro DOS v4.0)
  8550                                  		; 27/09/2022
  8551                                  		; (Microsoft FAT32 File	System Specification,
  8552                                  		; December 2000, Page 21)
  8553                                  		; TmpVal1 = DskSize - (BPB_ResvdSecCnt+RootrDirSectors)
  8554                                  		; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs
  8555                                  		; 8/8/2023 (Retro DOS v5.0)
  8556                                  		; If(FATType == FAT32)
  8557                                  		;   TmpVal2 = TmpVal2 / 2;
  8558                                  		; FATsz	= (TmpVal1+(TmpVal2-1))/TmpVal2
  8559                                  		; 8/8/2023 (Retro DOS v5.0)
  8560                                  		; If(FATType == FAT32) {
  8561                                  		;   BPB_FATSz16 = 0;
  8562                                  		;   BPB_FATSz32 = FATSz;
  8563                                  		;} else {
  8564                                  		;   BPB_FATSz16 = LOWORD(FATSz);
  8565                                  		;/* there is no BPB_FATSz32 in a FAT16 BPB */
  8566                                  		;}
  8567                                  					; dx:ax = TmpVal1, bx = TmpVal2
  8568 00002509 01D8                    		add	ax, bx		; 
  8569 0000250B 83D200                  		adc	dx, 0		; dx:ax = TmpVal1+TmpVal2
  8570 0000250E 83E801                  		sub	ax, 1		
  8571 00002511 83DA00                  		sbb	dx, 0		; dx:ax = TmpVal1+TmpVal2-1
  8572                                  
  8573                                  		;;;
  8574                                  		; 17/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  8575 00002514 F606[FC19]20            		test	byte [fbigfat], 20h ; fbigbig (FAT32) flag
  8576 00002519 740D                    		jz      short dobig1
  8577                                  
  8578 0000251B D1EB                    		shr	bx, 1           ; TmpVal2 = TmpVal2 / 2
  8579                                  					; dx:ax = TmpVal1+(2*TmpVal2)-1
  8580 0000251D 83E81F                  		sub	ax, 31          ; reserved sectors = 32 (for FAT32 fs) /// 1+31 = 32
  8581 00002520 83DA00                  		sbb	dx, 0
  8582 00002523 29D8                    		sub	ax, bx
  8583 00002525 83DA00                  		sbb	dx, 0           ; dx:ax = TmpVal1+(2*TmpVal2)-TmpVal2-1
  8584                                  					;       = TmpVal1+(TmpVal2-1)
  8585                                  dobig1:
  8586 00002528 50                      		push	ax		; save lw of dividend
  8587 00002529 89D0                    		mov	ax, dx		; divide hw of dx:ax at first (as 1st stage)
  8588 0000252B 31D2                    		xor	dx, dx
  8589 0000252D F7F3                    		div	bx		; 32 bit division, dx:ax/bx
  8590                                  					; remainder in dx is hw of 2nd stage dividend
  8591 0000252F 89C5                    		mov	bp, ax		; hw of quotient
  8592 00002531 58                      		pop	ax		; restore lw of dividend (of 1st stage)
  8593                                  		;;;
  8594                                  
  8595                                  ; assuming dx in the table will never be bigger than bx.
  8596                                  
  8597 00002532 F7F3                    		div	bx		; BDS.fatsecs =
  8598                                  					; ceil((total-dir-res)/(256*BDS.secperclus+2))
  8599 00002534 894511                  		mov	[di+11h], ax	; [di+BDS.fatsecs]
  8600                                  					; number of fat	sectors
  8601                                  		;;;
  8602                                  		
  8603                                  		; 18/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  8604 00002537 8A1E[FC19]              		mov	bl, [fbigfat]
  8605 0000253B 885D3B                  		mov	[di+3Bh], bl	; [di+BDS.fatsiz] ; fat size flag
  8606                                  		
  8607 0000253E F6C320                  		test	bl, 20h		; fbigbig (FAT32) flag
  8608 00002541 7410                    		jz	short dobig2	; not FAT32
  8609                                  
  8610 00002543 89451F                  		mov	[di+1Fh], ax	; [di+BDS.fatsecs32]
  8611 00002546 896D21                  		mov	[di+21h], bp	; [di+BDS.fatsecs32+2]
  8612 00002549 C745110000              		mov	word [di+11h], 0 ; [di+BDS.fatsecs] = 0
  8613                                  					; clear 16 bit FAT size field
  8614 0000254E C745092000              		mov	word [di+9], 32	; [di+BDS.resectors]
  8615                                  					; set reserved sectors to 32 (FAT32 de facto)
  8616                                  dobig2:
  8617                                  		;;;
  8618                                  
  8619                                  ; now, set the default filesys_id, volume label, serial number
  8620                                  
  8621                                  		; 05/08/2023
  8622                                  		; [di+1Fh] = [fbigfat]
  8623                                  		;
  8624                                  		;;mov	bl, ds:fbigfat
  8625                                  		;; 17/10/2022
  8626                                  		;mov	bl, [fbigfat]
  8627                                  		;mov	[di+1Fh], bl	; [di+BDS.fatsiz] ; fat	size flag
  8628                                  
  8629                                  		; 12/08/2023
  8630                                  		;push	ds ; ds = cs = BIOSDATA
  8631                                  		
  8632                                  		; 17/12/2023
  8633                                  		; es = ds = cs
  8634                                  		;push	ds
  8635                                  		;pop	es
  8636                                  
  8637                                  		; 12/08/2023 
  8638                                  		; ds = cs = BIOSDATA
  8639                                  		;push	cs
  8640                                  		;pop	ds
  8641                                  
  8642                                  		; 18/12/2023 - Retro DOS v5.0
  8643                                  		; bl = [fbigfat] (clear_ids_x uses bl value here)
  8644                                  		; 11/09/2023
  8645                                  		;mov	al, [fbigfat]
  8646 00002553 BD[A106]                		mov	bp, CLEARIDS_X	; clear_ids_x (uses AL value here)
  8647                                  		; 17/10/2022
  8648                                  		;mov	bp, CLEARIDS
  8649                                  		;;mov	bp, 5D9h	; clear_ids
  8650                                  					; at 2C7h:5D9h = 70h:2B49h
  8651                                  					; at BIOSCODE:06ABh
  8652                                  					;	in PCDOS 7.1 IBMBIO.COM
  8653 00002556 0E                      		push	cs
  8654 00002557 E809F5                  		call	call_bios_code
  8655                                  
  8656                                  		; 12/08/2023
  8657                                  		;pop	ds ; ds = cs = BIOSDATA
  8658                                  
  8659                                  ; at this point, in bpb of bds table, BDS_BPB.BPB_BIGTOTALSECTORS which is
  8660                                  ; set according to the partition information. we are going to
  8661                                  ; see if (hidden sectors + total sectors) > a word. if it is true,
  8662                                  ; then no change. otherwise, BDS_BPB.BPB_BIGTOTALSECTORS will be moved
  8663                                  ; to BDS_BPB.BPB_TOTALSECTORS and BDS_BPB.BPB_BIGTOTALSECTORS will be set to 0.
  8664                                  ; we don't do this for the bpb information from the boot record. we
  8665                                  ; are not going to change the bpb information from the boot record.
  8666                                  
  8667                                  massage_bpb:
  8668                                  		; 05/08/2023
  8669                                  		; [di+1Fh] = [fbigfat]
  8670                                  		;
  8671                                  		;; 12/12/2022
  8672                                  		;mov	bl, [fbigfat]
  8673                                  		;mov	[di+1Fh], bl	; [di+BDS.fatsiz]
  8674                                  		;			; set size of fat on media
  8675                                  		;
  8676 0000255A 8B551D                  		mov	dx, [di+1Dh]	; [di+BDS.totalsecs32+2]
  8677 0000255D 8B451B                  		mov	ax, [di+1Bh]	; [di+BDS.totalsecs32]
  8678                                  		; 11/09/2023
  8679 00002560 09D2                    		or	dx, dx
  8680 00002562 7514                    		jnz	short goodret	
  8681                                  		;cmp	dx, 0		; double word total sectors?
  8682                                  		;;ja	short goodret	; don't have to change it.
  8683                                  		;; 12/12/2022
  8684                                  		;ja	short short goodret2
  8685                                  		;cmp	word [di+19h], 0 ; [di+BDS.hiddensecs+2]
  8686                                  		;ja	short goodret	; don't have to change it.
  8687                                  		; 12/12/2022
  8688 00002564 395519                  		cmp	[di+19h], dx ; 0
  8689                                  		;ja	short goodret2
  8690 00002567 770F                    		ja	short goodret	; 11/09/2023
  8691 00002569 034517                  		add	ax, [di+17h]	; [di+BDS.hiddensecs]
  8692                                  		;jb	short goodret
  8693                                  		; 12/12/2022
  8694                                  		;jc	short goodret
  8695 0000256C 7209                    		jc	short goodret_clc ; 11/09/2023
  8696 0000256E 8B451B                  		mov	ax, [di+1Bh]	; [di+BDS.totalsecs32]
  8697 00002571 89450E                  		mov	[di+0Eh], ax	; [di+BDS.totalsecs16]
  8698                                  		;mov	word [di+1Bh], 0 ; [di+BDS.totalsecs32]
  8699                                  		; 12/12/2022
  8700 00002574 89551B                  		mov	[di+1Bh], dx ; 0
  8701                                  goodret_clc:
  8702                                  		; 11/09/2023
  8703 00002577 F8                      		clc 
  8704                                  goodret:
  8705                                  		;mov	bl, ds:fbigfat
  8706                                  		; 11/09/2023
  8707                                  		; 12/12/2022
  8708                                  		; 17/10/2022
  8709 00002578 8A1E[FC19]              		mov	bl, [fbigfat]
  8710                                  		; 17/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  8711 0000257C 885D3B                  		mov	[di+3Bh], bl	; [di+BDS.fatsiz]
  8712                                  		;mov	[di+1Fh], bl	; [di+BDS.fatsiz]
  8713                                  					; set size of fat on media
  8714                                  		; 11/09/2023
  8715                                  		;clc
  8716                                  ret_hard_err:
  8717                                  		; 12/12/2022
  8718                                  goodret2:
  8719 0000257F 07                      		pop	es
  8720                                  		;pop	ds	; ds = cs = BIOSDATA ; 14/08/2023
  8721 00002580 5B                      		pop	bx
  8722 00002581 5F                      		pop	di
  8723 00002582 C3                      		retn
  8724                                  
  8725                                  ; =============== S U B	R O U T	I N E =======================================
  8726                                  
  8727                                  ; 15/10/2022
  8728                                  
  8729                                  ;fdisk of pc dos 3.3 and below, os2 1.0 has a bug. the maximum number of
  8730                                  ;sector that can be handled by pc dos 3.3 ibmbio should be 0ffffh.
  8731                                  ;instead, sometimes fdisk use 10000h to calculate the maximum number.
  8732                                  ;so, we are going to check that if BPB_TOTALSECTORS + hidden sector = 10000h
  8733                                  ;then subtract 1 from BPB_TOTALSECTORS.
  8734                                  
  8735                                  		; 17/10/2022
  8736                                  cover_fdisk_bug:
  8737                                  		; 12/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  8738                                  		; ds = cs
  8739                                  
  8740                                  		; 18/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  8741                                  		; (optimization)
  8742                                  		;push	ax
  8743                                  		;push	dx
  8744                                  		;push	si
  8745                                  
  8746                                  		; 18/12/2023
  8747                                  		; bx = offset disksector
  8748                                  
  8749                                  		; 18/12/2023
  8750 00002583 807F2629                		cmp	byte [bx+26h], 29h
  8751                                  		; 12/08/2023
  8752                                  		;cmp	byte [disksector+26h], 29h
  8753                                  		;;cmp	byte [cs:disksector+26h], 29h
  8754                                  					; [disksector+EXT_BOOT.SIG],
  8755                                  					; EXT_BOOT_SIGNATURE
  8756 00002587 7426                    		je	short cfb_retit	; if extended bpb, then	>= pc dos 4.00
  8757                                  		
  8758 00002589 817F073130              		cmp	word [bx+7], 3031h
  8759                                  		;cmp	word [cs:bx+7], 3031h ; '10' ; os2 1.0 = ibm 10.0
  8760 0000258E 7506                    		jne	short cfb_chk_totalsecs ; 11/08/2023
  8761 00002590 807F0A30                		cmp	byte [bx+10], '0'
  8762                                  		;cmp	byte [cs:bx+10], '0'
  8763 00002594 7519                    		jne	short cfb_retit
  8764                                  
  8765                                  cfb_chk_totalsecs:
  8766                                  		; 11/08/2023
  8767                                  ; 18/12/2023
  8768                                  %if 0
  8769                                  		; 17/10/2022		
  8770                                  		mov	si, disksector+11 ; 14Eh+0Bh
  8771                                  		;mov	si, 159h	; disksector+EXT_BOOT.BPB
  8772                                  		; 12/08/2023
  8773                                  		cmp	word [si+8], 0
  8774                                  		;cmp	word [cs:si+8], 0 ; [cs:si+EBPB.TOTALSECTORS]
  8775                                  					; just to make sure.
  8776                                  		jz	short cfb_retit
  8777                                  		;mov	ax, [cs:si+8]	; [cs:si+EBPB.TOTALSECTORS]
  8778                                  		;add	ax, [cs:si+11h]	; [cs:si+EBPB.HIDDENSECTORS]
  8779                                  		; 12/08/2023
  8780                                  		mov	ax, [si+8]
  8781                                  		add	ax, [si+11h]
  8782                                  
  8783                                  		jnb	short cfb_retit
  8784                                  		jnz	short cfb_retit
  8785                                  					; if carry set and ax=0
  8786                                  		dec	word [si+8]
  8787                                  		;dec	word [cs:si+8]	; 0 -> 0FFFFh
  8788                                  					; then decrease	BPB_TOTALSECTORS by 1
  8789                                  %endif
  8790                                  		; 18/12/2023
  8791                                  		;cmp	word [bx+19], 0
  8792 00002596 8B4713                  		mov	ax, [bx+19]	; [bx+EBPB.TOTALSECTORS]
  8793 00002599 21C0                    		and	ax, ax ; 0 ?
  8794 0000259B 7412                    		jz	short cfb_retit
  8795                                  
  8796                                  		;mov	ax, [bx+19]
  8797 0000259D 03471C                  		add	ax, [bx+28]	; [bx+EBPB.HIDDENSECTORS]
  8798 000025A0 730D                    		jnc	short cfb_retit
  8799 000025A2 750B                    		jnz	short cfb_retit
  8800                                  		; ax = 0		; 0 -> 0FFFFh
  8801 000025A4 FF4F13                  		dec	word [bx+19]	; then decrease	BPB_TOTALSECTORS by 1
  8802                                  
  8803 000025A7 836D1B01                		sub	word [di+1Bh], 1 ; [di+BDS.totalsecs32]
  8804 000025AB 835D1D00                		sbb	word [di+1Dh], 0 ; [di+BDS.totalsecs32+2]
  8805                                  cfb_retit:	
  8806                                  		; 18/12/2023
  8807                                  		;pop	si
  8808                                  		;pop	dx
  8809                                  		;pop	ax
  8810                                  		
  8811 000025AF C3                      		retn
  8812                                  
  8813                                  ; ---------------------------------------------------------------------------
  8814                                  
  8815 000025B0 0200                    word2:		dw 2
  8816 000025B2 0300                    word3:		dw 3
  8817 000025B4 0002                    word512:	dw 512
  8818                                  
  8819                                  ; =============== S U B	R O U T	I N E =======================================
  8820                                  
  8821                                  ; 15/10/2022
  8822                                  
  8823                                  ; setdrvparms sets up the recommended bpb in each bds in the system based on
  8824                                  ; the form factor. it is assumed that the bpbs for the various form factors
  8825                                  ; are present in the bpbtable. for hard files, the recommended bpb is the same
  8826                                  ; as the bpb on the drive.
  8827                                  ;
  8828                                  ; no attempt is made to preserve registers since we are going to jump to
  8829                                  ; sysinit straight after this routine.
  8830                                  
  8831                                  		; 18/12/2023 - Retro DOS v5.0 
  8832                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2A43h)
  8833                                  setdrvparms:
  8834                                  		; 12/12/2023
  8835                                  		; ds = cs
  8836 000025B6 31DB                    		xor	bx, bx
  8837                                  		; 18/10/2022
  8838 000025B8 C43E[1901]              		les	di, [start_bds] ; get first bds in list
  8839                                  _next_bds:
  8840 000025BC 06                      		push	es
  8841 000025BD 57                      		push	di
  8842                                  
  8843                                  		; 18/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
  8844 000025BE 268A5D3E                		mov	bl, [es:di+3Eh]	; [es:di+BDS.formfactor]
  8845                                  		;mov	bl, [es:di+22h]	; [es:di+BDS.formfactor]
  8846                                  
  8847 000025C2 80FB05                  		cmp	bl, 5		; ffHardFile
  8848 000025C5 753A                    		jnz	short nothardff
  8849 000025C7 31D2                    		xor	dx, dx
  8850 000025C9 268B450E                		mov	ax, [es:di+0Eh]	; [es:di+BDS.totalsecs16]
  8851 000025CD 09C0                    		or	ax, ax
  8852 000025CF 7508                    		jnz	short get_ccyl
  8853 000025D1 268B551D                		mov	dx, [es:di+1Dh]	; [es:di+BDS.totalsecs32+2]
  8854 000025D5 268B451B                		mov	ax, [es:di+1Bh]	; [es:di+BDS.totalsecs32]
  8855                                  get_ccyl:
  8856 000025D9 52                      		push	dx
  8857 000025DA 50                      		push	ax
  8858 000025DB 268B4515                		mov	ax, [es:di+15h]	; [es:di+BDS.heads]
  8859 000025DF 26F76513                		mul	word [es:di+13h] ; [es:di+BDS.secpertrack]
  8860                                  					; assume sectors per cyl. < 64k.
  8861 000025E3 89C1                    		mov	cx, ax		; cx has # sectors per cylinder
  8862 000025E5 58                      		pop	ax
  8863 000025E6 5A                      		pop	dx		; dx:ax	= total	sectors
  8864 000025E7 50                      		push	ax
  8865 000025E8 89D0                    		mov	ax, dx
  8866 000025EA 31D2                    		xor	dx, dx
  8867 000025EC F7F1                    		div	cx
  8868                                  		; 12/12/2023  ; !*!
  8869                                  		; (data segment may not be same with code segment here)
  8870                                  		;mov	[cs:temp_h], ax	; ax be	0 here.
  8871                                  		; 18/12/2023 - Retro DOS v5.0
  8872                                  		;mov	[cs:saved_word], ax
  8873 000025EE 58                      		pop	ax
  8874 000025EF F7F1                    		div	cx		; div #sec by sec/cyl to get # cyl.
  8875 000025F1 09D2                    		or	dx, dx
  8876 000025F3 7401                    		jz	short no_cyl_rnd ; came out even
  8877 000025F5 40                      		inc	ax		; round	up
  8878                                  no_cyl_rnd:
  8879                                  		; 18/12/2023 - Retro DOS v5.0
  8880 000025F6 26894541                		mov	[es:di+41h], ax	; [es:di+BDS.cylinders]
  8881                                  		;mov	[es:di+25h], ax	; [es:di+BDS.cylinders]
  8882                                  		
  8883 000025FA 06                      		push	es
  8884 000025FB 1F                      		pop	ds  ; !*! ; 12/12/2023
  8885                                  
  8886 000025FC 8D7506                  		lea	si, [di+6]	; [di+BDS.bytespersec]
  8887                                  					; ds:si	-> bpb for hard	file
  8888 000025FF EB55                    		jmp	short set_recbpb
  8889                                  ; ---------------------------------------------------------------------------
  8890                                  
  8891                                  nothardff:				
  8892 00002601 0E                      		push	cs
  8893 00002602 1F                      		pop	ds
  8894                                  
  8895                                  ; if fake floppy drive variable is set then we don't have to handle this bds.
  8896                                  ; we can just go and deal with the next bds at label go_to_next_bds.
  8897                                  
  8898                                  		; 10/12/2022
  8899                                  		; ds = cs
  8900                                  		; 17/10/2022 (ds=cs)
  8901 00002603 803E[031A]01            		cmp	byte [fakefloppydrv], 1
  8902                                  		;cmp	byte [cs:fakefloppydrv], 1
  8903 00002608 7454                    		jz	short go_to_next_bds
  8904 0000260A 80FB07                  		cmp	bl, 7		; ffother
  8905                                  					; special case "other" type of medium
  8906 0000260D 753D                    		jnz	short not_process_other
  8907                                  process_other:
  8908 0000260F 31D2                    		xor	dx, dx
  8909                                  
  8910                                  		;mov	ax, [di+25h]	; [di+BDS.cylinders]
  8911                                  		;mul	word [di+36h]	; [di+BDS.rheads]
  8912                                  		;mul	word [di+34h]	; [di+BDS.rsecpertrack]
  8913                                  		;mov	[di+2Fh], ax	; [di+BDS.rtotalsecs16]
  8914                                  		;			; have the total number of sectors
  8915                                  		; 18/12/2023 - Retro DOS v5.0
  8916 00002611 8B4541                  		mov	ax, [di+41h]	; [di+BDS.cylinders]
  8917 00002614 F76552                  		mul	word [di+52h]	; [di+BDS.rheads]
  8918 00002617 F76550                  		mul	word [di+50h]	; [di+BDS.rsecpertrack]
  8919 0000261A 89454B                  		mov	[di+4Bh], ax	; [di+BDS.rtotalsecs16]
  8920                                  					; have the total number of sectors
  8921 0000261D 48                      		dec	ax
  8922 0000261E B201                    		mov	dl, 1
  8923                                  _again:					
  8924 00002620 3DF60F                  		cmp	ax, 0FF6h	; 4096-10
  8925 00002623 7206                    		jb	short _@@
  8926 00002625 D1E8                    		shr	ax, 1
  8927 00002627 D0E2                    		shl	dl, 1
  8928 00002629 EBF5                    		jmp	short _again
  8929                                  ; ---------------------------------------------------------------------------
  8930                                  
  8931                                  _@@:
  8932 0000262B 80FA01                  		cmp	dl, 1		; is it	a small	disk ?
  8933 0000262E 7405                    		jz	short __@@	; yes, 224 root	entries	is enuf
  8934                                  
  8935                                  		; 18/12/2023 - Retro DOS v5.0
  8936 00002630 C74549F000              		mov	word [di+49h], 240 ; [di+BDS.rdirentries]
  8937                                  		;mov	word [di+2Dh], 240 ; [di+BDS.rdirentries]
  8938                                  __@@:
  8939                                  		; 18/12/2023 - Retro DOS v5.0
  8940 00002635 885545                  		mov	[di+45h], dl	; [di+BDS.rsecperclus]
  8941                                  		;mov	[di+29h], dl	; [di+BDS.rsecperclus]
  8942                                  
  8943                                  ; logic to get the sectors/fat area.
  8944                                  ; fat entry is assumed to be 1.5 bytes!!!
  8945                                  
  8946                                  		; 10/12/2022
  8947                                  		; ds = cs
  8948                                  		; 17/10/2022 (ds=cs)
  8949 00002638 F726[B225]              		mul	word [word3]	; * 3
  8950 0000263C F736[B025]              		div	word [word2]	; / 2
  8951 00002640 31D2                    		xor	dx, dx
  8952 00002642 F736[B425]              		div	word [word512]	; / 512
  8953                                  		;
  8954                                  		; 10/12/2022
  8955                                  		;mul	word [cs:word3]	; * 3
  8956                                  		;div	word [cs:word2]	; / 2
  8957                                  		;xor	dx, dx
  8958                                  		;div	word [cs:word512] ; / 512
  8959                                  		;
  8960 00002646 40                      		inc	ax		; + 1
  8961                                  no_round_up:
  8962                                  		; 18/12/2023 - Retro DOS v5.0
  8963 00002647 89454E                  		mov	[di+4Eh], ax	; [di+BDS.rfatsecs]
  8964                                  		;mov	[di+32h], ax	; [di+BDS.rfatsecs]
  8965                                  
  8966 0000264A EB12                    		jmp	short go_to_next_bds
  8967                                  ; ---------------------------------------------------------------------------
  8968                                  
  8969                                  not_process_other:
  8970 0000264C D1E3                    		shl	bx, 1		; bx is	word index into	table of bpbs
  8971                                  		
  8972                                  		;mov	si, bpbtable
  8973                                  		;mov	si, [bpbtable+bx] ; 15/10/2022
  8974                                  		; 09/12/2022
  8975                                  		;mov	si, BPBTABLE
  8976                                  		;mov	si, [bx+si]	; get address of bpb
  8977                                  		; 10/12/2022
  8978                                  		;mov	si, [BPBTABLE+bx]
  8979                                  		; 13/12/2022
  8980                                  		;mov	si, [SYSINITOFFSET+bpbtable+bx] ; wrong ! 14/08/2023
  8981                                  		
  8982                                  		; 14/08/2023
  8983                                  		SYSINIT_OFFSET equ (SYSINITSEG-DOSBIODATASEG<<4)
  8984                                  							; correct offset
  8985 0000264E 8BB7[7A90]              		mov	si, [bx+SYSINIT_OFFSET+bpbtable]
  8986                                  		
  8987                                  		; 18/12/2023 
  8988                                  		; si = address of the requested disk(ette) parameter block
  8989                                  		;	! as offset from SYSINIT segment !
  8990                                  
  8991                                  		; 28/08/2023
  8992 00002652 81C67046                		add	si, SYSINIT_OFFSET
  8993                                  			; + displacement from BIOSDATA segment ; 18/12/2023
  8994                                  set_recbpb:
  8995                                  		; 18/12/2023
  8996                                  		;lea	di, [di+27h]	; [di+BDS.R_BPB]
  8997                                  		;			; es:di	-> recbpb
  8998                                  		;mov	cx, 25		; bpbx.size
  8999                                  		;rep movsb		; move (size bpbx) bytes
  9000                                  		
  9001                                  		; 18/12/2023 - Retro DOS v5.0
  9002 00002656 8D7D43                  		lea	di, [di+43h]	; [di+BDS.R_BPB]
  9003                                  					; es:di	-> recbpb
  9004 00002659 B93500                  		mov	cx, 53		; bpbx.size
  9005 0000265C F3A4                    		rep movsb		; move (size bpbx) byte
  9006                                  go_to_next_bds:
  9007 0000265E 5F                      		pop	di
  9008 0000265F 07                      		pop	es		; restore pointer to bds
  9009 00002660 26C43D                  		les	di, [es:di]	; [es:di+BDS.link]
  9010 00002663 83FFFF                  		cmp	di, 0FFFFh	; -1
  9011 00002666 740A                    		jz	short got_end_of_bds_chain
  9012 00002668 E951FF                  		jmp	_next_bds
  9013                                  
  9014                                  ; ---------------------------------------------------------------------------
  9015                                  
  9016                                  		; 18/12/2022
  9017                                  ;got_end_of_bds_chain:
  9018                                  		;retn
  9019                                  
  9020                                  ; =============== S U B	R O U T	I N E =======================================
  9021                                  
  9022                                  ; 15/10/2022
  9023                                  ; 30/12/2018 - Retro DOS v4.0
  9024                                  
  9025                                  ; al = device number
  9026                                  
  9027                                  print_init:	
  9028 0000266B 98                      		cbw
  9029 0000266C 89C2                    		mov	dx, ax
  9030 0000266E B401                    		mov	ah, 1
  9031 00002670 CD17                    		int	17h		; PRINTER - INITIALIZE
  9032                                  					; DX = printer port (0-3)
  9033                                  					; Return: AH = status
  9034                                  got_end_of_bds_chain:	; 18/12/2022
  9035 00002672 C3                      		retn
  9036                                  
  9037                                  ; =============== S U B	R O U T	I N E =======================================
  9038                                  
  9039                                  ; al = device number
  9040                                  
  9041                                  aux_init:
  9042 00002673 98                      		cbw
  9043 00002674 89C2                    		mov	dx, ax
  9044                                  		;mov	al, 0A3h	; RSINIT ; 0A3h
  9045                                  					; 2400,n,1,8 (msequ.inc)
  9046                                  		;mov	ah, 0
  9047                                  		; 10/12/2022
  9048 00002676 B8A300                  		mov	ax, 00A3h
  9049 00002679 CD14                    		int	14h		; SERIAL I/O - INITIALIZE USART
  9050                                  					; 	AL = initializing parameters,
  9051                                  					;	DX = port number (0-3)
  9052                                  					; Return: AH = RS-232 status code bits,
  9053                                  					;	  AL = modem status bits
  9054 0000267B C3                      		retn
  9055                                  
  9056                                  ; =============== S U B	R O U T	I N E =======================================
  9057                                  
  9058                                  ; 18/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
  9059                                  ; 08/08/2023 - Retro DOS v4.2 (Modified MSDOS 6.22 IO.SYS)
  9060                                  ; 15/10/2022 (Modified MSDOS 5.0 IO.SYS) -Retro DOS v4 2022- (MSDOS 5.0-6.21)
  9061                                  ; 30/12/2018 - Retro DOS v4.0
  9062                                  ; 03/06/2018 - Retro DOS v3.0
  9063                                  ; (19/03/2018 - Retro DOS v2.0)
  9064                                  
  9065                                  ; domini **********************************************************************
  9066                                  ;
  9067                                  ;mini disk initialization routine. called right after dohard
  9068                                  ;modified for >2 hardfile support
  9069                                  ;
  9070                                  ; **cs=ds=es=datagrp
  9071                                  ;
  9072                                  ; **domini will search for every extended partition in the system, and
  9073                                  ;   initialize it.
  9074                                  ;
  9075                                  ; **bdsm stands for bds table for mini disk and located right after the label
  9076                                  ;   end96tpi. end_of_bdsm will have the offset value of the ending
  9077                                  ;   address of bdsm table.
  9078                                  ;
  9079                                  ; **bdsm is the same as usual bds structure except that tim_lo, tim_hi entries
  9080                                  ;   are overlapped and used to identify mini disk and the number of hidden_trks.
  9081                                  ;   right now, they are called as ismini, hidden_trks respectively.
  9082                                  ;
  9083                                  ; **domini will use the same routine in sethard routine after label set2 to
  9084                                  ;   save coding.
  9085                                  ;
  9086                                  ; **drvmax determined in dohard routine will be used for the next
  9087                                  ;   available logical mini disk drive number.
  9088                                  ;
  9089                                  ; input: drvmax, dskdrvs
  9090                                  ;
  9091                                  ; output: minidisk installed. bdsm table established and installed to bds.
  9092                                  ;	  end_of_bdsm - ending offset address of bdsm.
  9093                                  ;
  9094                                  ; called modules:
  9095                                  ;		  getboot
  9096                                  ;		  find_mini_partition (new), xinstall_bds (new), M038
  9097                                  ;
  9098                                  ;		  setmini (new, it will use set2 routine)
  9099                                  ;
  9100                                  ; variables used: end_of_bdsm
  9101                                  ;		  rom_minidisk_num
  9102                                  ;		  mini_hdlim, mini_seclim
  9103                                  ;		  BDS_STRUC, start_bds
  9104                                  ;
  9105                                  ;******************************************************************************
  9106                                  		; 18/12/2023 - Retro DOS v5.0 IO.SYS/IBMBIO.COM
  9107                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2B10h)
  9108                                  
  9109                                  		; 19/10/2022
  9110                                  domini:
  9111 0000267C 8A36[4F1A]              		mov	dh, [hnum]	; get number of hardfiles
  9112                                  		; 10/12/2022
  9113 00002680 20F6                    		and	dh, dh
  9114                                  		;cmp	dh, 0
  9115 00002682 743C                    		jz	short dominiret	; no hard file?	then exit.
  9116 00002684 B280                    		mov	dl, 80h		; start	with hardfile 80h
  9117                                  domini_loop:
  9118                                  		; 18/12/2023 - Retro DOS v5.0
  9119 00002686 31C0                    		xor	ax, ax ; 0
  9120                                  		; ds = cs
  9121                                  		;mov	[cs:ep_start_sector], ax
  9122                                  		;mov	[cs:ep_start_sector+2], ax
  9123                                  		;mov	[cs:ep_hidden_secs], ax
  9124                                  		;mov	[cs:ep_hidden_secs+2], ax
  9125 00002688 A3[D421]                		mov	[ep_start_sector], ax
  9126 0000268B A3[D621]                		mov	[ep_start_sector+2], ax
  9127 0000268E A3[D821]                		mov	[ep_hidden_secs], ax
  9128 00002691 A3[DA21]                		mov	[ep_hidden_secs+2], ax
  9129                                  		;
  9130 00002694 52                      		push	dx
  9131 00002695 8816[4E1A]              		mov	[rom_minidisk_num], dl
  9132 00002699 B408                    		mov	ah, 8
  9133 0000269B CD13                    		int	13h		; DISK - DISK -	GET CURRENT DRIVE PARAMETERS (XT,AT,XT286,CONV,PS)
  9134                                  					; DL = drive number
  9135                                  					; Return: CF set on error, AH =	status code, BL	= drive	type
  9136                                  					; DL = number of consecutive drives
  9137                                  					; DH = maximum value for head number, ES:DI -> drive parameter
  9138                                  		
  9139                                  		; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  9140                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:2B36h
  9141                                  		;inc	dh
  9142                                  		;xor	ax, ax
  9143                                  		;mov	al, dh
  9144 0000269D 31C0                    		xor	ax, ax
  9145 0000269F 88F0                    		mov	al, dh	; <= 255
  9146 000026A1 40                      		inc	ax	; (0FFh -> 100h)
  9147 000026A2 A3[541A]                		mov	[mini_hdlim], ax ; # of heads
  9148                                  		;and	cl, 3Fh
  9149                                  		;mov	al, cl
  9150                                  		; 08/08/2023
  9151 000026A5 88C8                    		mov	al, cl
  9152 000026A7 83E03F                  		and	ax, 3Fh
  9153 000026AA A3[561A]                		mov	[mini_seclim], ax ; # of sectors/track
  9154                                  		
  9155                                  		; 18/12/2023
  9156                                  		;push	es ; * ; not necessary
  9157 000026AD 8A16[4E1A]              		mov	dl, [rom_minidisk_num]
  9158 000026B1 E868FA                  		call	getboot		; read master boot record into
  9159                                  					; initbootsegment:bootbias
  9160 000026B4 7203                    		jc	short domininext
  9161 000026B6 E80800                  		call	find_mini_partition
  9162                                  domininext:
  9163                                  		;pop	es ; *
  9164 000026B9 5A                      		pop	dx
  9165 000026BA FEC2                    		inc	dl		; next hard file
  9166 000026BC FECE                    		dec	dh
  9167 000026BE 75C6                    		jnz	short domini_loop
  9168                                  dominiret:
  9169 000026C0 C3                      		retn
  9170                                  
  9171                                  ; =============== S U B	R O U T	I N E =======================================
  9172                                  
  9173                                  ; 15/10/2022 (Modified MSDOS 5.0 IO.SYS)
  9174                                  ; 30/12/2018 - Retro DOS v4.0
  9175                                  
  9176                                  ;find_mini_partition tries to find every extended partition on a disk.
  9177                                  ;at entry:	di -> bdsm entry
  9178                                  ;		es:bx -> 07c0:bootbias - master boot record
  9179                                  ;		rom_minidisk_num - rom drive number
  9180                                  ;		drvmax - logical drive number
  9181                                  ;		mini_hdlim, mini_seclim
  9182                                  ;
  9183                                  ;called routine: setmini which uses set2 (in sethard routine)
  9184                                  ;variables & equates used from original bios - flags, fnon_removable, fbigfat
  9185                                  
  9186                                  
  9187                                  		; 19/12/2023 - Retro DOS v5.0 
  9188                                  		;	(Modified PCDOS 7.1 IBMBIO.COM)
  9189                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSADATA:2BFCh)
  9190                                  
  9191                                  find_mini_partition:	
  9192 000026C1 81C3C201                		add	bx, 1C2h	; bx ->	file system id
  9193                                  
  9194                                  		; 19/12/2023
  9195                                  		; PCDOS 7.1 IBMBIO.COM
  9196                                  		;mov	word [ld_p_number], 26
  9197                                  fmpnext:
  9198                                  		;add	word [ld_p_number], 16
  9199                                  		;cmp	word [ld_p_number], 4122
  9200                                  		;		; 64 logical disk partitions (64 EBRs)
  9201                                  		;		; (64*4 = 256 pte's, 256*16 = 4096, + 26 = 4122)
  9202                                  		;jg	short fmpnextfound
  9203                                  				
  9204 000026C5 26803F05                		cmp	byte [es:bx], 5 ; 05h = extended partition id.
  9205 000026C9 7410                    		je	short fmpgot ; Extended DOS CHS
  9206                                  		
  9207                                  		; 19/12/2023 - Retro DOS v5.0
  9208 000026CB 26803F0F                		cmp     byte [es:bx], 0Fh ; Extended DOS LBA
  9209 000026CF 740A                    		je	short fmpgot
  9210                                  
  9211 000026D1 83C310                  		add	bx, 16
  9212 000026D4 81FB0204                		cmp	bx, 402h	; 202h+bootbias
  9213 000026D8 75EB                    		jnz	short fmpnext
  9214                                  		;jmp	short fmpnextfound ; extended partition	not found
  9215                                  		; 18/12/2022
  9216                                  fmpnextfound:
  9217 000026DA C3                      		retn
  9218                                  
  9219                                  ;		; 30/07/2019 - Retro DOS v3.2
  9220                                  ;		jb	short fmpnext
  9221                                  ;fmpret:
  9222                                  ;		retn	; 29/05/2019
  9223                                  
  9224                                  ; ---------------------------------------------------------------------------
  9225                                  
  9226                                  		; 19/10/2022
  9227                                  fmpgot:					; found my partition.
  9228 000026DB E82B01                  		call	dmax_check	; check	for drvmax already 26
  9229 000026DE 73FA                    		jnb	short fmpnextfound ; done if too many
  9230                                  
  9231 000026E0 8B3E[521A]              		mov	di, [end_of_bdss] ; get next free bds
  9232                                  
  9233                                  		; 19/12/2023
  9234                                  		;mov	word [di+47h], 1 ; [di+BDS.bdsm_ismini]
  9235                                  		;; 10/12/2022
  9236                                  		;or	byte [di+23h], 1
  9237                                  		;;or	word [di+23h], 1 ; [di+BDS.flags]
  9238                                  		;			; fNon_Removable
  9239                                  		;mov	byte [di+22h], 5 ; [di+BDS.formfactor]
  9240                                  		;			; ffHardFile
  9241                                  		; 19/12/2023 - Retro DOS v5.0
  9242 000026E4 C745790100              		mov	word [di+79h], 1 ; [di+BDS.bdsm_ismini]
  9243 000026E9 804D3F01                		or	byte [di+3Fh], 1 ; [di+BDS.flags], fNon_Removable
  9244 000026ED C6453E05                		mov	byte [di+3Eh], 5 ; [di+BDS.formfactor], ffHardFile 
  9245                                  
  9246 000026F1 C606[FC19]00            		mov	byte [fbigfat], 0 ; assume 12 bit fat.
  9247 000026F6 A1[541A]                		mov	ax, [mini_hdlim]
  9248 000026F9 894515                  		mov	[di+15h], ax	; [di+BDS.heads]
  9249 000026FC A1[561A]                		mov	ax, [mini_seclim]
  9250 000026FF 894513                  		mov	[di+13h], ax	; [di+BDS.secpertrack]
  9251 00002702 A0[4E1A]                		mov	al, [rom_minidisk_num]
  9252 00002705 884504                  		mov	[di+4],	al	; [di+BDS.drivenum]
  9253                                  					; set physical number
  9254 00002708 A0[7500]                		mov	al, [drvmax]
  9255 0000270B 884505                  		mov	[di+5],	al	; [di+BDS.drivelet]
  9256                                  					; set logical number
  9257 0000270E 26837F0A00              		cmp	word [es:bx+10], 0
  9258                                  		;ja	short fmpgot_cont
  9259 00002713 7707                    		ja	short fmpgot1	; 19/12/2023
  9260 00002715 26837F0840              		cmp	word [es:bx+8], 64 ; with current bpb,
  9261                                  					; only lower word is meaningful.
  9262 0000271A 72BE                    		jb	short fmpnextfound
  9263                                  					; should be bigger than 64 sectors at least
  9264                                  fmpgot1:	; 19/12/2023
  9265                                  ;fmpgot_cont:				
  9266 0000271C 83EB04                  		sub	bx, 4		; let bx point to the start of the entry
  9267 0000271F 268A7702                		mov	dh, [es:bx+2]	; cylinder
  9268 00002723 80E6C0                  		and	dh, 0C0h	; get higher bits of cyl
  9269 00002726 D0C6                    		rol	dh, 1
  9270 00002728 D0C6                    		rol	dh, 1
  9271 0000272A 268A5703                		mov	dl, [es:bx+3]	; cyl byte
  9272                                  		; 19/12/2023 - Retro DOS v5.0
  9273 0000272E 89557B                  		mov	[di+7Bh], dx	; [di+BDS.bdsm_hidden_trks]
  9274                                  		;mov	[di+49h], dx	; [di+BDS.bdsm_hidden_trks]
  9275                                  					; set hidden trks
  9276                                  		; 19/12/2023
  9277                                  		;push	bx ; * ; PCDOS 7.1	
  9278                                  		;;;
  9279 00002731 268B4F08                		mov	cx, [es:bx+8]	; partition size, lw
  9280 00002735 268B470A                		mov	ax, [es:bx+10]	; partition size, hw
  9281 00002739 030E[D421]              		add	cx, [ep_start_sector]
  9282 0000273D 1306[D621]              		adc	ax, [ep_start_sector+2]
  9283 00002741 31D2                    		xor	dx, dx ; 19/12/2023
  9284 00002743 3916[D421]              		cmp	[ep_start_sector], dx ; 0
  9285                                  		;cmp	word [ep_start_sector], 0
  9286 00002747 750D                    		jnz	short fmpgot2
  9287 00002749 3916[D621]              		cmp	[ep_start_sector+2], dx ; 0
  9288                                  		;cmp	word [ep_start_sector+2], 0
  9289 0000274D 7507                    		jnz	short fmpgot2
  9290 0000274F 890E[D421]              		mov	[ep_start_sector], cx
  9291 00002753 A3[D621]                		mov	[ep_start_sector+2], ax
  9292                                  fmpgot2:
  9293 00002756 890E[D821]              		mov	[ep_hidden_secs], cx
  9294 0000275A A3[DA21]                		mov	[ep_hidden_secs+2], ax
  9295                                  		
  9296                                  		; convert start sector address to CHS
  9297                                  	
  9298                                  		; 19/12/2023
  9299                                  		; dx = 0
  9300                                  		;push	bx ; * ; not necessary
  9301                                  
  9302                                  		;mov	bx, [di+13h]	; [di+BDS.secpertrack]
  9303 0000275D 8B7513                  		mov	si, [di+13h]	; [di+BDS.secpertrack]
  9304                                  		;xor	dx, dx  ; dx = 0
  9305                                  		;div	bx
  9306 00002760 F7F6                    		div	si
  9307 00002762 91                      		xchg	ax, cx
  9308                                  		;div	bx
  9309 00002763 F7F6                    		div	si
  9310 00002765 8B5D15                  		mov	bx, [di+15h]	; [di+BDS.heads]
  9311 00002768 91                      		xchg	ax, cx
  9312 00002769 31D2                    		xor	dx, dx
  9313                                  		;div	bx
  9314 0000276B F7F6                    		div	si
  9315 0000276D 91                      		xchg	ax, cx
  9316                                  		;div	bx
  9317 0000276E F7F6                    		div	si
  9318                                  
  9319                                  		;pop	bx ; *
  9320                                  
  9321 00002770 09C9                    		or	cx, cx
  9322 00002772 7505                    		jnz	short fmpgot_lba_rd
  9323 00002774 3D0004                  		cmp	ax, 1024	; cylinder number < 1024, CHS read is proper
  9324 00002777 7235                    		jb	short fmpgot_chs_rd
  9325                                  fmpgot_lba_rd:
  9326 00002779 804D4004                		or	byte [di+40h], 4 ; set fLBArw flag ; LBA read/write ok/ready
  9327 0000277D 8A16[4E1A]              		mov	dl, [rom_minidisk_num]
  9328 00002781 1E                      		push	ds
  9329                                  		; 19/12/2023
  9330                                  		;push	si ; ** ; not necessary 
  9331 00002782 31C0                    		xor	ax, ax		; push bp
  9332                                  				        ; mov bp, sp ; (*)
  9333 00002784 50                      		push	ax ; 0
  9334 00002785 50                      		push	ax ; 0
  9335 00002786 FF36[DA21]              		push	word [ep_hidden_secs+2]
  9336 0000278A FF36[D821]              		push	word [ep_hidden_secs]
  9337 0000278E B80002                  		mov	ax, bootbias ; 200h	
  9338                                  		;mov	ax, 200h	; bootbias (buffer offset)
  9339 00002791 06                      		push	es		; buffer segment
  9340 00002792 50                      		push	ax
  9341 00002793 B80100                  		mov	ax, 1
  9342 00002796 50                      		push	ax		; read count
  9343 00002797 B81000                  		mov	ax, 10h		; DAP size = 16
  9344 0000279A 50                      		push	ax
  9345 0000279B 8CD0                    		mov	ax, ss
  9346 0000279D 8ED8                    		mov	ds, ax
  9347 0000279F 89E6                    		mov	si, sp		; ds:si = Disk Address Packet
  9348                                  		
  9349 000027A1 B442                    		mov	ah, 42h		; LBA read
  9350 000027A3 CD13                    		int	13h		; DISK - IBM/MS Extension
  9351                                  					; EXTENDED READ (DL - drive, DS:SI - disk address packet)
  9352                                  		; 19/12/2023	
  9353                                  		;pushf		; PCDOS 7.1 IBMBIO.COM BUG! Erdogan Tan - 08/08/2023
  9354                                  		;add	sp, 16
  9355                                  		;popf		; BUG!
  9356                                  					; mov sp, bp ; (*)
  9357                                  					; pop bp
  9358                                  		; 19/12/2023
  9359 000027A5 9F                      		lahf		; load status flags into AH
  9360 000027A6 83C410                  		add	sp, 16
  9361 000027A9 9E                      		sahf		; store AH into flags
  9362                                  		
  9363                                  		;pop	si ; ** ; 19/12/2023
  9364 000027AA 1F                      		pop	ds
  9365 000027AB 7317                    		jnc	short fmpgot3
  9366                                  fmpnotfound:	; 19/12/2023
  9367 000027AD C3                      		retn
  9368                                  		;jmp	short fmpgot3 
  9369                                  		;;;
  9370                                  
  9371                                  		; 19/12/2023
  9372                                  fmpgot_chs_rd:
  9373 000027AE 268B4F02                		mov	cx, [es:bx+2]	; cylinder,cylinder/sector
  9374 000027B2 268A7701                		mov	dh, [es:bx+1]	; head
  9375 000027B6 8A16[4E1A]              		mov	dl, [rom_minidisk_num]
  9376 000027BA BB0002                  		mov	bx, 200h	; bootbias
  9377 000027BD B80102                  		mov	ax, 201h
  9378 000027C0 CD13                    		int	13h		; DISK - READ SECTORS INTO MEMORY
  9379                                  					; AL = number of sectors to read, CH = track, CL = sector
  9380                                  					; DH = head, DL	= drive, ES:BX -> buffer to fill
  9381                                  					; Return: CF set on error, AH =	status,	AL = number of sectors read
  9382                                  ;fmpgot3:	; 19/12/2023
  9383                                  		;jc	short fmpnextfound
  9384 000027C2 72E9                    		jc	short fmpnotfound
  9385                                  fmpgot3:	
  9386 000027C4 BBC203                  		mov	bx, 3C2h	; 1C2h+bootbias
  9387                                  
  9388                                  		; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  9389                                  		; PCDOS 7.1 IBMBIO.COM - BIOSDATA:2C7Ch
  9390 000027C7 26817F3C55AA            		cmp	word [es:bx+3Ch], 0AA55h ; 03C2h+03Ch = 3FEh
  9391                                  		;jne	short fmpnextfound ; not a valid boot sector !
  9392                                  		; 19/12/2023
  9393 000027CD 75DE                    		jne	short fmpnotfound ; not a valid boot sector !
  9394                                  
  9395                                  		; 13/08/2023
  9396                                  		;push	es
  9397 000027CF E80800                  		call	setmini		; install a mini disk.
  9398                                  					; bx value saved.
  9399                                  		;pop	es  ; 13/08/2023
  9400 000027D2 7203                    		jc	short fmpnextchain
  9401 000027D4 E84700                  		call	xinstall_bds	; -- install the bdsm into table
  9402                                  fmpnextchain:
  9403 000027D7 E9EBFE                  		jmp	fmpnext		; let's find out
  9404                                  					; if we	have any chained partition
  9405                                  ; ---------------------------------------------------------------------------
  9406                                  
  9407                                  		; 18/12/2022
  9408                                  ;fmpnextfound:
  9409                                  		;retn
  9410                                  
  9411                                  ; =============== S U B	R O U T	I N E =======================================
  9412                                  
  9413                                  ; 15/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
  9414                                  ; 28/12/2018 - Retro DOS v4.0 (MSDOS 6.21)
  9415                                  
  9416                                  ; 19/12/2022 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
  9417                                  ; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2C92h)
  9418                                  
  9419                                  setmini:	; 'setmini' is called from 'find_mini_partition' procedure
  9420                                  	
  9421 000027DA 57                      		push	di
  9422 000027DB 53                      		push	bx
  9423                                  		; 12/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
  9424                                  		; ds = cs = BIOSDATA segment
  9425                                  		;push	ds
  9426 000027DC 06                      		push	es
  9427                                  setmini_1:
  9428                                  		;cmp	byte [es:bx], 1 ; FAT12 partition
  9429                                  		;je	short setmini_2
  9430                                  		;cmp	byte [es:bx], 4 ; FAT16 (CHS) partition
  9431                                  		;je	short setmini_2
  9432                                  		;cmp	byte [es:bx], 6 ; FAT16 BIG (CHS) partition
  9433                                  		;je	short setmini_2
  9434                                  		;
  9435                                  		; 19/12/2023 - Retro DOS v5.0
  9436                                  		;cmp	byte [es:bx], 0Bh ; FAT32 (CHS) partition
  9437                                  		;je	short setmini_2
  9438                                  		;cmp	byte [es:bx], 0Ch ; FAT32 (LBA) partition
  9439                                  		;je	short setmini_2
  9440                                  		;cmp	byte [es:bx], 0Eh ; FAT16 (LBA) partition
  9441                                  		;je	short setmini_2
  9442                                  
  9443                                  		; 19/12/2023
  9444 000027DD 268A07                  		mov 	al, [es:bx]
  9445 000027E0 3C01                    		cmp	al, 1 		; FAT12 partition
  9446 000027E2 7422                    		je	short setmini_2
  9447 000027E4 3C04                    		cmp	al, 4 		; FAT16 (CHS) partition
  9448 000027E6 741E                    		je	short setmini_2
  9449 000027E8 3C06                    		cmp	al, 6 		; FAT16 BIG (CHS) partition
  9450 000027EA 741A                    		je	short setmini_2
  9451 000027EC 3C0B                    		cmp	al, 0Bh 	; FAT32 (CHS) partition
  9452 000027EE 7416                    		je	short setmini_2
  9453 000027F0 3C0C                    		cmp	al, 0Ch 	; FAT32 (LBA) partition
  9454 000027F2 7412                    		je	short setmini_2
  9455 000027F4 3C0E                    		cmp	al, 0Eh 	; FAT16 (LBA) partition
  9456 000027F6 740E                    		je	short setmini_2
  9457                                  
  9458 000027F8 83C310                  		add	bx, 16
  9459 000027FB 81FB0204                		cmp	bx, 402h	; 202h+bootbias
  9460                                  		;jne	short setmini_1
  9461 000027FF 72DC                    		jb	short setmini_1 ; 19/12/2023
  9462 00002801 F9                      		stc
  9463 00002802 07                      		pop	es
  9464                                  		; 12/08/2023
  9465                                  		;pop	ds
  9466 00002803 5B                      		pop	bx
  9467 00002804 5F                      		pop	di
  9468 00002805 C3                      		retn
  9469                                  
  9470                                  ; ---------------------------------------------------------------------------
  9471                                  setmini_2:
  9472 00002806 E9D3F9                  		jmp	set2		; branch into middle of sethard
  9473                                  
  9474                                  ; =============== S U B	R O U T	I N E =======================================
  9475                                  
  9476                                  ; 30/12/2022 - Retro DOS v4.2
  9477                                  ; (SYSINITSEG is 473h for MSDOS 6.21 IO.SYS)
  9478                                  
  9479                                  ; 15/10/2022
  9480                                  ; 28/12/2018 - Retro DOS v4.0
  9481                                  ;
  9482                                  ; dmax_check -- call this when we want to install a new drive.
  9483                                  ;		it checks for drvmax < 26 to see if there is
  9484                                  ;		a drive letter left.
  9485                                  ;
  9486                                  ;	drvmax < 26 : carry SET!
  9487                                  ;	drvmax >=26 : carry RESET!, error flag set for message later
  9488                                  ;			trash ax
  9489                                  
  9490                                  		; 19/12/2023 - Retro DOS v5.0
  9491                                  dmax_check:
  9492 00002809 803E[7500]1A            		cmp	byte [drvmax], 26 ; checks for drvmax < 26
  9493 0000280E 720D                    		jb	short dmax_ok	; return with carry if okay
  9494 00002810 06                      		push	es
  9495                                  		;;mov	ax, 46Dh	; SYSINIT_SEG (SYSINIT segment)
  9496                                  		;mov	ax, 544h	; 19/12/2023 (PCDOS 7.1)
  9497 00002811 B8D704                  		mov	ax, SYSINITSEG	; 17/10/2022	
  9498 00002814 8EC0                    		mov	es, ax
  9499                                  		; 18/10/2022
  9500 00002816 26C606[8803]01          		mov	byte [es:TOOMANYDRIVESFLAG], 1 ; 09/12/2022 
  9501                                  		;mov	byte ptr es:3FFh, 1 ; [es:toomanydrivesflag]
  9502                                  					; set message flag
  9503                                  					; [SYSINIT+toomanydrivesflag]
  9504 0000281C 07                      		pop	es
  9505                                  
  9506                                  		;;push	es
  9507                                  		;;mov	ax,SYSINIT_SEG
  9508                                  		;;mov	es,ax
  9509                                  		;;mov	byte [es:toomanydrivesflag],1
  9510                                  					; set message flag
  9511                                  		;;pop	es
  9512                                  		;
  9513                                  		;mov	byte [SYSINIT+toomanydrivesflag],1
  9514                                  dmax_ok:
  9515 0000281D C3                      		retn
  9516                                  
  9517                                  ; =============== S U B	R O U T	I N E =======================================
  9518                                  
  9519                                  ; 18/10/2022
  9520                                  ; 15/10/2022
  9521                                  ; 28/12/2018 - Retro DOS v4.0
  9522                                  ;
  9523                                  ;	link next bds (at ds:di) into the chain. assume that the
  9524                                  ;	  chain is entirely within ds == datagrp. also update drvmax,
  9525                                  ;	  dskdrv_table, and end_of_bdss.	
  9526                                  
  9527                                  		; 19/12/2023 - Retro DOS v5.0
  9528                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2CE1h)
  9529                                  xinstall_bds:
  9530 0000281E 56                      		push	si
  9531 0000281F 53                      		push	bx
  9532 00002820 8B36[1901]              		mov	si, [start_bds]	; get first bds
  9533                                  xinstall_bds_1:
  9534 00002824 833CFF                  		cmp	word [si], 0FFFFh ; is this the last one?
  9535 00002827 7404                    		jz	short xinstall_bds_2 ;	skip ahead if so
  9536                                  		;mov	si, [si+BDS.link]
  9537 00002829 8B34                    		mov	si, [si]	; chain	through	list
  9538 0000282B EBF7                    		jmp	short xinstall_bds_1
  9539                                  
  9540                                  xinstall_bds_2:
  9541                                  		;mov	[si+BDS.link], di
  9542 0000282D 893C                    		mov	[si], di
  9543                                  		;mov	[si+BDS.link+2], ds
  9544 0000282F 8C5C02                  		mov	[si+2], ds
  9545                                  		;mov	word [di+BDS.link], -1
  9546 00002832 C705FFFF                		mov	word [di], 0FFFFh ; make sure it is a null ptr.
  9547                                  		;mov	[di+BDS.link+2], ds
  9548 00002836 8C5D02                  		mov	[di+2], ds ; might as well plug segment
  9549                                  		; 20/03/2019 - Retro DOS v4.0
  9550                                  		;lea	bx, [di+BDS.BPB]
  9551 00002839 8D5D06                  		lea	bx, [di+6]
  9552 0000283C 8B36[501A]              		mov	si, [last_dskdrv_table]
  9553 00002840 891C                    		mov	[si], bx
  9554 00002842 8306[501A]02            		add	word [last_dskdrv_table], 2
  9555 00002847 FE06[7500]              		inc	byte [drvmax]
  9556                                  		;add	word [end_of_bdss], 100 ; BDS.size = 100
  9557                                  		; 19/12/2023 - Retro DOS v5.0
  9558 0000284B 8106[521A]9600          		add	word [end_of_bdss], 150 ; BDS.size = 150
  9559 00002851 5B                      		pop	bx
  9560 00002852 5E                      		pop	si
  9561 00002853 C3                      		retn
  9562                                  
  9563                                  ; =============== S U B	R O U T	I N E =======================================
  9564                                  
  9565                                  ; 17/10/2022
  9566                                  ; 15/10/2022
  9567                                  ; 28/12/2018 - Retro DOS v4.0
  9568                                  ; 03/06/2018 - Retro DOS v3.0
  9569                                  
  9570                                  		; 19/12/2023 - Retro DOS v5.0
  9571                                  cmos_clock_read:
  9572 00002854 50                      		push	ax
  9573 00002855 51                      		push	cx
  9574 00002856 52                      		push	dx
  9575 00002857 55                      		push	bp
  9576 00002858 31ED                    		xor	bp, bp
  9577                                  loop_clock:
  9578 0000285A 31C9                    		xor	cx, cx
  9579 0000285C 31D2                    		xor	dx, dx
  9580 0000285E B402                    		mov	ah, 2
  9581 00002860 CD1A                    		int	1Ah		; CLOCK	- READ REAL TIME CLOCK (AT,XT286,CONV,PS)
  9582                                  					; Return: CH = hours in	BCD
  9583                                  					; CL = minutes in BCD
  9584                                  					; DH = seconds in BCD
  9585                                  		; 19/12/2023
  9586                                  		;cmp	cx, 0
  9587 00002862 21C9                    		and	cx, cx
  9588 00002864 750F                    		jnz	short clock_present
  9589                                  		;cmp	dx, 0
  9590 00002866 09D2                    		or	dx, dx
  9591 00002868 750B                    		jnz	short clock_present
  9592                                  		;cmp	bp, 1		; read again after a slight delay, in case clock
  9593                                  		;je	short no_readdate ; was	at zero	setting.
  9594 0000286A 21ED                    		and	bp, bp
  9595 0000286C 751A                    		jnz	short no_readdate
  9596 0000286E 45                      		inc	bp		; only perform delay once.
  9597                                  		;mov	cx, 4000h	; 16384
  9598                                  		; 19/12/2023
  9599 0000286F B540                    		mov	ch, 40h ; cx = 4000h ; 16384
  9600                                  delay:					
  9601 00002871 E2FE                    		loop	delay
  9602 00002873 EBE5                    		jmp	short loop_clock
  9603                                  ; ---------------------------------------------------------------------------
  9604                                  
  9605                                  clock_present:
  9606                                  		;mov	byte [cs:havecmosclock], 1 ; set the flag for cmos clock
  9607                                  		; 19/12/2023
  9608                                  		; ds = cs
  9609 00002875 C606[8C04]01            		mov	byte [havecmosclock], 1 ; set the flag for cmos clock
  9610                                  		
  9611 0000287A E81000                  		call	cmosck		; reset	cmos clock rate	that may be
  9612                                  					; possibly destroyed by	cp dos and
  9613                                  					; post routine did not restore that.
  9614 0000287D 56                      		push	si
  9615 0000287E E8EAEF                  		call	read_real_date	; read real-time clock for date
  9616 00002881 FA                      		cli
  9617                                  		;mov	ds:daycnt, si	; set system date
  9618 00002882 8936[8904]              		mov	[daycnt], si
  9619 00002886 FB                      		sti
  9620 00002887 5E                      		pop	si
  9621                                  no_readdate:
  9622 00002888 5D                      		pop	bp
  9623 00002889 5A                      		pop	dx
  9624 0000288A 59                      		pop	cx
  9625 0000288B 58                      		pop	ax
  9626                                  cmosck9:	; 19/12/2023
  9627 0000288C C3                      		retn
  9628                                  
  9629                                  ; ---------------------------------------------------------------------------
  9630                                  
  9631                                  ; the following code is written by jack gulley in engineering group.
  9632                                  ; cp dos (CP/DOS, OS/2) is changing cmos clock rate for its own purposes
  9633                                  ; and if the use cold boot the system to use pc dos while running cp dos,
  9634                                  ; the cmos clock rate are still slow which slow down disk operations
  9635                                  ; of pc dos which uses cmos clock. pc dos is put this code in msinit
  9636                                  ; to fix this problem at the request of cp dos.
  9637                                  ;
  9638                                  ; the program is modified to be run on msinit. equates are defined
  9639                                  ; in cmosequ.inc. this program will be called by cmos_clock_read procedure.
  9640                                  ;
  9641                                  ;  the following code cmosck is used to insure that the cmos has not
  9642                                  ;	had its rate controls left in an invalid state on older at's.
  9643                                  ;
  9644                                  ;	it checks for an at model byte "fc" with a submodel type of
  9645                                  ;	00, 01, 02, 03 or 06 and resets the periodic interrupt rate
  9646                                  ;	bits in case post has not done it. this initilization routine
  9647                                  ;	is only needed once when dos loads. it should be run as soon
  9648                                  ;	as possible to prevent slow diskette access.
  9649                                  ;
  9650                                  ;	this code exposes one to dos clearing cmos setup done by a
  9651                                  ;	resident program that hides and re-boots the system.
  9652                                  
  9653                                  cmosck:					; check and reset rtc rate bits
  9654                                  
  9655                                  ;model byte and submodel byte were already determined in msinit.
  9656                                  
  9657                                  	; 16/06/2018 - Retro DOS v3.0
  9658                                  	; 19/03/2018 (Model: 0FCh, Sub Model: 01h, REF: AMIBIOS Prog. Guide)
  9659                                  
  9660                                  	; 19/12/2023 - Retro DOS v5.0
  9661                                  	
  9662                                  		; 19/12/2023
  9663                                  		; ds = cs
  9664                                  		;push	ax ; not necessary ; 19/12/2023
  9665                                  		;
  9666 0000288D 803E[AF05]FC            		cmp	byte [model_byte], 0FCh
  9667                                  		;cmp	byte [cs:model_byte], 0FCh
  9668 00002892 75F8                    		jnz	short cmosck9	; Exit if not an AT model
  9669 00002894 2E803E[B005]06          		cmp	byte [cs:secondary_model_byte], 6
  9670                                  		;cmp	byte [cs:secondary_model_byte], 6
  9671                                  					; Is it 06 for the industral AT ?
  9672 0000289A 7407                    		jz	short cmosck4	; Go reset CMOS periodic rate if 06
  9673 0000289C 803E[B005]04            		cmp	byte [secondary_model_byte], 4
  9674                                  		;cmp	byte [cs:secondary_model_byte], 4
  9675                                  					; Is it 00, 01, 02, or 03 ?
  9676 000028A1 73E9                    		jnb	short cmosck9	; EXIT if problem fixed by POST
  9677                                  					; Also,Secondary_model_byte = 0
  9678                                  					;   when AH=0C0h, int 15h failed.
  9679                                  					;	RESET THE CMOS PERIODIC RATE
  9680                                  					;  Model=FC submodel=00,01,02,03 or 06
  9681                                  cmosck4:
  9682 000028A3 B08A                    		mov	al, 8Ah		; cmos_reg_a|nmi
  9683                                  					; NMI disabled on return
  9684 000028A5 B426                    		mov	ah, 26h		; 00100110b
  9685                                  					; Set divider & rate selection
  9686 000028A7 E80B00                  		call	cmos_write
  9687 000028AA B08B                    		mov	al, 8Bh		; cmos_reg_b|nmi
  9688                                  					; NMI disabled on return
  9689 000028AC E82000                  		call	cmos_read
  9690 000028AF 2407                    		and	al, 7		; 00000111b
  9691                                  					; clear SET,PIE,AIE,UIE,SQWE
  9692 000028B1 88C4                    		mov	ah, al
  9693 000028B3 B00B                    		mov	al, 0Bh		; cmos_reg_b
  9694                                  					; NMI enabled on return
  9695                                  		; 19/12/2023
  9696                                  		;call	cmos_write
  9697                                  ;cmosck9:
  9698                                  		;pop	ax ; 19/12/2023
  9699                                  		;retn
  9700                                  
  9701                                  		; 19/12/2023
  9702                                  		;jmp	short cmos_write
  9703                                  
  9704                                  ; =============== S U B	R O U T	I N E =======================================
  9705                                  
  9706                                  ;--- cmos_write ----------------------------------------------------------------
  9707                                  ;		write byte to cmos system clock configuration table	       :
  9708                                  ;									       :
  9709                                  ; input: (al)=	cmos table address to be written to			       :
  9710                                  ;		bit    7 = 0 for nmi enabled and 1 for nmi disabled on exit    :
  9711                                  ;		bits 6-0 = address of table location to write		       :
  9712                                  ;	 (ah)=	new value to be placed in the addressed table location	       :
  9713                                  ;									       :
  9714                                  ; output:	value in (ah) placed in location (al) with nmi left disabled   :
  9715                                  ;		if bit 7 of (al) is on. during the cmos update both nmi and    :
  9716                                  ;		normal interrupts are disabled to protect cmos data integrity. :
  9717                                  ;		the cmos address register is pointed to a default value and    :
  9718                                  ;		the interrupt flag restored to the entry state on return.      :
  9719                                  ;		only the cmos location and the nmi state is changed.	       :
  9720                                  ;-------------------------------------------------------------------------------
  9721                                  
  9722                                  cmos_write:				; write (ah) to location (al)
  9723 000028B5 9C                      		pushf			;
  9724 000028B6 50                      		push	ax		; save work register values
  9725 000028B7 FA                      		cli
  9726 000028B8 50                      		push	ax		; save user nmi	state
  9727 000028B9 0C80                    		or	al, 80h		; disable nmi for us
  9728 000028BB E670                    		out	70h, al		; CMOS Memory/RTC Index	Register:
  9729                                  					; RTC Seconds
  9730 000028BD 90                      		nop
  9731 000028BE 88E0                    		mov	al, ah
  9732 000028C0 E671                    		out	71h, al		; CMOS Memory/RTC Data Register
  9733 000028C2 58                      		pop	ax		; get user nmi
  9734 000028C3 2480                    		and	al, 80h
  9735 000028C5 0C0F                    		or	al, 0Fh
  9736 000028C7 E670                    		out	70h, al		; CMOS Memory/RTC Index	Register:
  9737                                  					; RTC Seconds
  9738 000028C9 90                      		nop
  9739 000028CA E471                    		in	al, 71h		; CMOS Memory/RTC Data Register
  9740 000028CC 58                      		pop	ax		; restore work registers
  9741                                  
  9742                                  		; 19/12/2023
  9743                                  		;push	cs		; *place code segment in stack and
  9744                                  		;call	cmos_popf	; *handle popf for b- level 80286
  9745                                  		;retn
  9746 000028CD EB1A                    		jmp	short cmos_rw_popf
  9747                                  
  9748                                  ; =============== S U B	R O U T	I N E =======================================
  9749                                  
  9750                                  ;--- CMOS_READ -----------------------------------------------------------------
  9751                                  ;		read byte from cmos system clock configuration table	       :
  9752                                  ;									       :
  9753                                  ; input: (al)=	cmos table address to be read				       :
  9754                                  ;		bit    7 = 0 for nmi enabled and 1 for nmi disabled on exit    :
  9755                                  ;		bits 6-0 = address of table location to read		       :
  9756                                  ;									       :
  9757                                  ; output: (al)	value at location (al) moved into (al). if bit 7 of (al) was   :
  9758                                  ;		on then nmi left disabled. during the cmos read both nmi and  :
  9759                                  ;		normal interrupts are disabled to protect cmos data integrity. :
  9760                                  ;		the cmos address register is pointed to a default value and    :
  9761                                  ;		the interrupt flag restored to the entry state on return.      :
  9762                                  ;		only the (al) register and the nmi state is changed.	       :
  9763                                  ;-------------------------------------------------------------------------------
  9764                                  
  9765                                  cmos_read:				; read location (al) into (al)
  9766 000028CF 9C                      		pushf
  9767 000028D0 FA                      		cli
  9768 000028D1 53                      		push	bx
  9769 000028D2 50                      		push	ax		; AL = cmos table address to be read
  9770 000028D3 0C80                    		or	al, 80h
  9771 000028D5 E670                    		out	70h, al		; CMOS Memory/RTC Index	Register:
  9772                                  					; RTC Seconds
  9773 000028D7 90                      		nop			; (undocumented delay needed)
  9774 000028D8 E471                    		in	al, 71h		; CMOS Memory/RTC Data Register
  9775 000028DA 89C3                    		mov	bx, ax
  9776 000028DC 58                      		pop	ax
  9777 000028DD 2480                    		and	al, 80h
  9778 000028DF 0C0F                    		or	al, 0Fh
  9779 000028E1 E670                    		out	70h, al		; CMOS Memory/RTC Index	Register:
  9780                                  					; RTC Seconds
  9781 000028E3 90                      		nop
  9782 000028E4 E471                    		in	al, 71h		; CMOS Memory/RTC Data Register
  9783 000028E6 89D8                    		mov	ax, bx
  9784 000028E8 5B                      		pop	bx
  9785                                  
  9786                                  		; 19/12/2023
  9787                                  cmos_rw_popf:
  9788 000028E9 0E                      		push	cs		; *place code segment in stack and
  9789 000028EA E80100                  		call	cmos_popf	; *handle popf for b- level 80286
  9790 000028ED C3                      		retn			; return with flags restored
  9791                                  
  9792                                  ; ---------------------------------------------------------------------------
  9793                                  
  9794                                  cmos_popf:				
  9795 000028EE CF                      		iret			; popf for level b- parts
  9796                                  					; return far and restore flags
  9797                                  
  9798                                  ; 21/12/2022
  9799                                  ; ---------------------------------------------------------------------------
  9800                                  ; ---------------------------------------------------------------------------
  9801                                  %if 0
  9802                                  
  9803                                  ; ---------------------------------------------------------------------------
  9804                                  ; MSINIT.ASM (MSDOS 6.0, 1991)
  9805                                  ; ---------------------------------------------------------------------------
  9806                                  ; The following routines provide support for reading in the file MSDOS.SYS.
  9807                                  ; ---------------------------------------------------------------------------
  9808                                  
  9809                                  ; 15/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
  9810                                  ;
  9811                                  ; (For Retro DOS, 'IO.SYS' and 'MSDOS.SYS' are already loaded together
  9812                                  ;  at once -as single kernel file- by the Retro DOS boot sector code.
  9813                                  ;  So, following disk reads -MSDOS.SYS loading- is not needed!
  9814                                  ;  Only needing is to move MSDOS Kernel to it's final memory location.) 
  9815                                  
  9816                                  ; =============== S U B	R O U T	I N E =======================================
  9817                                  
  9818                                  ; GetClus, read in a cluster at a specified address
  9819                                  ;
  9820                                  ;  bx = cluster to read
  9821                                  ;  cx = sectors per cluster
  9822                                  ;  es:di = load location
  9823                                  
  9824                                  ; 17/10/2022
  9825                                  ;DISKRD equ diskrd - DOSBIOSEG_2C7h	; (8E5h for MSDOS 5.0 IO.SYS)
  9826                                  ; 09/12/2022
  9827                                  DISKRD equ diskrd
  9828                                  
  9829                                  		; 29/12/2023
  9830                                  		; 20/12/2023 - Retro DOS v5.0
  9831                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSDATA:2DC4h)
  9832                                  
  9833                                  		; si:bx = (32 bit) cluster to read
  9834                                  		; cx = sectors per cluster
  9835                                  		; es:di = load location
  9836                                  
  9837                                  		; 17/10/2022
  9838                                  getclus:
  9839                                  		; 12/12/2023
  9840                                  		; ds = cs
  9841                                  		
  9842                                  		push	cx ; 1*
  9843                                  		push	di ; 2*
  9844                                  		;mov	[cs:doscnt], cx
  9845                                  		mov	[doscnt], cx ; 12/12/2023
  9846                                  
  9847                                  		; 20/12/2023
  9848                                  		;;mov	[cs:ClusterH], si ; high word of cluster number
  9849                                  		;mov	[ClusterH], si ; high word of cluster number
  9850                                  		mov	bp, si
  9851                                  
  9852                                  		mov	ax, bx
  9853                                  
  9854                                  		;dec	ax
  9855                                  		;dec	ax
  9856                                  		; 20/12/2023
  9857                                  		sub	ax, 2
  9858                                  
  9859                                  		;;sbb	[cs:ClusterH], 0
  9860                                  		;sbb	[ClusterH], 0
  9861                                  		sbb	bp, 0		
  9862                                  
  9863                                  		; 20/12/2023
  9864                                  		;;xchg	ax, [cs:ClusterH]
  9865                                  		;xchg	ax, [ClusterH]
  9866                                  		xchg	ax, bp
  9867                                  
  9868                                  		mul	cx
  9869                                  
  9870                                  		;;xchg	ax, [cs:ClusterH]
  9871                                  		;xchg	ax, [ClusterH]
  9872                                  		xchg	ax, bp ; (+)
  9873                                  		;
  9874                                  		mul	cx		;; convert to logical sector
  9875                                  					;; dx:ax = matching logical sector number
  9876                                  					;;	  starting from the data sector
  9877                                  		;;add	ax, [cs:bios_l]
  9878                                  		;;adc	dx, [cs:bios_h]	; dx:ax	= first	logical	sector to read
  9879                                  		; 12/12/2023
  9880                                  		;add	ax, [bios_l]
  9881                                  		;adc	dx, [bios_h]	; dx:ax	= first	logical	sector to read
  9882                                  
  9883                                  		; 20/12/2023
  9884                                  		;;add	dx, [cs:ClusterH]
  9885                                  		;add	ax, [cs:First_Data_Sector]
  9886                                  		;adc	dx, [cs:First_Data_Sector+2]
  9887                                  		add	dx, bp ; (+)
  9888                                  		;add	dx, [ClusterH]	; convert to logical sector
  9889                                  					; dx:ax	= matching logical sector number
  9890                                  					;	  starting from the data sector
  9891                                  		add	ax, [First_Data_Sector]
  9892                                  		adc	dx, [First_Data_Sector+2]
  9893                                  					; dx:ax = first logical sector to read
  9894                                  unpack:
  9895                                  		; 20/12/2023
  9896                                  		push	ds ; 3* ; ds = cs ; 12/12/2023
  9897                                  		push	dx ; 4* ; * ; 12/12/2023
  9898                                  		push	ax ; 5*
  9899                                  		; 29/12/2023
  9900                                  		push	si ; 6* 
  9901                                  		push	bx ; 7*
  9902                                  
  9903                                  		;;mov	si, [cs:fatloc]
  9904                                  		;mov	si, [fatloc] ; 12/12/2023
  9905                                  		;mov	ds, si
  9906                                  		; 20/12/2023
  9907                                  		;mov	ax, [fatloc]
  9908                                  		;mov	ds, ax
  9909                                  		push	bx ; 8*
  9910                                  		push	word [fatloc] ; 9*
  9911                                  
  9912                                  		;test	byte [cs:fbigfat], 20h
  9913                                  		test	byte [fbigfat], 20h	; fbigbig FAT32 ?
  9914                                  		pop	ds ; 9* ; ds = [fatloc]
  9915                                  		jz      short not_32bit_cluster ; no
  9916                                  unpack32:
  9917                                  		;push	dx
  9918                                  		mov	dx, si
  9919                                  		;mov	si, bx
  9920                                  		pop	si ; 8* ; si = bx
  9921                                  		add	si, si
  9922                                  		adc	dx, dx
  9923                                  		add	si, si
  9924                                  		adc	dx, dx 
  9925                                  			; dx:si = 4*(si:bx) ; clust num offset from FAT entry 0
  9926                                  		call	get_fat_sector
  9927                                  		mov	si, [bx+2]	; high word of the FAT32 cluster number
  9928                                  		mov	bx, [bx]	; low word of the FAT32 cluster number
  9929                                  		;pop	dx
  9930                                  		jmp	short getcl1
  9931                                  
  9932                                  not_32bit_cluster:
  9933                                  		;mov	si, bx		; next cluster
  9934                                  		pop	si ; 8* ; si = bx
  9935                                  		test	byte [cs:fbigfat], 40h	; fbig
  9936                                  					; 16 bit fat?
  9937                                  		jnz	short unpack16	; yes
  9938                                  unpack12:
  9939                                  		shr	si, 1		; 12 bit fat. si = si/2
  9940                                  					; si = clus + clus/2
  9941                                  		add	si, bx		;
  9942                                  					; (si =	byte offset of the cluster in the FAT)
  9943                                  		;push	dx ; 12/12/2023
  9944                                  		xor	dx, dx
  9945                                  		; 12/12/2023
  9946                                  		; ds = FAT buffer segment
  9947                                  		call	get_fat_sector
  9948                                  		;pop	dx ; 12/12/2023
  9949                                  
  9950                                  		mov	ax, [bx]	; save it into ax
  9951                                  		jnz	short even_odd	; if not a splitted fat, check even-odd.
  9952                                  		; 25/06/2023
  9953                                  		;mov	al, [bx]	; splitted fat
  9954                                  		
  9955                                  		; 12/12/2023
  9956                                  		;mov	[cs:temp_cluster], al
  9957                                  		push	ax ; **	; al = low 8 bits of 12 bits cluster number
  9958                                  
  9959                                   		inc	si		; (next	byte)
  9960                                  
  9961                                  		;push	dx ; 12/12/2023
  9962                                  		xor	dx, dx
  9963                                  		call	get_fat_sector
  9964                                  		;pop	dx ; 12/12/2023
  9965                                  
  9966                                  		;mov	al, ds:0
  9967                                  		; 12/12/2023
  9968                                  		; ds = FAT buffer segment
  9969                                  		;mov	al, [0] ; 19/10/2022
  9970                                  		;mov	[cs:temp_cluster+1], al
  9971                                  		;mov	ax, [cs:temp_cluster]
  9972                                  		; 12/12/2023
  9973                                  		;mov	al, [cs:temp_cluster]
  9974                                  		pop	ax  ; ** ; al = low 8 bits of 12 bits cluster number
  9975                                  		mov	ah, [0] ; high 4 bits (bits 7 to 11) of 12 bits cluster num
  9976                                  even_odd:
  9977                                  		; 29/12/2023
  9978                                  		pop	bx ; 7*		; restore old fat entry	value
  9979                                  		push	bx		; save it right	away.
  9980                                  		shr	bx, 1		; was it even or odd?
  9981                                  		jnc	short havclus	; it was even.
  9982                                  		shr	ax, 1		; odd. massage fat value and keep
  9983                                  					; the highest 12 bits.
  9984                                  		shr	ax, 1
  9985                                  		shr	ax, 1
  9986                                  		shr	ax, 1
  9987                                  havclus:
  9988                                  		mov	bx, ax		; now bx = new fat entry.
  9989                                  		and	bx, 0FFFh	; keep low 12 bits.
  9990                                  		jmp	short unpackx
  9991                                  ; ---------------------------------------------------------------------------
  9992                                  
  9993                                  unpack16:
  9994                                  		;push	dx	; 12/12/2023
  9995                                  		xor	dx, dx ; 0
  9996                                  		shl	si, 1		; extend to 32 bit offset
  9997                                  		;adc	dx, 0
  9998                                  		; 12/12/2023
  9999                                  		rcl	dx, 1
 10000                                  
 10001                                  		; 12/12/2023
 10002                                  		; ds = FAT buffer segment
 10003                                  		call	get_fat_sector
 10004                                  		;pop	dx	; 12/12/2023
 10005                                  		mov	bx, [bx]	;
 10006                                  					; bx = new fat entry.
 10007                                  unpackx:
 10008                                  		; 20/12/2023
 10009                                  		xor	si, si		; high word of cluster number = 0
 10010                                  					; (FAT12 or FAT16)
 10011                                  getcl1:
 10012                                  		; 29/12/2023
 10013                                  		pop	ax	; 7* - cluster number lw
 10014                                  		;pop	word [cs:ClusterH]
 10015                                  		pop	dx	; 6* - cluster number hw
 10016                                  
 10017                                  		; 20/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 10018                                  		; (this is a fast kernel loading method by the MSDOS programmer)
 10019                                  		; ((consequtive clusters --> consequtive sectors))
 10020                                  
 10021                                  		sub	ax, bx	; previous - current (or current - new)	
 10022                                  		;sbb	[cs:ClusterH], si
 10023                                  		sbb	dx, si
 10024                                  		;;cmp	[cs:ClusterH], -1 ; one apart? (current = previous+1)
 10025                                  		;cmp	dx, -1
 10026                                  		; 29/12/2023
 10027                                  		inc	dx ; -1 -> 0
 10028                                  		jnz	short not_consequental
 10029                                  		;cmp	ax, -1		; 0FFFFh ; is [ClusterH]:ax = -1 ?
 10030                                  		inc	ax ; -1 -> 0
 10031                                  not_consequental:
 10032                                  		pop	ax ; 5* 	; restore logical sector (low)
 10033                                  		pop	dx ; 4* ; * ; 12/12/2023
 10034                                  		pop	ds ; 3*
 10035                                  
 10036                                  		;; 12/12/2023
 10037                                  		;; (this is a fast kernel loading method by the MSDOS programmer)
 10038                                  		;; ((consequtive clusters --> consequtive sectors))
 10039                                  		;; ds = cs
 10040                                  		;sub	si, bx
 10041                                  		;cmp	si, -1		; one apart? (consequtive?)
 10042                                  		;			; (current = previous+1)
 10043                                  
 10044                                  		jnz	short getcl2	; no, read [doscnt] sectors 
 10045                                  
 10046                                  		;add	[cs:doscnt], cx ; (cx = sectors per cluster)
 10047                                  		add	[doscnt], cx ; 12/12/2023 ; add to read count
 10048                                  		jmp	unpack
 10049                                  ; ---------------------------------------------------------------------------
 10050                                  
 10051                                  getcl2:
 10052                                  		push	si ; 20/12/2023
 10053                                  		push	bx	
 10054                                  		; bx = low word of the new cluster number
 10055                                  		; 20/12/2023 - Retro DOS v5.0 (32 bit cluster numbers)
 10056                                  		; si = high word of the new cluster number
 10057                                  		push	dx		; sector to read (high word)
 10058                                  		push	ax		; sector to read (low word)
 10059                                  		
 10060                                  		; 12/12/2023
 10061                                  		; ds = cs
 10062                                  		;mov	ax, [cs:drvfat]	; get drive and	fat spec
 10063                                  		;mov	cx, [cs:doscnt]
 10064                                  		mov	ax, [drvfat]	; get drive and	fat spec
 10065                                  
 10066                                  		;;;
 10067                                  		; 20/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 10068                                  		;
 10069                                  		; dma and segment (64K boundary) overrun precaution
 10070                                  		; (sector count will be decreased if it is required)
 10071                                   		mov	cx, di
 10072                                  		not	cx		; cx = 65535 - cx
 10073                                  		shr	cx, 1		; cx = cx/2
 10074                                  		xor	cl, cl
 10075                                  		xchg	cl, ch		; cx = cx/256
 10076                                  		
 10077                                  		;cmp	cx, [cs:doscnt]	
 10078                                  				; if sector read count > cx, decrease it to cx
 10079                                  		cmp	cx, [doscnt]
 10080                                  		jbe	short getcl3
 10081                                  		;;;
 10082                                  		;mov	cx, [cs:doscnt]
 10083                                  		mov	cx, [doscnt]
 10084                                  getcl3:
 10085                                  		pop	dx		; sector to read for diskrd (low)
 10086                                  		;pop	word [cs:start_sec_h]
 10087                                  		; 12/12/2023
 10088                                  		pop	word [start_sec_h]
 10089                                  					; sector to read for diskrd (high)
 10090                                  		; 12/12/2023
 10091                                  		; ds = cs
 10092                                  		;push	ds
 10093                                  		;push	cs
 10094                                  		;pop	ds
 10095                                  		
 10096                                  		push	cs		; simulate far call
 10097                                  
 10098                                  		; 20/12/2023
 10099                                  		; 17/10/2022
 10100                                  		mov	bp, DISKRD	; offset diskrd
 10101                                  		;mov	bp, 0A2Bh	; 20/12/2023
 10102                                  		;	(PCDOS 7.1 IBMBIO.COM - BIOSCODE:0A2Bh ; 364h:0A2Bh)
 10103                                  		;mov	bp, 8E5h	; 17/10/2022
 10104                                  					; 2C7h:8E5h = 70h:2E55h
 10105                                  
 10106                                  		call	call_bios_code	; read the clusters
 10107                                  		
 10108                                  		;pop	ds
 10109                                  		; 12/12/2023
 10110                                  		; ds = cs
 10111                                  		pop	bx		; lw of the new cluster number
 10112                                  		pop	si ; 20/12/2023 ; hw of the new cluster number
 10113                                  
 10114                                  		pop	di ; 2* - (kernel) load location (es:di)
 10115                                  
 10116                                  		;mov	ax, [cs:doscnt]	; get number of	sectors	read
 10117                                  		; 12/12/2023
 10118                                  		mov	ax, [doscnt]
 10119                                  		xchg	ah, al		; multiply by 256
 10120                                  		shl	ax, 1		; times	2 equal	512
 10121                                  		add	di, ax		; update load location
 10122                                  
 10123                                  		pop	cx ; 1*		; restore sectors/cluster
 10124                                  
 10125                                  		retn
 10126                                  
 10127                                  ; =============== S U B	R O U T	I N E =======================================
 10128                                  
 10129                                  ;function: find and read the corresponding fat sector into ds:0
 10130                                  ;
 10131                                  ;in). dx:si - offset value (starting from fat entry 0) of fat entry to find. M054
 10132                                  ;     ds - fatloc segment
 10133                                  ;     cs:drvfat - logical drive number, fat id
 10134                                  ;     cs:md_sectorsize
 10135                                  ;     cs:last_fat_secnum - last fat sector number read in.
 10136                                  ;
 10137                                  ;out). corresponding fat sector read in.
 10138                                  ;      bx = offset value from fatlog segment.
 10139                                  ;      other registers are saved.
 10140                                  ;      zero flag set if the fat entry is splitted, i.e., when 12 bit fat entry
 10141                                  ;      starts at the last byte of the fat sector. in this case, the caller
 10142                                  ;      should save this byte, and read the next fat sector to get the rest
 10143                                  ;      of the fat entry value. (this will only happen with the 12 bit fat.)
 10144                                  
 10145                                  		; 17/10/2022
 10146                                  get_fat_sector:	
 10147                                  		; 12/12/2023
 10148                                  		; ds = fat buffer segment
 10149                                  
 10150                                  		; 12/12/2023
 10151                                  		;push	ax ; (not necessary)
 10152                                  		push	cx ; read count (sectors per cluster)
 10153                                  		push	di ; IBMDOS.COM/MSDOS.SYS load offset
 10154                                  		push	si ; FAT offset value (from fat entry 0)
 10155                                  		push	es ; IBMDOS.COM/MSDOS.SYS load segment
 10156                                  		push	ds ; FAT buffer segment
 10157                                  
 10158                                  		; 12/12/2023
 10159                                  		push	cs
 10160                                  		pop	ds
 10161                                  	
 10162                                  		mov	ax, si
 10163                                  		;;mov	cx, [cs:md_sectorsize] ; 512
 10164                                  		; 12/12/2023
 10165                                  		;mov	cx, [md_sectorsize] ; 512
 10166                                  		;div	cx		; ax = sector number, dx = offset
 10167                                  		; 12/12/2023
 10168                                  		;nop
 10169                                  
 10170                                  		; 12/12/2023
 10171                                  		div	word [md_sectorsize] ; 512
 10172                                  
 10173                                  		; ax = FAT sector (sequence/index) number
 10174                                  		; dx = cluster number offset
 10175                                  
 10176                                  		; Get rid of the assumption that
 10177                                  		; there	is only	one reserved sector
 10178                                  
 10179                                  		; 12/12/2023 ; *
 10180                                  		;push	es ; *
 10181                                  		;push	ds ; *
 10182                                  		;push	di ; *
 10183                                  		push	ax
 10184                                  		;push	cs ; *
 10185                                  		;pop	ds ; *
 10186                                  
 10187                                  		;mov	ax, [cs:drvfat]	; get drive # and FAT id
 10188                                  		; 12/12/2023
 10189                                  		mov	ax, [drvfat]	; get drive # and FAT id 
 10190                                  		mov	bp, SETDRIVE
 10191                                  		;mov	bp, 5AEh  ; PCDOS 7.1 IBMBIO.COM
 10192                                  		;;mov	bp, 4D7h	; setdrive
 10193                                  					; at 2C7h:4D7h = 70h:2A47h
 10194                                  		push	cs		; simulate far call
 10195                                  		call	call_bios_code	; get bds for drive
 10196                                  		pop	ax		; (sector number -without reserved and hidden sectors-)
 10197                                  		add	ax, [es:di+9]	; [es:di+BDS.resectors]
 10198                                  					; add #reserved_sectors
 10199                                  		; 12/12/2023
 10200                                  		;pop	di ; *
 10201                                  		;pop	ds ; *
 10202                                  		;pop	es ; *
 10203                                  
 10204                                  		; 12/12/2023
 10205                                  		; ds = cs
 10206                                  		cmp	ax, [last_fat_sec_num]
 10207                                  		;cmp	ax, [cs:last_fat_sec_num]
 10208                                  		jz	short gfs_split_chk ; don't need to read it again.
 10209                                  		mov	[last_fat_sec_num], ax
 10210                                  		;mov	[cs:last_fat_sec_num], ax
 10211                                  					; sector number
 10212                                  					; (in the partition, without hidden sectors)
 10213                                  		; 13/12/2023
 10214                                  		pop	es ; FAT buffer segment (DS on top of the stack)
 10215                                  		push	es ; (put it on top of the stack again)
 10216                                  
 10217                                  		push	dx ; cluster number offset
 10218                                  
 10219                                  		; 12/12/2023
 10220                                  		xor	cx, cx
 10221                                  		mov	[start_sec_h], cx ;0 
 10222                                  		;mov	word [cs:start_sec_h], 0 
 10223                                  					; prepare to read the fat sector
 10224                                  					; start_sec_h is always	0 for fat sector.
 10225                                  		mov	dx, ax
 10226                                  		; 12/12/2023
 10227                                  		inc	cx ; cx = 1
 10228                                  		;mov	cx, 1		; 1 sector read
 10229                                  		;mov	ax, [cs:drvfat]
 10230                                  		mov	ax, [drvfat]
 10231                                  		;push	ds
 10232                                  		;pop	es
 10233                                  
 10234                                  		xor	di, di	; 0	; es:di	-> fatloc segment:0
 10235                                  		
 10236                                  		; 12/12/2023
 10237                                  		;push	ds
 10238                                  		;push	cs
 10239                                  		;pop	ds
 10240                                  		
 10241                                  		push	cs		; simulate far call
 10242                                  		mov	bp, DISKRD	; 8E5h
 10243                                  		;mov	bp, 8E5h	; offset diskrd
 10244                                  					; 2C7h:8E5h = 70h:2E55h
 10245                                  		call	call_bios_code
 10246                                  
 10247                                  		; 12/12/2023
 10248                                  		;pop	ds
 10249                                  		; ds = cs = biosdata segment
 10250                                  
 10251                                  		pop	dx ; cluster number offset 
 10252                                  
 10253                                  gfs_split_chk:
 10254                                  		; 13/12/2023
 10255                                  		;mov	cx, [cs:md_sectorsize] ; 512
 10256                                  		mov	cx, [md_sectorsize]
 10257                                  ;gfs_split_chk:					
 10258                                  		dec	cx		; 511
 10259                                  		cmp	dx, cx		; if offset points to the
 10260                                  					; last byte of this sector,
 10261                                  					; then splitted	entry.
 10262                                  		mov	bx, dx		; set bx to dx
 10263                                  		
 10264                                  		; 12/12/2023
 10265                                  		; bx = dx = cluster number offset in the FAT buffer
 10266                                  		pop	ds ; FAT buffer segment
 10267                                  		pop	es ; IBMDOS.COM/MSDOS.SYS load segment
 10268                                  		pop	si ; FAT offset value (from fat entry 0)
 10269                                  		pop	di ; IBMDOS.COM/MSDOS.SYS load offset
 10270                                  		pop	cx ; read count (sectors per cluster)
 10271                                  		;pop	ax
 10272                                  
 10273                                  		retn
 10274                                  ; 15/10/2022
 10275                                  ;Bios_Data_Init	ends
 10276                                  
 10277                                  %endif
 10278                                  ; ---------------------------------------------------------------------------
 10279                                  ; ---------------------------------------------------------------------------
 10280                                  
 10281                                  		; 09/12/2022
 10282                                  		;db 0
 10283                                  
 10284                                  numbertodiv	equ ($-BData_start)
 10285                                  numbertomod	equ (numbertodiv % 16)
 10286                                  
 10287                                  %if (numbertomod>0) & (numbertomod<16) ; 17/09/2023
 10288 000028EF 00                      		times (16-numbertomod) db 0
 10289                                  %endif
 10290                                  
 10291                                  ;align 16
 10292                                  
 10293                                  ; 09/12/2022
 10294                                  IOSYSCODESEGOFF equ $ - BData_start
 10295                                  ; 29/09/2023
 10296                                  ;IOSYSCODESEGOFF equ $-$$
 10297                                  IOSYSCODESEG	equ (IOSYSCODESEGOFF>>4)+(700h>>4)
 10298                                  
 10299                                  ; 28/09/2023
 10300                                  S1SIZE equ $-$$
 10301                                  
 10302                                  ;--- End of DOSBIOS data segment --------------------------------------------
 10303                                  ; ---------------------------------------------------------------------------
 10304                                  		;db 4 dup(0)
 10305                                  ; 09/12/2022		
 10306                                  ;		times 4 db 0	; 19/10/2022
 10307                                  ; ---------------------------------------------------------------------------
 10308                                  
 10309                                  ;============================================================================
 10310                                  ; DOS BIOS (IO.SYS) CODE SEGMENT 
 10311                                  ;============================================================================
 10312                                  ; 09/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 10313                                  
 10314                                  section .BIOSCODE vstart=0  
 10315                                  
 10316                                  BCode_start:	 ; 09/12/2022
 10317                                   
 10318                                  ; 02/10/2022
 10319                                  
 10320                                  ;--- DOSBIOS code segment ---------------------------------------------------
 10321                                  ;----------------------------------------------------------------------------
 10322                                  ; MSBIO1.ASM (MSDOS 6.0, 1991)
 10323                                  ;----------------------------------------------------------------------------
 10324                                  
 10325                                  DOSBIOSEG_2C7h:	;db 30h dup(0)		; SEGMENT 2C7h (2C70h-700h=2570h)
 10326 00000000 00<rep 30h>             		times 48 db 0		; 19/10/2022	
 10327 00000030 7000                    BiosDataWord:	dw 70h
 10328                                  
 10329                                  ; 15/10/2022
 10330                                  ;BIOSDATAWORD	equ BiosDataWord - DOSBIOSEG_2C7h
 10331                                  ; 09/12/2022
 10332                                  BIOSDATAWORD	equ BiosDataWord
 10333                                  
 10334                                  ; ---------------------------------------------------------------------------
 10335                                  
 10336                                  ; 15/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 10337                                  ; 20/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
 10338                                  
 10339                                  ;************************************************************************
 10340                                  ;*									*
 10341                                  ;*	seg_reinit is called with ax = our new code segment value,	*
 10342                                  ;*	  trashes di, cx, es						*
 10343                                  ;*									*
 10344                                  ;*	cas -- should be made disposable!				*
 10345                                  ;*									*
 10346                                  ;************************************************************************
 10347                                  
 10348                                  	; 20/09/2023	
 10349                                  	; 10/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 10350                                  	; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0032h 
 10351                                  
 10352                                  _seg_reinit:
 10353 00000032 2E8E06[3000]            		mov	es, [cs:BIOSDATAWORD]
 10354                                  					; at 2C7h:30h or 70h:25A0h
 10355                                  		;mov	di, (offset cdev+2)
 10356 00000037 BF[0406]                		mov	di, cdev+2	; 19/10/2022
 10357                                  		; 20/09/2023
 10358                                  		;mov	cx, 4		; (end_BC_entries - cdev)/4
 10359                                  		; 10/08/2023
 10360 0000003A B90300                  		mov	cx, 3 ; (PCDOS 7.1)
 10361                                  _seg_reinit_1:
 10362 0000003D AB                      		stosw			; modify Bios_Code entry points
 10363 0000003E 47                      		inc	di
 10364 0000003F 47                      		inc	di
 10365 00000040 E2FB                    		loop	_seg_reinit_1
 10366                                  
 10367                                  		; 10/08/2023 (PCDOS 7.1)
 10368                                  		; (direct jump to i2f_handler from BIOSDATA:bios_i2f)
 10369                                  		; (instead of 'bcode_i2f: dw i2f_handler, IOSYSCODESEG')
 10370                                  		
 10371                                  		; 20/09/2023
 10372 00000042 26A3[0800]              		mov	[es:bios_i2f_seg], ax ; actual BIOSCODE segment
 10373                                  		
 10374 00000046 CB                      		retf
 10375                                  
 10376                                  ; ---------------------------------------------------------------------------
 10377                                  
 10378                                  ; 15/10/2022
 10379                                  
 10380                                  ;************************************************************************
 10381                                  ;*									*
 10382                                  ;*	chardev_entry - main device driver dispatch routine		*
 10383                                  ;*	   called with a dummy parameter block on the stack		*
 10384                                  ;*	   dw dispatch_table, dw prn/aux numbers (optional)		*
 10385                                  ;*									*
 10386                                  ;*	will eventually take care of doing the transitions in		*
 10387                                  ;*	   out of Bios_Code						*
 10388                                  ;*									*
 10389                                  ;************************************************************************
 10390                                  
 10391                                  		; 20/09/2023
 10392                                  chardev_entry:				; 0070h:25B3h =	02C7h:0043h
 10393 00000047 56                      		push	si
 10394 00000048 50                      		push	ax
 10395 00000049 51                      		push	cx
 10396 0000004A 52                      		push	dx
 10397 0000004B 57                      		push	di
 10398 0000004C 55                      		push	bp
 10399 0000004D 1E                      		push	ds
 10400 0000004E 06                      		push	es
 10401 0000004F 53                      		push	bx
 10402 00000050 89E5                    		mov	bp, sp
 10403 00000052 8B7612                  		mov	si, [bp+18]	; get return address (dispatch table)
 10404                                  		;;mov	ds, word [cs:0030h]
 10405                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:0030h]
 10406 00000055 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD] ; 17/10/2022
 10407                                  		; 20/09/2023 (PCDOS 7.1 - IBMBIO.COM - BIOSCODE:005Ah)
 10408 0000005A C434                    		les	si, [si]
 10409                                  		;mov	ax, [si+2]	; get the device number	if present
 10410 0000005C 8CC0                    		mov	ax, es
 10411 0000005E A2[2100]                		mov	[auxnum], al
 10412 00000061 8826[8004]              		mov	[printdev], ah
 10413                                  		;mov	si, [si]	; point	to the device dispatch table
 10414 00000065 C41E[1200]              		les	bx, [ptrsav]	; get pointer to i/o packet
 10415 00000069 268A4701                		mov	al, [es:bx+1]	; [es:bx+unit]	; al = unit code
 10416 0000006D 268A670D                		mov	ah, [es:bx+13]	; [es:bx+media]	; ah = media descrip
 10417 00000071 268B4F12                		mov	cx, [es:bx+18]	; [es:bx+count]	; cx = count
 10418 00000075 268B5714                		mov	dx, [es:bx+20]	; [es:bx+start]	; dx = start sector
 10419                                  		; 17/10/2022
 10420 00000079 81FE[6F05]              		cmp	si, DSKTBL
 10421                                  		;;cmp	si, 579h	; (PCDOS 7.1 IBMBIO.COM)
 10422                                  		;cmp	si, 4A2h	; dsktbl
 10423                                  					; at 2C7h:4A2h = 70h:2A12h
 10424 0000007D 7517                    		jnz	short no_sector32_mapping
 10425                                  
 10426                                  ; Special case for 32-bit start sector number:
 10427                                  ;   if (si==dsktbl) /* if this is a disk device call */
 10428                                  ;      set high 16 bits of secnum to 0
 10429                                  ;      if (secnum == 0xffff) fetch 32 bit sector number
 10430                                  ;
 10431                                  ; pass high word of sector number in start_sec_h, low word in dx
 10432                                  ;
 10433                                  ; note: start_l and start_h are the offsets within the io_request packet
 10434                                  ;	  which contain the low and hi words of the 32 bit start sector if
 10435                                  ;	  it has been used.
 10436                                  ;
 10437                                  ; note: remember not to destroy the registers which have been set up before
 10438                                  
 10439                                  		; 20/09/2023
 10440                                  		;mov	ds:start_sec_h,	0 ; initialize to 0
 10441 0000007F C706[9C04]0000          		mov	word [start_sec_h], 0
 10442 00000085 83FAFF                  		cmp	dx, 0FFFFh
 10443 00000088 750C                    		jnz	short no_sector32_mapping
 10444 0000008A 268B571C                		mov	dx, [es:bx+28]	; [es:bx+start_h]
 10445                                  					; 32 bits dsk req
 10446                                  		;mov	ds:start_sec_h,	dx ; start_sec_h = packet.start_h
 10447 0000008E 8916[9C04]              		mov	[start_sec_h], dx
 10448 00000092 268B571A                		mov	dx, [es:bx+26]	; [es:bx+start_l]
 10449                                  					; dx = packet.start_l
 10450                                  no_sector32_mapping:
 10451 00000096 97                      		xchg	ax, di
 10452 00000097 268A4702                		mov	al, [es:bx+2]	; [es:bx+cmd]
 10453 0000009B 2E3A04                  		cmp	al, [cs:si]
 10454 0000009E 732B                    		jnb	short command_error
 10455 000000A0 98                      		cbw			; note that al <= 15 means ok
 10456 000000A1 D1E0                    		shl	ax, 1
 10457 000000A3 01C6                    		add	si, ax
 10458 000000A5 97                      		xchg	ax, di
 10459 000000A6 26C47F0E                		les	di, [es:bx+14]	; [es:bx+trans]
 10460 000000AA FC                      		cld
 10461                                  		; 17/10/2022
 10462 000000AB 2EFF5401                		call	near [cs:si+1]
 10463                                  		;call	word ptr cs:si+1
 10464 000000AF 7202                    		jb	short already_got_ah_status
 10465 000000B1 B401                    		mov	ah, 1
 10466                                  already_got_ah_status:
 10467                                  		;;mov	ds, [cs:0030h]	; 15/10/2022
 10468                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:0030h]
 10469                                  					; cas note: shouldn't be needed!
 10470 000000B3 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD] ; 17/10/2022
 10471                                  		;lds	bx, ds:ptrsav
 10472 000000B8 C51E[1200]              		lds	bx, [ptrsav]
 10473 000000BC 894703                  		mov	[bx+3],	ax	; [bx+status]
 10474                                  					; mark operation complete
 10475 000000BF 5B                      		pop	bx
 10476 000000C0 07                      		pop	es
 10477 000000C1 1F                      		pop	ds
 10478 000000C2 5D                      		pop	bp
 10479 000000C3 5F                      		pop	di
 10480 000000C4 5A                      		pop	dx
 10481 000000C5 59                      		pop	cx
 10482 000000C6 58                      		pop	ax
 10483 000000C7 5E                      		pop	si
 10484                                  		;add	sp, 2		; get rid of fake return address
 10485                                  		; 20/09/2023 (PCDOS 7.1	- IBMBIO.COM - BIOSCODE:00C8h)
 10486 000000C8 44                      		inc	sp
 10487 000000C9 44                      		inc	sp	
 10488                                  
 10489                                  		; fall through into bc_retf
 10490                                  ; ---------------------------------------------------------------------------	
 10491                                  bc_retf:
 10492 000000CA CB                      		retf
 10493                                  ; ---------------------------------------------------------------------------
 10494                                  
 10495                                  command_error:				
 10496 000000CB E80700                  		call	bc_cmderr
 10497 000000CE EBE3                    		jmp	short already_got_ah_status
 10498                                  ; 15/10/2022
 10499                                  ; 01/05/2019
 10500                                  
 10501                                  ;----------------------------------------------------------------------------
 10502                                  ; The following piece of hack is for supporting CP/M compatibility
 10503                                  ; Basically at offset 5 we have a far call into 0:c0. But this does not call
 10504                                  ; 0:c0 directly instead it call f01d:fef0, because it needs to support 'lhld 6'
 10505                                  ; The following hack has to reside at ffff:d0 (= f01d:fef0) if BIOS is loaded
 10506                                  ; high.
 10507                                  ;----------------------------------------------------------------------------
 10508                                  
 10509                                  
 10510                                  		;db 7 dup(0)
 10511                                  
 10512                                  		; 20/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 10513                                  		; (PCDOS 7.1 - IBMBIO.COM - BIOSCODE:0D0h)
 10514                                  		; 15/10/2022
 10515                                  		;dw 0		; pad to bring offset to 0D0h
 10516                                  
 10517 000000D0 00<rep 5h>              off_d0: 	times 5 db 0	; 5 bytes from 0:c0 will be copied onto here
 10518                                  				;  which is the CP/M call 5 entry point
 10519                                  		
 10520                                  ; ---------------------------------------------------------------------------
 10521                                  
 10522                                  ;	exit - all routines return through this path
 10523                                  
 10524                                  bc_cmderr:				
 10525 000000D5 B003                    		mov	al, 3		; 2C7h:D5h = 70h:2645h
 10526                                  					; unknown command error
 10527                                  
 10528                                  ; =============== S U B	R O U T	I N E =======================================
 10529                                  
 10530                                  ;	now zero the count field by subtracting its current value,
 10531                                  ;	  which is still in cx, from itself.
 10532                                  
 10533                                  ;	subtract the number of i/o's NOT YET COMPLETED from total
 10534                                  ;	  in order to return the number actually complete
 10535                                  
 10536                                  bc_err_cnt:	
 10537                                  		;les	bx, ds:ptrsav
 10538                                  		; 19/10/2022
 10539 000000D7 C41E[1200]              		les	bx, [ptrsav]
 10540 000000DB 26294F12                		sub	[es:bx+18], cx	; [es:bx+count]
 10541                                  					; # of successful i/o's
 10542 000000DF B481                    		mov	ah, 81h		; mark error return
 10543 000000E1 F9                      		stc			; indicate abnormal end
 10544 000000E2 C3                      		retn
 10545                                  
 10546                                  ; 15/10/2022
 10547                                  
 10548                                  ;Bios_Code ends
 10549                                  
 10550                                  ;----------------------------------------------------------------------------
 10551                                  ; MSCHAR.ASM - MSDOS 6.0 - 1991
 10552                                  ;----------------------------------------------------------------------------
 10553                                  ; 15/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 10554                                  ; 10/01/2019 - Retro DOS v4.0
 10555                                  
 10556                                  ; 30/04/2019
 10557                                  
 10558                                  ;title	mschar - character and clock devices
 10559                                  
 10560                                  ;MODE_CTRLBRK	equ	0FFh
 10561                                  
 10562                                  ; BIOSCODE:00E4h (MSDOS 6.21, IO.SYS)
 10563                                  
 10564                                  ;************************************************************************
 10565                                  ;*									*
 10566                                  ;*	device driver dispatch tables					*
 10567                                  ;*									*
 10568                                  ;*	each table starts with a byte which lists the number of		*
 10569                                  ;*	legal functions, followed by that number of words. Each		*
 10570                                  ;*	word represents an offset of a routine in Bios_Code which	*
 10571                                  ;*	handles the function. The functions are terminated with		*
 10572                                  ;*	a near return. If carry is reset, a 'done' code is returned	*
 10573                                  ;*	to the caller. If carry is set, the ah/al registers are		*
 10574                                  ;*	returned as abnormal completion status. Notice that ds		*
 10575                                  ;*	is assumed to point to the Bios_Data segment throughout.	*
 10576                                  ;*									*
 10577                                  ;************************************************************************
 10578                                  
 10579                                  		; 20/09/2023
 10580                                  		; (PCDOS 7.1 - IBMBIO.COM - BIOSCODE:00E3h)
 10581                                  		; 13/12/2022
 10582 000000E3 00                      		db 0
 10583                                  
 10584                                  		; 13/12/2022
 10585 000000E4 0B                      con_table:	db ((con_table_end - con_table)-1)/2 ; 11
 10586                                  					; 2C7h:0E4h = 70h:2654h
 10587 000000E5 [FA01]                  		dw bc_exvec  ; 1FBh	; bc_exvec at 2C7h:1FBh	= 70h:276Bh
 10588                                  					; 00 init
 10589 000000E7 [FA01]                  		dw bc_exvec  ; 1FBh	; 01
 10590 000000E9 [FA01]                  		dw bc_exvec  ; 1FBh	; 02
 10591 000000EB [D500]                  		dw bc_cmderr ; 0D5h	; bc_exvec at 2C7h:D5h = 70h:2645h
 10592                                  					; 03
 10593 000000ED [5C01]                  		dw con_read  ; 15Ch	; con_read at 2C7h:15Ch	= 70h:26CCh
 10594                                  					; 04
 10595 000000EF [9F01]                  		dw con_rdnd  ; 19Fh	; con_rdnd at 2C7h:19Fh	= 70h:270Fh
 10596                                  					; 05
 10597 000000F1 [FA01]                  		dw bc_exvec  ; 1FBh	; 06
 10598 000000F3 [0802]                  		dw con_flush ; 209h	; con_flush at 2C7h:209h = 70h:2779h
 10599                                  					; 07
 10600 000000F5 [FC01]                  		dw con_writ  ; 1FDh	; con_writ at 2C7h:1FDh	= 70h:276Dh
 10601                                  					; 08
 10602 000000F7 [FC01]                  		dw con_writ  ; 1FDh	; 09
 10603 000000F9 [FA01]                  		dw bc_exvec  ; 1FBh	; 0A
 10604                                  con_table_end:
 10605 000000FB 1A                      prn_table:	db ((prn_table_end - prn_table)-1)/2 ; 26			
 10606                                  					; 2C7h:0FBh = 70h:266Bh
 10607 000000FC [FA01]                  		dw bc_exvec   ; 1FBh	; bc_exvec
 10608 000000FE [FA01]                  		dw bc_exvec   ; 1FBh	; 01
 10609 00000100 [FA01]                  		dw bc_exvec   ; 1FBh	; 02
 10610 00000102 [D500]                  		dw bc_cmderr  ;	0D5h	; bc_cmderr
 10611 00000104 [1902]                  		dw prn_input  ;	21Ah	; prn_input
 10612                                  					; 04 indicate zero chars read
 10613 00000106 [C701]                  		dw z_bus_exit ; 1C8h	; z_bus_exit
 10614                                  					; 05 read non-destructive
 10615 00000108 [FA01]                  		dw bc_exvec   ; 1FBh	; 06
 10616 0000010A [FA01]                  		dw bc_exvec   ; 1FBh	; 07
 10617 0000010C [1E02]                  		dw prn_writ   ;	21Fh	; prn_writ
 10618 0000010E [1E02]                  		dw prn_writ   ; 21Fh	; 09
 10619 00000110 [4F02]                  		dw prn_stat   ; 251h	; prn_stat
 10620 00000112 [FA01]                  		dw bc_exvec   ; 1FBh	; 0B
 10621 00000114 [FA01]                  		dw bc_exvec   ; 1FBh	; 0C
 10622 00000116 [FA01]                  		dw bc_exvec   ; 1FBh	; 0D
 10623 00000118 [FA01]                  		dw bc_exvec   ; 1FBh	; 0E
 10624 0000011A [FA01]                  		dw bc_exvec   ; 1FBh	; 0F
 10625 0000011C [9402]                  		dw prn_tilbusy ; 28Bh	; prn_tilbusy
 10626 0000011E [FA01]                  		dw bc_exvec   ; 1FBh	; 11
 10627 00000120 [FA01]                  		dw bc_exvec   ; 1FBh	; 12
 10628 00000122 [C202]                  		dw prn_genioctl ; 2BAh	; prn_genioctl
 10629 00000124 [FA01]                  		dw bc_exvec   ; 1FBh	; 14
 10630 00000126 [FA01]                  		dw bc_exvec   ; 1FBh	; 15
 10631 00000128 [FA01]                  		dw bc_exvec   ; 1FBh	; 16
 10632 0000012A [FA01]                  		dw bc_exvec   ; 1FBh	; 17
 10633 0000012C [FA01]                  		dw bc_exvec   ; 1FBh	; 18
 10634 0000012E [F702]                  		dw prn_ioctl_query ; 2F0h ; prn_ioctl_query
 10635                                  prn_table_end:
 10636 00000130 0B                      aux_table:	db ((aux_table_end - aux_table)-1)/2 ; 11			
 10637                                  					; 2C7h:130h = 70h:26A0h
 10638 00000131 [FA01]                  		dw bc_exvec   ; 1FBh	; 00 - init
 10639 00000133 [FA01]                  		dw bc_exvec   ; 1FBh	; 01
 10640 00000135 [FA01]                  		dw bc_exvec   ; 1FBh	; 02
 10641 00000137 [D500]                  		dw bc_cmderr  ;	0D5h	; 03
 10642 00000139 [1203]                  		dw aux_read   ; 30Dh	; aux_read ; 04	- read
 10643 0000013B [3703]                  		dw aux_rdnd   ; 335h	; aux_rdnd - 05	- read non-destructive
 10644 0000013D [FA01]                  		dw bc_exvec   ; 1FBh	; 06
 10645 0000013F [7803]                  		dw aux_flsh   ;	36Ch	; aux_flsh
 10646 00000141 [7F03]                  		dw aux_writ   ;	374h	; aux_writ
 10647 00000143 [7F03]                  		dw aux_writ   ;	374h	; 09
 10648 00000145 [5703]                  		dw aux_wrst   ;	355h	; aux_wrst
 10649                                  aux_table_end:
 10650 00000147 0A                      tim_table	db ((tim_table_end - tim_table)-1)/2 ; 10
 10651                                  					; 2C7h:147h = 70h:26B7h
 10652 00000148 [FA01]                  		dw bc_exvec   ; 1FBh	; 00
 10653 0000014A [FA01]                  		dw bc_exvec   ; 1FBh	; 01
 10654 0000014C [FA01]                  		dw bc_exvec   ; 1FBh	; 02
 10655 0000014E [D500]                  		dw bc_cmderr  ;	0D5h	; 03
 10656 00000150 [E404]                  		dw tim_read   ;	435h	; tim_read
 10657 00000152 [C701]                  		dw z_bus_exit ; 1C8h	; z_bus_exit
 10658 00000154 [FA01]                  		dw bc_exvec   ; 1FBh	; 06
 10659 00000156 [FA01]                  		dw bc_exvec   ; 1FBh	; 07
 10660 00000158 [E503]                  		dw tim_writ   ; 3DBh	; tim_writ
 10661 0000015A [E503]                  		dw tim_writ   ; 3DBh	; 09
 10662                                  tim_table_end:
 10663                                  
 10664                                  ; ---------------------------------------------------------------------------
 10665                                  
 10666                                  ;************************************************************************
 10667                                  ;*									*
 10668                                  ;*	con_read - read cx bytes from keyboard into buffer at es:di	*
 10669                                  ;*									*
 10670                                  ;************************************************************************
 10671                                  
 10672                                  con_read:				; 2C7h:15Ch = 70h:26CCh
 10673                                  		;jcxz	short con_exit	; read cx bytes	from keyboard into buffer
 10674 0000015C E306                    		jcxz	con_exit	; 19/10/2022
 10675                                  con_loop:				
 10676 0000015E E80500                  		call	chrin		; get char in al
 10677 00000161 AA                      		stosb			; store	char at	es:di
 10678 00000162 E2FA                    		loop	con_loop
 10679                                  con_exit:				
 10680 00000164 F8                      		clc
 10681 00000165 C3                      		retn
 10682                                  
 10683                                  ; =============== S U B	R O U T	I N E =======================================
 10684                                  
 10685                                  ;************************************************************************
 10686                                  ;*									*
 10687                                  ;*	chrin - input single char from keyboard into al			*
 10688                                  ;*									*
 10689                                  ;*	  we are going to issue extended keyboard function, if		*
 10690                                  ;*	  supported. the returning value of the extended keystroke	*
 10691                                  ;*	  of the extended keyboard function uses 0E0h in al		*
 10692                                  ;*	  instead of 00h as in the conventional keyboard function.	*
 10693                                  ;*	  this creates a conflict when the user entered real		*
 10694                                  ;*	  greek alpha charater (= 0E0h) to  distinguish the extended	*
 10695                                  ;*	  keystroke and the greek alpha. this case will be handled	*
 10696                                  ;*	  in the following manner:					*
 10697                                  ;*									*
 10698                                  ;*	      ah = 16h							*
 10699                                  ;*	      int 16h							*
 10700                                  ;*	      if al == 0, then extended code (in ah)			*
 10701                                  ;*	      else if al == 0E0h, then					*
 10702                                  ;*	      if ah <> 0, then extended code (in ah)			*
 10703                                  ;*		else greek_alpha character.				*
 10704                                  ;*									*
 10705                                  ;*	also, for compatibility reason, if an extended code is		*
 10706                                  ;*	  detected, then we are going to change the value in al		*
 10707                                  ;*	  from 0E0h to 00h.						*
 10708                                  ;*									*
 10709                                  ;************************************************************************
 10710                                  
 10711                                  		; 19/10/2022
 10712                                  chrin:		
 10713 00000166 8A26[7E04]              		mov	ah, [keyrd_func] ; set by msinit. 0 or 10h
 10714 0000016A 30C0                    		xor	al, al
 10715 0000016C 8606[0C00]              		xchg	al, [altah]	; get character	& zero altah
 10716 00000170 08C0                    		or	al, al
 10717 00000172 752A                    		jnz	short keyret
 10718 00000174 CD16                    		int	16h		; KEYBOARD -
 10719 00000176 09C0                    		or	ax, ax
 10720 00000178 74EC                    		jz	short chrin
 10721 0000017A 3D0072                  		cmp	ax, 7200h	; check	for ctrl-prtsc
 10722 0000017D 7504                    		jnz	short alt_ext_chk
 10723 0000017F B010                    		mov	al, 10h
 10724 00000181 EB1B                    		jmp	short keyret
 10725                                  ; ---------------------------------------------------------------------------
 10726                                  
 10727                                  ;  if operation was extended function (i.e. keyrd_func != 0) then
 10728                                  ;    if character read was 0E0h then
 10729                                  ;      if extended byte was zero (i.e. ah == 0) then
 10730                                  ;	 goto keyret
 10731                                  ;      else
 10732                                  ;	 set al to zero
 10733                                  ;	 goto alt_save
 10734                                  ;      endif
 10735                                  ;    endif
 10736                                  ;  endif
 10737                                  
 10738                                  alt_ext_chk:
 10739 00000183 803E[7E04]00            		cmp	byte [keyrd_func], 0
 10740 00000188 740C                    		jz	short not_ext
 10741 0000018A 3CE0                    		cmp	al, 0E0h
 10742 0000018C 7508                    		jnz	short not_ext
 10743 0000018E 08E4                    		or	ah, ah
 10744 00000190 740C                    		jz	short keyret
 10745 00000192 30C0                    		xor	al, al
 10746 00000194 EB04                    		jmp	short alt_save
 10747                                  ; ---------------------------------------------------------------------------
 10748                                  
 10749                                  not_ext:				
 10750 00000196 08C0                    		or	al, al		; special case?
 10751 00000198 7504                    		jnz	short keyret
 10752                                  alt_save:				
 10753 0000019A 8826[0C00]              		mov	[altah], ah	; store	special	key
 10754                                  keyret:					
 10755 0000019E C3                      		retn
 10756                                  
 10757                                  ; ---------------------------------------------------------------------------
 10758                                  
 10759                                  ;************************************************************************
 10760                                  ;*									*
 10761                                  ;*	con_rdnd - keyboard non destructive read, no wait		*
 10762                                  ;*									*
 10763                                  ;*	pc-convertible-type machine: if bit 10 is set by the dos	*
 10764                                  ;*	in the status word of the request packet, and there is no	*
 10765                                  ;*	character in the input buffer, the driver issues a system	*
 10766                                  ;*	wait request to the rom. on return from the rom, it returns	*
 10767                                  ;*	a 'char-not-found' to the dos.					*
 10768                                  ;*									*
 10769                                  ;************************************************************************
 10770                                  
 10771                                  		; 19/10/2022
 10772                                  con_rdnd:				
 10773 0000019F A0[0C00]                		mov	al, [altah]
 10774 000001A2 08C0                    		or	al, al
 10775 000001A4 754C                    		jnz	short rdexit
 10776 000001A6 8A26[7F04]              		mov	ah, [keysts_func]
 10777 000001AA CD16                    		int	16h		; KEYBOARD -
 10778 000001AC 751D                    		jnz	short gotchr
 10779 000001AE 803E[7900]00            		cmp	byte [fhavek09], 0
 10780 000001B3 7412                    		jz	short z_bus_exit
 10781 000001B5 C41E[1200]              		les	bx, [ptrsav]
 10782                                  		; 12/12/2022
 10783 000001B9 26F6470404              		test	byte [es:bx+4], 04h
 10784                                  		;test	word [es:bx+3], 400h ; [es:bx+status]
 10785 000001BE 7407                    		jz	short z_bus_exit
 10786 000001C0 B80041                  		mov	ax, 4100h
 10787 000001C3 30DB                    		xor	bl, bl
 10788 000001C5 CD15                    		int	15h		; SYSTEM - WAIT	ON EXTERNAL EVENT (CONVERTIBLE)
 10789                                  					; AL = condition type, BH = condition compare or mask value
 10790                                  					; BL = timeout value times 55 milliseconds, 00h	means no timeout
 10791                                  					; DX = I/O port	address	if AL bit 4 set
 10792                                  z_bus_exit:				
 10793 000001C7 F9                      		stc			; 2C7h:1C8h = 70h:2738h
 10794 000001C8 B403                    		mov	ah, 3		; indicate busy	status
 10795 000001CA C3                      		retn
 10796                                  ; ---------------------------------------------------------------------------
 10797                                  
 10798                                  gotchr:					
 10799 000001CB 09C0                    		or	ax, ax
 10800 000001CD 7508                    		jnz	short notbrk	; check	for null after break
 10801 000001CF 8A26[7E04]              		mov	ah, [keyrd_func] ; issue keyboard read function
 10802 000001D3 CD16                    		int	16h		; KEYBOARD -
 10803 000001D5 EBC8                    		jmp	short con_rdnd	; get a	real status
 10804                                  ; ---------------------------------------------------------------------------
 10805                                  
 10806                                  notbrk:					
 10807 000001D7 3D0072                  		cmp	ax, 7200h	; check	for ctrl-prtsc
 10808 000001DA 7504                    		jnz	short rd_ext_chk
 10809 000001DC B010                    		mov	al, 10h		; ('P' & 1Fh) ; return control p
 10810 000001DE EB12                    		jmp	short rdexit
 10811                                  ; ---------------------------------------------------------------------------
 10812                                  
 10813                                  rd_ext_chk:				
 10814 000001E0 803E[7E04]00            		cmp	byte [keyrd_func], 0 ; extended keyboard function?
 10815 000001E5 740B                    		jz	short rdexit
 10816 000001E7 3CE0                    		cmp	al, 0E0h	; extended key value or	greek alpha?
 10817 000001E9 7507                    		jnz	short rdexit
 10818 000001EB 80FC00                  		cmp	ah, 0		; scan code exist?
 10819 000001EE 7402                    		jz	short rdexit	; yes. greek alpha char.
 10820 000001F0 B000                    		mov	al, 0		; no. extended key stroke.
 10821                                  					; change it for	compatibility
 10822                                  rdexit:					
 10823 000001F2 C41E[1200]              		les	bx, [ptrsav]
 10824 000001F6 2688470D                		mov	[es:bx+13], al	; [es:bx+media]
 10825                                  					; return keyboard character here
 10826                                  bc_exvec:				
 10827 000001FA F8                      		clc			; bc_exvec at 2C7h:1FBh	= 70h:276Bh
 10828                                  					; indicate normal termination
 10829 000001FB C3                      		retn
 10830                                  ; ---------------------------------------------------------------------------
 10831                                  
 10832                                  ;************************************************************************
 10833                                  ;*									*
 10834                                  ;*	con_write - console write routine				*
 10835                                  ;*									*
 10836                                  ;*	entry:	es:di -> buffer						*
 10837                                  ;*		cx    =  count						*
 10838                                  ;*									*
 10839                                  ;************************************************************************
 10840                                  
 10841                                  con_writ:
 10842                                  		;jcxz	short bc_exvec
 10843 000001FC E3FC                    		jcxz	bc_exvec	; 19/10/2022
 10844                                  		; 12/12/2022
 10845                                  		;jcxz	cc_ret
 10846                                  con_lp:					
 10847 000001FE 268A05                  		mov	al, [es:di]
 10848 00000201 47                      		inc	di
 10849 00000202 CD29                    		int	29h		; DOS 2+ internal - FAST PUTCHAR
 10850                                  					; AL = character to display
 10851 00000204 E2F8                    		loop	con_lp
 10852                                  cc_ret:					
 10853 00000206 F8                      		clc
 10854 00000207 C3                      		retn
 10855                                  
 10856                                  ; =============== S U B	R O U T	I N E =======================================
 10857                                  
 10858                                  ;************************************************************************
 10859                                  ;*									*
 10860                                  ;*	con_flush - flush out keyboard queue				*
 10861                                  ;*									*
 10862                                  ;************************************************************************
 10863                                  
 10864                                  con_flush:
 10865 00000208 C606[0C00]00            		mov	byte [altah], 0	; clear	out holding buffer
 10866                                  flloop:					; while	(charavail()) charread();	
 10867 0000020D B401                    		mov	ah, 1
 10868 0000020F CD16                    		int	16h		; KEYBOARD - CHECK BUFFER, DO NOT CLEAR
 10869                                  					; Return: ZF clear if character	in buffer
 10870                                  					; AH = scan code, AL = character
 10871                                  					; ZF set if no character in buffer
 10872 00000211 74F3                    		jz	short cc_ret
 10873 00000213 30E4                    		xor	ah, ah
 10874 00000215 CD16                    		int	16h		; KEYBOARD - READ CHAR FROM BUFFER, WAIT IF EMPTY
 10875                                  					; Return: AH = scan code, AL = character
 10876 00000217 EBF4                    		jmp	short flloop
 10877                                  
 10878                                  ; ---------------------------------------------------------------------------
 10879                                  
 10880                                  ; 15/10/2022
 10881                                  
 10882                                  ;************************************************************************
 10883                                  ;*									*
 10884                                  ;*	some equates for rom bios printer i/o				*
 10885                                  ;*									*
 10886                                  ;************************************************************************
 10887                                  
 10888                                  ; ibm rom status bits (i don't trust them, neither should you)
 10889                                  ; warning!!! the ibm rom does not return just one bit. it returns a
 10890                                  ; whole slew of bits, only one of which is correct.
 10891                                  
 10892                                  ;notbusystatus	equ 10000000b		; not busy
 10893                                  ;nopaperstatus	equ 00100000b		; no more paper
 10894                                  ;prnselected	equ 00010000b		; printer selected
 10895                                  ;ioerrstatus	equ 00001000b		; some kinda error
 10896                                  ;timeoutstatus	equ 00000001b		; time out.
 10897                                  ;
 10898                                  ;noprinter	equ 00110000b		; no printer attached
 10899                                  
 10900                                  ; 18/03/2019 - Retro DOS v4.0
 10901                                  ;error_I24_out_of_paper	equ 9 ; MSDOS 6.0, ERR.INC, 1991
 10902                                  
 10903                                  ; ---------------------------------------------------------------------------
 10904                                  
 10905                                  ;************************************************************************
 10906                                  ;*									*
 10907                                  ;*	prn_input - return with no error but zero chars read		*
 10908                                  ;*									*
 10909                                  ;*	enter with cx = number of characters requested			*
 10910                                  ;*									*
 10911                                  ;************************************************************************
 10912                                  
 10913                                  prn_input:				; 2C7h:21Ah = 70h:278Ah
 10914 00000219 E8BBFE                  		call	bc_err_cnt	; reset	count to zero
 10915                                  					; (sub reqpkt.count,cx)
 10916                                  		; 12/12/2022
 10917                                  prn_done:
 10918 0000021C F8                      		clc			; but return with carry	reset for no error
 10919 0000021D C3                      		retn
 10920                                  ; ---------------------------------------------------------------------------
 10921                                  
 10922                                  ;************************************************************************
 10923                                  ;*									*
 10924                                  ;*	prn_writ - write cx bytes from es:di to printer device		*
 10925                                  ;*									*
 10926                                  ;*	auxnum has printer number					*
 10927                                  ;*									*
 10928                                  ;************************************************************************
 10929                                  
 10930                                  prn_writ:				; 2C7h:21Fh = 70h:278Fh
 10931                                  		;jcxz	short prn_done	; no chars to output
 10932 0000021E E3FC                    		jcxz	prn_done	; 19/10/2022
 10933                                  prn_loop:				
 10934 00000220 BB0200                  		mov	bx, 2		; retry	count
 10935                                  prn_out:				
 10936 00000223 E83600                  		call	prnstat		; get status
 10937 00000226 751D                    		jnz	short TestPrnError
 10938 00000228 268A05                  		mov	al, [es:di]	; get character	to print
 10939 0000022B 30E4                    		xor	ah, ah
 10940 0000022D E82E00                  		call	prnop		; print	to printer
 10941 00000230 7419                    		jz	short prn_con	; no error - continue
 10942 00000232 80FCFF                  		cmp	ah, 0FFh	; MODE_CTRLBRK
 10943 00000235 7509                    		jnz	short _prnwf
 10944 00000237 B00C                    		mov	al, 0Ch		; error_I24_gen_failure
 10945 00000239 C606[0C00]00            		mov	byte [altah], 0
 10946 0000023E EB08                    		jmp	short pmessg
 10947                                  ; ---------------------------------------------------------------------------
 10948                                  
 10949                                  _prnwf:					
 10950 00000240 F6C401                  		test	ah, 1		; timeoutstatus
 10951 00000243 7406                    		jz	short prn_con
 10952                                  TestPrnError:				
 10953 00000245 4B                      		dec	bx		; retry	until count is exhausted.
 10954 00000246 75DB                    		jnz	short prn_out
 10955                                  pmessg:					
 10956 00000248 E98CFE                  		jmp	bc_err_cnt
 10957                                  ; ---------------------------------------------------------------------------
 10958                                  
 10959                                  prn_con:				
 10960 0000024B 47                      		inc	di		; point	to next	char and continue
 10961 0000024C E2D2                    		loop	prn_loop
 10962                                  ;prn_done:				
 10963                                  		; 12/12/2022
 10964                                  prn_done2:
 10965                                  		;clc
 10966                                  		; cf=0
 10967 0000024E C3                      		retn
 10968                                  ; ---------------------------------------------------------------------------
 10969                                  
 10970                                  ;************************************************************************
 10971                                  ;*									*
 10972                                  ;*	prn_stat - device driver entry to return printer status		*
 10973                                  ;*									*
 10974                                  ;************************************************************************
 10975                                  
 10976                                  prn_stat:				; 2C7h:251h = 70h:27C1h
 10977 0000024F E80A00                  		call	prnstat		; device in dx
 10978 00000252 75F4                    		jnz	short pmessg
 10979 00000254 F6C480                  		test	ah, 80h		; notbusystatus
 10980                                  		;jnz	short prn_done
 10981                                  		; 12/12/2022
 10982 00000257 75F5                    		jnz	short prn_done2 ; cf=0
 10983 00000259 E96BFF                  		jmp	z_bus_exit
 10984                                  ; ---------------------------------------------------------------------------
 10985                                  
 10986                                  ;************************************************************************
 10987                                  ;*									*
 10988                                  ;*	prnstat - utility function to call ROM BIOS to check		*
 10989                                  ;*		 printer status. Return meaningful error code		*
 10990                                  ;*									*
 10991                                  ;************************************************************************
 10992                                  
 10993                                  prnstat:				
 10994 0000025C B402                    		mov	ah, 2		; set command for get status
 10995                                  					; PRINTER - GET	STATUS
 10996                                  					; DX = printer port (0-3)
 10997                                  					; Return: AH = status
 10998                                  
 10999                                  ; =============== S U B	R O U T	I N E =======================================
 11000                                  
 11001                                  ;************************************************************************
 11002                                  ;*									*
 11003                                  ;*	prnop - call ROM BIOS printer function in ah			*
 11004                                  ;*		return zero true if no error				*
 11005                                  ;*		return zero false if error, al = error code		*
 11006                                  ;*									*
 11007                                  ;************************************************************************
 11008                                  
 11009                                  prnop:
 11010                                  		; 20/12/2023 - Retro DOS v5.0
 11011                                  		; PCDOS 7.1 IBMBIO.COM
 11012                                  		
 11013                                  		;mov	dx, [auxnum]	; get printer number
 11014                                  		;int	17h
 11015                                  
 11016 0000025E 1E                      		push	ds
 11017 0000025F FF36[2100]              		push	word [auxnum]
 11018 00000263 31D2                    		xor	dx, dx ; 0
 11019 00000265 8EDA                    		mov	ds, dx
 11020 00000267 5A                      		pop	dx
 11021 00000268 9C                      		pushf			; simulate int 17h
 11022 00000269 FA                      		cli
 11023                                  		;call	dword ptr ds:5Ch
 11024 0000026A FF1E5C00                		call	far [17h*4]	; 0:5Ch = INT 17h vector
 11025 0000026E 1F                      		pop	ds
 11026                                  
 11027                                  	; This check was added to see if this is a case of no
 11028                                  	; printer being installed. This tests checks to be sure
 11029                                  	; the error is noprinter (30h)
 11030                                  
 11031 0000026F 50                      		push	ax
 11032 00000270 80E430                  		and	ah, 30h
 11033 00000273 80FC30                  		cmp	ah, 30h		; noprinter
 11034 00000276 58                      		pop	ax
 11035 00000277 7506                    		jnz	short NextTest
 11036 00000279 80E4DF                  		and	ah, 0DFh	; ~nopaperstatus
 11037 0000027C 80CC08                  		or	ah, 8		; ioerrstatus
 11038                                  
 11039                                  ; examine the status bits to see if an error occurred. unfortunately, several
 11040                                  ; of the bits are set so we have to pick and choose. we must be extremely
 11041                                  ; careful about breaking basic.
 11042                                  
 11043                                  NextTest:				
 11044 0000027F F6C428                  		test	ah, 28h		; (ioerrstatus+nopaperstatus)
 11045                                  					; i/o error?
 11046 00000282 740A                    		jz	short checknotready ; no, try not ready
 11047                                  
 11048                                  ; at this point, we know we have an error. the converse is not true
 11049                                  
 11050 00000284 B009                    		mov	al, 9		; error_I24_out_of_paper
 11051                                  					; first, assume	out of paper
 11052 00000286 F6C420                  		test	ah, 20h		; out of paper set?
 11053 00000289 7502                    		jnz	short ret1	; yes, error is	set
 11054 0000028B FEC0                    		inc	al		; return al=10 (i/o error)
 11055                                  ret1:					
 11056 0000028D C3                      		retn
 11057                                  ; ---------------------------------------------------------------------------
 11058                                  
 11059                                  checknotready:				
 11060 0000028E B002                    		mov	al, 2		; assume not-ready
 11061 00000290 F6C401                  		test	ah, 1
 11062 00000293 C3                      		retn
 11063                                  
 11064                                  ; ---------------------------------------------------------------------------
 11065                                  
 11066                                  ;************************************************************************
 11067                                  ;*									*
 11068                                  ;*	prn_tilbusy - output until busy. Used by print spooler.		*
 11069                                  ;*		     this entry point should never block waiting for	*
 11070                                  ;*		     device to come ready.				*
 11071                                  ;*									*
 11072                                  ;*	inputs:	cx = count, es:di -> buffer				*
 11073                                  ;*	outputs: set the number of bytes transferred in the		*
 11074                                  ;*		 device driver request packet				*
 11075                                  ;*									*
 11076                                  ;************************************************************************
 11077                                  
 11078                                  		; 19/10/2022
 11079                                  prn_tilbusy:				; 2C7h:28Bh = 70h:27FBh
 11080 00000294 89FE                    		mov	si, di		; everything is	set for	lodsb
 11081                                  prn_tilbloop:				
 11082 00000296 51                      		push	cx
 11083 00000297 53                      		push	bx
 11084 00000298 30FF                    		xor	bh, bh
 11085 0000029A 8A1E[8004]              		mov	bl, [printdev]
 11086 0000029E D1E3                    		shl	bx, 1
 11087                                  		;mov	cx, ds:wait_count[bx] ;	wait count times to come ready
 11088 000002A0 8B8F[8104]              		mov	cx, [wait_count+bx]
 11089 000002A4 5B                      		pop	bx
 11090                                  prn_getstat:				
 11091 000002A5 E8B4FF                  		call	prnstat		; get status
 11092 000002A8 7514                    		jnz	short prn_bperr	; error
 11093 000002AA F6C480                  		test	ah, 80h		; ready	yet?
 11094 000002AD E1F6                    		loope	prn_getstat	; no, go for more
 11095 000002AF 59                      		pop	cx		; get original count
 11096 000002B0 740D                    		jz	short prn_berr	; still	not ready => done
 11097 000002B2 26                      		es
 11098 000002B3 AC                      		lodsb
 11099                                  		;lods	byte ptr es:[si] ; es
 11100                                  					; lodsb
 11101 000002B4 30E4                    		xor	ah, ah
 11102 000002B6 E8A5FF                  		call	prnop
 11103 000002B9 7504                    		jnz	short prn_berr	; error
 11104 000002BB E2D9                    		loop	prn_tilbloop
 11105                                  		; 12/12/2022
 11106                                  		; cf=0 (prnop)
 11107                                  		;clc			; normal no-error return
 11108 000002BD C3                      		retn			;   from device driver
 11109                                  
 11110                                  ; ---------------------------------------------------------------------------
 11111                                  
 11112                                  prn_bperr:				
 11113 000002BE 59                      		pop	cx		; restore transfer count from stack
 11114                                  prn_berr:				
 11115 000002BF E915FE                  		jmp	bc_err_cnt
 11116                                  ; ---------------------------------------------------------------------------
 11117                                  
 11118                                  ; 15/10/2022
 11119                                  
 11120                                  ;************************************************************************
 11121                                  ;*									*
 11122                                  ;*	prn_genioctl - get/set printer retry count			*
 11123                                  ;*									*
 11124                                  ;************************************************************************
 11125                                  
 11126                                  ; IOCTL.INC (MSDOS 6.0, 1991)
 11127                                  ; 11/01/2019
 11128                                  
 11129                                  ;********************************;*
 11130                                  ; CHARACTER DEVICES (PRINTERS)	 ;*
 11131                                  ;********************************;*
 11132                                  
 11133                                  ;;RAWIO SUB-FUNCTIONS
 11134                                  ;;get_retry_count equ 65h
 11135                                  ;;set_retry_count equ 45h
 11136                                  
 11137                                  ;;struc A_RETRYCOUNT
 11138                                  ;;.rc_count: resw 1
 11139                                  ;;endstruc
 11140                                  
 11141                                  ;ioc_pc equ 5
 11142                                  
 11143                                  ; ---------------------------------------------------------------------------
 11144                                  
 11145                                  		; 19/10/2022
 11146                                  prn_genioctl:				; 2C7h:2BAh = 70h:282Ah
 11147 000002C2 C43E[1200]              		les	di, [ptrsav]
 11148 000002C6 26807D0D05              		cmp	byte [es:di+13], 5 ; [es:di+IOCTL_REQ.MAJORFUNCTION]
 11149                                  					; ioc_pc
 11150 000002CB 7403                    		jz	short prnfunc_ok
 11151                                  
 11152                                  prnfuncerr:				
 11153 000002CD E905FE                  		jmp	bc_cmderr
 11154                                  ; ---------------------------------------------------------------------------
 11155                                  
 11156                                  prnfunc_ok:				
 11157 000002D0 268A450E                		mov	al, [es:di+14]	; [es:di+IOCTL_REQ.MINORFUNCTION]
 11158 000002D4 26C47D13                		les	di, [es:di+19]	; [es:di+IOCTL_REQ.GENERICIOCTL_PACKET]
 11159 000002D8 30FF                    		xor	bh, bh
 11160                                  		;mov	bl, ds:printdev	; get index into retry counts
 11161 000002DA 8A1E[8004]              		mov	bl, [printdev]
 11162 000002DE D1E3                    		shl	bx, 1
 11163                                  		;mov	cx, ds:wait_count[bx] ;	pull out retry count for device
 11164 000002E0 8B8F[8104]              		mov	cx, [wait_count+bx]
 11165 000002E4 3C65                    		cmp	al, 65h		; get_retry_count
 11166 000002E6 7407                    		jz	short prngetcount
 11167 000002E8 3C45                    		cmp	al, 45h		; set_retry_count
 11168 000002EA 75E1                    		jnz	short prnfuncerr
 11169 000002EC 268B0D                  		mov	cx, [es:di]
 11170                                  prngetcount:				
 11171                                  		;mov	ds:wait_count[bx], cx
 11172 000002EF 898F[8104]              		mov	[wait_count+bx], cx
 11173 000002F3 26890D                  		mov	[es:di], cx	; [es:di+A_RETRYCOUNT.RC_COUNT]
 11174                                  					; return current retry count
 11175                                  		; 12/12/2022
 11176                                  		; cf=0
 11177                                  		;clc
 11178 000002F6 C3                      		retn
 11179                                  ; ---------------------------------------------------------------------------
 11180                                  
 11181                                  ;************************************************************************
 11182                                  ;*									*
 11183                                  ;*  prn_ioctl_query							*
 11184                                  ;*									*
 11185                                  ;*  Added for 5.00							*
 11186                                  ;************************************************************************
 11187                                  
 11188                                  prn_ioctl_query:			; 2C7h:2F0h = 70h:2860h
 11189 000002F7 C43E[1200]              		les	di, [ptrsav]
 11190 000002FB 26807D0D05              		cmp	byte [es:di+13], 5 ; [es:di+IOCTL_REQ.MAJORFUNCTION]
 11191                                  					; ioc_pc
 11192 00000300 750D                    		jnz	short prn_query_err
 11193 00000302 268A450E                		mov	al, [es:di+14]	; [es:di+IOCTL_REQ.MINORFUNCTION]
 11194 00000306 3C65                    		cmp	al, 65h		; GET_RETRY_COUNT
 11195 00000308 7404                    		jz	short IOCtlSupported
 11196 0000030A 3C45                    		cmp	al, 45h		; SET_RETRY_COUNT
 11197 0000030C 7501                    		jnz	short prn_query_err
 11198                                  IOCtlSupported:	
 11199                                  		; 12/12/2022
 11200                                  		; cf=0		
 11201                                  		;clc
 11202 0000030E C3                      		retn
 11203                                  ; ---------------------------------------------------------------------------
 11204                                  
 11205                                  prn_query_err:
 11206                                  		; 12/12/2022				
 11207                                  		;stc
 11208 0000030F E9C3FD                  		jmp	bc_cmderr ; (bc_cmderr sets cf to 1)
 11209                                  ; ---------------------------------------------------------------------------
 11210                                  
 11211                                  ;************************************************************************
 11212                                  ;*									*
 11213                                  ;*	aux port driver code -- "aux" == "com1"				*
 11214                                  ;*									*
 11215                                  ;*	the device driver entry/dispatch code sets up auxnum to		*
 11216                                  ;*	give the com port number to use (0=com1, 1=com2, 2=com3...)	*
 11217                                  ;*									*
 11218                                  ;************************************************************************
 11219                                  
 11220                                  ;	values in ah, requesting function of int 14h in rom bios
 11221                                  
 11222                                  ;auxfunc_send	 equ	1	;transmit
 11223                                  ;auxfunc_receive equ	2	;read
 11224                                  ;auxfunc_status	 equ	3	;request status
 11225                                  
 11226                                  ;	error flags, reported by int 14h, reported in ah:
 11227                                  
 11228                                  ;flag_data_ready equ	01h	;data ready
 11229                                  ;flag_overrun	 equ	02h	;overrun error
 11230                                  ;flag_parity	 equ	04h	;parity error
 11231                                  ;flag_frame	 equ	08h	;framing error
 11232                                  ;flag_break	 equ	10h	;break detect
 11233                                  ;flag_tranhol_emp equ	20h	;transmit holding register empty
 11234                                  ;flag_timeout	 equ	80h	;timeout
 11235                                  
 11236                                  ;	these flags reported in al:
 11237                                  
 11238                                  ;flag_cts	 equ	10h	;clear to send
 11239                                  ;flag_dsr	 equ	20h	;data set ready
 11240                                  ;flag_rec_sig	 equ	80h	;receive line signal detect
 11241                                  
 11242                                  ; ---------------------------------------------------------------------------
 11243                                  
 11244                                  ;************************************************************************
 11245                                  ;*									*
 11246                                  ;*	aux_read - read cx bytes from [auxnum] aux port to buffer	*
 11247                                  ;*		   at es:di						*
 11248                                  ;*									*
 11249                                  ;************************************************************************
 11250                                  
 11251                                  aux_read:				; 2C7h:30Dh = 70h:287Dh
 11252                                  		;jcxz	short exvec2
 11253 00000312 E311                    		jcxz	exvec2		; 19/10/2022
 11254 00000314 E88000                  		call	getbx		; put address of auxbuf	in bx
 11255 00000317 30C0                    		xor	al, al
 11256 00000319 8607                    		xchg	al, [bx]
 11257 0000031B 08C0                    		or	al, al
 11258 0000031D 7503                    		jnz	short aux2
 11259                                  aux1:					
 11260 0000031F E80500                  		call	auxin		; get character	from port
 11261                                  					; won't return if error
 11262                                  aux2:					
 11263 00000322 AA                      		stosb
 11264 00000323 E2FA                    		loop	aux1		; if more characters, go around	again
 11265                                  exvec2:					
 11266 00000325 F8                      		clc			; all done, successful exit
 11267                                  auxin_retn:	; 18/12/2022
 11268 00000326 C3                      		retn
 11269                                  ; ---------------------------------------------------------------------------
 11270                                  
 11271                                  ;************************************************************************
 11272                                  ;*									*
 11273                                  ;*	auxin - call rom bios to read character from aux port		*
 11274                                  ;*		if error occurs, map the error and return one		*
 11275                                  ;*		level up to device driver exit code, setting		*
 11276                                  ;*		the number of bytes transferred appropriately		*
 11277                                  ;*									*
 11278                                  ;************************************************************************
 11279                                  
 11280                                  auxin:					
 11281 00000327 B402                    		mov	ah, 2		; auxfunc_receive
 11282 00000329 E83A00                  		call	auxop
 11283 0000032C F6C40E                  		test	ah, 0Eh		; flag_frame|flag_parity|flag_overrun
 11284                                  		;jnz	short arbad	; skip if any error bits set
 11285                                  		;retn
 11286                                  		; 25/06/2023 (BugFix)
 11287 0000032F 74F5                    		jz	short auxin_retn
 11288                                  ; ---------------------------------------------------------------------------
 11289                                  
 11290                                  arbad:					
 11291 00000331 58                      		pop	ax		; remove return	address	(near call)
 11292                                  		;xor	al, al
 11293                                  		;or	al, 0B0h	; flag_rec_sig|	flag_dsr|flag_cts
 11294                                  		; 11/08/2023
 11295 00000332 B0B0                    		mov	al, 0B0h	; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0334h
 11296 00000334 E9A0FD                  		jmp	bc_err_cnt
 11297                                  
 11298                                  ; ---------------------------------------------------------------------------
 11299                                  
 11300                                  ;************************************************************************
 11301                                  ;*									*
 11302                                  ;*	aux_rdnd - non-destructive aux port read			*
 11303                                  ;*									*
 11304                                  ;************************************************************************
 11305                                  
 11306                                  aux_rdnd:				; 2C7h:335h = 70h:28A5h
 11307 00000337 E85D00                  		call	getbx
 11308 0000033A 8A07                    		mov	al, [bx]	; have bx point	to auxbuf
 11309 0000033C 08C0                    		or	al, al		; if al	is non-zero (char in buffer)
 11310 0000033E 7511                    		jnz	short auxdrx	; then return character
 11311 00000340 E82100                  		call	auxstat		; if not, get status of	aux device
 11312 00000343 F6C401                  		test	ah, 1		; flag_data_ready - test data ready
 11313 00000346 740C                    		jz	short auxbus	; then device is busy (not ready)
 11314 00000348 A820                    		test	al, 20h		; flag_dsr - test data set ready
 11315 0000034A 7408                    		jz	short auxbus	; then device is busy (not ready)
 11316 0000034C E8D8FF                  		call	auxin		; else aux is ready, get character
 11317 0000034F 8807                    		mov	[bx], al
 11318                                  auxdrx:					
 11319 00000351 E99EFE                  		jmp	rdexit		; return busy status
 11320                                  ; ---------------------------------------------------------------------------
 11321                                  
 11322                                  auxbus:					
 11323 00000354 E970FE                  		jmp	z_bus_exit
 11324                                  ; ---------------------------------------------------------------------------
 11325                                  
 11326                                  ;************************************************************************
 11327                                  ;*									*
 11328                                  ;*	aux_wrst - return aux port write status				*
 11329                                  ;*									*
 11330                                  ;************************************************************************
 11331                                  
 11332                                  aux_wrst:				; 2C7h:355h = 70h:28C5h
 11333 00000357 E80A00                  		call	auxstat		; get status of	aux in ax
 11334 0000035A A820                    		test	al, 20h		; test data set	ready
 11335 0000035C 74F6                    		jz	short auxbus	; then device is busy (not ready)
 11336 0000035E F6C420                  		test	ah, 20h		; flag_tranhol_emp - test transmit hold	reg empty
 11337 00000361 74F1                    		jz	short auxbus	; then device is busy (not ready)
 11338                                  		; 12/12/2022
 11339                                  		; cf=0	; (test instruction resets cf)
 11340                                  		;clc
 11341 00000363 C3                      		retn
 11342                                  ; ---------------------------------------------------------------------------
 11343                                  
 11344                                  ;************************************************************************
 11345                                  ;*									*
 11346                                  ;*	auxstat - call rom bios to determine aux port status		*
 11347                                  ;*									*
 11348                                  ;*	exit:	ax = status						*
 11349                                  ;*		dx = [auxnum]						*
 11350                                  ;*									*
 11351                                  ;************************************************************************
 11352                                  
 11353                                  auxstat:				
 11354 00000364 B403                    		mov	ah, 3		; auxfunc_status
 11355                                  
 11356                                  		; fall into auxop
 11357                                  
 11358                                  ; =============== S U B	R O U T	I N E =======================================
 11359                                  
 11360                                  ;************************************************************************
 11361                                  ;*									*
 11362                                  ;*	auxop - perform rom-biox aux port interrupt			*
 11363                                  ;*									*
 11364                                  ;*	entry:	ah = int 14h function number				*
 11365                                  ;*	exit:	ax = results						*
 11366                                  ;*		dx = [auxnum]						*
 11367                                  ;*									*
 11368                                  ;************************************************************************
 11369                                  
 11370                                  auxop:		; proc near
 11371                                  		; 20/12/2023 - Retro DOS v5.0
 11372                                  		;mov	dx, [auxnum]	; ah=function code
 11373                                  		;			; 0=init, 1=send, 2=receive, 3=status
 11374                                  		;			; get port number
 11375                                  		;
 11376                                  		;int	14h		; SERIAL I/O - GET USART STATUS
 11377                                  		;			; DX = port number (0-3)
 11378                                  		;			; Return: AX = port status code
 11379                                  		; (PCDOS 7.1 IBMBIO.COM)
 11380 00000366 1E                      		push	ds
 11381 00000367 FF36[2100]              		push	word [auxnum]
 11382 0000036B 31D2                    		xor	dx, dx ; 0
 11383 0000036D 8EDA                    		mov	ds, dx
 11384 0000036F 5A                      		pop	dx
 11385 00000370 9C                      		pushf			; simulate INT 14h
 11386 00000371 FA                      		cli
 11387                                  		;call	dword ptr ds:50h
 11388 00000372 FF1E5000                		call	far [14h*4]	; INT 14h vector (14h*4 = 50h)
 11389 00000376 1F                      		pop	ds
 11390                                  
 11391 00000377 C3                      		retn
 11392                                  
 11393                                  ; ---------------------------------------------------------------------------
 11394                                  
 11395                                  ;************************************************************************
 11396                                  ;*									*
 11397                                  ;*	aux_flsh - flush aux input buffer - set contents of		*
 11398                                  ;*		   auxbuf [auxnum] to zero				*
 11399                                  ;*									*
 11400                                  ;*	cas - shouldn't this code call the rom bios input function	*
 11401                                  ;*	      repeatedly until it isn't ready?  to flush out any	*
 11402                                  ;*	      pending serial input queue if there's a tsr like MODE	*
 11403                                  ;*	      which is providing interrupt-buffering of aux port?	*
 11404                                  ;*									*
 11405                                  ;************************************************************************
 11406                                  
 11407                                  aux_flsh:				; 2C7h:36Ch = 70h:28DCh
 11408 00000378 E81C00                  		call	getbx		; flush	aux input buffer
 11409 0000037B C60700                  		mov	byte [bx], 0	; get bx to point to auxbuf
 11410                                  					; zero out buffer
 11411                                  		;clc			; all done, successful return
 11412                                  		; 12/12/2022
 11413                                  		; cf=0 ('add' instruction in 'getbx')
 11414 0000037E C3                      		retn
 11415                                  ; ---------------------------------------------------------------------------
 11416                                  
 11417                                  ;************************************************************************
 11418                                  ;*									*
 11419                                  ;*	aux_writ - write to aux device					*
 11420                                  ;*									*
 11421                                  ;************************************************************************
 11422                                  
 11423                                  aux_writ:				; 2C7h:374h = 70h:28E4h
 11424                                  		;jcxz	short exvec2	; write	to aux device (if cx > 0)
 11425 0000037F E3A4                    		jcxz	exvec2		; 19/10/2022
 11426                                  aux_loop:				
 11427 00000381 268A05                  		mov	al, [es:di]	; get character	to be written
 11428                                  					; move di pointer to next character
 11429 00000384 47                      		inc	di
 11430 00000385 B401                    		mov	ah, 1		; auxfunc_send - indicates a write
 11431 00000387 E8DCFF                  		call	auxop		; send character over aux port
 11432 0000038A F6C480                  		test	ah, 80h		; check	for error
 11433 0000038D 7405                    		jz	short awok	; then no error
 11434 0000038F B00A                    		mov	al, 10		; else indicate	write fault
 11435 00000391 E943FD                  		jmp	bc_err_cnt	; call error routines
 11436                                  ; ---------------------------------------------------------------------------
 11437                                  
 11438                                  awok:					
 11439 00000394 E2EB                    		loop	aux_loop	; if cx	is non-zero,
 11440                                  					; still	more character to print
 11441                                  		;clc			; all done, successful return
 11442                                  		; 12/12/2022
 11443                                  		; cf=0 (test instruction above)	
 11444 00000396 C3                      		retn
 11445                                  
 11446                                  ; =============== S U B	R O U T	I N E =======================================
 11447                                  
 11448                                  ;************************************************************************
 11449                                  ;*									*
 11450                                  ;*	getbx - return bx -> single byte input buffer for		*
 11451                                  ;*		selected aux port ([auxnum])				*
 11452                                  ;*									*
 11453                                  ;************************************************************************
 11454                                  
 11455                                  getbx:	
 11456 00000397 8B1E[2100]              		mov	bx, [auxnum]	; return bx -> single byte input buffer
 11457                                  					; for selected aux port	([auxnum])
 11458                                  		;add	bx, offset auxbuf
 11459 0000039B 81C3[1600]              		add	bx, auxbuf	; 19/10/2022
 11460                                  		; 12/12/2022
 11461                                  		; cf=0 (if [auxnum] is valid number) 
 11462 0000039F C3                      		retn
 11463                                  
 11464                                  ; ---------------------------------------------------------------------------
 11465                                  
 11466                                  ; 15/10/2022
 11467                                  
 11468                                  ;----------------------------------------------------------------
 11469                                  ;								:
 11470                                  ;		    clock device driver 			:
 11471                                  ;								:
 11472                                  ;								:
 11473                                  ;   this file contains the clock device driver. 		:
 11474                                  ;								:
 11475                                  ;   the routines in this files are:				:
 11476                                  ;								:
 11477                                  ;	routine 		function			:
 11478                                  ;	------- 		--------			:
 11479                                  ;	tim_writ		set the current time		:
 11480                                  ;	tim_read		read the current time		:
 11481                                  ;	time_to_ticks		convert time to corresponding	:
 11482                                  ;				  number of clock ticks 	:
 11483                                  ;								:
 11484                                  ; the clock ticks at the rate of:				:
 11485                                  ;								:
 11486                                  ;	1193180/65536 ticks/second (about 18.2 ticks per second):
 11487                                  ; see each routine for information on the use.			:
 11488                                  ;								:
 11489                                  ;----------------------------------------------------------------
 11490                                  
 11491                                  ; convert time to ticks
 11492                                  ; input : time in cx and dx
 11493                                  ; ticks returned in cx:dx
 11494                                  
 11495                                  ;19/07/2019
 11496                                  ;09/03/2019
 11497                                  
 11498                                  time_to_ticks:				; 0070h:2906h =	02C7h:0396h
 11499                                  
 11500                                  ; first convert from hour,min,sec,hund. to
 11501                                  ; total number of 100th of seconds
 11502                                  
 11503 000003A0 B03C                    		mov	al, 60
 11504 000003A2 F6E5                    		mul	ch		; hours	to minutes
 11505 000003A4 B500                    		mov	ch, 0
 11506 000003A6 01C8                    		add	ax, cx		; total	minutes
 11507 000003A8 B97017                  		mov	cx, 6000	; 60*100
 11508 000003AB 89D3                    		mov	bx, dx		; get out of the way of	the multiply
 11509 000003AD F7E1                    		mul	cx		; convert to 1/100 sec
 11510 000003AF 89C1                    		mov	cx, ax
 11511 000003B1 B064                    		mov	al, 100
 11512 000003B3 F6E7                    		mul	bh		; convert seconds to 1/100 sec
 11513 000003B5 01C1                    		add	cx, ax		; combine seconds with hours and min
 11514 000003B7 83D200                  		adc	dx, 0		; ripple carry
 11515 000003BA B700                    		mov	bh, 0
 11516 000003BC 01D9                    		add	cx, bx		; combine 1/100	sec
 11517 000003BE 83D200                  		adc	dx, 0
 11518                                  
 11519                                  	; dx:cx is time in 1/100 sec
 11520                                  
 11521 000003C1 92                      		xchg	ax, dx
 11522 000003C2 91                      		xchg	ax, cx		; now time is in cx:ax
 11523 000003C3 BB0BE9                  		mov	bx, 59659
 11524 000003C6 F7E3                    		mul	bx		; multiply low half
 11525 000003C8 87D1                    		xchg	dx, cx
 11526 000003CA 92                      		xchg	ax, dx		; cx->ax, ax->dx, dx->cx
 11527 000003CB F7E3                    		mul	bx		; multiply high	half
 11528 000003CD 01C8                    		add	ax, cx		; combine overlapping products
 11529 000003CF 83D200                  		adc	dx, 0
 11530 000003D2 92                      		xchg	ax, dx		; ax:dx=time*59659
 11531 000003D3 BB0500                  		mov	bx, 5
 11532 000003D6 F6F3                    		div	bl		; divide high half by 5
 11533 000003D8 88C1                    		mov	cl, al
 11534 000003DA B500                    		mov	ch, 0
 11535 000003DC 88E0                    		mov	al, ah		; remainder of divide-by-5
 11536 000003DE 98                      		cbw
 11537 000003DF 92                      		xchg	ax, dx		; use it to extend low half
 11538 000003E0 F7F3                    		div	bx		; divide low half by 5
 11539 000003E2 89C2                    		mov	dx, ax		; cx:dx	is now number of ticks in time
 11540 000003E4 CB                      		retf			; far return
 11541                                  
 11542                                  ; ---------------------------------------------------------------------------
 11543                                  
 11544                                  ; 17/10/2022
 11545                                  ; 15/10/2022
 11546                                  
 11547                                  ;--------------------------------------------------------------------
 11548                                  ;
 11549                                  ; tim_writ sets the current time
 11550                                  ;
 11551                                  ; on entry es:[di] has the current time:
 11552                                  ;
 11553                                  ;	number of days since 1-1-80	(word)
 11554                                  ;	minutes (0-59)			(byte)
 11555                                  ;	hours (0-23)			(byte)
 11556                                  ;	hundredths of seconds (0-99)	(byte)
 11557                                  ;	seconds (0-59)			(byte)
 11558                                  ;
 11559                                  ; each number has been checked for the correct range.
 11560                                  ;
 11561                                  ;	NOTE: Any changes in this routine probably require corresponding
 11562                                  ;	changes in the version that is built with the power manager driver.
 11563                                  ;	See ptime.asm.
 11564                                  ;
 11565                                  ;--------------------------------------------------------------------
 11566                                  
 11567                                  	; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 11568                                  	; PCDOS 7.1 IBMBIO.COM - BIOSCODE:03EAh
 11569                                  tim_writ:				; 2C7h:3DBh = 70h:294Bh
 11570 000003E5 268B05                  		mov	ax, [es:di]
 11571 000003E8 50                      		push	ax		; daycnt. we need to set this at the very
 11572                                  					; end to avoid tick windows.
 11573 000003E9 803E[8C04]00            		cmp	byte [havecmosclock], 0
 11574                                  		;cmp	ds:havecmosclock, 0
 11575 000003EE 7423                    		jz	short no_cmos_1
 11576 000003F0 268A4503                		mov	al, [es:di+3]	; near indirect	calls
 11577                                  					; get binary hours
 11578                                  					; convert to bcd
 11579                                  		;call	far [bintobcd]
 11580                                  		;;call	ds:bintobcd	; call far [bintobcd]
 11581                                  		; 08/08/2023
 11582 000003F4 E8E800                  		call	bintobcd
 11583 000003F7 88C5                    		mov	ch, al		; ch = bcd hours
 11584 000003F9 268A4502                		mov	al, [es:di+2]	; get binary minutes
 11585                                  		;call	far [bintobcd]
 11586                                  		;;call	ds:bintobcd	; convert to bcd
 11587 000003FD E8DF00                  		call	bintobcd
 11588 00000400 88C1                    		mov	cl, al		; cl = bcd minutes
 11589 00000402 268A4505                		mov	al, [es:di+5]	; get binary seconds
 11590                                  		;call	far [bintobcd]
 11591                                  		;;call	ds:bintobcd
 11592 00000406 E8D600                  		call	bintobcd
 11593                                  
 11594 00000409 88C6                    		mov	dh, al		; dh = bcd seconds
 11595 0000040B B200                    		mov	dl, 0		; dl = 0 (st) or 1 (dst)
 11596 0000040D FA                      		cli
 11597 0000040E B403                    		mov	ah, 3
 11598 00000410 CD1A                    		int	1Ah		; CLOCK	- SET REAL TIME	CLOCK (AT,XT286,CONV,PS)
 11599                                  					; CH = hours in	BCD, CL	= minutes in BCD
 11600                                  					;  DH =	seconds	in BCD,DL = 01h	if daylight savings, 00h if standard time
 11601                                  					; Return: CMOS clock set
 11602 00000412 FB                      		sti
 11603                                  no_cmos_1:				
 11604 00000413 268B4D02                		mov	cx, [es:di+2]
 11605 00000417 268B5504                		mov	dx, [es:di+4]
 11606                                  		; 17/10/2022
 11607 0000041B FF1E[0606]              		call	far [ttticks]
 11608                                  		;call	dword ptr ds:ttticks ; call far	[ttticks]
 11609                                  					; convert time to ticks
 11610                                  					; cx:dx	now has	time in	ticks
 11611 0000041F FA                      		cli			; turn off timer
 11612 00000420 B401                    		mov	ah, 1
 11613 00000422 CD1A                    		int	1Ah		; CLOCK	- SET TIME OF DAY
 11614                                  					; CX:DX	= clock	count
 11615                                  					; Return: time of day set
 11616                                  		;pop	ds:daycnt
 11617 00000424 8F06[8904]              		pop	word [daycnt]
 11618 00000428 FB                      		sti
 11619                                  		;cmp	ds:havecmosclock, 0
 11620 00000429 803E[8C04]00            		cmp	byte [havecmosclock], 0
 11621 0000042E 7409                    		jz	short no_cmos_2
 11622                                  
 11623                                  		; 08/08/2023
 11624                                  		;call	far [daycnttoday]
 11625                                  		;;call	ds:daycnttoday	; call far [daycnttoday]
 11626                                  					; convert to bcd format
 11627 00000430 E80700                  		call	daycnttoday
 11628                                  
 11629 00000433 FA                      		cli
 11630 00000434 B405                    		mov	ah, 5
 11631 00000436 CD1A                    		int	1Ah		; CLOCK	- SET DATE IN REAL TIME	CLOCK (AT,XT286,CONV,PS)
 11632                                  					; DL = day in BCD, DH =	month in BCD, CL = year	in BCD
 11633                                  					; CH = century (19h or 20h)
 11634                                  					; Return: CMOS clock set
 11635 00000438 FB                      		sti
 11636                                  no_cmos_2:
 11637                                  		; 12/12/2022
 11638                                  		; cf=0
 11639                                  		;clc
 11640 00000439 C3                      		retn
 11641                                  
 11642                                  ; ---------------------------------------------------------------------------
 11643                                  
 11644                                  ; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 11645                                  ; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0440h
 11646                                  %if 1 
 11647                                  
 11648                                  ; CMOS Clock setting support routines used by MSCLOCK.
 11649                                  ; Warning!!! This code will be dynamically relocated by MSINIT.
 11650                                  
 11651                                  daycnttoday:	; proc near
 11652                                  
 11653                                  ; entry: [daycnt] = number of days since 1-1-80
 11654                                  ;
 11655                                  ; return: ch - century in bcd
 11656                                  ;	  cl - year in bcd
 11657                                  ;	  dh - month in bcd
 11658                                  ;	  dl - day in bcd
 11659                                  
 11660                                  		; 20/12/2023 - Retro DOS v5.0
 11661                                  
 11662                                  		; 08/08/2023 (ds:) (near proc)
 11663                                  		; 16/10/2022 (cs:) (far proc)		
 11664 0000043A FF36[8904]              		push	word [daycnt] ; save daycnt
 11665 0000043E 813E[8904]891C          		cmp	word [daycnt], 7305 ; (365*20+(20/4))
 11666                                  					; # days from 1-1-1980 to 1-1-2000
 11667 00000444 7308                    		jnb	short century20
 11668                                  		;mov	byte [base_century], 19
 11669                                  		;mov	byte [base_year], 80
 11670                                  		; 08/08/2023
 11671 00000446 C706[8D04]1350          		mov	word [base_century], 5013h
 11672 0000044C EB0C                    		jmp	short years
 11673                                  ; ----------------------------------------------------------------------------
 11674                                  		
 11675                                  century20:				
 11676                                  		;mov	byte [base_century], 20
 11677                                  		;mov	byte [base_year], 0
 11678                                  		; 08/08/2023
 11679 0000044E C706[8D04]1400          		mov	word [base_century], 20
 11680 00000454 812E[8904]891C          		sub	word [daycnt], 7305 ; (365*20+(20/4))
 11681                                  					; adjust daycnt
 11682                                  years:					
 11683 0000045A 31D2                    		xor	dx, dx
 11684 0000045C A1[8904]                		mov	ax, [daycnt]
 11685 0000045F BBB505                  		mov	bx, 1461	; (366+365*3)
 11686                                  					; # of days in a Leap year block
 11687 00000462 F7F3                    		div	bx		; AX = # of leap block,	DX = daycnt
 11688 00000464 8916[8904]              		mov	[daycnt], dx	; save daycnt left
 11689 00000468 B304                    		mov	bl, 4
 11690 0000046A F6E3                    		mul	bl		; AX = # of years. Less	than 100
 11691 0000046C 0006[8E04]              		add	[base_year], al ; So, ah = 0. Adjust year
 11692 00000470 FF06[8904]              		inc	word [daycnt]	; set daycnt to	1 base
 11693                                  		; 08/08/2023
 11694 00000474 BB6E01                  		mov	bx, 366
 11695 00000477 B90300                  		mov	cx, 3
 11696                                  		;cmp	word [daycnt], 366 ; daycnt=remainder of leap year
 11697 0000047A 391E[8904]              		cmp	[daycnt], bx ; 366
 11698 0000047E 7619                    		jbe	short leapyear	; within 366+355+355+355 days.
 11699 00000480 FE06[8E04]              		inc	byte [base_year] ; if daycnt <= 366, then leap year
 11700                                  		;sub	word [daycnt], 366 ; else daycnt--, base_year++ ;
 11701 00000484 291E[8904]              		sub	[daycnt], bx ; 366 ; 08/08/2023
 11702                                  		;mov	cx, 3		; And next three years are normal
 11703                                  		; 08/08/2023
 11704 00000488 4B                      		dec	bx ; 365
 11705                                  regularyear:	; 20/12/2023
 11706                                  		;cmp	word [daycnt], 365 ; for(i=1; i>3 or daycnt <=365; i++)
 11707 00000489 391E[8904]              		cmp	[daycnt], bx ; 365 ; 08/08/2023
 11708 0000048D 760F                    		jbe	short yeardone	; {if (daycnt >	365)
 11709 0000048F FE06[8E04]              		inc	byte [base_year] ; { daycnt -=	365
 11710                                  		;sub	word [daycnt], 365 ; }
 11711 00000493 291E[8904]              		sub	[daycnt], bx ; 365 ; 08/08/2023
 11712 00000497 E2F0                    		loop	regularyear	; }
 11713                                  					;
 11714                                  					; should never fall through loop
 11715                                  leapyear:	
 11716 00000499 C606[9004]1D            		mov	byte [february], 29 ; 08/08/2023			
 11717                                  		;mov	byte [month_tab+1], 29 ; leap year.
 11718                                  					; change month table.
 11719                                  yeardone:				
 11720 0000049E 31DB                    		xor	bx, bx
 11721 000004A0 31D2                    		xor	dx, dx
 11722 000004A2 A1[8904]                		mov	ax, [daycnt]
 11723                                  		;mov	si, offset month_tab
 11724 000004A5 BE[8F04]                		mov	si, month_tab	; 19/10/2022
 11725                                  		;mov	cx, 12
 11726                                  		; 08/08/2023
 11727 000004A8 B10C                    		mov	cl, 12
 11728                                  months:					
 11729 000004AA FEC3                    		inc	bl
 11730                                  		; 08/08/2023
 11731 000004AC 8A14                    		mov	dl, [si]	; PCDOS 7.1 IBMBIO.COM - BIOSCODE:04B7h
 11732 000004AE 39D0                    		cmp	ax, dx		; cmp daycnt for each month till fit
 11733                                  					; dh=0
 11734 000004B0 7605                    		jbe	short month_done
 11735 000004B2 46                      		inc	si		; next month
 11736 000004B3 29D0                    		sub	ax, dx		; adjust daycnt
 11737 000004B5 E2F3                    		loop	months		;
 11738                                  					; should never fall through loop
 11739                                  month_done:	
 11740 000004B7 C606[9004]1C            		mov	byte [february], 28 ; 08/08/2023
 11741                                  		;mov	byte [month_tab+1], 28
 11742                                  					; restore month table value
 11743 000004BC 88DA                    		mov	dl, bl
 11744 000004BE 8A36[8E04]              		mov	dh, [base_year]
 11745 000004C2 8A0E[8D04]              		mov	cl, [base_century] ; al=day,dl=month,dh=year,cl=cntry
 11746 000004C6 E81600                  		call	bintobcd	; convert "day"	to bcd
 11747                                  					; dl = bcd day,	al = month
 11748 000004C9 86D0                    		xchg	dl, al
 11749 000004CB E81100                  		call	bintobcd	; dh = bcd month, al = year
 11750 000004CE 86F0                    		xchg	dh, al
 11751 000004D0 E80C00                  		call	bintobcd	; cl = bcd year, al = century
 11752 000004D3 86C8                    		xchg	cl, al
 11753 000004D5 E80700                  		call	bintobcd	; ch = bcd century
 11754 000004D8 88C5                    		mov	ch, al
 11755 000004DA 8F06[8904]              		pop	word [daycnt] ; restore original value
 11756 000004DE C3                      		retn
 11757                                  
 11758                                  ;----------------------------------------------------------------------------
 11759                                  
 11760                                  bintobcd:	; proc near		; real time clock support
 11761                                  
 11762                                  ;convert a binary input in al (less than 63h or 99 decimal)
 11763                                  ;into a bcd value in al. ah destroyed.	
 11764                                  		
 11765 000004DF D40A                    		aam			; AH = AL/10, AL = AL MOD 10
 11766 000004E1 D510                    		aad     10h             ; db 0D5h,10h
 11767                                  					; AL = (AH*10H)+AL, AH = 0
 11768 000004E3 C3                      		retn
 11769                                  %endif
 11770                                  
 11771                                  ;----------------------------------------------------------------------------
 11772                                  
 11773                                  ; 15/10/2022
 11774                                  
 11775                                  ;----------------------------------------------------------------------------
 11776                                  ; gettime reads date and time
 11777                                  ; and returns the following information:
 11778                                  ;
 11779                                  ;	es:[di]  =count of days since 1-1-80
 11780                                  ;	es:[di+2]=hours
 11781                                  ;	es:[di+3]=minutes
 11782                                  ;	es:[di+4]=seconds
 11783                                  ;	es:[di+5]=hundredths of seconds
 11784                                  ;
 11785                                  ;	NOTE: Any changes in this routine probably require corresponding
 11786                                  ;	changes in the version that is built with the power manager driver.
 11787                                  ;	See ptime.asm.
 11788                                  ;----------------------------------------------------------------------------
 11789                                  
 11790                                  tim_read:				; 2C7h:435h = 70h:29A5h
 11791 000004E4 E84A00                  		call	GetTickCnt
 11792 000004E7 8B36[8904]              		mov	si, [daycnt]
 11793                                  
 11794                                  ; we now need to convert the time in tick to the time in 100th of
 11795                                  ; seconds. the relation between tick and seconds is:
 11796                                  ;
 11797                                  ;		 65,536 seconds
 11798                                  ;	       ----------------
 11799                                  ;		1,193,180 tick
 11800                                  ;
 11801                                  ; to get to 100th of second we need to multiply by 100. the equation is:
 11802                                  ;
 11803                                  ;	ticks from clock  * 65,536 * 100
 11804                                  ;      --------------------------------- = time in 100th of seconds
 11805                                  ;		1,193,180
 11806                                  ;
 11807                                  ; fortunately this formula simplifies to:
 11808                                  ;
 11809                                  ;	ticks from clock * 5 * 65,536
 11810                                  ;      --------------------------------- = time in 100th of seconds
 11811                                  ;		59,659
 11812                                  ;
 11813                                  ; the calculation is done by first multipling tick by 5. next we divide by
 11814                                  ; 59,659. in this division we multiply by 65,536 by shifting the dividend
 11815                                  ; my 16 bits to the left.
 11816                                  ;
 11817                                  ; start with ticks in cx:dx
 11818                                  ; multiply by 5
 11819                                  
 11820 000004EB 89C8                    		mov	ax, cx
 11821 000004ED 89D3                    		mov	bx, dx		; start	with ticks in cx:dx
 11822                                  					; multiply by 5
 11823 000004EF D1E2                    		shl	dx, 1
 11824 000004F1 D1D1                    		rcl	cx, 1		; times	2
 11825 000004F3 D1E2                    		shl	dx, 1
 11826 000004F5 D1D1                    		rcl	cx, 1		; times	4
 11827 000004F7 01DA                    		add	dx, bx
 11828 000004F9 11C8                    		adc	ax, cx		; times	5
 11829 000004FB 92                      		xchg	ax, dx
 11830                                  
 11831                                  ; now have ticks * 5 in	dx:ax
 11832                                  ; we now need to multiply by 65536 and divide by 59659 d.
 11833                                  
 11834 000004FC B90BE9                  		mov	cx, 59659	; get divisor
 11835 000004FF F7F1                    		div	cx		; dx now has remainder
 11836                                  					; ax has high word of final quotient
 11837                                  
 11838                                  		; 08/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 11839                                  		;mov	bx, ax		; put high word	in safe	place
 11840 00000501 93                      		xchg	bx, ax
 11841 00000502 31C0                    		xor	ax, ax		; this is the multiply by 65536
 11842 00000504 F7F1                    		div	cx		; bx:ax	now has	time in	100th of seconds
 11843                                  
 11844                                  ; rounding based on the	remainder may be added here
 11845                                  ; the result in	bx:ax is time in 1/100 second.
 11846                                  
 11847 00000506 89DA                    		mov	dx, bx		
 11848 00000508 B9C800                  		mov	cx, 200		; extract 1/100's
 11849                                  
 11850                                  ; division by 200 is necessary to ensure no overflow--max result
 11851                                  ; is number of seconds in a day/2 = 43200.
 11852                                  
 11853 0000050B F7F1                    		div	cx
 11854 0000050D 80FA64                  		cmp	dl, 100		; remainder over 100?
 11855 00000510 7203                    		jb	short noadj
 11856 00000512 80EA64                  		sub	dl, 100		; keep 1/100's less than 100
 11857                                  noadj:					
 11858 00000515 F5                      		cmc			; if we	subtracted 100,	carry is now set
 11859 00000516 88D3                    		mov	bl, dl		; save 1/100's
 11860                                  
 11861                                  ; to compensate	for dividing by	200 instead of 100, we now multiply
 11862                                  ; by two, shifting a one in if the remainder had exceeded 100.
 11863                                  
 11864 00000518 D1D0                    		rcl	ax, 1		
 11865 0000051A B200                    		mov	dl, 0
 11866 0000051C D1D2                    		rcl	dx, 1
 11867                                  		;mov	cx, 60		; divide out seconds
 11868                                  		; 20/12/2023
 11869 0000051E B13C                    		mov	cl, 60
 11870 00000520 F7F1                    		div	cx
 11871 00000522 88D7                    		mov	bh, dl		; save the seconds
 11872 00000524 F6F1                    		div	cl		; break	into hours and minutes
 11873 00000526 86C4                    		xchg	al, ah
 11874                                  
 11875                                  ; time is now in ax:bx (hours, minutes, seconds, 1/100 sec)
 11876                                  
 11877                                  		; 08/08/2023
 11878                                  		;push	ax
 11879                                  		;mov	ax, si		; daycnt
 11880 00000528 96                      		xchg	ax, si
 11881 00000529 AB                      		stosw
 11882                                  		;pop	ax
 11883 0000052A 96                      		xchg	ax, si		; al = hours, ah = minutes
 11884 0000052B AB                      		stosw
 11885 0000052C 89D8                    		mov	ax, bx
 11886 0000052E AB                      		stosw
 11887 0000052F F8                      		clc			; [es:di] = count of days since 1-1-80
 11888                                  					;   [es:di+2] = hours
 11889                                  					;   [es:di+3] = minutes
 11890                                  					;   [es:di+4] = seconds
 11891                                  					;   [es:di+5] = hundredths of seconds
 11892 00000530 C3                      		retn
 11893                                  
 11894                                  ; =============== S U B	R O U T	I N E =======================================
 11895                                  
 11896                                  ; 15/10/2022
 11897                                  
 11898                                  ;----------------------------------------------------------------------------
 11899                                  ;
 11900                                  ; procedure : GetTickCnt
 11901                                  ;
 11902                                  ;		Returns the tick count in CX:DX. Takes care of DayCnt in case
 11903                                  ;		of rollover [except when power management driver is in use]. 
 11904                                  ;		Uses the following logic for updating Daycnt
 11905                                  ;
 11906                                  ;		if ( rollover ) {
 11907                                  ;			if ( t_switch )
 11908                                  ;				daycnt++ ;
 11909                                  ;			else
 11910                                  ;				daycnt += rollover ;
 11911                                  ;		}
 11912                                  ;
 11913                                  ; USES : AX
 11914                                  ;
 11915                                  ; RETURNS : CX:DX - tick count
 11916                                  ; MODIFIES : daycnt
 11917                                  ;
 11918                                  ;----------------------------------------------------------------------------
 11919                                  
 11920                                  		; 17/10/2022
 11921                                  GetTickCnt:
 11922 00000531 30E4                    		xor	ah, ah
 11923 00000533 CD1A                    		int	1Ah		; CLOCK	- GET TIME OF DAY
 11924                                  					; Return: CX:DX	= clock	count
 11925                                  					; AL = 00h if clock was	read or	written	(via AH=0,1) since the previous
 11926                                  					; midnight
 11927                                  					; Otherwise, AL	> 0
 11928                                  		; 20/12/2023
 11929 00000535 30E4                    		xor	ah, ah
 11930 00000537 3826[8B04]              		cmp	byte [t_switch], ah ; 0
 11931                                  		;cmp	byte [t_switch], 0 ; use old method ? (>0 is yes)
 11932 0000053B 7505                    		jnz	short inc_case	; old method assumes that Int 1Ah returns rollover flag
 11933                                  		;xor	ah, ah		; new method assumes that Int 1Ah returns roll over count
 11934                                  					; and not flag
 11935 0000053D 0106[8904]              		add	[daycnt], ax
 11936 00000541 C3                      		retn
 11937                                  ; ---------------------------------------------------------------------------
 11938                                  
 11939                                  inc_case:
 11940 00000542 08C0                    		or	al, al
 11941 00000544 7404                    		jz	short no_rollover
 11942 00000546 FF06[8904]              		inc	word [daycnt]
 11943                                  no_rollover:
 11944 0000054A C3                      		retn
 11945                                  
 11946                                  ; ---------------------------------------------------------------------------
 11947                                  ; ---------------------------------------------------------------------------
 11948                                  ; 03/10/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
 11949                                  ; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0556h
 11950                                  
 11951                                  %if 1
 11952                                  
 11953 0000054B 4641543132202020        fat_12_id:	db 'FAT12   '
 11954 00000553 4641543136202020        fat_16_id:	db 'FAT16   '
 11955 0000055B 4641543332202020        fat_32_id:	db 'FAT32   '
 11956 00000563 4E4F204E414D452020-     nul_vid:	db 'NO NAME    '
 11956 0000056C 2020               
 11957                                  
 11958                                  %endif
 11959                                  
 11960                                  ; ---------------------------------------------------------------------------
 11961                                  
 11962                                  ;----------------------------------------------------------------------------
 11963                                  ; MSDISK.ASM - MSDOS 6.0 - 1991
 11964                                  ;----------------------------------------------------------------------------
 11965                                  ; 15/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 11966                                  ; 09/03/2019 - Retro DOS v4.0
 11967                                  
 11968                                  ; MSDISK.ASM - MSDOS 3.3 - 02/02/1988
 11969                                  ; 26/05/2018 - Retro DOS v3.0
 11970                                  ; 23/03/2018 - Retro DOS v2.0
 11971                                  
 11972                                  ;error_unknown_media equ	7	; for use in BUILD BPB call
 11973                                  
 11974                                  ;struc BPB_TYPE
 11975                                  ;.SECSIZE:	resw 1
 11976                                  ;.SECALL:	resb 1
 11977                                  ;.RESNUM:	resw 1
 11978                                  ;.FATNUM:	resb 1
 11979                                  ;.DIRNUM:	resw 1
 11980                                  ;.SECNUM:	resw 1
 11981                                  ;.FATID:	resb 1
 11982                                  ;.FATSIZE:	resw 1
 11983                                  ;.SLIM:		resw 1
 11984                                  ;.HLIM:		resw 1
 11985                                  ;.HIDDEN:	resw 1
 11986                                  ;.size:
 11987                                  ;endstruc
 11988                                  
 11989                                  ;-----------------------------------------------------------------
 11990                                  ;	disk interface routines
 11991                                  ;-----------------------------------------------------------------
 11992                                  
 11993                                  ; device attribute bits:
 11994                                  ;	bit 6 - get/set map for logical drives and generic ioctl.
 11995                                  
 11996                                  ;MAXERR		equ	5
 11997                                  ;MAX_HD_FMT_ERR	equ	2
 11998                                  
 11999                                  ;LSTDRV	equ 504h
 12000                                  
 12001                                  ; some floppies do not have changeline. as a result, media-check would
 12002                                  ; normally return i-don't-know, the dos would continually reread the fat and
 12003                                  ; discard cached data. we optimize this by implementing a logical door-latch:
 12004                                  ; it is physically impossible to change a disk in under 2 seconds. we retain
 12005                                  ; the time of the last successful disk operation and compare it with the current
 12006                                  ; time during media-check. if < 2 seconds and at least 1 timer tick has passed,
 12007                                  ; the we say no change. if > 2 seconds then we say i-don't-know. finally, 
 12008                                  ; since we cannot trust the timer to be always available, we record the number 
 12009                                  ; of media checks that have occurred when no apparent time has elapsed. while
 12010                                  ; this number is < a given threshold, we say no change. when it exceeds that
 12011                                  ; threshold, we say i-don't-know and reset the counter to 0. when we store 
 12012                                  ; the time of last successful access, if we see that time has passed too,
 12013                                  ; we reset the counter.
 12014                                  
 12015                                  accessmax	equ	5
 12016                                  
 12017                                  ; due to various bogosities, we need to continually adjust what the head
 12018                                  ; settle time is.  the following algorithm is used:
 12019                                  ;
 12020                                  ;   get the current head settle value.
 12021                                  ;   if it is 0, then
 12022                                  ;	set slow = 15
 12023                                  ;   else
 12024                                  ;	set slow = value
 12025                                  ;   ...
 12026                                  ;*********************************************
 12027                                  ;************ old algorithm ******************
 12028                                  ;*   if we are seeking and writing then
 12029                                  ;*	 use slow
 12030                                  ;*   else
 12031                                  ;*	 use fast
 12032                                  ;*********************************************
 12033                                  ;*********** ibm's requested logic ***********
 12034                                  ;   if we are seeking and writing and not on an at then
 12035                                  ;	use slow
 12036                                  ;   else
 12037                                  ;	use fast
 12038                                  ;   ...
 12039                                  ;   restore current head settle value
 12040                                  ;
 12041                                  ;
 12042                                  ;---------------------------------------
 12043                                  multrk_on	equ	10000000b	;user spcified mutitrack=on, or system turns
 12044                                  					; it on after handling config.sys file as a
 12045                                  					; default value, if multrk_flag = multrk_off1.
 12046                                  multrk_off1	equ	00000000b	;initial value. no "multitrack=" command entered.
 12047                                  multrk_off2	equ	00000001b	;user specified multitrack=off.
 12048                                  
 12049                                  ; close data segment, open Bios_Code segment
 12050                                  
 12051                                  ; 15/10/2022
 12052                                  
 12053                                  ; BIOSCODE:04A2h (MSDOS 6.21, IO.SYS)
 12054                                  
 12055                                  ;-----------------------------------------------------------------
 12056                                  ;	command jump table
 12057                                  ;-----------------------------------------------------------------
 12058                                  
 12059 0000056E 00                      		db 0
 12060                                  ; 11/12/2022
 12061                                  %if 0
 12062                                  
 12063                                  dsktbl:		db 26			; 2C7h:4A2h = 70h:2A12h
 12064                                  					; ((dtbl_siz-1)/2) ; this is the size of the table ; 26
 12065                                  		dw 1742h		; dsk_init
 12066                                  		dw 4EBh			; media_chk
 12067                                  		dw 592h			; get_bpb
 12068                                  		dw 0D5h			; bc_cmderr
 12069                                  		dw 857h			; dsk_read
 12070                                  		dw 83Dh			; x_bus_exit
 12071                                  		dw 558h			; ret_carry_clear
 12072                                  		dw 558h			; ret_carry_clear
 12073                                  		dw 849h			; dsk_writ
 12074                                  		dw 841h			; dsk_writv
 12075                                  		dw 558h			; ret_carry_clear
 12076                                  		dw 558h			; ret_carry_clear
 12077                                  		dw 0D5h			; bc_cmderr
 12078                                  		dw 80Ah			; dsk_open
 12079                                  		dw 81Ah			; dsk_close
 12080                                  		dw 831h			; dsk_rem
 12081                                  		dw 558h			; ret_carry_clear
 12082                                  		dw 558h			; ret_carry_clear
 12083                                  		dw 558h			; ret_carry_clear
 12084                                  		dw 0C6Bh		; do_generic_ioctl
 12085                                  		dw 558h			; ret_carry_clear
 12086                                  		dw 558h			; ret_carry_clear
 12087                                  		dw 558h			; ret_carry_clear
 12088                                  		dw 1124h		; ioctl_getown
 12089                                  		dw 1142h		; ioctl_setown
 12090                                  		dw 129Ah		; ioctl_support_query
 12091                                  
 12092                                  ;dtbl_siz equ $-dsktbl
 12093                                  
 12094                                  %endif
 12095                                  
 12096                                  ; 21/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
 12097                                  ; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0579h		
 12098                                  
 12099                                  		; 21/12/2023 - Retro DOS v5.0
 12100                                  		; 11/12/2022
 12101 0000056F 1A                      dsktbl:		db (dtbl_siz-1)/2	; 26 ; this is the size of the table
 12102 00000570 [4E1A]                  		dw dsk_init
 12103 00000572 [B805]                  		dw media_chk
 12104 00000574 [5706]                  		dw get_bpb
 12105                                  		;dw bc_cmderr
 12106 00000576 [490E]                  		dw ioctl_input ; PCDOS 7 ; 21/12/2023
 12107 00000578 [7209]                  		dw dsk_read
 12108 0000057A [5809]                  		dw x_bus_exit
 12109 0000057C [2206]                  		dw ret_carry_clear
 12110 0000057E [2206]                  		dw ret_carry_clear
 12111 00000580 [6409]                  		dw dsk_writ
 12112 00000582 [5C09]                  		dw dsk_writv
 12113 00000584 [2206]                  		dw ret_carry_clear
 12114 00000586 [2206]                  		dw ret_carry_clear
 12115                                  		;dw bc_cmderr
 12116 00000588 [F60D]                  		dw ioctl_output ; PCDOS 7 ; 21/12/2023
 12117 0000058A [2909]                  		dw dsk_open
 12118 0000058C [3809]                  		dw dsk_close
 12119 0000058E [4E09]                  		dw dsk_rem
 12120 00000590 [2206]                  		dw ret_carry_clear
 12121 00000592 [2206]                  		dw ret_carry_clear
 12122 00000594 [2206]                  		dw ret_carry_clear
 12123 00000596 [CB0E]                  		dw do_generic_ioctl
 12124 00000598 [2206]                  		dw ret_carry_clear
 12125 0000059A [2206]                  		dw ret_carry_clear
 12126 0000059C [2206]                  		dw ret_carry_clear
 12127 0000059E [A613]                  		dw ioctl_getown
 12128 000005A0 [C313]                  		dw ioctl_setown
 12129 000005A2 [2015]                  		dw ioctl_support_query
 12130                                  
 12131                                  dtbl_siz equ $-dsktbl
 12132                                  
 12133                                  ; =============== S U B	R O U T	I N E =======================================
 12134                                  
 12135                                  ; ---------------------------------------------------------------------------
 12136                                  ; setdrive scans through the data structure of bdss, and returns a pointer to
 12137                                  ; the one that belongs to the drive specified. carry is set if none exists
 12138                                  ; for the drive. Pointer is returned in es:[di]
 12139                                  ;
 12140                                  ;  AL contains the logical drive number.
 12141                                  ; ---------------------------------------------------------------------------
 12142                                  
 12143                                  SetDrive:
 12144                                  		;les	di, dword ptr ds:start_bds ; Point es:di to first bds
 12145 000005A4 C43E[1901]              		les	di, [start_bds] ; 19/10/2022
 12146                                  X_Scan_Loop:
 12147 000005A8 26384505                		cmp	[es:di+5], al	
 12148 000005AC 7409                    		jz	short X_SetDrv
 12149 000005AE 26C43D                  		les	di, [es:di]	; [es:di+BDS.link] ; Go	to next	bds
 12150 000005B1 83FFFF                  		cmp	di, 0FFFFh
 12151 000005B4 75F2                    		jnz	short X_Scan_Loop
 12152 000005B6 F9                      		stc
 12153                                  X_SetDrv:
 12154 000005B7 C3                      		retn
 12155                                  
 12156                                  ; ---------------------------------------------------------------------------
 12157                                  
 12158                                  ; 15/10/2022
 12159                                  
 12160                                  	; 21/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
 12161                                  	; PCDOS 7.1 IBMBIO.COM - BIOSCODE:05C2h
 12162                                  
 12163                                  ; ---------------------------------------------------------------------
 12164                                  ; if id is f9, have a 96tpi disk else
 12165                                  ; if bit 2 is 0 then media is not removable and could not have changed
 12166                                  ;  otherwise if within 2 secs of last disk operation media could not
 12167                                  ;    have changed, otherwise dont know if media has changed
 12168                                  ; ---------------------------------------------------------------------
 12169                                  
 12170                                  media_chk:				; 2C7h:4EBh = 70h:2A5Bh
 12171 000005B8 E8E9FF                  		call	SetDrive
 12172 000005BB BE0100                  		mov	si, 1
 12173                                  		; 21/12/2023
 12174 000005BE 26F6454001              		test	byte [es:di+40h], 1
 12175                                  		;test	byte [es:di+24h], 1 ; [es:di+BDS.flags+1]
 12176                                  					; fchanged_by_format
 12177 000005C3 7415                    		jz	short WeAreNotFakingIt
 12178                                  		; 21/12/2023
 12179 000005C5 26806540FE              		and	byte [es:di+40h], 0FEh
 12180                                  		; 12/12/2022
 12181                                  		;and	byte [es:di+24h], 0FEh ; ~fchanged_by_format
 12182                                  		;;and	word [es:di+23h], 0FEFFh ; [es:di+BDS.flags]
 12183                                  					; ~fchanged_by_format ;	reset flag
 12184 000005CA C606[1E01]FF            		mov	byte [tim_drv], 0FFh ; -1
 12185                                  					; Ensure that we ask the rom if media has changed
 12186                                  		; 21/12/2023
 12187 000005CF 26F6453F01              		test	byte [es:di+3Fh], 1
 12188                                  		;test	byte [es:di+23h], 1 ; [es:di+BDS.flags]
 12189                                  					; fnon_removable
 12190 000005D4 740B                    		jz	short wehaveafloppy
 12191                                  		;mov	si, 0FFFFh	; Indicate media changed
 12192                                  		; 11/08/2023
 12193 000005D6 F7DE                    		neg	si		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:05E0h
 12194 000005D8 EB2B                    		jmp	short Media_Done ; Media_Done
 12195                                  ; ---------------------------------------------------------------------------
 12196                                  
 12197                                  WeAreNotFakingIt:
 12198                                  		; 21/12/2023
 12199 000005DA 26F6453F01              		test	byte [es:di+3Fh], 1
 12200                                  		;test	byte [es:di+BDS.flags], fnon_removable			
 12201                                  		;test	byte [es:di+23h], 1
 12202 000005DF 7524                    		jnz	short Media_Done
 12203                                  wehaveafloppy:
 12204                                  		;xor	si, si ; 0	; Presume "I don't know"
 12205                                  		; 11/08/2023
 12206 000005E1 4E                      		dec	si ; 0 		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:05EBh
 12207                                  
 12208                                  		; If we have a floppy with changeline support, we ask the ROM
 12209                                  		; to determine if media has changed. We do not perform the
 12210                                  		; 2 second check for these drives.
 12211                                  
 12212 000005E2 803E[7700]00            		cmp	byte [fhave96], 0	; Do we	have changeline	support?
 12213 000005E7 740A                    		jz	short mChk_NoChangeLine	; Brif not
 12214 000005E9 E83A15                  		call	mediacheck	;  Call	into removable routine
 12215 000005EC 7236                    		jb	short err_exitj
 12216 000005EE E89E16                  		call	haschange
 12217 000005F1 7512                    		jnz	short Media_Done
 12218                                  mChk_NoChangeLine:
 12219                                  		; If we come here, we have a floppy with no changeline support
 12220                                  			
 12221 000005F3 BE0100                  		mov	si, 1		; Presume no change
 12222 000005F6 A0[1E01]                		mov	al, [tim_drv]	; Last drive accessed
 12223 000005F9 263A4504                		cmp	al, [es:di+4]	; [es:di+BDS.drivenum]
 12224                                  					; Is drive of last access the same?
 12225 000005FD 7505                    		jnz	short Media_Unk	; No, then "i don't know"
 12226 000005FF E82800                  		call	Check_Time_Of_Access
 12227 00000602 EB01                    		jmp	short Media_Done
 12228                                  ; ---------------------------------------------------------------------------
 12229                                  
 12230                                  Media_Unk:
 12231 00000604 4E                      		dec	si		; ; Return "I don't know"
 12232                                  
 12233                                  		; SI now contains the correct value for media change.
 12234                                  		; Clean up the left overs
 12235                                  Media_Done:
 12236                                  		; 19/10/2022
 12237 00000605 06                      		push	es
 12238 00000606 C41E[1200]              		les	bx, [ptrsav]
 12239 0000060A 2689770E                		mov	[es:bx+0Eh], si	; [es:bx+trans]
 12240 0000060E 07                      		pop	es
 12241 0000060F 09F6                    		or	si, si
 12242 00000611 790F                    		jns	short ret_carry_clear ;	volidok
 12243 00000613 803E[7700]00            		cmp	byte [fhave96], 0
 12244 00000618 7403                    		jz	short mChk1_NoChangeLine ; Brif	no changeline support
 12245 0000061A E80416                  		call	media_set_vid
 12246                                  mChk1_NoChangeLine:
 12247 0000061D C606[1E01]FF            		mov	byte [tim_drv], 0FFh ; -1
 12248                                  					; Make sure we ask rom for media check
 12249                                  ret_carry_clear:			
 12250 00000622 F8                      		clc			; volidok
 12251 00000623 C3                      		retn
 12252                                  ; ---------------------------------------------------------------------------
 12253                                  
 12254                                  err_exitj:
 12255 00000624 E88107                  		call	maperror	; guaranteed to	set carry
 12256                                  ret81:					
 12257 00000627 B481                    		mov	ah, 81h		; return error status
 12258 00000629 C3                      		retn			; return with carry set
 12259                                  
 12260                                  ; =============== S U B	R O U T	I N E =======================================
 12261                                  
 12262                                  ; ---------------------------------------------------------------------------
 12263                                  ; perform a check on the time passed since the last access for this physical
 12264                                  ; drive.
 12265                                  ; we are accessing the same drive. if the time of last successful access was
 12266                                  ; less than 2 seconds ago, then we may presume that the disk was not changed.
 12267                                  ; returns in si:
 12268                                  ;	0 - if time of last access was >= 2 seconds
 12269                                  ;	1 - if time was < 2 seconds (i.e no media change assumed)
 12270                                  ; registers affected ax,cx,dx, flags.
 12271                                  ;
 12272                                  ;	assume es:di -> bds, ds->Bios_Data
 12273                                  ; ---------------------------------------------------------------------------
 12274                                  
 12275                                  		; 21/12/2023 - Retro DOS v5.0 IBMBIO.COM
 12276                                  		; 19/10/2022
 12277                                  Check_Time_Of_Access:
 12278 0000062A BE0100                  		mov	si, 1		; presume no change.
 12279 0000062D E801FF                  		call	GetTickCnt	; cx:dx	is the elapsed time
 12280                                  		; 21/12/2023
 12281 00000630 268B4579                		mov	ax, [es:di+79h]
 12282                                  		;mov	ax, [es:di+47h]	; [es:di+BDS.tim_lo]
 12283                                  					; get stored time
 12284 00000634 29C2                    		sub	dx, ax
 12285                                  		; 21/12/2023
 12286 00000636 268B457B                		mov	ax, [es:di+7Bh]
 12287                                  		;mov	ax, [es:di+49h]	; [es:di+BDS.tim_hi]
 12288 0000063A 19C1                    		sbb	cx, ax
 12289                                  		; 11/08/2023
 12290                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0646h
 12291                                  		;mov	al, [accesscount]
 12292 0000063C 7515                    		jnz	short timecheck_unk ; cx<>0 => >1 hour
 12293 0000063E 09D2                    		or	dx, dx		; time must pass
 12294 00000640 750C                    		jnz	short timepassed ; yes, examine max value
 12295                                  		; 11/08/2023
 12296                                  		;inc	al
 12297                                  		;cmp	al, 5
 12298                                  		;;inc	byte [accesscount]
 12299                                  		;;cmp	byte [accesscount], 5
 12300                                  		;			; if count is less than threshold, ok
 12301                                  		;jb	short timecheck_ret
 12302                                  		;;dec	byte [accesscount] ; don't let the count wrap
 12303                                  		; 11/08/2023
 12304                                  		;dec	al
 12305                                  		;jmp	short timecheck_unk ; "i don't know" if media changed
 12306                                  		; 11/08/2023
 12307 00000642 803E[1D01]04            		cmp	byte [accesscount], 4
 12308 00000647 730A                    		jnb	short timecheck_unk
 12309 00000649 FE06[1D01]              		inc	byte [accesscount]
 12310 0000064D C3                      		retn
 12311                                  
 12312                                  ; ---------------------------------------------------------------------------
 12313                                  
 12314                                  timepassed:
 12315 0000064E 83FA24                  		cmp	dx, 36		; 18*2 ; 18.2 tics per second.
 12316                                  					; min elapsed time? (2 seconds)
 12317 00000651 7601                    		jbe	short timecheck_ret ; yes, presume no change
 12318                                  
 12319                                  		; everything indicates that we do not know what has happened.
 12320                                  timecheck_unk:
 12321 00000653 4E                      		dec	si		; presume i don't know
 12322                                  timecheck_ret:
 12323                                  		; 11/08/2023
 12324                                  		;mov	[accesscount], al
 12325 00000654 C3                      		retn
 12326                                  
 12327                                  ; ---------------------------------------------------------------------------
 12328                                  ; 15/10/2022
 12329                                  Err_Exitj2:
 12330 00000655 EBCD                    		jmp	short err_exitj
 12331                                  
 12332                                  ; ---------------------------------------------------------------------------
 12333                                  
 12334                                  ; 15/10/2022
 12335                                  
 12336                                  ; ==========================================================================
 12337                                  ; Build a valid bpb for the disk in the drive.
 12338                                  ; ==========================================================================
 12339                                  
 12340                                  
 12341                                  		; 21/12/2023 - Retro DOS v5.0 IBMBIO.COM
 12342                                  		; 19/10/2022
 12343                                  get_bpb:				; 2C7h:592h = 70h:2B02h
 12344 00000657 268A25                  		mov	ah, [es:di]	; get fat id byte read by dos
 12345 0000065A E847FF                  		call	SetDrive	; get the correct bds for the drive
 12346                                  		; 21/12/2023
 12347 0000065D 26F6453F01              		test	byte [es:di+3Fh], 1
 12348                                  		;test	byte [es:di+23h], 1 ; [es:di+BDS.flags]
 12349                                  					; fnon_removable
 12350 00000662 7523                    		jnz	short already_gotbpb ; no need to build	for fixed disks
 12351                                  
 12352                                  		; let's set the default value for volid,vol_serial,
 12353                                  		; filesys_id in bds table
 12354                                  
 12355 00000664 E83600                  		call	clear_ids
 12356                                  		;mov	ds:set_id_flag,	1 ; indicate to	set system id in bds
 12357 00000667 C606[9B04]01            		mov	byte [set_id_flag], 1
 12358 0000066C E86700                  		call	GetBp		; build	a bpb if necessary
 12359 0000066F 72B6                    		jb	short ret81
 12360                                  		;cmp	ds:set_id_flag,	2 ; already, volume_label set from boot
 12361 00000671 803E[9B04]02            		cmp	byte [set_id_flag], 2
 12362                                  		;mov	ds:set_id_flag,	0 ; record to bds table?
 12363 00000676 C606[9B04]00            		mov	byte [set_id_flag], 0
 12364 0000067B 740A                    		jz	short already_gotbpb ; do not set it again from	root dir
 12365                                  					; otherwise, conventional boot record
 12366                                  		;cmp	ds:fhave96, 0	; do we	have changeline	support?
 12367 0000067D 803E[7700]00            		cmp	byte [fhave96], 0
 12368 00000682 7403                    		jz	short already_gotbpb ; brif not
 12369 00000684 E80E16                  		call	set_volume_id
 12370                                  already_gotbpb:
 12371 00000687 83C706                  		add	di, 6		; BDS.BPB
 12372                                  					; return the bpb from the current bds
 12373                                  
 12374                                  ;		fall into setptrsav, es:di -> result
 12375                                  
 12376                                  ; ---------------------------------------------------------------------------
 12377                                  
 12378                                  ; 15/10/2022
 12379                                  
 12380                                  ; ==========================================================================
 12381                                  ;Setptrsav is also jumped to from dsk_init (msbio2.asm). In both cases, the
 12382                                  ;pointer to be returned is in es:di. We were incorrectly returning ds:di.
 12383                                  ;Note that this works in most cases because most pointers are in Bios_Data.
 12384                                  ;It fails, for instance, when we install an external drive using driver.sys
 12385                                  ;because then the BDS segment is no longer Bios_Data. 
 12386                                  ;NB: It is fine to corrupt cx because this is not a return value and anyway
 12387                                  ;this returns to Chardev_entry (msbio1.asm) where all registers are 
 12388                                  ;restored before returning to the caller.
 12389                                  ; ==========================================================================
 12390                                  
 12391                                  ; 21/12/2023
 12392                                  %if 0
 12393                                  		; 19/10/2022
 12394                                  SetPtrSav:	; return point for dsk_init
 12395                                  		mov	cx, es		; save es
 12396                                  		;les	bx, ds:ptrsav
 12397                                  		les	bx, [ptrsav]
 12398                                  		mov	[es:bx+0Dh], ah	; [es:bx+media]
 12399                                  		mov	[es:bx+12h], di	; [es:bx+count]
 12400                                  		mov	[es:bx+14h], cx	; [es:bx+count+2]
 12401                                  		clc
 12402                                  		retn
 12403                                  %endif
 12404                                  		; 21/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
 12405                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0698h
 12406                                  SetPtrSav:	
 12407                                  		; return point for dsk_init
 12408 0000068A 1E                      		push	ds
 12409                                  		;lds	bx, ds:ptrsav
 12410 0000068B C51E[1200]              		lds	bx, [ptrsav]
 12411 0000068F 88670D                  		mov	[bx+0Dh], ah	; [bx+media]
 12412 00000692 897F12                  		mov	[bx+12h], di	; [bx+count]
 12413 00000695 8C4714                  		mov	[bx+14h], es	; [bx+count+2]
 12414 00000698 1E                      		push	ds
 12415 00000699 07                      		pop	es
 12416 0000069A 1F                      		pop	ds
 12417 0000069B F8                      		clc
 12418 0000069C C3                      		retn
 12419                                  
 12420                                  ; =============== S U B	R O U T	I N E =======================================
 12421                                  
 12422                                  ; 15/10/2022
 12423                                  
 12424                                  ; -----------------------------------------------------
 12425                                  ; clear ids in bds table. only applied for floppies.
 12426                                  ;input:  es:di -> bds table
 12427                                  ;	assumes ds: -> Bios_Data
 12428                                  ;output: volid set to "NO NAME    "
 12429                                  ;	 vol_serial set to 0.
 12430                                  ;	 filesys_id set to "FAT12   " or "FAT16   "
 12431                                  ;	   depending on the flag fatsize in bds.
 12432                                  ;
 12433                                  ;	trashes si, cx
 12434                                  ; -----------------------------------------------------
 12435                                  
 12436                                  ;size_of_EXT_BOOT_VOL_LABEL equ 11
 12437                                  ;size_of_EXT_SYSTEM_ID equ 8
 12438                                  
 12439                                  ; 11/09/2023
 12440                                  ; 14/08/2023
 12441                                  ;BDS.fatsiz equ 1Fh
 12442                                  ; 21/12/2023
 12443                                  ;BDS.fatsiz equ 59
 12444                                  
 12445                                  		; 22/12/2023
 12446                                  		; 21/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
 12447                                  clear_ids:
 12448                                  		;mov	al, [es:di+1Fh] ; mov al,[es:di+BDS.fatsiz]
 12449                                  		; 21/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM BugFix)
 12450 0000069D 268A5D3B                		mov	bl, [es:di+3Bh] ; mov bl,[es:di+BDS.fatsiz]; *+
 12451                                  clear_ids_x:
 12452                                  		; 21/12/2023 
 12453                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:06ABh)
 12454                                  		; 11/09/2023		
 12455                                   		; (MSDOS 5.0 IO.SYS - BIOSCODE:05D9h)
 12456 000006A1 57                      		push	di
 12457 000006A2 31C9                    		xor	cx, cx		; no serial number
 12458                                  		; 21/12/2023
 12459 000006A4 26898D8900              		mov	[es:di+89h], cx	; [es:di+BDS.vol_serial]
 12460 000006A9 26898D8B00              		mov	[es:di+8Bh], cx	; [es:di+BDS.vol_serial+2]
 12461                                  		;mov	[es:di+57h], cx	; [es:di+BDS.vol_serial]
 12462                                  		;mov	[es:di+59h], cx	; [es:di+BDS.vol_serial+2]
 12463                                  
 12464                                  		; BUGBUG - there's a lot in common here and with
 12465                                  		; mov_media_ids.. see if we can save some space by
 12466                                  		; merging them... jgl
 12467                                  
 12468                                  		;mov	cx, 11		; size_of_EXT_BOOT_VOL_LABEL
 12469                                  		; 10/12/2022
 12470 000006AE B10B                    		mov	cl, 11 ; cx = 11
 12471                                  
 12472                                  		;;mov	si, offset vol_no_name ; "NO NAME    "
 12473                                  		;mov	si, vol_no_name	; 19/10/2022
 12474                                  		; 22/12/2023
 12475                                  		;mov	si, offset nul_vid ; "NO NAME    "
 12476 000006B0 BE[6305]                		mov	si, nul_vid
 12477                                  
 12478                                  		; 21/12/2023
 12479 000006B3 83C77D                  		add	di, 125
 12480                                  		;add	di, 75		; BDS.volid
 12481                                  		
 12482                                  		;rep movsb
 12483                                  		; 21/12/2023
 12484                                  		;rep movs byte ptr es:[di], byte ptr cs:[si] ; cs rep movsb
 12485                                  		; 26/12/2023
 12486                                  		;cs	; vol_no_name is in BIOSCODE segment
 12487                                  		;rep movsb
 12488 000006B6 F3                      		rep
 12489 000006B7 2E                      		cs
 12490 000006B8 A4                      		movsb
 12491                                  
 12492                                  		; 11/09/2023 (BugFix, DI is not start addr of BDS structure here)
 12493                                  		;;test	byte [es:di+BDS.fatsiz], fbig
 12494                                  		; (MSDOS 5.0 IO.SYS - BIOSCODE:05EFh)
 12495                                  		;test	byte [es:di+1Fh], 40h
 12496                                  		; 21/12/2023 - Retro DOS v5.0
 12497                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:06C3h)
 12498                                  		;test	byte [es:di+59], 20h 
 12499                                  			; (here, es:di points to the BDS offset +136)
 12500                                  			; purpose: test byte [es:di+BDS.fatsiz], fbigbig
 12501                                  			; applied: test byte [es:BDS.fatsiz+136], fbigbig -BUG!-
 12502                                  
 12503                                  			; (PCDOS 7.1 BUG note: 26/06/2023 - Erdogan Tan)
 12504                                  			;; ! NOTE - 11/08/2023 - Erdogan Tan (Retro DOS v4.2 IO.SYS bugfix)
 12505                                  			; Microsoft/IBM code has a bug here because the BDS's
 12506                                  			; .volid and .filesys_id fields will be reset
 12507                                  			; (to their default text) according to 'BDS.fatsiz' flags
 12508                                  			; at the BDS offset 59 but current (this) code checks flags
 12509                                  			; at ES:DI+59 while DI points the BDS offset 136!? ; (PCDOS 7.1)
 12510                                  			;; at the BDS offset 31 but current (this) code checks flags
 12511                                  			;; at ES:DI+31 while DI points the BDS offset 86!? ; (MSDOS 6.22)
 12512                                  			;
 12513                                  			; Correct Code:
 12514                                  			; ;test byte [ES:59],20h or [ES:BDS.fatsiz],fbigbig  ; (PCDOS 7.1)	
 12515                                  			; ;;test byte [ES:31],40h or [ES:BDS.fatsiz],fbig  ; (MSDOS 6.22)
 12516                                  			; 11/09/2023
 12517                                  			; (before 'rep movsb') 'mov al,[es:di+BDS.Fatsiz]' and then
 12518                                  			; (after 'rep movsb') 'test al,fbig' (AL is free/proper to use here)	
 12519                                  			;
 12520                                  			; Same BUG is existing in MSDOS 6.22 IO.SYS - BIOSCODE:05EFh
 12521                                  			; and in Windows ME IO.SYS - BIOSCODE:0E1Ah as 'test byte [es:di+59],20h'
 12522                                  
 12523                                  			;
 12524                                  			; (Why this bug did not affect MSDOS and PCDOS 7.x applications:
 12525                                  			; 'clear_ids' is used for floppy disks only and the default
 12526                                  			; option of 'clear_ids' is FAT12 volid and filesys_id text
 12527                                  			; when the flag bit has wrong value for FAT16/40h or FAT32/20h.)
 12528                                  
 12529                                  		; 21/12/2023 - Retro DOS v5.0
 12530                                  		;mov	si, offset fat_32_id ; "FAT32   "
 12531 000006B9 BE[5B05]                		mov	si, fat_32_id	
 12532                                  
 12533                                  		; 21/12/2023
 12534                                  		; BugFix (of the PCDOS 7.1 IBMBIO.COM BUG) ; *+
 12535                                  		;test	bl, fbigbig ; FAT32 flag
 12536 000006BC F6C320                  		test	bl, 20h ; * ; BL = [es:BDS.fatsiz] = [es:59]
 12537 000006BF 750B                    		jnz	short ci_bigfat
 12538                                  
 12539                                  		;mov	si, offset fat_16_id ; "FAT16	"
 12540 000006C1 BE[5305]                		mov	si, fat_16_id	; 19/10/2022
 12541                                  		
 12542                                  		; 21/12/2023
 12543                                  		; !BUG! (PCDOS 7.1 IBMBIO.COM BIOSCODE:06CDh)
 12544                                  		;test	byte [es:di+59], 40h ; [es:di+BDS.fatsiz], fbig
 12545                                  		; BugFix ; *+
 12546                                  		;test	bl, fbig ; FAT16 flag
 12547 000006C4 F6C340                  		test	bl, 40h ; * ; Retro DOS v5.0
 12548                                  		;;test	al, 40h ; * ; Retro DOS v4.2
 12549 000006C7 7503                    		jnz	short ci_bigfat
 12550                                  
 12551                                  		;mov	si, offset fat_12_id ; "FAT12	"
 12552 000006C9 BE[4B05]                		mov	si, fat_12_id	; 19/10/2022
 12553                                  ci_bigfat:
 12554                                  		;mov	cx, 8		; size_of_EXT_SYSTEM_ID
 12555                                  		; 10/12/2022
 12556 000006CC B108                    		mov	cl, 8 ; cx = 8 
 12557 000006CE 83C705                  		add	di, 5		; (BDS.filesys_id-BDS.volid)-size_of_EXT_BOOT_VOL_LABEL
 12558                                  					; filesys_id field
 12559                                  		;rep movsb
 12560                                  		; 21/12/2023 - Retro DOS v5.0
 12561                                  		;rep movs byte ptr es:[di], byte ptr cs:[si] ; 0F3h,2Eh,0A4h
 12562                                  		; 26/12/2023
 12563                                  		;cs	; fat32_id, fat16_id and fat12_id are in BIOSCODE segment
 12564                                  		;rep movsb
 12565 000006D1 F3                      		rep
 12566 000006D2 2E                      		cs
 12567 000006D3 A4                      		movsb
 12568                                  
 12569 000006D4 5F                      		pop	di		; restore bds pointer
 12570                                  getret_exit:		; 21/12/2023
 12571 000006D5 C3                      		retn
 12572                                  
 12573                                  ; =============== S U B	R O U T	I N E =======================================
 12574                                  
 12575                                  ; 15/10/2022
 12576                                  
 12577                                  ; ---------------------------------------------------------------------------
 12578                                  ;	getbp - return bpb from the drive specified by the bds.
 12579                                  ;	    if the return_fake_bpb flag is set, then it does nothing.
 12580                                  ;	    note that we never come here for fixed disks.
 12581                                  ;	    for all other cases,
 12582                                  ;	      - it reads boot sector to pull out the bpb
 12583                                  ;	      - if no valid bpb is found, it then reads the fat sector,
 12584                                  ;		to get the fat id byte to build the bpb from there.
 12585                                  ;
 12586                                  ;   inputs:	es:di point to correct bds.
 12587                                  ;
 12588                                  ;   outputs:	fills in bpb in current bds if valid bpb or fat id on disk.
 12589                                  ;		carry set, and al=7 if invalid disk.
 12590                                  ;		carry set and error code in al if other error.
 12591                                  ;		if failed to recognize the boot record, then will set the
 12592                                  ;		set_id_flag to 0.
 12593                                  ;		this routine will only work for a floppy diskette.
 12594                                  ;		     for a fixed disk, it will just return.
 12595                                  ;
 12596                                  ;	****** Note: getbp is a clone of getbp which uses the newer
 12597                                  ;	  segment definitions. It should be migrated towards.
 12598                                  ;	   now es:di has the bds, ds: has Bios_Data
 12599                                  ; ---------------------------------------------------------------------------
 12600                                  
 12601                                  		; 29/12/2023
 12602                                  		; 21/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
 12603                                  GetBp:
 12604                                  		; if returning fake bpb then return bpb as is.
 12605                                  		; 21/12/2023
 12606 000006D6 26F6453F05              		test	byte [es:di+3Fh], 5 ; PCDOS 7.1
 12607                                  		;test	byte [es:di+BDS.flags], return_fake_bpb|fnon_removable		
 12608                                  		;test	byte [es:di+23h], 5 ; MSDOS 6.22 (& MSDOS 5.0)
 12609                                  		;jz	short getbp1	; getbp1
 12610                                  		;jmp	getret_exit
 12611                                  		; 21/12/2023
 12612 000006DB 75F8                    		jnz	short getret_exit
 12613                                  ; ---------------------------------------------------------------------------
 12614                                  getbp1:	
 12615 000006DD 51                      		push	cx
 12616 000006DE 52                      		push	dx
 12617 000006DF 53                      		push	bx
 12618                                  
 12619                                  		; attempt to read in boot sector and determine bpb.
 12620                                  		; we assume that the 2.x and greater dos disks all
 12621                                  		; have a valid boot sector.
 12622                                  
 12623 000006E0 E8CF00                  		call	readbootsec
 12624 000006E3 720A                    		jb	short getbp_err_ret_brdg ; carry set if there was error.
 12625 000006E5 09DB                    		or	bx, bx		; bx is	0 if boot sector is valid.
 12626 000006E7 7509                    		jnz	short dofatbpb
 12627 000006E9 E81401                  		call	movbpb		; move bpb into	registers
 12628                                  		;jmp	short Has1
 12629                                  		; 21/12/2023 - Retro DOS v5.0 (PCDOS 7.1) IBMBIO.COM
 12630 000006EC E9B500                  		jmp	getret
 12631                                  ; ---------------------------------------------------------------------------
 12632                                  
 12633                                  getbp_err_ret_brdg:
 12634 000006EF E9B600                  		jmp	getbp_err_ret
 12635                                  ; ---------------------------------------------------------------------------
 12636                                  
 12637                                  		; we have a 1.x diskette. In this case read in the fat ID byte
 12638                                  		; and fill in bpb from there.
 12639                                  dofatbpb:				
 12640 000006F2 E8B401                  		call	readfat		; puts media descriptor	byte in	ah
 12641 000006F5 72F8                    		jb	short getbp_err_ret_brdg
 12642                                  		;cmp	ds:fhave96, 0	;  changeline support available?
 12643 000006F7 803E[7700]00            		cmp	byte [fhave96], 0 ; 19/10/2022
 12644 000006FC 7403                    		jz	short bpb_nochangeline ; brif not
 12645 000006FE E83515                  		call	hidensity	; may not return! May add sp, 2	and
 12646                                  					; jump to has1!!!!!! or	has720K
 12647                                  bpb_nochangeline:		; test for a valid 3.5" medium			
 12648                                  		; 21/12/2023 - Retro DOS v5.0
 12649 00000701 26807D3E02              		cmp	byte [es:di+3Eh], 2
 12650                                  		;cmp	byte [es:di+22h], 2 ; [es:di+BDS.formfactor]
 12651                                  					; ffSmall
 12652 00000706 7512                    		jnz	short is_floppy
 12653 00000708 80FCF9                  		cmp	ah, 0F9h	; is it	a valid	fat id byte for	3.5" ?
 12654 0000070B 7512                    		jnz	short got_unknown_medium
 12655                                  Has720K:
 12656                                  		; 21/12/2023
 12657                                  		;;mov	bx, offset sm92 ; pointer to correct bpb
 12658                                  		;mov	bx, sm92	; 19/10/2022
 12659                                  
 12660                                  		; es points to segment of bds. the following should be modified
 12661                                  		; to get spf,csec,spau,spt correctly. it had been wrong if
 12662                                  		; driver.sys is loaded since the bds is inside the driver.sys.
 12663                                  
 12664                                  		; 21/12/2023
 12665                                  		;; 10/12/2022
 12666                                  		;;mov	al, [bx+0]	; [bx+bpbtype.spf]
 12667                                  		;; 21/12/2022
 12668                                  		;mov	al, [bx]
 12669                                  		;mov	cx, [bx+3]	; [bx+bpbtype.csec]
 12670                                  		;mov	dx, [bx+5]	; [bx+bpbtype.spau]
 12671                                  		;mov	bx, [bx+1]	; [bx+bpbtype.spt]
 12672                                  		;; 19/10/2022 - Temporary !
 12673                                  		;;db	8Ah, 87h, 0, 0	; mov al, [bx+0]
 12674                                  		;;db	8Bh, 8Fh, 3, 0	; mov cx, [bx+3]
 12675                                  		;;db	8Bh, 97h, 5, 0	; mov dx, [bx+5]
 12676                                  		;;db	8Bh, 9Fh, 1, 0	; mov bx, [bx+1]
 12677                                  
 12678                                  		; 21/12/2023 - Retro DOS v5.0
 12679 0000070D B003                    		mov	al, 3		; bpbtype.sbf = 3
 12680 0000070F B9A005                  		mov	cx, 1440	; bpbtype.csec = 1440
 12681 00000712 BA0202                  		mov	dx, 202h	; dl = bpbtype.spau = 2
 12682                                  					; dh = bpbtype.chead = 2
 12683 00000715 BB0970                  		mov	bx, 7009h	; bl = bpbtype.spt = 9
 12684                                  					; bh = bpbtype.dire = 112
 12685 00000718 EB30                    		jmp	short Has1
 12686                                  ; ---------------------------------------------------------------------------
 12687                                  
 12688                                  is_floppy:			; must be a 5.25" floppy if we come here
 12689 0000071A 80FCF8                  		cmp	ah, 0F8h	; valid	media??	(0F8h-0FFh)
 12690                                  		;jb	short got_unknown_medium
 12691                                  		; 21/12/2023
 12692 0000071D 730A                    		jnb	short chk_160K
 12693                                  ; ---------------------------------------------------------------------------
 12694                                  		; 21/12/2023
 12695                                  		; we have a 3.5" diskette for which we cannot build a bpb.
 12696                                  		; we do	not assume any type of bpb for this medium.
 12697                                  got_unknown_medium:
 12698                                  		;mov	ds:set_id_flag,	0
 12699 0000071F C606[9B04]00            		mov	byte [set_id_flag], 0
 12700 00000724 B007                    		mov	al, 7
 12701 00000726 F9                      		stc
 12702 00000727 EB7B                    		jmp	short getret
 12703                                  ; ---------------------------------------------------------------------------
 12704                                  chk_160K:
 12705 00000729 B001                    		mov	al, 1		; set number of	fat sectors
 12706 0000072B BB0840                  		mov	bx, 16392	; 64*256+8
 12707                                  					; set dir entries and sector max
 12708 0000072E B94001                  		mov	cx, 320		; 40*8
 12709                                  					; set size of drive
 12710 00000731 BA0101                  		mov	dx, 257		; 01*256+1
 12711                                  					; set head limit and sec/all unit
 12712                                  		; 21/12/2023
 12713                                  		;mov	al, 1		; bpbtype.sbf = 1
 12714                                  		;mov	bx, 4008h	; bl = bpbtype.spt = 8
 12715                                  		;			; bh = bpbtype.dire = 64
 12716                                  		;mov	cx, 140h	; bpbtype.csec = 320
 12717                                  		;mov	dx, 101h	; dl = bpbtype.spau = 1
 12718                                  		;			; dh = bpbtype.chead = 1
 12719                                  
 12720 00000734 F6C402                  		test	ah, 2		; test for 8 or	9 sector
 12721 00000737 7505                    		jnz	short has8	; nz = has 8 sectors
 12722                                  		
 12723                                  		; 29/12/2023
 12724                                  		;inc	al	; 2 	; inc number of	fat sectors
 12725                                  		;inc	bl	; 9	; inc sector max
 12726 00000739 40                      		inc	ax
 12727 0000073A 43                      		inc	bx
 12728                                  
 12729                                  		;add	cx, 40		; increase size	(to 360)
 12730                                  		; 18/12/2022
 12731 0000073B 80C128                  		add	cl, 40	; 28h	; 180K (360 sectors)
 12732                                  has8:
 12733 0000073E F6C401                  		test	ah, 1		; test for 1 or	2 heads
 12734 00000741 7407                    		jz	short Has1	; jz = 1 head
 12735 00000743 01C9                    		add	cx, cx		; double size of disk
 12736 00000745 B770                    		mov	bh, 112		; increase number of directory entries
 12737 00000747 FEC6                    		inc	dh	; 2	; inc sec/all unit
 12738                                  		; 29/12/2023
 12739                                  		;inc	dl	; 2	; inc head limit
 12740 00000749 42                      		inc	dx
 12741                                  Has1:
 12742                                  		; 02/09/2023 (PCDOS 7.1, IBMBIO.COM - BIOSCODE:0754h)
 12743 0000074A 1E                      		push	ds
 12744 0000074B 06                      		push	es
 12745 0000074C 1F                      		pop	ds
 12746                                  
 12747                                  		;mov	[es:di+8], dh	; [es:di+BDS.secperclus]
 12748                                  		;mov	[es:di+0Ch], bh	; [es:di+BDS.direntries]
 12749                                  		;mov	[es:di+0Eh], cx	; [es:di+BDS.totalsecs16]
 12750                                  		;mov	[es:di+10h], ah	; [es:di+BDS.media]
 12751                                  		;mov	[es:di+11h], al	; [es:di+BDS.fatsecs]
 12752                                  		;mov	[es:di+13h], bl	; [es:di+BDS.secpertrack]
 12753                                  		;mov	[es:di+15h], dl	; [es:di+BDS.heads]
 12754                                  
 12755 0000074D 887508                  		mov	[di+8], dh	; [di+BDS.secperclus]
 12756 00000750 30F6                    		xor	dh, dh
 12757 00000752 895515                  		mov	[di+15h], dx	; [di+BDS.heads]
 12758 00000755 88FA                    		mov	dl, bh
 12759 00000757 89550C                  		mov	[di+0Ch], dx	; [di+BDS.direntries]
 12760 0000075A 894D0E                  		mov	[di+0Eh], cx	; [di+BDS.totalsecs16]
 12761 0000075D 894D1B                  		mov	[di+1Bh], cx	; [di+BDS.totalsecs32]
 12762 00000760 886510                  		mov	[di+10h], ah	; [di+BDS.media]
 12763 00000763 88C2                    		mov	dl, al
 12764 00000765 895511                  		mov	[di+11h], dx	; [di+BDS.fatsecs]
 12765 00000768 88DA                    		mov	dl, bl
 12766 0000076A 895513                  		mov	[di+13h], dx	; [di+BDS.secpertrack]
 12767                                  
 12768                                  		; the BDS_BPB.BPB_HIDDENSECTORS+2 field and the
 12769                                  		; BDS_BPB.BPB_BIGTOTALSECTORS field need to be set
 12770                                  		; to 0 since this code is for floppies
 12771                                  
 12772                                  		; 18/12/2022
 12773                                  		;mov	word [es:di+19h], 0 ; [es:di+BDS.hiddensecs+2]
 12774                                  		;mov	word [es:di+17h], 0 ; [es:di+BDS.hiddensecs]
 12775                                  		;mov	word [es:di+1Dh], 0 ; [es:di+BDS.totalsecs32+2]
 12776                                  		; 18/12/2022
 12777 0000076D 29C9                    		sub	cx, cx ; 0
 12778                                  		;mov	[es:di+19h], cx ; 0 ; [es:di+BDS.hiddensecs+2]
 12779                                  		;mov	[es:di+17h], cx ; 0 ; [es:di+BDS.hiddensecs]
 12780                                  		;mov	[es:di+1Dh], cx ; 0 ; [es:di+BDS.totalsecs32+2]
 12781                                  		
 12782                                  		; 02/09/2023
 12783 0000076F 894D19                  		mov	[di+19h], cx ; 0 ; [di+BDS.hiddensecs+2]
 12784 00000772 894D17                  		mov	[di+17h], cx ; 0 ; [di+BDS.hiddensecs]
 12785 00000775 894D1D                  		mov	[di+1Dh], cx ; 0 ; [di+BDS.totalsecs32+2]
 12786                                  
 12787                                  		; 21/12/2023 - Retro DOS v5.0
 12788 00000778 894D1F                  		mov     [di+1Fh], cx    ; [di+BDS.fatsecs32] ; BPB_FATSz32
 12789 0000077B 894D21                  		mov     [di+21h], cx    ; [di+BDS.fatsecs32+2]
 12790 0000077E 894D27                  		mov     [di+27h], cx    ; [di+BDS.rootdirclust]
 12791 00000781 894D29                  		mov     [di+29h], cx    ; [di+BDS.rootdirclust+2]
 12792 00000784 894D2F                  		mov     [di+2Fh], cx    ; [di+BDS.reserved]
 12793                                  					;     BPB_Reserved (12 zero bytes)
 12794 00000787 894D31                  		mov     [di+31h], cx
 12795 0000078A 894D33                  		mov     [di+33h], cx
 12796 0000078D 894D35                  		mov     [di+35h], cx
 12797 00000790 894D37                  		mov     [di+37h], cx
 12798 00000793 894D39                  		mov     [di+39h], cx
 12799 00000796 894D23                  		mov     [di+23h], cx    ; [di+BDS.extflags] ; BPB_ExtFlags
 12800 00000799 894D25                  		mov     [di+25h], cx    ; [di+BDS.fsver] ; BPB_FSVer
 12801                                  
 12802 0000079C 49                      		dec     cx              ; -1 ; 0FFFFFFFFh
 12803 0000079D 894D2B                  		mov     [di+2Bh], cx    ; [di+BDS.fsinfo] ; BPB_FSInfo
 12804 000007A0 894D2D                  		mov     [di+2Dh], cx    ; [di+BDS.bkbootsec] ; BPB_BkBootSec
 12805                                  		
 12806 000007A3 1F                      		pop	ds ; 02/09/2023
 12807                                  getret:
 12808 000007A4 5B                      		pop	bx
 12809 000007A5 5A                      		pop	dx
 12810 000007A6 59                      		pop	cx
 12811                                  ;getret_exit:		; 21/12/2023
 12812 000007A7 C3                      		retn
 12813                                  ; ---------------------------------------------------------------------------
 12814                                  
 12815                                  getbp_err_ret:	; before doing anything else, set set_id_flag to 0.
 12816                                  		;mov	ds:set_id_flag,	0
 12817                                  		; 19/10/2022
 12818 000007A8 C606[9B04]00            		mov	byte [set_id_flag], 0
 12819 000007AD E8F805                  		call	maperror
 12820 000007B0 EBF2                    		jmp	short getret
 12821                                  ; ---------------------------------------------------------------------------
 12822                                  ; 21/12/2023
 12823                                  ;		; we have a 3.5" diskette for which we cannot build a bpb.
 12824                                  ;		; we do	not assume any type of bpb for this medium.
 12825                                  ;
 12826                                  ;got_unknown_medium:
 12827                                  ;		;mov	ds:set_id_flag,	0
 12828                                  ;		mov	byte [set_id_flag], 0
 12829                                  ;		mov	al, 7
 12830                                  ;		stc
 12831                                  ;		jmp	short getret
 12832                                  
 12833                                  ; =============== S U B	R O U T	I N E =======================================
 12834                                  
 12835                                  ; 15/10/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS)
 12836                                  
 12837                                  ; ----------------------------------------------------------------
 12838                                  ; read in the boot sector. set carry if error in reading sector.
 12839                                  ; bx is set to 1 if the boot sector is invalid, otherwise it is 0.
 12840                                  ;
 12841                                  ;	assumes es:di -> bds, ds-> Bios_Data
 12842                                  ; ----------------------------------------------------------------
 12843                                  ; 10/03/2019 - Retro DOS v4.0
 12844                                  
 12845                                  ; 30/12/2022 - Retro DOS v4.2
 12846                                  ; (MSDOS 6.21 IO.SYS, BIOSCODE:06C3h)
 12847                                  ; ((MSDOS 6.22 IO.SYS, BIOSCODE:06C3h)) ; 22/12/2023
 12848                                  
 12849                                  ; 22/12/2023 - Retro DOS v5.0
 12850                                  ; (PCDOS 7.1 IBMBIO.COM, BIOSCODE:07C6h)
 12851                                  
 12852                                  readbootsec:	
 12853 000007B2 B600                    		mov	dh, 0		; head 0
 12854 000007B4 B90100                  		mov	cx, 1		; cylinder 0, sector 1
 12855 000007B7 E8FC00                  		call	read_sector
 12856 000007BA 7243                    		jb	short err_ret
 12857 000007BC 31DB                    		xor	bx, bx		; assume valid boot sector
 12858                                  
 12859                                  		; put a sanity check for the boot sector in here to detect
 12860                                  		; boot sectors that do not have valid bpbs. we examine the
 12861                                  		; first two bytes - they must contain a long jump (69h) or a
 12862                                  		; short jump (EBh) followed by a nop (90h), or a short jump
 12863                                  		; (E9h). if this test is passed, we further check by examining
 12864                                  		; the signature at the end of the boot sector for the word
 12865                                  		; AA55h. if the signature is not present, we examine the media
 12866                                  		; descriptor byte to see if it is valid. for dos 3.3, this
 12867                                  		; logic is modified a little bit. we are not going to check
 12868                                  		; signature. instead we are going to sanity check the media
 12869                                  		; byte in bpb regardless of the validity of signature. this is
 12870                                  		; to save the already developed commercial products that have
 12871                                  		; good jump instruction and signature but with the false bpb
 12872                                  		; informations
 12873                                  
 12874                                  ; that will crash the diskette drive operation. (for example, symphony diskette).
 12875                                  
 12876                                  		; 02/09/2023
 12877                                  		; 19/10/2022
 12878                                  		;cmp	byte [disksector], 69h ; is it a direct jump?
 12879                                  		;jz	short check_bpb_mediabyte ; don't need to find a nop
 12880                                  		;cmp	byte [disksector], 0E9h ; dos 2.0 jump?
 12881                                  		;jz	short check_bpb_mediabyte ; no need for	nop
 12882                                  		;cmp	byte [disksector], 0EBh ; how about a short jump?
 12883                                  		;jnz	short invalidbootsec
 12884                                  		;cmp	byte [disksector+2], 90h ; is next one a nop?
 12885                                  		;jnz	short invalidbootsec
 12886                                  
 12887                                  		; 02/09/2023 (PCDOS 7.1)
 12888 000007BE A0[5201]                		mov	al, [disksector]
 12889 000007C1 3C69                    		cmp	al, 69h		; is it a direct jump?
 12890 000007C3 740F                    		je	short check_bpb_mediabyte
 12891                                  					; don't need to find a nop
 12892 000007C5 3CE9                    		cmp	al, 0E9h	; dos 2.0 jump?
 12893 000007C7 740B                    		je	short check_bpb_mediabyte
 12894                                  					; no need for nop
 12895 000007C9 3CEB                    		cmp	al, 0EBh	; how about a short jump?
 12896 000007CB 7530                    		jne	short invalidbootsec
 12897 000007CD 803E[5401]90            		cmp	byte [disksector+2], 90h ; is next one a nop?
 12898 000007D2 7529                    		jne	short invalidbootsec
 12899                                  
 12900                                  ; 15/10/5022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 12901                                  ;
 12902                                  ;; 10/03/2019
 12903                                  ;; (MSDOS 3.3, MSDISK.ASM, 1988)
 12904                                  ;;
 12905                                  ;; Don't have to perform the following signature check since
 12906                                  ;; we need to check the media byte even with the good signatured diskette.
 12907                                  ;;
 12908                                  ;;check_signature:
 12909                                  ;;		cmp	word [cs:disksector+1FEh],0AA55h ; see if non-ibm
 12910                                  ;;							 ; disk or 1.x media.
 12911                                  ;;		jz	short checksinglesided ; go see if singled sided medium.
 12912                                  ;;					       ; may need some special handling
 12913                                  
 12914                                  ; check for non-ibm disks which do not have the signature AA55h at the
 12915                                  ; end of the boot sector, but still have a valid boot sector. this is done
 12916                                  ; by examining the media descriptor in the boot sector.
 12917                                  
 12918                                  		; 19/10/2022
 12919                                  check_bpb_mediabyte:
 12920 000007D4 A0[6701]                		mov	al, [disksector+15h]
 12921                                  					; [disksector+EXT_BOOT.BPB+EBPB.MEDIADESCRIPTOR]
 12922 000007D7 50                      		push	ax ; 02/09/2023
 12923 000007D8 24F0                    		and	al, 0F0h
 12924 000007DA 3CF0                    		cmp	al, 0F0h	; allow	for strange media
 12925 000007DC 58                      		pop	ax ; 02/09/2023
 12926 000007DD 751E                    		jnz	short invalidbootsec
 12927                                  
 12928                                  ; there were some (apparently a lot of them) diskettes that had been formatted
 12929                                  ; under dos 3.1 and earlier versions which have invalid bpbs in their boot
 12930                                  ; sectors. these are specifically diskettes that were formatted in drives
 12931                                  ; with one head, or whose side 0 was bad. these contain bpbs in the boot
 12932                                  ; sector that have the sec/clus field set to 2 instead of 1, as is standard
 12933                                  ; in dos. in order to support them, we have to introduce a "hack" that will
 12934                                  ; help our build bpb routine to recognise these specific cases, and to
 12935                                  ; set up out copy of the bpb accordingly.
 12936                                  ; we do this by checking to see if the boot sector is off a diskette that
 12937                                  ; is single-sided and is a pre-dos 3.20 diskette. if it is, we set the
 12938                                  ; sec/clus field to 1. if not, we carry on as normal.
 12939                                  
 12940                                  checksinglesided:
 12941                                  		;mov	al, [disksector+15h]
 12942                                  		; 02/09/2023
 12943                                  		; al = [disksector+15h]
 12944 000007DF 3CF0                    		cmp	al, 0F0h
 12945 000007E1 741B                    		jz	short gooddsk
 12946 000007E3 A801                    		test	al, 1
 12947 000007E5 7517                    		jnz	short gooddsk
 12948 000007E7 813E[5A01]332E          		cmp	word [disksector+8], 2E33h ; "3."
 12949 000007ED 7507                    		jnz	short mustbeearlier
 12950 000007EF 803E[5C01]32            		cmp	byte [disksector+0Ah], 32h ; "2"
 12951 000007F4 7308                    		jnb	short gooddsk
 12952                                  
 12953                                  ; we must have a pre-3.20 diskette. set the sec/clus field to 1
 12954                                  
 12955                                  mustbeearlier:				
 12956 000007F6 C606[5F01]01            		mov	byte [disksector+0Dh], 1
 12957                                  					; [disksector+EXT_BOOT.BPB+EBPB.SECTORSPERCLUSTER]
 12958 000007FB EB01                    		jmp	short gooddsk
 12959                                  ; ---------------------------------------------------------------------------
 12960                                  
 12961                                  invalidbootsec:				
 12962 000007FD 43                      		inc	bx		; indicate that boot sector invalid
 12963                                  		; 10/12/2022
 12964                                  movbpb_ret:
 12965                                  gooddsk:				
 12966 000007FE F8                      		clc
 12967                                  err_ret:
 12968 000007FF C3                      		retn
 12969                                  ; ---------------------------------------------------------------------------
 12970                                  
 12971                                  		; 10/12/2022
 12972                                  ;err_ret:				
 12973                                  		;retn
 12974                                  
 12975                                  ; =============== S U B	R O U T	I N E =======================================
 12976                                  
 12977                                  ; 15/10/2022
 12978                                  ; ---------------------------------------------------------------------------
 12979                                  ; 'movbpb' moves the bpb read from the boot sector into registers for use by
 12980                                  ; getbp routine at has1
 12981                                  ;
 12982                                  ; if the set_id_flag is 1, and if an extended boot record, then set volume
 12983                                  ; serial number, volume label, file system id in bds according to
 12984                                  ; the boot record. after that, this routine will set the set_id_flag to 2
 12985                                  ; to signal that volume label is set already from the extended boot record
 12986                                  ; (so, don't set it again by calling "set_volume_id" routine which uses
 12987                                  ; the volume label in the root directory.)
 12988                                  ; ---------------------------------------------------------------------------
 12989                                  
 12990                                  ; 10/03/2019 - Retro DOS v4.0
 12991                                  
 12992                                  ; 22/12/2023
 12993                                  %if 0
 12994                                  		; 19/10/2022
 12995                                  movbpb:
 12996                                  		mov	dh, [disksector+0Dh]
 12997                                  					; disksector+EXT_BOOT.BPB+EBPB.SECTORSPERCLUSTER]
 12998                                  					; sectors per unit
 12999                                  		mov	bh, [disksector+11h]
 13000                                  					; [disksector+EXT_BOOT.BPB+EBPB.ROOTENTRIES]
 13001                                  					; number of directory entries
 13002                                  		mov	cx, [disksector+13h]
 13003                                  					; [disksector+EXT_BOOT.BPB+EBPB.TOTALSECTORS]
 13004                                  					; size of drive
 13005                                  		mov	ah, [disksector+15h]
 13006                                  					; [disksector+EXT_BOOT.BPB+EBPB.MEDIADESCRIPTOR]
 13007                                  					; media	descriptor
 13008                                  		mov	al, [disksector+16h];
 13009                                  					; [disksector+EXT_BOOT.BPB+EBPB.SECTORSPERFAT]
 13010                                  					; number of fat	sectors
 13011                                  		mov	bl, [disksector+18h]
 13012                                  					; [disksector+EXT_BOOT.BPB+EBPB.SECTORSPERTRACK]
 13013                                  					; sectors per track
 13014                                  		mov	dl, [disksector+1Ah]
 13015                                  					; [disksector+EXT_BOOT.BPB+EBPB.HEADS]
 13016                                  					; number of heads
 13017                                  %else
 13018                                  		; 29/12/2023
 13019                                  		; 22/12/2023 - Retro DOS v5.0
 13020                                  		; (PCDOS 7.1 IBMBIO.COM, BIOSCODE:0814h)
 13021                                  		;;;
 13022                                  movbpb:
 13023 00000800 57                      		push	di
 13024 00000801 83C706                  		add	di, 6		; BDS+6 = BDS.BPB
 13025 00000804 8D36[5D01]              		lea	si, [disksector+0Bh]
 13026 00000808 B93500                  		mov	cx, 53		; copy bios parameters block
 13027                                  					; from BPB_BytsPerSec to (FAT32) BS_DrvNum (excluded)
 13028 0000080B FC                      		cld
 13029 0000080C F3A4                    		rep movsb
 13030 0000080E 8B4CD3                  		mov	cx, [si-45]	; si = disksector+64 -> 64-45 = 19
 13031                                  					; disksektor+19 = BPB_TotSec16
 13032 00000811 31C0                    		xor	ax, ax
 13033 00000813 E308                    		jcxz	movbpb_bigdisk
 13034 00000815 26894DE0                		mov	[es:di-32], cx	; write 16 bit total sectors
 13035                                  					; to 32 bit total sectors field
 13036 00000819 268945E2                		mov	[es:di-30], ax	; BPB_TotalSec32+2 (BDS offset 29, BPB offset 23)
 13037                                  movbpb_bigdisk:
 13038 0000081D 3944D6                  		cmp	[si-42], ax     ; BPB_FATSz16 = disksector+22
 13039 00000820 7410                    		jz	short movbpb_fat32
 13040                                  movbpb_fat:
 13041 00000822 83EF1C                  		sub	di, 28		; di = BDS offset 31 (BPB offset 25)
 13042                                  		; 29/12/2023
 13043 00000825 B90C00                  		mov	cx, 12		; clear 12 byte extended BDS (FAT32) fields
 13044                                  					; (which are used only for FAT32 disks)
 13045 00000828 F3AA                    		rep stosb
 13046 0000082A 48                      		dec	ax		; -1 ; 0FFFFh
 13047 0000082B AB                      		stosw			; set BDS offset 43 (dword) to -1
 13048                                  					; dword [BDS.BPB_FSInfo] = 0FFFFFFFFh
 13049 0000082C AB                      		stosw
 13050 0000082D 40                      		inc	ax		; ax = 0
 13051 0000082E B10C                    		mov	cl, 12		
 13052                                  		;mov	cx, 12		; clear BDS offset 47 to 59
 13053                                  					; (BPB offset 41 to 53) (disksector offset 52 to 64)
 13054 00000830 F3AA                    		rep stosb
 13055                                  movbpb_fat32:
 13056 00000832 5F                      		pop	di
 13057                                  %endif
 13058                                  		;;;
 13059                                  
 13060 00000833 803E[9B04]01            		cmp	byte [set_id_flag], 1 ; called by get_bpb?
 13061 00000838 75C4                    		jnz	short movbpb_ret
 13062 0000083A E81200                  		call	mov_media_ids
 13063 0000083D 7205                    		jb	short movbpb_conv ; conventional boot record?
 13064 0000083F C606[9B04]02            		mov	byte [set_id_flag], 2 ; signals that volume id is set
 13065                                  movbpb_conv:
 13066 00000844 803E[7700]01            		cmp	byte [fhave96], 1
 13067 00000849 75B3                    		jnz	short movbpb_ret
 13068 0000084B E83B14                  		call	resetchanged	; reset	flags in bds to	not fchanged.
 13069                                  		; 10/12/2022
 13070                                  		; cf = 0
 13071                                  ;movbpb_ret:
 13072                                  		;clc
 13073 0000084E C3                      		retn
 13074                                  
 13075                                  ; =============== S U B	R O U T	I N E =======================================
 13076                                  
 13077                                  ;copy the boot_serial number, volume id, and filesystem id from the
 13078                                  ;***extended boot record*** in ds:disksector to the bds table pointed
 13079                                  ;by es:di.
 13080                                  
 13081                                  ;in.) es:di -> bds
 13082                                  ;     ds:disksector = valid extended boot record.
 13083                                  ;out.) vol_serial, bds_volid and bds_system_id in bds are set according to
 13084                                  ;      the boot record information.
 13085                                  ;     carry flag set if not an extended bpb.
 13086                                  ;     all registers saved except the flag.
 13087                                  
 13088                                  ; 22/12/2023
 13089                                  %if 0
 13090                                  		; 19/10/2022
 13091                                  mov_media_ids:		
 13092                                  		cmp	byte [disksector+26h], 29h
 13093                                  					; [disksector+EXT_BOOT.SIG],
 13094                                  					; EXT_BOOT_SIGNATURE
 13095                                  		jnz	short mmi_not_ext
 13096                                  		push	cx
 13097                                  		mov	cx, [disksector+27h]
 13098                                  					; [disksector+EXT_BOOT.SERIAL]
 13099                                  		mov	[es:di+57h], cx	; [es:di+BDS.vol_serial]
 13100                                  		mov	cx, [disksector+29h]
 13101                                  					; [disksector+EXT_BOOT.SERIAL+2]
 13102                                  		mov	[es:di+59h], cx	; [es:di+BDS.vol_serial+2]
 13103                                  		push	di
 13104                                  		push	si
 13105                                  		mov	cx, 11		; size_of_EXT_BOOT_VOL_LABEL
 13106                                  		mov	si, disksector+2Bh
 13107                                  		;mov	si, (offset disksector+2Bh) ;
 13108                                  					; disksector+EXT_BOOT.VOL_LABEL
 13109                                  		add	di, 75		; BDS.volid
 13110                                  		rep movsb
 13111                                  		;mov	cx, 8		; size_of_EXT_SYSTEM_ID
 13112                                  		; 10/12/2022
 13113                                  		mov	cl, 8 ; cx = 8
 13114                                  		mov	si, disksector+36h
 13115                                  		;mov	si, (offset disksector+36h) ; disksector+EXT_BOOT.SYSTEM_ID
 13116                                  		add	di, 5		; (BDS.filesys_id-BDS.volid)-size_of_EXT_BOOT_VOL_LABEL
 13117                                  		rep movsb
 13118                                  		pop	si
 13119                                  		pop	di
 13120                                  		pop	cx
 13121                                  		; 10/12/2022
 13122                                  		; cf = 0
 13123                                  		;clc		; this clc is not required (16/06/2019 - Erdogan Tan)
 13124                                  				; (20/09/2022)
 13125                                  		retn
 13126                                  %else
 13127                                  		; 22/12/2023 - Retro DOS v5.0
 13128                                  		; (PCDOS 7.1 IBMBIO.COM, BIOSCODE:0865h)
 13129                                  		;;;		
 13130                                  mov_media_ids:
 13131 0000084F 833E[6801]00            		cmp	word [disksector+16h], 0 ; BPB.FATSz16
 13132 00000854 7507                    		jnz	short mmi_chk_fat
 13133 00000856 803E[9401]29            		cmp	byte [disksector+42h], 29h
 13134                                  					; [disksector+FAT32_EXT_BOOT.SIG],
 13135                                  					; EXT_BOOT_SIGNATURE
 13136 0000085B EB05                    		jmp	short mmi_chk_fat32
 13137                                  mmi_chk_fat:
 13138 0000085D 803E[7801]29            		cmp	byte [disksector+26h], 29h
 13139                                  					; [disksector+EXT_BOOT.SIG],EXT_BOOT_SIGNATURE
 13140                                  mmi_chk_fat32:
 13141 00000862 7543                    		jnz	short mmi_not_ext
 13142 00000864 51                      		push	cx
 13143 00000865 50                      		push	ax
 13144 00000866 57                      		push	di
 13145 00000867 56                      		push	si
 13146 00000868 1E                      		push	ds
 13147 00000869 833E[6801]00            		cmp	word [disksector+16h], 0 ; BPB.FATSz16
 13148 0000086E 750C                    		jnz	short mmi_fat
 13149                                  
 13150                                  mmi_fat32:				; FAT32 file system
 13151                                  		;lds	cx, dword ptr ds:disksector+43h
 13152 00000870 C50E[9501]              		lds	cx, [disksector+43h]	; BS_FAT32_VolID
 13153 00000874 BE[9901]                		mov	si, disksector+47h	; BS_FAT32_VolLab
 13154 00000877 B8[A401]                		mov	ax, disksector+52h	; BS_FAT32_FilSysType
 13155 0000087A EB0A                    		jmp	short mmi_do
 13156                                  
 13157                                  mmi_fat:
 13158                                  		;lds	cx, dword ptr ds:disksector+27h
 13159 0000087C C50E[7901]              		lds	cx, [disksector+27h]	; BS_VolID
 13160 00000880 BE[7D01]                		mov	si, disksector+2Bh	; BS_VolLab
 13161 00000883 B8[8801]                		mov	ax, disksector+36h	; BS_FilSysType
 13162                                  mmi_do:
 13163 00000886 26898D8900              		mov	[es:di+89h], cx	; [es:di+BDS.vol_serial]
 13164                                  					; (BDS offset 137)
 13165 0000088B 268C9D8B00              		mov	[es:di+8Bh], ds	; [es:di+BDS.vol_serial+2]
 13166 00000890 1F                      		pop	ds
 13167 00000891 B90B00                  		mov	cx, 11
 13168 00000894 83C77D                  		add	di, 125		; di = di+125 = BDS.volid
 13169 00000897 F3A4                    		rep movsb
 13170 00000899 B108                    		mov	cl, 8		; di = di+136
 13171 0000089B 89C6                    		mov	si, ax		; BS_FilSysType or BS_FAT32_FilSysType
 13172 0000089D 83C705                  		add	di, 5		; di = di+141 = BDS.filesys_id
 13173 000008A0 F3A4                    		rep movsb
 13174 000008A2 5E                      		pop	si
 13175 000008A3 5F                      		pop	di
 13176 000008A4 58                      		pop	ax
 13177 000008A5 59                      		pop	cx
 13178                                  		;clc	; this clc is not required (16/06/2019 - Erdogan Tan)
 13179                                  			; (20/09/2022 - 27/06/2023) MSDOS 6.21 .. PCDOS 7.1
 13180 000008A6 C3                      		retn
 13181                                  %endif
 13182                                  		;;;
 13183                                  
 13184                                  ; ---------------------------------------------------------------------------
 13185                                  
 13186                                  mmi_not_ext:				
 13187 000008A7 F9                      		stc
 13188 000008A8 C3                      		retn
 13189                                  
 13190                                  ; =============== S U B	R O U T	I N E =======================================
 13191                                  
 13192                                  ; 15/10/2022
 13193                                  ; --------------------------------------------------------------
 13194                                  ; read in the fat sector and get the media byte from it.
 13195                                  ; input : es:di -> bds
 13196                                  ; output:
 13197                                  ;	  carry set if an error occurs, ax contains error code.
 13198                                  ;	  otherwise, ah contains media byte on exit
 13199                                  ; --------------------------------------------------------------
 13200                                  
 13201                                  readfat:	
 13202                                  		;mov	dh, 0
 13203                                  		; 10/12/2022
 13204 000008A9 30F6                    		xor	dh, dh
 13205 000008AB B90200                  		mov	cx, 2		; head 0
 13206                                  					; cylinder 0, sector 2
 13207 000008AE E80500                  		call	read_sector
 13208 000008B1 7202                    		jb	short bad_fat_ret
 13209 000008B3 8A27                    		mov	ah, [bx]	; media	byte
 13210                                  bad_fat_ret:				
 13211 000008B5 C3                      		retn
 13212                                  
 13213                                  ; =============== S U B	R O U T	I N E =======================================
 13214                                  
 13215                                  ; 15/10/2022
 13216                                  
 13217                                  ; ---------------------------------------------------------------------------
 13218                                  ; read a single sector into the temp buffer.
 13219                                  ; perform three retries in case of error.
 13220                                  ;   inputs:	es:[di].bds_drivenum has physical drive to use
 13221                                  ;		cx has sector and cylinder
 13222                                  ;		dh has head
 13223                                  ;		es:di has bds
 13224                                  ;		ds has Bios_Data
 13225                                  ;
 13226                                  ;   outputs:	carry clear
 13227                                  ;		    Bios_Data:bx point to sector
 13228                                  ;		       (note: some callers assume location of buffer)
 13229                                  ;
 13230                                  ;		carry set
 13231                                  ;		    ax has rom error code
 13232                                  ;
 13233                                  ; register bp is preserved.
 13234                                  ; ---------------------------------------------------------------------------
 13235                                  
 13236                                  ; 10/03/2019 - Retro DOS v4.0
 13237                                  ; 22/12/2023 - Retro DOS v5.0
 13238                                  
 13239                                  		; 19/10/2022
 13240                                  read_sector:
 13241 000008B6 55                      		push	bp
 13242 000008B7 BD0300                  		mov	bp, 3		; make 3 attempts
 13243 000008BA 268A5504                		mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 13244 000008BE BB[5201]                		mov	bx, disksector	; get es:bx to point to	buffer
 13245                                  rd_ret:
 13246 000008C1 06                      		push	es
 13247 000008C2 1E                      		push	ds
 13248 000008C3 07                      		pop	es
 13249 000008C4 B80102                  		mov	ax, 201h
 13250 000008C7 CD13                    		int	13h		; DISK - READ SECTORS INTO MEMORY
 13251                                  					; AL = number of sectors to read, CH = track, CL = sector
 13252                                  					; DH = head, DL	= drive, ES:BX -> buffer to fill
 13253                                  					; Return: CF set on error, AH =	status,	AL = number of sectors read
 13254 000008C9 07                      		pop	es
 13255 000008CA 734A                    		jnb	short okret2
 13256                                  rd_rty:
 13257 000008CC E81105                  		call	again		; reset	disk, decrement	bp, preserve ax
 13258 000008CF 7442                    		jz	short err_rd_ret
 13259                                  
 13260                                  		; 22/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 13261 000008D1 26F6453F01              		test	byte [es:di+3Fh], 1
 13262                                  		;test	byte [es:di+23h], 1
 13263                                  		;;test	byte ptr [es:di+23h], 1	; [es:di+BDS.flags]
 13264                                  					; fnon_removable
 13265 000008D6 75E9                    		jnz	short rd_ret
 13266 000008D8 803E[A905]00            		cmp	byte [media_set_for_format], 0
 13267 000008DD 7510                    		jnz	short rd_skip1_dpt
 13268 000008DF 50                      		push	ax
 13269 000008E0 1E                      		push	ds		; for retry, set the head settle time to 0Fh
 13270 000008E1 C536[2D01]              		lds	si, [dpt]
 13271                                  		;mov	al, [si+9]	; [si+DISK_PARMS.DISK_HEAD_STTL]
 13272                                  		;mov	byte [si+9], 15 ; [si+DISK_PARMS.DISK_HEAD_STTL]
 13273                                  		;			; NORMSETTLE
 13274                                  		; 12/12/2022
 13275 000008E5 B00F                    		mov	al, 15
 13276 000008E7 864409                  		xchg	al, [si+9]
 13277                                  		; 
 13278 000008EA 1F                      		pop	ds
 13279 000008EB A2[2A01]                		mov	[save_head_sttl], al
 13280 000008EE 58                      		pop	ax
 13281                                  rd_skip1_dpt:
 13282 000008EF 06                      		push	es
 13283 000008F0 1E                      		push	ds
 13284 000008F1 07                      		pop	es
 13285 000008F2 B80102                  		mov	ax, 201h
 13286 000008F5 CD13                    		int	13h		; DISK - READ SECTORS INTO MEMORY
 13287                                  					; AL = number of sectors to read, CH = track, CL = sector
 13288                                  					; DH = head, DL	= drive, ES:BX -> buffer to fill
 13289                                  					; Return: CF set on error, AH =	status,	AL = number of sectors read
 13290 000008F7 07                      		pop	es
 13291 000008F8 9C                      		pushf
 13292 000008F9 803E[A905]00            		cmp	byte [media_set_for_format], 0
 13293 000008FE 750E                    		jnz	short rd_skip2_dpt
 13294 00000900 50                      		push	ax
 13295 00000901 A0[2A01]                		mov	al, [save_head_sttl]
 13296 00000904 1E                      		push	ds
 13297 00000905 C536[2D01]              		lds	si, [dpt]
 13298 00000909 884409                  		mov	[si+9],	al	; [si+DISK_PARMS.DISK_HEAD_STTL]
 13299 0000090C 1F                      		pop	ds
 13300 0000090D 58                      		pop	ax
 13301                                  rd_skip2_dpt:
 13302 0000090E 9D                      		popf
 13303 0000090F 7305                    		jnb	short okret2
 13304 00000911 EBB9                    		jmp	short rd_rty
 13305                                  ; ---------------------------------------------------------------------------
 13306                                  
 13307                                  err_rd_ret:
 13308 00000913 B2FF                    		mov	dl, 0FFh	; make sure we ask rom if media	has changed
 13309                                  					; return error
 13310 00000915 F9                      		stc
 13311                                  
 13312                                  ; update information pertaining to last drive accessed, time of access, last
 13313                                  ; track accessed in that drive.
 13314                                  
 13315                                  okret2:
 13316 00000916 8816[7600]              		mov	[step_drv], dl	; set up for head settle logic in disk
 13317 0000091A 8816[1E01]              		mov	[tim_drv], dl	; save drive last accessed
 13318                                  		
 13319                                  		; 22/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 13320 0000091E 26886D78                		mov	[es:di+78h], ch
 13321                                  		;mov	[es:di+46h], ch	; [es:di+BDS.track]
 13322                                  					; save last track accessed on this drive
 13323                                  					; preserve flags in case error occurred
 13324 00000922 9C                      		pushf
 13325 00000923 E89A04                  		call	set_tim
 13326 00000926 9D                      		popf			; restore flags
 13327 00000927 5D                      		pop	bp
 13328 00000928 C3                      		retn
 13329                                  
 13330                                  ;----------------------------------------------------------------------------
 13331                                  ;	disk open/close routines
 13332                                  ;----------------------------------------------------------------------------
 13333                                  
 13334                                  dsk_open:				; 2C7h:80Ah = 70h:2D7Ah
 13335 00000929 803E[7700]00            		cmp	byte [fhave96], 0
 13336 0000092E 7407                    		jz	short dsk_open_exit ; done if no changeline support
 13337 00000930 E871FC                  		call	SetDrive	; get bds for drive
 13338                                  		; 22/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 13339 00000933 26FF453C                		inc	word [es:di+3Ch] ; [es:di+BDS.opcnt] ; BDS offset 60
 13340                                  		;inc	word [es:di+20h] ; [es:di+BDS.opcnt]
 13341                                  dsk_open_exit:
 13342                                  		; 10/12/2022
 13343                                  		; cf = 0			
 13344                                  		;clc		; CF is	already	ZERO here (18/09/2022, MSDOS 5.0 IO.SYS)
 13345                                  				; (19/07/2019 -	Erdogan	Tan - MSDOS 6.0	IO.SYS - retrodos4.s)
 13346 00000937 C3                      		retn
 13347                                  ; ---------------------------------------------------------------------------
 13348                                  
 13349                                  dsk_close:				; 2C7h:81Ah = 70h:2D8Ah
 13350 00000938 803E[7700]00            		cmp	byte [fhave96], 0
 13351 0000093D 740E                    		jz	short exitjx	; done if no changeline	support
 13352 0000093F E862FC                  		call	SetDrive	; get bds for drive
 13353                                  		; 22/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 13354 00000942 26837D3C00              		cmp	word [es:di+3Ch], 0 ; [es:di+BDS.opcnt] ; BDS off 60
 13355                                  		;cmp	word [es:di+20h], 0 ; [es:di+BDS.opcnt]
 13356 00000947 7404                    		jz	short exitjx	; watch	out for	wrap
 13357                                  		; 22/12/2023
 13358 00000949 26FF4D3C                		dec	word [es:di+3Ch]
 13359                                  		;dec	word [es:di+20h]
 13360                                  exitjx:
 13361                                  		; 10/12/2022
 13362                                  		; cf = 0
 13363                                  		;clc		; CF is	already	ZERO here (18/09/2022, MSDOS 5.0 IO.SYS)
 13364                                  				; (19/07/2019 -	Erdogan	Tan - MSDOS 6.0	IO.SYS - retrodos4.s)
 13365 0000094D C3                      		retn
 13366                                  
 13367                                  ;----------------------------------------------------------------------------
 13368                                  ;		disk removable routine
 13369                                  ;----------------------------------------------------------------------------
 13370                                  
 13371                                  		; al is	unit #
 13372                                  dsk_rem:				; 2C7h:831h = 70h:2DA1h
 13373 0000094E E853FC                  		call	SetDrive	; get bds for this drive
 13374                                  		; 22/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 13375                                  		;test	byte [es:di+BDS.flags], fnon_removable
 13376 00000951 26F6453F01              		test	byte [es:di+3Fh], 1 ; [es:di+BDS.flags], fnon_removable
 13377 00000956 74F5                    		jz	short exitjx
 13378                                  		;test	byte [es:di+23h], 1 ; [es:di+BDS.flags], fnon_removable
 13379                                  		;;jnz	short x_bus_exit ; non_rem
 13380                                  		;jnz	short non_rem	; 15/10/2022
 13381                                  		;; 10/12/2022
 13382                                  		;; cf = 0
 13383                                  		;;clc			; CF is already ZERO here
 13384                                  		;			; 15/10/2022
 13385                                  		;retn
 13386                                  ; ---------------------------------------------------------------------------
 13387                                  
 13388                                  non_rem:
 13389                                  x_bus_exit:
 13390 00000958 B403                    		mov	ah, 3		; 2C7h:83Dh = 0070h:2DADh
 13391                                  					; return busy status
 13392 0000095A F9                      		stc
 13393                                  dsk_ret:
 13394 0000095B C3                      		retn
 13395                                  
 13396                                  ;----------------------------------------------------------------------------
 13397                                  ;		disk i/o routines
 13398                                  ;----------------------------------------------------------------------------
 13399                                  
 13400                                  dsk_writv:				; 2C7h:841h = 70h:2DB1h
 13401                                  		;mov	word [wrtverify], 103h
 13402                                  		; 19/10/2022
 13403 0000095C C706[2001]0301          		mov	word [rflag], 103h
 13404                                  		;mov	word ptr ds:rflag, 103h	; write	and verify
 13405 00000962 EB06                    		jmp	short dsk_cl
 13406                                  ; ---------------------------------------------------------------------------
 13407                                  
 13408                                  dsk_writ:				; 2C7h:849h = 70h:2DB9h
 13409                                  		;mov	word [wrtverify], 3
 13410                                  		; 19/10/2022
 13411 00000964 C706[2001]0300          		mov	word [rflag], 3
 13412                                  		;mov	word ptr ds:rflag, 3 ; romwrite
 13413                                  dsk_cl:
 13414 0000096A E8A400                  		call	diskio		; romwrite
 13415                                  ; ---------------------------------------------------------------------------
 13416                                  
 13417                                  dsk_io:
 13418 0000096D 73EC                    		jnb	short dsk_ret
 13419 0000096F E965F7                  		jmp	bc_err_cnt
 13420                                  ; ---------------------------------------------------------------------------
 13421                                  
 13422                                  dsk_read:				; ; 2C7h:857h =	70h:2DC7h
 13423 00000972 E89700                  		call	diskrd
 13424 00000975 EBF6                    		jmp	short dsk_io
 13425                                  
 13426                                  ; =============== S U B	R O U T	I N E =======================================
 13427                                  
 13428                                  ; 15/10/2022
 13429                                  ; 10/03/2019 - Retro DOS v4.0
 13430                                  ; 22/12/2023 - Retro DOS v5.0
 13431                                  
 13432                                  ;-----------------------------------------------------------
 13433                                  ; miscellaneous odd jump routines. 
 13434                                  ; moved out of mainline for speed.
 13435                                  
 13436                                  ; if we have a system where we have virtual drives, we need 
 13437                                  ; to prompt the user to place the correct disk in the drive.
 13438                                  ;
 13439                                  ;	assume es:di -> bds, ds:->Bios_Data
 13440                                  ;-----------------------------------------------------------
 13441                                  
 13442                                  		; 19/10/2022
 13443                                  checksingle:
 13444 00000977 50                      		push	ax
 13445 00000978 53                      		push	bx
 13446                                  		; 22/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 13447 00000979 268B5D3F                		mov	bx, [es:di+3Fh]	; [es:di+BDS.flags]
 13448                                  		;mov	bx, [es:di+23h]	; [es:di+BDS.flags]
 13449                                  
 13450                                  ; if hard drive, cannot change disk.
 13451                                  ; if current owner of physical drive, no need to change diskette.
 13452                                  
 13453 0000097D F6C321                  		test	bl, 21h		; fnon_removable|fi_own_physical
 13454 00000980 7573                    		jnz	short singleret
 13455 00000982 F6C310                  		test	bl, 10h		; fi_am_mult
 13456                                  					; is there a drive sharing this	physical drive?
 13457 00000985 746E                    		jz	short singleret
 13458                                  
 13459                                  ; look for the previous owner of this physical drive
 13460                                  ; and reset its ownership flag.
 13461                                  
 13462 00000987 268A4504                		mov	al, [es:di+4]	; [es:di+BDS.drivenum]
 13463                                  					; get physical drive number
 13464 0000098B 06                      		push	es		; preserve pointer to current bds
 13465 0000098C 57                      		push	di
 13466 0000098D C43E[1901]              		les	di, [start_bds] ; get first bds
 13467                                  scan_list:
 13468 00000991 26384504                		cmp	[es:di+4], al
 13469 00000995 7553                    		jnz	short scan_skip	; Not our drive. Try next bds.
 13470 00000997 B320                    		mov	bl, 20h	; ' '   ; fi_own_physical ; test ownership flag
 13471                                  		; 22/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 13472 00000999 26845D3F                		test	[es:di+3Fh], bl	; [es:di+BDS.flags]
 13473                                  		;test	[es:di+23h], bl
 13474 0000099D 744B                    		jz	short scan_skip	; he doesn't own it either. continue
 13475 0000099F 26305D3F                		xor	[es:di+3Fh], bl
 13476                                  		;xor	[es:di+23h], bl	; reset	ownership flag
 13477 000009A3 5F                      		pop	di		; restore pointer to current bds
 13478 000009A4 07                      		pop	es
 13479 000009A5 26085D3F                		or	[es:di+3Fh], bl
 13480                                  		;or	[es:di+23h], bl	; ; set	ownership flag
 13481                                  
 13482                                  ; we examine the fsetowner flag. if it is set, then we are using the code in
 13483                                  ; checksingle to just set the owner of a drive. we must not issue the prompt
 13484                                  ; in this case.
 13485 000009A9 803E[7A00]01            		cmp	byte [fsetowner], 1
 13486 000009AE 7517                    		jnz	short not_fsetowner
 13487                                  		;cmp	byte ptr es:[di+4], 0 ;	are we handling	drive number 0 ?
 13488 000009B0 26807D0400              		cmp	byte [es:di+4], 0
 13489 000009B5 753E                    		jnz	short singleret
 13490 000009B7 268A4505                		mov	al, [es:di+5]
 13491                                  		;mov	al, es:[di+5]	; [es:di+BDS.drivelet]
 13492                                  					; get the DOS drive letter
 13493 000009BB 06                      		push	es
 13494 000009BC 8E06[1A00]              		mov	es, [zeroseg]
 13495 000009C0 26A20405                		mov	[es:LSTDRV], al
 13496                                  		;mov	es:504h, al	; [es:LSTDRV]
 13497                                  					; set up sdsb
 13498 000009C4 07                      		pop	es		; restore bds pointer
 13499 000009C5 EB2E                    		jmp	short singleret
 13500                                  ; ---------------------------------------------------------------------------
 13501                                  
 13502                                  ; to support "backward" compatibility with ibm's "single drive status byte"
 13503                                  ; we now check to see if we are in a single drive system and the application
 13504                                  ; has "cleverly" diddled the sdsb
 13505                                  
 13506                                  not_fsetowner:
 13507 000009C7 803E[7800]02            		cmp	byte [single], 2 ; if (single_drive_system)
 13508 000009CC 7517                    		jnz	short ignore_sdsb
 13509 000009CE 50                      		push	ax
 13510 000009CF 268A4505                		mov	al, [es:di+5]	; if (curr_drv == req_drv)
 13511 000009D3 88C4                    		mov	ah, al
 13512 000009D5 06                      		push	es
 13513 000009D6 8E06[1A00]              		mov	es, [zeroseg]
 13514 000009DA 2686060405              		xchg	al, [es:LSTDRV]
 13515                                  		;xchg	al, es:504h	; [es:LSTDRV]
 13516                                  					; then swap(curr_drv,req_drv)
 13517 000009DF 07                      		pop	es
 13518 000009E0 38C4                    		cmp	ah, al		; else
 13519 000009E2 58                      		pop	ax		; swap(curr_drv,req_drv)
 13520 000009E3 7410                    		jz	short singleret	; issue	swap_dsk_msg
 13521                                  ignore_sdsb:
 13522 000009E5 E8B710                  		call	swpdsk
 13523 000009E8 EB0B                    		jmp	short singleret
 13524                                  ; ---------------------------------------------------------------------------
 13525                                  
 13526                                  scan_skip:
 13527 000009EA 26C43D                  		les	di, [es:di]
 13528                                  		;les	di, es:[di]	; [es:di+BDS.link]
 13529                                  					; go to	next bds
 13530 000009ED 83FFFF                  		cmp	di, 0FFFFh ; -1	; end of list?
 13531 000009F0 759F                    		jnz	short scan_list	; continue until hit end of list
 13532 000009F2 F9                      		stc
 13533 000009F3 5F                      		pop	di		; restore current bds
 13534 000009F4 07                      		pop	es
 13535                                  singleret:
 13536 000009F5 5B                      		pop	bx
 13537 000009F6 58                      		pop	ax
 13538 000009F7 C3                      		retn
 13539                                  
 13540                                  ; 22/12/2023
 13541                                  %if 0
 13542                                  ; ---------------------------------------------------------------------------
 13543                                  
 13544                                  baddrive:
 13545                                  		mov	al, 8		; sector not found
 13546                                  		jmp	short baddrive_ret
 13547                                  %endif
 13548                                  
 13549                                  ; ---------------------------------------------------------------------------
 13550                                  
 13551                                  unformatteddrive:
 13552 000009F8 B007                    		mov	al, 7		; unknown media
 13553                                  ;baddrive_ret:
 13554 000009FA F9                      		stc
 13555                                  ; ---------------------------------------------------------------------------
 13556                                  
 13557                                  ioret:
 13558 000009FB C3                      		retn
 13559                                  
 13560                                  ; ---------------------------------------------------------------------------
 13561                                  		
 13562                                  		; 22/12/2023 - Retro DOS v5.0
 13563                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0A1Bh
 13564                                  
 13565 000009FC 10                      LBA_Packet:	db 16			; ...
 13566                                  					; DAP buffer
 13567 000009FD 00                                      db 0
 13568 000009FE 0000                    dap_block_cnt:	dw 0			; ...
 13569 00000A00 00000000                dap_trans_buf:	dd 0			; ...
 13570 00000A04 00000000                dap_lba_value:	dd 0			; ...
 13571 00000A08 00000000                		dd 0
 13572                                  
 13573                                  ; ---------------------------------------------------------------------------
 13574                                  
 13575                                  ; 15/10/2022
 13576                                  
 13577                                  ; ---------------------------------------------------------------------------
 13578                                  ;	disk i/o handler
 13579                                  ;
 13580                                  ;	al = drive number (0-6)
 13581                                  ;	ah = media descriptor
 13582                                  ;	cx = sector count
 13583                                  ;	dx = first sector (low)
 13584                                  ;	[start_sec_h] = first sector (high)  32 bit calculation.
 13585                                  ;	ds = cs
 13586                                  ;	es:di = transfer address
 13587                                  ;	[rflag]=operation (2=read, 3=write)
 13588                                  ;	[verify]=1 for verify after write
 13589                                  ;
 13590                                  ;	if successful carry flag = 0
 13591                                  ;	  else cf=1 and al contains error code
 13592                                  ; ---------------------------------------------------------------------------
 13593                                  
 13594                                  		; 12/12/2023
 13595                                  		; ds = biosdata segment (cs = bioscode segment)
 13596                                  diskrd:	
 13597                                  		;mov	ds:rflag, 2	; romread
 13598                                  		; 19/10/2022
 13599 00000A0C C606[2001]02            		mov	byte [rflag], 2 ; romread
 13600                                  
 13601                                  ; =============== S U B	R O U T	I N E =======================================
 13602                                  
 13603                                  		; 22/12/2023 - Retro DOS v5.0
 13604                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:0A30h
 13605                                  ; 22/12/2023
 13606                                  %if 0
 13607                                  		; 19/10/2022
 13608                                  diskio:
 13609                                  		mov	bx, di		; es:bx	= transfer address
 13610                                  		mov	[xfer_seg], es	; save transfer	segment
 13611                                  		call	SetDrive
 13612                                  		mov	al, [es:di+10h]	; [es:di+BDS.media]
 13613                                  		mov	[medbyt], al
 13614                                  		;jcxz	short ioret
 13615                                  		jcxz	ioret
 13616                                  
 13617                                  ; see if the media is formatted or not by checking the flags field in
 13618                                  ; in the bds. if it is unformatted we cannot allow i/o, so we should
 13619                                  ; go to the error exit at label unformatteddrive.
 13620                                  
 13621                                  		test	byte [es:di+24h], 2
 13622                                  		;test	byte ptr es:[di+24h], 2	; [es:di+BDS.flags+1]
 13623                                  					; unformatted_media
 13624                                  		jnz	short unformatteddrive
 13625                                  		mov	[seccnt], cx	; save sector count
 13626                                  		mov	[spsav], sp	; save sp
 13627                                  
 13628                                  ; ensure that we are trying to access valid sectors on the drive
 13629                                  
 13630                                  		mov	ax, dx
 13631                                  		xor	si, si ; 0
 13632                                  		add	dx, cx
 13633                                  		;adc	si, 0
 13634                                  		; 02/09/2023 (PCDOS 7.1)
 13635                                  		rcl	si, 1
 13636                                  		cmp	word [es:di+0Eh], 0 ; [es:di+BDS.totalsecs16]
 13637                                  					; 32 bit sector ?
 13638                                  		jz	short sanity32
 13639                                  		;cmp	si, 0
 13640                                  		; 02/09/2023
 13641                                  		or	si, si
 13642                                  		jnz	short baddrive
 13643                                  		cmp	dx, [es:di+0Eh]	; [es:di+BDS.totalsecs16]
 13644                                  		ja	short baddrive
 13645                                  		jmp	short sanityok
 13646                                  ; ---------------------------------------------------------------------------
 13647                                  
 13648                                  sanity32:
 13649                                  		add	si, [start_sec_h]
 13650                                  		cmp	si, [es:di+1Dh]	; [es:di+BDS.totalsecs32+2]
 13651                                  		jb	short sanityok
 13652                                  		ja	short baddrive
 13653                                  		cmp	dx, [es:di+1Bh]	; [es:di+BDS.totalsecs32]
 13654                                  		ja	short baddrive
 13655                                  sanityok:
 13656                                  		mov	dx, [start_sec_h]
 13657                                  		add	ax, [es:di+17h]	; [es:di+BDS.hiddensecs]
 13658                                  		adc	dx, [es:di+19h]	; [es:di+BDS.hiddensecs+2]
 13659                                  
 13660                                  ; now dx;ax have the physical first sector.
 13661                                  ; since the following procedures is going to destroy ax, let's
 13662                                  ; save it temporarily to saved_word.
 13663                                  
 13664                                  		mov	[saved_word], ax ; save the sector number (low)
 13665                                  
 13666                                  ; set up pointer to disk base table in [dpt]. we cannot assume that iosetup
 13667                                  ; will do it because we will skip the set up stuff with hard disks.
 13668                                  
 13669                                  		push	es
 13670                                  		;mov	es, [zeroseg]
 13671                                  		; 02/09/2023
 13672                                  		xor	si, si ; 0
 13673                                  		mov	es, si
 13674                                  		les	si, [es:DSKADR]
 13675                                  		;les	si, es:78h	; [es:DSKADR]
 13676                                  					; current disk parm table
 13677                                  		mov	[dpt], si
 13678                                  		mov	[dpt+2], es
 13679                                  		pop	es
 13680                                  		test	byte [es:di+23h], 1 ; [es:di+BDS.flags]
 13681                                  					; fnon_removable
 13682                                  		jnz	short skip_setup
 13683                                  		call	checksingle
 13684                                  
 13685                                  ; check to see if we have previously noted a change line. the routine
 13686                                  ; returns if everything is ok. otherwise, it pops off the stack and returns
 13687                                  ; the proper error code.
 13688                                  
 13689                                  		cmp	byte [fhave96], 0 ; do we have changeline support?
 13690                                  		jz	short diskio_nochangeline ; brif not
 13691                                  		call	checklatchio	; will do a sneaky pop stack return
 13692                                  					; if a disk error occurs
 13693                                  diskio_nochangeline:			
 13694                                  		call	iosetup		; set up tables	and variables for i/o
 13695                                  
 13696                                  ; now the settle values are correct for the following code
 13697                                  
 13698                                  skip_setup:
 13699                                  
 13700                                  ; 32 bit sector calculation.
 13701                                  ; dx:[saved_word] = starting sector number.
 13702                                  				
 13703                                  		mov	ax, dx
 13704                                  		xor	dx, dx
 13705                                  		;div	word [es:di+13h] ; [es:di+BDS.secpertrack]
 13706                                  					 ; divide by sec per track
 13707                                  		; 02/09/2023
 13708                                  		mov	cx, [es:di+13h]
 13709                                  		div	cx
 13710                                  		mov	[temp_h], ax
 13711                                  		mov	ax, [saved_word]
 13712                                  		div	cx ; 02/09/2023
 13713                                  		;div	word [es:di+13h] ; [es:di+BDS.secpertrack]
 13714                                  					; now, [temp_h]:ax = track #, dx = sector
 13715                                  		;inc	dl		; sector number	is 1 based.
 13716                                  		; 18/12/2022
 13717                                  		inc	dx
 13718                                  		mov	[cursec], dl	; save current sector
 13719                                  		mov	cx, [es:di+15h]	; es:di+BDS.heads]
 13720                                  					; get number of	heads
 13721                                  		push	ax
 13722                                  		xor	dx, dx
 13723                                  		mov	ax, [temp_h]	; divide tracks	by heads per cylinder
 13724                                  		div	cx
 13725                                  		mov	[temp_h], ax
 13726                                  		pop	ax
 13727                                  		div	cx		; now, [temp_h]:ax = cylinder #, dx = head
 13728                                  		cmp	word [temp_h], 0
 13729                                  		ja	short baddrive_brdg
 13730                                  		cmp	ax, 1024	; 2^10 currently maxium	for track #.
 13731                                  		ja	short baddrive_brdg
 13732                                  		mov	[curhd], dl	; save current head
 13733                                  		mov	[curtrk], ax	; save current track
 13734                                  
 13735                                  ; we are now set up for the i/o. normally, we consider the dma boundary
 13736                                  ; violations here. not true. we perform the operation as if everything is
 13737                                  ; symmetric; let the int 13 handler worry about the dma violations.
 13738                                  
 13739                                  		mov	ax, [seccnt]
 13740                                  		call	block		; (cas - call/ret)
 13741                                  		;call	done
 13742                                  		;retn
 13743                                  		; 18/12/2022
 13744                                  		jmp	done
 13745                                  %else
 13746                                  		;;;	; 22/12/2023
 13747                                  diskio:
 13748 00000A11 89FB                    		mov	bx, di		; al = drive number
 13749                                  					; cx = sector count
 13750                                  					; dx = first sector (low)
 13751                                  					; [start_sec_h] = first sector (high)
 13752                                  					;
 13753                                  					; es:bx = transfer address
 13754 00000A13 8C06[A804]              		mov	[xfer_seg], es	; save transfer segment
 13755 00000A17 E88AFB                  		call	SetDrive
 13756 00000A1A 268A4510                		mov	al, [es:di+10h]	; [es:di+BDS.media]
 13757 00000A1E A2[1F01]                		mov	[medbyt], al
 13758 00000A21 E3D8                    		jcxz	ioret
 13759                                  
 13760                                  ; see if the media is formatted or not by checking the flags field in
 13761                                  ; in the bds. if it is unformatted we cannot allow i/o, so we should
 13762                                  ; go to the error exit at label unformatteddrive.
 13763                                  
 13764 00000A23 26F6454002              		test	byte [es:di+40h], 2 ; [es:di+BDS.flags+1]
 13765                                  					; unformatted_media
 13766 00000A28 75CE                    		jnz	short unformatteddrive
 13767 00000A2A 890E[2201]              		mov	[seccnt], cx	; save sector count
 13768 00000A2E 8926[3501]              		mov	[spsav], sp	; save sp
 13769                                  
 13770                                  ; ensure that we are trying to access valid sectors on the drive
 13771                                  
 13772 00000A32 89D0                    		mov	ax, dx
 13773 00000A34 31F6                    		xor	si, si ; 0
 13774 00000A36 01CA                    		add	dx, cx
 13775 00000A38 D1D6                    		rcl	si, 1
 13776 00000A3A 26837D0E00              		cmp	word [es:di+0Eh], 0 ; [es:di+BDS.totalsecs16]
 13777                                  					; > 32 bit sector ?
 13778 00000A3F 740E                    		jz	short sanity32
 13779 00000A41 09F6                    		or	si, si
 13780 00000A43 7506                    		jnz	short baddrive
 13781 00000A45 263B550E                		cmp	dx, [es:di+0Eh]	; [es:di+BDS.totalsecs16]
 13782                                  		;ja	short baddrive
 13783                                  		;jmp	short sanityok
 13784                                  		; 22/12/2023
 13785 00000A49 7616                    		jna	short sanityok
 13786                                  ; 29/12/2023
 13787                                  ; 22/12/2023
 13788                                  ;%if 1
 13789                                  ; ---------------------------------------------------------------------------
 13790                                  
 13791                                  baddrive:
 13792 00000A4B B008                    		mov	al, 8		; sector not found
 13793                                  		;jmp	short baddrive_ret
 13794                                  ; ---------------------------------------------------------------------------
 13795                                  ;unformatteddrive:
 13796                                  		;mov	al, 7		; unknown media
 13797                                  baddrive_ret:
 13798 00000A4D F9                      		stc
 13799                                  ;ioret:
 13800 00000A4E C3                      		retn
 13801                                  ;%endif
 13802                                  
 13803                                  ; ---------------------------------------------------------------------------
 13804                                  
 13805                                  sanity32:
 13806 00000A4F 0336[9C04]              		add	si, [start_sec_h]
 13807 00000A53 263B751D                		cmp	si, [es:di+1Dh]	; [es:di+BDS.totalsecs32+2]
 13808 00000A57 7208                    		jb	short sanityok
 13809 00000A59 77F0                    		ja	short baddrive
 13810 00000A5B 263B551B                		cmp	dx, [es:di+1Bh]	; [es:di+BDS.totalsecs32]
 13811 00000A5F 77EA                    		ja	short baddrive
 13812                                  sanityok:
 13813 00000A61 8B16[9C04]              		mov	dx, [start_sec_h]
 13814 00000A65 26034517                		add	ax, [es:di+17h]	; [es:di+BDS.hiddensecs]
 13815 00000A69 26135519                		adc	dx, [es:di+19h]	; [es:di+BDS.hiddensecs+2]
 13816                                  
 13817                                  ; now dx;ax have the physical first sector.
 13818                                  ; since the following procedures is going to destroy ax, let's
 13819                                  ; save it temporarily to saved_word.
 13820                                  
 13821 00000A6D A3[9E04]                		mov	[saved_word], ax ; save the sector number (low)
 13822                                  
 13823                                  ; set up pointer to disk base table in [dpt]. we cannot assume that iosetup
 13824                                  ; will do it because we will skip the set up stuff with hard disks.
 13825                                  
 13826 00000A70 06                      		push	es
 13827 00000A71 31F6                    		xor	si, si ; 0
 13828 00000A73 8EC6                    		mov	es, si
 13829                                  		;les	si, dword ptr es:78h
 13830 00000A75 26C4367800              		les	si, [es:78h]	; INT 1Eh vector address
 13831                                  					; [es:DSKADR] - current disk parm table
 13832 00000A7A 8936[2D01]              		mov	[dpt], si
 13833 00000A7E 8C06[2F01]              		mov	[dpt+2], es
 13834 00000A82 07                      		pop	es
 13835 00000A83 26F6453F01              		test	byte [es:di+3Fh], 1 ; [es:di+BDS.flags], fnon_removable
 13836 00000A88 7510                    		jnz	short chk_13h_ext_flag
 13837 00000A8A E8EAFE                  		call	checksingle
 13838                                  
 13839                                  ; check to see if we have previously noted a change line. the routine
 13840                                  ; returns if everything is ok. otherwise, it pops off the stack and returns
 13841                                  ; the proper error code.
 13842                                  
 13843 00000A8D 803E[7700]00            		cmp	byte [fhave96], 0 ; do we have changeline support?
 13844 00000A92 7403                    		jz	short diskio_nochangeline ; brif not
 13845 00000A94 E8D610                  		call	checklatchio	; will do a sneaky pop stack return
 13846                                  					; if a disk error occurs
 13847                                  diskio_nochangeline:
 13848 00000A97 E8E000                  		call	iosetup		; set up tables and variables for i/o
 13849                                  
 13850                                  chk_13h_ext_flag:
 13851 00000A9A 26F6454004              		test	byte [es:di+40h], 4 ; [es:di+BDS.flags+1], fLBArw
 13852                                  					; LBA read/write flag
 13853 00000A9F 7539                    		jnz	short set_lbarw_1
 13854                                  		;jmp	skip_setup
 13855                                  		; 22/12/2023
 13856                                  ; ---------------------------------------------------------------------------
 13857                                  
 13858                                  ; now the settle values are correct for the following code
 13859                                  
 13860                                  skip_setup:
 13861                                  
 13862                                  ; 32 bit sector calculation.
 13863                                  ; dx:[saved_word] = starting sector number.
 13864                                  
 13865                                  		;push	bp ; ! (not necessary) ; 22/12/2023
 13866 00000AA1 92                      		xchg	ax, dx ; mov ax,dx
 13867 00000AA2 31D2                    		xor	dx, dx
 13868 00000AA4 268B4D13                		mov	cx, [es:di+13h]	; [es:di+BDS.secpertrack]
 13869                                  					; divide by sec per track
 13870 00000AA8 F7F1                    		div	cx
 13871 00000AAA 95                      		xchg	ax, bp ; mov bp,ax
 13872 00000AAB A1[9E04]                		mov	ax, [saved_word]
 13873 00000AAE F7F1                    		div	cx		; [es:di+BDS.secpertrack]
 13874                                  					; now, bp:ax = track #, dx = sector
 13875                                  					; sector number is 1 based.
 13876 00000AB0 42                      		inc	dx
 13877 00000AB1 8816[3101]              		mov	[cursec], dl	; save current sector
 13878 00000AB5 268B4D15                		mov	cx, [es:di+15h] ; [es:di+BDS.heads]
 13879                                  					; get number of heads
 13880                                  		; 22/12/2023
 13881                                  		;push	ax ; *
 13882 00000AB9 31D2                    		xor	dx, dx
 13883 00000ABB 95                      		xchg	ax, bp ; bp = *	; divide tracks by heads per cylinder
 13884 00000ABC F7F1                    		div	cx
 13885 00000ABE 95                      		xchg	ax, bp ; ax = *, bp = **
 13886                                  		;pop	ax ; *
 13887 00000ABF F7F1                    		div	cx		; now, bp:ax = cylinder #, dx = head
 13888 00000AC1 09ED                    		or	bp, bp ; ** = 0 ?
 13889                                  		;pop	bp ; ! ; 22/12/2023
 13890                                  		;jnz	short baddrive_brdg
 13891                                  		; 22/12/2023
 13892 00000AC3 7586                    		jnz	short baddrive
 13893                                  
 13894                                  		;cmp	ax, 1024	; 2^10 currently maximum for track #.
 13895                                  		;jnb	short baddrive_brdg
 13896                                  		; 22/12/2023
 13897 00000AC5 80FC04                  		cmp	ah, 4	; if ax >= 4*256 (1024) 
 13898 00000AC8 7381                    		jnb	short baddrive 
 13899                                  
 13900 00000ACA 8816[3201]              		mov	[curhd], dl	; save current head
 13901 00000ACE A3[3301]                		mov	[curtrk], ax	; save current track
 13902                                  
 13903                                  ; we are now set up for the i/o. normally, we consider the dma boundary
 13904                                  ; violations here. not true. we perform the operation as if everything is
 13905                                  ; symmetric; let the int 13 handler worry about the dma violations.
 13906                                  
 13907 00000AD1 A1[2201]                		mov	ax, [seccnt]
 13908 00000AD4 E82101                  		call	block
 13909                                  		;call	done
 13910                                  		;retn
 13911                                  		; 22/12/2023
 13912 00000AD7 E9E700                  		jmp	done
 13913                                  		
 13914                                  ; ---------------------------------------------------------------------------
 13915                                  
 13916                                  set_lbarw_1:
 13917 00000ADA A1[9E04]                		mov	ax, [saved_word] ; check for mini disk
 13918                                  					 ; (logical dos drive/partition)
 13919 00000ADD 26837D7901              		cmp	word [es:di+79h], 1 ; [di+BDS.bdsm_ismini]
 13920                                  					    ; logical dos partition
 13921 00000AE2 750F                    		jnz	short set_lbarw_2 ; not a logical dos partition/drive
 13922 00000AE4 26837D7B00              		cmp	word [es:di+7Bh], 0 ; [di+BDS.bdsm_hidden_trks] (> 0)
 13923 00000AE9 7408                    		jz	short set_lbarw_2
 13924 00000AEB 26034517                		add	ax, [es:di+17h]	; [es:di+BDS.hiddensecs]
 13925 00000AEF 26135519                		adc	dx, [es:di+19h]	; [es:di+BDS.hiddensecs+2]
 13926                                  
 13927                                  set_lbarw_2:
 13928 00000AF3 2EA3[040A]              		mov	[cs:dap_lba_value], ax
 13929 00000AF7 2E8916[060A]            		mov	[cs:dap_lba_value+2], dx
 13930 00000AFC 2E891E[000A]            		mov	[cs:dap_trans_buf], bx
 13931 00000B01 A1[A804]                		mov	ax, [xfer_seg]
 13932 00000B04 2EA3[020A]              		mov	[cs:dap_trans_buf+2], ax
 13933 00000B08 A1[2201]                		mov	ax, [seccnt]
 13934 00000B0B 2EA3[FE09]              		mov	[cs:dap_block_cnt], ax
 13935 00000B0F BD0500                  		mov	bp, 5
 13936 00000B12 892E[A304]              		mov	[vretry_cnt], bp ; verify op. retry cnt for write-verify
 13937 00000B16 892E[A504]              		mov	[soft_ecc_cnt], bp ; soft ecc error retry count
 13938                                  
 13939                                  set_lbarw_3:
 13940 00000B1A 268A5504                		mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 13941 00000B1E 8A26[2001]              		mov	ah, [rflag]	; get read/write indicator
 13942 00000B22 80C440                  		add	ah, 40h
 13943 00000B25 30C0                    		xor	al, al
 13944 00000B27 1E                      		push	ds
 13945 00000B28 0E                      		push	cs
 13946 00000B29 1F                      		pop	ds
 13947 00000B2A BE[FC09]                		mov	si, LBA_Packet
 13948 00000B2D CD13                    		int	13h		; LBA read/write
 13949 00000B2F 1F                      		pop	ds
 13950 00000B30 731A                    		jnc	short set_lbarw_7
 13951 00000B32 E8AB02                  		call	again
 13952                                  set_lbarw_9:
 13953 00000B35 7503                    		jnz	short set_lbarw_4
 13954 00000B37 E92A02                  		jmp	harderr
 13955                                  ; ---------------------------------------------------------------------------
 13956                                  
 13957                                  set_lbarw_4:
 13958                                  ;set_lbarw_9:	; 22/12/2023
 13959 00000B3A 80FCCC                  		cmp	ah, 0CCh	; Write fault (hard disk)
 13960 00000B3D 7505                    		jnz	short set_lbarw_5
 13961 00000B3F BD0100                  		mov	bp, 1
 13962 00000B42 EB06                    		jmp	short set_lbarw_6
 13963                                  ; ---------------------------------------------------------------------------
 13964                                  
 13965                                  set_lbarw_5:
 13966                                  set_lbarw_10:	; 22/12/2023
 13967 00000B44 C706[A504]0500          		mov	word [soft_ecc_cnt], 5 ; soft ecc error retry count
 13968                                  set_lbarw_6:
 13969                                  set_lbarw_11:
 13970 00000B4A EBCE                    		jmp	short set_lbarw_3
 13971                                  ; ---------------------------------------------------------------------------
 13972                                  
 13973                                  set_lbarw_7:
 13974 00000B4C 813E[2001]0301          		cmp	word [rflag], 103h
 13975 00000B52 7523                    		jnz	short set_lbarw_12
 13976 00000B54 B444                    		mov	ah, 44h
 13977 00000B56 1E                      		push	ds
 13978 00000B57 0E                      		push	cs
 13979 00000B58 1F                      		pop	ds
 13980 00000B59 CD13                    		int	13h		; DISK - IBM/MS Extension - VERIFY SECTORS
 13981                                  					;  (DL - drive, [SI - disk address packet)
 13982 00000B5B 1F                      		pop	ds
 13983 00000B5C 7319                    		jnc	short set_lbarw_12
 13984 00000B5E 80FC11                  		cmp	ah, 11h		; ECC corrected data error (soft error - retried OK )
 13985 00000B61 7506                    		jnz	short set_lbarw_8
 13986 00000B63 FF0E[A504]              		dec	word [soft_ecc_cnt]
 13987                                  ;set_lbarw_8:
 13988 00000B67 740E                    		jz	short set_lbarw_12
 13989                                  set_lbarw_8:
 13990 00000B69 E8CE07                  		call	ResetDisk
 13991 00000B6C 80FC11                  		cmp	ah, 11h
 13992 00000B6F 74D9                    		jz	short set_lbarw_11
 13993 00000B71 FF0E[A304]              		dec	word [vretry_cnt]
 13994                                  		;jnz	short set_lbarw_9
 13995                                  		;jmp	harderr
 13996                                  		; 22/12/2023
 13997 00000B75 EBBE                    		jmp	short set_lbarw_9
 13998                                  
 13999                                  ; ---------------------------------------------------------------------------
 14000                                  ;		; 22/12/2023
 14001                                  ;set_lbarw_9:
 14002                                  ;		cmp	ah, 0CCh
 14003                                  ;		jnz	short set_lbarw_10
 14004                                  ;		mov	bp, 1
 14005                                  ;		jmp	short set_lbarw_11
 14006                                  ; ---------------------------------------------------------------------------
 14007                                  ;		; 22/12/2023
 14008                                  ;set_lbarw_10:
 14009                                  ;		mov	word [soft_ecc_cnt], 5 ; soft ecc error retry count
 14010                                  ;set_lbarw_11:
 14011                                  ;		jmp	short set_lbarw_3
 14012                                  ; ---------------------------------------------------------------------------
 14013                                  
 14014                                  set_lbarw_12:
 14015 00000B77 31C0                    		xor	ax, ax
 14016                                  skip_dpt_setting:	; 23/12/2023
 14017 00000B79 C3                      		retn
 14018                                  		;;;	; 22/12/2023
 14019                                  %endif
 14020                                  
 14021                                  ; ---------------------------------------------------------------------------
 14022                                  
 14023                                  		; 22/12/2023
 14024                                  ;baddrive_brdg:
 14025                                  		;jmp	baddrive
 14026                                  
 14027                                  ; =============== S U B	R O U T	I N E =======================================
 14028                                  
 14029                                  ;--------------------------------------------------------------
 14030                                  ; set the drive-last-accessed flag for diskette only.
 14031                                  ; we know that the hard disk will not be removed.
 14032                                  ; es:di -> current bds.
 14033                                  ; ds -> Bios_Data
 14034                                  ; ax,cx,si are destroyed.
 14035                                  ;--------------------------------------------------------------
 14036                                  
 14037                                  		; 23/12/2023 - Retro DOS v5.0
 14038                                  
 14039                                  		; 19/10/2022
 14040                                  iosetup:
 14041 00000B7A 268A4504                		mov	al, [es:di+4]	; [es:di+BDS.drivenum]
 14042 00000B7E A2[1E01]                		mov	[tim_drv], al	; save drive letter
 14043                                  
 14044                                  ; determine proper head settle values
 14045                                  
 14046 00000B81 803E[A905]00            		cmp	byte [media_set_for_format], 0
 14047 00000B86 75F1                    		jnz	short skip_dpt_setting
 14048 00000B88 A0[2C01]                		mov	al, [eot]	; fetch	up eot before changing ds
 14049 00000B8B 1E                      		push	ds
 14050 00000B8C C536[2D01]              		lds	si, [dpt]	; get pointer to disk base table
 14051 00000B90 884404                  		mov	[si+4],	al
 14052                                  		; 23/12/2023
 14053 00000B93 88C4                    		mov	ah, al
 14054 00000B95 8A440A                  		mov	al, [si+10]	; [si+DISK_PARMS.DISK_MOTOR_STRT]
 14055                                  		;mov	ah, [si+4]	; [si+DISK_PARMS.DISK_EOT]
 14056 00000B98 1F                      		pop	ds
 14057 00000B99 A2[2601]                		mov	[motorstartup], al
 14058 00000B9C 8826[2B01]              		mov	[save_eot], ah
 14059                                  
 14060                                  ; for 3.5" drives, both external as well as on the k09, we need to set the
 14061                                  ; motor start time to 4. this checking for every i/o is going to affect
 14062                                  ; performance across the board, but is necessary!!
 14063                                  
 14064 00000BA0 1E                      		push	ds
 14065 00000BA1 C536[2D01]              		lds	si, [dpt]	; get pointer to disk base table
 14066                                  		; 23/12/2023  - Retro DOS v5.0
 14067 00000BA5 26807D3E02              		cmp	byte [es:di+3Eh], 2 ; (PCDOS 7.1 IBMBIO.COM)
 14068                                  		;cmp	byte [es:di+22h], 2 ; [es:di+BDS.formfactor]
 14069                                  					; ffSmall
 14070 00000BAA 7505                    		jnz	short motor_start_ok
 14071 00000BAC B004                    		mov	al, 4
 14072 00000BAE 86440A                  		xchg	al, [si+10]	; [si+DISK_PARMS.DISK_MOTOR_STRT]
 14073                                  motor_start_ok:
 14074                                  
 14075                                  ; ds:si now points to disk parameter table.
 14076                                  ; get current settle and set fast settle
 14077                                  
 14078                                  		;xor	al, al
 14079                                  		;inc	al		; ibm wants fast settle	to be 1
 14080                                  		; 18/12/2022
 14081 00000BB1 31C0                    		xor	ax, ax
 14082 00000BB3 40                      		inc	ax
 14083 00000BB4 864409                  		xchg	al, [si+9]	; [si+DISK_PARMS.DISK_HEAD_STTL]
 14084                                  					; get settle and set up	for fast
 14085 00000BB7 1F                      		pop	ds
 14086 00000BB8 A2[2701]                		mov	[settlecurrent], al
 14087 00000BBB B00F                    		mov	al, 15		; NORMSETTLE
 14088                                  					; someone has diddled the settle
 14089 00000BBD A2[2801]                		mov	[settleslow], al
 14090                                  		; 23/12/2023
 14091                                  ;skip_dpt_setting:
 14092 00000BC0 C3                      		retn
 14093                                  
 14094                                  ; =============== S U B	R O U T	I N E =======================================
 14095                                  
 14096                                  ;--------------------------------------------------------------
 14097                                  ; set time of last access, and reset default values in the dpt.
 14098                                  ;
 14099                                  ;	  note: trashes (at least) si
 14100                                  ;--------------------------------------------------------------
 14101                                  
 14102                                  		; 23/12/2023 - Retro DOS v5.0
 14103                                  
 14104                                  		; 19/10/2022
 14105                                  done:		
 14106                                  		;test	byte [es:di+23h], 1 ; [es:di+BDS.flags]
 14107                                  					; fnon_removable
 14108                                  		; 23/12/2023
 14109 00000BC1 26F6453F01              		test	byte [es:di+3Fh], 1 ; (PCDOS 7.1 IBMBIO.COM)
 14110 00000BC6 752F                    		jnz	short ddbx	; do not set for non-removable media
 14111 00000BC8 E8F501                  		call	set_tim
 14112                                  ;diddleback:
 14113                                  ; 09/12/2022
 14114                                  diddle_back:
 14115 00000BCB 9C                      		pushf
 14116 00000BCC 803E[A905]00            		cmp	byte [media_set_for_format], 0
 14117 00000BD1 7523                    		jnz	short nodiddleback
 14118 00000BD3 50                      		push	ax
 14119 00000BD4 06                      		push	es
 14120 00000BD5 C436[2D01]              		les	si, [dpt]
 14121 00000BD9 A0[2B01]                		mov	al, [save_eot]
 14122 00000BDC 26884404                		mov	[es:si+4], al	; [es:si+DISK_PARMS.DISK_EOT]
 14123 00000BE0 A0[2701]                		mov	al, [settlecurrent]
 14124 00000BE3 8A26[2601]              		mov	ah, [motorstartup]
 14125 00000BE7 26884409                		mov	[es:si+9], al	; [es:si+DISK_PARMS.DISK_HEAD_STTL]
 14126 00000BEB 26C6440302              		mov	byte [es:si+3], 2 ; [es:si+DISK_PARMS.DISK_SECTOR_SIZ]
 14127 00000BF0 2688640A                		mov	[es:si+0Ah], ah	; [es:si+DISK_PARMS.DISK_MOTOR_STRT]
 14128 00000BF4 07                      		pop	es
 14129 00000BF5 58                      		pop	ax
 14130                                  nodiddleback:
 14131 00000BF6 9D                      		popf
 14132                                  ddbx:
 14133 00000BF7 C3                      		retn
 14134                                  
 14135                                  ; =============== S U B	R O U T	I N E =======================================
 14136                                  
 14137                                  ;--------------------------------------------------------------
 14138                                  ;read the number of sectors specified in ax,
 14139                                  ;handling track boundaries
 14140                                  ;es:di -> bds for this drive
 14141                                  ;--------------------------------------------------------------
 14142                                  
 14143                                  		; 23/12/2023 - Retro DOS v5.0
 14144                                  
 14145                                  		; 19/10/2022
 14146                                  block:	
 14147 00000BF8 09C0                    		or	ax, ax
 14148 00000BFA 74FB                    		jz	short ddbx
 14149                                  		; 23/12/2023
 14150 00000BFC 26F6453F01              		test	byte [es:di+3Fh], 1 ; (PCDOS 7.1 IBMBIO.COM)
 14151                                  		;test	byte [es:di+23h], 1 ; [es:di+BDS.flags]
 14152                                  					    ; fnon_removable
 14153 00000C01 740D                    		jz	short block_floppy
 14154                                  
 14155                                  ; check	to see if multi	track operation	is allowed. if not
 14156                                  ; we have to go	to the block_floppy below to break up the operation.
 14157                                  
 14158 00000C03 F606[A004]80            		test	byte [multrk_flag], 80h
 14159                                  		;test	byte ptr ds:multrk_flag, 80h ; multrk_on
 14160 00000C08 7406                    		jz	short block_floppy
 14161 00000C0A E82800                  		call	Disk
 14162 00000C0D 31C0                    		xor	ax, ax
 14163 00000C0F C3                      		retn
 14164                                  ; ---------------------------------------------------------------------------
 14165                                  
 14166                                  block_floppy:
 14167                                  
 14168                                  ; read at most 1 track worth. perform minimization at sector / track
 14169                                  
 14170 00000C10 268A4D13                		mov	cl, [es:di+19]	; [es:di+BDS.secpertrack]
 14171                                  		;inc	cl
 14172                                  		; 23/12/2023
 14173 00000C14 41                      		inc	cx
 14174 00000C15 2A0E[3101]              		sub	cl, [cursec]
 14175 00000C19 30ED                    		xor	ch, ch
 14176 00000C1B 39C8                    		cmp	ax, cx
 14177 00000C1D 7302                    		jnb	short gotmin
 14178 00000C1F 89C1                    		mov	cx, ax
 14179                                  gotmin:
 14180                                  
 14181                                  ; ax is the requested number of sectors to read
 14182                                  ; cx is the number that we can do on this track
 14183                                  
 14184 00000C21 50                      		push	ax
 14185 00000C22 51                      		push	cx
 14186 00000C23 89C8                    		mov	ax, cx
 14187 00000C25 E80D00                  		call	Disk
 14188 00000C28 59                      		pop	cx
 14189 00000C29 58                      		pop	ax
 14190                                  
 14191                                  ; cx is the number of sectors just transferred
 14192                                  
 14193 00000C2A 29C8                    		sub	ax, cx		; reduce sectors-remaining by last i/o
 14194 00000C2C D0E1                    		shl	cl, 1
 14195 00000C2E 00CF                    		add	bh, cl		; adjust transfer address
 14196 00000C30 EBC6                    		jmp	short block
 14197                                  dskerr_brdg:
 14198 00000C32 E9F100                  		jmp	dskerr
 14199                                  
 14200                                  ; =============== S U B	R O U T	I N E =======================================
 14201                                  
 14202                                  ; 15/10/2022
 14203                                  
 14204                                  ;--------------------------------------------------------------
 14205                                  ;perform disk i/o with retries
 14206                                  ; al = number of sectors (1-8, all on one track)
 14207                                  ; es:di point to drive parameters
 14208                                  ; xfer_seg:bx = transfer address 
 14209                                  ;		(must not cross a 64k physical boundary)
 14210                                  ; [rflag] = 2 if read, 3 if write
 14211                                  ; [verify] = 0 for normal, 1 for verify after write
 14212                                  ;--------------------------------------------------------------
 14213                                  
 14214                                  		; 23/12/2023 - Retro DOS v5.0
 14215                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:0C74h)
 14216                                  
 14217                                  		; 19/10/2022
 14218                                  Disk:
 14219                                  
 14220                                  ; Check for hard disk format and
 14221                                  ; if TRUE then set max error count to 2
 14222                                  
 14223 00000C35 BD0500                  		mov	bp, 5		; MAXERR
 14224                                  					; set up retry count
 14225                                  		; 23/12/2023
 14226 00000C38 268A4D3F                		mov	cl, [es:di+3Fh]
 14227 00000C3C 83E101                  		and	cx, 1
 14228                                  		;test	byte [es:di+3Fh], 1
 14229                                  		;;test	byte [es:di+23h], 1 
 14230                                  					; [es:di+BDS.flags], fnon_removable
 14231 00000C3F 7408                    		jz	short GetRdWrInd
 14232 00000C41 80FC04                  		cmp	ah, 4		; romverify ; Is this a	track verify?
 14233 00000C44 7403                    		jz	short GetRdWrInd
 14234 00000C46 BD0200                  		mov	bp, 2		; This is not verify so only 1 retry
 14235                                  GetRdWrInd:				
 14236 00000C49 892E[A304]              		mov	[vretry_cnt], bp ; verify op. retry cnt for write-verify
 14237 00000C4D 892E[A504]              		mov	[soft_ecc_cnt], bp ; soft ecc error retry count.
 14238 00000C51 8A26[2001]              		mov	ah, [rflag]	; get read/write indicator
 14239                                  ;retry:
 14240                                  ; 09/12/2022
 14241                                  _retry:
 14242 00000C55 50                      		push	ax
 14243 00000C56 8B16[3301]              		mov	dx, [curtrk]
 14244                                  		; 23/12/2023
 14245 00000C5A E30B                    		jcxz	disk_not_mini
 14246                                  		;test	byte [es:di+3Fh], 1
 14247                                  		;;test	byte [es:di+23h], 1
 14248                                  		;jz	short disk_not_mini
 14249                                  
 14250                                  		; 23/12/2023
 14251 00000C5C 26837D7901              		cmp	word [es:di+79h], 1
 14252                                  		;cmp	word [es:di+47h], 1 ; [es:di+BDS.bdsm_ismini]
 14253                                  					; is this a mini disk? ((logical dos partition))
 14254 00000C61 7504                    		jnz	short disk_not_mini ; no. continue to next.
 14255                                  		; 23/12/2023
 14256 00000C63 2603557B                		add     dx, [es:di+7Bh]
 14257                                  		;add	dx, [es:di+49h]	; [es:di+BDS.bdsm_hidden_trks]
 14258                                  					; add hidden trks.
 14259                                  disk_not_mini:
 14260 00000C67 D0CE                    		ror	dh, 1
 14261 00000C69 D0CE                    		ror	dh, 1
 14262 00000C6B 0A36[3101]              		or	dh, [cursec]
 14263 00000C6F 89D1                    		mov	cx, dx
 14264 00000C71 86E9                    		xchg	ch, cl		;  cl =	sector,	ch = cylinder
 14265 00000C73 8A36[3201]              		mov	dh, [curhd]	; load current head number and
 14266 00000C77 268A5504                		mov	dl, [es:di+4]	; physical drive number
 14267                                  					; [es:di+BDS.drivenum]
 14268                                  		; 23/12/2023
 14269 00000C7B 26807D3E05              		cmp	byte [es:di+3Eh], 5 
 14270                                  		;cmp	byte [es:di+22h], 5 ; [es:di+BDS.formfactor], ffHardFile
 14271 00000C80 7411                    		jz	short do_fast	; hard files use fast speed
 14272                                  
 14273                                  ; if we have [step_drv] set to -1, we use the slow settle time.
 14274                                  ; this helps when we have just done a reset disk operation and the head has
 14275                                  ; been moved to another cylinder - the problem crops up with 3.5" drives.
 14276                                  
 14277 00000C82 803E[7600]FF            		cmp	byte [step_drv], 0FFh ; -1
 14278                                  		;jz	short do_writej
 14279                                  		; 23/12/2023
 14280 00000C87 746A                    		jz	short do_write
 14281 00000C89 80FC02                  		cmp	ah, 2		; romread
 14282 00000C8C 7405                    		jz	short do_fast
 14283 00000C8E 80FC04                  		cmp	ah, 4		; romverify
 14284                                  		;jz	short do_fast
 14285                                  		; 23/12/2023
 14286 00000C91 7560                    		jnz	short do_write
 14287                                  ;do_writej:
 14288                                  
 14289                                  ; reads always fast, unless we have just done a disk reset operation
 14290                                  			
 14291                                  		;jmp	short do_write	; reads	always fast
 14292                                  ; ---------------------------------------------------------------------------
 14293                                  
 14294                                  do_fast:
 14295 00000C93 E80501                  		call	fastspeed	; change settle	mode
 14296                                  testerr:
 14297 00000C96 729A                    		jb	short dskerr_brdg
 14298                                  
 14299                                  		; 23/12/2023 Retro DOS v5.0
 14300                                  		; (PCDOS 7.1 IBMBIO.COM)
 14301 00000C98 83FD05                  		cmp	bp, 5		; is there retry ?
 14302 00000C9B 7505                    		jnz	short testerror	; yes
 14303 00000C9D 80FCBB                  		cmp	ah, 0BBh	; Undefined error (hard disk)
 14304 00000CA0 7490                    		jz	short dskerr_brdg
 14305                                  testerror:
 14306                                  
 14307                                  ; set drive and track of last access
 14308                                  
 14309 00000CA2 8816[7600]              		mov	[step_drv], dl
 14310                                  		; 23/12/2023
 14311 00000CA6 26886D78                		mov	[es:di+78h], ch
 14312                                  		;mov	[es:di+46h], ch	; [es:di+BDS.track]
 14313                                  no_set:
 14314                                  		;cmp	word [wrtverify], 103h
 14315 00000CAA 813E[2001]0301          		cmp	word [rflag], 103h ; check for write and verify
 14316 00000CB0 7452                    		jz	short doverify
 14317                                  noverify:
 14318 00000CB2 58                      		pop	ax
 14319                                  
 14320                                  ; check the flags word in the bds to see if the drive is non removable
 14321                                  ; if not we needn't do anything special
 14322                                  ; if it is a hard disk then check to see if multi-track operation
 14323                                  ; is specified. if specified we don't have to calculate for the next
 14324                                  ; track since we are already done. so we can go to the exit of this routine.
 14325                                  
 14326                                  		; 23/12/2023
 14327 00000CB3 26F6453F01              		test	byte [es:di+3Fh], 1
 14328                                  		;test	byte [es:di+23h], 1 ; [es:di+BDS.flags]
 14329                                  					; fnon_removable
 14330 00000CB8 7407                    		jz	short its_removable
 14331 00000CBA F606[A004]80            		test	byte [multrk_flag], 80h ; multrk_on
 14332 00000CBF 7530                    		jnz	short disk_ret
 14333                                  its_removable:
 14334 00000CC1 80E13F                  		and	cl, 3Fh		; eliminate cylinder bits from sector
 14335 00000CC4 30E4                    		xor	ah, ah
 14336 00000CC6 2906[2201]              		sub	[seccnt], ax	; reduce count of sectors to go	next sector
 14337 00000CCA 00C1                    		add	cl, al
 14338 00000CCC 880E[3101]              		mov	[cursec], cl
 14339 00000CD0 263A4D13                		cmp	cl, [es:di+13h]	; [es:di+BDS.secpertrack]
 14340                                  					; see if sector/track limit reached
 14341 00000CD4 761B                    		jbe	short disk_ret
 14342 00000CD6 C606[3101]01            		mov	byte [cursec], 1 ; start with first sector of next track
 14343 00000CDB 8A36[3201]              		mov	dh, [curhd]
 14344 00000CDF FEC6                    		inc	dh
 14345 00000CE1 263A7515                		cmp	dh, [es:di+15h]	; [es:di+BDS.heads]
 14346 00000CE5 7206                    		jb	short noxor
 14347 00000CE7 30F6                    		xor	dh, dh
 14348 00000CE9 FF06[3301]              		inc	word [curtrk]
 14349                                  noxor:
 14350 00000CED 8836[3201]              		mov	[curhd], dh
 14351                                  disk_ret:
 14352 00000CF1 F8                      		clc
 14353 00000CF2 C3                      		retn
 14354                                  ; ---------------------------------------------------------------------------
 14355                                  
 14356                                  ; 15/10/2022
 14357                                  
 14358                                  ; 24/12/2023 - Retro DOS v5.0
 14359                                  
 14360                                  ;--------------------------------------------------------------
 14361                                  ; the request is for write. determine if we are talking about
 14362                                  ; the same track and drive. if so, use the fast speed.
 14363                                  ;--------------------------------------------------------------
 14364                                  
 14365                                  do_write:
 14366 00000CF3 3A16[7600]              		cmp	dl, [step_drv]
 14367 00000CF7 7506                    		jnz	short do_norm	; we have changed drives
 14368                                  		; 24/12/2023
 14369 00000CF9 263A6D78                		cmp	ch, [es:di+78h]
 14370                                  		;cmp	ch, [es:di+46h]	; [es:di+BDS.track]
 14371 00000CFD 7494                    		jz	short do_fast	; we are still on the same track
 14372                                  do_norm:
 14373 00000CFF E87500                  		call	normspeed
 14374 00000D02 EB92                    		jmp	short testerr
 14375                                  ; ---------------------------------------------------------------------------
 14376                                  
 14377                                  ;--------------------------------------------------------------
 14378                                  ; we have a verify request also. get state info and go verify
 14379                                  ;--------------------------------------------------------------
 14380                                  
 14381                                  doverify:
 14382 00000D04 58                      		pop	ax
 14383 00000D05 50                      		push	ax
 14384 00000D06 B404                    		mov	ah, 4
 14385 00000D08 E89000                  		call	fastspeed
 14386 00000D0B 73A5                    		jnb	short noverify
 14387                                  
 14388                                  ; check the error returned in ah to see if it is a soft ecc error.
 14389                                  ; if it is not we needn't do anything special. if it is a soft
 14390                                  ; ecc error then decrement the soft_ecc_cnt error retry count. if
 14391                                  ; this retry count becomes 0 then we just ignore the error and go to
 14392                                  ; no_verify but if we can still try then we call the routine to reset
 14393                                  ; the disk and go to dskerr1 to retry the operation.
 14394                                  
 14395 00000D0D 80FC11                  		cmp	ah, 11h		; soft ecc error ?
 14396 00000D10 750B                    		jnz	short not_softecc_err
 14397 00000D12 FF0E[A504]              		dec	word [soft_ecc_cnt]
 14398 00000D16 749A                    		jz	short noverify	; no more retry
 14399 00000D18 E81F06                  		call	ResetDisk	; reset	disk
 14400 00000D1B EB3E                    		jmp	short dskerr1	; retry
 14401                                  ; ---------------------------------------------------------------------------
 14402                                  
 14403                                  not_softecc_err:			; other error.
 14404 00000D1D E81A06                  		call	ResetDisk
 14405 00000D20 FF0E[A304]              		dec	word [vretry_cnt]
 14406 00000D24 EB1C                    		jmp	short dskerr0
 14407                                  ; ---------------------------------------------------------------------------
 14408                                  
 14409                                  ;--------------------------------------------------------------
 14410                                  ; need to special case the change-line error ah=06h.
 14411                                  ; if we get this, we need to return it.
 14412                                  ;--------------------------------------------------------------
 14413                                  
 14414                                  dskerr:
 14415 00000D26 803E[7700]00            		cmp	byte [fhave96], 0	; do we	have changeline	support?
 14416 00000D2B 7403                    		jz	short dskerr_nochangeline ; brif not
 14417 00000D2D E8C30E                  		call	checkio
 14418                                  dskerr_nochangeline:
 14419 00000D30 803E[A704]01            		cmp	byte [multitrk_format_flag], 1 ; multi trk format request?
 14420 00000D35 7508                    		jnz	short dochkagain ; no more retry.
 14421 00000D37 BD0100                  		mov	bp, 1
 14422 00000D3A C606[A704]00            		mov	byte [multitrk_format_flag], 0 ; clear the flag.
 14423                                  dochkagain:
 14424 00000D3F E89E00                  		call	again
 14425                                  dskerr0:
 14426 00000D42 7420                    		jz	short harderr
 14427                                  		; 24/12/2023
 14428 00000D44 26F6453F01              		test	byte [es:di+3Fh], 1
 14429                                  		;test	byte [es:di+23h], 1 ; [es:di+BDS.flags]
 14430                                  					; fnon_removable
 14431 00000D49 7505                    		jnz	short skip_timeout_chk
 14432 00000D4B 80FC80                  		cmp	ah, 80h		; timeout?
 14433 00000D4E 7414                    		jz	short harderr
 14434                                  skip_timeout_chk:
 14435 00000D50 80FCCC                  		cmp	ah, 0CCh	; write	fault error?
 14436 00000D53 740A                    		jz	short write_fault_err ;	then, don't retry.
 14437 00000D55 C706[A504]0500          		mov	word [soft_ecc_cnt], 5 ; MAXERR
 14438                                  					; set soft_ecc_cnt back	to maxerr
 14439                                  dskerr1:
 14440 00000D5B 58                      		pop	ax		; restore sector count
 14441                                  		;jmp	retry
 14442                                  		; 09/12/2022
 14443 00000D5C E9F6FE                  		jmp	_retry
 14444                                  ; ---------------------------------------------------------------------------
 14445                                  
 14446                                  write_fault_err:
 14447 00000D5F BD0100                  		mov	bp, 1		; just retry only once
 14448                                  					; for write fault error.
 14449 00000D62 EBF7                    		jmp	short dskerr1
 14450                                  
 14451                                  		; fall into harderr
 14452                                  ; ---------------------------------------------------------------------------
 14453                                  
 14454                                  ; entry point for routines that call maperror themselves
 14455                                  
 14456                                  harderr:
 14457 00000D64 E84100                  		call	maperror
 14458                                  harderr2:
 14459 00000D67 C606[1E01]FF            		mov	byte [tim_drv], 0FFh
 14460                                  					; force a media check through rom
 14461 00000D6C 8B0E[2201]              		mov	cx, [seccnt]	; get count of sectors to go
 14462 00000D70 8B26[3501]              		mov	sp, [spsav]	; recover entry	stack pointer
 14463                                  
 14464                                  ; since we are performing a non-local goto, restore the disk parameters
 14465                                  
 14466                                  		;jmp	diddleback
 14467                                  		; 09/12/2022
 14468 00000D74 E954FE                  		jmp	diddle_back
 14469                                  
 14470                                  ; =============== S U B	R O U T	I N E =======================================
 14471                                  
 14472                                  ; change settle value from settlecurrent to whatever is appropriate
 14473                                  ; note that this routine is never called for a fixed disk.
 14474                                  
 14475                                  		; 19/10/2022
 14476                                  normspeed:
 14477 00000D77 803E[A905]00            		cmp	byte [media_set_for_format], 0
 14478 00000D7C 751D                    		jnz	short fastspeed
 14479 00000D7E 06                      		push	es
 14480 00000D7F 50                      		push	ax
 14481 00000D80 A0[2801]                		mov	al, [settleslow]
 14482 00000D83 C436[2D01]              		les	si, [dpt]	; current disk parm table
 14483 00000D87 26884409                		mov	[es:si+9], al	; [es:si+DISK_PARMS.DISK_HEAD_STTL]
 14484 00000D8B 58                      		pop	ax
 14485 00000D8C 07                      		pop	es
 14486 00000D8D E80B00                  		call	fastspeed
 14487                                  		; 24/12/2023
 14488                                  		;push	es
 14489                                  		;les	si, [dpt]
 14490                                  		;mov	byte [es:si+9], 1 ; [es:si+DISK_PARMS.DISK_HEAD_STTL]
 14491                                  		;			; 1 is fast settle value
 14492                                  		;pop	es
 14493 00000D90 1E                      		push	ds
 14494 00000D91 C536[2D01]              		lds	si, [dpt]
 14495 00000D95 C6440901                		mov	byte [si+9], 1
 14496 00000D99 1F                      		pop	ds
 14497                                  
 14498 00000D9A C3                      		retn
 14499                                  
 14500                                  ; =============== S U B	R O U T	I N E =======================================
 14501                                  
 14502                                  ; if the drive has been marked as too big (i.e. starting sector of the
 14503                                  ; partition is > 16 bits, then always return drive not ready.
 14504                                  
 14505                                  		; 24/12/2023 - Retro DOS v5.0
 14506                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:0DDDh)
 14507                                  fastspeed:
 14508                                  		;;test	byte [es:di+3Bh], 80h ; [es:di+BDS.fatsiz]
 14509                                  		;test	byte [es:di+1Fh], 80h ; [es:di+BDS.fatsiz]
 14510                                  		;			; ftoobig
 14511                                  		;jnz	short notready
 14512 00000D9B 06                      		push	es
 14513 00000D9C 8E06[A804]              		mov	es, [xfer_seg]
 14514 00000DA0 CD13                    		int	13h		; DISK -
 14515 00000DA2 8C06[A804]              		mov	[xfer_seg], es
 14516 00000DA6 07                      		pop	es
 14517 00000DA7 C3                      		retn
 14518                                  ; ---------------------------------------------------------------------------
 14519                                  ;		; 24/12/2023
 14520                                  ;notready:
 14521                                  		;stc
 14522                                  		;mov	ah, 80h
 14523                                  		;retn
 14524                                  
 14525                                  ; =============== S U B	R O U T	I N E =======================================
 14526                                  
 14527                                  ; map error returned by rom in ah into corresponding code to be returned to
 14528                                  ; dos in al. trashes di. guaranteed to set carry.
 14529                                  
 14530                                  maperror:
 14531 00000DA8 51                      		push	cx
 14532 00000DA9 06                      		push	es
 14533 00000DAA 1E                      		push	ds		; set es=Bios_Data
 14534 00000DAB 07                      		pop	es
 14535 00000DAC 88E0                    		mov	al, ah		; put error code in al
 14536 00000DAE A2[4601]                		mov	[lsterr], al	; terminate list with error code
 14537                                  		; 24/12/2023
 14538 00000DB1 B90B00                  		mov	cx, 11 ; PCDOS 7.1 ; 02/09/2023
 14539                                  		;mov	cx, 9		; numerr (= errout-errin)
 14540                                  					; number of possible error conditions
 14541 00000DB4 BF[3C01]                		mov	di, errin	; point to error conditions
 14542 00000DB7 F2AE                    		repne scasb
 14543                                  
 14544                                  		; 24/12/2023
 14545                                  		; 02/09/2023
 14546 00000DB9 8A450A                  		mov	al, [di+10] ; PCDOS 7.1 IBMBIO.COM
 14547                                  		; 10/12/2022
 14548                                  		;mov	al, [di+8]	; [di+numerr-1]
 14549                                  					; get translation
 14550                                  		; 19/10/2022 - Temporary ! 
 14551                                  		;db	8Ah, 85h, 8, 0	; mov al, [di+8]
 14552 00000DBC 07                      		pop	es
 14553 00000DBD 59                      		pop	cx
 14554 00000DBE F9                      		stc			; flag error condition
 14555 00000DBF C3                      		retn
 14556                                  
 14557                                  ; =============== S U B	R O U T	I N E =======================================
 14558                                  
 14559                                  ; set the time of last access for this drive.
 14560                                  ; this is done only for removable media. es:di -> bds
 14561                                  
 14562                                  set_tim:
 14563 00000DC0 50                      		push	ax
 14564 00000DC1 E86DF7                  		call	GetTickCnt	; Does INT 1A ah=0 & updates daycnt
 14565                                  
 14566                                  ; we have the new time. if we see that the time has passed,
 14567                                  ; then we reset the threshold counter...
 14568                                  
 14569                                  		; 24/12/2023 - Retro DOS v5.0
 14570 00000DC4 263B5579                		cmp	dx, [es:di+79h]	; PCDOS 7.1 IBMBIO.COM
 14571                                  		;cmp	dx, [es:di+47h]	; [es:di+BDS.tim_lo]
 14572 00000DC8 7506                    		jne	short setaccess
 14573                                  		; 24/12/2023
 14574 00000DCA 263B4D7B                		cmp	cx, [es:di+7Bh]	; PCDOS 7.1 IBMBIO.COM
 14575                                  		;cmp	cx, [es:di+49h]	; [es:di+BDS.tim_hi]
 14576                                  		;jz	short done_set
 14577                                  		; 12/12/2022
 14578 00000DCE 740E                    		je	short done_set2
 14579                                  setaccess:
 14580 00000DD0 C606[1D01]00            		mov	byte [accesscount], 0
 14581                                  		
 14582                                  		; 24/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 14583 00000DD5 26895579                		mov	[es:di+79h], dx
 14584 00000DD9 26894D7B                		mov	[es:di+7Bh], cx
 14585                                  		;mov	[es:di+47h], dx	; [es:di+BDS.tim_lo]
 14586                                  		;mov	[es:di+49h], cx	; [es:di+BDS.tim_hi]
 14587                                  done_set:
 14588 00000DDD F8                      		clc
 14589                                  done_set2:		; 12/12/2022
 14590 00000DDE 58                      		pop	ax
 14591 00000DDF C3                      		retn
 14592                                  
 14593                                  ; =============== S U B	R O U T	I N E =======================================
 14594                                  
 14595                                  ; this routine is called if an error occurs while formatting or verifying.
 14596                                  ; it resets the drive,and decrements the retry count.
 14597                                  ; on entry - ds:di - points to bds for the drive
 14598                                  ;	     bp    - contains retry count
 14599                                  ; on exit    flags indicate result of decrementing retry count
 14600                                  
 14601                                  again:
 14602 00000DE0 E85705                  		call	ResetDisk
 14603 00000DE3 80FC06                  		cmp	ah, 6
 14604 00000DE6 7402                    		jz	short dont_dec_retry_count ; If	it is a	media change error
 14605                                  					; do not decrement retry count.
 14606 00000DE8 4D                      		dec	bp		; decrement retry count
 14607 00000DE9 C3                      		retn
 14608                                  ; ---------------------------------------------------------------------------
 14609                                  
 14610                                  dont_dec_retry_count:
 14611 00000DEA 08E4                    		or	ah, ah
 14612 00000DEC C3                      		retn
 14613                                  
 14614                                  ;----------------------------------------------------------------------------
 14615                                  ; Retro DOS v5.0 - PCDOS 7.1 IBMBIO.COM - BIOSCODE:0E30h
 14616                                  ;----------------------------------------------------------------------------
 14617                                  ; 24/12/2023 - Retro DOS v5.0
 14618                                  ;;;;
 14619                                  
 14620 00000DED 00                      ioctl_drvnum:	db 0
 14621                                  
 14622                                  		; 24/12/2023
 14623                                  
 14624                                  ; =============== S U B R O U T I N E =======================================
 14625                                  
 14626                                  get_phy_drv_num:
 14627 00000DEE E8B3F7                  		call	SetDrive	; get physical drive number
 14628                                  					; INPUT: al = logical drive number (BDS.drivelet)
 14629                                  					; OUTPUT: physical drive number (BDS.drivenum)
 14630 00000DF1 268A5504                		mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 14631 00000DF5 C3                      		retn
 14632                                  
 14633                                  ; =============== S U B R O U T I N E =======================================
 14634                                  
 14635                                  		; 24/12/2023
 14636                                  ioctl_output:
 14637 00000DF6 E8F5FF                  		call	get_phy_drv_num
 14638 00000DF9 2E8816[ED0D]            		mov	[cs:ioctl_drvnum], dl
 14639 00000DFE B441                    		mov	ah, 41h
 14640 00000E00 BBAA55                  		mov	bx, 55AAh
 14641 00000E03 CD13                    		int	13h		; DISK - Check for INT 13h Extensions
 14642                                  					; BX = 55AAh, DL = drive number
 14643                                  					; Return: CF set if not supported
 14644                                  					; AH = extensions version
 14645                                  					; BX = AA55h
 14646                                  					; CX = Interface support bit map
 14647 00000E05 7235                    		jc	short int13h_exts_err
 14648                                  ioctl_input_1:
 14649 00000E07 C43E[1200]              		les	di, [ptrsav]
 14650 00000E0B 26C47D0E                		les	di, [es:di+14]	; [es:di+IOCTL_REQ.MINORFUNCTION]
 14651 00000E0F 723E                    		jc	short ioctl_input_2
 14652 00000E11 B80046                  		mov	ax, 4600h	; Eject removable media
 14653 00000E14 263805                  		cmp	[es:di], al	; al = 0 ; disk ioctl function = 0
 14654 00000E17 7417                    		je	short ioctl_output_1
 14655 00000E19 26803D01                		cmp	byte [es:di], 1 ; al = 1 ; disk ioctl function = 1
 14656 00000E1D 751B                    		jne	short ioctl_output_2
 14657 00000E1F B80145                  		mov	ax, 4501h	; Lock/unlock media
 14658                                  					; (al, 0 = lock, 1 = unlock)
 14659 00000E22 26807D0100              		cmp	byte [es:di+1], 0 ; unlock (reverse of INT 13h ah=45h)
 14660 00000E27 7407                    		jz	short ioctl_output_1
 14661 00000E29 26384501                		cmp	[es:di+1], al	; lock (reverse of INT 13h ah=45h)
 14662 00000E2D 750B                    		jne	short ioctl_output_2
 14663 00000E2F 48                      		dec	ax
 14664                                  ioctl_output_1:
 14665 00000E30 2E8A16[ED0D]            		mov	dl, [cs:ioctl_drvnum]
 14666 00000E35 CD13                    		int	13h		; DISK - IBM/MS Extension - LOCK/UNLOCK DRIVE (DL - drive, [SI - disk address packet)
 14667 00000E37 7203                    		jc	short int13h_exts_err
 14668                                  ioctl_lock_err:
 14669                                  		; cf=0
 14670                                  ioctl_output_ret:
 14671                                  		;clc
 14672 00000E39 C3                      		retn
 14673                                  ; ---------------------------------------------------------------------------
 14674                                  
 14675                                  ioctl_output_2:
 14676 00000E3A B401                    		mov	ah, 1
 14677                                  int13h_exts_err:
 14678 00000E3C 80FCB0                  		cmp	ah, 0B0h	; volume not locked in drive
 14679 00000E3F 74F8                    		je	short ioctl_lock_err
 14680 00000E41 80FCB4                  		cmp	ah, 0B4h	; lock count exceeded
 14681 00000E44 74F3                    		je	short ioctl_lock_err
 14682 00000E46 E9DBF7                  		jmp	err_exitj
 14683                                  
 14684                                  ; =============== S U B R O U T I N E =======================================
 14685                                  
 14686                                  		; 24/12/2023
 14687                                  ioctl_input:
 14688 00000E49 E8A2FF                  		call	get_phy_drv_num
 14689 00000E4C F9                      		stc
 14690 00000E4D EBB8                    		jmp	short ioctl_input_1
 14691                                  ioctl_input_2:
 14692 00000E4F 26803D06                		cmp	byte [es:di], 6	; disk ioctl function = 6
 14693 00000E53 75E5                    		jne	short ioctl_output_2
 14694 00000E55 B80245                  		mov	ax, 4502h	; get lock status
 14695 00000E58 CD13                    		int	13h		; DISK - IBM/MS Extension - LOCK/UNLOCK DRIVE (DL - drive, [SI - disk address packet)
 14696 00000E5A 72E0                    		jc	short int13h_exts_err
 14697 00000E5C BB0C00                  		mov	bx, 0Ch		; bit 1 lock bit
 14698 00000E5F 3C00                    		cmp	al, 0		; not locked
 14699 00000E61 7402                    		jz	short ioctl_input_3
 14700 00000E63 B30E                    		mov	bl, 0Eh
 14701                                  ioctl_input_3:
 14702 00000E65 53                      		push	bx
 14703 00000E66 B404                    		mov	ah, 4
 14704 00000E68 B90101                  		mov	cx, 101h
 14705 00000E6B B601                    		mov	dh, 1
 14706 00000E6D CD13                    		int	13h		; DISK - VERIFY SECTORS
 14707                                  					; AL = number of sectors to verify, CH = track, CL = sector
 14708                                  					; DH = head, DL = drive
 14709                                  					; Return: CF set on error, AH = status
 14710                                  					; AL = number of sectors verified
 14711 00000E6F 5B                      		pop	bx
 14712 00000E70 80FC31                  		cmp	ah, 31h		; no media in drive (IBM/MS INT 13 extensions)
 14713 00000E73 740B                    		je	short ioctl_input_5
 14714 00000E75 80FC80                  		cmp	ah, 80h		; timeout (not ready)
 14715 00000E78 7406                    		je	short ioctl_input_5
 14716                                  ioctl_input_4:
 14717 00000E7A 26895D01                		mov	[es:di+1], bx
 14718 00000E7E EBB9                    		jmp	short ioctl_lock_err
 14719                                  ioctl_input_5:
 14720 00000E80 81CB0108                		or	bx, 801h	; bit 0 error bit (1 = error, 31h or 80h)
 14721                                  					; bit 11 (not ready -removable media error- bit)
 14722                                  					; if bit 11 = 0, another error (except 31h and 80h)
 14723 00000E84 EBF4                    		jmp	short ioctl_input_4
 14724                                  
 14725                                  ; ---------------------------------------------------------------------------
 14726                                  ;;;;
 14727                                  
 14728                                  ; 16/10/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS)
 14729                                  
 14730                                  ;----------------------------------------------------------------------------
 14731                                  ; MSDIOCTL.ASM - MSDOS 6.0 - 1991
 14732                                  ;----------------------------------------------------------------------------
 14733                                  ; 11/03/2019 - Retro DOS v4.0
 14734                                  
 14735                                  ; 18/03/2019
 14736                                  
 14737                                  ; ==========================================================================
 14738                                  ;
 14739                                  ; NOTE: GetAccessFlag/SetAccessFlag is unpublished function.
 14740                                  ;
 14741                                  ;      This function is intended to give the user to control the
 14742                                  ;      bds table flags of unformatted_media bit.
 14743                                  ;      GetAccessFlag will show the status -
 14744                                  ;	 a_DiskAccess_Control.dac_access_flag = 0 disk i/o not allowed
 14745                                  ;						1 disk i/o allowed
 14746                                  ;      SetAccessFlag will set/reset the unformatted_media bit in flags -
 14747                                  ;	 a_DiskAccess_Control.dac_access_flag = 0 allow disk i/o
 14748                                  ;						1 disallow disk i/o
 14749                                  ; ==========================================================================
 14750                                  
 14751                                  		; generic ioctl dispatch tables
 14752                                  
 14753                                  ; BIOSCODE:0C3Ch (MSDOS 6.21, IO.SYS)
 14754                                  
 14755                                  ; 24/12/2023
 14756                                  ; BIOSCODE:0ECAh (PCDOS 7.1, IBMBIO.COM)
 14757                                  
 14758                                  ; ---------------------------------------------------------------------------
 14759                                  		; 24/12/2023
 14760                                  		;db 0
 14761                                  ; 09/12/2022 
 14762                                  %if 0
 14763                                  
 14764                                  IoReadJumpTable: db 8	; ((IoWriteJumpTable-IoReadJumpTable)-1)/2
 14765                                  		dw 0CA7h	; 60h	; GetDeviceParameters
 14766                                  		dw 0EE8h	; 61h	;gh ReadTrack
 14767                                  		dw 0E86h	; 62h	; VerifyTrack
 14768                                  		dw 0CA3h	 	; Cmd_Error_Proc
 14769                                  		dw 0CA3h		; Cmd_Error_Proc
 14770                                  		dw 0CA3h		; Cmd_Error_Proc
 14771                                  		dw 119Ah	; 66h	; GetMediaId
 14772                                  		dw 1269h	; 67h	; GetAccessFlag ; unpublished function
 14773                                  		dw 12C1h	; 68h	; SenseMediaType
 14774                                  
 14775                                  IoWriteJumpTable: db 7	; ((IOC_DC_Table-IoWriteJumpTable)-1)/2
 14776                                  		dw 0CF3h	; 40h	; SetDeviceParameters
 14777                                  		dw 0EEFh	; 41h	; WriteTrack
 14778                                  		dw 0DC1h	; 42h	; FormatTrack
 14779                                  		dw 0CA3h		; Cmd_Error_Proc
 14780                                  		dw 0CA3h		; Cmd_Error_Proc
 14781                                  		dw 0CA3h		; Cmd_Error_Proc
 14782                                  		dw 11D2h	; 46h	; SetMediaId
 14783                                  		dw 1280h	; 47h	; SetAccessFlag ; unpublished function
 14784                                  
 14785                                  %endif
 14786                                  		; 24/12/2023 - Retro DOS v5.0
 14787                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:0ECAh)
 14788                                  
 14789                                  		; 09/12/2022
 14790                                  IoReadJumpTable:
 14791 00000E86 10                      		db ((IoWriteJumpTable-IoReadJumpTable)-1)/2 ; 15
 14792 00000E87 [190F]                  		dw GetDeviceParameters	; 60h
 14793 00000E89 [9211]                  		dw ReadTrack		; 61h
 14794 00000E8B [3211]                  		dw VerifyTrack		; 62h
 14795 00000E8D [150F]                  		dw Cmd_Error_Proc
 14796 00000E8F [150F]                  		dw Cmd_Error_Proc
 14797 00000E91 [150F]                  		dw Cmd_Error_Proc
 14798 00000E93 [1114]                  		dw GetMediaId		; 66h
 14799 00000E95 [EE14]                  		dw GetAccessFlag	; 67h ; unpublished function
 14800 00000E97 [4815]                  		dw SenseMediaType	; 68h
 14801                                  		; 24/12/2023
 14802                                  		; Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 14803 00000E99 [150F]                  		dw Cmd_Error_Proc	; 69h
 14804 00000E9B [150F]                  		dw Cmd_Error_Proc	; 6Ah
 14805 00000E9D [150F]                  		dw Cmd_Error_Proc
 14806 00000E9F [150F]                  		dw Cmd_Error_Proc
 14807 00000EA1 [150F]                  		dw Cmd_Error_Proc
 14808 00000EA3 [150F]                  		dw Cmd_Error_Proc	; 6Eh
 14809 00000EA5 [CC15]                  		dw GetDrvMapInfo	; 6Fh
 14810                                  
 14811                                  IoWriteJumpTable:
 14812 00000EA7 0A                      		db ((IOC_DC_Table-IoWriteJumpTable)-1)/2 ; 9
 14813 00000EA8 [790F]                  		dw SetDeviceParameters	; 40h
 14814 00000EAA [9911]                  		dw WriteTrack		; 41h
 14815 00000EAC [6C10]                  		dw FormatTrack		; 42h
 14816 00000EAE [150F]                  		dw Cmd_Error_Proc
 14817 00000EB0 [150F]                  		dw Cmd_Error_Proc
 14818 00000EB2 [150F]                  		dw Cmd_Error_Proc
 14819 00000EB4 [5114]                  		dw SetMediaId		; 46h
 14820 00000EB6 [0315]                  		dw SetAccessFlag	; 47h ; unpublished function
 14821                                  		; 24/12/2023
 14822                                  		; Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 14823 00000EB8 [8515]                  		dw SetLockState		; 48h
 14824 00000EBA [9C15]                  		dw EjectMedia		; 49h	
 14825                                  		
 14826                                  ; ==========================================================================
 14827                                  ; IOC_DC_Table
 14828                                  ;
 14829                                  ; This table contains all of the valid generic IOCtl Minor codes for
 14830                                  ; major function 08 to be used by the Ioctl_Support_Query function.
 14831                                  ; Added for 5.00
 14832                                  ; ==========================================================================
 14833                                  
 14834                                  		; 24/12/2023 - Retro DOS v5.0
 14835                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:0F00h)
 14836                                  
 14837 00000EBC 60                      IOC_DC_Table:	db 60h			; GET_DEVICE_PARAMETERS
 14838 00000EBD 40                      		db 40h			; SET_DEVICE_PARAMETERS
 14839 00000EBE 61                      		db 61h			; READ_TRACK
 14840 00000EBF 41                      		db 41h			; WRITE_TRACK
 14841 00000EC0 62                      		db 62h			; VERIFY_TRACK
 14842 00000EC1 42                      		db 42h			; FORMAT_TRACK
 14843 00000EC2 66                      		db 66h			; GET_MEDIA_ID
 14844 00000EC3 46                      		db 46h			; SET_MEDIA_ID
 14845 00000EC4 67                      		db 67h			; GET_ACCESS_FLAG
 14846 00000EC5 47                      		db 47h			; SET_ACCESS_FLAG
 14847 00000EC6 68                      		db 68h			; SENSE_MEDIA_TYPE
 14848                                  		; 24/12/2023
 14849                                  		; Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 14850 00000EC7 48                      		db 48h			; SET_LOCK_STATE
 14851 00000EC8 49                      		db 49h			; EJECT_MEDIA
 14852 00000EC9 6F                      		db 6Fh			; GET_DRV_MAP_INFO
 14853                                  
 14854                                  ;IOC_DC_TABLE_LEN EQU $ - IOC_DC_Table
 14855                                  
 14856                                  		; 24/12/2023 - Retro DOS v5.0
 14857                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:0F0Eh)
 14858                                  
 14859 00000ECA 00                      new_genioctl:	db 0
 14860                                  
 14861                                  ; ---------------------------------------------------------------------------
 14862                                  
 14863                                  ; 16/10/2022
 14864                                  
 14865                                  ; ==========================================================================
 14866                                  ; Do_Generic_IOCtl: perform generic ioctl request
 14867                                  ;
 14868                                  ;    input: AL contains logical drive
 14869                                  ;
 14870                                  ;	functions are dispatched through a call. On return, carry indicates
 14871                                  ;	error code in al. Note::bES:b& ds undefined on return from
 14872                                  ;	subfunctions.
 14873                                  ;
 14874                                  ; ==========================================================================
 14875                                  
 14876                                  ; 11/03/2019
 14877                                  		; 24/12/2023 - Retro DOS v5.0
 14878                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:0F0Fh)
 14879                                  
 14880                                  		; 19/10/2022
 14881                                  do_generic_ioctl:			; 2C7h:0C6Bh = 70h:31DBh
 14882 00000ECB E8D6F6                  		call	SetDrive	; ES:DI	Points to bds for drive
 14883                                  		
 14884                                  		; 24/12/2023
 14885                                  		;;;
 14886 00000ECE 2EC606[CA0E]00          		mov	byte [cs:new_genioctl], 0
 14887                                  					; 0, old generic ioctl function
 14888 00000ED4 06                      		push	es
 14889 00000ED5 C41E[1200]              		les	bx, [ptrsav]	; ES:BX	Points to request header
 14890 00000ED9 26807F0D08              		cmp	byte [es:bx+0Dh], 8 ; [es:bx+IOCTL_REQ.MAJORFUNCTION]
 14891                                  					; RAWIO
 14892                                  		; 24/12/2023
 14893                                  		;mov	al, [es:bx+0Eh]	; [es:bx+IOCTL_REQ.MINORFUNCTION]
 14894                                  		;pop	es
 14895                                  		;jnz	short IoctlFuncErr
 14896 00000EDE 740A                    		jz	short chk_genioctl_minor
 14897 00000EE0 2EFE06[CA0E]            		inc	byte [cs:new_genioctl]
 14898                                  					; 1, new generic ioctl function (FAT32)
 14899 00000EE5 26807F0D48              		cmp	byte [es:bx+0Dh], 48h ; Generic IOCtl Request support
 14900                                  				; (called only if bit 6 of attribute is set to 1)
 14901                                  chk_genioctl_minor:
 14902 00000EEA 268A470E                		mov	al, [es:bx+0Eh]	; [es:bx+IOCTL_REQ.MINORFUNCTION]
 14903 00000EEE 07                      		pop	es
 14904 00000EEF 7525                    		jnz	short IoctlFuncErr
 14905                                  		;;;
 14906                                  
 14907                                  		; cas note: Could do the above two blocks in reverse order.
 14908                                  		; Would have to preserve al for SetDrive
 14909                                  
 14910                                  		; 10/12/2022
 14911 00000EF1 BE[860E]                		mov	si, IoReadJumpTable
 14912                                  		;mov	si, 0C3Ch	; IoReadJumpTable
 14913                                  					; at 2C7h:0C3Ch	= 70h:31ACh
 14914 00000EF4 A820                    		test	al, 20h		; GEN_IOCTL_FN_TST ; test of req. function
 14915 00000EF6 7503                    		jnz	short NotGenericWrite ; function is a read.
 14916                                  		; 10/12/2022
 14917 00000EF8 BE[A70E]                		mov	si, IoWriteJumpTable
 14918                                  		;mov	si, 0C4Fh	; IoWriteJumpTable
 14919                                  					; at 2C7h:0C4Fh	= 70h:31BFh
 14920                                  NotGenericWrite:
 14921 00000EFB 24DF                    		and	al, 0DFh	; ~GEN_IOCTL_FN_TST ; get rid of read/write bit
 14922 00000EFD 2C40                    		sub	al, 40h		; offset for base function
 14923 00000EFF 2E3A04                  		cmp	al, [cs:si]
 14924 00000F02 7712                    		ja	short IoctlFuncErr
 14925 00000F04 98                      		cbw
 14926                                  		; 24/12/2023
 14927                                  		;shl	ax, 1
 14928 00000F05 01C0                    		add	ax, ax
 14929 00000F07 46                      		inc	si
 14930 00000F08 01C6                    		add	si, ax
 14931 00000F0A 2EFF14                  		call	near [cs:si]
 14932                                  		;call	word ptr cs:[si]
 14933 00000F0D 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 14934                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 14935                                  					; 2C7h:30h = 70h:25A0h
 14936 00000F12 B481                    		mov	ah, 81h		; Return this status in	case of	carry
 14937 00000F14 C3                      		retn			; Pass carry flag through to exit code
 14938                                  ; ---------------------------------------------------------------------------
 14939                                  
 14940                                  		; Cmd_Error_Proc is called as a procedure and also use
 14941                                  		; as a fall through from above
 14942                                  Cmd_Error_Proc:				; 2C7h:0CA3h = 70h:3213h
 14943 00000F15 5A                      		pop	dx
 14944                                  IoctlFuncErr:
 14945 00000F16 E9BCF1                  		jmp	bc_cmderr
 14946                                  ; ---------------------------------------------------------------------------
 14947                                  
 14948                                  ; 16/10/2022
 14949                                  
 14950                                  ; ==========================================================================
 14951                                  ;**	GetDeviceParameters:
 14952                                  ;
 14953                                  ;	GetDeviceParameters implements the generic ioctl function:
 14954                                  ;	majorcode=RAWIO, minorcode=GetDeviceParameters (60h)
 14955                                  ;
 14956                                  ;	ENTRY	(ES:di) = BDS for drive
 14957                                  ;		PtrSav = long pointer to request header
 14958                                  ;	EXIT	??? BUGBUG
 14959                                  ;	USES	??? BUGBUG
 14960                                  ; ==========================================================================
 14961                                  
 14962                                  		; 24/12/2023 - Retro DOS v5.0
 14963                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:0F5Dh)
 14964                                  
 14965                                  		; 19/10/2022
 14966                                  GetDeviceParameters:
 14967                                  		; Copy info from bds to the device parameters packet
 14968                                  
 14969 00000F19 C51E[1200]              		lds	bx, [ptrsav]	; DS:BX	points to request header
 14970 00000F1D C55F13                  		lds	bx, [bx+19]	; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 14971                                  					; (DS:BX) = return buffer
 14972                                  		; 24/12/2023
 14973 00000F20 268A453E                		mov	al, [es:di+3Eh]
 14974                                  		;mov	al, [es:di+34]	; [es:di+BDS.formfactor]
 14975 00000F24 884701                  		mov	[bx+1],	al	; [bx+A_DEVICEPARAMETERS.DP_DEVICETYPE]
 14976                                  		; 24/12/2023
 14977 00000F27 268B453F                		mov	ax, [es:di+3Fh]
 14978                                  		;mov	ax, [es:di+35]	; [es:di+BDS.flags]
 14979 00000F2B 83E003                  		and	ax, 3		; fnon_removable+fchangeline
 14980                                  					; Mask off other bits
 14981 00000F2E 894702                  		mov	[bx+2],	ax	; [bx+A_DEVICEPARAMETERS.DP_DEVICEATTRIBUTES]
 14982                                  		; 24/12/2023
 14983 00000F31 268B4541                		mov     ax, [es:di+41h]
 14984                                  		;mov	ax, [es:di+37]	; [es:di+BDS.cylinders]
 14985 00000F35 894704                  		mov	[bx+4],	ax	; [bx+A_DEVICEPARAMETERS.DP_CYLINDERS]
 14986 00000F38 30C0                    		xor	al, al		; Set media type to default
 14987 00000F3A 884706                  		mov	[bx+6],	al	; [bx+A_DEVICEPARAMETERS.DP_MEDIATYPE]
 14988                                  					
 14989                                  		; copy recommended bpb
 14990                                  
 14991                                  		; 24/12/2023
 14992 00000F3D 8D7543                  		lea     si, [di+43h]
 14993                                  		;lea	si, [di+39]	; [di+BDS.rbytespersec]	= [di+BDS.R_BPB]
 14994 00000F40 F60701                  		test	byte [bx], 1	; [bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS]
 14995                                  					; BUILD_DEVICE_BPB
 14996 00000F43 7412                    		jz	short UseBpbPresent
 14997 00000F45 1E                      		push	ds		; Save request packet segment
 14998 00000F46 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 14999                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 15000                                  					; 2C7h:30h = 70h:25A0h
 15001                                  					; Point back to Bios_Data
 15002 00000F4B E829FA                  		call	checksingle
 15003 00000F4E E885F7                  		call	GetBp		; Build	the bpb	from scratch
 15004 00000F51 1F                      		pop	ds		; Restore request packet segment
 15005 00000F52 7224                    		jb	short GetParmRet
 15006 00000F54 8D7506                  		lea	si, [di+6]	; [di+BDS.bytespersec] = [di+BSD.DP_BPB]
 15007                                  					; Use this subfield of bds instead
 15008                                  UseBpbPresent:				
 15009 00000F57 8D7F07                  		lea	di, [bx+7]	; [bx+A_DEVICEPARAMETERS.DP_BPB]
 15010                                  					; This is where	the result goes
 15011                                  		; 24/12/2023
 15012 00000F5A 31D2                    		xor	dx, dx ; 0
 15013                                  		
 15014                                  		; 24/12/2023
 15015 00000F5C B91F00                  		mov	cx, 31		; A_BPB.size = 31
 15016                                  		;mov	cx, 25		; A_BPB.size - 6
 15017                                  					; For now use 'small' bpb
 15018                                  		; 24/12/2023
 15019                                  		;;;
 15020 00000F5F 2E3816[CA0E]            		cmp	[cs:new_genioctl], dl ; 0 ? ; *
 15021 00000F64 7404                    		jz	short gdp_1	; old type (FAT12 & FAT16) structure
 15022                                  		;mov	cx, 53		; FAT32 BPB size
 15023                                  		;mov	dx, 32		; 53+32 = 85 bytes (A_BPB_FAT32.size)
 15024 00000F66 B135                    		mov	cl, 53
 15025 00000F68 B220                    		mov	dl, 32
 15026                                  gdp_1:
 15027                                  		;;;
 15028 00000F6A 1E                      		push	ds		; reverse segments for copy
 15029 00000F6B 06                      		push	es
 15030 00000F6C 1F                      		pop	ds
 15031 00000F6D 07                      		pop	es
 15032 00000F6E F3A4                    		rep movsb
 15033                                  
 15034                                  		; 24/12/2023
 15035                                  		;;;
 15036 00000F70 89D1                    		mov	cx, dx		; 0 or 32
 15037 00000F72 E304                    		jcxz	gdp_2
 15038 00000F74 30C0                    		xor	al, al		; 32 zeros
 15039 00000F76 F3AA                    		rep stosb
 15040                                  gdp_2:
 15041                                  		;clc	; cf is already 0 ; * ; 24/12/2023
 15042                                  		;;;		
 15043                                  		
 15044                                  		; 12/12/2022
 15045                                  		; cf=0 (test instruction -above- resets cf) 	
 15046                                  		;clc
 15047                                  GetParmRet:				
 15048 00000F78 C3                      		retn
 15049                                  ; ---------------------------------------------------------------------------
 15050                                  
 15051                                  ; 17/10/2022
 15052                                  ; 16/10/2022
 15053                                  
 15054                                  ; ==========================================================================
 15055                                  ; SetDeviceParameters:
 15056                                  ;
 15057                                  ; input: ES:di points to bds for drive
 15058                                  ; ==========================================================================
 15059                                  
 15060                                  		; 24/12/2023 - Retro DOS v5.0
 15061                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:0FC0h)
 15062                                  
 15063                                  		; 19/10/2022
 15064                                  SetDeviceParameters:			; 2C7h:0CF3h = 70h:3263h
 15065 00000F79 C51E[1200]              		lds	bx, [ptrsav]	; DS:BX	points to request header
 15066 00000F7D C55F13                  		lds	bx, [bx+19]	; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 15067                                  		; 24/12/2023
 15068 00000F80 26814D3F4001            		or	word [es:di+3Fh], 140h
 15069                                  		;or	word [es:di+23h], 140h ; [es:di+BDS.flags]
 15070                                  					; fchanged_by_format|fchanged
 15071 00000F86 F60702                  		test	byte [bx], 2	; [bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS]
 15072                                  					; ONLY_SET_TRACKLAYOUT
 15073                                  		;jnz	short setTrackTable
 15074                                  		; 24/12/2023
 15075 00000F89 7403                    		jz	short sdp_1
 15076 00000F8B E98000                  		jmp	setTrackTable
 15077                                  sdp_1:	
 15078 00000F8E 8A4701                  		mov	al, [bx+1]	; [bx+A_DEVICEPARAMETERS.DP_DEVICETYPE]
 15079                                  		; 24/12/2023
 15080 00000F91 2688453E                		mov	[es:di+3Eh], al
 15081                                  		;mov	[es:di+34], al	; [es:di+BDS.formfactor]
 15082 00000F95 8B4704                  		mov	ax, [bx+4]	; [bx+A_DEVICEPARAMETERS.DP_CYLINDERS]
 15083                                  		; 24/12/2023
 15084 00000F98 26894541                		mov	[es:di+41h], ax
 15085                                  		;mov	[es:di+37], ax	; [es:di+BDS.cylinders]
 15086 00000F9C 8B4702                  		mov	ax, [bx+2]	; [bx+A_DEVICEPARAMETERS.DP_DEVICEATTRIBUTES]
 15087 00000F9F 1E                      		push	ds
 15088                                  		; 17/10/2022
 15089 00000FA0 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 15090                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 15091                                  					; 2C7h:30h = 70h:25A0h
 15092                                  		;cmp	byte [fhave96], 0
 15093 00000FA5 803E[7700]00            		cmp	byte [fhave96], 0
 15094 00000FAA 1F                      		pop	ds
 15095 00000FAB 7502                    		jnz	short HaveChange ; we have changeline support
 15096                                  		; 10/12/2022
 15097 00000FAD 24FD                    		and	al, 0FDh
 15098                                  		;and	ax, 0FFFDh	; ~fchangeline
 15099                                  
 15100                                  		; Ignore all bits except non_removable and changeline
 15101                                  HaveChange:
 15102 00000FAF 83E003                  		and	ax, 3		; fnon_removable|fchangeline
 15103                                  		; 24/12/2023
 15104 00000FB2 268B4D3F                		mov	cx, [es:di+3Fh]
 15105                                  		;mov	cx, [es:di+35]	; [es:di+BDS.flags]
 15106 00000FB6 81E1F4FD                		and	cx, 0FDF4h	; ~(fnon_removable|fchangeline|good_tracklayout|unformatted_media)
 15107 00000FBA 09C8                    		or	ax, cx
 15108                                  		; 24/12/2023
 15109 00000FBC 2689453F                		mov	[es:di+3Fh], ax
 15110                                  		;mov	[es:di+35], ax	; [es:di+BDS.flags]
 15111 00000FC0 8A4706                  		mov	al, [bx+6]	; [bx+A_DEVICEPARAMETERS.DP_MEDIATYPE]
 15112                                  					; Set media type
 15113 00000FC3 1E                      		push	ds
 15114 00000FC4 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 15115                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 15116 00000FC9 A2[A805]                		mov	[mediatype], al
 15117                                  		;mov	ds:mediatype, al
 15118                                  
 15119                                  		; 24/12/2023
 15120                                  		;;;
 15121 00000FCC B93500                  		mov	cx, 53		; FAT32 BPB size
 15122 00000FCF 2E803E[CA0E]00          		cmp	byte [cs:new_genioctl], 0
 15123 00000FD5 7502                    		jnz	short sdp_2	; new type (FAT32) structure
 15124                                  		;mov	cx, 31		; A_BPB.size = 31
 15125 00000FD7 B11F                    		mov	cl, 31
 15126                                  sdp_2:
 15127                                  		;;;	
 15128 00000FD9 1F                      		pop	ds
 15129                                  
 15130                                  		; The media changed (maybe) so we will have to do a set dasd
 15131                                  		; the next time we format a track
 15132                                  
 15133                                  		; 24/12/2023
 15134 00000FDA 26804D3F80              		or	byte [es:di+3Fh], 80h
 15135                                  		; 10/12/2022
 15136                                  		;or	byte [es:di+35], 80h
 15137                                  		;;or	word [es:di+35], 80h ; [es:di+BDS.flags]
 15138                                  					; set_dasd_true
 15139 00000FDF 57                      		push	di		; Save bds pointer
 15140                                  
 15141                                  		; Figure out what we are supposed to do with the bpb
 15142                                  		; were we asked to install a fake bpb?
 15143                                  
 15144 00000FE0 F60701                  		test	byte [bx], 1	; [bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS]
 15145                                  					; INSTALL_FAKE_BPB
 15146 00000FE3 7511                    		jnz	short InstallFakeBpb
 15147                                  
 15148                                  		; were we returning a fake bpb when asked to build a bpb?
 15149                                  
 15150                                  		; 24/12/2023
 15151 00000FE5 26F6453F04              		test	byte [es:di+3Fh], 4
 15152                                  		; 10/12/2022
 15153                                  		;test	byte [es:di+35], 4
 15154                                  		;;test	word [es:di+35], 4 ; [es:di+BDS.flags]
 15155                                  					; return_fake_bpb
 15156 00000FEA 7405                    		jz	short InstallRecommendedBpb
 15157                                  
 15158                                  		; we were returning a fake bpb but we can stop now
 15159                                  
 15160                                  		; 24/12/2023
 15161 00000FEC 2680653FFB              		and	byte [es:di+3Fh], 0FBh
 15162                                  		; 10/12/2022
 15163                                  		;and	byte [es:di+35], 0FBh
 15164                                  		;;and	word [es:di+35], 0FFFBh ; [es:di+BDS.flags]
 15165                                  					; ~return_fake_bpb
 15166                                  InstallRecommendedBpb:
 15167                                  		; 24/12/2023
 15168                                  		;mov	cx, 31		; A_BPB.size
 15169                                  		;lea	di, [di+27h]	; [di+BDS.R_BPB] = [di+BDS.rbytespersec]
 15170                                  		; cx = 53 or 31
 15171 00000FF1 8D7D43                  		lea	di, [di+43h]	; (PCDOS 7.1 IBMBIO.COM)
 15172 00000FF4 EB08                    		jmp	short CopyTheBpb
 15173                                  ; ---------------------------------------------------------------------------
 15174                                  
 15175                                  InstallFakeBpb:
 15176                                  		; 24/12/2023
 15177 00000FF6 26804D3F04              		or	byte [es:di+3Fh], 4
 15178                                  		; 10/12/2022
 15179                                  		;or	byte [es:di+35], 4
 15180                                  		;;or	word [es:di+35], 4 ; byte [es:di+BDS.flags]
 15181                                  					; return_fake_bpb
 15182                                  		; 24/12/2023
 15183                                  		; cx = 53 or 31
 15184                                  		;mov	cx, 25		; A_BPB.size - 6
 15185                                  					; move 'smaller' bpb
 15186 00000FFB 8D7D06                  		lea	di, [di+6]	; [es:di+BDS.BPB] = [es:di+BDS.bytespersec]
 15187                                  CopyTheBpb:				
 15188 00000FFE 8D7707                  		lea	si, [bx+7]	; [bx+A_DEVICEPARAMETERS.DP_BPB]
 15189 00001001 F3A4                    		rep movsb
 15190 00001003 1E                      		push	ds		; Save packet segment
 15191                                  		; 17/10/2022
 15192 00001004 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 15193                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 15194                                  					; Setup	for ds -> Bios_Data
 15195 00001009 E8DD03                  		call	RestoreOldDpt	; Restore the old Dpt from TempDpt
 15196 0000100C 1F                      		pop	ds		; Restore packet segment
 15197 0000100D 5F                      		pop	di		; Restore bds pointer
 15198                                  setTrackTable:	
 15199                                  		; 24/12/2023
 15200                                  		;mov	cx, [bx+38]	; [bx+26h]
 15201                                  		;;;
 15202 0000100E 8B4F5C                  		mov	cx, [bx+5Ch]	; [bx+A_DEVICEPARAMETERS.DP_TRACKTABLEENTRIES]
 15203                                  					; offset 85+7 (A_BPB.size+7) (FAT32)
 15204 00001011 2E803E[CA0E]00          		cmp	byte [cs:new_genioctl], 0
 15205 00001017 7503                    		jnz	short sdp_3	; new type (FAT32) structure
 15206 00001019 8B4F26                  		mov	cx, [bx+26h]	; [bx+A_DEVICEPARAMETERS.DP_TRACKTABLEENTRIES]
 15207                                  					; offset 31+7 (A_BPB.size+7)
 15208                                  sdp_3:
 15209                                  		;;;
 15210                                  
 15211 0000101C 1E                      		push	ds
 15212 0000101D 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 15213 00001022 890E[AA04]              		mov	[sectorspertrack], cx
 15214 00001026 1F                      		pop	ds
 15215                                  		
 15216                                  		; 24/12/2023
 15217 00001027 2680653FF7              		and	byte [es:di+3Fh], 0F7h
 15218                                  		; 10/12/2022
 15219                                  		;and	byte [es:di+35], 0F7h
 15220                                  		;;and	word [es:di+35], 0FFF7h ; [es:di+BDS.flags]
 15221                                  					; ~good_tracklayout
 15222 0000102C F60704                  		test	byte [bx], 4	; [bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS]
 15223                                  					; TRACKLAYOUT_IS_GOOD
 15224 0000102F 7405                    		jz	short UglyTrackLayOut
 15225                                  		; 24/12/2023
 15226 00001031 26804D3F08              		or	byte [es:di+3Fh], 8
 15227                                  		; 10/12/2022
 15228                                  		;or	byte [es:di+35], 8
 15229                                  		;;or	word [es:di+35], 8 ; [es:di+BDS.flags]
 15230                                  					; good_tracklayout
 15231                                  UglyTrackLayOut:
 15232 00001036 83F93F                  		cmp	cx, 63		; MAX_SECTORS_IN_TRACK
 15233 00001039 772D                    		ja	short TooManyPerTrack
 15234                                  		;jcxz	short SectorInfoSaved
 15235 0000103B E329                    		jcxz	SectorInfoSaved	; 19/10/2022
 15236                                  		
 15237 0000103D BF[AC04]                		mov	di, tracktable
 15238                                  
 15239                                  		; 24/12/2023
 15240                                  		;lea	si, [bx+40]	; [bx+A_DEVICEPARAMETERS.DP_SECTORTABLE]
 15241                                  		;;;
 15242 00001040 8D775E                  		lea	si, [bx+5Eh]	; [bx+A_DEVICEPARAMETERS.DP_SECTORTABLE]
 15243                                  					; offset 85+9 (A_BPB.size+9) (FAT32)
 15244 00001043 2E803E[CA0E]00          		cmp	byte [cs:new_genioctl], 0
 15245 00001049 7503                    		jnz	short sdp_4	; new type (FAT32) structure
 15246 0000104B 8D7728                  		lea	si, [bx+28h]	; [bx+A_DEVICEPARAMETERS.DP_SECTORTABLE]
 15247                                  					; offset 31+9 (A_BPB.size+9)
 15248                                  sdp_4:
 15249                                  		;;;
 15250                                  
 15251                                  		; 17/10/2022
 15252 0000104E 2E8E06[3000]            		mov	es, [cs:BIOSDATAWORD]
 15253                                  		;mov	es, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 15254                                  					; Trash	our bds	pointer
 15255                                  StoreSectorInfo:
 15256 00001053 47                      		inc	di
 15257 00001054 47                      		inc	di		; Skip over cylinder and head
 15258 00001055 AD                      		lodsw			; Get sector id
 15259 00001056 AA                      		stosb			; Copy it
 15260 00001057 AD                      		lodsw			; Get sector size
 15261                                  		
 15262                                  		; 24/12/2023
 15263                                  		; 02/09/2023 (PCDOS 7.1)
 15264                                  		;call	SectSizeToSectIndex
 15265 00001058 80FC03                  		cmp	ah, 3 ; 02/09/2023
 15266                                  		;cmp	ah, 2		; (0=>128,1=>256,2=>512,3=>1024)
 15267                                  					; examine upper	byte only
 15268 0000105B 7704                    		ja	short OneK
 15269 0000105D 88E0                    		mov	al, ah		; value	in AH is the index!
 15270 0000105F EB02                    		jmp	short sdp_s
 15271                                  OneK:
 15272 00001061 B003                    		mov	al, 3		; 1024 bytes per sector
 15273                                  sdp_s:
 15274 00001063 AA                      		stosb			; Store	sector SIZE index
 15275 00001064 E2ED                    		loop	StoreSectorInfo
 15276                                  SectorInfoSaved:
 15277 00001066 F8                      		clc
 15278 00001067 C3                      		retn
 15279                                  ; ---------------------------------------------------------------------------
 15280                                  
 15281                                  TooManyPerTrack:
 15282 00001068 B00C                    		mov	al, 0Ch
 15283 0000106A F9                      		stc
 15284 0000106B C3                      		retn
 15285                                  ; ---------------------------------------------------------------------------
 15286                                  
 15287                                  ; 16/10/2022
 15288                                  
 15289                                  ; ==========================================================================
 15290                                  ; FormatTrack:
 15291                                  ; if specialfunction byte is 1,then this is a status call to see if there is
 15292                                  ; rom support for the combination of sec/trk and # of cyln,and if the
 15293                                  ; combination is legal. if specialfunction byte is 0,then format the track.
 15294                                  ;
 15295                                  ; input: ES:di points to bds for drive
 15296                                  ;
 15297                                  ; output:
 15298                                  ;	for status call:
 15299                                  ;	specialfunction byte set to:
 15300                                  ;		0 - rom support + legal combination
 15301                                  ;		1 - no rom support
 15302                                  ;		2 - illegal combination
 15303                                  ;		3 - no media present
 15304                                  ;	carry cleared.
 15305                                  ;
 15306                                  ;	for format track:
 15307                                  ;		carry set if error
 15308                                  ;
 15309                                  ; ==========================================================================
 15310                                  
 15311                                  ; 16/03/2019
 15312                                  		; 24/12/2023 - Retro DOS 5.0
 15313                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:1B07h)
 15314                                  
 15315                                  		; 19/10/2022
 15316                                  FormatTrack:
 15317 0000106C C51E[1200]              		lds	bx, [ptrsav]
 15318 00001070 C55F13                  		lds	bx, [bx+19]	; [bx+IOCTL_REQ.GENERICIOCTL_PACKET
 15319 00001073 F60701                  		test	byte [bx], 1	; [bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS]
 15320                                  					; STATUS_FOR_FORMAT
 15321 00001076 740E                    		jz	short DoFormatTrack
 15322 00001078 1E                      		push	ds
 15323                                  		; 17/10/2022
 15324 00001079 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 15325                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 15326 0000107E E82502                  		call	SetMediaForFormat ; Also moves current Dpt to TempDpt
 15327 00001081 1F                      		pop	ds
 15328 00001082 8807                    		mov	[bx], al	; [bx+A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS]
 15329 00001084 F8                      		clc
 15330 00001085 C3                      		retn
 15331                                  ; ---------------------------------------------------------------------------
 15332                                  
 15333                                  DoFormatTrack:
 15334                                  		; 24/12/2023 - Retro DOS 5.0
 15335 00001086 26807D3E05              		cmp	byte [es:di+3Eh], 5				
 15336                                  		;cmp	byte [es:di+34], 5 ; [es:di+BDS.formfactor]
 15337                                  					; DEV_HARDDISK
 15338 0000108B 7508                    		jnz	short DoFormatDiskette
 15339                                  		; 17/10/2022
 15340 0000108D 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 15341                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 15342                                  					; Point	to Bios_Data (at 2C7h:30h or 70h:25A0h)
 15343 00001092 E99D00                  		jmp	VerifyTrack
 15344                                  ; ---------------------------------------------------------------------------
 15345                                  
 15346                                  DoFormatDiskette:
 15347 00001095 8B4F01                  		mov	cx, [bx+1]
 15348 00001098 8B5703                  		mov	dx, [bx+3]
 15349 0000109B F60702                  		test	byte [bx], 2
 15350                                  		; 17/10/2022
 15351 0000109E 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 15352                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 15353                                  					; Setup	ds-> Bios_Data for verify
 15354 000010A3 7403                    		jz	short DoFormatDiskette_1
 15355 000010A5 E9E500                  		jmp	VerifyTrack_Err
 15356                                  ; ---------------------------------------------------------------------------
 15357                                  
 15358                                  DoFormatDiskette_1:
 15359 000010A8 E8FB01                  		call	SetMediaForFormat ; Also moves current Dpt to TempDpt
 15360 000010AB 3C01                    		cmp	al, 1		;  ROM support for sec/trk,# trks comb?
 15361 000010AD 7406                    		jz	short NeedToSetDasd ; Old rom
 15362 000010AF 3C03                    		cmp	al, 3		; Time out error?
 15363 000010B1 7507                    		jnz	short NoSetDasd	; No,fine. (at this point, don't care
 15364                                  					; about	the illegal combination)
 15365 000010B3 EB68                    		jmp	short FormatFailed
 15366                                  ; ---------------------------------------------------------------------------
 15367                                  
 15368                                  NeedToSetDasd:
 15369 000010B5 52                      		push	dx
 15370 000010B6 E89001                  		call	SetDasd		; INT 13h, AH=17h
 15371 000010B9 5A                      		pop	dx
 15372                                  NoSetDasd:
 15373 000010BA E8BAF8                  		call	checksingle	; Do any needed	diskette swapping
 15374 000010BD 89D0                    		mov	ax, dx		; Get track from packet
 15375 000010BF A3[3901]                		mov	[trknum], ax
 15376 000010C2 880E[3801]              		mov	[hdnum], cl	; Store	head from packet
 15377 000010C6 88CC                    		mov	ah, cl
 15378 000010C8 BB[AC04]                		mov	bx, tracktable
 15379 000010CB 8B0E[AA04]              		mov	cx, [sectorspertrack]
 15380                                  		; 24/12/2023 - Retro DOS 5.0
 15381 000010CF E307                    		jcxz	set_fmt_retry_count
 15382                                  StoreCylinderHead:
 15383 000010D1 8907                    		mov	[bx], ax	; Store	into TrackTable
 15384 000010D3 83C304                  		add	bx, 4		; Skip to next sector field
 15385 000010D6 E2F9                    		loop	StoreCylinderHead
 15386                                  set_fmt_retry_count:	; 24/12/2023
 15387                                  		;mov	cx, 5		; MAXERR - Set up retry	count
 15388                                  		; 02/09/2023
 15389 000010D8 B105                    		mov	cl, 5
 15390                                  FormatRetry:
 15391 000010DA 51                      		push	cx
 15392 000010DB BB[AC04]                		mov	bx, tracktable
 15393 000010DE A0[AA04]                		mov	al, [sectorspertrack]
 15394 000010E1 B405                    		mov	ah, 5		; romformat
 15395 000010E3 8C1E[A804]              		mov	[xfer_seg], ds
 15396 000010E7 E86602                  		call	ToRom
 15397 000010EA 59                      		pop	cx
 15398 000010EB 7216                    		jb	short FormatError
 15399 000010ED 51                      		push	cx		; Now verify the sectors just formatted.
 15400                                  					; NOTE:	because	of bug in some BIOSes we have to
 15401                                  					;	set ES:BX to 00:00
 15402 000010EE 53                      		push	bx
 15403 000010EF 31DB                    		xor	bx, bx
 15404 000010F1 891E[A804]              		mov	[xfer_seg], bx
 15405 000010F5 A0[AA04]                		mov	al, [sectorspertrack]
 15406 000010F8 B404                    		mov	ah, 4		; romverify
 15407 000010FA B101                    		mov	cl, 1
 15408 000010FC E85102                  		call	ToRom
 15409 000010FF 5B                      		pop	bx
 15410 00001100 59                      		pop	cx
 15411 00001101 7329                    		jnb	short FormatOk
 15412                                  FormatError:
 15413 00001103 E83402                  		call	ResetDisk
 15414 00001106 C606[AA05]01            		mov	byte [had_format_error], 1
 15415 0000110B 50                      		push	ax
 15416 0000110C 51                      		push	cx
 15417 0000110D 52                      		push	dx
 15418 0000110E E89501                  		call	SetMediaForFormat
 15419 00001111 3C01                    		cmp	al, 1
 15420 00001113 7503                    		jnz	short WhileErr
 15421 00001115 E83101                  		call	SetDasd
 15422                                  WhileErr:
 15423 00001118 5A                      		pop	dx
 15424 00001119 59                      		pop	cx
 15425 0000111A 58                      		pop	ax
 15426 0000111B E2BD                    		loop	FormatRetry
 15427                                  FormatFailed:
 15428 0000111D C606[AA05]01            		mov	byte [had_format_error], 1
 15429                                  					; Set the format error flag
 15430 00001122 80FC06                  		cmp	ah, 6		; DSK_CHANGELINE_ERR - convert change line
 15431 00001125 7502                    		jnz	short DoMapIt	; Error	to time	out error
 15432 00001127 B480                    		mov	ah, 80h		; DSK_TIMEOUT_ERR
 15433                                  DoMapIt:
 15434 00001129 E97CFC                  		jmp	maperror
 15435                                  ; ---------------------------------------------------------------------------
 15436                                  
 15437                                  FormatOk:
 15438 0000112C C606[AA05]00            		mov	byte [had_format_error], 0 ; reset the format error flag
 15439 00001131 C3                      		retn
 15440                                  ; ---------------------------------------------------------------------------
 15441                                  
 15442                                  ; 16/10/2022
 15443                                  
 15444                                  ; ==========================================================================
 15445                                  ;
 15446                                  ; VerifyTrack:
 15447                                  ;
 15448                                  ; input: ES:di points to bds for drive
 15449                                  ; ==========================================================================
 15450                                  
 15451                                  		; 24/12/2023 - Retro DOS 5.0
 15452                                  VerifyTrack:
 15453 00001132 1E                      		push	ds
 15454 00001133 C51E[1200]              		lds	bx, [ptrsav]	; DS:BX points to request header.
 15455 00001137 C55F13                  		lds	bx, [bx+19]	; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 15456                                  
 15457                                  		; Come here with DS:[BX] -> packet, ES:[DI] -> bds
 15458                                  
 15459 0000113A 8B4F03                  		mov	cx, [bx+3]	; [bx+A_VERIFYPACKET.VP_CYLINDER]
 15460 0000113D 8B4701                  		mov	ax, [bx+1]	; [bx+A_VERIFYPACKET.VP_HEAD]
 15461 00001140 8B5705                  		mov	dx, [bx+5]	; [bx+A_FORMATPACKET.FP_TRACKCOUNT]
 15462 00001143 8A1F                    		mov	bl, [bx]	; [bx+A_FORMATPACKET.FP_SPECIALFUNCTIONS]
 15463                                  					; Get option flag word
 15464 00001145 1F                      		pop	ds
 15465 00001146 C606[2001]04            		mov	byte [rflag], 4	; romverify
 15466 0000114B 890E[3301]              		mov	[curtrk], cx
 15467 0000114F A2[3201]                		mov	[curhd], al	; ASSUME heads < 256
 15468 00001152 8B0E[AA04]              		mov	cx, [sectorspertrack]
 15469                                  
 15470                                  		; Check specialfunctions to see if DO_FAST_FORMAT has been
 15471                                  		; specified if not we should go to the normal track verification
 15472                                  		; routine. If fast format has been specified we should get the
 15473                                  		; number of tracks to be verified and check it to see if it is
 15474                                  		; > 255. If it is then it is an error and we should go to
 15475                                  		; VerifyTrack_Err. If not multiply the number of tracks by the
 15476                                  		; sectors per track to get the total number of sectors to be
 15477                                  		; verified. This should also be less than equal to 255
 15478                                  		; otherwise we go to same error exit. If everything is okay
 15479                                  		; we initalise cx to the total sectors. use ax as a temporary
 15480                                  		; register.
 15481                                  
 15482                                  					; Special function requested?	
 15483 00001156 F6C302                  		test	bl, 2		; DO_FAST_FORMAT
 15484 00001159 7421                    		jz	short NormVerifyTrack
 15485 0000115B 89D0                    		mov	ax, dx		; Get ax = number of trks to verify
 15486 0000115D 08E4                    		or	ah, ah
 15487 0000115F 752C                    		jnz	short VerifyTrack_Err ; #tracks > 255
 15488 00001161 F6E1                    		mul	cl
 15489 00001163 08E4                    		or	ah, ah
 15490 00001165 7526                    		jnz	short VerifyTrack_Err ; #sectors > 255	
 15491 00001167 89C1                    		mov	cx, ax
 15492                                  		; 24/12/2023
 15493 00001169 26F6453F01              		test	byte [es:di+3Fh], 1 ; PCDOS 7.1 IBMBIO.COM
 15494                                  		; 10/12/2022
 15495                                  		;test	byte [es:di+35], 1
 15496                                  		;;test	word [es:di+35], 1 ; [es:di+BDS.flags]
 15497                                  					; fnon_removable
 15498 0000116E 740C                    		jz	short NormVerifyTrack
 15499                                  					; Multitrack operation = on?
 15500                                  		; 10/12/2022
 15501                                  		; 19/10/2022
 15502 00001170 F606[A004]80            		test	byte [multrk_flag], 80h
 15503                                  		;test	word [multrk_flag], 80h ; MULTI_TRK_ON
 15504                                  		;;test	ds:multrk_flag,	80h ; MULTI_TRK_ON
 15505 00001175 7405                    		jz	short NormVerifyTrack
 15506 00001177 C606[A704]01            		mov	byte [multitrk_format_flag], 1
 15507                                  NormVerifyTrack:
 15508 0000117C 31C0                    		xor	ax, ax		; 1st sector
 15509 0000117E 31DB                    		xor	bx, bx
 15510 00001180 891E[A804]              		mov	[xfer_seg], bx	; Use 0:0 as the transfer address for verify
 15511 00001184 E83F00                  		call	TrackIo
 15512 00001187 C606[A704]00            		mov	byte [multitrk_format_flag], 0
 15513 0000118C C3                      		retn
 15514                                  ; ---------------------------------------------------------------------------
 15515                                  
 15516                                  VerifyTrack_Err:
 15517 0000118D B401                    		mov	ah, 1
 15518 0000118F E916FC                  		jmp	maperror
 15519                                  ; ---------------------------------------------------------------------------
 15520                                  
 15521                                  ; 16/10/2022
 15522                                  
 15523                                  ; ==========================================================================
 15524                                  ;
 15525                                  ; ReadTrack:
 15526                                  ;
 15527                                  ; input: ES:di points to bds for drive
 15528                                  ;
 15529                                  ; ==========================================================================
 15530                                  
 15531                                  ReadTrack:
 15532 00001192 C606[2001]02            		mov	byte [rflag], 2	; romread
 15533 00001197 EB05                    		jmp	short ReadWriteTrack
 15534                                  ; ---------------------------------------------------------------------------
 15535                                  
 15536                                  WriteTrack:
 15537                                  
 15538                                  ; ==========================================================================
 15539                                  ;
 15540                                  ; WriteTrack:
 15541                                  ;
 15542                                  ; input: ES:di points to bds for drive
 15543                                  ;
 15544                                  ; ==========================================================================
 15545                                  				
 15546 00001199 C606[2001]03            		mov	byte [rflag], 3	; romwrite
 15547                                  
 15548                                  		; Fall into ReadWriteTrack
 15549                                  
 15550                                  ; ==========================================================================
 15551                                  ;
 15552                                  ; readWriteTrack:
 15553                                  ;
 15554                                  ; input:
 15555                                  ;    ES:di points to bds for drive
 15556                                  ;    rFlag - 2 for read,3 for write
 15557                                  ;
 15558                                  ; ==========================================================================
 15559                                  
 15560                                  ReadWriteTrack:	
 15561                                  		; save bds pointer segment so we can use it to access
 15562                                  		; our packet. Notice that this is not the standard register
 15563                                  		; assignment for accessing packets
 15564                                  		
 15565                                  		; 19/10/2022
 15566 0000119E 06                      		push	es
 15567 0000119F C41E[1200]              		les	bx, [ptrsav]	; ES:BX	-> to request header
 15568 000011A3 26C45F13                		les	bx, [es:bx+19]	; [es:bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 15569 000011A7 268B4703                		mov	ax, [es:bx+3]	; [es:bx+A_TRACKREADWRITEPACKET.TRWP_CYLINDER]
 15570 000011AB A3[3301]                		mov	[curtrk], ax
 15571 000011AE 268B4701                		mov	ax, [es:bx+1]	; [es:bx+A_TRACKREADWRITEPACKET.TRWP_HEAD]
 15572 000011B2 A2[3201]                		mov	[curhd], al	; Assume heads < 256!!!
 15573 000011B5 268B4705                		mov	ax, [es:bx+5]	; [es:bx+A_TRACKREADWRITEPACKET.TRWP_FIRSTSECTOR]
 15574 000011B9 268B4F07                		mov	cx, [es:bx+7]	; [es:bx+A_TRACKREADWRITEPACKET.TRWP_SECTORSTOREADWRITE]
 15575 000011BD 26C45F09                		les	bx, [es:bx+9]	; [es:bx+A_TRACKREADWRITEPACKET.TRWP_TRANSFERADDRESS]
 15576                                  					; Get transfer address
 15577                                  
 15578                                  		; we just trashed our packet address, but we no longer care
 15579                                  
 15580 000011C1 8C06[A804]              		mov	[xfer_seg], es	; Pass transfer	segment
 15581 000011C5 07                      		pop	es
 15582                                  
 15583                                  		; Fall into TrackIo
 15584                                  
 15585                                  ; =============== S U B	R O U T	I N E =======================================
 15586                                  
 15587                                  ; 16/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 15588                                  
 15589                                  ; ==========================================================================
 15590                                  ;
 15591                                  ; TrackIo:
 15592                                  ;    performs track read/write/verify
 15593                                  ;
 15594                                  ;   input:
 15595                                  ;      rFlag	- 2 = read
 15596                                  ;		  3 = write
 15597                                  ;		  4 = verify
 15598                                  ;      AX	- Index into track table of first sector to io
 15599                                  ;      CX	- Number of sectors to io
 15600                                  ;      Xfer_Seg:BX - Transfer address
 15601                                  ;      ES:DI	- Pointer to bds
 15602                                  ;      CurTrk	- Current cylinder
 15603                                  ;      CurHd	- Current head
 15604                                  ;
 15605                                  ; ==========================================================================
 15606                                  
 15607                                  ; 16/03/2019 - Retro DOS v4.0
 15608                                  
 15609                                  		; 24/12/2023 - Retro DOS 5.0		
 15610                                  
 15611                                  		; 19/10/2022
 15612                                  TrackIo:
 15613                                  					; Procedure `disk' will pop stack to
 15614 000011C6 8926[3501]              		mov	[spsav], sp	; SpSav	and return if error
 15615 000011CA E8AAF7                  		call	checksingle	; Ensure correct disk is in drv
 15616 000011CD 803E[A905]01            		cmp	byte [media_set_for_format], 1
 15617                                  					; See if we have already set	disk
 15618 000011D2 7407                    		jz	short Dptalreadyset ; base table
 15619 000011D4 50                      		push	ax		; set up tables	and variables for i/o
 15620 000011D5 51                      		push	cx
 15621 000011D6 E8A1F9                  		call	iosetup
 15622 000011D9 59                      		pop	cx
 15623 000011DA 58                      		pop	ax
 15624                                  Dptalreadyset:				; Point si at the table entry of the			
 15625 000011DB BE[AC04]                		mov	si, tracktable	; first sector to be io'd
 15626                                  		; 24/12/2023
 15627                                  		;add	ax, ax		; PCDOS 7.1 IBMBIO.COM
 15628                                  		;add	ax, ax
 15629 000011DE D1E0                    		shl	ax, 1
 15630 000011E0 D1E0                    		shl	ax, 1
 15631 000011E2 01C6                    		add	si, ax
 15632                                  
 15633                                  		; WE WANT:
 15634                                  		; CX to	be the number of times we have to loop
 15635                                  		; DX to	be the number of sectors we read on each iteration
 15636                                  		
 15637 000011E4 BA0100                  		mov	dx, 1
 15638                                  
 15639                                  		; 24/12/2023
 15640 000011E7 26F6453F08              		test	byte [es:di+3Fh], 8 ; PCDOS 7.1 IBMBIO.COM
 15641                                  		; 12/12/2022
 15642                                  		;test	byte [es:di+23h], 8
 15643                                  		;;test	word [es:di+35], 8 ; [es:di+BDS.flags]
 15644                                  					; good_tracklayout
 15645 000011EC 7402                    		jz	short ionextsector
 15646                                  		
 15647 000011EE 87D1                    		xchg	dx, cx		; HEY! We can read all secs in one blow
 15648                                  ionextsector:
 15649 000011F0 51                      		push	cx
 15650 000011F1 52                      		push	dx
 15651 000011F2 46                      		inc	si
 15652 000011F3 46                      		inc	si		; Skip over the	cylinder and head in
 15653                                  					; the track table
 15654 000011F4 AC                      		lodsb			; Get sector ID	from track table
 15655 000011F5 A2[3101]                		mov	[cursec], al
 15656                                  
 15657                                  		; assumptions for a fixed disk multi-track disk	i/o
 15658                                  		; 1). In the input CX (# of sectors to go) to TrackIo,
 15659                                  		;     only CL is valid.
 15660                                  		; 2). Sector size should be set	to 512 bytes.
 15661                                  		; 3). Good track layout
 15662                                  		
 15663                                  		; 24/12/2023
 15664 000011F8 26F6453F01              		test	byte [es:di+3Fh], 1 ; PCDOS 7.1 IBMBIO.COM
 15665                                  		; 12/12/2022
 15666                                  		;test	byte [es:di+23h], 1
 15667                                  		;;test	word [es:di+35], 1 ; [es:di+BDS.flags]
 15668                                  					; fnon_removable ; Fixed disk?
 15669 000011FD 7414                    		jz	short IoRemovable ; No
 15670                                  
 15671                                  		; 12/12/2022
 15672 000011FF F606[A004]80            		test	byte [multrk_flag], 80h
 15673                                  		;test	word [multrk_flag], 80h ; MULTI_TRK_ON
 15674                                  						; Allow multi-track operation?
 15675 00001204 740D                    		jz	short IoRemovable ; No,don't do that.
 15676 00001206 8916[2201]              		mov	[seccnt], dx
 15677 0000120A 89D0                    		mov	ax, dx
 15678 0000120C E826FA                  		call	Disk
 15679 0000120F 5A                      		pop	dx
 15680 00001210 59                      		pop	cx
 15681 00001211 F8                      		clc
 15682 00001212 C3                      		retn
 15683                                  ; ---------------------------------------------------------------------------
 15684                                  
 15685                                  IoRemovable:
 15686 00001213 AC                      		lodsb			; Get sector size index	from track
 15687                                  					; table	and save it
 15688 00001214 50                      		push	ax
 15689 00001215 56                      		push	si
 15690 00001216 1E                      		push	ds		; Save Bios_Data
 15691 00001217 50                      		push	ax
 15692 00001218 8A26[2C01]              		mov	ah, [eot]	; Preserve whatever might be in	ah
 15693                                  					; Fetch	EOT while ds-> Bios_Data
 15694 0000121C C536[2D01]              		lds	si, [dpt]
 15695 00001220 884403                  		mov	[si+3],	al	; [si+DISK_PARMS.DISK_SECTOR_SIZ]
 15696 00001223 886404                  		mov	[si+4],	ah	; [si+DISK_PARMS.DISK_EOT]
 15697 00001226 58                      		pop	ax
 15698 00001227 1F                      		pop	ds
 15699 00001228 88D0                    		mov	al, dl
 15700 0000122A A3[2201]                		mov	[seccnt], ax
 15701 0000122D E805FA                  		call	Disk
 15702 00001230 5E                      		pop	si		; Advance buffer pointer by adding
 15703                                  					; sector size
 15704                                  		;pop	ax
 15705                                  		; 24/12/2023
 15706 00001231 59                      		pop	cx
 15707                                  
 15708                                  		; 02/09/2023 (PCDOS 7.1)
 15709                                  		;call	SectorSizeIndexToSectorSize
 15710                                  		;mov	cl, al	; 24/12/2023
 15711 00001232 B88000                  		mov	ax, 128
 15712 00001235 D3E0                    		shl	ax, cl
 15713                                  
 15714 00001237 01C3                    		add	bx, ax
 15715 00001239 5A                      		pop	dx
 15716 0000123A 59                      		pop	cx
 15717 0000123B E2B3                    		loop	ionextsector
 15718 0000123D 803E[A905]01            		cmp	byte [media_set_for_format], 1
 15719                                  		;jz	short NoNeedDone
 15720                                  		; 12/12/2022
 15721 00001242 7404                    		je	short NoNeedDone2
 15722 00001244 E87AF9                  		call	done		; set time of last access, and reset
 15723                                  					; entries in Dpt.
 15724                                  NoNeedDone:
 15725 00001247 F8                      		clc	; not necessary ('done' clears cf) ; 24/12/2023
 15726                                  NoNeedDone2:
 15727 00001248 C3                      		retn
 15728                                  
 15729                                  ; =============== S U B	R O U T	I N E =======================================
 15730                                  
 15731                                  ; ---------------------------------------------------------------------------
 15732                                  ;
 15733                                  ; The sector size in bytes needs to be converted to an index value for the ibm
 15734                                  ; rom. (0=>128,1=>256,2=>512,3=>1024). It is assumed that only these values
 15735                                  ; are permissible.
 15736                                  ;
 15737                                  ; On Input   AX contains sector size in bytes
 15738                                  ; On Output  AL Contains index
 15739                                  ; All other registers preserved
 15740                                  ;
 15741                                  ; ---------------------------------------------------------------------------
 15742                                  
 15743                                  ; 02/09/2023
 15744                                  ;SectSizeToSectIndex:
 15745                                  ;		cmp	ah, 2		; (0=>128,1=>256,2=>512,3=>1024)
 15746                                  ;					; examine upper	byte only
 15747                                  ;		ja	short OneK
 15748                                  ;		mov	al, ah		; value	in AH is the index!
 15749                                  ;		retn
 15750                                  
 15751                                  ; ---------------------------------------------------------------------------
 15752                                  ;
 15753                                  ;OneK:
 15754                                  ;		mov	al, 3
 15755                                  ;		retn
 15756                                  
 15757                                  ; =============== S U B	R O U T	I N E =======================================
 15758                                  
 15759                                  ; 02/09/2023
 15760                                  ;SectorSizeIndexToSectorSize:
 15761                                  ;		mov	cl, al
 15762                                  ;		mov	ax, 128
 15763                                  ;		shl	ax, cl
 15764                                  ;		retn
 15765                                  
 15766                                  ; =============== S U B	R O U T	I N E =======================================
 15767                                  
 15768                                  ; 16/10/2022
 15769                                  
 15770                                  ; ---------------------------------------------------------------------------
 15771                                  ;
 15772                                  ; SetDASD
 15773                                  ;
 15774                                  ; Set up the rom for formatting.
 15775                                  ; we have to tell the rom bios what type of disk is in the drive.
 15776                                  ;
 15777                                  ; On Input   - ES:di - Points to bds
 15778                                  ;
 15779                                  ; ---------------------------------------------------------------------------
 15780                                  
 15781                                  		; 24/12/2023 - Retro DOS 5.0
 15782                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:129Bh)
 15783                                  
 15784                                  		; 19/10/2022
 15785                                  SetDasd:
 15786 00001249 803E[AA05]01            		cmp	byte [had_format_error], 1 ;
 15787                                  					; See if we've previously set dasd type
 15788 0000124E 740C                    		jz	short DoSetDasd
 15789                                  		; 24/12/2023
 15790 00001250 26F6453F80              		test	byte [es:di+3Fh], 80h
 15791                                  		; 10/12/2022
 15792                                  		;test	byte [es:di+23h], 80h
 15793                                  		;;test	word [es:di+23h], 80h ; [es:di+BDS.flags]
 15794                                  					; set_dasd_true
 15795 00001255 7446                    		jz	short DasdHasBeenSet
 15796                                  		; 24/12/2023
 15797 00001257 2680653F7F              		and	byte [es:di+3Fh], 7Fh
 15798                                  		; 10/12/2022
 15799                                  		;and	byte [es:di+23h], 7Fh
 15800                                  		;;and	word [es:di+23h], 0FF7Fh ; [es:di+BDS.flags]
 15801                                  					; ~set_dasd_true
 15802                                  DoSetDasd:
 15803 0000125C C606[AA05]00            		mov	byte [had_format_error], 0 ; Reset it
 15804 00001261 C606[3B01]50            		mov	byte [gap_patch], 50h ; Format gap for 48tpi disks
 15805 00001266 B004                    		mov	al, 4
 15806                                  		; 24/12/2023
 15807 00001268 268A653E                		mov	ah, [es:di+3Eh]
 15808                                  		; 02/09/2023
 15809                                  		;mov	ah, [es:di+22h] ; [es:di+BDS.formfactor]
 15810 0000126C 80FC02                  		cmp	ah, 2
 15811                                  		;cmp	byte [es:di+22h], 2 ; [es:di+BDS.formfactor]
 15812                                  					; DEV_3INCH720KB
 15813 0000126F 7414                    		jz	short DoSet
 15814                                  		; 24/12/2023
 15815 00001271 B001                    		mov	al, 1
 15816                                  		;cmp	ah, 1
 15817 00001273 38C4                    		cmp	ah, al	; 1
 15818                                  		;cmp	byte [es:di+22h], 1 ; [es:di+BDS.formfactor]
 15819                                  					; DEV_5INCH96TPI
 15820                                  		;jz	short GotBig
 15821                                  		; 24/12/2023
 15822                                  		;mov	al, 1
 15823                                  		;jmp	short DoSet
 15824                                  		; 02/09/2023
 15825 00001275 750E                    		jnz	short DoSet
 15826                                  GotBig:
 15827                                  		;mov	al, 2		; 160/320k in a	1.2 meg	drive
 15828                                  		; 02/09/2023
 15829 00001277 40                      		inc	ax  ; mov al, 2
 15830 00001278 803E[A805]00            		cmp	byte [mediatype], 0
 15831 0000127D 7506                    		jnz	short DoSet
 15832                                  		;mov	al, 3		; 1.2meg in a 1.2meg drive
 15833                                  		; 10/12/2022
 15834                                  		;inc	al  ; al = 3
 15835                                  		; 18/12/2022
 15836 0000127F 40                      		inc	ax  ; al = 3
 15837 00001280 C606[3B01]54            		mov	byte [gap_patch], 54h
 15838                                  DoSet:
 15839 00001285 1E                      		push	ds
 15840 00001286 56                      		push	si
 15841                                  
 15842                                  		;mov	ds, [zeroseg]	; Point	to interrupt vectors
 15843                                  		; 02/09/2023
 15844 00001287 31F6                    		xor	si, si
 15845 00001289 8EDE                    		mov	ds, si	; 0
 15846                                  
 15847 0000128B C5367800                		lds	si, [DSKADR]
 15848                                  		;lds	si, [78h]	; [DSKADR]  (Int 1Eh)
 15849                                  		;;lds	si, ds:78h
 15850                                  
 15851 0000128F C644090F                		mov	byte [si+9], 0Fh ;
 15852                                  					; [si+DISK_PARMS.DISK_HEAD_STTL]
 15853 00001293 5E                      		pop	si
 15854 00001294 1F                      		pop	ds
 15855 00001295 B417                    		mov	ah, 17h
 15856 00001297 268A5504                		mov	dl, [es:di+4]
 15857 0000129B CD13                    		int	13h		; DISK - DISK -	SET TYPE (AT,XT2,XT286,CONV,PS
 15858                                  					; AL = disk type AL = 03h - high-capacity disk in high-capacity	drive
 15859                                  DasdHasBeenSet:
 15860 0000129D 268A6513                		mov	ah, [es:di+13h]	; [es:di+BDS.secpertrack]
 15861 000012A1 8826[3701]              		mov	[formt_eot], ah
 15862 000012A5 C3                      		retn
 15863                                  
 15864                                  ; =============== S U B	R O U T	I N E =======================================
 15865                                  
 15866                                  ; =============== S U B	R O U T	I N E =======================================
 15867                                  
 15868                                  ; 16/10/2022
 15869                                  
 15870                                  ; ---------------------------------------------------------------------------
 15871                                  ;
 15872                                  ; Set Media Type for Format
 15873                                  ; Performs the int 13 with ah = 18h to see if the medium described in the
 15874                                  ; BPB area in the BDS can be handled by the rom.
 15875                                  ; On Input, ES:DI -> current BDS.
 15876                                  ; The status of the operation is returned in AL
 15877                                  ;
 15878                                  ;	- 0 - if the support is available,and the combination is valid.
 15879                                  ;	- 1 - no rom support
 15880                                  ;	- 2 - illegal combination
 15881                                  ;	- 3 - no media present (rom support exists but cannot determine now)
 15882                                  ;
 15883                                  ; Flags also may be altered. All other registers preserved.
 15884                                  ; If the call to rom returns no error,then the current Dpt is "replaced" by
 15885                                  ; the one returned by the rom. This is Done by changing the pointer in [Dpt]
 15886                                  ; to the one returned. the original pointer to the disk base table is stored
 15887                                  ; in TempDpt, until it is restored.
 15888                                  ;
 15889                                  ; ---------------------------------------------------------------------------
 15890                                  
 15891                                  		; 24/12/2023 - Retro DOS 5.0
 15892                                  
 15893                                  		; 19/10/2022
 15894                                  SetMediaForFormat:	
 15895 000012A6 51                      		push	cx
 15896 000012A7 52                      		push	dx
 15897                                  
 15898                                  		; If we have a format error, then do not change Dpt, TempDpt.
 15899                                  		; but we need to call int 13h, ah=18h again.
 15900                                  
 15901 000012A8 803E[AA05]01            		cmp	byte [had_format_error], 1
 15902 000012AD 7425                    		jz	short SkipSaveDskAdr
 15903 000012AF 30C0                    		xor	al, al		; If already done return 0
 15904 000012B1 803E[A905]01            		cmp	byte [media_set_for_format], 1
 15905 000012B6 7502                    		jnz	short DoSetMediaForFormat
 15906 000012B8 EB7D                    		jmp	SetMediaRet	; Media	already	set
 15907                                  ; ---------------------------------------------------------------------------
 15908                                  
 15909                                  DoSetMediaForFormat:
 15910 000012BA 06                      		push	es
 15911 000012BB 56                      		push	si
 15912                                  
 15913                                  		; 02/09/2023
 15914                                  		;mov	es, [zeroseg]	; Point to interrupt vectors
 15915 000012BC 31F6                    		xor	si, si ; 0
 15916 000012BE 8EC6                    		mov	es, si
 15917                                  
 15918 000012C0 26C4367800              		les	si, [es:DSKADR]
 15919                                  		;les	si, es:78h	; [es:DSKADR]
 15920                                  					; Get pointer to disk base table
 15921 000012C5 8936[2D01]              		mov	[dpt], si
 15922 000012C9 8C06[2F01]              		mov	[dpt+2], es	; Save pointer to table
 15923                                  
 15924                                  		; Initialize the head settle time to 0Fh. See the offsets
 15925                                  		; given in dskprm.inc.
 15926                                  
 15927 000012CD 26C644090F              		mov	byte [es:si+9], 0Fh ; [es:si+DISK_PARMS.DISK_HEAD_STTL]
 15928 000012D2 5E                      		pop	si
 15929 000012D3 07                      		pop	es
 15930                                  SkipSaveDskAdr:
 15931                                  		; 24/12/2023
 15932 000012D4 268B4D41                		mov	cx, [es:di+41h]	; (PCDOS 7.1 IBMBIO.COM)
 15933                                  		;mov	cx, [es:di+25h]	; [es:di+BDS.cylinders]
 15934 000012D8 49                      		dec	cx
 15935 000012D9 80E503                  		and	ch, 3
 15936 000012DC D0CD                    		ror	ch, 1
 15937 000012DE D0CD                    		ror	ch, 1
 15938 000012E0 86E9                    		xchg	ch, cl
 15939 000012E2 260A4D13                		or	cl, [es:di+13h]	; [es:di+BDS.secpertrack]
 15940 000012E6 268A5504                		mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 15941 000012EA 06                      		push	es
 15942 000012EB 1E                      		push	ds
 15943 000012EC 56                      		push	si
 15944 000012ED 57                      		push	di
 15945 000012EE B418                    		mov	ah, 18h
 15946 000012F0 CD13                    		int	13h		; DISK - SET MEDIA TYPE	FOR FORMAT (AT model 3x9,XT2,XT286,PS)
 15947                                  					; DL = drive number, CH	= lower	8 bits of number of tracks, CL = sectors per track
 15948 000012F2 7231                    		jc	short FormaStatErr
 15949 000012F4 803E[AA05]01            		cmp	byte [had_format_error], 1
 15950 000012F9 7423                    		jz	short skip_disk_base_setting
 15951 000012FB 06                      		push	es		; Save segment returned	by the rom
 15952                                  
 15953                                  		; 02/09/2023
 15954                                  		;mov	es, [zeroseg]	; Point	to interrupt vector segment
 15955 000012FC 31F6                    		xor	si, si
 15956 000012FE 8EC6                    		mov	es, si ; 0
 15957 00001300 06                      		push	es ; * ; 02/09/2023
 15958                                  
 15959 00001301 26C4367800              		les	si, [es:DSKADR]
 15960                                  		;les	si, es:78h	; [es:DSKADR] (Int 1Eh)
 15961                                  					; Get current disk base	table
 15962 00001306 8936[AB05]              		mov	[tempdpt], si
 15963 0000130A 8C06[AD05]              		mov	[tempdpt+2], es ; Save it
 15964                                  
 15965                                  		; 02/09/2023
 15966                                  		;;mov	es, [zeroseg]
 15967                                  		;xor	si, si ; 0
 15968                                  		;mov	es, si
 15969 0000130E 07                      		pop	es ; * ; 02/09/2023
 15970                                  
 15971                                  		;mov	es:78h,	di
 15972 0000130F 26893E7800              		mov	[es:DSKADR], di
 15973                                  		;pop	word ptr es:7Ah	; replace with one returned by rom
 15974 00001314 268F067A00              		pop	word [es:DSKADR+2]
 15975 00001319 C606[A905]01            		mov	byte [media_set_for_format], 1
 15976                                  skip_disk_base_setting:
 15977 0000131E 30C0                    		xor	al, al		; Legal	combination + rom support code
 15978                                  		;mov	ds:had_format_error, al	; Reset	the flag
 15979 00001320 A2[AA05]                		mov	[had_format_error], al
 15980 00001323 EB0E                    		jmp	short PopStatRet
 15981                                  ; ---------------------------------------------------------------------------
 15982                                  
 15983                                  FormaStatErr:
 15984                                  		; 10/12/2022
 15985 00001325 B003                    		mov	al, 3
 15986                                  
 15987 00001327 80FC0C                  		cmp	ah, 0Ch		; DSK_ILLEGAL_COMBINATION
 15988                                  					; Illegal combination =	0Ch
 15989 0000132A 7406                    		jz	short FormatStatIllegalComb
 15990 0000132C 80FC80                  		cmp	ah, 80h		; DSK_TIMEOUT_ERR
 15991 0000132F 7402                    		jz	short FormatStatTimeOut
 15992                                  		; 10/12/2022
 15993                                  		;dec	al
 15994                                  		; 18/12/2022
 15995 00001331 48                      		dec	ax
 15996                                  		; al = 2
 15997                                  		;mov	al, 1		; Function not supported.
 15998                                  		;jmp	short PopStatRet
 15999                                  ; ---------------------------------------------------------------------------
 16000                                  
 16001                                  FormatStatIllegalComb:
 16002                                  		; 10/12/2022
 16003                                  		;dec	al	; 3 -> 2 or 2 -> 1
 16004                                  		; 18/12/2022
 16005 00001332 48                      		dec	ax
 16006                                  		; al = 2
 16007                                  		;mov	al, 2		; Function supported, but
 16008                                  					; Illegal sect/trk,trk combination.
 16009                                  		; 10/12/2022
 16010                                  		;jmp	short PopStatRet
 16011                                  ; ---------------------------------------------------------------------------
 16012                                  
 16013                                  FormatStatTimeOut:
 16014                                  		; 10/12/2022
 16015                                  		; al = 3
 16016                                  		;mov	al, 3		; Function supported, but
 16017                                  					; Media	not present.
 16018                                  PopStatRet:
 16019 00001333 5F                      		pop	di
 16020 00001334 5E                      		pop	si
 16021 00001335 1F                      		pop	ds
 16022 00001336 07                      		pop	es
 16023                                  SetMediaRet:
 16024 00001337 5A                      		pop	dx
 16025 00001338 59                      		pop	cx
 16026 00001339 C3                      		retn
 16027                                  
 16028                                  ; =============== S U B	R O U T	I N E =======================================
 16029                                  
 16030                                  ; 16/10/2022
 16031                                  
 16032                                  ; ---------------------------------------------------------------------------
 16033                                  ;
 16034                                  ; RESET THE DRIVE
 16035                                  ;
 16036                                  ; we also set [Step_Drv] to -1 to force the main disk routine to use the
 16037                                  ; slow head settle time for the next operation. this is because the reset
 16038                                  ; operation moves the head to cylinder 0,so we need to do a seek the next
 16039                                  ; time around - there is a problem with 3.5" drives in that the head does
 16040                                  ; not settle down in time,even for read operations!!
 16041                                  ;
 16042                                  ; ---------------------------------------------------------------------------
 16043                                  
 16044                                  ResetDisk:
 16045 0000133A 50                      		push	ax
 16046                                  
 16047                                  		; 02/09/2023
 16048 0000133B B80100                  		mov	ax, 1 ; PCDOS 7.1
 16049 0000133E 3806[A905]              		cmp	[media_set_for_format], al ; 1
 16050                                  		;cmp	byte [media_set_for_format], 1
 16051                                  					; Reset while formatting?
 16052 00001342 7503                    		jnz	short ResetDisk_cont
 16053                                  					; Then verify operation in "fmt & vrfy"
 16054                                  		;mov	byte [had_format_error], 1 ; Might have failed.
 16055 00001344 A2[AA05]                		mov	[had_format_error], al ; 1
 16056                                  ResetDisk_cont:
 16057                                  		; 02/09/2023 (ah=0)
 16058                                  		;xor	ah, ah		; So signals that we had a format error
 16059 00001347 CD13                    		int	13h		; DISK - RESET DISK SYSTEM
 16060                                  					; DL = drive (if bit 7 is set both hard	disks and floppy disks reset)
 16061 00001349 C606[7600]FF            		mov	byte [step_drv], 0FFh ; -1
 16062                                  					; Zap up the speed
 16063 0000134E 58                      		pop	ax
 16064 0000134F C3                      		retn
 16065                                  
 16066                                  ; =============== S U B	R O U T	I N E =======================================
 16067                                  
 16068                                  ; 16/10/2022
 16069                                  
 16070                                  ; ---------------------------------------------------------------------------
 16071                                  ;
 16072                                  ; This routine sets up the drive parameter table with the values needed for
 16073                                  ; format,does an int 13. values in Dpt are restored after a verify is done.
 16074                                  ;
 16075                                  ; on entry  -	ES:DI - points to bds for the drive
 16076                                  ;		Xfer_Seg:BX - points to trkbuf
 16077                                  ;		AL    - number of sectors
 16078                                  ;		AH    - int 13 function code
 16079                                  ;		CL    - sector number for verify
 16080                                  ;		DS    - Bios_Data
 16081                                  ;
 16082                                  ; ON EXIT   -	DS,DI,ES,BX remain unchanged.
 16083                                  ;		AX and flags are the results of the int 13
 16084                                  ;
 16085                                  ; ---------------------------------------------------------------------------
 16086                                  
 16087                                  		; 24/12/2023 - Retro DOS 5.0
 16088                                  
 16089                                  		; 19/10/2022
 16090                                  ToRom:
 16091 00001350 53                      		push	bx
 16092 00001351 56                      		push	si
 16093                                  
 16094                                  		; Compaq bug fix - check whether we are using new ROM
 16095                                  		; functionality to set up format, not merely if it exists.
 16096                                  		; This was formerly a check against [new_rom]
 16097                                  
 16098 00001352 F606[A905]01            		test	byte [media_set_for_format], 1
 16099 00001357 7534                    		jnz	short GotValidDpt
 16100 00001359 50                      		push	ax
 16101 0000135A 06                      		push	es		; Save bds segment
 16102                                  		; 24/12/2023
 16103 0000135B 26807D3E02              		cmp	byte [es:di+3Eh], 2
 16104                                  		;cmp	byte [es:di+22h], 2 ; [es:di+BDS.formfactor]
 16105                                  					; ffSmall ; is it a 3.5" drive?
 16106                                  		; 24/12/2023
 16107                                  		;pushf	; not necessary	; (Save	the cmp	result)
 16108 00001360 8E06[1A00]              		mov	es, [zeroseg]
 16109                                  		;les	si, es:78h	; Get pointer to disk base table
 16110 00001364 26C4367800              		les	si, [es:DSKADR]
 16111                                  		;mov	word ptr ds:dpt, si
 16112                                  		;mov	word ptr ds:dpt+2, es ;	 Save pointer to table
 16113 00001369 8936[2D01]              		mov	[dpt], si
 16114 0000136D 8C06[2F01]              		mov	[dpt+2], es	; Save pointer to table
 16115                                  		
 16116 00001371 A0[3701]                		mov	al, [formt_eot]
 16117 00001374 26884404                		mov	[es:si+4], al	; [es:si+DISK_PARMS.DISK_EOT]
 16118 00001378 A0[3B01]                		mov	al, [gap_patch]
 16119 0000137B 26884407                		mov	[es:si+7], al	; [es:si+DISK_PARMS.DISK_FORMT_GAP]
 16120                                  					; Important for	format
 16121 0000137F 26C644090F              		mov	byte [es:si+9], 0Fh ; [es:si+DISK_PARMS.DISK_HEAD_STTL]
 16122                                  					; Assume we are	doing a	seek operation
 16123                                  					; Setup	motor start correctly for 3.5" drives
 16124                                  		; 24/12/2023
 16125                                  		;popf			; Get result of	earlier	cmp
 16126 00001384 7505                    		jnz	short MotorStrtOK
 16127 00001386 26C6440A04              		mov	byte [es:si+0Ah], 4 ; [es:si+DISK_PARMS.DISK_MOTOR_STRT]
 16128                                  MotorStrtOK:
 16129 0000138B 07                      		pop	es		; Restore bds segment
 16130 0000138C 58                      		pop	ax
 16131                                  GotValidDpt:
 16132 0000138D 8B16[3901]              		mov	dx, [trknum]	; Set track number
 16133 00001391 88D5                    		mov	ch, dl		; Set low 8 bits in ch
 16134 00001393 268A5504                		mov	dl, [es:di+4]	; Set drive number
 16135 00001397 8A36[3801]              		mov	dh, [hdnum]	; Set head number
 16136 0000139B 06                      		push	es		; Save bds segment
 16137 0000139C 8E06[A804]              		mov	es, [xfer_seg]
 16138 000013A0 CD13                    		int	13h		; DISK -
 16139 000013A2 07                      		pop	es		; Restore bds segment
 16140 000013A3 5E                      		pop	si
 16141 000013A4 5B                      		pop	bx
 16142 000013A5 C3                      		retn
 16143                                  
 16144                                  ; ---------------------------------------------------------------------------
 16145                                  
 16146                                  ; 16/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 16147                                  ; 24/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
 16148                                  
 16149                                  ; BIOSCODE:1124h (MSDOS 6.21, IO.SYS)
 16150                                  ; PCDOS 7.1 IBMBIO.COM - BIOSCODE:1404h
 16151                                  
 16152                                  ; ==========================================================================
 16153                                  ;
 16154                                  ; get the owner of the physical drive represented by the logical drive in al.
 16155                                  ; the assumption is that we **always** keep track of the owner of a drive!!
 16156                                  ; if this is not the case, the system may hang, just following the linked list.
 16157                                  ;
 16158                                  ; ==========================================================================
 16159                                  
 16160                                  		; 24/12/2023 - Retro DOS 5.0
 16161                                  
 16162                                  		; 19/10/2022
 16163                                  ioctl_getown:
 16164 000013A6 E8FBF1                  		call	SetDrive
 16165 000013A9 268A4504                		mov	al, [es:di+4]	; [es:di+BDS.drivenum]
 16166                                  					; Get physical drive number
 16167 000013AD C43E[1901]              		les	di, [start_bds] ; Get start of bds chain
 16168                                  ownloop:
 16169 000013B1 26384504                		cmp	[es:di+4], al	; [es:di+BDS.drivenum]
 16170 000013B5 7507                    		jnz	short getnextBDS
 16171                                  		; 24/12/2023
 16172 000013B7 26F6453F20              		test	byte [es:di+3Fh], 20h ; (PCDOS 7.1 IBMBIO.COM)
 16173                                  		; 10/12/2022
 16174                                  		;test	byte [es:di+23h], 20h
 16175                                  		;;test	word [es:di+23h], 20h ; [es:di+BDS.flags]
 16176                                  					; fi_own_physical
 16177 000013BC 7514                    		jnz	short exitown
 16178                                  getnextBDS:
 16179 000013BE 26C43D                  		les	di, [es:di]	; [es:di+BDS.link]
 16180 000013C1 EBEE                    		jmp	short ownloop
 16181                                  ; ---------------------------------------------------------------------------
 16182                                  
 16183                                  ; ==========================================================================
 16184                                  ;
 16185                                  ; set the ownership of the physical drive represented by the logical drive
 16186                                  ; in al to al.
 16187                                  ;
 16188                                  ; ==========================================================================
 16189                                  
 16190                                  		; 24/12/2023 - Retro DOS 5.0
 16191                                  
 16192                                  		; 19/10/2022
 16193                                  ioctl_setown:
 16194 000013C3 E8DEF1                  		call	SetDrive
 16195 000013C6 C606[7A00]01            		mov	byte [fsetowner], 1
 16196                                  					; set flag for CheckSingle to look at.
 16197 000013CB E8A9F5                  		call	checksingle
 16198                                  		; 02/09/2023
 16199 000013CE FE0E[7A00]              		dec	byte [fsetowner] ; 0
 16200                                  		;mov	byte [fsetowner], 0
 16201                                  					; set ownership	of drive reset flag
 16202                                  		; Fall into ExitOwn
 16203                                  
 16204                                  ; ==========================================================================
 16205                                  ;
 16206                                  ; if there is only one logical drive assigned to this physical drive, return
 16207                                  ; 0 to user to indicate this. Enter with ES:di -> the owner's bds.
 16208                                  ;
 16209                                  ; ==========================================================================
 16210                                  
 16211                                  		; 24/12/2023 - Retro DOS 5.0
 16212                                  exitown:
 16213 000013D2 30C9                    		xor	cl, cl
 16214                                  		; 24/12/2023
 16215 000013D4 26F6453F10              		test	byte [es:di+3Fh], 10h ; (PCDOS 7.1 IBMBIO.COM)
 16216                                  		; 12/12/2022
 16217                                  		;test	byte [es:di+23h], 10h
 16218                                  		;;test	word [es:di+23h], 10h ; [es:di+BDS.flags]
 16219                                  					; fi_am_mult
 16220 000013D9 7406                    		jz	short exitnomult
 16221 000013DB 268A4D05                		mov	cl, [es:di+5]	; [es:di+BDS.drivelet]
 16222                                  					; Get logical drive number
 16223                                  					; Get it 1-based
 16224 000013DF FEC1                    		inc	cl
 16225                                  exitnomult:
 16226 000013E1 C51E[1200]              		lds	bx, [ptrsav]
 16227 000013E5 884F01                  		mov	[bx+1],	cl	; [bx+unit]
 16228                                  					; Exit normal termination
 16229                                  		; 12/12/2022
 16230                                  		; cf=0
 16231                                  		;clc
 16232 000013E8 C3                      		retn
 16233                                  
 16234                                  ; =============== S U B	R O U T	I N E =======================================
 16235                                  
 16236                                  ; 16/10/2022
 16237                                  
 16238                                  ; ---------------------------------------------------------------------------
 16239                                  ;
 16240                                  ; moves the old Dpt that had been saved in TempDpt back to Dpt. this is done
 16241                                  ; only if the first byte of TempDpt is not -1.
 16242                                  ; all registers (including flags) are preserved.
 16243                                  ;
 16244                                  ; ---------------------------------------------------------------------------
 16245                                  
 16246                                  		; 24/12/2023
 16247                                  		; 19/10/2022
 16248                                  RestoreOldDpt:
 16249                                  		; if we have already restored the disk base table earlier,
 16250                                  		; do not do it again.
 16251                                  
 16252 000013E9 50                      		push	ax
 16253 000013EA 30C0                    		xor	al, al
 16254 000013EC A2[AA05]                		mov	[had_format_error], al	; Reset flag and 
 16255 000013EF 8606[A905]              		xchg	al, [media_set_for_format] ; get current flag setting
 16256 000013F3 08C0                    		or	al, al
 16257 000013F5 7418                    		jz	short DontRestore
 16258 000013F7 56                      		push	si
 16259 000013F8 1E                      		push	ds
 16260 000013F9 06                      		push	es
 16261 000013FA C536[AB05]              		lds	si, [tempdpt]
 16262                                  
 16263                                  		; 17/10/2022
 16264                                  		;mov	es, [cs:BIOSDATAWORD]
 16265                                  		;;mov	es, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 16266                                  		;mov	es, [es:zeroseg]
 16267                                  		;;mov	es, es:zeroseg	; CAS -- bleeeech!
 16268                                  
 16269                                  		; 24/12/2023
 16270 000013FE 31C0                    		xor	ax, ax
 16271 00001400 8EC0                    		mov	es, ax ; 0
 16272                                  
 16273                                  		;mov	es:78h,	si	; [es:DSKADR]  (Int 1Eh)
 16274 00001402 2689367800              		mov	[es:DSKADR], si
 16275                                  		;mov	word ptr es:7Ah, ds ; [es:DSKADR+2]
 16276 00001407 268C1E7A00              		mov	[es:DSKADR+2], ds
 16277 0000140C 07                      		pop	es
 16278 0000140D 1F                      		pop	ds
 16279 0000140E 5E                      		pop	si
 16280                                  DontRestore:
 16281 0000140F 58                      		pop	ax
 16282                                  		; 12/12/2022
 16283                                  		; cf=0
 16284                                  		;clc			;  Clear carry
 16285 00001410 C3                      		retn
 16286                                  
 16287                                  ; ---------------------------------------------------------------------------
 16288                                  
 16289                                  ; 16/10/2022
 16290                                  
 16291                                  ; ==========================================================================
 16292                                  ;	get media id
 16293                                  ; ==========================================================================
 16294                                  ;
 16295                                  ; FUNCTION: get the volume label,the system id and the serial number from
 16296                                  ;	    the media that has the extended boot record.
 16297                                  ;	    for the conventional media,this routine will return "unknown
 16298                                  ;	    media type" error to dos.
 16299                                  ;
 16300                                  ; INPUT :   ES:di -> bds table for this drive.
 16301                                  ;
 16302                                  ; OUTPUT:   the request packet filled with the information,if not carry.
 16303                                  ;	    if carry set,then al contains the device driver error number
 16304                                  ;	    that will be returned to dos.
 16305                                  ;	    register DS,DX,AX,CX,DI,SI destroyed.
 16306                                  ;
 16307                                  ; SUBROUTINES TO BE CALLED:
 16308                                  ;	BootIo:NEAR
 16309                                  ;
 16310                                  ; LOGIC:
 16311                                  ;	to recognize the extended boot record,this logic will actually
 16312                                  ;	access the boot sector even if it is a hard disk.
 16313                                  ;	note:the valid extended bpb is recognized by looking at the mediabyte
 16314                                  ;	field of bpb and the extended boot signature.
 16315                                  ;
 16316                                  ; {
 16317                                  ;	get logical drive number from bds table;
 16318                                  ;	rFlag = read operation;
 16319                                  ;	BootIo;		 /*get the media boot record into the buffer
 16320                                  ;	if (no error) then
 16321                                  ;	     if (extended boot record) then
 16322                                  ;		{ set volume label,volume serial number and system id
 16323                                  ;		  of the request packet to those of the boot record;
 16324                                  ;		};
 16325                                  ;	     else		  /*not an extended bpb */
 16326                                  ;		{ set register al to "unknown media.." error code;
 16327                                  ;		  set carry bit;
 16328                                  ;		};
 16329                                  ;	else
 16330                                  ;	     ret;	/*already error code is set in the register al
 16331                                  ;
 16332                                  ; ==========================================================================
 16333                                  
 16334                                  ;size_of_EXT_BOOT_SERIAL equ 4
 16335                                  ;;size_of_EXT_BOOT_VOL_LABEL equ 11
 16336                                  ;;size_of_EXT_SYSTEM_ID equ 8
 16337                                  
 16338                                  		; 24/12/2023 - Retro DOS 5.0
 16339                                  		; (PCDOS 7.1 IBMBIO.COM - BIOSCODE:1478h)
 16340                                  
 16341                                  		; 19/10/2022
 16342                                  GetMediaId:
 16343 00001411 E8B000                  		call	ChangeLineChk
 16344 00001414 268A4505                		mov	al, [es:di+5]	; [es:di+BDS.drivelet] ; Logical drive number
 16345 00001418 C606[2001]02            		mov	byte [rflag], 2	; Read operation
 16346 0000141D E88C00                  		call	BootIo		; Read boot sector into	DiskSector
 16347 00001420 722E                    		jb	short IOCtl_If1
 16348                                  					; Valid? (0F0h-0FFh?)
 16349 00001422 803E[6701]F0            		cmp	byte [disksector+15h], 0F0h
 16350                                  					; [disksector+EXT_BOOT.BPB+EBPB.MEDIADESCRIPTOR]
 16351                                  		;jb	short IOCtl_If2	; brif not valid (0F0h - 0FFh)
 16352                                  		; 24/12/2023
 16353 00001427 7225                    		jb	short IOCtl_If7		
 16354                                  
 16355                                  		; 24/12/2023
 16356                                  		; 10/12/2022
 16357                                  		;mov	si, disksector+26h
 16358                                  		;;;
 16359                                  		; 24/12/2023
 16360                                  		;mov	si, disksector+43h ; BS_FAT32_VolID
 16361 00001429 BE[9401]                		mov	si, disksector+42h ; BS_FAT32_BootSig ; 24/12/2023
 16362 0000142C 833E[6801]00            		cmp	word [disksector+16h], 0 ; BPB.FATSz16
 16363 00001431 7403                    		jz	short IOCtl_If3 ; FAT32 fs
 16364 00001433 83EE1C                  		sub	si, 1Ch         ; FAT (12-16) fs ; 43h-1Ch = 27h ; BS_VolID
 16365                                  		; si = disksector+26h = BS_BootSig ; 24/12/2023
 16366                                  IOCtl_If3:
 16367                                  		;cmp	byte [si-1], 29h ; BS_BootSig or BS_FAT32_BootSig
 16368                                  		;;;
 16369 00001436 803C29                  		cmp	byte [si], 29h
 16370                                  		;cmp	byte [disksector+26h], 29h ; [disksector+EXT_BOOT.SIG]
 16371                                  					; EXT_BOOT_SIGNATURE
 16372 00001439 7512                    		jne	short IOCtl_If2	; not extended boot record
 16373 0000143B C43E[1200]              		les	di, [ptrsav]	; es:di	points to request header
 16374 0000143F 26C47F13                		les	di, [es:bx+19]	; [es:bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 16375                                  		; 10/12/2022
 16376                                  		;mov	si, disksector+27h ; disksector+EXT_BOOT.SERIAL
 16377 00001443 46                      		inc	si
 16378                                  		; 24/12/2023
 16379                                  		; si = disksector+27h (BS_VolID)
 16380                                  		;      or disksector+43h (BS_FAT32_VolID)
 16381                                  
 16382 00001444 83C702                  		add	di, 2		; A_MEDIA_ID_INFO.MI_SERIAL
 16383                                  IOCtl_If4:		; 24/12/2023
 16384 00001447 B91700                  		mov	cx, 23		; size_of_EXT_BOOT_SERIAL
 16385                                  					; L+size_of_EXT_BOOT_VOL_LABEL
 16386                                  					; +size_of_EXT_SYSTEM_ID
 16387 0000144A F3A4                    		rep movsb		; Move from Bios_Data into request packet
 16388                                  	
 16389                                  		; 10/12/2022
 16390                                  		; cf = 0
 16391                                  		;clc
 16392                                  
 16393 0000144C C3                      		retn
 16394                                  ; ---------------------------------------------------------------------------
 16395                                  
 16396                                  		; 24/12/2023
 16397                                  IOCtl_If2:
 16398 0000144D F9                      		stc	
 16399                                  IOCtl_If7:
 16400 0000144E B007                    		mov	al, 7		; error_unknown_media
 16401                                  		;stc
 16402                                  IOCtl_If6:
 16403                                  IOCtl_If1:
 16404 00001450 C3                      		retn
 16405                                  ; ---------------------------------------------------------------------------
 16406                                  
 16407                                  ; 16/10/2022
 16408                                  
 16409                                  ; ==========================================================================
 16410                                  ;  set media id
 16411                                  ; ==========================================================================
 16412                                  
 16413                                  ; function: set the volume label, the system id and the serial number of
 16414                                  ;	    the media that has the extended boot record.
 16415                                  ;	    for the conventional media, this routine will return "unknown
 16416                                  ;	    media.." error to dos.
 16417                                  ;	    this routine will also set the corresponding informations in
 16418                                  ;	    the bds table.
 16419                                  ;
 16420                                  ; input :   ES:di -> bds table for this drive.
 16421                                  ;
 16422                                  ; output:   the extended boot record in the media will be set according to
 16423                                  ;	    the request packet.
 16424                                  ;	    if carry set, then al contains the device driver error number
 16425                                  ;	    that will be returned to dos.
 16426                                  ;
 16427                                  ; subroutines to be called:
 16428                                  ;	BootIo:NEAR
 16429                                  ;
 16430                                  ; logic:
 16431                                  ;
 16432                                  ; {
 16433                                  ;	get drive_number from bds;
 16434                                  ;	rFlag = "read operation";
 16435                                  ;	BootIo;
 16436                                  ;	if (no error) then
 16437                                  ;	     if (extended boot record) then
 16438                                  ;		{ set volume label,volume serial number and system id
 16439                                  ;		  of the boot record to those of the request packet;
 16440                                  ;		  rFlag = "write operation";
 16441                                  ;		  get drive number from bds;
 16442                                  ;		  BootIo;	  /*write it back*/
 16443                                  ;		};
 16444                                  ;	     else		  /*not an extended bpb */
 16445                                  ;		{ set register al to "unknown media.." error code;
 16446                                  ;		  set carry bit;
 16447                                  ;		  ret;	 /*return back to caller */
 16448                                  ;		};
 16449                                  ;	else
 16450                                  ;	     ret;		 /*already error code is set */
 16451                                  ;
 16452                                  ; ==========================================================================
 16453                                  
 16454                                  		; 24/12/2023 - Retro DOS 5.0
 16455                                  
 16456                                  		; 19/10/2022
 16457                                  SetMediaId:
 16458 00001451 E87000                  		call	ChangeLineChk
 16459 00001454 268A4505                		mov	al, [es:di+5]	; [es:di+BDS.drivelet]
 16460                                  					; Logical drive	number
 16461 00001458 88C2                    		mov	dl, al
 16462 0000145A C606[2001]02            		mov	byte [rflag], 2	; romread
 16463 0000145F 52                      		push	dx
 16464 00001460 E84900                  		call	BootIo		; Read boot sec	to Bios_Data:DiskSector
 16465 00001463 5A                      		pop	dx
 16466 00001464 72EA                    		jb	short IOCtl_If6
 16467                                  					; Valid? (0F0h-0FFh?)
 16468 00001466 803E[6701]F0            		cmp	byte [disksector+15h], 0F0h
 16469                                  					; [disksector+EXT_BOOT.BPB+EBPB.MEDIADESCRIPTOR]
 16470 0000146B 72E1                    		jb	short IOCtl_If7	; Brif not
 16471                                  
 16472                                  		; 24/12/2023
 16473                                  		;cmp	byte [disksector+26h], 29h ; [disksector+EXT_BOOT.SIG]
 16474                                  		;			; EXT_BOOT_SIGNATURE
 16475                                  		;jnz	short IOCtl_If7	; not extended boot record
 16476                                  		
 16477 0000146D 06                      		push	es		; Save BDS pointer
 16478 0000146E 57                      		push	di
 16479 0000146F 1E                      		push	ds		; Point	ES To boot record
 16480 00001470 07                      		pop	es
 16481                                  
 16482                                  		; 24/12/2023
 16483                                  		;;;
 16484                                  		;mov	di, disksector+43h ; disksector+EXT_BOOT.SERIAL
 16485 00001471 BF[9401]                		mov	di, disksector+42h ; BS_FAT32_BootSig ; 24/12/2023 
 16486 00001474 833E[6801]00            		cmp	word [disksector+16h], 0 ; BPB.FATSz16
 16487 00001479 7403                    		jz      short IOCtl_If5	; FAT32 fs
 16488 0000147B 83EF1C                  		sub	di, 1Ch		; 67-28 ; offset disksektor+27h
 16489                                  		; di = disksector+26h = BS_BootSig ; 24/12/2023
 16490                                  IOCtl_If5:
 16491                                  		;cmp	byte [di-1], 29h ; BS_BootSig or BS_FAT32_BootSig
 16492 0000147E 803D29                  		cmp	byte [di], 29h
 16493 00001481 7404                    		je	short IOCtl_If8
 16494 00001483 5F                      		pop	di		; not extended boot record
 16495 00001484 07                      		pop	es
 16496                                  		;jmp	short IOCtl_If7
 16497                                  		; 24/12/2023
 16498 00001485 EBC6                    		jmp	short IOCtl_If2
 16499                                  IOCtl_If8:
 16500                                  		;;;
 16501                                  		; 24/12/2023
 16502                                  		;mov	di, disksector+27h ; disksector+EXT_BOOT.SERIAL
 16503 00001487 47                      		inc	di
 16504                                  		; di = disksector+27h (BS_VolID)
 16505                                  		;      or disksector+43h (BS_FAT32_VolID)
 16506                                  
 16507 00001488 C536[1200]              		lds	si, [ptrsav]	; ds:si	points to request header.
 16508 0000148C C57413                  		lds	si, [si+19]	; [si+IOCTL_REQ.GENERICIOCTL_PACKET]
 16509 0000148F 83C602                  		add	si, 2		; A_MEDIA_ID_INFO.MI_SERIAL
 16510                                  		
 16511                                  		; 24/12/2023
 16512                                  		;mov	cx, 23		; size_of_EXT_BOOT_SERIAL
 16513                                  		;			; +size_of_EXT_BOOT_VOL_LABEL
 16514                                  		;			; +size_of_EXT_SYSTEM_ID
 16515                                  		;rep movsb
 16516 00001492 E8B2FF                  		call	IOCtl_If4       ; copy volume serial, label and system id
 16517                                  
 16518 00001495 06                      		push	es		; point	ds back	to Bios_Data
 16519 00001496 1F                      		pop	ds
 16520 00001497 5F                      		pop	di		; restore bds pointer
 16521 00001498 07                      		pop	es
 16522 00001499 E8B3F3                  		call	mov_media_ids	; update the bds media id info.
 16523 0000149C 88D0                    		mov	al, dl
 16524 0000149E C606[2001]03            		mov	byte [rflag], 3	; romwrite
 16525 000014A3 E80600                  		call	BootIo		; write	it back.
 16526 000014A6 C606[1E01]FF            		mov	byte [tim_drv], 0FFh
 16527                                  					; make sure chk_media check the driver
 16528                                  					; return with error code from BootIo
 16529 000014AB C3                      		retn
 16530                                  ; ---------------------------------------------------------------------------
 16531                                  
 16532                                  		; 24/12/2023
 16533                                  ;IOCtl_If7:
 16534                                  ;		mov	al, 7		; error_unknown_media
 16535                                  ;		stc
 16536                                  ;IOCtl_If6:
 16537                                  ;		retn
 16538                                  
 16539                                  ; =============== S U B	R O U T	I N E =======================================
 16540                                  
 16541                                  ; =============== S U B	R O U T	I N E =======================================
 16542                                  
 16543                                  ; 16/10/2022
 16544                                  
 16545                                  ; ---------------------------------------------------------------------------
 16546                                  ;	BootIo
 16547                                  ; ---------------------------------------------------------------------------
 16548                                  ;
 16549                                  ; function: read/write the boot record into boot sector.
 16550                                  ;
 16551                                  ; input :
 16552                                  ;	    al=logical drive number
 16553                                  ;	    rFlag = operation (read/write)
 16554                                  ;
 16555                                  ; output:   for read operation,the boot record of the drive specified in bds
 16556                                  ;	    be read into the DiskSector buffer.
 16557                                  ;	    for write operation,the DiskSector buffer image will be written
 16558                                  ;	    to the drive specified in bds.
 16559                                  ;	    if carry set,then al contains the device driver error number
 16560                                  ;	    that will be returned to dos.
 16561                                  ;	    AX,CX,DX register destroyed.
 16562                                  ;	    if carry set,then al will contain the error code from DiskIO.
 16563                                  ;
 16564                                  ; subroutines to be called:
 16565                                  ;	DiskIO:NEAR
 16566                                  ;
 16567                                  ; logic:
 16568                                  ;
 16569                                  ; {
 16570                                  ;	first_sector = 0;	 /*logical sector 0 is the boot sector */
 16571                                  ;	sectorcount = 1;	 /*read 1 sector only */
 16572                                  ;	buffer = DiskSector;	 /*read it into the DiskSector buffer */
 16573                                  ;	call DiskIO (rFlag,drive_number,first_sector,sectorcount,buffer);
 16574                                  ; }
 16575                                  ; ==========================================================================
 16576                                  
 16577                                  		; 19/10/2022
 16578                                  BootIo:	
 16579 000014AC 06                      		push	es
 16580 000014AD 57                      		push	di
 16581 000014AE 53                      		push	bx
 16582 000014AF 1E                      		push	ds
 16583 000014B0 07                      		pop	es		; Point ES: to Bios_Data
 16584                                  
 16585                                  		; Call DiskIO to read/write the boot sec. The parameters which
 16586                                  		; need to be initialized for this subroutine out here are
 16587                                  		; - Transfer address to Bios_Data:DiskSector
 16588                                  		; - Low sector needs to be initalized to 0. this is a reg. param
 16589                                  		; - Hi sector in [Start_Sec_H] needs to be initialised to 0.
 16590                                  		; - Number of sectors <-- 1
 16591                                  
 16592 000014B1 BF[5201]                		mov	di, disksector	; es:di -> transfer address
 16593 000014B4 31D2                    		xor	dx, dx		; First	sector (h) -> 0
 16594 000014B6 8916[9C04]              		mov	[start_sec_h], dx ; Start sector (h) -> 0
 16595 000014BA B90100                  		mov	cx, 1
 16596 000014BD E851F5                  		call	diskio
 16597 000014C0 5B                      		pop	bx
 16598 000014C1 5F                      		pop	di
 16599 000014C2 07                      		pop	es
 16600 000014C3 C3                      		retn
 16601                                  
 16602                                  ; =============== S U B	R O U T	I N E =======================================
 16603                                  
 16604                                  ; 16/10/2022
 16605                                  
 16606                                  ; ---------------------------------------------------------------------------
 16607                                  ;	ChangeLineChk
 16608                                  ; ---------------------------------------------------------------------------
 16609                                  ;
 16610                                  ; when the user calls get/set media id call before dos establishes the media
 16611                                  ; by calling "media_chk",the change line activity of the drive is going to be
 16612                                  ; lost.	this routine will check the change line activity and will save the
 16613                                  ; history in the flags.
 16614                                  ;
 16615                                  ; FUNCTION: check the change line error activity
 16616                                  ;
 16617                                  ; INPUT :  ES:di -> bds table.
 16618                                  ;
 16619                                  ; OUTPUT:   flag in bds table will be updated if change line occurs.
 16620                                  ;
 16621                                  ; SUBROUTINES TO BE CALLED:
 16622                                  ;	Set_Changed_DL
 16623                                  ;
 16624                                  ; ---------------------------------------------------------------------------
 16625                                  
 16626                                  		; 24/12/2023 - Retro DOS 5.0
 16627                                  ChangeLineChk:	
 16628 000014C4 268A5504                		mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 16629 000014C8 08D2                    		or	dl, dl		; Fixed	disk?
 16630 000014CA 7821                    		js	short ChangeLnChkRet ; Yes, skip it.
 16631                                  		; 24/12/2023
 16632 000014CC 26F6453F04              		test	byte [es:di+3Fh], 4 ; [es:di+BDS.flags] ; PCDOS 7.1
 16633                                  		; 12/12/2022
 16634                                  		;test	byte [es:di+23h], 4
 16635                                  		;;test	word [es:di+23h], 4 ; [es:di+BDS.flags]
 16636                                  					; return_fake_bpb
 16637 000014D1 751A                    		jnz	short ChangeLnChkRet
 16638 000014D3 803E[7700]01            		cmp	byte [fhave96], 1   ; This rom support change line?
 16639 000014D8 7513                    		jnz	short ChangeLnChkRet
 16640 000014DA E8B207                  		call	haschange	; This drive support change line?
 16641 000014DD 740E                    		jz	short ChangeLnChkRet ; Do nothing
 16642                                  
 16643                                  		; Execute the rom disk interrupt to check changeline activity.
 16644                                  
 16645 000014DF B416                    		mov	ah, 16h
 16646 000014E1 CD13                    		int	13h	; DISK - FLOPPY	DISK - CHANGE OF DISK STATUS (AT,XT2,XT286,CONV,PS)
 16647                                  				; DL = drive to	check
 16648                                  				; Return: AH = disk change status
 16649 000014E3 7308                    		jnb	short ChangeLnChkRet
 16650 000014E5 53                      		push	bx
 16651 000014E6 BB4000                  		mov	bx, 40h		; fchanged
 16652                                  					; Update flag in BDS for this
 16653                                  					; physical drive
 16654 000014E9 E87C07                  		call	set_changed_dl
 16655 000014EC 5B                      		pop	bx
 16656                                  ChangeLnChkRet:				
 16657 000014ED C3                      		retn
 16658                                  
 16659                                  ; ---------------------------------------------------------------------------
 16660                                  
 16661                                  ; 16/10/2022
 16662                                  
 16663                                  ; ==========================================================================
 16664                                  ;	GetAccessFlag
 16665                                  ; ==========================================================================
 16666                                  ;
 16667                                  ; FUNCTION: get the status of UNFORMATTED_MEDIA bit of flags in bds table
 16668                                  ;
 16669                                  ; INPUT :
 16670                                  ;	    ES:di -> bds table
 16671                                  ;
 16672                                  ; OUTPUT:   a_DiskAccess_Control.dac_access_flag = 0 if disk i/o not allowed.
 16673                                  ;						 = 1 if disk i/o allowed.
 16674                                  ; ==========================================================================
 16675                                  
 16676                                  		; 24/12/2023 - Retro DOS 5.0
 16677                                  
 16678                                  		; 19/10/2022
 16679                                  GetAccessFlag:				
 16680 000014EE C51E[1200]              		lds	bx, [ptrsav]	; DS:BX	points to request header
 16681 000014F2 C55F13                  		lds	bx, [bx+19]	; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 16682                                  		;mov	al, 0		; Assume result	is unformatted
 16683                                  		; 10/12/2022
 16684 000014F5 28C0                    		sub	al, al
 16685                                  		; 24/12/2023
 16686 000014F7 26F6454002              		test	byte [es:di+40h], 02h ; (PCDOS 7.1 IBMBIO.COM)
 16687                                  		;test	word ptr es:[di+3Fh], 200h
 16688                                  		; 10/12/2022
 16689                                  		;test	byte [es:di+36], 02h
 16690                                  		;;test	word [es:di+35], 200h ; [es:di+BDS.flags]
 16691                                  					; unformatted_media
 16692 000014FC 7501                    		jnz	short GafDone	; Done if unformatted
 16693                                  		;inc	al		; Return true for formatted
 16694                                  		; 24/12/2023
 16695 000014FE 40                      		inc	ax
 16696                                  GafDone:				
 16697 000014FF 884701                  		mov	[bx+1],	al	; [bx+A_DISKACCESS_CONTROL.DAC_ACCESS_FLAG]
 16698 00001502 C3                      		retn
 16699                                  ; ---------------------------------------------------------------------------
 16700                                  
 16701                                  ; 16/10/2022
 16702                                  
 16703                                  ; ==========================================================================
 16704                                  ;	SetAccessFlag
 16705                                  ; ==========================================================================
 16706                                  ;
 16707                                  ; function: set/reset the UNFORMATTED_MEDIA bit of flags in bds table
 16708                                  ;
 16709                                  ; input :
 16710                                  ;	    ES:di -> bds table
 16711                                  ;
 16712                                  ; output:   unformtted_media bit modified according to the user request
 16713                                  ; ==========================================================================
 16714                                  
 16715                                  		; 24/12/2023 - Retro DOS 5.0
 16716                                  
 16717                                  		; 19/10/2022
 16718                                  SetAccessFlag:				
 16719 00001503 C51E[1200]              		lds	bx, [ptrsav]	; ES:BX	points to request header
 16720 00001507 C55F13                  		lds	bx, [bx+19]	; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 16721                                  		; 24/12/2023
 16722 0000150A 26806540FD              		and	byte [es:di+40h], 0FDh ; (PCDOS 7.1 IBMBIO.COM)
 16723                                  		;and	word ptr es:[di+3Fh], 0FDFFh
 16724                                  		; 10/12/2022
 16725                                  		;and	byte [es:di+36], 0FDh
 16726                                  		;;and	word [es:di+35], 0FDFFh ; [es:di+BDS.flags]
 16727                                  					; ~unformatted_media
 16728 0000150F 807F0100                		cmp	byte [bx+1], 0	; [bx+A_DISKACCESS_CONTROL.DAC_ACCESS_FLAG]
 16729 00001513 750A                    		jnz	short saf_Done
 16730                                  		; 24/12/2023
 16731 00001515 26804D4002              		or	byte [es:di+40h], 02h ; (PCDOS 7.1 IBMBIO.COM)
 16732                                  		;or	word ptr es:[di+3Fh], 200h
 16733                                  		; 10/12/2022
 16734 0000151A 26804D2402              		or	byte [es:di+36], 02h
 16735                                  		;or	word [es:di+35], 200h ; [es:di+BDS.flags]
 16736                                  					; unformatted_media
 16737                                  saf_Done:				
 16738 0000151F C3                      		retn
 16739                                  ; ---------------------------------------------------------------------------
 16740                                  
 16741                                  ; 16/10/2022
 16742                                  
 16743                                  ; ==========================================================================
 16744                                  ; Ioctl_Support_Query
 16745                                  ; ==========================================================================
 16746                                  ;
 16747                                  ; New device command which was added in DOS 5.00 to allow a query of a 
 16748                                  ; specific GENERIC IOCtl to see if it is supported. Bit 7 in the
 16749                                  ; device attributes specifies if this function is supported.
 16750                                  ;
 16751                                  ; ==========================================================================
 16752                                  
 16753                                  		; 24/12/2023 - Retro DOS 5.0
 16754                                  
 16755                                  		; 19/10/2022
 16756                                  ioctl_support_query:
 16757 00001520 06                      		push	es
 16758 00001521 C41E[1200]              		les	bx, [ptrsav]	; ES:BX Points to request header.
 16759 00001525 268B470D                		mov	ax, [es:bx+13]	; [es:bx+IOCTL_REQ.MAJORFUNCTION]
 16760                                  					; AL ==	Major, AH == Minor
 16761                                  		; 24/12/2023
 16762                                  		; 02/09/2023 (PCDOS 7.1)
 16763 00001529 3C48                    		cmp	al, 48h		; IOC_NEW_DC (PCDOS 7.1)
 16764                                  					; new generic ioctl function (FAT32)
 16765 0000152B 7404                    		je	short ioctl_support
 16766                                  
 16767 0000152D 3C08                    		cmp	al, 8		; IOC_DC
 16768                                  					; See if major code is 8
 16769 0000152F 7513                    		jne	short nosupport
 16770                                  ioctl_support:
 16771 00001531 0E                      		push	cs
 16772 00001532 07                      		pop	es
 16773                                  		; 24/12/2023
 16774                                  		; 02/09/2023
 16775 00001533 B90E00                  		mov	cx, 14          ; (PCDOS 7.1) IOC_DC_TABLE_LEN
 16776                                  		;mov	cx, 11		; IOC_DC_TABLE_LEN
 16777                                  		; 10/12/2022
 16778 00001536 BF[BC0E]                		mov	di, IOC_DC_Table
 16779                                  		;mov	di, 0C60h	; IOC_DC_Table
 16780                                  					; at 2C7h:0C60h	= 70h:31D0h
 16781 00001539 86C4                    		xchg	al, ah		; Put minor code in AL
 16782 0000153B F2AE                    		repne scasb		; Scan for minor code in AL
 16783 0000153D 7505                    		jnz	short nosupport	; it was not found
 16784 0000153F B80001                  		mov	ax, 100h
 16785                                  		; 10/12/2022
 16786                                  		; (jump to ioctlsupexit is not required)
 16787                                  		;jmp	short $+2	; ioctlsupexit
 16788                                  					; Signal ioctl is supported
 16789                                  		;;jmp	short ioctlsupexit
 16790                                  ; ---------------------------------------------------------------------------
 16791                                  ioctlsupexit:
 16792 00001542 07                      		pop	es
 16793                                  		; 10/12/2022
 16794                                  		; cf = 0
 16795                                  		;clc
 16796 00001543 C3                      		retn
 16797                                  ; ---------------------------------------------------------------------------
 16798                                  nosupport:
 16799 00001544 07                      		pop	es
 16800 00001545 E98DEB                  		jmp	bc_cmderr
 16801                                  ; ---------------------------------------------------------------------------
 16802                                  
 16803                                  ; 16/10/2022
 16804                                  
 16805                                  ; ==========================================================================
 16806                                  ;	GetMediaSenseStatus
 16807                                  ; ==========================================================================
 16808                                  ;
 16809                                  ; FUNCTION: Will return the type of diskette media in the specified DOS
 16810                                  ;	    diskette drive and whether the media is the default type
 16811                                  ;	    for that drive. (default type means the max size for that
 16812                                  ;	    drive)
 16813                                  ;
 16814                                  ; INPUT :   ES:DI -> BDS table
 16815                                  ; OUTPUT:   If carry clear
 16816                                  ;	    DS:BX -> Updated IOCtlPacket
 16817                                  ;
 16818                                  ;			 Special Function at offset 0:
 16819                                  ;				0	- Media detected is not default type
 16820                                  ;				1	- Media detected is default type
 16821                                  ;
 16822                                  ;			 Device Type at offset 1:
 16823                                  ;				2       - 720K 3.5" 80 tracks
 16824                                  ;				7	- 1.44M 3.5" 80 tracks
 16825                                  ;				9	- 2.88M 3.5" 80 tracks
 16826                                  ;
 16827                                  ; Error Codes returned in AX if carry set:
 16828                                  ;
 16829                                  ; 8102 - Drive not ready	- No disk is in the drive.
 16830                                  ; 8107 - Unknown media type	- Drive doesn't support this function or
 16831                                  ;				  the media is really unkown, any error
 16832                                  ;				  other than "media not present"
 16833                                  ; 
 16834                                  ; ==========================================================================
 16835                                  
 16836                                  		; 19/10/2022
 16837                                  SenseMediaType:
 16838 00001548 C51E[1200]              		lds	bx, [ptrsav]	; DS:BX	points to request header.
 16839 0000154C C55F13                  		lds	bx, [bx+19]	; bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 16840                                  		; 10/10/2022
 16841                                  		;mov	word [bx], 0	; Initialize the 2 packet bytes
 16842 0000154F 31D2                    		xor	dx, dx
 16843 00001551 8917                    		mov	[bx], dx ; 0
 16844                                  		;
 16845 00001553 268A5504                		mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 16846                                  					; Get int 13h drive number from	BDS
 16847                                  		; 10/12/2022
 16848                                  		;xor	dh, dh		; DX = physical	drive number
 16849 00001557 B420                    		mov	ah, 20h		; Get Media Type function
 16850                                  					; If no	carry media type in AL
 16851 00001559 CD13                    		int	13h		; DISK - QCACHE	- DISMOUNT
 16852 0000155B 7216                    		jc	short MediaSenseEr ; error code	in AH
 16853 0000155D FE07                    		inc	byte [bx]	; Signal media type is default (bit 1)
 16854                                  DetermineMediaType:
 16855 0000155F FEC8                    		dec	al
 16856 00001561 3C02                    		cmp	al, 2		; Chk for 720K ie: (3-1) = 2
 16857 00001563 740A                    		jz	short GotMediaType
 16858 00001565 0404                    		add	al, 4
 16859 00001567 3C07                    		cmp	al, 7		; Chk for 1.44M ie: (4-1+4) = 7
 16860 00001569 7404                    		jz	short GotMediaType
 16861 0000156B 3C09                    		cmp	al, 9		; Chk for 2.88M	ie: (6-1+4) = 9
 16862 0000156D 7510                    		jnz	short UnknownMediaType ; Just didn't recognize media type
 16863                                  GotMediaType:
 16864 0000156F 884701                  		mov	[bx+1],	al	; Save the return value
 16865                                  		; 10/12/2022
 16866                                  		; cf = 0
 16867                                  		;clc			; Signal success
 16868 00001572 C3                      		retn
 16869                                  ; ---------------------------------------------------------------------------
 16870                                  
 16871                                  MediaSenseEr:
 16872 00001573 80FC32                  		cmp	ah, 32h		; See if not default media error
 16873 00001576 74E7                    		jz	short DetermineMediaType ; Not really an error
 16874 00001578 B002                    		mov	al, 2		; Now assume drive not ready
 16875 0000157A 80FC31                  		cmp	ah, 31h		; See if media was present
 16876 0000157D 7402                    		jz	short SenseErrExit ; Return drive not ready
 16877                                  UnknownMediaType:
 16878 0000157F B007                    		mov	al, 7		; Just don't know the media type
 16879                                  SenseErrExit:
 16880 00001581 B481                    		mov	ah, 81h		; Signal error return
 16881 00001583 F9                      		stc
 16882 00001584 C3                      		retn
 16883                                  
 16884                                  ; ----------------------------------------------------------------------------
 16885                                  		; 10/12/2022
 16886                                  		;db    0
 16887                                  ; ----------------------------------------------------------------------------
 16888                                  
 16889                                  ;-----------------------------------------------------------------------------
 16890                                  ; PCDOS 7.1 IBMBIO.COM - BIOSCODE:15F2h
 16891                                  ;-----------------------------------------------------------------------------
 16892                                  ; 26/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
 16893                                  
 16894                                  ; =============== S U B R O U T I N E =======================================
 16895                                  
 16896                                  SetLockState:
 16897 00001585 C51E[1200]              		lds	bx, [ptrsav]	; set media lock state
 16898 00001589 C55F13                  		lds	bx, [bx+13h]	; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 16899                                  		;mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 16900                                  		;call	check_int13h_exts_present
 16901                                  		; 26/12/2023
 16902 0000158C E82100                  		call	check_int13h_exts_p
 16903                                  		;mov	al, 3		; unknown command error
 16904 0000158F 721C                    		jc	short setlockst_ret
 16905 00001591 8A07                    		mov	al, [bx]	; [bx+A_LOCKSTATE_CONTROL.LOCKSTATE_FUNCTIONS]
 16906 00001593 B445                    		mov	ah, 45h
 16907 00001595 CD13                    		int	13h		; DISK - IBM/MS Extension - LOCK/UNLOCK DRIVE
 16908                                  		; (DL - drive, [SI - disk address packet)
 16909 00001597 884701                  		mov	[bx+1], al	; 1 = locked, 0 = not locked
 16910                                  		; [bx+A_LOCKSTATE_CONTROL.LOCKSTATE_FLAG]
 16911                                  		
 16912                                  		; 26/12/2023
 16913 0000159A EB0A                    		jmp	short sls_em
 16914                                  
 16915                                  ;		jnc	short setlockst_ret
 16916                                  ;		mov	al, ah
 16917                                  ;		call	maperror
 16918                                  ;setlockst_ret:
 16919                                  ;		mov	ah, 81h		; Return this status in case of carry
 16920                                  ;		retn
 16921                                  
 16922                                  ; =============== S U B R O U T I N E =======================================
 16923                                  
 16924                                  EjectMedia:
 16925                                  		;mov	dl, [es:di+4]	; eject media in drive
 16926                                  		;			; [es:di+BDS.drivenum]
 16927                                  		;call	check_int13h_exts_present
 16928                                  		; 26/12/2023
 16929 0000159C E81100                  		call	check_int13h_exts_p
 16930                                  		;mov	al, 3		; unknown command error
 16931 0000159F 720C                    		jc	short ejectm_ret
 16932 000015A1 B80046                  		mov	ax, 4600h
 16933 000015A4 CD13                    		int	13h		; DISK - IBM/MS Extension - EJECT MEDIA
 16934                                  		; (DL - drive)
 16935                                  sls_em:			; 26/12/2023
 16936 000015A6 7305                    		jnc	short ejectm_ret
 16937 000015A8 88E0                    		mov	al, ah
 16938 000015AA E8FBF7                  		call	maperror
 16939                                  setlockst_ret:		; 26/12/2023
 16940                                  ejectm_ret:
 16941 000015AD B481                    		mov	ah, 81h		; Return this status in case of carry
 16942 000015AF C3                      		retn
 16943                                  
 16944                                  ; =============== S U B R O U T I N E =======================================
 16945                                  
 16946                                  		; 26/12/2023
 16947                                  check_int13h_exts_p:
 16948 000015B0 268A5504                		mov	dl, [es:di+4]
 16949                                  
 16950                                  check_int13h_exts_present:
 16951 000015B4 B441                    		mov	ah, 41h
 16952 000015B6 53                      		push	bx
 16953 000015B7 BBAA55                  		mov	bx, 55AAh
 16954 000015BA CD13                    		int	13h		; DISK - Check for INT 13h Extensions
 16955                                  					; BX = 55AAh, DL = drive number
 16956                                  					; Return: CF set if not supported
 16957                                  					; AH = extensions version
 16958                                  					; BX = AA55h
 16959                                  					; CX = Interface support bit map
 16960 000015BC 81FB55AA                		cmp	bx, 0AA55h
 16961 000015C0 5B                      		pop	bx
 16962 000015C1 7505                    		jnz	short exts_notsupported
 16963 000015C3 F6C102                  		test	cl, 2		; bit 1 - drive locking and ejecting subset
 16964 000015C6 7503                    		jnz	short exts_supported
 16965                                  exts_notsupported:
 16966                                  		; 26/12/2023
 16967 000015C8 B003                    		mov	al, 3
 16968                                  		;
 16969 000015CA F9                      		stc
 16970                                  exts_supported:
 16971 000015CB C3                      		retn
 16972                                  
 16973                                  ; =============== S U B R O U T I N E =======================================
 16974                                  
 16975                                  GetDrvMapInfo:
 16976 000015CC 8CD9                    		mov	cx, ds		; get drive map information
 16977                                  					;
 16978                                  					; es:di points to BDS which belongs to
 16979                                  					;	  the requested logical/dos drive number
 16980                                  					;
 16981                                  					; Format of parameter block:
 16982                                  					; Offset  Description (Table 01570)
 16983                                  					;  00h    (call) length of this buffer (in bytes)
 16984                                  					;  01h    (ret) number of bytes in parameter block
 16985                                  					;	    actually used
 16986                                  					;  02h    (ret) drive flags
 16987                                  					;  03h    (ret) physical drive number
 16988                                  					;	    00h-7Fh floppy
 16989                                  					;	    80h-FEh hard
 16990                                  					;	    FFh no physical drive
 16991                                  					;  04h    (ret) bitmap of logical drives associated with
 16992                                  					;	    physical drive
 16993                                  					;	    bit 0 = drive A:, etc.
 16994                                  					;  08h    (ret) relative block address of partition start
 16995                                  					;	    qword
 16996                                  					;
 16997                                  					; Ref: Ralf Brown's Interrupt List, INTERRUP.G
 16998 000015CE C51E[1200]              		lds	bx, [ptrsav]
 16999 000015D2 C55F13                  		lds	bx, [bx+13h]	; [bx+IOCTL_REQ.GENERICIOCTL_PACKET]
 17000 000015D5 B80381                  		mov	ax, 8103h	; ah = generic ioctl error code (81h)
 17001                                  					; al = unknown command error (03h)
 17002 000015D8 803F10                  		cmp	byte [bx], 10h	; parameter buffer length = 16 bytes
 17003 000015DB 7251                    		jb	short gdmi_4
 17004 000015DD 268A5504                		mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 17005 000015E1 885703                  		mov	[bx+3], dl	; parameter block - offset 3 - physical drive number
 17006 000015E4 C6470110                		mov	byte [bx+1], 10h ; parameter block - actually used length
 17007 000015E8 268B4517                		mov	ax, [es:di+17h]	; [es:di+BDS.hiddensectors]
 17008 000015EC 894708                  		mov	[bx+8], ax	; parameter block - offset 8 - partition start LBA
 17009 000015EF 268B4519                		mov	ax, [es:di+19h]	; [es:di+BDS.hiddensectors+2]
 17010 000015F3 89470A                  		mov	[bx+0Ah], ax	; parameter block - offset 10
 17011 000015F6 31C0                    		xor	ax, ax ; 0
 17012 000015F8 884702                  		mov	[bx+2], al	; drive flags = 0 (protected mode flags etc.)
 17013 000015FB 89470C                  		mov	[bx+0Ch], ax	; high dword of partition start address (LBA) is 0
 17014 000015FE 89470E                  		mov	[bx+0Eh], ax
 17015 00001601 894704                  		mov	[bx+4], ax	; logical drive bitmap of same physical drive
 17016                                  					; initialized as 0
 17017 00001604 894706                  		mov	[bx+6], ax ; 0
 17018 00001607 8EC1                    		mov	es, cx
 17019                                  		;les	di, dword ptr es:start_bds ; 1st BDS
 17020 00001609 26C43E[1901]            		les	di, [es:start_bds]
 17021 0000160E B90100                  		mov	cx, 1		; bit 0 (drive A:)
 17022                                  gdmi_1:
 17023 00001611 83FFFF                  		cmp	di, 0FFFFh	; last BDS ?
 17024 00001614 7415                    		jz	short gdmi_3	; yes
 17025 00001616 26385504                		cmp	[es:di+4], dl	; [es:di+BDS.drivenum], dl
 17026                                  					; is it same physical drive ?
 17027 0000161A 7506                    		jnz	short gdmi_2	; no
 17028 0000161C 094F04                  		or	[bx+4], cx	; set bit for logical drive index of this BDS
 17029                                  					; (previously) shifted bit (which is 1/ON) is in ax:cx
 17030 0000161F 094706                  		or	[bx+6], ax
 17031                                  gdmi_2:
 17032 00001622 D1E1                    		shl	cx, 1		; shift one left for setting the next drive's bit
 17033 00001624 D1D0                    		rcl	ax, 1		; set high word of the bit select (set) value
 17034 00001626 26C43D                  		les	di, [es:di]	; next BDS
 17035 00001629 EBE6                    		jmp	short gdmi_1	; loop until di = -1 (last BDS sign)
 17036                                  gdmi_3:
 17037 0000162B B80001                  		mov	ax, 100h	; success
 17038                                  gdmi_4:
 17039 0000162E C3                      		retn
 17040                                  
 17041                                  ;-----------------------------------------------------------------------------
 17042                                  
 17043                                  ; 16/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 17044                                  ; 26/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
 17045                                  
 17046                                  ;-----------------------------------------------------------------------------
 17047                                  ; MSINT13.ASM - MSDOS 6.0 - 1991
 17048                                  ;-----------------------------------------------------------------------------
 17049                                  ; 16/03/2019 - Retro DOS v4.0
 17050                                  
 17051                                  ;	int 2f function 13h allows the user to change the orig13 int_13 vector
 17052                                  ;	after booting. this allows testing and implementation of custom int_13
 17053                                  ;	handlers, without giving up ms-dos error recovery
 17054                                  ;	entry:	ds:dx	== addr. of new int_13 handler
 17055                                  ;		es:bx	== addr. of new int_13 vector used by warm boot (int19)
 17056                                  ;	exit:	orig13	== address of new int_13 handler
 17057                                  ;		ds:dx	== old orig13 value
 17058                                  ;		es:bx	== old old13  value
 17059                                  ;
 17060                                  ; int 2f handler for external block drivers to communicate with the internal
 17061                                  ; block driver in msdisk. the multiplex number chosen is 8. the handler
 17062                                  ; sets up the pointer to the request packet in [ptrsav] and then jumps to
 17063                                  ; dsk_entry, the entry point for all disk requests.
 17064                                  ;
 17065                                  ; on exit from this driver, we will return to the external driver
 17066                                  ; that issued this int 2f, and can then remove the flags from the stack.
 17067                                  ; this scheme allows us to have a small external device driver, and makes
 17068                                  ; the maintainance of the various drivers (driver and msbio) much easier,
 17069                                  ; since we only need to make changes in one place (most of the time).
 17070                                  ;
 17071                                  ;   ax=800h - check for installed handler - reserved
 17072                                  ;   ax=801h - install the bds into the linked list
 17073                                  ;   ax=802h - dos request
 17074                                  ;   ax=803h - return bds table starting pointer in ds:di
 17075                                  ;	   (ems device driver hooks int 13h to handle 16kb dma overrun
 17076                                  ;	    problem. bds table is going to be used to get head/sector
 17077                                  ;	    informations without calling generic ioctl get device parm call.)
 17078                                  
 17079                                  ;BIOSSEGMENT equ 70h
 17080                                  DOSBIOSSEG equ 0070h ; 17/10/2022
 17081                                  
 17082                                  ;;BIOSCODE:1302h (MSDOS 6.21, IO.SYS)
 17083                                  ;BIOSCODE:16AAh (PCDOS 7.1, IBMBIO.COM) ; 26/12/2023
 17084                                  
 17085                                  i2f_handler:				; here is 02C7h:1302h =	0070h:3872h
 17086 0000162F 80FC13                  		cmp	ah, 13h
 17087 00001632 7413                    		jz	short int2f_replace_int13
 17088 00001634 80FC08                  		cmp	ah, 8
 17089 00001637 7432                    		jz	short mine
 17090                                  
 17091                                  ; Check for WIN386 startup and return the BIOS instance data
 17092                                  
 17093 00001639 80FC16                  		cmp	ah, 16h		; MultWin386
 17094 0000163C 746D                    		jz	short win386call
 17095 0000163E 80FC4A                  		cmp	ah, 4Ah		; multMULT
 17096 00001641 7503                    		jnz	short i2f_handler_iret
 17097 00001643 E99800                  		jmp	handle_multmult
 17098                                  ; ---------------------------------------------------------------------------
 17099                                  
 17100                                  i2f_handler_iret:			
 17101 00001646 CF                      		iret
 17102                                  ; ---------------------------------------------------------------------------
 17103                                  
 17104                                  int2f_replace_int13:
 17105 00001647 FA                      		cli	; 26/12/2023
 17106 00001648 50                      		push	ax	; free up a register for caller's ds
 17107 00001649 8CD8                    		mov	ax, ds	; then we can use ds: -> Bios_Data
 17108                                  		;;mov	ds, word [cs:0030h] ; 15/10/2022	
 17109                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:0030h]
 17110                                  					; = [02C7h:0030h] = [0070h:25A0h]
 17111 0000164B 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD] ; 17/10/2022
 17112                                  		; 19/10/2022
 17113                                  		;push	word ptr ds:Orig13	; save old value of old13 and
 17114                                  		;push	word ptr ds:Orig13+2	; orig13 so that we can
 17115                                  		;push	word ptr ds:Old13	; return them to caller
 17116                                  		;push	word ptr ds:Old13+2
 17117                                  		
 17118                                  		; 02/09/2023 (PCDOS 7.1)
 17119                                  		;push	word [Orig13]
 17120 00001650 FF36[B600]              		push	word [Orig13+2]
 17121                                  		;push	word [Old13]
 17122 00001654 FF36[0801]              		push	word [Old13+2]
 17123                                  
 17124                                  		;mov	word ptr ds:Orig13, dx	; orig13 := addr. of new int_13
 17125                                  		;mov	word ptr ds:Orig13+2, ax
 17126                                  		;mov	word ptr ds:Old13, bx	; old13 := addr. of new boot_13
 17127                                  		;mov	word ptr ds:Old13+2, es
 17128                                  		
 17129                                  		;mov	[Orig13], dx
 17130                                  		; 02/09/2023
 17131 00001658 8716[B400]              		xchg	dx, [Orig13]
 17132 0000165C A3[B600]                		mov	[Orig13+2], ax
 17133                                  		;mov	[Old13], bx
 17134                                  		; 02/09/2023
 17135 0000165F 871E[0601]              		xchg	bx, [Old13]
 17136 00001663 8C06[0801]              		mov	[Old13+2], es
 17137                                  
 17138 00001667 07                      		pop	es			; es:bx := old old13 vector
 17139                                  		; 02/09/2023
 17140                                  		;pop	bx
 17141 00001668 1F                      		pop	ds			; ds:dx := old orig13 vector
 17142                                  		;pop	dx ; 02/09/2023
 17143 00001669 58                      		pop	ax
 17144                                  i2f_iret:
 17145 0000166A CF                      		iret
 17146                                  ; ---------------------------------------------------------------------------
 17147                                  
 17148                                  mine:
 17149 0000166B 3CF8                    		cmp	al, 0F8h 		; iret on reserved functions
 17150 0000166D 73FB                    		jnb	short i2f_iret
 17151 0000166F 08C0                    		or	al, al			; a get installed state request?
 17152 00001671 7503                    		jnz	short disp_func
 17153 00001673 B0FF                    		mov	al, 0FFh
 17154                                  		;jmp	short i2f_iret
 17155                                  		; 02/09/2023
 17156 00001675 CF                      		iret
 17157                                  ; ---------------------------------------------------------------------------
 17158                                  
 17159                                  disp_func:
 17160 00001676 3C01                    		cmp	al, 1			; request for installing bds?
 17161 00001678 7418                    		jz	short do_subfun_01
 17162 0000167A 3C03                    		cmp	al, 3			; get bds vector?
 17163 0000167C 7423                    		jz	short do_get_bds_vector
 17164                                  
 17165                                  ; set up pointer to request packet
 17166                                  
 17167 0000167E 1E                      		push	ds
 17168 0000167F 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD] ; 17/10/2022
 17169                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 17170                                  					; = [0070h:25A0h] = [02C7h:0030h]
 17171                                  		; 19/10/2022
 17172                                  		;mov	word ptr ds:ptrsav, bx
 17173                                  		;mov	word ptr ds:ptrsav+2, es
 17174 00001684 891E[1200]              		mov	[ptrsav], bx
 17175 00001688 8C06[1400]              		mov	[ptrsav+2], es
 17176 0000168C 1F                      		pop	ds
 17177                                  		;jmp	far ptr	i2f_dskentry
 17178                                  		; 07/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 17179                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:1708h
 17180 0000168D EA[5E06]7000            		jmp	DOSBIOSSEG:dsk_entry ; BIOSDATA:dsk_entry
 17181                                  		;; 17/10/2022
 17182                                  		;;jmp	far DOSBIOSSEG:dsk_entry
 17183                                  		;jmp	DOSBIOSSEG:i2f_dskentry ; 70h:i2f_dskentry
 17184                                  					; NOTE: jump to a FAR function, not an
 17185                                  					;  IRET type function. Callers of
 17186                                  					;  this int2f subfunction will have
 17187                                  					;  to be careful to do a popf
 17188                                  
 17189                                  ; ---------------------------------------------------------------------------
 17190                                  
 17191                                  do_subfun_01:
 17192 00001692 06                      		push	es
 17193 00001693 1E                      		push	ds
 17194 00001694 1E                      		push	ds
 17195 00001695 07                      		pop	es
 17196                                  		; 17/10/2022
 17197 00001696 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 17198                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 17199                                  					; point	ds: -> Bios_Data
 17200 0000169B E8BC03                  		call	install_bds
 17201 0000169E 1F                      		pop	ds
 17202 0000169F 07                      		pop	es
 17203                                  		;jmp	short i2f_iret
 17204                                  		; 02/09/2023
 17205 000016A0 CF                      		iret
 17206                                  ; ---------------------------------------------------------------------------
 17207                                  
 17208                                  do_get_bds_vector:
 17209                                  		; 17/10/2022
 17210 000016A1 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 17211                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 17212 000016A6 C53E[1901]              		lds	di, [start_bds]
 17213                                  		;lds	di, ds:start_bds
 17214                                  ;ii2f_iret:	; 10/12/2022
 17215                                  		;jmp	short i2f_iret
 17216                                  		; 02/09/2023
 17217 000016AA CF                      		iret
 17218                                  ; ---------------------------------------------------------------------------
 17219                                  
 17220                                  ; 17/10/2022
 17221                                  ; 16/10/2022
 17222                                  
 17223                                  ; WIN386 startup stuff is done here. If starting up we set our WIN386 present
 17224                                  ; flag and return instance data. If exiting, we reset the WIN386 present flag
 17225                                  ; NOTE: We assume that the BIOS int 2fh is at the bottom of the chain.
 17226                                  
 17227                                  win386call:
 17228 000016AB 1E                      		push	ds
 17229 000016AC 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 17230                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 17231                                  					; at 2C7h:30h =	70h:25A0h
 17232 000016B1 3C05                    		cmp	al, 5		; Win386_Init
 17233                                  					; is it	win386 initializing?
 17234 000016B3 7410                    		jz	short Win386Init
 17235 000016B5 3C06                    		cmp	al, 6		; Win386_Exit
 17236                                  					; is it	win386 exiting?
 17237 000016B7 7523                    		jnz	short win_iret	; if not, continue int2f chain
 17238                                  		; 12/12/2022
 17239 000016B9 F6C201                  		test	dl, 1
 17240                                  		;test	dx, 1		; is it	win386 or win286 dos extender?
 17241 000016BC 751E                    		jnz	short win_iret	; if not win386, then continue
 17242                                  		;and	ds:IsWin386, 0	; indicate that	win386 is not present  
 17243 000016BE 8026[1208]00            		and	byte [IsWin386], 0 
 17244 000016C3 EB17                    		jmp	short win_iret
 17245                                  ; ---------------------------------------------------------------------------
 17246                                  
 17247                                  Win386Init:
 17248                                  		; 12/12/2022
 17249 000016C5 F6C201                  		test	dl, 1
 17250                                  		;test	dx, 1		; is it win386 or win286 dos extender?
 17251 000016C8 7512                    		jnz	short win_iret	; if not win386, then continue
 17252                                  		;or	ds:IsWin386, 1	; Indicate WIN386 present
 17253 000016CA 800E[1208]01            		or	byte [IsWin386], 1
 17254                                  		;mov	word ptr ds:SI_Next, bx	; Hook our structure into chain
 17255                                  		;mov	word ptr ds:SI_Next+2, es
 17256 000016CF 891E[E007]              		mov	[SI_Next], bx
 17257 000016D3 8C06[E207]              		mov	[SI_Next+2], es
 17258                                  		;mov	bx, offset Win386_SI ; point ES:BX to Win386_SI
 17259 000016D7 BB[DE07]                		mov	bx, Win386_SI	; 19/10/2022
 17260 000016DA 1E                      		push	ds
 17261 000016DB 07                      		pop	es
 17262                                  win_iret:
 17263 000016DC 1F                      		pop	ds
 17264                                  ii2f_iret:	; 10/12/2022
 17265                                  		;jmp	short i2f_iret	; return back up the chain
 17266                                  		; 02/09/2023
 17267 000016DD CF                      		iret
 17268                                  ; ---------------------------------------------------------------------------
 17269                                  
 17270                                  handle_multmult:
 17271 000016DE 3C01                    		cmp	al, 1
 17272 000016E0 7514                    		jnz	short try_2
 17273 000016E2 1E                      		push	ds
 17274 000016E3 E84500                  		call	HMAPtr		; get offset of free HMA
 17275                                  		; 10/12/2022
 17276                                  		;xor	bx, bx
 17277                                  		;dec	bx
 17278 000016E6 BBFFFF                  		mov	bx, 0FFFFh
 17279 000016E9 8EC3                    		mov	es, bx		; seg of HMA
 17280 000016EB 89FB                    		mov	bx, di
 17281 000016ED F7D3                    		not	bx
 17282 000016EF 09DB                    		or	bx, bx
 17283 000016F1 7401                    		jz	short try_1
 17284 000016F3 43                      		inc	bx
 17285                                  try_1:
 17286 000016F4 1F                      		pop	ds
 17287                                  		;jmp	short ii2f_iret
 17288                                  		; 02/09/2023
 17289 000016F5 CF                      		iret
 17290                                  ; ---------------------------------------------------------------------------
 17291                                  
 17292                                  try_2:
 17293 000016F6 3C02                    		cmp	al, 2		; multMULTALLOCHMA
 17294 000016F8 7530                    		jnz	short try_3
 17295 000016FA 1E                      		push	ds
 17296                                  		; 10/12/2022
 17297                                  		;xor	di, di
 17298                                  		;dec	di
 17299 000016FB BFFFFF                  		mov	di, 0FFFFh	; assume not enough space
 17300 000016FE 8EC7                    		mov	es, di
 17301 00001700 E82800                  		call	HMAPtr		; get offset of free HMA
 17302 00001703 83FFFF                  		cmp	di, 0FFFFh
 17303 00001706 7421                    		jz	short InsuffHMA
 17304 00001708 F7DF                    		neg	di		; free space in HMA
 17305 0000170A 39FB                    		cmp	bx, di
 17306 0000170C 7605                    		jbe	short try_4
 17307                                  		; 10/12/2022
 17308                                  		;sub	di, di
 17309                                  		;dec	di
 17310 0000170E BFFFFF                  		mov	di, 0FFFFh
 17311                                  		;jmp	short InsuffHMA
 17312                                  		; 02/09/2023
 17313 00001711 1F                      		pop	ds
 17314 00001712 CF                      		iret
 17315                                  ; ---------------------------------------------------------------------------
 17316                                  
 17317                                  try_4:
 17318                                  		;mov	di, ds:FreeHMAPtr
 17319 00001713 8B3E[D707]              		mov	di, [FreeHMAPtr]
 17320 00001717 83C30F                  		add	bx, 15
 17321                                  		;and	bx, 0FFF0h
 17322                                  		; 10/12/2022
 17323 0000171A 80E3F0                  		and	bl, 0F0h
 17324                                  		;add	ds:FreeHMAPtr, bx ; update the free pointer
 17325 0000171D 011E[D707]              		add	[FreeHMAPtr], bx
 17326 00001721 7506                    		jnz	short InsuffHMA
 17327 00001723 C706[D707]FFFF          		mov	word [FreeHMAPtr], 0FFFFh ; -1
 17328                                  		;mov	ds:FreeHMAPtr, 0FFFFh
 17329                                  					; no more HMA if we have wrapped
 17330                                  InsuffHMA:
 17331 00001729 1F                      		pop	ds
 17332                                  		; 10/12/2022
 17333                                  try_3:
 17334                                  		;jmp	short ii2f_iret
 17335                                  		; 02/09/2023
 17336 0000172A CF                      		iret
 17337                                  ; ---------------------------------------------------------------------------
 17338                                  
 17339                                  		; 10/12/2022
 17340                                  ;try_3:
 17341                                  		;jmp	ii2f_iret
 17342                                  
 17343                                  ; =============== S U B	R O U T	I N E =======================================
 17344                                  
 17345                                  ; 16/10/2022
 17346                                  
 17347                                  ;--------------------------------------------------------------------------
 17348                                  ;
 17349                                  ; procedure : HMAPtr
 17350                                  ;
 17351                                  ;		Gets the offset of the free HMA area ( with respect to
 17352                                  ;							seg ffff )
 17353                                  ;		If DOS has not moved high, tries to move DOS high.
 17354                                  ;		In the course of doing this, it will allocate all the HMA
 17355                                  ;		and set the FreeHMAPtr to past the end of the BIOS and 
 17356                                  ;		DOS code. The call to MoveDOSIntoHMA (which is a pointer)
 17357                                  ;		enters the routine in sysinit1 called FTryToMovDOSHi.
 17358                                  ;
 17359                                  ;	RETURNS : offset of free HMA in DI
 17360                                  ;		  BIOS_DATA, seg in DS
 17361                                  ;
 17362                                  ;--------------------------------------------------------------------------
 17363                                  
 17364                                  		; 17/10/2022
 17365                                  HMAPtr:
 17366 0000172B 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 17367                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:Bios_Data_Word]
 17368 00001730 8B3E[D707]              		mov	di, [FreeHMAPtr]
 17369                                  		;mov	di, ds:FreeHMAPtr
 17370 00001734 83FFFF                  		cmp	di, 0FFFFh
 17371 00001737 750F                    		jnz	short HMAPtr_retn
 17372 00001739 803E[DD07]00            		cmp	byte [SysinitPresent], 0
 17373                                  		;cmp	ds:SysinitPresent, 0
 17374 0000173E 7408                    		jz	short HMAPtr_retn
 17375 00001740 FF1E[D907]              		call	far [MoveDOSIntoHMA]
 17376                                  		;call	ds:MoveDOSIntoHMA ; call far [MoveDOSIntoHMA]
 17377 00001744 8B3E[D707]              		mov	di, [FreeHMAPtr]
 17378                                  		;mov	di, ds:FreeHMAPtr
 17379                                  HMAPtr_retn:
 17380 00001748 C3                      		retn
 17381                                  
 17382                                  ; =============== S U B	R O U T	I N E =======================================
 17383                                  
 17384                                  ; 16/10/2022
 17385                                  
 17386                                  ; move a 512 byte sector from ds:si to es:di, do not trash cx
 17387                                  ; but go ahead and update direction flag, si, & di
 17388                                  
 17389                                  move_sector:
 17390                                  
 17391                                  ; The 80386 microprocessor considers an access to WORD 0FFFFh in
 17392                                  ; any segment to be a fault. Theoretically, this could be handled
 17393                                  ; by the fault handler and the behavior of an 8086 could be emulated
 17394                                  ; by wrapping the high byte to offset 0000h. This would be a lot
 17395                                  ; of work and was, indeed, blown off by the Win386 guys. COMPAQ
 17396                                  ; also handles the fault incorrectly in their ROM BIOS for real
 17397                                  ; mode. Their fault handler was only designed to deal with one
 17398                                  ; special case which occurred in a magazine benchmark, but didn't
 17399                                  ; handle the general case worth beans.
 17400                                  ;
 17401                                  ; Simply changing this code to do a byte loop would work okay but
 17402                                  ; would involve a general case performance hit. Therefore, we'll
 17403                                  ; check for either source or destination offsets being within one
 17404                                  ; sector of the end of their segments and only in that case fall
 17405                                  ; back to a byte move.
 17406                                  
 17407 00001749 FC                      		cld
 17408 0000174A 51                      		push	cx
 17409 0000174B B90001                  		mov	cx, 256
 17410 0000174E 81FE00FE                		cmp	si, 0FE00h
 17411 00001752 770A                    		ja	short movsec_bytes
 17412 00001754 81FF00FE                		cmp	di, 0FE00h
 17413 00001758 7704                    		ja	short movsec_bytes
 17414 0000175A F3A5                    		rep movsw
 17415 0000175C 59                      		pop	cx
 17416 0000175D C3                      		retn
 17417                                  ; ---------------------------------------------------------------------------
 17418                                  
 17419                                  movsec_bytes:
 17420 0000175E D1E1                    		shl	cx, 1
 17421 00001760 F3A4                    		rep movsb
 17422 00001762 59                      		pop	cx
 17423 00001763 C3                      		retn
 17424                                  
 17425                                  ; =============== S U B	R O U T	I N E =======================================
 17426                                  
 17427                                  ; 16/10/2022
 17428                                  
 17429                                  ; check_wrap is a routine that adjusts the starting sector, starting head
 17430                                  ; and starting cylinder for an int 13 request that requests i/o of a lot
 17431                                  ; of sectors. it only does this for fixed disks. it is used in the sections
 17432                                  ; of code that handle ecc errors and dma errors. it is necessary, because
 17433                                  ; ordinarily the rom would take care of wraps around heads and cylinders,
 17434                                  ; but we break down a request when we get an ecc or dma error into several
 17435                                  ; i/o of one or more sectors. in this case, we may already be beyond the
 17436                                  ; number of sectors on a track on the medium, and the request would fail.
 17437                                  ;
 17438                                  ; input conditions:
 17439                                  ;	all registers set up for an int 13 request.
 17440                                  ;
 17441                                  ; output:
 17442                                  ;	dh - contains starting head number for request
 17443                                  ;	cx - contains starting sector and cylinder numbers
 17444                                  ;	(the above may or may not have been changed, and are 0-based)
 17445                                  ;	all other registers preserved.
 17446                                  
 17447                                  		; 26/12/2023 - Retro DOS 5.0
 17448                                  check_wrap:	
 17449 00001764 50                      		push	ax
 17450 00001765 53                      		push	bx
 17451 00001766 06                      		push	es
 17452 00001767 57                      		push	di
 17453 00001768 E86C00                  		call	find_bds	; get pointer to bds for drive in dl
 17454 0000176B 725E                    		jb	short no_wrap	; finished if DOS doesn't use it
 17455                                  		; 26/12/2023
 17456 0000176D 26F6453F01              		test	byte [es:di+3Fh], 1
 17457                                  		; 12/12/2022
 17458                                  		;test	byte [es:di+23h], 1
 17459                                  		;;test	word [es:di+23h], 1 ; [es:di+BDS.flags],fnon_removable
 17460 00001772 7457                    		jz	short no_wrap	; no wrapping for removable media
 17461 00001774 268B5D13                		mov	bx, [es:di+13h]	; [es:di+BDS.secpertrack]
 17462 00001778 89C8                    		mov	ax, cx
 17463 0000177A 83E03F                  		and	ax, 3Fh		; extract sector number
 17464 0000177D 39D8                    		cmp	ax, bx		; are we going to wrap?
 17465 0000177F 764A                    		jbe	short no_wrap
 17466 00001781 F6F3                    		div	bl		; ah=new sector	#, al=#	of head	wraps
 17467                                  
 17468                                  ; we need to be careful here. if the new sector # is 0, then we are on the
 17469                                  ; last sector on that track.
 17470                                  
 17471 00001783 08E4                    		or	ah, ah
 17472 00001785 7503                    		jnz	short not_on_bound
 17473                                  		; 18/12/2022
 17474 00001787 48                      		dec	ax ; *
 17475 00001788 88DC                    		mov	ah, bl		; set sector=BDS_BPB.BPB_SECTORSPERTRACK
 17476                                  					; if on	boundary
 17477                                  		;dec	al ; *		; also decrement # of head wraps
 17478                                  not_on_bound:
 17479 0000178A 80E1C0                  		and	cl, 0C0h	; zero out sector #
 17480 0000178D 08E1                    		or	cl, ah		; or in	new sector #
 17481 0000178F 30E4                    		xor	ah, ah		; ax = # of head wraps
 17482 00001791 40                      		inc	ax
 17483 00001792 00F0                    		add	al, dh		; add in starting head #
 17484 00001794 80D400                  		adc	ah, 0		; catch	any carry
 17485                                  		; 02/09/2023
 17486 00001797 268B5D15                		mov	bx, [es:di+15h]	; [es:di+BDS.heads]
 17487 0000179B 39D8                    		cmp	ax, bx
 17488                                  		;cmp	ax, [es:di+15h]	; [es:di+BDS.heads]
 17489                                  					; are we going to wrap around a	head?
 17490 0000179D 7632                    		jbe	short no_wrap_head ; do	not lose new head number!!
 17491 0000179F 52                      		push	dx		; preserve drive number and head number
 17492 000017A0 31D2                    		xor	dx, dx
 17493                                  		;mov	bx, [es:di+15h]	; [es:di+BDS.heads]
 17494 000017A2 F7F3                    		div	bx		; dx=new head #, ax=# of cylinder wraps
 17495                                  
 17496                                  ; careful here! if new head # is 0, then we are on the last head.
 17497                                  
 17498 000017A4 09D2                    		or	dx, dx
 17499 000017A6 7507                    		jnz	short no_head_bound
 17500 000017A8 89DA                    		mov	dx, bx		; on boundary. set to BDS_BPB.BPB_HEADS
 17501                                  
 17502                                  ; if we had some cylinder wraps, we need to reduce them by one!!
 17503                                  
 17504 000017AA 09C0                    		or	ax, ax
 17505 000017AC 7401                    		jz	short no_head_bound
 17506 000017AE 48                      		dec	ax		; reduce number	of cylinder wraps
 17507                                  no_head_bound:				
 17508 000017AF 88D7                    		mov	bh, dl		; bh has new head number
 17509 000017B1 5A                      		pop	dx		; restore drive number and head number
 17510 000017B2 FECF                    		dec	bh		; get it 0-based
 17511 000017B4 88FE                    		mov	dh, bh		; set up new head number in dh
 17512 000017B6 88CF                    		mov	bh, cl
 17513 000017B8 80E73F                  		and	bh, 3Fh		; preserve sector number
 17514 000017BB B306                    		mov	bl, 6
 17515 000017BD 86CB                    		xchg	cl, bl
 17516 000017BF D2EB                    		shr	bl, cl		; get ms cylinder bits to ls end
 17517 000017C1 00C5                    		add	ch, al		; add in cylinder wrap
 17518 000017C3 10E3                    		adc	bl, ah		; add in high byte
 17519 000017C5 D2E3                    		shl	bl, cl		; move up to ms	end
 17520 000017C7 86D9                    		xchg	bl, cl		; restore cylinder bits	into cl
 17521 000017C9 08F9                    		or	cl, bh		; or in	sector number
 17522                                  no_wrap:				
 17523 000017CB F8                      		clc
 17524 000017CC 5F                      		pop	di
 17525 000017CD 07                      		pop	es
 17526 000017CE 5B                      		pop	bx
 17527 000017CF 58                      		pop	ax
 17528 000017D0 C3                      		retn
 17529                                  ; ---------------------------------------------------------------------------
 17530                                  
 17531                                  no_wrap_head:				
 17532 000017D1 88C6                    		mov	dh, al		; do not lose new head number
 17533 000017D3 FECE                    		dec	dh		; get it 0-based
 17534 000017D5 EBF4                    		jmp	short no_wrap
 17535                                  
 17536                                  ; =============== S U B	R O U T	I N E =======================================
 17537                                  
 17538                                  ; 16/10/2022
 17539                                  
 17540                                  ; this is a special version of the bds lookup code which is
 17541                                  ; based on physical drives rather than the usual logical drives
 17542                                  ; carry is set if the physical drive in dl is found, es:di -> its bds
 17543                                  ; otherwise carry is clear
 17544                                  ;
 17545                                  ; guaranteed to trash no registers except es:di
 17546                                  
 17547                                  		; 19/10/2022
 17548                                  find_bds:	
 17549 000017D7 C43E[1901]              		les	di, [start_bds]	; point es:di to first bds
 17550                                  fbds_1:					
 17551 000017DB 26385504                		cmp	[es:di+4], dl	; [es:di+BDS.drivenum]
 17552 000017DF 7409                    		jz	short fdbs_2
 17553 000017E1 26C43D                  		les	di, [es:di]	; [es:di+BDS.link]
 17554                                  					; go to next bds
 17555 000017E4 83FFFF                  		cmp	di, 0FFFFh
 17556 000017E7 75F2                    		jnz	short fbds_1
 17557 000017E9 F9                      		stc
 17558                                  fdbs_2:					
 17559 000017EA C3                      		retn
 17560                                  
 17561                                  ; =============== S U B	R O U T	I N E =======================================
 17562                                  
 17563                                  ; 16/10/2022
 17564                                  		; 17/10/2022
 17565                                  doint:
 17566                                  		; 10/12/2022
 17567 000017EB 8A5608                  		mov	dl, [bp+8]	; [bp+INT13FRAME.olddx]
 17568                                  					; get physical drive number
 17569                                  		; 19/10/2022 - Temporary !
 17570                                  		;db	8Ah, 96h, 8, 0	; mov dl, [bp+8]	
 17571                                  		
 17572 000017EE 30E4                    		xor	ah, ah
 17573 000017F0 08C0                    		or	al, al
 17574 000017F2 7410                    		jz	short dointdone	; if zero sectors, return ax=0
 17575                                  		; 10/12/2022
 17576 000017F4 8A6603                  		mov	ah, [bp+3]	; [bp+INT13FRAME.oldax+1]
 17577                                  					; get request code
 17578                                  		;db	8Ah, 0A6h, 3, 0	; mov ah, [bp+3]
 17579 000017F7 FF7610                  		push	word [bp+10h]	; [bp+INT13FRAME.oldf]
 17580                                  		;db	0FFh, 0B6h, 10h, 0 ; push word [bp+10h]
 17581 000017FA 9D                      		popf
 17582                                  		;call	far 70h:797h ; MSDOS 6.21 IO.SYS BIOSCODE:14EAh
 17583                                  		; 17/10/2022
 17584 000017FB 9A[0B07]7000            		call	DOSBIOSSEG:call_orig13
 17585                                  		;;call	call_orig13	; call far 70h:797h
 17586                                  					; call far KERNEL_SEGMENT:call_orig13
 17587 00001800 9C                      		pushf
 17588                                  		; 10/12/2022
 17589 00001801 8F4610                  		pop	word [bp+10h]	; [bp+INT13FRAME.oldf]
 17590                                  		;db	8Fh, 86h, 10h, 0 ; pop word [bp+10h]
 17591                                  dointdone:				
 17592 00001804 C3                      		retn
 17593                                  
 17594                                  ;----------------------------------------------------------------------------
 17595                                  
 17596                                  ; 16/10/2022
 17597                                  
 17598                                  ; this is the true int 13 handler. we parse the request to see if there is
 17599                                  ; a dma violation. if so, depending on the function, we:
 17600                                  ;   read/write break the request into three pieces and move the middle one
 17601                                  ;	       into our internal buffer.
 17602                                  ;
 17603                                  ;   format     copy the format table into the buffer
 17604                                  ;   verify     point the transfer address into the buffer
 17605                                  ;
 17606                                  ; this is the biggest bogosity of all. the ibm controller does not handle
 17607                                  ; operations that cross physical 64k boundaries. in these cases, we copy
 17608                                  ; the offending sector into the buffer below and do the i/o from there.
 17609                                  
 17610                                  ;struc INT13FRAME
 17611                                  ;.oldbp: resw
 17612                                  ;.oldax: resw 
 17613                                  ;.oldbx: resw
 17614                                  ;.oldcx: resw
 17615                                  ;.olddx: resw
 17616                                  ;.oldds: resw	; now we save caller's ds, too
 17617                                  ;.olddd: resd
 17618                                  ;.oldf:	resw
 17619                                  ;end struc
 17620                                  
 17621                                  ;----------------------------------------------------------------------------
 17622                                  
 17623                                  ;   entry conditions:
 17624                                  ;	ah = function
 17625                                  ;	al = number of sectors
 17626                                  ;	es:bx = dma address
 17627                                  ;	cx = packed track and sector
 17628                                  ;	dx = head and drive
 17629                                  ;   output conditions:
 17630                                  ;	no dma violation.
 17631                                  
 17632                                  ;	use extreme caution when working with this code. In general,
 17633                                  ;	  all registers are hot at all times.
 17634                                  ;
 17635                                  ;	question:  does this code handle cases where dma errors
 17636                                  ;	  occur during ecc retries, and where ecc errors occur during
 17637                                  ;	  dma breakdowns???? Hmmmmm.
 17638                                  
 17639                                  ;----------------------------------------------------------------------------
 17640                                  
 17641                                  ; ---------------------------------------------------------------------------
 17642                                  
 17643                                  		; 26/12/2023 - Retro DOS v5.0
 17644                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:1889h
 17645                                  dtype_array:
 17646 00001805 90004000                		dd 400090h		; 40h:90h is drive type array addr
 17647                                  
 17648                                  ; 17/10/2022
 17649                                  ;DTYPEARRAY equ dtype_array - DOSBIOSEG_2C7h ; (14F5h for MSDOS 5.0 IO.SYS)
 17650                                  ; 09/12/2022
 17651                                  DTYPEARRAY equ dtype_array
 17652                                  
 17653                                  ; ---------------------------------------------------------------------------
 17654                                  
 17655                                  ; stick some special stuff out of mainline
 17656                                  
 17657                                  ; we know we're doing a format command. if we have changeline
 17658                                  ; support, then flag some special changed stuff and set changed
 17659                                  ; by format bit for all logical drives using this physical drive
 17660                                  
 17661                                  format_special_stuff:
 17662 00001809 803E[7700]00            		cmp	byte [fhave96], 0	; do we have changeline support?
 17663 0000180E 7459                    		jz	short format_special_stuff_done ; brif not
 17664 00001810 53                      		push	bx
 17665 00001811 BB4001                  		mov	bx, 140h	; fchanged_by_format+fchanged
 17666 00001814 E85104                  		call	set_changed_dl	; indicate that media changed by format
 17667 00001817 5B                      		pop	bx
 17668 00001818 EB4F                    		jmp	short format_special_stuff_done
 17669                                  ; ---------------------------------------------------------------------------
 17670                                  
 17671                                  ; 16/10/2022
 17672                                  
 17673                                  ; we know we've got ec35's on the system. Now see if we're doing
 17674                                  ; a floppy. If so, create a mask and see if this particular
 17675                                  ; drive is an ec35. If so, set dtype_array[drive]=93h
 17676                                  
 17677                                  		; 19/10/2022
 17678                                  ec35_special_stuff:
 17679 0000181A 84D2                    		test	dl, dl		; floppy or hard disk?
 17680 0000181C 7852                    		js	short ec35_special_stuff_done ;	if hard	drive, we're done
 17681 0000181E 50                      		push	ax		; see if this PARTICULAR drive is ec35
 17682 0000181F 51                      		push	cx
 17683 00001820 88D1                    		mov	cl, dl		; turn drive number into bit map
 17684 00001822 B001                    		mov	al, 1		; assume drive 0
 17685 00001824 D2E0                    		shl	al, cl		; shift	over correct number of times
 17686 00001826 8406[A204]              		test	[ec35flag], al	; electrically compatible 3.5 incher?
 17687 0000182A 59                      		pop	cx
 17688 0000182B 58                      		pop	ax
 17689 0000182C 7442                    		jz	short ec35_special_stuff_done
 17690                                  					; done if this floppy is not an	ec35
 17691 0000182E 53                      		push	bx		; free up a far	pointer	(es:bx)
 17692 0000182F 06                      		push	es
 17693                                  		; 17/10/2022
 17694 00001830 2EC41E[0518]            		les	bx, [cs:DTYPEARRAY]
 17695                                  		;les	bx, dword ptr cs:DTYPEARRAY ; [cs:dtype_array]
 17696                                  					; 0070h:3A65h =	2C7h:14F5h
 17697 00001835 00D3                    		add	bl, dl
 17698 00001837 80D700                  		adc	bh, 0		; find entry for this drive
 17699 0000183A 26C60793                		mov	byte [es:bx], 93h ; establish drive type as:
 17700                                  					; (360k	disk in	360k drive,
 17701                                  					; no double-stepping, 250 kbs transfer rate)
 17702 0000183E 07                      		pop	es
 17703 0000183F 5B                      		pop	bx
 17704 00001840 EB2E                    		jmp	short ec35_special_stuff_done
 17705                                  ; ---------------------------------------------------------------------------
 17706                                  
 17707                                  ; 16/10/2022
 17708                                  
 17709                                  ; ps2_30 machine has some problem with ah=8h (read drive parm), int 13h.
 17710                                  ; this function does not reset the common buses after the execution.
 17711                                  ; to solve this problem, when we detect ah=8h, then we will save the result and
 17712                                  ; will issue ah=1 (read status) call to reset the buses.
 17713                                  
 17714                                  ps2_special_stuff:
 17715 00001842 803E[1E00]08            		cmp	byte [prevoper], 8 ; (ps2_30)
 17716                                  					; read driver parm ?
 17717 00001847 7407                    		jz	short ps2_30_problem
 17718 00001849 803E[1E00]15            		cmp	byte [prevoper], 15h
 17719                                  					; apparently function 15h fails, too
 17720 0000184E 752D                    		jnz	short ps2_special_stuff_done
 17721                                  ps2_30_problem:
 17722 00001850 50                      		push	ax
 17723 00001851 B401                    		mov	ah, 1
 17724                                  		; 26/12/2023
 17725                                  		;call	70h:70Bh ; PCDOS 7.1 IBMBIO.COM BIOSCODE:18D7h
 17726                                  		;		 ; call BIOSDATA:call_orig13	
 17727                                  		;;call	far 70:797h ; MSDOS 6.21 IO.SYS BIOSCODE:1543h
 17728                                  		; 17/10/2022
 17729 00001853 9A[0B07]7000            		call	DOSBIOSSEG:call_orig13
 17730                                  		;call	call_orig13	; call far 70:797h
 17731                                  					; call far KERNEL_SEGMENT:call_orig13
 17732 00001858 58                      		pop	ax
 17733 00001859 EB22                    		jmp	short ps2_special_stuff_done
 17734                                  ; ---------------------------------------------------------------------------
 17735                                  
 17736                                  ; 17/10/2022
 17737                                  ; 16/10/2022
 17738                                  
 17739                                  ; here is the actual int13 handler
 17740                                  
 17741                                  i13z:					; 0070h:3ABBh =	02C7h:154Bh
 17742                                  
 17743                                  ; cas -- inefficient! could push ds and load ds-> Bios_Data before
 17744                                  ; vectoring up here from Bios_Data
 17745                                  
 17746                                  		; 19/10/2022
 17747 0000185B 1E                      		push	ds		; save caller's ds register first thing
 17748                                  		;;mov	ds, word [cs:0030h]
 17749                                  					; and set up our own ds -> Bios_Data
 17750 0000185C 2E8E1E[3000]            		mov	ds, [cs:BIOSDATAWORD]
 17751                                  		;mov	ds, word ptr cs:BIOSDATAWORD ; [cs:0030h]
 17752                                  					; = [02C7h:0030h] = [0070h:25A0h]
 17753                                  
 17754                                  ; let the operation proceed. if there is a dma violation, then we do things
 17755                                  
 17756 00001861 A3[1E00]                		mov	[prevoper], ax	; save request
 17757 00001864 80FC05                  		cmp	ah, 5		; romformat
 17758 00001867 74A0                    		jz	short format_special_stuff
 17759                                  					; go do special stuff for format
 17760                                  format_special_stuff_done:
 17761 00001869 803E[A204]00            		cmp	byte [ec35flag], 0 ; any electrically compat 3.5 inchers?
 17762 0000186E 75AA                    		jnz	short ec35_special_stuff
 17763                                  					; go handle it out of line if so
 17764                                  ec35_special_stuff_done:
 17765                                  		; 26/12/2023
 17766                                  		;call	70h:70Bh ; PCDOS 7.1 IBMBIO.COM BIOSCODE:18EDh
 17767                                  		;;call	far 70:797h ; MSDOS 6.21 IO.SYS BIOSCODE:1560h
 17768 00001870 9A[0B07]7000            		call	DOSBIOSSEG:call_orig13
 17769                                  		;call	call_orig13	; call far KERNEL_SEGMENT:call_orig13
 17770                                  		
 17771 00001875 9C                      		pushf			; save result flags
 17772                                  		
 17773 00001876 803E[AF05]FA            		cmp	byte [model_byte], 0FAh ; is this a ps2/30?
 17774                                  					; mdl_ps2_30
 17775 0000187B 74C5                    		jz	short ps2_special_stuff
 17776                                  					; exit mainline to address special
 17777                                  ps2_special_stuff_done:			; ps2/30 problem if so
 17778 0000187D 9D                      		popf
 17779 0000187E 7221                    		jb	short goterr13	; error	on original orig13 call-thru?
 17780                                  ret_from_i13:
 17781 00001880 1F                      		pop	ds
 17782 00001881 CA0200                  		retf	2		; restore ds &	iret w/flags
 17783                                  ; ---------------------------------------------------------------------------
 17784                                  
 17785                                  ; most of our code exits through here. If carry isn't set, then
 17786                                  ; just do a simple exit. Else doublecheck that we aren't getting
 17787                                  ; a changeline error.
 17788                                  
 17789                                  i13ret_ck_chglinerr:			
 17790 00001884 73FA                    		jnb	short ret_from_i13 ; done if not an error termination
 17791                                  i13_ret_error:				
 17792 00001886 80FC06                  		cmp	ah, 6		; did i	see a change event?
 17793 00001889 7513                    		jnz	short int13b	; skip if wrong	error
 17794 0000188B 08D2                    		or	dl, dl		; is this for the hard disk?
 17795 0000188D 780F                    		js	short int13b	; yes, ignore
 17796 0000188F 803E[7700]00            		cmp	byte [fhave96], 0
 17797 00001894 7408                    		jz	short int13b	; just in case ROM returned this
 17798                                  					; error	even though it told us it
 17799                                  					; never	would
 17800 00001896 53                      		push	bx
 17801 00001897 BB4000                  		mov	bx, 40h		; fchanged
 17802 0000189A E8CB03                  		call	set_changed_dl
 17803 0000189D 5B                      		pop	bx
 17804                                  int13b:
 17805 0000189E F9                      		stc			; now return the error
 17806 0000189F EBDF                    		jmp	short ret_from_i13
 17807                                  ; ---------------------------------------------------------------------------
 17808                                  
 17809                                  ; some kind of error occurred. see if it is dma violation
 17810                                  
 17811                                  goterr13:
 17812 000018A1 80FC09                  		cmp	ah, 9		; dma error?
 17813 000018A4 747C                    		jz	short gotdmaerr
 17814                                  goterr13_xxxx:
 17815 000018A6 80FC11                  		cmp	ah, 11h		; ecc error?
 17816 000018A9 75DB                    		jnz	short i13_ret_error ; other error. just	return back.
 17817 000018AB 803E[A905]01            		cmp	byte [media_set_for_format], 1 ; formatting?
 17818 000018B0 74D4                    		jz	short i13_ret_error
 17819                                  
 17820 000018B2 803E[1F00]02            		cmp	byte [prevoper+1], 2
 17821                                  		;cmp	byte ptr ds:prevoper+1,	2 ; ecc-corrected error
 17822                                  					; (2 = romread)
 17823                                  					; ECC correction only applies to reads
 17824 000018B7 75CD                    		jnz	short i13_ret_error
 17825                                  
 17826 000018B9 30E4                    		xor	ah, ah
 17827                                  		;;call	far 70:797h ; MSDOS 6.21 IO.SYS BIOSCODE:15ABh
 17828                                  		; 17/10/2022
 17829 000018BB 9A[0B07]7000            		call	DOSBIOSSEG:call_orig13
 17830                                  		;call	call_orig13	; call far KERNEL_SEGMENT:call_orig13
 17831                                  					; call far 70:797h
 17832 000018C0 A1[1E00]                		mov	ax, [prevoper]
 17833 000018C3 30E4                    		xor	ah, ah		; return code =	no error
 17834 000018C5 3C01                    		cmp	al, 1		; if request for one sector, assume ok
 17835 000018C7 74B7                    		jz	short ret_from_i13 ; return with carry clear
 17836 000018C9 53                      		push	bx
 17837 000018CA 51                      		push	cx
 17838 000018CB 52                      		push	dx
 17839 000018CC A2[2000]                		mov	[number_of_sec], al
 17840                                  loop_ecc:
 17841 000018CF B80102                  		mov	ax, 201h	; read one sector
 17842                                  
 17843                                  ; we do reads one sector at a time. this ensures that we will eventually
 17844                                  ; finish the request since ecc errors on one sector do read in that sector.
 17845                                  ;
 17846                                  ; we need to put in some "intelligence" into the ecc handler to handle reads
 17847                                  ; that attempt to read more sectors than are available on a particular
 17848                                  ; track.
 17849                                  ;
 17850                                  ; we call check_wrap to set up the sector #, head # and cylinder # for
 17851                                  ; this request.
 17852                                  ;
 17853                                  ; at this point, all registers are set up for the call to orig13, except
 17854                                  ; that there may be a starting sector number that is bigger than the number
 17855                                  ; of sectors on a track.
 17856                                  ;
 17857 000018D2 E88FFE                  		call	check_wrap	; get correct parameters for int 13
 17858                                  		;;call	far 70:797h ; MSDOS 6.21 IO.SYS BIOSCODE:15C5h
 17859                                  		; 17/10/2022
 17860 000018D5 9A[0B07]7000            		call	DOSBIOSSEG:call_orig13
 17861                                  		;call	call_orig13	; call far KERNEL_SEGMENT:call_orig13
 17862 000018DA 730C                    		jnb	short ok11_op
 17863 000018DC 80FC09                  		cmp	ah, 9		; DMA error during ECC read?
 17864 000018DF 741B                    		jz	short handle_dma_during_ecc
 17865 000018E1 80FC11                  		cmp	ah, 11h		; only allow ecc errors
 17866 000018E4 7510                    		jnz	short ok11_exit_err
 17867                                  		; 10/12/2022
 17868                                  		; xor ax ax -> ah = 0
 17869                                  		;mov	ah, 0		; ecc error. reset the system again.
 17870 000018E6 31C0                    		xor	ax, ax		; clear	the error code so that if this
 17871                                  					; was the last sector, no error	code
 17872                                  					; will be returned for the corrected
 17873                                  					; read.	(clear carry too.)
 17874                                  ok11_op:
 17875 000018E8 FE0E[2000]              		dec	byte [number_of_sec]
 17876 000018EC 7409                    		jz	short ok11_exit	; all done?
 17877 000018EE FEC1                    		inc	cl		; advance sector number
 17878                                  					; add 200h to address
 17879 000018F0 FEC7                    		inc	bh
 17880 000018F2 FEC7                    		inc	bh
 17881 000018F4 EBD9                    		jmp	short loop_ecc
 17882                                  ; ---------------------------------------------------------------------------
 17883                                  
 17884                                  ; locate error returns centrally
 17885                                  
 17886                                  ok11_exit_err:
 17887 000018F6 F9                      		stc			; set carry bit again.
 17888                                  ok11_exit:
 17889 000018F7 5A                      		pop	dx
 17890 000018F8 59                      		pop	cx
 17891 000018F9 5B                      		pop	bx
 17892 000018FA EB88                    		jmp	short i13ret_ck_chglinerr
 17893                                  ; ---------------------------------------------------------------------------
 17894                                  
 17895                                  ; do the single sector read again, this time into our temporary
 17896                                  ; buffer, which is guaranteed not to have a DMA error, then
 17897                                  ; move the data to its proper location and proceed
 17898                                  
 17899                                  handle_dma_during_ecc:
 17900 000018FC 06                      		push	es
 17901 000018FD 53                      		push	bx
 17902 000018FE BB[5201]                		mov	bx, disksector
 17903 00001901 1E                      		push	ds
 17904 00001902 07                      		pop	es		; point es:bx to buffer
 17905 00001903 B80102                  		mov	ax, 201h	; read one sector
 17906                                  		;;call	far 70:797h ; MSDOS 6.21 IO.SYS BIOSCODE:15F8h
 17907                                  		; 17/10/2022
 17908 00001906 9A[0B07]7000            		call	DOSBIOSSEG:call_orig13
 17909                                  		;call	call_orig13	; call far KERNEL_SEGMENT:call_orig13
 17910 0000190B 5B                      		pop	bx
 17911 0000190C 07                      		pop	es
 17912 0000190D 7305                    		jnb	short handle_dma_during_ecc_noerr
 17913 0000190F 80FC11                  		cmp	ah, 11h
 17914 00001912 75E2                    		jnz	short ok11_exit_err ; if anything but ecc error, bomb out
 17915                                  
 17916                                  ; now we're kosher. Copy the data to where it belongs and resume
 17917                                  ; the ECC looping code.
 17918                                  
 17919                                  handle_dma_during_ecc_noerr:
 17920 00001914 56                      		push	si
 17921 00001915 57                      		push	di
 17922 00001916 89DF                    		mov	di, bx
 17923 00001918 BE[5201]                		mov	si, disksector
 17924 0000191B E82BFE                  		call	move_sector
 17925 0000191E 5F                      		pop	di
 17926 0000191F 5E                      		pop	si
 17927 00001920 EBC6                    		jmp	short ok11_op
 17928                                  ; ---------------------------------------------------------------------------
 17929                                  
 17930                                  ; we truly have a dma violation. restore register ax and retry the
 17931                                  ; operation as best we can.
 17932                                  
 17933                                  gotdmaerr:
 17934 00001922 A1[1E00]                		mov	ax, [prevoper]	; 19/10/2022
 17935 00001925 FB                      		sti
 17936 00001926 80FC02                  		cmp	ah, 2		; romread
 17937 00001929 723B                    		jb	short i13_done_dmaerr
 17938                                  					; just pass dma error thru for
 17939                                  					; functions we don't handle
 17940 0000192B 80FC04                  		cmp	ah, 4		; romverify
 17941 0000192E 743C                    		jz	short intverify
 17942 00001930 80FC05                  		cmp	ah, 5		; romformat
 17943 00001933 7448                    		jz	short intformat
 17944 00001935 772F                    		ja	short i13_done_dmaerr
 17945                                  
 17946                                  ; we are doing a read/write call. check for dma problems
 17947                                  
 17948                                  ;	******** set up stack frame here!!! ********
 17949                                  
 17950 00001937 52                      		push	dx
 17951 00001938 51                      		push	cx
 17952 00001939 53                      		push	bx
 17953 0000193A 50                      		push	ax
 17954 0000193B 55                      		push	bp
 17955 0000193C 89E5                    		mov	bp, sp
 17956 0000193E 8CC2                    		mov	dx, es		; check	for 64k	boundary error
 17957                                  		; 26/12/2023
 17958                                  		;add	dx, dx
 17959                                  		;add	dx, dx
 17960                                  		;add	dx, dx
 17961                                  		;add	dx, dx		; dx = dx*16
 17962 00001940 D1E2                    		shl	dx, 1
 17963 00001942 D1E2                    		shl	dx, 1
 17964 00001944 D1E2                    		shl	dx, 1
 17965 00001946 D1E2                    		shl	dx, 1		; segment converted to absolute	address
 17966 00001948 01DA                    		add	dx, bx		; combine with offset
 17967 0000194A 81C2FF01                		add	dx, 511		; simulate a transfer
 17968                                  
 17969                                  ; if carry is set, then we are within 512 bytes of the end of the segment.
 17970                                  ; we skip the first transfer and perform the remaining buffering and transfer
 17971                                  
 17972 0000194E 7303                    		jnb	short no_skip_first
 17973 00001950 E98300                  		jmp	bufferx		; restore dh=head & do buffer
 17974                                  ; ---------------------------------------------------------------------------
 17975                                  
 17976                                  no_skip_first:
 17977 00001953 D0EE                    		shr	dh, 1		; dh = number of sectors before	address
 17978 00001955 B480                    		mov	ah, 128		; ah = max number of sectors in	segment
 17979 00001957 28F4                    		sub	ah, dh
 17980                                  
 17981                                  ; ah is now the number of sectors that we can successfully write in this
 17982                                  ; segment. if this number is above or equal to the requested number, then we
 17983                                  ; continue the operation as normal. otherwise, we break it into pieces.
 17984                                  ;
 17985                                  ; wait a sec. this is goofy. the whole reason we got here in the
 17986                                  ; first place is because we got a dma error. so it's impossible
 17987                                  ; for the whole block to fit, unless the dma error was returned
 17988                                  ; in error.
 17989                                  
 17990 00001959 38C4                    		cmp	ah, al		; can we fit it	in?
 17991 0000195B 7236                    		jb	short doblock	; no, perform blocking.
 17992                                  
 17993                                  ; yes, the request fits. let it happen.
 17994                                  
 17995 0000195D 8A7609                  		mov	dh, [bp+9]	; [bp+INT13FRAME.olddx+1]
 17996                                  					; set up head number
 17997 00001960 E888FE                  		call	doint
 17998 00001963 E9D900                  		jmp	bad13		; and return from this place
 17999                                  ; ---------------------------------------------------------------------------
 18000                                  
 18001                                  i13_done_dmaerr:
 18002 00001966 B409                    		mov	ah, 9		; pass dma error thru to caller
 18003 00001968 F9                      		stc
 18004 00001969 E914FF                  		jmp	ret_from_i13	; return with error,
 18005                                  					; we know it's not a changeline error
 18006                                  ; ---------------------------------------------------------------------------
 18007                                  
 18008                                  ; verify the given sectors. place the buffer pointer into our space.
 18009                                  
 18010                                  intverify:
 18011 0000196C 06                      		push	es		; save caller's dma address
 18012 0000196D 53                      		push	bx
 18013 0000196E 1E                      		push	ds		; es:bx	-> Bios_Data:disksector
 18014 0000196F 07                      		pop	es
 18015                                  dosimple:
 18016 00001970 BB[5201]                		mov	bx, disksector
 18017                                  					; do the i/o from Bios_Data:disksector
 18018                                  		;;call	far 70:797h ; MSDOS 6.21 IO.SYS BIOSCODE:1665h
 18019                                  		; 17/10/2022
 18020 00001973 9A[0B07]7000            		call	DOSBIOSSEG:call_orig13
 18021                                  		;call	call_orig13	; call far KERNEL_SEGMENT:call_orig13
 18022 00001978 5B                      		pop	bx
 18023 00001979 07                      		pop	es
 18024 0000197A E907FF                  		jmp	i13ret_ck_chglinerr
 18025                                  ; ---------------------------------------------------------------------------
 18026                                  
 18027                                  ; format operation. copy the parameter table into Bios_Data:disksector
 18028                                  
 18029                                  intformat:
 18030 0000197D 06                      		push	es
 18031 0000197E 53                      		push	bx
 18032 0000197F 56                      		push	si
 18033 00001980 57                      		push	di
 18034 00001981 1E                      		push	ds
 18035                                  
 18036                                  ; point ds to the caller's dma buffer, es to Bios_Data
 18037                                  ; in other words, swap (ds, es)
 18038                                  
 18039 00001982 06                      		push	es
 18040 00001983 1E                      		push	ds
 18041 00001984 07                      		pop	es
 18042 00001985 1F                      		pop	ds
 18043 00001986 89DE                    		mov	si, bx
 18044 00001988 BF[5201]                		mov	di, disksector
 18045 0000198B E8BBFD                  		call	move_sector	; user's data into Bios_Data:disksector
 18046 0000198E 1F                      		pop	ds
 18047 0000198F 5F                      		pop	di
 18048 00001990 5E                      		pop	si		; do the i/o from
 18049 00001991 EBDD                    		jmp	short dosimple	; Bios_Data:disksector
 18050                                  ; ---------------------------------------------------------------------------
 18051                                  
 18052                                  ; we can't fit the request into the entire block. perform the operation on
 18053                                  ; the first block.
 18054                                  ;
 18055                                  ; doblock is modified to correctly handle multi-sector disk i/o.
 18056                                  ; old doblock had added the number of sectors i/oed (ah in old doblock) after
 18057                                  ; the doint call to cl. observing only the lower 6 bits of cl(=max. 64) can
 18058                                  ; represent a starting sector, if ah was big, then cl would be clobbered.
 18059                                  ; by the way, we still are going to use cl for this purpose since checkwrap
 18060                                  ; routine will use it as an input. to prevent cl from being clobbered, a
 18061                                  ; safe number of sectors should be calculated like "63 - # of sectors/track".
 18062                                  ; doblock will handle the first block of requested sectors within the
 18063                                  ; boundary of this safe value.
 18064                                  
 18065                                  		; 26/12/2023 - Retro DOS v5.0
 18066                                  doblock:
 18067                                  
 18068                                  ; try to get the # of sectors/track from bds via rom drive number.
 18069                                  ; for any mini disks installed, here we have to pray that they have the
 18070                                  ; same # of sector/track as the main dos partition disk drive.
 18071                                  				
 18072 00001993 8B5608                  		mov	dx, [bp+8]	; [bp+INT13FRAME.olddx]
 18073                                  					; get head #, drive #
 18074 00001996 51                      		push	cx
 18075 00001997 06                      		push	es
 18076 00001998 57                      		push	di		; ah - # of sectors before dma boundary
 18077                                  					; al - requested # of sectors for i/o.
 18078 00001999 E83BFE                  		call	find_bds
 18079 0000199C 268B4D13                		mov	cx, [es:di+13h]	; [es:di+BDS.secpertrack]
 18080                                  		; 26/12/2023
 18081 000019A0 26F6453F01              		test	byte [es:di+3Fh], 1
 18082                                  		; 12/12/2022
 18083                                  		;test	byte [es:di+23h], 1
 18084                                  		;;test	word [es:di+23h], 1 ; [es:di+BDS.flags],fnon_removable
 18085 000019A5 5F                      		pop	di
 18086 000019A6 07                      		pop	es
 18087 000019A7 88E0                    		mov	al, ah		; set al=ah for	floppies
 18088 000019A9 7404                    		jz	short doblockflop ; they are track by track operation
 18089 000019AB B43F                    		mov	ah, 63		; ah = 63-secpt	(# safe	sectors??)
 18090 000019AD 28CC                    		sub	ah, cl		; al - # of sectors before dma boundary
 18091                                  doblockflop:
 18092 000019AF 59                      		pop	cx
 18093                                  doblockcontinue:
 18094 000019B0 38C4                    		cmp	ah, al		; if safe_# >= #_of_sectors_to_go_before dma,
 18095 000019B2 7305                    		jnb	short doblocklast ; then #_of_sectors_to_go as it is for doint.
 18096 000019B4 50                      		push	ax
 18097 000019B5 88E0                    		mov	al, ah		; otherwise, set al to ah to operate.
 18098 000019B7 EB03                    		jmp	short doblockdoint
 18099                                  ; ---------------------------------------------------------------------------
 18100                                  
 18101                                  doblocklast:
 18102 000019B9 88C4                    		mov	ah, al
 18103 000019BB 50                      		push	ax
 18104                                  doblockdoint:				; let ah = al =	# of sectors for this shot
 18105 000019BC E82CFE                  		call	doint
 18106 000019BF 727E                    		jb	short bad13	; something happened, bye!
 18107 000019C1 58                      		pop	ax
 18108 000019C2 286602                  		sub	[bp+2],	ah	; sub [bp+INT13FRAME.oldax], ah
 18109                                  					; decrement by the successful operation
 18110 000019C5 00E1                    		add	cl, ah		; advance sector #. safety gauranteed.
 18111 000019C7 00E7                    		add	bh, ah		; advance dma addres
 18112 000019C9 00E7                    		add	bh, ah		; twice	for 512	byte sectors
 18113 000019CB 38C4                    		cmp	ah, al		; check	the previous value
 18114 000019CD 740A                    		jz	short buffer	; if #_of_sectors_to_go	< safe_#,
 18115                                  					; then we are done already.
 18116 000019CF 28E0                    		sub	al, ah		; otherwise,
 18117                                  					; #_sector_to_go = #_of_sector_to_go - safe_#
 18118 000019D1 E890FD                  		call	check_wrap	; get new cx, dh for the next operation.
 18119 000019D4 EBDA                    		jmp	short doblockcontinue ;	handles	next sectors left.
 18120                                  ; ---------------------------------------------------------------------------
 18121                                  
 18122                                  bufferx:
 18123 000019D6 8A7609                  		mov	dh, [bp+9]	; [bp+INT13FRAME.olddx+1]
 18124                                  					; set up head number
 18125                                  buffer:
 18126 000019D9 53                      		push	bx
 18127 000019DA 8A6603                  		mov	ah, [bp+3]	; [bp+INT13FRAME.oldax+1]
 18128 000019DD 80FC03                  		cmp	ah, 3		; romwrite
 18129 000019E0 7525                    		jnz	short doread	;
 18130                                  					
 18131                                  ; copy the offending sector into local buffer
 18132                                  
 18133 000019E2 06                      		push	es
 18134 000019E3 1E                      		push	ds
 18135 000019E4 56                      		push	si
 18136 000019E5 57                      		push	di
 18137 000019E6 1E                      		push	ds		; exchange segment registers
 18138 000019E7 06                      		push	es
 18139 000019E8 1F                      		pop	ds
 18140 000019E9 07                      		pop	es
 18141 000019EA BF[5201]                		mov	di, disksector	; where to move
 18142 000019ED 57                      		push	di		; save it
 18143 000019EE 89DE                    		mov	si, bx		; source
 18144 000019F0 E856FD                  		call	move_sector	; move sector into local buffer
 18145 000019F3 5B                      		pop	bx		; new transfer address
 18146                                  					; (es:bx = Bios_Data:diskbuffer)
 18147 000019F4 5F                      		pop	di		; restore caller's di & si
 18148 000019F5 5E                      		pop	si
 18149 000019F6 1F                      		pop	ds		; restore Bios_Data
 18150                                  
 18151                                  ; see if we are wrapping around a track or head
 18152                                  
 18153 000019F7 B001                    		mov	al, 1		; [bp+INT13FRAME.olddx]
 18154                                  					; get drive number
 18155 000019F9 8A5608                  		mov	dl, [bp+8]
 18156 000019FC E865FD                  		call	check_wrap	; sets up registers if wrap-around
 18157                                  					;
 18158                                  					; ah is	function
 18159                                  					; al is	1 for single sector transfer
 18160                                  					; es:bx	is local transfer addres
 18161                                  					; cx is	track/sector number
 18162                                  					; dx is	head/drive number
 18163                                  					; si,di	unchanged
 18164 000019FF E8E9FD                  		call	doint
 18165 00001A02 07                      		pop	es		; restore caller's dma segment
 18166 00001A03 723A                    		jb	short bad13	; go clean up
 18167 00001A05 EB22                    		jmp	short dotail
 18168                                  ; ---------------------------------------------------------------------------
 18169                                  
 18170                                  ; reading a sector. do int first, then move things around
 18171                                  
 18172                                  doread:
 18173 00001A07 06                      		push	es
 18174 00001A08 53                      		push	bx
 18175 00001A09 1E                      		push	ds		; es = Bios_Code
 18176 00001A0A 07                      		pop	es
 18177 00001A0B BB[5201]                		mov	bx, disksector
 18178 00001A0E B001                    		mov	al, 1
 18179 00001A10 8A5608                  		mov	dl, [bp+8]	; [bp+INT13FRAME.olddx]
 18180                                  					; get drive number
 18181 00001A13 E84EFD                  		call	check_wrap	;
 18182                                  					; ah = function
 18183                                  					; al = 1 for single sector
 18184                                  					; es:bx	points to local	buffer
 18185                                  					; cx, dx are track/sector, head/drive
 18186 00001A16 E8D2FD                  		call	doint
 18187 00001A19 5B                      		pop	bx
 18188 00001A1A 07                      		pop	es
 18189 00001A1B 7222                    		jb	short bad13
 18190 00001A1D 56                      		push	si
 18191 00001A1E 57                      		push	di
 18192 00001A1F 89DF                    		mov	di, bx
 18193 00001A21 BE[5201]                		mov	si, disksector
 18194 00001A24 E822FD                  		call	move_sector
 18195 00001A27 5F                      		pop	di
 18196 00001A28 5E                      		pop	si
 18197                                  
 18198                                  ; note the fact that we've done 1 more sector
 18199                                  
 18200                                  dotail:
 18201 00001A29 5B                      		pop	bx		; retrieve new dma area
 18202 00001A2A 80C702                  		add	bh, 2		; advance over sector
 18203 00001A2D 41                      		inc	cx
 18204 00001A2E 8A4602                  		mov	al, [bp+2]	; [bp+INT13FRAME.oldax]
 18205 00001A31 F8                      		clc
 18206 00001A32 FEC8                    		dec	al
 18207 00001A34 7409                    		jz	short bad13	; no more i/o
 18208                                  
 18209                                  ; see if we wrap around a track or head boundary with starting sector
 18210                                  ; we already have the correct head number to pass to check_wrap
 18211                                  
 18212 00001A36 8A5608                  		mov	dl, [bp+8]	; [bp+INT13FRAME.olddx]
 18213 00001A39 E828FD                  		call	check_wrap
 18214 00001A3C E8ACFD                  		call	doint
 18215                                  
 18216                                  ; we are done. ax has the final code; we throw away what we got before
 18217                                  
 18218                                  ; M046  -- okay gang. Now we've either terminated our DMA loop,
 18219                                  ;	   or we've finished. If carry is set now, our only
 18220                                  ;	   hope for salvation is that it was a read operation
 18221                                  ;	   and the error code is ECC error. In that case, we'll
 18222                                  ;	   just pop the registers and go do the old ECC thing.
 18223                                  ;	   When the DMA error that got us here in the first
 18224                                  ;	   place occurs, it'll handle it.
 18225                                  
 18226                                  bad13:
 18227 00001A3F 89EC                    		mov	sp, bp
 18228 00001A41 5D                      		pop	bp
 18229 00001A42 5B                      		pop	bx
 18230 00001A43 5B                      		pop	bx
 18231 00001A44 59                      		pop	cx
 18232 00001A45 5A                      		pop	dx
 18233 00001A46 7203                    		jb	short xgoterr13_xxxx ; go handle ECC errors
 18234 00001A48 E935FE                  		jmp	ret_from_i13	; non-error exit
 18235                                  ; ---------------------------------------------------------------------------
 18236                                  
 18237                                  xgoterr13_xxxx:	
 18238 00001A4B E958FE                  		jmp	goterr13_xxxx
 18239                                  
 18240                                  ; ---------------------------------------------------------------------------
 18241                                  		; 10/12/2022
 18242                                  		;db 	0
 18243                                  ; ---------------------------------------------------------------------------
 18244                                  
 18245                                  ;Bios_Code ends
 18246                                  
 18247                                  ; 16/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 18248                                  
 18249                                  ;-----------------------------------------------------------------------------
 18250                                  ; MSBIO2.ASM - MSDOS 6.0 - 1991
 18251                                  ;-----------------------------------------------------------------------------
 18252                                  ; 17/03/2019 - Retro DOS v4.0
 18253                                  
 18254                                  		; 19/10/2022
 18255                                  dsk_init:				; 2C7h:1742h = 70h:3CB2h
 18256 00001A4E 8A26[7500]              		mov	ah, [drvmax]
 18257 00001A52 BF[3C05]                		mov	di, dskdrvs
 18258 00001A55 1E                      		push	ds		; pass result in es:di
 18259 00001A56 07                      		pop	es
 18260 00001A57 E930EC                  		jmp	SetPtrSav
 18261                                  
 18262                                  ; =============== S U B	R O U T	I N E =======================================
 18263                                  
 18264                                  ;---------------------------------------------------------------------------
 18265                                  ; install_bds installs a bds at location es:di into the current linked list of
 18266                                  ; bds maintained by this device driver. it places the bds at the end of the
 18267                                  ; list. Trashes (at least) ax, bx, di, si
 18268                                  ;---------------------------------------------------------------------------
 18269                                  
 18270                                  		; 26/12/2023 - Retro DOS v5.0
 18271                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:1AE0h
 18272                                  install_bds:
 18273 00001A5A 1E                      		push	ds		; save Bios_Data segment
 18274 00001A5B BE[1901]                		mov	si, start_bds	; beginning of chain
 18275                                  
 18276                                  		; ds:si now points to link to first bds
 18277                                  		; assume bds list is non-empty
 18278                                  loop_next_bds:
 18279 00001A5E C534                    		lds	si, [si]	; [si+BDS.link]
 18280                                  					; fetch	next bds
 18281 00001A60 268A4504                		mov	al, [es:di+4]	; [es:di+BDS.drivenum]
 18282 00001A64 384404                  		cmp	[si+4],	al	; does this one	share a	physical
 18283                                  					; drive	with new one?
 18284 00001A67 7518                    		jnz	short next_bds
 18285 00001A69 B310                    		mov	bl, 10h		; fi_am_mult
 18286                                  		; 26/12/2023
 18287 00001A6B 26085D3F                		or	[es:di+3Fh], bl
 18288                                  		;or	[es:di+23h], bl	; [es:di+BDS.flags]
 18289                                  					; set both of them to i_am_mult	if so
 18290 00001A6F 085C3F                  		or	[si+3Fh], bl
 18291                                  		;or	[si+23h], bl	; [si+BDS.flags]
 18292 00001A72 2680653FDF              		and	byte [es:di+3Fh], 0DFh
 18293                                  		;and	byte [es:di+23h], 0DFh ; [es:di+BDS.flags],~fi_own_physical
 18294                                  					; we don't own it
 18295 00001A77 8A5C3F                  		mov	bl, [si+3Fh]
 18296                                  		;mov	bl, [si+23h]	; [si+BDS.flags]
 18297                                  					; determine if changeline available
 18298 00001A7A 80E302                  		and	bl, 2		; fchangeline
 18299 00001A7D 26085D3F                		or	[es:di+3Fh], bl
 18300                                  		;or	[es:di+23h], bl	; [es:di+BDS.flags]
 18301                                  next_bds:
 18302                                  		; 02/09/2023 (PCDOS 7.1)
 18303 00001A81 B8FFFF                  		mov	ax, 0FFFFh	; -1
 18304 00001A84 3904                    		cmp	[si], ax	; [si+BDS.link],-1
 18305                                  		;cmp	word [si], 0FFFFh ; [si+BDS.link],-1
 18306                                  					; are we at end	of list?
 18307 00001A86 75D6                    		jnz	short loop_next_bds
 18308 00001A88 8C4402                  		mov	[si+2], es	; [si+BDS.link+2],es
 18309                                  					; install bds
 18310 00001A8B 893C                    		mov	[si], di
 18311 00001A8D 268905                  		mov	[es:di], ax	; [es:di+BDS.link],-1
 18312                                  		;mov	word [es:di], 0FFFFh ; [es:di+BDS.link],-1
 18313                                  					; set next pointer to null
 18314 00001A90 1F                      		pop	ds
 18315                                  
 18316                                  ; 01/07/2023 - Retro DOS v4.2 (MSDOS 6.21 IO.SYS - BIOSCODE:1785h)
 18317                                  ; 16/10/2022 (MSDOS 6.0 Code)
 18318                                  
 18319                                  ; **** If the new drive has a higher EOT value, we must alter the
 18320                                  ;      'eot' variable appropriately.
 18321                                  
 18322                                  		; 26/12/2023
 18323 00001A91 268A4550                		mov	al, [es:di+50h]	; [es:di+BDS.rsecpertrack]
 18324                                  		; 01/06/2019
 18325                                  		;mov	al,[es:di+52]
 18326                                  		; 22/07/2023
 18327                                  		;mov	al,[es:di+BDS.rsecpertrack]
 18328 00001A95 3A06[2C01]              		cmp	al,[eot]
 18329 00001A99 7603                    		jbe	short _eot_ok
 18330 00001A9B A2[2C01]                		mov	[eot],al
 18331                                  _eot_ok:
 18332 00001A9E C3                      		retn
 18333                                  
 18334                                  ; ---------------------------------------------------------------------------
 18335                                  
 18336                                  ; 17/10/2022
 18337                                  ;DRVLET	equ drvlet - DOSBIOSEG_2C7h
 18338                                  ;SNGMSG	equ sngmsg - DOSBIOSEG_2C7h
 18339                                  ; 09/12/2022
 18340                                  DRVLET equ drvlet
 18341                                  SNGMSG equ sngmsg
 18342                                  
 18343                                  ; 16/10/2022
 18344                                  
 18345                                  ;---------------------------------------------------------------------------
 18346                                  ;  ask to swap the disk in drive a:
 18347                                  ;	es:di -> bds
 18348                                  ;	ds -> Bios_Data
 18349                                  ;---------------------------------------------------------------------------
 18350                                  
 18351                                  		; 26/12/2023 - Retro DOS v5.0
 18352                                  
 18353                                  		; 19/10/2022
 18354 00001A9F F606[1208]01            swpdsk:		test	byte [IsWin386], 1
 18355                                  		;test	ds:IsWin386, 1	; Is win386 present?
 18356 00001AA4 7405                    		jz	short no_win386	; no, skip SetFocus
 18357                                  		
 18358                                  		; set focus to the correct VM
 18359                                  		;call	far ptr 70h:813h ; PCDOS 7.1 IBMBIO.COM BIOSCODE:1B2Ch
 18360                                  		;;call	far 70h:8D1h	; MSDOS 6.21 IO.SYS BIOSCODE:179Ah
 18361                                  		; 17/10/2022
 18362 00001AA6 9A[1308]7000            		call	DOSBIOSSEG:V86_Crit_SetFocus ; BIOSDATA:V86_Crit_SetFocus
 18363                                  		;call	far ptr	V86_Crit_SetFocus ; call far 70h:8D1h
 18364                                  					; call far KERNEL_SEGMENT:V86_Crit_SetFocus
 18365                                  no_win386:
 18366 00001AAB 51                      		push	cx
 18367 00001AAC 52                      		push	dx
 18368 00001AAD 268A5505                		mov	dl, [es:di+5]	; [es:di+BDS.drivelet]
 18369                                  					; get the drive	letter
 18370                                  
 18371                                  ; WARNING : next two instructions assume that if the new disk is for drive B
 18372                                  ;           then existing dsk is drive A & vice versa
 18373                                  
 18374 00001AB1 88D6                    		mov	dh, dl
 18375 00001AB3 80F601                  		xor	dh, 1
 18376 00001AB6 29C9                    		sub	cx, cx		; nobody has handled swap disk
 18377 00001AB8 B8004A                  		mov	ax, 4A00h	; multMULT<<8)|multMULTSWPDSK
 18378                                  					; broad	cast code for swap disk
 18379                                  					; Broadcast it
 18380 00001ABB CD2F                    		int	2Fh
 18381 00001ABD 41                      		inc	cx		; cx == -1 ?
 18382 00001ABE 741E                    		jz	short swpdsk9	; somebody has handled it
 18383                                  
 18384                                  ; using a different drive in a one drive system so request the user change disks
 18385                                  
 18386 00001AC0 80C241                  		add	dl, 'A'
 18387                                  		; 17/10/2022
 18388 00001AC3 2E8816[FD1A]            		mov	[cs:DRVLET], dl	; "A: and press any key when ready\r\n\n"
 18389                                  		; 16/10/2022
 18390                                  		;;mov	byte [cs:drvlet], dl
 18391                                  		;mov	byte ptr cs:17E4h, dl ; [cs:drvlet]
 18392                                  					; 0070h:3D54h =	2C7h:17E4h
 18393 00001AC8 BE[E11A]                		mov	si, SNGMSG	; "\r\nInsert diskette for drive "
 18394                                  		;mov	si, 17C8h	; sngmsg
 18395                                  					; 0070h:3D38h =	2C7h:17C8h
 18396 00001ACB 53                      		push	bx
 18397 00001ACC 2E                      		cs
 18398 00001ACD AC                      		lodsb			; get the next character of the message
 18399                                  		;lods	byte ptr cs:[si]
 18400                                  wrmsg_loop:
 18401 00001ACE CD29                    		int	29h		; DOS 2+ internal - FAST PUTCHAR
 18402                                  					; AL = character to display
 18403 00001AD0 2E                      		cs
 18404 00001AD1 AC                      		lodsb
 18405                                  		;lods	byte ptr cs:[si] ; cs lodsb
 18406                                  					; get the next character of the	message
 18407 00001AD2 08C0                    		or	al, al
 18408 00001AD4 75F8                    		jnz	short wrmsg_loop
 18409 00001AD6 E82FE7                  		call	con_flush	; flush out keyboard queue
 18410                                  					; call rom-bios
 18411 00001AD9 30E4                    		xor	ah, ah
 18412 00001ADB CD16                    		int	16h		; KEYBOARD - READ CHAR FROM BUFFER, WAIT IF EMPTY
 18413                                  					; Return: AH = scan code, AL = character
 18414 00001ADD 5B                      		pop	bx
 18415                                  swpdsk9:
 18416 00001ADE 5A                      		pop	dx
 18417 00001ADF 59                      		pop	cx
 18418 00001AE0 C3                      		retn
 18419                                  
 18420                                  ; ---------------------------------------------------------------------------
 18421                                  
 18422                                  ; 16/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 18423                                  
 18424                                  ;--------------------------------------------------------
 18425                                  ; include msbio.cl2 (MSDOS 6.0, 1991)
 18426                                  ;--------------------------------------------------------
 18427                                  ; (MSDOS 6.21 IO.SYS BIOSCODE:17D5h)
 18428                                  ;--------------------------------------------------------
 18429                                  ; 17/03/2019 - Retro DOS v4.0
 18430                                  ; 26/12/2023 - Retro DOS v5.0
 18431                                  
 18432                                  		; MSDOS 5.0 IO.SYS offset 0070h:3D38h or 02C7h:17C8h
 18433                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:1B67h
 18434 00001AE1 0D0A                    sngmsg:		db 0Dh,0Ah
 18435 00001AE3 496E73657274206469-     		db 'Insert diskette for drive '
 18435 00001AEC 736B6574746520666F-
 18435 00001AF5 7220647269766520   
 18436                                  
 18437                                  		; MSDOS 5.0 IO.SYS offset 0070h:3D54h or 02C7h:17E4h
 18438                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:1B83h
 18439 00001AFD 413A20616E64207072-     drvlet:		db 'A: and press any key when ready',0Dh,0Ah
 18439 00001B06 65737320616E79206B-
 18439 00001B0F 6579207768656E2072-
 18439 00001B18 656164790D0A       
 18440 00001B1E 0A00                    		db 0Ah,0
 18441                                  
 18442                                  ; =============== S U B	R O U T	I N E =======================================
 18443                                  
 18444                                  ;---------------------------------------------------------------------------
 18445                                  ; input : es:di points to current bds for drive.
 18446                                  ; return : zero set if no open files
 18447                                  ;	   zero reset if open files
 18448                                  ;---------------------------------------------------------------------------
 18449                                  
 18450                                  		; 26/12/2023 - Retro DOS v5.0
 18451                                  chkopcnt:	
 18452 00001B20 26837D3C00              		cmp     word [es:di+3Ch], 0
 18453                                  		;cmp	word [es:di+20h], 0 ; [es:di+BDS.opcnt]
 18454 00001B25 C3                      		retn
 18455                                  
 18456                                  ; =============== S U B	R O U T	I N E =======================================
 18457                                  
 18458                                  ;---------------------------------------------------------------------------
 18459                                  ; at media check time, we need to really get down and check what the change is.
 18460                                  ; this is guaranteed to be expensive.
 18461                                  ;
 18462                                  ;	es:di -> bds, ds -> Bios_Data
 18463                                  ;---------------------------------------------------------------------------
 18464                                  
 18465                                  		; 26/12/2023 - Retro DOS v5.0
 18466                                  		; PCDOS 7.1 IBMBIO.COM - BIOSCODE:1BA6h
 18467                                  mediacheck:
 18468 00001B26 E84EEE                  		call	checksingle	; make sure correct disk is in place
 18469 00001B29 31F6                    		xor	si, si
 18470 00001B2B E86101                  		call	haschange
 18471 00001B2E 742F                    		jz	short mediaret
 18472                                  		; 26/12/2023
 18473                                  		;test	byte [es:di+3Fh], 40h ; [es:di+BDS.flags], fchanged ; 40h
 18474 00001B30 E85001                  		call	checkromchange
 18475 00001B33 752B                    		jnz	short mediadovolid
 18476 00001B35 50                      		push	ax
 18477 00001B36 52                      		push	dx
 18478 00001B37 268A5504                		mov	dl, [es:di+4]	; [es:di+BDS.drivenum]
 18479                                  					; set logical drive number
 18480 00001B3B B416                    		mov	ah, 16h
 18481 00001B3D CD13                    		int	13h		; DISK - FLOPPY	DISK - CHANGE OF DISK STATUS (AT,XT2,XT286,CONV,PS)
 18482                                  					; DL = drive to	check
 18483                                  					; Return: AH = disk change status
 18484 00001B3F 5A                      		pop	dx
 18485 00001B40 58                      		pop	ax
 18486 00001B41 721D                    		jb	short mediadovolid
 18487 00001B43 BE0100                  		mov	si, 1		; signal no change
 18488                                  
 18489                                  ; there are some drives with changeline that "lose" the changeline indication
 18490                                  ; if a different drive is accessed after the current one. in order to avoid
 18491                                  ; missing a media change, we return an "i don't know" to dos if the changeline
 18492                                  ; is not active and we are accessing a different drive from the last one.
 18493                                  ; if we are accessing the same drive, then we can safely rely on the changeline
 18494                                  ; status.
 18495                                  		; 19/10/2022
 18496 00001B46 8A1E[1E01]              		mov	bl, [tim_drv]	; get last drive accessed
 18497 00001B4A 26385D04                		cmp	[es:di+4], bl	; [es:di+BDS.drivenum]
 18498                                  					; (If the last drive accessed is not current drive
 18499                                  					; media	change status may be incorrect.	So,
 18500                                  					; "I don't now" will be returned even if it is indicated
 18501                                  					; as media is not changed.)
 18502 00001B4E 740F                    		jz	short mediaret	; (same	drive,
 18503                                  					; media	changeline indication is reliable)
 18504                                  
 18505                                  ; do the 2 second twiddle. if time >= 2 seconds, do a volid check.
 18506                                  ; otherwise return "i don't know" (strictly speaking, we should return a
 18507                                  ; "not changed" here since the 2 second test said no change.)
 18508                                  
 18509 00001B50 50                      		push	ax
 18510 00001B51 51                      		push	cx
 18511 00001B52 52                      		push	dx
 18512 00001B53 E8D4EA                  		call	Check_Time_Of_Access
 18513 00001B56 5A                      		pop	dx
 18514 00001B57 59                      		pop	cx
 18515 00001B58 58                      		pop	ax
 18516 00001B59 09F6                    		or	si, si
 18517 00001B5B 7403                    		jz	short mediadovolid ; check_time	says ">= 2 secs	passed"
 18518                                  					; (volume id will be checked)
 18519 00001B5D 31F6                    		xor	si, si		; return "i don't know"
 18520                                  mediaret:
 18521 00001B5F C3                      		retn
 18522                                  ; ---------------------------------------------------------------------------
 18523                                  
 18524                                  ; somehow the media was changed. look at vid to see. we do not look at fat
 18525                                  ; because this may be different since we only set medbyt when doing a read
 18526                                  ; or write.
 18527                                  
 18528                                  mediadovolid:
 18529 00001B60 E873EB                  		call	GetBp		; build	a new bpb in current bds
 18530 00001B63 72FA                    		jb	short mediaret
 18531 00001B65 E82D00                  		call	check_vid
 18532 00001B68 73F5                    		jnb	short mediaret
 18533 00001B6A E93BF2                  		jmp	maperror	; fix up al for	return to dos
 18534                                  ; ---------------------------------------------------------------------------
 18535                                  
 18536                                  ; simple, quick check of latched change. if no indication, then return
 18537                                  ; otherwise do expensive check. if the expensive test fails, pop off the
 18538                                  ; return and set al = 15 (for invalid media change) which will be returned to
 18539                                  ; dos.
 18540                                  ;
 18541                                  ; for dos 3.3, this will work only for the drive that has changeline.
 18542                                  
 18543                                  ;	call with es:di -> bds, ds -> Bios_Data
 18544                                  ;	***** warning:  this routine will return one level up on the stack
 18545                                  ;			if an error occurs!
 18546                                  
 18547                                  checklatchio:
 18548                                  
 18549                                  ; if returning fake bpb then assume the disk has not changed
 18550                                  
 18551                                  		; 26/12/2023
 18552                                  		;cmp	word [es:di+3Ch], 0 ; [es:di+BDS.opcnt]	
 18553 00001B6D E8B0FF                  		call	chkopcnt
 18554 00001B70 741B                    		jz	short checkret	; done if zero
 18555                                  
 18556                                  ; check for past rom indications. if no rom change indicated, then return ok.
 18557                                  
 18558                                  		; 26/12/2023
 18559                                  		;test	word [es:di+3Fh], 40h
 18560                                  		;			; test [es:di+BDS.flags], fchanged ; 40h
 18561 00001B72 E80E01                  		call	checkromchange
 18562 00001B75 7416                    		jz	short checkret
 18563                                  
 18564                                  ; we now see that a change line has been seen in the past. let's do the
 18565                                  ; expensive verification.
 18566                                  
 18567 00001B77 E85CEB                  		call	GetBp		; build	bpb in current bds
 18568 00001B7A 720F                    		jb	short ret_no_error_map ; getbp has already called maperror
 18569 00001B7C E81600                  		call	check_vid
 18570 00001B7F 7207                    		jb	short checklatchret ; disk error trying	to read	in.
 18571 00001B81 09F6                    		or	si, si		; is changed for sure?
 18572 00001B83 7908                    		jns	short checkret
 18573 00001B85 E88F00                  		call	returnvid
 18574                                  checklatchret:
 18575 00001B88 E81DF2                  		call	maperror	; fix up al for	return to dos
 18576                                  ret_no_error_map:
 18577 00001B8B F9                      		stc
 18578 00001B8C 5E                      		pop	si		; pop off return address
 18579                                  checkret:
 18580 00001B8D C3                      		retn
 18581                                  ; ---------------------------------------------------------------------------
 18582                                  
 18583                                  ; check the fat and the vid. return in di -1 or 0. return with carry set
 18584                                  ; only if there was a disk error. return that error code in ax.
 18585                                  ;
 18586                                  ;	called with es:di -> bds, ds -> Bios_Data
 18587                                  
 18588                                  checkfatvid:
 18589 00001B8E E8D101                  		call	fat_check	; check	the fat	and the	vid
 18590 00001B91 09F6                    		or	si, si
 18591 00001B93 7835                    		js	short changed_drv
 18592                                  
 18593                                  ; the fat was the same. fall into check_vid and check volume id.
 18594                                  
 18595                                  		; fall into check_vid
 18596                                  
 18597                                  ; =============== S U B	R O U T	I N E =======================================
 18598                                  
 18599                                  ; now with the extended boot record, the logic should be enhanced.
 18600                                  ;
 18601                                  ; if it is the extended boot record, then we check the volume serial
 18602                                  ; number instead of volume id. if it is different, then set si to -1.
 18603                                  ;
 18604                                  ; if it is same, then si= 1 (no change).
 18605                                  ;
 18606                                  ; if it is not the extended boot record, then just follows the old
 18607                                  ; logic. dos 4.00 will check if the # of fat in the boot record bpb
 18608                                  ; is not 0.  if it is 0 then it must be non_fat based system and
 18609                                  ; should have already covered by extended boot structure checking.
 18610                                  ; so, we will return "i don't know" by setting si to 0.
 18611                                  ;
 18612                                  ; this routine assume the newest valid boot record is in cs:[disksector].
 18613                                  ; (this will be gauranteed by a successful getbp call right before this
 18614                                  ; routine.)
 18615                                  ;
 18616                                  ;	called with es:di -> bds, ds -> bds
 18617                                  
 18618                                  		; 26/12/2023 - Retro DOS v5.0
 18619                                  		; 19/10/2022
 18620                                  check_vid:
 18621                                  
 18622                                  ; check the disksector.EXT_BOOT_SIG variable for the extended
 18623                                  ; boot signature. if it is set then go to do the extended
 18624                                  ; id check otherwise continue with code below
 18625                                  
 18626                                  		; 26/12/2023
 18627                                  		;;;
 18628 00001B95 833E[6801]00            		cmp	word  [disksector+16h], 0 ; BPB_FATSz16
 18629 00001B9A 7507                    		jnz     short chk_vid_1
 18630 00001B9C 803E[9401]29            		cmp     byte [disksector+42h], 29h ; BS_FAT32_BootSig
 18631                                  					; [disksector+EXT_BOOT.SIG],EXT_BOOT_SIGNATURE
 18632 00001BA1 EB05                    		jmp     short chk_vid_2
 18633                                  chk_vid_1:
 18634                                  		;;;
 18635 00001BA3 803E[7801]29            		cmp	byte [disksector+26h], 29h
 18636                                  					; [disksector+EXT_BOOT.SIG],
 18637                                  					; EXT_BOOT_SIGNATURE
 18638                                  chk_vid_2:		; 26/12/2023
 18639 00001BA8 7427                    		jz	short do_ext_check_id
 18640 00001BAA E8E200                  		call	haschange
 18641 00001BAD 74DE                    		jz	short checkret
 18642 00001BAF 31F6                    		xor	si, si
 18643 00001BB1 803E[6201]00            		cmp	byte [disksector+10h], 0 ; BPB_NumFATs
 18644                                  					; [disksector+EXT_BOOT.BPB+EBPB.NUMBEROFFATS]
 18645 00001BB6 7411                    		jz	short checkfatret ; don't read vol id
 18646                                  					; if not fat system
 18647 00001BB8 E8F400                  		call	read_volume_id
 18648 00001BBB 720C                    		jb	short checkfatret
 18649 00001BBD E89901                  		call	check_volume_id
 18650 00001BC0 BEFFFF                  		mov	si, 0FFFFh	; -1
 18651                                  					; definitely changed
 18652 00001BC3 7505                    		jnz	short changed_drv
 18653                                  
 18654 00001BC5 46                      		inc	si		; not changed
 18655                                  vid_no_changed:
 18656 00001BC6 E8C000                  		call	resetchanged
 18657                                  		; 12/12/2022
 18658                                  		; cf=0 ('and' instruction in 'resetchanged' clears cf) 
 18659                                  		;clc
 18660                                  checkfatret:
 18661 00001BC9 C3                      		retn
 18662                                  ; ---------------------------------------------------------------------------
 18663                                  
 18664                                  		; 12/12/2022
 18665                                  changed_drv:
 18666 00001BCA F8                      		clc			; cas -- return	no error
 18667 00001BCB C606[1E01]FF            		mov	byte  [tim_drv], 0FFh 
 18668                                  					; ensure that we ask rom for media
 18669 00001BD0 C3                      		retn			; check	next time round
 18670                                  ; ---------------------------------------------------------------------------
 18671                                  
 18672                                  ; extended id check
 18673                                  
 18674                                  ; 16/10/2022
 18675                                  
 18676                                  ; the code to check extended id is basically a check to see if the
 18677                                  ; volume serial number is still the same. the volume serial number
 18678                                  ; previously read is in cs:disksector.EXT_BOOT_SERIAL
 18679                                  ; ds:di points to the bds of the drive under consideration.
 18680                                  ; the bds has fields containing the high and low words 
 18681                                  ; of the volume serial number of the media in the drive.
 18682                                  ; compare these fields to the fields mentioned above. if these fields
 18683                                  ; do not match the media has changed and so we should jump to the code
 18684                                  ; starting at ext_changed else return "i don't know" status
 18685                                  ; in the register used for the changeline status and continue executing
 18686                                  ; the code given below. for temporary storage use the register which
 18687                                  ; has been saved and restored around this block.
 18688                                  ;
 18689                                  ; bds fields in inc\msbds.inc
 18690                                  
 18691                                  		; 26/12/2023 - Retro DOS v5.0
 18692                                  		; 19/10/2022
 18693                                  do_ext_check_id:
 18694                                  		; 26/12/2023
 18695                                  		;push	ax
 18696                                  		;;mov	ax, word ptr ds:disksector+27h
 18697                                  		;			; [DiskSector+EXT_BOOT.SERIAL]
 18698                                  		;mov	ax, [disksector+27h]
 18699                                  ; 26/12/2023
 18700                                  %if 1
 18701                                  		;;;
 18702 00001BD1 57                      		push	di
 18703 00001BD2 BE[9501]                		mov	si, disksector+43h ; BS_FAT32_VolID
 18704                                  					; [DiskSector+FAT32_EXT_BOOT.SERIAL]
 18705 00001BD5 833E[6801]00            		cmp	word [disksector+16h], 0 ; BPB_FATSz16
 18706 00001BDA 7403                    		jz	short chk_vid_3
 18707 00001BDC 83EE1C                  		sub	si, 28		; BS_VolID
 18708                                  		; si = disksector+27h	; [DiskSector+EXT_BOOT.SERIAL]
 18709                                  chk_vid_3:
 18710                                  		; [es:di+89h] = [es:di+BDS.vol_serial]
 18711 00001BDF 81C78900                		add	di, 137		; BDS.vol_serial
 18712 00001BE3 A7                      		cmpsw	; [DiskSector+EXT_BOOT.SERIAL] ; (or FAT32_EXT_BOOT)
 18713                                  			;		= [di+BDS.vol_serial] ?
 18714 00001BE4 7501                    		jnz	short chk_vid_4
 18715 00001BE6 A7                      		cmpsw	; [DiskSector+EXT_BOOT.SERIAL+2] ; (or FAT32_EXT_BOOT)
 18716                                  			;		= [di+BDS.vol_serial+2] ?
 18717                                  chk_vid_4:
 18718 00001BE7 5F                      		pop	di
 18719                                  		;pop	ax
 18720 00001BE8 7504                    		jnz	short ext_changed ; not equal/same
 18721 00001BEA 31F6                    		xor	si, si 		 ; 0 ; don't know
 18722 00001BEC EBD8                    		jmp	short vid_no_changed ; reset the flag
 18723                                  		;;;
 18724                                  %else
 18725                                  		; 02/09/2023
 18726                                  		xor	si, si ; 0
 18727                                  		cmp	ax, [es:di+57h]	; [di+BDS.vol_serial]
 18728                                  		jnz	short ext_changed
 18729                                  		mov	ax, [disksector+29h] ; [DiskSector+EXT_BOOT.SERIAL+2]
 18730                                  		cmp	ax, [es:di+59h]	; [di+BDS.vol_serial+2]
 18731                                  		jnz	short ext_changed
 18732                                  		;xor	si, si		; 0
 18733                                  					; don't know
 18734                                  		pop	ax
 18735                                  		jmp	short vid_no_changed
 18736                                  					; reset the flag
 18737                                  %endif
 18738                                  
 18739                                  ; ---------------------------------------------------------------------------
 18740                                  
 18741                                  ext_changed:
 18742                                  		; 26/12/2023
 18743                                  		;pop	ax
 18744                                  		; 02/09/2023
 18745                                  		;dec	si ; mov si, 0FFFFh ; -1
 18746 00001BEE BEFFFF                  		mov	si, 0FFFFh	; -1
 18747                                  					; disk changed!
 18748                                  		; 12/12/2022
 18749                                  		; ('changed_drv' clears cf)
 18750                                  		;clc
 18751 00001BF1 EBD7                    		jmp	short changed_drv
 18752                                  
 18753                                  ; ---------------------------------------------------------------------------
 18754                                  
 18755                                  ; at i/o time, we detected the error. now we need to determine whether the
 18756                                  ; media was truly changed or not. we return normally if media change unknown.
 18757                                  ; and we pop off the call and jmp to harderr if we see an error.
 18758                                  ;
 18759                                  ; es:di -> bds
 18760                                  
 18761                                  checkio:
 18762 00001BF3 80FC06                  		cmp	ah, 6
 18763 00001BF6 75D1                    		jnz	short checkfatret
 18764                                  		; 26/12/2023 - Retro DOS v5.0
 18765                                  		;cmp	word [es:di+3Ch], 0 ; [es:di+BDS.opcnt]
 18766 00001BF8 E825FF                  		call	chkopcnt
 18767 00001BFB 74CC                    		jz	short checkfatret
 18768 00001BFD E8D6EA                  		call	GetBp
 18769 00001C00 7212                    		jb	short no_error_map
 18770 00001C02 E889FF                  		call	checkfatvid
 18771 00001C05 7209                    		jb	short checkioret ; disk	error trying to	read in.
 18772 00001C07 09F6                    		or	si, si		; is changed for sure?
 18773 00001C09 7802                    		js	short checkioerr ; yes changed
 18774 00001C0B 45                      		inc	bp		; allow	a retry
 18775 00001C0C C3                      		retn
 18776                                  ; ---------------------------------------------------------------------------
 18777                                  
 18778                                  checkioerr:
 18779 00001C0D E80700                  		call	returnvid
 18780                                  
 18781                                  checkioret:
 18782 00001C10 F9                      		stc			; make sure carry gets passed through
 18783 00001C11 E950F1                  		jmp	harderr
 18784                                  ; ---------------------------------------------------------------------------
 18785                                  
 18786                                  no_error_map:				
 18787 00001C14 E950F1                  		jmp	harderr2
 18788                                  
 18789                                  ; =============== S U B	R O U T	I N E =======================================
 18790                                  
 18791                                  ; return vid sets up the vid for a return to dos.
 18792                                  ;  es:di -> bds, returns pointer in packet to bds_volid
 18793                                  ;  **** trashes si! ****
 18794                                  
 18795                                  returnvid:
 18796 00001C17 BE1600                  		mov	si, 22		; extra
 18797                                  					; offset into pointer to return	value
 18798 00001C1A E80700                  		call	vid_into_packet
 18799 00001C1D B406                    		mov	ah, 6
 18800 00001C1F F9                      		stc
 18801 00001C20 C3                      		retn
 18802                                  
 18803                                  ; ---------------------------------------------------------------------------
 18804                                  
 18805                                  ; moves the pointer to the volid for the drive into the original request packet
 18806                                  ; no attempt is made to preserve registers.
 18807                                  ;
 18808                                  ; assumes es:di -> bds
 18809                                  ; **trashes si**
 18810                                  
 18811                                  media_set_vid:
 18812 00001C21 BE0F00                  		mov	si, 15		; trans+1
 18813                                  					; return the value here	in packet
 18814                                  
 18815                                  		; fall into vid_into_packet
 18816                                  
 18817                                  ; =============== S U B	R O U T	I N E =======================================
 18818                                  
 18819                                  ; return pointer to vid in bds at es:di in packet[si]
 18820                                  
 18821                                  		; 26/12/2023 - Retro DOS v5.0
 18822                                  		; 19/10/2022
 18823                                  vid_into_packet:
 18824 00001C24 1E                      		push	ds		; return pointer to vid	in bds at es:di	in packet[si]
 18825 00001C25 C51E[1200]              		lds	bx, [ptrsav]
 18826                                  		; 26/12/2023
 18827 00001C29 83C77D                  		add	di, 125         ; BDS.volid (BDS offset 125)
 18828                                  		;add	di, 75		; BDS.volid
 18829 00001C2C 8938                    		mov	[bx+si], di
 18830 00001C2E 83EF7D                  		sub     di, 125         ; BDS start (BDS offset 0)
 18831                                  		;sub	di, 75		
 18832 00001C31 8C4002                  		mov	[bx+si+2], es
 18833 00001C34 1F                      		pop	ds
 18834                                  dofloppy:	; 18/12/2022
 18835 00001C35 C3                      		retn
 18836                                  
 18837                                  ; ---------------------------------------------------------------------------
 18838                                  
 18839                                  ;----------------------------------------------------------------------------
 18840                                  ;   hidensity - examine a drive/media descriptor to set the media type. if
 18841                                  ;   the media descriptor is not f9 (not 96tpi or 3 1/2), we return and let the
 18842                                  ;   caller do the rest. otherwise, we pop off the return and jump to the tail
 18843                                  ;   of getbp. for 3.5" media, we just return.
 18844                                  ;
 18845                                  ;   inputs:	es:di point to correct bds for this drive
 18846                                  ;		ah has media byte
 18847                                  ;
 18848                                  ;   outputs:	carry clear
 18849                                  ;		    no registers modified
 18850                                  ;		carry set
 18851                                  ;		    al = sectors/fat
 18852                                  ;		    bh = number of root directory entries
 18853                                  ;		    bl = sectors per track
 18854                                  ;		    cx = number of sectors
 18855                                  ;		    dh = sectors per allocation unit
 18856                                  ;		    dl = number of heads
 18857                                  ;
 18858                                  ;----------------------------------------------------------------------------
 18859                                  
 18860                                  		; 26/12/2023 - Retro DOS v5.0
 18861                                  hidensity:
 18862                                  
 18863                                  ; check for correct drive
 18864                                  		
 18865                                  		; 26/12/2023
 18866 00001C36 26F6453F02              		test	byte [es:di+3Fh], 2 ; is it special?
 18867                                  		; 12/12/2022
 18868                                  		;test	byte [es:di+23h], 2
 18869                                  		;;test	word [es:di+23h], 2 ; is it special?
 18870                                  					; [es:di+BDS.flags], fchangeline
 18871 00001C3B 74F8                    		jz	short dofloppy	; no, do normal floppy test
 18872                                  
 18873                                  ; we have a media byte that is pretty complex. examine drive information
 18874                                  ; table to see what kind it is.
 18875                                  
 18876                                  		; 26/12/2023
 18877 00001C3D 26807D3E02              		cmp	byte [es:di+3Eh], 2 ; is it single-media?
 18878                                  		;cmp	byte [es:di+22h], 2 ; is it single-media?
 18879 00001C42 74F1                    		jz	short dofloppy	; [es:di+BDS.formfactor], ffSmall
 18880                                  					; yes, use fatid...
 18881                                  ; 96 tpi drive?
 18882 00001C44 80FCF9                  		cmp	ah, 0F9h
 18883 00001C47 75EC                    		jnz	short dofloppy
 18884                                  
 18885                                  ;------ If formfactor of drive = ffother or ff288 it has to be
 18886                                  ;------ a 720K diskette
 18887                                  
 18888                                  		; 02/09/2023 (PCDOS 7.1)
 18889                                  		; 26/12/2023
 18890 00001C49 268A453E                		mov	al, [es:di+3Eh] ; [es:di+BDS.formfactor]
 18891                                  		;mov	al, [es:di+22h]	; [es:di+BDS.formfactor]
 18892 00001C4D 3C07                    		cmp	al, 7
 18893                                  		;cmp	byte [es:di+22h], 7 ; [es:di+BDS.formfactor]
 18894                                  					; ffOther
 18895 00001C4F 7413                    		jz	short Is720K
 18896 00001C51 3C09                    		cmp	al, 9
 18897                                  		;cmp	byte [es:di+22h], 9 ; [es:di+BDS.formfactor]
 18898                                  					; ff288
 18899 00001C53 740F                    		jz	short Is720K
 18900 00001C55 B007                    		mov	al, 7		; seven	sectors	/ fat
 18901 00001C57 BB0FE0                  		mov	bx, 57359	; 224*256+0Fh
 18902                                  					; 224 root dir entries
 18903                                  					; & 0Fh sector max
 18904 00001C5A B96009                  		mov	cx, 2400	; 80*15*2
 18905                                  					; 80 tracks, 15 sectors/track,
 18906                                  					; 2 sides
 18907                                  		; 02/09/2023
 18908 00001C5D 5A                      		pop	dx		; pop off return address
 18909 00001C5E BA0201                  		mov	dx, 258		; 1*256+2
 18910                                  					; sectors/allocation unit
 18911                                  					; & head max
 18912                                  		;add	sp, 2		; pop off return address
 18913 00001C61 E9E6EA                  		jmp	Has1		; return to tail of getbp
 18914                                  ; ---------------------------------------------------------------------------
 18915                                  
 18916                                  Is720K:
 18917                                  		; 02/09/2023
 18918 00001C64 5B                      		pop	bx		; pop off return address
 18919                                  		;add	sp, 2		; pop off return address
 18920 00001C65 E9A5EA                  		jmp	Has720K		; return to 720K code
 18921                                  ; ---------------------------------------------------------------------------
 18922                                  
 18923                                  		; 18/12/2022
 18924                                  ;dofloppy:
 18925                                  		;retn
 18926                                  
 18927                                  ; =============== S U B	R O U T	I N E =======================================
 18928                                  
 18929                                  ; 16/10/2022
 18930                                  
 18931                                  ;---------------------------------------------------------------------------
 18932                                  ; set_changed_dl - sets flag bits according to bits set in bx.
 18933                                  ;		   essentially used to indicate changeline, or format.
 18934                                  ;
 18935                                  ;   inputs:	dl contains physical drive number
 18936                                  ;		bx contains bits to set in the flag field in the bdss
 18937                                  ;   outputs:	none
 18938                                  ;   registers modified: flags
 18939                                  ;
 18940                                  ;	called from int13 hooker.  Must preserve ALL registers!!!
 18941                                  ;
 18942                                  ; in the virtual drive system we *must* flag the other drives as being changed
 18943                                  ;---------------------------------------------------------------------------
 18944                                  
 18945                                  		; 26/12/2023 - Retro DOS v5.0
 18946                                  set_changed_dl:	
 18947 00001C68 06                      		push	es
 18948 00001C69 57                      		push	di
 18949                                  		;les	di, ds:start_bds
 18950                                  		; 19/10/2022
 18951 00001C6A C43E[1901]              		les	di, [start_bds]
 18952                                  
 18953                                  ; note: we assume that the list is non-empty
 18954                                  
 18955                                  scan_bds:
 18956 00001C6E 26385504                		cmp	[es:di+4], dl	; [es:di+BDS.drivenum]
 18957 00001C72 7504                    		jnz	short get_next_bds
 18958                                  
 18959                                  ; someone may complain, but this *always* must be done when a disk change is
 18960                                  ; noted. there are *no* other compromising circumstances.
 18961                                  
 18962                                  		; 26/12/2023
 18963 00001C74 26095D3F                		or	[es:di+3Fh], bx	; [es:di+BDS.flags]
 18964                                  		;or	[es:di+23h], bx	; [es:di+BDS.flags]
 18965                                  					; signal change	on other drive
 18966                                  get_next_bds:
 18967 00001C78 26C43D                  		les	di, [es:di]	; [es:di+BDS.link]
 18968                                  					; go to	next bds
 18969 00001C7B 83FFFF                  		cmp	di, 0FFFFh
 18970 00001C7E 75EE                    		jnz	short scan_bds	; loop unless we hit end of chain
 18971 00001C80 5F                      		pop	di
 18972 00001C81 07                      		pop	es
 18973 00001C82 C3                      		retn
 18974                                  
 18975                                  ; =============== S U B	R O U T	I N E =======================================
 18976                                  
 18977                                  ;---------------------------------------------------------------------------
 18978                                  ; checkromchange - see if external program has diddled rom change line.
 18979                                  ;
 18980                                  ;   inputs:	es:di points to current bds.
 18981                                  ;   outputs:	zero set - no change
 18982                                  ;		zero reset - change
 18983                                  ;   registers modified: none
 18984                                  ;---------------------------------------------------------------------------
 18985                                  
 18986                                  		; 26/12/2023 - Retro DOS v5.0
 18987                                  checkromchange:	
 18988                                  		;test	word [es:di+BDS.flags], fchanged ; 40h
 18989                                  		; 26/12/2023
 18990 00001C83 26F6453F40              		test	byte [es:di+3Fh], 40h
 18991                                  		; 10/12/2022
 18992                                  		;test	byte [es:di+23h], 40h
 18993                                  		;;test	word [es:di+23h], 40h ; [es:di+BDS.flags]
 18994                                  					; fchanged
 18995 00001C88 C3                      		retn
 18996                                  
 18997                                  ; =============== S U B	R O U T	I N E =======================================
 18998                                  
 18999                                  ;---------------------------------------------------------------------------
 19000                                  ; resetchanged - restore value of change line
 19001                                  ;
 19002                                  ;   inputs:	es:di points to current bds
 19003                                  ;   outputs:	none
 19004                                  ;   registers modified: none
 19005                                  ;---------------------------------------------------------------------------
 19006                                  
 19007                                  		; 26/12/2023 - Retro DOS v5.0
 19008                                  resetchanged:
 19009                                  		;and	word [es:di+BDS.flags], ~fchanged ; 0FFBFh
 19010                                  		; 26/12/2023
 19011 00001C89 2680653FBF              		and	byte [es:di+3Fh], 0BFh
 19012                                  		; 10/12/2022
 19013                                  		;and	byte [es:di+23h], 0BFh
 19014                                  		;;and	word [es:di+23h], 0FFBFh ; [es:di+BDS.flags]
 19015                                  					; ~fchanged
 19016 00001C8E C3                      		retn
 19017                                  
 19018                                  ; =============== S U B	R O U T	I N E =======================================
 19019                                  
 19020                                  ;---------------------------------------------------------------------------
 19021                                  ; haschange - see if drive can supply change line
 19022                                  ;
 19023                                  ;   inputs:	es:di points to current bds
 19024                                  ;   outputs:	zero set - no change line available
 19025                                  ;		zero reset - change line available
 19026                                  ;   registers modified: none
 19027                                  ;---------------------------------------------------------------------------
 19028                                  
 19029                                  		; 26/12/2023 - Retro DOS v5.0
 19030                                  haschange:
 19031                                  		;test	word [es:di+BDS.flags], fchangeline ; 2
 19032                                  		; 26/12/2023
 19033 00001C8F 26F6453F02              		test	byte [es:di+3Fh], 2
 19034                                  		; 10/12/2022
 19035                                  		;test	byte [es:di+23h], 2
 19036                                  		;;test	word [es:di+23h], 2 ; [es:di+BDS.flags]
 19037                                  					; fchangeline
 19038 00001C94 C3                      		retn
 19039                                  
 19040                                  ; ---------------------------------------------------------------------------
 19041                                  
 19042                                  ; 16/10/2022
 19043                                  
 19044                                  ;-------------------------------------------------------------------------
 19045                                  ; set_volume_id      -	main routine, calls other routines.
 19046                                  ; read_volume_id     -	read the volume id and tells if it has been changed.
 19047                                  ; transfer_volume_id -	copy the volume id from tmp to special drive.
 19048                                  ; check_volume_id    -	compare volume id in tmp area with one expected for drive.
 19049                                  ; fat_check          -	see of the fatid has changed in the specified drive.
 19050                                  ;-------------------------------------------------------------------------
 19051                                  
 19052                                  ; set_volume_id
 19053                                  ;   if drive has changeline support, read in and set the volume_id
 19054                                  ; and the last fat_id byte. if no change line support then do nothing.
 19055                                  ;
 19056                                  ;   on entry:
 19057                                  ;	es:di points to the bds for this disk.
 19058                                  ;	ah contains media byte
 19059                                  ;
 19060                                  ;   on exit:
 19061                                  ;	carry clear:
 19062                                  ;	   successful call
 19063                                  ;	carry set
 19064                                  ;	   error and ax has error code
 19065                                  
 19066                                  set_volume_id:
 19067 00001C95 52                      		push	dx		; save registers
 19068 00001C96 50                      		push	ax
 19069 00001C97 E8F5FF                  		call	haschange	; does drive have changeline support?
 19070 00001C9A 740B                    		jz	short setvret	; no, get out
 19071 00001C9C E81000                  		call	read_volume_id
 19072 00001C9F 7209                    		jb	short seterr
 19073 00001CA1 E8A900                  		call	transfer_volume_id ; copy the volume id	to special drive
 19074 00001CA4 E8E2FF                  		call	resetchanged	; restore value	of change line
 19075                                  setvret:				
 19076                                  		; 10/12/2022
 19077                                  		; cf = 0
 19078                                  		;clc			; no error, clear carry flag
 19079 00001CA7 58                      		pop	ax		; restore registers
 19080 00001CA8 5A                      		pop	dx
 19081 00001CA9 C3                      		retn
 19082                                  ; ---------------------------------------------------------------------------
 19083                                  
 19084                                  seterr:
 19085 00001CAA 5A                      		pop	dx		; pop stack but don't overwrite ax
 19086 00001CAB 5A                      		pop	dx		; restore dx
 19087 00001CAC C3                      		retn
 19088                                  ; ---------------------------------------------------------------------------
 19089 00001CAD 0000                    root_sec:	dw 0			; root sector #
 19090                                  
 19091                                  ; 16/10/2022
 19092                                  ;ROOTSEC equ root_sec - DOSBIOSEG_2C7h		
 19093                                  ; 09/12/2022
 19094                                  ROOTSEC equ root_sec
 19095                                  
 19096                                  ; =============== S U B	R O U T	I N E =======================================
 19097                                  
 19098                                  ; 16/10/2022
 19099                                  
 19100                                  ; read_volume_id read the volume id and tells if it has been changed.
 19101                                  ;
 19102                                  ;   on entry:
 19103                                  ;	es:di points to current bds for drive.
 19104                                  ;
 19105                                  ;   on exit:
 19106                                  ;	carry clear
 19107                                  ;	    si = 1  no change
 19108                                  ;	    si = 0  ?
 19109                                  ;	    si = -1 change
 19110                                  ;
 19111                                  ;	carry set:
 19112                                  ;	    error and ax has error code.
 19113                                  
 19114                                  read_volume_id:
 19115 00001CAF 52                      		push	dx		; preserve registers
 19116 00001CB0 51                      		push	cx
 19117 00001CB1 53                      		push	bx
 19118 00001CB2 50                      		push	ax
 19119 00001CB3 06                      		push	es		; stack the bds last
 19120 00001CB4 57                      		push	di
 19121 00001CB5 1E                      		push	ds		; point es to Bios_Data
 19122 00001CB6 07                      		pop	es
 19123 00001CB7 BF[4008]                		mov	di, tmp_vid	; "NO NAME	 "
 19124 00001CBA BE[6305]                		mov	si, nul_vid	; "NO NAME	 "
 19125                                  		; 26/12/2023
 19126 00001CBD B90B00                  		mov	cx, 11		; PCDOS 7.1 - 02/09/2023
 19127                                  		;mov	cx, 12		; initialize tmp_vid to	null vi_id
 19128                                  		
 19129                                  		;rep	movsb
 19130                                  		; 26/12/2023
 19131                                  		;rep movs byte ptr es:[di], byte ptr cs:[si]
 19132                                  		;db 0FBh,2Eh,0A4h 
 19133                                  		;cs	; nul_vid is in BIOSCODE segment 
 19134                                  		;rep movsb
 19135 00001CC0 F3                      		rep
 19136 00001CC1 2E                      		cs
 19137 00001CC2 A4                      		movsb	
 19138                                  		
 19139 00001CC3 5F                      		pop	di
 19140 00001CC4 07                      		pop	es
 19141 00001CC5 268A450B                		mov	al, [es:di+11]	; [es:di+BDS.fats]
 19142                                  					; # of fats
 19143 00001CC9 268B4D11                		mov	cx, [es:di+17]	; [es:di+BDS.fatsecs]
 19144                                  					; sectors / fat
 19145 00001CCD F6E1                    		mul	cl		; size taken by	fats
 19146 00001CCF 26034509                		add	ax, [es:di+9]	; [es:di+BDS.resectors]
 19147                                  					; add on reserved sectors
 19148                                  					;
 19149                                  					; ax is	now sector # (0	based)
 19150                                  		; 17/10/2022
 19151 00001CD3 2EA3[AD1C]              		mov	[cs:ROOTSEC], ax
 19152                                  		;mov	word ptr cs:198Fh, ax ; [cs:root_sec]
 19153                                  					; 0070h:3EFFh =	2C7h:198Fh
 19154 00001CD7 268B450C                		mov	ax, [es:di+12]	; [es:di+BDS.direntries]
 19155                                  					; # root dir entries
 19156 00001CDB B104                    		mov	cl, 4		; 16 entries/sector
 19157 00001CDD D3E8                    		shr	ax, cl		; divide by 16
 19158                                  		;mov	cx, ax		; cx is	# of sectors to	scan
 19159                                  		; 02/09/2023 (PCDOS 7.1, one byte opcode)
 19160 00001CDF 91                      		xchg	ax, cx		; cx is	# of sectors to	scan
 19161                                  next_sec:
 19162 00001CE0 51                      		push	cx		; save outer loop counter
 19163 00001CE1 2EA1[AD1C]              		mov	ax, [cs:ROOTSEC]
 19164                                  		;mov	ax, word ptr cs:198Fh ; [cs:root_sec]
 19165                                  					; get sector #
 19166 00001CE5 268B4D13                		mov	cx, [es:di+19]	; [es:di+BDS.secpertrack]
 19167                                  					; sectors / track
 19168 00001CE9 31D2                    		xor	dx, dx
 19169 00001CEB F7F1                    		div	cx
 19170                                  
 19171                                  ; set up registers for call to read_sector
 19172                                  
 19173 00001CED 42                      		inc	dx		; dx= sectors into track
 19174                                  					; ax= track count from 0
 19175 00001CEE 88D1                    		mov	cl, dl		; sector to read
 19176 00001CF0 31D2                    		xor	dx, dx
 19177 00001CF2 26F77515                		div	word [es:di+21] ; [es:di+BDS.heads]
 19178                                  					; # heads on this disc
 19179 00001CF6 88D6                    		mov	dh, dl		; head number
 19180 00001CF8 88C5                    		mov	ch, al		; track	#
 19181 00001CFA E8B9EB                  		call	read_sector	; get first sector of the root directory,
 19182                                  					; ds:bx	-> directory sector
 19183 00001CFD 723F                    		jb	short readviderr
 19184 00001CFF B91000                  		mov	cx, 16		; # of dir entries in a	block of root
 19185 00001D02 B008                    		mov	al, 8		; volume label bit
 19186                                  fvid_loop:
 19187                                  		; 02/09/2023 (PCDOS 7.1)
 19188 00001D04 382F                    		cmp	[bx], ch ; 0				
 19189                                  		;cmp	byte [bx], 0 ; end of dir?
 19190 00001D06 7433                    		jz	short no_vid	; yes, no vol id
 19191 00001D08 803FE5                  		cmp	byte [bx], 0E5h ; empty entry?
 19192 00001D0B 7405                    		jz	short ent_loop	; yes, skip
 19193 00001D0D 84470B                  		test	[bx+11], al	; is volume label bit set in fcb?
 19194 00001D10 750F                    		jnz	short found_vid	; jmp yes
 19195                                  ent_loop:
 19196 00001D12 83C320                  		add	bx, 32		; add length of	directory entry
 19197 00001D15 E2ED                    		loop	fvid_loop
 19198 00001D17 59                      		pop	cx		; outer loop
 19199 00001D18 2EFF06[AD1C]            		inc	word [cs:ROOTSEC]
 19200                                  		;inc	word ptr cs:198Fh ; inc word [root_sec]
 19201                                  					; next sector
 19202 00001D1D E2C1                    		loop	next_sec	; continue
 19203                                  notfound:
 19204                                  		; 02/09/2023
 19205                                  		;xor	si, si
 19206 00001D1F EB13                    		jmp	short fvid_ret
 19207                                  ; ---------------------------------------------------------------------------
 19208                                  
 19209                                  found_vid:
 19210                                  		; 02/09/2023
 19211                                  		; cf = 0  ('test' instruction clears cf)
 19212 00001D21 59                      		pop	cx		; clean stack of outer loop counter
 19213 00001D22 89DE                    		mov	si, bx		; point	to volume_id
 19214 00001D24 06                      		push	es		; preserve current bds
 19215 00001D25 57                      		push	di
 19216 00001D26 1E                      		push	ds
 19217 00001D27 07                      		pop	es		; point es to Bios_Data
 19218 00001D28 BF[4008]                		mov	di, tmp_vid	; "NO NAME	 "
 19219 00001D2B B90B00                  		mov	cx, 11		; VOLID_SIZ-1
 19220                                  					; length of string minus nul
 19221 00001D2E F3A4                    		rep movsb		; mov volume label to tmp_vid
 19222                                  		;xor	al, al
 19223                                  		; 02/09/2023
 19224 00001D30 91                      		xchg	ax, cx		; ax = 0
 19225 00001D31 AA                      		stosb			; null terminate
 19226                                  		;;xor	si, si
 19227                                  		; 02/09/2023
 19228                                  		;xchg	ax, si		; si = 0
 19229 00001D32 5F                      		pop	di		; restore current bds
 19230 00001D33 07                      		pop	es
 19231                                  fvid_ret:
 19232                                  		; 02/09/2023
 19233 00001D34 31F6                    		xor	si, si ; 0
 19234                                  				
 19235 00001D36 58                      		pop	ax
 19236                                  		; 10/12/2022
 19237                                  		; cf = 0
 19238                                  		;clc
 19239                                  rvidret:
 19240 00001D37 5B                      		pop	bx		; restore registers
 19241 00001D38 59                      		pop	cx
 19242 00001D39 5A                      		pop	dx
 19243 00001D3A C3                      		retn
 19244                                  ; ---------------------------------------------------------------------------
 19245                                  
 19246                                  no_vid:
 19247 00001D3B 59                      		pop	cx		; clean stack of outer loop counter
 19248                                  		;jmp	short notfound	; not found
 19249                                  		; 02/09/2023
 19250 00001D3C EBF6                    		jmp	short fvid_ret
 19251                                  ; ---------------------------------------------------------------------------
 19252                                  
 19253                                  readviderr:
 19254 00001D3E 5E                      		pop	si		; trash the outer loop counter
 19255 00001D3F 5E                      		pop	si		; caller's ax, return error code instead
 19256 00001D40 EBF5                    		jmp	short rvidret
 19257                                  
 19258                                  ; ---------------------------------------------------------------------------
 19259                                  		; 26/12/2023 - Retro DOS v5.0
 19260                                  		; 02/09/2023 - Retro DOS v4.2 (IO.SYS optimization)
 19261                                  		; PCDOS 7.1 - IBMBIO.COM - BIOSCODE:1DCFh 
 19262                                  preset_volid_addr:
 19263 00001D42 BE[4008]                		mov	si, tmp_vid	; "NO NAME    "
 19264                                  		; 26/12/2023
 19265                                  		; PCDOS 7.1
 19266 00001D45 83C77D                  		add	di, 125		; BDS.volid
 19267 00001D48 B90B00                  		mov	cx, 11		; VOLID_SIZ (12 for MSDOS 5.0-6.22 versions)
 19268                                  		; MSDOS 6.21 (MSDOS 5.0 & 6.?)
 19269                                  		;add	di, 75		; BDS.volid
 19270                                  		;mov	cx, 12		; VOLID_SIZ
 19271                                  		;
 19272 00001D4B FC                      		cld
 19273 00001D4C C3                      		retn
 19274                                  
 19275                                  ; =============== S U B	R O U T	I N E =======================================
 19276                                  
 19277                                  ; transfer_volume_id - copy the volume id from tmp to special drive
 19278                                  ;
 19279                                  ; inputs:	es:di has current bds
 19280                                  ; outputs:	bds for drive has volume id from tmp
 19281                                  
 19282                                  		; 27/12/2023 - Retro DOS v5.0
 19283                                  transfer_volume_id:
 19284 00001D4D 57                      		push	di		; copy the volume id from tmp to special drive
 19285                                  		;push	si
 19286 00001D4E 51                      		push	cx
 19287                                  		; 27/12/2023
 19288 00001D4F 56                      		push	si		
 19289                                  
 19290                                  		;mov	si, tmp_vid	; "NO NAME	 "
 19291                                  		;;add	di, BDS.volid
 19292                                  		;add	di, 75		; BDS.volid
 19293                                  		;;mov	cx, VOLID_SIZ
 19294                                  		;mov	cx, 12		; VOLID_SIZ
 19295                                  		;cld
 19296                                  		; 02/09/2023 (PCDOS 7.1)
 19297 00001D50 E8EFFF                  		call	preset_volid_addr
 19298                                  
 19299 00001D53 F3A4                    		rep movsb
 19300                                  		
 19301                                  		; 27/12/2023
 19302 00001D55 5E                      		pop	si
 19303                                  chk_volid_ok:
 19304 00001D56 59                      		pop	cx
 19305                                  		;pop	si
 19306 00001D57 5F                      		pop	di
 19307 00001D58 C3                      		retn
 19308                                  
 19309                                  ; =============== S U B	R O U T	I N E =======================================
 19310                                  
 19311                                  ;  check_volume_id - compare volume id in tmp area with
 19312                                  ;		     one expected for drive
 19313                                  ;
 19314                                  ;   inputs:	es:di has current bds for drive
 19315                                  ;   outputs:	zero true means it matched
 19316                                  
 19317                                  		; 27/12/2023 - Retro DOS v5.0
 19318                                  check_volume_id:
 19319 00001D59 57                      		push	di
 19320 00001D5A 51                      		push	cx
 19321                                  		
 19322                                  		;mov	si, tmp_vid	; "NO NAME	 "
 19323                                  		;;add	di, BDS.volid
 19324                                  		;add	di, 75		; BDS.volid
 19325                                  		;;mov	cx, VOLID_SIZ
 19326                                  		;mov	cx, 12		; VOLID_SIZ
 19327                                  		;cld
 19328                                  		; 02/09/2023 (PCDOS 7.1)
 19329 00001D5B E8E4FF                  		call	preset_volid_addr
 19330                                  
 19331 00001D5E F3A6                    		repe cmpsb		; are the 2 volume_ids the same?
 19332                                  		
 19333                                  		; 27/12/2023
 19334                                  		;pop	cx
 19335                                  		;pop	di
 19336                                  		;retn
 19337 00001D60 EBF4                    		jmp	short chk_volid_ok
 19338                                  
 19339                                  ; =============== S U B	R O U T	I N E =======================================
 19340                                  
 19341                                  ;   fat_check - see of the fatid has changed in the specified drive.
 19342                                  ;	      - uses the fat id obtained from the boot sector.
 19343                                  ;
 19344                                  ;   inputs:	medbyt is expected fat id
 19345                                  ;		es:di points to current bds
 19346                                  ;
 19347                                  ;   output:	si = -1 if fat id different,
 19348                                  ;		si = 0 otherwise
 19349                                  ;
 19350                                  ;   no other registers changed.
 19351                                  
 19352                                  fat_check:
 19353 00001D62 50                      		push	ax
 19354 00001D63 31F6                    		xor	si, si		; say fat id's are same.
 19355 00001D65 A0[1F01]                		mov	al, [medbyt]	; 19/10/2022
 19356 00001D68 263A4510                		cmp	al, [es:di+10h]	; [es:di+BDS.media]
 19357                                  					; compare it with the bds medbyte
 19358 00001D6C 7401                    		jz	short okret1	; carry	clear
 19359 00001D6E 4E                      		dec	si
 19360                                  okret1:
 19361 00001D6F 58                      		pop	ax
 19362 00001D70 C3                      		retn
 19363                                  
 19364                                  ; ---------------------------------------------------------------------------
 19365                                  
 19366                                  ; BIOSCODE:1DFEh (PCDOS 7.1 IBMBIO.COM) ; 27/12/2023
 19367                                  		;times 2 db 0
 19368                                  
 19369                                  ; BIOSCODE:1A69h (MSDOS 6.21 IO.SYS) ((& MSDOS 6.22 IO.SYS))
 19370                                  		;times 7 db 0
 19371                                  
 19372                                  ; BIOSCODE:180Bh (MSDOS 5.0 IO.SYS)	
 19373                                  
 19374                                  		; 09/12/2022
 19375                                  		;times 4 db 0	; 17/10/2022
 19376                                  		;db 4 dup(0)	; times 4 db 0
 19377                                  
 19378                                  ; ---------------------------------------------------------------------------
 19379                                  
 19380                                  		; 09/12/2022
 19381                                  		;db 0
 19382                                  
 19383                                  number2div	equ ($-BCode_start)
 19384                                  number2mod	equ (number2div % 16)
 19385                                  
 19386                                  %if (number2mod>0) & (number2mod<16) ; 17/09/2023
 19387 00001D71 00<rep Fh>              		times (16-number2mod) db 0
 19388                                  %endif
 19389                                  
 19390                                  ;align 16
 19391                                  
 19392                                  ; 09/12/2022
 19393                                  BCODE_END	equ $ - BCode_start
 19394                                  ; 29/09/2023
 19395                                  BCODEEND:
 19396                                  ;SYSINITSEG	equ IOSYSCODESEG+(BCODE_END>>4)
 19397                                  ; 13/12/2022
 19398                                  SYSINITOFFSET	equ BCODE_END
 19399                                  ; 29/09/2023
 19400                                  ;SYSINITOFFSET	equ $-$$
 19401                                  SYSINITSEG	equ IOSYSCODESEG+(SYSINITOFFSET>>4)
 19402                                  
 19403                                  ; 28/09/2023
 19404                                  S2SIZE equ $-$$
 19405                                  
 19406                                  ;--- End of DOSBIOS code segment ---------------------------------------------
 19407                                  
 19408                                  ; 16/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 19409                                  ; 01/05/2019 - Retro DOS v4.0 
 19410                                  ; ============================================================================
 19411                                  ; end of BIOSCODE
 19412                                  
 19413                                  ; ----------------------------------------------------------------------------
 19414                                  ; %include sysinit5.s	; 09/12/2022
 19415                                  ; ----------------------------------------------------------------------------
 19416                                  
 19417                                  ;=============================================================================
 19418                                  ; (IO.SYS) SYSINIT SEGMENT 
 19419                                  ;=============================================================================
 19420                                  ; 09/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 19421                                  ; 30/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 19422                                  
 19423                                  section .SYSINIT vstart=0
 19424                                  
 19425                                  ; ****************************************************************************
 19426                                  ; SYSINIT.BIN (MSDOS 6.21 IO.SYS) - RETRO DOS v4.0 by ERDOGAN TAN - 21/10/2022
 19427                                  ; ----------------------------------------------------------------------------
 19428                                  ; Last Update: 04/01/2023 (Modified IO.SYS)  ((Previous: 30/12/2022))
 19429                                  ; ----------------------------------------------------------------------------
 19430                                  ; Beginning: 03/06/2018 (Retro DOS 3.0), 21/03/2019 (Retro DOS 4.0)
 19431                                  ; ----------------------------------------------------------------------------
 19432                                  ; Assembler: NASM version 2.15
 19433                                  ; ----------------------------------------------------------------------------
 19434                                  ;	   ((nasm sysinit6.s -l sysinit6.lst -o SYSINIT6.BIN -Z error.txt)) 	
 19435                                  ; ----------------------------------------------------------------------------
 19436                                  ; Modified from 'sysinit2.s' (SYSINIT2.BIN) file of Retro DOS v3.0 (6/7/2018)
 19437                                  ; ----------------------------------------------------------------------------
 19438                                  ; Derived from 'SYSINIT1.ASM' and 'SYSINIT2.ASM' files of MSDOS 6.0
 19439                                  ; source code by Microsoft, 1991 
 19440                                  ; ----------------------------------------------------------------------------
 19441                                  ; Derived from 'SYSINIT.ASM' file of MSDOS 2.0 (IBM PCDOS v2.0) source code
 19442                                  ; by Microsoft, 12/10/1983
 19443                                  ; ****************************************************************************
 19444                                  ; main file: 'retrodos4.s'
 19445                                  ; incbin 'SYSINIT3.BIN' ; (SYINITSEG)
 19446                                  
 19447                                  ; 30/12/2022 - Retro DOS v4.2 
 19448                                  ; Retro DOS v4.0 - 2019
 19449                                  ; SYSINIT (MSDOS 6.21 IO.SYS) draft: 'sysinit3.s' (01/07/2019)
 19450                                   
 19451                                  ; 21/10/2022
 19452                                  ; ----------------------------------------------------------------------------
 19453                                  ; This source code (version) is based on SYSINIT source code of disassembled
 19454                                  ; MSDOS 5.0 IO.SYS file (SYSINIT.BIN) 
 19455                                  ; Dissassembler: Hex-Rays Interactive Disassembler (IDA)
 19456                                  ; ----------------------------------------------------------------------------
 19457                                  ; Binary file splitter & joiner: FFSJ v3.3
 19458                                  
 19459                                  ;--------------------------------------------------------------
 19460                                  ; SYSINIT.TXT (27/01/1983)
 19461                                  ;--------------------------------------------------------------
 19462                                  ;    SYSINIT is  a module linked behind the OEM bios.  It takes
 19463                                  ;over  the  system  initialization  after  the  OEM  bios   has
 19464                                  ;performed any  initialization  it  needs  to  do.   Control is
 19465                                  ;transfered with a long jump to the external  variable  SYSINIT
 19466                                  ;
 19467                                  ;
 19468                                  ;   The OEM  has  the  following  variables declared external:
 19469                                  ;
 19470                                  ;   CURRENT_DOS_LOCATION    WORD
 19471                                  ;
 19472                                  ;This word  contains  the  segment  number of the DOS before it
 19473                                  ;is relocated.  The OEM bios must set this value.
 19474                                  ;
 19475                                  ;   FINAL_DOS_LOCATION      WORD
 19476                                  ;
 19477                                  ;This word contains the segment number of the DOS after SYSINIT
 19478                                  ;moves it.  The OEM bios must set this value.
 19479                                  ;
 19480                                  ;   DEVICE_LIST             DWORD
 19481                                  ;
 19482                                  ;This  double  word  pointer  points  to  the  linked  list  of
 19483                                  ;character and block device drivers.  The  OEM  must  set  this
 19484                                  ;value.
 19485                                  ;
 19486                                  ;   MEMORY_SIZE             WORD
 19487                                  ;
 19488                                  ;This word  contains  the  number  of  RAM  paragraphs.  If the
 19489                                  ;bios doesn't set  this  variable  SYSINIT  will  automatically
 19490                                  ;calculate it.   NOTE:  systems with PARITY checked memory must
 19491                                  ;size memory in the BIOS.  SYSINITs method is to  write  memory
 19492                                  ;and read it back until it gets a mismatch.
 19493                                  ;
 19494                                  ;   DEFAULT_DRIVE           BYTE
 19495                                  ;
 19496                                  ;This is  the initial default drive when the system first comes
 19497                                  ;up.  drive a=0, drive b=1,  etc.   If  the  bios  doesn't  set
 19498                                  ;it then drive a is assumed.
 19499                                  ;
 19500                                  ;   BUFFERS                 BYTE
 19501                                  ;
 19502                                  ;This is  the  default  number of buffers for the system.  This
 19503                                  ;value may be overridden by the user in  the  CONFIG.SYS  file.
 19504                                  ;It is DBed to 2 in SYSINIT it should be greater than 1.
 19505                                  ;
 19506                                  ;   FILES                   BYTE
 19507                                  ;
 19508                                  ;This is  the  default  number  of  files for the system.  This
 19509                                  ;value may be overridden by the user in  the  CONFIG.SYS  file.
 19510                                  ;It is  DBed  to  8 in SYSINIT, values less than 5 are ignored.
 19511                                  ;
 19512                                  ;   SYSINIT                 FAR
 19513                                  ;
 19514                                  ;The entry  point  of  the  SYSINIT  module.  OEM BIOS jumps to
 19515                                  ;this label at the end of its INIT code.
 19516                                  ;
 19517                                  ;   The OEM  has  the  following  variables declared public:
 19518                                  ;
 19519                                  ;   RE_INIT                 FAR
 19520                                  ;
 19521                                  ;This is an entry point which allows the BIOS to do some INIT
 19522                                  ;work  after  the  DOS is initialized.  ALL REGISTERS MUST BE
 19523                                  ;PRESERVED.  On entry DS points to the first available memory
 19524                                  ;(after  the DOS).  DS:0 points to a 100H byte program header
 19525                                  ;prefix which represents  the  "program"  currently  running.
 19526                                  ;This  program  should  be  thought  of  as  the OEM BIOS and
 19527                                  ;SYSINIT taken together.  This is not  a  normal  program  in
 19528                                  ;that  no  memory  is  allocated to it, it is running in free
 19529                                  ;memory.
 19530                                  ;NOTES:
 19531                                  ;     At the time this routine is called SYSINIT occupies the
 19532                                  ;highest 10K of memory ("highest" is determined by the  value
 19533                                  ;of the MEMORY_SIZE variable), DO NOT DO WRITES THERE.
 19534                                  ;     Since this is called AFTER DOS is initialized, you can
 19535                                  ;make system calls.  This also implies that the code for this
 19536                                  ;routine    CANNOT   be   thrown   away   by   use   of   the
 19537                                  ;FINAL_DOS_LOCATION since the DOS has already been moved.
 19538                                  ;     If you don't want  anything done just set this to point
 19539                                  ;at a FAR RET instruction.
 19540                                  
 19541                                  ; ----------------------------------------------------------------------
 19542                                  ; TITLE   BIOS SYSTEM INITIALIZATION
 19543                                  ; ----------------------------------------------------------------------
 19544                                  
 19545                                  ;include version.inc
 19546                                  ; ----------------------------------------------------------------------
 19547                                  
 19548                                  ;FALSE   EQU     0
 19549                                  ;TRUE    EQU     0FFFFh
 19550                                  
 19551                                  ;IBMVER	    EQU     TRUE
 19552                                  ;IBMCOPYRIGHT EQU   FALSE
 19553                                  ;STACKSW    EQU	    TRUE		;Include Switchable Hardware Stacks
 19554                                  ;IBMJAPVER  EQU     FALSE		; If TRUE set KANJI true also
 19555                                  ;MSVER      EQU     FALSE
 19556                                  ;ALTVECT    EQU     FALSE		; Switch to build ALTVECT version
 19557                                  ;KANJI      EQU     FALSE
 19558                                  
 19559                                  ;(MSDOS 6.0, versiona.inc, 1991)
 19560                                  ; ----------------------------------------------------------------------
 19561                                  ;MAJOR_VERSION  EQU	6
 19562                                  ;;MINOR_VERSION	EQU	0	;6.00
 19563                                  ;MINOR_VERSION  EQU	21	;6.21  ; 21/03/2019 - Retro DOS v4.0
 19564                                  
 19565                                  ; 22/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0)
 19566                                  ; ----------------------------------------------------------------------
 19567                                  ;MAJOR_VERSION   EQU	5
 19568                                  ;MINOR_VERSION   EQU	0
 19569                                  
 19570                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21)
 19571                                  MAJOR_VERSION   EQU	6
 19572                                  MINOR_VERSION   EQU	22
 19573                                  
 19574                                  expected_version equ	(MINOR_VERSION<<8)+MAJOR_VERSION
 19575                                  
 19576                                  ;DOSREVNM equ	00000000b       ; m037 - bits 0-2 = revision number of DOS
 19577                                  				; currently 0.
 19578                                  DOSREVNM equ	00000111b	; [[[ 7 for Retro DOS v4.0 ]]] (21/03/2019)	
 19579                                  DOSINROM equ	00001000B       ; bit 3 of ver flags returned in BH
 19580                                  DOSINHMA equ	00010000B       ; bit 4 of ver flags 
 19581                                  
 19582                                  ;      if1
 19583                                  ;      %OUT  ... for DOS Version 5.00 ...
 19584                                  ;      endif
 19585                                  
 19586                                         ;******************************
 19587                                         ;Each assembler program should:
 19588                                         ;  mov ah,030h                   ;DOS Get Version function
 19589                                         ;  int 021h                      ;Version ret. in AX,minor version first
 19590                                         ;  cmp ax,expected_version       ;ALL utilities should check for an
 19591                                         ;  jne error_handler             ; EXACT version match.
 19592                                         ;******************************
 19593                                  
 19594                                  ; ----------------------------------------------------------------------
 19595                                  ; device definitions
 19596                                  
 19597                                  ;Attribute bit masks
 19598                                  DEVTYP  EQU     8000h           ;Bit 15 - 1  if Char, 0 if block
 19599                                  DEVIOCTL EQU    4000h           ;Bit 14 - CONTROL mode bit
 19600                                  ISFATBYDEV EQU  2000h           ;Bit 13 - Device uses FAT ID bytes, comp media.
 19601                                  ISCIN   EQU     0001h           ;Bit 0 - This device is the console input.
 19602                                  ISCOUT  EQU     0002h           ;Bit 1 - This device is the console output.
 19603                                  ISNULL  EQU     0004h           ;Bit 2 - This device is the null device.
 19604                                  ISCLOCK EQU     0008h           ;Bit 3 - This device is the clock device.
 19605                                  ISIBM   EQU     0010h           ;Bit 4 - This device is special
 19606                                  
 19607                                  ; The device table list has the form:
 19608                                  struc	SYSDEV
 19609 00000000 ????????                .NEXT:		resd 1		;Pointer to next device header
 19610 00000004 ????                    .ATT:		resw 1		;Attributes of the device
 19611 00000006 ????                    .STRAT:		resw 1		;Strategy entry point
 19612 00000008 ????                    .INT:		resw 1		;Interrupt entry point
 19613 0000000A ????????????????        .NAME:		resb 8		;Name of device (only first byte used for block)
 19614                                  .size:
 19615                                  endstruc
 19616                                  
 19617                                  ;Static Reguest Header
 19618                                  struc	SRHEAD
 19619 00000000 ??                      .REQLEN:	resb 1		;Length in bytes of request block
 19620 00000001 ??                      .REQUNIT:	resb 1		;Device unit number
 19621 00000002 ??                      .REQFUNC:	resb 1		;Type of request
 19622 00000003 ????                    .REQSTAT:	resw 1		;Status Word
 19623 00000005 ????????????????                	resb 8		;Reserved for queue links
 19624                                  .size:
 19625                                  endstruc
 19626                                  
 19627                                  ;Status word masks
 19628                                  STERR   EQU     8000H           ;Bit 15 - Error
 19629                                  STBUI   EQU     0200H           ;Bit 9 - Buisy
 19630                                  STDON   EQU     0100H           ;Bit 8 - Done
 19631                                  STECODE EQU     00FFH           ;Error code
 19632                                  WRECODE EQU     0
 19633                                  
 19634                                  ;Function codes
 19635                                  DEVINIT EQU     0               ;Initialization
 19636                                  DINITHL EQU     26              ;Size of init header
 19637                                  DEVMDCH EQU     1               ;Media check
 19638                                  DMEDHL  EQU     15              ;Size of media check header
 19639                                  DEVBPB  EQU     2               ;Get BPB
 19640                                  DEVRDIOCTL EQU  3               ;IOCTL read
 19641                                  DBPBHL  EQU     22              ;Size of Get BPB header
 19642                                  DEVRD   EQU     4               ;Read
 19643                                  DRDWRHL EQU     22              ;Size of RD/WR header
 19644                                  DEVRDND EQU     5               ;Non destructive read no wait (character devs)
 19645                                  DRDNDHL EQU     14              ;Size of non destructive read header
 19646                                  DEVIST  EQU     6               ;Input status
 19647                                  DSTATHL EQU     13              ;Size of status header
 19648                                  DEVIFL  EQU     7               ;Input flush
 19649                                  DFLSHL  EQU     15              ;Size of flush header
 19650                                  DEVWRT  EQU     8               ;Write
 19651                                  DEVWRTV EQU     9               ;Write with verify
 19652                                  DEVOST  EQU     10              ;Output status
 19653                                  DEVOFL  EQU     11              ;Output flush
 19654                                  DEVWRIOCTL EQU  12              ;IOCTL write
 19655                                  
 19656                                  ; ----------------------------------------------------------------------
 19657                                  struc	SYS_FCB
 19658 00000000 ??                      .fcb_drive:	resb 1
 19659 00000001 ????????????????        .fcb_name:	resb 8
 19660 00000009 ??????                  .fcb_ext:	resb 3
 19661 0000000C ????                    .fcb_EXTENT:	resw 1
 19662 0000000E ????                    .fcb_RECSIZ:	resw 1	; Size of record (user settable)
 19663 00000010 ????                    .fcb_FILSIZ:	resw 1	; Size of file in bytes; used with the following
 19664                                                          ; word
 19665 00000012 ????                    .fcb_DRVBP:	resw 1	; BP for SEARCH FIRST and SEARCH NEXT
 19666 00000014 ????                    .fcb_FDATE:	resw 1	; Date of last writing
 19667 00000016 ????                    .fcb_FTIME:	resw 1	; Time of last writing
 19668 00000018 ??                      .fcb_DEVID:	resb 1	; Device ID number, bits 0-5 if file.
 19669                                                          ; bit 7=0 for file, bit 7=1 for I/O device
 19670                                                          ; If file, bit 6=0 if dirty
 19671                                                          ; If I/O device, bit 6=0 if EOF (input)
 19672                                                          ;               Bit 5=1 if Raw mode
 19673                                                          ;               Bit 0=1 if console input device
 19674                                                          ;               Bit 1=1 if console output device
 19675                                                          ;               Bit 2=1 if null device
 19676                                                          ;               Bit 3=1 if clock device
 19677 00000019 ????                    .fcb_FIRCLUS:	resw 1	; First cluster of file
 19678 0000001B ????                    .fcb_CLUSPOS:	resw 1	; Position of last cluster accessed
 19679 0000001D ????                    .fcb_LSTCLUS:	resw 1	; Last cluster accessed and directory
 19680 0000001F ??                                   	resb 1	; pack 2 12 bit numbers into 24 bits...
 19681 00000020 ??                      .fcb_NR:	resb 1	; Next record
 19682 00000021 ????????                .fcb_RR:	resb 4	; Random record
 19683                                  .size:
 19684                                  endstruc
 19685                                  
 19686                                  ; ----------------------------------------------------------------------
 19687                                  ; Field definition for I/O buffer information
 19688                                  
 19689                                  ; 22/03/2019 - Retro DOS v4.0 (MSDOS 6.0, BUFFER.INC, 1991)
 19690                                  
 19691                                  struc buffinfo
 19692 00000000 ????                    .buf_next:	resw 1	; Pointer to next buffer in list
 19693 00000002 ????                    .buf_prev:	resw 1	; Pointer to previous buffer in list
 19694 00000004 ??                      .buf_ID:	resb 1	; Drive of buffer (bit 7 = 0)
 19695                                  			; SFT table index (bit 7 = 1)
 19696                                  			; = FFh if buffer free
 19697 00000005 ??                      .buf_flags:	resb 1	; Bit 7 = 1 if Remote file buffer
 19698                                  			;	= 0 if Local device buffer
 19699                                  			; Bit 6 = 1 if buffer dirty
 19700                                  			; Bit 5 = Reserved
 19701                                  			; Bit 4 = Search bit (bit 7 = 1)
 19702                                  			; Bit 3 = 1 if buffer is DATA
 19703                                  			; Bit 2 = 1 if buffer is DIR
 19704                                  			; Bit 1 = 1 if buffer is FAT
 19705                                  			; Bit 0 = Reserved
 19706 00000006 ????????                .buf_sector:	resd 1	; Sector number of buffer (bit 7 = 0)
 19707                                  ; The next two items are often refed as a word (bit 7 = 0)
 19708 0000000A ??                      .buf_wrtcnt:	resb 1	; For FAT sectors, # times sector written out
 19709 0000000B ????                    .buf_wrtcntinc:	resw 1	; "   "     "   , # sectors between each write
 19710 0000000D ????????                .buf_DPB :	resd 1	; Pointer to drive parameters
 19711 00000011 ????                    .buf_fill:	resw 1	; How full buffer is (bit 7 = 1)
 19712 00000013 ??                      .buf_reserved:	resb 1	; make DWORD boundary for 386
 19713                                  .size:
 19714                                  endstruc
 19715                                  
 19716                                  %define buf_offset	dword [buf_sector]
 19717                                  			;For bit 7 = 1, this is the byte
 19718                                  			;offset of the start of the buffer in
 19719                                  			;the file pointed to by buf_ID.  Thus
 19720                                  			;the buffer starts at location
 19721                                  			;buf_offset in the file and contains
 19722                                  			;buf_fill bytes.
 19723                                  
 19724                                  bufinsiz	equ	buffinfo.size ; ; Size of structure in bytes
 19725                                  
 19726                                  
 19727                                  buf_Free	equ	0FFh		; buf_id of free buffer
 19728                                  
 19729                                  ;Flag byte masks
 19730                                  buf_isnet	EQU	10000000B
 19731                                  buf_dirty	EQU	01000000B
 19732                                  ;***
 19733                                  buf_visit	EQU	00100000B
 19734                                  ;***
 19735                                  buf_snbuf	EQU	00010000B
 19736                                  
 19737                                  buf_isDATA	EQU	00001000B
 19738                                  buf_isDIR	EQU	00000100B
 19739                                  buf_isFAT	EQU	00000010B
 19740                                  buf_type_0	EQU	11110001B	; AND sets type to "none"
 19741                                  
 19742                                  buf_NetID	EQU	bufinsiz
 19743                                  
 19744                                  ; ----------------------------------------------------------------------
 19745                                  
 19746                                  ; ----------------------------------------------------------------------
 19747                                  ;**	DPB - Drive Parameter Block
 19748                                  
 19749                                  ; 25/03/2019 - Retro DOS v4.0 (MSDOS 6.0, DPB.INC, 1991)
 19750                                  
 19751                                  ;	BUGBUG - this isn't authorative - it's my probably incomplete and
 19752                                  ;	possibly inaccurate deductions from code study... - jgl
 19753                                  ;
 19754                                  ;	The DPB is DOS's main structure for describing block devices.
 19755                                  ;	It contains info about the "Drive" intermingled with info about
 19756                                  ;	the FAT file system which is presumably on the drive.  I don't know
 19757                                  ;	how those fields are used if it's not the FAT file system - BUGBUG
 19758                                  ;
 19759                                  ;	The DPBs are statically allocated and chained off of DPBHead.
 19760                                  ;	Users scan this chain looking for a match on DPB_DRIVE.
 19761                                  ;	The DPBs are built at init time from info in the SYSDEV structure.
 19762                                  
 19763                                  ; 08/06/2018 - Retro DOS v3.0 (MSDOS 3.3, DPB.INC, 24/07/1987)
 19764                                  
 19765                                  ; 12/05/2019 - Retro DOS v4.0
 19766                                  
 19767                                  struc	DPB
 19768 00000000 ??                      .DRIVE:		resb 1		; Logical drive # assoc with DPB (A=0,B=1,...)
 19769 00000001 ??                      .UNIT:		resb 1		; Driver unit number of DPB
 19770 00000002 ????                    .SECTOR_SIZE:	resw 1		; Size of physical sector in bytes
 19771 00000004 ??                      .CLUSTER_MASK:	resb 1		; Sectors/cluster - 1
 19772 00000005 ??                      .CLUSTER_SHIFT:	resb 1		; Log2 of sectors/cluster
 19773 00000006 ????                    .FIRST_FAT:	resw 1		; Starting record of FATs
 19774 00000008 ??                      .FAT_COUNT:	resb 1		; Number of FATs for this drive
 19775 00000009 ????                    .ROOT_ENTRIES:	resw 1		; Number of directory entries
 19776 0000000B ????                    .FIRST_SECTOR:	resw 1		; First sector of first cluster
 19777 0000000D ????                    .MAX_CLUSTER:	resw 1		; Number of clusters on drive + 1
 19778                                  ;.FAT_SIZE:	resb 1  ; MSDOS 3.3
 19779 0000000F ????                    .FAT_SIZE:	resw 1		; Number of records occupied by FAT
 19780 00000011 ????                    .DIR_SECTOR:	resw 1		; Starting record of directory
 19781 00000013 ????????                .DRIVER_ADDR:	resd 1		; Pointer to driver
 19782 00000017 ??                      .MEDIA:		resb 1		; Media byte
 19783 00000018 ??                      .FIRST_ACCESS:	resb 1		; This is initialized to -1 to force a media
 19784                                  				; check the first time this DPB is used
 19785 00000019 ????????                .NEXT_DPB:	resd 1		; Pointer to next Drive parameter block
 19786 0000001D ????                    .NEXT_FREE:	resw 1		; Cluster # of last allocated cluster
 19787 0000001F ????                    .FREE_CNT:	resw 1		; Count of free clusters, -1 if unknown
 19788                                  .size:
 19789                                  endstruc
 19790                                  
 19791                                  DPBSIZ  EQU     DPB.size	; Size of the structure in bytes
 19792                                  
 19793                                  DSKSIZ  EQU	DPB.MAX_CLUSTER	; Size of disk (temp used during init only)
 19794                                  
 19795                                  ; ----------------------------------------------------------------------
 19796                                  ; 26/03/2018
 19797                                  
 19798                                  ; IOCTL SUB-FUNCTIONS
 19799                                  IOCTL_GET_DEVICE_INFO	EQU	0
 19800                                  IOCTL_SET_DEVICE_INFO	EQU	1
 19801                                  IOCTL_READ_HANDLE	EQU	2
 19802                                  IOCTL_WRITE_HANDLE	EQU	3
 19803                                  IOCTL_READ_DRIVE	EQU	4
 19804                                  IOCTL_WRITE_DRIVE	EQU	5
 19805                                  IOCTL_GET_INPUT_STATUS	EQU	6
 19806                                  IOCTL_GET_OUTPUT_STATUS EQU	7
 19807                                  IOCTL_CHANGEABLE?	EQU	8
 19808                                  IOCTL_SHARING_RETRY	EQU	11
 19809                                  GENERIC_IOCTL_HANDLE	EQU	12
 19810                                  GENERIC_IOCTL		EQU	13
 19811                                  
 19812                                  ; GENERIC IOCTL SUB-FUNCTIONS
 19813                                  RAWIO			EQU	8
 19814                                  
 19815                                  ; RAWIO SUB-FUNCTIONS
 19816                                  GET_DEVICE_PARAMETERS	EQU	60H
 19817                                  SET_DEVICE_PARAMETERS	EQU	40H
 19818                                  READ_TRACK		EQU	61H
 19819                                  WRITE_TRACK		EQU	41H
 19820                                  VERIFY_TRACK		EQU	62H
 19821                                  FORMAT_TRACK		EQU	42H
 19822                                  
 19823                                  ; DEVICETYPE VALUES
 19824                                  MAX_SECTORS_IN_TRACK	EQU	63
 19825                                  DEV_5INCH		EQU	0
 19826                                  DEV_5INCH96TPI		EQU	1
 19827                                  DEV_3INCH720KB		EQU	2
 19828                                  DEV_8INCHSS		EQU	3
 19829                                  DEV_8INCHDS		EQU	4
 19830                                  DEV_HARDDISK		EQU	5
 19831                                  DEV_OTHER		EQU	7
 19832                                  ;DEV_3INCH1440KB	EQU	7
 19833                                  DEV_3INCH2880KB		EQU	9
 19834                                  ; Retro DOS v2.0 - 26/03/2018
 19835                                  ;;DEV_TAPE		EQU	6
 19836                                  ;;DEV_ERIMO		EQU	8
 19837                                  ;DEV_3INCH2880KB	EQU	9
 19838                                  DEV_3INCH1440KB		EQU	10
 19839                                  
 19840                                  ;MAX_DEV_TYPE		EQU	9	; MAXIMUM DEVICE TYPE THAT WE
 19841                                  					; CURRENTLY SUPPORT.
 19842                                  MAX_DEV_TYPE		EQU	10
 19843                                  
 19844                                  struc A_SECTORTABLE
 19845 00000000 ????                    .ST_SECTORNUMBER:	resw	1
 19846 00000002 ????                    .ST_SECTORSIZE:		resw	1
 19847                                  .size:
 19848                                  endstruc
 19849                                  
 19850                                  ; 25/03/2019 - Retro DOS v4.0  (MSDOS 6.0, BPB.INC, IOCTL.INC)
 19851                                  
 19852                                  ;**	BIOS PARAMETER BLOCK DEFINITION
 19853                                  ;
 19854                                  ;	The BPB contains information about the disk structure.  It dates
 19855                                  ;	back to the earliest FAT systems and so FAT information is
 19856                                  ;	intermingled with physical driver information.
 19857                                  ;
 19858                                  ;	A boot sector contains a BPB for its device; for other disks
 19859                                  ;	the driver creates a BPB.  DOS keeps copies of some of this
 19860                                  ;	information in the DPB.
 19861                                  ;
 19862                                  ;	The BDS structure contains a BPB within it.
 19863                                  
 19864                                  struc A_BPB
 19865 00000000 ????                    .BPB_BYTESPERSECTOR:	resw	1
 19866 00000002 ??                      .BPB_SECTORSPERCLUSTER:	resb	1
 19867 00000003 ????                    .BPB_RESERVEDSECTORS:	resw	1
 19868 00000005 ??                      .BPB_NUMBEROFFATS:	resb	1
 19869 00000006 ????                    .BPB_ROOTENTRIES: 	resw	1
 19870 00000008 ????                    .BPB_TOTALSECTORS:	resw	1
 19871 0000000A ??                      .BPB_MEDIADESCRIPTOR:	resb	1
 19872 0000000B ????                    .BPB_SECTORSPERFAT:	resw	1
 19873 0000000D ????                    .BPB_SECTORSPERTRACK:	resw	1
 19874 0000000F ????                    .BPB_HEADS:		resw	1
 19875 00000011 ????                    .BPB_HIDDENSECTORS:	resw	1
 19876 00000013 ????                    			resw	1
 19877 00000015 ????                    .BPB_BIGTOTALSECTORS:	resw	1
 19878 00000017 ????                    			resw	1
 19879 00000019 ????????????            			resb	6	; NOTE:  many times these
 19880                                  ;					; 	 6 bytes are omitted
 19881                                  ;					;	 when BPB manipulations
 19882                                  ;					;	 are performed!
 19883                                  .size:
 19884                                  endstruc
 19885                                  
 19886                                  struc A_DEVICEPARAMETERS
 19887 00000000 ??                      .DP_SPECIALFUNCTIONS:	resb	1
 19888 00000001 ??                      .DP_DEVICETYPE:		resb	1
 19889 00000002 ????                    .DP_DEVICEATTRIBUTES:	resw	1
 19890 00000004 ????                    .DP_CYLINDERS:		resw	1
 19891 00000006 ??                      .DP_MEDIATYPE:		resb	1
 19892 00000007 <res 1Fh>               .DP_BPB:		resb	A_BPB.size
 19893 00000026 ????                    .DP_TRACKTABLEENTRIES:	resw	1
 19894 00000028 <res FCh>               .DP_SECTORTABLE:	resb	MAX_SECTORS_IN_TRACK * A_SECTORTABLE.size
 19895                                  endstruc
 19896                                  
 19897                                  ; ----------------------------------------------------------------------
 19898                                  ; structure, equates for devmark for mem command.
 19899                                  
 19900                                  ; 25/03/2019 - Retro DOS v4.0 (MSDOS 6.0, DEVMARK.INC, 1991)
 19901                                  
 19902                                  struc devmark
 19903 00000000 ??                       .id:	    resb 1
 19904 00000001 ????                     .seg:	    resw 1
 19905 00000003 ????                     .size:	    resw 1
 19906 00000005 ??????                   .dum:	    resb 3
 19907 00000008 ????????????????         .filename: resb 8
 19908                                  endstruc
 19909                                  
 19910                                  devmark_stk	equ	'S'
 19911                                  devmark_device	equ	'D'
 19912                                  devmark_ifs	equ	'I'
 19913                                  devmark_buf	equ	'B'
 19914                                  devmark_cds	equ	'L' ; lastdrive
 19915                                  devmark_files	equ	'F'
 19916                                  devmark_fcbs	equ	'X'
 19917                                  devmark_inst	equ	'T' ; used for sysinit base for install= command.
 19918                                  devmark_ems_stub equ	'E'
 19919                                  
 19920                                  setbrkdone	equ	00000001b
 19921                                  for_devmark	equ	00000010b
 19922                                  not_for_devmark equ	11111101b
 19923                                  
 19924                                  ; ----------------------------------------------------------------------
 19925                                  ; Memory arena structure
 19926                                  
 19927                                  ; 24/03/2019 - Retro DOS v4.0 
 19928                                  ; (MSDOS 6.0, ARENA.INC)
 19929                                  
 19930                                  ;** Arena Header
 19931                                  
 19932                                  struc ARENA
 19933 00000000 ??                      .SIGNATURE:	resb 1		; 4D for valid item, 5A for last item
 19934 00000001 ????                    .OWNER:		resw 1		; owner of arena item
 19935 00000003 ????                    .SIZE:		resw 1		; size in paragraphs of item
 19936 00000005 ??????                  .RESERVED	resb 3		; reserved
 19937 00000008 ????????????????        .NAME:		resb 8		; owner file name
 19938                                  endstruc
 19939                                  
 19940                                  ; 12/04/2019
 19941                                  
 19942                                  arena_owner_system	EQU 0	; free block indication
 19943                                  
 19944                                  arena_signature_normal	EQU 4Dh ; valid signature, not end of arena
 19945                                  arena_signature_end	EQU 5Ah ; valid signature, last block in arena
 19946                                  
 19947                                  ; ----------------------------------------------------------------------
 19948                                  ; Process data block (otherwise known as program header)
 19949                                  
 19950                                  ; 23/03/2019 - Retro DOS v4.0
 19951                                  
 19952                                  ; (MSDOS 6.0 - PDB.INC, 1991)
 19953                                  
 19954                                  FILPERPROC	EQU     20
 19955                                  
 19956                                  struc PDB	; Process_data_block
 19957 00000000 ????                    .EXIT_CALL:	resw 1   	; INT int_abort system terminate
 19958 00000002 ????                    .BLOCK_LEN:	resw 1		; size of execution block
 19959 00000004 ??                                      resb 1
 19960 00000005 ??????????              .CPM_CALL:	resb 5		; ancient call to system
 19961 0000000A ????????                .EXIT:		resd 1		; pointer to exit routine
 19962 0000000E ????????                .CTRL_C:	resd 1		; pointer to ^C routine
 19963 00000012 ????????                .FATAL_ABORT:	resd 1		; pointer to fatal error
 19964 00000016 ????                    .PARENT_PID:	resw 1		; PID of parent (terminate PID)
 19965 00000018 <res 14h>               .JFN_TABLE:     resb FILPERPROC ; indices into system table
 19966 0000002C ????                    .ENVIRON:	resw 1		; seg addr of environment
 19967 0000002E ????????                .USER_STACK:	resd 1		; stack of self during system calls
 19968 00000032 ????                    .JFN_LENGTH:	resw 1 		; number of handles allowed
 19969 00000034 ????????                .JFN_POINTER:	resd 1 		; pointer to JFN table
 19970 00000038 ????????                .NEXT_PDB:	resd 1		; pointer to nested PDB's
 19971 0000003C ??                      .INTERCON:	resb 1 		; *** jh-3/28/90 ***
 19972 0000003D ??                      .APPEND:	resb 1		; *** Not sure if still used ***
 19973 0000003E ????                    .NOVELL_USED:	resb 2		; Novell shell (redir) uses these
 19974 00000040 ????                    .VERSION:	resw 1		; DOS version reported to this app
 19975 00000042 <res Eh>                .PAD1:		resb 14		; 	
 19976 00000050 ??????????              .CALL_SYSTEM:	resb 5		; portable method of system call
 19977 00000055 ??????????????          .PAD2:		resb 7 		; reserved so FCB 1 can be used as an extended FCB
 19978 0000005C <res 10h>               .FCB1:		resb 16		; default FCB 1
 19979 0000006C <res 10h>               .FCB2:		resb 16		; default FCB 2
 19980 0000007C ????????                .PAD3:		resb 4		; not sure if this is used by PDB_FCB2
 19981 00000080 <res 80h>               .TAIL:		resb 128	; command tail and default DTA
 19982                                  ;.size:
 19983                                  endstruc
 19984                                  
 19985                                  ; ----------------------------------------------------------------------
 19986                                  ; <system call definitions>
 19987                                  
 19988                                  ; 23/03/2019 - Retro DOS v4.0
 19989                                  
 19990                                  ; (MSDOS 6.0 - SYSCALL.INC, 1991)
 19991                                  
 19992                                  ABORT                           EQU 0   ;  0      0
 19993                                  STD_CON_INPUT                   EQU 1   ;  1      1
 19994                                  STD_CON_OUTPUT                  EQU 2   ;  2      2
 19995                                  STD_AUX_INPUT                   EQU 3   ;  3      3
 19996                                  STD_AUX_OUTPUT                  EQU 4   ;  4      4
 19997                                  STD_PRINTER_OUTPUT              EQU 5   ;  5      5
 19998                                  RAW_CON_IO                      EQU 6   ;  6      6
 19999                                  RAW_CON_INPUT                   EQU 7   ;  7      7
 20000                                  STD_CON_INPUT_NO_ECHO           EQU 8   ;  8      8
 20001                                  STD_CON_STRING_OUTPUT           EQU 9   ;  9      9
 20002                                  STD_CON_STRING_INPUT            EQU 10  ; 10      A
 20003                                  STD_CON_INPUT_STATUS            EQU 11  ; 11      B
 20004                                  STD_CON_INPUT_FLUSH             EQU 12  ; 12      C
 20005                                  DISK_RESET                      EQU 13  ; 13      D
 20006                                  SET_DEFAULT_DRIVE               EQU 14  ; 14      E
 20007                                  FCB_OPEN                        EQU 15  ; 15      F
 20008                                  FCB_CLOSE                       EQU 16  ; 16     10
 20009                                  DIR_SEARCH_FIRST                EQU 17  ; 17     11
 20010                                  DIR_SEARCH_NEXT                 EQU 18  ; 18     12
 20011                                  FCB_DELETE                      EQU 19  ; 19     13
 20012                                  FCB_SEQ_READ                    EQU 20  ; 20     14
 20013                                  FCB_SEQ_WRITE                   EQU 21  ; 21     15
 20014                                  FCB_CREATE                      EQU 22  ; 22     16
 20015                                  FCB_RENAME                      EQU 23  ; 23     17
 20016                                  GET_DEFAULT_DRIVE               EQU 25  ; 25     19
 20017                                  SET_DMA                         EQU 26  ; 26     1A
 20018                                  GET_DEFAULT_DPB                 EQU 31  ; 31     1F
 20019                                  FCB_RANDOM_READ                 EQU 33  ; 33     21
 20020                                  FCB_RANDOM_WRITE                EQU 34  ; 34     22
 20021                                  GET_FCB_FILE_LENGTH             EQU 35  ; 35     23
 20022                                  GET_FCB_POSITION                EQU 36  ; 36     24
 20023                                  SET_INTERRUPT_VECTOR            EQU 37  ; 37     25
 20024                                  CREATE_PROCESS_DATA_BLOCK       EQU 38  ; 38     26
 20025                                  FCB_RANDOM_READ_BLOCK           EQU 39  ; 39     27
 20026                                  FCB_RANDOM_WRITE_BLOCK          EQU 40  ; 40     28
 20027                                  PARSE_FILE_DESCRIPTOR           EQU 41  ; 41     29
 20028                                  GET_DATE                        EQU 42  ; 42     2A
 20029                                  SET_DATE                        EQU 43  ; 43     2B
 20030                                  GET_TIME                        EQU 44  ; 44     2C
 20031                                  SET_TIME                        EQU 45  ; 45     2D
 20032                                  SET_VERIFY_ON_WRITE             EQU 46  ; 46     2E
 20033                                  ; Extended functionality group
 20034                                  GET_DMA                         EQU 47  ; 47     2F
 20035                                  GET_VERSION                     EQU 48  ; 48     30
 20036                                  KEEP_PROCESS                    EQU 49  ; 49     31
 20037                                  GET_DPB                         EQU 50  ; 50     32
 20038                                  SET_CTRL_C_TRAPPING             EQU 51  ; 51     33
 20039                                  GET_INDOS_FLAG                  EQU 52  ; 52     34
 20040                                  GET_INTERRUPT_VECTOR            EQU 53  ; 53     35
 20041                                  GET_DRIVE_FREESPACE             EQU 54  ; 54     36
 20042                                  CHAR_OPER                       EQU 55  ; 55     37
 20043                                  INTERNATIONAL                   EQU 56  ; 56     38
 20044                                  ;   Directory Group
 20045                                  MKDIR                           EQU 57  ; 57     39
 20046                                  RMDIR                           EQU 58  ; 58     3A
 20047                                  CHDIR                           EQU 59  ; 59     3B
 20048                                  ;   File Group
 20049                                  CREAT                           EQU 60  ; 60     3C
 20050                                  OPEN                            EQU 61  ; 61     3D
 20051                                  CLOSE                           EQU 62  ; 62     3E
 20052                                  READ                            EQU 63  ; 63     3F
 20053                                  WRITE                           EQU 64  ; 64     40
 20054                                  UNLINK                          EQU 65  ; 65     41
 20055                                  LSEEK                           EQU 66  ; 66     42
 20056                                  CHMOD                           EQU 67  ; 67     43
 20057                                  IOCTL                           EQU 68  ; 68     44
 20058                                  XDUP                            EQU 69  ; 69     45
 20059                                  XDUP2                           EQU 70  ; 70     46
 20060                                  CURRENT_DIR                     EQU 71  ; 71     47
 20061                                  ;    Memory Group
 20062                                  ALLOC                           EQU 72  ; 72     48
 20063                                  DEALLOC                         EQU 73  ; 73     49
 20064                                  SETBLOCK                        EQU 74  ; 74     4A
 20065                                  ;    Process Group
 20066                                  EXEC                            EQU 75  ; 75     4B
 20067                                  EXIT                            EQU 76  ; 76     4C
 20068                                  WAITPROCESS			EQU 77  ; 77     4D
 20069                                  FIND_FIRST                      EQU 78  ; 78     4E
 20070                                  ;   Special Group
 20071                                  FIND_NEXT                       EQU 79  ; 79     4F
 20072                                  ; SPECIAL SYSTEM GROUP
 20073                                  SET_CURRENT_PDB                 EQU 80  ; 80     50
 20074                                  GET_CURRENT_PDB                 EQU 81  ; 81     51
 20075                                  GET_IN_VARS                     EQU 82  ; 82     52
 20076                                  SETDPB                          EQU 83  ; 83     53
 20077                                  GET_VERIFY_ON_WRITE             EQU 84  ; 84     54
 20078                                  DUP_PDB                         EQU 85  ; 85     55
 20079                                  RENAME                          EQU 86  ; 86     56
 20080                                  FILE_TIMES                      EQU 87  ; 87     57
 20081                                  ;
 20082                                  ALLOCOPER			EQU 88	; 88     58	
 20083                                  ; Network extention system calls
 20084                                  GetExtendedError		EQU 89	; 89	 59
 20085                                  CreateTempFile			EQU 90	; 90	 5A
 20086                                  CreateNewFile			EQU 91	; 91	 5B
 20087                                  LockOper			EQU 92	; 92	 5C Lock and Unlock
 20088                                  ServerCall			EQU 93	; 93	 5D CommitAll, ServerDOSCall,
 20089                                  					;	    CloseByName, CloseUser,
 20090                                  					;	    CloseUserProcess,
 20091                                  					;	    GetOpenFileList
 20092                                  UserOper			EQU 94	; 94	 5E Get and Set
 20093                                  AssignOper			EQU 95	; 95	 5F On, Off, Get, Set, Cancel
 20094                                  xNameTrans			EQU 96	; 96	 60
 20095                                  PathParse			EQU 97	; 97	 61
 20096                                  GetCurrentPSP			EQU 98	; 98	 62
 20097                                  Hongeul 			EQU 99	; 99	 63
 20098                                  ECS_CALL			EQU 99	; 99	 63  ;; DBCS support
 20099                                  Set_Printer_Flag		EQU 100 ; 100	 64
 20100                                  GetExtCntry			EQU 101 ; 101	 65
 20101                                  GetSetCdPg			EQU 102 ; 102	 66
 20102                                  ExtHandle			EQU 103 ; 103	 67
 20103                                  Commit				EQU 104 ; 104	 68
 20104                                  GetSetMediaID			EQU 105 ; 105	 69
 20105                                  IFS_IOCTL			EQU 107 ; 107	 6B
 20106                                  ExtOpen 			EQU 108 ; 108	 6C
 20107                                  ;
 20108                                  ;ifdef ROMEXEC
 20109                                  ;ROM_FIND_FIRST			EQU 109 ; 109    6D
 20110                                  ;ROM_FIND_NEXT			EQU 110 ; 110    6E
 20111                                  ;ROM_EXCLUDE			EQU 111 ; 111	 6F
 20112                                  ;endif
 20113                                  ;
 20114                                  Set_Oem_Handler 		EQU 248 ; 248	 F8
 20115                                  OEM_C1				EQU 249 ; 249	 F9
 20116                                  OEM_C2				EQU 250 ; 250	 FA
 20117                                  OEM_C3				EQU 251 ; 251	 FB
 20118                                  OEM_C4				EQU 252 ; 252	 FC
 20119                                  OEM_C5				EQU 253 ; 253	 FD
 20120                                  OEM_C6				EQU 254 ; 254	 FE
 20121                                  OEM_C7				EQU 255 ; 255	 FF
 20122                                  
 20123                                  ; ----------------------------------------------------------------------
 20124                                  ; SYSCONF.ASM (MSDOS 3.3 - 24/07/1987) 	
 20125                                  ; ----------------------------------------------------------------------
 20126                                  
 20127                                  ;;	IF	STACKSW
 20128                                  
 20129                                  ;;
 20130                                  ;; Internal Stack Parameters
 20131                                  ;EntrySize		equ	8
 20132                                  ;
 20133                                  ;MinCount		equ	8
 20134                                  ;DefaultCount		equ	9
 20135                                  ;MaxCount		equ	64
 20136                                  ;
 20137                                  ;MinSize 		equ	32
 20138                                  ;DefaultSize		equ	128
 20139                                  ;MaxSize 		equ	512
 20140                                  
 20141                                  ;;	ENDIF
 20142                                  
 20143                                  ; ----------------------------------------------------------------------
 20144                                  ; BIOSTRUC.INC (MSDOS 3.3 - 24/07/1987) 	
 20145                                  ; ----------------------------------------------------------------------
 20146                                  					  ;;Rev 3.30 Modification
 20147                                  ; ROM BIOS CALL PACKET STRUCTURES					  
 20148                                  									  
 20149                                  ;*******************************					  
 20150                                  ;System Service call ( Int 15h )					  
 20151                                  ;*******************************					  
 20152                                  ;Function AH = 0C0h, Return system configuration			  
 20153                                  ;For PC and PCJR on return:						  
 20154                                  ;	(AH)	= 80h							  
 20155                                  ;	(CY)	= 1							  
 20156                                  ;For PCXT, PC PORTABLE and PCAT on return:				  
 20157                                  ;	(AH)	= 86h							  
 20158                                  ;	(CY)	= 1							  
 20159                                  ;For all others:							  
 20160                                  ;	(AH)	= 0							  
 20161                                  ;	(CY)	= 0							  
 20162                                  ;	(ES:BX) = pointer to system descriptor vector in ROS		  
 20163                                  ; System descriptor :							  
 20164                                  ;	DW	xxxx		length of descriptor in bytes,		  
 20165                                  ;				minimum length = 8			  
 20166                                  ;	DB	xx		model byte				  
 20167                                  ;				0FFh	= PC				  
 20168                                  ;				0FEh	= PC/XT, Portable		  
 20169                                  ;				0FDh	= PC/JR 			  
 20170                                  ;				0FCh	= PC/AT				  
 20171                                  ;				0F9h	= Convertable			  
 20172                                  ;				0F8h	= Model 80			  
 20173                                  ;				0E0 thru 0EFh = reserved		  
 20174                                  ;									  
 20175                                  ;	DB	xx		secondary model byte			  
 20176                                  ;				000h	= PC1				  
 20177                                  ;				000h	= PC/XT, Portable		  
 20178                                  ;				000h	= PC/JR 			  
 20179                                  ;				000h	= PC/AT 			  
 20180                                  ;				001h	= PC/AT Model 339		  
 20181                                  ;				003h	= PC/RT				  
 20182                                  ;				000h	= Convertable			  
 20183                                  ;									  
 20184                                  ;	DB	xx		bios revision level			  
 20185                                  ;				00 for first release, subsequent release  
 20186                                  ;				of code with same model byte and	  
 20187                                  ;				secondary model byte require revison level
 20188                                  ;				to increase by one.			  
 20189                                  ;									  
 20190                                  ;	DB	xx		feature information byte 1		  
 20191                                  ;				X0000000 = 1, bios use DMA channel 3	  
 20192                                  ;					 = 0, DMA channel 3 not used	  
 20193                                  ;									  
 20194                                  ;				0X000000 = 1, 2nd Interrupt chip present  
 20195                                  ;					 = 0, 2nd Interrupt chip not present
 20196                                  ;									  
 20197                                  ;				00X00000 = 1, Real Time Clock present	  
 20198                                  ;					 = 0, Real Time Clock not present 
 20199                                  ;									  
 20200                                  ;				000X0000 = 1, Keyboard escape sequence(INT 15h)
 20201                                  ;						called in keyboard interrupt
 20202                                  ;						(Int 09h).		  
 20203                                  ;					 = 0, Keyboard escape sequence not
 20204                                  ;						called. 		  
 20205                                  ;				0000XXXX reserved			  
 20206                                  ;									  
 20207                                  ;	DB	xx		feature information byte 2 - reserved	  
 20208                                  ;									  
 20209                                  ;	DB	xx		feature information byte 2 - reserved	  
 20210                                  ;									  
 20211                                  ;	DB	xx		feature information byte 2 - reserved	  
 20212                                  ;									  
 20213                                  ;	DB	xx		feature information byte 2 - reserved	  
 20214                                  ;									  
 20215                                  
 20216                                  ; 22/03/2019									  
 20217                                  struc ROMBIOS_DESC		; BIOS_SYSTEM_DESCRIPTOR						  
 20218 00000000 ????                    .bios_sd_leng:		resw 1				  
 20219 00000002 ??                      .bios_sd_modelbyte:	resb 1					  
 20220                                  .bios_sd_scnd_modelbyte: 
 20221 00000003 ??                      			resb 1					  
 20222 00000004 ??                      			resb 1					  
 20223 00000005 ??                      .bios_sd_featurebyte1:	resb 1					  
 20224 00000006 ????????                			resb 4					  
 20225                                  endstruc					  
 20226                                  									  
 20227                                  ;FeatureByte1	bit map equates 					  
 20228                                  DMAchannel3		equ 10000000b					  
 20229                                  ScndIntController	equ 01000000b					  
 20230                                  RealTimeClock		equ 00100000b					  
 20231                                  KeyEscapeSeq		equ 00010000b					  
 20232                                  					;;End of Modification
 20233                                  
 20234                                  ; ----------------------------------------------------------------------
 20235                                  ; SYSVAR.INC (MSDOS 6.0 - 1991) 	
 20236                                  ; ----------------------------------------------------------------------
 20237                                  ; 22/03/2019 - Retro DOS v4.0
 20238                                  
 20239                                  ;	SCCSID = @(#)sysvar.asm 1.1 85/04/10
 20240                                  
 20241                                  struc SysInitVars
 20242                                  ; MSDOS 3.3
 20243 00000000 ????????                .SYSI_DPB:    resd 1			; DPB chain
 20244 00000004 ????????                .SYSI_SFT:    resd 1			; SFT chain
 20245 00000008 ????????                .SYSI_CLOCK:  resd 1			; CLOCK device
 20246 0000000C ????????                .SYSI_CON:    resd 1			; CON device
 20247 00000010 ????                    .SYSI_MAXSEC: resw 1			; maximum sector size
 20248 00000012 ????????                .SYSI_BUF:    resd 1			; buffer chain
 20249 00000016 ????????                .SYSI_CDS:    resd 1			; CDS list
 20250 0000001A ????????                .SYSI_FCB:    resd 1			; FCB chain
 20251 0000001E ????                    .SYSI_KEEP:   resw 1			; keep count
 20252 00000020 ??                      .SYSI_NUMIO:  resb 1			; number of block devices
 20253 00000021 ??                      .SYSI_NCDS:   resb 1			; number of CDS's
 20254 00000022 ????????                .SYSI_DEV:    resd 1			; device list
 20255                                  ; MSDOS 6.0
 20256 00000026 ????                    .SYSI_ATTR:	    resw 1		; null device attribute word
 20257 00000028 ????                    .SYSI_STRAT:	    resw 1		; null device strategy entry point
 20258 0000002A ????                    .SYSI_INTER:	    resw 1		; null device interrupt entry point
 20259 0000002C ????????????????        .SYSI_NAME:	    resb 8		; null device name
 20260                                  .SYSI_SPLICE:	    resb 0		; TRUE -> splicees being done
 20261 00000034 ????                    .SYSI_IBMDOS_SIZE:  resw 1		; DOS size in paragraphs
 20262 00000036 ????????                .SYSI_IFS_DOSCALL@: resd 1		; IFS DOS service rountine entry
 20263 0000003A ????????                .SYSI_IFS:	    resd 1	 	; IFS header chain
 20264 0000003E ????????                .SYSI_BUFFERS:	    resw 2		; BUFFERS= values (m,n)
 20265 00000042 ??                      .SYSI_BOOT_DRIVE:   resb 1		; boot drive A=1 B=2,..
 20266 00000043 ??                      .SYSI_DWMOVE:	    resb 1		; 1 if 386 machine
 20267 00000044 ????                    .SYSI_EXT_MEM:	    resw 1		; Extended memory size in KB.
 20268                                  .size:
 20269                                  endstruc
 20270                                  
 20271                                  ;This is added for more information exchage between DOS, BIOS.
 20272                                  ;DOS will give the pointer to SysInitTable in ES:DI. - J.K. 5/29/86
 20273                                  
 20274                                  ; 22/03/2019
 20275                                  struc SysInitVars_Ext
 20276 00000000 ????????                .SYSI_InitVars:	   resd 1	; Points to the above structure.
 20277 00000004 ????????                .SYSI_Country_Tab: resd 1	; DOS_Country_cdpg_info
 20278                                  endstruc
 20279                                  
 20280                                  ; 09/06/2018
 20281                                  ; 08/06/2018 - Retro DOS v3.0 (MSDOS 3.3)
 20282                                  SYSI_DPB    equ	0
 20283                                  SYSI_SFT    equ 4
 20284                                  SYSI_CLOCK  equ 8
 20285                                  SYSI_CON    equ 12
 20286                                  SYSI_MAXSEC equ 16
 20287                                  SYSI_BUF    equ 18 		
 20288                                  SYSI_CDS    equ 22
 20289                                  SYSI_FCB    equ 26
 20290                                  SYSI_KEEP   equ 30
 20291                                  SYSI_NUMIO  equ	32
 20292                                  SYSI_NCDS   equ	33
 20293                                  SYSI_DEV    equ 34
 20294                                  ; 22/03/2019 - Retro DOS v4.0 (MSDOS 6.0)
 20295                                  SYSI_ATTR	  equ 38
 20296                                  SYSI_STRAT	  equ 40
 20297                                  SYSI_INTER	  equ 42
 20298                                  SYSI_NAME	  equ 44
 20299                                  SYSI_SPLICE	  equ 52
 20300                                  SYSI_IBMDOS_SIZE  equ 53
 20301                                  SYSI_IFS_DOSCALL@ equ 55
 20302                                  SYSI_IFS	  equ 59
 20303                                  SYSI_BUFFERS	  equ 63
 20304                                  SYSI_BOOT_DRIVE   equ 67
 20305                                  SYSI_DWMOVE	  equ 68
 20306                                  SYSI_EXT_MEM	  equ 69
 20307                                  
 20308                                  ;The SYSI_BUF of SysInitVars points to the following structure
 20309                                  
 20310                                  EMS_MAP_BUFF_SIZE EQU 12	; EMS map buffer size
 20311                                  
 20312                                  struc BUFFINF 	; BUFFINFO
 20313 00000000 ????????                .Buff_Queue:	   resd	1	; Head of list of buffers
 20314 00000004 ????                    .Dirty_Buff_Count: resw 1	; number of dirty buffers in list
 20315 00000006 ????????                .Cache_ptr:	   resd 1	; pointer to secondary cache
 20316 0000000A ????                    .Cache_count:      resw 1	; number of secondary cache entries
 20317                                  
 20318 0000000C ??                      .Buff_In_HMA:	   resb 1	; flag to indicate that buffers
 20319                                  				; are in HMA
 20320 0000000D ????????                .Lo_Mem_Buff:	   resd 1	; Ptr to scratch buff in Low Mem
 20321                                  				;  used to read/write on disks
 20322 00000011 ????????                .UU_EMS_FIRST_PAGE:	resw 2
 20323 00000015 ????                    .UU_EMS_NPA640:		resw 1
 20324 00000017 ??                      .UU_EMS_mode:		resb 1	 ; no EMS = -1
 20325 00000018 ????                    .UU_EMS_handle:		resw 1	 ; EMS handle for buffers
 20326 0000001A ????                    .UU_EMS_PageFrame_Number: resw 1 ; EMS page frame number
 20327 0000001C ????                    .UU_EMS_Seg_Cnt:	resw 1	 ; EMS segment count
 20328 0000001E ????                    .UU_EMS_Page_Frame:	resw 1	 ; EMS page frame segment address
 20329 00000020 ????                    .UU_EMS_reserved:	resw 1	 ; EMS segment count
 20330 00000022 ??                      .UU_EMS_Map_Buff:	resb 1	 ; map buffer
 20331                                  .size:
 20332                                  endstruc
 20333                                  
 20334                                  ; ----------------------------------------------------------------------
 20335                                  ; CURDIR.INC (MSDOS 6.0 - 1991) 	
 20336                                  ; ----------------------------------------------------------------------
 20337                                  ; 22/03/2019 - Retro DOS v4.0
 20338                                  
 20339                                  ;**	CDS - Current Directory Structure
 20340                                  ;
 20341                                  ; CDS items are used bu the internal routines to store cluster numbers and
 20342                                  ; network identifiers for each logical name.  The ID field is used dually,
 20343                                  ; both as net ID and for a cluster number for local devices. In the case
 20344                                  ; of local devices, the cluster number will be -1 if there is a potential
 20345                                  ; of the disk being changed or if the path must be recracked.
 20346                                  ;
 20347                                  ;	Some pathnames have special preambles, such as
 20348                                  ;
 20349                                  ;		\\machine\sharename\...
 20350                                  ;	For these pathnames we can't allow ".." processing to back us
 20351                                  ;	up into the special front part of the name.  The CURDIR_END field
 20352                                  ;	holds the address of the seperator character which marks
 20353                                  ;	the split between the special preamble and the regular
 20354                                  ;	path list; ".." processing isn't allowed to back us up past
 20355                                  ;	(i.e., before) CURDIR_END
 20356                                  ;	For the root, it points at the leading /. For net
 20357                                  ;	assignments it points at the end (nul) of the initial assignment:
 20358                                  ;	A:/	\\foo\bar	    \\foo\bar\blech\bozo
 20359                                  ;	  ^		 ^		     ^
 20360                                  
 20361                                  DIRSTRLEN	EQU	64+3		; Max length in bytes of directory strings
 20362                                  TEMPLEN 	EQU	DIRSTRLEN*2
 20363                                  
 20364                                  struc 		curdir_list
 20365                                  ; MSDOS 3.3
 20366 00000000 <res 43h>               .cdir_text	resb	DIRSTRLEN	; text of assignment and curdir
 20367 00000043 ????                    .cdir_flags	resw	1		; various flags
 20368 00000045 ????????                .cdir_devptr	resd	1		; local pointer to DPB or net device
 20369 00000049 ????????                .cdir_ID	resw	2		; cluster of current dir (net ID)
 20370 0000004D ????                    .cdir_usr_word	resw	1
 20371 0000004F ????                    .cdir_end	resw	1		; end of assignment
 20372                                  ; MSDOS 6.0
 20373 00000051 ??                      .cdir_type:	resb	1		; IFS drive (2=ifs, 4=netuse)
 20374 00000052 ????????                .cdir_ifd_hdr:	resd	1		; Ptr to File System Header
 20375 00000056 ????                    .cdir_fsda:	resb	2		; File System Dependent Data Area
 20376                                  .size:
 20377                                  endstruc
 20378                                  
 20379                                  curdirlen	EQU	curdir_list.size	; Needed for screwed up
 20380                                  						; ASM87 which doesn't allow
 20381                                  						; Size directive as a macro
 20382                                  						; argument
 20383                                  %define curdir_netID	dword [curdir_list.cdir_ID]
 20384                                  
 20385                                  ;**	Flag values for CURDIR_FLAGS
 20386                                  
 20387                                  ;Flag word masks
 20388                                  curdir_isnet	EQU	1000000000000000B
 20389                                  curdir_isifs	EQU	1000000000000000B
 20390                                  curdir_inuse	EQU	0100000000000000B
 20391                                  curdir_splice	EQU	0010000000000000B
 20392                                  curdir_local	EQU	0001000000000000B
 20393                                  
 20394                                  ; ----------------------------------------------------------------------
 20395                                  ; SF.INC (MSDOS 6.0 - 1991) 	
 20396                                  ; ----------------------------------------------------------------------
 20397                                  ; 25/03/2019 - Retro DOS v4.0
 20398                                  
 20399                                  ; system file table
 20400                                  
 20401                                  ;**	System File Table SuperStructure
 20402                                  ;
 20403                                  ;	The system file table entries are allocated in contiguous groups.
 20404                                  ;	There may be more than one such groups; the SF "superstructure"
 20405                                  ;	tracks the groups.
 20406                                  
 20407                                  struc	SF
 20408 00000000 ????????                .SFLink:	resd	1
 20409 00000004 ????                    .SFCount:	resw	1		; number of entries
 20410 00000006 ????                    .SFTable:	resw	1		; beginning of array of the following
 20411                                  .size:
 20412                                  endstruc
 20413                                  
 20414                                  ;**	System file table entry
 20415                                  ;
 20416                                  ;	These are the structures which are at SFTABLE in the SF structure.
 20417                                  
 20418                                  struc	SF_ENTRY
 20419 00000000 ????                    .sf_ref_count:	resw	1		; number of processes sharing entry
 20420                                  					;   if FCB then ref count
 20421 00000002 ????                    .sf_mode: 	resw	1		; mode of access or high bit on if FCB
 20422 00000004 ??                      .sf_attr: 	resb	1		; attribute of file
 20423 00000005 ????                    .sf_flags:	resw	1		;Bits 8-15
 20424                                  					; Bit 15 = 1 if remote file
 20425                                  					;	 = 0 if local file or device
 20426                                  					; Bit 14 = 1 if date/time is not to be
 20427                                  					;   set from clock at CLOSE.  Set by
 20428                                  					;   FILETIMES and FCB_CLOSE.  Reset by
 20429                                  					;   other reseters of the dirty bit
 20430                                  					;   (WRITE)
 20431                                  					; Bit 13 = Pipe bit (reserved)
 20432                                  					;
 20433                                  					; Bits 0-7 (old FCB_devid bits)
 20434                                  					; If remote file or local file, bit
 20435                                  					; 6=0 if dirty Device ID number, bits
 20436                                  					; 0-5 if local file.
 20437                                  					; bit 7=0 for local file, bit 7
 20438                                  					;      =1 for local I/O device
 20439                                  					; If local I/O device, bit 6=0 if EOF (input)
 20440                                  					;		Bit 5=1 if Raw mode
 20441                                  					;		Bit 0=1 if console input device
 20442                                  					;		Bit 1=1 if console output device
 20443                                  					;		Bit 2=1 if null device
 20444                                  					;		Bit 3=1 if clock device
 20445 00000007 ????????                .sf_devptr:	resd	1		; Points to DPB if local file, points
 20446                                  					; to device header if local device,
 20447                                  					; points to net device header if
 20448                                  					; remote
 20449 0000000B ????                    .sf_firclus:	resw	1		; First cluster of file (bit 15 = 0)
 20450                                  ;.sf_lstclus:	resw	1 ; *	
 20451 0000000D ????                    .sf_time: 	resw	1		; Time associated with file
 20452 0000000F ????                    .sf_date: 	resw	1		; Date associated with file
 20453 00000011 ????????                .sf_size: 	resd	1		; Size associated with file
 20454 00000015 ????????                .sf_position:	resd	1		; Read/Write pointer or LRU count for FCBs
 20455                                  ;
 20456                                  ; Starting here, the next 7 bytes may be used by the file system to store an
 20457                                  ; ID
 20458                                  ;
 20459 00000019 ????                    .sf_cluspos:	resw	1		; Position of last cluster accessed
 20460 0000001B ????                    .sf_dirsec:	resw	1		; Sector number of directory sector for this file
 20461 0000001D ??                      .sf_dirpos:	resb	1		; Offset of this entry in the above
 20462                                  ;
 20463                                  ; End of 7 bytes of file-system specific info.
 20464                                  ;
 20465 0000001E <res Bh>                .sf_name:	resb	11		; 11 character name that is in the
 20466                                  					; directory entry.  This is used by
 20467                                  					; close to detect file deleted and
 20468                                  					; disk changed errors.
 20469                                  ; SHARING INFO
 20470 00000029 ????????                .sf_chain:	resd	1		; link to next SF
 20471 0000002D ????                    .sf_UID:	resw	1
 20472 0000002F ????                    .sf_PID:	resw	1
 20473 00000031 ????                    .sf_MFT:	resw	1
 20474 00000033 ????                    .sf_lstclus:	resw	1 ; *		; Last cluster accessed
 20475 00000035 ????????                .sf_IFS_HDR:	resd 	1 ; **
 20476                                  .size:
 20477                                  endstruc
 20478                                  
 20479                                  ; ----------------------------------------------------------------------
 20480                                  ; DOSCNTRY.INC (MSDOS 3.3 - 24/07/1987) 	
 20481                                  ; ----------------------------------------------------------------------
 20482                                  ; 11/06/2018 - Retro DOS v3.0
 20483                                  
 20484                                  ;Equates for COUNTRY INFORMATION.
 20485                                  SetCountryInfo		EQU	1	;country info
 20486                                  SetUcase		EQU	2	;uppercase table
 20487                                  SetLcase		EQU	3	;lowercase table (Reserved)
 20488                                  SetUcaseFile		EQU	4	;uppercase file spec table
 20489                                  SetFileList		EQU	5	;valid file character list
 20490                                  SetCollate		EQU	6	;collating sequence
 20491                                  SetDBCS 		EQU	7	;double byte character set
 20492                                  SetALL			EQU	-1	;all the entries
 20493                                  
 20494                                  ;DOS country and code page information table structure.
 20495                                  ;Internally, IBMDOS gives a pointer to this table.
 20496                                  ;IBMBIO, MODE and NLSFUNC modules communicate with IBMDOS through
 20497                                  ;this structure.
 20498                                  
 20499                                  struc country_cdpg_info ; DOS_country_cdpg_info
 20500 00000000 ????????????????        .ccInfo_reserved :	resb	8	;reserved for internal use
 20501 00000008 <res 40h>               .ccPath_CountrySys:	resb	64	;path and filename for country info
 20502 00000048 ????                    .ccSysCodePage:		resw	1	;system code page id
 20503 0000004A ????                    .ccNumber_of_entries:	resw	1 ; dw 5
 20504 0000004C ??                      .ccSetUcase:		resb	1 ; db SetUcase ; = 2
 20505 0000004D ????????                .ccUcase_ptr:		resd	1	;pointer to Ucase table
 20506                                  
 20507 00000051 ??                      .ccSetUcaseFile:	resb	1 ; db SetUcaseFile ; = 4
 20508 00000052 ????????                .ccFileUcase_ptr: 	resd	1	;pointer to File Ucase table
 20509                                  
 20510 00000056 ??                      .ccSetFileList:		resb	1 ; db SetFileList ; = 5
 20511 00000057 ????????                .ccFileChar_ptr:	resd	1	;pointer to File char list table
 20512                                  
 20513 0000005B ??                      .ccSetCollate:		resb	1 ; db SetCollate ; = 6
 20514 0000005C ????????                .ccCollate_ptr:		resd	1	;pointer to collate table
 20515                                  
 20516 00000060 ??                      .ccSetCountryInfo:	resb	1 ; db SetCountryInfo ; = 1
 20517 00000061 ????                    .ccCountryInfoLen:	resw	1	;length of country info
 20518 00000063 ????                    .ccDosCountry:		resw	1	;system country code id
 20519 00000065 ????                    .ccDosCodePage:		resw	1	;system code page id
 20520 00000067 ????                    .ccDFormat:		resw	1	;date format
 20521 00000069 ??????????              .ccCurSymbol:		resb	5 ; db "    ",0
 20522                                  					;5 byte of (currency symbol+0)
 20523 0000006E ????                    .cc1000Sep:		resb	2 ; db " ",0 ;2 byte of (1000 sep. + 0)
 20524 00000070 ????                    .ccDecSep:		resb	2 ; db " ",0 ;2 byte of (Decimal sep. + 0)
 20525 00000072 ????                    .ccDateSep:		resb	2 ; db " ",0 ;2 byte of (date sep. + 0)
 20526 00000074 ????                    .ccTimeSep:		resb 	2 ; db " ",0 ;2 byte of (time sep. + 0)
 20527 00000076 ??                      .ccCFormat:		resb	1 	;currency format flags
 20528 00000077 ??                      .ccCSigDigits:		resb	1	;# of digits in currency
 20529 00000078 ??                      .ccTFormat:		resb	1	;time format
 20530 00000079 ????????                .ccMono_Ptr:		resd	1	;monocase routine entry point
 20531 0000007D ????                    .ccListSep:		resb	2 ; db " ",0 ;data list separator
 20532 0000007F <res Ah>                .ccReserved_area: 	resw	5 ; dw 5 dup(?) ;reserved
 20533                                  .size:
 20534                                  endstruc
 20535                                  
 20536                                  NEW_COUNTRY_SIZE    equ  country_cdpg_info.size - country_cdpg_info.ccDosCountry
 20537                                  
 20538                                  ; ======================================================================
 20539                                  ; retrodos4.s (offset addresses in MSDOS.SYS or RETRODOS.SYS)
 20540                                  ; ======================================================================
 20541                                  ; 21/03/2019 - Retro DOS v4.0
 20542                                  ; 21/10/2022 - Retro DOS v4.0 (MOdified MSDOS 5.0 IO.SYS)
 20543                                  
 20544                                  ;KERNEL_SEGMENT	equ 0070h  ; (IO.SYS loading segment, BIOS_DATA segment)
 20545                                  ; 21/10/2022
 20546                                  DOSBIODATASEG equ 0070h	; (IO.SYS loading segment, BIOS_DATA segment)
 20547                                  ; 22/10/2022
 20548                                  ;DOSBIOCODESEG equ 02C7h ; (MSDOS 5.0 IO.SYS, BIOS_CODE segment)
 20549                                  ; 09/12/2022
 20550                                  DOSBIOCODESEG equ IOSYSCODESEG
 20551                                  
 20552                                  ; Note: These offset addresses must be chanqed when the code 
 20553                                  ; 	in retrodos4.s (MSDOS.SYS) file will be changed.
 20554                                  
 20555                                  ; (following addresses can be verified by searching them in retrodos4.lst) 
 20556                                  
 20557                                  ; 09/12/2022
 20558                                  %if 0
 20559                                  
 20560                                  ; 13/05/2019
 20561                                  
 20562                                  ;IsWin386         equ 08CFh
 20563                                  ;V86_Crit_SetFocus equ 08D0h
 20564                                  ; 21/10/2022
 20565                                  IsWin386          equ 08D0h
 20566                                  V86_Crit_SetFocus equ 08D1h 
 20567                                  
 20568                                  ;seg_reinit	  equ 0772h ; not used in Retro DOS v4.0
 20569                                  ; 21/10/2022 - Retro DOS v4.0 (MOdified MSDOS 5.0 IO.SYS)
 20570                                  seg_reinit	  equ 0032h ; DOSBIOCODESEG:0032h
 20571                                  
 20572                                  ;SysinitPresent	  equ 08FCh
 20573                                  ; 21/10/2022
 20574                                  SysinitPresent	  equ 08FDh
 20575                                  
 20576                                  inHMA		  equ 000Dh
 20577                                  xms		  equ 000Eh
 20578                                  ;FreeHMAPtr	  equ 08F6h
 20579                                  ;multrk_flag	  equ 0533h
 20580                                  ;ec35_flag	  equ 0535h
 20581                                  ;EOT		  equ 012Eh
 20582                                  ; 21/10/2022
 20583                                  FreeHMAPtr	  equ 08F7h
 20584                                  multrk_flag	  equ 052Fh
 20585                                  ec35_flag	  equ 0531h
 20586                                  EOT		  equ 012Ch
 20587                                  
 20588                                  ;NextStack	  equ 08BFh
 20589                                  ;IT_StackLoc	  equ 08C5h
 20590                                  ;IT_StackSize	  equ 08C9h
 20591                                  ; 21/10/2022
 20592                                  NextStack	  equ 08C0h
 20593                                  IT_StackLoc	  equ 08C6h
 20594                                  IT_StackSize	  equ 08CAh
 20595                                  
 20596                                  ;MoveDOSIntoHMA	  equ 08F8h
 20597                                  ; 21/10/2022
 20598                                  MoveDOSIntoHMA	  equ 08F9h
 20599                                  
 20600                                  ;INT19SEM equ 0644h ; 01/05/2019 - retrodos4.lst
 20601                                  ;I19_LST  equ 0645h ; 27/03/2019 - retrodos4.lst
 20602                                  ; 21/10/2022
 20603                                  INT19SEM equ 0640h ; (iosys5.txt)
 20604                                  I19_LST  equ 0641h ; (iosys5.txt)
 20605                                  
 20606                                  %endif
 20607                                  
 20608                                  ; 09/12/2022
 20609                                  seg_reinit equ _seg_reinit
 20610                                  ec35_flag  equ ec35flag		
 20611                                  INT19SEM   equ int19sem
 20612                                  I19_LST    equ i19_lst
 20613                                  
 20614                                  INT19OLD02 equ I19_LST+1 ; 0642h ; 21/10/2022
 20615                                  INT19OLD08 equ I19_LST+6
 20616                                  INT19OLD09 equ I19_LST+11
 20617                                  INT19OLD0A equ I19_LST+16
 20618                                  INT19OLD0B equ I19_LST+21
 20619                                  INT19OLD0C equ I19_LST+26
 20620                                  INT19OLD0D equ I19_LST+31
 20621                                  INT19OLD0E equ I19_LST+36
 20622                                  INT19OLD70 equ I19_LST+41
 20623                                  INT19OLD72 equ I19_LST+46
 20624                                  INT19OLD73 equ I19_LST+51
 20625                                  INT19OLD74 equ I19_LST+56
 20626                                  INT19OLD76 equ I19_LST+61
 20627                                  INT19OLD77 equ I19_LST+66 ; 0683h ; 21/10/2022
 20628                                  
 20629                                  ; 09/12/2022
 20630                                  %if 0
 20631                                  
 20632                                  ;keyrd_func	equ 04E9h
 20633                                  ;keysts_func	equ 04EAh
 20634                                  ;t_switch	equ 04F6h
 20635                                  ; 21/10/2022
 20636                                  keyrd_func	equ 04E5h
 20637                                  keysts_func	equ 04E6h
 20638                                  t_switch	equ 04F2h
 20639                                  
 20640                                  ; 22/10/2022
 20641                                  SYSINITSEG	equ 046Dh  ; SYSINIT segment
 20642                                  BCODE_END	equ (SYSINITSEG-DOSBIOCODESEG)*16 ; = 1A60h
 20643                                  BCODE_START	equ 30h  ; (offset BiosDataWord in DOSBIOCODESEG) 
 20644                                  RE_INIT		equ 089Bh ; (re_init offset in DOSBIODATASEG)
 20645                                  
 20646                                  %endif
 20647                                  
 20648                                  ; 09/12/2022
 20649                                  BCODESTART	equ BIOSDATAWORD
 20650                                  RE_INIT		equ re_init
 20651                                  
 20652                                  ; ----------------------------------------------------------------------
 20653                                  ; CONFIG.INC (MSDOS 6.0 - 1991) 	
 20654                                  ; ----------------------------------------------------------------------
 20655                                  ; 15/04/2019 - Retro DOS v4.0
 20656                                  
 20657                                  CONFIG_BEGIN        equ  '['
 20658                                  CONFIG_BREAK        equ  'C'
 20659                                  CONFIG_BUFFERS      equ  'B'
 20660                                  CONFIG_COMMENT      equ  'Y'
 20661                                  CONFIG_COUNTRY      equ  'Q'
 20662                                  CONFIG_DEVICE       equ  'D'
 20663                                  CONFIG_DEVICEHIGH   equ  'U'
 20664                                  CONFIG_DOS          equ  'H'
 20665                                  CONFIG_DRIVPARM     equ  'P'
 20666                                  CONFIG_FCBS         equ  'X'
 20667                                  CONFIG_FILES        equ  'F'
 20668                                  CONFIG_INCLUDE      equ  'J'
 20669                                  CONFIG_INSTALL      equ  'I'
 20670                                  CONFIG_INSTALLHIGH  equ  'W'
 20671                                  CONFIG_LASTDRIVE    equ  'L'
 20672                                  CONFIG_MENUCOLOR    equ  'R'
 20673                                  CONFIG_MENUDEFAULT  equ  'A'
 20674                                  CONFIG_MENUITEM     equ  'E'
 20675                                  CONFIG_MULTITRACK   equ  'M'
 20676                                  CONFIG_NUMLOCK      equ  'N'
 20677                                  CONFIG_REM          equ  '0'
 20678                                  CONFIG_SEMICOLON    equ  ';'
 20679                                  CONFIG_SET          equ  'V'
 20680                                  CONFIG_SHELL        equ  'S'
 20681                                  CONFIG_STACKS       equ  'K'
 20682                                  CONFIG_SUBMENU      equ  'O'
 20683                                  CONFIG_SWITCHES     equ  '1'
 20684                                  
 20685                                  CONFIG_UNKNOWN      equ  'Z'
 20686                                  
 20687                                  CONFIG_OPTION_QUERY equ 80h
 20688                                  
 20689                                  ; ----------------------------------------------------------------------
 20690                                  ; SYSINIT1.ASM (MSDOS 6.0 - 1991) 	
 20691                                  ; ----------------------------------------------------------------------
 20692                                  ; 21/03/2019 - Retro DOS v4.0
 20693                                  
 20694                                  true	equ	0FFFFh
 20695                                  false	equ	0
 20696                                  cr	equ	13
 20697                                  lf	equ	10
 20698                                  tab	equ	9
 20699                                  
 20700                                  multMULT	   equ	4Ah
 20701                                  multMULTGETHMAPTR  equ	1
 20702                                  multMULTALLOCHMA   equ	2
 20703                                  
 20704                                  ;NOEXEC    equ	FALSE
 20705                                  
 20706                                  stacksw    equ	true	;include switchable hardware stacks
 20707                                  mycds_size equ	88	;size of curdir_list. if it is not
 20708                                  			;the same, then will generate compile error.
 20709                                  
 20710                                  entrysize   equ     8
 20711                                  
 20712                                  mincount    equ     8
 20713                                  defaultcount equ    9
 20714                                  maxcount    equ     64
 20715                                  
 20716                                  minsize     equ     32
 20717                                  defaultsize equ     128
 20718                                  maxsize     equ     512
 20719                                  
 20720                                  ;%define allocbyte  byte [es:bp+0]
 20721                                  ;%define intlevel   byte [es:bp+1]
 20722                                  ;%define savedsp    word [es:bp+2]
 20723                                  ;%define savedss    word [es:bp+4]
 20724                                  ;%define newsp	    word [es:bp+6]
 20725                                  
 20726                                  allocbyte   equ     0
 20727                                  intlevel    equ     1
 20728                                  savedsp     equ     2
 20729                                  savedss     equ     4
 20730                                  newsp       equ     6
 20731                                  
 20732                                  free	    equ     0
 20733                                  allocated   equ     1
 20734                                  overflowed  equ     2
 20735                                  clobbered   equ     3
 20736                                  
 20737                                  ;---------------------------------------
 20738                                  ; external variable defined in ibmbio module for multi-track
 20739                                  
 20740                                  multrk_on equ	10000000b ;user specified mutitrack=on,or system turns
 20741                                  			  ; it on after handling config.sys file as a
 20742                                  			  ; default value,if multrk_flag = multrk_off1.
 20743                                  multrk_off1 equ 00000000b ;initial value. no "multitrack=" command entered.
 20744                                  multrk_off2 equ 00000001b ;user specified multitrack=off.
 20745                                  
 20746                                  ; SYSINITSEG	SEGMENT PUBLIC 'SYSTEM_INIT'
 20747                                  
 20748                                  SYSINIT$:
 20749                                  	;IF	STACKSW 
 20750                                  	; include MSSTACK.INC	;Main stack program and data definitions
 20751                                  	; include STKMES.INC	;Fatal stack error message
 20752                                  	;   public Endstackcode
 20753                                  ;Endstackcode	label byte
 20754                                  	;ENDIF
 20755                                  
 20756                                  ; 05/07/2018
 20757                                  ; ----------------------------------------------------------------------
 20758                                  ; 04/06/2018 - Retro DOS v3.0
 20759                                  
 20760                                  ; ----------------------------------------------------------------------
 20761                                  ; 21/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS - SYSINIT)
 20762                                  ; ----------------------------------------------------------------------
 20763                                  
 20764                                  ;	MSStack.inc
 20765                                  ;
 20766                                  ;	Interrupt level 2, 3, 4, 5, 6, 7,(10, 11, 12, 14, 15 - AT level)
 20767                                  ;	should follow the standard Interrupt Sharing Scheme which has
 20768                                  ;	a standard header structure.
 20769                                  ;	Fyi, the following shows the relations between
 20770                                  ;	the interrupt vector and interrupt level.
 20771                                  ; VEC(Hex)    2  8  9  A  B  C	D  E  70  72  73  74  76  77
 20772                                  ; LVL(Deci)   9  0  1  2  3  4	5  6   8  10  11  12  14  15
 20773                                  ;	MSSTACK module modifies the following interrupt vectors
 20774                                  ;	to meet the standard Interrupt Sharing standard;
 20775                                  ;	  A, B, C, D, E, 72, 73, 74, 76, 77.
 20776                                  ;	Also, for interrupt level 7 and 15, the FirstFlag in a standard header
 20777                                  ;	should be initialized to indicat whether this interrupt handler is
 20778                                  ;	the first (= 80h) or not.  The FirstFlag entry of INT77h's
 20779                                  ;	program header is initialized in STKINIT.INC module.
 20780                                  ;	FirstFlag is only meaningful for interrupt level 7 and 15.
 20781                                  ;
 20782                                  
 20783                                  ;  User specifies the number of stack elements - default = 9
 20784                                  ;						 minimum = 8
 20785                                  ;						 maximum = 64
 20786                                  ;
 20787                                  ;  Intercepts Asynchronous Hardware Interrupts only
 20788                                  ;
 20789                                  ;  Picks a stack from pool of stacks and switches to it
 20790                                  ;
 20791                                  ;  Calls the previously saved interrupt vector after pushing flags
 20792                                  ;
 20793                                  ;  On return, returns the stack to the stack pool
 20794                                  ;
 20795                                  
 20796                                  ; This is a modification of STACKS:
 20797                                  ; 1. To fix a bug which was causing the program to take up too much space.
 20798                                  ; 2. To dispense stack space from hi-mem first rather than low-mem first.
 20799                                  ;    . Clobbers the stack that got too big instead of innocent stack
 20800                                  ;    . Allows system to work if the only stack that got too big was the most
 20801                                  ;      deeply nested one
 20802                                  ; 3. Disables NMI interrupts while setting the NMI vector.
 20803                                  ; 4. Does not intercept any interrupts on a PCjr.
 20804                                  ; 5. Double checks that a nested interrupt didn't get the same stack.
 20805                                  ; 6. Intercepts Ints 70, 72-77 for PC-ATs and other future products
 20806                                  
 20807                                  		;EVEN
 20808                                  ;align 2
 20809                                  		; 21/10/2022
 20810                                  
 20811 00000000 0000                    		dw	0	; spare field but leave these in order
 20812 00000002 0000                    stackcount:	dw	0
 20813 00000004 0000                    stackat: 	dw	0
 20814 00000006 0000                    stacksize:	dw	0
 20815 00000008 0000                    stacks:		dw	0
 20816 0000000A 0000                    		dw	0
 20817                                  
 20818 0000000C [0800]                  firstentry:	dw	stacks
 20819 0000000E [4800]                  lastentry:	dw	stacks+(defaultcount*entrysize)-entrysize
 20820 00000010 [4800]                  nextentry:	dw	stacks+(defaultcount*entrysize)-entrysize
 20821                                  
 20822                                  ;***********************************************************************
 20823                                  ; THESE ARE THE INDIVIDUAL INTERRUPT HANDLERS
 20824                                  
 20825                                  ; ----------------------------------------------------------------------
 20826                                  
 20827 00000012 00000000                old02:	dd	0
 20828                                  
 20829                                  int02:
 20830                                  
 20831                                  ; *********************************************************************
 20832                                  ;
 20833                                  ; this is special support for the pc convertible / nmi handler
 20834                                  ;
 20835                                  ;	on the pc convertible, there is a situation where an nmi can be 
 20836                                  ;	caused by using the "out" instructions to certain ports. when this
 20837                                  ;	occurs, the pc convertible hardware *guarantees* that **nothing** 
 20838                                  ;	can stop the nmi or interfere with getting to the nmi handler. this
 20839                                  ;	includes other type of interrupts (hardware and software), and
 20840                                  ;	also includes other type of nmi's. when any nmi has occured,
 20841                                  ;	no other interrtupt (hardware, software or nmi) can occur until
 20842                                  ;	the software takes specific steps to allow further interrupting.
 20843                                  ;
 20844                                  ;	for pc convertible, the situation where the nmi is generated by the
 20845                                  ;	"out" to a control port requires "fixing-up" and re-attempting. in
 20846                                  ;	otherwords, it is actually a "restartable exception". in this
 20847                                  ;	case, the software handler must be able to get to the stack in
 20848                                  ;	order to figure out what instruction caused the problem, where
 20849                                  ;	it was "out"ing to and what value it was "out"ing.  therefore,
 20850                                  ;	we will not switch stacks in this situation. this situation is
 20851                                  ;	detected by interrogating port 62h, and checking for a bit value
 20852                                  ;	of 80h. if set, *****do not switch stacks*****.
 20853                                  ;
 20854                                  ; *********************************************************************
 20855                                  
 20856 00000016 50                      	push	ax
 20857 00000017 06                      	push	es
 20858 00000018 B800F0                  	mov	ax,0F000h
 20859 0000001B 8EC0                    	mov	es,ax
 20860                                  	; 02/11/2022
 20861 0000001D 26803EFEFFF9            	cmp	byte [es:0FFFEh],0F9h ; mdl_convert ; check if convertible
 20862 00000023 07                      	pop	es
 20863 00000024 750C                    	jne	short normal02
 20864                                  
 20865 00000026 E462                    	in	al,62h		; PC/XT PPI port C. Bits:
 20866                                  				; 0-3: values of DIP switches
 20867                                  				; 5: 1=Timer 2 channel out
 20868                                  				; 6: 1=I/O channel check
 20869                                  				; 7: 1=RAM parity check error occurred.
 20870 00000028 A880                    	test	al,80h
 20871 0000002A 7406                    	jz	short normal02
 20872                                  special02:
 20873 0000002C 58                      	pop	ax
 20874 0000002D 2EFF2E[1200]            	jmp	far [cs:old02]
 20875                                  normal02:
 20876 00000032 58                      	pop	ax
 20877 00000033 E81101                  	call	do_int_stacks
 20878 00000036 [1200]                  	dw	old02
 20879                                  
 20880                                  ; ----------------------------------------------------------------------
 20881                                  
 20882 00000038 00000000                old08:	dd	0
 20883                                  
 20884                                  int08:
 20885 0000003C E80801                  	call	do_int_stacks
 20886 0000003F [3800]                  	dw	old08
 20887                                  
 20888                                  ; ----------------------------------------------------------------------
 20889                                  
 20890 00000041 00000000                old09:	dd	0
 20891                                  
 20892                                  int09:
 20893                                  
 20894                                  ; keyboard interrupt must have a three byte jump, a nop and a zero byte
 20895                                  ; as its first instruction for compatibility reasons
 20896                                  
 20897 00000045 EB02                    	jmp	short keyboard_lbl
 20898 00000047 90                      	nop
 20899 00000048 00                      	db	0
 20900                                  
 20901                                  keyboard_lbl:
 20902 00000049 E8FB00                  	call	do_int_stacks
 20903 0000004C [4100]                  	dw	old09
 20904                                  
 20905                                  ; ----------------------------------------------------------------------
 20906                                  
 20907 0000004E 00000000                old70:	dd	0
 20908                                  
 20909                                  int70:
 20910 00000052 E8F200                  	call	do_int_stacks
 20911 00000055 [4E00]                  	dw	old70
 20912                                  
 20913                                  ; ----------------------------------------------------------------------
 20914                                  
 20915                                  ;	irp	a,<0a,0b,0c,0d,0e,72,73,74,76,77>
 20916                                  ;public	int&a
 20917                                  ;public	old&a
 20918                                  ;public	firstflag&a
 20919                                  ;int&a	proc	far
 20920                                  ;	jmp	short entry_int&a&_stk
 20921                                  ;old&a	dd	  0		;forward pointer
 20922                                  ;	dw	  424bh 	;compatible signature for int. sharing
 20923                                  ;firstflag&a db   0		;the firstly hooked.
 20924                                  ;	jmp	short intret_&a	;reset routine. we don't care this.
 20925                                  ;	db	7 dup (0)	;reserved for future.
 20926                                  ;entry_int&a&_stk:
 20927                                  ;	call	do_int_stacks
 20928                                  ;	dw	old&a
 20929                                  ;intret_&a:
 20930                                  ;	iret
 20931                                  ;int&a	endp
 20932                                  ;	endm
 20933                                  
 20934                                  ; ----------------------------------------------------------------------
 20935                                  
 20936                                  int0A:
 20937 00000057 EB10                    	jmp	short entry_int0A_stk
 20938 00000059 00000000                old0A:	dd	0	
 20939 0000005D 4B42                    	dw	424Bh
 20940                                  firstflag0A:
 20941 0000005F 00                      	db	0
 20942 00000060 EB0C                    	jmp	short intret_0A
 20943 00000062 00<rep 7h>              	times	7 db 0
 20944                                  
 20945                                  entry_int0A_stk:
 20946 00000069 E8DB00                  	call	do_int_stacks
 20947 0000006C [5900]                  	dw	old0A
 20948                                  intret_0A:
 20949 0000006E CF                      	iret
 20950                                  
 20951                                  ; ----------------------------------------------------------------------
 20952                                  
 20953                                  int0B:
 20954 0000006F EB10                    	jmp	short entry_int0B_stk
 20955 00000071 00000000                old0B:	dd	0	
 20956 00000075 4B42                    	dw	424Bh
 20957                                  firstflag0B:
 20958 00000077 00                      	db	0
 20959 00000078 EB0C                    	jmp	short intret_0B
 20960 0000007A 00<rep 7h>              	times	7 db 0
 20961                                  
 20962                                  entry_int0B_stk:
 20963 00000081 E8C300                  	call	do_int_stacks
 20964 00000084 [7100]                  	dw	old0B
 20965                                  intret_0B:
 20966 00000086 CF                      	iret
 20967                                  
 20968                                  ; ----------------------------------------------------------------------
 20969                                  
 20970                                  int0C:
 20971 00000087 EB10                    	jmp	short entry_int0C_stk
 20972 00000089 00000000                old0C:	dd	0	
 20973 0000008D 4B42                    	dw	424Bh
 20974                                  firstflag0C:
 20975 0000008F 00                      	db	0
 20976 00000090 EB0C                    	jmp	short intret_0C
 20977 00000092 00<rep 7h>              	times	7 db 0
 20978                                  
 20979                                  entry_int0C_stk:
 20980 00000099 E8AB00                  	call	do_int_stacks
 20981 0000009C [8900]                  	dw	old0C
 20982                                  intret_0C:
 20983 0000009E CF                      	iret
 20984                                  
 20985                                  ; ----------------------------------------------------------------------
 20986                                  
 20987                                  int0D:
 20988 0000009F EB10                    	jmp	short entry_int0D_stk
 20989 000000A1 00000000                old0D:	dd	0	
 20990 000000A5 4B42                    	dw	424Bh
 20991                                  firstflag0D:
 20992 000000A7 00                      	db	0
 20993 000000A8 EB0C                    	jmp	short intret_0D
 20994 000000AA 00<rep 7h>              	times	7 db 0
 20995                                  
 20996                                  entry_int0D_stk:
 20997 000000B1 E89300                  	call	do_int_stacks
 20998 000000B4 [A100]                  	dw	old0D
 20999                                  intret_0D:
 21000 000000B6 CF                      	iret
 21001                                  
 21002                                  ; ----------------------------------------------------------------------
 21003                                  
 21004                                  int0E:
 21005 000000B7 EB10                    	jmp	short entry_int0E_stk
 21006 000000B9 00000000                old0E:	dd	0	
 21007 000000BD 4B42                    	dw	424Bh
 21008                                  firstflag0E:
 21009 000000BF 00                      	db	0
 21010 000000C0 EB0C                    	jmp	short intret_0E
 21011 000000C2 00<rep 7h>              	times	7 db 0
 21012                                  
 21013                                  entry_int0E_stk:
 21014 000000C9 E87B00                  	call	do_int_stacks
 21015 000000CC [B900]                  	dw	old0E
 21016                                  intret_0E:
 21017 000000CE CF                      	iret
 21018                                  
 21019                                  ; ----------------------------------------------------------------------
 21020                                  
 21021                                  int72:
 21022 000000CF EB10                    	jmp	short entry_int72_stk
 21023 000000D1 00000000                old72:	dd	0	
 21024 000000D5 4B42                    	dw	424Bh
 21025                                  firstflag72:
 21026 000000D7 00                      	db	0
 21027 000000D8 EB0C                    	jmp	short intret_72
 21028 000000DA 00<rep 7h>              	times	7 db 0
 21029                                  
 21030                                  entry_int72_stk:
 21031 000000E1 E86300                  	call	do_int_stacks
 21032 000000E4 [D100]                  	dw	old72
 21033                                  intret_72:
 21034 000000E6 CF                      	iret
 21035                                  
 21036                                  ; ----------------------------------------------------------------------
 21037                                  
 21038                                  int73:
 21039 000000E7 EB10                    	jmp	short entry_int73_stk
 21040 000000E9 00000000                old73:	dd	0	
 21041 000000ED 4B42                    	dw	424Bh
 21042                                  firstflag73:
 21043 000000EF 00                      	db	0
 21044 000000F0 EB0C                    	jmp	short intret_73
 21045 000000F2 00<rep 7h>              	times	7 db 0
 21046                                  
 21047                                  entry_int73_stk:
 21048 000000F9 E84B00                  	call	do_int_stacks
 21049 000000FC [E900]                  	dw	old73
 21050                                  intret_73:
 21051 000000FE CF                      	iret
 21052                                  
 21053                                  ; ----------------------------------------------------------------------
 21054                                  
 21055                                  int74:
 21056 000000FF EB10                    	jmp	short entry_int74_stk
 21057 00000101 00000000                old74:	dd	0	
 21058 00000105 4B42                    	dw	424Bh
 21059                                  firstflag74:
 21060 00000107 00                      	db	0
 21061 00000108 EB0C                    	jmp	short intret_74
 21062 0000010A 00<rep 7h>              	times	7 db 0
 21063                                  
 21064                                  entry_int74_stk:
 21065 00000111 E83300                  	call	do_int_stacks
 21066 00000114 [0101]                  	dw	old74
 21067                                  intret_74:
 21068 00000116 CF                      	iret
 21069                                  
 21070                                  ; ----------------------------------------------------------------------
 21071                                  
 21072                                  int76:
 21073 00000117 EB10                    	jmp	short entry_int76_stk
 21074 00000119 00000000                old76:	dd	0	
 21075 0000011D 4B42                    	dw	424Bh
 21076                                  firstflag76:
 21077 0000011F 00                      	db	0
 21078 00000120 EB0C                    	jmp	short intret_76
 21079 00000122 00<rep 7h>              	times	7 db 0
 21080                                  
 21081                                  entry_int76_stk:
 21082 00000129 E81B00                  	call	do_int_stacks
 21083 0000012C [1901]                  	dw	old76
 21084                                  intret_76:
 21085 0000012E CF                      	iret
 21086                                  
 21087                                  ; ----------------------------------------------------------------------
 21088                                  
 21089                                  int77:
 21090 0000012F EB10                    	jmp	short entry_int77_stk
 21091 00000131 00000000                old77:	dd	0	
 21092 00000135 4B42                    	dw	424Bh
 21093                                  firstflag77:
 21094 00000137 00                      	db	0
 21095 00000138 EB0C                    	jmp	short intret_77
 21096 0000013A 00<rep 7h>              	times	7 db 0
 21097                                  
 21098                                  entry_int77_stk:
 21099 00000141 E80300                  	call	do_int_stacks
 21100 00000144 [3101]                  	dw	old77
 21101                                  intret_77:
 21102 00000146 CF                      	iret
 21103                                  
 21104                                  ; ----------------------------------------------------------------------
 21105                                  
 21106                                  ;********************************************************************
 21107                                  ;common routines
 21108                                  ;********************************************************************
 21109                                  
 21110                                  ; do interrupt stack switching. the fake return address holds
 21111                                  ; a pointer to the far-pointer of the actual interrupt
 21112                                  ; service routine
 21113                                  
 21114                                  ; 21/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 SYSINIT)
 21115                                  ; 21/03/2019 - Retro DOS v4.0
 21116                                  
 21117                                  ;allocbyte   equ 0
 21118                                  ;intlevel    equ 1
 21119                                  ;savedsp     equ 2
 21120                                  ;savedss     equ 4
 21121                                  ;newsp       equ 6
 21122                                  
 21123                                  ; 30/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 SYSINIT)
 21124                                  ; (MSDOS 6.21 IO.SYS, SYSINIT:0147h)
 21125                                  
 21126                                  do_int_stacks:
 21127 00000147 50                      	push	ax
 21128 00000148 55                      	push	bp
 21129 00000149 06                      	push	es
 21130 0000014A 2E8E06[0A00]            	mov	es,[cs:stacks+2]	; Get segment of stacks
 21131 0000014F 2E8B2E[1000]            	mov	bp,[cs:nextentry]	; get most likely candidate
 21132 00000154 B001                    	mov	al,allocated ; 1
 21133                                  	; 21/10/2022
 21134                                  	;xchg	[es:bp+allocbyte],al 
 21135                                  	; 11/12/2022
 21136 00000156 26864600                	xchg	[es:bp],al		; grab the entry
 21137 0000015A 3C00                    	cmp	al,free ; 0		; still avail?
 21138 0000015C 7551                    	jne	short notfree02
 21139                                  
 21140 0000015E 2E832E[1000]08          	sub	word [cs:nextentry],entrysize ; set for next interrupt
 21141                                  found02:
 21142 00000164 26896602                	mov	[es:bp+savedsp],sp	; save sp value
 21143 00000168 268C5604                	mov	[es:bp+savedss],ss	; save ss also
 21144                                  
 21145 0000016C 89E8                    	mov	ax,bp			; temp save of table offset
 21146                                  
 21147 0000016E 268B6E06                	mov	bp,[es:bp+newsp]	; get new SP value
 21148                                  	; 21/10/2022
 21149                                  	;mov	bp,[es:bp+6]
 21150                                  	; 11/12/2022
 21151                                  	;cmp	[es:bp+0],ax	
 21152 00000172 26394600                	cmp	[es:bp],ax		; check for offset into table
 21153 00000176 7544                    	jne	short foundbad02
 21154                                  
 21155                                  	; 02/07/2023 (MSDOS 6.21 SYSINIT code)
 21156 00000178 8CC0                    	mov	ax,es			; point ss,sp to the new stack
 21157 0000017A 8EC5                    	mov	es,bp
 21158 0000017C 89E5                    	mov	bp,sp
 21159 0000017E 8B6E06                  	mov	bp,[bp+6]
 21160 00000181 8ED0                    	mov	ss,ax
 21161 00000183 8CC4                    	mov	sp,es
 21162 00000185 8EC0                    	mov	es,ax
 21163 00000187 2E8B6E00                	mov	bp,[cs:bp]
 21164                                  
 21165                                  	; 21/10/2022 (MSDOS 5.0 SYSINIT code)
 21166                                  	;push    bp
 21167                                  	;mov     bp,sp
 21168                                  	;mov     ax,[bp+8]
 21169                                  	;pop     bp
 21170                                  	;push    es
 21171                                  	;pop     ss
 21172                                  	;mov     sp,bp
 21173                                  	;mov     bp,ax
 21174                                  	; 11/12/2022
 21175                                  	;;mov	bp,[cs:bp+0]	
 21176                                  	;mov	bp,[cs:bp]	
 21177                                  
 21178 0000018B 9C                      	pushf				; go execute the real interrupt handler
 21179                                  	; 11/12/2022
 21180 0000018C 2EFF5E00                	call	far [cs:bp]		; which will iret back to here
 21181                                  	; 21/10/2022
 21182                                  	;call	far [cs:bp+0]
 21183                                  
 21184 00000190 89E5                    	mov	bp,sp			; retrieve the table offset for us
 21185                                  	; 11/12/2022
 21186 00000192 268B6E00                	mov	bp,[es:bp]		; but leave it on the stack
 21187                                  	; 21/10/2022
 21188                                  	;mov	bp,[es:bp+0]
 21189 00000196 268E5604                	mov	ss,[es:bp+savedss]	; get old stack back
 21190 0000019A 268B6602                	mov	sp,[es:bp+savedsp]
 21191                                  
 21192                                  	; 11/12/2022
 21193                                  	;mov	byte [es:bp+allocbyte],free ; free the entry
 21194                                  	; 21/10/2022
 21195 0000019E 26C6460000              	mov	byte [es:bp],free ; 0
 21196 000001A3 2E892E[1000]            	mov	[cs:nextentry],bp	; setup to use next time
 21197                                  
 21198 000001A8 07                      	pop	es			; saved on entry
 21199 000001A9 5D                      	pop	bp			; saved on entry
 21200 000001AA 58                      	pop	ax			; saved on entry
 21201 000001AB 83C402                  	add	sp,2			; (skip near call return addr) 
 21202 000001AE CF                      	iret				; done with this interrupt
 21203                                  
 21204                                  notfree02:
 21205 000001AF 3C01                    	cmp	al,allocated		; error flag
 21206 000001B1 7404                    	je	short findnext02	; no, continue
 21207                                  	; 11/12/2022
 21208                                  	;xchg	[es:bp+allocbyte],al	; yes, restore error value
 21209                                  	; 21/10/2022
 21210 000001B3 26864600                	xchg	[es:bp],al
 21211                                  
 21212                                  findnext02:
 21213 000001B7 E81200                  	call	longpath
 21214 000001BA EBA8                    	jmp	short found02
 21215                                  
 21216                                  foundbad02:
 21217 000001BC 2E3B2E[0C00]            	cmp	bp,[cs:firstentry]
 21218 000001C1 72F4                    	jc	short findnext02
 21219 000001C3 89C5                    	mov	bp,ax			; flag this entry
 21220                                  	; 11/12/2022
 21221                                  	;mov	byte [es:bp+allocbyte],clobbered
 21222                                  	; 21/10/2022
 21223 000001C5 26C6460003              	mov	byte [es:bp],clobbered ; 3
 21224 000001CA EBEB                    	jmp	short findnext02	; keep looking
 21225                                  
 21226                                  ; ----------------------------------------------------------------------
 21227                                  
 21228                                  ; Common routines
 21229                                  
 21230                                  longpath:
 21231                                  	; 21/03/2019
 21232 000001CC 2E8B2E[0E00]            	mov	bp,[cs:lastentry]	; start with last entry in table
 21233                                  lploopp:
 21234                                  	; 11/12/2022
 21235                                  	;cmp	byte [es:bp+allocbyte],free ; is entry free?
 21236                                  	; 21/10/2022
 21237 000001D1 26807E0000              	cmp	byte [es:bp],free
 21238 000001D6 7512                    	jne	short inuse		;  no, try next one
 21239                                  
 21240 000001D8 B001                    	mov	al,allocated
 21241                                  	; 11/12/2022
 21242                                  	;xchg	[es:bp+allocbyte],al	; allocate entry
 21243                                  	; 21/10/2022
 21244 000001DA 26864600                	xchg	[es:bp],al
 21245 000001DE 3C00                    	cmp	al,free 		; is it still free?
 21246 000001E0 7414                    	je	short found		;  yes, go use it
 21247                                  
 21248 000001E2 3C01                    	cmp	al,allocated		; is it other than Allocated or Free?
 21249 000001E4 7404                    	je	short inuse		;  no, check the next one
 21250                                  
 21251                                  	; 11/12/2022
 21252                                  	;mov	[es:bp+allocbyte],al	;  yes, put back the error state
 21253                                  	; 21/10/2022
 21254 000001E6 26884600                	mov	[es:bp],al
 21255                                  inuse:
 21256 000001EA 2E3B2E[0C00]            	cmp	bp,[cs:firstentry]
 21257 000001EF 7406                    	je	short fatal
 21258 000001F1 83ED08                  	sub	bp,entrysize
 21259 000001F4 EBDB                    	jmp	short lploopp
 21260                                  found:
 21261 000001F6 C3                      	retn
 21262                                  fatal:
 21263 000001F7 1E                      	push	ds
 21264 000001F8 B800F0                  	mov	ax,0F000h		;look at the model byte
 21265 000001FB 8ED8                    	mov	ds,ax
 21266 000001FD 803EFEFFF9              	cmp	byte [0FFFEh],0F9h ; mdl_convert ; convertible?
 21267 00000202 1F                      	pop	ds
 21268 00000203 7504                    	jne	short skip_nmis
 21269                                  
 21270 00000205 B007                    	mov	al,07h			; disable pc convertible nmis
 21271 00000207 E672                    	out	72h,al
 21272                                  
 21273                                  skip_nmis:
 21274 00000209 FA                      	cli				; disable and mask
 21275 0000020A B0FF                    	mov	al,0FFh			;   all other ints
 21276 0000020C E621                    	out	021h,al
 21277 0000020E E6A1                    	out	0A1h,al
 21278                                  
 21279 00000210 8CCE                    	mov	si,cs
 21280 00000212 8EDE                    	mov	ds,si
 21281 00000214 BE[3B02]                	mov	si,fatal_msg
 21282                                  ;SR;
 21283                                  ;   We set all foci to this VM to issue the stack failure message
 21284                                  ;
 21285 00000217 50                      	push	ax
 21286 00000218 1E                      	push	ds
 21287                                  	;;mov	ax,Bios_Data ; 0070h
 21288                                  	;mov	ax,KERNEL_SEGMENT ; 0070h
 21289                                  	; 21/10/2022
 21290 00000219 B87000                  	mov	ax,DOSBIODATASEG
 21291 0000021C 8ED8                    	mov	ds,ax
 21292                                  
 21293                                  	;test	byte [08D0h],1 	; (MSDOS 6.21, IO.SYS - SYSINIT:021Eh)
 21294 0000021E F606[1208]01            	test	byte [IsWin386],1 ; (retrodos4.sys, offset: ****h)
 21295 00000223 1F                      	pop	ds
 21296 00000224 58                      	pop	ax
 21297 00000225 7405                    	jz	short fatal_loop	; win386 not present, continue
 21298                                  
 21299                                  	;;call	far ptr 0070h:08D1h ; (MSDOS 621, IO.SYS - SYSINIT:0227h)
 21300                                  	;call	KERNEL_SEGMENT:V86_Crit_SetFocus ; set focus to this VM
 21301                                  	; 21/10/2022
 21302 00000227 9A[1308]7000            	call	DOSBIODATASEG:V86_Crit_SetFocus ; 0070h:08D1h
 21303                                  ;
 21304                                  ;SR; We do not bother about the returned status of this call. 
 21305                                  ;
 21306                                  fatal_loop:
 21307 0000022C AC                      	lodsb
 21308 0000022D 3C24                    	cmp	al,'$' ; 24h
 21309 0000022F 7408                    	je	short fatal_done
 21310                                  
 21311 00000231 B307                    	mov	bl,7
 21312                                  	; 28/09/2023 (BugFix)
 21313 00000233 B40E                    	mov	ah,14
 21314                                  	;mov	ah,0Eh
 21315 00000235 CD10                    	int	10h			; whoops, this enables ints
 21316                                  			; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
 21317                                  			; AL = character, BH = display page (alpha modes)
 21318                                  			; BL = foreground color (graphics modes)
 21319 00000237 EBF3                    	jmp	short fatal_loop
 21320                                  
 21321                                  fatal_done:
 21322 00000239 EBFE                    	jmp	short fatal_done
 21323                                  
 21324                                  
 21325                                  ; 21/03/2019 - Retro DOS v4.0 (MSDOS 6.0, SYSINIT1.ASM, 1991)
 21326                                  ; ----------------------------------------------------------------------
 21327                                  ;	include msbio.cl5		; fatal stack error message
 21328                                  
 21329                                  ; MSDOS 6.21, IO.SYS, SYSINIT:023Bh
 21330                                  
 21331                                  ; STKMES.INC - MSDOS 3.3 (24/07/1987)
 21332                                  ; ----------------------------------------------------------------------
 21333                                  ; 04/06/2018 - Retro DOS v3.0
 21334                                  
 21335                                  fatal_msg:
 21336 0000023B 0D0A                    	db	0Dh,0Ah
 21337 0000023D 070D0A                  	db	7,0Dh,0Ah
 21338 00000240 496E7465726E616C20-     	db	"Internal stack overflow",0Dh,0Ah
 21338 00000249 737461636B206F7665-
 21338 00000252 72666C6F770D0A     
 21339 00000259 53797374656D206861-     	db	"System halted",0Dh,0Ah,"$" 
 21339 00000262 6C7465640D0A24     
 21340                                  
 21341                                  endstackcode:
 21342                                  
 21343                                  ; ----------------------------------------------------------------------
 21344                                  ; SYINIT1.ASM (MSDOS 6.0, 1991) 'SYSINIT' jump addr from 'MSINIT.ASM'
 21345                                  ; ----------------------------------------------------------------------
 21346                                  ; 04/06/2018 - Retro DOS v3.0 (MSDOS 3.3, SYSINIT1.ASM, 24/07/1987)
 21347                                  
 21348                                  ; 22/03/2019 - Retro DOS v4.0
 21349                                  
 21350                                  ; SYSINIT:0269h (MSDOS 6.21 IO.SYS, SYSINIT segment, offset: 0269h)
 21351                                  
 21352                                  ; ('SYSINIT:' location/address is used in 'retrodos4.s'. If following
 21353                                  ; address will be changed, it must also be changed in 'retrodos4.s'.)
 21354                                  
 21355                                  ; 21/10/2022- Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 21356                                  ; ----------------------------------------------------------------------
 21357                                  ; SYSINITSEG:0267h (MSDOS 5.0 IO.SYS, SYSINIT segment, offset: 0267h)
 21358                                  
 21359                                  ; SYSINIT:0269h (MSDOS 6.22 IO.SYS, SYSINIT segment, offset: 0269h)
 21360                                  
 21361                                  ; 29/12/2023- Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
 21362                                  ; ----------------------------------------------------------------------
 21363                                  ; SYSINITSEG:0269h (PCDOS 7.1 IBMBIO.COM, SYSINIT segment, offset: 0269h)
 21364                                  
 21365                                  SYSINIT:	
 21366 00000269 E9AD01                          JMP	GOINIT
 21367                                  	;JMP	SYSIN ; 25/02/2018 - Retro DOS 2.0 modification
 21368                                  
 21369                                  ; ----------------------------------------------------------------------
 21370                                  
 21371                                  struc DDHighInfo
 21372 00000000 ????????                 .ddhigh_CSegPtr resd 1	; pointer to code segment to be relocated
 21373 00000004 ????                     .ddhigh_CSegLen resw 1	; length of code segment to be relocated
 21374 00000006 ????????                 .ddhigh_CallBak resd 1	; pointer to the call back routine
 21375                                  endstruc
 21376                                  
 21377                                  ; 22/03/2019 - Retro DOS v4.0
 21378                                  
 21379 0000026C 00                      runhigh: db	0
 21380                                  
 21381                                  ; 02/11/2022
 21382                                  ;align 4
 21383                                  
 21384                                  DOSINFO: 
 21385 0000026D 00000000                	dd	0	; address of the DOS Sysini Variables
 21386                                  ;MSDOS:
 21387                                  dos_temp_location: ; dword ; MSDOS 6.0
 21388                                  dosinit:		; MSDOS 6.0
 21389 00000271 0000                    	dw	0
 21390                                  
 21391                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 21392                                  ;FINAL_DOS_LOCATION: ; 20/04/2019 - Retro DOS v4.0
 21393                                  ;	dw	0
 21394                                  ;MSDOS 5.0 IO.SYS - SYSINIT:0271h
 21395                                  
 21396                                  CURRENT_DOS_LOCATION:
 21397 00000273 0000                    	dw	0
 21398                                  
 21399                                  ;DOSSIZE: ; Retro DOS 2.0 feature - 25/02/2018
 21400                                  ;	dw	0   ; 'MSDOS.BIN' kernel size in words
 21401                                  
 21402                                  ; 22/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 21403                                  ; (MSDOS 5.0 MSDOS.SYS size is 37394 bytes)
 21404                                  ;DOSSIZE equ	0A000h	; (MSDOS 6.0 - SYSINIT1.ASM - 1991)
 21405                                  ; 30/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
 21406                                  ; 03/09/2023 (PCDOS 7.1 IBMDOS.COM size is 42566 bytes, 04/12/2003)
 21407                                  DOSSIZE equ	0B000h	; (PCDOS 7.1 - SYSINIT)
 21408                                  
 21409                                  DEVICE_LIST:
 21410 00000275 00000000                	dd	0
 21411                                  
 21412                                  ; 04/06/2018 - Retro DOS v3.0
 21413                                  ; 28/03/2018
 21414                                  ;; MSDOS 3.3 - SYSINIT1.ASM - 24/07/1987
 21415                                  ;
 21416                                  sysi_country:	
 21417 00000279 00000000                	dd	0 ; 5/29/86 Pointer to country table in DOS
 21418                                  
 21419                                  ; MSDOS 6.0
 21420 0000027D 00000000                dos_segreinit:	dw	0,0	; room for dword
 21421                                  
 21422 00000281 0000                    lo_doscod_size:	dw	0	; dos code size when in low mem
 21423 00000283 0000                    hi_doscod_size:	dw	0	; dos code size when in HMA
 21424                                  
 21425 00000285 0000                    def_php:	dw	0
 21426                                  
 21427                                  ; M022--
 21428                                  ; pointer for calling into Bios_Code for re-initializing segment values.
 21429                                  ;  call with ax = new segment for Bios_Code. Notice that we'll
 21430                                  ;  call it in its temporary home, cuz seg_reinit won't get moved to
 21431                                  ;  the new home.
 21432                                  
 21433                                  ;Bios_Code	equ	KERNEL_SEGMENT  ; 0070h
 21434                                  ; 21/10/2022
 21435                                  ;DOSBIOCODESEG	equ	02C7h ; (MSDOS 5.0 IO.SYS)
 21436                                  
 21437                                  ; 22/10/2022
 21438                                  seg_reinit_ptr:	; label dword
 21439 00000287 [3200]                  		dw	seg_reinit ; Bios_Code:0032h for MSDOS 6.21 IO.SYS
 21440                                  temp_bcode_seg:
 21441                                  		;dw	Bios_Code  ; 02CCh for MSDOS 6.21 IO.SYS
 21442                                  		; 22/10/2022
 21443 00000289 FF02                    		dw	DOSBIOCODESEG ; 02C7h for MSDOS 5.0 IO.SYS
 21444                                  				; 364h for PCDOS 7.1 IBMBIO.COM - 29/12/2023
 21445                                  fake_floppy_drv:
 21446 0000028B 00                      		db	0	; set to 1 if this machine
 21447                                  				; does not have any floppies!!!
 21448                                  
 21449                                  ; Internal Stack Parameters
 21450                                  
 21451 0000028C 0900                    stack_count:	dW	defaultcount ; 9
 21452 0000028E 8000                    stack_size:	dw	defaultsize  ; 128
 21453 00000290 00000000                stack_addr:	dd	0
 21454                                  
 21455                                  ; 05/06/2018 - Retro DOS v3.0
 21456                                  
 21457                                  ; various default values
 21458                                  
 21459 00000294 0100                    MEMORY_SIZE:	dw	1
 21460                                  
 21461                                  ; 22/03/2019 - Retro DOS v4.0 (MSDOS 6.0 source, MSDOS 6.21 disassembled src.)
 21462                                  
 21463 00000296 0000                    RPLMemTop:	dw	0  ; 22/10/2022 (MSDOS 5.0 IO.SYS SYSINIT:0294h)
 21464 00000298 00                      DEFAULT_DRIVE:	db	0	;initialized by ibminit.
 21465 00000299 FFFF                    buffers:	dw	0FFFFh	; initialized during buffer allocation
 21466 0000029B 0000                    h_buffers:	dw	0	; # of the heuristic buffers. initially 0.
 21467 0000029D 0000                    singlebuffersize: dw	0	; maximum sector size + buffer head
 21468                                  
 21469 0000029F 08                      FILES:	db	8	; enough files for pipe
 21470 000002A0 04                      FCBS:	db	4	; performance for recycling
 21471 000002A1 00                      KEEP:	db	0	; keep original set
 21472 000002A2 05                      NUM_CDS: db	5	; 5 net drives
 21473                                  
 21474                                  ; 22/10/2022 (MSDOS 5.0 SYSINIT)
 21475                                  ;;CONFBOT: dw	0
 21476                                  ;;ALLOCLIM: dw	0
 21477                                  ;CONFBOT: ; 02/11/2022
 21478                                  ;top_of_cdss: dw 0
 21479                                  
 21480                                  ; 30/12/2022 - Retrodos v4.2 (MSDOS 6.21 SYSINIT)
 21481                                  ; (SYSINIT:02A3h)
 21482 000002A3 0000                    CONFBOT: dw	0
 21483 000002A5 0000                    ALLOCLIM: dw	0
 21484 000002A7 0000                    top_of_cdss: dw 0
 21485                                  
 21486                                  ; 02/11/2022 (MSDOS 5.0 SYSINIT)
 21487                                  ; 30/12/2022 (MSDOS 6.21 SYSINIT)
 21488                                  ;ALLOCLIM: dw	0	; (SYSINIT:02A3h)	
 21489                                  
 21490 000002A9 413A5C00                DirStrng: db	"A:\",0	; string for the root directory of a drive
 21491                                  
 21492                                  ; 30/12/2022 - Retro DOS v4.2 (MSDOS 6.21 SYSINIT)
 21493                                  %if 0
 21494                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 21495                                  ; (SYSINIT:02A9h)
 21496                                  
 21497                                  command_line:
 21498                                  	db	2,0
 21499                                  	db	'P'
 21500                                  	db	0
 21501                                  	times	124 db 0 ; db 124 dup(0)
 21502                                  
 21503                                  %endif
 21504                                  
 21505                                  ; (SYSINIT:0329h)
 21506 000002AD 00                      ZERO:	db	0
 21507 000002AE 00                      sepchr:	db	0
 21508 000002AF 0000                    linecount: dw	0			; line count in config.sys
 21509 000002B1 20202020200D0A24        showcount: db	'     ',cr,lf,'$'	; used to convert linecount to ascii.
 21510 000002B9 0000                    buffer_linenum: dw	0		; line count for "buffers=" command if entered.
 21511                                  
 21512 000002BB FF                      sys_model_byte:	db	0FFh		; model byte used in sysinit
 21513 000002BC 00                      sys_scnd_model_byte: db 0		; secondary model byte used in sysinit
 21514                                  
 21515 000002BD 0000                    buf_prev_off:	dw	0
 21516                                  
 21517                                          ;IF      NOT NOEXEC
 21518                                  ;COMEXE EXEC0 <0,COMMAND_LINE,DEFAULT_DRIVE,ZERO>
 21519                                          ;ENDIF
 21520                                  
 21521                                  ; 29/12/2023
 21522                                  ; 01/05/2018
 21523                                  COMEXE:
 21524 000002BF 0000                    EXEC0.ENVIRON:	dw	0	; seg addr of environment
 21525 000002C1 [6846]                  EXEC0.COM_LINE:	dw	command_line ; pointer to asciz command line
 21526 000002C3 0000                    		dw	0 	; SYSINIT segment (0473h for MSDOS 6.21 IO.SYS)
 21527                                  				; SYSINIT segment (0544h for PCDOS 7.1 IBMBIO.COM)
 21528 000002C5 [9802]                  EXEC0.5C_FCB:	dw	DEFAULT_DRIVE ; default fcb at 5C
 21529 000002C7 0000                    		dw	0	; SYSINIT segment (0473h for MSDOS 6.21 IO.SYS)
 21530 000002C9 [AD02]                  EXEC0.6C_FCB:	dw	ZERO	; default fcb at 6C
 21531 000002CB 0000                    		dw	0
 21532                                  
 21533                                  ; variables for install= command.
 21534                                  
 21535 000002CD 00                      multi_pass_id:	db	0		; parameter passed to multi_pass
 21536                                  					;  indicating the pass number
 21537                                  					; 0 - do scan for DOS=HIGH/LOW
 21538                                  					; 1 - load device drivers
 21539                                  					; 2 - was to load IFS
 21540                                  					;      now it is unused
 21541                                  					; 3 - do install=
 21542                                  					; >3 - nop
 21543 000002CE 0000                    install_flag:	dw	0
 21544                                  
 21545                                  have_install_cmd equ	00000001b	; config.sys has install= commands
 21546                                  has_installed	equ	00000010b	; sysinit_base installed.
 21547                                  
 21548 000002D0 0000                    config_size:	dw	0		; size of config.sys file. set by sysconf.asm
 21549 000002D2 00000000                sysinit_base_ptr: dd	0		; pointer to sysinit_base
 21550 000002D6 00000000                sysinit_ptr:	dd	0		; returning addr. from sysinit_base
 21551 000002DA 0000                    checksum:	dw	0		; used by sum_up
 21552                                  
 21553 000002DC 20<rep 14h>             ldexec_fcb:	times 20 db 20h ; db 20 dup (' ') ;big enough
 21554 000002F0 00                      ldexec_line:	db	0		;# of parm characters
 21555 000002F1 20                      ldexec_start:	db	' '
 21556 000002F2 00<rep 50h>             ldexec_parm:	times 80 db 0	; db 80 dup (0)
 21557                                  
 21558                                  ;instexe exec0	<0,ldexec_line,ldexec_fcb,ldexec_fcb>
 21559                                  
 21560                                  instexe:
 21561 00000342 0000                    iexec.environ:	dw	0		; seg addr of environment
 21562 00000344 [F002]                  iexec.ldexec_line: dw	ldexec_line ; pointer to asciz command line
 21563 00000346 0000                    		dw	0 	; SYSINIT segment (0473h for MSDOS 6.21 IO.SYS)
 21564                                  				; SYSINIT segment (0544h for PCDOS 7.1 IBMBIO.COM)
 21565 00000348 [DC02]                  iexec.ldexec_5c_fcb: dw	ldexec_fcb	; default fcb at 5C
 21566 0000034A 0000                    		dw	0	; SYSINIT segment (0473h for MSDOS 6.22 IO.SYS)
 21567 0000034C [DC02]                  iexec.ldexec_6c_fcb: dw	ldexec_fcb	; default fcb at 6C
 21568 0000034E 0000                    		dw	0
 21569                                  
 21570                                  ; variables for comment=
 21571                                  
 21572 00000350 00                      com_level:	db	0		; level of " " in command line
 21573 00000351 00                      cmmt:		db	0		; length of comment string token
 21574 00000352 00                      cmmt1:		db	0		; token
 21575 00000353 00                      cmmt2:		db	0		; token
 21576 00000354 00                      cmd_indicator:	db	0
 21577 00000355 00                      donotshownum:	db	0
 21578                                  
 21579 00000356 0000                    count:		dw	0
 21580 00000358 0000                    org_count:	dw	0
 21581 0000035A 0000                    chrptr:		dw	0
 21582 0000035C 0000                    cntryfilehandle: dw	0
 21583 0000035E 0000                    old_area:	dw	0
 21584 00000360 0000                    impossible_owner_size: dw 0		; paragraph
 21585                                  
 21586                                  bucketptr: ; label dword
 21587                                  bufptr:	   ; label dword		; leave this stuff in order!
 21588 00000362 0000                    memlo:	dw	0
 21589                                  prmblk:	   ; label word
 21590 00000364 0000                    memhi:	dw	0
 21591 00000366 0000                    ldoff:	dw	0
 21592 00000368 0000                    area:	dw	0
 21593                                  
 21594                                  ; 29/12/2023 - PCDOS 7.1 IBMBIO.COM - SYSINIT:036Ah
 21595 0000036A 0000                    prev_memhi:	dw 0
 21596 0000036C 0000                    prev_alloclim:	dw 0
 21597 0000036E 00                      dosdata_umb:	db 0
 21598                                  
 21599                                  ; Following is the request packet used to call INIT routines for 
 21600                                  ; all device drivers. Some fields may be accessed individually in
 21601                                  ; the code, and hence have individual labels, but they should not
 21602                                  ; be separated.
 21603                                  
 21604 0000036F 19                      packet:	db	25			; PCDOS 7.1 IBMBIO.COM
 21605                                  	;db	24			; was 22
 21606 00000370 00                      	db	0
 21607 00000371 00                      	db	0			; initialize code
 21608 00000372 0000                    	dw	0
 21609 00000374 00<rep 8h>              	times	8 db 0	; db 8 dup (?)
 21610                                  
 21611 0000037C 00                      unitcount:	db	0
 21612 0000037D 00000000                break_addr:	dd	0
 21613 00000381 00000000                bpb_addr:	dd	0
 21614                                  drivenumber:	; 22/10/2022
 21615 00000385 00                      devdrivenum:	db	0 
 21616 00000386 0000                    configmsgflag:	dw	0  ; used to control "error in config.sys line #" message
 21617                                  
 21618                                  ; end of request packet
 21619                                  
 21620                                  ;drivenumber:	db	0  ; 22/03/2019
 21621                                  
 21622                                  toomanydrivesflag:
 21623 00000388 00                      		db	0  ; >24 fixed disk partitions flag ; M029 
 21624 00000389 90                      align 2
 21625                                  
 21626                                  BCodeSeg:	; 21/10/2022
 21627 0000038A FF02                    	dw	DOSBIOCODESEG ; (02C7h for MSDOS 5.0 IO.SYS)
 21628                                  			; 0364h for PCDOS 7.1 IBMBIO.COM - 29/12/2023
 21629                                  	;dw	Bios_Code  ; = KERNEL_SEGMENT = 0070h (for Retro DOS v4.0)
 21630                                  			   ; BCodeSeg = 2CCh (for MSDOS 6.21 IO.SYS)
 21631                                  
 21632                                  ; 30/12/2022
 21633                                  ; MSDOS 6.21 IO.SYS, SYSINIT:0387h
 21634                                  ;
 21635                                  ; Magicbackdoor: dd 0
 21636                                  ; NullBackdoor: 
 21637                                  ;		retf
 21638                                  
 21639                                  ; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 21640                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 21641                                  ; 19/04/2019
 21642                                  _timer_lw_:
 21643 0000038C 0000                    	dw	0  ; MSDOS 6.21 IO.SYS - SYSINIT:038Ch
 21644                                  
 21645                                  ; 29/12/2023 - Retro DOS v5.0
 21646                                  ; PCDOS 7.1 IBMBIO.COM - SYSINIT:038Eh
 21647                                  
 21648 0000038E 00                      F5_key:	db 0
 21649 0000038F 00                      F8_key:	db 0
 21650 00000390 00000000                MagicBackdoor:	dd 0
 21651                                  NullBackdoor:
 21652 00000394 CB                      		retf
 21653                                  
 21654                                  ;SR;
 21655                                  ; This is the communication block between the DOS and the BIOS. It starts at
 21656                                  ;the SysinitPresent flag. Any other data that needs to be communicated 
 21657                                  ;to the DOS should be added after SysinitPresent. The pointer to this block
 21658                                  ;is passed to DOS as part of the DOSINIT call.
 21659                                  ;
 21660                                  
 21661                                  BiosComBlock:
 21662                                  	;dd	Bios_Data:SysinitPresent 
 21663                                  		; 0070h:08FDh for MSDOS 6.21 IO.SYS
 21664 00000395 [DD07]                  	dw	SysinitPresent  ; (retrodos4.sys, offset: ****h)
 21665                                  	;dw	KERNEL_SEGMENT ; 0070h
 21666                                  	; 21/10/2022
 21667 00000397 7000                    	dw	DOSBIODATASEG ; 0070h
 21668                                  
 21669                                  ;align 2
 21670                                  
 21671                                  	; 22/10/2022 - (MSDOS 5.0 IO.SYS, SYSINIT:0406h)
 21672                                  	; 30/12/2022 - (MSDOS 6.21 IO.SYS, SYSINIT:0392h)
 21673                                  tempstack:	
 21674 00000399 00<rep 80h>             	times	128 db 0  ; db	80h dup (?)
 21675                                  
 21676                                  ; ----------------------------------------------------------------------------
 21677                                  
 21678                                  
 21679                                  	; 29/12/2023 - Retro DOS v5.0
 21680                                  	; 22/10/2022 - Retro DOS v4.0
 21681                                  	;	; (MSDOS 5.0 IO.SYS, SYSINIT:0486h)
 21682                                  GOINIT:		; (MSDOS 6.22 IO.SYS, SYSINIT:0412h)
 21683                                  	; 12/12/2023
 21684 00000419 0E                      	push	cs
 21685 0000041A 1F                      	pop	ds
 21686                                  
 21687                                  	; 12/12/2022
 21688                                  	; 22/03/2019 - Retro DOS v4.0
 21689                                  	; 06/07/2018
 21690                                  	; 04/06/2018 - Retro DOS v3.0
 21691                                  ; before doing anything else, let's set the model byte
 21692 0000041B B4C0                    	mov	ah,0C0h 		; get system configuration
 21693 0000041D CD15                    	int	15h			; 
 21694 0000041F 7214                    	jc	short no_rom_config
 21695                                  
 21696                                  	;cmp	ah,0			; double check
 21697                                  	;jne	short no_rom_config
 21698                                  	; 03/09/2023
 21699 00000421 08E4                    	or	ah,ah
 21700 00000423 7510                    	jnz	short no_rom_config
 21701                                  
 21702                                  	; 12/12/2023 ; *
 21703                                  	; ds = cs
 21704                                  
 21705 00000425 268A4702                	mov	al,[es:bx+ROMBIOS_DESC.bios_sd_modelbyte]
 21706                                  	;mov	[cs:sys_model_byte],al 
 21707 00000429 A2[BB02]                	mov	[sys_model_byte],al ; *
 21708 0000042C 268A4703                	mov	al,[es:bx+ROMBIOS_DESC.bios_sd_scnd_modelbyte]
 21709                                  	;mov	[cs:sys_scnd_model_byte],al
 21710 00000430 A2[BC02]                	mov	[sys_scnd_model_byte],al ; *
 21711                                  	;jmp	short SYSIN
 21712                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 21713 00000433 EB29                    	jmp	short move_myself
 21714                                  
 21715                                  no_rom_config:				; Old ROM
 21716                                  	; 12/12/2023
 21717                                  	;mov	ax,0F000h
 21718                                  	;mov	ds,ax
 21719                                  	;mov	al,[0FFFEh]
 21720                                  	;mov	[cs:sys_model_byte],al	; set the model byte.
 21721                                  	; 12/12/2023
 21722                                  	; ds = cs
 21723 00000435 B800F0                  	mov	ax,0F000h
 21724 00000438 8EC0                    	mov	es,ax
 21725 0000043A 26A0FEFF                	mov	al,[es:0FFFEh]
 21726 0000043E A2[BB02]                	mov	[sys_model_byte],al	; set the model byte.
 21727                                  	
 21728                                  ; set fake_floppy_drv if there is no diskette drives in this machine.
 21729                                  ; execute the equipment determination interrupt and then
 21730                                  ; check the returned value to see if we have any floppy drives
 21731                                  ; if we have no floppy drive we set cs:fake_floppy_drv to 1
 21732                                  ; see the at tech ref bios listings for help on the equipment
 21733                                  ; flag interrupt (11h)	
 21734                                  
 21735                                  	; 22/10/2022
 21736                                  ;check_for_fake_floppy:			; entry point for rom_config above
 21737 00000441 CD11                    	int	11h			; check equipment flag
 21738                                  
 21739                                  	; 29/12/2023 - Retro DOS v5.0
 21740                                  	;jmp	short check_for_fake_floppy
 21741                                  	; PCDOS 7.1 IBMBIO.COM - SYSINIT:0446h
 21742                                  	;db	52h	; 'RPS' sign
 21743                                  	;db	50h
 21744                                  	;db	53h
 21745                                  
 21746                                  check_for_fake_floppy:
 21747                                  	; 29/12/2023
 21748                                  	; PCDOS 7.1 IBMBIO.COM - SYSINIT:0449h
 21749                                  	;or	ax, 1		; (nonsense! this may be overwritten/disabled
 21750                                  	;			; by using 'RPS' sign position)
 21751                                  	;			;		 03/07/2023 - Erdogan Tan
 21752                                  	;test	ax, 1		; have any floppies?
 21753                                  
 21754                                  	; 12/12/2022
 21755 00000443 A801                    	test	al,1		
 21756                                  	;test	ax,1			; have any floppies?
 21757 00000445 7517                    	jnz	short move_myself	; yes,normal system
 21758                                  
 21759                                  ; Some ROM BIOSs lie that there are no floppy drives. Lets find out
 21760                                  ; whether it is an old ROM BIOS or a new one
 21761                                  ;
 21762                                  ; WARNING !!!
 21763                                  ;
 21764                                  ; This sequence of code is present in MSINIT.ASM also. Any modification
 21765                                  ; here will require an equivalent modification in MSINIT.ASM also
 21766                                  
 21767                                  	; 12/12/2023
 21768                                  	;push	es  ; not necessary
 21769                                  
 21770 00000447 30C9                    	xor	cl,cl	
 21771 00000449 B408                    	mov	ah,8			; get disk parameters
 21772 0000044B B200                    	mov	dl,0			; of drive 0
 21773 0000044D CD13                    	int	13h
 21774                                  
 21775                                  	;pop	es  ; 12/12/2023	
 21776                                  
 21777 0000044F 720D                    	jc	short move_myself	; if error lets assume that the
 21778                                  					;  ROM BIOS lied
 21779                                  	;cmp	cl,0			; double check (max sec no cannot be 0)
 21780                                  	;je	short move_myself
 21781                                  	; 03/09/2023
 21782 00000451 08C9                    	or	cl,cl
 21783 00000453 7409                    	jz	short move_myself
 21784                                  
 21785 00000455 08D2                    	or	dl,dl			; number of flp drvs == 0?
 21786 00000457 7505                    	jnz	short move_myself	; no
 21787                                  
 21788                                  	;mov	byte [cs:fake_floppy_drv],1 ; set fake flag.
 21789                                  	; 12/12/2023
 21790                                  	; ds = cs
 21791 00000459 C606[8B02]01            	mov	byte [fake_floppy_drv],1 ; set fake flag.
 21792                                  
 21793                                  move_myself:
 21794                                  	; 12/12/2023
 21795                                  	;cld	; not necessary		; set up move
 21796                                  	;xor	si,si
 21797                                  	;mov	di,si
 21798                                  
 21799                                  	; 12/12/2023
 21800                                  	; ds = cs
 21801                                  	; 12/12/2022
 21802                                  	;push	cs
 21803                                  	;pop	ds
 21804                                  
 21805                                  	;mov	cx,[cs:MEMORY_SIZE]
 21806 0000045E 8B0E[9402]              	mov	cx,[MEMORY_SIZE] ; 12/12/2022
 21807                                  
 21808                                  	; (MSDOS 6.0 - SYSINIT1.ASM - 1991)
 21809                                  ;;;	if	msver
 21810                                  ;	cmp	cx,1		; 1 means do scan
 21811                                  ;	jnz	short noscan
 21812                                  ;	mov	cx,2048		; start scanning at 32k boundary
 21813                                  ;	xor	bx,bx
 21814                                  ;
 21815                                  ;memscan:inc	cx
 21816                                  ;	jz	short setend
 21817                                  ;	mov	ds,cx
 21818                                  ;	mov	al,[bx]
 21819                                  ;	not	al
 21820                                  ;	mov	[bx],al
 21821                                  ;	cmp	al,[bx]
 21822                                  ;	not	al
 21823                                  ;	mov	[bx],al
 21824                                  ;	jz	short memscan
 21825                                  ;setend:
 21826                                  ;	mov	cs:[memory_size],cx
 21827                                  ;;;	endif
 21828                                  
 21829                                  ;noscan: 				; cx is mem size in para
 21830                                  ;;
 21831                                  ;;	cas -- a) if we got our memory size from the ROM, we should test it
 21832                                  ;;		  before we try to run.
 21833                                  ;;	       b) in any case, we should check for sufficient memory and give
 21834                                  ;;		  an appropriate error diagnostic if there isn't enough
 21835                                  ;
 21836                                  ;	push	cs
 21837                                  ;	pop	ds
 21838                                  ;
 21839                                  ;;	cas note:  It would be better to put dos + bios_code BELOW sysinit
 21840                                  ;;	  that way it would be easier to slide them down home in a minimal
 21841                                  ;;	  memory system after sysinit.  As it is, you need room to keep
 21842                                  ;;	  two full non-overlapping copies, since sysinit sits between the
 21843                                  ;;	  temporary home and the final one.  the problem with doing that
 21844                                  ;;	  is that sys*.asm are filled with "mov ax,cs, sub ax,11h" type stuff.
 21845                                  ;
 21846                                  ;	dec	cx			; one para for an arena at end of mem
 21847                                  ;					; in case of UMBs
 21848                                  
 21849                                  	; 22/10/2022
 21850                                  	; (MSDOS 5.0 IO.SYS SYSINIT:04DBh)
 21851                                  
 21852                                  	; 12/12/2022
 21853                                  	;push	cs
 21854                                  	;pop	ds
 21855                                  
 21856 00000462 49                      	dec	cx
 21857                                  
 21858                                  ;------ Check if an RPL program is present at TOM and do not tromp over it
 21859                                  
 21860 00000463 31DB                    	xor	bx,bx
 21861 00000465 8EC3                    	mov	es,bx
 21862                                  	;mov	bx,[es:(2Fh*4)] ; INT 2Fh address (0:0BCh)
 21863                                  	;mov	es,[es:((2Fh*4)+2)] ; INT 2Fh segment (0:0BEh)
 21864                                  	; 29/09/2023
 21865 00000467 26C41EBC00              	les	bx,[es:(2Fh*4)]
 21866 0000046C 26817F035250            	cmp	word [es:bx+3],'RP'
 21867 00000472 751B                    	jne	short NoRPL
 21868 00000474 26807F054C              	cmp	byte [es:bx+5],'L'
 21869 00000479 7514                    	jne	short NoRPL
 21870                                  
 21871 0000047B 89CA                    	mov	dx,cx			; get TOM into DX
 21872 0000047D 52                      	push	dx
 21873 0000047E B8064A                  	mov	ax,4A06h
 21874                                  	;mov	ax,(multMULT<<8)+multMULTRPLTOM
 21875 00000481 CD2F                    	int	2Fh			; Get new TOM from any RPL
 21876 00000483 58                      	pop	ax
 21877 00000484 89D1                    	mov	cx,dx
 21878 00000486 39C2                    	cmp	dx,ax
 21879 00000488 7405                    	je	short NoRPL
 21880                                  	
 21881                                  	; 11/12/2022
 21882                                  	; ds = cs
 21883 0000048A 8916[9602]              	mov	[RPLMemTop],dx
 21884                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 21885                                  	;mov	[cs:RPLMemTop],dx
 21886                                  	
 21887 0000048E 49                      	dec	cx
 21888                                  NoRPL:
 21889 0000048F B8[A04D]                	mov	ax,SI_end		; need this much room for sysinit
 21890                                  					; (SI_end == sysinit code size)
 21891                                  					; 03/09/2023
 21892                                  					; (58A0h for MSDOS 6.21 IO.SYS)
 21893                                  					; (5B40h for PCDOS 7.1 IBMBIO.COM)
 21894 00000492 E8EE07                  	call	off_to_para
 21895 00000495 29C1                    	sub	cx,ax
 21896                                  
 21897                                  ; we need to leave room for the DOS and (if not ROMDOS) for the BIOS
 21898                                  ; code above sysinit in memory
 21899                                  ;
 21900 00000497 81E9000B                	sub	cx,DOSSIZE/16 ; (0A00h)	; leave this much room for DOS
 21901                                  			      ; (0B00h) ; (PCDOS 7.1 IBMBIO.COM) -03/09/2023-	
 21902                                  
 21903 0000049B B8801D                  	mov	ax,BCODE_END 		; (1A60h for MSDOS 5.0 IO.SYS)
 21904                                  					; (1A70h for MSDOS 6.21 IO.SYS)
 21905                                  					; 03/09/2023
 21906                                  					; (1E00h for PCDOS 7.1 IBMBIO.COM)
 21907 0000049E E8E207                  	call	off_to_para		; leave this much room for BIOS code
 21908 000004A1 29C1                    	sub	cx,ax
 21909 000004A3 8EC1                    	mov	es,cx			; segment where sysinit will be located
 21910                                  
 21911                                  	; 12/12/2023
 21912 000004A5 FC                      	cld	; not necessary		; set up move
 21913 000004A6 31F6                    	xor	si,si
 21914 000004A8 89F7                    	mov	di,si
 21915                                  
 21916 000004AA B9[A04D]                	mov	cx,SI_end		; (sysinit code size)
 21917 000004AD D1E9                    	shr	cx,1			; divide by 2 to get words
 21918 000004AF F3A5                    	rep	movsw			; relocate sysinit
 21919                                  
 21920 000004B1 06                      	push	es			; push relocated segment
 21921 000004B2 B8[B704]                	mov	ax,SYSIN
 21922 000004B5 50                      	push	ax			; push relocated entry point
 21923                                  
 21924 000004B6 CB                      	retf				; far jump to relocated sysinit
 21925                                  
 21926                                  ; =============== S U B R O U T I N E ========================================
 21927                                  
 21928                                  ; 30/12/2023
 21929                                  ; PCDOS 7.1 IBMBIO.COM - SYSINIT:04CEh
 21930                                  %if 0
 21931                                  get_cpu_type:
 21932                                  	pushf
 21933                                  	push	bx
 21934                                  	xor	bx,bx
 21935                                  	xor	ax,ax
 21936                                  	push	ax
 21937                                  	popf
 21938                                  	pushf
 21939                                  	pop	ax
 21940                                  	and	ax,0F000h
 21941                                  	cmp	ax,0F000h
 21942                                  	jz	short cpu_8086
 21943                                  	mov	ax,0F000h
 21944                                  	push	ax
 21945                                  	popf
 21946                                  	pushf
 21947                                  	pop	ax
 21948                                  	and	ax,0F000h
 21949                                  	jz	short cpu_286
 21950                                  cpu_386:
 21951                                  	inc	bx
 21952                                  cpu_286:
 21953                                  	inc	bx
 21954                                  cpu_8086:
 21955                                  	mov	ax,bx
 21956                                  	pop	bx
 21957                                  	popf
 21958                                  	retn
 21959                                  %endif
 21960                                  
 21961                                  ; ----------------------------------------------------------------------------
 21962                                  
 21963                                  
 21964                                  ;	MOVE THE DOS TO ITS PROPER LOCATION
 21965                                  
 21966                                  	; 22/10/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS)
 21967                                  	; (SYSINIT:0533h)
 21968                                  	; 30/12/2022 - Retro DOS 4.2 (Modified MSDOS 6.21 IO.SYS)
 21969                                  	; (SYSINIT:04BFh)
 21970                                  	; 03/09/2023 - Retro DOS 4.2 (5.0 - Modified PCDOS 7.1 IBMBIO.COM)
 21971                                  	; (SYSINIT:04F3h)
 21972                                  SYSIN:
 21973                                  	; Retro DOS 5.0 - 30/12/2023
 21974                                  	; Retro DOS 4.0 - 22/03/2019
 21975                                  	; Retro DOS 2.0 - 25/02/2018
 21976                                  
 21977                                  	; 23/04/2019
 21978                                  	;;mov	ax,Bios_Data
 21979                                  	;mov	ax,KERNEL_SEGMENT ; 0070h
 21980                                  	; 21/10/2022
 21981 000004B7 B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 21982 000004BA 8ED8                    	mov	ds,ax
 21983                                  
 21984                                  	; 30/12/2023 - Retro DOS v5.0
 21985                                  	;;;
 21986                                  	;push	es
 21987                                  	;push	ax		; not needed (*) E.TAN - 03/07/2023
 21988                                  	;push	di
 21989                                  	
 21990                                  	;call	get_cpu_type	; determine if 386 system
 21991                                  	;
 21992                                  get_cpu_type:
 21993 000004BC 9C                      	pushf
 21994 000004BD 31C0                    	xor	ax,ax
 21995 000004BF 50                      	push	ax
 21996 000004C0 9D                      	popf
 21997 000004C1 9C                      	pushf
 21998 000004C2 58                      	pop	ax
 21999 000004C3 2500F0                  	and	ax,0F000h
 22000 000004C6 3D00F0                  	cmp	ax,0F000h
 22001 000004C9 740F                    	jz	short cpu_8086
 22002 000004CB B800F0                  	mov	ax,0F000h
 22003 000004CE 50                      	push	ax
 22004 000004CF 9D                      	popf
 22005 000004D0 9C                      	pushf
 22006 000004D1 58                      	pop	ax
 22007 000004D2 2500F0                  	and	ax,0F000h
 22008 000004D5 7402                    	jz	short cpu_286
 22009                                  cpu_386:
 22010 000004D7 29C0                    	sub	ax,ax
 22011                                  cpu_286:
 22012 000004D9 40                      	inc	ax
 22013                                  cpu_8086:	; ax = 0
 22014                                  	; 30/12/2023
 22015 000004DA A2[BB06]                	mov	[cpu_type],al
 22016 000004DD 9D                      	popf
 22017                                  	;
 22018                                  	;cmp	ax,2		; 0 = 8086, 1 = 286, 2 = 386
 22019 000004DE 3C02                    	cmp	al,2
 22020 000004E0 7512                    	jnz     short not_386_system
 22021 000004E2 FC                      	cld			; 80386
 22022 000004E3 1E                      	push	ds
 22023 000004E4 07                      	pop	es		; change A20 line on/off check code
 22024 000004E5 BF[4D07]                	mov	di,cpu386_cmpsd
 22025 000004E8 B8B904                  	mov	ax,04B9h	; mov cx,4 ; B90400
 22026 000004EB AB                      	stosw
 22027 000004EC B800F3                  	mov	ax,0F300h	; repz  ; F3
 22028 000004EF AB                      	stosw
 22029 000004F0 B866A7                  	mov	ax,0A766h	; cmpsd ; 66A7
 22030 000004F3 AB                      	stosw
 22031                                  not_386_system:
 22032                                  	;pop	di
 22033                                  	;pop	ax
 22034                                  	;pop	es
 22035                                  	;;;	
 22036                                  
 22037 000004F4 8C0E[DB07]              	mov	[MoveDOSIntoHMA+2],cs	; set seg of routine to move DOS
 22038 000004F8 C606[DD07]01            	mov	byte [SysinitPresent],1	; flag that MoveDOSIntoHMA can be called
 22039                                  
 22040                                  ; first move the MSDOS.SYS image up to a harmless place 
 22041                                  ; on top of our new sysinitseg
 22042                                  
 22043                                  	; 22/10/2022
 22044 000004FD B8[A04D]                	mov	ax,SI_end		; how big is sysinitseg?
 22045 00000500 E88007                  	call	off_to_para
 22046 00000503 8CC9                    	mov	cx,cs			; pick a buffer for msdos above us
 22047 00000505 01C8                    	add	ax,cx
 22048 00000507 8EC0                    	mov	es,ax
 22049                                  	
 22050 00000509 31F6                    	xor	si,si
 22051 0000050B 89F7                    	mov	di,si
 22052                                  
 22053 0000050D 2E8E1E[7302]            	mov	ds,[cs:CURRENT_DOS_LOCATION] ; where it is (set by msinit)
 22054                                  
 22055                                  	;mov	ax,cs	
 22056                                  	;mov	ds,ax
 22057                                  
 22058                                  	;;;mov	cx,20480  ; MSDOS 6.21 IO.SYS - SYSINIT:04E2h
 22059                                  	;;mov	cx,dossize/2 ; MSDOS 6.0
 22060                                  	;mov	cx,[DOSSIZE] ; words (not bytes!)  ; Retro DOS v4.0 (3.0, 2.0)
 22061                                  	;mov	es,[FINAL_DOS_LOCATION] ; on top of SYSINIT code
 22062                                  	;mov	ds,[CURRENT_DOS_LOCATION]
 22063                                  
 22064                                  	; 22/10/2022
 22065 00000512 B90058                  	mov	cx,DOSSIZE/2 ; 5000h
 22066                                  			     ; 03/09/2023
 22067                                  			     ; 5800h (PCDOS 7.1)
 22068 00000515 F3A5                    	rep     movsw
 22069 00000517 2E8C06[7302]            	mov	[cs:CURRENT_DOS_LOCATION],es
 22070                                  
 22071                                  ; The DOS code is ORGed at a non-zero value to allow it to be located in
 22072                                  ; HIMEM. Thus, the DOS segment location must be adjusted accordingly.
 22073                                  ; If this is ROMDOS, however, only the init code is loaded into RAM, so
 22074                                  ; this ORG is not done. The entry point is at offset zero in the segment.
 22075                                  
 22076                                  	; 22/04/2019 (MSDOS 6.0 & MSDOS 6.21 kernel address modification)
 22077                                  	;mov	ax,cs
 22078                                  	; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS, SYSINIT)
 22079                                  	;mov	ds,ax
 22080                                  
 22081                                  ; 29/04/2019 - Retro DOS v4.0 ! important MODIFICATION !
 22082                                  
 22083                                  ;	; 24/04/2019 
 22084                                  ;;ifndef ROMDOS
 22085                                  ;	mov	ax,[es:3] 		; get offset of dos
 22086                                  ;		; ax = 3DE0h for MSDOS 6.21 kernel (MSDOS.SYS, offset 3) 
 22087                                  ;	mov	[dosinit],ax		; that's the entry point offset
 22088                                  ;	call	off_to_para		; subtract this much from segment
 22089                                  ;	; 23/04/2019
 22090                                  ;	;sub	[CURRENT_DOS_LOCATION],ax
 22091                                  ;	sub	[FINAL_DOS_LOCATION],ax
 22092                                  ;;else
 22093                                  ;;	mov	word [dosinit],0	; entry to init is at zero
 22094                                  ;;
 22095                                  ;;endif ; ROMDOS
 22096                                  
 22097                                  	; 29/04/2019 - Retro DOS v4.0 ! important MODIFICATION !
 22098                                  	; (! MSDOS6.BIN starts with DOSDATA ! - Retro DOS v4.0 modification) 
 22099                                  
 22100                                  	;mov	ax,[es:0] ; DOSCODE start address = DOSDATA size (= 136Ah)
 22101                                  	;		  ; (Valid for Retro DOS v4.0 only!)
 22102                                  
 22103                                  	; 22/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS, SYSINIT)
 22104                                  	; (SYSINIT:0563h for MSDOS 5.0 IO.SYS SYSINIT)
 22105                                  	; 03/09/2023 - Retro DOS 4.2 (Modified MSDOS 6.21 IO.SYS)
 22106                                  	; (SYSINIT:04ECh for MSDOS 6.21 IO.SYS SYSINIT)
 22107                                  	; (SYSINIT:0540h for PCDOS 7.1 IBMBIO.COM SYSINIT)
 22108 0000051C A10300                  	mov	ax, [3]		; mov ax, word ptr ds:3
 22109                                  
 22110 0000051F 2EA3[7102]              	mov	[cs:dosinit],ax ; (SYSINIT:0563h for MSDOS 5.0 IO.SYS SYSINIT)
 22111                                  	; 02/11/2022
 22112 00000523 E85D07                  	call	off_to_para		; subtract this much from segment
 22113 00000526 2E2906[7302]            	sub	[cs:CURRENT_DOS_LOCATION],ax
 22114                                  
 22115                                  	; Current DOSCODE start address = dword [dosinit]
 22116                                  
 22117                                  ;; If this is not ROMDOS, then the BIOS code is moved to the top of memory
 22118                                  ;; until it is determined whether it will be running in HIMEM or not.
 22119                                  
 22120                                  ;ifndef ROMDOS
 22121                                  
 22122                                  ; now put Bios_Code up on top of that. Assume Bios_Code + dossize < 64k
 22123                                  
 22124                                  	; 22/10/2022
 22125 0000052B 8CC0                    	mov	ax,es
 22126 0000052D 05000B                  	add	ax,DOSSIZE/16		; get paragraph of end of dos
 22127 00000530 8EC0                    	mov	es,ax
 22128 00000532 2E8706[8902]            	xchg	ax,[cs:temp_bcode_seg]	; swap with original home of Bios_Code
 22129 00000537 8ED8                    	mov	ds,ax			; point to loaded image of Bios_Code
 22130                                  
 22131                                  	;mov	si,BCODE_START ; mov si,30h
 22132                                  	; 09/12/2022
 22133 00000539 BE[3000]                	mov	si,BCODESTART
 22134                                  	; 02/11/2022
 22135 0000053C 89F7                    	mov	di,si
 22136 0000053E B9801D                  	mov	cx,BCODE_END   ; mov cx,1A60h ; mov cx,1A70h ; 30/12/2022
 22137 00000541 29F1                    	sub	cx,si
 22138 00000543 D1E9                    	shr	cx,1
 22139 00000545 F3A5                    	rep	movsw			; move Bios_Code into place
 22140                                  
 22141 00000547 8CC0                    	mov	ax,es			; tell it what segment it's in
 22142 00000549 2EFF1E[8702]            	call	far [cs:seg_reinit_ptr]	; far call to seg_reinit in Bios_Code (M022)
 22143                                  
 22144                                  ;endif	; not ROMDOS
 22145                                  
 22146                                  ; now call dosinit while it's in its temporary home
 22147                                  
 22148                                  	;mov	ax,cs
 22149                                  	;mov	ds,ax	 
 22150                                  
 22151                                  	;mov	dx,[MEMORY_SIZE]	; set for call to dosinit
 22152                                  
 22153                                  	; 22/10/2022
 22154                                  
 22155 0000054E 2EC43E[9503]            	les	di,[cs:BiosComBlock]	; ptr to BIOS communication block
 22156                                  		; es = KERNEL_SEGMENT (70h), di = 'SysInitPresent' address
 22157 00000553 2EC536[7502]            	lds	si,[cs:DEVICE_LIST]	; set for call to dosinit
 22158                                  		; ds = KERNEL_SEGMENT (70h), si = 'res_dev_list' address
 22159                                  
 22160 00000558 2E8B16[9402]            	mov	dx,[cs:MEMORY_SIZE]	; set for call to dosinit
 22161                                  
 22162 0000055D FA                      	cli
 22163 0000055E 8CC8                    	mov	ax,cs
 22164 00000560 8ED0                    	mov	ss,ax
 22165                                  
 22166                                  ; 30/12/2023 - Retro DOS v5.0 (PCDOS 7.1 IBMBIO.COM)
 22167                                  ; 22/03/2019 - Retro DOS v4.0 (MSDOS 6.0, SYSINIT1.ASM)
 22168                                  %define locstack ($ - SYSINIT$) & 0FFFEh  ; 532h in MSDOS 6.21 IO.SYS
 22169                                  					  ; 5A6h in MSDOS 5.0 IO.SYS SYSINIT
 22170                                  					  ; 586h in PCDOS 7.1 IBMBIO.COM SYSINIT
 22171                                  ;SYSINIT:0532h: 
 22172                                  
 22173                                  ; 22/10/2022
 22174                                  ; ----------------------------------------------------------------------------
 22175                                  ;SYSINIT:05A6h:
 22176                                  ;locstack:	; (at SYSINIT:05A6h for MSDOS 5.0 IO.SYS)
 22177                                  
 22178                                  ; 03/09/2023
 22179                                  ; (locstack at SYSINIT:0586h in PCDOS 7.1 IBMBIO.COM SYSINIT)
 22180                                  
 22181                                  	;mov	sp,05A6h
 22182 00000562 BC6205                  	mov     sp,locstack		; set stack
 22183                                  
 22184 00000565 FB                      	sti
 22185                                  
 22186                                  ;align 2
 22187                                  	; 30/03/2018
 22188                                  ;LOCSTACK:
 22189                                          ;CALL	FAR [CS:MSDOS]	; FINAL_DOS_LOCATION:0 
 22190                                  		       		;('jmp DOSINIT' in 'MSHEAD.ASM')
 22191                                  		       		;('DOSINIT:' is in 'MSINIT.ASM')
 22192                                  
 22193                                  	; 22/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 22194                                  	; 22/03/2019 - Retro DOS v4.0 (MSDOS 6.0, 6.21)
 22195                                  
 22196                                  ; This call to DOSINIT will relocate the DOS data from its present location
 22197                                  ; at the top of memory, to its final location in low memory just above the
 22198                                  ; BIOS data. It will then build important DOS data structures in low 
 22199                                  ; memory following the DOS data. It returns (among many other things) the
 22200                                  ; new starting address of free memory.
 22201                                  
 22202 00000566 2EFF1E[7102]            	call	far [cs:dosinit]	; call dosinit	
 22203                                  			 ; es:di -> sysinitvars_ext
 22204                                  
 22205 0000056B 2E8C1E[8502]            	mov	[cs:def_php],ds		; save pointer to PSP
 22206                                  	
 22207                                  	; 11/12/2022
 22208                                  	; 22/03/2019
 22209 00000570 0E                      	push	cs
 22210 00000571 1F                      	pop	ds
 22211                                  	; 22/10/2022
 22212 00000572 A3[8302]                	mov	[hi_doscod_size],ax
 22213 00000575 890E[8102]              	mov	[lo_doscod_size],cx
 22214 00000579 8916[7D02]              	mov	[dos_segreinit],dx
 22215                                  	
 22216                                  	; 11/12/2022
 22217                                  	; ds = cs
 22218                                  	;mov	[cs:hi_doscod_size],ax	; size of doscode (including exepatch)
 22219                                  	;mov	[cs:lo_doscod_size],cx	; (not including exepatch)
 22220                                  	;mov	[cs:dos_segreinit],dx	; save offset of segreinit
 22221                                  
 22222                                  	; 05/06/2018 - Retro DOS v3.0
 22223                                  	; ES:DI = Address of pointer to SYSINITVARS structure (MSDOS 3.3)
 22224                                  
 22225                                  	; 11/12/2022
 22226                                  	; ds = cs
 22227                                  	; 22/10/2022
 22228                                  	;mov	ax,[es:di+SysInitVars_Ext.SYSI_InitVars] ; 5/29/86
 22229 0000057D 268B05                  	mov	ax,[es:di] ; 22/03/2019
 22230                                  	;mov	[cs:DOSINFO],ax
 22231 00000580 A3[6D02]                	mov	[DOSINFO],ax
 22232                                  	;mov	ax,[es:di+SysInitVars_Ext.SYSI_InitVars+2]
 22233 00000583 268B4502                	mov	ax,[es:di+2]
 22234                                  	;mov	[cs:DOSINFO+2],ax
 22235 00000587 A3[6F02]                	mov	[DOSINFO+2],ax	; set the sysvar pointer
 22236                                  
 22237                                  	;mov	ax,[es:di+SysInitVars_Ext.SYSI_Country_Tab]
 22238 0000058A 268B4504                	mov	ax,[es:di+4]
 22239                                  	;mov	[cs:sysi_country],ax
 22240 0000058E A3[7902]                	mov	[sysi_country],ax
 22241                                  	;mov	ax,[es:di+SysInitVars_Ext.SYSI_Country_Tab+2]
 22242 00000591 268B4506                	mov	ax,[es:di+6]
 22243                                  	;mov	[cs:sysi_country+2],ax
 22244 00000595 A3[7B02]                	mov	[sysi_country+2],ax	; set the SYSI_Country pointer
 22245                                  
 22246                                  	; 20/04/2019
 22247                                  	;mov	ax,[CURRENT_DOS_LOCATION]
 22248                                  	;;mov	es,[CURRENT_DOS_LOCATION]
 22249                                  	;mov	ax,[FINAL_DOS_LOCATION] ; give dos its temporary location
 22250                                  	; 22/10/2022
 22251                                  	;mov	ax,[cs:CURRENT_DOS_LOCATION]
 22252                                  	;;;mov	[dos_segreinit+2],es
 22253                                  	;;mov	[dos_segreinit+2],ax
 22254                                  	;mov	[cs:dos_segreinit+2],ax
 22255                                  	; 11/12/2022
 22256                                  	; ds = cs
 22257 00000598 8E06[7302]              	mov	es,[CURRENT_DOS_LOCATION]
 22258 0000059C 8C06[7F02]              	mov	[dos_segreinit+2],es
 22259                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 22260                                  	;mov	es,[cs:CURRENT_DOS_LOCATION]
 22261                                  	;mov	[cs:dos_segreinit+2],es
 22262                                  
 22263                                  ; ----------------------------------------------------------------------------
 22264                                  
 22265                                  ;SYSINIT:0577h:
 22266                                  	; ... RPLArena ... MSDOS 6.21 IO.SYS (SYSINIT:0577h to SYSINIT:05D1h)
 22267                                  ;SYSINIT:05D1h:	; NoRPLArena 
 22268                                  
 22269                                  	; 22/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS SYSINIT)
 22270                                  ;------ Cover up RPL code with an arena
 22271                                  ;SYSINIT:05EBh:
 22272                                  	; 11/12/2022
 22273                                  	; ds = cs
 22274 000005A0 31DB                    	xor	bx,bx
 22275 000005A2 391E[9602]              	cmp	[RPLMemTop],bx ; 0
 22276                                  	;cmp	word [RPLMemTop],0
 22277                                  	;;cmp	word [cs:RPLMemTop],0
 22278 000005A6 7450                    	je	short NoRPLArena
 22279                                  
 22280                                  ;------ alloc all memory
 22281                                  
 22282                                  	; 11/12/2022
 22283                                  	;mov	bx,0FFFFh
 22284 000005A8 4B                      	dec	bx
 22285                                  	; bx = 0FFFFh
 22286 000005A9 B448                    	mov	ah,48h
 22287 000005AB CD21                    	int	21h
 22288                                  			; DOS - 2+ - ALLOCATE MEMORY
 22289                                  			; BX = number of 16-byte paragraphs desired
 22290 000005AD B448                    	mov	ah,48h
 22291 000005AF CD21                    	int	21h
 22292                                  
 22293 000005B1 8EC0                    	mov	es,ax			; get it into ES and save it
 22294 000005B3 06                      	push	es
 22295                                  
 22296                                  ;------ resize upto RPL mem
 22297                                  
 22298                                  	; 11/12/2022
 22299                                  	; ds = cs
 22300                                  	;sub	ax,[cs:RPLMemTop]
 22301 000005B4 2B06[9602]              	sub	ax,[RPLMemTop]
 22302 000005B8 F7D8                    	neg	ax
 22303 000005BA 48                      	dec	ax
 22304 000005BB 89C3                    	mov	bx,ax
 22305 000005BD B44A                    	mov	ah,4Ah
 22306 000005BF CD21                    	int	21h
 22307                                    			; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
 22308                                  			; ES = segment address of block to change
 22309                                  			; BX = new size in paragraphs
 22310                                  
 22311                                  ;------ allocate the free (RPL MEM)
 22312                                  
 22313 000005C1 BBFFFF                  	mov	bx,0FFFFh
 22314 000005C4 B448                    	mov	ah,48h
 22315 000005C6 CD21                    	int	21h
 22316 000005C8 B448                    	mov	ah,48h
 22317 000005CA CD21                    	int	21h
 22318                                  
 22319                                  ;----- mark that it belongs to RPL
 22320                                  
 22321 000005CC 48                      	dec	ax
 22322 000005CD 8EC0                    	mov	es,ax
 22323                                  	;mov	word [es:arena_owner],8
 22324 000005CF 26C70601000800          	mov	word [es:1],8
 22325                                  	;mov	word [es:arena_name],'RP'
 22326 000005D6 26C70608005250          	mov	word [es:8],'RP'
 22327                                  	;mov	word [es:arena_name+2],'L'
 22328 000005DD 26C7060A004C00          	mov	word [es:10],'L'
 22329                                  	;mov	word [es:arena_name+4],0
 22330 000005E4 26C7060C000000          	mov	word [es:12],0
 22331                                  	;mov	word [es:arena_name+6],0
 22332 000005EB 26C7060E000000          	mov	word [es:14],0	
 22333                                  
 22334 000005F2 07                              pop     es                      ; get back ptr to first block
 22335 000005F3 B449                            mov     ah,49h	; Dealloc	; and free it
 22336 000005F5 CD21                    	int	21h		
 22337                                  					; DOS - 2+ - FREE MEMORY
 22338                                  					; ES = segment address of area to be freed
 22339                                  	; 11/12/2022
 22340 000005F7 F8                      	clc
 22341                                  
 22342                                  ; ----------------------------------------------------------------------------
 22343                                  
 22344                                  NoRPLArena:
 22345                                  	; 11/12/2022
 22346                                  	; ds = cs
 22347                                  	; 22/03/2019 - Retro DOS v4.0 (MSDOS 6.0, 6.21, IO.SYS)
 22348 000005F8 C43E[6D02]              	les	di,[DOSINFO]	; es:di -> dosinfo
 22349                                  	; 22/10/2022 - Retro DOS v4.0 (MSDOS 5.0 IO.SYS SYSINIT)
 22350                                  	;les	di,[cs:DOSINFO]	; es:di -> dosinfo
 22351                                  
 22352                                  	; 11/12/2022
 22353                                  	;clc				; get the extended memory size
 22354                                  
 22355                                  ;	execute the get extended memory size subfunction in the bios int 15h
 22356                                  ;	if the function reports an error do nothing else store the extended
 22357                                  ;	memory size reported at the appropriate location in the dosinfo buffer
 22358                                  ;	currently pointed to by es:di. use the offsets specified in the
 22359                                  ;	definition of the sysinitvars struct in inc\sysvar.inc
 22360                                  
 22361 000005FC B488                    	mov	ah,88h
 22362 000005FE CD15                    	int	15h			; check extended memory size
 22363 00000600 720B                    	jc	short no_ext_memory
 22364                                  			; Get Extended Memory Size
 22365                                  			; Return: CF clear on success
 22366                                  			; AX = size of memory above 1M in K	
 22367                                  	;mov	[es:di+SYSI_EXT_MEM],ax ; save extended memory size
 22368                                  	; 22/10/2022
 22369 00000602 26894545                	mov	[es:di+45h],ax ; save extended memory size
 22370 00000606 09C0                    	or	ax,ax
 22371 00000608 7403                    	jz	short no_ext_memory
 22372 0000060A E8EF05                  	call	ClrVDISKHeader
 22373                                  no_ext_memory:
 22374                                  	;mov	ax,[es:di+SYSI_MAXSEC]	; get the sector size
 22375 0000060D 268B4510                	mov	ax,[es:di+10h]
 22376                                  	;add	ax,bufinsiz
 22377 00000611 83C014                  	add	ax,20			; size of buffer header
 22378                                  	; 11/12/2022
 22379                                  	; ds = cs
 22380 00000614 A3[9D02]                	mov	[singlebuffersize],ax	; total size for a buffer
 22381                                  	;mov	[cs:singlebuffersize],ax	
 22382                                  	; 11/12/2022
 22383 00000617 A0[9802]                	mov	al,[DEFAULT_DRIVE]	; get the 1 based boot drive number set by msinit
 22384                                  	;mov	al,[cs:DEFAULT_DRIVE]
 22385                                  	;mov	[es:di+SYSI_BOOT_DRIVE],al ; set sysi_boot_drive
 22386 0000061A 26884543                	mov	[es:di+43h],al
 22387                                  
 22388                                  ; determine if 386 system...
 22389                                  
 22390                                  ; 30/12/2023
 22391                                  %if 0
 22392                                  	;get_cpu_type			; macro to determine cpu type
 22393                                  
 22394                                  get_cpu_type:
 22395                                  	; 11/12/2022
 22396                                  	pushf
 22397                                  	;push	bx
 22398                                  	;xor	bx,bx
 22399                                  	; 11/12/2022
 22400                                  	;xor	cx,cx
 22401                                  	;
 22402                                  	xor	ax,ax
 22403                                  	; ax = 0
 22404                                  	push    ax
 22405                                  	popf
 22406                                  	pushf
 22407                                  	pop	ax
 22408                                  	and	ax,0F000h
 22409                                  	;cmp	ax,0F000h
 22410                                  	cmp	ah,0F0h 
 22411                                  	je	short cpu_8086
 22412                                  	;mov	ax,0F000h
 22413                                  	mov	ah,0F0h
 22414                                  	; ax = 0F000h
 22415                                  	push	ax
 22416                                  	popf
 22417                                  	pushf
 22418                                  	pop	ax
 22419                                  	;and	ax,0F000h
 22420                                  	and	ah,0F0h
 22421                                  	jz	short cpu_286
 22422                                  cpu_386:
 22423                                  	; 11/12/2022
 22424                                  	;;inc	bx
 22425                                  	;inc	cx
 22426                                  	; 11/12/2022
 22427                                  	;mov	byte [es:di+SYSI_DWMOVE],1
 22428                                  	mov	byte [es:di+44h],1
 22429                                  
 22430                                  	; 03/09/2023 - Retro DOS v5.0 (PCDOS 7.1 Modified SYSINIT)
 22431                                  	; change A20 line on/off check code to the faster (for 32 bit cpu)
 22432                                  	;push	es
 22433                                  	;push	di
 22434                                  	;mov	ax,DOSBIODATASEG ; 0070h
 22435                                  	;mov	es,ax
 22436                                  	;cld
 22437                                  	;mov	di,cpu386_cmpsd ; (IsA20Off)
 22438                                  	;mov	ax,4B9h        ; mov cx,4 ; B90400
 22439                                  	;stosw
 22440                                  	;mov	ax,0F300h      ; repz  ; F3
 22441                                  	;stosw
 22442                                  	;mov	ax,0A766h      ; cmpsd ; 66A7
 22443                                  	;stosw
 22444                                  	;pop	di
 22445                                  	;pop	es
 22446                                  
 22447                                  cpu_286:
 22448                                  	;;;inc	bx
 22449                                  	;;inc	cx
 22450                                  cpu_8086:
 22451                                  	; 11/12/2022
 22452                                  	;;mov	ax,bx	
 22453                                  	;pop	bx
 22454                                  	popf
 22455                                  %endif
 22456                                  	;...
 22457                                  
 22458                                  	; 11/12/2022
 22459                                  	;or	cl,cl
 22460                                  	;jz	short not_386_system
 22461                                  	; 11/12/202
 22462                                  	;cmp	cl,2
 22463                                  	;;cmp	ax,2			; is it a 386?
 22464                                  	;jne	short not_386_system	; no: don't mess with flag
 22465                                  
 22466                                  	; 30/12/2023 - Retro DOS v5.0
 22467 0000061E 803E[BB06]02            	cmp	byte [cpu_type], 2	; is it a 386?
 22468 00000623 7505                    	jne	short _not_386_system	; no: don't mess with flag
 22469                                  	
 22470                                  	;mov	byte [es:di+SYSI_DWMOVE],1
 22471                                  	; 11/12/2022
 22472                                  	; 22/10/2022
 22473 00000625 26C6454401              	mov	byte [es:di+44h],1
 22474                                  _not_386_system:
 22475                                  	;mov	al,[es:di+SYSI_NUMIO]
 22476 0000062A 268A4520                	mov	al,[es:di+20h]
 22477                                  	; 11/12/2022
 22478                                  	; ds = cs
 22479 0000062E A2[8503]                	mov	[drivenumber],al	; save start of installable block drvs
 22480                                  	;mov	[cs:drivenumber],al
 22481                                  
 22482 00000631 8CC8                    	mov	ax,cs
 22483 00000633 83E811                  	sub	ax,11h			; room for PSP we will copy shortly
 22484                                  	; 11/12/2022
 22485                                  	;mov	cx,[singlebuffersize]	; temporary single buffer area
 22486                                  	;;mov	cx,[cs:singlebuffersize]
 22487                                  	;shr	cx,1			
 22488                                  	;shr	cx,1			; divide size by 16...
 22489                                  	;shr	cx,1
 22490                                  	;shr	cx,1			; ...to get paragraphs...
 22491                                  	;inc	cx			; ... and round up
 22492                                  	; 11/12/2022
 22493 00000636 8B1E[9D02]              	mov	bx,[singlebuffersize]
 22494 0000063A B104                    	mov	cl,4
 22495 0000063C D3EB                    	shr	bx,cl
 22496 0000063E 43                      	inc	bx
 22497                                  
 22498                                  ;	cas note: this unorthodox paragraph rounding scheme wastes a byte
 22499                                  ;	  if [singlebuffersize] ever happens to be zero mod 16. Could this
 22500                                  ;	  ever happen? Only if the buffer overhead was zero mod 16, since
 22501                                  ;	  it is probably safe to assume that the sector size always will be.
 22502                                  ;
 22503                                  ;	 mohans also found a bug in CONFIG.SYS processing where it replaces
 22504                                  ;	  EOF's with cr,lf's, without checking for collision with [confbot].
 22505                                  ;	  perhaps the extra byte this code guarantees is what has kept that
 22506                                  ;	  other code from ever causing a problem???
 22507                                  
 22508                                  	; 11/12/2022
 22509 0000063F 29D8                    	sub	ax,bx
 22510                                  	;sub	ax,cx
 22511 00000641 A3[A702]                	mov	[top_of_cdss],ax	; temp "unsafe" location
 22512                                  	; 22/10/2022
 22513                                  	;mov	[cs:top_of_cdss],ax
 22514                                  
 22515                                  ;	chuckst -- 25 Jul 92 -- added code here to pre-allocate space
 22516                                  ;	for 26 temporary CDSs, which makes it easier to use alloclim
 22517                                  ;	for allocating memory for MagicDrv.
 22518                                  
 22519 00000644 06                      	push	es			; preserve pointer to dosinfo
 22520 00000645 57                      	push	di
 22521                                  
 22522                                  	; 22/10/2022
 22523                                  ;	mov	cx,ax			; save pointer for buffer
 22524                                  ;
 22525                                  ;;	now allocate space for 26 CDSs
 22526                                  ;
 22527                                  ;	sub	ax,((26 *(curdirlen))+15)/16
 22528                                  ;	mov	[ALLOCLIM],ax		; init top of free memory pointer
 22529                                  ;	mov	[CONFBOT],ax		; init this in case no CONFIG.SYS
 22530                                  
 22531                                  	; 30/12/2022 - Retro DOS v4.2 (MSDOS 6.21 IO.SYS)
 22532                                  	; (SYSINIT:064Ch)
 22533 00000646 89C1                    	mov	cx,ax ; (*)
 22534 00000648 2D8F00                  	sub	ax,((26 *(curdirlen))+15)/16 ; sub ax,143
 22535 0000064B A3[A502]                	mov	[ALLOCLIM],ax		; init top of free memory pointer
 22536 0000064E A3[A302]                	mov	[CONFBOT],ax		; init this in case no CONFIG.SYS
 22537                                  	 	
 22538                                  ; setup and initialize the temporary buffer at cx
 22539                                  
 22540                                  	;les	di,[es:di+SYSI_BUF]	; get the buffer chain entry pointer
 22541 00000651 26C47D12                	les	di,[es:di+12h]
 22542                                  	; 11/12/2022
 22543 00000655 31DB                    	xor	bx,bx
 22544                                  	;xor	ax,ax
 22545                                  	;mov	[es:di+BUFFINF.Dirty_Buff_Count],ax ; 0
 22546                                  	;mov	word [es:di+4],0
 22547 00000657 26895D04                	mov	[es:di+4],bx ; 0
 22548                                  	;mov	[es:di+BUFFINF.Buff_Queue],ax ; 0
 22549                                  	;mov	word [es:di],0
 22550 0000065B 26891D                  	mov	[es:di],bx ; 0
 22551                                  	;mov	[es:di+BUFFINF.Buff_Queue+2],cx ; cx = [top_of_cdss] ; 6.21
 22552                                  	;;mov	[es:di+BUFFINF.Buff_Queue+2],ax ; ax = [top_of_cdss] ; 5.0
 22553                                  	;mov	[es:di+2],ax
 22554                                  	;mov	es,ax	; [top_of_cdss] = [CONFBOT]
 22555                                  	; 30/12/2022 - Retro DOS v4.2 (MSDOS 6.21 IO.SYS, SYSINIT)
 22556 0000065E 26894D02                	mov	[es:di+2],cx ; [top_of_cdss] ; (*)	
 22557 00000662 8EC1                    	mov	es,cx
 22558                                  
 22559                                  	; 11/12/2022
 22560                                  	;xor	ax,ax
 22561                                  	;mov	di,ax			; es:di -> single buffer
 22562 00000664 89DF                    	mov	di,bx
 22563                                  	; di = 0
 22564                                  
 22565                                  	;mov	[es:di+buffinfo.buf_next],ax ; points to itself
 22566                                  	; 11/12/2022
 22567                                  	;mov	[es:di],ax ; 0
 22568 00000666 26891D                  	mov	[es:di],bx ; 0
 22569                                  	;mov	[es:di+buffinfo.buf_prev],ax ; points to itself
 22570                                  	; 11/12/2022
 22571                                  	;mov	[es:di+2],ax ; 0
 22572 00000669 26895D02                	mov	[es:di+2],bx ; 0 
 22573                                  
 22574                                  	; 22/10/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS SYINIT)
 22575                                  	; MSDOS 5.0 IO.SYS - SYSINIT:06E0h
 22576                                  
 22577                                  	;mov	word [es:di+buffinfo.buf_ID],00FFh ; free buffer,clear flag
 22578 0000066D 26C74504FF00            	mov	word [es:di+4],00FFh
 22579                                  ;SYSINIT:06E6h
 22580                                  	;;mov	[es:di+buffinfo.buf_sector],ax ; 0
 22581                                  	;mov	word [es:di+6],0
 22582                                  	; 11/12/2022
 22583                                  	;mov	[es:di+buffinfo.buf_sector],bx ; 0
 22584 00000673 26895D06                	mov	[es:di+6],bx ; 0
 22585                                  	;;mov	[es:di+buffinfo.buf_sector+2],ax ; 0
 22586                                  	;mov	word [es:di+8],0
 22587                                  	; 11/12/2022
 22588                                  	;mov	[es:di+buffinfo.buf_sector+2],bx ; 0
 22589 00000677 26895D08                	mov	[es:di+8],bx ; 0
 22590                                  
 22591 0000067B 5F                      	pop	di			; restore pointer to DOSINFO data
 22592 0000067C 07                      	pop	es
 22593                                  
 22594                                  	; 11/12/2022
 22595                                  	; ds = cs
 22596                                  	; 22/10/2022
 22597                                  	;push	cs
 22598                                  	;pop	ds
 22599                                  
 22600 0000067D E80C06                  	call	TempCDS			; set up cdss so re_init and sysinit
 22601                                  					;  can make disk system calls
 22602                                  					; tempcds trashes ds
 22603                                  	; 10/05/2019
 22604 00000680 2E8E1E[8502]            	mov	ds,[cs:def_php]		; retrieve pointer to PSP returned by DOSINIT
 22605                                  
 22606                                  	;if not ibmjapver
 22607                                  	;call	far KERNEL_SEGMENT:re_init ; re-call the bios
 22608                                  	;endif
 22609                                  
 22610                                  	; 22/10/2022
 22611                                  ;SYSINIT:06FEh:	; (MSDOS 5.0 IO.SYS, SYSINIT)
 22612                                  	; 30/12/2022
 22613                                  ;SYSINIT:0697h:	; (MSDOS 6.21 IO.SYS, SYSINIT)
 22614                                  	;call	far ptr 70h:89Bh
 22615 00000685 9A[2807]7000            	call	DOSBIODATASEG:RE_INIT
 22616                                  
 22617 0000068A FB                      	sti				; ints ok
 22618 0000068B FC                      	cld				; make sure
 22619                                  
 22620                                  ; 23/03/2019
 22621                                  
 22622                                  ;SYSINIT:069Eh	; 30/12/2022
 22623                                  
 22624                                  ; dosinit has set up a default "process" (php) at ds:0. we will move it out
 22625                                  ; of the way by putting it just below sysinit at end of memory.
 22626                                  
 22627 0000068C 8CCB                    	mov	bx,cs
 22628 0000068E 83EB10                  	sub	bx,10h
 22629 00000691 8EC3                    	mov	es,bx
 22630 00000693 31F6                    	xor	si,si
 22631 00000695 89F7                    	mov	di,si
 22632 00000697 B98000                  	mov	cx,128
 22633 0000069A F3A5                    	rep	movsw
 22634                                  
 22635                                  	;mov	[es:PDB.JFN_POINTER+2],es ; Relocate
 22636                                  	; 22/10/2022
 22637 0000069C 268C063600              	mov	[es:36h],es
 22638                                  
 22639                                   	; Set Process Data Block - Program Segment Prefix address
 22640                                  	; BX = PDB/PSP segment
 22641 000006A1 B450                            mov	ah,50h	; SET_CURRENT_PDB
 22642 000006A3 CD21                    	int	21h			; tell DOS we moved it
 22643                                  			; DOS - 2+ internal - SET PSP SEGMENT
 22644                                  			; BX = segment address of new PSP
 22645                                  	; 22/10/2022
 22646                                  	; 27/03/2019
 22647                                  	; 30/12/2023
 22648                                  	;push	ds ; */			; preserve DS returned by DOSINIT
 22649                                  
 22650 000006A5 0E                      	push	cs	
 22651 000006A6 1F                      	pop	ds
 22652                                  
 22653                                  	; set up temp. critical error handler
 22654 000006A7 BA[2645]                	mov	dx,int24		; set up int 24 handler
 22655                                  	;;mov	ax,(SET_INTERRUPT_VECTOR*256)+24h
 22656                                  	;mov	ax,(SET_INTERRUPT_VECTOR<<8)|24h
 22657 000006AA B82425                  	mov	ax,2524h
 22658 000006AD CD21                    	int	21h
 22659                                  
 22660 000006AF 803E[8803]00                    cmp     byte [toomanydrivesflag],0 ; Q: >24 partitions?      M029
 22661 000006B4 7406                            je      short no_err		   ;  N: continue            M029
 22662 000006B6 BA[574D]                        mov     dx,TooManyDrivesMsg	   ;  Y: print error message M029
 22663                                          ; 22/10/2022
 22664                                  	;call	print 			   ;		             M029
 22665                                  	; 12/12/2022
 22666 000006B9 EB04                    	jmp	short p_dosinit_msg ; 23/03/2019 - Retro DOS v4.0
 22667                                  
 22668                                  	; 30/12/2023 - Retro DOS v5.0
 22669                                  cpu_type:
 22670 000006BB FF                      	db 0FFh	; db 0
 22671                                  
 22672                                  no_err:
 22673                                  	; 12/05/2019
 22674                                  	;----------------------------------------------
 22675                                  	; 27/06/2018 - Retro DOS v3.0	; 23/03/2019 - Retro DOS v4.0
 22676                                  	; 22/10/2022 - Retro DOS v4.0
 22677                                  	; 12/12/2022
 22678                                  	; 30/12/2023 - Retro DOS v5.0
 22679 000006BC BA[2A45]                	mov	dx,BOOTMES		; Display (fake) MSDOS version message
 22680                                  p_dosinit_msg:
 22681 000006BF E83F3E                  	call	print			; Print message
 22682                                  	;----------------------------------------------
 22683                                  	
 22684                                  	; 11/12/2022
 22685                                  	; 22/10/2022
 22686                                  	; 23/03/2019 - Retro DOS v4.0
 22687                                  	;pop	ds			; start of free memory
 22688                                  	;mov	dl,[cs:DEFAULT_DRIVE]
 22689                                  	
 22690                                  	; 11/12/2022
 22691                                  	; 27/03/2019
 22692 000006C2 8A16[9802]              	mov	dl,[DEFAULT_DRIVE]	
 22693                                  	; 30/12/2023
 22694                                  	;pop	ds ; */
 22695                                  
 22696 000006C6 08D2                    	or	dl,dl
 22697                                  	; 30/12/2023
 22698 000006C8 7405                    	jz	short nodrvset		; bios didn't say
 22699                                  	;jz	short ProcessConfig  ; (Retro DOS v4.0 does not contain DBLSPACE code)
 22700                                  	;dec	dl			; A = 0
 22701                                  	; 18/12/2022
 22702 000006CA 4A                      	dec	dx
 22703 000006CB B40E                    	mov	ah,0Eh	; SET_DEFAULT_DRIVE
 22704 000006CD CD21                    	int	21h			; select the disk
 22705                                  			; DOS - SELECT DISK
 22706                                  			; DL = new default drive number (0 = A, 1 = B, etc.)
 22707                                  			; Return: AL = number of logical drives
 22708                                  nodrvset:
 22709                                  	; 04/01/2023 - Retro DOS 4.2 (Modified MSDOS 6.21 IO.SYS SYINIT)
 22710                                  	; (SYSINIT:06DFh)
 22711                                  	
 22712                                  	; 30/12/2023 - Retro DOS 5.0
 22713                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:0733h)
 22714 000006CF 1E                      	push	ds
 22715 000006D0 29C0                    	sub	ax,ax
 22716 000006D2 8ED8                    	mov	ds,ax ; 0 ; ROM BIOS Data Area
 22717 000006D4 A16C04                  	mov	ax,[46Ch] ; timer tick count (18.2 ticks per second)
 22718                                  	;mov	[cs:_timer_lw_],ax
 22719 000006D7 1F                      	pop	ds
 22720                                  	; ds = cs	
 22721 000006D8 A3[8C03]                	mov	[_timer_lw_],ax
 22722                                  
 22723                                  	; ---------------------
 22724                                  
 22725                                  	;ifdef	dblspace_hooks
 22726                                  	;	....
 22727                                  	;	....
 22728                                  	;endif
 22729                                  
 22730                                  	; ---------------------
 22731                                  
 22732                                  
 22733                                  	; 30/12/2023 - Retro DOS 5.0 (Modified MSDOS 7.1 IBMBIO.COM SYS SYINIT)
 22734                                  ; ----------------------------------------------------------------------------
 22735                                  	; (SYSINIT:0740h)
 22736                                  
 22737 000006DB 0E                      	push	cs
 22738 000006DC 07                      	pop	es
 22739                                  
 22740                                  	; burada kaldm ... 30/12/2023
 22741                                  
 22742                                  ; ----------------------------------------------------------------------------
 22743                                  
 22744                                  
 22745                                  ; MSDOS 6.21 IO.SYS, SYSINIT:0744h
 22746                                  
 22747                                  ; 23/03/2019 - Retro DOS v4.0 (MSDOS 6.0, SYSINIT1.ASM, 1991)
 22748                                  ; ----------------------------------------------------------------------------
 22749                                  ; 22/10/2022 - Retro DOS v4.0 (MSDOS 5.0 IO.SYS SYSINIT)
 22750                                  ; ----------------------------------------------------------------------------
 22751                                  ; 30/12/2022 - Retro DOS v4.2 (MSDOS 6.21 IO.SYS SYSINIT)
 22752                                  
 22753                                  ProcessConfig:
 22754                                  	;; ds = cs ; 27/03/2019
 22755                                  	; 11/12/2022
 22756                                  	; ds <> cs	
 22757                                  
 22758                                  ; (MSDOS 5.0 IO.SYS - SYSINIT:0746h)
 22759                                  
 22760 000006DD E8E118                  	call	doconf			; do pre-scan for dos=high/low
 22761                                  
 22762                                  	; 11/12/2022
 22763                                  	; 27/03/2019
 22764                                  	; ds = cs (at return from doconf)
 22765                                  
 22766                                  ; Now, if this is not romdos, we decide what to do with the DOS code.
 22767                                  ; It will either be relocated to low memory, above the DOS data structures,
 22768                                  ; or else it will be located in HiMem, in which case a stub with the DOS
 22769                                  ; code entry points will be located in low memory. Dos_segreinit is used
 22770                                  ; to tell the DOS data where the code has been placed, and to install the
 22771                                  ; low memory stub if necessary. If the DOS is going to go into HiMem, we
 22772                                  ; must first initialize it in its present location and load the installable
 22773                                  ; device drivers. Then, if a HiMem driver has been located, we can actually
 22774                                  ; relocate the DOS code into HiMem.
 22775                                  ;
 22776                                  ; For ROMDOS, if DOS=HIGH is indicated, then we need to call dos_segreinit
 22777                                  ; to install the low memory stub (this must be done before allowing any
 22778                                  ; device drivers to hook interrupt vectors). Otherwise, we don't need to 
 22779                                  ; call dos_segreinit at all, since the interrupt vector table has already 
 22780                                  ; been patched.
 22781                                  
 22782                                  	; 22/10/2022 - Retro DOS v4.0
 22783                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:0749h)
 22784                                  	;cmp	byte [cs:runhigh],0	; Did user choose to run low ?
 22785                                  	; 11/12/2022
 22786 000006E0 803E[6C02]00            	cmp	byte [runhigh],0
 22787 000006E5 740C                    	je	short dont_install_stub	; yes, don't install dos low mem stub
 22788                                  
 22789                                  ;------ user chose to load high
 22790                                  
 22791                                  	; 22/10/2022
 22792                                  	;mov	es,[cs:CURRENT_DOS_LOCATION] ; MSDOS 6.21 (& MSDOS 6.0)
 22793                                  	; 11/12/2022
 22794                                  	; ds = cs
 22795 000006E7 8E06[7302]              	mov	es,[CURRENT_DOS_LOCATION]
 22796                                  
 22797                                  	;mov	es,[cs:FINAL_DOS_LOCATION]   ; Retro DOS v4.0
 22798                                  	; 27/03/2019
 22799                                  	;;mov	es,[FINAL_DOS_LOCATION]
 22800                                  
 22801 000006EB 31C0                    	xor	ax,ax			; ax = 0 ---> install stub
 22802                                  	; 11/12/2022
 22803                                  	; ds = cs
 22804                                  	;call	far [cs:dos_segreinit]	; call dos segreinit
 22805 000006ED FF1E[7D02]              	call	far [dos_segreinit]
 22806                                  
 22807 000006F1 EB10                    	jmp	short do_multi_pass
 22808                                  
 22809                                  ;------ User chose to load dos low
 22810                                  
 22811                                  dont_install_stub:
 22812                                  	; 22/10/2022
 22813 000006F3 31DB                    	xor	bx,bx			; M012
 22814                                  					; don't use int 21 call to alloc mem
 22815 000006F5 E8D002                  	call	MovDOSLo		; move it !
 22816                                  
 22817 000006F8 B80100                  	mov	ax,1			; dont install stub
 22818                                  	; 11/12/2022
 22819                                  	; ds = cs
 22820 000006FB 8E06[7302]              	mov	es,[CURRENT_DOS_LOCATION]
 22821                                  	;mov	es,[cs:CURRENT_DOS_LOCATION] ; set_dos_final_position set it up
 22822                                  	;;mov	es,[cs:FINAL_DOS_LOCATION]   ; Retro DOS v4.0
 22823                                  	; 27/03/2019
 22824                                  ;do_multi_pass:
 22825                                  	;;mov	es,[FINAL_DOS_LOCATION] 
 22826                                  
 22827                                  	; 11/12/2022
 22828                                  	; ds = cs
 22829                                  	;call	far [cs:dos_segreinit]	; inform dos about new seg
 22830 000006FF FF1E[7D02]              	call	far [dos_segreinit]
 22831                                  do_multi_pass:
 22832 00000703 E80C02                  	call	AllocFreeMem		; allocate all the free mem
 22833                                  					; & update [memhi] & [area]
 22834                                  					; start of free memory.
 22835                                  	;ifdef	dblspace_hooks
 22836                                  	;mov	bx,0			; magic backdoor to place int hooks
 22837                                  	;call	cs:MagicBackdoor
 22838                                  	;endif
 22839                                  
 22840                                  ; Now, process config.sys some more.  
 22841                                  ; Load the device drivers and install programs
 22842                                  
 22843                                  	; 22/10/2022
 22844                                  	;inc	byte [cs:multi_pass_id]	; multi_pass_id = 1
 22845                                  	; 11/12/2022
 22846                                  	; ds = cs
 22847 00000706 FE06[CD02]              	inc	byte [multi_pass_id]
 22848 0000070A E85019                  	call	multi_pass		; load device drivers
 22849 0000070D E86C2D                  	call	ShrinkUMB
 22850 00000710 E8902D                  	call	UnlinkUMB		; unlink all UMBs	;M002
 22851                                  	; 02/11/2022
 22852                                  	;inc	byte [cs:multi_pass_id]	; multi_pass_id = 2
 22853                                  	; 11/12/2022
 22854                                  	; ds = cs
 22855 00000713 FE06[CD02]              	inc	byte [multi_pass_id]
 22856 00000717 E84319                  	call	multi_pass		; was load ifs (now does nothing)
 22857                                  
 22858                                  	;ifdef	dblspace_hooks
 22859                                  	;call	MagicPostload		; make sure Magicdrv is final placed
 22860                                  	;endif
 22861                                  
 22862                                  	; ds = cs
 22863                                  	
 22864 0000071A E81706                  	call	endfile			; setup fcbs, files, buffers etc
 22865                                  
 22866                                  	;ifdef	dblspace_hooks
 22867                                  	;call	MagicSetCdss		; disable CDSs of reserved drives
 22868                                  	;endif
 22869                                  
 22870                                  ;Reset SysinitPresent flag here. This is needed for the special fix for lying
 22871                                  ;to device drivers. This has been moved up to this point to avoid problems 
 22872                                  ;with overlays called from installed programs
 22873                                  
 22874                                  	; 11/12/2022
 22875                                  	; ds = cs
 22876                                  
 22877                                  	;;mov	ax,Bios_Data ; 0070h
 22878                                  	;mov	ax,KERNEL_SEGMENT
 22879                                  	; 21/10/2022
 22880 0000071D B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 22881 00000720 8EC0                    	mov	es,ax			; point ES to bios data
 22882                                  
 22883 00000722 26C606[DD07]00          	mov	byte [es:SysinitPresent],0 ; clear SysinitPresent flag
 22884                                  
 22885                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 22886                                  	;test	word [cs:install_flag],have_install_cmd ; 1
 22887                                  	;test	byte [cs:install_flag],1
 22888                                  	; 11/12/2022
 22889                                  	; ds = cs
 22890 00000728 F606[CE02]01            	test	byte [install_flag],1
 22891                                  	;test	byte [cs:install_flag],have_install_cmd
 22892                                  					; are there install commands?
 22893 0000072D 7407                    	jz	short dolast		; no, no need for further processing
 22894                                  	;inc	byte [cs:multi_pass_id]	; mult_pass_id = 3
 22895                                  	; 11/12/2022
 22896                                  	; ds =cs
 22897 0000072F FE06[CD02]              	inc	byte [multi_pass_id]
 22898 00000733 E82719                  	call	multi_pass		; execute install= commands
 22899                                  
 22900                                  dolast:
 22901                                  	
 22902                                  ; [area] has the segment address for the allocated memory of sysinit, confbot.
 22903                                  ;  free the confbot area used for config.sys and sysinit itself.
 22904                                  
 22905                                  ; Now if DOS is supposed to run high, we actually move it into high memory 
 22906                                  ; (if HiMem manager is available). For ROMDOS, we don't actually move
 22907                                  ; anything, but just set up the ROM area for suballocation (or print
 22908                                  ; a message if HiMem is not available).
 22909                                  ;
 22910                                  ; There is also this little hack for CPM style DOS calls that needs to
 22911                                  ; be done when A20 is set...
 22912                                  
 22913                                  	; 11/12/2022
 22914                                  	; ds = cs
 22915                                  
 22916                                  	; 22/10/2022
 22917                                  	;cmp	byte [cs:runhigh],0FFh	; are we still waiting to be moved?
 22918                                  	; 11/12/2022
 22919 00000736 803E[6C02]FF            	cmp	byte [runhigh],0FFh
 22920 0000073B 7503                    	jne	short _@@_ ; 09/12/2022 ; no, our job is over
 22921 0000073D E83702                  	call	LoadDOSHiOrLo
 22922                                  _@@_:
 22923                                  	;cmp	byte [cs:runhigh],0	; are we running low
 22924                                  	; 11/12/2022
 22925                                  	; ds = cs
 22926 00000740 803E[6C02]00            	cmp	byte [runhigh],0
 22927                                  	;je	short _@@@
 22928 00000745 7403                    	je	short ConfigDone	; yes, no CPM hack needed
 22929 00000747 E82305                  	call	CPMHack			; make ffff:d0 same as 0:c0
 22930                                  ;_@@@:
 22931                                  
 22932                                  ; We are now done with CONFIG.SYS processing
 22933                                  
 22934                                  ConfigDone:
 22935                                  	; 12/12/2022
 22936                                  	; 22/10/2022
 22937                                  	;mov	byte [cs:donotshownum],1 
 22938                                  					; done with config.sys.
 22939                                  					; do not show line number message.
 22940                                  	;mov	es,[cs:area]
 22941                                  	; 12/12/2022
 22942                                  	; ds = cs
 22943                                  	; 27/03/2019
 22944 0000074A C606[5503]01            	mov	byte [donotshownum],1
 22945 0000074F 8E06[6803]              	mov	es,[area]
 22946                                  
 22947 00000753 B449                            mov     ah,49h ; DEALLOC	; free allocated memory for command.com
 22948 00000755 CD21                    	int	21h
 22949                                  			; DOS - 2+ - FREE MEMORY
 22950                                  			; ES = segment address of area to be freed
 22951                                  
 22952                                  	; 22/10/2022
 22953                                  	;test	word [cs:install_flag],2
 22954                                  	;test	word [cs:install_flag],has_installed ; sysinit_base installed?
 22955                                  	;test	byte [cs:install_flag],has_installed
 22956                                  	; 11/12/2022
 22957                                  	; ds = cs
 22958 00000757 F606[CE02]02            	test	byte [install_flag],2 ; has_installed
 22959                                  	;test	byte [install_flag],has_installed
 22960 0000075C 741F                    	jz	short skip_free_sysinitbase ; no.
 22961                                  
 22962                                  ; set block from the old_area with impossible_owner_size.
 22963                                  ; this will free the unnecessary sysinit_base that had been put in memory to
 22964                                  ; handle install= command.
 22965                                  
 22966                                  	; 12/12/2022
 22967                                          ;push	es		; BUGBUG 3-30-92 JeffPar: no reason to save ES
 22968                                  	;push	bx
 22969                                  	
 22970                                  	; 22/10/2022
 22971                                  	;mov	es,[cs:old_area]
 22972                                  	;mov	bx,[cs:impossible_owner_size]
 22973                                  	; 12/12/2022
 22974                                  	; ds = cs
 22975 0000075E 8E06[5E03]              	mov	es,[old_area]
 22976 00000762 8B1E[6003]              	mov	bx,[impossible_owner_size]
 22977                                  	
 22978 00000766 B44A                    	mov	ah,4Ah ; SETBLOCK
 22979 00000768 CD21                    	int	21h
 22980                                  			; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
 22981                                  			; ES = segment address of block to change
 22982                                  			; BX = new size in paragraphs
 22983 0000076A 8CC0                    	mov	ax,es
 22984 0000076C 48                      	dec	ax
 22985 0000076D 8EC0                    	mov	es,ax			; point to arena
 22986                                  	;mov	word [es:ARENA.OWNER],8	; set impossible owner
 22987 0000076F 26C70601000800          	mov	word [es:1],8
 22988                                  	;mov	word [es:ARENA.NAME],'SD' ; 4453h ; System Data
 22989 00000776 26C70608005344          	mov	word [es:8],'SD'
 22990                                  	
 22991                                  	; 12/12/2022
 22992                                  	;pop	bx
 22993                                          ;pop	es		; BUGBUG 3-30-92 JeffPar: no reason to save ES
 22994                                  
 22995                                  skip_free_sysinitbase:
 22996                                  	; 22/10/2022
 22997                                  	;cmp	byte [cs:runhigh],0
 22998                                  	; 12/12/2022
 22999                                  	; ds = cs
 23000 0000077D 803E[6C02]00            	cmp	byte [runhigh],0	
 23001 00000782 7403                    	je	short _@@@_ ; 04/07/2023
 23002                                  
 23003 00000784 E8CD03                  	call	InstVDiskHeader	; Install VDISK header (allocates some mem from DOS)
 23004                                  
 23005                                  ; ----------------------------------------------------------------------------
 23006                                  
 23007                                  _@@@_:
 23008                                  	; 12/12/2022
 23009                                  	; ds = cs
 23010                                  	; 22/10/2022
 23011                                  	; 27/03/2019
 23012                                  	;push	cs
 23013                                  	;pop	ds			; point DS to sysinitseg
 23014                                  
 23015                                  ; set up the parameters for command
 23016                                  
 23017                                  ;	; 22/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS SYSINIT)
 23018                                  ;;ifdef	MULTI_CONFIG
 23019                                  ;	mov	byte [config_cmd],0	; set special code for query_user
 23020                                  ;       call    query_user		; to issue the AUTOEXEC prompt
 23021                                  ;	jnc	short process_autoexec	; we should process autoexec normally
 23022                                  ;	; !!!
 23023                                  ;	or	byte [bQueryOpt],4 ; MSDOS 6.21 IO.SYS - SYSINIT:081Fh
 23024                                  ;       ; !!!
 23025                                  ;	call    disable_autoexec        ; no, we should disable it
 23026                                  ;process_autoexec:
 23027                                  ;;endif	; !!!
 23028                                  ;	call	CheckQueryOpt	; MSDOS 6.21 IO.SYS - SYSINIT:0827h	
 23029                                  ;	; !!!
 23030                                  
 23031                                  	; 22/10/2022 
 23032                                  	;mov     cl,[command_line]
 23033                                          ;mov     ch,0
 23034                                          ;inc     cx
 23035                                          ;mov     si,command_line	
 23036                                  	;add     si,cx
 23037                                          ;mov     byte [si],cr	; cr-terminate command line
 23038                                  
 23039                                  	; 22/10/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS)
 23040                                  	; (SYSINIT:0809h)
 23041                                  
 23042                                  	;;;;
 23043                                  
 23044                                  	; 30/12/2022 - Retro DOS 4.2 (Modified MSDOS 6.21 IO.SYS)
 23045                                  	; (SYSINIT:0813h)
 23046                                  	; ds = cs
 23047                                  	; push	cs
 23048                                  	; pop	ds
 23049                                  
 23050 00000787 C606[E814]00            	mov	byte [config_cmd],0	; set special code for query_user
 23051 0000078C E83A39                  	call    query_user		; to issue the AUTOEXEC prompt
 23052 0000078F 7308                    	jnc	short process_autoexec	; we should process autoexec normally
 23053                                  	; !!!
 23054 00000791 800E[3247]04            	or	byte [bQueryOpt],4 ; MSDOS 6.21 IO.SYS - SYSINIT:081Fh
 23055                                  	; !!!
 23056 00000796 E82B3A                  	call    disable_autoexec        ; no, we should disable it
 23057                                  process_autoexec:
 23058                                  	; !!!
 23059 00000799 E8733A                  	call	CheckQueryOpt	; MSDOS 6.21 IO.SYS - SYSINIT:0827h	
 23060                                  
 23061                                  	;mov     cl,[command_line]
 23062                                  	; 30/12/2022
 23063 0000079C BE[6846]                	mov	si,command_line
 23064 0000079F 8A0C                    	mov	cl,[si]
 23065 000007A1 B500                    	mov     ch,0
 23066 000007A3 41                      	inc     cx
 23067                                  	;mov	si,command_line
 23068 000007A4 01CE                    	add     si,cx
 23069 000007A6 C6040D                  	mov     byte [si],cr	; cr-terminate command line
 23070                                  	
 23071                                  	;;;;		
 23072                                  
 23073                                  ; 30/12/2022 - Retro DOS v4.2
 23074                                  %if 0
 23075                                  	;mov	si,(offset command_line+1)
 23076                                  	mov	si,command_line+1
 23077                                  	push    ds
 23078                                  	pop     es
 23079                                  	mov     di,si
 23080                                  	mov     cl,0FFh ; -1
 23081                                  _@_loop:
 23082                                  	inc     cl ; +1
 23083                                  	lodsb
 23084                                  	stosb
 23085                                  	or      al,al
 23086                                  	jnz     short _@_loop
 23087                                  	dec     di
 23088                                  	mov     al,0Dh
 23089                                  	stosb			; cr-terminate command line
 23090                                  	mov     [command_line],cl ; command line length (except CR)
 23091                                  
 23092                                  %endif
 23093                                  
 23094                                  ; ----------------------------------------------------------------------------
 23095                                  
 23096                                  ;   Once we get to this point, the above code, which is below "retry"
 23097                                  ;   in memory, can be trashed (and in fact is -- see references to retry
 23098                                  ;   which follow....)
 23099                                  
 23100                                  retry:
 23101 000007A9 BA[DA45]                	mov	dx,commnd	; now pointing to file description
 23102                                  
 23103                                  ; we are going to open the command interpreter and size it as is done in
 23104                                  ; ldfil. the reason we must do this is that sysinit is in free memory. if
 23105                                  ; there is not enough room for the command interpreter,exec will probably
 23106                                  ; overlay our stack and code so when it returns with an error sysinit won't be
 23107                                  ; here to catch it. this code is not perfect (for instance .exe command
 23108                                  ; interpreters are possible) because it does its sizing based on the
 23109                                  ; assumption that the file being loaded is a .com file. it is close enough to
 23110                                  ; correctness to be usable.
 23111                                  
 23112                                  ; first, find out where the command interpreter is going to go.
 23113                                  
 23114 000007AC 52                      	push	dx		; save pointer to name
 23115 000007AD BBFFFF                  	mov	bx,0FFFFh
 23116 000007B0 B448                    	mov	ah,48h	; ALLOC
 23117 000007B2 CD21                            int     21h             ; get biggest piece
 23118 000007B4 B448                    	mov	ah,48h	; ALLOC
 23119 000007B6 CD21                    	int	21h		; second time gets it
 23120 000007B8 726B                    	jc	short memerrjx	; oooops
 23121                                  
 23122 000007BA 8EC0                    	mov	es,ax
 23123 000007BC B449                    	mov	ah,49h	; DEALLOC
 23124 000007BE CD21                    	int	21h		; give it right back
 23125 000007C0 89DD                    	mov	bp,bx
 23126                                  
 23127                                  ; es:0 points to block,and bp is the size of the block in para.
 23128                                  
 23129                                  ; we will now adjust the size in bp down by the size of sysinit.
 23130                                  ; we need to do this because exec might get upset if some of the exec
 23131                                  ; data in sysinit is overlayed during the exec.
 23132                                  
 23133                                  	; 22/10/2022
 23134                                  	; (MSDOS 5.0 IO.SYS SYSINIT:083Bh)
 23135 000007C2 8B1E[9402]                      mov     bx,[MEMORY_SIZE] ; get location of end of memory
 23136 000007C6 8CC8                    	mov	ax,cs		 ; get location of beginning of sysinit
 23137                                  
 23138                                  ; Note that the "config_wrkseg" environment data is a segment in
 23139                                  ; unallocated memory (as of the Dealloc of [area], above). This is ideal
 23140                                  ; in one sense, because Exec is going to make a copy of it for COMMAND.COM
 23141                                  ; anyway, and no one has responsibility for freeing "config_wrkseg". But
 23142                                  ; we need to make sure that there's no way Exec will stomp on that data
 23143                                  ; before it can copy it, and one way to do that is to make the available
 23144                                  ; memory calculation even more "paranoid", by subtracting "config_wrkseg"
 23145                                  ; from the "memory_size" segment value (which is typically A000h) instead
 23146                                  ; of the current sysinit CS....
 23147                                  ;
 23148                                  ; The reason I use the term "paranoid" is because this code should have
 23149                                  ; slid the data required by Exec up to the very top of memory, because as
 23150                                  ; it stands, you have to have sizeof(COMMAND.COM) PLUS 64K to load just
 23151                                  ; COMMAND.COM (64k is about what sysinit, and all the goop above sysinit,
 23152                                  ; consumes). Now it's just a little worse (65K or more, depending on
 23153                                  ; the size of your CONFIG.SYS, since the size of the environment workspace
 23154                                  ; is determined by the size of CONFIG.SYS.... -JTP
 23155                                  
 23156                                  	; 30/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21, IO.SYS)
 23157                                  	; (SYSINIT:0858h)
 23158 000007C8 8B0E[E414]              	mov	cx,[config_envlen]
 23159 000007CC E303                            jcxz	no_env		; use config_wrkseg only if there's env data
 23160 000007CE A1[E614]                        mov	ax,[config_wrkseg]	
 23161                                  
 23162                                  	; 22/10/2022
 23163                                  	;mov	cx,[config_envlen]
 23164                                          ;jcxz	no_env		; use config_wrkseg only if there's env data
 23165                                          ;mov	ax,[config_wrkseg]
 23166                                  ;no_env:
 23167                                  	; 22/10/2022
 23168                                  	; (MSDOS 5.0 IO.SYS SYSINIT:0841h)
 23169                                  no_env:
 23170                                  	; 30/12/2022
 23171                                  	; (MSDOS 6.21 IO.SYS SYSINIT:0861h)
 23172 000007D1 29C3                      	sub     bx,ax           ; bx is size of sysinit in para
 23173 000007D3 83C311                  	add	bx,11h		; add the sysinit php
 23174 000007D6 29DD                    	sub	bp,bx		; sub sysinit size from amount of free memory
 23175 000007D8 724B                    	jc	short memerrjx	; if there isn't even this much memory, give up
 23176                                  
 23177                                          ;mov	ax,(OPEN<<8)	; open the file being execed
 23178 000007DA B8003D                          mov	ax,3D00h
 23179 000007DD F9                      	stc                     ; in case of int 24
 23180 000007DE CD21                    	int	21h
 23181 000007E0 7270                    	jc	short comerr	; ooops
 23182                                  			; DOS - 2+ - OPEN DISK FILE WITH HANDLE
 23183                                  			; DS:DX -> ASCIZ filename
 23184                                  			; AL = access mode
 23185                                  			; 0 - read
 23186                                  	; 22/10/2022
 23187                                  	; (MSDOS 5.0 IO.SYS SYSINIT:0852h)
 23188 000007E2 89C3                            mov     bx,ax           ; handle in bx
 23189                                  
 23190                                  ;   If the standard command interpreter is being used, verify it is correct
 23191                                  
 23192                                  	; 30/12/2022 - Retro DOS v4.2
 23193                                  	; (MSDOS 6.21 IO.SYS, SYSINIT:0874h)
 23194 000007E4 803E[D745]00            	cmp	byte [newcmd],0	; was a new shell selected?
 23195 000007E9 7518                    	jne	short skip_validation ; yes
 23196 000007EB BA[A507]                	mov	dx,retry-4
 23197 000007EE B90400                  	mov	cx,4		;
 23198 000007F1 B43F                    	mov	ah,READ		;
 23199 000007F3 CD21                    	int	21h		;
 23200 000007F5 803E[A507]E9            	cmp	byte [retry-4],0E9h
 23201 000007FA 7556                    	jne	short comerr
 23202                                  	; 20/04/2019 - Retro DOS v4.0
 23203                                  	; 30/12/2022 
 23204                                  	;cmp	byte [retry-1],64h ; MSDOS 6.21 IO.SYS - SYSINIT:088Ch
 23205                                  				; .. COMMAND.COM Version 6.20 (14h&0Fh)	
 23206 000007FC 803E[A807]66            	cmp	byte [retry-1],((MAJOR_VERSION&0Fh)<<4)|(MINOR_VERSION&0Fh)
 23207 00000801 754F                    	jne	short comerr	;
 23208                                  
 23209                                  	; 22/10/2022
 23210                                  	;cmp	byte [newcmd],0	; was a new shell selected?
 23211                                  	;jne	short skip_validation ; yes
 23212                                  	;mov	dx,retry-4
 23213                                  	;mov	cx,4		;
 23214                                  	;mov	ah,READ		;
 23215                                  	;int	21h		;
 23216                                  	;cmp	byte [retry-4],0E9h
 23217                                  	;jne	short comerr
 23218                                  	;; 20/04/2019 - Retro DOS v4.0
 23219                                  	;cmp	byte [retry-1],64h ; MSDOS 6.21 IO.SYS - SYSINIT:088Ch
 23220                                  	;;cmp	byte [retry-1],((MAJOR_VERSION&0Fh)<<4)|(MINOR_VERSION&0Fh)
 23221                                  	;jne	short comerr	;
 23222                                  
 23223                                  ;skip_validation:
 23224                                  	; 22/10/2022
 23225                                  	; (MSDOS 5.0 IO.SYS SYSINIT:0854h)
 23226                                  skip_validation:
 23227                                  	; 30/12/2022
 23228                                  	; (MSDOS 6.21 IO.SYS SYSINIT:0893h)
 23229 00000803 31C9                    	xor	cx,cx
 23230 00000805 31D2                    	xor	dx,dx
 23231                                  	;mov	ax,(LSEEK<<8)|2
 23232 00000807 B80242                  	mov	ax,4202h
 23233 0000080A F9                      	stc			;in case of int 24
 23234 0000080B CD21                    	int	21h		; get file size in dx:ax
 23235 0000080D 7243                    	jc	short comerr
 23236                                  				; convert size in dx:ax to para in ax
 23237 0000080F 83C00F                  	add	ax,15		; round up size for conversion to para
 23238 00000812 83D200                  	adc	dx,0
 23239 00000815 E86B04                  	call	off_to_para
 23240 00000818 B10C                    	mov	cl,12
 23241 0000081A D3E2                    	shl	dx,cl		; low nibble of dx to high nibble
 23242 0000081C 09D0                    	or	ax,dx		; ax is now # of para for file
 23243 0000081E 83C010                  	add	ax,10h		; 100h byte php
 23244 00000821 39E8                    	cmp	ax,bp		; will command fit in available mem?
 23245 00000823 7208                    	jb	short okld	; jump if yes.
 23246                                  
 23247                                  ; 30/12/2022
 23248                                  %if 0
 23249                                  	; 22/10/2022
 23250                                  memerrjx:	; (MSDOS 5.0 IO.SYS SYSINIT:0876h)
 23251                                  	;jmp	memerr	; (MSDOS 5.0 IO.SYS SYSINIT:34D5h)
 23252                                  	; 02/11/2022
 23253                                  	;jmp	mem_err
 23254                                  	; 11/12/2022
 23255                                  	; ds = cs
 23256                                  	jmp	mem_err2
 23257                                  %endif
 23258                                  	; 30/12/2022
 23259                                  	; (MSDOS 6.21, IO.SYS, SYSINIT:08B5h)
 23260                                  memerrjx:
 23261 00000825 BA[254B]                	mov	dx,badmem 	; "Configuration too large for memory"
 23262 00000828 E8D63C                  	call	print
 23263 0000082B EB3D                    	jmp     short continue
 23264                                  
 23265                                  okld:
 23266 0000082D B43E                    	mov	ah,3Eh ; CLOSE
 23267 0000082F CD21                    	int	21h		; close file
 23268                                  
 23269                                  	; 22/10/2022
 23270 00000831 5A                      	pop	dx	; (MSDOS 5.0 IO.SYS SYSINIT:087Dh)
 23271                                  
 23272                                  	; 24/03/2019
 23273                                  
 23274 00000832 0E                      	push	cs		; point es to sysinitseg
 23275 00000833 07                      	pop	es
 23276 00000834 BB[BF02]                        mov     bx,COMEXE	; point to exec block
 23277                                  	; 22/10/2022
 23278                                  	;pop	dx              ; recover pointer to name
 23279                                  
 23280                                  ;;ifdef	MULTI_CONFIG
 23281                                  
 23282                                  ;   If there's any environment data in "config_wrkseg", pass it to shell;
 23283                                  ;   there will be data if there were any valid SET commands and/or if a menu
 23284                                  ;   selection was made (in which case the CONFIG environment variable will be
 23285                                  ;   set to that selection).
 23286                                  
 23287                                  	; 23/10/2022
 23288                                  	;mov	cx,[config_envlen]
 23289                                  	;jcxz	no_envdata
 23290                                          ;mov	cx,[config_wrkseg]
 23291                                  ;no_envdata:
 23292                                  	;;mov	[bx+EXEC0.ENVIRON],cx
 23293                                  	;mov	[bx],cx
 23294                                  
 23295                                  ;;endif	;MULTI_CONFIG
 23296                                  
 23297                                  	; 30/12/2022 - Retro DOS v4.2
 23298                                  	; (MSDOS 6.21 IO.SYS SYSINIT:08C7h)
 23299 00000837 8B0E[E414]              	mov	cx,[config_envlen]
 23300 0000083B E304                    	jcxz	no_envdata
 23301 0000083D 8B0E[E614]                      mov	cx,[config_wrkseg]
 23302                                  no_envdata:
 23303                                  	;mov	[bx+EXEC0.ENVIRON],cx
 23304 00000841 890F                    	mov	[bx],cx	
 23305                                  	
 23306                                  	; 23/10/2022
 23307                                  	; (MSDOS 5.0 IO.SYS SYSINIT:0883h)
 23308                                  
 23309                                  	;mov	[bx+EXEC0.COM_LINE+2],cs ; set segments
 23310 00000843 8C4F04                  	mov	[bx+4],cs
 23311                                  	;mov	[bx+EXEC0.5C_FCB+2],cs
 23312 00000846 8C4F08                  	mov	[bx+8],cs
 23313                                  	;mov	[bx+EXEC0.6C_FCB+2],cs
 23314 00000849 8C4F0C                  	mov	[bx+12],cs
 23315                                  
 23316                                  	;mov	ax,(EXEC<<8) + 0
 23317                                  	; 23/10/2022
 23318                                  	;xor	ax,ax
 23319                                  	;mov	ah,4Bh
 23320                                  	; 04/07/2023
 23321                                  	;mov	ax,4B00h
 23322 0000084C B8004B                  	mov	ax,(EXEC<<8)
 23323                                  
 23324 0000084F F9                      	stc                     ; in case of int 24
 23325 00000850 CD21                            int     21h             ; go start up command
 23326                                  			; DOS - 2+ - LOAD OR EXECUTE (EXEC)
 23327                                  			; DS:DX -> ASCIZ filename
 23328                                  			; ES:BX -> parameter block
 23329                                  			; AL = subfunc: load & execute program
 23330                                  	;push	cs
 23331                                  	;pop	ds
 23332                                  
 23333                                  	; 23/10/2022
 23334                                  	;push	dx		; push to balance fall-through pop
 23335                                  
 23336                                  ; note fall through if exec returns (an error)
 23337                                  comerr:
 23338                                  	; 23/10/2022
 23339                                  ;;ifdef	MULTI_CONFIG
 23340                                  	;cmp	byte [commnd4],0
 23341                                  	;je	short comerr2	; all defaults exhausted, print err msg
 23342                                  	;cmp	byte [newcmd],0
 23343                                  	;je	short continue	; don't print err msg for defaults just yet
 23344                                  ;comerr2:
 23345                                  ;;endif
 23346                                  
 23347                                  	; 30/12/2022 - Retro DOS v4.2
 23348 00000852 0E                      	push	cs
 23349 00000853 1F                      	pop	ds
 23350 00000854 803E[4B46]00            	cmp	byte [commnd4],0
 23351 00000859 7407                    	je	short comerr2	; all defaults exhausted, print err msg
 23352 0000085B 803E[D745]00            	cmp	byte [newcmd],0
 23353 00000860 7408                    	je	short continue	; don't print err msg for defaults just yet
 23354                                  comerr2:
 23355 00000862 52                      	push	dx ; 30/12/2022
 23356                                  
 23357                                  	; 23/10/2022
 23358 00000863 BA[A14A]                        mov     dx,badcom	; want to print command error
 23359 00000866 E86C3C                  	call	badfil
 23360                                  	
 23361 00000869 5A                      	pop	dx  ; 30/12/2022
 23362                                  continue:
 23363                                  	; 23/10/2022
 23364                                  	;pop	dx
 23365                                  
 23366                                  ; 30/12/2022
 23367                                  %if 0
 23368                                  
 23369                                  ;;ifndef MULTI_CONFIG
 23370                                  	;jmp	stall
 23371                                  	; 24/10/2022
 23372                                  stall:		; (MSDOS 5.0 IO.SYS, SYSINIT:0899h)
 23373                                  	jmp	short stall
 23374                                  ;;else
 23375                                  
 23376                                  %endif
 23377                                  	
 23378                                  ; 30/12/2022 (MSDOS 6.21 SYSINIT, Retro DOS v4.2)
 23379                                  ;%if 1
 23380                                  ; 23/10/2022 (MSDOS 5.0 SYSINIT, Retrodos v4.0)
 23381                                  ;%if 0	
 23382 0000086A B419                    	mov	ah,GET_DEFAULT_DRIVE ; 19h
 23383 0000086C CD21                    	int	21h             ;
 23384 0000086E 0441                    	add	al,'A'          ;
 23385 00000870 88C2                    	mov	dl,al           ; DL == default drive letter
 23386 00000872 BE[1A46]                	mov	si,commnd2
 23387 00000875 803E[D745]00            	cmp	byte [newcmd],0 ; if a SHELL= was given
 23388 0000087A 7505                    	jne	short do_def2	; then try the 2nd alternate;
 23389 0000087C C60400                  	mov	byte [si],0	; otherwise, the default SHELL= was tried,
 23390 0000087F EB05                    	jmp	short do_def3   ; which is the same as our 2nd alt, so skip it
 23391                                  do_def2:			
 23392 00000881 803C00                  	cmp	byte [si],0	; has 2nd alternate been tried?
 23393 00000884 7554                            jne	short do_alt    ; no
 23394                                  do_def3:
 23395 00000886 BE[2B46]                	mov	si,commnd3
 23396 00000889 803C00                  	cmp	byte [si],0	; has 3rd alternate been tried?
 23397 0000088C 754C                    	jne	short do_alt	; no
 23398 0000088E BE[4B46]                	mov	si,commnd4
 23399 00000891 803C00                  	cmp	byte [si],0	; has 4th alternate been tried?
 23400 00000894 7544                    	jne	short do_alt	; no
 23401 00000896 52                      	push	dx              ;
 23402 00000897 BA[FA4C]                	mov	dx,badcomprmpt
 23403 0000089A E8643C                  	call	print		;
 23404 0000089D 5A                      	pop	dx              ; recover default drive letter in DL
 23405                                  request_input:			;
 23406 0000089E B402                    	mov	ah,STD_CON_OUTPUT
 23407 000008A0 CD21                    	int	21h             ;
 23408 000008A2 52                      	push	dx              ;
 23409 000008A3 B23E                    	mov	dl,'>'          ;
 23410 000008A5 CD21                    	int	21h             ;
 23411 000008A7 8A1E[D945]              	mov	bl,[tmplate+1]	;
 23412 000008AB B700                    	mov	bh,0            ;
 23413 000008AD C687[DA45]0D            	mov	byte [commnd+bx],0Dh
 23414 000008B2 BA[D845]                	mov	dx,tmplate
 23415 000008B5 B40A                    	mov	ah,STD_CON_STRING_INPUT
 23416 000008B7 CD21                    	int	21h             ; read a line of input
 23417 000008B9 BA[4C4A]                	mov	dx,crlfm	;
 23418 000008BC E8423C                  	call	print           ;
 23419 000008BF 5A                      	pop	dx              ;
 23420 000008C0 8A1E[D945]              	mov	bl,[tmplate+1]	;
 23421 000008C4 08DB                    	or	bl,bl           ; was anything typed?
 23422 000008C6 74D6                    	jz	short request_input ;
 23423 000008C8 C606[D745]01            	mov	byte [newcmd],1 ; disable validation for user-specified binaries
 23424 000008CD C687[DA45]00            	mov	byte [commnd+bx],0 ; NULL-terminate it before execing it
 23425 000008D2 C706[6846]000D          	mov	word [command_line],0D00h
 23426 000008D8 EB35                    	jmp	short do_exec   ;
 23427                                  do_alt:
 23428 000008DA 1E                      	push	ds
 23429 000008DB 07                      	pop	es
 23430 000008DC C606[D745]00            	mov	byte [newcmd],0 ; force validation for alternate binaries
 23431 000008E1 BF[DA45]                	mov	di,commnd	;
 23432                                  do_alt1:
 23433 000008E4 AC                      	lodsb			; copy the alternate, zapping it as we go,
 23434 000008E5 C644FF00                	mov	byte [si-1],0	; so that we know it's been tried
 23435 000008E9 AA                      	stosb 			;
 23436 000008EA 08C0                    	or	al,al		;
 23437 000008EC 75F6                    	jnz	short do_alt1	;
 23438 000008EE BF[6846]                	mov	di,command_line
 23439 000008F1 807C023A                	cmp	byte [si+2],':'
 23440 000008F5 7503                    	jne	short do_alt2	;
 23441 000008F7 885401                  	mov	[si+1],dl	; stuff default drive into alt. command line
 23442                                  do_alt2:			;
 23443 000008FA AC                      	lodsb			;
 23444 000008FB AA                      	stosb			;
 23445 000008FC 08C0                    	or	al,al           ;
 23446 000008FE 75FA                    	jnz	short do_alt2   ;
 23447 00000900 C645FF0D                	mov	byte [di-1],cr  ; ODh
 23448                                  
 23449                                  ;;   Last but not least, see if we need to call disable_autoexec
 23450                                  
 23451                                  	; MSDOS 6.0 (SYSINIT1.ASM)
 23452                                  	;cmp	[command_line-1],0
 23453                                          ;jne	short do_exec   ;
 23454                                          ;mov	[command_line-1],'/'
 23455                                  	;call	disable_autoexec ;
 23456                                  
 23457                                  	; MSDOS 6.21 IO.SYS (SYSINIT:0994h)
 23458 00000904 C606[2847]00            	mov	byte [dae_flag],0 ; 24/03/2019 - Retro DOS v4.0 	
 23459 00000909 E8B838                  	call	disable_autoexec
 23460 0000090C E80039                  	call	CheckQueryOpt	; 24/03/2019 - Retro DOS v4.0
 23461                                  do_exec:
 23462 0000090F E997FE                  	jmp	retry		;
 23463                                  
 23464                                  ;;endif	;MULTI_CONFIG
 23465                                  
 23466                                  ;%endif ; 23/10/2022 (MSDOS 5.0 SYSINIT)
 23467                                  ;%endif ; 30/12/2022 (MSDOS 6.21 SYSINIT)
 23468                                  
 23469                                  ; 24/03/2019 - Retro DOS v4.0
 23470                                  
 23471                                  ; ----------------------------------------------------------------------
 23472                                  ; procedure : AllocFreeMem
 23473                                  ;
 23474                                  ; Allocate Max memory from DOS to find out where to load DOS.
 23475                                  ; DOS is at temporary location when this call is being made
 23476                                  ;
 23477                                  ; Inputs : None
 23478                                  ; Outputs: The biggest chunk of memory is allocated (all mem at init time)
 23479                                  ;	   [area] & [memhi] set to the para value of the start of the
 23480                                  ;	   free memory.
 23481                                  ;
 23482                                  ; Uses   : AX, BX
 23483                                  ;
 23484                                  ; ----------------------------------------------------------------------
 23485                                  	
 23486                                  	; 30/12/2022 - Retro DOS v4.2
 23487                                  	; (MSDOS 6.21 IO.SYS, SYSINIT:09A2h)
 23488                                  
 23489                                  	; 23/10/2022
 23490                                  AllocFreeMem:
 23491 00000912 BBFFFF                  	mov	bx,0FFFFh
 23492 00000915 B448                    	mov	ah,48h ; ALLOC
 23493 00000917 CD21                    	int	21h			; first time fails
 23494 00000919 B448                    	mov	ah,48h ; ALLOC
 23495 0000091B CD21                    	int	21h			; second time gets it
 23496                                  	; 11/12/2022
 23497                                  	; ds = cs
 23498                                  	;mov	[cs:area],ax
 23499                                  	;mov	[cs:memhi],ax		; memhi:memlo now points to
 23500 0000091D A3[6803]                	mov	[area],ax
 23501 00000920 A3[6403]                	mov	[memhi],ax		; memhi:memlo now points to			
 23502 00000923 C3                      	retn				; start of free memory
 23503                                  				
 23504                                  	; include msbio.cl6
 23505                                  ; ----------------------------------------------------------------------
 23506                                  DOSLOMSG:
 23507 00000924 484D41206E6F742061-     	db	'HMA not available: Loading DOS low',0Dh,0Ah,'$'
 23507 0000092D 7661696C61626C653A-
 23507 00000936 204C6F6164696E6720-
 23507 0000093F 444F53206C6F770D0A-
 23507 00000948 24                 
 23508                                  FEmsg:
 23509 00000949 466174616C20457272-     	db	'Fatal Error: Cannot allocate Memory for DOS',0Dh,0Ah,'$'
 23509 00000952 6F723A2043616E6E6F-
 23509 0000095B 7420616C6C6F636174-
 23509 00000964 65204D656D6F727920-
 23509 0000096D 666F7220444F530D0A-
 23509 00000976 24                 
 23510                                  
 23511                                  ; ----------------------------------------------------------------------
 23512                                  ;
 23513                                  ; procedure : LoadDOSHiOrLo
 23514                                  ;
 23515                                  ;		Tries to move DOS into HMA. If it fails then loads
 23516                                  ;		DOS into Low memory. For ROMDOS, nothing is actually
 23517                                  ;		moved; this just tries to allocate the HMA, and prints
 23518                                  ;		a message if this is not possible.
 23519                                  ;
 23520                                  ; ----------------------------------------------------------------------
 23521                                  
 23522                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 23523                                  LoadDOSHiOrLo:
 23524                                  	; 27/03/2019 - Retro DOS v4.0
 23525                                  	; ds = cs
 23526 00000977 E81F00                  	call	TryToMovDOSHi		; Try moving it into HMA (M024)
 23527                                  	;jc	short LdngLo		; If that don't work...
 23528                                  	;retn
 23529                                  	; 18/12/2022
 23530 0000097A 731C                    	jnc	short LoadDosHi_ok
 23531                                  LdngLo:
 23532                                  	; 23/10/2022
 23533                                  	;push	cs
 23534                                  	;pop	ds
 23535                                  	; 11/12/2022
 23536                                  	; ds = cs
 23537 0000097C B409                    	mov	ah,9
 23538 0000097E BA[2409]                	mov	dx,DOSLOMSG		; inform user that we are
 23539 00000981 CD21                    	int	21h			; loading low
 23540                                  
 23541                                  ;ifndef ROMDOS
 23542                                  	; actually move the dos, and reinitialize it.
 23543                                  
 23544 00000983 BB0100                  	mov	bx,1				; M012
 23545                                  						;  use int 21 alloc for mem
 23546 00000986 E83F00                  	call	MovDOSLo
 23547                                  	; 11/12/2022
 23548                                  	; ds = cs
 23549                                  	;mov	es,[cs:CURRENT_DOS_LOCATION]	; give dos its temporary loc.
 23550                                  	; 23/10/2022
 23551 00000989 8E06[7302]              	mov	es,[CURRENT_DOS_LOCATION]
 23552                                  	;;mov	es,[cs:FINAL_DOS_LOCATION]  ; 24/03/2019 - Retro DOS v4.0
 23553                                  	;mov	es,[FINAL_DOS_LOCATION] ; 27/03/2019
 23554 0000098D 31C0                    	xor	ax,ax				; ax = 00 ---> install stub
 23555                                  	; 11/12/2022
 23556                                  	; ds = cs
 23557                                  	;call	far [cs:dos_segreinit]		; call dos segreinit
 23558 0000098F FF1E[7D02]              	call	far [dos_segreinit] ; 27/03/2019
 23559                                  	
 23560                                  ;endif ; ROMDOS
 23561                                  	; 23/10/2022
 23562                                  	;mov	byte [cs:runhigh],0		; mark that we are running lo
 23563                                  	; 11/12/2022
 23564                                  	; ds = cs
 23565 00000993 C606[6C02]00            	mov	byte [runhigh],0 ; 27/03/2019
 23566                                  LoadDosHi_ok:	; 18/12/2022
 23567 00000998 C3                      	retn
 23568                                  
 23569                                  ; ----------------------------------------------------------------------
 23570                                  ;
 23571                                  ; procedure : TryToMovDOSHi
 23572                                  ;
 23573                                  ;		This tries to move DOS into HMA.
 23574                                  ;		Returns CY if it failed.
 23575                                  ;		If it succeeds returns with carry cleared.
 23576                                  ;
 23577                                  ;		For ROMDOS, dos_segreinit must be called again to allow
 23578                                  ;		the A20 switching code in the low mem stub to be installed.
 23579                                  ; 
 23580                                  ; ----------------------------------------------------------------------
 23581                                  
 23582                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 23583                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:092Ah)
 23584                                  TryToMovDOSHi:
 23585                                  	; 11/12/2022
 23586                                  	; 27/03/2019 - Retro DOS v4.0
 23587                                  	; ds = cs
 23588 00000999 E81300                  	call	MovDOSHi
 23589 0000099C 7210                    	jc	short ttldhx
 23590                                  
 23591                                  ;ifndef ROMDOS
 23592                                  	; 23/10/2022
 23593                                  	;mov	es,[cs:CURRENT_DOS_LOCATION] ; give dos its temporary loc.
 23594                                  	;;mov	es,[cs:FINAL_DOS_LOCATION] ; 24/03/2019 - Retro DOS v4.0
 23595                                  	; 11/12/2022
 23596                                  	; ds = cs
 23597 0000099E 8E06[7302]              	mov	es,[CURRENT_DOS_LOCATION]
 23598                                  ;else
 23599                                  ;	..
 23600                                  ;endif ; ROMDOS
 23601                                  
 23602                                  	; 11/12/2022
 23603                                  	; ds = cs
 23604 000009A2 31C0                    	xor	ax,ax			; ax = 00 ---> install stub
 23605                                  	;call	far [cs:dos_segreinit]	; call dos segreinit
 23606 000009A4 FF1E[7D02]              	call	far [dos_segreinit]
 23607                                  	;mov	byte [cs:runhigh],1
 23608 000009A8 C606[6C02]01            	mov	byte [runhigh],1
 23609 000009AD F8                      	clc
 23610                                  ttldhx:
 23611 000009AE C3                      	retn
 23612                                  
 23613                                  ; ----------------------------------------------------------------------
 23614                                  ;
 23615                                  ; procedure : MovDOSHi
 23616                                  ;
 23617                                  ;		Tries to allocate HMA and Move DOS/BIOS code into HMA
 23618                                  ;		For ROMDOS, the code is not actually moved, but the
 23619                                  ;		HMA is allocated and prepared for sub-allocation.
 23620                                  ;
 23621                                  ;		Returns : CY if it failed
 23622                                  ;
 23623                                  ; ----------------------------------------------------------------------
 23624                                  
 23625                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 23626                                  MovDOSHi:
 23627                                  	; 14/05/2019
 23628                                  	; 27/03/2019 - Retro DOS v4.0
 23629                                  	; ds = cs
 23630 000009AF E8D600                  	call	AllocHMA			; did we get HMA?
 23631 000009B2 7213                    	jc	short mdhx			; no
 23632 000009B4 B8FFFF                  	mov	ax,0FFFFh			; yes, HMA seg = 0ffffh
 23633 000009B7 8EC0                    	mov	es,ax
 23634                                  
 23635                                  ;ifndef ROMDOS
 23636                                  	; actually move the BIOS and DOS
 23637                                  
 23638                                  	; NOTE: Retro DOS v4.0 does not move BIOS (IO.SYS) to HMA
 23639                                  	; 24/03/2019
 23640                                  	
 23641                                  	; 23/10/2022
 23642 000009B9 E83200                  	call	MovBIOS				; First move BIOS into HMA
 23643                                  
 23644                                  	; ES:DI points to free HMA after BIOS
 23645                                  	
 23646                                  	; 14/05/2019
 23647                                  	; 24/03/2019 - Retro DOS v4.0
 23648                                  	;xor	di,di
 23649                                  	
 23650                                  	; 23/10/2022
 23651                                  	;mov	cx,[cs:hi_doscod_size]		; pass the code size of DOS
 23652                                  	; 11/12/2022
 23653                                  	; ds = cs
 23654 000009BC 8B0E[8302]              	mov	cx,[hi_doscod_size]		; when it is in HMA
 23655 000009C0 E81100                  	call	MovDOS				; and move it
 23656                                  
 23657                                  	; ES:DI points to free HMA after DOS
 23658                                  ;else
 23659                                  ;	; allocate space at beginning of HMA to allow for CPMHack
 23660                                  ;
 23661                                  ;	mov	di,0E0h				; room for 5 bytes at ffff:d0
 23662                                  ;
 23663                                  ;endif ; ROMDOS
 23664                                  
 23665 000009C3 E85E02                  	call	SaveFreeHMAPtr			; Save the Free HMA ptr
 23666 000009C6 F8                      	clc
 23667                                  mdhx:
 23668 000009C7 C3                      	retn
 23669                                  
 23670                                  ; ----------------------------------------------------------------------
 23671                                  ;
 23672                                  ; procedure : MovDOSLo
 23673                                  ;
 23674                                  ;		Allocates memory from DOS and moves BIOS/DOS code into it
 23675                                  ;
 23676                                  ; ----------------------------------------------------------------------
 23677                                  
 23678                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 23679                                  
 23680                                  ;ifndef ROMDOS
 23681                                  
 23682                                  MovDOSLo:
 23683                                  	; 14/05/2019
 23684                                  	; 27/03/2019 - Retro DOS v4.0
 23685                                  	; ds = cs
 23686 000009C8 E84500                  	call	AllocMemForDOS			; incestuosly!!!
 23687                                  	
 23688                                  	; 23/10/2022
 23689                                  	; 14/05/2019
 23690                                  	;inc	ax  ; skip MCB
 23691                                  	
 23692 000009CB 8EC0                    	mov	es,ax				; pass the segment to MovBIOS
 23693                                  	; NOTE: Retro DOS v4.0 does not move BIOS (IO.SYS) to HMA
 23694                                  	; 24/03/2019
 23695                                  	
 23696                                  	; 23/10/2022
 23697 000009CD E81E00                  	call	MovBIOS
 23698                                  
 23699                                  ;------ ES:DI points memory immediately after BIOS
 23700                                  
 23701                                  	; 14/05/2019
 23702                                  	; NOTE: 
 23703                                  	;     Order of (RETRO) DOS kernel sections at memory:
 23704                                  	;	BIOSDATA+BIOSCODE+BIOSDATAINIT+DOSDATA+DOSCODE(LOW)
 23705                                  
 23706                                  	; 24/03/2019 - Retro DOS v4.0
 23707                                  	;xor	di,di	
 23708                                  
 23709                                  	; 23/10/2022
 23710                                  	;mov	cx,[cs:lo_doscod_size]		; DOS code size when loaded
 23711                                  	; 11/12/2022
 23712                                  	; ds = cs
 23713 000009D0 8B0E[8102]              	mov	cx,[lo_doscod_size]		; low
 23714                                  	;call	MovDOS
 23715                                  	;retn
 23716                                  	; 11/12/2022
 23717                                  	;jmp	short MovDOS
 23718                                  
 23719                                  ;endif ; ROMDOS
 23720                                  
 23721                                  ; 11/12/2022
 23722                                  
 23723                                  ; ----------------------------------------------------------------------
 23724                                  ;
 23725                                  ; procedure : MovDOS
 23726                                  ;
 23727                                  ;		Moves DOS code into requested area
 23728                                  ;
 23729                                  ;	In : ES:DI - pointer to memory where DOS is to be moved
 23730                                  ;	     CX    - size of DOS code to be moved
 23731                                  ;
 23732                                  ;	Out : ES:DI - pointer to memory immediately after DOS
 23733                                  ;
 23734                                  ; ----------------------------------------------------------------------
 23735                                  
 23736                                  	; 11/12/2022
 23737                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 23738                                  
 23739                                  ;ifndef ROMDOS
 23740                                  
 23741                                  MovDOS:
 23742                                  	; 14/05/2019
 23743                                  	; 27/03/2019 - Retro DOS v4.0
 23744                                  
 23745                                  	; 11/12/2022
 23746                                  	; ds = cs
 23747                                  
 23748                                  	; 23/10/2022
 23749                                  	;push	ds ; *//
 23750                                  	
 23751 000009D4 06                      	push	es
 23752 000009D5 57                      	push	di
 23753                                  
 23754                                  	; 11/12/2022
 23755 000009D6 1E                      	push	ds ; *// ; 11/12/202
 23756                                  
 23757                                  	; 29/04/2019
 23758 000009D7 C536[7102]              	lds	si,[dosinit] ; 11/12/2022
 23759                                  	; 23/10/2022
 23760                                  	;lds	si,[cs:dosinit]
 23761                                  	; 03/09/2023
 23762 000009DB 89F0                    	mov	ax,si
 23763                                  
 23764 000009DD F3A4                    	rep	movsb
 23765                                  
 23766 000009DF 1F                      	pop	ds ; *// ; 11/12/2022
 23767                                  
 23768 000009E0 5B                      	pop	bx				; get back offset into which
 23769                                  						;  DOS was moved
 23770                                  	; 03/09/2023
 23771                                  	;;mov	ax,[cs:dosinit]			; get the offset at which DOS
 23772                                  						;  wants to run
 23773                                  	; 03/09/2023
 23774                                  	;mov	ax,[dosinit]
 23775                                  	; ax = [dosinit]
 23776                                  
 23777 000009E1 29D8                    	sub	ax,bx
 23778 000009E3 E89D02                  	call	off_to_para
 23779 000009E6 5B                      	pop	bx				; get the segment at which
 23780                                  						;  we moved DOS into
 23781 000009E7 29C3                    	sub	bx,ax				; Adjust segment
 23782                                  	
 23783                                  	; 11/12/2022
 23784                                  	; 23/10/2022
 23785                                  	;mov	[cs:CURRENT_DOS_LOCATION],bx	; and save it
 23786                                  	;;mov	[cs:FINAL_DOS_LOCATION],bx
 23787                                  	; 11/12/2022
 23788 000009E9 891E[7302]              	mov	[CURRENT_DOS_LOCATION],bx
 23789                                  		
 23790                                  	; 27/03/2019
 23791                                  	;pop	ds ; *//
 23792                                  	; ds = cs
 23793                                  	;mov	[FINAL_DOS_LOCATION],bx
 23794                                  
 23795 000009ED C3                      	retn
 23796                                  
 23797                                  ;endif ;ROMDOS
 23798                                  
 23799                                  ; NOTE: Retro DOS v4.0 does not move BIOS (IO.SYS) to HMA
 23800                                  ; 24/03/2019
 23801                                  ; ----------------------------------------------------------------------
 23802                                  ;
 23803                                  ; procedure : MovBIOS
 23804                                  ;
 23805                                  ;		Moves BIOS code into requested segment
 23806                                  ;
 23807                                  ;	In : ES - segment to which BIOS is to be moved
 23808                                  ;		  ( it moves always into offset BCode_Start)
 23809                                  ;
 23810                                  ;	Out : ES:DI - pointer to memory immediately after BIOS
 23811                                  ;
 23812                                  ; ----------------------------------------------------------------------
 23813                                  
 23814                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 23815                                  
 23816                                  ;ifndef ROMDOS
 23817                                  
 23818                                  MovBIOS: ; proc	near
 23819                                  	; 11/12/2022
 23820 000009EE 1E                      	push	ds ; ds = cs	
 23821                                  	;
 23822                                  	; 23/10/2022
 23823                                  	;mov	ds,[cs:temp_bcode_seg]		; current BIOS code seg
 23824                                  	; 17/09/2023
 23825 000009EF 8E1E[8902]              	mov	ds,[temp_bcode_seg]
 23826                                  	;mov	si,BCODE_START ; mov si,30h
 23827                                  	; 09/12/2022
 23828 000009F3 BE[3000]                	mov	si,BCODESTART
 23829 000009F6 89F7                    	mov	di,si
 23830 000009F8 B9801D                  	mov	cx,BCODE_END ; mov cx,1A60h
 23831 000009FB 29F1                    	sub	cx,si				; size of BIOS
 23832 000009FD D1E9                    	shr	cx,1				; Both the labels are para
 23833                                  						;  aligned
 23834 000009FF F3A5                    	rep	movsw
 23835                                  	
 23836                                  	; 11/12/2022
 23837 00000A01 1F                      	pop	ds ; ds = cs
 23838                                  	;
 23839 00000A02 06                      	push	es
 23840 00000A03 57                      	push	di				; save end of BIOS
 23841 00000A04 8CC0                    	mov	ax,es
 23842                                  	;
 23843                                  	; 11/12/2022
 23844                                  	;mov	[cs:BCodeSeg],ax		; save it for later use
 23845                                  	;;call	dword ptr cs:_seg_reinit_ptr
 23846                                  	;call	far [cs:seg_reinit_ptr]		; far call to seg_reinit (M022)
 23847                                  	; ds = cs
 23848 00000A06 A3[8A03]                	mov	[BCodeSeg],ax
 23849 00000A09 FF1E[8702]              	call	far [seg_reinit_ptr]
 23850                                  	;
 23851 00000A0D 5F                      	pop	di
 23852 00000A0E 07                      	pop	es				; get back end of BIOS
 23853 00000A0F C3                      	retn
 23854                                  
 23855                                  ;MovBIOS endp
 23856                                  
 23857                                  ;endif ; ROMDOS
 23858                                  
 23859                                  ; 11/12/2022
 23860                                  %if 0
 23861                                  
 23862                                  ; 24/03/2019
 23863                                  
 23864                                  ; ----------------------------------------------------------------------
 23865                                  ;
 23866                                  ; procedure : MovDOS
 23867                                  ;
 23868                                  ;		Moves DOS code into requested area
 23869                                  ;
 23870                                  ;	In : ES:DI - pointer to memory where DOS is to be moved
 23871                                  ;	     CX    - size of DOS code to be moved
 23872                                  ;
 23873                                  ;	Out : ES:DI - pointer to memory immediately after DOS
 23874                                  ;
 23875                                  ; ----------------------------------------------------------------------
 23876                                  
 23877                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 23878                                  
 23879                                  ;ifndef ROMDOS
 23880                                  
 23881                                  MovDOS:
 23882                                  	; 14/05/2019
 23883                                  	; 27/03/2019 - Retro DOS v4.0
 23884                                  
 23885                                  	; 11/12/2022
 23886                                  	; ds = cs
 23887                                  
 23888                                  	; 23/10/2022
 23889                                  	;push	ds ; *//
 23890                                  	
 23891                                  	push	es
 23892                                  	push	di
 23893                                  
 23894                                  	; 11/12/2022
 23895                                  	push	ds ; *// ; 11/12/202
 23896                                  
 23897                                  	; 29/04/2019
 23898                                  	lds	si,[dosinit] ; 11/12/2022
 23899                                  	; 23/10/2022
 23900                                  	;lds	si,[cs:dosinit]
 23901                                  	; 03/09/2023
 23902                                  	mov	ax,si
 23903                                  
 23904                                  	rep	movsb
 23905                                  
 23906                                  	pop	ds ; *// ; 11/12/2022
 23907                                  
 23908                                  	pop	bx				; get back offset into which
 23909                                  						;  DOS was moved
 23910                                  	;mov	ax,[dosinit] ; 03/09/2023
 23911                                  	;;mov	ax,[cs:dosinit]			; get the offset at which DOS
 23912                                  						;  wants to run
 23913                                  	sub	ax,bx
 23914                                  	call	off_to_para
 23915                                  	pop	bx				; get the segment at which
 23916                                  						;  we moved DOS into
 23917                                  	sub	bx,ax				; Adjust segment
 23918                                  	
 23919                                  	; 11/12/2022
 23920                                  	; 23/10/2022
 23921                                  	;mov	[cs:CURRENT_DOS_LOCATION],bx	; and save it
 23922                                  	;;mov	[cs:FINAL_DOS_LOCATION],bx
 23923                                  	; 11/12/2022
 23924                                  	mov	[CURRENT_DOS_LOCATION],bx
 23925                                  		
 23926                                  	; 27/03/2019
 23927                                  	;pop	ds ; *//
 23928                                  	; ds = cs
 23929                                  	;mov	[FINAL_DOS_LOCATION],bx
 23930                                  
 23931                                  	retn
 23932                                  
 23933                                  ;endif ;ROMDOS
 23934                                  
 23935                                  %endif
 23936                                  
 23937                                  ; ----------------------------------------------------------------------
 23938                                  ;
 23939                                  ; procedure : AllocMemForDOS
 23940                                  ;
 23941                                  ;		Allocate memory for DOS/BIOS code from DOS !!!
 23942                                  ;
 23943                                  ;	Out : AX - seg of allocated memoryblock
 23944                                  ;
 23945                                  ; ----------------------------------------------------------------------
 23946                                  
 23947                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 23948                                  
 23949                                  ;ifndef ROMDOS
 23950                                  
 23951                                  AllocMemForDOS:
 23952                                  	; 11/12/2022
 23953                                  	; 14/05/2019
 23954                                  	; 27/03/2019 - Retro DOS v4.0
 23955                                  	; ds = cs
 23956                                  	;mov	ax,BCode_end
 23957                                  	;sub	ax,BCode_start		; BIOS code size
 23958                                  	; 23/10/2022
 23959 00000A10 B8801D                  	mov	ax,BCODE_END ; 1A60h	; 1A70h for MSDOS 6.21
 23960                                  					; 30/12/2022
 23961                                  	;sub	ax,BCODE_START ; 30h
 23962                                  	; 09/12/2022
 23963 00000A13 2D[3000]                	sub	ax,BCODESTART 
 23964                                  	; 24/03/2019 - Retro DOS v4.0 
 23965                                  	; 02/11/2022
 23966                                  	;add	ax,[cs:lo_doscod_size]	; DOS code size
 23967                                  	; 11/12/2022
 23968                                  	; ds = cs
 23969 00000A16 0306[8102]              	add	ax,[lo_doscod_size]
 23970 00000A1A 83C00F                  	add	ax,15
 23971 00000A1D E86302                  	call	off_to_para			; convert to para
 23972                                  	; 23/10/2022
 23973                                  	; 14/05/2019
 23974                                  	;inc	ax ; + 1 paragraph for MCB
 23975 00000A20 09DB                    	or	bx,bx				; M012
 23976 00000A22 89C3                    	mov	bx,ax				;  can we use int 21 for alloc
 23977 00000A24 741A                    	jz	short update_arena		; M012
 23978 00000A26 B448                    	mov	ah,48h				; request DOS
 23979 00000A28 CD21                    	int	21h
 23980 00000A2A 7250                    	jc	short FatalErr			; IF ERR WE ARE HOSED
 23981                                   	; 23/10/2022
 23982                                  	; 24/03/2019 - Retro DOS v4.0 (ORG 0)
 23983 00000A2C 83E803                  	sub	ax,3				; Take care ORG 30h of
 23984                                  						;  BIOS code
 23985 00000A2F 8EC0                    	mov	es,ax
 23986                                  	;mov	word [es:20h+ARENA.OWNER],08h	; mark it as system
 23987                                  	;mov	word [es:20h+ARENA.NAME],'SC'	;  code area
 23988                                  	; 14/05/2019
 23989                                  	;mov	word [es:ARENA.OWNER],08h	; mark it as system
 23990                                  	;mov	word [es:ARENA.NAME],'SC'	;  code area
 23991                                  	; 23/10/2022
 23992 00000A31 26C70621000800          	mov	word [es:20h+1],08h		; mark it as system
 23993 00000A38 26C70628005343          	mov	word [es:20h+8],'SC'		;  code area
 23994                                  
 23995 00000A3F C3                      	retn
 23996                                  
 23997                                  ; BUGBUG -- 5 Aug 92 -- chuckst -- Allocating space for DOS
 23998                                  ;	  using DOS itself causes an arena to be generated.
 23999                                  ;	  Unfortunately, certain programs (like PROTMAN$)
 24000                                  ;	  assume that the device drivers are loaded into
 24001                                  ;	  the first arena. For this reason, MagicDrv's
 24002                                  ;	  main device driver header arena is manually
 24003                                  ;	  truncated from the arena chain, and the space
 24004                                  ;	  for DOS is allocated using the following
 24005                                  ;	  simple code, which also assumes that the
 24006                                  ;	  first arena is the free one where DOS's low
 24007                                  ;	  stub will go.
 24008                                  ;
 24009                                  ; M012 : BEGIN
 24010                                  
 24011                                  	; 23/10/2022
 24012                                  update_arena:
 24013 00000A40 1E                      	push	ds ; ds = cs
 24014 00000A41 57                      	push	di
 24015 00000A42 51                      	push	cx
 24016 00000A43 52                      	push	dx
 24017                                  	; 23/10/2022
 24018                                  	;lds	di,[cs:DOSINFO]			; get ptr to DOS var
 24019                                  	; 11/12/2022
 24020                                  	; ds = cs 
 24021 00000A44 C53E[6D02]              	lds	di,[DOSINFO] ; 27/03/2019	
 24022 00000A48 4F                      	dec	di
 24023 00000A49 4F                      	dec	di				; Arena head is immediately
 24024                                  						;  before sysvar
 24025 00000A4A 8E05                    	mov	es,[di]				; es = arena head
 24026                                  	;mov	cx,[es:ARENA.SIZE]		; cx = total low mem size
 24027 00000A4C 268B0E0300              	mov	cx,[es:3]
 24028 00000A51 39D9                    	cmp	cx,bx				; is it sufficient ?
 24029 00000A53 7227                    	jb	short FatalErr			; no, fatal error
 24030                                  
 24031                                  	;mov	dl,[es:ARENA.SIGNATURE]
 24032 00000A55 268A160000              	mov	dl,[es:0]
 24033 00000A5A 8CC0                    	mov	ax,es
 24034 00000A5C 01D8                    	add	ax,bx				; ax = new arena head
 24035 00000A5E 8905                    	mov	[di],ax				; store it in DOS data area
 24036 00000A60 8ED8                    	mov	ds,ax
 24037                                  	;mov	[ARENA.SIGNATURE],dl		; type of arena
 24038 00000A62 88160000                	mov	[0],dl
 24039                                  	;mov	word [ARENA.OWNER],0		; free
 24040 00000A66 C70601000000            	mov	word [1],0
 24041 00000A6C 29D9                    	sub	cx,bx				; size of the new block
 24042                                  	;mov	[ARENA.SIZE],cx			; store it in the arena
 24043 00000A6E 890E0300                	mov	[3],cx
 24044 00000A72 8CC0                    	mov	ax,es				; return seg to the caller
 24045                                  	; 23/10/2022
 24046                                  	;; 24/03/2019 - Retro DOS v4.0 (ORG 0)	; Take care ORG 30h of
 24047 00000A74 83E803                  	sub	ax,3				;  BIOS code
 24048 00000A77 5A                      	pop	dx
 24049 00000A78 59                      	pop	cx
 24050 00000A79 5F                      	pop	di
 24051 00000A7A 1F                      	pop	ds ; ds = cs
 24052 00000A7B C3                      	retn
 24053                                  ;
 24054                                  ; M012 : END
 24055                                  ;
 24056                                  FatalErr:
 24057 00000A7C 0E                      	push	cs
 24058 00000A7D 1F                      	pop	ds
 24059 00000A7E BA[4909]                	mov	dx,FEmsg
 24060 00000A81 B409                    	mov	ah,9
 24061 00000A83 CD21                    	int	21h 		; DOS - PRINT STRING
 24062                                  				; DS:DX -> string terminated by "$"
 24063                                  	; 30/12/2022 (MSDOS 6.21 SYSINIT)
 24064 00000A85 E92C07                  	jmp	stall
 24065                                  	; 23/10/2022 (MSDOS 5.0 SYSINIT)
 24066                                  	;cli
 24067                                  	;hlt
 24068                                  
 24069                                  ;endif ;ROMDOS
 24070                                  
 24071                                  ; 25/03/2019 - Retro DOS v4.0
 24072                                  
 24073                                  ; ----------------------------------------------------------------------
 24074                                  ;
 24075                                  ; procedure : AllocHMA
 24076                                  ;
 24077                                  ;	grab_the_hma tries to enable a20 and make sure there is memory
 24078                                  ;	  up there. If it gets any sort of error, it will return with
 24079                                  ;	  carry set so that we can resort to running low.
 24080                                  ;
 24081                                  ;	It also returns ES: -> 0ffffh if it returns success
 24082                                  ;
 24083                                  ; ----------------------------------------------------------------------
 24084                                  
 24085                                  AllocHMA:
 24086                                  ;	cas note:  The pre-286 check is no longer needed here since the
 24087                                  ;		   presence of XMS is sufficient. However, this code hasn't
 24088                                  ;		   been deleted because it can be recycled for skipping the
 24089                                  ;		   extra pass of CONFIG.SYS and assuming we're running low
 24090                                  ;		   in the case of a pre-286.
 24091                                  
 24092                                  ;;	see if we're running on a pre-286. If not, force low.
 24093                                  ;
 24094                                  ;	xor	ax,ax
 24095                                  ;	pushf			; save flags (like int)
 24096                                  ;	push	ax
 24097                                  ;	popf
 24098                                  ;	pushf
 24099                                  ;	pop	ax
 24100                                  ;	popf			; restore original flags (like int)
 24101                                  ;	and	ax,0F000h
 24102                                  ;	cmp	ax,0F000h	; 8088/8086?
 24103                                  ;	jz	short grab_hma_error
 24104                                  
 24105                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 24106                                  	; (SYSINIT:0A26h)
 24107                                  
 24108 00000A88 1E                      	push	ds
 24109                                  	;;mov	ax,Bios_Data
 24110                                  	;mov	ax,KERNEL_SEGMENT
 24111                                  	; 21/10/2022
 24112 00000A89 B87000                  	mov	ax,DOSBIODATASEG
 24113 00000A8C 8ED8                    	mov	ds,ax
 24114                                  
 24115 00000A8E E84A00                  	call	IsXMSLoaded
 24116 00000A91 7545                    	jnz	short grabhma_error
 24117                                  
 24118 00000A93 B81043                  	mov	ax,4310h
 24119 00000A96 CD2F                    	int	2Fh		; get the vector into es:bx
 24120                                  		; - Multiplex - XMS - GET DRIVER ADDRESS
 24121                                  		; Return: ES:BX -> driver entry point
 24122                                  
 24123 00000A98 891E[0E00]              	mov	[xms],bx
 24124                                  	;mov	[0Eh],bx
 24125 00000A9C 8C06[1000]              	mov	[xms+2],es
 24126                                  	;mov	[10h],es
 24127                                  
 24128 00000AA0 B401                    	mov	ah,1		; request HMA
 24129 00000AA2 BAFFFF                  	mov	dx,0FFFFh
 24130                                  	;call	dword ptr ds:0Eh
 24131 00000AA5 FF1E[0E00]              	call	far [xms]
 24132 00000AA9 48                      	dec	ax
 24133 00000AAA 7409                    	jz	short allocHMA_1 ; error if not able to allocate HMA
 24134                                  
 24135                                  ;------ Himem may be lying because it has allocated mem for int 15
 24136                                  
 24137 00000AAC B488                    	mov	ah,88h
 24138 00000AAE CD15                    	int	15h
 24139                                  		; Get Extended Memory Size
 24140                                  		; Return: CF clear on success
 24141                                  		; AX = size of memory above 1M in K
 24142 00000AB0 83F840                  	cmp	ax,64		; less than 64 K of hma ?
 24143                                  	;jb	short grabhma_error
 24144                                  	; 11/12/2022
 24145 00000AB3 7224                    	jb	short grabhma_err ; cf=1
 24146                                  allocHMA_1:
 24147 00000AB5 B405                    	mov	ah,5		; localenableA20
 24148                                  	;call	dword ptr ds:0Eh
 24149 00000AB7 FF1E[0E00]              	call	far [xms]
 24150 00000ABB 48                      	dec	ax
 24151 00000ABC 751A                    	jnz	short grabhma_error ; error if couldn't enable A20
 24152                                  
 24153 00000ABE E88501                  	call	IsVDiskInstalled
 24154 00000AC1 7415                    	jz	short grabhma_error ; yes, we cant use HMA
 24155                                  
 24156 00000AC3 B8FFFF                  	mov	ax,0FFFFh
 24157 00000AC6 8EC0                    	mov	es,ax
 24158 00000AC8 26C70610003412          	mov	word [es:10h],1234h ; see if we can really read/write there
 24159 00000ACF 26813E10003412          	cmp	word [es:10h],1234h
 24160                                  	;jne	short grabhma_error ; don't try to load there if XMS lied
 24161                                  	; 11/12/2022
 24162 00000AD6 7401                    	je	short allocHMA_ok	
 24163                                  
 24164                                  ; 11/12/2022
 24165                                  ;	; 11/12/2022
 24166                                  ;	; cf=0
 24167                                  ;	;clc
 24168                                  ;	pop	ds
 24169                                  ;	retn
 24170                                  
 24171                                  grabhma_error:
 24172 00000AD8 F9                      	stc
 24173                                  	; 11/12/022
 24174                                  grabhma_err:	; cf=1
 24175                                  allocHMA_ok:	; cf=0
 24176 00000AD9 1F                      	pop	ds
 24177 00000ADA C3                      	retn
 24178                                  
 24179                                  ; ----------------------------------------------------------------------
 24180                                  ;
 24181                                  ; procedure : IsXMSLoaded
 24182                                  ;
 24183                                  ;             Checks whether a XMS driver is loaded
 24184                                  ;
 24185                                  ; Returns : Z flag set if XMS driver loaded
 24186                                  ;           Z flag reset if no XMS drivers are present
 24187                                  ;
 24188                                  ; ----------------------------------------------------------------------
 24189                                  
 24190                                  IsXMSLoaded:
 24191 00000ADB B80043                  	mov	ax,4300h
 24192 00000ADE CD2F                    	int	2Fh		; - Multiplex - XMS - INSTALLATION CHECK
 24193                                  				; Return: AL = 80h XMS driver installed
 24194                                  				; AL <> 80h no driver
 24195 00000AE0 3C80                    	cmp	al,80h		; XMS installed?
 24196 00000AE2 C3                      	retn
 24197                                  
 24198                                  ; ----------------------------------------------------------------------
 24199                                  ; procedure : FTryToMovDOSHi
 24200                                  ;
 24201                                  ;		Called from HMA suballoc calls
 24202                                  ;	
 24203                                  ; ----------------------------------------------------------------------
 24204                                  
 24205                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 24206                                  	; (SYSINIT:0A84h)
 24207                                  
 24208                                  FTryToMovDOSHi:	; proc	far
 24209                                  
 24210 00000AE3 50                      	push	ax
 24211 00000AE4 53                      	push	bx
 24212 00000AE5 51                      	push	cx
 24213 00000AE6 52                      	push	dx
 24214 00000AE7 56                      	push	si
 24215 00000AE8 57                      	push	di
 24216 00000AE9 1E                      	push	ds
 24217 00000AEA 06                      	push	es
 24218                                  
 24219                                  	; 23/10/2022
 24220                                  	; 27/03/2019 - Retro DOS v4.0
 24221                                  	; 11/12/2022
 24222 00000AEB 0E                      	push	cs
 24223 00000AEC 1F                      	pop	ds
 24224                                  
 24225                                  	;cmp	byte [cs:runhigh],0FFh
 24226                                  	; 11/12/2022
 24227 00000AED 803E[6C02]FF            	cmp	byte [runhigh],0FFh
 24228 00000AF2 7503                    	jne	short _ftymdh_1
 24229                                  
 24230                                  	; ds = cs
 24231 00000AF4 E8A2FE                  	call	TryToMovDOSHi
 24232                                  _ftymdh_1:
 24233 00000AF7 07                      	pop	es
 24234 00000AF8 1F                      	pop	ds
 24235 00000AF9 5F                      	pop	di
 24236 00000AFA 5E                      	pop	si
 24237 00000AFB 5A                      	pop	dx
 24238 00000AFC 59                      	pop	cx
 24239 00000AFD 5B                      	pop	bx
 24240 00000AFE 58                      	pop	ax
 24241                                  
 24242 00000AFF CB                      	retf
 24243                                  
 24244                                  ; ----------------------------------------------------------------------
 24245                                  ;
 24246                                  ; following piece of code will be moved into a para boundary. And the para
 24247                                  ; address posted in seg of int 19h vector. Offset of int 19h will point to
 24248                                  ; VDint19. This is to protect HMA from apps which use VDISK header method
 24249                                  ; to determine free extended memory.
 24250                                  ;
 24251                                  ; For more details read "power programming" column by Ray Duncan in the
 24252                                  ; May 30 1989 issue of PC Magazine (pp 377-388) [USING EXTENDED MEMORY,PART 1]
 24253                                  ;
 24254                                  ; ----------------------------------------------------------------------
 24255                                  
 24256                                  StartVDHead:
 24257                                  ;-------------- what follows is a dummy device driver header (not used by DOS)
 24258                                  
 24259 00000B00 00000000                	dd	0		; link to next device driver
 24260 00000B04 0080                    	dw	8000h		; device attribute
 24261 00000B06 0000                    	dw	0		; strategy routine offset
 24262 00000B08 0000                    	dw	0		; interrupt routine offset
 24263 00000B0A 01                      	db	1		; number of units
 24264                                  	;db	7 dup(0) 
 24265 00000B0B 00<rep 7h>              	times	7 db 0 		; reserved area
 24266                                  VDiskSig1:
 24267 00000B12 564449534B              	db	'VDISK'
 24268                                  
 24269                                  VLEN1	equ	($-VDiskSig1)
 24270                                  
 24271 00000B17 202056332E33            	db	'  V3.3'	; vdisk label
 24272                                  	;db	15 dup (0)	; pad
 24273 00000B1D 00<rep Fh>              	times	15 db 0
 24274 00000B2C 0000                    	dw	0		; bits 0-15 of free HMA
 24275 00000B2E 11                      	db	11h		; bits 16-23 of free HMA (1M + 64K)
 24276                                  VDInt19:
 24277 00000B2F EA                      	db	0EAh		; jmp to old vector
 24278                                  OldVDInt19:
 24279 00000B30 00000000                	dd	0		; Saved int 19 vector
 24280                                  
 24281                                  EndVDHead: ; label byte
 24282                                  
 24283                                  VDiskHMAHead:	
 24284 00000B34 000000                  	db	0,0,0		; non-bootable disk
 24285                                  VDiskSig2:
 24286 00000B37 564449534B              	db	'VDISK'
 24287                                  
 24288                                  VLEN2	equ	($-VDiskSig2)
 24289                                  
 24290 00000B3C 332E33                  	db	'3.3'		; OEM - signature
 24291 00000B3F 8000                    	dw	128		; number of bytes/sector
 24292 00000B41 01                      	db	1		; sectors/cluster
 24293 00000B42 0100                    	dw	1		; reserved sectors
 24294 00000B44 01                      	db	1		; number of FAT copies
 24295 00000B45 4000                    	dw	64		; number of root dir entries
 24296 00000B47 0002                    	dw	512		; number of sectors
 24297 00000B49 FE                      	db	0FEh		; media descriptor
 24298 00000B4A 0600                    	dw	6		; number of sectors/FAT
 24299 00000B4C 0800                    	dw	8		; sectors per track
 24300 00000B4E 0100                    	dw	1		; number of heads
 24301 00000B50 0000                    	dw	0		; number of hidden sectors
 24302 00000B52 4004                    	dw	440h		; Start of free HMA in K (1M+64K)
 24303                                  
 24304                                  EndVDiskHMAHead: ; label byte
 24305                                  
 24306                                  ; ----------------------------------------------------------------------
 24307                                  ;
 24308                                  ; procedure : InstVDiskHeader
 24309                                  ;
 24310                                  ;             Installs the VDISK header to reserve the 64k of HMA
 24311                                  ;	      It puts a 32 byte header at 10000:0 and
 24312                                  ;	      another header at (seg of int19):0
 24313                                  ;
 24314                                  ; Inputs : None
 24315                                  ;
 24316                                  ; Outputs : None
 24317                                  ;
 24318                                  ; USES : DS,SI,AX,CX,DX
 24319                                  ;
 24320                                  ; ----------------------------------------------------------------------
 24321                                  
 24322                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 24323                                  
 24324                                  InstVDiskHeader:
 24325 00000B54 31C0                    	xor	ax,ax
 24326 00000B56 8ED8                    	mov	ds,ax			; seg of int vect table
 24327                                  
 24328                                  ;-------------- save old int 19 vector
 24329                                  
 24330                                  	; 23/10/2022
 24331 00000B58 A16400                  	mov	ax,[19h*4]
 24332                                  	;mov	[OldVDInt19],ax
 24333 00000B5B 2EA3[300B]              	mov	[cs:OldVDInt19],ax
 24334 00000B5F A16600                  	mov	ax,[19h*4+2]
 24335                                  	;mov	[OldVDInt19+2],ax
 24336 00000B62 2EA3[320B]              	mov	[cs:OldVDInt19+2],ax
 24337                                  
 24338                                  ;-------------- calculate seg of new int 19 handler
 24339                                  
 24340 00000B66 B448                    	mov	ah,48h			; allocate memory
 24341                                  	;mov	bx,(EndVDHead-StartVDHead+15)>>4
 24342                                  	; 23/10/2022
 24343 00000B68 BB0400                  	mov	bx,4
 24344 00000B6B CD21                    	int	21h
 24345                                  
 24346                                  ;	if carry, fatal hanging error!!!!!
 24347                                  
 24348 00000B6D 48                      	dec	ax			; point to arena
 24349 00000B6E 8EC0                    	mov	es,ax
 24350                                  	;mov	word [es:ARENA.OWNER],8	; owner = System
 24351 00000B70 26C70601000800          	mov	word [es:1],8
 24352                                  	;mov	word [es:ARENA.NAME],'SC' ; System Code
 24353 00000B77 26C70608005343          	mov	word [es:8],'SC'
 24354 00000B7E 40                      	inc	ax
 24355 00000B7F 8EC0                    	mov	es,ax			; get back to allocated memory
 24356                                  
 24357                                  ;-------------- install new int 19 vector
 24358                                  
 24359 00000B81 FA                      	cli				; no reboots at this time
 24360                                  	;mov	word [19h*4],(VDInt19-StartVDHead)
 24361 00000B82 C70664002F00            	mov	word [19h*4],47
 24362 00000B88 A36600                  	mov	[19h*4+2],ax
 24363                                  
 24364                                  ;-------------- move the code into proper place
 24365                                  
 24366                                  	;mov	cx,(EndVDHead-StartVDHead)
 24367 00000B8B B93400                  	mov	cx,52
 24368 00000B8E BE[000B]                	mov	si,StartVDHead
 24369 00000B91 31FF                    	xor	di,di
 24370 00000B93 0E                      	push	cs
 24371 00000B94 1F                      	pop	ds
 24372 00000B95 FC                      	cld
 24373 00000B96 F3A4                    	rep	movsb
 24374 00000B98 FB                      	sti				; BUGBUG is sti OK now?
 24375                                  
 24376                                  ;-------------- mov the HMA VDisk head into HMA
 24377                                  
 24378                                  	; 23/10/2022
 24379 00000B99 57                      	push	di
 24380 00000B9A 06                      	push	es
 24381                                  
 24382                                  	;mov	ax,0FFFFh
 24383                                  	;mov	es,ax
 24384                                  	; 03/09/2023
 24385 00000B9B 49                      	dec	cx
 24386                                  	; cx = 0FFFFh
 24387 00000B9C 8EC1                    	mov	es,cx
 24388                                  
 24389 00000B9E BF1000                  	mov	di,10h
 24390                                  	;mov	cx,(EndVDiskHMAHead-VDiskHMAHead)
 24391 00000BA1 B92000                  	mov	cx,32
 24392 00000BA4 BE[340B]                	mov	si,VDiskHMAHead
 24393 00000BA7 F3A4                    	rep	movsb			; ds already set to cs
 24394                                  
 24395 00000BA9 5F                      	pop	di
 24396 00000BAA 07                      	pop	es
 24397                                  
 24398 00000BAB C3                      	retn
 24399                                  
 24400                                  ; ----------------------------------------------------------------------
 24401                                  ; procedure : ClrVDISKHeader
 24402                                  ;
 24403                                  ;		Clears the first 32 bytes at 1MB boundary
 24404                                  ;		So that DOS/HIMEM is not confused about the VDISK header
 24405                                  ;		left by previous DOS=HIGH session
 24406                                  ;
 24407                                  ; ----------------------------------------------------------------------
 24408                                  
 24409                                  struc desc
 24410 00000000 ????                     .seg_lim:	resw	1		; seg limit 64K 
 24411 00000002 ????                     .lo_word:	resw	1		; 24 bit seg physical 
 24412 00000004 ??                       .hi_byte:	resb 	1		; address
 24413 00000005 ??                       .acc_rights:	resb	1		; access rights ( CPL0 - R/W )
 24414 00000006 ????                     .reserved:	resw	1		;
 24415                                   .size:
 24416                                  endstruc
 24417                                  
 24418                                  		; 23/10/2022
 24419                                  bmove:		;label byte
 24420                                  
 24421                                  dummy:		;times desc.size db 0	; desc	<>
 24422 00000BAC 00<rep 8h>              		times 8 db 0		 
 24423                                  gdt:		;times desc.size db 0	; desc	<>
 24424 00000BB4 00<rep 8h>              		times 8 db 0
 24425 00000BBC FFFF                    src_desc:	dw	0FFFFh		; desc	<0ffffh,0,0,93h,0>
 24426 00000BBE 0000                    		dw	0
 24427 00000BC0 00                      		db	0
 24428 00000BC1 93                      		db	93h
 24429 00000BC2 0000                    		dw	0
 24430 00000BC4 FFFF                    tgt_desc:	dw	0FFFFh		; desc	<0ffffh,0,10h,93h,0>  ; 1MB
 24431 00000BC6 0000                    		dw	0
 24432 00000BC8 10                      		db	10h
 24433 00000BC9 93                      		db	93h
 24434 00000BCA 0000                    		dw	0
 24435                                  
 24436                                  rombios_code:	;times desc.size db 0	; desc	<>
 24437 00000BCC 00<rep 8h>              		times 8 db 0
 24438                                  temp_stack:	;times desc.size db 0	; desc	<>
 24439 00000BD4 00<rep 8h>              		times 8 db 0
 24440                                  
 24441 00000BDC 00<rep 20h>             ClrdVDISKHead:	times 32 db 0		; db 32 dup (0)
 24442                                  
 24443                                  
 24444                                  ; 25/03/2019 - Retro DOS v4.0 (MSDOS 6.21 IO.SYS, MSDOS 6.0 SYSINIT1.ASM)
 24445                                  
 24446                                  ; 30/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 24447                                  ; (SYSINIT:0CA6h)
 24448                                  
 24449                                  ClrVDISKHeader:	; proc	near
 24450                                  
 24451                                  ;; 04/07/2023 - Retro DOS v4.2 IO.SYS (optimized)
 24452                                  ;;-----------------------------------------------------------	     ;I070
 24453                                  ;; The following workaround get around a problem with the	     ;I070
 24454                                  ;; Tortugas and PS/2 30-286 BIOS when password server mode	     ;I070
 24455                                  ;; is set. On those machines the INT 15h block move code	     ;I070
 24456                                  ;; goes through the 8042 to twiddle A20 instead of port 92h.	     ;I070
 24457                                  ;; In password server mode the 8042 is disabled so the block	     ;I070
 24458                                  ;; move crashes the system. We can do this because these	     ;I070
 24459                                  ;; systems clear all of memory on a cold boot.			     ;I070
 24460                                  ;								     ;I070
 24461                                  ;	in      al,64h         		; Test for passwd servr mode ;I070
 24462                                  ;	test    al,10h			; Is keyboard inhibited?     ;I070
 24463                                  ;	jnz     short ClrVDISKok	; No, go do block move.      ;I070
 24464                                  ;					; Check for Tortugas...	     ;I070
 24465                                  ;	;;cmp	word [cs:sys_model_byte],19F8h                	     ;I070
 24466                                  ;	;cmp	word [sys_model_byte],19F8h  ; ds = cs       
 24467                                  ;	mov	ax,[sys_model_byte]
 24468                                  ;	cmp	ax,19F8h
 24469                                  ;	je      short ClrVDISKno                            	     ;I070
 24470                                  ;					; Check for mod 30-286	     ;I070
 24471                                  ;	;;cmp	word [cs:sys_model_byte],09FCh			     ;I070
 24472                                  ;	;cmp	word [sys_model_byte],09FCh	
 24473                                  ;	cmp	ax,09FCh
 24474                                  ;	jne     short ClrVDISKok			      	     ;I070
 24475                                  ;ClrVDISKno:							     ;I070	
 24476                                  ;	retn	               		; Return w/o block move.     ;I070
 24477                                  ;ClrVDISKok:							     ;I070
 24478                                  ;-----------------------------------------------------------	     ;I070
 24479                                  
 24480                                  	; 12/12/2022
 24481                                  	; ds = cs
 24482                                  
 24483                                  	; 30/12/2022 - Retro DOS v4.2
 24484                                  	; (MSDOS 6.21 IO.SYS SYSINIT:0CBFh)
 24485                                  
 24486 00000BFC 06                      	push	es
 24487 00000BFD 8CC8                    	mov	ax,cs
 24488 00000BFF 89C2                    	mov	dx,ax
 24489 00000C01 B10C                    	mov	cl,12
 24490 00000C03 D3EA                    	shr	dx,cl
 24491 00000C05 B104                    	mov	cl,4
 24492 00000C07 D3E0                    	shl	ax,cl
 24493 00000C09 05[DC0B]                	add	ax,ClrdVDISKHead
 24494 00000C0C 80D200                  	adc	dl,0
 24495                                  
 24496                                  	;; 23/10/2022
 24497                                  	;;mov	[cs:src_desc+desc.lo_word],ax
 24498                                  	;mov	[cs:src_desc+2],ax
 24499                                  	;;mov	[cs:src_desc+desc.hi_byte],dl
 24500                                  	;mov	[cs:src_desc+4],dl
 24501                                  	; 12/12/2022
 24502                                  	;mov	[src_desc+desc.lo_word],ax
 24503 00000C0F A3[BE0B]                	mov	[src_desc+2],ax
 24504                                  	;mov	[src_desc+desc.hi_byte],dl
 24505 00000C12 8816[C00B]              	mov	[src_desc+4],dl
 24506                                  
 24507 00000C16 B91000                  	mov	cx,16	; 16 words
 24508 00000C19 0E                      	push	cs
 24509 00000C1A 07                      	pop	es
 24510 00000C1B BE[AC0B]                	mov	si,bmove
 24511 00000C1E B487                    	mov	ah,87h
 24512 00000C20 CD15                    	int	15h	; EXTENDED MEMORY - BLOCK MOVE (AT,XT286,PS)
 24513                                  			; CX = number of words to move 
 24514                                  			; ES:SI -> global descriptor table
 24515                                  			; Return: CF set on error, AH = status
 24516 00000C22 07                      	pop	es
 24517 00000C23 C3                      	retn
 24518                                  
 24519                                  ; ----------------------------------------------------------------------
 24520                                  ;
 24521                                  ; procedure : SaveFreeHMAPtr
 24522                                  ;
 24523                                  ;		Save the Free HMA pointer in BIOS variable for later use.
 24524                                  ;		(INT 2f ax==4a01 call returns pointer to free HMA)
 24525                                  ;		Normalizes the pointer to ffff:xxxx format and stores only
 24526                                  ;		the offset.
 24527                                  ;
 24528                                  ; Inputs : ES:DI - pointer to free HMA
 24529                                  ; Output : FreeHMAPtr in BIOS data segment updated
 24530                                  ;
 24531                                  ; ----------------------------------------------------------------------
 24532                                  
 24533                                  SaveFreeHMAPtr:
 24534                                  	; 03/09/2023
 24535 00000C24 1E                      	push	ds
 24536 00000C25 B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 24537 00000C28 8ED8                    	mov	ds,ax
 24538                                  	;
 24539 00000C2A 8CC3                    	mov	bx,es
 24540 00000C2C B8FFFF                  	mov	ax,0FFFFh	   ; HMA segment
 24541                                  	; 03/09/2023
 24542 00000C2F A2[0D00]                	mov	[inHMA],al ; 0FFh
 24543                                  	;
 24544 00000C32 29D8                    	sub	ax,bx
 24545 00000C34 83C70F                  	add	di,15		   ; para round
 24546 00000C37 83E7F0                  	and	di,0FFF0h
 24547 00000C3A B104                    	mov	cl,4
 24548 00000C3C D3E0                    	shl	ax,cl
 24549 00000C3E 29C7                    	sub	di,ax
 24550                                  	;
 24551                                  	; 03/09/2023
 24552                                  	;push	ds
 24553                                  	;;mov	ax,Bios_Data ; 0070h
 24554                                  	;mov	ax,KERNEL_SEGMENT ; 0070h
 24555                                  	; 21/10/2022
 24556                                  	; 03/09/2023
 24557                                  	;mov	ax,DOSBIODATASEG ; 0070h
 24558                                  	;mov	ds,ax
 24559 00000C40 893E[D707]              	mov	[FreeHMAPtr],di	   ; (ds:8F7h for MSDOS 6.21 IO.SYS)
 24560                                  	;mov	byte [inHMA],0FFh  ; (ds:0Dh)
 24561 00000C44 1F                      	pop	ds
 24562 00000C45 C3                      	retn
 24563                                  
 24564                                  ; ----------------------------------------------------------------------
 24565                                  ;
 24566                                  ; procedure : IsVDiskInstalled
 24567                                  ;
 24568                                  ;		Checks for the presence of VDISK header at 1MB boundary
 24569                                  ;		& INT 19 vector
 24570                                  ;
 24571                                  ; Inputs  : A20 flag should be ON
 24572                                  ; Outputs : Zero set if VDISK header found else Zero cleared
 24573                                  ;
 24574                                  ; ----------------------------------------------------------------------
 24575                                  
 24576                                  IsVDiskInstalled:
 24577 00000C46 31C0                    	xor	ax,ax
 24578 00000C48 8ED8                    	mov	ds,ax
 24579 00000C4A 8E1E4E00                	mov	ds,[19*4+2]
 24580                                  	;mov	si,VDiskSig1-StartVDHead ; 12h
 24581                                  	; 23/10/2022
 24582 00000C4E BE1200                  	mov	si,12h ; 18
 24583                                  	;mov	cx,VLEN1 ; 5
 24584 00000C51 B90500                  	mov	cx,5
 24585 00000C54 0E                      	push	cs
 24586 00000C55 07                      	pop	es
 24587 00000C56 BF[120B]                	mov	di,VDiskSig1
 24588 00000C59 F3A6                    	rep	cmpsb
 24589 00000C5B 740F                    	je	short ivdins_retn
 24590 00000C5D B8FFFF                  	mov	ax,0FFFFh
 24591 00000C60 8ED8                    	mov	ds,ax
 24592                                  	;mov	si,10h+(VDiskSig2-VDiskHMAHead) ; 13h
 24593 00000C62 BE1300                  	mov	si,13h
 24594 00000C65 BF[370B]                	mov	di,VDiskSig2
 24595                                  	;;mov	cx,VLEN2  ; 5
 24596                                  	;mov	cx,5
 24597                                  	; 03/09/2023
 24598 00000C68 B105                    	mov	cl,5
 24599 00000C6A F3A6                    	rep	cmpsb
 24600                                  ivdins_retn: 
 24601 00000C6C C3                      	retn			; returns the Zero flag
 24602                                  
 24603                                  ; ----------------------------------------------------------------------
 24604                                  ;
 24605                                  ; procedure : CPMHack
 24606                                  ;
 24607                                  ;		Copies the code from 0:c0 into ffff:0d0h
 24608                                  ;		for CPM compatibility
 24609                                  ;
 24610                                  ; ----------------------------------------------------------------------
 24611                                  
 24612                                  	; 11/12/2022
 24613                                  CPMHack:
 24614 00000C6D 1E                      	push	ds
 24615 00000C6E B9FFFF                  	mov	cx,0FFFFh
 24616 00000C71 8EC1                    	mov	es,cx		; ES = 0FFFFh
 24617                                  	;xor	cx,cx
 24618                                  	; 11/12/2022
 24619 00000C73 41                      	inc	cx  ; cx = 0
 24620 00000C74 8ED9                    	mov	ds,cx		; DS = 0
 24621 00000C76 BEC000                  	mov	si,0C0h
 24622 00000C79 BFD000                  	mov	di,0D0h
 24623                                  	;mov	cx,5
 24624 00000C7C B105                    	mov	cl,5
 24625 00000C7E FC                      	cld
 24626 00000C7F F3A4                    	rep	movsb		; move 5 bytes from 0:C0 to FFFF:D0
 24627 00000C81 1F                      	pop	ds
 24628 00000C82 C3                      	retn
 24629                                  
 24630                                  ; ----------------------------------------------------------------------
 24631                                  ;
 24632                                  ; procedure : off_to_para
 24633                                  ;
 24634                                  ; ----------------------------------------------------------------------
 24635                                  off_to_para:
 24636 00000C83 D1E8                    	shr	ax,1
 24637 00000C85 D1E8                    	shr	ax,1
 24638 00000C87 D1E8                    	shr	ax,1
 24639 00000C89 D1E8                    	shr	ax,1
 24640 00000C8B C3                      	retn
 24641                                  
 24642                                  ; ----------------------------------------------------------------------
 24643                                  ;**	TempCDS - Create (Temporary?) CDS
 24644                                  ;
 24645                                  ;	ENTRY	?? BUGBUG
 24646                                  ;		(DS) = SysInitSeg
 24647                                  ;	EXIT	?? BUGBUG
 24648                                  ;	USES	?? BUGBUG
 24649                                  ; ----------------------------------------------------------------------
 24650                                  
 24651                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 24652                                  	; 30/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 24653                                  TempCDS:
 24654 00000C8C C43E[6D02]              	les	di,[DOSINFO]
 24655 00000C90 268A4D20                	mov	cl,[es:di+SYSI_NUMIO]
 24656                                  	;mov	cl,[es:di+20h]
 24657 00000C94 30ED                    	xor	ch,ch			; (cx) = # of block devices
 24658                                  
 24659 00000C96 26884D21                	mov	[es:di+SYSI_NCDS],cl	; one CDS per device
 24660                                  	;mov	[es:di+21h],cl	
 24661                                  
 24662 00000C9A 88C8                    	mov	al,cl
 24663 00000C9C B458                    	mov	ah,curdirlen ; curdir_list.size ; 88
 24664                                  	;mov	ah,88
 24665 00000C9E F6E4                    	mul	ah			; (ax) = byte size for those CDSs
 24666 00000CA0 E8D804                  	call	ParaRound		; (ax) = paragraph size for CDSs
 24667 00000CA3 8B36[A702]              	mov	si,[top_of_cdss] ; 31/12/2022
 24668                                  
 24669                                  ;	BUGBUG - we don't update confbot - won't someone else use it?
 24670                                  ;	chuckst -- answer: no. Confbot is used to access the CDSs,
 24671                                  ;	25 jul 92  which are stored BELOW it. Alloclim is the
 24672                                  ;		   variable which has the top of free memory for
 24673                                  ;		   device driver loads, etc.
 24674                                  
 24675 00000CA7 29C6                    	sub	si,ax
 24676                                  
 24677                                  ;	chuckst, 25 Jul 92 -- note: I'm removing the code here
 24678                                  ;		that automatically updates alloclim every time we
 24679                                  ;		set up some new CDSs. Instead, I've added code
 24680                                  ;		which pre-allocates space for 26 CDSs. This
 24681                                  ;	        way we've got room for worst case CDSs before
 24682                                  ;		we place MagicDrv.sys
 24683                                  ;
 24684                                  ;	mov	[ALLOCLIM],si		; can't alloc past here!
 24685                                  
 24686                                  	; 30/12/2022
 24687                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 24688                                  	; (SYSINIT:0C52h)
 24689                                  	;mov	[ALLOCLIM],si ; (MSDOS 5.0 SYSINIT)
 24690                                  
 24691 00000CA9 26897518                	mov	[es:di+SYSI_CDS+2],si
 24692                                  	;mov	[es:di+18h],si
 24693 00000CAD 89F0                    	mov	ax,si
 24694 00000CAF 26C745160000            	mov	word [es:di+SYSI_CDS],0	; set address of CDS list
 24695                                  	;mov	[word es:di+16h],0
 24696                                  	;lds	si,[es:di+SYSI_DPB]	; (ds:si) = address of first DPB
 24697 00000CB5 26C535                  	lds	si,[es:di]
 24698 00000CB8 8EC0                    	mov	es,ax
 24699 00000CBA 31FF                    	xor	di,di			; (es:di) = address of 1st CDS
 24700                                  
 24701                                  ;*	Initialize our temporary CDSs. We'll init each CDS with the
 24702                                  ;	info from the corresponding DPB.
 24703                                  ;
 24704                                  ;	(cx) = count of CDSs left to process
 24705                                  ;	(es:di) = address of next CDS
 24706                                  
 24707                                  fooset:
 24708                                  	; 23/10/2022
 24709 00000CBC 2EA1[A902]              	mov	ax,[cs:DirStrng] ; "A:"
 24710 00000CC0 AB                      	stosw				; setup the root as the curdir
 24711                                  	
 24712                                  	; 23/10/2022 (MSDOS 5.0 SYSINIT)
 24713                                  	;call	get_dpb_for_drive_al	; get dpb for drive in dpb
 24714                                  
 24715                                  	; 30/12/2022
 24716                                  	; (MSDOS 6.21 SYSINIT:0D8Bh)
 24717 00000CC1 E85A00                  	call	get_dpb_for_drive_al	; get dpb for drive in dpb
 24718                                  
 24719                                  ;	(ds:si) = address of DPB
 24720                                  ;		 (si) = -1 if no drive
 24721                                  
 24722 00000CC4 2EA1[AB02]              	mov	ax,[cs:DirStrng+2] ; "\",0
 24723 00000CC8 AB                      	stosw
 24724 00000CC9 2EFE06[A902]            	inc	byte [cs:DirStrng]
 24725 00000CCE 31C0                    	xor	ax,ax ; 0
 24726 00000CD0 51                      	push	cx
 24727                                  	;mov	cx,curdir_list.cdir_flags - 4 ; 63
 24728 00000CD1 B93F00                  	mov	cx,63	; 23/10/2022
 24729 00000CD4 F3AA                    	rep	stosb			; zero out rest of CURDIR_TEXTs
 24730                                  
 24731                                  ;	should handle the system that does not have any floppies.
 24732                                  ;	in this case,we are going to pretended there are two dummy floppies
 24733                                  ;	in the system. still they have dpb and cds,but we are going to
 24734                                  ;	0 out curdir_flags,curdir_devptr of cds so ibmdos can issue
 24735                                  ;	"invalid drive specification" message when the user try to
 24736                                  ;	access them.
 24737                                  ;
 24738                                  ;	(ax) = 0
 24739                                  ;	(es:di) = CURDIR_FLAGS in the CDS records
 24740                                  ;	(ds:si) = Next DPB (-1 if none)
 24741                                  
 24742 00000CD6 83FEFF                  	cmp	si,-1	; cmp si,0FFFFh
 24743 00000CD9 7413                    	je	short fooset_zero	; don't have any physical drive.
 24744                                  
 24745                                  ;	check to see if we are faking floppy drives. if not go to normcds.
 24746                                  ;	if we are faking floppy drives then see if this cds being initialised
 24747                                  ;	is for drive a: or b: by checking the appropriate field in the dpb
 24748                                  ;	pointed to by ds:si. if not for a: or b: then go to normcds. if
 24749                                  ;	for a: or b: then execute the code given below starting at fooset_zero.
 24750                                  ;	for dpb offsets look at inc\dpb.inc.
 24751                                  	
 24752                                  	; 03/09/2023
 24753 00000CDB 41                      	inc	cx  ; cx = 1
 24754                                  
 24755 00000CDC 2E380E[8B02]            	cmp	[cs:fake_floppy_drv],cl ; 1 ; 03/09/2023
 24756                                  	;cmp	byte [cs:fake_floppy_drv],1
 24757 00000CE1 7512                    	jne	short normcds 		; machine has floppy drives
 24758                                  	;cmp	byte [si+DPB.drive],1	; if dpb_drive = 0 (a) or 1 (b).
 24759                                  	;cmp	byte [si],1
 24760 00000CE3 380C                    	cmp	[si],cl ; 1 ; 03/09/2023
 24761 00000CE5 770E                    	ja	short normcds
 24762 00000CE7 B103                    	mov	cl,3			; the next dbp pointer
 24763                                  					; AX should be zero here
 24764 00000CE9 F3AB                    	rep	stosw
 24765 00000CEB 59                      	pop	cx
 24766 00000CEC EB17                    	jmp	short get_next_dpb
 24767                                  
 24768                                  ;	(ax) = 0
 24769                                  
 24770                                  fooset_zero:
 24771 00000CEE B103                    	mov	cl,3
 24772 00000CF0 F3AB                    	rep	stosw
 24773 00000CF2 59                      	pop	cx
 24774 00000CF3 EB10                    	jmp	short fincds
 24775                                  
 24776                                  ;*	We have a "normal" DPB and thus a normal CDS.
 24777                                  ;
 24778                                  ;	(ax) = 0
 24779                                  ;	(es:di) = CURDIR_FLAGS in the CDS records
 24780                                  ;	(ds:si) = Next DPB (-1 if none)
 24781                                  
 24782                                  normcds:
 24783 00000CF5 59                      	pop	cx
 24784                                  
 24785                                  ;	if a non-fat based media is detected (by dpb.numberoffat == 0), then
 24786                                  ;	set curdir_flags to 0. this is for signaling ibmdos and ifsfunc that
 24787                                  ;	this media is a non-fat based one.
 24788                                  
 24789                                  	;cmp	byte [si+DPB.FAT_COUNT],0 ; non fat system?
 24790                                  	; 23/10/2022
 24791                                  	;cmp	byte [si+8],0
 24792                                  	; 03/09/2023 (ax=0)
 24793 00000CF6 384408                  	cmp	[si+8],al ; 0
 24794 00000CF9 7403                    	je	short setnormcds	; yes. set curdir_flags to 0. ax = 0 now.
 24795 00000CFB B80040                  	mov	ax,curdir_inuse ; 4000h	; else,fat system. set the flag to curdir_inuse.
 24796                                  	;mov	ax,4000h
 24797                                  setnormcds:
 24798 00000CFE AB                      	stosw				; curdir_flags
 24799 00000CFF 89F0                    	mov	ax,si
 24800 00000D01 AB                      	stosw				; curdir_devptr
 24801 00000D02 8CD8                    	mov	ax,ds
 24802 00000D04 AB                      	stosw
 24803                                  
 24804                                  get_next_dpb:				; entry point for fake_fooset_zero
 24805                                  	; 30/12/2022
 24806                                  	; (MSDOS 6.21 SYSINIT:0DD1h)
 24807                                  	; 23/10/2022
 24808                                  	;lds	si,[si+19h] ; (MSDOS 5.0 SYSINIT)
 24809                                  	;;lds	si,[si+DPB.NEXT_DPB] ; [si+19h]
 24810                                  fincds:	; get_next_dpb
 24811                                  	; 30/12/2022
 24812                                  	; (MSDOS 6.21 SYSINIT:0DD1h)
 24813 00000D05 B8FFFF                  	mov	ax,-1	; mov ax,0FFFFh
 24814 00000D08 AB                      	stosw				; curdir_id
 24815 00000D09 AB                      	stosw				; curdir_id
 24816 00000D0A AB                      	stosw				; curdir_user_word
 24817 00000D0B B80200                  	mov	ax,2
 24818 00000D0E AB                      	stosw				; curdir_end
 24819 00000D0F B000                    	mov	al,0			; clear out 7 bytes (curdir_type,
 24820 00000D11 AA                      	stosb
 24821 00000D12 AB                      	stosw				;  curdir_ifs_hdr,curdir_fsda)
 24822 00000D13 AB                      	stosw
 24823 00000D14 AB                      	stosw
 24824                                  
 24825 00000D15 E2A5                    	loop	fooset
 24826                                  	
 24827 00000D17 2EC606[A902]41          	mov	byte [cs:DirStrng],"A"	; "A:\"
 24828                                  	
 24829 00000D1D C3                      	retn
 24830                                  
 24831                                  ; ----------------------------------------------------------------------
 24832                                  ;***	get_dpb_for_drive_al -- lookup the DPB for drive in al
 24833                                  ;
 24834                                  ;	entry:
 24835                                  ;	   al == ASCII CAPS drive letter
 24836                                  ;
 24837                                  ;	exit:
 24838                                  ;	   ds:si -> DPB, or si = -1 if not found
 24839                                  ; ----------------------------------------------------------------------
 24840                                  
 24841                                  ; 30/12/2022
 24842                                  ; (MSDOS 6.21 SYSINIT:0DEAh)
 24843                                  ; 23/10/2022
 24844                                  ;%if 0
 24845                                  get_dpb_for_drive_al:
 24846 00000D1E 2EC536[6D02]            	lds	si,[cs:DOSINFO]		; point to first DPB
 24847                                  	;lds	si,[si+SYSI_DPB]	; (ds:si) = address of first DPB
 24848 00000D23 C534                    	lds	si,[si]
 24849 00000D25 2C41                    	sub	al,'A'
 24850                                  
 24851                                  get_dpb_for_drive_1:
 24852                                  	;cmp	al,[si+DPB.DRIVE]	; match?
 24853 00000D27 3A04                    	cmp	al,[si]
 24854 00000D29 7408                    	je	short got_dpb_for_drive	;  done if so
 24855                                  
 24856 00000D2B C57419                  	lds	si,[si+DPB.NEXT_DPB] ; [si+19h]
 24857 00000D2E 83FEFF                  	cmp	si,-1
 24858 00000D31 75F4                    	jne	short get_dpb_for_drive_1 ; loop until hit end of DPBs
 24859                                  
 24860                                  got_dpb_for_drive:
 24861 00000D33 C3                      	retn
 24862                                  ;%endif  ; 23/10/2022
 24863                                  
 24864                                  ;=======================================================================
 24865                                  
 24866                                  ;**	EndFile - Build DOS structures
 24867                                  ;
 24868                                  ; This procedure is called after the config.sys has been processed and
 24869                                  ; installable device drivers have been loaded (but before "install="
 24870                                  ; programs are loaded) to create the dos structures such as SFTs, buffers,
 24871                                  ; FCBs, CDSs, etc. It also loads the sysinit_base module in low memory
 24872                                  ; to allow for the safe EXECing of "install=" programs. All memory
 24873                                  ; above these structures is deallocated back to DOS.
 24874                                  ;
 24875                                  ;	ENTRY	?? BUGBUG
 24876                                  ;	EXIT	?? BUGBUG
 24877                                  ;	USES	?? BUGBUG
 24878                                  
 24879                                  ;=======================================================================
 24880                                  ; allocate files
 24881                                  ; ----------------------------------------------------------------------
 24882                                  
 24883                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 24884                                  	; (SYSINIT:0CCDh)
 24885                                  
 24886                                  	; 30/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 24887                                  	; (SYSINIT:0E00h)
 24888                                  endfile:
 24889                                  ; we are now setting up final cdss,buffers,files,fcss strings etc. we no
 24890                                  ; longer need the space taken by the temp stuff below confbot,so set alloclim
 24891                                  ; to confbot.
 24892                                  
 24893                                  ;	if this procedure has been called to take care of install= command,
 24894                                  ;	   then we have to save es,si registers.
 24895                                  
 24896                                  	; 11/12/2022
 24897                                  	; ds = cs
 24898                                  
 24899                                  	; 23/10/2022
 24900                                  	; 31/03/2019
 24901 00000D34 1E                      	push	ds
 24902                                  
 24903                                  	;;mov	ax,Bios_Data ; 0070h
 24904                                  	;mov	ax,KERNEL_SEGMENT ; 0070h
 24905                                  	; 21/10/2022
 24906 00000D35 B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 24907 00000D38 8ED8                    	mov	ds,ax
 24908                                  
 24909                                  	;cmp	word [052Fh],0
 24910 00000D3A 833E[A004]00            	cmp	word [multrk_flag],multrk_off1 ;=0,multrack= command entered?
 24911 00000D3F 7505                    	jne	short multrk_flag_done
 24912                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 24913                                  	;or	word [multrk_flag],multrk_on ; 80h  ; default will be on.
 24914                                  	; 12/12/2022
 24915 00000D41 800E[A004]80            	or	byte [multrk_flag],multrk_on ; 80h
 24916                                  multrk_flag_done:
 24917                                  	; 23/10/2022
 24918                                  	; 31/03/2019
 24919 00000D46 1F                      	pop	ds
 24920                                  
 24921                                  	; 11/12/2022
 24922                                  	; ds = cs
 24923                                  	;mov	ax,[top_of_cdss] ; mov ax,[CONFBOT]
 24924                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 24925                                  	; (SYSINIT:0E14h)
 24926 00000D47 A1[A302]                	mov	ax,[CONFBOT]
 24927 00000D4A A3[A502]                	mov	[ALLOCLIM],ax
 24928                                  	; 23/10/2022
 24929                                  	;mov	ax, [cs:top_of_cdss]
 24930                                  	;mov	[cs:ALLOCLIM], ax 
 24931                                  
 24932                                  	; 11/12/2022
 24933                                  	; ds = cs
 24934                                  	;push	cs
 24935                                  	;pop	ds
 24936                                  	
 24937                                  	;mov	ax,[CONFBOT]
 24938                                  	;mov	[ALLOCLIM],ax
 24939                                  
 24940 00000D4D E84F35                  	call	round
 24941                                  	; 11/12/2022
 24942                                  	; ds = cs
 24943 00000D50 A0[9F02]                	mov	al,[FILES]
 24944                                  	; 23/10/2022
 24945                                  	;mov	al,[cs:FILES]
 24946 00000D53 2C05                    	sub	al,5
 24947 00000D55 764B                    	jbe	short dofcbs
 24948                                  
 24949 00000D57 50                      	push	ax
 24950                                  	;mov	al,devmark_files ; 'F'
 24951 00000D58 B046                    	mov	al,'F'
 24952 00000D5A E86B07                  	call	setdevmark		; set devmark for sfts (files)
 24953 00000D5D 58                      	pop	ax
 24954 00000D5E 30E4                    	xor	ah,ah			; do not use cbw instruction!!!!!
 24955                                  					;  it does sign extend.
 24956                                  	; 11/12/2022mhhj.mnm
 24957                                  	; ds = cs
 24958 00000D60 8B1E[6203]              	mov	bx,[memlo]
 24959 00000D64 8B16[6403]              	mov	dx,[memhi]
 24960 00000D68 C53E[6D02]              	lds	di,[DOSINFO]		;get pointer to dos data
 24961                                  	; 23/10/2022
 24962                                  	;mov	bx,[cs:memlo]
 24963                                  	;mov	dx,[cs:memhi]
 24964                                  	;lds	di,[cs:DOSINFO]		
 24965                                  
 24966                                  	;lds	di,[di+SYSI_SFT]	;ds:bp points to sft
 24967 00000D6C C57D04                  	lds	di,[di+4]
 24968                                  
 24969                                  	;mov	[di+SF.SFLink],bx
 24970 00000D6F 891D                    	mov	[di],bx
 24971 00000D71 895502                  	mov	[di+SF.SFLink+2],dx	;set pointer to new sft
 24972                                  
 24973 00000D74 0E                      	push	cs
 24974 00000D75 1F                      	pop	ds
 24975                                  
 24976                                  	; 11/12/2022
 24977                                  	; ds = cs
 24978 00000D76 C43E[6203]              	les	di,[memlo]		;point to new sft
 24979                                  	; 23/10/2022
 24980                                  	;les	di,[cs:memlo]
 24981                                  
 24982                                  	;mov	word [es:di+SF.SFLink],-1
 24983 00000D7A 26C705FFFF              	mov	word [es:di],-1		; 0FFFFh
 24984                                  	;mov	[es:di+SF.SFCount],ax
 24985 00000D7F 26894504                	mov	[es:di+4],ax
 24986                                  	;mov	bl,SF_ENTRY.size ; 59
 24987 00000D83 B33B                    	mov	bl,59
 24988 00000D85 F6E3                    	mul	bl			;ax = number of bytes to clear
 24989 00000D87 89C1                    	mov	cx,ax
 24990                                  	; 11/12/2022
 24991                                  	; ds = cs
 24992 00000D89 0106[6203]              	add	[memlo],ax		;allocate memory
 24993                                  	; 23/10/2022
 24994                                  	;add	[cs:memlo],ax
 24995 00000D8D B80600                  	mov	ax,6
 24996                                  	; 11/12/2022
 24997 00000D90 0106[6203]              	add	[memlo],ax		;remember the header too
 24998                                  	;add	[cs:memlo],ax
 24999                                  	; 11/12/2022
 25000 00000D94 800E[ED14]02            	or	byte [setdevmarkflag],for_devmark ; 2
 25001                                  	; 23/10/2022
 25002                                  	;or	byte [cs:setdevmarkflag],2
 25003 00000D99 E80335                  	call	round			; check for mem error before the stosb
 25004 00000D9C 01C7                    	add	di,ax
 25005 00000D9E 31C0                    	xor	ax,ax
 25006 00000DA0 F3AA                    	rep	stosb			;clean out the stuff
 25007                                  
 25008                                  ; allocate fcbs
 25009                                  ; ----------------------------------------------------------------------
 25010                                  
 25011                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 25012                                  	; (SYSINIT:0D48h)
 25013                                  dofcbs:
 25014                                  	; 11/12/2022
 25015                                  	; ds = cs
 25016                                  	;push	cs
 25017                                  	;pop	ds
 25018 00000DA2 E8FA34                  	call	round
 25019                                  	;mov	al,devmark_fcbs	; 'X'	;='x'
 25020 00000DA5 B058                    	mov	al,'X'
 25021 00000DA7 E81E07                  	call	setdevmark
 25022                                  	; 11/12/2022
 25023                                  	; ds = cs
 25024 00000DAA A0[A002]                	mov	al,[FCBS]
 25025                                  	;mov	al,[cs:FCBS]
 25026 00000DAD 30E4                    	xor	ah,ah			; do not use cbw instruction!!!!!
 25027                                  					;  it does sign extend.
 25028                                  	; 11/12/2022
 25029 00000DAF 8B1E[6203]              	mov	bx,[memlo]
 25030 00000DB3 8B16[6403]              	mov	dx,[memhi]
 25031 00000DB7 C53E[6D02]              	lds	di,[DOSINFO]		;get pointer to dos data
 25032                                  	; 23/10/2022
 25033                                  	;mov	bx,[cs:memlo]
 25034                                  	;mov	dx,[cs:memhi]
 25035                                  	;lds	di,[cs:DOSINFO]
 25036                                  
 25037                                  	;mov	[di+SYSI_FCB],bx
 25038                                  	;mov	[di+SYSI_FCB+2],dx ;set pointer to new table
 25039                                  	; 23/10/2022
 25040 00000DBB 895D1A                  	mov	[di+1Ah],bx		; [di+SYSI_FCB]
 25041 00000DBE 89551C                  	mov	[di+1Ch],dx		; [di+SYSI_FCB+2]
 25042                                  
 25043 00000DC1 2E8A1E[A102]            	mov	bl,[cs:KEEP]
 25044 00000DC6 30FF                    	xor	bh,bh
 25045                                  	;mov	[di+SYSI_KEEP],bx
 25046 00000DC8 895D1E                  	mov	[di+1Eh],bx		; [di+SYSI_KEEP]	
 25047                                  
 25048 00000DCB 0E                      	push	cs
 25049 00000DCC 1F                      	pop	ds
 25050                                  	
 25051 00000DCD C43E[6203]              	les	di,[memlo]		; point to new table
 25052                                  	;mov	word [es:di+SF.SFLink],-1
 25053 00000DD1 26C705FFFF              	mov	word [es:di],-1
 25054                                  	;mov	[es:di+SF.SFCount],ax
 25055                                  	; 02/11/2022
 25056 00000DD6 26894504                	mov	[es:di+4],ax
 25057 00000DDA B339                    	mov	bl,SF_ENTRY.size ; 59
 25058 00000DDC 89C1                    	mov	cx,ax
 25059 00000DDE F6E3                    	mul	bl			; ax = number of bytes to clear
 25060 00000DE0 0106[6203]              	add	[memlo],ax		; allocate memory
 25061                                  	;mov	ax,6
 25062 00000DE4 B80600                  	mov	ax,SF.size-2 ; 6
 25063 00000DE7 0106[6203]              	add	[memlo],ax		; remember the header too
 25064                                  	;or	byte [setdevmarkflag],for_devmark ; 2
 25065 00000DEB 800E[ED14]02            	or	byte [setdevmarkflag],2
 25066 00000DF0 E8AC34                  	call	round			; check for mem error before the stosb
 25067 00000DF3 01C7                    	add	di,ax			; skip over header
 25068 00000DF5 B041                    	mov	al,'A'
 25069                                  fillloop:
 25070 00000DF7 51                      	push	cx			; save count
 25071 00000DF8 B93900                  	mov	cx,SF_ENTRY.size ; 59	; number of bytes to fill
 25072 00000DFB FC                      	cld
 25073 00000DFC F3AA                    	rep	stosb			; filled
 25074                                  
 25075                                  	;mov	word [es:di-(SF_ENTRY.size)+SF_ENTRY.sf_ref_count],0  ; [es:di-59]
 25076                                  	;mov	word [es:di-(SF_ENTRY.size)+SF_ENTRY.sf_position],0   ; [es:di-38]	
 25077                                  	;mov	word [es:di-(SF_ENTRY.size)+SF_ENTRY.sf_position+2],0 ; [es:di-36]
 25078                                  
 25079                                  	; 18/12/2022
 25080                                  	;cx = 0
 25081 00000DFE 26894DC7                	mov	[es:di-(SF_ENTRY.size)+SF_ENTRY.sf_ref_count],cx ;0  ; [es:di-59]
 25082 00000E02 26894DDC                	mov	[es:di-(SF_ENTRY.size)+SF_ENTRY.sf_position],cx ;0   ; [es:di-38]	
 25083 00000E06 26894DDE                	mov	[es:di-(SF_ENTRY.size)+SF_ENTRY.sf_position+2],cx ;0 ; [es:di-36]
 25084                                  	
 25085                                  	; 23/10/2022	
 25086                                  	;mov     word [es:di-3Bh],0
 25087                                  	;mov     word [es:di-26h],0
 25088                                  	;mov     word [es:di-24h],0
 25089                                  
 25090 00000E0A 59                      	pop	cx
 25091 00000E0B E2EA                    	loop	fillloop
 25092                                  
 25093                                  ; allocate buffers
 25094                                  ; ----------------------------------------------------------------------
 25095                                  
 25096                                  ; search through the list of media supported and allocate 3 buffers if the
 25097                                  ; capacity of the drive is > 360kb
 25098                                  
 25099                                  	; 18/12/2022
 25100                                  	; cx = 0
 25101 00000E0D 833E[9902]FF            	cmp	word [buffers],-1	; has buffers been already set?
 25102 00000E12 7403                    	je	short dodefaultbuff
 25103 00000E14 E98000                  	jmp	dobuff			; the user entered the buffers=.
 25104                                  
 25105                                  dodefaultbuff:
 25106                                  	; 18/12/2022
 25107 00000E17 890E[9B02]              	mov	[h_buffers],cx ; 0
 25108 00000E1B 41                      	inc	cx
 25109 00000E1C 41                      	inc	cx
 25110 00000E1D 890E[9902]              	mov	[buffers],cx ; 2	
 25111                                  	
 25112                                  	;mov	word [h_buffers],0	; default is no heuristic buffers.
 25113                                  	;mov	word [buffers],2	; default to 2 buffers
 25114                                  
 25115                                  	; 23/10/2022
 25116                                  	; 04/09/2023
 25117                                  	;push	ax
 25118                                  	;push	ds ; 26/03/2019
 25119                                  
 25120                                  	; 04/09/2023
 25121                                  	; ds = cs
 25122 00000E21 C42E[6D02]              	les	bp,[DOSINFO]		; search through the dpb's
 25123                                  	;les	bp,[cs:DOSINFO]
 25124                                  	;les	bp,[es:bp+SYSI_DPB]	; get first dpb
 25125                                  	; 11/12/2022
 25126 00000E25 26C46E00                	les	bp,[es:bp]
 25127                                  	; 23/10/2022
 25128                                  	;les	bp,[es:bp+0]	; ! (MSDOS 5.0 IO.SYS address compability) !	
 25129                                  
 25130                                  	; 04/09/2023
 25131                                  	; ds = cs
 25132                                  	;push	cs
 25133                                  	;pop	ds
 25134                                  ;SYSINIT:0DE2h:
 25135                                  nextdpb:				; test if the drive supports removeable media
 25136                                  	;mov	bl,[es:bp+DPB.drive]
 25137                                  	; 11/12/2022
 25138 00000E29 268A5E00                	mov	bl,[es:bp]
 25139                                  	; 23/10/2022
 25140                                  	;mov	bl,[es:bp+0]	; ! (MSDOS 5.0 IO.SYS address compability) !
 25141                                  
 25142                                  	;inc	bl
 25143                                  	; 18/12/2022
 25144 00000E2D 43                      	inc	bx
 25145                                  
 25146                                  	;mov	ax,(IOCTL<<8)|8
 25147 00000E2E B80844                  	mov	ax,4408h
 25148 00000E31 CD21                    	int	21h		; DOS - 2+ - IOCTL -
 25149                                  
 25150                                  ; ignore fixed disks
 25151                                  
 25152 00000E33 09C0                    	or	ax,ax			; ax is nonzero if disk is nonremoveable
 25153 00000E35 7534                    	jnz	short nosetbuf
 25154                                  
 25155                                  ; get parameters of drive
 25156                                  
 25157 00000E37 31DB                    	xor	bx,bx
 25158                                  	;;mov	bl,[es:bp+DPB.drive]
 25159                                  	; 11/12/2022
 25160 00000E39 268A5E00                	mov	bl,[es:bp]
 25161                                  	; 23/10/2022
 25162                                  	;mov	bl,[es:bp+0]	; ! (MSDOS 5.0 IO.SYS address compability) !
 25163                                  	
 25164                                  	;inc	bl
 25165                                  	; 18/12/2022
 25166 00000E3D 43                      	inc	bx
 25167                                  
 25168 00000E3E BA[6248]                	mov	dx,deviceparameters
 25169                                  	;mov	ax,(IOCTL<<8)|GENERIC_IOCTL
 25170 00000E41 B80D44                  	mov	ax,440Dh
 25171                                  	;mov	cx,(RAWIO<<8)|GET_DEVICE_PARAMETERS
 25172 00000E44 B96008                  	mov	cx,860h
 25173 00000E47 CD21                    	int	21h		; DOS - 2+ - IOCTL -
 25174 00000E49 7220                    	jc	short nosetbuf		; get next dpb if driver doesn't support
 25175                                  					; generic ioctl
 25176                                  ; determine capacity of drive
 25177                                  ; media capacity = #sectors * bytes/sector
 25178                                  
 25179                                  	;mov	bx,[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_TOTALSECTORS]
 25180                                  	; 23/10/2022
 25181 00000E4B 8B1E[7148]              	mov	bx,[deviceparameters+15] ; total sectors (16 bit)
 25182                                  	
 25183                                  ; to keep the magnitude of the media capacity within a word,
 25184                                  ; scale the sector size
 25185                                  ; (ie. 1 -> 512 bytes,2 -> 1024 bytes,...)
 25186                                  
 25187                                  	;mov	ax,[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_BYTESPERSECTOR]
 25188                                  	; 23/10/2022
 25189 00000E4F A1[6948]                	mov	ax,[deviceparameters+7] ; bytes per sector
 25190 00000E52 31D2                    	xor	dx,dx
 25191 00000E54 B90002                  	mov	cx,512
 25192 00000E57 F7F1                    	div	cx			; scale sector size in factor of
 25193                                  					; 512 bytes
 25194 00000E59 F7E3                    	mul	bx			; ax = #sectors * size factor
 25195 00000E5B 09D2                    	or	dx,dx			; just in case of large floppies
 25196 00000E5D 7505                    	jnz	short setbuf
 25197 00000E5F 3DD002                  	cmp	ax,720			; 720 sectors * size factor of 1
 25198 00000E62 7607                    	jbe	short nosetbuf
 25199                                  setbuf:
 25200                                  	; 18/12/2022
 25201                                  	; word [buffers] = 2
 25202 00000E64 C606[9902]03            	mov	byte [buffers],3
 25203                                  	;mov	word [buffers],3
 25204 00000E69 EB0D                    	jmp	short chk_memsize_for_buffers ; now check the memory size
 25205                                  					; for default buffer count
 25206                                  nosetbuf:
 25207                                  	; 23/10/2022
 25208                                  	;cmp	word [es:bp+DPB.NEXT_DPB],-1
 25209 00000E6B 26837E19FF              	cmp	word [es:bp+19h], -1 ; 0FFFFh
 25210 00000E70 7406                    	je	short chk_memsize_for_buffers
 25211                                  	;les	bp,[es:bp+DPB.NEXT_DPB] ; [es:bp+19h]
 25212 00000E72 26C46E19                	les	bp,[es:bp+19h]
 25213 00000E76 EBB1                    	jmp	short nextdpb
 25214                                  
 25215                                  ;from dos 3.3,the default number of buffers will be changed according to the
 25216                                  ;memory size too.
 25217                                  ; default buffers = 2
 25218                                  ; if diskette media > 360 kb,then default buffers = 3
 25219                                  ; if memory size > 128 kb (2000h para),then default buffers = 5
 25220                                  ; if memory size > 256 kb (4000h para),then default buffers = 10
 25221                                  ; if memory size > 512 kb (8000h para),then default buffers = 15.
 25222                                  
 25223                                  chk_memsize_for_buffers:
 25224                                  	; 18/12/2022
 25225                                  	;cmp	word [MEMORY_SIZE],2000h
 25226                                  	;jbe	short bufset
 25227                                  	;mov	word [buffers],5
 25228                                  	;cmp	word [MEMORY_SIZE],4000h
 25229                                  	;jbe	short bufset
 25230                                  	;mov	word [buffers],10
 25231                                  	;cmp	word [MEMORY_SIZE],8000h
 25232                                  	;jbe	short bufset
 25233                                  	;mov	word [buffers],15
 25234                                  
 25235                                  	; 18/12/2022
 25236                                  	; word [buffers] = 3 or 2
 25237 00000E78 BB[9902]                	mov	bx,buffers
 25238 00000E7B A1[9402]                	mov	ax,[MEMORY_SIZE]
 25239 00000E7E 48                      	dec	ax	; [MEMORY_SIZE] - 1
 25240                                  
 25241 00000E7F 80FC20                  	cmp	ah,20h	; ax >= 2000h ([MEMORY_SIZE] > 2000h) ; *
 25242 00000E82 7213                    	jb	short bufset
 25243 00000E84 C6070F                  	mov	byte [bx],15 ; [buffers] = 15 ; ***
 25244 00000E87 80FC80                  	cmp	ah,80h	; ax >= 8000h ([MEMORY_SIZE] > 8000h) ; ***
 25245 00000E8A 730B                    	jnb	short bufset
 25246 00000E8C C6070A                  	mov	byte [bx],10 ; [buffers] = 10 ; **
 25247 00000E8F 80FC40                  	cmp	ah,40h	; ax >= 4000h ([MEMORY_SIZE] > 4000h) ; **
 25248 00000E92 7303                    	jnb	short bufset
 25249 00000E94 C60705                  	mov	byte [bx],5  ; [buffers] = 5 ; *
 25250                                  bufset:
 25251                                  	; 23/10/2022
 25252                                  	; 26/03/2019
 25253                                  	; 04/09/2023
 25254                                  	;pop	ds
 25255                                  	;pop	ax
 25256                                  
 25257                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 25258                                  ;j.k. here we should put extended stuff and new allocation scheme!!!
 25259                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 25260                                  
 25261                                  ; 26/03/2019
 25262                                  
 25263                                  ;*******************************************************************************
 25264                                  ;									       *
 25265                                  ; function: actually allocate buffers in the memory and initialize it. 	       *
 25266                                  ; input :								       *
 25267                                  ;    memhi:memlo - start of the next available memory			       *
 25268                                  ;    buffers = number of buffers					       *
 25269                                  ;    h_buffers = number of secondary buffers				       *
 25270                                  ;									       *
 25271                                  ; output:								       *
 25272                                  ;	buffinfo.cache_count - # of caches to be installed.		       *
 25273                                  ;	buffinfo set.							       *
 25274                                  ;	bufferqueue set.						       *
 25275                                  ;									       *
 25276                                  ; subroutines to be called:						       *
 25277                                  ;									       *
 25278                                  ;*******************************************************************************
 25279                                  
 25280                                  	; 23/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 25281                                  	; (SYSINIT:0E60h)
 25282                                  dobuff:
 25283                                  	; ds = cs ; 31/03/2019
 25284                                  	; 23/10/2022
 25285                                  	;lds	bx,[cs:DOSINFO]	; ds:bx -> sysinitvar
 25286                                  	; 04/09/2023
 25287 00000E97 A1[9902]                	mov	ax,[buffers] ; 31/03/2019
 25288 00000E9A 8B0E[9B02]              	mov	cx,[h_buffers] ; *
 25289 00000E9E C51E[6D02]              	lds	bx,[DOSINFO]
 25290                                  	;mov	ax,[cs:buffers]	; set sysi_buffers
 25291                                  	;mov	[bx+SYSI_BUFFERS],ax ; [bx+3Fh]
 25292 00000EA2 89473F                  	mov	[bx+3Fh],ax
 25293                                  	; 04/09/2023
 25294                                  	;mov	ax,[cs:h_buffers]
 25295                                  	;;mov	[bx+SYSI_BUFFERS+2],ax ; [bx+41h]
 25296                                  	;mov	[bx+41h],ax
 25297                                  	; 04/09/2023
 25298 00000EA5 894F41                  	mov	[bx+41h],cx ; *
 25299 00000EA8 C55F12                  	lds	bx,[bx+12h]
 25300                                  	;lds	bx,[bx+SYSI_BUF] ; now,ds:bx -> buffinfo
 25301 00000EAB E8F133                  	call	round		; get [memhi]:[memlo]
 25302                                  	;mov	al,devmark_buf	; ='B'
 25303 00000EAE B042                    	mov	al,'B'	
 25304 00000EB0 E81506                  	call	setdevmark
 25305                                  
 25306                                  ;allocate buffers
 25307                                  
 25308 00000EB3 1E                      	push	ds			; save buffer info. ptr.
 25309 00000EB4 53                      	push	bx
 25310                                  
 25311 00000EB5 E85003                  	call	set_buffer
 25312                                  
 25313 00000EB8 5B                      	pop	bx
 25314 00000EB9 1F                      	pop	ds
 25315                                  
 25316                                  ;now set the secondary buffer if specified.
 25317                                  
 25318 00000EBA 2E833E[9B02]00          	cmp	word [cs:h_buffers],0
 25319 00000EC0 742D                    	je	short xif16
 25320 00000EC2 E8DA33                  	call	round
 25321                                  	; 23/10/2022
 25322 00000EC5 2E8B0E[6203]            	mov	cx,[cs:memlo]
 25323                                  	;mov	[bx+BUFFINF.Cache_ptr],cx  ; [bx+6]
 25324 00000ECA 894F06                  	mov	[bx+6],cx
 25325 00000ECD 2E8B0E[6403]            	mov	cx,[cs:memhi]
 25326                                  	;mov	[bx+BUFFINF.Cache_ptr+2],cx ; [bx+8]
 25327 00000ED2 894F08                  	mov	[bx+8],cx
 25328 00000ED5 2E8B0E[9B02]            	mov	cx,[cs:h_buffers]
 25329                                  	;mov	[bx+BUFFINF.Cache_count],cx ; [bx+10]
 25330 00000EDA 894F0A                  	mov	[bx+10],cx
 25331 00000EDD B80002                  	mov	ax,512			; 512 byte
 25332 00000EE0 F7E1                    	mul	cx
 25333 00000EE2 2EA3[6203]              	mov	[cs:memlo],ax
 25334                                  	;or	byte [cs:setdevmarkflag],for_devmark ; 2
 25335 00000EE6 2E800E[ED14]02          	or	byte [cs:setdevmarkflag],2
 25336 00000EEC E8B033                  	call	round
 25337                                  xif16:
 25338                                  
 25339                                  ; ----------------------------------------------------------------------
 25340                                  ; allocate cdss
 25341                                  ; ----------------------------------------------------------------------
 25342                                  
 25343                                  buf1:
 25344 00000EEF E8AD33                  	call	round
 25345                                  
 25346 00000EF2 50                      	push	ax
 25347                                  	; 23/10/2022
 25348                                  	;mov	ax,devmark_cds		;='L'
 25349 00000EF3 B84C00                  	mov	ax, 'L'
 25350 00000EF6 E8CF05                  	call	setdevmark
 25351 00000EF9 58                      	pop	ax
 25352                                  
 25353 00000EFA 2EC43E[6D02]            	les	di,[cs:DOSINFO]
 25354                                  	;mov	cl,[es:di+SYSI_NUMIO]
 25355 00000EFF 268A4D20                	mov	cl,[es:di+20h]
 25356 00000F03 2E3A0E[A202]            	cmp	cl,[cs:NUM_CDS]
 25357 00000F08 7305                    	jae	short gotncds 		; user setting must be at least numio
 25358 00000F0A 2E8A0E[A202]            	mov	cl,[cs:NUM_CDS]
 25359                                  gotncds:
 25360 00000F0F 30ED                    	xor	ch,ch
 25361                                  	;mov	[es:di+SYSI_NCDS],cl	; [es:di+33]
 25362 00000F11 26884D21                	mov	[es:di+21h],cl
 25363 00000F15 2EA1[6403]              	mov	ax,[cs:memhi]
 25364                                  	;mov	[es:di+SYSI_CDS+2],ax
 25365 00000F19 26894518                	mov	[es:di+18h],ax
 25366 00000F1D 2EA1[6203]              	mov	ax,[cs:memlo]
 25367                                  	;mov	[es:di+SYSI_CDS],ax
 25368 00000F21 26894516                	mov	[es:di+16h],ax
 25369 00000F25 88C8                    	mov	al,cl
 25370                                  	;mov	ah,curdirlen ; curdir_list.size
 25371 00000F27 B458                    	mov	ah,88
 25372 00000F29 F6E4                    	mul	ah
 25373 00000F2B E84D02                  	call	ParaRound
 25374 00000F2E 2E0106[6403]            	add	[cs:memhi],ax
 25375                                  
 25376                                  	;or	byte [cs:setdevmarkflag],for_devmark ; 2
 25377 00000F33 2E800E[ED14]02          	or	byte [cs:setdevmarkflag],2
 25378 00000F39 E86333                  	call	round			; check for mem error before initializing
 25379                                  	;lds	si,[es:di+SYSI_DPB] ; [es:di+0]
 25380 00000F3C 26C535                  	lds	si,[es:di]
 25381                                  	;les	di,[es:di+SYSI_CDS] ; [es:di+22]
 25382 00000F3F 26C47D16                	les	di,[es:di+16h]
 25383 00000F43 E876FD                  	call	fooset
 25384                                  
 25385                                  ; ----------------------------------------------------------------------
 25386                                  ; allocate space for internal stack
 25387                                  ; ----------------------------------------------------------------------
 25388                                  
 25389 00000F46 0E                      	push	cs
 25390 00000F47 1F                      	pop	ds
 25391                                  
 25392                                  ;	if the user did not entered stacks= command, as a default, do not install
 25393                                  ;	sytem stacks for pc1,pc xt,pc portable cases.
 25394                                  ;	otherwise,install it to the user specified value or to the default
 25395                                  ;	value of 9,128 for other systems.
 25396                                  
 25397 00000F48 833E[9002]FF            	cmp	word [stack_addr],-1 ; has the user entered "stacks=" command?
 25398 00000F4D 740E                    	je	short doinstallstack	; then install as specified by the user
 25399 00000F4F 803E[BC02]00            	cmp	byte [sys_scnd_model_byte],0 ; pc1,xt has the secondary model byte = 0
 25400 00000F54 7507                    	jne	short doinstallstack	; other model should have default stack of 9,128
 25401 00000F56 803E[BB02]FE            	cmp	byte [sys_model_byte],0FEh ; pc1, pc/xt or pc portable ?
 25402 00000F5B 736D                    	jae	short skipstack
 25403                                  doinstallstack:
 25404 00000F5D A1[8C02]                	mov	ax,[stack_count]	; stack_count = 0?
 25405 00000F60 09C0                    	or	ax,ax			; then, stack size must be 0 too.
 25406 00000F62 7466                    	jz	short skipstack		; don't install stack.
 25407                                  
 25408                                  ;	dynamic relocation of stack code.
 25409                                  
 25410 00000F64 E83833                  	call	round			; [memhi] = seg. for stack code
 25411                                  					; [memlo] = 0
 25412                                  
 25413                                  ; set devmark block into memory for mem command
 25414                                  ; devmark_id = 's' for stack
 25415                                  
 25416                                  	;mov	al,devmark_stk	;='S'
 25417                                  	; 23/10/2022
 25418 00000F67 B053                    	mov	al,'S'
 25419 00000F69 E85C05                  	call	setdevmark
 25420                                  
 25421 00000F6C A1[6403]                	mov	ax,[memhi]
 25422 00000F6F 8EC0                    	mov	es,ax		; es -> seg. the stack code is going to move.
 25423                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 25424                                  	; 11/12/2022
 25425                                  	; ds = cs
 25426                                  	;push	cs
 25427                                  	;pop	ds
 25428 00000F71 31F6                    	xor	si,si		; !!we know that stack code is at the beginning of sysinit.
 25429 00000F73 31FF                    	xor	di,di
 25430 00000F75 B9[6902]                	mov	cx,endstackcode
 25431 00000F78 890E[6203]              	mov	[memlo],cx
 25432 00000F7C E82033                  	call	round		; have enough space for relocation?
 25433 00000F7F F3A4                    	rep	movsb
 25434                                  
 25435 00000F81 1E                      	push	ds		; stick the location of the NextStack entry
 25436                                  	;;mov	ax,Bios_Data	; into the Win386 Instance Data tables
 25437                                  	;mov	ax,KERNEL_SEGMENT ; 70h
 25438                                  	; 21/10/2022
 25439 00000F82 B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 25440 00000F85 8ED8                    	mov	ds,ax
 25441 00000F87 C706[0208][1000]        	mov	word [NextStack],nextentry ; (8C0h for MSDOS 6.21 IO.SYS)
 25442 00000F8D 8C06[0408]              	mov	[NextStack+2],es	   ; (8C2h for MSDOS 6.21 IO.SYS)
 25443                                  
 25444 00000F91 2EA1[6203]              	mov	ax,[cs:memlo]
 25445 00000F95 2EA3[9002]              	mov	[cs:stack_addr],ax ; set for stack area initialization
 25446 00000F99 A3[0808]                	mov	[IT_StackLoc],ax  ; pass it as Instance Data, too
 25447 00000F9C 2EA1[6403]              	mov	ax,[cs:memhi]	 ; this will be used by stack_init routine.
 25448 00000FA0 2EA3[9202]              	mov	[cs:stack_addr+2],ax
 25449 00000FA4 A3[0A08]                	mov	[IT_StackLoc+2],ax
 25450                                  
 25451                                  ;	space for internal stack area = stack_count(entrysize + stack_size)
 25452                                  
 25453                                  	;mov	ax,entrysize ; mov ax,8
 25454                                  	; 23/10/2022
 25455 00000FA7 B80800                  	mov	ax,8
 25456 00000FAA 2E0306[8E02]            	add	ax,[cs:stack_size]
 25457 00000FAF 2EF726[8C02]            	mul	word [cs:stack_count]
 25458                                  
 25459 00000FB4 A3[0C08]                	mov	[IT_StackSize],ax ; pass through to Instance Tables
 25460                                  
 25461 00000FB7 1F                      	pop	ds		; no more need to access Instance Table
 25462                                  
 25463 00000FB8 E8C001                  	call	ParaRound	; convert size to paragraphs
 25464                                  	
 25465                                  	; 11/12/2022
 25466                                  	; ds = cs
 25467                                  	;add	[cs:memhi],ax
 25468 00000FBB 0106[6403]              	add	[memhi],ax
 25469                                  	;or	byte [cs:setdevmarkflag],for_devmark ; 2
 25470                                  	;or	byte [cs:setdevmarkflag],2
 25471 00000FBF 800E[ED14]02            	or	byte [setdevmarkflag],2
 25472                                  	;or	byte [setdevmarkflag],for_devmark ; 2
 25473                                  				; to set the devmark_size for stack by round routine.
 25474 00000FC4 E8D832                  	call	round		; check for memory error before
 25475                                  				; continuing
 25476 00000FC7 E8E502                  	call	stackinit	; initialize hardware stack. 
 25477                                  				; cs=ds=sysinitseg,es=relocated stack code & data
 25478                                  skipstack:
 25479                                  	; 24/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 25480                                  	; (SYSINIT:0F99h)
 25481                                  
 25482                                  	; 11/12/2022
 25483                                  	; ds = cs
 25484                                  	;push	cs
 25485                                  	;pop	ds
 25486                                  
 25487 00000FCA A0[9F02]                	mov	al,[FILES]
 25488 00000FCD 30E4                    	xor	ah,ah		; do not use cbw instruction!!!!!
 25489                                  				;  it does sign extend.
 25490 00000FCF 89C1                    	mov	cx,ax
 25491 00000FD1 31DB                    	xor	bx,bx		;close standard input
 25492 00000FD3 B43E                    	mov	ah,3Eh ; CLOSE
 25493 00000FD5 CD21                    	int	21h
 25494 00000FD7 BB0200                  	mov	bx,2
 25495                                  rcclloop:			;close everybody but standard output
 25496 00000FDA B43E                    	mov	ah,3Eh ; CLOSE	; need output so we can print message
 25497 00000FDC CD21                    	int	21h		; in case we can't get new one open.
 25498 00000FDE 43                      	inc	bx
 25499 00000FDF E2F9                    	loop	rcclloop
 25500                                  
 25501 00000FE1 BA[7245]                	mov	dx,condev
 25502 00000FE4 B002                    	mov	al,2
 25503 00000FE6 B43D                    	mov	ah,3Dh ; OPEN 	;open con for read/write
 25504 00000FE8 F9                      	stc			; set for possible int 24
 25505 00000FE9 CD21                    	int	21h
 25506 00000FEB 7305                    	jnc	short goaux
 25507 00000FED E8E534                  	call	badfil
 25508 00000FF0 EB13                    	jmp	short goaux2
 25509                                  goaux:	
 25510 00000FF2 50                      	push	ax
 25511 00000FF3 BB0100                  	mov	bx,1		;close standard output
 25512 00000FF6 B43E                    	mov	ah,3Eh ; CLOSE
 25513 00000FF8 CD21                    	int	21h
 25514 00000FFA 58                      	pop	ax
 25515                                  
 25516 00000FFB 89C3                    	mov	bx,ax		;new device handle
 25517 00000FFD B445                    	mov	ah,45h ; XDUP
 25518 00000FFF CD21                    	int	21h		;dup to 1,stdout
 25519 00001001 B445                    	mov	ah,45h ; XDUP
 25520 00001003 CD21                    	int	21h		;dup to 2,stderr
 25521                                  goaux2: 
 25522 00001005 BA[7645]                	mov	dx,auxdev
 25523 00001008 B002                    	mov	al,2		;read/write access
 25524 0000100A E8F934                  	call	open_dev
 25525                                  
 25526 0000100D BA[7A45]                	mov	dx,prndev
 25527 00001010 B001                    	mov	al,1		;write only
 25528 00001012 E8F134                  	call	open_dev
 25529                                  
 25530                                  ;global rearm command for shared interrupt devices attached in the system;
 25531                                  ;shared interrupt attachment has some problem when it issues interrupt
 25532                                  ;during a warm reboot. once the interrupt is presented by the attachment,
 25533                                  ;no further interrupts on that level will be presented until a global rearm
 25534                                  ;is issued. by the request of the system architecture group, msbio will
 25535                                  ;issue a global rearm after every device driver is loaded.
 25536                                  ;to issue a global rearm:	;for pc1,xt,palace
 25537                                  ;
 25538                                  ;			  out 02f2h,xx  ; interrupt level 2
 25539                                  ;			  out 02f3h,xx  ; interrupt level 3
 25540                                  ;			  out 02f4h,xx  ; interrupt level 4
 25541                                  ;			  out 02f5h,xx  ; interrupt level 5
 25542                                  ;			  out 02f6h,xx  ; interrupt level 6
 25543                                  ;			  out 02f7h,xx  ; interrupt level 7
 25544                                  ;
 25545                                  ;	for pc at,in addition to the above commands,
 25546                                  ;	need to handle the secondary interrupt handler
 25547                                  ;
 25548                                  ;			  out 06f2h,xx  ; interrupt level 10
 25549                                  ;			  out 06f3h,xx  ; interrupt level 11
 25550                                  ;			  out 06f4h,xx  ; interrupt level 12
 25551                                  ;			  out 06f6h,xx  ; interrupt level 14
 25552                                  ;			  out 06f7h,xx  ; interrupt level 15
 25553                                  ;
 25554                                  ;	for round-up machine
 25555                                  ;
 25556                                  ;			  none.
 25557                                  
 25558                                  ; where xx stands for any value.
 25559                                  ;
 25560                                  ; for your information,after naples level machine,the system service bios
 25561                                  ; call (int 15h),function ah=0c0h returns the system configuration parameters
 25562                                  
 25563                                  	; 24/10/2022
 25564                                  
 25565 00001015 50                      	push	ax
 25566 00001016 53                      	push	bx
 25567 00001017 52                      	push	dx
 25568 00001018 06                      	push	es
 25569                                  
 25570 00001019 B0FF                    	mov	al,0FFh 		;reset h/w by writing to port
 25571 0000101B BAF202                  	mov	dx,2F2h 		;get starting address
 25572 0000101E EE                      	out	dx,al			; out 02f2h,0ffh
 25573 0000101F 42                      	inc	dx
 25574 00001020 EE                      	out	dx,al			; out 02f3h,0ffh
 25575 00001021 42                      	inc	dx
 25576 00001022 EE                      	out	dx,al			; out 02f4h,0ffh
 25577 00001023 42                      	inc	dx
 25578 00001024 EE                      	out	dx,al			; out 02f5h,0ffh
 25579 00001025 42                      	inc	dx
 25580 00001026 EE                      	out	dx,al			; out 02f6h,0ffh
 25581 00001027 42                      	inc	dx
 25582 00001028 EE                      	out	dx,al			; out 02f7h,0ffh
 25583                                  
 25584                                  ;sb secondary global rearm
 25585                                  
 25586 00001029 B800F0                  	mov	ax,0F000h		;get machine type
 25587 0000102C 8EC0                    	mov	es,ax
 25588 0000102E 26803EFEFFFC            	cmp	byte [es:0FFFEh],0FCh ;q:is it a at type machine
 25589 00001034 740D                    	je	short startrearm	; *if at no need to check
 25590                                  
 25591 00001036 B4C0                    	mov	ah,0C0h 		;get system configuration
 25592 00001038 CD15                    	int	15h			; *
 25593 0000103A 7216                    	jc	short finishrearm	; *jmp if old rom
 25594                                  
 25595                                  ; test feature byte for secondary interrupt controller
 25596                                  
 25597 0000103C 26F6470540              	test	byte [es:bx+5],40h
 25598                                  	; 24/10/2022
 25599                                  	;test	byte [es:bx+ROMBIOS_DESC.bios_sd_featurebyte1],ScndIntController
 25600 00001041 740F                    	je	short finishrearm	;jmp if it is there
 25601                                  
 25602                                  startrearm:
 25603 00001043 B0FF                    	mov	al,0FFh 		;write any pattern to port
 25604 00001045 BAF206                  	mov	dx,6F2h 		;get starting address
 25605 00001048 EE                      	out	dx,al			;out 06f2h,0ffh
 25606 00001049 42                      	inc	dx			;bump address
 25607 0000104A EE                      	out	dx,al			;out 06f3h,0ffh
 25608 0000104B 42                      	inc	dx			;bump address
 25609 0000104C EE                      	out	dx,al			;out 06f4h,0ffh
 25610 0000104D 42                      	inc	dx			;bump address
 25611 0000104E 42                      	inc	dx			;bump address
 25612 0000104F EE                      	out	dx,al			;out 06f6h,0ffh
 25613 00001050 42                      	inc	dx			;bump address
 25614 00001051 EE                      	out	dx,al			;out 06f7h,0ffh
 25615                                  
 25616                                  finishrearm:
 25617 00001052 07                      	pop	es
 25618 00001053 5A                      	pop	dx
 25619 00001054 5B                      	pop	bx
 25620 00001055 58                      	pop	ax
 25621                                  
 25622                                  ;    global rearm end *******************
 25623                                  
 25624                                  ; ----------------------------------------------------------------------
 25625                                  ; allocate sysinit_base for install= command
 25626                                  ; ----------------------------------------------------------------------
 25627                                  ; sysinit_base allocation.
 25628                                  ;   check if endfile has been called to handle install= command.
 25629                                  
 25630                                  set_sysinit_base:
 25631                                  
 25632                                  ; ----------------------------------------------------------------------
 25633                                  ;sysinit_base will be established in the secure area of
 25634                                  ;lower memory when it handles the first install= command.
 25635                                  ;sysinit_base is the place where the actual exec function will be called and
 25636                                  ;will check sysinit module in high memory if it is damaged by the application
 25637                                  ;program.  if sysinit module has been broken,then "memory error..." message
 25638                                  ;is displayed by sysinit_base.
 25639                                  ; ----------------------------------------------------------------------
 25640                                  
 25641                                  	; 24/10/2022 - Retro DOS v4.0 (MSDOS 5.0 IO.SYS, SYSINIT)
 25642                                  	; (SYSINIT:1028h)
 25643                                  
 25644                                  	; 11/12/2022
 25645                                  	; ds = cs
 25646 00001056 50                      	push	ax			; set devmark for mem command
 25647 00001057 A1[6403]                	mov	ax,[memhi]
 25648 0000105A 2B06[6803]              	sub	ax,[area]
 25649 0000105E A3[6003]                	mov	[impossible_owner_size],ax ; remember the size in case.
 25650                                  	;mov	al,devmark_inst ; 'T'
 25651 00001061 B054                    	mov	al,'T'
 25652 00001063 E86204                  	call	setdevmark
 25653 00001066 58                      	pop	ax
 25654                                  
 25655 00001067 8B3E[6403]              	mov	di,[memhi]
 25656 0000106B 8EC7                    	mov	es,di
 25657 0000106D 893E[D402]              	mov	[sysinit_base_ptr+2],di ; save this entry for the next use.
 25658 00001071 31FF                    	xor	di,di
 25659 00001073 893E[D202]              	mov	[sysinit_base_ptr],di	; es:di -> destination.
 25660 00001077 BE[8711]                	mov	si,sysinit_base		; ds:si -> source code to be relocated.
 25661 0000107A B98100                  	mov	cx,end_sysinit_base-sysinit_base ; 129
 25662                                  	; 24/10/2022 
 25663                                  	;mov	cx,128	; 11DCh-115Ch 	; (MSDOS 5.0 IO.SYS, SYSINIT)
 25664 0000107D 010E[6203]              	add	[memlo],cx
 25665                                  	;or	byte cs:[setdevmarkflag],for_devmark ; 2
 25666                                  	; 11/12/2022
 25667                                  	; ds = cs
 25668                                  	;or	byte [cs:setdevmarkflag],2
 25669 00001081 800E[ED14]02            	or	byte [setdevmarkflag],2
 25670                                  	;or	byte [setdevmarkflag],for_devmark
 25671 00001086 E81632                  	call	round			; check mem error. also,readjust memhi for the next use.
 25672 00001089 F3A4                    	rep	movsb			; reallocate it.
 25673                                  
 25674 0000108B C706[D602][6E11]        	mov	word [sysinit_ptr],sysinitptr ; returning address from
 25675 00001091 8C0E[D802]              	mov	[sysinit_ptr+2],cs	 ; sysinit_base back to sysinit.
 25676                                  	;or	word [install_flag],has_installed ; set the flag.
 25677                                  	;or	byte [install_flag],has_installed ; 2
 25678                                  	; 11/12/2022
 25679 00001095 800E[CE02]02            	or	byte [install_flag],2
 25680                                  	; 24/10/2022
 25681                                  	;or	word [install_flag],2	
 25682                                  
 25683                                  ; ----------------------------------------------------------------------
 25684                                  ; free the rest of the memory from memhi to confbot. still from confbot to
 25685                                  ; the top of the memory will be allocated for sysinit and config.sys if
 25686                                  ; have_install_cmd.
 25687                                  ; ----------------------------------------------------------------------
 25688                                  
 25689 0000109A E80232                  	call	round
 25690 0000109D 8B1E[6403]              	mov	bx,[memhi]
 25691 000010A1 A1[6803]                	mov	ax,[area]
 25692 000010A4 A3[5E03]                	mov	[old_area],ax		; save [area]
 25693 000010A7 8EC0                    	mov	es,ax			;calc what we needed
 25694 000010A9 29C3                    	sub	bx,ax
 25695                                  	; 24/10/2022
 25696 000010AB B44A                    	mov	ah,4Ah ; SETBLOCK
 25697 000010AD CD21                    	int	21h			;give the rest back
 25698                                  		; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
 25699                                  		; ES = segment address of block to change
 25700                                  		; BX = new size in paragraphs
 25701 000010AF 06                      	push	es
 25702 000010B0 8CC0                    	mov	ax,es
 25703 000010B2 48                      	dec	ax
 25704 000010B3 8EC0                    	mov	es,ax			;point to arena
 25705                                  	;mov	word [es:ARENA.OWNER],8	;set impossible owner
 25706                                  	;;mov	word [es:ARENA.NAME],4453h	; System Data
 25707                                  	;mov	word [es:ARENA.NAME],'SD'	; System Data
 25708                                  	; 24/10/2022
 25709 000010B5 26C70601000800          	mov	word [es:1],8		;set impossible owner
 25710 000010BC 26C70608005344          	mov	word [es:8],'SD'	; System Data
 25711 000010C3 07                      	pop	es
 25712                                  
 25713 000010C4 BBFFFF                  	mov	bx,0FFFFh
 25714 000010C7 B448                    	mov	ah,48h ; ALLOC
 25715 000010C9 CD21                    	int	21h
 25716 000010CB B448                    	mov	ah,48h ; ALLOC
 25717 000010CD CD21                    	int	21h			; allocate the rest of the memory
 25718                                  		; DOS - 2+ - ALLOCATE MEMORY
 25719                                  		; BX = number of 16-byte paragraphs desired
 25720 000010CF A3[6403]                	mov	[memhi],ax		; start of the allocated memory
 25721 000010D2 C706[6203]0000          	mov	word [memlo],0		;  to be used next.
 25722                                  
 25723                                  ;;;; at this moment,memory from [memhi]:0 to top-of-the memory is
 25724                                  ;;;; allocated.
 25725                                  ;;;; to protect sysinit,confbot module (from confbot (or =alloclim at
 25726                                  ;;;; this time) to the top-of-the memory),here we are going to
 25727                                  ;;;; 1). "setblock" from memhi to confbot.
 25728                                  ;;;; 2). "alloc" from confbot to the top of the memory.
 25729                                  ;;;; 3). "free alloc memory" from memhi to confbot.
 25730                                  
 25731                                  ;memory allocation for sysinit,confbot module.
 25732                                  
 25733 000010D8 8EC0                    	mov	es,ax
 25734                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 25735                                  	; (SYSINIT:11DFh)
 25736 000010DA 8B1E[A302]              	mov	bx,[CONFBOT]
 25737                                  	; 24/10/2022
 25738                                  	;mov	bx,[top_of_cdss] ; mov bx,[confbot]
 25739 000010DE 29C3                    	sub	bx,ax			; confbot - memhi
 25740 000010E0 4B                      	dec	bx			; make a room for the memory block id.
 25741 000010E1 4B                      	dec	bx			; make sure!!!.
 25742 000010E2 B44A                    	mov	ah,4Ah ; SETBLOCK
 25743 000010E4 CD21                    	int	21h			; this will free (confbot to top of memory)
 25744                                  		; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
 25745                                  		; ES = segment address of block to change
 25746                                  		; BX = new size in paragraphs
 25747 000010E6 BBFFFF                  	mov	bx,0FFFFh
 25748 000010E9 B448                    	mov	ah,48h ; ALLOC
 25749 000010EB CD21                    	int	21h
 25750 000010ED B448                    	mov	ah,48h ; ALLOC
 25751 000010EF CD21                    	int	21h			; allocate (confbot to top of memory)
 25752                                  		; DOS - 2+ - ALLOCATE MEMORY
 25753                                  		; BX = number of 16-byte paragraphs desired
 25754 000010F1 A3[6803]                	mov	[area],ax		; save allocated memory segment.
 25755                                  					; need this to free this area for command.com.
 25756 000010F4 8E06[6403]              	mov	es,[memhi]
 25757 000010F8 B449                    	mov	ah,49h			; free allocated memory.
 25758 000010FA CD21                    	int	21h			; free (memhi to confbot(=area))
 25759                                  		; DOS - 2+ - FREE MEMORY
 25760                                  		; ES = segment address of area to be freed
 25761                                  endfile_ret:
 25762 000010FC C3                      	retn
 25763                                  
 25764                                  ; End of "EndFile" DOS structure configuration.
 25765                                  
 25766                                  ; ----------------------------------------------------------------------
 25767                                  ; 26/03/2019 - Retro DOS v4.0
 25768                                  ; 24/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS, SYSINIT)	
 25769                                  ; ----------------------------------------------------------------------
 25770                                  ; Do_Install_Exec
 25771                                  ;
 25772                                  ; This procedure is used to EXEC a program being loaded via the 
 25773                                  ; "install=" mechanism in config.sys. It does this by setting up
 25774                                  ; the parameters, and then jumping to sysinit_base, which has been
 25775                                  ; setup in low memory. When complete, sysinit_base will jump back
 25776                                  ; up to this procedure (if sysinit remains uncorrupted by the installed
 25777                                  ; program).
 25778                                  
 25779                                  ;SYSINIT:10CFh:
 25780                                  
 25781                                  do_install_exec:			; now,handles install= command.
 25782                                  
 25783 000010FD 56                      	push	si			; save si for config.sys again.
 25784                                  
 25785                                  ; we are going to call load/exec function.
 25786                                  ; set es:bx to the parameter block here;;;;;;;
 25787                                  ; set ds:dx to the asciiz string. remember that we already has 0
 25788                                  ; after the filename. so parameter starts after that. if next
 25789                                  ; character is a line feed (i.e. 10),then assume that the 0
 25790                                  ; we already encountered used to be a carrage return. in this
 25791                                  ; case,let's set the length to 0 which will be followed by
 25792                                  ; carridge return.
 25793                                  
 25794                                  ; es:si -> command line in config.sys. points to the first non blank
 25795                                  ;character after =.
 25796                                  
 25797 000010FE 06                      	push	es
 25798 000010FF 1E                      	push	ds
 25799 00001100 07                      	pop	es
 25800 00001101 1F                      	pop	ds			; es->sysinitseg,ds->confbot seg
 25801 00001102 89F2                    	mov	dx,si			; ds:dx->file name,0 in config.sys image.
 25802                                  
 25803 00001104 31C9                    	xor	cx,cx
 25804 00001106 FC                      	cld
 25805 00001107 2EC606[F102]20          	mov	byte [cs:ldexec_start],' ' ; clear out the parm area
 25806 0000110D BF[F202]                	mov	di,ldexec_parm
 25807                                  installfilename:			; skip the file name
 25808 00001110 AC                      	lodsb				; al = ds:si; si++
 25809                                  	; 05/09/2023
 25810 00001111 08C0                    	or	al,al
 25811                                  	;cmp	al,0
 25812 00001113 7402                    	je	short got_installparm
 25813 00001115 EBF9                    	jmp	short installfilename
 25814                                  got_installparm:			; copy the parameters to ldexec_parm
 25815 00001117 AC                      	lodsb
 25816 00001118 268805                  	mov	[es:di],al
 25817 0000111B 3C0A                    	cmp	al,lf	; cmp al,0Ah	; line feed?
 25818 0000111D 7405                    	je	short done_installparm
 25819 0000111F FEC1                    	inc	cl			; # of char. in the parm.
 25820 00001121 47                      	inc	di
 25821 00001122 EBF3                    	jmp	short got_installparm
 25822                                  done_installparm:
 25823 00001124 2E880E[F002]            	mov	byte [cs:ldexec_line],cl ; length of the parm.
 25824                                  	; 05/09/2023
 25825 00001129 08C9                    	or	cl,cl
 25826                                  	;cmp	cl,0			; if no parm,then
 25827 0000112B 7506                    	jne	short install_seg_set 	; let the parm area
 25828 0000112D 2EC606[F102]0D          	mov	byte [cs:ldexec_start],cr ; 0Dh 
 25829                                  					; starts with cr.
 25830                                  install_seg_set:
 25831                                  	; 05/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 25832 00001133 31DB                    	xor	bx, bx
 25833                                  	;mov	word [cs:0],0		; make a null environment segment
 25834 00001135 2E891F                  	mov	[cs:bx], bx ; 05/09/2023
 25835 00001138 8CC8                    	mov	ax,cs			; by overlap jmp instruction of sysinitseg.
 25836                                  
 25837                                  ;---------------------------------------------------M067----------------
 25838                                  ;
 25839                                  ; 	the environment pointer is made 0. so the current environment ptr.
 25840                                  ; 	will be the same as pdb_environ which after dosinit is 0.
 25841                                  ;
 25842                                  ; 	mov	cs:[instexe.exec0_environ],0 ; set the environment seg.
 25843                                  ;
 25844                                  ; 	instexe.exec0_environ need not be initialized to 0 above. It was
 25845                                  ; 	done as a fix for bug #529. The actual bug was in NLSFUNC and
 25846                                  ; 	was fixed. 
 25847                                  ;
 25848                                  ; ----------------------------------------------------------------------
 25849                                  
 25850                                  ;;ifdef MULTI_CONFIG
 25851                                  
 25852                                  ; If there's any environment data in "config_wrkseg", pass to app
 25853                                  
 25854                                  ; 30/12/2022 - Retro DOS v4.0 (Modified MSDOS 6.21 IO.SYS SYSINIT)
 25855                                  ; 24/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS SYSINIT)
 25856                                  ;%if 0
 25857 0000113A 89C1                    	mov	cx,ax ; *
 25858                                  	; 05/09/2023
 25859 0000113C 2E391E[E414]            	cmp	[cs:config_envlen],bx ; 0
 25860                                  	;cmp	word [cs:config_envlen],0
 25861 00001141 7405                    	je	short no_envdata2
 25862 00001143 2E8B0E[E614]            	mov	cx,[cs:config_wrkseg] ; *
 25863                                  no_envdata2:
 25864                                  ;;endif  ;MULTI_CONFIG
 25865                                  
 25866                                  ;%endif	; 24/10/2022
 25867                                  
 25868                                  	;mov	[cs:instexe.exec0_environ],cx ; set the environment seg.
 25869                                  	; 05/09/2023 (BugFix)
 25870                                  	; 24/10/2022
 25871 00001148 2E890E[4203]            	mov	[cs:iexec.environ],cx ; *
 25872                                  	; 02/11/2022
 25873                                  	;mov	[cs:iexec.environ],ax	; 05/09/2023
 25874                                  
 25875                                  	;mov	[cs:instexe.exec0_com_line+2],ax ; set the seg.
 25876 0000114D 2EA3[4603]              	mov	[cs:iexec.ldexec_line+2],ax
 25877                                  	;mov	[cs:instexe.exec0_5c_fcb+2],ax
 25878 00001151 2EA3[4A03]              	mov	[cs:iexec.ldexec_5c_fcb+2],ax
 25879                                  	;mov	[cs:instexe.exec0_6c_fcb+2],ax
 25880 00001155 2EA3[4E03]              	mov	[cs:iexec.ldexec_6c_fcb+2],ax
 25881 00001159 E86000                  	call	sum_up
 25882 0000115C 26A3[DA02]              	mov	[es:checksum],ax	; save the value of the sum
 25883 00001160 31C0                    	xor	ax,ax
 25884 00001162 B44B                    	mov	ah,4Bh ; EXEC		; load/exec
 25885 00001164 BB[4203]                	mov	bx,instexe		; es:bx -> parm block.
 25886 00001167 06                      	push	es			; save es,ds for load/exec
 25887 00001168 1E                      	push	ds			; these registers will be restored in sysinit_base.
 25888 00001169 2EFF2E[D202]            	jmp	far [cs:sysinit_base_ptr] ; jmp to sysinit_base to execute
 25889                                  					; load/exec function and check sum.
 25890                                  
 25891                                  ;----------------------------------------
 25892                                  
 25893                                  ;j.k. this is the returning address from sysinit_base.
 25894                                  
 25895                                  	; 24/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS SYSINIT)
 25896                                  
 25897                                  sysinitptr:				; returning far address from sysinit_base
 25898 0000116E 5E                      	pop	si			; restore si for config.sys file.
 25899 0000116F 06                      	push	es
 25900 00001170 1E                      	push	ds
 25901 00001171 07                      	pop	es
 25902 00001172 1F                      	pop	ds			; now ds - sysinitseg, es - confbot
 25903 00001173 7305                            jnc     short install_exit_ret
 25904                                  
 25905 00001175 56                      	push	si			; error in loading the file for install=.
 25906 00001176 E86033                  	call	badload 		; es:si-> path,filename,0.
 25907 00001179 5E                      	pop	si
 25908                                  
 25909                                  	; 24/10/2022
 25910                                  	;jmp	short sysinitptr_retn ; (MSDOS 5.0 IO.SYS, SYSINIT:1140h)
 25911                                  	; 11/12/2022
 25912                                  	; ds = cs
 25913                                  
 25914                                  	; 30/12/2022 - Retro DOS v4.2
 25915                                  	; (MSDOS 6.21 IO.SYS, SYSINIT:1283h)
 25916                                  
 25917                                  install_exit_ret:
 25918 0000117A C3                      	retn
 25919                                  
 25920                                  ; 30/12/2022 - Retro DOS v4.2
 25921                                  %if 0
 25922                                  install_exit_ret:
 25923                                  	;retn		; retn (MSDOS 6.21 IO.SYS, SYSINIT:1283h) ; 18/12/2022
 25924                                  
 25925                                  	; 24/10/2022 (MSDOS 5.0 IO.SYS SYSINIT)
 25926                                  ;SYSINIT:1142h:
 25927                                  	mov     ah,4Dh
 25928                                  	int     21h             ; DOS - 2+ - GET EXIT CODE OF SUBPROGRAM (WAIT)
 25929                                  	cmp     ah,3
 25930                                  	jz      short sysinitptr_retn
 25931                                  	call    error_line
 25932                                  	stc
 25933                                  sysinitptr_retn:	; (SYSINIT:114Fh)
 25934                                  	retn		
 25935                                  
 25936                                  %endif ; 24/10/2022
 25937                                  
 25938                                  ; ----------------------------------------------------------------------
 25939                                  
 25940                                  ;**	ParaRound - Round Up length to paragraph multiple
 25941                                  ;
 25942                                  ;	ParaRound rounds a byte count up to a multiple of 16, then divides
 25943                                  ;	by 16 yielding a "length in paragraphs" value.
 25944                                  ;
 25945                                  ;	ENTRY	(ax) = byte length
 25946                                  ;	EXIT	(ax) = rounded up length in paragraphs
 25947                                  ;	USES	ax, flags
 25948                                  
 25949                                  ParaRound:
 25950 0000117B 83C00F                  	add	ax,15
 25951 0000117E D1D8                    	rcr	ax,1
 25952 00001180 D1E8                    	shr	ax,1
 25953 00001182 D1E8                    	shr	ax,1
 25954 00001184 D1E8                    	shr	ax,1
 25955 00001186 C3                      	retn
 25956                                  
 25957                                  ; ----------------------------------------------------------------------
 25958                                  ; sysinit_base module.
 25959                                  ;
 25960                                  ; This module is relocated by the routine EndFile to a location in low
 25961                                  ; memory. It is then called by SYSINIT to perform the EXEC of programs
 25962                                  ; that are being loaded by the "install=" command. After the EXEC call
 25963                                  ; completes, this module performs a checksum on the SYSINIT code (at the
 25964                                  ; top of memory) to be sure that the EXECed program did not damage it.
 25965                                  ; If it did, then this module will print an error message and stop the
 25966                                  ; system. Otherwise, it returns control to SYSINIT.
 25967                                  ;
 25968                                  ;in: after relocation,
 25969                                  ;    ax = 4b00h - load and execute the program dos function.
 25970                                  ;    ds = confbot. segment of config.sys file image
 25971                                  ;    es = sysinitseg. segment of sysinit module itself.
 25972                                  ;    ds:dx = pointer to asciiz string of the path,filename to be executed.
 25973                                  ;    es:bx = pointer to a parameter block for load.
 25974                                  ;    SI_end (byte) - offset value of end of sysinit module label
 25975                                  ;    bigsize (word) - # of word from confbot to SI_end.
 25976                                  ;    chksum (word) - sum of every byte from confbot to SI_end in a
 25977                                  ;			word boundary moduler form.
 25978                                  ;    sysinit_ptr (dword ptr) - return address to sysinit module.
 25979                                  ;
 25980                                  ;note: sysinit should save necessary registers and when the control is back
 25981                                  
 25982                                  	; 24/10/2022
 25983                                  	; (SYSINIT:115Ch for MSDOS 5.0 SYSINIT)
 25984                                  sysinit_base:				
 25985 00001187 2E8C166200              	mov	[cs:sysinit_base_ss],ss	; save stack
 25986 0000118C 2E89266400              	mov	[cs:sysinit_base_sp],sp	
 25987 00001191 CD21                    	int	21h			; load/exec dos call.
 25988 00001193 2E8E166200              	mov	ss,[cs:sysinit_base_ss]	; restore stack
 25989 00001198 2E8B266400              	mov	sp,[cs:sysinit_base_sp]
 25990 0000119D 1F                      	pop	ds			; restore confbot seg
 25991 0000119E 07                      	pop	es			; restore sysinitseg
 25992 0000119F 7216                    	jc	short sysinit_base_end	; load/exec function failed.
 25993                                  					; at this time,i don't have to worry about
 25994                                  					; that sysinit module has been broken or not.
 25995 000011A1 E81800                  	call	sum_up			; otherwise,check if it is good.
 25996 000011A4 263906[DA02]            	cmp	[es:checksum],ax
 25997 000011A9 740C                    	je	short sysinit_base_end
 25998                                  
 25999                                  ;	memory broken. show "memory allocation error" message and stall.
 26000                                  
 26001 000011AB B409                    	mov	ah,9
 26002 000011AD 0E                      	push	cs
 26003 000011AE 1F                      	pop	ds
 26004                                  	; 30/12/2022
 26005                                  	; (MSDOS 6.21 IO.SYS, SYSINIT:12B8h)
 26006                                  	;mov	dx, 102
 26007 000011AF BA6600                  	mov	dx,mem_alloc_err_msgx-sysinit_base ; 65h (for MSDOS 5.0 SYSINIT)
 26008                                  					; 66h (for MSDOS 6.21 SYSINIT)
 26009 000011B2 CD21                    	int	21h
 26010                                  		; DOS - PRINT STRING
 26011                                  		; DS:DX -> string terminated by "$"
 26012                                  
 26013                                  	; 30/12/2022 - Retro DOS v4.2
 26014                                  stall:
 26015                                  	; 24/10/2022
 26016                                  _stall: 
 26017                                  	; 11/12/2022
 26018 000011B4 F4                      	hlt 
 26019                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 26020                                  	;hlt				;use HLT to minimize energy consumption
 26021 000011B5 EBFD                            jmp	short _stall
 26022                                  
 26023                                  sysinit_base_end: 
 26024 000011B7 26FF2E[D602]            	jmp	far [es:sysinit_ptr]	;return back to sysinit module
 26025                                  
 26026                                  ;-------------------------------------
 26027                                  
 26028                                  sum_up:
 26029                                  
 26030                                  ;in:   es - sysinitseg.
 26031                                  ;out:  ax - result
 26032                                  ;
 26033                                  ;remark: since this routine will only check starting from "locstack" to the end of
 26034                                  ;	 sysinit segment,the data area, and the current stack area are not
 26035                                  ;	 coverd. in this sense,this check sum routine only gives a minimal
 26036                                  ;	 gaurantee to be safe.
 26037                                  ;
 26038                                  ;first sum up confbot seg.
 26039                                  
 26040 000011BC 1E                      	push	ds
 26041                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 26042                                  	; (SYSINIT:12C6h)
 26043 000011BD 26A1[A302]              	mov	ax,[es:CONFBOT]
 26044                                  	; 24/10/2022
 26045                                  	;mov	ax,[es:top_of_cdss]
 26046 000011C1 8ED8                    	mov	ds,ax
 26047 000011C3 31F6                    	xor	si,si
 26048 000011C5 31C0                    	xor	ax,ax
 26049 000011C7 268B0E[D002]            	mov	cx,[es:config_size]	; if config_size has been broken,then this
 26050                                  					; whole test better fail.
 26051 000011CC D1E9                    	shr	cx,1			; make it a word count
 26052 000011CE 7406                    	jz	short sum_sys_code	; when config.sys file not exist.
 26053                                  sum1:
 26054 000011D0 0304                    	add	ax,[si]
 26055 000011D2 46                      	inc	si
 26056 000011D3 46                      	inc	si
 26057 000011D4 E2FA                    	loop	sum1
 26058                                  ;now,sum up sysinit module.
 26059                                  sum_sys_code:
 26060                                  	; 24/10/2022
 26061 000011D6 BED611                  	mov	si,locstack ; 5A6h (MSDOS 5.0 IO.SYS, SYSINIT)
 26062                                  			    ; 532h (MSDOS 6.21 IO.SYS, SYSINIT)
 26063                                  				        ; starting after the stack.  M069
 26064                                  					;  this does not cover the possible stack code!!!
 26065                                  	;;mov	cx,22688  ; for MSDOS 6.21 IO.SYS
 26066                                  	; 02/11/2022
 26067                                  	;mov	cx,3D20h  ; (15648) for MSDOS 5.0 IO.SYS (SYSINIT)	
 26068                                  	; 30/12/2022  
 26069 000011D9 B9[A04D]                	mov	cx,SI_end ; (22688) 	; SI_end is the label at the end of sysinit
 26070 000011DC 29F1                    	sub	cx,si			;  from after_checksum to SI_end
 26071 000011DE D1E9                    	shr	cx,1
 26072                                  sum2:
 26073 000011E0 260304                  	add	ax,[es:si]
 26074 000011E3 46                      	inc	si
 26075 000011E4 46                      	inc	si
 26076 000011E5 E2F9                    	loop	sum2
 26077 000011E7 1F                      	pop	ds
 26078 000011E8 C3                      	retn
 26079                                  
 26080                                  ; 24/10/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS, SYSINIT)
 26081                                  ; 30/12/2022 - Retro DOS 4.2 (Modified MSDOS 6.21 IO.SYS, SYSINIT)
 26082                                  ; (SYSINIT:12F2h)
 26083                                  
 26084                                  sysinit_base_ss equ $-sysinit_base  ; = 61 (MSDOS 5.0 IO.SYS, SYSINIT:115Ch)
 26085                                  ;SYSINIT:11BDh:			    ; = 62 (MSDOS 6.21 IO.SYS, SYSINIT:1290h) 	
 26086 000011E9 0000                    	dw	0
 26087                                  sysinit_base_sp equ $-sysinit_base  ; = 63 (MSDOS 5.0 IO.SYS, SYSINIT:1161h)
 26088                                  ;SYSINIT:11BFh:			    ; = 64 (MSDOS 6.21 IO.SYS, SYSINIT:1292h)
 26089 000011EB 0000                    	dw	0	
 26090                                  
 26091                                  mem_alloc_err_msgx:
 26092                                  
 26093                                         ;include msbio.cl4		; memory allocation error message
 26094                                  
 26095                                  ;SYSINIT:12F6:  ; MSDOS 6.21 IO.SYS SYSINIT:12F6h
 26096 000011ED 0D0A                    	db	0Dh,0Ah
 26097 000011EF 4D656D6F727920616C-     	db 	'Memory allocation error $'
 26097 000011F8 6C6F636174696F6E20-
 26097 00001201 6572726F722024     
 26098                                  
 26099                                  end_sysinit_base: ; label byte
 26100                                  	; 24/10/2022
 26101                                  	; (SYSINIT:11DCh for MSDOS 5.0 SYSINIT)
 26102                                  
 26103                                  ; ----------------------------------------------------------------------
 26104                                  ; Set_Buffer
 26105                                  ;
 26106                                  ;function: set buffers in the real memory.				  
 26107                                  ;	   lastly set the memhi,memlo for the next available free address.
 26108                                  ;
 26109                                  ;input:    ds:bx -> buffinfo.
 26110                                  ;	   [memhi]:[memlo = 0] = available space for the hash bucket.	  
 26111                                  ;	   singlebuffersize = buffer header size + sector size		  
 26112                                  ;
 26113                                  ;output:   buffers Queue established.	       				   
 26114                                  ;	   [memhi]:[memlo] = address of the next available free space.	   
 26115                                  ; ----------------------------------------------------------------------
 26116                                  
 26117                                  	; 25/10/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS, SYSINIT)
 26118                                  	; (SYSINIT:11DCh)
 26119                                  
 26120                                  set_buffer:
 26121 00001208 30D2                    	xor	dl,dl				; assume buffers not in HMA
 26122 0000120A E85500                  	call	GetBufferAddr
 26123 0000120D 7402                    	jz	short set_buff_1
 26124                                  	;mov	dl,1				; buffers in HMA
 26125                                  	; 17/09/2023
 26126 0000120F FEC2                    	inc	dl ; mov dl,1
 26127                                  set_buff_1:
 26128                                  	; 25/10/2022
 26129                                  	;mov	[bx+BUFFINF.Buff_Queue],di	; head of Buff Q
 26130 00001211 893F                    	mov	[bx],di
 26131                                  	;mov	[bx+BUFFINF.Buff_Queue+2],es
 26132 00001213 8C4702                  	mov	[bx+2],es
 26133                                  	;mov	word [bx+BUFFINF.Dirty_Buff_Count],0 ;set dirty_count to 0.
 26134 00001216 C747040000              	mov	word [bx+4],0
 26135                                  
 26136 0000121B 89F8                    	mov	ax,di
 26137 0000121D 2E8B0E[9902]            	mov	cx,[cs:buffers]
 26138 00001222 57                      	push	di				; remember first buffer
 26139                                  
 26140                                  ;	for each buffer
 26141                                  
 26142                                  nxt_buff:
 26143 00001223 E86100                  	call	set_buffer_info 		; set buf_link,buf_id...
 26144 00001226 89C7                    	mov	di,ax
 26145 00001228 E2F9                    	loop	nxt_buff
 26146                                  
 26147 0000122A 2E2B3E[9D02]            	sub	di,[cs:singlebuffersize]	; point to last buffer
 26148                                  
 26149 0000122F 59                      	pop	cx				; get first buffer
 26150                                  	;mov	[es:di+buffinfo.buf_next],cx	; last->next = first
 26151 00001230 26890D                  	mov	[es:di],cx
 26152 00001233 87CF                    	xchg	cx,di
 26153                                  	;mov	[es:di+buffinfo.buf_prev],cx	; first->prev = last
 26154                                  	; 25/10/2022
 26155 00001235 26894D02                	mov	[es:di+2],cx
 26156                                  
 26157 00001239 08D2                    	or	dl,dl				; In HMA ?
 26158 0000123B 7417                    	jz	short set_buff_2		; no
 26159                                  	;mov	byte [bx+BUFFINF.Buff_In_HMA],1
 26160 0000123D C6470C01                	mov	byte [bx+12],1
 26161 00001241 2EA1[6403]              	mov	ax,[cs:memhi]			; seg of scratch buff
 26162                                  	;mov	word [bx+BUFFINF.Lo_Mem_Buff],0	; offset of scratch buff is 0
 26163 00001245 C7470D0000              	mov	word [bx+13],0
 26164                                  	;mov	[bx+BUFFINF.Lo_Mem_Buff+2],ax
 26165 0000124A 89470F                  	mov	word [bx+15],ax
 26166 0000124D 2EA1[9D02]              	mov	ax,[cs:singlebuffersize]	; size of scratch buff
 26167                                  	;sub	ax,bufinsiz ; 20		; buffer head not required
 26168                                  	;; 05/09/2023
 26169                                  	;;sub	ax,24 ; bufinsiz		; (bufinsiz is 24 in PCDOS 7.1)
 26170 00001251 83E814                  	sub	ax,20
 26171                                  set_buff_2:
 26172 00001254 2E0106[6203]            	add	[cs:memlo],ax
 26173                                  	;or	byte [cs:setdevmarkflag],for_devmark ; 2
 26174 00001259 2E800E[ED14]02          	or	byte [cs:setdevmarkflag],2
 26175                                  	;call	round
 26176                                  	;retn
 26177                                  	; 12/12/2022
 26178 0000125F E93D30                  	jmp	round
 26179                                  
 26180                                  ; ----------------------------------------------------------------------
 26181                                  ; procedure : GetBufferAddr
 26182                                  ;
 26183                                  ;	      Gets the buffer address either in HMA or in Lo Mem
 26184                                  ;
 26185                                  ; returns in es:di the buffer adress
 26186                                  ; returns NZ if allocated in HMA
 26187                                  ; ----------------------------------------------------------------------
 26188                                  
 26189                                  	; 25/10/2022 
 26190                                  GetBufferAddr:
 26191 00001262 53                      	push	bx
 26192 00001263 52                      	push	dx
 26193 00001264 2EA1[9D02]              	mov	ax, [cs:singlebuffersize]
 26194 00001268 2EF726[9902]            	mul	word [cs:buffers]
 26195                                  	;add	ax,0Fh
 26196 0000126D 83C00F                  	add	ax,15 
 26197                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 26198                                  	;and	ax,~15	; 0FFF0h	; para round
 26199                                  	; 12/12/2022
 26200 00001270 24F0                    	and	al,~15	; 0F0h
 26201 00001272 89C3                    	mov	bx,ax
 26202 00001274 B8024A                  	mov	ax,4A02h
 26203                                  	;mov	ax,((multMULT<<8)+multMULTALLOCHMA)
 26204 00001277 CD2F                    	int	2Fh
 26205 00001279 83FFFF                  	cmp	di,0FFFFh
 26206 0000127C 7506                    	jne	short got_hma
 26207                                  
 26208                                  	;mov	di,0			; dont xor di,di Z flag needed
 26209                                  	; 05/09/2023
 26210                                  	; zf=1
 26211 0000127E 47                      	inc	di ; 0FFFFh -> 0
 26212                                  	; zf=1
 26213                                  	
 26214                                  	;zf=1
 26215                                  	;xor	di,di	; 25/10/2022
 26216                                  	;zf=1
 26217 0000127F 2E8E06[6403]            	mov	es,[cs:memhi]
 26218                                  got_hma:
 26219 00001284 5A                      	pop	dx
 26220 00001285 5B                      	pop	bx
 26221 00001286 C3                      	retn
 26222                                  
 26223                                  ; ----------------------------------------------------------------------
 26224                                  
 26225                                  set_buffer_info:
 26226                                  
 26227                                  ;function: set buf_link,buf_id,buf_sector
 26228                                  ;
 26229                                  ;in: es:di -> buffer header to be set.
 26230                                  ;    ax = di
 26231                                  ;
 26232                                  ;out:
 26233                                  ;    above entries set.
 26234                                  
 26235                                  	; 25/10/2022 
 26236 00001287 2EFF36[BD02]            	push	word [cs:buf_prev_off]
 26237                                  	;pop	word [es:di+buffinfo.buf_prev]
 26238 0000128C 268F4502                	pop	word [es:di+2]
 26239 00001290 2EA3[BD02]              	mov	[cs:buf_prev_off],ax
 26240 00001294 2E0306[9D02]            	add	ax,[cs:singlebuffersize]	; adjust ax
 26241                                  	;mov	[es:di+buffinfo.buf_next],ax
 26242 00001299 268905                  	mov	[es:di],ax
 26243                                  	;mov	word [es:di+buffinfo.buf_ID],00FFh  ; new buffer free
 26244 0000129C 26C74504FF00            	mov	word [es:di+4],00FFh
 26245                                  	;mov	word [es:di+buffinfo.buf_sector],0   ; to compensate the masm 3 bug
 26246 000012A2 26C745060000            	mov	word [es:di+6],0
 26247                                  	;mov	word [es:di+buffinfo.buf_sector+2],0 ; to compensate the masm 3 bug
 26248 000012A8 26C745080000            	mov	word [es:di+8],0
 26249 000012AE C3                      	retn
 26250                                  
 26251                                  ; ======================================================================
 26252                                  ; MSSTACK initialization routine - MSDOS 6.0 - SYSDINIT1.ASM - 1991
 26253                                  ; ----------------------------------------------------------------------
 26254                                  ; 27/03/2019 - Retro DOS v4.0
 26255                                  
 26256                                  ; ----------------------------------------------------------------------
 26257                                  ; ibmstack initialization routine.
 26258                                  ;
 26259                                  ;	to follow the standard interrupt sharing scheme, msstack.asm
 26260                                  ;	has been modified. this initialization routine also has to
 26261                                  ;	be modified because for the interrupt level 7 and 15, firstflag
 26262                                  ;	should be set to signal that this interrupt handler is the
 26263                                  ;	first handler hooked to this interrupt vector.
 26264                                  ;	we determine this by looking at the instruction pointed by
 26265                                  ;	this vector. if it is iret, then this handler should be the
 26266                                  ;	first one. in our case, only the interrupt vector 77h is the
 26267                                  ;	interrupt level 15. (we don't hook interrupt level 7.)
 26268                                  ;
 26269                                  ;	the followings are mainly due to m.r.t; ptm fix of p886 12/3/86
 26270                                  ;	some design changes are needed to the above interrupt sharing
 26271                                  ;	method. the above sharing scheme assumes that 1). interrupt
 26272                                  ;	sharing is never done on levels that have bios support. 2). "phantom"
 26273                                  ;	interrupts would only be generated on levels 7 and 15.
 26274                                  ;	these assumptions are not true any more. we have to use the firstflag
 26275                                  ;	for every level of interrupt. we will set the firstflag on the following
 26276                                  ;	conditions:
 26277                                  ;
 26278                                  ;	 a.	 if the cs portion of the vector is 0000, then "first"
 26279                                  ;	 b. else if cs:ip points to valid shared header, then not "first"
 26280                                  ;	 c. else if cs:ip points to an iret, then "first"
 26281                                  ;	 d. else if cs:ip points to dummy, then "first"
 26282                                  ;
 26283                                  ;	where dummy is - the cs portion must be f000, and the ip portion must
 26284                                  ;	be equal to the value at f000:ff01. this location is the initial value
 26285                                  ;	from vector_table for interrupt 7, one of the preserved addresses in all
 26286                                  ;	the bioses for all of the machines.
 26287                                  ;
 26288                                  ;	system design group requests bios to handle the phantom interrupts.
 26289                                  ;
 26290                                  ;	the "phantom" interrupt is an illegal interrupt such as an interrupt
 26291                                  ;	produced by the bogus adapter card even without interrupt request is
 26292                                  ;	set.  more specifically, 1). the 8259 has a feature when running in
 26293                                  ;	edge triggered mode to latch a pulse and present the interrupt when
 26294                                  ;	the processor indicates interrupt acknowledge (inta). the interrupt
 26295                                  ;	pulse was exist at the time of inta to get a "phantom" interrupt.
 26296                                  ;	2). or, this is caused by adapter cards placing a glitch on the
 26297                                  ;	interrupt line.
 26298                                  ;
 26299                                  ;	to handle those "phantom" interrupts, the main stack code will check
 26300                                  ;	the own firstflag, and if it is not "first" (which means the forward
 26301                                  ;	pointer points to the legal shared interrupt handler), then pass the
 26302                                  ;	control. if it is the first, then the following action should be
 26303                                  ;	taken. we don't have to implement stack logic in this case.
 26304                                  ;
 26305                                  ;	to implement this logic, we rather choose a simple method.
 26306                                  ;	if ont of the above "firstflag" conditions is met, we are not
 26307                                  ;	going to hook this interrupt vector. the reason is if the original
 26308                                  ;	vector points to "iret" and do nothing, we don't need
 26309                                  ;	to implement the stack logic for it. this will simplify implementation
 26310                                  ;	while maintaining compatibility with the old version of dos.
 26311                                  ;	this implies that in the main stack code, there might be a stack code
 26312                                  ;	that will never be used, a dead code.
 26313                                  ;
 26314                                  ;in - cs, ds -> sysinitseg, es -> relocated stack code & data.
 26315                                  
 26316                                  	; 25/10/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS, SYSINIT)
 26317                                  	; (SYSINIT:1287h)
 26318                                  
 26319                                  	; 14/12/2022
 26320                                  stackinit:
 26321 000012AF 50                      	push	ax
 26322 000012B0 1E                      	push	ds
 26323 000012B1 06                      	push	es
 26324 000012B2 53                      	push	bx
 26325 000012B3 51                      	push	cx
 26326 000012B4 52                      	push	dx
 26327 000012B5 57                      	push	di
 26328 000012B6 56                      	push	si
 26329 000012B7 55                      	push	bp
 26330                                  
 26331                                  ;currently es -> stack code area
 26332                                  
 26333                                  	; 12/12/2022
 26334                                  	; ds = cs
 26335 000012B8 A1[8C02]                	mov	ax,[stack_count]
 26336 000012BB 89C1                    	mov	cx,ax  ; *!*!*  
 26337                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 26338                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:1290h)
 26339                                  	;mov	ax,[cs:stack_count] ; !!	;defined in cs
 26340 000012BD 26A3[0200]              	mov	[es:stackcount],ax		;defined in stack code area
 26341                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:1298h)
 26342 000012C1 A1[8E02]                	mov	ax,[stack_size]	 ; !!		;in cs
 26343 000012C4 26A3[0600]              	mov	[es:stacksize],ax
 26344                                  	; 12/12/2022
 26345 000012C8 A1[9002]                	mov	ax,[stack_addr]			; offset
 26346                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 26347                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:129Fh)
 26348                                  	;mov	ax,[cs:stack_addr]  ; !!
 26349 000012CB 26A3[0800]              	mov	[es:stacks],ax
 26350                                  	; 12/12/2022
 26351 000012CF 89C5                    	mov	bp,ax ; *!*
 26352 000012D1 A1[9202]                	mov	ax,[stack_addr+2]
 26353                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 26354                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:129Fh)
 26355                                  	;mov	ax,[cs:stack_addr+2] ; !!	; segment
 26356 000012D4 26A3[0A00]              	mov	[es:stacks+2],ax
 26357                                  
 26358                                  ; initialize the data fields with the parameters
 26359                                  
 26360                                  ; "firstentry" will always be at stacks
 26361                                  
 26362                                  	;mov	bp,[es:stacks]			; get offset of stack
 26363                                  	; 12/12/2022
 26364                                  	; bp = [es:stacks] ; *!*
 26365 000012D8 26892E[0C00]            	mov	[es:firstentry],bp
 26366                                  
 26367                                  ; the stacks will always immediately follow the table entries
 26368                                  
 26369 000012DD B80800                  	mov	ax,entrysize ; 8
 26370                                  	;mov	cx,[es:stackcount]
 26371                                  	; 12/12/2022
 26372                                  	; cx = [es:stackcount] ; *!*!*
 26373 000012E0 F7E1                    	mul	cx
 26374 000012E2 01E8                    	add	ax,bp
 26375 000012E4 26A3[0400]              	mov	[es:stackat],ax
 26376 000012E8 89C3                    	mov	bx,ax
 26377 000012EA 83EB02                  	sub	bx,2
 26378                                  
 26379                                  ; zero the entire stack area to start with
 26380                                  
 26381 000012ED 268B3E[0400]            	mov	di,[es:stackat]
 26382 000012F2 26A1[0600]              	mov	ax,[es:stacksize]
 26383 000012F6 F7E1                    	mul	cx
 26384 000012F8 89C1                    	mov	cx,ax
 26385 000012FA 31C0                    	xor	ax,ax
 26386 000012FC 06                      	push	es
 26387 000012FD 1F                      	pop	ds				;ds = relocated stack code seg.
 26388                                  
 26389                                  ;now, ds -> stack code area
 26390                                  
 26391 000012FE 8E06[0A00]              	mov	es,[stacks+2]			; get segment of stack area.
 26392 00001302 FC                      	cld
 26393 00001303 F3AA                    	rep	stosb
 26394                                  
 26395 00001305 8B0E[0200]              	mov	cx,[stackcount]
 26396                                  
 26397                                  ; loop for "count" times, building a table entry
 26398                                  ;  cs = sysinitseg, ds = relocated stack code seg, es = segment of stack space
 26399                                  ;  cx = number of entries
 26400                                  ;  es:bp => base of stacks - 2
 26401                                  ;  es:bx => first table entry
 26402                                  
 26403                                  buildloop:
 26404                                  	; 11/12/2022
 26405                                  	;mov	byte [es:bp+allocbyte],free	; mov [es:bp+0],0
 26406                                  	; 25/10/2022
 26407                                  	;mov	byte [es:bp],free
 26408                                  	; 06/07/2023
 26409 00001309 26884600                	mov	[es:bp],al ; 0 ; free
 26410 0000130D 26884601                	mov	[es:bp+intlevel],al	; ax = 0
 26411                                  	;mov	[es:bp+1],al
 26412 00001311 26894602                	mov	[es:bp+savedsp],ax
 26413                                  	;mov	[es:bp2],ax
 26414 00001315 26894604                	mov	[es:bp+savedss],ax
 26415                                  	;mov	[es:bp+4],ax
 26416 00001319 031E[0600]              	add	bx,[stacksize]
 26417 0000131D 26895E06                	mov	[es:bp+newsp],bx		; mov [es:bp+6],bx
 26418                                  	;mov	[es:bp+6],bx
 26419 00001321 26892F                  	mov	[es:bx],bp
 26420 00001324 83C508                  	add	bp,entrysize ; 8
 26421                                  
 26422 00001327 E2E0                    	loop	buildloop
 26423                                  
 26424 00001329 83ED08                  	sub	bp,entrysize ; 8
 26425 0000132C 892E[0E00]              	mov	[lastentry],bp
 26426 00001330 892E[1000]              	mov	[nextentry],bp
 26427                                  
 26428 00001334 1E                      	push	ds
 26429                                  	;mov	ax,0F000h		;look at the model byte
 26430                                  	; 05/09/2023
 26431 00001335 B4F0                    	mov	ah,0F0h ; ax = 0F000h
 26432 00001337 8ED8                    	mov	ds,ax
 26433 00001339 803EFEFFF9              	cmp	byte [0FFFEh],0F9h ; mdl_convert ; convertible?
 26434 0000133E 1F                      	pop	ds
 26435 0000133F 7504                    	jne	short skip_disablenmis
 26436                                  
 26437 00001341 B007                    	mov	al,07h			; disable convertible nmis
 26438 00001343 E672                    	out	72h,al
 26439                                  
 26440                                  skip_disablenmis:
 26441 00001345 31C0                    	xor	ax,ax
 26442 00001347 8EC0                    	mov	es,ax			;es - segid of vector table at 0
 26443                                  					;ds - relocated stack code segment
 26444 00001349 FA                      	cli
 26445                                  
 26446                                  	;irp	aa,<02,08,09,70>
 26447                                  	;
 26448                                  	;mov	si,aa&h*4		;pass where vector is to be adjusted
 26449                                  	;mov	di,offset int19old&aa	;we have to set old&aa for int19 handler too.
 26450                                  	;mov	bx,offset old&aa	;pass where to save original owner pointer
 26451                                  	;mov	dx,offset int&aa	;pass where new handler is
 26452                                  	;call	new_init_loop		;adjust the vector to new handler,
 26453                                  	;				;saving pointer to original owner
 26454                                  	;endm
 26455                                  
 26456                                  stkinit_02:
 26457 0000134A BE0800                  	mov	si,02h*4 ; 8
 26458 0000134D BF[B305]                	mov	di,INT19OLD02
 26459 00001350 BB[1200]                	mov	bx,old02
 26460 00001353 BA[1600]                	mov	dx,int02
 26461 00001356 E84801                  	call	new_init_loop
 26462                                  stkinit_08:
 26463 00001359 BE2000                  	mov	si,08h*4 ; 32
 26464 0000135C BF[B805]                	mov	di,INT19OLD08
 26465 0000135F BB[3800]                	mov	bx,old08
 26466 00001362 BA[3C00]                	mov	dx,int08
 26467 00001365 E83901                  	call	new_init_loop
 26468                                  stkinit_09:
 26469 00001368 BE2400                  	mov	si,09h*4 ; 36
 26470 0000136B BF[BD05]                	mov	di,INT19OLD09
 26471 0000136E BB[4100]                	mov	bx,old09
 26472 00001371 BA[4500]                	mov	dx,int09
 26473 00001374 E82A01                  	call	new_init_loop
 26474                                  stkinit_70:
 26475 00001377 BEC001                  	mov	si,70h*4 ; 448
 26476 0000137A BF[DB05]                	mov	di,INT19OLD70
 26477 0000137D BB[4E00]                	mov	bx,old70
 26478 00001380 BA[5200]                	mov	dx,int70
 26479 00001383 E81B01                  	call	new_init_loop
 26480                                  
 26481                                  	;irp	aa,<0a,0b,0c,0d,0e,72,73,74,76,77> ;shared interrupts
 26482                                  	;
 26483                                  	;mov	si,aa&h*4		;pass where vector is to be adjusted
 26484                                  	;push	ds			;save relocated stack code segment
 26485                                  	;lds	bx, es:[si]		;ds:bx -> original interrupt handler
 26486                                  	;push	ds
 26487                                  	;pop	dx			;dx = segment value
 26488                                  	;	
 26489                                  	;cmp	dx,0
 26490                                  	;jz	int&aa&_first
 26491                                  	;
 26492                                  	;cmp	byte ptr ds:[bx],0cfh	;does vector point to an iret?
 26493                                  	;jz	int&aa&_first
 26494                                  	;
 26495                                  	;cmp	word ptr ds:[bx.6],424bh ;magic offset (see int&aa, msstack.inc)
 26496                                  	;jz	int&aa&_not_first
 26497                                  	;
 26498                                  	;cmp	dx,0f000h		;rom bios segment
 26499                                  	;jnz	int&aa&_not_first
 26500                                  	;
 26501                                  	;push	es
 26502                                  	;push	dx
 26503                                  	;mov	dx,0f000h
 26504                                  	;mov	es,dx
 26505                                  	;cmp	bx,word ptr es:0ff01h
 26506                                         	;pop	dx
 26507                                  	;pop	es
 26508                                  	;jz	int&aa&_first
 26509                                  	;
 26510                                  ;int&aa&_not_first:			;not the first. we are going to hook vector.
 26511                                  	;pop	ds
 26512                                  	;mov	di, offset int19old&aa	;we have to set old&aa for int19 handler too.
 26513                                  	;mov	bx, offset old&aa	;pass where to save original owner pointer
 26514                                  	;mov	dx, offset int&aa	;pass where new handler is
 26515                                  	;call	new_init_loop		;adjust the vector to new handler, saving
 26516                                  	;				;pointer to original owner.
 26517                                  	;jmp	short int&aa&_end
 26518                                  ;int&aa&_first:				;the first. don't have to hook stack code.
 26519                                  	;pop	ds
 26520                                  ;int&aa&_end:
 26521                                  	;
 26522                                  	;endm
 26523                                  
 26524                                  stkinit_0A:
 26525 00001386 BE2800                  	mov	si,0Ah*4 ; 40
 26526                                  	
 26527                                  ; 14/12/2022
 26528                                  %if 0	
 26529                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26530                                  	push	ds
 26531                                  	
 26532                                  	lds	bx,[es:si]
 26533                                  	push	ds
 26534                                  	pop	dx
 26535                                  		
 26536                                  	cmp	dx,0
 26537                                  	je	short int_0A_first
 26538                                  	
 26539                                  	cmp	byte [bx],0CFh
 26540                                  	je	short int_0A_first
 26541                                  	
 26542                                  	cmp	word [bx+6],424Bh
 26543                                  	je	short int_0A_not_first
 26544                                  	
 26545                                  	cmp	dx,0F000h
 26546                                  	jne	short int_0A_not_first
 26547                                  	
 26548                                  	push	es
 26549                                  	push	dx
 26550                                  	mov	dx,0F000h
 26551                                  	mov	es,dx
 26552                                  	cmp	bx,[es:0FF01h]
 26553                                         	pop	dx
 26554                                  	pop	es
 26555                                  	je	short int_0A_first
 26556                                  %Endif
 26557                                  
 26558                                  	; 14/12/2022
 26559                                  	; 25/10/2022
 26560 00001389 E8EB00                  	call	int_xx_first_check ; 27/03/2019 - Retro DOS v4.0
 26561 0000138C 730C                    	jnc	short int_0A_first
 26562                                  	
 26563                                  int_0A_not_first:
 26564                                  	; 14/12/2022
 26565                                  	; 25/10/2022
 26566                                  	;pop	ds
 26567 0000138E BF[C205]                	mov	di,INT19OLD0A
 26568 00001391 BB[5900]                	mov	bx,old0A
 26569 00001394 BA[5700]                	mov	dx,int0A
 26570 00001397 E80701                  	call	new_init_loop
 26571                                  	
 26572                                  	; 14/12/2022	
 26573                                  	;jmp	short int_0A_end
 26574                                  ;int_0A_first:
 26575                                  	; 25/10/2022
 26576                                  	;pop	ds
 26577                                  
 26578                                  	; 14/12/2022
 26579                                  int_0A_first:
 26580                                  int_0A_end:
 26581                                  
 26582                                  stkinit_0B:
 26583 0000139A BE2C00                  	mov	si,0Bh*4 ; 44
 26584                                  	
 26585                                  	; 14/12/2022
 26586                                  	; 25/10/2022
 26587 0000139D E8D700                  	call	int_xx_first_check ; 27/03/2019 - Retro DOS v4.0
 26588 000013A0 730C                    	jnc	short int_0B_end ; int_0B_first
 26589                                  
 26590                                  ; 14/12/2022
 26591                                  %if 0	
 26592                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26593                                  	push	ds
 26594                                  	lds	bx,[es:si]
 26595                                  	push	ds
 26596                                  	pop	dx
 26597                                  		
 26598                                  	cmp	dx,0
 26599                                  	je	short int_0B_first
 26600                                  
 26601                                  	cmp	byte [bx],0CFh
 26602                                  	je	short int_0B_first
 26603                                  	
 26604                                  	cmp	word [bx+6],424Bh
 26605                                  	je	short int_0B_not_first
 26606                                  	
 26607                                  	cmp	dx,0F000h
 26608                                  	jne	short int_0B_not_first
 26609                                  
 26610                                  	push	es
 26611                                  	push	dx
 26612                                  	mov	dx,0F000h
 26613                                  	mov	es,dx
 26614                                  	cmp	bx,[es:0FF01h]
 26615                                  	pop	dx
 26616                                  	pop	es
 26617                                  	je	short int_0B_first
 26618                                  %endif
 26619                                  
 26620                                  int_0B_not_first:
 26621                                  	; 14/12/2022
 26622                                  	; 25/10/2022
 26623                                  	;pop	ds
 26624 000013A2 BF[C705]                	mov	di,INT19OLD0B
 26625 000013A5 BB[7100]                	mov	bx,old0B
 26626 000013A8 BA[6F00]                	mov	dx,int0B
 26627 000013AB E8F300                  	call	new_init_loop
 26628                                  
 26629                                  	; 14/12/2022
 26630                                  	;jmp	short int_0B_end
 26631                                  ;int_0B_first:
 26632                                  	; 25/10/2022
 26633                                  	;pop	ds
 26634                                  
 26635                                  int_0B_end:
 26636                                  	
 26637                                  stkinit_0C:
 26638 000013AE BE3000                  	mov	si,0Ch*4 ; 48
 26639                                  	
 26640                                  	; 14/12/2022
 26641                                  	; 25/10/2022
 26642 000013B1 E8C300                  	call	int_xx_first_check
 26643 000013B4 730C                    	jnc	short int_0C_end ; int_0C_first
 26644                                  
 26645                                  ; 14/12/2022
 26646                                  %if 0	
 26647                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26648                                  	push	ds
 26649                                  	lds	bx,[es:si]
 26650                                  	push	ds
 26651                                  	pop	dx
 26652                                  		
 26653                                  	cmp	dx,0
 26654                                  	je	short int_0C_first
 26655                                  
 26656                                  	cmp	byte [bx],0CFh
 26657                                  	je	short int_0C_first
 26658                                  	
 26659                                  	cmp	word [bx+6],424Bh
 26660                                  	je	short int_0C_not_first
 26661                                  	
 26662                                  	cmp	dx,0F000h
 26663                                  	jne	short int_0C_not_first
 26664                                  
 26665                                  	push	es
 26666                                  	push	dx
 26667                                  	mov	dx,0F000h
 26668                                  	mov	es,dx
 26669                                  	cmp	bx,[es:0FF01h]
 26670                                  	pop	dx
 26671                                  	pop	es
 26672                                  	je	short int_0C_first
 26673                                  %endif
 26674                                  	
 26675                                  int_0C_not_first:
 26676                                  	; 14/12/2022
 26677                                  	; 25/10/2022
 26678                                  	;pop	ds
 26679 000013B6 BF[CC05]                	mov	di,INT19OLD0C
 26680 000013B9 BB[8900]                	mov	bx,old0C
 26681 000013BC BA[8700]                	mov	dx,int0C
 26682 000013BF E8DF00                  	call	new_init_loop
 26683                                  
 26684                                  	; 14/12/2022
 26685                                  	;jmp	short int_0C_end
 26686                                  ;int_0C_first:
 26687                                  	; 25/10/2022
 26688                                  	;pop	ds
 26689                                  
 26690                                  int_0C_end:
 26691                                  
 26692                                  stkinit_0D:
 26693 000013C2 BE3400                  	mov	si,0Dh*4 ; 52
 26694                                  
 26695                                  	; 14/12/2022	
 26696                                  	; 25/10/2022
 26697 000013C5 E8AF00                  	call	int_xx_first_check
 26698 000013C8 730C                    	jnc	short int_0D_end ; int_0D_first
 26699                                  
 26700                                  ; 14/12/2022
 26701                                  %if 0	
 26702                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26703                                  	push	ds
 26704                                  	lds	bx,[es:si]
 26705                                  	push	ds
 26706                                  	pop	dx
 26707                                  		
 26708                                  	cmp	dx,0
 26709                                  	je	short int_0D_first
 26710                                  
 26711                                  	cmp	byte [bx],0CFh
 26712                                  	je	short int_0D_first
 26713                                  	
 26714                                  	cmp	word [bx+6],424Bh
 26715                                  	je	short int_0D_not_first
 26716                                  	
 26717                                  	cmp	dx,0F000h
 26718                                  	jne	short int_0D_not_first
 26719                                  
 26720                                  	push	es
 26721                                  	push	dx
 26722                                  	mov	dx,0F000h
 26723                                  	mov	es,dx
 26724                                  	cmp	bx,[es:0FF01h]
 26725                                  	pop	dx
 26726                                  	pop	es
 26727                                  	je	short int_0D_first
 26728                                  %endif
 26729                                  	
 26730                                  int_0D_not_first:
 26731                                  	; 14/12/2022
 26732                                  	; 25/10/2022
 26733                                  	;pop	ds
 26734 000013CA BF[D105]                	mov	di,INT19OLD0D
 26735 000013CD BB[A100]                	mov	bx,old0D
 26736 000013D0 BA[9F00]                	mov	dx,int0D
 26737 000013D3 E8CB00                  	call	new_init_loop
 26738                                  
 26739                                  	; 14/12/2022
 26740                                  	;jmp	short int_0D_end
 26741                                  	; 02/11/2022
 26742                                  ;int_0D_first:
 26743                                  	;pop	ds
 26744                                  
 26745                                  int_0D_end:
 26746                                  
 26747                                  stkinit_0E:
 26748 000013D6 BE3800                  	mov	si,0Eh*4 ; 56
 26749                                  
 26750                                  	; 14/12/2022	
 26751                                  	; 25/10/2022
 26752 000013D9 E89B00                  	call	int_xx_first_check
 26753 000013DC 730C                    	jnc	short int_0E_end ; int_0E_first
 26754                                  
 26755                                  ; 14/12/2022
 26756                                  %if 0	
 26757                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26758                                  	push	ds
 26759                                  	lds	bx,[es:si]
 26760                                  	push	ds
 26761                                  	pop	dx
 26762                                  		
 26763                                  	cmp	dx,0
 26764                                  	je	short int_0E_first
 26765                                  
 26766                                  	cmp	byte [bx],0CFh
 26767                                  	je	short int_0E_first
 26768                                  	
 26769                                  	cmp	word [bx+6],424Bh
 26770                                  	je	short int_0E_not_first
 26771                                  	
 26772                                  	cmp	dx,0F000h
 26773                                  	jne	short int_0E_not_first
 26774                                  
 26775                                  	push	es
 26776                                  	push	dx
 26777                                  	mov	dx,0F000h
 26778                                  	mov	es,dx
 26779                                  	cmp	bx,[es:0FF01h]
 26780                                  	pop	dx
 26781                                  	pop	es
 26782                                  	je	short int_0E_first
 26783                                  %endif
 26784                                  	
 26785                                  int_0E_not_first:
 26786                                  	; 14/12/2022
 26787                                  	; 25/10/2022
 26788                                  	;pop	ds
 26789 000013DE BF[D605]                	mov	di,INT19OLD0E
 26790 000013E1 BB[B900]                	mov	bx,old0E
 26791 000013E4 BA[B700]                	mov	dx,int0E
 26792 000013E7 E8B700                  	call	new_init_loop
 26793                                  
 26794                                  	; 14/12/2022
 26795                                  	;jmp	short int_0E_end
 26796                                  ;int_0E_first:
 26797                                  	; 25/10/2022
 26798                                  	;pop	ds	
 26799                                  
 26800                                  int_0E_end:
 26801                                  
 26802                                  stkinit_72:
 26803 000013EA BEC801                  	mov	si,72h*4 ; 456
 26804                                  	
 26805                                  	; 14/12/2022
 26806                                  	; 25/10/2022
 26807 000013ED E88700                  	call	int_xx_first_check
 26808 000013F0 730C                    	jnc	short int_72_end ; int_72_first
 26809                                  
 26810                                  ; 14/12/2022
 26811                                  %if 0	
 26812                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26813                                  	push	ds
 26814                                  	lds	bx,[es:si]
 26815                                  	push	ds
 26816                                  	pop	dx
 26817                                  		
 26818                                  	cmp	dx,0
 26819                                  	je	short int_72_first
 26820                                  
 26821                                  	cmp	byte [bx],0CFh
 26822                                  	je	short int_72_first
 26823                                  	
 26824                                  	cmp	word [bx+6],424Bh
 26825                                  	je	short int_72_not_first
 26826                                  	
 26827                                  	cmp	dx,0F000h
 26828                                  	jne	short int_72_not_first
 26829                                  
 26830                                  	push	es
 26831                                  	push	dx
 26832                                  	mov	dx,0F000h
 26833                                  	mov	es,dx
 26834                                  	cmp	bx,[es:0FF01h]
 26835                                  	pop	dx
 26836                                  	pop	es
 26837                                  	je	short int_72_first
 26838                                  %endif
 26839                                  	
 26840                                  int_72_not_first:
 26841                                  	; 14/12/2022
 26842                                  	; 25/10/2022
 26843                                  	;pop	ds
 26844 000013F2 BF[E005]                	mov	di,INT19OLD72
 26845 000013F5 BB[D100]                	mov	bx,old72
 26846 000013F8 BA[CF00]                	mov	dx,int72
 26847 000013FB E8A300                  	call	new_init_loop
 26848                                  
 26849                                  	; 14/12/2022
 26850                                  	;jmp	short int_72_end
 26851                                  ;int_72_first:
 26852                                  	; 25/10/2022
 26853                                  	;pop	ds
 26854                                  
 26855                                  int_72_end:
 26856                                  
 26857                                  stkinit_73:
 26858 000013FE BECC01                  	mov	si,73h*4 ; 460
 26859                                  	
 26860                                  	; 14/12/2022
 26861                                  	; 25/10/2022
 26862 00001401 E87300                  	call	int_xx_first_check
 26863 00001404 730C                    	jnc	short int_73_end ; int_73_first
 26864                                  
 26865                                  ; 14/12/2022
 26866                                  %if 0	
 26867                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26868                                  	push	ds
 26869                                  	lds	bx,[es:si]
 26870                                  	push	ds
 26871                                  	pop	dx
 26872                                  		
 26873                                  	cmp	dx,0
 26874                                  	je	short int_73_first
 26875                                  
 26876                                  	cmp	byte [bx],0CFh
 26877                                  	je	short int_73_first
 26878                                  	
 26879                                  	cmp	word [bx+6],424Bh
 26880                                  	je	short int_73_not_first
 26881                                  	
 26882                                  	cmp	dx,0F000h
 26883                                  	jne	short int_73_not_first
 26884                                  
 26885                                  	push	es
 26886                                  	push	dx
 26887                                  	mov	dx,0F000h
 26888                                  	mov	es,dx
 26889                                  	cmp	bx,[es:0FF01h]
 26890                                  	pop	dx
 26891                                  	pop	es
 26892                                  	je	short int_73_first
 26893                                  %endif	
 26894                                  	
 26895                                  int_73_not_first:
 26896                                  	; 14/12/2022
 26897                                  	; 25/10/2022
 26898                                  	;pop	ds
 26899 00001406 BF[E505]                	mov	di,INT19OLD73
 26900 00001409 BB[E900]                	mov	bx,old73
 26901 0000140C BA[E700]                	mov	dx,int73
 26902 0000140F E88F00                  	call	new_init_loop
 26903                                  
 26904                                  	; 14/12/2022
 26905                                  	;jmp	short int_73_end
 26906                                  ;int_73_first:
 26907                                  	; 25/10/2022
 26908                                  	;pop	ds
 26909                                  
 26910                                  int_73_end:
 26911                                  
 26912                                  stkinit_74:
 26913 00001412 BED001                  	mov	si,74h*4 ; 464
 26914                                  	
 26915                                  	; 14/12/2022
 26916                                  	; 25/10/2022
 26917 00001415 E85F00                  	call	int_xx_first_check
 26918 00001418 730C                    	jnc	short int_74_end ; int_74_first
 26919                                  
 26920                                  ; 14/12/2022
 26921                                  %if 0		
 26922                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26923                                  	push	ds
 26924                                  	lds	bx,[es:si]
 26925                                  	push	ds
 26926                                  	pop	dx
 26927                                  		
 26928                                  	cmp	dx,0
 26929                                  	je	short int_74_first
 26930                                  
 26931                                  	cmp	byte [bx],0CFh
 26932                                  	je	short int_74_first
 26933                                  	
 26934                                  	cmp	word [bx+6],424Bh
 26935                                  	je	short int_74_not_first
 26936                                  	
 26937                                  	cmp	dx,0F000h
 26938                                  	jne	short int_74_not_first
 26939                                  
 26940                                  	push	es
 26941                                  	push	dx
 26942                                  	mov	dx,0F000h
 26943                                  	mov	es,dx
 26944                                  	cmp	bx,[es:0FF01h]
 26945                                  	pop	dx
 26946                                  	pop	es
 26947                                  	je	short int_74_first
 26948                                  %endif
 26949                                  
 26950                                  int_74_not_first:
 26951                                  	; 14/12/2022
 26952                                  	; 25/10/2022
 26953                                  	;pop	ds
 26954 0000141A BF[EA05]                	mov	di,INT19OLD74
 26955 0000141D BB[0101]                	mov	bx,old74
 26956 00001420 BA[FF00]                	mov	dx,int74
 26957 00001423 E87B00                  	call	new_init_loop
 26958                                  	
 26959                                  	; 14/12/2022
 26960                                  	;jmp	short int_74_end
 26961                                  ;int_74_first:
 26962                                  	; 25/10/2022
 26963                                  	;pop	ds
 26964                                  
 26965                                  int_74_end:
 26966                                  
 26967                                  stkinit_76:
 26968 00001426 BED801                  	mov	si,76h*4 ; 472
 26969                                  	
 26970                                  	; 14/12/2022
 26971                                  	; 25/10/2022
 26972 00001429 E84B00                  	call	int_xx_first_check
 26973 0000142C 730E                    	jnc	short int_76_end ; int_76_first
 26974                                  
 26975                                  ; 14/12/2022
 26976                                  %if 0	
 26977                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 26978                                  	push	ds
 26979                                  	lds	bx,[es:si]
 26980                                  	push	ds
 26981                                  	pop	dx
 26982                                  		
 26983                                  	cmp	dx,0
 26984                                  	je	short int_76_first
 26985                                  
 26986                                  	cmp	byte [bx],0CFh
 26987                                  	je	short int_76_first
 26988                                  	
 26989                                  	cmp	word [bx+6],424Bh
 26990                                  	je	short int_76_not_first
 26991                                  	
 26992                                  	cmp	dx,0F000h
 26993                                  	jne	short int_76_not_first
 26994                                  
 26995                                  	push	es
 26996                                  	push	dx
 26997                                  	mov	dx,0F000h
 26998                                  	mov	es,dx
 26999                                  	cmp	bx,[es:0FF01h]
 27000                                  	pop	dx
 27001                                  	pop	es
 27002                                  	je	short int_76_first
 27003                                  %endif
 27004                                  	
 27005                                  int_76_not_first:
 27006                                  	; 14/12/2022
 27007                                  	; 25/10/2022
 27008                                  	;pop	ds
 27009 0000142E BF[EF05]                	mov	di,INT19OLD76
 27010 00001431 BB[1901]                	mov	bx,old76
 27011 00001434 BA[1701]                	mov	dx,int76
 27012 00001437 E86700                  	call	new_init_loop
 27013                                  
 27014                                  	; 14/12/2022
 27015 0000143A EB00                    	jmp	short int_76_end
 27016                                  ;int_76_first:
 27017                                  	; 25/10/2022
 27018                                  	;pop	ds
 27019                                  
 27020                                  int_76_end:
 27021                                  
 27022                                  stkinit_77:
 27023 0000143C BEDC01                  	mov	si,77h*4 ; 476
 27024                                  	
 27025                                  	; 14/12/2022
 27026                                  	; 25/10/2022
 27027 0000143F E83500                  	call	int_xx_first_check
 27028 00001442 730C                    	jnc	short int_77_end ; int_77_first
 27029                                  
 27030                                  ; 14/12/2022
 27031                                  %if 0	
 27032                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 27033                                  	push	ds
 27034                                  	lds	bx,[es:si]
 27035                                  	push	ds
 27036                                  	pop	dx
 27037                                  		
 27038                                  	cmp	dx,0
 27039                                  	je	short int_77_first
 27040                                  
 27041                                  	cmp	byte [bx],0CFh
 27042                                  	je	short int_77_first
 27043                                  	
 27044                                  	cmp	word [bx+6],424Bh
 27045                                  	je	short int_77_not_first
 27046                                  	
 27047                                  	cmp	dx,0F000h
 27048                                  	jne	short int_77_not_first
 27049                                  
 27050                                  	push	es
 27051                                  	push	dx
 27052                                  	mov	dx,0F000h
 27053                                  	mov	es,dx
 27054                                  	cmp	bx,[es:0FF01h]
 27055                                  	pop	dx
 27056                                  	pop	es
 27057                                  	je	short int_77_first
 27058                                  %endif
 27059                                  	
 27060                                  int_77_not_first:
 27061                                  	; 14/12/2022
 27062                                  	; 25/10/2022
 27063                                  	;pop	ds
 27064 00001444 BF[F405]                	mov	di,INT19OLD77
 27065 00001447 BB[3101]                	mov	bx,old77
 27066 0000144A BA[2F01]                	mov	dx,int77
 27067 0000144D E85100                  	call	new_init_loop
 27068                                  
 27069                                  	; 14/12/2022
 27070                                  	;jmp	short int_77_end
 27071                                  ;int_77_first:
 27072                                  	; 25/10/2022
 27073                                  	;pop	ds
 27074                                  
 27075                                  int_77_end:
 27076 00001450 1E                      	push	ds
 27077 00001451 B800F0                  	mov	ax,0F000h		; look at the model byte
 27078 00001454 8ED8                    	mov	ds,ax
 27079 00001456 803EFEFFF9              	cmp	byte [0FFFEh],0F9h ; mdl_convert ; pc convertible?
 27080 0000145B 1F                      	pop	ds
 27081 0000145C 7504                    	jne	short skip_enablenmis
 27082                                  
 27083 0000145E B027                    	mov	al,27h			; enable convertible nmis
 27084 00001460 E672                    	out	72h,al
 27085                                  
 27086                                  ; 25/10/2022
 27087                                  ; (MSDOS 5.0 SYSINIT:15FBh)
 27088                                  
 27089                                  skip_enablenmis:
 27090 00001462 FB                      	sti
 27091                                  	;;mov	ax,Bios_Data ; 70h
 27092                                  	;mov	ax,KERNEL_SEGMENT ; 70h
 27093                                  	; 21/10/2022
 27094 00001463 B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 27095 00001466 8ED8                    	mov	ds,ax
 27096                                  
 27097                                  	;mov	[640h],1 ; SYSINIT:1736h for MSDOS 6.21 IO.SYS
 27098                                  
 27099 00001468 C606[B105]01            	mov	byte [INT19SEM],1	; indicate that int 19h
 27100                                  					; initialization is complete
 27101                                  
 27102 0000146D 5D                      	pop	bp			; restore all
 27103 0000146E 5E                      	pop	si
 27104 0000146F 5F                      	pop	di
 27105 00001470 5A                      	pop	dx
 27106 00001471 59                      	pop	cx
 27107 00001472 5B                      	pop	bx
 27108 00001473 07                      	pop	es
 27109 00001474 1F                      	pop	ds
 27110 00001475 58                      	pop	ax
 27111 00001476 C3                      	retn
 27112                                  
 27113                                  ; 14/12/2022
 27114                                  ; ----------------------------------------------------------------------
 27115                                  
 27116                                  	; 14/12/2022
 27117                                  	; 25/10/2022
 27118                                  ;%if 0
 27119                                  	; 27/03/2019 - Retro DOS v4.0
 27120                                  int_xx_first_check:
 27121 00001477 1E                      	push	ds
 27122 00001478 26C51C                  	lds	bx,[es:si]
 27123 0000147B 1E                      	push	ds
 27124 0000147C 5A                      	pop	dx
 27125                                  		
 27126                                  	;cmp	dx,0
 27127                                  	;je	short int_xx_first
 27128                                  	; 05/09/2023
 27129 0000147D 21D2                    	and	dx,dx
 27130 0000147F 741E                    	jz	short int_xx_first	
 27131                                  
 27132 00001481 803FCF                  	cmp	byte [bx],0CFh
 27133 00001484 7419                    	je	short int_xx_first
 27134                                  	
 27135 00001486 817F064B42              	cmp	word [bx+6],424Bh
 27136 0000148B 7411                    	je	short int_xx_not_first
 27137                                  	
 27138 0000148D 81FA00F0                	cmp	dx,0F000h
 27139 00001491 750B                    	jne	short int_xx_not_first
 27140                                  
 27141 00001493 06                      	push	es
 27142                                  	;push	dx
 27143                                  	;mov	dx,0F000h
 27144 00001494 8EC2                    	mov	es,dx
 27145 00001496 263B1E01FF              	cmp	bx,[es:0FF01h]
 27146                                        	;pop	dx
 27147 0000149B 07                      	pop	es
 27148 0000149C 7401                    	je	short int_xx_first
 27149                                  
 27150                                  int_xx_not_first:
 27151 0000149E F9                      	stc
 27152                                  int_xx_first:
 27153 0000149F 1F                      	pop	ds
 27154 000014A0 C3                      	retn
 27155                                  
 27156                                  ;%endif
 27157                                  
 27158                                  ; ----------------------------------------------------------------------
 27159                                  ; 27/03/2019 - Retro DOS v4.0
 27160                                  
 27161                                  ; 25/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS, SYSINIT)
 27162                                  ; (SYSINIT:1610h)
 27163                                  
 27164                                  new_init_loop:
 27165                                  
 27166                                  ;input: si=ofset into vector table of the particular int vector being adjusted
 27167                                  ;	bx=ds:offset of oldxx, where will be saved the pointer to original owner
 27168                                  ;	dx=ds:offset of intxx, the new interrupt handler
 27169                                  ;	di=offset value of int19old&aa variable in bios.
 27170                                  ;	es=zero, segid of vector table
 27171                                  ;	ds=relocated stack code segment
 27172                                  
 27173 000014A1 268B04                  	mov	ax,[es:si]		;remember offset in vector
 27174 000014A4 8907                    	mov	[bx],ax			; to original owner in ds
 27175 000014A6 268B4402                	mov	ax,[es:si+2]		;remember segid in vector
 27176 000014AA 894702                  	mov	[bx+2],ax		; to original owner in ds
 27177                                  
 27178 000014AD 1E                      	push	ds
 27179                                  	;;mov	ax,Bios_Data ; 70h
 27180                                  	;mov	ax,KERNEL_SEGMENT ; 70h
 27181                                  	; 21/10/2022
 27182 000014AE B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 27183 000014B1 8ED8                    	mov	ds,ax			;set int19oldxx value in bios for
 27184 000014B3 268B04                  	mov	ax,[es:si]		;int 19 handler
 27185 000014B6 8905                    	mov	[di],ax
 27186 000014B8 268B4402                	mov	ax,[es:si+2]
 27187 000014BC 894502                  	mov	[di+2],ax
 27188 000014BF 1F                      	pop	ds
 27189                                  
 27190 000014C0 268914                  	mov	[es:si],dx  	;set vector to point to new int handler
 27191 000014C3 268C5C02                	mov	[es:si+2],ds
 27192 000014C7 C3                      	retn
 27193                                  
 27194                                  ; End of STACK initialization routine
 27195                                  ; ----------------------------------------------------------------------
 27196                                  
 27197                                  ; ----------------------------------------------------------------------
 27198                                  ;set the devmark for mem command.
 27199                                  ;in: [memhi] - the address to place devmark
 27200                                  ;    [memlo] = 0
 27201                                  ;    al = id for devmark_id
 27202                                  ;out: devmark established.
 27203                                  ;     the address saved in cs:[devmark_addr]
 27204                                  ;     [memhi] increase by 1.
 27205                                  ; ----------------------------------------------------------------------
 27206                                  
 27207                                  ; 25/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS, SYSINIT)
 27208                                  ; (SYSINIT:1637h)
 27209                                  ; 04/09/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS, SYSINIT)
 27210                                  ; (SYSINIT:176Ch)
 27211                                  
 27212                                  ; 04/09/2023 - PCDOS 7.1 - IBMBIO.COM (SYSINIT:1944h)
 27213                                  
 27214                                  setdevmark:
 27215                                  
 27216                                  	; 04/09/2023
 27217                                  	;push	es
 27218                                  	;push	cx
 27219                                  
 27220 000014C8 2E8B0E[6403]            	mov	cx,[cs:memhi]
 27221 000014CD 2E890E[EB14]            	mov	[cs:devmark_addr],cx
 27222 000014D2 8EC1                    	mov	es,cx
 27223                                  	; 25/10/2022
 27224                                  	;mov	[es:devmark.id],al
 27225 000014D4 26A20000                	mov	[es:0],al
 27226 000014D8 41                      	inc	cx
 27227                                  	;mov	[es:devmark.seg],cx
 27228 000014D9 26890E0100              	mov	[es:1],cx
 27229                                  
 27230                                  	; 04/09/2023
 27231                                  	;pop	cx
 27232                                  	;pop	es
 27233                                  	
 27234 000014DE 2EFF06[6403]            	inc	word [cs:memhi]
 27235 000014E3 C3                      	retn
 27236                                  
 27237                                  ; ----------------------------------------------------------------------
 27238                                  ; SYSCONF.ASM - MSDOS 6.0 - 1991
 27239                                  ; ----------------------------------------------------------------------
 27240                                  ; 27/03/2019 - Retro DOS v4.0
 27241                                  
 27242                                  ;MULTI_CONFIG	equ 1
 27243                                  
 27244                                  HIGH_FIRST 	equ 080h		; from ARENA.INC - modifier for
 27245                                                                          ; allocation strategy call
 27246                                  
 27247                                  ;have_install_cmd equ 00000001b 	; config.sys has install= commands
 27248                                  ;has_installed	  equ 00000010b 	; sysinit_base installed.
 27249                                  
 27250                                  default_filenum equ 8
 27251                                  
 27252                                  ;stacksw	equ true		; include switchable hardware stacks
 27253                                  
 27254                                  ; external variable defined in ibmbio module for multi-track
 27255                                  
 27256                                  ;multrk_on	equ 10000000b		;user spcified mutitrack=on,or system turns
 27257                                  					; it on after handling config.sys file as a
 27258                                  					; default value,if multrk_flag = multrk_off1.
 27259                                  ;multrk_off1	equ 00000000b		;initial value. no "multitrack=" command entered.
 27260                                  ;multrk_off2	equ 00000001b		;user specified multitrack=off.
 27261                                  
 27262                                  ; if stacksw
 27263                                  
 27264                                  ; internal stack parameters
 27265                                  
 27266                                  ;entrysize	equ 8
 27267                                  
 27268                                  ;mincount	equ 8
 27269                                  ;defaultcount	equ 9
 27270                                  ;maxcount	equ 64
 27271                                  
 27272                                  ;minsize 	equ 32
 27273                                  ;defaultsize	equ 128
 27274                                  ;maxsize 	equ 512
 27275                                  
 27276                                  DOS_FLAG_OFFSET	equ 86h
 27277                                  
 27278                                  ;ifdef MULTI_CONFIG
 27279                                  ;
 27280                                  ;   config_envlen must immediately precede config_wrkseg, because they
 27281                                  ;   may be loaded as a dword ptr
 27282                                  
 27283                                  ; 30/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 27284                                  ; 25/10/2022
 27285 000014E4 0000                    config_envlen:	dw  0  			; when config_wrkseg is being used as
 27286                                                 				;  a scratch env, this is its length
 27287 000014E6 0000                    config_wrkseg:	dw  0			; config work area (above confbot)
 27288                                                     			;  segment of work area
 27289                                  
 27290 000014E8 00                      config_cmd:	db  0  			; current config cmd
 27291                                                   			;  (with CONFIG_OPTION_QUERY bit intact)
 27292 000014E9 00                      config_multi:	db  0                   ; non-zero if multi-config config.sys
 27293                                  
 27294                                  ;endif ; MULTI_CONFIG
 27295                                  
 27296 000014EA 00                      multdeviceflag:	db  0
 27297                                  
 27298 000014EB 0000                    devmark_addr:	dw  0			;segment address for devmark.
 27299                                  
 27300 000014ED 00                      setdevmarkflag: db  0			;flag used for devmark
 27301                                  
 27302                                  ; 30/12/2022
 27303                                  ; 12/12/2022
 27304 000014EE 00                      driver_units:	db  0			;total unitcount for driver
 27305                                  
 27306                                  ; 12/12/2022
 27307                                  ;ems_stub_installed:
 27308                                  ;		db  0
 27309                                  
 27310                                  ; 12/12/2022	
 27311                                  ;align 2
 27312                                  
 27313                                  badparm_ptr:	; label	dword
 27314 000014EF 0000                    badparm_off:	dw  0
 27315 000014F1 0000                    badparm_seg:	dw  0
 27316                                  
 27317                                  ;******************************************************************************
 27318                                  ;take care of config.sys file.
 27319                                  ;system parser data and code.
 27320                                  ;******************************************************************************
 27321                                  
 27322                                  ;*******************************************************************
 27323                                  ; parser options set for msbio sysconf module
 27324                                  ;*******************************************************************
 27325                                  ;
 27326                                  ;**** default assemble swiches definition **************************
 27327                                  
 27328                                  ;farsw	equ 0		; near call expected
 27329                                  ;datesw	equ 0		; check date format
 27330                                  ;timesw	equ 0		; check time format
 27331                                  ;filesw	equ 1		; check file specification
 27332                                  ;capsw	equ 0		; perform caps if specified
 27333                                  ;cmpxsw	equ 0		; check complex list
 27334                                  ;numsw	equ 1		; check numeric value
 27335                                  ;keysw	equ 0		; support keywords
 27336                                  ;swsw	equ 1		; support switches
 27337                                  ;val1sw	equ 1		; support value definition 1
 27338                                  ;val2sw	equ 0		; support value definition 2
 27339                                  ;val3sw	equ 1		; support value definition 3
 27340                                  ;drvsw	equ 1		; support drive only format
 27341                                  ;qussw	equ 0		; support quoted string format
 27342                                  
 27343                                  ; psdata_seg equ cs
 27344                                  
 27345                                  	;.xlist
 27346                                  	;include parse.asm		;together with psdata.inc
 27347                                  	;.list
 27348                                  
 27349                                  ; PSDATA.INC - MSDOS 6.0 - 1991
 27350                                  ; ======================================================================
 27351                                  ; 27/03/2019 - Retro DOS v4.0
 27352                                  
 27353                                  ; 30/03/2019
 27354                                  ; VERSION.INC (MSDOS 6.0) 
 27355                                  ; Set DBCS Blank constant
 27356                                  
 27357                                  ; ifndef DBCS
 27358                                  DB_SPACE EQU 2020h
 27359                                  DB_SP_HI EQU 20h
 27360                                  DB_SP_LO EQU 20h
 27361                                  ; else
 27362                                  
 27363                                  ;*******************************************************************
 27364                                  ; Parser include file
 27365                                  ;*******************************************************************
 27366                                  
 27367                                  ;**** Equation field
 27368                                  ;-------- Character code definition
 27369                                  
 27370                                  _$P_DBSP1	   equ	DB_SP_HI	;AN000; 1st byte of DBCS blank
 27371                                  _$P_DBSP2	   equ	DB_SP_LO	;AN000; 2nd byte of DBCS blank
 27372                                  _$P_Period	   equ	"."             ;AN020;
 27373                                  _$P_Slash	   equ	"/"             ;AN020;
 27374                                  _$P_Space	   equ	" "             ;AN000; SBCS blank
 27375                                  _$P_Comma	   equ	","             ;AN000;
 27376                                  _$P_Switch	   equ	"/"             ;AN000;
 27377                                  _$P_Keyword	   equ	"="             ;AN000;
 27378                                  _$P_Colon	   equ	":"             ;AN000;
 27379                                  _$P_Plus 	   equ	"+"             ;AN000;
 27380                                  _$P_Minus	   equ	"-"             ;AN000;
 27381                                  _$P_Rparen	   equ	")"             ;AN000;
 27382                                  _$P_Lparen	   equ	"("             ;AN000;
 27383                                  ;_$P_SQuote        equ  "'"			;AN025; deleted
 27384                                  _$P_DQuote	   equ	'"'             ;AN000;
 27385                                  _$P_NULL 	   equ	0		;AN000;
 27386                                  _$P_TAB		   equ	9		;AN000;
 27387                                  _$P_CR		   equ	0Dh		;AN000;
 27388                                  _$P_LF		   equ	0Ah		;AN000;
 27389                                  _$P_ASCII80	   equ	80h		;AN000; ASCII 80h character code
 27390                                  
 27391                                  ;-------- Masks
 27392                                  _$P_Make_Lower	   equ	20h		;AN000; make lower case character
 27393                                  _$P_Make_Upper	   equ	0FFh-_$P_Make_Lower ;AN000; make upper case character
 27394                                  
 27395                                  ;-------- DOS function call related equs
 27396                                  
 27397                                  _$P_DOS_Get_CDI	   equ	3800h		;AN000; get country dependent information
 27398                                  					; by this call, following information
 27399                                  struc _$P_CDI	
 27400 00000000 ????                     .DateF: resw 1
 27401 00000002 ??????????               .Money: resb 5
 27402 00000007 ????                     .1000:	 resb 2
 27403 00000009 ????                     .Dec:	 resb 2
 27404 0000000B ????                     .DateS: resb 2
 27405 0000000D ????                     .TimeS: resb 2
 27406 0000000F ??                          	 resb 1
 27407 00000010 ??                      	 resb 1
 27408 00000011 ??                       .TimeF: resb 1	 
 27409 00000012 ????????                	 resw 2
 27410 00000016 ????                    	 resb 2
 27411 00000018 <res Ah>                	 resw 5
 27412                                   .size:
 27413                                  endstruc
 27414                                  
 27415                                  _$P_Date_MDY	   equ	0		;AN000;
 27416                                  _$P_Date_DMY	   equ	1		;AN000;
 27417                                  _$P_Date_YMD	   equ	2		;AN000;
 27418                                  ;-------------
 27419                                  _$P_DOS_GetEV	   equ	6300h		;AN000; get DBCS EV call
 27420                                  					;AN000; DS:SI will points to DBCS EV
 27421                                  ;-------------
 27422                                  _$P_DOS_Get_TBL	   equ	65h		;AN000; get uppercase table call
 27423                                  					;AN000; following parameters are set
 27424                                  					;AN000; to get casemap table.
 27425                                  _$P_DOSTBL_Def	   equ	-1		;AN000; get default
 27426                                  _$P_DOSTBL_BL	   equ	5		;AN000; buffer length for Tbl pointer
 27427                                  _$P_DOSTBL_File	   equ	4		;AN000; get file uppercase table
 27428                                  _$P_DOSTBL_Char	   equ	2		;AN000; get character uppercase table
 27429                                  					; By this call following information
 27430                                  					; is returned.
 27431                                  struc _$P_DOS_TBL
 27432 00000000 ??                       .InfoID: resb 1			;AN000; information id for the table
 27433 00000001 ????                     .Off:	 resw 1				;AN000; offset address of the table
 27434 00000003 ????                     .Seg:	 resw 1				;AN000; segment address of the table
 27435                                  endstruc
 27436                                  
 27437                                  ; ----------------------------------------------------------------------------
 27438                                  ; PARMS 	LABEL	BYTE
 27439                                  ;		DW	PARMSX
 27440                                  ;		DB	2		; NUMBER OF STRINGS (0, 1, 2)
 27441                                  ;		DB	length		; LENGTH OF THE NEXT LIST, 0 IF NONE
 27442                                  ;		DB	" .. "          ; EXTRA DELIMITER LIST,
 27443                                  ;					; TYPICAL ARE ";", "="
 27444                                  ;					; "," & WHITESPACE ALWAYS
 27445                                  ;		DB	length		; LENGTH OF THE NEXT LIST, 0 IF NONE
 27446                                  ;		DB	" .. "          ; EXTRA END OF LINE LIST, CR, LF OR 0 ALWAYS
 27447                                  ; ----------------------------------------------------------------------------
 27448                                  
 27449                                  ;-------------------------------- PARMS block structure
 27450                                  struc _$P_PARMS_Blk
 27451 00000000 ????                     .PARMSX_Address:  resw 1		;AN000; Address of PARMSX
 27452 00000002 ??                       .Num_Extra:	   resb 1		;AN000; Number of extra stuff
 27453 00000003 ??                       .Len_Extra_Delim: resb 1		;AN000; Length of extra delimiter
 27454                                  endstruc
 27455                                  
 27456                                  _$P_Len_PARMS	   equ	4		;AN000;
 27457                                  _$P_I_Use_Default  equ	0		;AN000; no extra stuff specified
 27458                                  _$P_I_Have_Delim   equ	1		;AN000; extra delimiter specified
 27459                                  _$P_I_Have_EOL	   equ	2		;AN000; extra EOL specified
 27460                                  
 27461                                  ; ----------------------------------------------------------------------------
 27462                                  ; PARMSX	LABEL	BYTE
 27463                                  ;		DB	minp,maxp	; MIN, MAX POSITIONAL OPERANDS ALLOWED
 27464                                  ;		DW	CONTROL 	; DESCRIPTION OF POSITIONAL 1
 27465                                  ;		:			; REPEATS maxp-1 TIMES
 27466                                  ;		DB	maxs		; # OF SWITCHES
 27467                                  ;		DW	CONTROL 	; DESCRIPTION OF SWITCH 1
 27468                                  ;		:			; REPEATS maxs-1 TIMES
 27469                                  ;		DB	maxk		; # OF KEYWORD
 27470                                  ;		DW	CONTROL 	; DESCRIPTION OF KEYWORD 1
 27471                                  ;		:			; REPEATS maxk-1 TIMES
 27472                                  ; ----------------------------------------------------------------------------
 27473                                  
 27474                                  ;-------------------------------- PARMSX block structure
 27475                                  struc _$P_PARMSX_Blk		;AN000;
 27476 00000000 ??                       .MinP: resb 1			;AN000; Minimum positional number
 27477 00000001 ??                       .MaxP:	resb 1			;AN000; Maximum positional number
 27478 00000002 ????                     .1st_Control: resw 1		;AN000; Address of the 1st CONTROL block
 27479                                  endstruc
 27480                                  
 27481                                  ; ----------------------------------------------------------------------------
 27482                                  ; << Control field definition  >>
 27483                                  ;
 27484                                  ;
 27485                                  ;CONTROL   LABEL   BYTE
 27486                                  ;	   DW	   MATCH_FLAGS	   ; CONTROLS TYPE MATCHED
 27487                                  ;				   ; 8000H=NUMERIC VALUE, (VALUE LIST WILL BE CHECKED)
 27488                                  ;				   ; 4000H=SIGNED NUMERIC VALUE (VALUE LIST WILL BE CHECKED)
 27489                                  ;				   ; 2000H=SIMPLE STRING(VALUE LIST WILL BE CHECKED)
 27490                                  ;				   ; 1000H=DATE STRING (VALUE LIST WON'T BE CHECKED)
 27491                                  ;				   ; 0800H=TIME STRING (VALUE LIST WON'T BE CHECKED)
 27492                                  ;				   ; 0400H=COMPLEX LIST (VALUE LIST WON'T BE CHECKED)
 27493                                  ;				   ; 0200H=FILE SPEC (VALUE LIST WON'T BE CHECKED)
 27494                                  ;				   ; 0100H=DRIVE ONLY (VALUE LIST WON'T BE CHECKED)
 27495                                  ;				   ; 0080H=QUOTED STRING (VALUE LIST WON'T BE CHECKED)
 27496                                  ;				   ; 0010H=IGNORE ":" AT END IN MATCH
 27497                                  ;				   ; 0002H=REPEATS ALLOWED
 27498                                  ;				   ; 0001H=OPTIONAL
 27499                                  ;	   DW	   FUNCTION_FLAGS
 27500                                  ;				   ; 0001H=CAP RESULT BY FILE TABLE
 27501                                  ;				   ; 0002H=CAP RESULT BY CHAR TABLE
 27502                                  ;				   ; 0010H=REMOVE ":" AT END
 27503                                  ; (tm10)			   ; 0020H=colon is not necessary for switch
 27504                                  ;	   DW	   RESULT	   ; RESULT BUFFER
 27505                                  ;	   DW	   VALUES	   ; VALUE LISTS
 27506                                  ;	   DB	   nid		   ; NUMBER OF KEYWORD/SWITCH SYNONYMS IN FOLLOWING LIST
 27507                                  ;	   DB	   "...",0         ; IF n >0, KEYWORD 1
 27508                                  ;	   :
 27509                                  ;
 27510                                  ;Note:
 27511                                  ;    - The MATCH_FLAG is bit significant. You can set, for example, TIME bit and
 27512                                  ;      DATE bit simalteniously.
 27513                                  ;
 27514                                  ;      The parser examins each bit along with the following priority.
 27515                                  ;
 27516                                  ;      COMPLEX -> DATE -> TIME -> NUMERIC VAL -> SIGNED NUMERIC VAL -> DRIVE ->
 27517                                  ;      FILE SPEC -> SIMPLE STRING.
 27518                                  ;
 27519                                  ;    - When the FUNCTION_FLAG is 0001 or 0002, the STRING pointed to by a pointer
 27520                                  ;      in the result buffer is capitalized.
 27521                                  ;
 27522                                  ;    - Match_Flags 0001H and 0002H have meaning only for the positional.
 27523                                  ;
 27524                                  ;    - The "...",0 (bottom most line) does require '=' or '/'. When you need a
 27525                                  ;      switch, for example, '/A', then STRING points to;
 27526                                  ;
 27527                                  ;			DB    1 	; number of following synonyms
 27528                                  ;			DB   '/A',0
 27529                                  ;
 27530                                  ;      When you need a keyword, for example, 'CODEPAGE=', then "...",0 will be;
 27531                                  ;
 27532                                  ;			DB    1 	; number of following synonyms
 27533                                  ;			DB   'CODEPAGE=',0
 27534                                  ;
 27535                                  ;    - "..." must consist of upper case characters only because the parser
 27536                                  ;      performs pattern matching after converting input to upper case (by
 27537                                  ;      using the current country upper case table)
 27538                                  ;
 27539                                  ;    - One "..." can contain only one switch or keyword. If you need, for
 27540                                  ;      example /A and /B, the format will be;
 27541                                  ;
 27542                                  ;			DB    2 	; number of following synonyms
 27543                                  ;			DB    '/A',0
 27544                                  ;			DB    '/B',0
 27545                                  ; ----------------------------------------------------------------------------
 27546                                  
 27547                                  ;**** Match_Flags
 27548                                  
 27549                                  _$P_Num_Val	   equ	8000h		;AN000; Numeric Value
 27550                                  _$P_SNum_Val	   equ	4000h		;AN000; Signed numeric value
 27551                                  _$P_Simple_S	   equ	2000h		;AN000; Simple string
 27552                                  _$P_Date_S	   equ	1000h		;AN000; Date string
 27553                                  _$P_Time_S	   equ	0800h		;AN000; Time string
 27554                                  _$P_Cmpx_S	   equ	0400h		;AN000; Complex string
 27555                                  _$P_File_Spc	   equ	0200h		;AN000; File Spec
 27556                                  _$P_Drv_Only	   equ	0100h		;AN000; Drive Only
 27557                                  _$P_Qu_String	   equ	0080h		;AN000; Quoted string
 27558                                  _$P_Ig_Colon	   equ	0010h		;AN000; Ignore colon at end in match
 27559                                  _$P_Repeat	   equ	0002h		;AN000; Repeat allowed
 27560                                  _$P_Optional	   equ	0001h		;AN000; Optional
 27561                                  
 27562                                  ;**** Function flags
 27563                                  
 27564                                  _$P_CAP_File	   equ	0001h		;AN000; CAP result by file table
 27565                                  _$P_CAP_Char	   equ	0002h		;AN000; CAP result by character table
 27566                                  _$P_Rm_Colon	   equ	0010h		;AN000; Remove ":" at the end
 27567                                  _$P_colon_is_not_necessary equ 0020h	;AN000;(tm10) /+10 and /+:10
 27568                                  
 27569                                  ;-------------------------------- Control block structure
 27570                                  struc _$P_Control_Blk
 27571 00000000 ????                     .Match_Flag:	 resw 1		;AN000; Controls type matched
 27572 00000002 ????                     .Function_Flag: resw 1		;AN000; Function should be taken
 27573 00000004 ????                     .Result_Buf:	 resw 1		; Result buffer address
 27574 00000006 ????                     .Value_List:	 resw 1		;AN000; Value list address
 27575 00000008 ??                       .nid:		 resb 1		;AN000; # of keyword/SW synonyms
 27576 00000009 ??                       .KEYorSW:	 resb 1		;AN000; keyword or sw
 27577                                  endstruc
 27578                                  
 27579                                  ; ----------------------------------------------------------------------------
 27580                                  ; << Value List Definition >>
 27581                                  ;
 27582                                  ;VALUES 	LABEL	BYTE
 27583                                  ;		DB	nval			; NUMBER OF VALUE DEFINITIONS (0 - 3)
 27584                                  ;	     +-
 27585                                  ;	     |	DB	nrng			; NUMBER OF RANGES
 27586                                  ;	     | +DB	ITEM_TAG		; RETURN VALUE IF RANGE MATCHED
 27587                                  ;	     | +DD	X,Y			; RANGE OF VALUES
 27588                                  ;	     |	:
 27589                                  ;	     |	DB	nnval			; NUMBER OF CHOICES
 27590                                  ;	     | +DB	ITEM_TAG		; RETURN VALUE IF NUMBER CHOICE MATCHED
 27591                                  ;	     | +DD	VALUE			; SPECIFIC CHOICE IF NUMBER
 27592                                  ;	     |	:
 27593                                  ;	     |	DB	nstrval 		; NUMBER OF CHOICES
 27594                                  ;	     | +DB	ITEM_TAG		; RETURN VALUE IF STRING CHOICE MATCHED
 27595                                  ;	     | +DW	STRING			; SPECIFIC CHOICE IF STING
 27596                                  ;	     +-	:
 27597                                  ;
 27598                                  ;STRING 	DB	"...",0                 ; ASCIIZ STRING IMAGE
 27599                                  ;
 27600                                  ;Note:
 27601                                  ;    - ITEM_TAG must not be 0FFH, which will be used in the result buffer
 27602                                  ;      when no choice lists are provided.
 27603                                  ;
 27604                                  ;    - STRING must consist of upper case characters only because the parser
 27605                                  ;      performs pattern matching after converting input to upper case (by
 27606                                  ;      using the current country upper case table)
 27607                                  ; ----------------------------------------------------------------------------
 27608                                  
 27609                                  _$P_nval_None	   equ	0		;AN000; no value list ID
 27610                                  _$P_nval_Range	   equ	1		;AN000; range list ID
 27611                                  _$P_nval_Value	   equ	2		;AN000; value list ID
 27612                                  _$P_nval_String	   equ	3		;AN000; string list ID
 27613                                  _$P_Len_Range	   equ	9		;AN000; Length of a range choice(two DD plus one DB)
 27614                                  _$P_Len_Value	   equ	5		;AN000; Length of a value choice(one DD plus one DB)
 27615                                  _$P_Len_String	   equ	3		;AN000; Length of a string choice(one DW plus one DB)
 27616                                  _$P_No_nrng	   equ	0		;AN000; (tm07) no nrng. nnval must not be 0.
 27617                                  
 27618                                  struc _$P_Val_List
 27619 00000000 ??                       .NumofList: resb 1			;AN000; number of following choice
 27620 00000001 ????                     .Val_XL:    resw 1			;AN000; lower word of value
 27621 00000003 ????                     .Val_XH:    resw 1			;AN000; higher word of value
 27622 00000005 ????                     .Val_YL:    resw 1			;AN000; lower word of another value
 27623 00000007 ????                     .Val_YH:    resw 1			;AN000; higher word of another value
 27624                                  endstruc
 27625                                  
 27626                                  ; ----------------------------------------------------------------------------
 27627                                  ; << Result Buffer Definition  >>
 27628                                  ;
 27629                                  ;RESULT 	LABEL	BYTE			; BELOW FILLED IN FOR DEFAULTS
 27630                                  ;		DB	type			; TYPE RETURNED: 0=RESERVED,
 27631                                  ;						;	1=NUMBER, 2=LIST INDEX,
 27632                                  ;						;	3=STRING, 4=COMPLEX,
 27633                                  ;						;	5=FILESPEC, 6=DRIVE
 27634                                  ;						;	7=DATE, 8=TIME
 27635                                  ;						;	9=QUOTED STRING
 27636                                  ;		DB	ITEM_TAG		; MATCHED ITEM TAG
 27637                                  ;
 27638                                  ;		dw	synonym@		; es:@ points to found SYNONYM if provided.
 27639                                  ;
 27640                                  ;            +-
 27641                                  ;	    | DD	n			; VALUE IF NUMBER
 27642                                  ;	    | or
 27643                                  ;	    |	DW	i			; INDEX (OFFSET) INTO VALUE LIST
 27644                                  ;	    |					; (ES presents Segment address)
 27645                                  ;	    | or
 27646                                  ;	    |	DD	STRING			; OFFSET OF STRING VALUE
 27647                                  ;	    | or
 27648                                  ;	    |	DB	drv			; DRIVE NUMBER (1-A, 2-B,..., 26-Z)
 27649                                  ;	    | or
 27650                                  ;	    |	DW	YEAR	   ;(1980-2099)  IN CASE OF DATE
 27651                                  ;	    |	DB	MONTH	   ;(1-12)	 Note: Range check is not performed.
 27652                                  ;	    |	DB	DATE	   ;(1-31)	       0 is filled when the corresponding field was not specified.
 27653                                  ;	    | or
 27654                                  ;	    |	DB	HOUR	   ;(0-23)	  IN CASE OF TIME
 27655                                  ;	    |	DB	MINUTES    ;(0-59)	  Note: Range check is not performed .
 27656                                  ;	    |	DB	SECONDS    ;(0-59)		0 is filled when the corresponding field was not specified .
 27657                                  ;	    |	DB	HUNDREDTHS ;(0-99)
 27658                                  ;	    +-
 27659                                  ;
 27660                                  ;
 27661                                  ;Note: ITEM_TAG is 0FFH when the caller does not specify the choice
 27662                                  ;      list.
 27663                                  ;
 27664                                  ;      YEAR: If the input value for the year is less than 100, parser
 27665                                  ;	     adds 1900 to it.  For example, when 87 is input to parser for
 27666                                  ;	     the year value, he returns 1987.
 27667                                  ; ----------------------------------------------------------------------------
 27668                                  
 27669                                  ;-------------------------------- Result block structure
 27670                                  struc _$P_Result_Blk
 27671 00000000 ??                       .Type:        resb 1		;AN000; Type returned
 27672 00000001 ??                       .Item_Tag:    resb 1		;AN000; Matched item tag
 27673 00000002 ????                     .SYNONYM_Ptr: resw 1		;AN000; pointer to Synonym list returned
 27674 00000004 ????????                 .Picked_Val:  resb 4		;AN000; value
 27675                                  endstruc
 27676                                  
 27677                                  ;--------------------------------
 27678                                  ;**** values for the type field in the result block
 27679                                  
 27680                                  _$P_EOL		   equ	0		;AN000; End of line
 27681                                  _$P_Number	   equ	1		;AN000; Number
 27682                                  _$P_List_Idx	   equ	2		;AN000; List Index
 27683                                  _$P_String	   equ	3		;AN000; String
 27684                                  _$P_Complex	   equ	4		;AN000; Complex
 27685                                  _$P_File_Spec	   equ	5		;AN000; File Spec
 27686                                  _$P_Drive	   equ	6		;AN000; Drive
 27687                                  _$P_Date_F	   equ	7		;AN000; Date
 27688                                  _$P_Time_F	   equ	8		;AN000; Time
 27689                                  _$P_Quoted_String  equ	9		;AN000; Quoted String
 27690                                  
 27691                                  _$P_No_Tag	   equ	0FFh		;AN000; No ITEM_TAG found
 27692                                  
 27693                                  ;**** Return code
 27694                                  ;
 27695                                  ; following return code will be returned in the AX register.
 27696                                  
 27697                                  _$P_No_Error	   equ	0		;AN000; No error
 27698                                  _$P_Too_Many	   equ	1		;AN000; Too many operands
 27699                                  _$P_Op_Missing	   equ	2		;AN000; Required operand missing
 27700                                  _$P_Not_In_SW	   equ	3		;AN000; Not in switch list provided
 27701                                  _$P_Not_In_Key	   equ	4		;AN000; Not in keyword list provided
 27702                                  _$P_Out_Of_Range   equ	6		;AN000; Out of range specified
 27703                                  _$P_Not_In_Val	   equ	7		;AN000; Not in value list provided
 27704                                  _$P_Not_In_Str	   equ	8		;AN000; Not in string list provided
 27705                                  _$P_Syntax	   equ	9		;AN000; Syntax error
 27706                                  _$P_RC_EOL	   equ	-1		;AN000; End of command line
 27707                                  
 27708                                  ; DATA - Retro DOS v4.0 - 27/03/2019
 27709                                  
 27710                                  ; MSDOS 6.2 IO.SYS SYSINIT:179Ch
 27711                                  
 27712                                  ;********************** Local Data *************************************
 27713 000014F3 0000                    _$P_ORDINAL:	   dw	0		;AN000; Operand ordinal save area
 27714 000014F5 0000                    _$P_RC:		   dw	0		;AN000; Return code from parser
 27715 000014F7 0000                    _$P_SI_Save:	   dw	0		;AN000; Pointer of command buffer
 27716 000014F9 0000                    _$P_DX:		   dw	0		;AN000; Return result buffer address
 27717 000014FB 00                      _$P_Terminator:	   db	0		;AN000; Terminator code (ASCII)
 27718 000014FC 0000                    _$P_DBCSEV_OFF:	   dw	0		;AN000; Offset of DBCS EV
 27719 000014FE 0000                    _$P_DBCSEV_SEG:	   dw	0		;AN000; Segment of DBCS EV
 27720 00001500 0000                    _$P_Flags:	   dw	0		;AN000; Parser internal flags
 27721                                  %define _$P_Flags1 _$P_Flags		;AN038; to reference first byte flags
 27722                                  %define _$P_Flags2 _$P_Flags+1		;AN038; to reference second byte flags only
 27723                                  
 27724                                  ;in second byte of _$P_Flags, referenced as _$P_Flags2:
 27725                                  _$P_equ		   equ	01h	      ;AN000; "=" packed in string buffet
 27726                                  _$P_Neg		   equ	02h	      ;AN000; Negative value
 27727                                  _$P_Time12	   equ	04h	      ;AN000; set when PM is specified
 27728                                  _$P_Key_Cmp	   equ	08h	      ;AN000; set when keyword compare
 27729                                  _$P_SW_Cmp	   equ	10h	      ;AN000; set when switch compare
 27730                                  _$P_Extra	   equ	20h	      ;AN000; set when extra delimiter found
 27731                                  _$P_SW		   equ	40h	      ;AN000; set when switch found (tm08)
 27732                                  _$P_Signed	   equ	80h	      ;AN000; signed numeric specified
 27733                                  
 27734                                  ;in first byte of _$P_Flags, referenced as _$P_Flags1:
 27735                                  _$P_time12am	   equ	01h	      ;AN038; set when AM is specified on time
 27736                                  _$P_TIME_AGAIN	   equ	02h	      ;AN039; SET WHEN READY TO RE-PARSE TIME
 27737                                  
 27738 00001502 0000                    _$P_SaveSI_Cmpx:   dw	0		;AN000; save si for later use by complex
 27739 00001504 0000                    _$P_KEYorSW_Ptr:   dw	0		;AN000; points next to "=" or ":" code
 27740 00001506 0000                    _$P_Save_EOB:	   dw	0		;AN000; save pointer to EOB
 27741 00001508 0000                    _$P_Found_SYNONYM: dw	0		;AN000; es:@ points to found synonym
 27742                                  
 27743 0000150A 00<rep 80h>             _$P_STRING_BUF:	   times 128 db 0	;AN000; Pick a operand from command line
 27744                                  _$P_STRING_BUF_END equ	$		;AN000;
 27745                                  
 27746                                  ; 25/10/2022
 27747                                  ; (MSDOS 5.0 IO.SYS, SYSINIT:16F8h)
 27748                                  
 27749 0000158A FF                      _$P_Char_CAP_Ptr:  db	0FFh		;AN000; info id
 27750 0000158B 0000                    		   dw	0		;AN000; offset	of char case map table
 27751 0000158D 0000                    		   dw	0		;AN000; segment of char case map table
 27752                                  ; 25/10/2022
 27753                                  ;IF CAPSW
 27754                                  ;_$P_File_CAP_Ptr: db	0FFh		;AN000; info id
 27755                                  ;		   dw	0		;AN000; offset	of file case map table
 27756                                  ;		   dw	0		;AN000; segment of file case map table
 27757                                  ;ENDIF
 27758                                  
 27759                                  ; (tm06) IF FileSW			;AN000;(Check if file spec is supported)
 27760                                  ;
 27761                                  
 27762                                  ;M029
 27763                                  ;!!!WARNING!!!
 27764                                  ; In routine SYSPARSE (parse.asm), _$P_FileSp_Char is reinitialized using 
 27765                                  ;hardcoded strings. If the chars in the string are changed here, corresponding
 27766                                  ;changes need to be made in SYSPARSE
 27767                                  
 27768                                  ;IF FileSW+DrvSW 			;AN000;(Check if file spec is supported)
 27769                                  
 27770                                  ; 25/10/2022
 27771                                  ; (MSDOS 5.0 IO.SYS, SYSINIT:16FDh)
 27772                                  
 27773 0000158F 5B5D7C3C3E2B3D3B22      _$P_FileSp_Char	   db	'[]|<>+=;"'     ;AN000; delimitter of file spec
 27774                                  _$P_FileSp_Len	   equ	$-_$P_FileSp_Char ;AN000;
 27775                                  
 27776                                  ;ENDIF					;AN000;(of FileSW)
 27777                                  
 27778                                  ; delimiter parsing
 27779                                  _$P_colon_period   equ	01h		;AN032; check for colon & period
 27780                                  _$P_period_only	   equ	02h		;AN032; check only for period
 27781                                  
 27782                                  ;filespec error flag
 27783 00001598 00                      _$P_err_flag:	   db	0		;AN033; flag set if filespec parsing error
 27784                                  					;AN033;  was detected.
 27785                                  _$P_error_filespec equ	01h		;AN033; mask to set flag
 27786                                  
 27787                                  
 27788                                  ; PARSE.ASM - MSDOS 6.0 - 1991
 27789                                  ; ======================================================================
 27790                                  ; 27/03/2019 - Retro DOS v4.0
 27791                                  
 27792                                  ;***********************************************************************
 27793                                  ; SysParse;
 27794                                  ;
 27795                                  ;  Function : Parser Entry
 27796                                  ;
 27797                                  ;  Input: DS:SI -> command line
 27798                                  ;	  ES:DI -> parameter block
 27799                                  ;	  cs -> psdata.inc
 27800                                  ;	  CX = operand ordinal
 27801                                  ;
 27802                                  ;	  Note:  ES is the segment containing all the control blocks defined
 27803                                  ;		 by the caller, except for the DOS COMMAND line parms, which
 27804                                  ;		 is in DS.
 27805                                  ;
 27806                                  ;  Output: CY = 1   error of caller, means invalid parameter block or
 27807                                  ;		    invalid value list. But this parser does NOT implement
 27808                                  ;		    this feature. Therefore CY always zero.
 27809                                  ;
 27810                                  ;	   CY = 0   AX = return code
 27811                                  ;		    BL = terminated delimiter code
 27812                                  ;		    CX = new operand ordinal
 27813                                  ;		    SI = set past scaned operand
 27814                                  ;		    DX = selected result buffer
 27815                                  ;
 27816                                  ; Use:	_$P_Skip_Delim, _$P_Chk_EOL, _$P_Chk_Delim, _$P_Chk_DBCS
 27817                                  ;	_$P_Chk_Swtch, _$P_Chk_Pos_Control, _$P_Chk_Key_Control
 27818                                  ;	_$P_Chk_Sw_Control, _$P_Fill_Result
 27819                                  ;
 27820                                  ; Vars: _$P_Ordinal(RW), _$P_RC(RW), _$P_SI_Save(RW), _$P_DX(R), _$P_Terminator(R)
 27821                                  ;	_$P_SaveSI_Cmpx(W), _$P_Flags(RW), _$P_Found_SYNONYM(R), _$P_Save_EOB(W)
 27822                                  ;
 27823                                  ;-------- Modification History -----------------------------------------
 27824                                  ;
 27825                                  ;  4/04/87 : Created by K. K,
 27826                                  ;  4/28/87 : _$P_Val_YH assemble error (tm01)
 27827                                  ;	   : JMP SHORT assemble error (tm02)
 27828                                  ;  5/14/87 : Someone doesn't want to include psdata (tm03)
 27829                                  ;  6/12/87 : _$P_Bridge is missing when TimeSw equ 0 and (CmpxSw equ 1 or
 27830                                  ;	     DateSW equ 1)	      (tm04)
 27831                                  ;  6/12/87 : _$P_SorD_Quote is missing when QusSw equ 0 and CmpxSW equ 1
 27832                                  ;				      (tm05) in PSDATA.INC
 27833                                  ;  6/12/87 : _$P_FileSp_Char and _$P_FileSP_Len are missing
 27834                                  ;	     when FileSW equ 0 and DrvSW equ 1 (tm06) in PSDATA.INC
 27835                                  ;  6/18/87 : $VAL1 and $VAL3, $VAL2 and $VAL3 can be used in the same
 27836                                  ;	     value-list block	      (tm07)
 27837                                  ;  6/20/87 : Add _$P_SW to check if there's an omiting parameter after
 27838                                  ;	     switch (keyword) or not. If there is, backup si for next call
 27839                                  ;	     (tm08)
 27840                                  ;  6/24/87 : Complex Item checking does not work correctly when CmpSW equ 1
 27841                                  ;	     and DateSW equ 0 and TimeSW equ 0 (tm09)
 27842                                  ;  6/24/87 : New function flag _$P_colon_is_not_necessary for switch
 27843                                  ;	     /+15 and /+:15 are allowed for user (tm10)
 27844                                  ;  6/29/87 : ECS call changes DS register but it causes the address problem
 27845                                  ;	     in user's routines. _$P_Chk_DBCS (tm11)
 27846                                  ;  7/10/87 : Switch with no_match flag (0x0000H) does not work correctly
 27847                                  ;					  (tm12)
 27848                                  ;  7/10/87 : Invalid switch/keyword does not work correctly
 27849                                  ;					  (tm13)
 27850                                  ;  7/10/87 : Drive_only breaks 3 bytes after the result buffer
 27851                                  ;					  (tm14)
 27852                                  ;  7/12/87 : Too_Many_Operands sets DX=0 as the PARSE result
 27853                                  ;					  (tm15)
 27854                                  ;  7/24/87 : Negative lower bound on numeric ranges cause trouble
 27855                                  
 27856                                  ;  7/24/87 : Quoted strings being returned with quotes.
 27857                                  
 27858                                  ;  7/28/87 : Kerry S (;AN018;)
 27859                                  ;	     Non optional value on switch (match flags<>0 and <>1) not flagged
 27860                                  ;	     as an error when missing.	Solution: return error 2.  Modules
 27861                                  ;	     affected: _$P_Chk_SW_Control.
 27862                                  
 27863                                  ;  7/29/87 : Kerry S (;AN019;)
 27864                                  ;	     Now allow the optional bit in match flags for switches.  This
 27865                                  ;	     allows the switch to be encountered with a value or without a
 27866                                  ;	     value and no error is returned.
 27867                                  ;
 27868                                  
 27869                                  ;  8/28/87 : Ed K, Kerry S (;AN020;)
 27870                                  ;  9/14/87   In PROC _$P_Get_DecNum, when checking for field separators
 27871                                  ;	     within a date response, instead of checking just for the one
 27872                                  ;	     character defined by the COUNTRY DEPENDENT INFO, check for
 27873                                  ;	     all three chars, "-", "/", and ".". Change _$P_Chk_Switch to allow
 27874                                  ;	     slashes in date strings when DateSw (assembler switch) is set.
 27875                                  
 27876                                  ;  9/1/87  : Kerry S (;AN021)
 27877                                  ;	     In PROC _$P_String_Comp, when comparing the switch or keyword on
 27878                                  ;	     the command line with the string in the control block the
 27879                                  ;	     comparing was stopping at a colon (switch) or equal (keyword)
 27880                                  ;	     on the command line and assuming a match.	This allowed a shorter
 27881                                  ;	     string on the command line than in the synonym list in the control
 27882                                  ;	     block.  I put in a test for a null in the control block so the
 27883                                  ;	     string in the control block must be the same length as the string
 27884                                  ;	     preceeding the colon or equal on the command line.
 27885                                  
 27886                                  ;  8/28/87 : Kerry S (;AN022;)
 27887                                  ;	     All references to data in PSDATA.INC had CS overrides.  This caused
 27888                                  ;	     problems for people who included it themselves in a segment other
 27889                                  ;	     than CS.  Added switch to allow including PSDATA.INC in any
 27890                                  ;	     segment.
 27891                                  
 27892                                  ;  9/16/87 : Ed K (;AN023;) PTM1040
 27893                                  ;	     in _$P_set_cdi PROC, it assumes CS points to psdata. Change Push CS
 27894                                  ;	     into PUSH cs.  In _$P_Get_DecNum PROC, fix AN020
 27895                                  ;	     forced both TIME and DATE to use the delims, "-","/",".".
 27896                                  ;	     Created FLag, in _$P_time_Format PROC, to request the delim in
 27897                                  ;	     BL be used if TIME is being parsed.
 27898                                  
 27899                                  ;  9/24/87 : Ed K
 27900                                  ;	     Removed the include to STRUC.INC.	Replaced the STRUC macro
 27901                                  ;	     invocations with their normally expanded code; made comments
 27902                                  ;	     out of the STRUC macro invocation statements to maintain readability.
 27903                                  
 27904                                  ;  9/24/87 : Ed K (;AN024;) PTM1222
 27905                                  ;	     When no CONTROL for a keyword found, tried to fill in RESULT
 27906                                  ;	     pointed to by non-existant CONTROL.
 27907                                  
 27908                                  ; 10/15/87 : Ed K (;AN025;) PTM1672
 27909                                  ;	     A quoted text string can be framed only by double quote.  Remove
 27910                                  ;	     support to frame quoted text string with single quote.
 27911                                  ;	     (apostrophe) _$P_SorD_Quote is removed from PSDATA.INC.
 27912                                  ;	     _$P_SQuote EQU also removed from PSDATA.INC.  Any references to
 27913                                  ;	     single quote in PROC prologues are left as is for history reasons.
 27914                                  
 27915                                  ;	     This fixes another bug, not mentioned in p1672, in that two
 27916                                  ;	     quote chars within a quoted string is supposed to be reported as
 27917                                  ;	     one quote character, but is reported as two quotes.  This changed
 27918                                  ;	     two instructions in PROC _$P_Quoted_Str.
 27919                                  
 27920                                  ;	     Also fixed are several JMP that caused a NOP, these changed to
 27921                                  ;	     have the SHORT operator to avoid the unneeded NOP.
 27922                                  
 27923                                  ;	     The code and PSDATA.INC have been aligned for ease of reading.
 27924                                  
 27925                                  ; 10/26/87 : Ed K (;AN026;) PTM2041, DATE within SWITCH, BX reference to
 27926                                  ;	     psdata buffer should have cs.
 27927                                  
 27928                                  ; 10/27/87 : Ed K (;AN027;) PTM2042 comma between keywords implies
 27929                                  ;	     positional missing.
 27930                                  
 27931                                  ; 11/06/87 : Ed K (;AN028;) PTM 2315 Parser should not use line feed
 27932                                  ;	     as a line delimiter, should use carriage return.
 27933                                  ;	     Define switch: LFEOLSW, if on, accept LF as end of line char.
 27934                                  
 27935                                  ; 11/11/87 : Ed K (;AN029;) PTM 1651 GET RID OF WHITESPACE AROUND "=".
 27936                                  
 27937                                  ; 11/18/87 : Ed K (;AN030;) PTM 2551 If filename is just "", then
 27938                                  ;	     endless loop since SI is returned still pointing to start
 27939                                  ;	     of that parm.
 27940                                  
 27941                                  ; 11/19/87 : Ed K (;AN031;) PTM 2585 date & time getting bad values.
 27942                                  ;	     Vector to returned string has CS instead of cs, but
 27943                                  ;	     when tried to fix it on previous version, changed similar
 27944                                  ;	     but wrong place.
 27945                                  
 27946                                  ; 12/09/87 : Bill L (;AN032;) PTM 2772 colon and period are now valid
 27947                                  ;	     delimiters between hours, minutes, seconds for time. And period
 27948                                  ;	     and comma are valid delimiters between seconds and 100th second.
 27949                                  
 27950                                  ; 12/14/87 : Bill L (;AN033;) PTM 2722 if illegal delimiter characters
 27951                                  ;	     in a filespec, then flag an error.
 27952                                  
 27953                                  ; 12/22/87 : Bill L (;AN034;)	    All local data to parser is now
 27954                                  ;	     indexed off of the cs equate instead of the DS register.
 27955                                  ;	     Using this method, DS can point to the segment of PSP or to psdata
 27956                                  ;  -->	     local parser data. Why were some references to local data changed
 27957                                  ;	     to do this before, but not all ?????
 27958                                  
 27959                                  ; 02/02/88 : Ed K (;AC035;) INSPECT utility, suggests optimizations.
 27960                                  
 27961                                  ; 02/05/88 : Ed K (;AN036;) P3372-UPPERCASE TRANSLATION, cs HOSED.
 27962                                  ;
 27963                                  ; 02/08/88 : Ed K (;AN037;) P3410-AVOID POP OF CS, CHECK BASESW FIRST.
 27964                                  
 27965                                  ; 02/19/88 : Ed K (;AN038;) p3524 above noon and "am" should be error
 27966                                  
 27967                                  ; 02/23/88 : Ed K (;AN039;) p3518 accept "comma" and "period" as decimal
 27968                                  ;	     separator in TIME before hundredths field.
 27969                                  ;
 27970                                  ; 08/09/90 : SA	M005	Prevented parser from recognizing '=' signs within
 27971                                  ;			strings as keywords.
 27972                                  ;
 27973                                  ;***********************************************************************
 27974                                  
 27975                                  ;IF FarSW				;AN000;(Check if need far return)
 27976                                  ;SysParse proc far			;AN000;
 27977                                  ;ELSE					;AN000;
 27978                                  ;SysParse proc near			;AN000;
 27979                                  ;ENDIF					;AN000;(of FarSW)
 27980                                  
 27981                                  ; 27/03/2019 - Retro DOS v4.0
 27982                                  ; (MSDOS 6.21 IO.SYS - SYSINIT:1842h)
 27983                                  
 27984                                  ; 25/10/2022 - Retro DOS v4.0
 27985                                  ; (MSDOS 5.0 IO.SYS - SYSINIT:1707h)
 27986                                  
 27987                                  ; 06/09/2023 - Retro DOS v4.2 IO.SYS Optimization (& Retro DOS v5.0 pre-work)
 27988                                  ; (PCDOS 7.1 IBMBIO.COM - SYSINIT:1D08h)
 27989                                  
 27990                                  SysParse:
 27991                                  	; 06/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 27992                                  	; dx = 0
 27993 00001599 1E                      	push	ds ; *!*
 27994 0000159A 0E                      	push	cs
 27995 0000159B 1F                      	pop	ds 
 27996                                  
 27997                                  	;mov	word [cs:_$P_Flags],0	;AC034; Clear all internal flags
 27998                                  	;cld				;AN000; confirm forward direction
 27999                                  	;mov	word [cs:_$P_ORDINAL],cx ;AC034; save operand ordinal
 28000                                  	;mov	word [cs:_$P_RC],_$P_No_Error ;AC034; Assume no error
 28001                                  	;mov	word [cs:_$P_Found_SYNONYM],0 ;AC034; initalize synonym pointer
 28002                                  	;
 28003                                  	;mov	word [cs:_$P_DX],0	;AC034; (tm15)
 28004                                  
 28005                                  	; 06/09/2023
 28006 0000159C 8916[0015]              	mov	[_$P_Flags],dx ; 0	;AC034; Clear all internal flags
 28007 000015A0 FC                      	cld				;AN000; confirm forward direction
 28008 000015A1 890E[F314]              	mov	[_$P_ORDINAL],cx	;AC034; save operand ordinal
 28009 000015A5 8916[F514]              	mov	[_$P_RC],dx ; $P_No_Error ;AC034; Assume no error
 28010 000015A9 8916[0815]              	mov	[_$P_Found_SYNONYM],dx	; 0 ;AC034; initalize synonym pointer
 28011 000015AD 8916[F914]              	mov	[_$P_DX],dx ; 0		;AC034; (tm15)
 28012                                  
 28013                                  ;M029 -- Begin changes
 28014                                  ; The table of special chars _$P_FileSp_Char should be initialized on every
 28015                                  ;entry to SysParse. This is in the non-checksum region and any program that
 28016                                  ;corrupts this table but does not corrupt the checksum region will leave
 28017                                  ;command.com parsing in an inconsistent state.
 28018                                  ; NB: The special characters string has been hardcoded here. If any change
 28019                                  ;is made to it in psdata.inc, a corresponding change needs to be made here.
 28020                                  
 28021                                  ;IF FileSW + DrvSW
 28022                                  	;mov	word [cs:_$P_FileSp_Char], ']['
 28023                                  	;mov	word [cs:_$P_FileSp_Char+2], '<|'
 28024                                  	;mov	word [cs:_$P_FileSp_Char+4], '+>'
 28025                                  	;mov 	word [cs:_$P_FileSp_Char+6], ';='
 28026                                  
 28027                                  	; 06/09/2023
 28028 000015B1 C706[8F15]5D5B          	mov	word [_$P_FileSp_Char], ']['
 28029 000015B7 C706[9115]3C7C          	mov	word [_$P_FileSp_Char+2], '<|'
 28030 000015BD C706[9315]2B3E          	mov	word [_$P_FileSp_Char+4], '+>'
 28031 000015C3 C706[9515]3B3D          	mov 	word [_$P_FileSp_Char+6], ';='
 28032                                  ;ENDIF
 28033                                  	; 06/09/2023
 28034 000015C9 1F                      	pop	ds ; *!*
 28035                                  
 28036                                  ;M029 -- End of changes
 28037                                  
 28038 000015CA E87C06                  	call	_$P_Skip_Delim		;AN000; Move si to 1st non white space
 28039 000015CD 7313                    	jnc	short _$P_Start		;AN000; If EOL is not encountered, do parse
 28040                                  ;--------------------------- End of Line
 28041 000015CF B8FFFF                  	mov	ax,_$P_RC_EOL		;AN000; set exit code to -1
 28042 000015D2 53                      	push	bx			;AN000;
 28043                                  	;mov	bx,[es:di+_$P_PARMS_Blk.PARMSX_Address]
 28044                                  					;AN000; Get the PARMSX address to
 28045 000015D3 268B1D                  	mov	bx,[es:di]
 28046                                  	;cmp	cl,[es:bx+_$P_PARMSX_Blk.MinP]
 28047                                  					;AN000; check ORDINAL to see if the minimum
 28048 000015D6 263A0F                  	cmp	cl,[es:bx]	
 28049 000015D9 7303                    	jae	short _$P_Fin		;AN000; positional found.
 28050                                  
 28051 000015DB B80200                  	mov	ax,_$P_Op_Missing	;AN000; If no, set exit code to missing operand
 28052                                  _$P_Fin: 				;AN000;
 28053 000015DE 5B                      	pop	bx			;AN000;
 28054 000015DF E90A01                  	jmp	_$P_Single_Exit		;AN000; return to the caller
 28055                                  ;---------------------------
 28056                                  _$P_Start:				;AN000;
 28057 000015E2 2E8936[0215]            	mov	[cs:_$P_SaveSI_Cmpx],si ;AN000;AC034; save ptr to command line for later use by complex,
 28058 000015E7 53                      	push	bx			;AN000; quoted string or file spec.
 28059 000015E8 57                      	push	di			;AN000;
 28060 000015E9 55                      	push	bp			;AN000;
 28061                                  	;;lea	bx,[cs:_$P_STRING_BUF] ;AC034; set buffer to copy from command string
 28062                                  	; 02/11/2022
 28063                                  	;lea	bx,[_$P_STRING_BUF]
 28064                                  	; 07/09/2023
 28065 000015EA BB[0A15]                	mov	bx,_$P_STRING_BUF
 28066 000015ED 2EF606[0115]20          	test	byte [cs:_$P_Flags2],_$P_Extra ;AC034; 3/9 extra delimiter encountered ?
 28067 000015F3 7543                    	jnz	short _$P_Pack_End	;AN000; 3/9 if yes, no need to copy
 28068                                  
 28069                                  _$P_Pack_Loop:				;AN000;
 28070 000015F5 AC                      	lodsb				;AN000; Pick a operand from buffer
 28071 000015F6 E8F506                  	call	_$P_Chk_Switch		;AN000; Check switch character
 28072 000015F9 723C                    	jc	short _$P_Pack_End_BY_EOL ;AN020; if carry set found delimiter type slash, need backup si, else continue
 28073                                  
 28074 000015FB E86D06                  	call	_$P_Chk_EOL		;AN000; Check EOL character
 28075 000015FE 7437                    	je	short _$P_Pack_End_BY_EOL ;AN000; need backup si
 28076                                  
 28077 00001600 E89D06                  	call	_$P_Chk_Delim		;AN000; Check delimiter
 28078 00001603 7518                    	jne	short _$P_PL01 		;AN000; If no, process next byte
 28079                                  
 28080 00001605 2EF606[0115]20          	test	byte [cs:_$P_Flags2],_$P_Extra ;AC034; 3/9 If yes and white spec,
 28081                                  ; (tm08)jne	short _$P_Pack_End	;AN000; 3/9 then
 28082 0000160B 7505                    	jnz	short _$P_Pack_End_backup_si ;AN000; (tm08)
 28083                                  
 28084 0000160D E83906                  	call	_$P_Skip_Delim		;AN000; skip subsequent white space,too
 28085 00001610 EB26                    	jmp	short _$P_Pack_End	;AN000; finish copy by placing NUL at end
 28086                                  
 28087                                  _$P_Pack_End_backup_si:			;AN000; (tm08)
 28088 00001612 2EF606[0115]41          	test	byte [cs:_$P_Flags2],_$P_SW+_$P_equ ;AN000;AC034;  (tm08)
 28089 00001618 741E                    	jz	short _$P_Pack_End	;AN000; (tm08)
 28090                                  
 28091 0000161A 4E                      	dec	si			;AN000; (tm08)
 28092 0000161B EB1B                    	jmp	short _$P_Pack_End	;AN025; (tm08)
 28093                                  
 28094                                  _$P_PL01:				;AN000;
 28095 0000161D 2E8807                  	mov	[cs:bx],al		;AN000; move byte to STRING_BUF
 28096 00001620 3C3D                    	cmp	al,_$P_Keyword  ;'='	;AN000; if it is equal character,
 28097 00001622 7506                    	jne	short _$P_PL00 		;AN000; then
 28098                                  
 28099 00001624 2E800E[0115]01          	or	byte [cs:_$P_Flags2],_$P_equ ;AC034; remember it in flag
 28100                                  _$P_PL00:				;AN000;
 28101 0000162A 43                      	inc	bx			;AN000; ready to see next byte
 28102 0000162B E8D906                  	call	_$P_Chk_DBCS		;AN000; was it 1st byte of DBCS ?
 28103 0000162E 73C5                    	jnc	short _$P_Pack_Loop	;AN000; if no, process to next byte
 28104                                  
 28105 00001630 AC                      	lodsb				;AN000; if yes, store
 28106 00001631 2E8807                  	mov	[cs:bx],al		;AN000;    2nd byte of DBCS
 28107 00001634 43                      	inc	bx			;AN000; update pointer
 28108 00001635 EBBE                    	jmp	short _$P_Pack_Loop	;AN000; process to next byte
 28109                                  
 28110                                  _$P_Pack_End_BY_EOL:			;AN000;
 28111 00001637 4E                      	dec	si			;AN000; backup si pointer
 28112                                  _$P_Pack_End:				;AN000;
 28113 00001638 2E8936[F714]            	mov	[cs:_$P_SI_Save],si     ;AC034; save next pointer, SI
 28114                                  	; 07/09/2023
 28115                                  	;mov	byte [cs:bx],_$P_NULL	;AN000; put NULL at the end
 28116 0000163D 30E4                    	xor	ah,ah ; 0 ; *
 28117 0000163F 2E8827                  	mov	[cs:bx],ah ; _$P_NULL	;AN000; put NULL at the end
 28118                                  	;
 28119 00001642 2E891E[0615]            	mov	[cs:_$P_Save_EOB],bx    ;AC034; 3/17/87 keep the address for later use of complex
 28120                                  	;mov	bx,[es:di+_$P_PARMS_Blk.PARMSX_Address] ;AN000; get PARMSX address
 28121 00001647 268B1D                  	mov	bx,[es:di]
 28122                                  	;;lea	si,[cs:_$P_STRING_BUF]	;AC034;
 28123                                  	; 02/11/2022
 28124                                  	;lea	si,[_$P_STRING_BUF]
 28125                                  	; 07/09/2023
 28126 0000164A BE[0A15]                	mov	si,_$P_STRING_BUF
 28127 0000164D 2E803C2F                	cmp	byte [cs:si],_$P_Switch ;AN000; the operand begins w/ switch char ?
 28128 00001651 7440                    	je	short _$P_SW_Manager	;AN000; if yes, process as switch
 28129                                  
 28130 00001653 2E803C22                	cmp	byte [cs:si],_$P_DQuote	;M005;is it a string?
 28131 00001657 7408                    	je	short _$P_Positional_Manager ;M005;if so, process as one!
 28132                                  
 28133 00001659 2EF606[0115]01          	test	byte [cs:_$P_Flags2],_$P_equ ;AC034; the operand includes equal char ?
 28134 0000165F 7552                    	jnz	short _$P_Key_Manager	;AN000; if yes, process as keyword
 28135                                  
 28136                                  _$P_Positional_Manager:			;AN000; else process as positional
 28137 00001661 268A4701                	mov	al,[es:bx+_$P_PARMSX_Blk.MaxP] ;AN000; get maxp
 28138                                  	; 07/09/2023
 28139                                  	;xor	ah,ah			;AN000; ax = maxp
 28140 00001665 2E3906[F314]            	cmp	[cs:_$P_ORDINAL],ax	;AC034; too many positional ?
 28141 0000166A 7312                    	jae	short _$P_Too_Many_Error ;AN000; if yes, set exit code to too many
 28142                                  
 28143 0000166C 2EA1[F314]              	mov	ax,[cs:_$P_ORDINAL]	;AC034; see what the current ordinal
 28144 00001670 D1E0                    	shl	ax,1			;AN000; ax = ax*2
 28145 00001672 43                      	inc	bx			;AC035; add '2' to
 28146 00001673 43                      	inc	bx			;AC035;  BX reg
 28147                                  					;AN000; now bx points to 1st CONTROL
 28148 00001674 01C3                    	add	bx,ax			;AN000; now bx points to specified CONTROL address
 28149 00001676 268B1F                  	mov	bx,[es:bx]		;AN000; now bx points to specified CONTROL itself
 28150 00001679 E87200                  	call	_$P_Chk_Pos_Control	;AN000; Do process for positional
 28151 0000167C EB53                    	jmp	short _$P_Return_to_Caller ;AN000; and return to the caller
 28152                                  
 28153                                  _$P_Too_Many_Error:			;AN000;
 28154 0000167E 2EC706[F514]0100        	mov	word [cs:_$P_RC],_$P_Too_Many ;AC034; set exit code
 28155 00001685 EB4A                    	jmp	short _$P_Return_to_Caller ;AN000; and return to the caller
 28156                                  
 28157                                  	; 07/09/2023 - Retro DOSD v4.2 IO.SYS (Optimization)
 28158                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:1E06h)
 28159                                  get_maxp:
 28160                                  	;mov	al,[es:bx+1]
 28161 00001687 268A4701                	mov	al,[es:bx+_$P_PARMSX_Blk.MaxP] ;AN000; get maxp
 28162                                  	; 07/09/2023
 28163                                  	; ah=0 ; *
 28164                                  	;xor	ah,ah ; 0		;AN000; ax = maxp
 28165 0000168B 30ED                    	xor	ch,ch ; **
 28166 0000168D 40                      	inc	ax			;AN000;
 28167 0000168E D1E0                    	shl	ax,1			;AN000; ax = (ax+1)*2
 28168 00001690 01C3                    	add	bx,ax			;AN000; now bx points to maxs
 28169 00001692 C3                      	retn
 28170                                  
 28171                                  _$P_SW_Manager:				;AN000;
 28172                                  	; 07/09/2023
 28173                                  	;mov	al,[es:bx+_$P_PARMSX_Blk.MaxP] ;AN000; get maxp
 28174                                  	;xor	ah,ah			;AN000; ax = maxp
 28175                                  	;inc	ax			;AN000;
 28176                                  	;shl	ax,1			;AN000; ax = (ax+1)*2
 28177                                  	;add	bx,ax			;AN000; now bx points to maxs
 28178 00001693 E8F1FF                  	call	get_maxp ; 07/09/2023
 28179                                  
 28180 00001696 268A0F                  	mov	cl,[es:bx]		;AN000;
 28181                                  	; 07/09/2023
 28182                                  	;xor	ch,ch ; ** (ch=0)	;AN000; cx = maxs
 28183                                  	;or	cx,cx			;AN000; at least one switch ?
 28184                                  	;jz	short _$P_SW_Not_Found 	;AN000;
 28185                                  	; 07/07/2023
 28186 00001699 E30F                    	jcxz	_$P_SW_Not_Found	; no
 28187                                  
 28188 0000169B 43                      	inc	bx			;AN000; now bx points to 1st CONTROL address
 28189                                  
 28190                                  _$P_SW_Mgr_Loop: 			;AN000;
 28191 0000169C 53                      	push	bx			;AN000;
 28192 0000169D 268B1F                  	mov	bx,[es:bx]		;AN000; bx points to Switch CONTROL itself
 28193 000016A0 E8A900                  	call	_$P_Chk_SW_Control	;AN000; do process for switch
 28194 000016A3 5B                      	pop	bx			;AN000;
 28195 000016A4 732B                    	jnc	short _$P_Return_to_Caller ;AN000; if the CONTROL is for the switch, exit
 28196                                  
 28197 000016A6 43                      	inc	bx			;AC035; add '2' to
 28198 000016A7 43                      	inc	bx			;AC035;  BX reg
 28199                                  					;AN000; else bx points to the next CONTROL
 28200 000016A8 E2F2                    	loop	_$P_SW_Mgr_Loop		;AN000; and loop
 28201                                  
 28202                                  _$P_SW_Not_Found:			;AN000;
 28203 000016AA 2EC706[F514]0300        	mov	word [cs:_$P_RC],_$P_Not_In_SW ;AC034; here no CONTROL for the switch has
 28204 000016B1 EB1E                    	jmp	short _$P_Return_to_Caller ;AN000; not been found, means error.
 28205                                  
 28206                                  _$P_Key_Manager: 			;AN000;
 28207                                  	; 07/09/2023
 28208                                  	;mov	al,[es:bx+_$P_PARMSX_Blk.MaxP] ;AN000; get maxp
 28209                                  	;xor	ah,ah			;AN000; ax = maxp
 28210                                  	;inc	ax			;AN000;
 28211                                  	;shl	ax,1			;AN000; ax = (ax+1)*2
 28212                                  	;add	bx,ax			;AN000; now bx points to maxs
 28213 000016B3 E8D1FF                  	call	get_maxp ; 07/09/2023
 28214                                  	
 28215 000016B6 268A07                  	mov	al,[es:bx]		;AN000;
 28216 000016B9 30E4                    	xor	ah,ah ; 0		;AN000; ax = maxs
 28217 000016BB D1E0                    	shl	ax,1			;AN000;
 28218 000016BD 40                      	inc	ax			;AN000; ax = ax*2+1
 28219 000016BE 01C3                    	add	bx,ax			;AN000; now bx points to maxk
 28220 000016C0 268A0F                  	mov	cl,[es:bx]		;AN000;
 28221                                  	; 07/09/2023
 28222                                  	;xor	ch,ch ; ** (ch=0)	;AN000; cx = maxk
 28223                                  	;or	cx,cx			;AN000; at least one keyword ?
 28224                                  	;jz	short _$P_Key_Not_Found	;AN000;
 28225                                  	; 07/07/2023
 28226 000016C3 E305                    	jcxz	_$P_Key_Not_Found	; no
 28227                                  
 28228 000016C5 43                      	inc	bx			;AN000; now bx points to 1st CONTROL
 28229                                  
 28230                                  _$P_Key_Mgr_Loop:			;AN000;
 28231                                  	; 07/09/2023
 28232                                  	; ('_$P_Chk_Key_Control' contains only 'stc' instruction)
 28233                                  	; (always returns with cf=1)
 28234                                  	;push	bx			;AN000;
 28235                                  	;mov	bx,[es:bx]		;AN000; bx points to keyword CONTROL itself
 28236                                  	;call	_$P_Chk_Key_Control	;AN000; do process for keyword
 28237                                  	;pop	bx			;AN000;
 28238                                  	;jnc	short _$P_Return_to_Caller ;AN000; if the CONTROL is for the keyword, exit
 28239                                  	; 07/09/2023
 28240                                  	; cf=1 (after 'call _$P_Chk_Key_Control')
 28241                                  
 28242 000016C6 43                      	inc	bx			;AC035; add '2' to
 28243 000016C7 43                      	inc	bx			;AC035;  BX reg
 28244                                  					;AN000; else bx points to the next CONTROL
 28245 000016C8 E2FC                    	loop	_$P_Key_Mgr_Loop 	;AN000; and loop
 28246                                  
 28247                                  _$P_Key_Not_Found:			;AN000;
 28248 000016CA 2EC706[F514]0400        	mov	word [cs:_$P_RC],_$P_Not_In_Key ;AC034; here no CONTROL for the keyword has
 28249                                  _$P_Return_to_Caller:			;AN000;
 28250 000016D1 5D                      	pop	bp			;AN000;
 28251 000016D2 5F                      	pop	di			;AN000;
 28252 000016D3 5B                      	pop	bx			;AN000;
 28253 000016D4 2E8B0E[F314]            	mov	cx,[cs:_$P_ORDINAL]	;AC034; return next ordinal
 28254 000016D9 2EA1[F514]              	mov	ax,[cs:_$P_RC]		;AC034; return exit code
 28255 000016DD 2E8B36[F714]            	mov	si,[cs:_$P_SI_Save]	;AC034; return next operand pointer
 28256 000016E2 2E8B16[F914]            	mov	dx,[cs:_$P_DX]		;AC034; return result buffer address
 28257 000016E7 2E8A1E[FB14]            	mov	bl,[cs:_$P_Terminator]	;AC034; return delimiter code found
 28258                                  _$P_Single_Exit: 			;AN000;
 28259 000016EC F8                      	clc				;AN000;
 28260 000016ED C3                      	retn				;AN000;
 28261                                  
 28262                                  ;***********************************************************************
 28263                                  ; _$P_Chk_Pos_Control
 28264                                  ;
 28265                                  ; Function: Parse CONTROL block for a positional
 28266                                  ;
 28267                                  ; Input:     ES:BX -> CONTROL block
 28268                                  ;	     cs:SI -> _$P_STRING_BUF
 28269                                  ;
 28270                                  ; Output:    None
 28271                                  ;
 28272                                  ; Use:	 _$P_Fill_Result, _$P_Check_Match_Flags
 28273                                  ;
 28274                                  ; Vars: _$P_Ordinal(W), _$P_RC(W)
 28275                                  ;***********************************************************************
 28276                                  
 28277                                  _$P_Chk_Pos_Control:
 28278 000016EE 50                      	push	ax			;AN000;
 28279                                  	;mov	ax,[es:bx+_$P_Control_Blk.Match_Flag] ;AN000;
 28280 000016EF 268B07                  	mov	ax,[es:bx]
 28281                                  	; 12/12/2022
 28282 000016F2 A802                    	test	al,_$P_Repeat
 28283                                  	;test	ax,_$P_Repeat		;AN000; repeat allowed ?
 28284 000016F4 7505                    	jnz	short _$P_CPC00		;AN000; then do not increment ORDINAL
 28285                                  
 28286 000016F6 2EFF06[F314]            	inc	word [cs:_$P_ORDINAL]	;AC034; update the ordinal
 28287                                  _$P_CPC00:				;AN000;
 28288 000016FB 2E803C00                	cmp	byte [cs:si],_$P_NULL	;AN000; no data ?
 28289 000016FF 7517                    	jne	short _$P_CPC01		;AN000;
 28290                                  
 28291                                  	; 12/12/2022
 28292 00001701 A801                    	test	al,_$P_Optional
 28293                                  	;test	ax,_$P_Optional		;AN000; yes, then is it optional ?
 28294 00001703 7509                    	jnz	short _$P_CPC02		;AN000;
 28295                                  
 28296 00001705 2EC706[F514]0200        	mov	word [cs:_$P_RC],_$P_Op_Missing ;AC034; no, then error 3/17/87
 28297 0000170C EB0D                    	jmp	short _$P_CPC_Exit	;AN000;
 28298                                  
 28299                                  _$P_CPC02:				;AN000;
 28300 0000170E 50                      	push	ax			;AN000;
 28301                                  	;mov	al,_$P_String		;AN000; if it is optional return NULL
 28302                                  	;mov	ah,_$P_No_Tag		;AN000; no item tag indication
 28303                                  	; 07/07/2023
 28304 0000170F B803FF                  	mov	ax,(_$P_No_Tag<<8)|_$P_String
 28305 00001712 E89600                  	call	_$P_Fill_Result		;AN000;
 28306 00001715 58                      	pop	ax			;AN000;
 28307 00001716 EB03                    	jmp	short _$P_CPC_Exit	;AN000;
 28308                                  
 28309                                  _$P_CPC01:				;AN000;
 28310 00001718 E81101                  	call	_$P_Check_Match_Flags	;AN000;
 28311                                  _$P_CPC_Exit:				;AN000;
 28312 0000171B 58                      	pop	ax			;AN000;
 28313 0000171C C3                      	retn				;AN000;
 28314                                  
 28315                                  ;***********************************************************************
 28316                                  ; _$P_Chk_Key_Control
 28317                                  ;
 28318                                  ; Function: Parse CONTROL block for a keyword
 28319                                  ;
 28320                                  ; Input:     ES:BX -> CONTROL block
 28321                                  ;	     cs:SI -> _$P_STRING_BUF
 28322                                  ;
 28323                                  ; Output:    CY = 1 : not match
 28324                                  ;
 28325                                  ; Use:	 _$P_Fill_Result, _$P_Search_KEYorSW, _$P_Check_Match_Flags
 28326                                  ;
 28327                                  ; Vars: _$P_RC(W), _$P_SaveSI_Cmpx(W), _$P_KEYorSW_Ptr(R), _$P_Flags(W)
 28328                                  ;***********************************************************************
 28329                                  
 28330                                  ; 07/09/2023
 28331                                  ;_$P_Chk_Key_Control:
 28332                                  ;	stc				;AN000; this logic works when the KeySW
 28333                                  ;	retn				;AN000; is reset.
 28334                                  
 28335                                  ;***********************************************************************
 28336                                  ; _$P_Search_KEYorSW:
 28337                                  ;
 28338                                  ; Function: Seach specified keyword or switch from CONTROL
 28339                                  ;
 28340                                  ; Input:     ES:BX -> CONTROL block
 28341                                  ;	     cs:SI -> _$P_STRING_BUF
 28342                                  ;
 28343                                  ; Output:    CY = 1 : not match
 28344                                  ;
 28345                                  ; Use:	 _$P_String_Comp, _$P_MoveBP_NUL, _$P_Found_SYNONYM
 28346                                  ;***********************************************************************
 28347                                  
 28348                                  	; 25/10/2022 - Retro DOS v4.0
 28349                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:18B6h)
 28350                                  
 28351                                  _$P_Search_KEYorSW:			;AN000;
 28352 0000171D 55                      	push	bp			;AN000;
 28353 0000171E 51                      	push	cx			;AN000;
 28354 0000171F 268A4F08                	mov	cl,[es:bx+_$P_Control_Blk.nid] ;AN000; Get synonym count
 28355 00001723 30ED                    	xor	ch,ch			;AN000; and set it to cx
 28356                                  	;or	cx,cx			;AN000; No synonyms specified ?
 28357                                  	;jz	short _$P_KEYorSW_Not_Found ;AN000; then indicate not found by CY
 28358                                  	; 07/07/2023
 28359 00001725 E30D                    	jcxz	_$P_KEYorSW_Not_Found
 28360                                  
 28361                                  	;lea	bp,[es:bx+_$P_Control_Blk.KEYorSW] ;AN000; BP points to the 1st synonym
 28362                                  	; 25/10/2022
 28363 00001727 8D6F09                  	lea	bp,[bx+_$P_Control_Blk.KEYorSW]
 28364                                  	;lea	bp,[bx+9]
 28365                                  _$P_KEYorSW_Loop:			;AN000;
 28366 0000172A E8B903                  	call	_$P_String_Comp		;AN000; compare string in buffer w/ the synonym
 28367 0000172D 7308                    	jnc	short _$P_KEYorSW_Found	;AN000; If match, set it to synonym pointer
 28368                                  
 28369 0000172F E80E00                  	call	_$P_MoveBP_NUL		;AN000; else, bp points to the next string
 28370 00001732 E2F6                    	loop	_$P_KEYorSW_Loop 	;AN000; loop nid times
 28371                                  _$P_KEYorSW_Not_Found:			;AN000;
 28372 00001734 F9                      	stc				;AN000; indicate not found in synonym list
 28373 00001735 EB06                    	jmp	short _$P_KEYorSW_Exit	;AN000; and exit
 28374                                  
 28375                                  _$P_KEYorSW_Found:			;AN000;
 28376 00001737 2E892E[0815]            	mov	[cs:_$P_Found_SYNONYM],bp ;AC034; set synonym pointer
 28377 0000173C F8                      	clc				;AN000; indicate found
 28378                                  _$P_KEYorSW_Exit:			;AN000;
 28379 0000173D 59                      	pop	cx			;AN000;
 28380 0000173E 5D                      	pop	bp			;AN000;
 28381 0000173F C3                      	retn				;AN000;
 28382                                   
 28383                                  ;***********************************************************************
 28384                                  ; _$P_MoveBP_NUL
 28385                                  ;***********************************************************************
 28386                                  
 28387                                  _$P_MoveBP_NUL:
 28388                                  _$P_MBP_Loop:				;AN000;
 28389                                  	; 11/12/2022
 28390 00001740 26807E0000              	cmp	byte [es:bp],_$P_NULL	;AN000; Increment BP that points
 28391                                  	; 25/10/2022 (MSDOS 5.0 IO.SYS compatibility)
 28392                                  	; (SYSINIT:18DBh)
 28393                                   	;cmp     byte [es:bp+0],0
 28394 00001745 7403                    	je	short _$P_MBP_Exit	;AN000; to the synomym list
 28395                                  
 28396 00001747 45                      	inc	bp			;AN000; until
 28397 00001748 EBF6                    	jmp	short _$P_MBP_Loop	;AN000; NULL encountered.
 28398                                  
 28399                                  _$P_MBP_Exit:				;AN000;
 28400 0000174A 45                      	inc	bp			;AN000; bp points to next to NULL
 28401 0000174B C3                      	retn				;AN000;
 28402                                  
 28403                                  ;***********************************************************************
 28404                                  ; _$P_Chk_SW_Control
 28405                                  ;
 28406                                  ; Function: Parse CONTROL block for a switch
 28407                                  ;
 28408                                  ; Input:     ES:BX -> CONTROL block
 28409                                  ;	     cs:SI -> _$P_STRING_BUF
 28410                                  ;
 28411                                  ; Output:    CY = 1 : not match
 28412                                  ;
 28413                                  ; Use:	 _$P_Fill_Result, _$P_Search_KEYorSW, _$P_Check_Match_Flags
 28414                                  ;
 28415                                  ; Vars:  _$P_SaveSI_Cmpx(W), _$P_KEYorSW_Ptr(R), _$P_Flags(W)
 28416                                  ;***********************************************************************
 28417                                  
 28418                                  _$P_Chk_SW_Control:
 28419                                  
 28420                                  ;IF SwSW				;AN000;(Check if switch is supported)
 28421                                  	;or	byte [cs:_$P_Flags+1],10h
 28422 0000174C 2E800E[0115]10          	or	byte [cs:_$P_Flags2],_$P_SW_Cmp ;AC034; Indicate switch for later string comparison
 28423 00001752 E8C8FF                  	call	_$P_Search_KEYorSW	;AN000; Search the switch in the CONTROL block
 28424 00001755 7248                    	jc	short _$P_Chk_SW_Err0	;AN000; not found, then try next CONTROL
 28425                                  
 28426                                  	;and	[cs:_$P_Flags+],0EFh
 28427 00001757 2E8026[0115]EF          	and	byte [cs:_$P_Flags2],0FFh-_$P_SW_Cmp 
 28428                                  					;AC034; reset the indicator previously set
 28429 0000175D 50                      	push	ax			;AN000; 	      /switch:
 28430 0000175E 2EA1[0415]              	mov	ax,[cs:_$P_KEYorSW_Ptr] ;AC034;	      ^       ^
 28431 00001762 29F0                    	sub	ax,si			;AN000;  SI	KEYorSW
 28432 00001764 2E0106[0215]            	add	[cs:_$P_SaveSI_Cmpx],ax	;AC034; update for complex list
 28433 00001769 58                      	pop	ax			;AN000;
 28434                                  
 28435 0000176A 2E8B36[0415]            	mov	si,[cs:_$P_KEYorSW_Ptr] ;AC034; set si at the end or colon
 28436 0000176F 2E803C00                	cmp	byte [cs:si],_$P_NULL	;AN000; any data after colon
 28437 00001773 7525                    	jne	short _$P_CSW00		;AN000; if yes, process match flags
 28438                                  
 28439 00001775 2E807CFF3A              	cmp	byte [cs:si-1],_$P_Colon ;AN000; if no, the switch terminated by colon ?
 28440 0000177A 7509                    	jne	short _$P_Chk_if_data_required ;AN000; if yes,
 28441                                  
 28442 0000177C 2EC706[F514]0900        	mov	word [cs:_$P_RC],_$P_Syntax ;AC034; return syntax error
 28443 00001783 EB1C                    	jmp	short _$P_Chk_SW_Exit	;AN000;
 28444                                  
 28445                                  _$P_Chk_if_data_required:		;AN018; no data, no colon
 28446                                  	;cmp	word [es:bx+_$P_Control_Blk.Match_Flag],0 
 28447 00001785 26833F00                	cmp	word [es:bx],0		;AN018; should have data? zero match flag means switch followed by nothing is OK
 28448 00001789 7416                    	je	short _$P_Chk_SW_Exit	;AN018; match flags not zero so should have something if optional bit is not on
 28449                                  
 28450                                  	;test	word [es:bx+_$P_Control_Blk.Match_Flag],_$P_Optional 
 28451                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYINIT compatibility)
 28452                                  	;test	word [es:bx],1
 28453                                  	; 12/12/2022
 28454                                  	;test	word [es:bx],_$P_Optional ;AN019; see if no value is valid
 28455 0000178B 26F60701                	test	byte [es:bx],_$P_Optional
 28456 0000178F 7510                    	jnz	short _$P_Chk_SW_Exit	;AN019; if so, then leave, else yell
 28457                                  
 28458 00001791 2EC706[F514]0200        	mov	word [cs:_$P_RC],_$P_Op_Missing ;AC034; return required operand missing
 28459 00001798 EB07                    	jmp	short _$P_Chk_SW_Exit	;AN018;
 28460                                  
 28461                                  _$P_CSW00:				;AN000;
 28462 0000179A E88F00                  	call	_$P_Check_Match_Flags	;AN000; process match flag
 28463 0000179D F8                      	clc				;AN000; indicate match
 28464                                  	;jmp	short _$P_Chk_SW_Single_Exit ;AN000;
 28465                                  	; 12/12/2022
 28466 0000179E C3                      	retn
 28467                                  
 28468                                  _$P_Chk_SW_Err0: 			;AN000;
 28469 0000179F F9                      	stc				;AN000; not found in switch synonym list
 28470                                  	;jmp	short _$P_Chk_SW_Single_Exit ;AN000;
 28471                                  	; 12/12/2022
 28472 000017A0 C3                      	retn	
 28473                                  
 28474                                  _$P_Chk_SW_Exit: 			;AN000;
 28475 000017A1 50                      	push	ax			;AN000;
 28476                                  	;mov	al,_$P_String		;AN000;
 28477                                  	;mov	ah,_$P_No_Tag		;AN000;
 28478                                  	; 07/07/2023
 28479 000017A2 B803FF                  	mov	ax,(_$P_No_Tag<<8)|_$P_String
 28480 000017A5 E80300                  	call	_$P_Fill_Result		;AN000; set result buffer
 28481 000017A8 58                      	pop	ax			;AN000;
 28482 000017A9 F8                      	clc				;AN000;
 28483                                  _$P_Chk_SW_Single_Exit:			;AN000;
 28484 000017AA C3                      	retn				;AN000;
 28485                                  ;ELSE					;AN000;(of IF SwSW)
 28486                                  ;	stc				;AN000; this logic works when the SwSW
 28487                                  ;	retn				;AN000; is reset.
 28488                                  
 28489                                  ;***********************************************************************
 28490                                  ; _$P_Fill_Result
 28491                                  ;
 28492                                  ; Function: Fill the result buffer
 28493                                  ;
 28494                                  ; Input:    AH = Item tag
 28495                                  ;	    AL = type
 28496                                  ;		  AL = 1: CX,DX has 32bit number (CX = high)
 28497                                  ;		  AL = 2: DX has index(offset) into value list
 28498                                  ;		  AL = 6: DL has driver # (1-A, 2-B, ... , 26 - Z)
 28499                                  ;		  AL = 7: DX has year, CL has month and CH has date
 28500                                  ;		  AL = 8: DL has hours, DH has minutes, CL has seconds,
 28501                                  ;			  amd CH has hundredths
 28502                                  ;		  AL = else: cs:SI points to returned string buffer
 28503                                  ;	    ES:BX -> CONTROL block
 28504                                  ;
 28505                                  ; Output:   None
 28506                                  ;
 28507                                  ; Use:	_$P_Do_CAPS_String, _$P_Remove_Colon, _$P_Found_SYNONYM
 28508                                  ;
 28509                                  ; Vars: _$P_DX(W)
 28510                                  ;***********************************************************************
 28511                                  
 28512                                  _$P_Fill_Result:
 28513 000017AB 57                      	push	di			;AN000;
 28514 000017AC 268B7F04                	mov	di,[es:bx+_$P_Control_Blk.Result_Buf]
 28515                                  					;AN000; di points to result buffer
 28516 000017B0 2E893E[F914]            	mov	[cs:_$P_DX],di		;AC034; set returned result address
 28517                                  	;mov	[es:di+_$P_Result_Blk.Type],al ;AN000; store type
 28518                                  	;mov	[es:di+_$P_Result_Blk.Item_Tag],ah ;AN000; store item tag
 28519                                  	; 07/09/2023
 28520                                  	;mov	[es:di+_$P_Result_Blk.Type], ax
 28521 000017B5 268905                  	mov	[es:di],ax		; store type (al) and item tag (ah)
 28522                                  
 28523 000017B8 50                      	push	ax			;AN000;
 28524 000017B9 2EA1[0815]              	mov	ax,[cs:_$P_Found_SYNONYM] ;AC034; if yes,
 28525 000017BD 26894502                	mov	[es:di+_$P_Result_Blk.SYNONYM_Ptr],ax 
 28526                                  					;AN000;   then set it to the result
 28527 000017C1 58                      	pop	ax			;AN000;
 28528                                  _$P_RLT04:				;AN000;
 28529 000017C2 3C01                    	cmp	al,_$P_Number		;AN000; if number
 28530 000017C4 750A                    	jne	short _$P_RLT00		;AN000;
 28531                                  
 28532                                  _$P_RLT02:				;AN000;
 28533 000017C6 26895504                	mov	[es:di+_$P_Result_Blk.Picked_Val],dx ;AN000; then store 32bit
 28534 000017CA 26894D06                	mov	[es:di+_$P_Result_Blk.Picked_Val+2],cx ;AN000; number
 28535 000017CE EB5A                    	jmp	short _$P_RLT_Exit	;AN000;
 28536                                  
 28537                                  _$P_RLT00:				;AN000;
 28538 000017D0 3C02                    	cmp	al,_$P_List_Idx		;AN000; if list index
 28539 000017D2 7506                    	jne	short _$P_RLT01		;AN000;
 28540                                  
 28541 000017D4 26895504                	mov	[es:di+_$P_Result_Blk.Picked_Val],dx 
 28542                                  					;AN000; then store list index
 28543 000017D8 EB50                    	jmp	short _$P_RLT_Exit	;AN000;
 28544                                  
 28545                                  _$P_RLT01:				;AN000;
 28546 000017DA 3C07                    	cmp	al,_$P_Date_F		;AN000; Date format ?
 28547 000017DC 74E8                    	je	short _$P_RLT02		;AN000;
 28548                                  
 28549 000017DE 3C08                    	cmp	al,_$P_Time_F		;AN000; Time format ?
 28550 000017E0 74E4                    	je	short _$P_RLT02		;AN000;
 28551                                  
 28552 000017E2 3C06                    	cmp	al,_$P_Drive		;AN000; drive format ?
 28553 000017E4 7506                    	jne	short _$P_RLT03		;AN000;
 28554                                  
 28555 000017E6 26885504                	mov	[es:di+_$P_Result_Blk.Picked_Val],dl ;AN000; store drive number
 28556 000017EA EB3E                    	jmp	short _$P_RLT_Exit	;AN000;
 28557                                  
 28558                                  _$P_RLT03:				;AN000;
 28559 000017EC 3C04                    	cmp	al,_$P_Complex		;AN000; complex format ?
 28560 000017EE 750F                    	jne	short _$P_RLT05		;AN000;
 28561                                  
 28562 000017F0 2EA1[0215]              	mov	ax,[cs:_$P_SaveSI_Cmpx] ;AC034; then get pointer in command buffer
 28563 000017F4 40                      	inc	ax			;AN000; skip left Parentheses
 28564 000017F5 26894504                	mov	[es:di+_$P_Result_Blk.Picked_Val],ax ;AN000; store offset
 28565 000017F9 268C5D06                	mov	[es:di+_$P_Result_Blk.Picked_Val+2],ds ;AN000; store segment
 28566 000017FD EB2B                    	jmp	short _$P_RLT_Exit	;AN000;
 28567                                  
 28568                                  _$P_RLT05:				;AN000;
 28569                                  ;------------------------  AL = 3, 5, or 9
 28570 000017FF 26897504                	mov	[es:di+_$P_Result_Blk.Picked_Val],si 
 28571                                  					;AN000; store offset of STRING_BUF
 28572 00001803 268C4D06                	mov	[es:di+_$P_Result_Blk.Picked_Val+2],cs 
 28573                                  					;AN031; store segment of STRING_BUF
 28574 00001807 50                      	push	ax			;AN000;
 28575 00001808 26F6470201              	test	byte [es:bx+_$P_Control_Blk.Function_Flag],_$P_CAP_File 
 28576                                  					;AN000; need CAPS by file table?
 28577 0000180D 7404                    	jz	short _$P_RLT_CAP00	;AN000;
 28578                                  
 28579 0000180F B004                    	mov	al,_$P_DOSTBL_File	;AN000; use file upper case table
 28580 00001811 EB09                    	jmp	short _$P_RLT_CAP02	;AN000;
 28581                                  
 28582                                  _$P_RLT_CAP00:				;AN000;
 28583 00001813 26F6470202              	test	byte [es:bx+_$P_Control_Blk.Function_Flag],_$P_CAP_Char 
 28584                                  					;AN000; need CAPS by char table ?
 28585 00001818 7405                    	jz	short _$P_RLT_CAP01	;AN000;
 28586                                  
 28587 0000181A B002                    	mov	al,_$P_DOSTBL_Char	;AN000; use character upper case table
 28588                                  _$P_RLT_CAP02:				;AN000;
 28589 0000181C E8DF00                  	call	_$P_Do_CAPS_String	;AN000; process CAPS along the table
 28590                                  _$P_RLT_CAP01:				;AN000;
 28591 0000181F 58                      	pop	ax			;AN000;
 28592 00001820 26F6470210              	test	byte [es:bx+_$P_Control_Blk.Function_Flag],_$P_Rm_Colon 
 28593                                  					;AN000; removing colon at end ?
 28594 00001825 7403                    	jz	short _$P_RLT_Exit	;AN000;
 28595                                  
 28596 00001827 E8AE00                  	call	_$P_Remove_Colon 	;AN000; then process it.
 28597                                  _$P_RLT_Exit:				;AN000;
 28598 0000182A 5F                      	pop	di			;AN000;
 28599 0000182B C3                      	retn				;AN000;
 28600                                  
 28601                                  ;***********************************************************************
 28602                                  ; _$P_Check_Match_Flags
 28603                                  ;
 28604                                  ; Function:  Check the match_flags and make the exit code and set the
 28605                                  ;	     result buffer
 28606                                  ;
 28607                                  ;	    Check for types in this order:
 28608                                  ;		Complex
 28609                                  ;		Date
 28610                                  ;		Time
 28611                                  ;		Drive
 28612                                  ;		Filespec
 28613                                  ;		Quoted String
 28614                                  ;		Simple String
 28615                                  ;
 28616                                  ; Input:     cs:SI -> _$P_STRING_BUF
 28617                                  ;	     ES:BX -> CONTROL block
 28618                                  ;
 28619                                  ; Output:    None
 28620                                  ;
 28621                                  ; Use:	     _$P_Value, P$_SValue, _$P_Simple_String, _$P_Date_Format
 28622                                  ;	     _$P_Time_Format, _$P_Complex_Format, _$P_File_Foemat
 28623                                  ;	     _$P_Drive_Format
 28624                                  ;***********************************************************************
 28625                                  
 28626                                  	; 25/10/2022 - Retro DOS v4.0
 28627                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:19CFh)
 28628                                  
 28629                                  	; 12/12/2022
 28630                                  _$P_Check_Match_Flags:
 28631 0000182C 2EC606[9815]00          	mov	byte [cs:_$P_err_flag],_$P_NULL 
 28632                                  					;AN033;AC034;; clear filespec error flag.
 28633 00001832 50                      	push	ax			;AN000;
 28634                                  	;mov	ax,[es:bx+_$P_Control_Blk.Match_Flag]
 28635 00001833 268B07                  	mov	ax,[es:bx]		;AN000; load match flag(16bit) to ax
 28636 00001836 09C0                    	or	ax,ax			;AC035; test ax for zero
 28637 00001838 7517                    	jnz	short _$P_Mat		;AN000; (tm12)
 28638 0000183A 50                      	push	ax			;AN000; (tm12)
 28639 0000183B 53                      	push	bx			;AN000; (tm12)
 28640 0000183C 52                      	push	dx			;AN000; (tm12)
 28641 0000183D 57                      	push	di			;AN000; (tm12)
 28642 0000183E 2EC706[F514]0900        	mov	word [cs:_$P_RC],_$P_Syntax ;AC034; (tm12)
 28643                                  	;mov	ah,_$P_No_Tag		;AN000; (tm12)
 28644                                  	;mov	al,_$P_String		;AN000; (tm12)
 28645                                  	; 07/07/2023
 28646 00001845 B803FF                  	mov	ax,(_$P_No_Tag<<8)|_$P_String
 28647 00001848 E860FF                  	call	_$P_Fill_Result		;AN000; (tm12)
 28648 0000184B 5F                      	pop	di			;AN000; (tm12)
 28649 0000184C 5A                      	pop	dx			;AN000; (tm12)
 28650 0000184D 5B                      	pop	bx			;AN000; (tm12)
 28651 0000184E 58                      	pop	ax			;AN000; (tm12)
 28652                                  	; 12/12/2022
 28653                                  	;jmp	short _$P_Bridge 	;AC035; (tm12)
 28654                                  	; 12/12/2022
 28655                                  ;_$P_Mat: 				;AN000; (tm12)
 28656                                  	;jmp	short _$P_Match03	;AN025; (tm09)
 28657                                  _$P_Bridge:
 28658 0000184F EB6E                    	jmp	short _$P_Match_Exit	;AN000; (tm02)
 28659                                  	
 28660                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 28661                                  	; (SYSINIT:19F9h)
 28662                                  	; 12/12/2022
 28663                                  	;nop	; db 90h
 28664                                  
 28665                                  ; 12/12/2022
 28666                                  _$P_Mat:
 28667                                  _$P_Match03:				;AN000;
 28668                                  	;test	ax,_$P_Num_Val ; 8000h	;AN000; Numeric value
 28669                                  	; 07/07/2023
 28670 00001851 F6C480                  	test	ah,(_$P_Num_Val>>8) ; 80h
 28671 00001854 7412                    	jz	short _$P_Match04	;AN000;
 28672                                  
 28673 00001856 2EC706[F514]0000        	mov	word [cs:_$P_RC],_$P_No_Error ;AC034; assume no error
 28674 0000185D E81E01                  	call	_$P_Value		;AN000; do process
 28675 00001860 2E833E[F514]09          	cmp	word [cs:_$P_RC],_$P_Syntax ;AC034; if error, examine the next type
 28676 00001866 7557                    	jne	short _$P_Match_Exit	;AN000;
 28677                                  _$P_Match04:				;AN000;
 28678                                  	;test	ax,_$P_SNum_Val ; 4000h	;AN000; Signed numeric value
 28679                                  	; 07/07/2023
 28680 00001868 F6C440                  	test	ah,(_$P_SNum_Val>>8) ; 40h
 28681 0000186B 7412                    	jz	short _$P_Match05	;AN000;
 28682                                  
 28683 0000186D 2EC706[F514]0000        	mov	word [cs:_$P_RC],_$P_No_Error ;AC034; assume no error
 28684 00001874 E8E300                  	call	_$P_SValue		;AN000; do process
 28685 00001877 2E833E[F514]09          	cmp	word [cs:_$P_RC],_$P_Syntax ;AC034; if error, examine the next type
 28686 0000187D 7540                    	jne	short _$P_Match_Exit	;AN000;
 28687                                  _$P_Match05:				;AN000;
 28688                                  	;test	ax,_$P_Drv_Only ; 100h	;AN000; Drive only
 28689                                  	; 07/07/2023
 28690 0000187F F6C401                  	test	ah,(_$P_Drv_Only>>8) ; 1
 28691 00001882 7415                    	jz	short _$P_Match06	;AN000;
 28692                                  
 28693 00001884 2EC706[F514]0000        	mov	word [cs:_$P_RC],_$P_No_Error ;AC034; assume no error
 28694 0000188B E8F602                  	call	_$P_File_Format		;AN000; 1st, call file format
 28695 0000188E E87603                  	call	_$P_Drive_Format	;AN000; check drive format, next
 28696 00001891 2E833E[F514]09          	cmp	word [cs:_$P_RC],_$P_Syntax ;AC034; if error, examine the next type
 28697 00001897 7526                    	jne	short _$P_Match_Exit	;AN000;
 28698                                  _$P_Match06:				;AN000;
 28699                                  	;test	ax,_$P_File_Spc ; 200h	;AN000; File spec
 28700                                  	; 07/07/2023
 28701 00001899 F6C402                  	test	ah,(_$P_File_Spc>>8) ; 2
 28702 0000189C 7412                    	jz	short _$P_Match07	;AN000;
 28703                                  
 28704 0000189E 2EC706[F514]0000        	mov	word [cs:_$P_RC],_$P_No_Error ;AC034; assume no error
 28705 000018A5 E8DC02                  	call	_$P_File_Format		;AN000; do process
 28706 000018A8 2E833E[F514]09          	cmp	word [cs:_$P_RC],_$P_Syntax ;AC034; if error, examine the next type
 28707 000018AE 750F                    	jne	short _$P_Match_Exit	;AN000;
 28708                                  _$P_Match07:				;AN000;
 28709                                  	;test	ax,_$P_Simple_S	; 2000h	;AN000; Simple string
 28710                                  	; 07/07/2023
 28711 000018B0 F6C420                  	test	ah,(_$P_Simple_S>>8) ; 20h
 28712 000018B3 740A                    	jz	short _$P_Match09	;AN000;
 28713                                  
 28714 000018B5 2EC706[F514]0000        	mov	word [cs:_$P_RC],_$P_No_Error ;AC034; assume no error
 28715 000018BC E8BE01                  	call	_$P_Simple_String	;AN000; do process
 28716                                  _$P_Match09:				;AN000;
 28717                                  _$P_Match_Exit:				;AN000;
 28718 000018BF 2E833E[9815]01          	cmp	word [cs:_$P_err_flag],_$P_error_filespec ;AC034; bad filespec ?
 28719 000018C5 750F                    	jne	short _$P_Match2_Exit	;AN033; no, continue
 28720 000018C7 2E833E[F514]00          	cmp	word [cs:_$P_RC],_$P_No_Error ;AN033;AC034;; check for other errors ?
 28721 000018CD 7507                    	jne	short _$P_Match2_Exit	;AN033; no, continue
 28722 000018CF 2EC706[F514]0900        	mov	word [cs:_$P_RC],_$P_Syntax ;AN033;AC034;; set error flag
 28723                                  _$P_Match2_Exit: 			;AN033;
 28724 000018D6 58                      	pop	ax			;AN000;
 28725 000018D7 C3                      	retn				;AN000;
 28726                                  
 28727                                  ;***********************************************************************
 28728                                  ; _$P_Remove_Colon;
 28729                                  ;
 28730                                  ; Function: Remove colon at end
 28731                                  ;
 28732                                  ; Input:    cs:SI points to string buffer to be examineed
 28733                                  ;
 28734                                  ; Output:   None
 28735                                  ;
 28736                                  ; Use:	_$P_Chk_DBCS
 28737                                  ;***********************************************************************
 28738                                  
 28739                                  _$P_Remove_Colon:
 28740 000018D8 50                      	push	ax			;AN000;
 28741 000018D9 56                      	push	si			;AN000;
 28742                                  _$P_RCOL_Loop:				;AN000;
 28743 000018DA 2E8A04                  	mov	al,[cs:si]		;AN000; get character
 28744 000018DD 08C0                    	or	al,al			;AN000; end of string ?
 28745 000018DF 741A                    	jz	short _$P_RCOL_Exit	;AN000; if yes, just exit
 28746                                  
 28747 000018E1 3C3A                    	cmp	al,_$P_Colon		;AN000; is it colon ?
 28748 000018E3 750D                    	jne	short _$P_RCOL00	;AN000;
 28749                                  
 28750 000018E5 2E807C0100              	cmp	byte [cs:si+1],_$P_NULL ;AN000; if so, next is NULL ?
 28751 000018EA 7506                    	jne	short _$P_RCOL00	;AN000; no, then next char
 28752                                  
 28753 000018EC 2EC60400                	mov	byte [cs:si],_$P_NULL	;AN000; yes, remove colon
 28754 000018F0 EB09                    	jmp	short _$P_RCOL_Exit	;AN000; and exit.
 28755                                  
 28756                                  _$P_RCOL00:				;AN000;
 28757 000018F2 E81204                  	call	_$P_Chk_DBCS		;AN000; if not colon, then check if
 28758 000018F5 7301                    	jnc	short _$P_RCOL01	;AN000; DBCS leading byte.
 28759                                  
 28760 000018F7 46                      	inc	si			;AN000; if yes, skip trailing byte
 28761                                  _$P_RCOL01:				;AN000;
 28762 000018F8 46                      	inc	si			;AN000; si points to next byte
 28763 000018F9 EBDF                    	jmp	short _$P_RCOL_Loop	;AN000; loop until NULL encountered
 28764                                  
 28765                                  _$P_RCOL_Exit:				;AN000;
 28766 000018FB 5E                      	pop	si			;AN000;
 28767 000018FC 58                      	pop	ax			;AN000;
 28768 000018FD C3                      	retn				;AN000;
 28769                                  
 28770                                  ;***********************************************************************
 28771                                  ; _$P_Do_CAPS_String;
 28772                                  ;
 28773                                  ; Function: Perform capitalization along with the file case map table
 28774                                  ;	    or character case map table.
 28775                                  ;
 28776                                  ; Input:    AL = 2 : Use character table
 28777                                  ;	    AL = 4 : Use file table
 28778                                  ;	    cs:SI points to string buffer to be capitalized
 28779                                  ;
 28780                                  ; Output:   None
 28781                                  ;
 28782                                  ; Use:	_$P_Do_CAPS_Char, _$P_Chk_DBCS
 28783                                  ;***********************************************************************
 28784                                  
 28785                                  _$P_Do_CAPS_String:
 28786 000018FE 56                      	push	si			;AN000;
 28787 000018FF 52                      	push	dx			;AN000;
 28788 00001900 88C2                    	mov	dl,al			;AN000; save info id
 28789                                  _$P_DCS_Loop:				;AN000;
 28790 00001902 2E8A04                  	mov	al,[cs:si]		;AN000; load charater and
 28791 00001905 E8FF03                  	call	_$P_Chk_DBCS		;AN000; check if DBCS leading byte
 28792 00001908 720C                    	jc	short _$P_DCS00		;AN000; if yes, do not need CAPS
 28793                                  
 28794 0000190A 08C0                    	or	al,al			;AN000; end of string ?
 28795 0000190C 740C                    	jz	short _$P_DCS_Exit	;AN000; then exit.
 28796                                  
 28797 0000190E E80C00                  	call	_$P_Do_CAPS_Char 	;AN000; Here a SBCS char need to be CAPS
 28798 00001911 2E8804                  	mov	[cs:si],al		;AN000; stored upper case char to buffer
 28799 00001914 EB01                    	jmp	short _$P_DCS01		;AN000; process next
 28800                                  _$P_DCS00:				;AN000;
 28801 00001916 46                      	inc	si			;AN000; skip DBCS leading and trailing byte
 28802                                  _$P_DCS01:				;AN000;
 28803 00001917 46                      	inc	si			;AN000; si point to next byte
 28804 00001918 EBE8                    	jmp	short _$P_DCS_Loop	;AN000; loop until NULL encountered
 28805                                  _$P_DCS_Exit:				;AN000;
 28806 0000191A 5A                      	pop	dx			;AN000;
 28807 0000191B 5E                      	pop	si			;AN000;
 28808 0000191C C3                      	retn
 28809                                  
 28810                                  ;***********************************************************************
 28811                                  ; _$P_Do_CAPS_Char;
 28812                                  ;
 28813                                  ; Function: Perform capitalization along with the file case map table
 28814                                  ;	    or character case map table.
 28815                                  ;
 28816                                  ; Input:    DL = 2 : Use character table
 28817                                  ;	    DL = 4 : Use file table
 28818                                  ;	    AL = character to be capitalized
 28819                                  ;
 28820                                  ; Output:   None
 28821                                  ;
 28822                                  ; Use:	INT 21h /w AH=65h
 28823                                  ;***********************************************************************
 28824                                  
 28825                                  _$P_Do_CAPS_Char:
 28826 0000191D 3C80                    	cmp	al,_$P_ASCII80	;80h	;AN000; need upper case table ?
 28827 0000191F 730B                    	jae	short _$P_DCC_Go	;AN000; no
 28828                                  
 28829 00001921 3C61                    	cmp	al,"a"                  ;AN000; check if  "a" <= AL <= "z"
 28830 00001923 7234                    	jb	short _$P_CAPS_Ret	;AN000;   
 28831                                  
 28832 00001925 3C7A                    	cmp	al,"z"                  ;AN000;
 28833 00001927 7730                    	ja	short _$P_CAPS_Ret	;AN000;
 28834                                  
 28835 00001929 24DF                    	and	al,_$P_Make_Upper ;0DFh ;AN000; make CAPS
 28836                                  	;jmp	short _$P_CAPS_Ret	;AN000;
 28837                                  	; 07/07/2023
 28838 0000192B C3                      	retn
 28839                                  
 28840                                  _$P_DCC_Go:				;AN000;
 28841 0000192C 53                      	push	bx			;AN000;
 28842 0000192D 06                      	push	es			;AN000;
 28843 0000192E 57                      	push	di			;AN000;
 28844                                  
 28845                                  	;;lea	di,[cs:_$P_Char_CAP_Ptr] ;AC034; or use char CAPS table ?
 28846                                  	;lea	di,[_$P_Char_CAP_Ptr]
 28847                                  	; 07/09/2023
 28848 0000192F BF[8A15]                	mov	di,_$P_Char_CAP_Ptr
 28849                                  _$P_DCC00:				;AN000;
 28850 00001932 2E3815                  	cmp	[cs:di],dl		;AN000; already got table address ?
 28851 00001935 7415                    	je	short _$P_DCC01		;AN000; no
 28852                                  
 28853                                  ;In this next section, ES will be used to pass a 5 byte workarea to INT 21h,
 28854                                  ; the GET COUNTYRY INFO call. This usage of ES is required by the function
 28855                                  ; call, regardless of what base register is currently be defined as cs.
 28856                                  
 28857 00001937 50                      	push	ax			;AN000; get CAPS table thru DOS call
 28858 00001938 51                      	push	cx			;AN000;
 28859 00001939 52                      	push	dx			;AN000;
 28860                                  
 28861 0000193A 0E                      	push	cs			;AC036; pass current base seg into
 28862                                  					;(Note: this used to push CS.  BUG...
 28863 0000193B 07                      	pop	es			;AN000;   ES reg, required for
 28864                                  					;get extended country information
 28865                                  	;mov	al,dl ; function	;AN000; upper case table
 28866                                  	; 07/07/2023
 28867 0000193C 92                      	xchg	ax,dx
 28868 0000193D B465                    	mov	ah,_$P_DOS_Get_TBL ; 65h ;AN000; get extended CDI
 28869 0000193F BBFFFF                  	mov	bx,_$P_DOSTBL_Def ; -1	;AN000; get active CON
 28870 00001942 B90500                  	mov	cx,_$P_DOSTBL_BL ; 5	;AN000; buffer length
 28871                                  	;mov	dx,_$P_DOSTBL_Def	;AN000; get for default code page
 28872                                  	; 07/07/2023
 28873 00001945 89DA                    	mov	dx,bx ; 0FFFFh
 28874                                  					;DI already set to point to buffer
 28875 00001947 CD21                    	int	21h			;AN000; es:di point to buffer that
 28876                                  					;now has been filled in with info
 28877 00001949 5A                      	pop	dx			;AN000;
 28878 0000194A 59                      	pop	cx			;AN000;
 28879 0000194B 58                      	pop	ax			;AN000;
 28880                                  
 28881                                  _$P_DCC01:				;AN000;
 28882                                  
 28883                                  ;In this next section, ES will be used as the base of the XLAT table, provided
 28884                                  ; by the previous GET COUNTRY INFO DOS call. This usage of ES is made
 28885                                  ; regardless of which base reg is currently the cs reg.
 28886                                  
 28887                                  	;mov	bx,[cs:di+_$P_DOS_TBL.Off] ;AN000; get offset of table
 28888                                  	;mov	es,[cs:di+_$P_DOS_TBL.Seg] ;AN000; get segment of table
 28889                                  	; 07/07/2023
 28890 0000194C 2EC45D01                	les	bx,[cs:di+_$P_DOS_TBL.Off]
 28891 00001950 43                      	inc	bx			;AC035; add '2' to
 28892 00001951 43                      	inc	bx			;AC035;  BX reg
 28893                                  					;AN000; skip length field
 28894 00001952 2C80                    	sub	al,_$P_ASCII80 ; 80h	;AN000; make char to index
 28895                                  	;xlat	es:[bx] 		;AN000; perform case map
 28896 00001954 26                      	es
 28897 00001955 D7                      	xlat
 28898 00001956 5F                      	pop	di			;AN000;
 28899 00001957 07                      	pop	es			;AN000;
 28900 00001958 5B                      	pop	bx			;AN000;
 28901                                  _$P_CAPS_Ret:				;AN000;
 28902 00001959 C3                      	retn				;AN000;
 28903                                  
 28904                                  ;***********************************************************************
 28905                                  ; _$P_Value / _$P_SValue
 28906                                  ;
 28907                                  ; Function:  Make 32bit value from cs:SI and see value list
 28908                                  ;	     and make result buffer.
 28909                                  ;	     _$P_SValue is an entry point for the signed value
 28910                                  ;	     and this will simply call _$P_Value after the handling
 28911                                  ;	     of the sign character, "+" or "-"
 28912                                  ;
 28913                                  ; Input:     cs:SI -> _$P_STRING_BUF
 28914                                  ;	     ES:BX -> CONTROL block
 28915                                  ;
 28916                                  ; Output:    None
 28917                                  ;
 28918                                  ; Use:	_$P_Fill_Result, _$P_Check_OVF
 28919                                  ;
 28920                                  ; Vars: _$P_RC(W), _$P_Flags(RW)
 28921                                  ;***********************************************************************
 28922                                  
 28923                                  	; 26/10/2022 - Retro DOS v4.0
 28924                                  	; (MSDOS 5.0 IO.SYS - SYSINIT:1B0Bh)
 28925                                  
 28926                                  	; 07/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 28927                                  	; (MSDOS 6.21 IO.SYS - SYSINIT:1C46h)  	
 28928                                  _$P_SValue:				;AN000; when signed value here
 28929 0000195A 50                      	push	ax			;AN000;
 28930 0000195B 2E800E[0115]80          	or	byte [cs:_$P_Flags2],_$P_Signed ;AC034; indicate a signed numeric
 28931 00001961 2E8026[0115]FD          	and	byte [cs:_$P_Flags2],0FFh-_$P_Neg ;AC034; assume positive value
 28932                                  	;and	byte [cs:_$P_Flags2],~_$P_Neg ; 07/07/2023 
 28933 00001967 2E8A04                  	mov	al,[cs:si]		;AN000; get sign
 28934 0000196A 3C2B                    	cmp	al,_$P_Plus		;AN000; "+" ?
 28935 0000196C 740A                    	je	short _$P_SVal00	;AN000;
 28936                                  
 28937 0000196E 3C2D                    	cmp	al,_$P_Minus		;AN000; "-" ?
 28938 00001970 7507                    	jne	short _$P_Sval01	;AN000; else
 28939                                  
 28940 00001972 2E800E[0115]02          	or	byte [cs:_$P_Flags2],_$P_Neg ;AC034; set this is negative value
 28941                                  _$P_SVal00:				;AN000;
 28942 00001978 46                      	inc	si			;AN000; skip sign char
 28943                                  _$P_Sval01:				;AN000;
 28944 00001979 E80200                  	call	_$P_Value		;AN000; and process value
 28945 0000197C 58                      	pop	ax			;AN000;
 28946 0000197D C3                      	retn
 28947                                  
 28948                                  ;***********************************************************************
 28949                                  
 28950                                  	; 07/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 28951                                  	; (MSDOS 6.21 IO.SYS - SYSINIT:1C6Ah)
 28952                                  
 28953                                  	; 26/10/2022
 28954                                  _$P_Value:				;AN000;
 28955 0000197E 50                      	push	ax			;AN000;
 28956 0000197F 51                      	push	cx			;AN000;
 28957 00001980 52                      	push	dx			;AN000;
 28958 00001981 56                      	push	si			;AN000;
 28959 00001982 31C9                    	xor	cx,cx			;AN000; cx = higher 16 bits
 28960 00001984 31D2                    	xor	dx,dx			;AN000; dx = lower 16 bits
 28961 00001986 53                      	push	bx			;AN000; save control pointer
 28962                                  _$P_Value_Loop:				;AN000;
 28963 00001987 2E8A04                  	mov	al,[cs:si]		;AN000; get character
 28964 0000198A 08C0                    	or	al,al			;AN000; end of line ?
 28965 0000198C 743C                    	jz	short _$P_Value00	;AN000;
 28966                                  
 28967 0000198E E8E000                  	call	_$P_0099 		;AN000; make asc(0..9) to bin(0..9)
 28968 00001991 7233                    	jc	short _$P_Value_Err0	;AN000;
 28969                                  
 28970 00001993 30E4                    	xor	ah,ah			;AN000;
 28971 00001995 89C5                    	mov	bp,ax			;AN000; save binary number
 28972                                  
 28973                                  ; 08/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 28974                                  ; Ref: Disassembled PCDOS 7.1 IBMBIO.COM SYSINIT code
 28975                                  ;				Erdogan Tan - July 2023 
 28976                                  %if 0
 28977                                  	shl	dx,1			;AN000; to have 2*x
 28978                                  	rcl	cx,1			;AN000; shift left w/ carry
 28979                                  	call	_$P_Check_OVF		;AN000; Overflow occurred ?
 28980                                  	jc	short _$P_Value_Err0	;AN000; then error, exit
 28981                                  
 28982                                  	mov	bx,dx			;AN000; save low(2*x)
 28983                                  	mov	ax,cx			;AN000; save high(2*x)
 28984                                  	shl	dx,1			;AN000; to have 4*x
 28985                                  	rcl	cx,1			;AN000; shift left w/ carry
 28986                                  	call	_$P_Check_OVF		;AN000; Overflow occurred ?
 28987                                  	jc	short _$P_Value_Err0	;AN000; then error, exit
 28988                                  
 28989                                  	shl	dx,1			;AN000; to have 8*x
 28990                                  	rcl	cx,1			;AN000; shift left w/ carry
 28991                                  	call	_$P_Check_OVF		;AN000; Overflow occurred ?
 28992                                  	jc	short _$P_Value_Err0	;AN000; then error, exit
 28993                                  
 28994                                  	add	dx,bx			;AN000; now have 10*x
 28995                                  	adc	cx,ax			;AN000; 32bit ADD
 28996                                  	call	_$P_Check_OVF		;AN000; Overflow occurred ?
 28997                                  	jc	short _$P_Value_Err0	;AN000; then error, exit
 28998                                  
 28999                                  	add	dx,bp			;AN000; Add the current one degree decimal
 29000                                  	adc	cx,0			;AN000; if carry, add 1 to high 16bit
 29001                                  	call	_$P_Check_OVF		;AN000; Overflow occurred ?
 29002                                  	jc	short _$P_Value_Err0	;AN000; then error, exit
 29003                                  
 29004                                  	inc	si			;AN000; update pointer
 29005                                  	jmp	short _$P_Value_Loop	;AN000; loop until NULL encountered
 29006                                  ;_$P_Value_Err0:
 29007                                  %endif
 29008                                  ;****
 29009                                  %if 1
 29010                                  ; 08/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 29011                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:2130h)
 29012                                  
 29013 00001997 30E4                    	xor	ah,ah
 29014 00001999 89C5                    	mov	bp,ax			; save binary number
 29015 0000199B E81C00                  	call	_$P_Value_2x_OVF 	; multiply cx:dx by 2 and then check overflow
 29016 0000199E 89D3                    	mov	bx,dx			; ax:bx = 2*(cx:dx)
 29017 000019A0 89C8                    	mov	ax,cx
 29018 000019A2 E81500                  	call	_$P_Value_2x_OVF 	; multiply cx:dx by 2 and then check overflow
 29019 000019A5 E81200                  	call	_$P_Value_2x_OVF 	; multiply cx:dx by 2 and then check overflow
 29020 000019A8 01DA                    	add	dx,bx			; 8*(cx:dx)+2*(cx:dx) = 10*(cx:dx)
 29021 000019AA 11C1                    	adc	cx,ax
 29022 000019AC E80F00                  	call	_$P_Value_Chk_Add_OVF
 29023 000019AF 01EA                    	add	dx,bp			; Add the current one degree decimal
 29024                                  					; if carry, add 1 to high 16bit
 29025 000019B1 83D100                  	adc	cx,0
 29026 000019B4 E80700                  	call	_$P_Value_Chk_Add_OVF	; Overflow occurred ?
 29027                                  					; then error, exit (without return here)
 29028 000019B7 46                      	inc	si			; update pointer
 29029 000019B8 EBCD                    	jmp	short _$P_Value_Loop
 29030                                  
 29031                                  _$P_Value_2x_OVF:
 29032 000019BA D1E2                    	shl	dx,1 			; to have 2*x
 29033 000019BC D1D1                    	rcl	cx,1			; shift left w/ carry
 29034                                  _$P_Value_Chk_Add_OVF:
 29035 000019BE E89E00                  	call	_$P_Check_OVF		; check overflow (for the last shift or add)
 29036 000019C1 7201                    	jc	short _$P_Value_OVF
 29037 000019C3 C3                      	retn
 29038                                  _$P_Value_OVF:
 29039 000019C4 44                      	inc	sp 			; skip "call" return address to the caller
 29040 000019C5 44                      	inc	sp
 29041                                  
 29042                                  ;_$P_Value_Err0:	
 29043                                  %endif
 29044                                  ;****
 29045                                  
 29046                                  _$P_Value_Err0:				;AN000;
 29047 000019C6 5B                      	pop	bx			;AN000;
 29048 000019C7 E98300                  	jmp	_$P_Value_Err		;AN000; Bridge
 29049                                  ;
 29050                                  _$P_Value00:				;AN000;
 29051 000019CA 5B                      	pop	bx			;AN000; restore control pointer
 29052 000019CB 2EF606[0115]02          	test	byte [cs:_$P_Flags2],_$P_Neg ;AC034; here cx,dx = 32bit value
 29053 000019D1 740A                    	jz	short _$P_Value01	;AN000; was it negative ?
 29054                                  
 29055 000019D3 F7D1                    	not	cx			;AN000; +
 29056 000019D5 F7D2                    	not	dx			;AN000; |- Make 2's complement
 29057 000019D7 83C201                  	add	dx,1			;AN000; |
 29058 000019DA 83D100                  	adc	cx,0			;AN000; +
 29059                                  
 29060                                  _$P_Value01:				;AN000; / nval = 0
 29061 000019DD 268B7706                	mov	si,[es:bx+_$P_Control_Blk.Value_List] ;AN000; si points to value list
 29062 000019E1 268A04                  	mov	al,[es:si]		;AN000; get nval
 29063                                  	; 07/09/2023
 29064                                  	;cmp	al,_$P_nval_None ; 0	;AN000; no value list ?
 29065                                  	;;*jne	short _$P_Value02	;AN000;
 29066                                  	;;* 07/07/2023
 29067                                  	;je	short _$P_Value05
 29068                                  	; 07/09/2023
 29069 000019E4 08C0                    	or	al,al
 29070 000019E6 7459                    	jz	short _$P_Value05 ; _$P_nval_None
 29071                                  
 29072                                  	;mov	al,_$P_Number		;AN000; Set type
 29073                                  	;mov	ah,_$P_No_Tag		;AN000; No ITEM_TAG set
 29074                                  	; 07/07/2023
 29075                                  	;*mov	ax,(_$P_No_Tag<<8)|_$P_Number
 29076                                  	;*jmp	short _$P_Value_Exit	;AN000;
 29077                                  
 29078                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS, SYSINIT compatibility)
 29079                                  	; (SYSINIT:1BA5h)
 29080                                  	; 12/12/2022
 29081                                  	;nop	; db  90h
 29082                                  
 29083                                  _$P_Value02:				;AN000; / nval = 1
 29084                                  ;IF	Val1SW				;AN000;(Check if value list id #1 is supported)
 29085                                  ;(tm07) cmp	al,_$P_nval_Range	;AN000; have range list ?
 29086                                  ;(tm07) jne	short _$P_Value03	;AN000;
 29087                                  
 29088 000019E8 46                      	inc	si			;AN000;
 29089 000019E9 268A04                  	mov	al,[es:si]		;AN000; al = number of range
 29090                                  	
 29091                                  	; 07/09/2023
 29092                                  	;cmp	al,_$P_No_nrng		;AN000; (tm07)
 29093                                  	;je	short _$P_Value03	;AN000; (tm07)
 29094 000019EC 08C0                    	or	al,al
 29095 000019EE 745D                    	jz	short _$P_Value03 ; _$P_No_nrng
 29096                                  
 29097 000019F0 46                      	inc	si			;AN000; si points to 1st item_tag
 29098                                  _$P_Val02_Loop:				;AN000;
 29099 000019F1 2EF606[0115]80          	test	byte [cs:_$P_Flags2],_$P_Signed ;AC034;
 29100 000019F7 751E                    	jnz	short _$P_Val02_Sign	;AN000;
 29101                                  
 29102 000019F9 263B4C03                	cmp	cx,[es:si+_$P_Val_List.Val_XH] ;AN000; comp cx with XH
 29103 000019FD 7234                    	jb	short _$P_Val02_Next	;AN000;
 29104 000019FF 7706                    	ja	short _$P_Val_In	;AN000;
 29105                                  
 29106 00001A01 263B5401                	cmp	dx,[es:si+_$P_Val_List.Val_XL] ;AN000; comp dx with XL
 29107 00001A05 722C                    	jb	short _$P_Val02_Next	;AN000;
 29108                                  
 29109                                  _$P_Val_In:				;AN000;
 29110 00001A07 263B4C07                	cmp	cx,[es:si+_$P_Val_List.Val_YH] ;AN000; comp cx with YH (tm01)
 29111 00001A0B 7726                    	ja	short _$P_Val02_Next	;AN000;
 29112 00001A0D 7237                    	jb	short _$P_Val_Found	;AN000;
 29113                                  
 29114 00001A0F 263B5405                	cmp	dx,[es:si+_$P_Val_List.Val_YL] ;AN000; comp dx with YL
 29115 00001A13 771E                    	ja	short _$P_Val02_Next	;AN000;
 29116                                  
 29117 00001A15 EB2F                    	jmp	short _$P_Val_Found	;AN000;
 29118                                  
 29119                                  _$P_Val02_Sign:				;AN000;
 29120 00001A17 263B4C03                	cmp	cx,[es:si+_$P_Val_List.Val_XH]	;AN000; comp cx with XH
 29121 00001A1B 7C16                    	jl	short _$P_Val02_Next	;AN000;
 29122 00001A1D 7F06                    	jg	short _$P_SVal_In	;AN000;
 29123                                  
 29124 00001A1F 263B5401                	cmp	dx,[es:si+_$P_Val_List.Val_XL]	;AN000; comp dx with XL
 29125 00001A23 7C0E                    	jl	short _$P_Val02_Next	;AN000;
 29126                                  
 29127                                  _$P_SVal_In:				;AN000;
 29128 00001A25 263B4C07                	cmp	cx,[es:si+_$P_Val_List.Val_YH]	;AN000; comp cx with YH
 29129 00001A29 7F08                    	jg	short _$P_Val02_Next	;AN000;
 29130                                  
 29131 00001A2B 7C19                    	jl	short _$P_Val_Found	;AN000;
 29132                                  
 29133 00001A2D 263B5405                	cmp	dx,[es:si+_$P_Val_List.Val_YL]	;AN000; comp dx with YL
 29134                                  	;jg	short _$P_Val02_Next	;AN000;
 29135                                  	;jmp	short _$P_Val_Found	;AN000;
 29136                                  	; 07/07/2023
 29137 00001A31 7E13                    	jng	short _$P_Val_Found
 29138                                  
 29139                                  _$P_Val02_Next:				;AN000;
 29140 00001A33 83C609                  	add	si,_$P_Len_Range 	;AN000;
 29141 00001A36 FEC8                    	dec	al			;AN000; loop nrng times in AL
 29142 00001A38 75B7                    	jne	short _$P_Val02_Loop	;AN000;
 29143                                  					; / Not found
 29144 00001A3A 2EC706[F514]0600        	mov	word [cs:_$P_RC],_$P_Out_Of_Range ;AC034;
 29145                                  	;mov	al,_$P_Number		;AN000;
 29146                                  	;mov	ah,_$P_No_Tag		;AN000; No ITEM_TAG set
 29147                                  _$P_Value05:		;* 07/07/2023
 29148                                  	; 07/07/2023
 29149 00001A41 B801FF                  	mov	ax,(_$P_No_Tag<<8)|_$P_Number
 29150 00001A44 EB11                    	jmp	short _$P_Value_Exit	;AN000;
 29151                                  
 29152                                  _$P_Val_Found:				;AN000;
 29153 00001A46 B001                    	mov	al,_$P_Number		;AN000;
 29154 00001A48 268A24                  	mov	ah,[es:si]		;AN000; found ITEM_TAG set
 29155 00001A4B EB0A                    	jmp	short _$P_Value_Exit	;AN000;
 29156                                  
 29157                                  _$P_Value03:				;AN000; / nval = 2
 29158                                  
 29159                                  ;IF	Val2SW				;AN000;(Check if value list id #2 is supported)
 29160                                  ;;;;	cmp	al,$P_nval_Value	; have match list ? ASSUME nval=2,
 29161                                  ;;;;	jne	$P_Value04		; even if it is 3 or more.
 29162                                  ;(tm07) inc	si			;AN000;
 29163                                  ;(tm07) mov	al,es:[si]		;AN000; al = nrng
 29164                                  ;	mov	ah,$P_Len_Range 	;AN000;
 29165                                  ;	mul	ah			;AN000;  Skip nrng field
 29166                                  ;	inc	ax			;AN000;
 29167                                  ;	add	si,ax			;AN000; si points to nnval
 29168                                  ;	mov	al,es:[si]		;AN000; get nnval
 29169                                  ;	inc	si			;AN000; si points to 1st item_tag
 29170                                  ;$P_Val03_Loop:				;AN000;
 29171                                  ;	cmp	cx,es:[si+$P_Val_XH]	;AN000; comp cx with XH
 29172                                  ;	jne	$P_Val03_Next		;AN000;
 29173                                  ;
 29174                                  ;	cmp	dx,es:[si+$P_Val_XL]	;AN000; comp dx with XL
 29175                                  ;	je	$P_Val_Found		;AN000;
 29176                                  ;
 29177                                  ;$P_Val03_Next:				;AN000;
 29178                                  ;	add	si,$P_Len_Value 	;AN000; points to next value choice
 29179                                  ;	dec	al			;AN000; loop nval times in AL
 29180                                  ;	jne	$P_Val03_Loop		;AN000;
 29181                                  ;					;AN000; / Not found
 29182                                  ;	mov	psdata_seg:$P_RC,$P_Not_in_Val ;AC034;
 29183                                  ;	mov	al,$P_Number		;AN000;
 29184                                  ;	mov	ah,$P_No_Tag		;AN000; No ITEM_TAG set
 29185                                  ;	jmp	short $P_Value_Exit	;AN000;
 29186                                  ;
 29187                                  ;ENDIF					;AN000;(of Val2SW)
 29188                                  ;$P_Value04:
 29189                                  
 29190                                  _$P_Value_Err:				;AN000;
 29191 00001A4D 2EC706[F514]0900        	mov	word [cs:_$P_RC],_$P_Syntax ;AC034;
 29192                                  	;mov	al,_$P_String		;AN000; Set type
 29193                                  	;mov	ah,_$P_No_Tag		;AN000; No ITEM_TAG set
 29194                                  	; 07/09/2023
 29195                                  	; 07/07/2023
 29196 00001A54 B803FF                  	mov	ax,(_$P_No_Tag<<8)|_$P_String
 29197                                  _$P_Value_Exit:				;AN000;
 29198 00001A57 E851FD                  	call	_$P_Fill_Result		;AN000;
 29199 00001A5A 5E                      	pop	si			;AN000;
 29200 00001A5B 5A                      	pop	dx			;AN000;
 29201 00001A5C 59                      	pop	cx			;AN000;
 29202 00001A5D 58                      	pop	ax			;AN000;
 29203 00001A5E C3                      	retn				;AN000;
 29204                                  
 29205                                  ; 28/03/2019 - Retro DOS v4.0
 29206                                  
 29207                                  ;***********************************************************************
 29208                                  ; _$P_Check_OVF
 29209                                  ;
 29210                                  ; Function:  Check if overflow is occurred with consideration of
 29211                                  ;	     signed or un-signed numeric value
 29212                                  ;
 29213                                  ; Input:     Flag register
 29214                                  ;
 29215                                  ; Output:    CY = 1  :	Overflow
 29216                                  ;
 29217                                  ; Vars:     _$P_Flags(R)
 29218                                  ;***********************************************************************
 29219                                  
 29220                                  	; 26/10/2022
 29221                                  _$P_Check_OVF:
 29222 00001A5F 9C                      	pushf				;AN000;
 29223 00001A60 2EF606[0115]02          	test	byte [cs:_$P_Flags2],_$P_Neg ;AC034; is it negative value ?
 29224 00001A66 7502                    	jnz	short _$P_COVF 		;AN000; if no, check overflow
 29225                                  
 29226 00001A68 9D                      	popf				;AN000; by the CY bit
 29227 00001A69 C3                      	retn				;AN000;
 29228                                  
 29229                                  _$P_COVF:				;AN000;
 29230 00001A6A 9D                      	popf				;AN000; else,
 29231 00001A6B 7002                    	jo	short _$P_COVF00	;AN000; check overflow by the OF
 29232                                  
 29233 00001A6D F8                      	clc				;AN000; indicate it with CY bit
 29234 00001A6E C3                      	retn				;AN000; CY=0 means no overflow
 29235                                  
 29236                                  _$P_COVF00:				;AN000;
 29237 00001A6F F9                      	stc				;AN000; and CY=1 means overflow
 29238 00001A70 C3                      	retn				;AN000;
 29239                                  
 29240                                  ;***********************************************************************
 29241                                  ; _$P_0099;
 29242                                  ;
 29243                                  ; Function:  Make ASCII 0-9 to Binary 0-9
 29244                                  ;
 29245                                  ; Input:     AL = character code
 29246                                  ;
 29247                                  ; Output:    CY = 1 : AL is not number
 29248                                  ;	     CY = 0 : AL contains binary value
 29249                                  ;***********************************************************************
 29250                                  
 29251                                  ; 08/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 29252                                  %if 0
 29253                                  _$P_0099:
 29254                                  	cmp	al,"0"                  ;AN000;
 29255                                  	;jb	short _$P_0099Err	;AN000; must be 0 =< al =< 9
 29256                                  	; 12/12/2022
 29257                                  	jb	short _$P_0099Err2  ; cf=1
 29258                                  
 29259                                  	cmp	al,"9"                  ;AN000;
 29260                                  	ja	short _$P_0099Err	;AN000; must be 0 =< al =< 9
 29261                                  
 29262                                  	sub	al,"0"                  ;AN000; make char -> bin
 29263                                  	; 12/12/2022
 29264                                  	; cf=0	
 29265                                  	;clc				;AN000; indicate no error
 29266                                  	retn				;AN000;
 29267                                  
 29268                                  _$P_0099Err:				;AN000;
 29269                                  	stc				;AN000; indicate error
 29270                                  _$P_0099Err2: ; 12/12/2022	
 29271                                  	retn				;AN000;
 29272                                  %endif
 29273                                  
 29274                                  ; 08/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 29275                                  %if 1
 29276                                  _$P_0099:
 29277 00001A71 3C30                    	cmp	al,"0"                  ; cmp al,30h
 29278 00001A73 7207                    	jb	short _$P_0099Err	; must be 0 =< al =< 9
 29279 00001A75 3C3A                    	cmp	al,"9"+1                ; cmp al,3Ah  
 29280 00001A77 F5                      	cmc				; cf=0 -> cf=1
 29281 00001A78 7202                    	jb	short _$P_0099Err
 29282 00001A7A 2C30                    	sub	al,"0"	; sub al,30h 	; make char -> bin
 29283                                  	; cf=0
 29284                                  _$P_0099Err:	; cf=1
 29285 00001A7C C3                      	retn
 29286                                  %endif	
 29287                                  
 29288                                  ;***********************************************************************
 29289                                  ; _$P_Simple_String
 29290                                  ;
 29291                                  ; Function:  See value list for the simple string
 29292                                  ;	     and make result buffer.
 29293                                  ;
 29294                                  ; Input:     cs:SI -> _$P_STRING_BUF
 29295                                  ;	     ES:BX -> CONTROL block
 29296                                  ;
 29297                                  ; Output:    None
 29298                                  ;
 29299                                  ; Use:	_$P_Fill_Result, _$P_String_Comp
 29300                                  ;
 29301                                  ; Vars: _$P_RC(W)
 29302                                  ;***********************************************************************
 29303                                  
 29304                                  _$P_Simple_String:
 29305 00001A7D 50                      	push	ax			;AN000;
 29306 00001A7E 53                      	push	bx			;AN000;
 29307 00001A7F 52                      	push	dx			;AN000;
 29308 00001A80 57                      	push	di			;AN000;
 29309 00001A81 268B7F06                	mov	di,[es:bx+_$P_Control_Blk.Value_List] ;AN000; di points to value list
 29310 00001A85 268A05                  	mov	al,[es:di]		;AN000; get nval
 29311 00001A88 08C0                    	or	al,al			;AN000; no value list ?
 29312 00001A8A 7504                    	jnz	short _$P_Sim00		;AN000; then
 29313                                  
 29314 00001A8C B4FF                    	mov	ah,_$P_No_Tag		;AN000; No ITEM_TAG set
 29315 00001A8E EB4C                    	jmp	short _$P_Sim_Exit	;AN000; and set result buffer
 29316                                  
 29317                                  _$P_Sim00:				;AN000;
 29318                                  ;IF	Val3SW+KeySW			;AN000;(Check if keyword or value list id #3 is supported)
 29319 00001A90 3C03                    	cmp	al,_$P_nval_String	;AN000; String choice list provided ?
 29320 00001A92 753F                    	jne	short _$P_Sim01		;AN000; if no, syntax error
 29321                                  
 29322 00001A94 47                      	inc	di			;AN000;
 29323 00001A95 268A05                  	mov	al,[es:di]		;AN000; al = nrng
 29324 00001A98 B409                    	mov	ah,_$P_Len_Range 	;AN000;
 29325 00001A9A F6E4                    	mul	ah			;AN000; Skip nrng field
 29326 00001A9C 40                      	inc	ax			;AN000; ax = (nrng*9)+1
 29327 00001A9D 01C7                    	add	di,ax			;AN000; di points to nnval
 29328 00001A9F 268A05                  	mov	al,[es:di]		;AN000; get nnval
 29329 00001AA2 B405                    	mov	ah,_$P_Len_Value 	;AN000;
 29330 00001AA4 F6E4                    	mul	ah			;AN000; Skip nnval field
 29331 00001AA6 40                      	inc	ax			;AN000; ax = (nnval*5)+1
 29332 00001AA7 01C7                    	add	di,ax			;AN000; di points to nstrval
 29333 00001AA9 268A05                  	mov	al,[es:di]		;AN000; get nstrval c
 29334 00001AAC 47                      	inc	di			;AC035; add '2' to
 29335 00001AAD 47                      	inc	di			;AC035;  DI reg
 29336                                  					;AN000; di points to 1st string in list
 29337                                  _$P_Sim_Loop:				;AN000;
 29338 00001AAE 268B2D                  	mov	bp,[es:di]		;AN000; get string pointer
 29339 00001AB1 E83200                  	call	_$P_String_Comp		;AN000; compare it with operand
 29340 00001AB4 7312                    	jnc	short _$P_Sim_Found	;AN000; found on list ?
 29341                                  
 29342 00001AB6 83C703                  	add	di,_$P_Len_String ; 3	;AN000; if no, point to next choice
 29343 00001AB9 FEC8                    	dec	al			;AN000; loop nstval times in AL
 29344 00001ABB 75F1                    	jne	short _$P_Sim_Loop	;AN000;
 29345                                  					;AN000; / Not found
 29346 00001ABD 2EC706[F514]0800        	mov	word [cs:_$P_RC],_$P_Not_In_Str ;AC034;
 29347 00001AC4 B4FF                    	mov	ah,_$P_No_Tag		;AN000; No ITEM_TAG set
 29348 00001AC6 EB14                    	jmp	short _$P_Sim_Exit	;AN000;
 29349                                  
 29350                                  _$P_Sim_Found:				;AN000;
 29351 00001AC8 268A65FF                	mov	ah,[es:di-1]		;AN000; set item_tag
 29352 00001ACC B002                    	mov	al,_$P_List_Idx		;AN000;
 29353 00001ACE 268B15                  	mov	dx,[es:di]		;AN000; get address of STRING
 29354 00001AD1 EB0B                    	jmp	short _$P_Sim_Exit0	;AN000;
 29355                                  ;ENDIF					;AN000;(of Val3SW+KeySW)
 29356                                  _$P_Sim01:				;AN000;
 29357 00001AD3 2EC706[F514]0900        	mov	word [cs:_$P_RC],_$P_Syntax ;AC034;
 29358 00001ADA B4FF                    	mov	ah,_$P_No_Tag		;AN000; No ITEM_TAG set
 29359                                  _$P_Sim_Exit:				;AN000;
 29360 00001ADC B003                    	mov	al,_$P_String		;AN000; Set type
 29361                                  _$P_Sim_Exit0:				;AN000;
 29362 00001ADE E8CAFC                  	call	_$P_Fill_Result		;AN000;
 29363 00001AE1 5F                      	pop	di			;AN000;
 29364 00001AE2 5A                      	pop	dx			;AN000;
 29365 00001AE3 5B                      	pop	bx			;AN000;
 29366 00001AE4 58                      	pop	ax			;AN000;
 29367 00001AE5 C3                      	retn				;AN000;
 29368                                  
 29369                                  ;***********************************************************************
 29370                                  ; _$P_String_Comp:
 29371                                  ;
 29372                                  ; Function:  Compare two string
 29373                                  ;
 29374                                  ; Input:     cs:SI -> 1st string
 29375                                  ;	     ES:BP -> 2nd string  (Must be upper case)
 29376                                  ;	     ES:BX -> CONTROL block
 29377                                  ;
 29378                                  ; Output:    CY = 1 if not match
 29379                                  ;
 29380                                  ; Use:	_$P_Chk_DBCS, _$P_Do_CAPS_Char
 29381                                  ;
 29382                                  ; Vars: _$P_KEYor_SW_Ptr(W), _$P_Flags(R). _$P_KEYorSW_Ptr
 29383                                  ;***********************************************************************
 29384                                  
 29385                                  _$P_String_Comp:
 29386 00001AE6 50                      	push	ax			;AN000;
 29387 00001AE7 55                      	push	bp			;AN000;
 29388 00001AE8 52                      	push	dx			;AN000;
 29389 00001AE9 56                      	push	si			;AN000;
 29390 00001AEA B202                    	mov	dl,_$P_DOSTBL_Char	;AN000; use character case map table
 29391                                  _$P_SCOM_Loop:				;AN000;
 29392 00001AEC 2E8A04                  	mov	al,[cs:si]		;AN000; get command character
 29393 00001AEF E81502                  	call	_$P_Chk_DBCS		;AN000; DBCS ?
 29394 00001AF2 723A                    	jc	short _$P_SCOM00	;AN000; yes,DBCS
 29395                                  
 29396 00001AF4 E826FE                  	call	_$P_Do_CAPS_Char 	;AN000; else, upper case map before comparison
 29397                                  ;IF KeySW+SwSW				;AN000;(Check if keyword or switch is supported)
 29398 00001AF7 2EF606[0115]08          	test	byte [cs:_$P_Flags2],_$P_Key_Cmp ;AC034; keyword search ?
 29399 00001AFD 740D                    	jz	short _$P_SCOM04	;AN000;
 29400                                  
 29401 00001AFF 3C3D                    	cmp	al,_$P_Keyword		;AN000; "=" is delimiter
 29402 00001B01 751F                    	jne	short _$P_SCOM03	;AN000; IF "=" on command line AND  (bp+1=> char after the "=" in synonym list)
 29403                                  
 29404 00001B03 26807E0100              	cmp	byte [es:bp+1],_$P_NULL ;AN021;  at end of keyword string in the control block THEN
 29405 00001B08 756D                    	jne	short _$P_SCOM_Differ	;AN021;
 29406                                  
 29407 00001B0A EB13                    	jmp	short _$P_SCOM05 	;AN000; keyword found in synonym list
 29408                                  
 29409                                  _$P_SCOM04:				;AN000;
 29410 00001B0C 2EF606[0115]10          	test	byte [cs:_$P_Flags2],_$P_SW_Cmp ;AC034; switch search ?
 29411 00001B12 740E                    	jz	short _$P_SCOM03	;AN000;
 29412                                  
 29413 00001B14 3C3A                    	cmp	al,_$P_Colon		;AN000; ":" is delimiter, at end of switch on command line
 29414 00001B16 750A                    	jne	short _$P_SCOM03	;AN000; continue compares
 29415                                  
 29416                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 29417                                  	;cmp	byte [es:bp+0],_$P_NULL
 29418                                  	; 11/12/2022
 29419 00001B18 26807E0000              	cmp	byte [es:bp],_$P_NULL	;AN021; IF at end of switch on command AND
 29420 00001B1D 7558                    	jne	short _$P_SCOM_Differ	;AN021;   at end of switch string in the control block THEN
 29421                                  
 29422                                  _$P_SCOM05:				;AN000;   found a match
 29423 00001B1F 46                      	inc	si			;AN000; si points to just after "=" or ":"
 29424 00001B20 EB58                    	jmp	short _$P_SCOM_Same	;AN000; exit
 29425                                  
 29426                                  _$P_SCOM03:				;AN000;
 29427                                  ;ENDIF					;AN000;(of KeySW+SwSW)
 29428                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 29429                                  	;cmp	al,[es:bp+0]
 29430                                  	; 11/12/2022
 29431 00001B22 263A4600                	cmp	al,[es:bp]		;AN000; compare operand w/ a synonym
 29432 00001B26 751B                    	jne	short _$P_SCOM_Differ0 	;AN000; if different, check ignore colon option
 29433                                  
 29434 00001B28 08C0                    	or	al,al			;AN000; end of line
 29435 00001B2A 744E                    	jz	short _$P_SCOM_Same	;AN000; if so, exit
 29436                                  
 29437                                  	; 12/12/2022
 29438                                  	;inc	si			;AN000; update operand pointer
 29439                                  	;inc	bp			;AN000;    and synonym pointer
 29440                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 29441 00001B2C EB11                    	jmp	short _$P_SCOM01 	;AN000; loop until NULL or "=" or ":" found in case
 29442                                  
 29443                                  _$P_SCOM00:				;AN000; Here al is DBCS leading byte
 29444                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 29445                                  	;cmp	al,[es:bp+0]
 29446                                  	; 11/12/2022
 29447 00001B2E 263A4600                	cmp	al,[es:bp]		;AN000; compare leading byte
 29448 00001B32 7543                    	jne	short _$P_SCOM_Differ	;AN000; if not match, say different
 29449                                  
 29450 00001B34 46                      	inc	si			;AN000; else, load next byte
 29451 00001B35 2E8A04                  	mov	al,[cs:si]		;AN000; and
 29452 00001B38 45                      	inc	bp			;AN000;
 29453                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 29454                                  	;cmp	al,[es:bp+0]
 29455                                  	; 11/12/2022
 29456 00001B39 263A4600                	cmp	al,[es:bp]		;AN000; compare 2nd byte
 29457 00001B3D 7538                    	jne	short _$P_SCOM_Differ	;AN000; if not match, say different, too
 29458                                  
 29459                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 29460                                  	; 12/12/2022
 29461                                  _$P_SCOM01:
 29462 00001B3F 46                      	inc	si			;AN000; else update operand pointer
 29463 00001B40 45                      	inc	bp			;AN000; 		and synonym pointer
 29464                                  ;_$P_SCOM01:				;AN000;
 29465 00001B41 EBA9                    	jmp	short _$P_SCOM_Loop	;AN000; loop until NULL or "=" or "/" found in case
 29466                                  
 29467                                  _$P_SCOM_Differ0:			;AN000;
 29468                                  ;IF SwSW				;AN000;(tm10)
 29469 00001B43 2EF606[0115]40          	test	byte [cs:_$P_Flags2],_$P_SW ;AC034;(tm10)
 29470 00001B49 740E                    	jz	short _$P_not_applicable ;AN000;(tm10)
 29471                                  
 29472                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 29473                                  	;test	word [es:bx+_$P_Control_Blk.Function_Flag],_$P_colon_is_not_necessary ;AN000;(tm10)
 29474                                  	; 12/12/2022
 29475 00001B4B 26F6470220              	test	byte [es:bx+_$P_Control_Blk.Function_Flag],_$P_colon_is_not_necessary
 29476 00001B50 7407                    	je	short _$P_not_applicable ;AN000;(tm10)
 29477                                  
 29478                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)	
 29479                                  	;cmp	byte [es:bp+0],_$P_NULL
 29480                                  	; 11/12/2022
 29481 00001B52 26807E0000              	cmp	byte [es:bp],_$P_NULL	;AN000;(tm10)
 29482                                  ;(deleted ;AN025;) jne short _$P_not_applicable ;AN000;(tm10)
 29483 00001B57 7421                    	je	short _$P_SCOM_Same	;AN025;(tm10)
 29484                                  
 29485                                  _$P_not_applicable:			;AN000;(tm10)
 29486                                  ;ENDIF					;AN000;(tm10)
 29487                                  
 29488                                  	;test	word [es:bx+_$P_Control_Blk.Match_Flag],_$P_Ig_Colon 
 29489                                  					;AN000; ignore colon option specified ?
 29490                                  	;test	byte [es:bx+_$P_Control_Blk.Match_Flag],_$P_Ig_Colon
 29491                                  	; 12/12/2022
 29492 00001B59 26F60710                	test	byte [es:bx],_$P_Ig_Colon
 29493                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)	
 29494                                  	;test	word [es:bx],_$P_Ig_Colon ; 10h
 29495 00001B5D 7418                    	jz	short _$P_SCOM_Differ	;AN000; if no, say different.
 29496                                  
 29497 00001B5F 3C3A                    	cmp	al,_$P_Colon		;AN000; End up with ":" and
 29498 00001B61 7509                    	jne	short _$P_SCOM02	;AN000;    subseqently
 29499                                  
 29500                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)	
 29501                                  	;cmp	byte [es:bp+0],_$P_NULL
 29502                                  	; 11/12/2022
 29503 00001B63 26807E0000              	cmp	byte [es:bp],_$P_NULL	;AN000; NULL ?
 29504 00001B68 750D                    	jne	short _$P_SCOM_Differ	;AN000; if no, say different
 29505                                  
 29506 00001B6A EB0E                    	jmp	short _$P_SCOM_Same	;AN000; else, say same
 29507                                  
 29508                                  _$P_SCOM02:				;AN000;
 29509 00001B6C 3C00                    	cmp	al,_$P_NULL		;AN000; end up NULL and :
 29510 00001B6E 7507                    	jne	short _$P_SCOM_Differ	;AN000;
 29511                                  
 29512                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)	
 29513                                  	;cmp	byte [es:bp+0],_$P_Colon
 29514                                  	; 11/12/2022
 29515 00001B70 26807E003A              	cmp	byte [es:bp],_$P_Colon	;AN000; if no, say different
 29516 00001B75 7403                    	je	short _$P_SCOM_Same	;AN000; else, say same
 29517                                  
 29518                                  _$P_SCOM_Differ: 			;AN000;
 29519 00001B77 F9                      	stc				;AN000; indicate not found
 29520 00001B78 EB05                    	jmp	short _$P_SCOM_Exit	;AN000;
 29521                                  
 29522                                  _$P_SCOM_Same:				;AN000;
 29523                                  	; 12/12/2022
 29524                                  	; cf=0
 29525 00001B7A 2E8936[0415]            	mov	[cs:_$P_KEYorSW_Ptr],si ;AC034; for later use by keyword or switch
 29526                                  	; 12/12/2022
 29527                                  	;clc				;AN000; indicate found
 29528                                  _$P_SCOM_Exit:				;AN000;
 29529 00001B7F 5E                      	pop	si			;AN000;
 29530 00001B80 5A                      	pop	dx			;AN000;
 29531 00001B81 5D                      	pop	bp			;AN000;
 29532 00001B82 58                      	pop	ax			;AN000;
 29533 00001B83 C3                      	retn
 29534                                  
 29535                                  ; 30/03/2019
 29536                                  
 29537                                  ;IF FileSW+DrvSW			;AN000;(Check if file spec or drive only is supported)
 29538                                  
 29539                                  ;***********************************************************************
 29540                                  ; _$P_File_Format;
 29541                                  ;
 29542                                  ; Function:  Check if the input string is valid file spec format.
 29543                                  ;	     And set the result buffer.
 29544                                  ;
 29545                                  ; Input:     cs:SI -> _$P_STRING_BUF
 29546                                  ;	     ES:BX -> CONTROL block
 29547                                  ;
 29548                                  ; Output:    None
 29549                                  ;
 29550                                  ; Use:	_$P_Fill_Result, _$P_Chk_DBCS, _$P_FileSp_Chk
 29551                                  ;
 29552                                  ; Vars: _$P_RC(W), _$P_SI_Save(W), _$P_Terminator(W), _$P_SaveSI_Cmpx(R)
 29553                                  ;	_$P_SaveSI_Cmpx(R)
 29554                                  ;***********************************************************************
 29555                                  
 29556                                  _$P_File_Format:
 29557 00001B84 50                      	push	ax			;AN000;
 29558 00001B85 57                      	push	di			;AN000;
 29559 00001B86 56                      	push	si			;AN000;
 29560 00001B87 2E8B3E[0215]            	mov	di,[cs:_$P_SaveSI_Cmpx]	;AC034; get user buffer address
 29561                                  _$P_FileF_Loop0: 			;AN000; / skip special characters
 29562 00001B8C 2E8A04                  	mov	al,[cs:si]		;AN000; load character
 29563 00001B8F 08C0                    	or	al,al			;AN000; end of line ?
 29564 00001B91 7413                    	jz	short _$P_FileF_Err	;AN000; if yes, error exit
 29565                                  
 29566 00001B93 E85D00                  	call	_$P_FileSp_Chk		;AN000; else, check if file special character
 29567 00001B96 7523                    	jne	short _$P_FileF03	;AN000; if yes,
 29568                                  
 29569 00001B98 2EC606[9815]01          	mov	byte [cs:_$P_err_flag],_$P_error_filespec 
 29570                                  					;AN033;AC034;; set error flag- bad char.
 29571 00001B9E 5E                      	pop	si			;AN033;
 29572 00001B9F 2EC60400                	mov	byte [cs:si],_$P_NULL	;AN033;
 29573 00001BA3 5F                      	pop	di			;AN033;
 29574 00001BA4 EB3E                    	jmp	short _$P_FileF02	;AN033;
 29575                                  
 29576                                  _$P_FileF_Err:				;AN000;
 29577 00001BA6 5E                      	pop	si			;AN000;
 29578 00001BA7 2EC60400                	mov	byte [cs:si],_$P_NULL	;AN000;
 29579 00001BAB 5F                      	pop	di			;AN000;
 29580                                  
 29581                                  	;test	word [es:bx+_$P_Control_Blk.Match_Flag],_$P_Optional ;AN000; is it optional ?
 29582                                  	;test	byte [es:bx+_$P_Control_Blk.Match_Flag],_$P_Optional
 29583                                  	; 12/12/2022
 29584 00001BAC 26F60701                	test	byte [es:bx],_$P_Optional
 29585                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)	
 29586                                  	;test	word [es:bx],_$P_Optional
 29587 00001BB0 7532                    	jnz	short _$P_FileF02	;AN000;
 29588                                  
 29589 00001BB2 2EC706[F514]0200        	mov	word [cs:_$P_RC],_$P_Op_Missing ;AC034; 3/17/87
 29590 00001BB9 EB29                    	jmp	short _$P_FileF02	;AN000;
 29591                                  
 29592                                  _$P_FileF03:				;AN000;
 29593 00001BBB 58                      	pop	ax			;AN000; discard save si
 29594 00001BBC 56                      	push	si			;AN000; save new si
 29595                                  _$P_FileF_Loop1: 			;AN000;
 29596 00001BBD 2E8A04                  	mov	al,[cs:si]		;AN000; load character (not special char)
 29597 00001BC0 08C0                    	or	al,al			;AN000; end of line ?
 29598 00001BC2 741E                    	jz	short _$P_FileF_RLT	;AN000;
 29599                                  
 29600 00001BC4 E82C00                  	call	_$P_FileSp_Chk		;AN000; File special character ?
 29601 00001BC7 740B                    	je	short _$P_FileF00	;AN000;
 29602                                  
 29603 00001BC9 E83B01                  	call	_$P_Chk_DBCS		;AN000; no, then DBCS ?
 29604 00001BCC 7302                    	jnc	short _$P_FileF01	;AN000;
 29605 00001BCE 47                      	inc	di			;AN000; if yes, skip next byte
 29606 00001BCF 46                      	inc	si			;AN000;
 29607                                  _$P_FileF01:				;AN000;
 29608 00001BD0 47                      	inc	di			;AN000;
 29609 00001BD1 46                      	inc	si			;AN000;
 29610 00001BD2 EBE9                    	jmp	short _$P_FileF_Loop1	;AN000;
 29611                                  ;
 29612                                  _$P_FileF00:				;AN000;
 29613 00001BD4 2EA2[FB14]              	mov	[cs:_$P_Terminator],al	;AC034;
 29614 00001BD8 2EC60400                	mov	byte [cs:si],_$P_NULL	;AN000; update end of string
 29615 00001BDC 47                      	inc	di			;AN000;
 29616 00001BDD 2E893E[F714]            	mov	[cs:_$P_SI_Save],di	;AC034; update next pointer in command line
 29617                                  _$P_FileF_RLT:				;AN000;
 29618 00001BE2 5E                      	pop	si			;AN000;
 29619 00001BE3 5F                      	pop	di			;AN000;
 29620                                  _$P_FileF02:				;AN000;
 29621 00001BE4 58                      	pop	ax			;AN000; (tm14)
 29622                                  	;test	ax,_$P_File_Spc	; 200h	;AN000; (tm14)
 29623                                  	; 08/07/2023
 29624 00001BE5 F6C402                  	test	ah,(_$P_File_Spc>>8) ; 2
 29625 00001BE8 7408                    	jz	short _$P_Drv_Only_Exit	;AN000; (tm14)
 29626                                  
 29627 00001BEA 50                      	push	ax			;AN000; (tm14)
 29628                                  	;mov	ah,_$P_No_Tag		;AN000; set
 29629                                  	;mov	al,_$P_File_Spec 	;AN000; result
 29630                                  	; 08/07/2023
 29631 00001BEB B805FF                  	mov	ax,(_$P_No_Tag<<8)|_$P_File_Spec ; 0FF05h
 29632                                  					      ; set result
 29633 00001BEE E8BAFB                  	call	_$P_Fill_Result		;AN000; buffer to file spec
 29634 00001BF1 58                      	pop	ax			;AN000;
 29635                                  
 29636                                  _$P_Drv_Only_Exit:			;AN000; (tm14)
 29637 00001BF2 C3                      	retn				;AN000;
 29638                                  
 29639                                  ;***********************************************************************
 29640                                  ; _$P_FileSp_Chk
 29641                                  ;
 29642                                  ; Function:  Check if the input byte is one of file special characters
 29643                                  ;
 29644                                  ; Input:     cs:SI -> _$P_STRING_BUF
 29645                                  ;	     AL = character code to be examineed
 29646                                  ;
 29647                                  ; Output:    ZF = 1 , AL is one of special characters
 29648                                  ;***********************************************************************
 29649                                  
 29650                                  _$P_FileSp_Chk:
 29651 00001BF3 53                      	push	bx			;AN000;
 29652 00001BF4 51                      	push	cx			;AN000;
 29653                                  	;;lea	bx,[cs:_$P_FileSp_Char] ;AC034; special character table
 29654                                  	;lea	bx,[_$P_FileSp_Char] 	; "[]|<>+=;\"" at
 29655                                  					; MSDOS 6.21 IO.SYS - SYSINIT:1838h
 29656                                  	; 07/09/2023
 29657 00001BF5 BB[8F15]                	mov	bx,_$P_FileSp_Char
 29658 00001BF8 B90900                  	mov	cx,_$P_FileSp_Len ; 9	;AN000; load length of it
 29659                                  _$P_FileSp_Loop: 			;AN000;
 29660 00001BFB 2E3A07                  	cmp	al,[cs:bx]		;AN000; is it one of special character ?
 29661 00001BFE 7404                    	je	short _$P_FileSp_Exit	;AN000;
 29662                                  
 29663 00001C00 43                      	inc	bx			;AN000;
 29664 00001C01 E2F8                    	loop	_$P_FileSp_Loop		;AN000;
 29665                                  
 29666 00001C03 41                      	inc	cx			;AN000; reset ZF
 29667                                  _$P_FileSp_Exit: 			;AN000;
 29668 00001C04 59                      	pop	cx			;AN000;
 29669 00001C05 5B                      	pop	bx			;AN000;
 29670 00001C06 C3                      	retn
 29671                                  
 29672                                  ;ENDIF					;AN000;(of FileSW+DrvSW)
 29673                                  
 29674                                  ;IF	DrvSW				;AN000;(Check if drive only is supported)
 29675                                  
 29676                                  ;***********************************************************************
 29677                                  ; _$P_Drive_Format;
 29678                                  ;
 29679                                  ; Function:  Check if the input string is valid drive only format.
 29680                                  ;	     And set the result buffer.
 29681                                  ;
 29682                                  ; Input:     cs:SI -> _$P_STRING_BUF
 29683                                  ;	     ES:BX -> CONTROL block
 29684                                  ;
 29685                                  ; Output:    None
 29686                                  ;
 29687                                  ; Use:	_$P_Fill_Result, _$P_Chk_DBCS
 29688                                  ;
 29689                                  ; Vars: _$P_RC(W)
 29690                                  ;***********************************************************************
 29691                                  
 29692                                  _$P_Drive_Format:
 29693 00001C07 50                      	push	ax			;AN000;
 29694 00001C08 52                      	push	dx			;AN000;
 29695 00001C09 2E8A04                  	mov	al,[cs:si]		;AN000;
 29696 00001C0C 08C0                    	or	al,al			;AN000; if null string
 29697 00001C0E 7436                    	je	short _$P_Drv_Exit	;AN000; do nothing
 29698                                  
 29699 00001C10 E8F400                  	call	_$P_Chk_DBCS		;AN000; is it leading byte ?
 29700 00001C13 722A                    	jc	short _$P_Drv_Err	;AN000; (yes, error)
 29701                                  
 29702 00001C15 2E837C013A              	cmp	word [cs:si+1],_$P_Colon ;AN000; "d",":", 0 ?
 29703 00001C1A 740D                    	je	short _$P_DrvF00	;AN000;
 29704                                  
 29705                                  	;test	word [es:bx+_$P_Control_Blk.Match_Flag],_$P_Ig_Colon 
 29706                                  	;test	byte [es:bx+_$P_Control_Blk.Match_Flag],_$P_Ig_Colon ;AN000; colon can be ignored?
 29707                                  	; 12/12/2022
 29708 00001C1C 26F60710                	test	byte [es:bx],_$P_Ig_Colon
 29709                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)	
 29710                                  	;test	word [es:bx],_$P_Ig_Colon
 29711 00001C20 741D                    	jz	short _$P_Drv_Err	;AN000;
 29712                                  
 29713 00001C22 2E807C0100              	cmp	byte [cs:si+1],_$P_NULL ;AN000; "d",0 ?
 29714 00001C27 7516                    	jne	short _$P_Drv_Err	;AN000;
 29715                                  
 29716                                  _$P_DrvF00:				;AN000;
 29717 00001C29 0C20                    	or	al,_$P_Make_Lower	;AN000; lower case
 29718 00001C2B 3C61                    	cmp	al,"a"                  ;AN000; drive letter must
 29719 00001C2D 7210                    	jb	short _$P_Drv_Err	;AN000; in range of
 29720                                  
 29721 00001C2F 3C7A                    	cmp	al,"z"                  ;AN000; "a"-"z"
 29722 00001C31 770C                    	ja	short _$P_Drv_Err	;AN000; if no, error
 29723                                  
 29724 00001C33 2C60                    	sub	al,"a"-1                ;AN000; make text drive to binary drive
 29725 00001C35 88C2                    	mov	dl,al			;AN000; set
 29726                                  	;mov	ah,_$P_No_Tag		;AN000; result
 29727                                  	;mov	al,_$P_Drive		;AN000; buffer
 29728                                  	; 08/07/2023
 29729 00001C37 B806FF                  	mov	ax,(_$P_No_Tag<<8)|_$P_Drive ; 0FF06h
 29730                                  					      ; set result buffer
 29731 00001C3A E86EFB                  	call	_$P_Fill_Result		;AN000; to drive
 29732 00001C3D EB07                    	jmp	short _$P_Drv_Exit	;AN000;
 29733                                  
 29734                                  _$P_Drv_Err:				;AN000;
 29735 00001C3F 2EC706[F514]0900        	mov	word [cs:_$P_RC],_$P_Syntax ;AC034;
 29736                                  _$P_Drv_Exit:				;AN000;
 29737 00001C46 5A                      	pop	dx			;AN000;
 29738 00001C47 58                      	pop	ax			;AN000;
 29739 00001C48 C3                      	retn				;AN000;
 29740                                  
 29741                                  ;ENDIF					;AN000;(of DrvSW)
 29742                                  
 29743                                  ;***********************************************************************
 29744                                  ; _$P_Skip_Delim;
 29745                                  ;
 29746                                  ; Function: Skip delimiters specified in the PARMS list, white space
 29747                                  ;	    and comma.
 29748                                  ;
 29749                                  ; Input:    DS:SI -> Command String
 29750                                  ;	    ES:DI -> Parameter List
 29751                                  ;
 29752                                  ; Output:   CY = 1 if the end of line encounterd
 29753                                  ;	    CY = 0 then SI move to 1st non-delimiter character
 29754                                  ;	    AL = Last examineed character
 29755                                  ;
 29756                                  ; Use:	    _$P_Chk_EOL, _$P_Chk_Delim,
 29757                                  ;
 29758                                  ; Vars:     _$P_Flags(R)
 29759                                  ;***********************************************************************
 29760                                  
 29761                                  _$P_Skip_Delim:
 29762                                  _$P_Skip_Delim_Loop:			;AN000;
 29763 00001C49 AC                      	lodsb				;AN000;
 29764 00001C4A E81E00                  	call	_$P_Chk_EOL		;AN000; is it EOL character ?
 29765 00001C4D 7416                    	jz	short _$P_Skip_Delim_CY	;AN000; if yes, exit w/ CY on
 29766                                  
 29767 00001C4F E84E00                  	call	_$P_Chk_Delim		;AN000; is it one of delimiters ?
 29768 00001C52 7514                    	jnz	short _$P_Skip_Delim_NCY ;AN000; if no, exit w/ CY off
 29769                                  
 29770 00001C54 2EF606[0115]20          	test	byte [cs:_$P_Flags2],_$P_Extra ;AC034; extra delim or comma found ?
 29771 00001C5A 74ED                    	jz	short _$P_Skip_Delim_Loop ;AN000; if no, loop
 29772                                  
 29773 00001C5C 2EF606[0115]41          	test	byte [cs:_$P_Flags2],_$P_SW+_$P_equ ;AC034; /x , or xxx=zzz , (tm08)
 29774                                  	;jz	short _$P_Exit_At_Extra	;AN000; no switch, no keyword (tm08)
 29775                                  	; 08/07/2023
 29776                                  	; cf=0
 29777 00001C62 7505                    	jnz	short _$P_Skip_Delim_Exit
 29778 00001C64 C3                      	retn
 29779                                  
 29780                                  	;dec	si			;AN000; backup si for next call (tm08)
 29781                                  	;jmp	short _$P_Exit_At_Extra	;AN000; else exit w/ CY off
 29782                                  	; 12/12/2022
 29783                                  	; cf=0
 29784                                  	; 08/07/2023
 29785                                  	;jmp	short _$P_Skip_Delim_Exit
 29786                                  
 29787                                  _$P_Skip_Delim_CY:			;AN000;
 29788 00001C65 F9                      	stc				;AN000; indicate EOL
 29789 00001C66 EB01                    	jmp	short _$P_Skip_Delim_Exit ;AN000;
 29790                                  
 29791                                  _$P_Skip_Delim_NCY:			;AN000;
 29792 00001C68 F8                      	clc				;AN000; indicate non delim
 29793                                  _$P_Skip_Delim_Exit:			;AN000; in this case, need
 29794 00001C69 4E                      	dec	si			;AN000;  backup index pointer
 29795                                  	; 08/07/2023
 29796                                  	; 12/12/2022
 29797                                  ;_$P_Exit_At_Extra:	 ; cf=0
 29798 00001C6A C3                      	retn				;AN000;
 29799                                  
 29800                                  	; 12/12/2022
 29801                                  ;_$P_Exit_At_Extra:			;AN000;
 29802                                  	;clc				;AN000; indicate extra delim
 29803                                  	;retn				;AN000;
 29804                                  
 29805                                  ;***********************************************************************
 29806                                  ; _$P_Chk_EOL;
 29807                                  ;
 29808                                  ; Function: Check if AL is one of End of Line characters.
 29809                                  ;
 29810                                  ; Input:    AL = character code
 29811                                  ;	    ES:DI -> Parameter List
 29812                                  ;
 29813                                  ; Output:   ZF = 1 if one of End of Line characters
 29814                                  ;**********************************************************************
 29815                                  
 29816                                  _$P_Chk_EOL:
 29817 00001C6B 53                      	push	bx			;AN000;
 29818 00001C6C 51                      	push	cx			;AN000;
 29819 00001C6D 3C0D                    	cmp	al,_$P_CR		;AN000; Carriage return ?
 29820 00001C6F 742C                    	je	short _$P_Chk_EOL_Exit 	;AN000;
 29821 00001C71 3C00                    	cmp	al,_$P_NULL		;AN000; zero ?
 29822 00001C73 7428                    	je	short _$P_Chk_EOL_Exit 	;AN000;
 29823                                  ;IF LFEOLSW				;AN028; IF LF TO BE ACCEPTED AS EOL
 29824 00001C75 3C0A                    	cmp	al,_$P_LF		;AN000; Line feed ?
 29825 00001C77 7424                    	je	short _$P_Chk_EOL_Exit 	;AN000;
 29826                                  ;ENDIF					;AN028;
 29827 00001C79 26807D0202              	cmp	byte [es:di+_$P_PARMS_Blk.Num_Extra],_$P_I_Have_EOL 
 29828                                  					;AN000; EOL character specified ?
 29829 00001C7E 721D                    	jb	short _$P_Chk_EOL_Exit 	;AN000;
 29830 00001C80 31DB                    	xor	bx,bx			;AN000;
 29831 00001C82 268A5D03                	mov	bl,[es:di+_$P_PARMS_Blk.Len_Extra_Delim]
 29832                                  					;AN000; get length of delimiter list
 29833 00001C86 83C304                  	add	bx,_$P_Len_PARMS 	;AN000; skip it
 29834                                  	; 08/07/2023
 29835 00001C89 31C9                    	xor	cx,cx ; *
 29836 00001C8B 26803900                	cmp	byte [es:bx+di],_$P_I_Use_Default ;AN000; No extra EOL character ?
 29837 00001C8F 740B                    	je	short _$P_Chk_EOL_NZ	;AN000;
 29838                                  	; 08/07/2023
 29839                                  	;;xor	cx,cx			;AN000; Get number of extra character
 29840                                  	;xor	ch,ch ; *
 29841 00001C91 268A09                  	mov	cl,[es:bx+di]		;AN000; 
 29842                                  _$P_Chk_EOL_Loop:			;AN000;
 29843 00001C94 43                      	inc	bx			;AN000;
 29844 00001C95 263A01                  	cmp	al,[es:bx+di]		;AN000; Check extra EOL character
 29845 00001C98 7403                    	je	short _$P_Chk_EOL_Exit 	;AN000;
 29846 00001C9A E2F8                    	loop	_$P_Chk_EOL_Loop 	;AN000;
 29847                                  	; 08/07/2023
 29848                                  	; cx=0
 29849                                  _$P_Chk_EOL_NZ:				;AN000;
 29850                                  	;cmp	al,_$P_CR		;AN000; reset ZF
 29851                                  	; 08/07/2023
 29852 00001C9C 41                      	inc	cx  ; zf=0  (cx=1) ; *
 29853                                  _$P_Chk_EOL_Exit:			;AN000;
 29854 00001C9D 59                      	pop	cx			;AN000;
 29855 00001C9E 5B                      	pop	bx			;AN000;
 29856 00001C9F C3                      	retn
 29857                                  
 29858                                  ;***********************************************************************
 29859                                  ; _$P_Chk_Delim;
 29860                                  ;
 29861                                  ; Function: Check if AL is one of delimiter characters.
 29862                                  ;	    if AL+[si] is DBCS blank, it is replaced with two SBCS
 29863                                  ;	    blanks.
 29864                                  ;
 29865                                  ; Input:    AL = character code
 29866                                  ;	    DS:SI -> Next Character
 29867                                  ;	    ES:DI -> Parameter List
 29868                                  ;
 29869                                  ; Output:   ZF = 1 if one of delimiter characters
 29870                                  ;	    SI points to the next character
 29871                                  ; Vars:  _$P_Terminator(W), _$P_Flags(W)
 29872                                  ;***********************************************************************
 29873                                   
 29874                                  	; 08/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 29875                                  	; MSDOS 6.21 IO.SYS - SYSINIT:1FAEh
 29876                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:2451h) ; (Retro DOS v5.0)
 29877                                  
 29878                                  _$P_Chk_Delim:
 29879 00001CA0 53                      	push	bx			;AN000;
 29880 00001CA1 51                      	push	cx			;AN000;
 29881 00001CA2 2EC606[FB14]20          	mov	byte [cs:_$P_Terminator],_$P_Space 
 29882                                  					;AC034; Assume terminated by space
 29883                                  	;and	byte [cs:_$P_Flags20,0DFh
 29884 00001CA8 2E8026[0115]DF          	and	byte [cs:_$P_Flags2],0FFh-_$P_Extra ;AC034;
 29885 00001CAE 3C20                    	cmp	al,_$P_Space ; 20h	;AN000; Space ?
 29886 00001CB0 7423                    	je	short _$P_Chk_Delim_Exit ;AN000;
 29887                                  
 29888 00001CB2 3C09                    	cmp	al,_$P_TAB		;AN000; TAB ?
 29889 00001CB4 741F                    	je	short _$P_Chk_Delim_Exit ;AN000;
 29890                                  
 29891 00001CB6 3C2C                    	cmp	al,_$P_Comma		;AN000; Comma ?
 29892 00001CB8 741E                    	je	short _$P_Chk_Delim_Exit0 ;AN000;
 29893                                  
 29894                                  ; Note: _$P_Chk_Delim00 part of code is nonsense here
 29895                                  ;        because _$P_Space = _$P_DBSP1 = 20h
 29896                                  ;        Erdogan Tan - 08/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 29897                                  ;_$P_Chk_Delim00:
 29898                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:246Bh)
 29899                                  	; (MSDOS 6.21 IO.SYS - SYSINIT:1FC8h)
 29900                                  %if 0
 29901                                  	; 26/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 29902                                  _$P_Chk_Delim00: 			;AN000;
 29903                                  	cmp	al,_$P_DBSP1	; 20h	;AN000; 1st byte of DBCS Space ?
 29904                                  	jne	short _$P_Chk_Delim01	;AN000;
 29905                                  
 29906                                  	cmp	byte [si],_$P_DBSP2 ; 20h ;AN000; 2nd byte of DBCS Space ?
 29907                                  	jne	short _$P_Chk_Delim01	;AN000;
 29908                                  
 29909                                  	mov	al,_$P_Space		;AN000;
 29910                                  	inc	si			;AN000; make si point to next character
 29911                                  	cmp	al,al			;AN000; Set ZF
 29912                                  	jmp	short _$P_Chk_Delim_Exit ;AN000;
 29913                                  %endif
 29914                                  
 29915                                  _$P_Chk_Delim01: 			;AN000;
 29916 00001CBA 26807DFE01              	cmp	byte [es:di-_$P_PARMS_Blk.Num_Extra],_$P_I_Have_Delim 
 29917                                  					;AN000; delimiter character specified ?
 29918 00001CBF 7214                    	jb	short _$P_Chk_Delim_Exit ;AN000;
 29919                                  
 29920                                  	;xor	cx,cx			;AN000;
 29921 00001CC1 30ED                    	xor	ch,ch
 29922                                  	;mov	cl,[es:di+3]
 29923 00001CC3 268A4D03                	mov	cl,[es:di+_$P_PARMS_Blk.Len_Extra_Delim] 
 29924                                  					;AN000; get length of delimiter list
 29925                                  	;or	cx,cx			;AN000; No extra Delim character ?
 29926                                  	;jz	short _$P_Chk_Delim_NZ 	;AN000;
 29927                                  	; 08/07/2023
 29928 00001CC7 E30B                    	jcxz	_$P_Chk_Delim_NZ
 29929                                  
 29930 00001CC9 BB0300                  	mov	bx,_$P_Len_PARMS-1 ; 3	;AN000; set bx to 1st extra delimiter
 29931                                  _$P_Chk_Delim_Loop:			;AN000;
 29932 00001CCC 43                      	inc	bx			;AN000;
 29933 00001CCD 263A01                  	cmp	al,[es:bx+di]		;AN000; Check extra Delim character
 29934 00001CD0 7406                    	je	short _$P_Chk_Delim_Exit0 ;AN000;
 29935                                  
 29936 00001CD2 E2F8                    	loop	_$P_Chk_Delim_Loop	;AN000; examine all extra delimiter
 29937                                  
 29938                                  _$P_Chk_Delim_NZ:			;AN000;
 29939                                  	;cmp	al,_$P_Space		;AN000; reset ZF
 29940                                  	; 08/07/2023
 29941                                  	; cx=0 here
 29942 00001CD4 41                      	inc	cx ; cx=1, zf=0
 29943                                  _$P_Chk_Delim_Exit:			;AN000;
 29944                                  _$P_ChkDfin:				;AN000;
 29945 00001CD5 59                      	pop	cx			;AN000;
 29946 00001CD6 5B                      	pop	bx			;AN000;
 29947 00001CD7 C3                      	retn				;AN000;
 29948                                  
 29949                                  _$P_Chk_Delim_Exit0:			;AN000;
 29950 00001CD8 2EA2[FB14]              	mov	[cs:_$P_Terminator],al ;AC034; keep terminated delimiter
 29951 00001CDC 2EF606[0115]01          	test	byte [cs:_$P_Flags2],_$P_equ ;AN027;AC034;; if terminating a key=
 29952 00001CE2 7506                    	jnz	short _$P_No_Set_Extra 	;AN027; then do not set the EXTRA bit
 29953                                  
 29954 00001CE4 2E800E[0115]20          	or	byte [cs:_$P_Flags2],_$P_Extra 
 29955                                  					;AC034; flag terminated extra delimiter or comma
 29956                                  _$P_No_Set_Extra:			;AN027;
 29957 00001CEA 38C0                    	cmp	al,al			;AN000; set ZF
 29958 00001CEC EBE7                    	jmp	short _$P_Chk_Delim_Exit ;AN000;
 29959                                  
 29960                                  ;***********************************************************************
 29961                                  ; _$P_Chk_Switch;
 29962                                  ;
 29963                                  ; Function: Check if AL is the switch character not in first position of
 29964                                  ;	    _$P_STRING_BUF
 29965                                  ;
 29966                                  ; Input:    AL = character code
 29967                                  ;	    BX = current pointer within _$P_String_Buf
 29968                                  ;	    SI =>next char on command line (following the one in AL)
 29969                                  ;
 29970                                  ; Output:   CF = 1 (set) if AL is switch character, and not in first
 29971                                  ;		 position, and has no chance of being part of a date string,
 29972                                  ;		 i.e. should be treated as a delimiter.
 29973                                  
 29974                                  ;	    CF = 0 (reset, cleared) if AL is not a switch char, is in the first
 29975                                  ;		 position, or is a slash but may be part of a date string, i.e.
 29976                                  ;		 should not be treated as a delimiter.
 29977                                  ;
 29978                                  ; Vars:  _$P_Terminator(W)
 29979                                  
 29980                                  ; Use:	 _$P_0099
 29981                                  ;***********************************************************************
 29982                                  
 29983                                  _$P_Chk_Switch:
 29984                                  	;;lea	bp,[cs:_$P_STRING_BUF]	;AN020;AC034
 29985                                  	;lea	bp,[_$P_STRING_BUF]	;BP=OFFSET of _$P_String_Buf even in group addressing
 29986                                  	; 08/07/2023
 29987 00001CEE BD[0A15]                	mov	bp,_$P_STRING_BUF
 29988                                  
 29989                                  ;	.IF <BX NE BP> THEN		;AN020;IF not first char THEN
 29990 00001CF1 39EB                    	cmp	bx,bp			;AN000;
 29991 00001CF3 7406                    	je	short _$P_STRUC_L2	;AN000;
 29992                                  
 29993                                  ;	.IF <AL EQ _$P_Switch> THEN	;AN020;otherwise see if a slash
 29994 00001CF5 3C2F                    	cmp	al,_$P_Switch		;AN000;
 29995 00001CF7 750C                    	jne	short _$P_STRUC_L5 	;AN000;
 29996                                  
 29997 00001CF9 F9                      	stc				;AN020;not in first position and is slash
 29998                                  	;jmp     short _$P_STRUC_L1	;AN000;
 29999                                  	; 12/12/2022
 30000 00001CFA C3                      	retn
 30001                                  
 30002                                  ; 12/12/2022
 30003                                  ;_$P_STRUC_L5:				;AN000;
 30004                                  ;	CLC				;AN020;not a slash
 30005                                  ;;	    .ENDIF			;AN020;
 30006                                  ;;	.ELSE				;AN020;is first char in the buffer, ZF=0
 30007                                  ;	jmp	short _$P_STRUC_L1	;AN000;
 30008                                  
 30009                                  _$P_STRUC_L2:				;AN000;
 30010                                  ;	.IF <AL EQ _$P_Switch> THEN	;AN020;
 30011 00001CFB 3C2F                    	cmp     al,_$P_Switch		;AN000;
 30012 00001CFD 7506                    	jne	short _$P_STRUC_L12	;AN000;
 30013                                  
 30014 00001CFF 2E800E[0115]40          	or	byte [cs:_$P_Flags2],_$P_SW ;AN020 ;AC034;;could be valid switch, first char and is slash
 30015                                  ;	.ENDIF				;AN020;
 30016                                  
 30017                                  	; 12/12/2022
 30018                                  	; cf=0
 30019                                  	;retn
 30020                                  
 30021                                  _$P_STRUC_L5:
 30022                                  	; 12/12/2022
 30023                                  _$P_STRUC_L12:				;AN000;
 30024 00001D05 F8                      	clc				;AN020;CF=0 indicating first char
 30025                                  ;	.ENDIF				;AN020;
 30026                                  _$P_STRUC_L1:				;AN000;
 30027 00001D06 C3                      	retn				;AN000;
 30028                                  
 30029                                  ;**************************************************************************
 30030                                  ; _$P_Chk_DBCS:
 30031                                  ;
 30032                                  ;  Function: Check if a specified byte is in ranges of the DBCS lead bytes
 30033                                  ;
 30034                                  ;  Input:
 30035                                  ;	  AL	= Code to be examineed
 30036                                  ;
 30037                                  ;  Output:
 30038                                  ;	  If CF is on then a lead byte of DBCS
 30039                                  ;
 30040                                  ; Use: INT 21h w/AH=63
 30041                                  ;
 30042                                  ; Vars:  _$P_DBCSEV_Seg(RW), _$P_DBCSEV_Off(RW)
 30043                                  ;***************************************************************************
 30044                                  
 30045                                  _$P_Chk_DBCS:
 30046 00001D07 1E                      	push	ds			;AN000;
 30047 00001D08 56                      	push	si			;AN000;
 30048 00001D09 53                      	push	bx			;AN000; (tm11)
 30049                                  	;cmp	word [cs:_$P_DBCSEV_SEG],0 ;AC034; ALREADY SET ?
 30050                                  	;jne	short _$P_DBCS00	;AN000;
 30051                                  	; 08/07/2023
 30052 00001D0A 2E8B36[FE14]            	mov	si,[cs:_$P_DBCSEV_SEG]
 30053 00001D0F 21F6                    	and	si,si ; 0 ?
 30054 00001D11 7525                    	jnz	short _$P_DBCS00 ; already set
 30055 00001D13 50                      	push	ax			;AN000;
 30056 00001D14 1E                      	push	ds			;AN000; (tm11)
 30057 00001D15 51                      	push	cx			;AN000;
 30058 00001D16 52                      	push	dx			;AN000;
 30059 00001D17 57                      	push	di			;AN000;
 30060 00001D18 55                      	push	bp			;AN000;
 30061 00001D19 06                      	push	es			;AN000;
 30062                                  	; si = 0 ; 08/07/2023
 30063                                  	;xor	si,si			;AN000;
 30064 00001D1A 8EDE                    	mov	ds,si ; 0		;AN000;
 30065 00001D1C B80063                  	mov	ax,_$P_DOS_GetEV ; 6300h ;AN000; GET DBCS EV CALL
 30066 00001D1F CD21                    	int	21h			;AN000;
 30067                                  		; DOS - 3.2+ only - GET DOUBLE BYTE CHARACTER SET LEAD TABLE
 30068 00001D21 8CDB                    	mov	bx,ds			;AN000; (tm11)
 30069 00001D23 09DB                    	or	bx,bx			;AN000; (tm11)
 30070 00001D25 07                      	pop	es			;AN000;
 30071 00001D26 5D                      	pop	bp			;AN000;
 30072 00001D27 5F                      	pop	di			;AN000;
 30073 00001D28 5A                      	pop	dx			;AN000;
 30074 00001D29 59                      	pop	cx			;AN000;
 30075 00001D2A 1F                      	pop	ds			;AN000; (tm11)
 30076 00001D2B 58                      	pop	ax			;AN000;
 30077 00001D2C 7424                    	jz	short _$P_NON_DBCS	;AN000;
 30078                                  _$P_DBCS02:				;AN000;
 30079 00001D2E 2E8936[FC14]            	mov	[cs:_$P_DBCSEV_OFF],si	;AC034; save EV offset
 30080 00001D33 2E891E[FE14]            	mov	[cs:_$P_DBCSEV_SEG],bx	;AC034; save EV segment (tm11)
 30081                                  _$P_DBCS00:				;AN000;
 30082                                  	;mov	si,[cs:_$P_DBCSEV_OFF]	;AC034; load EV offset
 30083                                  	;mov	ds,[cs:_$P_DBCSEV_SEG]	;AC034; and segment
 30084                                  	; 08/07/2023
 30085 00001D38 2EC536[FC14]            	lds	si,[cs:_$P_DBCSEV_OFF]
 30086                                  _$P_DBCS_LOOP:				;AN000;
 30087 00001D3D 833C00                  	cmp	word [si],0		;AN000; zero vector ?
 30088 00001D40 7410                    	je	short _$P_NON_DBCS	;AN000; then exit
 30089 00001D42 3A04                    	cmp	al,[si] 		;AN000;
 30090 00001D44 7208                    	jb	short _$P_DBCS01	;AN000; Check if AL is in
 30091 00001D46 3A4401                  	cmp	al,[si+1]		;AN000;   range of
 30092 00001D49 7703                    	ja	short _$P_DBCS01	;AN000;      the vector
 30093 00001D4B F9                      	stc				;AN000; if yes, indicate DBCS and exit
 30094 00001D4C EB04                    	jmp	short _$P_DBCS_EXIT	;AN000;
 30095                                  _$P_DBCS01:				;AN000;
 30096 00001D4E 46                      	inc	si			;AC035; add '2' to
 30097 00001D4F 46                      	inc	si			;AC035;  SI reg
 30098                                  					;AN000; get next vector
 30099 00001D50 EBEB                    	jmp	short _$P_DBCS_LOOP	;AN000; loop until zero vector found
 30100                                  _$P_NON_DBCS:				;AN000;
 30101                                  	; 12/12/2022
 30102                                  	; cf=0
 30103                                  	;clc				;AN000; indicate SBCS
 30104                                  _$P_DBCS_EXIT:				;AN000;
 30105 00001D52 5B                      	pop	bx			;AN000; (tm11)
 30106 00001D53 5E                      	pop	si			;AN000;
 30107 00001D54 1F                      	pop	ds			;AN000;
 30108 00001D55 C3                      	retn				;AN000;
 30109                                  
 30110                                  ; SYSCONF.ASM - MSDOS 6.0 - 1991
 30111                                  ; ======================================================================
 30112                                  ; 27/03/2019 - Retro DOS v4.0
 30113                                  
 30114                                  ;control block definitions for parser.
 30115                                  ;-----------------------------------------------------------------------
 30116                                  ; buffer = [n | n,m] {/e}
 30117                                  
 30118                                  ; 30/03/2019
 30119                                  
 30120                                  struc p_parms
 30121 00000000 ????                    	resw	1	; dw ?
 30122 00000002 ??                      	resb	1	; db 1	; an extra delimiter list
 30123 00000003 ??                      	resb	1	; db 1	; length is 1
 30124 00000004 ??                      	resb 	1	; db ';' ; delimiter
 30125                                  .size:
 30126                                  endstruc
 30127                                  
 30128                                  struc p_pos
 30129 00000000 ????                    	resw	1	; dw ?	; numeric value??
 30130 00000002 ????                    	resw	1	; dw ?	; function
 30131 00000004 ????                    	resw	1	; dw ?	; result value buffer
 30132                                  
 30133                                  ; note: by defining result_val before this structure, we could remove
 30134                                  ;  the "result_val" from every structure invocation
 30135                                  
 30136 00000006 ????                    	resw	1	; dw ?	; value list
 30137 00000008 ??                      	resb	1	; db 0	; no switches/keywords
 30138                                  .size:
 30139                                  endstruc
 30140                                  
 30141                                  struc	p_range
 30142 00000000 ??                      	resb	1	; db 1	; range definition
 30143 00000001 ??                      	resb 	1	; db 1	; 1 definition of range
 30144 00000002 ??                      	resb 	1	; db 1	; item tag for this range
 30145 00000003 ????????                	resd	1	; dd ?	; numeric min
 30146 00000007 ????????                	resd	1	; dd ?	; numeric max
 30147                                  .size:
 30148                                  endstruc
 30149                                  
 30150                                  ;-----------------------------------------------------------------------
 30151                                  
 30152                                  	; 26/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 30153                                  	; (SYSINIT:1F48h)
 30154                                  
 30155                                  	; 08/07/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 30156                                  	; MSDOS 6.21 IO.SYS - SYSINIT:2083h
 30157                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:251Dh) ; (Retro DOS v5.0)
 30158                                  
 30159                                  ; buffer = [n | n,m] {/e}
 30160                                  
 30161                                  ;buf_parms p_parms <buf_parmsx>
 30162                                  buf_parms: 
 30163 00001D56 [5B1D]                  	dw	buf_parmsx
 30164 00001D58 01                      	db	1	; an extra delimiter list
 30165 00001D59 01                      	db	1	; length is 1
 30166 00001D5A 3B                      	db	';'	; delimiter
 30167                                  
 30168                                  buf_parmsx:
 30169 00001D5B 0102[651D][791D]        	dw	201h,buf_pos1,buf_pos2	; min 1, max 2 positionals
 30170 00001D61 01                      	db	1			; one switch
 30171 00001D62 [8D1D]                  	dw	sw_x_ctrl
 30172 00001D64 00                      	db	0			; no keywords
 30173                                  
 30174                                  ;buf_pos1 p_pos <8000h,0,result_val,buf_range_1>  ; numeric
 30175                                  buf_pos1:
 30176 00001D65 0080                    	dw	8000h	; numeric value??
 30177 00001D67 0000                    	dw	0	; function
 30178 00001D69 [9F1D]                  	dw	result_val ; result value buffer	
 30179 00001D6B [6E1D]                  	dw	buf_range_1 ; value list
 30180 00001D6D 00                      	db	0  	; no switches/keywords
 30181                                  
 30182                                  ;buf_range_1 p_range <,,,1,99>		; M050
 30183                                  buf_range_1:
 30184 00001D6E 01                      	db	1	; range definition
 30185 00001D6F 01                      	db	1	; 1 definition of range
 30186 00001D70 01                      	db	1	; item tag for this range
 30187 00001D71 01000000                	dd	1	; numeric min
 30188 00001D75 63000000                	dd	99	; numeric max
 30189                                  
 30190                                  ;buf_pos2 p_pos <8001h,0,result_val,buf_range_2> ; optional num.
 30191                                  buf_pos2:
 30192 00001D79 0180                    	dw	8001h
 30193 00001D7B 0000                    	dw	0
 30194 00001D7D [9F1D]                  	dw	result_val	
 30195 00001D7F [821D]                  	dw	buf_range_2
 30196 00001D81 00                      	db	0
 30197                                  
 30198                                  ;buf_range_2 p_range <,,,0,8>
 30199                                  buf_range_2:
 30200 00001D82 01                      	db	1
 30201 00001D83 01                      	db	1
 30202 00001D84 01                      	db	1
 30203 00001D85 00000000                	dd	0
 30204 00001D89 08000000                	dd	8
 30205                                  
 30206                                  ;sw_x_ctrl p_pos <0,0,result_val,noval,1> ; followed by one switch
 30207                                  sw_x_ctrl:
 30208 00001D8D 0000                    	dw	0
 30209 00001D8F 0000                    	dw	0
 30210 00001D91 [9F1D]                  	dw	result_val	
 30211 00001D93 [9E1D]                  	dw	noval
 30212 00001D95 01                      	db	1	; 1 switch
 30213                                  	
 30214                                  switch_x:
 30215 00001D96 2F5800                  	db	'/X',0		; M016
 30216                                  
 30217                                  p_buffers:
 30218 00001D99 0000                    	dw	0	; local variables
 30219                                  p_h_buffers:
 30220 00001D9B 0000                    	dw	0
 30221                                  	; 26/10/2022  (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 30222                                  p_buffer_slash_x:
 30223 00001D9D 00                      	db	0 ; 31/03/2019
 30224                                  
 30225                                  ;-- common definitions -------------------------------------------------
 30226                                  
 30227 00001D9E 00                      noval:	db	0
 30228                                  
 30229                                  result_val: 	;label	byte
 30230 00001D9F 00                      	db	0		; type returned
 30231                                  result_val_itag:
 30232 00001DA0 00                      	db	0		; item tag returned
 30233                                  result_val_swoff:
 30234 00001DA1 0000                    	dw	0		; es:offset of the switch defined
 30235                                  rv_byte:	;label	byte
 30236 00001DA3 00000000                rv_dword: dd	0		; value if number,or seg:offset to string.
 30237                                  
 30238                                  ;-----------------------------------------------------------------------
 30239                                  
 30240                                  	; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 30241                                  	; (SYSINIT:1F99h)
 30242                                  
 30243                                  ; break = [ on | off ]
 30244                                  
 30245                                  ;brk_parms p_parms  <brk_parmsx>
 30246                                  brk_parms:
 30247 00001DA7 [AC1D]                  	dw	brk_parmsx
 30248 00001DA9 01                      	db	1	; an extra delimiter list
 30249 00001DAA 01                      	db	1	; length is 1
 30250 00001DAB 3B                      	db	';'	; delimiter
 30251                                  
 30252                                  brk_parmsx:
 30253 00001DAC 0101[B21D]              	dw	101h,brk_pos	; min,max = 1 positional
 30254 00001DB0 00                      	db	0		; no switches
 30255 00001DB1 00                      	db	0		; no keywords
 30256                                  
 30257                                  ;brk_pos p_pos <2000h,0,result_val,on_off_string> ; simple string
 30258                                  brk_pos:
 30259 00001DB2 0020                    	dw	2000h
 30260 00001DB4 0000                    	dw	0
 30261 00001DB6 [9F1D]                  	dw	result_val	
 30262 00001DB8 [BB1D]                  	dw	on_off_string
 30263 00001DBA 00                      	db	0
 30264                                  
 30265                                  on_off_string:	;label	byte
 30266 00001DBB 03                      	db	3		; signals that there is a string choice
 30267 00001DBC 00                      	db	0		; no range definition
 30268 00001DBD 00                      	db	0		; no numeric values choice
 30269 00001DBE 02                      	db	2		; 2 strings for choice
 30270 00001DBF 01                      	db	1		; the 1st string tag
 30271 00001DC0 [C51D]                  	dw	on_string
 30272 00001DC2 02                      	db	2		; the 2nd string tag
 30273 00001DC3 [C81D]                  	dw	off_string
 30274                                  
 30275                                  on_string:
 30276 00001DC5 4F4E00                  	db	"ON",0
 30277                                  off_string:
 30278 00001DC8 4F464600                	db	"OFF",0
 30279                                  
 30280                                  p_ctrl_break:
 30281 00001DCC 00                      	db	0	; local variable
 30282                                  
 30283                                  ;-----------------------------------------------------------------------
 30284                                  
 30285                                  	; 27/10/2022
 30286                                  
 30287                                  ; country = n {m {path}}
 30288                                  ; or
 30289                                  ; country = n,,path
 30290                                  
 30291                                  ;cntry_parms p_parms <cntry_parmsx>
 30292                                  cntry_parms:
 30293 00001DCD [D21D]                  	dw	cntry_parmsx
 30294 00001DCF 01                      	db	1
 30295 00001DD0 01                      	db	1
 30296 00001DD1 3B                      	db	';'
 30297                                  	
 30298                                  cntry_parmsx:
 30299 00001DD2 0103[DC1D][F01D]-       	dw	301h,cntry_pos1,cntry_pos2,cntry_pos3 ; min 1, max 3 pos.
 30299 00001DD8 [F91D]             
 30300 00001DDA 00                      	db	0		; no switches
 30301 00001DDB 00                      	db	0		; no keywords
 30302                                  
 30303                                  ;cntry_pos1 p_pos <8000h,0,result_val,cc_range> ; numeric value
 30304                                  cntry_pos1:
 30305 00001DDC 0080                    	dw	8000h
 30306 00001DDE 0000                    	dw	0
 30307 00001DE0 [9F1D]                  	dw	result_val	
 30308 00001DE2 [E51D]                  	dw	cc_range
 30309 00001DE4 00                      	db	0
 30310                                  
 30311                                  ;cc_range p_range <,,,1,999>
 30312                                  cc_range:
 30313 00001DE5 01                      	db	1
 30314 00001DE6 01                      	db	1
 30315 00001DE7 01                      	db	1
 30316 00001DE8 01000000                	dd	1
 30317 00001DEC E7030000                	dd	999
 30318                                  
 30319                                  ;cntry_pos2 p_pos <8001h,0,result_val,cc_range> ; optional num.
 30320                                  cntry_pos2:
 30321 00001DF0 0180                    	dw	8001h
 30322 00001DF2 0000                    	dw	0
 30323 00001DF4 [9F1D]                  	dw	result_val	
 30324 00001DF6 [E51D]                  	dw	cc_range
 30325 00001DF8 00                      	db	0
 30326                                  
 30327                                  ;cntry_pos3 p_pos <201h,0,result_val,noval>     ; optional filespec
 30328                                  cntry_pos3:
 30329 00001DF9 0102                    	dw	201h
 30330 00001DFB 0000                    	dw	0
 30331 00001DFD [9F1D]                  	dw	result_val	
 30332 00001DFF [9E1D]                  	dw	noval
 30333 00001E01 00                      	db	0	
 30334                                  
 30335                                  p_cntry_code:
 30336 00001E02 0000                    	dw	0	; local variable
 30337                                  p_code_page:
 30338 00001E04 0000                    	dw	0	; local variable
 30339                                  
 30340                                  ;-----------------------------------------------------------------------
 30341                                  
 30342                                  	; 27/10/2022
 30343                                  
 30344                                  ; files = n
 30345                                  
 30346                                  ;files_parms p_parms <files_parmsx>
 30347                                  files_parms:
 30348 00001E06 [0B1E]                  	dw	files_parmsx
 30349 00001E08 01                      	db	1
 30350 00001E09 01                      	db	1
 30351 00001E0A 3B                      	db	';'
 30352                                  
 30353                                  files_parmsx:
 30354 00001E0B 0101[111E]              	dw	101h,files_pos	; min,max 1 positional
 30355 00001E0F 00                      	db	0		; no switches
 30356 00001E10 00                      	db	0		; no keywords
 30357                                  
 30358                                  ;files_pos p_pos <8000h,0,result_val,files_range,0> ; numeric value
 30359                                  files_pos:
 30360 00001E11 0080                    	dw	8000h
 30361 00001E13 0000                    	dw	0
 30362 00001E15 [9F1D]                  	dw	result_val	
 30363 00001E17 [1A1E]                  	dw	files_range
 30364 00001E19 00                      	db	0
 30365                                  
 30366                                  ;files_range p_range <,,,8,255>
 30367                                  files_range:
 30368 00001E1A 01                      	db	1
 30369 00001E1B 01                      	db	1
 30370 00001E1C 01                      	db	1
 30371 00001E1D 08000000                	dd	8
 30372 00001E21 FF000000                	dd	255
 30373                                  
 30374                                  p_files:
 30375 00001E25 00                      	db	0		; local variable
 30376                                  
 30377                                  ;-----------------------------------------------------------------------
 30378                                  
 30379                                  	; 27/10/2022
 30380                                  
 30381                                  ; fcbs = n,m
 30382                                  
 30383                                  ;fcbs_parms p_parms <fcbs_parmsx>
 30384                                  fcbs_parms:
 30385 00001E26 [2B1E]                  	dw	fcbs_parmsx
 30386 00001E28 01                      	db	1
 30387 00001E29 01                      	db	1
 30388 00001E2A 3B                      	db	';'
 30389                                  
 30390                                  fcbs_parmsx:
 30391 00001E2B 0102[331E][471E]        	dw	201h,fcbs_pos_1,fcbs_pos_2 ; min,max = 2 positional
 30392 00001E31 00                      	db	0		; no switches
 30393 00001E32 00                      	db	0		; no keywords
 30394                                  
 30395                                  ;fcbs_pos_1 p_pos <8000h,0,result_val,fcbs_range> ; numeric value
 30396                                  fcbs_pos_1:
 30397 00001E33 0080                    	dw	8000h
 30398 00001E35 0000                    	dw	0
 30399 00001E37 [9F1D]                  	dw	result_val	
 30400 00001E39 [3C1E]                  	dw	fcbs_range
 30401 00001E3B 00                      	db	0
 30402                                  
 30403                                  ;fcbs_range p_range <,,,1,255>
 30404                                  fcbs_range:
 30405 00001E3C 01                      	db	1
 30406 00001E3D 01                      	db	1
 30407 00001E3E 01                      	db	1
 30408 00001E3F 01000000                	dd	1
 30409 00001E43 FF000000                	dd	255
 30410                                  
 30411                                  ;fcbs_pos_2 p_pos <8000h,0,result_val,fcbs_keep_range> ; numeric value
 30412                                  fcbs_pos_2:
 30413 00001E47 0080                    	dw	8000h
 30414 00001E49 0000                    	dw	0
 30415 00001E4B [9F1D]                  	dw	result_val	
 30416 00001E4D [501E]                  	dw	fcbs_keep_range
 30417 00001E4F 00                      	db	0
 30418                                  
 30419                                  ;fcbs_keep_range p_range <,,,0,255>
 30420                                  fcbs_keep_range:
 30421 00001E50 01                      	db	1
 30422 00001E51 01                      	db	1
 30423 00001E52 01                      	db	1
 30424 00001E53 00000000                	dd	0
 30425 00001E57 FF000000                	dd	255
 30426                                  
 30427 00001E5B 00                      p_fcbs:	db	0		; local variable
 30428 00001E5C 00                      p_keep:	db	0		; local variable
 30429                                  
 30430                                  ;-----------------------------------------------------------------------
 30431                                  
 30432                                  	; 27/10/2022
 30433                                  
 30434                                  ; lastdrive = x
 30435                                  
 30436                                  ;ldrv_parms p_parms <ldrv_parmsx>
 30437                                  ldrv_parms:
 30438 00001E5D [621E]                  	dw	ldrv_parmsx
 30439 00001E5F 01                      	db	1
 30440 00001E60 01                      	db	1
 30441 00001E61 3B                      	db	';'
 30442                                  
 30443                                  ldrv_parmsx:
 30444 00001E62 0101[681E]              	dw	101h,ldrv_pos	; min,max = 1 positional
 30445 00001E66 00                      	db	0		; no switches
 30446 00001E67 00                      	db	0		; no keywords
 30447                                  
 30448                                  ;ldrv_pos p_pos	<110h,10h,result_val,noval> ; drive only, ignore colon
 30449                                  ldrv_pos:				    ; remove colon at end
 30450 00001E68 1001                    	dw	110h
 30451 00001E6A 1000                    	dw	10h
 30452 00001E6C [9F1D]                  	dw	result_val	
 30453 00001E6E [9E1D]                  	dw	noval
 30454 00001E70 00                      	db	0
 30455                                  	
 30456 00001E71 00                      p_ldrv:	db	0		; local variable
 30457                                  
 30458                                  ;-----------------------------------------------------------------------
 30459                                  
 30460                                  	; 27/10/2022
 30461                                  
 30462                                  ; stacks = n,m
 30463                                  
 30464                                  ;stks_parms p_parms <stks_parmsx>
 30465                                  stks_parms:
 30466 00001E72 [771E]                  	dw	stks_parmsx
 30467 00001E74 01                      	db	1
 30468 00001E75 01                      	db	1
 30469 00001E76 3B                      	db	';'
 30470                                  
 30471                                  stks_parmsx:
 30472 00001E77 0202[7F1E][931E]        	dw	202h,stks_pos_1,stks_pos_2 ; min,max = 2 positionals
 30473 00001E7D 00                      	db	0		; no switches
 30474 00001E7E 00                      	db	0		; no keywords
 30475                                  
 30476                                  ;stks_pos_1 p_pos <8000h,0,result_val,stks_range> ; numeric value
 30477                                  stks_pos_1:
 30478 00001E7F 0080                    	dw	8000h
 30479 00001E81 0000                    	dw	0
 30480 00001E83 [9F1D]                  	dw	result_val	
 30481 00001E85 [881E]                  	dw	stks_range
 30482 00001E87 00                      	db	0
 30483                                  
 30484                                  ;stks_range p_range <,,,0,64>
 30485                                  stks_range:
 30486 00001E88 01                      	db	1
 30487 00001E89 01                      	db	1
 30488 00001E8A 01                      	db	1
 30489 00001E8B 00000000                	dd	0
 30490 00001E8F 40000000                	dd	64
 30491                                  
 30492                                  ;stks_pos_2 p_pos <8000h,0,result_val,stk_size_range> ; numeric value
 30493                                  stks_pos_2:
 30494 00001E93 0080                    	dw	8000h
 30495 00001E95 0000                    	dw	0
 30496 00001E97 [9F1D]                  	dw	result_val	
 30497 00001E99 [9C1E]                  	dw	stk_size_range
 30498 00001E9B 00                      	db	0
 30499                                  
 30500                                  ;stk_size_range p_range <,,,0,512>
 30501                                  stk_size_range:
 30502 00001E9C 01                      	db	1
 30503 00001E9D 01                      	db	1
 30504 00001E9E 01                      	db	1
 30505 00001E9F 00000000                	dd	0
 30506 00001EA3 00020000                	dd	512	
 30507                                  
 30508                                  p_stack_count:
 30509 00001EA7 0000                    	dw	0	; local variable
 30510                                  p_stack_size:
 30511 00001EA9 0000                    	dw	0	; local variable
 30512                                  
 30513                                  ;-----------------------------------------------------------------------
 30514                                  
 30515                                  	; 27/10/2022
 30516                                  
 30517                                  ; multitrack = [ on | off ]
 30518                                  
 30519                                  ;mtrk_parms p_parms <mtrk_parmsx>
 30520                                  mtrk_parms:
 30521 00001EAB [B01E]                  	dw	mtrk_parmsx
 30522 00001EAD 01                      	db	1
 30523 00001EAE 01                      	db	1
 30524 00001EAF 3B                      	db	';'
 30525                                  
 30526                                  mtrk_parmsx:
 30527 00001EB0 0101[B61E]              	dw	101h,mtrk_pos	; min,max = 1 positional
 30528 00001EB4 00                      	db	0		; no switches
 30529 00001EB5 00                      	db	0		; no keywords
 30530                                  
 30531                                  ;mtrk_pos p_pos <2000h,0,result_val,on_off_string> ; simple string
 30532                                  mtrk_pos:
 30533 00001EB6 0020                    	dw	2000h
 30534 00001EB8 0000                    	dw	0
 30535 00001EBA [9F1D]                  	dw	result_val	
 30536 00001EBC [BB1D]                  	dw	on_off_string
 30537 00001EBE 00                      	db	0
 30538                                  
 30539 00001EBF 00                      p_mtrk:	db	0		; local variable
 30540                                  
 30541                                  ;-----------------------------------------------------------------------
 30542                                  
 30543                                  	; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 30544                                  	; (SYSINIT:20B2h)
 30545                                  
 30546                                  ; switches=/k
 30547                                  
 30548                                  ;swit_parms p_parms <swit_parmsx>
 30549                                  swit_parms:
 30550 00001EC0 [C51E]                  	dw	swit_parmsx
 30551 00001EC2 01                      	db	1
 30552 00001EC3 01                      	db	1
 30553 00001EC4 3B                      	db	';'
 30554                                  
 30555                                  swit_parmsx:
 30556 00001EC5 0000                    	dw	0		; no positionals
 30557                                  	; 08/07/2023 - Retro DOS v4.2 (MSDOS 6.21 IO.SYS, SYSINIT)
 30558 00001EC7 05                      	db	5               ; # of switches
 30559                                  	; 27/10/2022 - Retro DOS v4.0 (MSDOS 5.0 IO.SYS, SYSINIT)
 30560                                  	;db	3
 30561 00001EC8 [D31E]                  	dw	swit_k_ctrl	; /k control
 30562                                  	; 01/01/2023 - Retro DOS v4.2 ; *
 30563 00001ECA [DF1E]                  	dw	swit_n_ctrl ; * ; /n control (for MULTI_CONFIG only)
 30564 00001ECC [EB1E]                  	dw	swit_f_ctrl ; * ; /f control (for MULTI_CONFIG only)
 30565 00001ECE [F71E]                  	dw	swit_t_ctrl     ; /t control
 30566 00001ED0 [031F]                  	dw	swit_w_ctrl     ; /w control
 30567 00001ED2 00                      	db	0		; no keywords
 30568                                  
 30569                                  ;swit_k_ctrl p_pos <0,0,result_val,noval,1> ; switch string follows
 30570                                  swit_k_ctrl:
 30571 00001ED3 00000000[9F1D]-         	dw	0,0,result_val,noval
 30571 00001ED9 [9E1D]             
 30572 00001EDB 01                      	db	1
 30573 00001EDC 2F4B00                  swit_k:	db	'/K',0
 30574                                  
 30575                                  ; 01/01/2023 - Retro DOS v4.2 (MSDOS 6.21 IO.SYS)
 30576                                  ; (SYSINIT:220Ch) ; *
 30577                                  
 30578                                  ; 27/10/2022 - Retro DOS v4.0 (MSDOS 5.0 IO.SYS, SYSINIT)
 30579                                  ;
 30580                                  ;swit_n_ctrl p_pos <0,0,result_val,noval,1> ; switch string follows
 30581                                  swit_n_ctrl: ; *
 30582 00001EDF 00000000[9F1D]-         	dw	0,0,result_val,noval
 30582 00001EE5 [9E1D]             
 30583 00001EE7 01                      	db	1
 30584 00001EE8 2F4E00                  swit_n: db	'/N',0
 30585                                  
 30586                                  ;swit_f_ctrl p_pos <0,0,result_val,noval,1> ; switch string follows
 30587                                  swit_f_ctrl: ; *
 30588 00001EEB 00000000[9F1D]-         	dw	0,0,result_val,noval
 30588 00001EF1 [9E1D]             
 30589 00001EF3 01                      	db	1
 30590 00001EF4 2F4600                  swit_f: db 	'/F',0
 30591                                  
 30592                                  	; 27/10/2022
 30593                                  
 30594                                  ;swit_t_ctrl p_pos <0,0,result_val,noval,1> ; switch string follows	M059
 30595                                  swit_t_ctrl:
 30596 00001EF7 00000000[9F1D]-         	dw	0,0,result_val,noval
 30596 00001EFD [9E1D]             
 30597 00001EFF 01                      	db	1
 30598 00001F00 2F5400                  swit_t:	db	'/T',0			   ;				M059
 30599                                  ;swit_w_ctrl p_pos <0,0,result_val,noval,1> ; switch string follows	M063
 30600                                  swit_w_ctrl:
 30601 00001F03 00000000[9F1D]-         	dw	0,0,result_val,noval
 30601 00001F09 [9E1D]             
 30602 00001F0B 01                      	db	1
 30603 00001F0C 2F5700                  swit_w:	db	'/W',0			   ;				M063
 30604                                  
 30605                                  ;   There doesn't need to be p_swit_n or p_swit_f because /N and /F are
 30606                                  ;   acted upon during MULTI_CONFIG processing; we only needed entries
 30607                                  ;   in the above table to prevent the parsing code from complaining about them
 30608                                  
 30609 00001F0F 00                      p_swit_k:	db     0	; local variable
 30610 00001F10 00                      p_swit_t:	db     0	; local variable			M059
 30611 00001F11 00                      p_swit_w:	db     0	; local variable			M063
 30612                                  
 30613                                  ;-----------------------------------------------------------------------
 30614                                  
 30615                                  	; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 30616                                  	; (SYSINIT:20E8h)
 30617                                  
 30618                                  ; DOS = [ high | low ]
 30619                                  
 30620                                  ;dos_parms p_parms  <dos_parmsx>
 30621                                  dos_parms:
 30622 00001F12 [171F]                  	dw	dos_parmsx
 30623 00001F14 01                      	db	1
 30624 00001F15 01                      	db	1
 30625 00001F16 3B                      	db	';'
 30626                                  dos_parmsx:
 30627 00001F17 01                      	db	1		; min parameters
 30628 00001F18 02                      	db	2		; max parameters
 30629 00001F19 [1F1F]                  	dw	dos_pos		; 
 30630 00001F1B [1F1F]                  	dw	dos_pos		; 
 30631 00001F1D 00                      	db	0		; no switches
 30632 00001F1E 00                      	db	0		; no keywords
 30633                                  
 30634                                  ;dos_pos p_pos	<2000h,0,result_val,dos_strings> ; simple string
 30635                                  ;        p_pos	<2000h,0,result_val,dos_strings> ; simple string
 30636                                  dos_pos:
 30637 00001F1F 00200000[9F1D]-         	dw	2000h,0,result_val,dos_strings
 30637 00001F25 [311F]             
 30638 00001F27 00                      	db	0
 30639 00001F28 00200000[9F1D]-         	dw	2000h,0,result_val,dos_strings
 30639 00001F2E [311F]             
 30640 00001F30 00                      	db	0	
 30641                                  
 30642                                  dos_strings:	;label	byte
 30643 00001F31 03                      	db	3		; signals that there is a string choice
 30644 00001F32 00                      	db	0		; no range definition
 30645 00001F33 00                      	db	0		; no numeric values choice
 30646 00001F34 04                      	db	4		; 4 strings for choice
 30647 00001F35 01                      	db	1		; the 1st string tag
 30648 00001F36 [411F]                  	dw	hi_string
 30649 00001F38 02                      	db	2		; the 2nd string tag
 30650 00001F39 [461F]                  	dw	lo_string
 30651 00001F3B 03                      	db	3
 30652 00001F3C [4A1F]                  	dw	umb_string
 30653 00001F3E 04                      	db	4
 30654 00001F3F [4E1F]                  	dw	noumb_string
 30655                                  
 30656 00001F41 4849474800              hi_string:	db	"HIGH",0
 30657 00001F46 4C4F5700                lo_string:	db	"LOW",0
 30658 00001F4A 554D4200                umb_string:	db	"UMB",0
 30659 00001F4E 4E4F554D4200            noumb_string:	db	"NOUMB",0
 30660                                  
 30661 00001F54 00                      p_dos_hi:	db	0	; local variable
 30662                                  				; BUGBUG : I dont know whether PARSER uses
 30663                                  				;          this variable or not
 30664                                  
 30665                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 30666                                  ; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 30667                                  ;%if 0
 30668                                  
 30669                                  ;****************************************************************** RICHID ****
 30670                                  
 30671                                  ;include	highvar.inc	; devicehigh variables (used by loadhigh also)
 30672                                  
 30673                                  ; 30/03/2019 - Retro DOS v4.0
 30674                                  ;------------------------------------------------------------------------------
 30675                                  
 30676                                  ;   Module:   HIGHVAR.INC - Data common to LOADHIGH and DEVICEHIGH, res seg
 30677                                  ;
 30678                                  ;   Date:     May 14, 1992
 30679                                  ;
 30680                                  ;******************************************************************************
 30681                                  ;
 30682                                  ;   Modification log:
 30683                                  ;
 30684                                  ;     DATE    WHO      DESCRIPTION
 30685                                  ;   --------  -------  --------------------------------------------------------
 30686                                  ;   05/14/92  t-richj  Original
 30687                                  ;   06/21/92  t-richj  Final revisions before check-in
 30688                                  ;
 30689                                  ;******************************************************************************
 30690                                  ;
 30691                                  ; There are two primary definitions which need to be made, selectively, before
 30692                                  ; this include file should be used.  These are:
 30693                                  ;    HV_Extern - If this has been defined, variables for this module will be
 30694                                  ;                declared as external.  Otherwise, variables will be declared
 30695                                  ;                public, as well as defined, here.  LoadHigh declares HV_Extern
 30696                                  ;                in stub.asm and loadhi.asm, and does not declare it in
 30697                                  ;                rdata.asm... DeviceHigh does not declare HV_Extern anywhere
 30698                                  ;                (as only one module, sysconf.asm, includes this file).
 30699                                  ;    HV_LoadHigh - This should be defined when this module is going into
 30700                                  ;                  command.com, for LoadHigh.  All of loadhi.asm, stub.asm and
 30701                                  ;                  rdata.asm define this, while io.sys' sysconf.asm does not.
 30702                                  ;
 30703                                  ;******************************************************************************
 30704                                  
 30705                                  ; To keep track of which UMBs were specified on the DH/LH command lines, and
 30706                                  ; to keep track of the minimum sizes given for each, there're two arrays kept
 30707                                  ; in { IO.SYS: sysinitseg / COMMAND.COM: DATARES }... each is MAXUMB elements
 30708                                  ; big.  16 should be around 14 too many for most users, so there's no expected
 30709                                  ; space problem (it's just such a nice round number, eh?).
 30710                                  
 30711                                  MAXUMB	equ	16
 30712                                  
 30713                                  ; Memory elements owned by the system are marked as PSP address 8 in both the
 30714                                  ; USA and Japan; Japanese systems also use 9 under more bizzarre conditions.
 30715                                  
 30716                                  FreePSPOwner	equ	0	; Free MCBs all have an owner PSP address of 0
 30717                                  SystemPSPOwner	equ	8
 30718                                  ;JapanPSPOwner	equ	9
 30719                                  
 30720                                  ; for LoadHigh and DeviceHigh:
 30721                                  ;
 30722                                  ;	fInHigh - Is set to 1 during HideUMBs(), and back to zero in
 30723                                  ;	          UnHideUMBs().
 30724                                  ;	fUmbTiny - Is set to 1 if the user has specified /S on the command-
 30725                                  ;	           line.
 30726                                  ;	SegLoad - Segment address for first UMB specified; set automatically.
 30727                                  ;	UmbLoad - The load UMB number; for example, this is 3 if the user has
 30728                                  ;	          given a command-line like "/L:3,500;4"
 30729                                  ;	UmbUsed - An array of characters, each of which is 1 iff the UMB
 30730                                  ;	          matching its index number was specified on the command-line;
 30731                                  ;	          for example, after "/L:3,500;4;7", UmbUsed[3], [4] and [7]
 30732                                  ;	          will be set to 1. All others will be set to 0.
 30733                                  ;	UmbSize - An array of words, each of which is interpereted as a size
 30734                                  ;	          specified by the user for a UMB (in the above example, all
 30735                                  ;	          elements would be zero save UmbSize[3], which would be 500.
 30736                                  ;	fm_umb - Set to the old UMB link-state (0x80 or 0x00)
 30737                                  ;	fm_strat - Set to the old memory-allocation strategy (0$00000???)
 30738                                  ;	fm_argc  - Number of arguments received by ParseVar() (see ParseVar()
 30739                                  ;	           for details).
 30740                                  
 30741 00001F55 00                      fInHigh:  db	0
 30742 00001F56 00                      fUmbTiny: db	0
 30743 00001F57 0000                    SegLoad:  dw	0
 30744 00001F59 00                      UmbLoad:  db	0
 30745 00001F5A 00<rep 10h>             UmbUsed:  times MAXUMB db 0 ; times 16 db 0  ; db 16 dup(?)
 30746 00001F6A 0000<rep 10h>           UmbSize:  times MAXUMB dw 0 ; times 16 dw 0  ; dw 16 dup(?)
 30747 00001F8A 00                      fm_umb:   db	0
 30748 00001F8B 00                      fm_strat: db	0
 30749 00001F8C 00                      fm_argc:  db	0	
 30750                                  
 30751                                  ; UmbLoad is set to UNSPECIFED, below, until /L:umb is read; at which point
 30752                                  ; UmbLoad is set to the UMB number given.
 30753                                  
 30754                                  UNSPECIFIED	equ	-1
 30755                                  
 30756                                  ;%endif ; 27/10/2022
 30757                                  
 30758                                  ;****************************************************************** RICHID ****
 30759                                  
 30760                                  ; 30/03/2019 - Retro DOS v4.0 (MSDOS 6.0, SYSCONF.ASM)
 30761                                  ; ((MSDOS 6.21 IO.SYS -> SYNINIT:22BAh))
 30762                                  
 30763                                  ; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 30764                                  ; (SYSINIT:212Bh)	
 30765                                  
 30766                                  		;public	DevEntry
 30767                                  
 30768 00001F8D 0000                    DevSize:	dw	0	; size of the device driver being loaded (paras)
 30769 00001F8F 0000                    DevLoadAddr:	dw	0	; Mem addr where the device driver is 2 b loaded
 30770 00001F91 0000                    DevLoadEnd:	dw	0	; MaxAddr to which device can be loaded
 30771 00001F93 00000000                DevEntry:	dd	0	; Entry point to the device driver
 30772 00001F97 00000000                DevBrkAddr:	dd	0	; Break address of the device driver
 30773                                  ; 30/12/2022
 30774                                  ; 27/10/2022 
 30775 00001F9B 00                      ConvLoad:	db	0	; Use conventional (dos 5 style) InitDevLoad?
 30776                                  ;
 30777 00001F9C 00                      DevUMB:		db	0	; byte indicating whether to load DDs in UMBs
 30778 00001F9D 0000                    DevUMBAddr:	dw	0	; current UMB used for loading devices (paras)
 30779 00001F9F 0000                    DevUMBSize:	dw	0	; Size of the current UMB being used   (paras)
 30780 00001FA1 0000                    DevUMBFree:	dw	0	; Start of free mem blk in the current UMB (paras)
 30781                                  ;
 30782 00001FA3 00000000                DevXMSAddr:	dd	0
 30783                                  ;
 30784 00001FA7 0000                    DevExecAddr:	dw	0	; Device load address parameter to Exec call
 30785 00001FA9 0000                    DevExecReloc:	dw	0	; Device load relocation factor
 30786                                  ;
 30787 00001FAB 00                      DeviceHi:	db	0	; Flag indicating whether the current device
 30788                                  				;  is being loaded into UMB
 30789 00001FAC 0000                    DevSizeOption:	dw	0	; SIZE= option
 30790                                  ;
 30791 00001FAE 00                      Int12Lied:	db	0	; did we trap int 12h ?
 30792 00001FAF 0000                    OldInt12Mem:	dw	0	; value in 40:13h (int 12h ram)
 30793 00001FB1 50524F544D414E24        ThreeComName:	db	'PROTMAN$' ; 3Com Device name
 30794                                  ;
 30795 00001FB9 00                      FirstUMBLinked:	db	0
 30796 00001FBA 0000                    DevDOSData:	dw	0	; segment of DOS Data
 30797 00001FBC 00000000                DevCmdLine:	dd	0	; Current Command line
 30798 00001FC0 00                      DevSavedDelim:	db	0	; The delimiter which was replaced with null
 30799                                  				; to use the file name in the command line
 30800                                  ;
 30801                                  ;	ifdef	dblspace_hooks
 30802                                  ;MagicHomeFlag:	db	0	; set non-zero when MagicDrv is final placed
 30803                                  ;	endif
 30804                                  
 30805                                  ; ===========================================================================
 30806                                  
 30807                                  ; 31/03/2019 - Retro DOS v4.0
 30808                                  
 30809                                  ; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 30810                                  ; (SYSINIT:215Eh)
 30811                                  
 30812                                  ;----------------------------------------------------------------------------
 30813                                  ;
 30814                                  ; procedure : doconf
 30815                                  ;
 30816                                  ;             Config file is parsed initially with this routine. For the
 30817                                  ;             Subsequent passes 'multi_pass' entry is used .
 30818                                  ;
 30819                                  ;----------------------------------------------------------------------------
 30820                                  
 30821                                  	; 27/10/2022
 30822                                  doconf:
 30823 00001FC1 0E                      	push	cs
 30824 00001FC2 1F                      	pop	ds
 30825                                  
 30826 00001FC3 B80037                  	mov	ax,3700h
 30827                                          ;mov	ax,(CHAR_OPER<<8)	; get switch character
 30828 00001FC6 CD21                    	int	21h
 30829 00001FC8 8816[6946]              	mov	[command_line+1],dl	; set in default command line
 30830                                  
 30831                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21  IO.SYS)
 30832                                  ; 27/10/2022
 30833                                  ;;ifdef	MULTI_CONFIG
 30834                                  ;	;mov	[command_line-1],dl     ; save default switchchar
 30835 00001FCC 8816[6746]              	mov	[def_swchr],dl ; 31/03/2019 
 30836                                  ;;endif	;MULTI_CONFIG
 30837                                  
 30838 00001FD0 BA[7E45]                	mov	dx,config ;'\CONFIG.SYS' ; now pointing to file description
 30839 00001FD3 B8003D                  	mov	ax,3D00h
 30840                                  	;mov	ax,OPEN<<8		; open file "config.sys"
 30841 00001FD6 F9                      	stc				; in case of int 24h
 30842 00001FD7 CD21                    	int	21h			; function request
 30843 00001FD9 7309                    	jnc	short noprob		; brif opened okay
 30844                                  
 30845                                  ; 31/12/2022
 30846                                  ; 27/10/2022
 30847                                  ;;ifdef	MULTI_CONFIG
 30848 00001FDB E8F418                  	call	kbd_read		; we still want to give the guy
 30849                                  ;					; a chance to select clean boot!
 30850                                  ;;endif					; (ie, no autoexec.bat processing)
 30851 00001FDE C606[CD02]0B            	mov	byte [multi_pass_id],11	; set it to unreasonable number
 30852 00001FE3 C3                      	retn
 30853                                  noprob: 				; get file size (note < 64k!!)
 30854 00001FE4 89C3                    	mov	bx,ax  ; File handle
 30855 00001FE6 31C9                    	xor	cx,cx			; 0
 30856 00001FE8 31D2                    	xor	dx,dx			; 0
 30857                                  	;mov	ax,4202h
 30858 00001FEA B80242                  	mov	ax,(LSEEK<<8)|2
 30859 00001FED CD21                    	int	21h
 30860 00001FEF A3[5603]                	mov	[count],ax		; dx:ax = file size ; 08/09/2023
 30861                                  					; 08/09/2023 - Erdogan Tan - Note:
 30862 00001FF2 31D2                    	xor	dx,dx			; dx already must be 0 here ; 08/09/2023
 30863                                  					; I am not removing 'xor dx,dx' here
 30864                                  					; for MSDOS compatibility.
 30865                                  					; ((Also PCDOS 7.1 has 'xor dx,dx' here))
 30866                                  					; (Error will be same if CONGIG.SYS file
 30867                                  					;  size > 64KB) 
 30868                                  	;mov	ax,4200h
 30869 00001FF4 B80042                  	mov	ax,LSEEK<<8		;reset pointer to beginning of file
 30870 00001FF7 CD21                    	int	21h
 30871                                  
 30872                                  	; 31/12/2022 - Retro DOS v4.2 
 30873 00001FF9 8B16[A502]              	mov	dx,[ALLOCLIM]		;use current alloclim value
 30874                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 30875                                  	;mov	dx,[top_of_cdss] 
 30876                                  
 30877 00001FFD A1[5603]                	mov	ax,[count]
 30878 00002000 A3[D002]                	mov	[config_size],ax	;save the size of config.sys file.
 30879 00002003 E875F1                  	call	ParaRound
 30880 00002006 29C2                    	sub	dx,ax
 30881                                  
 30882                                  ; 31/12/2022
 30883                                  ; 27/10/2022
 30884                                  ;ifdef	MULTI_CONFIG
 30885                                  ;
 30886                                  ;  The size of the CONFIG.SYS workspace (for recreating the in-memory
 30887                                  ;  CONFIG.SYS image, and later for building the initial environment) need
 30888                                  ;  not be any larger than CONFIG.SYS itself, EXCEPT for the fact that
 30889                                  ;  we (may) add a variable to the environment that does not explicity appear
 30890                                  ;  in CONFIG.SYS, and that variable is CONFIG (as in CONFIG=COMMON).
 30891                                  ;  The default setting for CONFIG cannot result in more than 1 paragraph
 30892                                  ;  of extra space, so here we account for it (the worst case of course is
 30893                                  ;  when CONFIG.SYS is some very small size, like 0 -JTP)
 30894                                  ;
 30895 00002008 4A                      	dec	dx                      ;reserve 1 additional paragraph
 30896 00002009 8916[E614]              	mov	[config_wrkseg],dx      ;this is the segment to be used for
 30897 0000200D 29C2                    	sub	dx,ax                   ;rebuilding the config.sys memory image
 30898                                  ;;endif	;MULTI_CONFIG
 30899                                  
 30900 0000200F 83EA11                  	sub	dx,11h			;room for header
 30901                                  	
 30902                                  	; 31/12/2022
 30903 00002012 8916[A502]              	mov	[ALLOCLIM],dx		;config starts here. new alloclim value.
 30904 00002016 8916[A302]              	mov	[CONFBOT],dx
 30905                                  	
 30906                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 30907                                  	;mov	[top_of_cdss],dx
 30908                                  	;call    TempCDS 
 30909                                  	; 31/12/2022
 30910                                  	; 11/12/2022
 30911                                  	; ds <> cs 
 30912                                  	;mov	dx,[cs:top_of_cdss]	
 30913                                  
 30914                                  	; 08/09/2023
 30915                                  	; ds = cs
 30916 0000201A 8B0E[5603]              	mov	cx,[count]
 30917                                  
 30918 0000201E 8EDA                    	mov	ds,dx
 30919 00002020 8EC2                    	mov	es,dx
 30920                                  
 30921 00002022 31D2                    	xor	dx,dx
 30922                                  	; 08/09/2023
 30923                                  	;mov	cx,[cs:count]
 30924 00002024 B43F                    	mov	ah,3Fh
 30925                                  	;mov	ah,READ  ; 3Fh
 30926 00002026 F9                      	stc				;in case of int 24
 30927 00002027 CD21                    	int	21h			;function request
 30928 00002029 9C                      	pushf
 30929                                  
 30930                                  ; find the eof mark in the file. if present,then trim length.
 30931                                  
 30932 0000202A 50                      	push	ax
 30933 0000202B 57                      	push	di
 30934 0000202C 51                      	push	cx
 30935 0000202D B01A                    	mov	al,1Ah			; eof mark
 30936 0000202F 89D7                    	mov	di,dx			; point to buffer
 30937 00002031 E305                    	jcxz	puteol			; no chars
 30938 00002033 F2AE                    	repnz	scasb			; find end
 30939 00002035 7501                    	jnz	short puteol		; none found and count exhausted
 30940                                  
 30941                                  ; we found a 1a. back up
 30942                                  
 30943 00002037 4F                      	dec	di			; backup past 1Ah
 30944                                  
 30945                                  ;  just for the halibut, stick in an extra eol
 30946                                  
 30947                                  puteol:
 30948 00002038 B00D                    	mov	al,cr ; 0Dh
 30949 0000203A AA                      	stosb
 30950 0000203B B00A                    	mov	al,lf  ;0Ah
 30951 0000203D AA                      	stosb
 30952 0000203E 29D7                    	sub	di,dx			; difference moved
 30953                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 30954                                  	;mov	[cs:count],di		; new count
 30955                                  
 30956                                  	; 11/12/2022	
 30957                                  	; 31/03/2019 - Retro DOS v4.0
 30958 00002040 0E                      	push	cs
 30959 00002041 1F                      	pop	ds
 30960                                  
 30961 00002042 893E[5603]              	mov	[count],di		; new count
 30962                                  
 30963 00002046 59                      	pop	cx
 30964 00002047 5F                      	pop	di
 30965 00002048 58                      	pop	ax
 30966                                  
 30967                                  	; 11/12/2022
 30968                                  	; 27/10/2022
 30969                                  	;push	cs
 30970                                  	;pop	ds
 30971                                  
 30972 00002049 50                      	push	ax
 30973                                  	;mov	ah,CLOSE
 30974 0000204A B43E                    	mov	ah,3Eh
 30975 0000204C CD21                    	int	21h
 30976 0000204E 58                      	pop	ax
 30977 0000204F 9D                      	popf
 30978 00002050 7204                    	jc	short conferr 		;we've got a problem
 30979 00002052 39C1                    	cmp	cx,ax			; if ax <(>) cx
 30980 00002054 742C                    	jz	short getcom		;couldn't read the file
 30981                                  conferr:
 30982 00002056 BA[7E45]                	mov	dx,config		;print config error
 30983 00002059 E87924                  	call	badfil
 30984                                  	; 17/09/2023
 30985                                  endconv:	; 01/01/2023
 30986 0000205C C3                      	retn
 30987                                  
 30988                                  ;----------------------------------------------------------------------------
 30989                                  ;
 30990                                  ; entry : multi_pass
 30991                                  ;
 30992                                  ;             called to execute device=,install= commands
 30993                                  ;
 30994                                  ;----------------------------------------------------------------------------
 30995                                  
 30996                                  	; 27/10/2022
 30997                                  multi_pass:
 30998 0000205D 0E                      	push	cs
 30999 0000205E 1F                      	pop	ds
 31000                                  
 31001 0000205F 803E[CD02]0A            	cmp	byte [multi_pass_id],10
 31002                                  ;jae_endconv:
 31003 00002064 73F6                    	jae	short endconv 		; do nothing. just return.
 31004                                  
 31005                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31006 00002066 FF36[A302]              	push	word [CONFBOT]
 31007                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31008                                  	;push	word [top_of_cdss]
 31009 0000206A 07                      	pop	es			; es = [confbot] (CONFIG.SYS image seg)
 31010                                  
 31011 0000206B 8B36[5803]              	mov	si,[org_count]
 31012 0000206F 8936[5603]              	mov	[count],si		; set count
 31013 00002073 31F6                    	xor	si,si ; 0
 31014 00002075 8936[5A03]                      mov     [chrptr],si		; reset chrptr
 31015 00002079 8936[AF02]                      mov     [linecount],si		; reset linecount
 31016                                  
 31017 0000207D E8DC21                  	call	getchr
 31018 00002080 EB06                    	jmp	short conflp
 31019                                  
 31020                                  	; 17/09/2023
 31021                                  	; 01/01/2023
 31022                                  ;endconv:
 31023                                  	;retn	
 31024                                  
 31025                                  getcom:
 31026                                  	; 03/01/2023
 31027                                  	; ds = cs
 31028 00002082 E81416                          call    organize                ; organize the file
 31029 00002085 E8D421                  	call	getchr
 31030                                  conflp: 
 31031 00002088 72D2                    	jc	short endconv
 31032                                  
 31033 0000208A FF06[AF02]                      inc     word [linecount]	; increase linecount
 31034                                  	
 31035                                  	; 08/09/2023
 31036 0000208E 30E4                    	xor	ah,ah ; 0
 31037                                  	;mov	byte [multdeviceflag],0	; reset multdeviceflag.
 31038                                  	;mov	byte [setdevmarkflag],0	; reset setdevmarkflag.
 31039 00002090 8826[EA14]              	mov	[multdeviceflag],ah ; 0
 31040 00002094 8826[ED14]              	mov	[setdevmarkflag],ah ; 0
 31041                                  
 31042 00002098 3C0A                    	cmp	al,lf			; linefeed?
 31043 0000209A 7448                    	je	short blank_line	; then ignore this line.
 31044                                  
 31045                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31046                                  ; (SYSINIT:23CCh)
 31047                                  ; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31048                                  ;%if 0
 31049                                  
 31050                                  ;ifdef	MULTI_CONFIG
 31051                                  
 31052                                  ;   If this is a genuine CONFIG.SYS command, then there should be a line
 31053                                  ;   number immediately following it....
 31054                                  
 31055 0000209C A2[E814]                        mov     [config_cmd],al         ; save original command code
 31056                                  	;and	al,NOT CONFIG_OPTION_QUERY
 31057 0000209F 247F                    	and	al,~CONFIG_OPTION_QUERY ; and al,7Fh
 31058                                  	
 31059                                  	; 08/09/2023
 31060 000020A1 3826[E914]              	cmp	[config_multi],ah ; 0
 31061                                  	;cmp	byte [config_multi],0	; is this a multi-config config.sys?
 31062 000020A5 7427                            je      short not_final		; no, line number is not embedded
 31063                                  
 31064 000020A7 50                              push    ax                      ;
 31065 000020A8 E8B121                          call    getchr                  ; ignore end-of-image errors,
 31066 000020AB 88C4                            mov     ah,al                   ; because if there's an error
 31067 000020AD E8AC21                          call    getchr                  ; fetching the line number that's
 31068 000020B0 86C4                            xchg    al,ah                   ; supposed to be there, the next
 31069 000020B2 A3[AF02]                        mov     [linecount],ax          ; getchr call will get the same error
 31070 000020B5 58                              pop     ax
 31071                                  ;
 31072                                  ;   HACK: when 4DOS.COM is the shell and it doesn't have an environment from
 31073                                  ;   which to obtain its original program name, it grovels through all of
 31074                                  ;   memory to find the filename that was used to exec it; it wants to find
 31075                                  ;   the SHELL= line in the in-memory copy of CONFIG.SYS, and it knows that
 31076                                  ;   sysinit converts the SHELL= keyword to an 'S', so it expects to find an 'S'
 31077                                  ;   immediately before the filename, but since we are now storing line # info
 31078                                  ;   in the config.sys memory image, 4DOS fails to find the 'S' in the right
 31079                                  ;   spot.
 31080                                  ;
 31081                                  ;   So, on the final pass of CONFIG.SYS, copy the command code (eg, 'S')
 31082                                  ;   over the line number info, since we no longer need that info anyway. This
 31083                                  ;   relies on the fact that getchr leaves ES:SI pointing to the last byte
 31084                                  ;   retrieved.
 31085                                  ;
 31086 000020B6 803E[CD02]02                    cmp	byte [multi_pass_id],2	; final pass?
 31087 000020BB 7211                            jb	short not_final		; no
 31088                                          ;test	word [install_flag],have_install_cmd
 31089 000020BD F606[CE02]01            	test	byte [install_flag],have_install_cmd ; 1
 31090 000020C2 7407                            jz	short final		; no install cmds, so yes it is
 31091 000020C4 803E[CD02]03                    cmp	byte [multi_pass_id],3	; final pass?
 31092 000020C9 7203                            jb	short not_final		; no
 31093                                  final:                                  ;
 31094 000020CB 268804                  	mov	[es:si],al		; save backward-compatible command code
 31095                                  not_final:                              ;
 31096                                  ;endif
 31097                                  
 31098                                  ; 31/12/2022
 31099                                  ;%endif ; 27/10/2022
 31100                                  
 31101 000020CE 88C4                    	mov	ah,al
 31102 000020D0 E88921                  	call	getchr
 31103 000020D3 7314                    	jnc	short tryi
 31104                                  
 31105 000020D5 803E[CD02]02            	cmp	byte [multi_pass_id],2
 31106                                  	;jae	short jae_endconv	; do not show badop again for multi_pass.
 31107                                  	; 27/10/2022
 31108 000020DA 7380                    	jnb	short endconv	
 31109 000020DC E95408                  	jmp	badop
 31110                                  	
 31111                                  coff:	
 31112                                  	; 11/12/2022
 31113                                  	; ds = cs
 31114                                  	;push	cs
 31115                                  	;pop	ds
 31116 000020DF E87121                  	call	newline
 31117 000020E2 EBA4                    	jmp	short conflp	; 13/05/2019
 31118                                  
 31119                                  blank_line:
 31120 000020E4 E87521                  	call	getchr
 31121 000020E7 EB9F                    	jmp	short conflp
 31122                                  
 31123                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31124                                  ; 11/12/2022
 31125                                  ; (there is not a jump or call to here from anywhere!)
 31126                                  ;coff_p:
 31127                                  	;push	cs
 31128                                  	;pop	ds
 31129                                  
 31130                                  ;to handle install= commands,we are going to use multi-pass.
 31131                                  ;the first pass handles the other commands and only set install_flag when
 31132                                  ;it finds any install command. the second pass will only handle the
 31133                                  ;install= command.
 31134                                  
 31135                                  ;------------------------------------------------------------------------------
 31136                                  ;install command
 31137                                  ;------------------------------------------------------------------------------
 31138                                  
 31139                                  	; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 31140                                  	; (SYSINIT:2250h)
 31141                                  tryi:
 31142 000020E9 803E[CD02]00            	cmp	byte [multi_pass_id],0	; the initial pass for DOS=HI
 31143 000020EE 7503                    	jne	short not_init_pass
 31144 000020F0 E97F01                  	jmp	multi_try_doshi
 31145                                  not_init_pass:
 31146 000020F3 803E[CD02]02            	cmp	byte [multi_pass_id],2	; the second pass was for ifs=
 31147                                          ; 11/12/2022
 31148                                  	;je	short multi_pass_coff2	; now it is NOPs
 31149 000020F8 74E5                    	je	short coff
 31150                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31151                                  	;je	short multi_pass_coff	
 31152                                  					; This pass can be made use of if
 31153                                  					; we want do some config.sys process
 31154                                  					; after device drivers are loaded
 31155                                  					; and before install= commands
 31156                                  					; are processed
 31157                                  
 31158 000020FA 803E[CD02]03            	cmp	byte [multi_pass_id],3	; the third pass for install= ?
 31159 000020FF 741D                    	je	short multi_try_i
 31160 00002101 80FC48                          cmp     ah, CONFIG_DOS  ; 'H'
 31161                                  	; 11/12/2022
 31162                                  	;je	short multi_pass_coff2
 31163 00002104 74D9                    	je	short coff
 31164                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31165                                  	;je	short multi_pass_coff	
 31166                                  
 31167                                  ;       make note of any INSTALL= or INSTALLHIGH= commands we find,
 31168                                  ;       but don't process them now.        
 31169                                          
 31170 00002106 80FC49                          cmp     ah,CONFIG_INSTALL ; 'I'	; install= command?
 31171                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31172 00002109 7507                    	jne	short precheck_installhigh ; the first pass is for normal operation.
 31173                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31174                                  	;jne	short tryb	
 31175                                  	
 31176                                  	;or	word [install_flag],have_install_cmd ; set the flag
 31177 0000210B 800E[CE02]01            	or	byte [install_flag],have_install_cmd ; 1
 31178                                  multi_pass_coff2:
 31179 00002110 EBCD                    	jmp	short coff ; 13/05/2019	; and handles the next command
 31180                                  
 31181                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31182                                  ; (SYSINIT:2448h)
 31183                                  ; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31184                                  ;%if 0
 31185                                  precheck_installhigh:
 31186 00002112 80FC57                  	cmp     ah,CONFIG_INSTALLHIGH ; 'W' ; signifier for INSTALLHIGH
 31187 00002115 756B                    	jne     short tryb		; carry on with normal processing
 31188                                  	;or	word [install_flag],have_install_cmd
 31189 00002117 800E[CE02]01            	or	byte [install_flag],have_install_cmd ; 1
 31190 0000211C EBC1                    	jmp	short coff
 31191                                  ;%endif ; 27/10/2022
 31192                                  
 31193                                  multi_try_i:
 31194 0000211E 80FC49                          cmp     ah,CONFIG_INSTALL ; 'I' ; install= command?
 31195                                  	; 31/12/2022 - Retro DOS v4.2
 31196 00002121 750A                    	jne	short multi_try_n	; no, check for installhigh
 31197                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31198                                  	;jne	short multi_pass_filter
 31199                                  
 31200                                  ; 31/12/2022
 31201                                  ;%if 1 
 31202                                  ; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31203                                  ;%if 0
 31204                                  ;ifdef	MULTI_CONFIG
 31205 00002123 E8A31F                  	call	query_user              ; query the user if config_cmd
 31206 00002126 7241                    	jc	short multi_pass_filter	; has the CONFIG_OPTION_QUERY bit set
 31207                                  ;endif
 31208                                  ;%endif ; 27/10/2022
 31209                                  
 31210 00002128 E8D2EF                  	call	do_install_exec 	;install it.
 31211 0000212B EBB2                    	jmp	short coff		;to handle next install= command.
 31212                                  
 31213                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31214                                  ; (SYSINIT:2463h)
 31215                                  ;%if 1
 31216                                  ; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31217                                  ;%if 0
 31218                                  
 31219                                  multi_try_n:
 31220 0000212D 80FC57                          cmp     ah,CONFIG_INSTALLHIGH   ; installhigh= command?
 31221 00002130 7537                            jne	short multi_pass_filter	; no. ignore this.
 31222                                  ;ifdef	MULTI_CONFIG
 31223 00002132 E8941F                          call    query_user              ; query the user if config_cmd
 31224 00002135 7232                            jc      short multi_pass_filter	; has the CONFIG_OPTION_QUERY bit set
 31225                                  ;endif
 31226                                  
 31227                                  ;       The memory environment is in its normal DOS state, so do
 31228                                  ;       the standard calls to set the alloc strategy for loading high
 31229                                  
 31230 00002137 B80058                  	mov	ax,(ALLOCOPER<<8)|0 ; 5800h
 31231 0000213A CD21                    	int	21h			;get alloc strategy
 31232 0000213C 89C3                    	mov	bx,ax
 31233 0000213E 53                              push    bx                      ; save for the return
 31234                                  
 31235 0000213F 81CB8000                        or	bx,HIGH_FIRST  ; 80h	;set alloc to HighFirst
 31236 00002143 B80158                  	mov	ax,(ALLOCOPER<<8)|1 ; 5801h
 31237 00002146 CD21                    	int	21h			;set alloc strategy
 31238                                  
 31239 00002148 B80258                  	mov     ax,(ALLOCOPER<<8)|2 ; 5802h
 31240 0000214B CD21                            int     21h                     ; get link state
 31241 0000214D 30E4                            xor     ah,ah                   ; clear top byte
 31242 0000214F 50                              push    ax                      ; save for return
 31243                                  
 31244 00002150 B80358                          mov	ax,(ALLOCOPER<<8)|3 ; 5803h
 31245 00002153 BB0100                  	mov	bx,1
 31246 00002156 CD21                    	int	21h			;link in UMBs
 31247                                  
 31248 00002158 E8A2EF                  	call	do_install_exec 	;install it.
 31249                                  
 31250 0000215B B80358                          mov     ax,(ALLOCOPER<<8)|3
 31251 0000215E 5B                              pop     bx                      ; recover original link state
 31252 0000215F CD21                            int     21h
 31253 00002161 5B                              pop     bx                      ; recover original alloc strategy
 31254 00002162 B80158                          mov     ax,(ALLOCOPER<<8)|1
 31255 00002165 CD21                            int     21h
 31256                                  
 31257                                  	;jmp	short coff		;to handle next install= command.
 31258                                  	; 01/01/2023
 31259 00002167 EBA7                    	jmp	short multi_pass_coff2
 31260                                  
 31261                                  ;%endif ; 27/10/2022
 31262                                  
 31263                                  multi_pass_filter:
 31264 00002169 80FC59                          cmp     ah,CONFIG_COMMENT ; 'Y' ; comment?
 31265 0000216C 740A                    	je	short multi_pass_adjust
 31266 0000216E 80FC5A                          cmp     ah,CONFIG_UNKNOWN ; 'Z' ; bad command?
 31267 00002171 7405                    	je	short multi_pass_adjust
 31268 00002173 80FC30                          cmp     ah,CONFIG_REM     ; '0' ; rem?
 31269 00002176 7508                    	jne	short multi_pass_coff 	; ignore the rest of the commands.
 31270                                  
 31271                                  multi_pass_adjust:			; these commands need to
 31272 00002178 FF0E[5A03]              	dec	word [chrptr]		;  adjust chrptr,count
 31273 0000217C FF06[5603]              	inc	word [count]		;  for newline proc.
 31274                                  
 31275                                  multi_pass_coff:
 31276                                  	; 11/12/2022
 31277                                  	;jmp	short coff		; to handle next install= commands.
 31278                                  	; 01/01/2023
 31279 00002180 EB8E                    	jmp	short multi_pass_coff2
 31280                                  
 31281                                  ;------------------------------------------------------------------------------
 31282                                  ; buffer command
 31283                                  ;------------------------------------------------------------------------------
 31284                                  
 31285                                  ;******************************************************************************
 31286                                  ;									      *
 31287                                  ; function: parse the parameters of buffers= command.			      *
 31288                                  ;									      *
 31289                                  ; input :								      *
 31290                                  ;	es:si -> parameters in command line.				      *
 31291                                  ; output:								      *
 31292                                  ;	buffers set							      *
 31293                                  ;	buffer_slash_x	flag set if /x option chosen.			      *
 31294                                  ;	h_buffers set if secondary buffer cache specified.		      *
 31295                                  ;									      *
 31296                                  ; subroutines to be called:						      *
 31297                                  ;	sysinit_parse							      *
 31298                                  ; logic:								      *
 31299                                  ; {									      *
 31300                                  ;	set di points to buf_parms;  /*parse control definition*/	      *
 31301                                  ;	set dx,cx to 0; 						      *
 31302                                  ;	reset buffer_slash_x;						      *
 31303                                  ;	while (end of command line)					      *
 31304                                  ;	{ sysinit_parse;						      *
 31305                                  ;	  if (no error) then						      *
 31306                                  ;	       if (result_val._$P_synonym_ptr == slash_e) then /*not a switch *
 31307                                  ;		    buffer_slash_x = 1					      *
 31308                                  ;	       else if	 (cx == 1) then 	    /* first positional */    *
 31309                                  ;			  buffers = result_val._$P_picked_val;		      *
 31310                                  ;		    else  h_buffers = result_val._$P_picked_val; 	      *
 31311                                  ;	  else	{show error message;error exit} 			      *
 31312                                  ;	};								      *
 31313                                  ;	if (buffer_slash_x is off & buffers > 99) then show_error;	      *
 31314                                  ; };									      *
 31315                                  ;									      *
 31316                                  ;******************************************************************************
 31317                                  
 31318                                  	; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 31319                                  	; (SYSINIT:229Ch)
 31320                                  tryb:
 31321 00002182 80FC42                          cmp     ah,CONFIG_BUFFERS ; 'B'
 31322 00002185 755C                    	jne	short tryc
 31323                                  
 31324                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31325                                  ; (SYSINIT:24BFh)
 31326                                  ; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31327                                  ;%if 0
 31328                                  ;ifdef	MULTI_CONFIG
 31329 00002187 E83F1F                  	call	query_user		; query the user if config_cmd
 31330 0000218A 7257                    	jc	short tryc		; has the CONFIG_OPTION_QUERY bit set
 31331                                  ;endif
 31332                                  ;%endif ; 27/10/2022
 31333                                  
 31334                                  	; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31335                                  	; 18/12/2022
 31336 0000218C 31C9                    	xor	cx,cx
 31337                                  	;mov	byte [p_buffer_slash_x],0 ; 31/03/2019
 31338 0000218E 880E[9D1D]              	mov	[p_buffer_slash_x],cl ; 0
 31339                                  
 31340 00002192 BF[561D]                	mov	di,buf_parms
 31341                                  	;xor	cx,cx	; 18/12/2022
 31342                                  	; 03/01/2023
 31343                                  	;mov	dx,cx
 31344                                  do7:
 31345 00002195 E87C07                  	call	sysinit_parse
 31346 00002198 7303                    	jnc	short if7		; parse error,
 31347                                  	;call	badparm_p		;  and show messages and end the search loop.
 31348                                  	;;jmp	short sr7
 31349                                  	; 31/12/2022
 31350                                  ;sr7:
 31351                                  	;jmp	coff
 31352                                  	; 03/01/2023
 31353 0000219A E9A606                  	jmp	badparm_p_coff
 31354                                  if7:
 31355 0000219D 83F8FF                  	cmp	ax,_$P_RC_EOL ; 0FFFFh	; end of line?
 31356 000021A0 741A                    	je	short en7		;  then jmp to $endloop for semantic check
 31357                                  	;cmp	word [result_val_swoff],switch_x ; (/X switch)
 31358 000021A2 813E[A11D][961D]        	cmp	word [result_val+_$P_Result_Blk.SYNONYM_Ptr],switch_x
 31359                                  	;jne	short if11
 31360                                  	; 31/12/2022
 31361 000021A8 74EB                    	je	short do7 ;je short en11
 31362                                  
 31363                                  ;	mov	byte [p_buffer_slash_x],1 ; set the flag M016
 31364                                  	;jmp	short en11 ; 31/12/2022
 31365                                  if11:
 31366                                  	;mov	ax,[rv_dword]
 31367 000021AA A1[A31D]                	mov	ax,[result_val+_$P_Result_Blk.Picked_Val]
 31368 000021AD 83F901                  	cmp	cx,1
 31369 000021B0 7505                    	jne	short if13
 31370                                  
 31371 000021B2 A3[991D]                	mov	[p_buffers],ax
 31372                                  	;jmp	short en11
 31373                                  	; 31/12/2022
 31374 000021B5 EBDE                    	jmp	short do7
 31375                                  if13:
 31376 000021B7 A3[9B1D]                	mov	[p_h_buffers],ax
 31377                                  en11:
 31378 000021BA EBD9                    	jmp	short do7
 31379                                  en7:
 31380 000021BC 833E[991D]63            	cmp	word [p_buffers],99
 31381 000021C1 760B                    	jbe	short if18
 31382                                  
 31383                                  ;	cmp	byte [p_buffer_slash_x],0 ; M016
 31384                                  ;	jne	short if18
 31385                                  
 31386 000021C3 E87907                  	call	badparm_p
 31387 000021C6 C706[9B1D]0000          	mov	word [p_h_buffers],0
 31388 000021CC EB12                    	jmp	short sr7
 31389                                  if18:
 31390 000021CE A1[991D]                	mov	ax,[p_buffers]	; we don't have any problem.
 31391 000021D1 A3[9902]                	mov	[buffers],ax	; now,let's set it really.
 31392                                  
 31393 000021D4 A1[9B1D]                	mov	ax,[p_h_buffers]
 31394 000021D7 A3[9B02]                	mov	[h_buffers],ax
 31395                                  
 31396                                  ;	mov	al,[p_buffer_slash_x]	; M016
 31397                                  ;	mov	[buffer_slash_x],al
 31398                                  
 31399 000021DA A1[AF02]                	mov	ax,[linecount]
 31400 000021DD A3[B902]                	mov	[buffer_linenum],ax ; save the line number for the future use.
 31401                                  	; 31/12/2022
 31402                                  	;jmp	short sr7
 31403                                  	; 03/01/2023
 31404                                  sr7:
 31405 000021E0 E9FCFE                  	jmp	coff
 31406                                  
 31407                                  ;------------------------------------------------------------------------------
 31408                                  ; break command
 31409                                  ;------------------------------------------------------------------------------
 31410                                  
 31411                                  ;****************************************************************************
 31412                                  ;									    *
 31413                                  ; function: parse the parameters of break = command.			    *
 31414                                  ;									    *
 31415                                  ; input :								    *
 31416                                  ;	es:si -> parameters in command line.				    *
 31417                                  ; output:								    *
 31418                                  ;	turn the control-c check on or off.				    *
 31419                                  ;									    *
 31420                                  ; subroutines to be called:						    *
 31421                                  ;	sysinit_parse							    *
 31422                                  ; logic:								    *
 31423                                  ; {									    *
 31424                                  ;	set di to brk_parms;						    *
 31425                                  ;	set dx,cx to 0; 						    *
 31426                                  ;	while (end of command line)					    *
 31427                                  ;	{ sysinit_parse;						    *
 31428                                  ;	  if (no error) then						    *
 31429                                  ;	       if (result_val._$P_item_tag == 1) then	  /*on		 */ *
 31430                                  ;		   set p_ctrl_break,on;					    *
 31431                                  ;	       else					  /*off 	 */ *
 31432                                  ;		   set p_ctrl_break,off;				    *
 31433                                  ;	  else {show message;error_exit};				    *
 31434                                  ;	};								    *
 31435                                  ;	if (no error) then						    *
 31436                                  ;	   dos function call to set ctrl_break check according to	    *
 31437                                  ; };									    *
 31438                                  ;									    *
 31439                                  ;****************************************************************************
 31440                                  
 31441                                  	; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 31442                                  	; (SYSINIT:22FFh)
 31443                                  tryc:
 31444 000021E3 80FC43                          cmp     ah,CONFIG_BREAK ; 'C'
 31445 000021E6 7539                    	jne	short trym
 31446                                  
 31447                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31448                                  ; (SYSINIT:2527h)
 31449                                  ; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31450                                  ;%if 0
 31451                                  ;ifdef	MULTI_CONFIG
 31452 000021E8 E8DE1E                  	call	query_user              ; query the user if config_cmd
 31453 000021EB 7234                    	jc	short trym		; has the CONFIG_OPTION_QUERY bit set
 31454                                  ;endif
 31455                                  ;%endif ; 27/10/2022
 31456                                  
 31457 000021ED BF[A71D]                	mov	di,brk_parms
 31458 000021F0 31C9                    	xor	cx,cx
 31459                                  	; 03/01/2023
 31460                                  	;mov	dx,cx
 31461                                  do22:
 31462 000021F2 E81F07                  	call	sysinit_parse
 31463 000021F5 7303                    	jnc	short if22		; parse error
 31464                                  	;call	badparm_p		;  show message and end the search loop.
 31465                                  	;;jmp	short sr22
 31466                                  	; 31/12/2022
 31467                                  ;sr22:
 31468                                  	;jmp	coff
 31469                                  	; 03/01/2023
 31470 000021F7 E94906                  	jmp	badparm_p_coff
 31471                                  if22:
 31472 000021FA 83F8FF                  	cmp	ax,_$P_RC_EOL		; end of line?
 31473 000021FD 7415                    	je	short en22		; then end the $endloop
 31474                                  
 31475                                  	;cmp	byte [result_val_itag],1
 31476 000021FF 803E[A01D]01            	cmp	byte [result_val+_$P_Result_Blk.Item_Tag],1
 31477 00002204 7507                    	jne	short if26
 31478                                  
 31479 00002206 C606[CC1D]01            	mov	byte [p_ctrl_break],1	; turn it on
 31480                                  	;jmp	short en26
 31481                                  	; 31/12/2022
 31482 0000220B EBE5                    	jmp	short do22
 31483                                  if26:
 31484 0000220D C606[CC1D]00            	mov	byte [p_ctrl_break],0	; turn it off
 31485                                  en26:
 31486 00002212 EBDE                    	jmp	short do22		; we actually set the ctrl break
 31487                                  en22:
 31488 00002214 B433                    	mov	ah,SET_CTRL_C_TRAPPING ; if we don't have any parse error.
 31489 00002216 B001                    	mov	al,1
 31490 00002218 8A16[CC1D]              	mov	dl,[p_ctrl_break]
 31491 0000221C CD21                    	int	21h
 31492                                  	; 31/12/2022
 31493                                  	;jmp	short sr22
 31494                                  	; 03/01/2023
 31495                                  sr22:
 31496 0000221E E9BEFE                  	jmp	coff
 31497                                  
 31498                                  ;------------------------------------------------------------------------------
 31499                                  ; multitrack command
 31500                                  ;------------------------------------------------------------------------------
 31501                                  
 31502                                  ;******************************************************************************
 31503                                  ;									      *
 31504                                  ; function: parse the parameters of multitrack= command.		      *
 31505                                  ;									      *
 31506                                  ; input :								      *
 31507                                  ;	es:si -> parameters in command line.				      *
 31508                                  ; output:								      *
 31509                                  ;	turn multrk_flag on or off.					      *
 31510                                  ;									      *
 31511                                  ; subroutines to be called:						      *
 31512                                  ;	sysinit_parse							      *
 31513                                  ; logic:								      *
 31514                                  ; {									      *
 31515                                  ;	set di to brk_parms;						      *
 31516                                  ;	set dx,cx to 0; 						      *
 31517                                  ;	while (end of command line)					      *
 31518                                  ;	{ sysinit_parse;						      *
 31519                                  ;	  if (no error) then						      *
 31520                                  ;	       if (result_val._$P_item_tag == 1) then	  /*on		 */   *
 31521                                  ;		   set p_mtrk,on;					      *
 31522                                  ;	       else					  /*off 	 */   *
 31523                                  ;		   set p_mtrk,off;					      *
 31524                                  ;	  else {show message;error_exit};				      *
 31525                                  ;	};								      *
 31526                                  ;	if (no error) then						      *
 31527                                  ;	   dos function call to set multrk_flag according to p_mtrk.	      *
 31528                                  ;									      *
 31529                                  ; };									      *
 31530                                  ;									      *
 31531                                  ;******************************************************************************
 31532                                  
 31533                                  	; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 31534                                  trym:
 31535 00002221 80FC4D                          cmp     ah,CONFIG_MULTITRACK  ; 'M'
 31536 00002224 7573                    	jne	short tryu
 31537                                  
 31538                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31539                                  ; (SYSINIT:2569h)
 31540                                  ; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31541                                  ;%if 0
 31542                                  ;ifdef	MULTI_CONFIG
 31543 00002226 E8A01E                  	call	query_user      ; query the user if config_cmd
 31544 00002229 726E                    	jc	short tryu	; has the CONFIG_OPTION_QUERY bit set
 31545                                  ;endif
 31546                                  ;%endif	; 27/10/2022
 31547                                  
 31548 0000222B BF[AB1E]                	mov	di,mtrk_parms
 31549 0000222E 31C9                    	xor	cx,cx
 31550                                  	; 03/01/2023
 31551                                  	;mov	dx,cx
 31552                                  do31:
 31553 00002230 E8E106                  	call	sysinit_parse
 31554 00002233 7303                    	jnc	short if31	; parse error
 31555                                  	;call	badparm_p	;  show message and end the search loop.
 31556                                  	;;jmp	short sr31
 31557                                  	; 31/12/2022
 31558                                  ;sr31:
 31559                                  	;jmp	coff
 31560                                  	; 03/01/2023
 31561 00002235 E90B06                  	jmp	badparm_p_coff
 31562                                  if31:
 31563 00002238 83F8FF                  	cmp	ax,_$P_RC_EOL	; end of line?
 31564 0000223B 7415                    	je	short en31	; then end the $endloop
 31565                                  
 31566                                  	;cmp	byte [result_val_itag],1
 31567 0000223D 803E[A01D]01            	cmp	byte [result_val+_$P_Result_Blk.Item_Tag],1
 31568 00002242 7507                    	jne	short if35
 31569                                  
 31570 00002244 C606[BF1E]01            	mov	byte [p_mtrk],1	; turn it on temporarily.
 31571                                  	;jmp	short en35
 31572                                  	; 31/12/2022
 31573 00002249 EBE5                    	jmp	short do31
 31574                                  if35:
 31575 0000224B C606[BF1E]00            	mov	byte [p_mtrk],0	; turn it off temporarily.
 31576                                  en35:
 31577 00002250 EBDE                    	jmp	short do31	; we actually set the multrk_flag here
 31578                                  en31:
 31579 00002252 1E                      	push	ds
 31580                                  	;;mov	ax,Bios_Data ; 70h
 31581                                  	;mov	ax,KERNEL_SEGMENT ; 70h
 31582                                  	; 21/10/2022
 31583 00002253 B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 31584 00002256 8ED8                    	mov	ds,ax
 31585                                  
 31586 00002258 2E803E[BF1E]00          	cmp	byte [cs:p_mtrk],0
 31587 0000225E 7508                    	jne	short if39
 31588                                  
 31589 00002260 C706[A004]0100          	mov	word [multrk_flag],multrk_off2	; 0001h
 31590 00002266 EB06                    	jmp	short en39
 31591                                  if39:
 31592 00002268 C706[A004]8000          	mov	word [multrk_flag],multrk_on	; 0080h
 31593                                  en39:
 31594 0000226E 1F                      	pop	ds
 31595                                  	; 31/12/2022
 31596                                  	;jmp	short sr31
 31597                                  	; 03/01/2023
 31598                                  sr31:
 31599 0000226F E96DFE                  	jmp	coff
 31600                                  
 31601                                  ;----------------------------------------------------------------------------
 31602                                  ; DOS=HIGH/LOW command
 31603                                  ;----------------------------------------------------------------------------
 31604                                  
 31605                                  	; 27/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 31606                                  multi_try_doshi:
 31607 00002272 80FC48                          cmp     ah,CONFIG_DOS ; 'H'
 31608 00002275 7403                    	je	short it_is_h
 31609                                  skip_it:
 31610 00002277 E9EFFE                  	jmp	multi_pass_filter
 31611                                  it_is_h:				; M003 - removed initing DevUMB
 31612                                  					;	 & runhigh
 31613                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31614                                  ; (SYSINIT:25C1h)
 31615                                  ; 27/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31616                                  ;%if 0
 31617                                  ;ifdef	MULTI_CONFIG
 31618 0000227A E84C1E                  	call	query_user              ; query the user if config_cmd
 31619 0000227D 72F8                    	jc	short skip_it		; has the CONFIG_OPTION_QUERY bit set
 31620                                  ;endif
 31621                                  ;%endif ; 27/10/2022
 31622                                  
 31623 0000227F BF[121F]                	mov	di,dos_parms
 31624 00002282 31C9                    	xor	cx,cx
 31625                                  	; 03/01/2023
 31626                                  	;mov	dx,cx
 31627                                  h_do_parse:
 31628 00002284 E88D06                  	call	sysinit_parse
 31629 00002287 7303                    	jnc	short h_parse_ok	
 31630                                  h_badparm:				; parse error
 31631                                  	; 03/01/2023
 31632                                  	;call	badparm_p		; show message and end the search loop.
 31633                                  	;;jmp	short h_end
 31634                                  	; 11/12/2022
 31635                                  ;h_end:
 31636                                  	;jmp	coff
 31637                                  	; 03/01/2023
 31638 00002289 E9B705                  	jmp	badparm_p_coff	
 31639                                  h_parse_ok:
 31640 0000228C 83F8FF                  	cmp	ax,_$P_RC_EOL		; end of line?
 31641 0000228F 7405                    	je	short h_end		; then end the $endloop
 31642 00002291 E80207                  	call	ProcDOS
 31643 00002294 EBEE                    	jmp	short h_do_parse
 31644                                  	; 11/12/2022
 31645                                  	; 03/01/2023
 31646                                  h_end:
 31647 00002296 E946FE                  	jmp	coff
 31648                                  
 31649                                  ;-----------------------------------------------------------------------------
 31650                                  ; devicehigh command
 31651                                  ;-----------------------------------------------------------------------------
 31652                                  
 31653                                  	; 28/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 31654                                  tryu:
 31655 00002299 80FC55                          cmp     ah,CONFIG_DEVICEHIGH ; 'U'
 31656 0000229C 7552                    	jne	short tryd
 31657                                  
 31658                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31659                                  ; (SYSINIT:25E9h)
 31660                                  ; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31661                                  ;%if 0
 31662                                  ;ifdef	MULTI_CONFIG
 31663 0000229E E8281E                  	call	query_user              ; query the user if config_cmd
 31664 000022A1 724D                    	jc	short tryd		; has the CONFIG_OPTION_QUERY bit set
 31665                                  ;endif
 31666                                  ;%endif ; 28/10/2022
 31667                                  
 31668                                  ; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31669                                  ;%if 0
 31670                                  	; 01/01/2023
 31671                                  	; ds = cs
 31672                                  
 31673 000022A3 E88707                  	call	InitVar
 31674 000022A6 E85B0F                  	call	ParseSize		; process the size= option
 31675                                  	;jnc	short tryu_0
 31676                                  	; 31/12/2022
 31677 000022A9 720C                    	jc	short tryu_1 ; 31/03/2019 - Retro DOS v4.0
 31678                                  
 31679                                  ;%endif ; 28/10/2022
 31680                                  
 31681                                  ; 31/12/2022
 31682                                  %if 0
 31683                                  	; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31684                                  	;mov	[cs:badparm_off], si	; stash it there in case of an error
 31685                                  	;mov	[cs:badparm_seg], es
 31686                                  	; 11/12/2022
 31687                                  	; ds = cs
 31688                                  	mov	[badparm_off], si
 31689                                  	mov	[badparm_seg], es
 31690                                  
 31691                                  	; 31/12/2022
 31692                                  	;call	ParseSize
 31693                                  	;jnc	short tryu_2	; 28/10/2022
 31694                                  	
 31695                                  	;call	badparm_p
 31696                                  	;jmp	coff
 31697                                  	; 03/01/2023
 31698                                  	jmp	badparm_p_coff
 31699                                  %endif
 31700                                  
 31701                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31702                                  ; (SYSINIT:2606h)
 31703                                  ; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31704                                  ;%if 0
 31705                                  tryu_0:
 31706                                  	;mov	ax,[cs:DevSizeOption]
 31707                                  	; 31/12/2022
 31708 000022AB A1[AC1F]                	mov	ax,[DevSizeOption] ; ds = cs
 31709 000022AE 09C0                    	or	ax,ax
 31710 000022B0 7510                    	jnz	short tryu_2
 31711                                  
 31712 000022B2 E80A08                  	call	ParseVar
 31713 000022B5 730B                    	jnc	short tryu_2
 31714                                  tryu_1:
 31715                                  	; 31/12/2022
 31716                                  	; ds = cs
 31717 000022B7 8936[EF14]              	mov	[badparm_off], si
 31718 000022BB 8C06[F114]              	mov	[badparm_seg], es
 31719                                  	;mov	[cs:badparm_off], si	; If ParseVar up there failed, then
 31720                                  	;mov	[cs:badparm_seg], es	; ES:SI points to its problem area...
 31721                                  	
 31722                                  	;call	badparm_p		; so all we have to do is choke and
 31723                                  	;jmp	coff			; die, rather verbosely.
 31724                                  	; 03/01/2023
 31725 000022BF E98105                  	jmp	badparm_p_coff
 31726                                  
 31727                                  ;%endif ; 28/10/2022
 31728                                  
 31729                                  tryu_2:	
 31730 000022C2 56                      	push	si
 31731 000022C3 06                      	push	es
 31732                                  
 31733                                  	; 08/09/2023 - Retro DOS 4.2 IO.SYS (Optimization)
 31734                                  	; MSDOS 6.21 IO.SYS - SYSINIT:2623h
 31735                                  	; PCDOS 7.1 IBMBIO.COM - SYSINIT:2B17h
 31736                                  tryu_3:
 31737 000022C4 268A04                  	mov	al,[es:si]
 31738 000022C7 3C0D                    	cmp	al,cr
 31739 000022C9 740C                    	je	short tryu_4
 31740                                  	; 08/09/2023 - Retro DOS 5.0 (PCDOS 7.1 IBMBIO.COM)
 31741                                  	;je	short tryu_5
 31742 000022CB 3C0A                    	cmp	al,lf
 31743 000022CD 7408                    	je	short tryu_4
 31744 000022CF E8651F                  	call	delim
 31745 000022D2 7403                    	jz	short tryu_4
 31746 000022D4 46                      	inc	si
 31747 000022D5 EBED                    	jmp	short tryu_3
 31748                                  
 31749                                  	; 08/09/2023 - Retro DOS 5.0 (PCDOS 7.1 IBMBIO.COM)
 31750                                  ;tryu_5:
 31751                                  ;	mov     al, 20h ; ' '   ; blank instead of cr
 31752                                  
 31753                                  tryu_4:	
 31754                                  	; 11/12/2022
 31755                                  	; ds = cs
 31756 000022D7 A2[C01F]                	mov	[DevSavedDelim],al
 31757                                  	;mov	[cs:DevSavedDelim],al	; Save the delimiter before replacing
 31758                                  					;  it with null
 31759                                  	; 18/12/2022
 31760 000022DA 29DB                    	sub	bx,bx
 31761 000022DC 26881C                  	mov	[es:si],bl ; 0
 31762                                   	;mov	byte [es:si],0
 31763                                  
 31764 000022DF 07                      	pop	es
 31765 000022E0 5E                      	pop	si
 31766                                  
 31767                                  ;------------------------------------------------------------------------------
 31768                                  ; BEGIN PATCH TO CHECK FOR NON-EXISTANT UMBs   -- t-richj 7-21-92
 31769                                  ;------------------------------------------------------------------------------
 31770                                  
 31771                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31772                                  ; (SYSINIT:2642h)
 31773                                  ; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31774                                  ;%if 0
 31775                                  ; 10/07/2023 - Retro DOS v4.2 IO.SYS (optimized)
 31776                                  ; MSDOS 6.21 IO.SYS - SYSINIT:2642h
 31777                                  %if 1
 31778                                  	; 01/01/2023
 31779                                  	; ds = cs
 31780 000022E1 E8480C                  	call	UmbTest			; See if UMBs are around...
 31781                                  	; 01/01/2023
 31782                                  	;jnc	short NrmTst		; ...yep. So do that normal thang.
 31783                                  	
 31784                                  	;mov	byte [cs:DeviceHi],0	; ...nope... so load low.
 31785                                  	; 31/12/2022
 31786                                  	; ds = cs, bx = 0
 31787                                  	;mov	byte [DeviceHi],bl ; 0
 31788                                  	;jmp	short LoadDevice
 31789                                  	; 01/01/2023
 31790 000022E4 7222                    	jc	short LoadDevice ; bl = 0
 31791                                  %endif
 31792                                  ;%endif
 31793                                  
 31794                                  ;------------------------------------------------------------------------------
 31795                                  ; END PATCH TO CHECK FOR NON-EXISTANT UMBs   -- t-richj 7-21-92
 31796                                  ;------------------------------------------------------------------------------
 31797                                  
 31798                                  NrmTst:
 31799                                  	; 11/12/2022
 31800                                  	; ds = cs
 31801                                  	;;mov	byte [cs:DeviceHi],0
 31802                                  	;mov	byte [DeviceHi],0
 31803                                  	; 18/12/2022
 31804                                  	; bx = 0
 31805 000022E6 381E[9C1F]              	cmp	[DevUMB],bl ; 0
 31806                                  	;cmp	byte [DevUMB],0
 31807                                  	;;cmp	byte [cs:DevUMB],0	; do we support UMBs
 31808 000022EA 741C                    	je	short LoadDevice	; no, we don't
 31809                                  	;mov	byte [cs:DeviceHi],1
 31810                                  	; 11/12/2022
 31811                                  	;mov	byte [DeviceHi],1
 31812                                  	; 18/12/2022
 31813 000022EC FEC3                    	inc	bl ; mov bl,1 ; (*)
 31814                                  	; 11/12/2022
 31815                                  	;jmp	short LoadDevice2	; 11/12/2022
 31816 000022EE EB18                    	jmp	short LoadDevice
 31817                                  
 31818                                  ;------------------------------------------------------------------------------
 31819                                  ; device command
 31820                                  ;------------------------------------------------------------------------------
 31821                                  
 31822                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31823                                  	; (SYSINIT:2665h)
 31824                                  
 31825                                  	; 28/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 31826                                  	; (SYSINIT:2401h)
 31827                                  tryd:
 31828                                  	; 11/12/2022
 31829                                  	;xor 	bx,bx ; 31/12/2022
 31830                                  	;
 31831 000022F0 80FC44                          cmp     ah,CONFIG_DEVICE ; 'D'
 31832 000022F3 7403                    	je	short gotd
 31833                                  skip_it2:
 31834 000022F5 E99302                  	jmp	tryq
 31835                                  gotd:
 31836                                  
 31837                                  ; 31/12/2022 - Retro DOS v4.2
 31838                                  ; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31839                                  ;%if 0
 31840                                  ;ifdef	MULTI_CONFIG
 31841 000022F8 E8CE1D                  	call	query_user              ; query the user if config_cmd
 31842 000022FB 72F8                    	jc	short skip_it2		; has the CONFIG_OPTION_QUERY bit set
 31843                                  ;endif
 31844                                  ;%endif ; 28/10/2022
 31845                                  
 31846                                  	; 31/12/2022
 31847 000022FD 29DB                    	sub	bx,bx
 31848                                  	; bx = 0
 31849                                  	; 11/12/2022
 31850                                  	; ds = cs
 31851                                  	;mov	byte [DeviceHi],0
 31852                                  	;mov	word [DevSizeOption],0
 31853 000022FF 891E[AC1F]              	mov	[DevSizeOption],bx ; 0
 31854 00002303 C606[C01F]20            	mov	byte [DevSavedDelim],' '
 31855                                  	;mov	byte [cs:DeviceHi],0	; not to be loaded in UMB ;M007
 31856                                  	;mov	word [cs:DevSizeOption],0
 31857                                  	;mov	byte [cs:DevSavedDelim],' ' ; In case of DEVICE= the null has to
 31858                                  					;  be replaced with a ' '
 31859                                  LoadDevice:                             ; device= or devicehigh= command.
 31860                                  	; 11/12/2022
 31861                                  	;mov	byte [DeviceHi],0
 31862 00002308 881E[AB1F]              	mov	byte [DeviceHi],bl	; 0 or 1 (*)
 31863                                  LoadDevice2:
 31864                                  	; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)        
 31865                                  	;
 31866                                  	;push    cs
 31867                                          ;pop     ds
 31868                                  	;
 31869                                  	;mov	[bpb_addr],si		; pass the command line to the device
 31870                                  	;mov	[bpb_addr+2],es
 31871                                  	;
 31872                                  	;mov	[DevCmdLine],si		; save it for ourself
 31873                                  	;mov	[DevCmdLine+2],es
 31874                                  	;
 31875                                  	;mov	byte [driver_units],0	; clear total block units for driver	
 31876                                  
 31877                                  	; 11/12/2022
 31878                                  	; ds = cs
 31879                                  	;mov	bx,cs
 31880                                  	;mov	ds,bx
 31881                                  
 31882                                  	;mov	[cs:bpb_addr],si	; pass the command line to the device
 31883 0000230C 8936[8103]              	mov	[bpb_addr],si
 31884                                  	;mov	[cs:bpb_addr+2],es
 31885 00002310 8C06[8303]              	mov	[bpb_addr+2],es
 31886                                  
 31887                                  	;mov	[cs:DevCmdLine],si	; save it for ourself
 31888 00002314 8936[BC1F]              	mov	[DevCmdLine],si
 31889                                  	;mov	[cs:DevCmdLine+2],es	
 31890 00002318 8C06[BE1F]              	mov	[DevCmdLine+2],es
 31891                                  
 31892                                  	; 31/12/2022 - Retro DOS v4.2
 31893 0000231C C606[EE14]00            	mov	byte [driver_units],0	; clear total block units for driver	
 31894                                  
 31895 00002321 E87B1F                  	call	round
 31896                                  	
 31897 00002324 E8E90D                  	call	SizeDevice
 31898 00002327 723F                    	jc	short BadFile
 31899                                  
 31900                                  	; 11/12/2022
 31901                                  	; ds = cs
 31902                                  
 31903                                  ; - Begin DeviceHigh primary logic changes ------------------------------------
 31904                                  
 31905                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31906                                  ; (SYSINIT:26A4h)
 31907                                  
 31908                                  ; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31909                                  ;%if 0
 31910 00002329 C606[9B1F]01            	mov	byte [ConvLoad],1	; Doesn't matter if DeviceHi==0
 31911                                  
 31912                                  	; 22/07/2023
 31913                                  	;mov	al,[DeviceHi]		; If not using upper memory,
 31914 0000232E 800E[AB1F]00            	or	byte [DeviceHi],0	; Skip all this and go on to
 31915                                  	; 10/07/2023
 31916                                  	;or	al,al
 31917 00002333 741E                    	jz	short DevConvLoad	; the actual load.
 31918                                  
 31919                                  	;call	GetLoadUMB		; Returns first UMB spec'ed in AX
 31920 00002335 A0[591F]                	mov	al,[UmbLoad]	; 19/04/2019 - Retro DOS v4.0
 31921                                  
 31922 00002338 3CFF                    	cmp	al,-1			; If umb0 not specified, it's old style
 31923 0000233A 7417                    	jz	short DevConvLoad	; so load high even if SIZE= is smaller
 31924                                  
 31925 0000233C FE0E[9B1F]              	dec	byte [ConvLoad] ; 0 	; They specified /L, so use new loader
 31926                                  
 31927 00002340 E8B109                  	call	GetLoadSize		; Returns size of first UMB specified
 31928 00002343 09C0                    	or	ax,ax
 31929 00002345 7406                    	jz	short tryd_1		; If size is not specified..
 31930                                  
 31931 00002347 3B06[8D1F]              	cmp	ax,[DevSize]		; /L:...,Size < DevSize?
 31932 0000234B 7D06                    	jge	short DevConvLoad
 31933                                  tryd_1:
 31934 0000234D A1[8D1F]                	mov	ax,[DevSize]		; Size < DevSize, so write DevSize as
 31935 00002350 E8AD09                  	call	StoLoadSize		; minsize for load UMB.
 31936                                  
 31937                                  ;%endif ; 28/10/2022
 31938                                  
 31939                                  ; - End DeviceHigh primary logic changes --------------------------------------
 31940                                  
 31941                                  DevConvLoad:
 31942                                  	; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31943 00002353 E8BE0C                  	call	InitDevLoad
 31944                                  
 31945                                  	; 11/12/2022
 31946                                  	; ds = cs
 31947 00002356 A1[8F1F]                	mov	ax,[DevLoadAddr]
 31948 00002359 0306[8D1F]              	add	ax,[DevSize]
 31949 0000235D 7206                    	jc	short NoMem
 31950 0000235F 3906[911F]              	cmp	[DevLoadEnd],ax
 31951 00002363 7315                    	jae	short LoadDev
 31952                                  	
 31953                                  	; 11/12/2022
 31954                                  	;mov	ax,[cs:DevLoadAddr]
 31955                                  	;add	ax,[cs:DevSize]
 31956                                  	;jc	short NoMem
 31957                                  	;cmp	[cs:DevLoadEnd],ax
 31958                                  	;jae	short LoadDev
 31959                                  NoMem:
 31960                                  	; 11/12/2022
 31961                                  	; ds = cs
 31962                                  	;jmp	mem_err
 31963 00002365 E9761F                  	jmp	mem_err2
 31964                                  
 31965                                  BadFile:
 31966                                  	; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 31967                                  	;;call	RetFromUM		; Does nothing if didn't call HideUMBs
 31968                                  	;;cmp	byte [es:si],' '
 31969                                          ;;jae	short tryd_2
 31970                                  	; 31/12/2022	
 31971                                  	;cmp	byte [es:si],0Dh	; cr
 31972                                          ;jne	short tryd_2
 31973                                  	;jmp	badop
 31974                                  	; 31/12/2022
 31975                                  	; ds = cs
 31976                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 31977                                  	; (SYSINIT:26E6h)
 31978 00002368 E8060E                  	call	RetFromUM		; Does nothing if didn't call HideUMBs
 31979 0000236B 26803C20                	cmp	byte [es:si],' ' 
 31980                                  	;cmp	byte [es:si],20h ; space
 31981 0000236F 7303                    	jnb	short tryd_2
 31982 00002371 E9BF05                  	jmp	badop
 31983                                  tryd_2:
 31984 00002374 E86221                  	call	badload
 31985 00002377 E965FD                  	jmp	coff
 31986                                  
 31987                                  LoadDev:
 31988 0000237A 06                      	push	es
 31989 0000237B 1F                      	pop	ds
 31990                                  
 31991 0000237C 89F2                    	mov	dx,si			;ds:dx points to file name
 31992 0000237E E8D40D                  	call	ExecDev			; load device driver using exec call
 31993                                  badldreset:
 31994 00002381 1E                      	push	ds
 31995 00002382 07                      	pop	es			;es:si back to config.sys
 31996 00002383 0E                      	push	cs
 31997 00002384 1F                      	pop	ds			;ds back to sysinit
 31998 00002385 72E1                    	jc	short BadFile
 31999                                  goodld:
 32000                                  	; 11/12/2022
 32001                                  	; ds = cs
 32002                                  
 32003 00002387 06                      	push	es ; +	; 31/12/2022
 32004 00002388 56                      	push	si ; ++
 32005 00002389 E8F60D                  	call	RemoveNull
 32006 0000238C 06                      	push	es
 32007 0000238D 56                      	push	si
 32008                                  
 32009 0000238E 0E                      	push	cs
 32010 0000238F 07                      	pop	es
 32011                                  
 32012 00002390 1E                      	push	ds ; **  ; ds = cs
 32013 00002391 56                      	push	si
 32014                                  
 32015                                  	;lds	si,[cs:DevEntry]	; peeks the header attribute
 32016                                  	; 31/12/2022
 32017                                  	; ds = cs
 32018 00002392 C536[931F]              	lds	si,[DevEntry]
 32019                                  
 32020                                  	;test	word [si+4],8000h
 32021                                  	; 11/12/2022
 32022 00002396 F6440580                	test	byte [si+SYSDEV.ATT+1],DEVTYP>>8
 32023                                  	;test	word [si+SYSDEV.ATT],DEVTYP ; block device driver?
 32024 0000239A 7514                    	jnz	short got_device_com_cont   ; no.
 32025                                  
 32026 0000239C 2EC536[6D02]            	lds	si,[cs:DOSINFO]		; ds:si -> sys_var
 32027                                  	;cmp	byte [si+32],26
 32028 000023A1 807C201A                	cmp	byte [si+SYSI_NUMIO],26	; no more than 26 drive number
 32029 000023A5 7209                    	jb	short got_device_com_cont
 32030                                  
 32031 000023A7 5E                      	pop	si
 32032 000023A8 1F                      	pop	ds ; **
 32033                                  
 32034 000023A9 5E                      	pop	si			; clear the stack
 32035 000023AA 07                      	pop	es
 32036                                  
 32037                                  	; 28/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32038                                  	;call	RetFromUM
 32039                                  	; 31/12/2022
 32040                                  	; ds = cs ; **
 32041 000023AB E8C30D                  	call	RetFromUM		; Do this before we leave
 32042                                  
 32043                                  	;jmp	short badnumblock
 32044                                  	; 31/12/2022
 32045 000023AE EB73                    	jmp	short badnumblock2  ; ds = cs
 32046                                  
 32047                                  got_device_com_cont:
 32048 000023B0 5E                      	pop	si
 32049 000023B1 1F                      	pop	ds
 32050                                  
 32051                                  	; 11/12/2022
 32052                                  	; ds = cs
 32053                                  
 32054 000023B2 E80406                  	call	LieInt12Mem
 32055 000023B5 E86306                  	call	UpdatePDB		; update the PSP:2 value M020
 32056                                  
 32057                                  	; 11/12/2022
 32058                                  	; ds = cs
 32059                                  	; 08/09/2023
 32060 000023B8 31C0                    	xor	ax, ax ; 0
 32061 000023BA 3806[EA14]              	cmp	byte [multdeviceflag],al ; 0
 32062                                  	;cmp	byte [multdeviceflag],0
 32063                                  	;cmp	byte [cs:multdeviceflag],0 ; Pass limit only for the 1st device
 32064                                  					;  driver in the file ; M027
 32065 000023BE 750B                    	jne	short skip_pass_limit	;		      ; M027
 32066                                  
 32067                                  	; 11/12/2022
 32068                                  	; ds = cs
 32069                                  	;mov	word [cs:break_addr],0	; pass the limit to the DD
 32070                                  	;mov	bx,[cs:DevLoadEnd]
 32071                                  	;mov	[cs:break_addr+2],bx
 32072                                  
 32073                                  	;mov	word [break_addr],0
 32074                                  	; 08/09/2023
 32075 000023C0 A3[7D03]                	mov	[break_addr],ax ; 0
 32076 000023C3 8B1E[911F]              	mov	bx,[DevLoadEnd]
 32077 000023C7 891E[7F03]              	mov	[break_addr+2],bx
 32078                                  
 32079                                  skip_pass_limit:
 32080                                  ;	Note: sysi_numio (in DOS DATA) currently reflects the REAL
 32081                                  ;	number of installed devices (including DblSpace drives) where
 32082                                  ;	"drivenumber" is the number that the next block device will
 32083                                  ;	be assigned to. Because some naughty device drivers (like
 32084                                  ;	interlnk) look at the internal DOS variable instead of the
 32085                                  ;	value we pass it, we'll temporarily stick our value into
 32086                                  ;	DOS DATA while we're initializing the device drivers.
 32087                                  ;
 32088                                  ;	Note that this will make it impossible for this device
 32089                                  ;	driver to access the DblSpace drive letters, whether
 32090                                  ;	they are swapped-hosts or unswapped compressed drives,
 32091                                  ;	during its initialization phase.
 32092                                  
 32093                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32094                                  ; (SYSINIT:2752h)
 32095                                  ; 29/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32096                                  ;%if 0
 32097                                  	; 31/12/2022
 32098                                  	;push	ds
 32099                                  	
 32100                                  	;lds	bx,[cs:DOSINFO]		; ds:bx -> sys_var
 32101                                  	; 31/12/2022
 32102                                  	; ds = cs
 32103                                  	; 08/09/2023
 32104                                  	;lds	bx,[DOSINFO]		; ds:bx -> sys_var
 32105                                  
 32106                                  	;mov	al,[cs:drivenumber]	; temporarily use this next drv value
 32107                                  	;mov	[cs:devdrivenum],al	; pass drive number in packet to driver
 32108                                  	;mov	ah,al
 32109                                  
 32110                                  	; 08/09/2023
 32111                                  	; ds = cs
 32112 000023CB A0[8503]                	mov	al,[drivenumber]	; temporarily use this next drv value		
 32113 000023CE A2[8503]                	mov	[devdrivenum],al	; pass drive number in packet to driver
 32114 000023D1 88C4                    	mov	ah,al
 32115 000023D3 C51E[6D02]              	lds	bx,[DOSINFO]		; ds:bx -> sys_var
 32116                                  
 32117 000023D7 874720                  	xchg	ax,[bx+SYSI_NUMIO]	; swap with existing values
 32118                                  	; 31/12/2022
 32119                                  	;pop	ds
 32120                                  	
 32121 000023DA 50                      	push	ax			; save real sysi_numio/ncds in ax
 32122                                  
 32123                                  ;%endif ; 29/10/2022
 32124                                  
 32125                                  	; 29/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 32126                                  	; (SYSINIT:24B9h)
 32127                                  
 32128 000023DB BB0600                  	mov	bx,SYSDEV.STRAT ; 6
 32129 000023DE E8061F                  	call	calldev 		; calldev (sdevstrat);
 32130 000023E1 BB0800                  	mov	bx,SYSDEV.INT ; 8
 32131 000023E4 E8001F                  	call	calldev 		; calldev (sdevint);
 32132                                  
 32133                                  	; 11/12/2022
 32134                                  	; ds <> cs (from calldev) ; 31/12/2022
 32135                                  
 32136                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32137                                  ; (SYSINIT:2773h)
 32138                                  ; 29/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32139                                  ;%if 0
 32140 000023E7 58                      	pop	ax			; get real sysi_numio value
 32141                                  	; 31/12/2022
 32142                                  	;push	ds
 32143 000023E8 2EC51E[6D02]            	lds	bx,[cs:DOSINFO]		; ds:bx -> sys_var
 32144 000023ED 894720                  	mov	[bx+SYSI_NUMIO],ax	; restore previous/real value
 32145                                  	; 31/12/2022
 32146                                  	;pop	ds
 32147                                  
 32148                                  ;%endif ; 29/10/2022
 32149                                  
 32150                                  	; 11/12/2022
 32151 000023F0 0E                      	push	cs
 32152 000023F1 1F                      	pop	ds
 32153                                  
 32154 000023F2 E8F405                  	call	TrueInt12Mem
 32155                                  
 32156                                  	; 11/12/2022
 32157                                  	; ds = cs
 32158                                  	;mov	ax,[cs:break_addr]	; move break addr from the req packet
 32159                                  	;mov	[cs:DevBrkAddr],ax
 32160                                  	;mov	ax,[cs:break_addr+2]
 32161                                  	;mov	[cs:DevBrkAddr+2],ax
 32162 000023F5 A1[7D03]                	mov	ax,[break_addr]	
 32163 000023F8 A3[971F]                	mov	[DevBrkAddr],ax
 32164 000023FB A1[7F03]                	mov	ax,[break_addr+2]
 32165 000023FE A3[991F]                	mov	[DevBrkAddr+2],ax
 32166                                  
 32167                                  	; 29/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32168                                  	;call	RetFromUM		; There we go... all done.
 32169                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32170                                  	; (SYSINIT:2791h)
 32171 00002401 E86D0D                  	call	RetFromUM		; There we go... all done.	
 32172                                  
 32173                                  	; 31/12/2022
 32174                                  	; ds = cs
 32175                                  
 32176                                  	; 11/12/2022
 32177 00002404 803E[9C1F]00            	cmp	byte [DevUMB],0	
 32178                                  	;cmp	byte [cs:DevUMB],0
 32179 00002409 7403                    	je	short tryd_3
 32180 0000240B E8580F                  	call	AllocUMB
 32181                                  	; 31/12/2022
 32182                                  	; ds = cs
 32183                                  tryd_3:
 32184                                  
 32185                                  ;ifndef ROMDOS
 32186                                  ;------ If we are waiting to be moved into hma lets try it now !!!
 32187                                  
 32188                                  	; 11/12/2022
 32189                                  	; ds = cs
 32190                                  	
 32191                                  	;cmp	byte [cs:runhigh],0FFh
 32192 0000240E 803E[6C02]FF            	cmp	byte [runhigh],0FFh ; 11/12/2022
 32193 00002413 7503                    	jne	short tryd_4
 32194                                  	
 32195                                  	; 11/12/2022
 32196                                  	; ds = cs
 32197 00002415 E881E5                  	call	TryToMovDOSHi		; move DOS into HMA if reqd
 32198                                  tryd_4:
 32199                                  ;endif ; ROMDOS
 32200                                  
 32201 00002418 5E                      	pop	si
 32202 00002419 1F                      	pop	ds
 32203 0000241A C60400                  	mov	byte [si],0		; *p = 0;
 32204                                  
 32205 0000241D 0E                      	push	cs
 32206 0000241E 1F                      	pop	ds
 32207                                  
 32208 0000241F EB1F                    	jmp	short was_device_com
 32209                                  
 32210                                  ;----------------------------------------------------------------------------
 32211                                  
 32212                                  ; 02/04/2019 - Retro DOS v4.0
 32213                                  
 32214                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32215                                  ; (SYSINIT:27B3h)
 32216                                  
 32217                                  badnumblock:
 32218 00002421 0E                      	push	cs
 32219 00002422 1F                      	pop	ds
 32220                                  badnumblock2:	; 31/12/2022 (ds=cs)
 32221 00002423 BA[4C4B]                	mov	dx,badblock
 32222 00002426 E8D820                  	call	print
 32223                                  
 32224                                  ;------ fall thru -----------------------------------------------------------
 32225                                  
 32226                                  	; 31/12/2022 - Retro DOS v4.2
 32227                                  
 32228                                  erase_dev_do:				; modified to show message "error in config.sys..."
 32229                                  	
 32230                                  	;call	CheckDoubleSpace ; MSDOS 6.21 IO.SYS SYSINIT:27BBh
 32231                                  				; (Note: 'call CheckDoubleSpace'
 32232                                  				; has been removed at 'erase_dev_do:' pos
 32233                                  				; in PCDOS 7.1 IBMBIO.COM - SYSINIT:2CBAh)
 32234                                  				; Erdogan Tan - 10/07/2023
 32235 00002429 5E                      	pop	si ; ++
 32236 0000242A 07                      	pop	es ; + ; 31/12/2022
 32237                                  
 32238 0000242B 0E                      	push	cs
 32239 0000242C 1F                      	pop	ds
 32240                                  
 32241                                  skip1_resetmemhi:
 32242                                  	; 11/12/2022
 32243                                  	; ds = cs
 32244 0000242D 833E[8603]00            	cmp	word [configmsgflag],0
 32245                                  	;cmp	word [cs:configmsgflag],0
 32246 00002432 7409                    	je	short no_error_line_msg
 32247                                  
 32248 00002434 E83005                  	call	error_line		; no "error in config.sys" msg for device driver. dcr d493
 32249                                  	; 11/12/2022
 32250                                  	; ds = cs
 32251                                  	;mov	word [cs:configmsgflag],0
 32252 00002437 C706[8603]0000          	mov	word [configmsgflag],0	; set the default value again.
 32253                                  
 32254                                  no_error_line_msg:
 32255 0000243D E99FFC                  	jmp	coff
 32256                                  
 32257                                  ;----------------------------------------------------------------------------
 32258                                  
 32259                                  was_device_com:
 32260                                  	; 14/12/2022
 32261                                  	; ds = cs
 32262 00002440 A1[991F]                	mov	ax,[DevBrkAddr+2]
 32263                                  	;mov	ax,[cs:DevBrkAddr+2] ; 13/05/2019
 32264 00002443 3B06[911F]              	cmp	ax,[DevLoadEnd]
 32265                                  	;cmp	ax,[cs:DevLoadEnd]
 32266 00002447 7605                    	jbe	short breakok
 32267                                  
 32268 00002449 5E                      	pop	si
 32269 0000244A 07                      	pop	es
 32270 0000244B E91AFF                  	jmp	BadFile
 32271                                  
 32272                                  breakok:
 32273                                  	; 14/12/2022
 32274                                  	; ds = cs
 32275 0000244E C43E[6D02]              	les	di,[DOSINFO] 
 32276 00002452 C516[931F]              	lds	dx,[DevEntry]
 32277                                  	;lds	dx,[cs:DevEntry]	;set ds:dx to header
 32278 00002456 89D6                    	mov	si,dx
 32279                                  
 32280                                  	; 14/11/2022
 32281                                  	;les	di,[cs:DOSINFO] 	;es:di point to dos info
 32282                                  
 32283                                  	; 14/12/2022
 32284                                  	; ds <> cs
 32285                                  	
 32286                                  	;mov	ax,[si+4]
 32287 00002458 8B4404                  	mov	ax,[si+SYSDEV.ATT]	;get attributes
 32288                                  	; 12/12/2022
 32289 0000245B F6C480                  	test	ah,DEVTYP>>8 ; 80h 
 32290                                  	;test	ax,DEVTYP ; 8000h	;test if block dev
 32291 0000245E 7426                    	jz	short isblock
 32292                                  
 32293                                  ;------ lets deal with character devices
 32294                                  
 32295 00002460 2E800E[ED14]02          	or	byte [cs:setdevmarkflag],for_devmark ; 2
 32296 00002466 E84C0D                  	call	DevSetBreak		;go ahead and alloc mem for device
 32297                                  jc_edd:
 32298 00002469 72BE                    	jc	short erase_dev_do	;device driver's init routine failed.
 32299                                  
 32300                                  	; 12/12/2022
 32301 0000246B A801                    	test	al,ISCIN
 32302                                  	;test	ax,ISCIN ; 1		;is it a console in?
 32303 0000246D 7408                    	jz	short tryclk
 32304                                  
 32305 0000246F 2689550C                	mov	[es:di+SYSI_CON],dx   ; es:di+12
 32306 00002473 268C5D0E                	mov	[es:di+SYSI_CON+2],ds ; es:di+14
 32307                                  tryclk: 
 32308                                  	; 12/12/2022
 32309 00002477 A808                    	test	al,ISCLOCK
 32310                                  	;test	ax,ISCLOCK ; 8		;is it a clock device?
 32311 00002479 7408                    	jz	short golink
 32312                                  
 32313 0000247B 26895508                	mov	[es:di+SYSI_CLOCK],dx	; es:di+8
 32314 0000247F 268C5D0A                	mov	[es:di+SYSI_CLOCK+2],ds ; es:di+10
 32315                                  golink: 
 32316 00002483 E9B500                  	jmp	linkit
 32317                                  
 32318                                  ;------ deal with block device drivers
 32319                                  
 32320                                  isblock:
 32321 00002486 2EA0[7C03]              	mov	al,[cs:unitcount]	;if no units found,erase the device
 32322 0000248A 08C0                    	or	al,al
 32323 0000248C 749B                    	jz	short erase_dev_do
 32324                                  	;mov	[si+10],al
 32325 0000248E 88440A                  	mov	[si+SYSDEV.NAME],al	; number of units in name field
 32326                                  	; 29/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32327                                  	;add	[cs:driver_units],al
 32328                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32329 00002491 2E0006[EE14]            	add	[cs:driver_units],al	; keep total for all drivers in file
 32330                                  perdrv:
 32331 00002496 98                      	cbw				; warning no device > 127 units
 32332 00002497 89C1                    	mov	cx,ax
 32333 00002499 88E6                    	mov	dh,ah
 32334                                  	;mov	dl,[es:di+32]
 32335 0000249B 268A5520                	mov	dl,[es:di+SYSI_NUMIO]	;get number of devices
 32336 0000249F 88D4                    	mov	ah,dl
 32337 000024A1 00C4                    	add	ah,al			; check for too many devices
 32338 000024A3 80FC1A                  	cmp	ah,26			; 'A' - 'Z' is 26 devices
 32339 000024A6 7603                    	jbe	short ok_block
 32340 000024A8 E976FF                  	jmp	badnumblock
 32341                                  
 32342                                  ok_block:
 32343 000024AB 2E800E[ED14]02          	or	byte [cs:setdevmarkflag],for_devmark ; 2
 32344 000024B1 E8010D                  	call	DevSetBreak		; alloc the device
 32345 000024B4 72B3                    	jc	short jc_edd
 32346 000024B6 26004520                	add	[es:di+SYSI_NUMIO],al	; update the amount
 32347                                  
 32348 000024BA 2E0006[8503]            	add	[cs:drivenumber],al	; remember amount for next device
 32349 000024BF 2EC51E[8103]            	lds	bx,[cs:bpb_addr]	; point to bpb array
 32350                                  perunit:
 32351 000024C4 2EC42E[6D02]            	les	bp,[cs:DOSINFO]
 32352                                  	;les	bp,[es:bp+SYSI_DPB]	; get first dpb
 32353                                  	; 11/12/2022
 32354 000024C9 26C46E00                	les	bp,[es:bp]
 32355                                  	; 29/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32356                                  	;les	bp,[es:bp+0]		; [es:bp+SYSI_DPB]
 32357                                  scandpb:
 32358                                  	;cmp	word [es:bp+25],-1
 32359 000024CD 26837E19FF              	cmp	word [es:bp+DPB.NEXT_DPB],-1
 32360 000024D2 7406                    	je	short foundpb
 32361                                  	;les	bp,[es:bp+25]
 32362 000024D4 26C46E19                	les	bp,[es:bp+DPB.NEXT_DPB]
 32363 000024D8 EBF3                    	jmp	short scandpb
 32364                                  foundpb:
 32365 000024DA 2EA1[971F]              	mov	ax,[cs:DevBrkAddr]
 32366 000024DE 26894619                	mov	[es:bp+DPB.NEXT_DPB],ax
 32367 000024E2 2EA1[991F]              	mov	ax,[cs:DevBrkAddr+2]
 32368 000024E6 2689461B                	mov	[es:bp+DPB.NEXT_DPB+2],ax
 32369                                  
 32370 000024EA 2EC42E[971F]            	les	bp,[cs:DevBrkAddr]
 32371 000024EF 2E8306[971F]21          	add	word [cs:DevBrkAddr],DPBSIZ ; 33
 32372                                  				; 08/09/2023
 32373                                  				; (61 in PCDOS 7.1 IBMBIO.COM)
 32374 000024F5 E89C0C                  	call	RoundBreakAddr
 32375                                  
 32376 000024F8 26C74619FFFF            	mov	word [es:bp+DPB.NEXT_DPB],-1
 32377 000024FE 26C64618FF              	mov	byte [es:bp+DPB.FIRST_ACCESS],-1
 32378                                  
 32379 00002503 8B37                    	mov	si,[bx] 		;ds:si points to bpb
 32380 00002505 43                      	inc	bx
 32381 00002506 43                      	inc	bx			;point to next guy
 32382                                  	;mov	[es:bp+DPB.DRIVE],dx
 32383                                  	; 11/12/2022
 32384 00002507 26895600                	mov	[es:bp],dx ; 13/05/2019
 32385                                  	; 29/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32386                                  	;mov	[es:bp+0],dx		; [es:bp+DPB.DRIVE]
 32387                                  
 32388 0000250B B453                    	mov	ah,SETDPB ; 53h		;hidden system call
 32389 0000250D CD21                    	int	21h
 32390                                  			; DOS - 2+ internal - TRANSLATE BIOS PARAMETER BLOCK
 32391                                  			; DS:SI -> BPB (BIOS Parameter Block)
 32392                                  			; ES:BP -> buffer for DOS Drive Parameter Block
 32393                                  
 32394                                  	;mov	ax,[es:bp+2]
 32395 0000250F 268B4602                	mov	ax,[es:bp+DPB.SECTOR_SIZE]
 32396 00002513 06                      	push	es
 32397 00002514 2EC43E[6D02]            	les	di,[cs:DOSINFO] 	;es:di point to dos info
 32398                                  	;cmp	ax,[es:di+10h]
 32399 00002519 263B4510                	cmp	ax,[es:di+SYSI_MAXSEC]
 32400 0000251D 07                      	pop	es
 32401                                  	;jna	short iblk_1
 32402                                  	;jmp	short bad_bpb_size_sector
 32403                                  	; 29/10/2022
 32404 0000251E 775D                    	ja	short bad_bpb_size_sector
 32405                                  iblk_1:
 32406 00002520 1E                      	push	ds
 32407 00002521 52                      	push	dx
 32408                                  
 32409 00002522 2EC516[931F]            	lds	dx,[cs:DevEntry]
 32410                                  	;mov	[es:bp+13h],dx
 32411 00002527 26895613                	mov	[es:bp+DPB.DRIVER_ADDR],dx
 32412                                  	;mov	[es:bp+15h],ds
 32413 0000252B 268C5E15                	mov	[es:bp+DPB.DRIVER_ADDR+2],ds
 32414                                  
 32415 0000252F 5A                      	pop	dx
 32416 00002530 1F                      	pop	ds
 32417                                  
 32418 00002531 42                      	inc	dx
 32419 00002532 FEC6                    	inc	dh
 32420 00002534 E28E                    	loop	perunit
 32421                                  
 32422 00002536 0E                      	push	cs
 32423 00002537 1F                      	pop	ds
 32424                                  
 32425 00002538 E851E7                  	call	TempCDS 		; set cds for new drives
 32426                                  	; 31/12/2022
 32427                                  	; ds <> cs
 32428                                  linkit:
 32429 0000253B 2EC43E[6D02]            	les	di,[cs:DOSINFO] 	;es:di = dos table
 32430 00002540 268B4D22                	mov	cx,[es:di+SYSI_DEV]	;dx:cx = head of list
 32431 00002544 268B5524                	mov	dx,[es:di+SYSI_DEV+2]
 32432                                  
 32433 00002548 2EC536[931F]            	lds	si,[cs:DevEntry]	;ds:si = device location
 32434 0000254D 26897522                	mov	[es:di+SYSI_DEV],si	;set head of list in dos
 32435 00002551 268C5D24                	mov	[es:di+SYSI_DEV+2],ds
 32436 00002555 8B04                    	mov	ax,[si]			;get pointer to next device
 32437 00002557 2EA3[931F]              	mov	[cs:DevEntry],ax	;and save it
 32438                                  
 32439 0000255B 890C                    	mov	[si],cx			;link in the driver
 32440 0000255D 895402                  	mov	[si+2],dx
 32441                                  enddev:
 32442 00002560 5E                      	pop	si
 32443 00002561 07                      	pop	es
 32444 00002562 40                      	inc	ax			;ax = ffff (no more devs if yes)?
 32445 00002563 740B                    	jz	short coffj3
 32446                                  
 32447 00002565 2EFE06[EA14]            	inc	byte [cs:multdeviceflag] ; possibly multiple device driver.
 32448 0000256A E86A0C                  	call	DevBreak		; M009
 32449                                  	; 11/12/2022
 32450                                  	; ds = cs (DevBreak)
 32451                                  
 32452                                  	; 03/04/2019 - Retro DOS v4.0
 32453                                  	; MSDOS 6.21 IO.SYS - SYSINIT:290Dh
 32454 0000256D E917FE                  	jmp	goodld			; otherwise pretend we loaded it in
 32455                                  coffj3: 
 32456                                  	; 18/12/2022
 32457                                  	; ax = 0
 32458 00002570 2EA2[EA14]              	mov	[cs:multdeviceflag],al ; 0
 32459                                  	;mov	byte [cs:multdeviceflag],0 ; reset the flag
 32460 00002574 E8600C                  	call	DevBreak
 32461                                  	; 11/12/2022
 32462                                  	; ds = cs (DevBreak)
 32463                                  	
 32464                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32465                                  	; (SYSINIT:2919h)
 32466                                  	; 11/07/2023
 32467 00002577 E88203                  	call	CheckProtmanArena
 32468                                  	
 32469                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS compatibility)
 32470                                  	;;call	CheckProtmanArena	; adjust alloclim if Protman$ just
 32471                                  ;					;  created a bogus arena to try
 32472                                  ;					;  to protect some of its resident-
 32473                                  ;					;  init code.
 32474                                  	;call	CheckDoubleSpace
 32475 0000257A E962FB                  	jmp	coff
 32476                                  
 32477                                  ;----------------------------------------------------------------------------
 32478                                  
 32479                                  ;CheckDoubleSpace:
 32480                                  ;;;;	ifdef	dblspace_hooks
 32481                                  ;
 32482                                  ;;	Now check for two special MagicDrv cases:
 32483                                  ;;
 32484                                  ;;       a) the last driver load was MagicDrv final placement:
 32485                                  ;;	   -> add number of MagicDrv reserved drives to drivenumber
 32486                                  ;;
 32487                                  ;;       b) MagicDrv is currently in temporary home:
 32488                                  ;;          -> call it to give it a chance to mount and shuffle drives
 32489                                  ;
 32490                                  ;	cmp	byte [cs:MagicHomeFlag],0 ; already home?
 32491                                  ;	jnz	short no_more_magic_calls ;  nothing more to do if so
 32492                                  ;
 32493                                  ;;	Now inquire of driver whether it is present, and final located
 32494                                  ;
 32495                                  ;	mov	ax,multMagicdrv ; 4A11h
 32496                                  ;	mov	bx,MD_VERSION ; 0
 32497                                  ;	int	2fh			; ch = number of MagicDrv drive letters
 32498                                  ;	or	ax,ax			; is it there?
 32499                                  ;	jnz	short no_more_magic_calls ; done if not
 32500                                  ;
 32501                                  ;	test	dx,8000h		; is it final placed?
 32502                                  ;	jnz	short magic_not_yet_home ;  skip if not
 32503                                  ;
 32504                                  ;;	Okay, now the driver is final placed!  Set the flag so we
 32505                                  ;;	don't keep checking it, and add its number of drive letters
 32506                                  ;;	to drivenumber.
 32507                                  ;
 32508                                  ;	mov	byte [cs:MagicHomeFlag],0ffh ; set the flag!
 32509                                  ;	add	[cs:drivenumber],ch	; add number of MagicDrv volumes to
 32510                                  ;;					;  the drive number we'll pass to the
 32511                                  ;;					;  next loadable block device.
 32512                                  ;
 32513                                  ;	jmp	short no_more_magic_calls ; and finished.
 32514                                  ;
 32515                                  ;magic_not_yet_home:
 32516                                  ;	push	es
 32517                                  ;	push	si
 32518                                  ;
 32519                                  ;	mov	cx,[cs:memhi]		; pass it a work buffer
 32520                                  ;	mov	dx,[cs:ALLOCLIM]	;   address in cx (segment)
 32521                                  ;	sub	dx,cx			;   for len dx (paragraphs)
 32522                                  ;
 32523                                  ;	mov	bx,2
 32524                                  ;	mov	al,[cs:driver_units]	; shuffle magicdrives and new drives
 32525                                  ;;					;   by this many units
 32526                                  ;
 32527                                  ;;BUGBUG 29-Oct-1992 bens Take this 55h out after Beta 4
 32528                                  ;	mov	ah,55h			; backdoor won't shuffle unless it
 32529                                  ;;					;  sees this, to prevent bad things
 32530                                  ;;					;  from happening if people run the
 32531                                  ;;					;  new driver with an old (dos) BIOS
 32532                                  ;	call	far [cs:MagicBackdoor]
 32533                                  ;
 32534                                  ;	pop	si
 32535                                  ;	pop	es
 32536                                  ;
 32537                                  ;no_more_magic_calls:
 32538                                  ;
 32539                                  ;;;;	endif
 32540                                  ;	retn
 32541                                  
 32542                                  ; 03/04/2019 - Retro DOS v4.0
 32543                                  
 32544                                  bad_bpb_size_sector:
 32545 0000257D 5E                      	pop	si
 32546 0000257E 07                      	pop	es
 32547 0000257F BA[6E4A]                	mov	dx,badsiz_pre
 32548 00002582 BB[4C4A]                	mov	bx,crlfm
 32549 00002585 E8571F                  	call	prnerr
 32550                                  
 32551 00002588 E954FB                  	jmp	coff
 32552                                  
 32553                                  ;------------------------------------------------------------------------------
 32554                                  ; country command
 32555                                  ;      the syntax is:
 32556                                  ;	country=country id {,codepage {,path}}
 32557                                  ;	country=country id {,,path}	:default codepage id in dos
 32558                                  ;------------------------------------------------------------------------------
 32559                                  
 32560                                  	; 30/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 32561                                  	; (SYSINIT:2663h)
 32562                                  tryq:
 32563 0000258B 80FC51                          cmp     ah,CONFIG_COUNTRY ; 'Q'
 32564 0000258E 7403                    	je	short tryq_cont
 32565                                  skip_it3:
 32566 00002590 E90D01                  	jmp	tryf
 32567                                  tryq_cont:
 32568                                  
 32569                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32570                                  ; (SYSINIT:297Eh)
 32571                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32572                                  ;%if 0
 32573                                  ;ifdef	MULTI_CONFIG
 32574 00002593 E8331B                  	call	query_user		; query the user if config_cmd
 32575 00002596 72F8                    	jc	short skip_it3		; has the CONFIG_OPTION_QUERY bit set
 32576                                  ;endif
 32577                                  ;%endif ; 02/11/2022
 32578                                  
 32579                                  	; 31/12/2022
 32580                                  	;xor	bx,bx
 32581 00002598 31C9                    	xor	cx,cx
 32582                                  	; 14/12/2022
 32583                                  	; ds = cs
 32584                                  	; bx = 0
 32585                                  	;mov	byte [cs:cntry_drv],0	; reset the drive,path to default value.
 32586                                  	;mov	word [cs:p_code_page],0
 32587                                  	; 31/12/2022
 32588                                  	; cx = 0
 32589                                  	;mov	[cntry_drv],bl ; 0
 32590                                  	;mov	[p_code_page],bx ; 0
 32591 0000259A 880E[8A45]              	mov	[cntry_drv],cl ; 0
 32592 0000259E 890E[041E]              	mov	[p_code_page],cx ; 0	
 32593                                  
 32594 000025A2 BF[CD1D]                	mov	di,cntry_parms
 32595                                  	;xor	cx,cx	; 31/12/2022
 32596                                  	; 03/01/2023
 32597                                  	;mov	dx,cx
 32598                                  do52:
 32599 000025A5 E86C03                  	call	sysinit_parse
 32600 000025A8 730B                    	jnc	short if52		; parse error,check error code and
 32601                                  
 32602 000025AA E8E000                  	call	cntry_error		; show message and end the search loop.
 32603                                  	; 14/12/2022
 32604                                  	; ds = cs
 32605 000025AD C706[021E]FFFF          	mov	word [p_cntry_code],-1
 32606                                  	;mov	word [cs:p_cntry_code],-1 ; signals that parse error.
 32607 000025B3 EB34                    	jmp	short sr52
 32608                                  if52:
 32609 000025B5 83F8FF                  	cmp	ax,_$P_RC_EOL ; 0FFFFh	; end of line?
 32610 000025B8 742F                    	jz	short sr52		; then end the search loop
 32611                                  
 32612                                  	;cmp	byte [cs:result_val+_$P_Result_Blk.Type],_$P_number ; numeric?
 32613                                  	; 14/12/2022
 32614                                  	; ds = cs
 32615 000025BA 803E[9F1D]01            	cmp	byte [result_val],_$P_Number	
 32616                                  	;cmp	byte [cs:result_val],_$P_Number
 32617 000025BF 7512                    	jnz	short if56
 32618                                  
 32619                                  	;;mov	ax,[cs:rw_dword]
 32620                                  	;mov	ax,[cs:result_val+_$P_Result_Blk.Picked_Val]
 32621                                  	; 14/12/2022
 32622 000025C1 A1[A31D]                	mov	ax,[result_val+_$P_Result_Blk.Picked_Val]
 32623 000025C4 83F901                  	cmp	cx,1
 32624 000025C7 7505                    	jne	short if57
 32625                                  
 32626                                  	;mov	[cs:p_cntry_code],ax
 32627                                  	; 14/12/2022
 32628 000025C9 A3[021E]                	mov	[p_cntry_code],ax
 32629                                  
 32630                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32631                                  	;jmp	short en57
 32632                                  	; 12/12/2022
 32633                                  	;jmp	short en56
 32634 000025CC EBD7                    	jmp	short do52
 32635                                  if57:
 32636                                  	;mov	[cs:p_code_page],ax
 32637                                  	; 14/12/2022
 32638                                  	; ds = cs
 32639 000025CE A3[041E]                	mov	[p_code_page],ax
 32640                                  en57:
 32641                                  	;jmp	short en56		; path entered
 32642                                  	; 12/12/2022
 32643 000025D1 EBD2                    	jmp	short do52
 32644                                  if56:
 32645 000025D3 1E                      	push	ds
 32646 000025D4 06                      	push	es
 32647 000025D5 56                      	push	si
 32648 000025D6 57                      	push	di
 32649                                  
 32650 000025D7 0E                      	push	cs
 32651 000025D8 07                      	pop	es
 32652                                  
 32653                                  	;lds	si,[cs:rv_dword]	; move the path to known place.
 32654                                  	; 14/12/2022
 32655 000025D9 C536[A31D]              	lds	si,[rv_dword]
 32656 000025DD BF[8A45]                	mov	di,cntry_drv
 32657 000025E0 E8EB1E                  	call	move_asciiz
 32658                                  
 32659 000025E3 5F                      	pop	di
 32660 000025E4 5E                      	pop	si
 32661 000025E5 07                      	pop	es
 32662 000025E6 1F                      	pop	ds
 32663                                  en56:
 32664 000025E7 EBBC                    	jmp	short do52
 32665                                  sr52:
 32666                                  	; 14/12/2022
 32667                                  	; ds = cs
 32668 000025E9 833E[021E]FF            	cmp	word [p_cntry_code],-1
 32669                                  	;cmp	word [cs:p_cntry_code],-1	; had a parse error?
 32670 000025EE 7509                    	jne	short tryq_open
 32671 000025F0 E9ECFA                  	jmp	coff
 32672                                  
 32673                                  tryqbad:				;"invalid country code or code page"
 32674 000025F3 F9                      	stc
 32675 000025F4 BA[B54A]                	mov     dx,badcountry
 32676 000025F7 EB79                    	jmp     tryqchkerr
 32677                                  
 32678                                  tryq_open:
 32679                                  	; 14/12/2022
 32680                                  	; ds = cs
 32681 000025F9 803E[8A45]00            	cmp	byte [cntry_drv],0
 32682                                  	;cmp	byte [cs:cntry_drv],0
 32683 000025FE 7405                    	je	short tryq_def
 32684 00002600 BA[8A45]                	mov	dx,cntry_drv
 32685 00002603 EB03                    	jmp	short tryq_openit
 32686                                  
 32687                                  tryq_def:
 32688 00002605 BA[8C45]                	mov	dx,cntry_root
 32689                                  tryq_openit:
 32690 00002608 B8003D                  	mov	ax,3D00h		;open a file
 32691 0000260B F9                      	stc
 32692 0000260C CD21                    	int	21h
 32693 0000260E 7242                    	jc	short tryqfilebad	;open failure
 32694                                  
 32695                                  	; 14/12/2022
 32696                                  	; ds = cs
 32697 00002610 A3[5C03]                	mov	[cntryfilehandle],ax
 32698                                  	;mov	[cs:cntryfilehandle],ax	;save file handle
 32699 00002613 89C3                    	mov	bx,ax
 32700 00002615 A1[021E]                	mov	ax,[p_cntry_code]
 32701 00002618 8B16[041E]              	mov	dx,[p_code_page]
 32702                                  	;mov	ax,[cs:p_cntry_code]
 32703                                  	;mov	dx,[cs:p_code_page]	;now,ax=country id,bx=filehandle
 32704                                  	;mov	cx,[cs:memhi]
 32705 0000261C 8B0E[6403]              	mov	cx,[memhi]
 32706 00002620 81C18001                	add	cx,384			;need 6k buffer to handle country.sys
 32707                                  					;M023
 32708                                  	; 14/12/2022
 32709                                  	; ds = cs
 32710 00002624 3B0E[A502]              	cmp	cx,[ALLOCLIM]
 32711                                  	;cmp	cx,[cs:ALLOCLIM]
 32712 00002628 7745                    	ja	short tryqmemory	;cannot allocate the buffer for country.sys
 32713                                  
 32714 0000262A BE[8A45]                	mov	si,cntry_drv		;ds:si -> cntry_drv
 32715 0000262D 803C00                  	cmp	byte [si],0 		;default path?
 32716 00002630 7502                    	jne	short tryq_set_for_dos
 32717                                  
 32718 00002632 46                      	inc	si
 32719 00002633 46                      	inc	si			;ds:si -> cntry_root
 32720                                  
 32721                                  tryq_set_for_dos:
 32722                                  	; 14/12/2022
 32723                                  	; ds = cs
 32724 00002634 C43E[7902]              	les	di,[sysi_country]
 32725                                  	;les	di,[cs:sysi_country]	;es:di -> country info tab in dos
 32726 00002638 57                      	push	di			;save di
 32727                                  	;add	di,8
 32728 00002639 83C708                  	add	di,country_cdpg_info.ccPath_CountrySys ; 8
 32729 0000263C E88F1E                  	call	move_asciiz		;set the path to country.sys in dos.
 32730 0000263F 5F                      	pop	di			;es:di -> country info tab again.
 32731                                  
 32732                                  	; 14/12/2022	
 32733 00002640 8B0E[6403]              	mov	cx,[memhi]
 32734                                  	;mov	cx,[cs:memhi]
 32735 00002644 8ED9                    	mov	ds,cx
 32736 00002646 31F6                    	xor	si,si			;ds:si -> 2k buffer to be used.
 32737 00002648 E81F1D                  	call	setdoscountryinfo	;now do the job!!!
 32738                                  	; ds <> cs ; 14/12/2022
 32739 0000264B 7325                    	jnc	short tryqchkerr	;read error or could not find country,code page combination
 32740                                  
 32741 0000264D 83F9FF                  	cmp	cx,-1			;could not find matching country_id,code page?
 32742 00002650 74A1                    	je	short tryqbad 		;then "invalid country code or code page"
 32743                                  
 32744                                  tryqfilebad:
 32745 00002652 0E                      	push	cs
 32746 00002653 07                      	pop	es
 32747 00002654 2E803E[8A45]00          	cmp	byte [cs:cntry_drv],0	;is the default file used?
 32748 0000265A 7405                    	je	short tryqdefbad
 32749                                  
 32750 0000265C BE[8A45]                	mov	si,cntry_drv
 32751 0000265F EB03                    	jmp	short tryqbadload
 32752                                  
 32753                                  tryqdefbad:				;default file has been used.
 32754 00002661 BE[8C45]                	mov	si,cntry_root		;es:si -> \country.sys in sysinit_seg
 32755                                  tryqbadload:
 32756 00002664 E8721E                  	call	badload 		;ds will be restored to sysinit_seg
 32757                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32758                                  	; (SYSINIT:2A69h)
 32759 00002667 8B0E[A302]              	mov	cx,[CONFBOT] ; ds = cs (from badload)
 32760                                  	;mov	cx,[cs:CONFBOT]
 32761                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32762                                  	;mov	cx,[cs:top_of_cdss]
 32763                                  	; 11/12/2022
 32764                                  	; ds = cs
 32765                                  	;mov	cx,[top_of_cdss]  ; mov cx,[CONFBOT]	
 32766 0000266B 8EC1                    	mov	es,cx			;restore es -> confbot.
 32767 0000266D EB13                    	jmp	short coffj4
 32768                                  
 32769                                  tryqmemory:
 32770 0000266F BA[F84A]                	mov	dx,insufmemory
 32771                                  tryqchkerr:
 32772                                  	;mov	cx,[cs:CONFBOT]
 32773                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32774                                  	;mov	cx,[cs:top_of_cdss]
 32775                                  	; 12/12/2022
 32776 00002672 0E                      	push	cs
 32777 00002673 1F                      	pop	ds
 32778                                  	; 31/12/2022 - Retro DOS v4.2
 32779 00002674 8B0E[A302]              	mov	cx,[CONFBOT] ; (MSDOS 6.21 IO.SYS, SYSINIT)
 32780                                  	;mov	cx,[top_of_cdss]  ; mov cx,[CONFBOT]
 32781 00002678 8EC1                    	mov	es,cx			;restore es -> confbot seg
 32782                                  	;push	cs
 32783                                  	;pop	ds			;restore ds to sysinit_seg
 32784 0000267A 7306                    	jnc	short coffj4		;if no error,then exit
 32785                                  
 32786 0000267C E8821E                  	call	print			;else show error message
 32787 0000267F E8E502                  	call	error_line
 32788                                  coffj4:
 32789                                  	;mov	bx,[cs:cntryfilehandle]
 32790                                  	; 11/12/2022
 32791                                  	; ds = cs
 32792 00002682 8B1E[5C03]              	mov	bx,[cntryfilehandle]
 32793 00002686 B43E                    	mov	ah,3Eh
 32794 00002688 CD21                    	int	21h			;close file. don't care even if it fails.
 32795 0000268A E952FA                  	jmp	coff
 32796                                  
 32797                                  ;--------------------------------------------
 32798                                  
 32799                                  cntry_error:
 32800                                  
 32801                                  ;function: show "invalid country code or code page" messages,or
 32802                                  ;		"error in country command" depending on the error code
 32803                                  ;		in ax returned by sysparse;
 32804                                  ;in:	ax - error code
 32805                                  ;	ds - sysinitseg
 32806                                  ;	es - confbot
 32807                                  ;out:	show message.  dx destroyed.
 32808                                  
 32809 0000268D 83F806                  	cmp	ax,_$P_Out_Of_Range ; 6
 32810 00002690 7505                    	jne	short if64
 32811 00002692 BA[B54A]                	mov	dx,badcountry		;"invalid country code or code page"
 32812 00002695 EB03                    	jmp	short en64
 32813                                  if64:
 32814 00002697 BA[DB4A]                	mov	dx,badcountrycom	;"error in contry command"
 32815                                  en64:
 32816 0000269A E8641E                  	call	print
 32817                                  	;call	error_line
 32818                                  	;retn
 32819                                  	; 11/12/2022
 32820 0000269D E9C702                  	jmp	error_line
 32821                                  
 32822                                  ;------------------------------------------------------------------------------
 32823                                  ; files command
 32824                                  ;------------------------------------------------------------------------------
 32825                                  
 32826                                  ;******************************************************************************
 32827                                  ; function: parse the parameters of files= command.			      *
 32828                                  ;									      *
 32829                                  ; input :								      *
 32830                                  ;	es:si -> parameters in command line.				      *
 32831                                  ; output:								      *
 32832                                  ;	variable files set.						      *
 32833                                  ;									      *
 32834                                  ; subroutines to be called:						      *
 32835                                  ;	sysinit_parse							      *
 32836                                  ; logic:								      *
 32837                                  ; {									      *
 32838                                  ;	set di points to files_parms;					      *
 32839                                  ;	set dx,cx to 0; 						      *
 32840                                  ;	while (end of command line)					      *
 32841                                  ;	{ sysinit_parse;						      *
 32842                                  ;	  if (no error) then						      *
 32843                                  ;	     files = result_val._$P_picked_val				      *
 32844                                  ;	  else								      *
 32845                                  ;	     error exit;						      *
 32846                                  ;	};								      *
 32847                                  ; };									      *
 32848                                  ;									      *
 32849                                  ;******************************************************************************
 32850                                  
 32851                                  tryf:
 32852 000026A0 80FC46                          cmp     ah,CONFIG_FILES ;  'F'
 32853 000026A3 7528                    	jne	short tryl
 32854                                  
 32855                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32856                                  ; (SYSINIT:2AABh)
 32857                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32858                                  ;%if 0
 32859                                  ;ifdef	MULTI_CONFIG
 32860 000026A5 E8211A                  	call	query_user              ; query the user if config_cmd
 32861 000026A8 7223                    	jc	short tryl		; has the CONFIG_OPTION_QUERY bit set
 32862                                  ;endif
 32863                                  ;%endif ; 30/10/2022
 32864                                  
 32865                                  	; 14/12/2022
 32866                                  	; ds = cs
 32867                                  
 32868 000026AA BF[061E]                	mov	di,files_parms
 32869 000026AD 31C9                    	xor	cx,cx
 32870                                  	; 03/01/2023
 32871                                  	;mov	dx,cx
 32872                                  do67:
 32873 000026AF E86202                  	call	sysinit_parse
 32874 000026B2 7303                    	jnc	short if67		; parse error
 32875                                  	;call	badparm_p		;  and show messages and end the search loop.
 32876                                  	;jmp	short sr67
 32877                                  	; 03/01/2023
 32878 000026B4 E98C01                  	jmp	badparm_p_coff
 32879                                  if67:
 32880 000026B7 83F8FF                  	cmp	ax,_$P_RC_EOL		; end of line?
 32881 000026BA 7408                    	je	short en67		; then end the $endloop
 32882                                  
 32883                                  	; 14/12/2022
 32884                                  	; ds = cs
 32885                                  	;;mov	al,[cs:rv_dword]
 32886                                  	;mov	al,[cs:result_val+_$P_Result_Blk.Picked_Val]
 32887                                  	;mov	[cs:p_files],al		; save it temporarily
 32888                                  	;mov	al,[rv_dword]
 32889 000026BC A0[A31D]                	mov	al,[result_val+_$P_Result_Blk.Picked_Val]
 32890 000026BF A2[251E]                	mov	[p_files],al
 32891                                  
 32892 000026C2 EBEB                    	jmp	short do67
 32893                                  en67:
 32894                                  	; 14/12/2022
 32895                                  	; ds = cs
 32896 000026C4 A0[251E]                	mov	al,[p_files]
 32897 000026C7 A2[9F02]                	mov	[FILES],al	
 32898                                  	;mov	al,[cs:p_files]
 32899                                  	;mov	[cs:FILES],al		; no error. really set the value now.
 32900                                  sr67:
 32901 000026CA E912FA                  	jmp	coff
 32902                                  
 32903                                  ; 04/04/2019 - Retro DOS v4.0
 32904                                  
 32905                                  ;------------------------------------------------------------------------------
 32906                                  ; lastdrive command
 32907                                  ;------------------------------------------------------------------------------
 32908                                  
 32909                                  ;******************************************************************************
 32910                                  ; function: parse the parameters of lastdrive= command. 		      *
 32911                                  ;									      *
 32912                                  ; input :								      *
 32913                                  ;	es:si -> parameters in command line.				      *
 32914                                  ; output:								      *
 32915                                  ;	set the variable num_cds.					      *
 32916                                  ;									      *
 32917                                  ; subroutines to be called:						      *
 32918                                  ;	sysinit_parse							      *
 32919                                  ; logic:								      *
 32920                                  ; {									      *
 32921                                  ;	set di points to ldrv_parms;					      *
 32922                                  ;	set dx,cx to 0; 						      *
 32923                                  ;	while (end of command line)					      *
 32924                                  ;	{ sysinit_parse;						      *
 32925                                  ;	  if (no error) then						      *
 32926                                  ;	     set num_cds to the returned value; 			      *
 32927                                  ;	  else	/*error exit*/						      *
 32928                                  ;	     error exit;						      *
 32929                                  ;	};								      *
 32930                                  ; };									      *
 32931                                  ;									      *
 32932                                  ;******************************************************************************
 32933                                  
 32934                                  tryl:
 32935 000026CD 80FC4C                          cmp     ah,CONFIG_LASTDRIVE ; 'L'
 32936 000026D0 7528                    	jne	short tryp
 32937                                  
 32938                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 32939                                  ; (SYSINIT:2AE0h)
 32940                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32941                                  ;%if 0
 32942 000026D2 E8F419                  	call	query_user      ; query the user if config_cmd
 32943 000026D5 7223                    	jc	short tryp	; has the CONFIG_OPTION_QUERY bit set
 32944                                  ;endif
 32945                                  ;%endif ; 30/10/2022
 32946                                  
 32947                                  	; 14/12/2022
 32948                                  	; ds = cs
 32949                                  
 32950 000026D7 BF[5D1E]                	mov	di,ldrv_parms
 32951 000026DA 31C9                    	xor	cx,cx
 32952                                  	; 03/01/2023
 32953                                  	;mov	dx,cx
 32954                                  do73:
 32955 000026DC E83502                  	call	sysinit_parse
 32956 000026DF 7303                    	jnc	short if73	; parse error
 32957                                  	;call	badparm_p	;  and show messages and end the search loop.
 32958                                  	;jmp	short sr73
 32959                                  	; 03/01/2023
 32960 000026E1 E95F01                  	jmp	badparm_p_coff
 32961                                  if73:
 32962 000026E4 83F8FF                  	cmp	ax,_$P_RC_EOL	; end of line?
 32963 000026E7 7408                    	je	short en73	; then end the $endloop
 32964                                  
 32965                                  	; 14/12/2022
 32966                                  	; ds = cs
 32967                                  	;;mov	al,[cs:rv_dword]
 32968                                  	;mov	al,[cs:rv_byte]	; pick up the drive number
 32969                                  	;mov	[cs:p_ldrv],al	; save it temporarily
 32970                                  
 32971                                  	;mov	al,[rv_dword]
 32972 000026E9 A0[A31D]                	mov	al,[rv_byte]
 32973 000026EC A2[711E]                	mov	[p_ldrv],al
 32974                                  
 32975 000026EF EBEB                    	jmp	short do73
 32976                                  en73:
 32977                                  	; 14/12/2022
 32978                                  	; ds = cs
 32979 000026F1 A0[711E]                	mov	al,[p_ldrv]
 32980 000026F4 A2[A202]                	mov	[NUM_CDS],al
 32981                                  	;mov	al,[cs:p_ldrv]
 32982                                  	;mov	[cs:NUM_CDS],al	; no error. really set the value now.
 32983                                  sr73:
 32984 000026F7 E9E5F9                  	jmp	coff
 32985                                  
 32986                                  ;--------------------------------------------------------------------------
 32987                                  ; setting drive parameters
 32988                                  ;--------------------------------------------------------------------------
 32989                                  
 32990                                  tryp:
 32991 000026FA 80FC50                          cmp     ah,CONFIG_DRIVPARM ; 'P'
 32992 000026FD 7516                    	jne	short tryk
 32993                                  
 32994                                  ; 31/12/2022 - Retro DOS v4.2
 32995                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 32996                                  ;%if 0
 32997                                  ;ifdef	MULTI_CONFIG
 32998 000026FF E8C719                  	call	query_user      ; query the user if config_cmd
 32999 00002702 7211                    	jc	short tryk	; has the CONFIG_OPTION_QUERY bit set
 33000                                  ;endif
 33001                                  ;%endif ; 30/10/2022
 33002                                  
 33003 00002704 E8AB0E                  	call	parseline
 33004 00002707 7209                    	jc	short trypbad
 33005 00002709 E8C40D                  	call	setparms
 33006 0000270C E8060E                  	call	diddleback
 33007                                  
 33008                                  ; No error check here, because setparms and diddleback have no error 
 33009                                  ; returns, and setparms as coded now can return with carry set. 
 33010                                  ;       jc	short trypbad
 33011                                  
 33012                                  	; 12/12/2022
 33013                                  	; cf = 0
 33014                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33015                                  	;jc	short trypbad
 33016                                  	
 33017 0000270F E9CDF9                  	jmp	coff
 33018                                  trypbad:
 33019 00002712 E91E02                  	jmp	badop
 33020                                  
 33021                                  ;--------------------------------------------------------------------------
 33022                                  ; setting internal stack parameters
 33023                                  ; stacks=m,n where
 33024                                  ;	m is the number of stacks (range 8 to 64,default 9)
 33025                                  ;	n is the stack size (range 32 to 512 bytes,default 128)
 33026                                  ; j.k. 5/5/86: stacks=0,0 implies no stack installation.
 33027                                  ;	any combinations that are not within the specified limits will
 33028                                  ;	result in "unrecognized command" error.
 33029                                  ;--------------------------------------------------------------------------
 33030                                  
 33031                                  ;**************************************************************************
 33032                                  ;									  *
 33033                                  ; function: parse the parameters of stacks= command.			  *
 33034                                  ;	    the minimum value for "number of stacks" and "stack size" is  *
 33035                                  ;	    8 and 32 each.  in the definition of sysparse value list,they *
 33036                                  ;	    are set to 0.  this is for accepting the exceptional case of  *
 33037                                  ;	    stacks=0,0 case (,which means do not install the stack.)	  *
 33038                                  ;	    so,after sysparse is done,we have to check if the entered	  *
 33039                                  ;	    values (stack_count,stack_size) are within the actual range,  *
 33040                                  ;	    (or if "0,0" pair has been entered.)			  *
 33041                                  ; input :								  *
 33042                                  ;	es:si -> parameters in command line.				  *
 33043                                  ; output:								  *
 33044                                  ;	set the variables stack_count,stack_size.			  *
 33045                                  ;									  *
 33046                                  ; subroutines to be called:						  *
 33047                                  ;	sysinit_parse							  *
 33048                                  ; logic:								  *
 33049                                  ; {									  *
 33050                                  ;	set di points to stks_parms;					  *
 33051                                  ;	set dx,cx to 0; 						  *
 33052                                  ;	while (end of command line)					  *
 33053                                  ;	{ sysinit_parse;						  *
 33054                                  ;	  if (no error) then						  *
 33055                                  ;	     { if (cx == 1) then /* first positional = stack count */	  *
 33056                                  ;		   p_stack_count = result_val._$P_picked_val;		  *
 33057                                  ;	       if (cx == 2) then /* second positional = stack size */	  *
 33058                                  ;		   p_stack_size = result_val._$P_picked_val;		  *
 33059                                  ;	     }								  *
 33060                                  ;	  else	/*error exit*/						  *
 33061                                  ;	     error exit;						  *
 33062                                  ;	};								  *
 33063                                  ;	here check p_stack_count,p_stack_size if it meets the condition;  *
 33064                                  ;	if o.k.,then set stack_count,stack_size;			  *
 33065                                  ;	 else error_exit;						  *
 33066                                  ; };									  *
 33067                                  ;**************************************************************************
 33068                                  
 33069                                  tryk:
 33070                                          ;if      stacksw
 33071                                  
 33072 00002715 80FC4B                          cmp     ah,CONFIG_STACKS ; 'K'
 33073 00002718 7402                    	je	short do_tryk
 33074                                  skip_it4:
 33075 0000271A EB79                    	jmp	short trys	; 15/12/2022
 33076                                  do_tryk:
 33077                                  
 33078                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 33079                                  ; (SYSINIT:2B33h)
 33080                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33081                                  ;%if 0
 33082                                  ;ifdef	MULTI_CONFIG
 33083 0000271C E8AA19                         call	query_user              ; query the user if config_cmd
 33084 0000271F 72F9                           jc	short skip_it4		; has the CONFIG_OPTION_QUERY bit set
 33085                                  ;endif
 33086                                  ;%endif	; 30/10/2022
 33087                                  
 33088                                  	; 14/12/2022
 33089                                  	; ds = cs
 33090                                  
 33091 00002721 BF[721E]                	mov	di,stks_parms
 33092 00002724 31C9                    	xor	cx,cx
 33093                                  	; 03/01/2023
 33094                                  	;mov	dx,cx
 33095                                  do79:
 33096 00002726 E8EB01                  	call	sysinit_parse
 33097 00002729 730B                    	jnc	short if79		; parse error
 33098                                  
 33099 0000272B BA[674B]                	mov	dx,badstack		; "invalid stack parameter"
 33100 0000272E E8D01D                  	call	print			;  and show messages and end the search loop.
 33101 00002731 E83302                  	call	error_line
 33102                                  	;jmp	sr79
 33103                                  	; 11/12/2022
 33104 00002734 EB39                    	jmp	short sr79
 33105                                  if79:
 33106 00002736 83F8FF                  	cmp	ax,_$P_RC_EOL		; end of line?
 33107 00002739 7412                    	je	short en79		; then end the $endloop
 33108                                  
 33109                                  	; 14/12/2022
 33110                                  	; ds = cs
 33111                                  
 33112                                  	;;mov	ax,[cs:rv_dword]
 33113                                  	;mov	ax,[cs:result_val+_$P_Result_Blk.Picked_Val]
 33114                                  	;mov	ax,[rv_dword]
 33115 0000273B A1[A31D]                	mov	ax,[result_val+_$P_Result_Blk.Picked_Val]
 33116                                  
 33117 0000273E 83F901                  	cmp	cx,1
 33118 00002741 7505                    	jne	short if83
 33119                                  
 33120                                  	; 14/12/2022
 33121                                  	;mov	[cs:p_stack_count],ax
 33122                                  	;jmp	short en83
 33123 00002743 A3[A71E]                	mov	[p_stack_count],ax
 33124 00002746 EBDE                    	jmp	short do79
 33125                                  if83:
 33126                                  	; 14/12/2022
 33127                                  	;mov	[cs:p_stack_size],ax
 33128 00002748 A3[A91E]                	mov	[p_stack_size],ax
 33129                                  en83:
 33130 0000274B EBD9                    	jmp	short do79
 33131                                  en79:
 33132                                  	; 14/12/2022
 33133                                  	; ds = cs
 33134 0000274D A1[A71E]                	mov	ax,[p_stack_count]
 33135 00002750 09C0                    	or	ax,ax
 33136 00002752 741E                    	jz	short if87		
 33137                                  
 33138                                  	; 14/12/2022
 33139                                  	;cmp	word [p_stack_count],0
 33140                                  	;;cmp	word [cs:p_stack_count],0
 33141                                  	;je	short if87
 33142                                  
 33143                                  	; 14/12/2022
 33144 00002754 83F808                  	cmp	ax,mincount ; 8
 33145                                  	;cmp	word [cs:p_stack_count],mincount ; 8
 33146                                  	; 15/12/2022
 33147 00002757 721F                    	jb	short en87
 33148 00002759 833E[A91E]20            	cmp	word [p_stack_size],minsize ; 32
 33149                                  	;cmp	word [cs:p_stack_size],minsize ; 32
 33150                                  	; 15/12/2022
 33151 0000275E 7218                    	jb	short en87
 33152                                  if94:
 33153                                  	; 14/12/2022
 33154                                  	; ds = cs
 33155                                  	; ax = [p_stack_count]
 33156                                  	;mov	ax,[p_stack_count]
 33157                                  	;;mov	ax,[cs:p_stack_count]
 33158 00002760 A3[8C02]                	mov	[stack_count],ax
 33159                                  	;mov	[cs:stack_count],ax
 33160                                  	;mov	ax,[cs:p_stack_size]
 33161 00002763 A1[A91E]                	mov	ax,[p_stack_size]
 33162                                  	;mov	[cs:stack_size],ax
 33163 00002766 A3[8E02]                	mov	[stack_size],ax
 33164                                  	;mov	word [cs:stack_addr],-1	; stacks= been accepted.
 33165 00002769 C706[9002]FFFF          	mov	word [stack_addr],-1
 33166                                  sr79:
 33167 0000276F E96DF9                  	jmp	coff
 33168                                  
 33169                                  if87:
 33170                                  	; 14/12/2022
 33171 00002772 3906[A91E]              	cmp	[p_stack_size],ax ; 0
 33172 00002776 74E8                    	je	short if94 ; ax = [p_stack_count] = 0
 33173                                  	;cmp	word [cs:p_stack_size],0
 33174                                  	;je	short if94
 33175                                  en87:
 33176                                  	; 15/12/2022
 33177                                  	; ([p_stack_count] is invalid, use default values)
 33178                                  	; 14/12/2022
 33179                                  	; ds = cs
 33180 00002778 C706[8C02]0900          	mov	word [stack_count],defaultcount ; 9
 33181 0000277E C706[8E02]8000          	mov	word [stack_size],defaultsize ; 128
 33182 00002784 C706[9002]0000          	mov	word [stack_addr],0
 33183                                  	;mov	word [cs:stack_count],defaultcount ; 9
 33184                                  	;				; reset to default value.
 33185                                  	;mov	word [cs:stack_size],defaultsize ; 128
 33186                                  	;mov	word [cs:stack_addr],0
 33187                                  
 33188 0000278A BA[674B]                	mov	dx,badstack
 33189 0000278D E8711D                  	call	print
 33190 00002790 E8D401                  	call	error_line
 33191 00002793 EBDA                    	jmp	short sr79
 33192                                  
 33193                                  ; 15/12/2022
 33194                                  %if 0
 33195                                  	mov	di,stks_parms
 33196                                  	xor	cx,cx
 33197                                  	; 03/01/2023
 33198                                  	;mov	dx,cx
 33199                                  do79:
 33200                                  	call	sysinit_parse
 33201                                  	jnc	short if79		; parse error
 33202                                  
 33203                                  	mov	dx,badstack		; "invalid stack parameter"
 33204                                  	call	print			;  and show messages and end the search loop.
 33205                                  	call	error_line
 33206                                  	;jmp	sr79
 33207                                  	; 11/12/2022
 33208                                  	jmp	short sr79
 33209                                  if79:
 33210                                  	cmp	ax,_$P_RC_EOL		; end of line?
 33211                                  	je	short en79		; then end the $endloop
 33212                                  
 33213                                  	;mov	ax,[cs:rv_dword]
 33214                                  	mov	ax,[cs:result_val+_$P_Result_Blk.Picked_Val]
 33215                                  	cmp	cx,1
 33216                                  	jne	short if83
 33217                                  
 33218                                  	mov	[cs:p_stack_count],ax
 33219                                  	jmp	short en83
 33220                                  if83:
 33221                                  	mov	[cs:p_stack_size],ax
 33222                                  en83:
 33223                                  	jmp	short do79
 33224                                  en79:
 33225                                  	cmp	word [cs:p_stack_count],0
 33226                                  	je	short if87
 33227                                  
 33228                                  	cmp	word [cs:p_stack_count],mincount ; 8
 33229                                  	jb	short ll88
 33230                                  	cmp	word [cs:p_stack_size],minsize ; 32
 33231                                  	jnb	short if88
 33232                                  ll88:
 33233                                  	mov	word [cs:p_stack_count],-1 ; invalid
 33234                                  if88:
 33235                                  	jmp	short en87
 33236                                  
 33237                                  	; 11/12/2022
 33238                                  if94:
 33239                                  	mov	ax,[cs:p_stack_count]
 33240                                  	mov	[cs:stack_count],ax
 33241                                  	mov	ax,[cs:p_stack_size]
 33242                                  	mov	[cs:stack_size],ax
 33243                                  	mov	word [cs:stack_addr],-1	; stacks= been accepted.
 33244                                  sr79:
 33245                                  	jmp	coff
 33246                                  
 33247                                  if87:
 33248                                  	cmp	word [cs:p_stack_size],0
 33249                                  	je	short en87
 33250                                  	mov	word [cs:p_stack_count],-1 ; invalid
 33251                                  en87:
 33252                                  	cmp	word [cs:p_stack_count],-1 ; invalid?
 33253                                  	jne	short if94
 33254                                  
 33255                                  	mov	word [cs:stack_count],defaultcount ; 9
 33256                                  					; reset to default value.
 33257                                  	mov	word [cs:stack_size],defaultsize ; 128
 33258                                  	mov	word [cs:stack_addr],0
 33259                                  
 33260                                  	mov	dx,badstack
 33261                                  	call	print
 33262                                  	call	error_line
 33263                                  	jmp	short sr79
 33264                                  
 33265                                  %endif
 33266                                  
 33267                                  ; 11/12/2022
 33268                                  %if 0 
 33269                                  if94:
 33270                                  	mov	ax,[cs:p_stack_count]
 33271                                  	mov	[cs:stack_count],ax
 33272                                  	mov	ax,[cs:p_stack_size]
 33273                                  	mov	[cs:stack_size],ax
 33274                                  	mov	word [cs:stack_addr],-1	; stacks= been accepted.
 33275                                  sr79:
 33276                                  	jmp	coff
 33277                                  %endif
 33278                                  	;endif
 33279                                  
 33280                                  ;------------------------------------------------------------------------
 33281                                  ; shell command
 33282                                  ;------------------------------------------------------------------------
 33283                                  
 33284                                  trys:
 33285 00002795 80FC53                          cmp     ah,CONFIG_SHELL ; 'S'
 33286 00002798 755A                    	jne	short tryx
 33287                                  
 33288                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 33289                                  ; (SYSINIT:2BE1h)
 33290                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33291                                  ;%if 0
 33292                                  ;ifdef	MULTI_CONFIG
 33293 0000279A E82C19                  	call	query_user              ; query the user if config_cmd
 33294 0000279D 7255                    	jc	short tryx		; has the CONFIG_OPTION_QUERY bit set
 33295                                  	;mov	byte [cs:newcmd],1
 33296                                  	; 27/09/2023
 33297 0000279F C606[D745]01            	mov	byte [newcmd],1 ; (ds = cs)
 33298                                  ;endif
 33299                                  ;%endif ; 30/10/2022
 33300                                  
 33301                                  	;;mov	word [cs:command_line],0 ; zap length,first byte of command-line
 33302                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33303                                  	;mov	byte [cs:command_line+1],0
 33304                                  	; 15/12/2022
 33305                                  	; ds = cs
 33306                                  	; 08/09/2023
 33307                                  	;mov	byte [command_line+1],0
 33308 000027A4 C706[6846]0000          	mov	word [command_line],0	; zap length,first byte of command-line
 33309                                  
 33310 000027AA BF[DB45]                        mov     di,commnd+1		; we already have the first char
 33311 000027AD 8845FF                          mov     [di-1],al               ; of the new shell in AL, save it now
 33312                                  storeshell:
 33313 000027B0 E8A91A                  	call	getchr
 33314 000027B3 08C0                            or      al,al                   ; this is the normal case: "organize"
 33315 000027B5 741C                            jz	short getshparms	; put a ZERO right after the filename
 33316                                  
 33317 000027B7 3C20                            cmp     al," "                  ; this may happen if there are no args
 33318 000027B9 7209                            jb	short endofshell	; I suppose...
 33319 000027BB 8805                    	mov	[di],al
 33320 000027BD 47                      	inc	di
 33321                                          ;cmp    di,commnd+63		; this makes sure we don't overflow
 33322                                          ;jb	short storeshell	; commnd (the filename)
 33323                                          ;jmp	short endofshell
 33324                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33325                                  	;jmp	short storeshell
 33326                                  	; 03/01/2023
 33327 000027BE 81FF[1946]              	cmp	di,commnd+63		; this makes sure we don't overflow
 33328 000027C2 72EC                            jb	short storeshell	; commnd (the filename)
 33329                                  	;jmp	short endofshell
 33330                                  
 33331                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33332                                  ;getshparms:
 33333                                  ;	mov     byte [di],0		; zero-terminate the filename
 33334                                  ;	mov     di,command_line+1	; prepare to process the command-line
 33335                                  ;
 33336                                  ;parmloop:
 33337                                  ;	call	getchr
 33338                                  ;	cmp	al," "
 33339                                  ;	jb	short endofparms
 33340                                  ;	mov	[di],al
 33341                                  ;	inc	di
 33342                                  ;	cmp     di,command_line+126
 33343                                  ;	jb	short parmloop
 33344                                  ;endofparms:
 33345                                  ;	mov     cx,di
 33346                                  ;	sub     cx,command_line+1
 33347                                  ;	mov     [cs:command_line],cl
 33348                                  ;
 33349                                  ;endofshell:
 33350                                  ;	mov     byte [di],0		; zero-terminate the filename (or
 33351                                  ;					; the command-line as the case may be)
 33352                                  ;skipline:
 33353                                  ;       cmp     al,lf	; 0Ah		; the safest way to eat the rest of
 33354                                  ;       je	short endofline		; the line: watch for ever-present LF
 33355                                  ;call	getchr
 33356                                  ;       jnc	short skipline		; keep it up as long as there are chars
 33357                                  ;
 33358                                  ;endofline:
 33359                                  ;       jmp     conflp
 33360                                  
 33361                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33362                                  endofshell:
 33363 000027C4 C60500                       	mov     byte [di],0		; zero-terminate the filename (or
 33364                                  					; the command-line as the case may be)
 33365                                  	; 11/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 33366                                  	; MSDOS 6.21 IO.SYS - SYSINIT:2C33h
 33367                                  	; PCDOS 7.1 IBMBIO.COM - SYSINIT:314Eh
 33368                                  	;call	getchr
 33369                                  skipline:		; MSDOS 6.21 IO.SYS - SYSINIT:2C33h
 33370 000027C7 3C0A                    	cmp     al,lf	; 0Ah		; the safest way to eat the rest of
 33371 000027C9 7405                    	je	short endofline		; the line: watch for ever-present LF
 33372 000027CB E88E1A                  	call	getchr
 33373                                  	; 03/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.1 IO.SYS)
 33374                                  	; (SYSINIT:2C3Ah)
 33375 000027CE 73F7                    	jnb	short skipline
 33376                                  
 33377                                  endofline:
 33378 000027D0 E9B5F8                  	jmp     conflp
 33379                                  
 33380                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33381                                  getshparms:
 33382                                  	; 18/12/2022
 33383                                  	; al = 0
 33384 000027D3 8805                    	mov	[di],al ; 0
 33385                                  	;mov	byte [di],0		; zero-terminate the filename
 33386 000027D5 BF[6946]                	mov     di,command_line+1	; prepare to process the command-line
 33387                                  parmloop:
 33388 000027D8 E8811A                  	call	getchr
 33389 000027DB 3C20                    	cmp	al," " ; 20h
 33390                                  	;jb	short endofshell
 33391                                  	; 03/01/2023
 33392 000027DD 7209                    	jb	short endofparms
 33393                                  
 33394 000027DF 8805                    	mov	[di],al
 33395 000027E1 47                      	inc	di
 33396                                  	;jmp	short parmloop
 33397                                  	; 03/01/2023 - Retro DOS v4.2
 33398 000027E2 81FF[E646]              	cmp     di,command_line+126
 33399 000027E6 72F0                    	jb	short parmloop
 33400                                  
 33401                                  	; 03/01/2023 - Retro DOS v4.2
 33402                                  endofparms:
 33403 000027E8 89F9                    	mov	cx,di
 33404 000027EA 81E9[6946]              	sub	cx,command_line+1
 33405                                  	;mov	[cs:command_line],cl
 33406                                  	; 03/01/2023
 33407 000027EE 880E[6846]              	mov	[command_line],cl
 33408 000027F2 EBD0                    	jmp	short endofshell
 33409                                  
 33410                                  ;------------------------------------------------------------------------
 33411                                  ; fcbs command
 33412                                  ;------------------------------------------------------------------------
 33413                                  
 33414                                  ;************************************************************************
 33415                                  ; function: parse the parameters of fcbs= command.			*
 33416                                  ;									*
 33417                                  ; input :								*
 33418                                  ;	es:si -> parameters in command line.				*
 33419                                  ; output:								*
 33420                                  ;	set the variables fcbs,keep.					*
 33421                                  ;									*
 33422                                  ; subroutines to be called:						*
 33423                                  ;	sysinit_parse							*
 33424                                  ; logic:								*
 33425                                  ; {									*
 33426                                  ;	set di points to fcbs_parms;					*
 33427                                  ;	set dx,cx to 0; 						*
 33428                                  ;	while (end of command line)					*
 33429                                  ;	{ sysparse;							*
 33430                                  ;	  if (no error) then						*
 33431                                  ;	     { if (cx == 1) then /* first positional = fcbs */		*
 33432                                  ;		   fcbs = result_val._$P_picked_val;			*
 33433                                  ;	       if (cx == 2) then /* second positional = keep */ 	*
 33434                                  ;		   keep = result_val._$P_picked_val;			*
 33435                                  ;	     }								*
 33436                                  ;	  else	/*error exit*/						*
 33437                                  ;	     error exit;						*
 33438                                  ;	};								*
 33439                                  ; };									*
 33440                                  ;************************************************************************
 33441                                  
 33442                                  tryx:
 33443 000027F4 80FC58                          cmp     ah,CONFIG_FCBS  ; 'X'
 33444                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 33445 000027F7 7534                    	jne	short try1
 33446                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33447                                  	;jne	short tryy	; comment command
 33448                                  
 33449                                  ; 31/12/2022 - Retro DOS v4.2
 33450                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33451                                  ;%if 0
 33452                                  ;ifdef	MULTI_CONFIG
 33453 000027F9 E8CD18                  	call	query_user      ; query the user if config_cmd
 33454 000027FC 722F                    	jc	short try1	; has the CONFIG_OPTION_QUERY bit set
 33455                                  ;endif
 33456                                  ;%endif ; 30/10/2022
 33457                                  
 33458 000027FE BF[261E]                	mov	di,fcbs_parms
 33459 00002801 31C9                    	xor	cx,cx
 33460                                  	; 03/01/2023
 33461                                  	;mov	dx,cx
 33462                                  do98:
 33463 00002803 E80E01                  	call	sysinit_parse
 33464                                          ; 03/01/2023
 33465                                  	;jnc	short if98	; parse error
 33466                                          ;call	badparm_p	;  and show messages and end the search loop.
 33467                                  	;jmp	short sr98
 33468                                  	;------------------------
 33469                                  	; 03/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 33470 00002806 723B                    	jc	short badparm_p_coff
 33471                                  if98:
 33472 00002808 83F8FF                  	cmp	ax,_$P_RC_EOL	; end of line?
 33473 0000280B 7412                    	je	short en98	; then end the $endloop
 33474                                  
 33475                                  	;;mov	al,[cs:rv_dword]
 33476                                  	;mov	al,[cs:result_val+_$P_Result_Blk.Picked_Val]
 33477                                  	; 15/12/2022
 33478                                  	; ds = cs
 33479 0000280D A0[A31D]                	mov	al,[result_val+_$P_Result_Blk.Picked_Val]
 33480 00002810 83F901                  	cmp	cx,1		; the first positional?
 33481 00002813 7505                    	jne	short if102
 33482                                  	;mov	[cs:p_fcbs],al
 33483                                  	; 15/12/2022
 33484 00002815 A2[5B1E]                	mov	[p_fcbs],al
 33485                                  	;jmp	short en102
 33486 00002818 EBE9                    	jmp	short do98
 33487                                  if102:
 33488                                  	;mov	[cs:p_keep],al
 33489                                  	; 15/12/2022
 33490 0000281A A2[5C1E]                	mov	[p_keep],al
 33491                                  en102:
 33492 0000281D EBE4                    	jmp	short do98
 33493                                  en98:
 33494                                  	; 15/12/2022
 33495                                  	; ds = cs
 33496 0000281F A0[5B1E]                	mov	al,[p_fcbs]
 33497 00002822 A2[A002]                	mov	[FCBS],al
 33498 00002825 C606[A102]00            	mov	byte [KEEP],0
 33499                                  	;mov	al,[cs:p_fcbs]	 ; M017
 33500                                  	;mov	[cs:FCBS],al	 ; M017
 33501                                  	;mov	byte [cs:KEEP],0 ; M017
 33502                                  sr98:
 33503 0000282A E9B2F8                  	jmp	coff
 33504                                  
 33505                                  ; 31/12/2022 - Retro DOS v4.2
 33506                                  %if 0
 33507                                  
 33508                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33509                                  ;-------------------------------------------------------------------------
 33510                                  ; comment= do nothing. just decrease chrptr,and increase count for correct
 33511                                  ;		line number
 33512                                  ;-------------------------------------------------------------------------
 33513                                  
 33514                                  tryy:
 33515                                  	cmp     ah,CONFIG_COMMENT ; 'Y'
 33516                                  	jne	short try0
 33517                                  
 33518                                  donothing:
 33519                                  	; 15/12/2022
 33520                                  	; ds = cs
 33521                                  	dec	word [chrptr]
 33522                                  	inc	word [count]
 33523                                  	; 02/11/2022
 33524                                  	;dec	word [cs:chrptr]
 33525                                  	;inc	word [cs:count]
 33526                                  
 33527                                  	jmp	coff
 33528                                  
 33529                                  ;------------------------------------------------------------------------
 33530                                  ; rem command
 33531                                  ;------------------------------------------------------------------------
 33532                                  
 33533                                  try0:				; do nothing with this line.
 33534                                  	cmp     ah,CONFIG_REM ; '0'
 33535                                  	je	short donothing
 33536                                  
 33537                                  %endif
 33538                                  
 33539                                  ; 07/04/2019 - Retro DOS v4.0
 33540                                  
 33541                                  ;-----------------------------------------------------------------------
 33542                                  ; switches command
 33543                                  ;-----------------------------------------------------------------------
 33544                                  
 33545                                  ;***********************************************************************
 33546                                  ;								       *
 33547                                  ; function: parse the option switches specified.		       *
 33548                                  ; note - this command is intended for the future use also.	       *
 33549                                  ; when we need to set system data flag,use this command.	       *
 33550                                  ;								       *
 33551                                  ; input :							       *
 33552                                  ;	es:si -> parameters in command line.			       *
 33553                                  ; output:							       *
 33554                                  ;	p_swit_k set if /k option chosen.			       *
 33555                                  ;								       *
 33556                                  ; subroutines to be called:					       *
 33557                                  ;	sysinit_parse						       *
 33558                                  ; logic:							       *
 33559                                  ; {								       *
 33560                                  ;	set di points to swit_parms;  /*parse control definition*/     *
 33561                                  ;	set dx,cx to 0; 					       *
 33562                                  ;	while (end of command line)				       *
 33563                                  ;	{ sysinit_parse;					       *
 33564                                  ;	  if (no error) then					       *
 33565                                  ;	       if (result_val._$P_synonym_ptr == swit_k) then	       *
 33566                                  ;		    p_swit_k = 1				       *
 33567                                  ;	       endif						       *
 33568                                  ;	  else {show error message;error exit}			       *
 33569                                  ;	};							       *
 33570                                  ; };								       *
 33571                                  ;								       *
 33572                                  ;***********************************************************************
 33573                                  
 33574                                  SUPPRESS_WINA20	EQU 00000010b	; M025 ; (DOSSYM.INC, MSDOS 6.0)
 33575                                  
 33576                                  try1:
 33577 0000282D 80FC31                          cmp     ah,CONFIG_SWITCHES ; '1'
 33578 00002830 7402                    	je	short do_try1	; switches= command entered?
 33579                                  skip_it5:
 33580                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 33581                                  	; (SYSINIT:2C8Ah)
 33582 00002832 EB7F                    	jmp	tryv
 33583                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33584                                  	;jmp	tryz
 33585                                  
 33586                                  do_try1:
 33587                                  
 33588                                  ; 31/12/2022 - Retro DOS v4.2
 33589                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33590                                  ;%if 0
 33591                                  ;ifdef	MULTI_CONFIG
 33592 00002834 E89218                  	call	query_user      ; query the user if config_cmd
 33593 00002837 72F9                    	jc	short skip_it5	; has the CONFIG_OPTION_QUERY bit set
 33594                                  ;endif
 33595                                  ;%endif ; 30/10/2022
 33596                                  
 33597 00002839 BF[C01E]                	mov	di,swit_parms
 33598 0000283C 31C9                    	xor	cx,cx
 33599                                  	; 03/01/2023
 33600                                  	;mov	dx,cx
 33601                                  do110:
 33602 0000283E E8D300                  	call	sysinit_parse
 33603 00002841 7306                    	jnc	short if110	; parse error
 33604                                  	;call	badparm_p	;  and show messages and end the search loop.
 33605                                  	;jmp	short sr110
 33606                                  	; -----------------------
 33607                                  	; 03/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 33608                                  badparm_p_coff:
 33609 00002843 E8F900                  	call	badparm_p
 33610 00002846 E996F8                  	jmp	coff
 33611                                  	;------------------------
 33612                                  if110:
 33613 00002849 83F8FF                  	cmp	ax,_$P_RC_EOL	; end of line?
 33614 0000284C 742D                    	je	short en110	; then jmp to $endloop for semantic check
 33615                                  
 33616                                  	; 15/12/2022
 33617                                  	; ds = cs
 33618                                  	;;cmp	word [cs:result_val_swoff],swit_k
 33619                                  	;cmp	word [cs:result_val+_$P_Result_Blk.SYNONYM_Ptr],swit_k 
 33620 0000284E 813E[A11D][DC1E]        	cmp	word [result_val+_$P_Result_Blk.SYNONYM_Ptr],swit_k 
 33621 00002854 7507                    	jne	short if115	;				;M059
 33622                                  	; 15/12/2022
 33623 00002856 C606[0F1F]01            	mov	byte [p_swit_k],1
 33624                                  	;mov	byte [cs:p_swit_k],1	; set the flag
 33625 0000285B EBE1                    	jmp	short do110
 33626                                  if115:	
 33627                                  	; 15/12/2022						;M059
 33628                                  	;;cmp	word [cs:result_val_swoff],swit_t
 33629                                  	;cmp	word [cs:result_val+_$P_Result_Blk.SYNONYM_Ptr],swit_t	;M059
 33630 0000285D 813E[A11D][001F]        	cmp	word [result_val+_$P_Result_Blk.SYNONYM_Ptr],swit_t
 33631 00002863 7507                    	jne	short if116					;M059 M063
 33632                                  	; 15/12/2022
 33633 00002865 C606[101F]01            	mov	byte [p_swit_t],1
 33634                                  	;mov	byte [cs:p_swit_t],1				;M059
 33635 0000286A EBD2                    	jmp	short do110					;M059
 33636                                  if116:
 33637                                  	; 15/12/2022
 33638                                  	;;cmp	word [cs:result_val_swoff],swit_w
 33639                                  	;cmp	word [cs:result_val+_$P_Result_Blk.SYNONYM_Ptr],swit_w	;M063
 33640 0000286C 813E[A11D][0C1F]        	cmp	word [result_val+_$P_Result_Blk.SYNONYM_Ptr],swit_w
 33641 00002872 75CA                    	jne	short do110					;M063
 33642                                  	; 15/12/2022
 33643 00002874 C606[111F]01            	mov	byte [p_swit_w],1
 33644                                  	;mov	byte [cs:p_swit_w],1				;M063
 33645 00002879 EBC3                    	jmp	short do110					;M063
 33646                                  en110:
 33647                                  	; 15/12/2022
 33648                                  	; ds = cs
 33649 0000287B 803E[0F1F]01            	cmp	byte [p_swit_k],1
 33650                                  	;cmp	byte [cs:p_swit_k],1	; if /k entered,
 33651 00002880 1E                      	push	ds
 33652                                  	;;mov	ax,Bios_Data
 33653                                  	;mov	ax,KERNEL_SEGMENT ; 0070h
 33654                                  	; 21/10/2022
 33655 00002881 B87000                  	mov	ax,DOSBIODATASEG ; 0070h
 33656 00002884 8ED8                    	mov	ds,ax
 33657 00002886 750A                    	jne	short if117
 33658 00002888 C606[7E04]00            	mov	byte [keyrd_func],0 ; 4E5h ; use the conventional keyboard functions
 33659 0000288D C606[7F04]01            	mov	byte [keysts_func],1 ; 4E6h (for MSDOS 6.21 IO.SYS)
 33660                                  if117:
 33661                                  	; 15/12/2022
 33662                                  	; ds <> cs
 33663 00002892 2EA0[101F]              	mov	al,[cs:p_swit_t]				;M059
 33664 00002896 A2[8B04]                	mov	[t_switch],al	; 4F2h (for MSDOS 6.21 IO.SYS)	;M059
 33665                                  
 33666 00002899 2E803E[111F]00          	cmp	byte [cs:p_swit_w],0				;M063
 33667 0000289F 740E                    	je	short skip_dos_flag				;M063
 33668 000028A1 06                      	push	es
 33669 000028A2 53                      	push	bx
 33670 000028A3 B452                    	mov	ah,GET_IN_VARS ; 52h				;M063
 33671 000028A5 CD21                    	int	21h						;M063
 33672                                  			; DOS - 2+ internal - GET LIST OF LISTS
 33673                                  			; Return: ES:BX -> DOS list of lists
 33674                                  	;or	bytes [es:86h],2
 33675 000028A7 26800E860002            	or	byte [es:DOS_FLAG_OFFSET],SUPPRESS_WINA20 ; 2	;M063
 33676 000028AD 5B                      	pop	bx
 33677 000028AE 07                      	pop	es
 33678                                  skip_dos_flag:							;M063
 33679 000028AF 1F                      	pop	ds
 33680                                  sr110:
 33681 000028B0 E92CF8                  	jmp	coff
 33682                                  
 33683                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 33684                                  ; (SYSINIT:2D14h)
 33685                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33686                                  ;%if 0
 33687                                  
 33688                                  tryv:
 33689                                  
 33690                                  ;ifdef	MULTI_CONFIG
 33691                                  ;------------------------------------------------------------------------
 33692                                  ; set command (as in "set var=value<cr/lf>")
 33693                                  ;------------------------------------------------------------------------
 33694                                  
 33695 000028B3 80FC56                  	cmp	ah,CONFIG_SET  ; 'V'
 33696 000028B6 750F                    	jne	short tryn
 33697 000028B8 E80E18                  	call	query_user      ; query the user if config_cmd
 33698 000028BB 720A                    	jc	short tryn 	; has the CONFIG_OPTION_QUERY bit set
 33699 000028BD E80514                  	call	copy_envvar     ; copy var at ES:SI to "config_wrkseg"
 33700 000028C0 73EE                    	jnc	short sr110	; no error
 33701                                  err:    
 33702 000028C2 E8A200                  	call	error_line      ; whoops, display error in line XXX
 33703 000028C5 EBE9                    	jmp	short sr110     ; jump to coff (to skip to next line)
 33704                                  
 33705                                  ;------------------------------------------------------------------------
 33706                                  ; numlock command (as in "numlock=on|off")
 33707                                  ;------------------------------------------------------------------------
 33708                                  tryn:
 33709 000028C7 80FC4E                  	cmp	ah,CONFIG_NUMLOCK  ;'N'
 33710 000028CA 750C                    	jne	short tryy      
 33711 000028CC E8FA17                  	call	query_user      ; query the user if config_cmd
 33712 000028CF 7207                    	jc	short tryy	; has the CONFIG_OPTION_QUERY bit set
 33713 000028D1 E88610                  	call	set_numlock
 33714 000028D4 72EC                    	jc	short err
 33715 000028D6 EBD8                    	jmp	short sr110	; all done
 33716                                  
 33717                                  ;endif	;MULTI_CONFIG
 33718                                  
 33719                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33720                                  ;-------------------------------------------------------------------------
 33721                                  ; comment= do nothing. just decrease chrptr,and increase count for correct
 33722                                  ;		line number
 33723                                  ;-------------------------------------------------------------------------
 33724                                  
 33725                                  	; 31/12/2022
 33726                                  tryy:
 33727 000028D8 80FC59                  	cmp     ah,CONFIG_COMMENT ; 'Y'
 33728 000028DB 750B                    	jne	short try0
 33729                                  
 33730                                  donothing:
 33731                                  	; 15/12/2022
 33732                                  	; ds = cs
 33733 000028DD FF0E[5A03]              	dec	word [chrptr]
 33734 000028E1 FF06[5603]              	inc	word [count]
 33735                                  	; 02/11/2022
 33736                                  	;dec	word [cs:chrptr]
 33737                                  	;inc	word [cs:count]
 33738                                  
 33739 000028E5 E9F7F7                  	jmp	coff
 33740                                  
 33741                                  ;------------------------------------------------------------------------
 33742                                  ; rem command
 33743                                  ;------------------------------------------------------------------------
 33744                                  
 33745                                  try0:				; do nothing with this line.
 33746 000028E8 80FC30                  	cmp     ah,CONFIG_REM ; '0'
 33747 000028EB 74F0                    	je	short donothing
 33748                                  
 33749                                  ;%endif	; 30/10/2022
 33750                                  
 33751                                  ; 30/10/2022
 33752                                  ; (MSSOS 5.0 IO.SYS - SYSINIT:29D7h)
 33753                                  
 33754                                  ;------------------------------------------------------------------------
 33755                                  ; bogus command
 33756                                  ;------------------------------------------------------------------------
 33757                                  
 33758                                  tryz:
 33759 000028ED 80FCFF                          cmp     ah,0FFh		;null command? (BUGBUG - who sets FFh anyway?)
 33760                                  	; 31/12/2022
 33761 000028F0 74EB                    	je	short donothing
 33762                                  	; 02/11/2022
 33763                                  	;je	short tryz_donothing
 33764                                  
 33765 000028F2 FF0E[5A03]              	dec	word [chrptr]
 33766 000028F6 FF06[5603]              	inc	word [count]
 33767 000028FA EB37                    	jmp	short badop
 33768                                  
 33769                                  ; 31/12/2022
 33770                                  ;	; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 33771                                  ;tryz_donothing:
 33772                                  ;	jmp	donothing
 33773                                  
 33774                                  ; 07/04/2019 - Retro DOS v4.0
 33775                                  
 33776                                  ;------------------------------------------------------------------------------
 33777                                  
 33778                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 33779                                  ; (SYSINIT:2D5Dh)
 33780                                  
 33781                                  ; 11/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 33782                                  
 33783                                  ; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 33784                                  ;
 33785                                  ;***	CheckProtmanArena -- special hack for adjusting alloclim with Protman$
 33786                                  ;
 33787                                  ;	adjusts alloclim if Protman$ reduced our arena through a manual hack.
 33788                                  ;
 33789                                  CheckProtmanArena:
 33790                                  	; 08/09/2023
 33791                                  	; ds = cs
 33792 000028FC 06                      	push	es
 33793                                  	;mov	ax,[cs:area]	; get our arena header
 33794 000028FD A1[6803]                	mov	ax,[area] ; 08/09/2023
 33795 00002900 48                      	dec	ax
 33796 00002901 8EC0                    	mov	es,ax
 33797                                  	;add	ax,[es:ARENA.SIZE]
 33798 00002903 2603060300              	add	ax,[es:3]	; find end of arena
 33799 00002908 40                      	inc	ax
 33800                                  	; 08/09/2023
 33801 00002909 3B06[A502]              	cmp	ax,[ALLOCLIM]
 33802                                  	;cmp	ax,[cs:ALLOCLIM] ; is it less than alloclim?
 33803 0000290D 7703                    	ja	short CheckProtmanDone
 33804                                  
 33805                                  	;mov	[cs:ALLOCLIM],ax ; reduce alloclim then
 33806                                  	; 08/09/2023
 33807 0000290F A3[A502]                	mov	[ALLOCLIM],ax
 33808                                  CheckProtmanDone:
 33809 00002912 07                      	pop	es
 33810 00002913 C3                      	retn
 33811                                  
 33812                                  ;------------------------------------------------------------------------------
 33813                                  
 33814                                  sysinit_parse:
 33815                                  
 33816                                  ;------------------------------------------------------------------------------
 33817                                  ;set up registers for sysparse
 33818                                  ;in)	es:si -> command line in confbot
 33819                                  ;	di -> offset of the parse control definition.
 33820                                  ;
 33821                                  ;out)	calls sysparse.
 33822                                  ;	carry will set if parse error.
 33823                                  ;	*** the caller should check the eol condition by looking at ax
 33824                                  ;	*** after each call.
 33825                                  ;	*** if no parameters are found,then ax will contain a error code.
 33826                                  ;	*** if the caller needs to look at the synomym@ of the result,
 33827                                  ;	***  the caller should use cs:@ instead of es:@.
 33828                                  ;	cx register should be set to 0 at the first time the caller calls this
 33829                                  ;	 procedure.
 33830                                  ;	ax - exit code
 33831                                  ;	bl - terminated delimeter code
 33832                                  ;	cx - new positional ordinal
 33833                                  ;	si - set to pase scanned operand
 33834                                  ;	dx - selected result buffer
 33835                                  ;------------------------------------------------------------------------------
 33836                                  
 33837                                  	; 03/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 33838                                  	; (SYSINIT:2D78h)
 33839                                  
 33840                                  	; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 33841                                  	; ds = cs
 33842 00002914 8C06[F114]              	mov	[badparm_seg],es	;save the pointer to the parm
 33843 00002918 8936[EF14]              	mov	[badparm_off],si	;we are about to parse for badparm msg.
 33844                                  
 33845                                  	; 24/10/2022
 33846 0000291C 06                      	push	es			;save es,ds
 33847 0000291D 1E                      	push	ds
 33848                                  
 33849 0000291E 06                      	push	es
 33850 0000291F 1F                      	pop	ds			;now ds:si -> command line
 33851                                  
 33852 00002920 0E                      	push	cs
 33853 00002921 07                      	pop	es			;now es:di -> control definition
 33854                                  
 33855                                  	; 09/09/2023
 33856                                  	;mov	[cs:badparm_seg],ds	;save the pointer to the parm
 33857                                  	;mov	[cs:badparm_off],si	;we are about to parse for badparm msg.
 33858                                  	
 33859                                  	;mov	dx,0
 33860                                  	; 04/01/2023
 33861 00002922 29D2                    	sub	dx,dx ; 0
 33862 00002924 E872EC                  	call	SysParse
 33863                                  	;cmp	ax,_$P_No_Error	; 0	;no error
 33864                                  	; 06/09/2023
 33865 00002927 21C0                    	and	ax,ax
 33866                                  
 33867                                  ;**cas note: when zero true after cmp, carry clear
 33868                                  
 33869                                  	;je	short ll4
 33870                                  	; 24/10/2022 (MSDOS 5.0 IO.SYS compatibility, SYSINIT:2A02h)
 33871                                  	; 12/12/2022
 33872 00002929 7405                    	je	short en4 ; cf=0
 33873 0000292B 83F8FF                  	cmp	ax,_$P_RC_EOL ; 0FFFFh	;or the end of line?
 33874                                  	;jne	short if4
 33875                                  	; 12/12/2022
 33876 0000292E 7400                    	je	short en4 ; cf=0
 33877                                  	; 06/09/2023
 33878                                  	; cf=1
 33879                                  
 33880                                  ; 12/12/2022
 33881                                  ;ll4:
 33882                                  ;	; 12/12/2022
 33883                                  ;	; cf=0
 33884                                  ;	;clc
 33885                                  ;	jmp	short en4
 33886                                  
 33887                                  if4:
 33888                                  	; 24/10/2022
 33889                                  	; 06/09/2023 (cf=1)
 33890                                  	;stc
 33891                                  en4:
 33892 00002930 1F                      	pop	ds
 33893 00002931 07                      	pop	es
 33894 00002932 C3                      	retn
 33895                                  
 33896                                  ; 11/12/2022
 33897                                  %if 0
 33898                                  
 33899                                  ;----------------------------------------------------------------------------
 33900                                  ;
 33901                                  ; procedure : badop_p
 33902                                  ;
 33903                                  ;             same thing as badop,but will make sure to set ds register back
 33904                                  ;             to sysinitseg and return back to the caller.
 33905                                  ;
 33906                                  ;----------------------------------------------------------------------------
 33907                                  
 33908                                  badop_p:
 33909                                  	push	cs
 33910                                  	pop	ds		;set ds to configsys seg.
 33911                                  	mov	dx,badopm
 33912                                  	call	print
 33913                                          ;call	error_line
 33914                                  	;retn
 33915                                  	; 11/12/2022
 33916                                  	jmp	error_line
 33917                                  
 33918                                  %endif
 33919                                  
 33920                                  ;----------------------------------------------------------------------------
 33921                                  ;
 33922                                  ; label : badop
 33923                                  ;
 33924                                  ;----------------------------------------------------------------------------
 33925                                  
 33926                                  badop:	
 33927 00002933 BA[284A]                	mov	dx,badopm	;want to print command error "unrecognized command..."
 33928 00002936 E8C81B                  	call	print
 33929 00002939 E82B00                  	call	error_line	;show "error in config.sys ..." .
 33930 0000293C E9A0F7                  	jmp	coff
 33931                                  
 33932                                  ;----------------------------------------------------------------------------
 33933                                  ;
 33934                                  ; procedure : badparm_p
 33935                                  ;
 33936                                  ;             show "bad command or parameters - xxxxxx"
 33937                                  ;             in badparm_seg,badparm_off -> xxxxx
 33938                                  ;
 33939                                  ;----------------------------------------------------------------------------
 33940                                  
 33941                                  	; 24/10/2022
 33942                                  badparm_p:
 33943                                  	; 11/12/2022
 33944                                  	; ds = cs
 33945                                  	; 11/12/2022
 33946                                  	;push	ds ; *
 33947 0000293F 52                      	push	dx
 33948 00002940 56                      	push	si
 33949                                  
 33950                                  	; 11/12/2022
 33951                                  	; ds = cs
 33952                                  	;push	cs
 33953                                  	;pop	ds
 33954                                  
 33955 00002941 BA[4F4A]                	mov	dx,badparm
 33956 00002944 E8BA1B                  	call	print			; "bad command or parameters - "
 33957 00002947 C536[EF14]              	lds	si,[badparm_ptr]
 33958                                  
 33959                                  ;	print "xxxx" until cr.
 33960                                  
 33961                                  do1:
 33962 0000294B 8A14                    	mov	dl,[si]			; get next character
 33963 0000294D 80FA0D                  	cmp	dl,cr ; 0Dh		; is a carriage return?
 33964 00002950 7407                    	je	short en1		; exit loop if so
 33965                                  
 33966 00002952 B402                    	mov	ah,2 ; STD_CON_OUTPUT	; function 2
 33967 00002954 CD21                    	int	21h			; display character
 33968 00002956 46                      	inc	si			; next character
 33969 00002957 EBF2                    	jmp	short do1
 33970                                  en1:
 33971 00002959 0E                      	push	cs
 33972 0000295A 1F                      	pop	ds
 33973                                  
 33974 0000295B BA[4C4A]                	mov	dx,crlfm
 33975 0000295E E8A01B                  	call	print
 33976 00002961 E80300                  	call	error_line
 33977                                  
 33978 00002964 5E                      	pop	si
 33979 00002965 5A                      	pop	dx
 33980                                  	; 11/12/2022
 33981                                  	;pop	ds ; *
 33982                                  badparmp_ret:
 33983 00002966 C3                      	retn
 33984                                  
 33985                                  ; 10/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 33986                                  %if 0
 33987                                  
 33988                                  ;----------------------------------------------------------------------------
 33989                                  ;
 33990                                  ; procedure : getchr
 33991                                  ;
 33992                                  ;----------------------------------------------------------------------------
 33993                                  
 33994                                  	; 24/10/2022
 33995                                  getchr:
 33996                                  	; 12/12/2022
 33997                                  	;push	cx
 33998                                  	;mov	cx,[count]
 33999                                  	;jcxz	nochar
 34000                                  	; 12/12/2022
 34001                                  	cmp	word [count],1 
 34002                                  	jb	short nochar ; cf=1 ([count] = 0)
 34003                                  	
 34004                                  	mov	si,[chrptr]
 34005                                  	mov	al,[es:si]
 34006                                  	dec	word [count]
 34007                                  	inc	word [chrptr]
 34008                                  	; 12/12/202
 34009                                  	; cf=0
 34010                                  	;clc
 34011                                  ;get_ret:
 34012                                  	;pop	cx
 34013                                  	;retn
 34014                                  nochar: 
 34015                                  	; 12/12/2022
 34016                                  	; cf=1
 34017                                  	;stc
 34018                                  	;jmp	short get_ret
 34019                                  	
 34020                                  	retn
 34021                                  
 34022                                  %endif
 34023                                  
 34024                                  ; 11/12/2022
 34025                                  %if 0
 34026                                  
 34027                                  ;----------------------------------------------------------------------------
 34028                                  ;
 34029                                  ; procedure : incorrect_order
 34030                                  ;
 34031                                  ;             show "incorrect order in config.sys ..." message.
 34032                                  ;
 34033                                  ;----------------------------------------------------------------------------
 34034                                  
 34035                                  incorrect_order:
 34036                                  	mov	dx,badorder
 34037                                  	call	print
 34038                                  	call	showlinenum
 34039                                  	retn
 34040                                  
 34041                                  %endif
 34042                                  
 34043                                  ;----------------------------------------------------------------------------
 34044                                  ;
 34045                                  ; procedure : error_line
 34046                                  ;
 34047                                  ;             show "error in config.sys ..." message.
 34048                                  ;
 34049                                  ;----------------------------------------------------------------------------
 34050                                  
 34051                                  	; 11/12/2022
 34052                                  	; 24/10/2022
 34053                                  error_line:
 34054                                  	; 11/12/2022
 34055                                  	; ds = cs
 34056                                  	;push	cs
 34057                                  	;pop	ds
 34058                                  
 34059 00002967 BA[844B]                	mov	dx,errorcmd
 34060 0000296A E8941B                  	call	print
 34061                                  	;call	showlinenum
 34062                                  	;retn
 34063                                  	; 11/12/2022
 34064                                  	;jmp	short showlinenum
 34065                                  
 34066                                  ;----------------------------------------------------------------------------
 34067                                  ;
 34068                                  ; procedure : showlinenum
 34069                                  ;
 34070                                  ; convert the binary linecount to decimal ascii string in showcount
 34071                                  ; and display showcount at the current curser position.
 34072                                  ; in.) linecount
 34073                                  ;
 34074                                  ; out) the number is printed.
 34075                                  ;
 34076                                  ;----------------------------------------------------------------------------
 34077                                  
 34078                                  	; 11/12/2022
 34079                                  	; ds = cs
 34080                                  	; 24/10/2022
 34081                                  showlinenum:
 34082 0000296D 06                      	push	es
 34083                                  	; 11/12/2022
 34084                                  	;push	ds
 34085 0000296E 57                      	push	di
 34086                                  
 34087 0000296F 0E                      	push	cs
 34088 00002970 07                      	pop	es		; es=cs
 34089                                  
 34090                                  	; 11/12/2022
 34091                                  	;push	cs
 34092                                  	;pop	ds
 34093                                  
 34094 00002971 BF[B502]                	mov	di,showcount+4	; di -> the least significant decimal field.
 34095 00002974 B90A00                  	mov	cx,10		; decimal divide factor
 34096                                  	;mov	ax,[cs:linecount]
 34097                                  	; 11/12/2022
 34098 00002977 A1[AF02]                	mov	ax,[linecount]
 34099                                  sln_loop:
 34100                                  	; 11/12/2022
 34101 0000297A 39C8                    	cmp	ax,cx ; < 10 ?
 34102                                  	;cmp	ax,10		; < 10?
 34103 0000297C 720C                    	jb	short sln_last  ; yes
 34104                                  
 34105 0000297E 31D2                    	xor	dx,dx
 34106 00002980 F7F1                    	div	cx	; cx = 10
 34107 00002982 80CA30                  	or	dl,30h		; add "0" (= 30h) to make it an ascii.
 34108                                  				; convert to ascii numeric char ("0" to "9")
 34109 00002985 8815                    	mov	[di],dl
 34110 00002987 4F                      	dec	di
 34111 00002988 EBF0                    	jmp	short sln_loop
 34112                                  
 34113                                  sln_last:
 34114 0000298A 0C30                    	or	al,30h	; "0"   ; convert to ascii numeric char ("0" to "9")
 34115 0000298C 8805                    	mov	[di],al
 34116 0000298E 89FA                    	mov	dx,di
 34117 00002990 E86E1B                  	call	print		; show it.
 34118 00002993 5F                      	pop	di
 34119                                  	; 11/12/2022
 34120                                  	;pop	ds
 34121 00002994 07                      	pop	es
 34122 00002995 C3                      	retn
 34123                                  
 34124                                  ; 07/04/2019 - Retro DOS v4.0
 34125                                  ; (MSDOS 6.21 IO.SYS, SYSINIT:2E44h)
 34126                                  
 34127                                  ;----------------------------------------------------------------------------
 34128                                  ;
 34129                                  ; procedure : ProcDOS
 34130                                  ;
 34131                                  ;	Process the result of DOS= parsing
 34132                                  ;
 34133                                  ;	result_val._$P_item_tag	= 1 for DOS=HIGH
 34134                                  ;				= 2 for DOS=LOW
 34135                                  ;				= 3 for DOS=UMB
 34136                                  ;				= 4 for DOS=NOUMB
 34137                                  ;----------------------------------------------------------------------------
 34138                                  
 34139                                  	; 01/11/2022 - Retro DOS v4.0 (Modififed MSDOS 5.0 IO.SYS)
 34140                                  	; (SYTSINIT:2AB5h)
 34141                                  ProcDOS:
 34142                                  	; 01/01/2023
 34143                                  	; ds = cs
 34144 00002996 30E4                    	xor	ah,ah
 34145                                  	;;mov	al,[cs:result_val_itag]
 34146                                  	;mov	al,[cs:result_val+_$P_Result_Blk.Item_Tag]
 34147                                  	; 01/01/2023
 34148 00002998 A0[A01D]                	mov	al,[result_val+_$P_Result_Blk.Item_Tag]
 34149 0000299B 48                      	dec	ax
 34150 0000299C 7415                    	jz	short pd_hi
 34151 0000299E 48                      	dec	ax
 34152 0000299F 740E                    	jz	short pd_lo
 34153 000029A1 48                      	dec	ax
 34154 000029A2 7405                    	jz	short pd_umb
 34155                                  	;;mov	byte [cs:DevUMB],0
 34156                                  	; 18/12/2022
 34157                                  	;mov	byte [cs:DevUMB],ah ; 0
 34158                                  	; 01/01/2023
 34159 000029A4 8826[9C1F]              	mov	byte [DevUMB],ah ; 0
 34160 000029A8 C3                      	retn
 34161                                  pd_umb:
 34162                                  	; 01/01/2023
 34163 000029A9 C606[9C1F]FF            	mov	byte [DevUMB],0FFh
 34164                                  	;mov	byte [cs:DevUMB],0FFh
 34165 000029AE C3                      	retn
 34166                                  pd_lo:
 34167                                  	; 01/01/2023
 34168 000029AF A2[6C02]                	mov	[runhigh],al ; 0
 34169                                  	; 18/12/2022
 34170                                  	;mov	[cs:runhigh],al ; 0
 34171                                  	;;mov	byte [cs:runhigh],0
 34172 000029B2 C3                      	retn
 34173                                  pd_hi:
 34174                                  	; 01/01/2023
 34175 000029B3 C606[6C02]FF            	mov	byte [runhigh],0FFh
 34176                                  	;mov	byte [cs:runhigh],0FFh
 34177                                  limx:	; 11/12/2022
 34178 000029B8 C3                      	retn
 34179                                  
 34180                                  ;----------------------------------------------------------------------------
 34181                                  ;
 34182                                  ; procedure : LieInt12Mem
 34183                                  ;
 34184                                  ;	Input : DevEntry points to Device Start address (offset == 0)
 34185                                  ;		alloclim set to the limit of low memory.
 34186                                  ;
 34187                                  ;	Output : none
 34188                                  ;
 34189                                  ;	Changes the ROM BIOS variable which stores the total low memory
 34190                                  ;	If a 3com device driver (any character device with name 'PROTMAN$')
 34191                                  ;	is being loaded alloclim is converted into Ks and stored in 40:13h
 34192                                  ;	Else if a device driver being loaded into UMB the DevLoadEnd is
 34193                                  ;	converted into Ks and stored in 40:13h
 34194                                  ;
 34195                                  ;----------------------------------------------------------------------------
 34196                                  
 34197                                  LieInt12Mem:
 34198                                  	; 11/12/2022
 34199                                  	; ds = cs
 34200 000029B9 A1[A502]                	mov	ax,[ALLOCLIM]
 34201                                  	;mov	ax,[cs:ALLOCLIM]	; lie INT 12h as alloclim
 34202                                  					; assuming that it is 3Com
 34203 000029BC E84400                  	call	IsIt3Com		; Is it 3Com driver?
 34204 000029BF 740A                    	jz	short lim_set		; yes, lie to him differently
 34205                                  	; 13/05/2019
 34206                                  	;cmp	byte [cs:DeviceHi],0	; Is the DD being loaded in UMB
 34207                                  	;je	short limx		; no, don't lie
 34208                                  	;mov	ax,[cs:DevLoadEnd]	; lie INT 12h as end of UMB
 34209                                  	; 11/12/2022
 34210                                  	; ds = cs
 34211 000029C1 803E[AB1F]00            	cmp	byte [DeviceHi],0
 34212 000029C6 74F0                    	je	short limx
 34213 000029C8 A1[911F]                	mov	ax,[DevLoadEnd]
 34214                                  lim_set:
 34215                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 34216                                  	; 11/12/2022
 34217                                  	;call	SetInt12Mem
 34218                                  ;limx:
 34219                                  	;retn
 34220                                  	
 34221                                  	;jmp	short SetInt12Mem 
 34222                                  
 34223                                  ;----------------------------------------------------------------------------
 34224                                  ;
 34225                                  ; procedure : SetInt12Mem
 34226                                  ;
 34227                                  ;	Input : AX = Memory size to be set (in paras)
 34228                                  ;	Output : none
 34229                                  ;
 34230                                  ;	Sets the variable 40:13 to the memory size passed in AX
 34231                                  ;	It saves the old value in 40:13 in OldInt12Mem,
 34232                                  ;	It also sets a flag Int12Lied to 0ffh, which is checked before
 34233                                  ;	restoring the value of 40:13
 34234                                  ;
 34235                                  ;----------------------------------------------------------------------------
 34236                                  
 34237                                  	; 01/11/2022
 34238                                  SetInt12Mem:
 34239 000029CB 1E                      	push	ds
 34240 000029CC BB4000                  	mov	bx,40h
 34241 000029CF 8EDB                    	mov	ds,bx			; ROM BIOS Data Segment
 34242 000029D1 8B1E1300                	mov	bx,[13h]		; INT 12 memory variable
 34243 000029D5 2E891E[AF1F]            	mov	[cs:OldInt12Mem],bx	; save it
 34244 000029DA B106                    	mov	cl,6
 34245 000029DC D3E8                    	shr	ax,cl			; convert paras into Ks
 34246 000029DE A31300                  	mov	[13h],ax		; Lie
 34247 000029E1 2EC606[AE1F]FF          	mov	byte [cs:Int12Lied],0FFh ; mark that we are lying
 34248 000029E7 1F                      	pop	ds
 34249                                  ;limx:
 34250 000029E8 C3                      	retn
 34251                                  
 34252                                  ;----------------------------------------------------------------------------
 34253                                  ;
 34254                                  ; procedure : TrueInt12Mem
 34255                                  ;
 34256                                  ;	Input : Int12Lied = 0 if we are not lying currently
 34257                                  ;			  = 0ffh if we are lying
 34258                                  ;		OldInt12Mem = Saved value of 40:13h
 34259                                  ;
 34260                                  ;	Output : none
 34261                                  ;
 34262                                  ;	Resets the INT 12 Memory variable if we were lying about int 12
 34263                                  ;	and resets the flag which indicates that we were lying
 34264                                  ;
 34265                                  ;----------------------------------------------------------------------------
 34266                                  
 34267                                  TrueInt12Mem:
 34268                                  	; 11/12/2022
 34269                                  	; ds = cs
 34270 000029E9 803E[AE1F]00            	cmp	byte [Int12Lied],0
 34271                                  	;cmp	byte [cs:Int12Lied],0	; were we lying so far?
 34272                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS, SYS.INIT:2B1Dh)
 34273                                  	;mov	byte [cs:Int12Lied],0	; reset it anyway
 34274 000029EE 7412                    	je	short timx		; no, we weren't
 34275                                  	; 18/12/2022
 34276 000029F0 B84000                  	mov	ax,40h
 34277 000029F3 8826[AE1F]              	mov	[Int12Lied],ah ; 0
 34278                                  	;mov	byte [Int12Lied],0
 34279                                  	;mov	byte [cs:Int12Lied],0
 34280 000029F7 1E                      	push	ds
 34281                                  	;mov	ax,40h
 34282 000029F8 8ED8                    	mov	ds,ax
 34283 000029FA 2EA1[AF1F]              	mov	ax,[cs:OldInt12Mem]
 34284 000029FE A31300                  	mov	[13h],ax		; restore INT 12h memory
 34285 00002A01 1F                      	pop	ds
 34286                                  timx:
 34287 00002A02 C3                      	retn
 34288                                  
 34289                                  ;----------------------------------------------------------------------------
 34290                                  ;
 34291                                  ; procedure : IsIt3Com?
 34292                                  ;
 34293                                  ;	Input : DevEntry = Seg:0 of device driver
 34294                                  ;	Output : Zero flag set if device name is 'PROTMAN$'
 34295                                  ;		 else Zero flag is reset
 34296                                  ;
 34297                                  ;----------------------------------------------------------------------------
 34298                                  
 34299                                  IsIt3Com:
 34300                                  	; 11/12/2022
 34301                                  	; ds = cs
 34302 00002A03 1E                      	push	ds
 34303 00002A04 06                      	push	es
 34304 00002A05 56                      	push	si
 34305                                  	; 11/12/2022
 34306 00002A06 C536[931F]              	lds	si,[DevEntry]
 34307                                  	;lds	si,[cs:DevEntry]	; ptr to device header
 34308 00002A0A 83C60A                  	add	si,SYSDEV.NAME ; 10 	; ptr device name
 34309 00002A0D 0E                      	push	cs
 34310 00002A0E 07                      	pop	es
 34311 00002A0F BF[B11F]                	mov	di,ThreeComName
 34312 00002A12 B90800                  	mov	cx,8			; name length
 34313 00002A15 F3A6                    	rep	cmpsb
 34314 00002A17 5E                      	pop	si
 34315 00002A18 07                      	pop	es
 34316 00002A19 1F                      	pop	ds
 34317 00002A1A C3                      	retn
 34318                                  
 34319                                  ;M020 : BEGIN
 34320                                  ;----------------------------------------------------------------------------
 34321                                  
 34322                                  UpdatePDB:
 34323 00002A1B 1E                      	push	ds
 34324 00002A1C B462                    	mov	ah,62h
 34325 00002A1E CD21                    	int	21h	; DOS - 3+ - GET PSP ADDRESS
 34326 00002A20 8EDB                    	mov	ds,bx
 34327 00002A22 2E8B1E[A502]            	mov	bx,[cs:ALLOCLIM]
 34328                                  	;mov	[2],bx
 34329 00002A27 891E0200                	mov	[PDB.BLOCK_LEN],bx
 34330 00002A2B 1F                      	pop	ds
 34331 00002A2C C3                      	retn
 34332                                  
 34333                                  ; M020 : END
 34334                                  
 34335                                  ;----------------------------------------------------------------------------
 34336                                  
 34337                                  ; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 34338                                  ;%if 0
 34339                                  
 34340                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 34341                                  ; (SYSINIT:2EEEh)
 34342                                  
 34343                                  ;include highload.inc	; Routines for devicehigh parsing, control of HIDDEN
 34344                                  ;include highexit.inc	; umb's, etc
 34345                                  
 34346                                  ; ----------------------------------------------------------------------
 34347                                  ; HIGHLOAD.INC (MSDOS 6.0 - 1991) 	
 34348                                  ; ----------------------------------------------------------------------
 34349                                  ; 07/04/2019 - Retro DOS v4.0
 34350                                  
 34351                                  ;******************************************************************************
 34352                                  ;
 34353                                  ; This file contains routines needed to parse and implement user-given
 34354                                  ; command-line options of the form "/S/L:3,0x500;2;7,127;0x0BE4". InitVar()
 34355                                  ; and Parsevar() are used to parse this data and place it in encoded form into
 34356                                  ; the variables in highvar.inc, for use by the rest of the routines.
 34357                                  ;
 34358                                  ; DeviceHigh accepts this command-line (handled in sysconf.asm, not here):
 34359                                  ;    DEVICEHIGH SIZE=hhhhhh module opts
 34360                                  ; Or, DeviceHigh and LoadHigh accept any of the following:
 34361                                  ;    DH/LH module opts
 34362                                  ;    DH/LH [/S][/L:umb[,size][;umb[,size]]*] module opts
 34363                                  ;    DH/LH [/L:umb[,size][;umb[,size]]*][/S] module opts
 34364                                  ; The initial UMB,SIZE pair designates the module's load address; the remainder
 34365                                  ; of the UMB and SIZE pairs are used to indicate specific UMBs to be left
 34366                                  ; available during the load.
 34367                                  ;
 34368                                  ; When an actual load is ready to be performed, a call to HideUMBs() will
 34369                                  ; temporarily allocate (as owner 8+"HIDDEN  ") all free elements in any
 34370                                  ; upper-memory block which was not specified by the user... in addition, if
 34371                                  ; UMBs were marked to shrink (/S option) to a certain size ("umb,size"), any
 34372                                  ; elements in that umb SAVE the lower-half of the newly-shrunken one are also
 34373                                  ; allocated. After the load, the function UnHideUMBs() (in highexit.inc) will
 34374                                  ; free any UMBs so allocated.
 34375                                  ;
 34376                                  ; When a device driver loads, there is the additional problem of allocating its
 34377                                  ; initial load site; this should be restricted to the first UMB specified on
 34378                                  ; the command-line. The function FreezeUM temporarily allocates all remaining
 34379                                  ; free upper-memory elements (as owner 8+"FROZEN  "), except those in the load
 34380                                  ; UMB. Then the initial allocation may be made, and a call to UnFreeze will
 34381                                  ; return any so-allocated memory elements to FREE, for the true load. Note
 34382                                  ; that UnFreeze leaves HIDDEN elements allocated; it only frees FROZEN ones.
 34383                                  ;
 34384                                  ;******************************************************************************
 34385                                  
 34386                                  SWTCH	equ	'/'		; Switch character
 34387                                  
 34388                                  DOS_CHECK_STRATEGY  equ	5800h	; Int 21h, Func 58h, Svc 0 = check alloc strat
 34389                                  DOS_SET_STRATEGY    equ	5801h	; Int 21h, Func 58h, Svc 1 = set alloc strategy
 34390                                  DOS_CHECK_UMBLINK   equ	5802h	; Int 21h, Func 58h, Svc 2 = check link state
 34391                                  DOS_GET_UMBLINK	    equ 5802h ; 20/04/2019
 34392                                  DOS_SET_UMBLINK     equ	5803h	; Int 21h, Func 58h, Svc 3 = set link state
 34393                                  DOS_GET_DOS_LISTS   equ	  52h	; Int 21h, Func 52h = return list of lists
 34394                                  DOS_UMB_HEAD        equ	  8Ch	; Offset from ES (after func52h) to get UMBHead
 34395                                  
 34396                                  CR	equ	0Dh		; Carriage Return
 34397                                  LF	equ	0Ah		; Line Feed
 34398                                  TAB	equ	09h		; Tab character (^I)
 34399                                  
 34400                                  ; -----------------------------------------------------------------------------
 34401                                  ;*** InitVar - initializes all the variables used in ParseVar and HideUMBs
 34402                                  ; -----------------------------------------------------------------------------
 34403                                  ; ENTRY:       None
 34404                                  ; EXIT:        Variables listed in highvar.inc are initialized
 34405                                  ; ERROR EXIT:  None
 34406                                  ; USES:        Flags, variables in highvar.inc
 34407                                  ; -----------------------------------------------------------------------------
 34408                                  ; Note that element 0 references UMB 0 (conventional), not UMB 1. Its contents
 34409                                  ; are largely ignored, but it is initialized nonetheless.
 34410                                  ; -----------------------------------------------------------------------------
 34411                                  
 34412                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 34413                                  ; (SYSINIT:2EEEh)
 34414                                  
 34415                                  InitVar:
 34416                                  	; 01/01/2023
 34417                                  	; ds = cs
 34418                                  
 34419                                  	;pushreg <ax, cx, di, es>
 34420                                  	; 03/01/2023
 34421                                  	;push	ax
 34422                                  	;push	cx
 34423                                  	;push	di
 34424 00002A2D 06                      	push	es
 34425                                  
 34426                                  	;dataseg es			;Point ES into appropriate data segment
 34427 00002A2E 0E                      	push	cs
 34428 00002A2F 07                      	pop	es
 34429                                  
 34430 00002A30 31C0                    	xor	ax,ax
 34431                                  	;mov	[es:fUmbTiny],al	;Shrink UMBs? (made 1 if /S given)
 34432                                  	;mov	[es:fInHigh],al		;Set to 1 when DH/LH has been called
 34433                                  	;mov	[es:SegLoad],ax		;Load Address (seg), used for DH only
 34434                                  	;mov	byte [es:UmbLoad],UNSPECIFIED ; 0FFh
 34435                                  	;				;Later is the # of the 1st spec'd UMB
 34436                                  	;mov	[es:fm_argc], al	;Start with zero args having been read
 34437                                  
 34438                                  	; 01/01/2023
 34439                                  	; ds = cs
 34440 00002A32 A2[561F]                	mov	[fUmbTiny],al		;Shrink UMBs? (made 1 if /S given)
 34441 00002A35 A2[551F]                	mov	[fInHigh],al		;Set to 1 when DH/LH has been called
 34442 00002A38 A3[571F]                	mov	[SegLoad],ax		;Load Address (seg), used for DH only
 34443 00002A3B C606[591F]FF            	mov	byte [UmbLoad],UNSPECIFIED ; 0FFh
 34444                                  					;Later is the # of the 1st spec'd UMB
 34445 00002A40 A2[8C1F]                	mov	[fm_argc], al		;Start with zero args having been read
 34446                                  
 34447 00002A43 FC                      	cld
 34448                                  
 34449 00002A44 B91000                  	mov	cx,MAXUMB ; 16		;For each entry
 34450 00002A47 BF[5A1F]                	mov	di,UmbUsed		;on the UmbUsed array,
 34451 00002A4A F3AA                    	rep	stosb			;	Store 0
 34452                                  
 34453                                  	;mov	cx,MAXUMB ; 16		;Okay... for each entry
 34454                                  	; 01/01/2033
 34455 00002A4C B110                    	mov	cl,MAXUMB ; 16
 34456 00002A4E BF[6A1F]                	mov	di,UmbSize		;on the UmbSize array,
 34457 00002A51 F3AB                    	rep	stosw			;	Store 0
 34458                                  
 34459                                  	;normseg es			; Return ES
 34460                                  
 34461                                  	;popreg	<es, di, cx, ax>
 34462 00002A53 07                      	pop	es
 34463                                  	; 03/01/2023
 34464                                  	;pop	di
 34465                                  	;pop	cx
 34466                                  	;pop	ax	 	
 34467                                  
 34468 00002A54 C3                      	retn
 34469                                  
 34470                                  ; -----------------------------------------------------------------------------
 34471                                  ;*** FixMem - scans the upper memory chain and concatenates adjacent free MCBs
 34472                                  ; -----------------------------------------------------------------------------
 34473                                  ; ENTRY   : None
 34474                                  ; EXIT    : None
 34475                                  ; ERROR   : None
 34476                                  ; USES    : Flags, fm_umb, fm_strat
 34477                                  ; -----------------------------------------------------------------------------
 34478                                  
 34479                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 34480                                  	; (SYSINIT:2F22h)
 34481                                  FixMem:
 34482                                  	; 01/01/2023
 34483                                  	;push	ax
 34484                                  	;push	bx
 34485                                  	;push	cx
 34486                                  	;push	dx
 34487 00002A55 06                      	push	es
 34488                                  
 34489 00002A56 E84900                  	call	fm_link		; Link in UMBs
 34490                                  
 34491 00002A59 E80002                  	call	UmbHead		; Get first upper-memory MCB address (0x9FFF)
 34492 00002A5C 723F                    	jc	short fmX	; (if couldn't get it, leave now).
 34493                                  
 34494 00002A5E 8EC0                    	mov	es,ax		; It returns in AX, so move it to ES.
 34495                                  
 34496                                  ; - Walk MCB Chain ------------------------------------------------------------
 34497                                  
 34498 00002A60 31D2                    	xor	dx,dx		; We're keeping the address of the last MCB
 34499 00002A62 89D1                    	mov 	cx,dx		; in CX... and the last owner
 34500 00002A64 42                      	inc	dx		; in dx as we go through the loop:
 34501                                  
 34502                                  ; ------------------------------------------
 34503                                  ; FM10--DX  = last MCB's owner's PSP address
 34504                                  ;       CX  = last MCB's address (segment)
 34505                                  ; ------------------------------------------
 34506                                  
 34507 00002A65 26A00000                fm10:	mov	al,[es:ARENA.SIGNATURE] ; if 'Z', don't repeat loop
 34508 00002A69 268B1E0100              	mov	bx,[es:ARENA.OWNER]	; if not zero, do nothing
 34509 00002A6E 09D3                    	or	bx,dx			; dx was owner of previous MCB
 34510 00002A70 7516                    	jnz	short fm30		; If not both zero, don't cat.
 34511                                  
 34512                                  	; - Coalesce memory blocks at ES:00 and CX:00 -------------------------
 34513                                  
 34514 00002A72 268B1E0300              fm20:	mov	bx,[es:ARENA.SIZE]	; Grab this block's Size,
 34515 00002A77 8EC1                    	mov	es,cx			; Go back to prev MCB's address
 34516 00002A79 26A20000                	mov	[es:ARENA.SIGNATURE],al ; & move the SECOND sig here
 34517                                  
 34518 00002A7D 26031E0300              	add	bx,[es:ARENA.SIZE]	; Size += first MCB's size
 34519                                  	;add	bx,1			; And add one for the header
 34520                                  	; 11/07/2023
 34521 00002A82 43                      	inc	bx
 34522 00002A83 26891E0300              	mov	[es:ARENA.SIZE],bx	; Write the size
 34523                                  
 34524                                  	; ---------------------------------------------------------------------
 34525                                  
 34526 00002A88 8CC1                    fm30:	mov	cx,es			; Save MCB address
 34527 00002A8A 268B160100              	mov	dx,[es:ARENA.OWNER]	; And remember its owner
 34528                                  
 34529 00002A8F 8CC3                    	mov	bx,es			; Move to the next MCB
 34530                                  	;add	bx,[es:3]
 34531 00002A91 26031E0300              	add	bx,[es:ARENA.SIZE]
 34532 00002A96 43                      	inc	bx
 34533 00002A97 8EC3                    	mov	es,bx
 34534                                  
 34535                                  	;cmp	al,'Z'
 34536 00002A99 3C5A                    	cmp	al,arena_signature_end
 34537 00002A9B 75C8                    	jne	short fm10		; If signature != 'Z', there are more.
 34538                                  fmX:	
 34539 00002A9D E81300                  	call	fm_unlink		; Unlink UMBs
 34540                                  
 34541 00002AA0 07                      	pop	es
 34542                                  	; 01/01/2023
 34543                                  	;pop	dx
 34544                                  	;pop	cx
 34545                                  	;pop	bx
 34546                                  	;pop	ax
 34547                                  
 34548 00002AA1 C3                      	retn
 34549                                  
 34550                                  ; -----------------------------------------------------------------------------
 34551                                  ;*** fm_link - links UMBs not already linked in
 34552                                  ; -----------------------------------------------------------------------------
 34553                                  ; ENTRY:    None
 34554                                  ; EXIT:     fm_umb == 0 if not linked in previously, 1 if already linked in
 34555                                  ; ERROR:    None
 34556                                  ; USES:     AX, BX, fm_umb
 34557                                  ; -----------------------------------------------------------------------------
 34558                                  
 34559                                  	; 01/01/2023 - Retro DOS v4.2
 34560                                  fm_link:
 34561 00002AA2 B80258                  	mov	ax,DOS_CHECK_UMBLINK ; 5802h
 34562 00002AA5 CD21                    	int	21h			; Current link-state is now in al
 34563                                  
 34564                                  	;putdata fm_umb,al		; So store it in fm_umb for later
 34565                                  	;
 34566                                  	;push	es
 34567                                  	;push	cs
 34568                                  	;pop	es
 34569                                  	;mov	[es:fm_umb],al
 34570                                  	;pop	es
 34571                                  	
 34572                                  	; 01/01/2023
 34573                                  	; ds = cs
 34574                                  	;mov	[cs:fm_umb],al
 34575 00002AA7 A2[8A1F]                	mov	[fm_umb],al
 34576                                  
 34577 00002AAA B80358                  	mov	ax,DOS_SET_UMBLINK ; 5803h
 34578 00002AAD BB0100                  	mov	bx,1
 34579 00002AB0 CD21                    	int	21h
 34580 00002AB2 C3                      	retn
 34581                                  
 34582                                  ; -----------------------------------------------------------------------------
 34583                                  ;*** fm_unlink - unlinks UMBs if fm_umb is set to 0
 34584                                  ; -----------------------------------------------------------------------------
 34585                                  ; ENTRY:    fm_umb == 1 : leave linked, else unlink
 34586                                  ; EXIT:     None
 34587                                  ; ERROR:    None
 34588                                  ; USES:     AX, BX
 34589                                  ; -----------------------------------------------------------------------------
 34590                                  
 34591                                  	; 01/01/2023 - Retro DOS v4.2
 34592                                  fm_unlink:
 34593 00002AB3 31DB                    	xor	bx,bx
 34594                                  	
 34595                                  	;getdata bl,fm_umb		; fm_umb already has the old link-state
 34596                                  	;
 34597                                  	;push	ds
 34598                                  	;push	cs
 34599                                  	;pop	ds
 34600                                  	;mov	bl,[fm_umb]	
 34601                                  	;pop	ds
 34602                                  	
 34603                                  	; 01/01/2023
 34604                                  	; ds = cs
 34605                                  	;mov	bl,[cs:fm_umb]
 34606 00002AB5 8A1E[8A1F]              	mov	bl,[fm_umb]
 34607                                  
 34608 00002AB9 B80358                  	mov	ax,DOS_SET_UMBLINK ; 5803h
 34609 00002ABC CD21                    	int	21h			; so just use that, and call int 21h
 34610 00002ABE C3                      	retn
 34611                                  
 34612                                  ; 08/04/2019 - Retro DOS v4.0
 34613                                  
 34614                                  ; -----------------------------------------------------------------------------
 34615                                  ;*** ParseVar - parses [/S][/L:umb[,size][;umb[,size]]*] and builds the table
 34616                                  ; laid out in highvar.inc
 34617                                  ; -----------------------------------------------------------------------------
 34618                                  ; ENTRY:    ES:SI points to command tail of LoadHigh/DeviceHigh (whitespace ok)
 34619                                  ; EXIT:     ES:SI points to first character in child program name
 34620                                  ; ERROR:    ES:SI points to character which caused error, carry set, AX == code
 34621                                  ; USES:     ES:SI, AX, flags, variables in highvar.inc
 34622                                  ; -----------------------------------------------------------------------------
 34623                                  ; Error codes (in AX if carry set on return):
 34624                                  ;
 34625                                  PV_InvArg	equ	1	; Invalid argument passed
 34626                                  PV_BadUMB	equ	2	; Bad UMB number passed (duplicate?)
 34627                                  PV_InvSwt	equ	3	; Unrecognized switch passed
 34628                                  ;
 34629                                  ; This routine exects ES:SI to point to a string much like the following:
 34630                                  ;    "/S/L:1,200;2 module options"
 34631                                  ; Optionally, the string can begin with whitespace; neither /S nor /L is
 34632                                  ; required, though that's what this routine is supposed to parse.
 34633                                  ;
 34634                                  optS		equ	'S'	; /S
 34635                                  optL		equ	'L'	; /L:...
 34636                                  ;
 34637                                  ; -----------------------------------------------------------------------------
 34638                                  ; LoadHigh has a list of arguments, returned by cparse, which is used to create
 34639                                  ; a command-line for spawning a child process. For a typical LH command, say,
 34640                                  ;     lh /l:1,1000;2 print/d:lpt2
 34641                                  ; the arguments would look like (one per line):
 34642                                  ;     lh
 34643                                  ;     /l
 34644                                  ;     1
 34645                                  ;     1000
 34646                                  ;     2
 34647                                  ;     print
 34648                                  ;     /d
 34649                                  ;     :lpt2
 34650                                  ; In short, if "print" were, say, "43", there'd be no way to determine which
 34651                                  ; arg was the filename. So, inside this routine, we keep a running counter
 34652                                  ; of the number of arguments LH will need to skip in order to get to the
 34653                                  ; program name. The "lh" is implicit--it'll always have to skip that. So if
 34654                                  ; there's no "/l" or "/s", fm_argc will be 0 ... other than that, 1 is added
 34655                                  ; for:
 34656                                  ;    Each /L
 34657                                  ;    Each /S (there should be only one)
 34658                                  ;    Each UMB number (they follow ":" or ";")
 34659                                  ;    Each UMB size   (they follow ",")
 34660                                  ; So, in the above example, fm_argc would be 4-- and LH would skip right to
 34661                                  ; "print".  Note that InitVar initializes fm_argc to zero.
 34662                                  ; -----------------------------------------------------------------------------
 34663                                  
 34664                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 34665                                  	; (SYSINIT:2F9Fh)
 34666                                  
 34667                                  ParseVar:
 34668                                  	;pushreg <di, ds, es>
 34669                                  	; 01/01/2023
 34670                                  	;push	di ; * ; (not required) ; 01/01/2023
 34671 00002ABF 1E                      	push	ds
 34672 00002AC0 06                      	push	es
 34673                                  
 34674 00002AC1 06                      	push	es		; Make DS:SI point to it, as well as ES:SI
 34675 00002AC2 1F                      	pop	ds		; (regardless if we're in devhigh or loadhigh)
 34676 00002AC3 FC                      	cld
 34677                                  
 34678                                  ; ------------------------------------------------
 34679                                  ; PV10--ES:SI = any whitespace on the command-line
 34680                                  ; ------------------------------------------------
 34681                                  
 34682 00002AC4 AC                      pv10:	lodsb			; here, ES:SI=="  /L..."--must eat whitespace
 34683 00002AC5 E8A200                  	call	isWhite
 34684 00002AC8 74FA                    	jz	short pv10	;       ES:SI==" /L..."--keep eating.
 34685                                  	;cmp	al,'/'
 34686 00002ACA 3C2F                    	cmp	al,SWTCH
 34687 00002ACC 7404                    	je	short pv20	;       ES:SI=="/L..."--go process a switch
 34688                                  
 34689 00002ACE 4E                      	dec	si		; Backup--it's now "odule options", and we need
 34690 00002ACF F8                      	clc			; that "m" we just read (or whatever it is).
 34691 00002AD0 EB2B                    	jmp	short pvX	; Then return with carry clear == we're done.
 34692                                  pv20:	
 34693 00002AD2 AC                      	lodsb			; Just read 'S' or 'L', hopefully
 34694                                  	;toUpper al		; So we make it upper-case, and...
 34695 00002AD3 24DF                    	and	al,0DFh
 34696                                  	;cmp	al,'S'
 34697 00002AD5 3C53                    	cmp	al,optS		; just read 'S'?
 34698 00002AD7 750D                    	jne	short pv30
 34699                                  
 34700                                  	;call	incArgc		; If it's /S, it's another arg for LH to skip.
 34701 00002AD9 2EFE06[8C1F]            	inc	byte [cs:fm_argc] ; 19/04/2019
 34702                                  
 34703                                  	;putdata fUmbTiny,1	; /S, so ES:SI=="  /L..." or " module opts", or
 34704                                  	;
 34705                                  	;push	es
 34706                                  	;push	cs
 34707                                  	;pop	es
 34708                                  	;mov	[es:fUmbTiny],1	
 34709                                  	;pop	es
 34710                                  
 34711 00002ADE 2EC606[561F]01          	mov	byte [cs:fUmbTiny],1
 34712                                  
 34713 00002AE4 EBDE                    	jmp	short pv10	; possibly even "/L...".
 34714                                  
 34715                                  pv30:	;cmp	al,'L'
 34716 00002AE6 3C4C                    	cmp	al,optL		; If it's not 'L' either, then it's a bad
 34717 00002AE8 750D                    	jne	short pvE1	; switch!
 34718                                  
 34719                                  	;call	incArgc		; If it's /L, it's another arg for LH to skip.
 34720 00002AEA 2EFE06[8C1F]            	inc	byte [cs:fm_argc] ; 19/04/2019
 34721                                  
 34722 00002AEF E80E00                  	call	parseL
 34723 00002AF2 73D0                    	jnc	short pv10	; If no carry, go back and look for more
 34724                                  
 34725 00002AF4 4E                      	dec	si		; Else, back up and exit.
 34726 00002AF5 EB03                    	jmp	short pvErr	; AX has already been set by parseL
 34727                                  
 34728                                  pvE1:	;mov	ax,3
 34729 00002AF7 B80300                  	mov	ax,PV_InvSwt	; Unrecognized switch passed
 34730 00002AFA 4E                      pvErr:	dec	si
 34731 00002AFB 4E                      	dec	si
 34732 00002AFC F9                      	stc
 34733                                  pvX:	;popreg	<es, ds, di>
 34734 00002AFD 07                      	pop	es
 34735 00002AFE 1F                      	pop	ds
 34736                                  	; 01/01/2023
 34737                                  	;pop	di ; * ; (not required) ; 01/01/2023
 34738 00002AFF C3                      	retn
 34739                                  
 34740                                  ; -----------------------------------------------------------------------------
 34741                                  ;*** parseL - parses ":nnnn[,nnnn][;nnnn[,nnnn]]*" for ParseVar
 34742                                  ; -----------------------------------------------------------------------------
 34743                                  ; ENTRY:    ES:SI points to colon
 34744                                  ; EXIT:     ES:SI points to first character not parsed
 34745                                  ; ERROR:    Carry set; rewind three characters and return (see ParseVar)
 34746                                  ; USES:     ES:SI, flags, AX, CX, DX, variables in highvar.inc
 34747                                  ; -----------------------------------------------------------------------------
 34748                                  ; If the string here is terminated with anything other than whitespace or a
 34749                                  ; switchchar (perhaps it's /S or another /L:... ), then we return with carry
 34750                                  ; set, indicating that they've screwed up the syntax. The 3-character rewind
 34751                                  ; makes sure the app /L: is reported as being the culprit.
 34752                                  ; -----------------------------------------------------------------------------
 34753                                  
 34754                                  parseL:
 34755 00002B00 AC                      	lodsb
 34756 00002B01 3C3A                    	cmp	al,':'		; Make sure they did /L:
 34757 00002B03 754E                    	jne	short plE1	; If they didn't, return with carry set.
 34758                                  
 34759                                  ; ------------------------------------------
 34760                                  ; PL10--ES:SI = a UMB number, after /L: or ;
 34761                                  ; ------------------------------------------
 34762                                  
 34763 00002B05 E8DB00                  pl10:	call	GetXNum		; After this, it's ",size" or ";umb" or " mod"
 34764 00002B08 724F                    	jc	short plE2	; And error if it's a bad number.
 34765 00002B0A E89D01                  	call	convUMB		; Convert any address to a UMB number
 34766                                  
 34767 00002B0D 88C1                    	mov	cl,al		; Remember the UMB number
 34768 00002B0F E87600                  	call	stowUMB		; Mark this UMB # as used;
 34769 00002B12 7245                    	jc	short plE2	; If it was already marked, it'll error
 34770                                  
 34771                                  	;call	incArgc		; Each UMB number is another arg for LH to skip
 34772 00002B14 2EFE06[8C1F]            	inc	byte [cs:fm_argc] ; 08/04/2019 - Retro DOS v4.0
 34773                                  
 34774 00002B19 AC                      	lodsb
 34775 00002B1A 3C3B                    	cmp	al,';'		; Did "umb;" ?
 34776 00002B1C 74E7                    	je	short pl10	; Yep: go back and get another UMB.
 34777                                  
 34778 00002B1E E84900                  	call	isWhite		; Did "umb " ?
 34779 00002B21 743B                    	jz	short plX	; Yep: return (it'll go back to whitespace)
 34780                                  
 34781 00002B23 E83900                  	call	isEOL		; Did "umb" ?
 34782 00002B26 7435                    	jz	short plSwX	; If so, backup and exit like everything's ok
 34783                                  
 34784                                  	;cmp	al,'/'
 34785 00002B28 3C2F                    	cmp	al,SWTCH 	; Did "umb/" ? (as in, "/L:1,100;2/S")
 34786 00002B2A 7431                    	je	short plSwX	; If so, back up ES:SI one character and return
 34787                                  
 34788 00002B2C 3C2C                    	cmp	al,','		; Did "umb," ?
 34789 00002B2E 7523                    	jne	short plE1	; Just what the heck DID they do? Return error.
 34790                                  
 34791                                  ; --- Read a size -------------------------------------------------------------
 34792                                  
 34793 00002B30 E8B000                  	call	GetXNum		; Stop on "size;" or "size " or anything else
 34794 00002B33 721E                    	jc	short plE1	; And error if it's a bad size.
 34795                                  
 34796 00002B35 E81601                  	call	toPara		; Convert from bytes to paragraphs
 34797                                  
 34798 00002B38 E8CE01                  	call	stowSiz		; CL still has the UMB number for this routine
 34799                                  
 34800                                  	;call	incArgc		; Each UMB size is another arg for LH to skip
 34801 00002B3B 2EFE06[8C1F]            	inc	byte [cs:fm_argc] ; 08/04/2019 - Retro DOS v4.0
 34802                                  
 34803 00002B40 AC                      	lodsb
 34804 00002B41 3C3B                    	cmp	al,';'		; They did "umb,size;", so get another UMB.
 34805 00002B43 74C0                    	je	short pl10	;
 34806                                  
 34807 00002B45 E82200                  	call	isWhite		; Did it end with whitespace?
 34808 00002B48 7414                    	jz	short plX	; If so, we're done here--go back.
 34809                                  
 34810 00002B4A E81200                  	call	isEOL		; Did they do "umb,size" and end??? (stupid)
 34811 00002B4D 740E                    	jz	short plSwX	; If so, backup and exit like everything's ok
 34812                                  
 34813                                  	;cmp	al,'/'
 34814 00002B4F 3C2F                    	cmp	al,SWTCH	; Did they do "umb,size/" ?
 34815 00002B51 740A                    	je	short plSwX	; If so, again, we're done here.
 34816                                  plE1:	
 34817                                  	;mov	ax,1
 34818 00002B53 B80100                  	mov	ax,PV_InvArg	; If not, we don't know WHAT they did...
 34819 00002B56 4E                      	dec	si
 34820 00002B57 F9                      	stc
 34821 00002B58 C3                      	retn
 34822                                  
 34823                                  plE2:	;mov	ax,2
 34824 00002B59 B80200                  	mov	ax,PV_BadUMB	; In this case, they've specified a UMB twice
 34825                                  	; 12/12/2022
 34826                                  	; cf=1
 34827                                  	;stc
 34828 00002B5C C3                      	retn
 34829                                  plSwX:	
 34830 00002B5D 4E                      	dec	si		; If we hit a '/' character, back up one char
 34831                                  				; so the whitespace checker will see it too.
 34832                                  plX:	; 12/12/2022
 34833                                  	; cf=0
 34834                                  	;clc			; Then just return with carry clear, so
 34835 00002B5E C3                      	retn			; ParseVar will go about its business.
 34836                                  
 34837                                  ; -----------------------------------------------------------------------------
 34838                                  ;*** incArgc - increments fm_argc, for use with LoadHigh command-line parsing
 34839                                  ; -----------------------------------------------------------------------------
 34840                                  ; ENTRY:    None
 34841                                  ; EXIT:     None
 34842                                  ; ERROR:    None
 34843                                  ; USES:     fm_argc, flags
 34844                                  ; -----------------------------------------------------------------------------
 34845                                  
 34846                                  ;incArgc:
 34847                                  	;push	ax
 34848                                  
 34849                                  	;;getdata al, fm_argc	; Obtain previous value of fm_argc,
 34850                                  
 34851                                  	;mov	al,[cs:fm_argc]
 34852                                  
 34853                                  	;inc	al		; Increment it,
 34854                                  
 34855                                  	;;putdata fm_argc, al	; And store it right back.
 34856                                  
 34857                                  	;mov	[cs:fm_argc],al
 34858                                  
 34859                                  	;pop	ax
 34860                                  	;retn
 34861                                  
 34862                                  ; -----------------------------------------------------------------------------
 34863                                  ;*** isEOL - returns with ZF set if AL contains CR or LF, or 0
 34864                                  ; -----------------------------------------------------------------------------
 34865                                  ; ENTRY:    AL contains character to test
 34866                                  ; EXIT:     ZF set if AL contains CR or LF, or 0
 34867                                  ; ERROR:    None
 34868                                  ; USES:     ZF
 34869                                  ; -----------------------------------------------------------------------------
 34870                                  
 34871                                  isEOL:
 34872 00002B5F 3C00                    	cmp	al,0		; Null-terminator
 34873 00002B61 7406                    	je	short ieX
 34874 00002B63 3C0D                    	cmp	al,CR ; 0Dh	; Carriage Return
 34875 00002B65 7402                    	je	short ieX
 34876 00002B67 3C0A                    	cmp	al,LF ; 0Ah	; LineFeed
 34877                                  ieX:	
 34878 00002B69 C3                      	retn
 34879                                  
 34880                                  ; -----------------------------------------------------------------------------
 34881                                  ;*** isWhite - returns with ZF set if AL contains whitespace (or "=")
 34882                                  ; -----------------------------------------------------------------------------
 34883                                  ; ENTRY:    AL contains character to test
 34884                                  ; EXIT:     ZF set if AL contains space, tab, or equals
 34885                                  ; ERROR:    None
 34886                                  ; USES:     ZF
 34887                                  ; -----------------------------------------------------------------------------
 34888                                  
 34889                                  isWhite:
 34890 00002B6A 3C20                    	cmp	al,' '		; Space
 34891 00002B6C 7406                    	je	short iwX
 34892 00002B6E 3C3D                    	cmp	al,'='		; Equals (treat as whitespace)
 34893 00002B70 7402                    	je	short iwX
 34894 00002B72 3C09                    	cmp	al,tab ; 9	; Tab
 34895                                  iwX:	
 34896 00002B74 C3                      	retn
 34897                                  
 34898                                  ; -----------------------------------------------------------------------------
 34899                                  ;*** unMarkUMB - marks a given UMB as unused, even if previously marked used
 34900                                  ; -----------------------------------------------------------------------------
 34901                                  ; ENTRY:    AL contains UMB number
 34902                                  ; EXIT:     None
 34903                                  ; ERROR:    None
 34904                                  ; USES:     Flags, variables in highvar.inc
 34905                                  ; -----------------------------------------------------------------------------
 34906                                  
 34907                                  	; 02/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 34908                                  
 34909                                  unMarkUMB:
 34910                                  	; 02/01/2023
 34911                                  	;push	ax
 34912                                  	;push	bx
 34913                                  	;push	di
 34914                                  	;push	es
 34915                                  	;
 34916                                  	;push	cs
 34917                                  	;pop	es
 34918                                  
 34919 00002B75 30E4                    	xor	ah,ah
 34920 00002B77 89C3                    	mov	bx,ax
 34921                                  
 34922                                  	; 19/04/2019
 34923                                  	
 34924                                  	;;mov	byte [es:bx+UmbUsed],0
 34925                                  	;mov	[es:bx+UmbUsed],ah ; 0
 34926                                  	; 02/01/2023
 34927                                  	; ds= cs
 34928                                  	;mov	[cs:bx+UmbUsed],ah ; 0
 34929 00002B79 88A7[5A1F]              	mov	[bx+UmbUsed],ah ; 0
 34930                                  
 34931 00002B7D 3806[591F]              	cmp	[UmbLoad],al
 34932                                  	;cmp	[cs:UmbLoad],al
 34933                                  	;;cmp	[es:UmbLoad],al
 34934 00002B81 7504                    	jne	short umu10
 34935                                  
 34936                                  	;;mov	[es:UmbLoad],0	; If unmarked the load UMB, load into convent.
 34937                                  	;mov	[es:UmbLoad],ah ; 0
 34938                                  	; 02/01/2023
 34939                                  	; ds = cs
 34940                                  	;mov	[cs:UmbLoad],ah ; 0
 34941 00002B83 8826[591F]              	mov	[UmbLoad],ah ; 0
 34942                                  umu10:	
 34943                                  	;pop	es
 34944                                  	;pop	di
 34945                                  	;pop	bx
 34946                                  	;pop	ax
 34947 00002B87 C3                      	retn
 34948                                  
 34949                                  ; -----------------------------------------------------------------------------
 34950                                  ;*** stowUMB - marks a given UMB as used, if it hasn't been so marked before
 34951                                  ;            -- accepts a UMB # in AL, and makes sure it hasn't yet been
 34952                                  ; listed in the /L:... chain. If it's the first one specified, it sets UmbLoad
 34953                                  ; to that UMB #... and in any case, it marks the UMB as specified.
 34954                                  ; -----------------------------------------------------------------------------
 34955                                  ; ENTRY:    AL contains UMB number, as specified by the user
 34956                                  ; EXIT:     None
 34957                                  ; ERROR:    Carry set if UMB # is less than 0 or >= MAXUMB (see highvar.inc)
 34958                                  ; USES:     AX, Flags, variables in highvar.inc
 34959                                  ; -----------------------------------------------------------------------------
 34960                                  
 34961                                  	; 01/01/2023 - Retro DOS v4.2
 34962                                  stowUMB:
 34963 00002B88 3C10                    	cmp	al,MAXUMB ; 16
 34964 00002B8A 7202                    	jb	short su10
 34965 00002B8C F9                      	stc
 34966 00002B8D C3                      	retn			; Ooops-- UMB # >= MAXUMB
 34967                                  su10:	
 34968                                  	; 01/01/2023
 34969                                  	;push	bx
 34970                                  	;push	di
 34971                                  	;push	si
 34972                                  	;push	ds
 34973                                  	;push	es
 34974                                  	;push	cs
 34975                                  	;pop	es
 34976                                  	;push	cs
 34977                                  	;pop	ds
 34978                                  
 34979                                  	; 01/01/2023
 34980                                  	; ds <> cs
 34981                                  	;cmp	byte [cs:UmbLoad],0FFh
 34982 00002B8E 2E803E[591F]FF          	cmp	byte [cs:UmbLoad],UNSPECIFIED
 34983                                  				; If this, we haven't been here before
 34984 00002B94 7504                    	jne	short su20
 34985 00002B96 2EA2[591F]              	mov	[cs:UmbLoad],al	; So remember this UMB as the load UMB slot.
 34986                                  
 34987                                  	;;cmp	byte [UmbLoad],0FFh
 34988                                  	;cmp	byte [UmbLoad],UNSPECIFIED ; If this, we haven't been here before
 34989                                  	;jne	short su20
 34990                                  	;mov	[UmbLoad],al	; So remember this UMB as the load UMB slot.
 34991                                  su20:	
 34992 00002B9A 08C0                    	or	al,al		; If they gave UMB 0, there's really nothing
 34993 00002B9C 740E                    	jz	short su30	; that we should do here.
 34994                                  
 34995                                  	;mov	bl,al
 34996                                  	;xor	bh,bh
 34997                                  	;mov	ax,1		; Now, AX = 1, and BX = UMB Number
 34998                                  	; 01/01/2023
 34999 00002B9E 30E4                    	xor	ah,ah
 35000 00002BA0 89C3                    	mov	bx,ax
 35001 00002BA2 B001                    	mov	al,1
 35002                                  
 35003                                  	;xchg	[es:bx+UmbUsed],al
 35004                                  	; 01/01/2023
 35005 00002BA4 2E8687[5A1F]            	xchg	[cs:bx+UmbUsed],al
 35006                                  
 35007                                  	;or	al,al		; If it was already 1, then al==1... and that
 35008                                  	;jz	short su30	; means an error.
 35009                                  	;
 35010                                  	;stc			; OOOPS! This one's been used before. :(
 35011                                  	
 35012                                  	; 01/01/2023
 35013 00002BA9 3C01                    	cmp	al,1
 35014 00002BAB F5                      	cmc 	; if al > 0 -> cf = 1
 35015                                  su30:	
 35016                                  	; 01/01/2023
 35017                                  	;pop	es
 35018                                  	;pop	ds
 35019                                  	;pop	si
 35020                                  	;pop	di
 35021                                  	;pop	bx
 35022 00002BAC C3                      	retn
 35023                                  
 35024                                  ; 08/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 35025                                  %if 0
 35026                                  ; -----------------------------------------------------------------------------
 35027                                  ;*** stowSiz - marks a given UMB as having a given minimum size
 35028                                  ; -----------------------------------------------------------------------------
 35029                                  ; ENTRY:    CL contains UMB number, AX contains size
 35030                                  ; EXIT:     None
 35031                                  ; ERROR:    None
 35032                                  ; USES:     AX, DX, Flags, variables in highvar.inc
 35033                                  ; -----------------------------------------------------------------------------
 35034                                  
 35035                                  ; 13/05/2019
 35036                                  
 35037                                  	; 01/01/2023 - Retro DOS v4.2
 35038                                  stowSiz:
 35039                                  	; 01/01/2023
 35040                                  	;push	bx
 35041                                  	;;push	di ; ?
 35042                                  	;push	es
 35043                                  
 35044                                  	;push	cs
 35045                                  	;pop	es	
 35046                                  
 35047                                  	mov	bl,cl			; Now bl==UMB number, AX==size
 35048                                  	mov	bh,0			;     bx==UMB number, AX==size
 35049                                  	shl	bl,1			;     bx==offset into array, AX=size
 35050                                  	;mov	[es:bx+UmbSize],ax	; Store the size
 35051                                  	; 01/01/2023
 35052                                  	mov	[cs:bx+UmbSize],ax	; Store the size
 35053                                  
 35054                                  	; 01/01/2023
 35055                                  	;pop	es
 35056                                  	;;pop	di ; ?
 35057                                  	;pop	bx
 35058                                  
 35059                                  	retn
 35060                                  %endif
 35061                                  
 35062                                  ; -----------------------------------------------------------------------------
 35063                                  ;*** toDigit - converts a character-digit to its binary counterpart
 35064                                  ;            -- verifies that CL contains a valid character-digit; if so, it
 35065                                  ; changes CL to its counterpart binary digit ((CL-'0') or (CL-'A'+10)).
 35066                                  ; A-F are considered valid if gnradix is 16.
 35067                                  ; -----------------------------------------------------------------------------
 35068                                  ; ENTRY:    CL contains a digit ('0' to '9' or, if gnradix==16, 'A' to 'F')
 35069                                  ; EXIT:     CL contains digit in binary (0 to 9 or, if gnradix==16, 0 to 15)
 35070                                  ; ERROR:    Carry set indicates invalid digit; carry clear indicates good digit
 35071                                  ; USES:     CL, Flags
 35072                                  ; -----------------------------------------------------------------------------
 35073                                  ; If the string is preceeded with "0x", the value is read as hexadecimal; else,
 35074                                  ; as decimal. After a read, you may check the radix by examining gnradix--it
 35075                                  ; will be 10 or 16.
 35076                                  ; -----------------------------------------------------------------------------
 35077                                  
 35078                                  gnradix:
 35079 00002BAD 0000                    	dw	0		; Must be a word--16x16 multiplication
 35080                                  
 35081                                  toDigit:
 35082 00002BAF 2E833E[AD2B]10          	cmp	word [cs:gnradix],16
 35083 00002BB5 751C                    	jne	short td20	; Don't check hex digits if radix isn't 16
 35084                                  
 35085                                  toDigit_hex:
 35086 00002BB7 80F961                  	cmp	cl,'a'	; 61h
 35087 00002BBA 7209                    	jb	short td10
 35088 00002BBC 80F966                  	cmp	cl,'f'	; 66h
 35089 00002BBF 7720                    	ja	short tdE	; Nothing valid above 'f' at all...
 35090 00002BC1 80E957                  	sub	cl,'a'-10 ; 57h	; Make 'a'==10 and return.
 35091                                  	;clc			; <- CLC is implicit from last SUB
 35092 00002BC4 C3                      	retn
 35093                                  td10:	
 35094 00002BC5 80F941                  	cmp	cl,'A'  ; 41h
 35095 00002BC8 7209                    	jb	short td20	; Below 'A'? Not a letter...
 35096 00002BCA 80F946                  	cmp	cl,'F'	; 46h
 35097 00002BCD 7712                    	ja	short tdE	; Above 'F'? Not a digit.
 35098 00002BCF 80E937                  	sub	cl,'A'-10 ; 37h	; Make 'A'==10 and return.
 35099                                  	;clc			; <- CLC is implicit from last SUB
 35100 00002BD2 C3                      	retn
 35101                                  toDigit_dec:
 35102                                  td20:	
 35103 00002BD3 80F930                  	cmp	cl,'0'		; If less than zero,
 35104                                  	;jb	short tdE	; Done.
 35105 00002BD6 720A                    	jb	short tdEr ; 08/04/2019
 35106 00002BD8 80F939                  	cmp	cl,'9'		; Or, if greater than nine,
 35107 00002BDB 7704                    	ja	short tdE	; Done.
 35108 00002BDD 80E930                  	sub	cl,'0'	; 30h	; Okay--make '0'==0 and return.
 35109                                  	;clc			; <- CLC is implicit from last SUB
 35110 00002BE0 C3                      	retn
 35111                                  tdE:	
 35112 00002BE1 F9                      	stc
 35113                                  tdEr:		; 08/04/2019 - Retro DOS v4.0	
 35114 00002BE2 C3                      	retn
 35115                                  
 35116                                  ; -----------------------------------------------------------------------------
 35117                                  ;*** GetXNum - reads a 32-bit ASCII number at ES:SI and returns it in DX:AX
 35118                                  ; -----------------------------------------------------------------------------
 35119                                  ; ENTRY:    ES:SI points to an ascii string to scan
 35120                                  ; EXIT:     ES:SI moved to first invalid digit, DX:AX contains value read
 35121                                  ; ERROR:    Carry set if # is too big, or has no digits (EOL possibly)
 35122                                  ; USES:     ES:SI, DX, AX, Flags, gnradix
 35123                                  ; -----------------------------------------------------------------------------
 35124                                  ; If the string is preceeded with "0x", the value is read as hexadecimal; else,
 35125                                  ; as decimal. After a read, you may check the radix by examining gnradix--it
 35126                                  ; will be 10 or 16.
 35127                                  ; -----------------------------------------------------------------------------
 35128                                  
 35129                                  ; 08/04/2019 - Retro DOS v4.0
 35130                                  
 35131                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 35132                                  ; (SYSINIT:3109h)
 35133                                  
 35134                                  GetXNum:
 35135                                  	;pushreg <bx, cx, ds>
 35136                                  	; 01/01/2023
 35137                                  	;push	bx
 35138 00002BE3 51                      	push	cx ; *
 35139                                  	;push	ds
 35140                                  
 35141 00002BE4 FC                      	cld
 35142 00002BE5 31C0                    	xor	ax,ax
 35143 00002BE7 31DB                    	xor	bx,bx
 35144 00002BE9 31C9                    	xor	cx,cx
 35145 00002BEB 31D2                    	xor	dx,dx			; Start with 0 (makes sense)
 35146                                  
 35147 00002BED 2EC706[AD2B]0A00        	mov	word [cs:gnradix],10	; And default to a radix of 10 (dec)
 35148                                  
 35149 00002BF4 268A0C                  	mov	cl,[es:si]		; Now AX=0, BX=0, CH=0/CL=char, DX=0
 35150                                  	;call	toDigit
 35151 00002BF7 E8D9FF                  	call	toDigit_dec
 35152                                  	;jc	short gxnE		; If it's not a digit, leave now.
 35153                                  	; 01/01/2023
 35154 00002BFA 7233                    	jc	short gxnX
 35155                                  
 35156 00002BFC 08C9                    	or	cl,cl
 35157 00002BFE 7517                    	jnz	short gxn20		; Doesn't have '0x'
 35158 00002C00 268A4C01                	mov	cl,[es:si+1]
 35159 00002C04 80F978                  	cmp	cl,'x'			; Either 'x'...
 35160 00002C07 7405                    	je	short gxn10
 35161 00002C09 80F958                  	cmp	cl,'X'			; ...or 'X' means it's hexadecimal
 35162 00002C0C 7509                    	jne	short gxn20
 35163                                  
 35164                                  gxn10:	
 35165 00002C0E 2EC706[AD2B]1000        	mov	word [cs:gnradix], 16
 35166 00002C15 46                      	inc	si			; Since we read "0x", march over it.
 35167 00002C16 46                      	inc	si
 35168                                  
 35169                                  ; ------------------------------------------------------
 35170                                  ; GXN20--ES:SI = a digit in a number; if not, we're done
 35171                                  ;        DX:AX = current total
 35172                                  ;        BX    = 0
 35173                                  ;        CH    = 0
 35174                                  ; ------------------------------------------------------
 35175                                  
 35176                                  gxn20:	
 35177 00002C17 268A0C                  	mov	cl,[es:si]	; Now DX:AX=current total, CH=0/CL=char
 35178 00002C1A 46                      	inc	si
 35179                                  
 35180 00002C1B E891FF                  	call	toDigit		; Accepts only valid digits, A-F -> 10-16
 35181 00002C1E 720D                    	jc	short gxnQ	; <- Ah... wasn't a digit. Stop.
 35182                                  
 35183 00002C20 E80E00                  	call	mul32		; Multiply DX:AX by gnradix
 35184 00002C23 720A                    	jc	short gxnX	; (if it's too big, error out)
 35185                                  
 35186 00002C25 01C8                    	add	ax,cx		; Add the digit
 35187 00002C27 11DA                    	adc	dx,bx		; (BX is 0!)--Adds 1 if last add wrapped
 35188                                  	;jc	short gxnX	; If _that_ wrapped, it's too big.
 35189                                  	;jmp	short gxn20
 35190 00002C29 73EC                    	jnc	short gxn20
 35191                                  gxnE:	
 35192                                  	;stc			; In this case, we need to set the carry
 35193 00002C2B EB02                    	jmp	short gxnX	; and leave--there were no digits given.
 35194                                  gxnQ:	
 35195 00002C2D 4E                      	dec	si		; Don't read in the offensive character.
 35196 00002C2E F8                      	clc			; And clear carry, so they know it's okay.
 35197                                  gxnX:	
 35198                                  	; 01/01/2023
 35199                                  	;pop	ds
 35200 00002C2F 59                      	pop	cx ; *
 35201                                  	;pop	bx
 35202 00002C30 C3                      	retn
 35203                                  
 35204                                  ; -----------------------------------------------------------------------------
 35205                                  ;*** mul32 - multiplies the number in DX:AX by gnradix
 35206                                  ; -----------------------------------------------------------------------------
 35207                                  ; ENTRY:   DX:AX = the number to be multiplied, BX = 0, gnradix = multiplier
 35208                                  ; EXIT:    DX:AX has been multiplied by gnradix if carry clear; BX still 0
 35209                                  ; ERROR:   Carry set if number was too large
 35210                                  ; USES:    Flags, AX, DX
 35211                                  ; -----------------------------------------------------------------------------
 35212                                  
 35213                                  mul32:
 35214 00002C31 50                      	push	ax		; DX=old:hi, AX=old:lo, TOS=old:lo, BX=0
 35215 00002C32 89D0                    	mov	ax,dx		; DX=old:hi, AX=old:hi, TOS=old:lo, BX=0
 35216 00002C34 2EF726[AD2B]            	mul	word [cs:gnradix] ; DX=?, AX=new:hi, TOS=old:lo, BX=0
 35217 00002C39 7211                    	jc	short m32E	; Too big?
 35218                                  
 35219 00002C3B 89C2                    	mov	dx,ax		; DX=new:hi, AX=new:hi, TOS=old:lo, BX=0
 35220 00002C3D 58                      	pop	ax		; DX=new:hi, AX=old:lo, TOS=orig, BX=0
 35221                                  
 35222 00002C3E 87D3                    	xchg	dx,bx		; DX=0, AX=old:lo, TOS=orig, BX=new:hi
 35223 00002C40 2EF726[AD2B]            	mul	word [cs:gnradix] ; DX=carry, AX=new:lo, TOS=orig, BX=new:hi
 35224 00002C45 87D3                    	xchg	dx,bx		; DX=new:hi, AX=new:lo, TOS=orig, BX=carry
 35225 00002C47 01DA                    	add	dx,bx		; DX=new:hi, AX=new:lo, TOS=orig, BX=carry
 35226 00002C49 31DB                    	xor	bx,bx		; DX=new:hi, AX=new:lo, TOS=orig, BX=0
 35227 00002C4B C3                      	retn
 35228                                  m32E:	
 35229 00002C4C 58                      	pop	ax
 35230 00002C4D C3                      	retn
 35231                                  
 35232                                  ; -----------------------------------------------------------------------------
 35233                                  ;*** toPara - divides DX:AX by 16; result in AX only (discards extra DX data)
 35234                                  ; -----------------------------------------------------------------------------
 35235                                  ; ENTRY:   DX:AX = the number to be divided
 35236                                  ; EXIT:    Interpereting DX:AX as bytes, AX=paragraph equivalent, 0xFFFF max
 35237                                  ; ERROR:   None
 35238                                  ; USES:    Flags, AX, DX
 35239                                  ; -----------------------------------------------------------------------------
 35240                                  ; Note: The 386 has a 32-bit SHR, which would work perfectly for this... but we
 35241                                  ;       can't ensure a 386 host machine. Sorry.
 35242                                  ; -----------------------------------------------------------------------------
 35243                                  
 35244                                  	; 01/01/2023 - Retro DOS v4.2
 35245                                  toPara:
 35246 00002C4E 51                      	push	cx		; DX:AX=HHHH hhhh hhhh hhhh:LLLL llll llll llll
 35247                                  
 35248 00002C4F B104                    	mov	cl,4		;
 35249 00002C51 D3E8                    	shr	ax,cl		; DX:AX=HHHH hhhh hhhh hhhh:0000 LLLL llll llll
 35250 00002C53 92                      	xchg	ax,dx		; DX:AX=0000 LLLL llll llll:HHHH hhhh hhhh hhhh
 35251 00002C54 B10C                    	mov	cl,12
 35252 00002C56 D3E0                    	shl	ax,cl		; DX:AX=0000 LLLL llll llll:hhhh 0000 0000 0000
 35253 00002C58 09D0                    	or	ax,dx		;    AX=hhhh LLLL llll llll
 35254                                  
 35255 00002C5A 59                      	pop	cx
 35256 00002C5B C3                      	retn
 35257                                  
 35258                                  ; -----------------------------------------------------------------------------
 35259                                  ;*** UmbHead - returns in AX the address of the first UMB block (0x9FFF)
 35260                                  ; -----------------------------------------------------------------------------
 35261                                  ; ENTRY:  Nothing
 35262                                  ; EXIT:   AX contains 0x9FFF for most systems
 35263                                  ; ERROR:  Carry set if pointer is 0xFFFF (if not set up yet--DH runs into this)
 35264                                  ; USES:   Flags, AX
 35265                                  ; -----------------------------------------------------------------------------
 35266                                  ; Early in the boot-cycle, the pointer used to obtain this value isn't set up;
 35267                                  ; to be precise, before a UMB provider is around. In this event, the pointer
 35268                                  ; is always set to 0xFFFF; it changes once a provider is around. On most
 35269                                  ; machines (all of 'em I've seen), it changes to 0x9FFF at that point.
 35270                                  ; -----------------------------------------------------------------------------
 35271                                  
 35272                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 35273                                  UmbHead:
 35274                                  	; 13/05/2019 (because of callers, pushs & pops are not needed here)
 35275                                  
 35276                                  	;push	si ; ?
 35277                                  	;push	ds ; ? 
 35278                                  	;push	es
 35279                                  	;push	bx ; *	
 35280                                  
 35281                                  	; 09/04/2019
 35282                                  	; !!! No need to save es,bx,ds,si above !!! (es,bx are changed here)
 35283                                  
 35284 00002C5C B452                    	mov	ah,GET_IN_VARS		; Call int 21h, function 52h...
 35285 00002C5E CD21                    	int	21h
 35286                                  
 35287 00002C60 26A18C00                	mov	ax,[es:DOS_UMB_HEAD]	; And read what's in ES:[008C]
 35288                                  	
 35289                                  	; 01/01/2023
 35290 00002C64 83F8FF                  	cmp	ax,0FFFFh
 35291 00002C67 F5                      	cmc
 35292                                  	; if AX=0FFFFh -> CF=1
 35293 00002C68 C3                      	retn
 35294                                  
 35295                                  ; 01/01/2023
 35296                                  ;%if 0
 35297                                  ;	cmp	ax,0FFFFh
 35298                                  ;	je	short uhE		; If it's 0xFFFF, it's an error...
 35299                                  ;
 35300                                  ;	clc				; Else, it isn't (CLC done by prev cmp)
 35301                                  ;	;jmp	short uhX
 35302                                  ;	; 12/12/2022
 35303                                  ;	retn
 35304                                  ;uhE:	
 35305                                  ;	stc
 35306                                  ;uhX:	
 35307                                  ;	;pop	bx ; *
 35308                                  ;	;pop	es
 35309                                  ;	;pop	ds ; ?
 35310                                  ;	;pop	si ; ?
 35311                                  ;	retn
 35312                                  ;%endif
 35313                                  
 35314                                  ; -----------------------------------------------------------------------------
 35315                                  ;*** isSysMCB - sets ZF if ES points to an MCB owned by "SC" + (8 or 9)
 35316                                  ; -----------------------------------------------------------------------------
 35317                                  ; ENTRY:  ES:0 should point to a valid MCB
 35318                                  ; EXIT:   ZF set if owned by SC+8 or SC+9 (for japan)
 35319                                  ; USES:   Flags
 35320                                  ; -----------------------------------------------------------------------------
 35321                                  
 35322                                  isSysMCB:
 35323                                  	;push	ax
 35324                                  
 35325                                  	;mov	ax,[es:ARENA.OWNER]	; Check the owner...
 35326                                  	;cmp	ax,SystemPSPOwner	; 8 (for US OR Japan) is valid
 35327                                  	;je	short ism10
 35328                                  	;cmp	ax,JapanPSPOwner	; 9 (for Japan) is valid
 35329                                  	;;je	short ism10
 35330                                  	;;jmp	short ismX		; Anything else isn't.
 35331                                  	;jne	short ismX
 35332 00002C69 26833E010008            	cmp	word [es:ARENA.OWNER],SystemPSPOwner ; 8  ; 09/04/2019
 35333 00002C6F 7507                    	jne	short ismX 
 35334                                  ism10:	
 35335                                  	;mov	ax,[es:ARENA.NAME]	; Check the name...
 35336                                  	;cmp	ax,'SC' ; 4353h
 35337 00002C71 26813E08005343          	cmp	word [es:ARENA.NAME],'SC'
 35338                                  ismX:	
 35339                                  	;pop	ax
 35340 00002C78 C3                      	retn
 35341                                  
 35342                                  ; 09/04/2019 - Retro DOS v4.0
 35343                                  
 35344                                  ; -----------------------------------------------------------------------------
 35345                                  ;*** AddrToUmb - converts a segment address in AX to its appropriate UMB number
 35346                                  ; -----------------------------------------------------------------------------
 35347                                  ; ENTRY:  AX contains a segment address
 35348                                  ; EXIT:   AX will contain the UMB number which contains the address (0==conv)
 35349                                  ; ERROR:  If the address is above UM Range, AX will return as FFFF.
 35350                                  ; USES:   Flags, AX
 35351                                  ; -----------------------------------------------------------------------------
 35352                                  ; An address in the following areas is treated as:
 35353                                  ;    0      <-> umbhead (0x9FFF)          = Conventional memory
 35354                                  ;    0x9FFF <-> addr of first UM sys MCB  = UMB #1
 35355                                  ;      ...
 35356                                  ;    addr of last UM sys MCB <-> TOM      = invalid; returns #0xFFFF
 35357                                  ; -----------------------------------------------------------------------------
 35358                                  
 35359                                  	; 01/01/2023 - Retro DOS v4.2
 35360                                  AddrToUmb:
 35361                                  	; 01/01/2023
 35362                                  	;push	cx
 35363                                  	;push	dx
 35364 00002C79 06                      	push	es
 35365                                  
 35366 00002C7A 89C2                    	mov	dx,ax		; DX = address to search for
 35367                                  
 35368 00002C7C E8DDFF                  	call	UmbHead		; AX = first segment
 35369 00002C7F 7222                    	jc	short atuE	; If it couldn't get it, error out.
 35370                                  
 35371                                  	; 22/07/2023
 35372                                  	;mov	es,ax ; *	; ES = first UMB segment
 35373 00002C81 31C9                    	xor	cx,cx ; 0	; Pretend we're on UMB 0 for now... (cx = UMB#)
 35374                                  
 35375                                  	; 22/07/2023
 35376                                  atu10:
 35377 00002C83 8EC0                    	mov	es,ax ; * ; ** ; 22/07/2023
 35378                                  ; ----------------------------------------
 35379                                  ; ATU10--ES - Current MCB address
 35380                                  ;        DX - Address given for conversion
 35381                                  ;        CX - Current UMB #
 35382                                  ; ----------------------------------------
 35383                                  
 35384                                  ;atu10:	
 35385                                  	;mov	ax,es ; * ; 18/07/2023
 35386 00002C85 39D0                            cmp	ax,dx		; Present segment >= given segment?
 35387 00002C87 731D                    	jae	short atuX	; Yep--done.
 35388                                  
 35389 00002C89 E8DDFF                  	call	isSysMCB	; Returns with ZF set if this is a system MCB
 35390 00002C8C 7501                    	jnz	short atu20
 35391                                  
 35392 00002C8E 41                      	inc	cx		; If it _was_ a system MCB, we're in a new UMB.
 35393                                  atu20:	
 35394                                  	;mov	al,[es:ARENA.SIGNATURE]
 35395                                  	;cmp	al,arena_signature_end  ; 'Z'
 35396                                  	; 22/07/2023
 35397                                  	; ax = es
 35398                                  	;mov	ax,es ; **
 35399 00002C8F 2603060300              	add	ax,[es:ARENA.SIZE]
 35400 00002C94 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],arena_signature_end
 35401 00002C9A 7403                    	je	short atu30		; 'Z' means this was the last MCB... that's it.
 35402                                  
 35403                                  	;NextMCB es,ax
 35404                                  
 35405                                  	;mov	ax,es ; **
 35406                                  	;;add	ax,[es:3]
 35407                                  	;add	ax,[es:ARENA.SIZE]
 35408 00002C9C 40                      	inc	ax
 35409                                  	; 22/07/2023
 35410                                  	;mov	es,ax ; *
 35411 00002C9D EBE4                    	jmp	short atu10
 35412                                  
 35413                                  ; -----------------------------------------------------------------------------
 35414                                  ; if we get to atu30, they specified a number that was past the last MCB.
 35415                                  ; make sure it's not _inside_ that MCB before we return an error condition.
 35416                                  ; -----------------------------------------------------------------------------
 35417                                  
 35418                                  atu30:	
 35419                                  	; 22/07/2023
 35420                                  	; ax = es + [es:ARENA.SIZE] 
 35421                                  	;mov	ax,es ; **
 35422                                  	;add	ax,[es:ARENA.SIZE] ; **
 35423 00002C9F 39D0                    	cmp	ax,dx		; Present >= given?
 35424 00002CA1 7303                    	jae	short atuX	; Yep! It _was_ inside.
 35425                                  atuE:	
 35426 00002CA3 31C9                    	xor	cx,cx ; 0	; Else, fall through with UMB # == -1
 35427 00002CA5 49                      	dec	cx		; (that makes it return 0xFFFF and sets CF)
 35428                                  atuX:	
 35429 00002CA6 89C8                    	mov	ax,cx		; Return the UMB number in AX
 35430                                  	
 35431 00002CA8 07                      	pop	es	
 35432                                  	; 01/01/2023
 35433                                  	;pop	dx
 35434                                  	;pop	cx
 35435 00002CA9 C3                      	retn
 35436                                  
 35437                                  ; -----------------------------------------------------------------------------
 35438                                  ;*** convUMB - checks after GetXNum to convert an address to a UMB number
 35439                                  ;            -- if GetXNum read a hex number, we interperete that as a segment
 35440                                  ; address rather than a UMB number... and use that address to look up a UMB.
 35441                                  ; This routine checks for that condition and calls AddrToUmb if necessary.
 35442                                  ; -----------------------------------------------------------------------------
 35443                                  ; ENTRY:  AX contains a UMB number or segment, gnradix has been set by GetXNum
 35444                                  ; EXIT:   AX will contain a UMB number
 35445                                  ; ERROR:  None
 35446                                  ; USES:   Flags, AX
 35447                                  ; -----------------------------------------------------------------------------
 35448                                  
 35449                                  	; 01/01/2023 - Retro DOS v4.2
 35450                                  convUMB:
 35451 00002CAA 2E833E[AD2B]10          	cmp	word [cs:gnradix],16
 35452 00002CB0 7507                    	jne	short cu10	; If it didn't read in hex, it's not an address
 35453 00002CB2 E8C4FF                  	call	AddrToUmb	; Else, convert the address to a UMB number
 35454                                  	;cmp	ax,0FFFFh
 35455                                  	;jne	short cu10
 35456                                  	;inc	ax		; If too high, ignore it (make it conventional)
 35457                                  	; 01/01/2023
 35458 00002CB5 40                      	inc	ax
 35459 00002CB6 7401                    	jz	short cu10	; If too high, ignore it (make it conventional)
 35460 00002CB8 48                      	dec	ax
 35461                                  cu10:	
 35462 00002CB9 C3                      	retn
 35463                                  
 35464                                  ; 01/01/2023 - Retro DOS v4.2
 35465                                  ;%if 0
 35466                                  ;
 35467                                  ;; -----------------------------------------------------------------------------
 35468                                  ;;*** setUMBs - links umbs and sets allocation strategy for a load
 35469                                  ;;            -- if LoadHigh, the allocation strategy MAY be LOW_FIRST instead
 35470                                  ;; of the usual HIGH_FIRST. See the code.
 35471                                  ;; -----------------------------------------------------------------------------
 35472                                  ;; ENTRY:  None
 35473                                  ;; EXIT:   None
 35474                                  ;; ERROR:  None
 35475                                  ;; USES:   Flags, fm_umb, fm_strat
 35476                                  ;; -----------------------------------------------------------------------------
 35477                                  ;
 35478                                  ;setUMBs:
 35479                                  ;	push	ax
 35480                                  ;	push	bx
 35481                                  ;	call	fm_link
 35482                                  ;	pop	bx
 35483                                  ;	pop	ax
 35484                                  ;	retn
 35485                                  ;
 35486                                  ;%endif
 35487                                  
 35488                                  ; 18/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 35489                                  ; loadLow subroutine is not used anywhere of IO.SYS 6.22 (& 5.0)
 35490                                  %if 0
 35491                                  
 35492                                  ; -----------------------------------------------------------------------------
 35493                                  ;*** loadLow - returns AL==0 if UMB0 == 0, else AL==1
 35494                                  ; -----------------------------------------------------------------------------
 35495                                  ; ENTRY:  None
 35496                                  ; EXIT:   AL==0 if mem strategy should be set to LOW_FIRST, else AL==1
 35497                                  ;         Carry set if UMB0 not specified (_NOT_ an error)
 35498                                  ; ERROR:  None
 35499                                  ; USES:   Flags, fm_strat, fm_umb
 35500                                  ; -----------------------------------------------------------------------------
 35501                                  ; We want to set the memory strategy to LOW_FIRST if the user specified a
 35502                                  ; load UMB, and it is 0. That 0 can be either from the user having _specified_
 35503                                  ; zero (/L:0;...), or from having specified a too-big min size (/L:1,99999999)
 35504                                  ; such that the load UMB is too small, and shouldn't be used.
 35505                                  ; -----------------------------------------------------------------------------
 35506                                  
 35507                                  loadLow:
 35508                                  	;push	ds
 35509                                  	;push	cs		; Point DS into appropriate data segment
 35510                                  	;pop	ds	
 35511                                  
 35512                                  	;mov	al,[UmbLoad]
 35513                                  	mov	al,[cs:UmbLoad]
 35514                                  	cmp	al,UNSPECIFIED ; 0FFh, -1
 35515                                  	jne	short ll10
 35516                                  
 35517                                  	stc
 35518                                  ll15:
 35519                                  	mov	al,1		; Return with AL==1 && STC if no UMBs specified
 35520                                  	;stc
 35521                                  	;jmp	short llX
 35522                                  	retn
 35523                                  ll10:	
 35524                                  	or	al,al		; AL=the load UMB: Is it == 0?
 35525                                  	;jz	short llX	; Yep... CF==0 (from OR) && AL=0, so just exit
 35526                                  
 35527                                  	jnz	short ll15	; 09/04/2019 - Retro DOS v4.0
 35528                                  	retn
 35529                                  
 35530                                  	;mov	al,1
 35531                                  	;clc
 35532                                  ;llX:
 35533                                  	;pop	ds		; Return DS to where it was
 35534                                  	;retn
 35535                                  
 35536                                  %endif
 35537                                  
 35538                                  ; -----------------------------------------------------------------------------
 35539                                  ;*** HideUMBs - links UMBs and hides upper-memory as appropriate
 35540                                  ; -----------------------------------------------------------------------------
 35541                                  ; ENTRY:  None
 35542                                  ; EXIT:   None
 35543                                  ; ERROR:  None
 35544                                  ; USES:   Flags, fm_strat, fm_umb
 35545                                  ; -----------------------------------------------------------------------------
 35546                                  
 35547                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 35548                                  	; (SYSINIT:322Fh)
 35549                                  HideUMBs:
 35550                                  	; 01/01/2023
 35551                                  	;push	ax
 35552                                  	;push	cx
 35553                                  	;push	ds
 35554 00002CBA 06                      	push	es
 35555                                  
 35556                                  	; 01/01/2023
 35557                                  	; ds = cs
 35558                                  
 35559 00002CBB E86E02                  	call	UmbTest		; See if we REALLY linked in anything...
 35560 00002CBE 7232                    	jc	short husX	; ...if not, there's nothing for us to do.
 35561                                  
 35562 00002CC0 E892FD                  	call	FixMem		; Concatenate adjacent free MCBs in upper mem
 35563                                  	
 35564                                  	;call	setUMBs		; Link UMBs and set memory-allocation strategy
 35565                                  	; 01/01/2023
 35566 00002CC3 E8DCFD                  	call	fm_link
 35567                                  
 35568                                  	;putdata fInHigh,1	; Remember that we're now running high
 35569                                  	;mov	byte [cs:fInHigh],1
 35570                                  	; 01/01/2023
 35571 00002CC6 C606[551F]01            	mov	byte [fInHigh],1
 35572                                  
 35573                                  	;call	GetLoadUMB	; See if they gave us a list to leave free
 35574                                  	;mov	al,[cs:UmbLoad] ; 09/04/2019 - Retro DOS v4.0
 35575                                  	; 01/01/2023
 35576 00002CCB A0[591F]                	mov	al,[UmbLoad]
 35577                                  
 35578 00002CCE 3CFF                    	cmp	al,UNSPECIFIED	; If they didn't,
 35579 00002CD0 7420                    	je	short husX	; then we shouldn't do this loop:
 35580                                  
 35581 00002CD2 31C9                    	xor	cx,cx
 35582                                  
 35583                                  ; -----------------------------------------------
 35584                                  ; HUS10-CX - UMB number (after inc, 1==first UMB)
 35585                                  ; -----------------------------------------------
 35586                                  
 35587 00002CD4 41                      hus10:	inc	cx		; For each UMB:
 35588                                  	; 01/01/2023
 35589 00002CD5 80F910                  	cmp	cl,MAXUMB
 35590                                  	;cmp	cx,MAXUMB ; 16
 35591 00002CD8 730E                    	jae	short hus20
 35592                                  
 35593 00002CDA 88C8                    	mov	al,cl		; (stopping as soon as we're outside of the
 35594 00002CDC 06                      	push	es
 35595 00002CDD E8A200                  	call	findUMB		; valid range of UMBs)
 35596 00002CE0 07                      	pop	es		; push/pop: trash what findumb finds. :-)
 35597 00002CE1 7205                    	jc	short hus20
 35598                                  	
 35599                                  	; 02/01/2023
 35600                                  	;push	cx ; *
 35601 00002CE3 E84F01                  	call	_hideUMB_	; hide what we need to hide.
 35602                                  	;pop	cx ; *
 35603                                  
 35604 00002CE6 EBEC                    	jmp	short hus10
 35605                                  hus20:	
 35606                                  	;call	GetLoadUMB	; Now check if they offered /L:0
 35607                                  	; 01/01/2023
 35608                                  	; ds = cs
 35609                                  	;mov	al,[UmbLoad]
 35610                                  	;;mov	al,[cs:UmbLoad] ; 09/04/2019 - Retro DOS v4.0	
 35611 00002CE8 800E[591F]00            	or	byte [UmbLoad],0
 35612                                  	;or	al,al		; --Is the load UMB 0? (-1==unspecified)
 35613 00002CED 7503                    	jnz	short husX	; If not, we're done.
 35614                                  
 35615 00002CEF E86802                  	call	hl_unlink	; If so, however, fix UMBs and strategy.
 35616                                  husX:	
 35617 00002CF2 07                      	pop	es
 35618                                  	; 01/01/2023
 35619                                  	;pop	ds
 35620                                  	;pop	cx
 35621                                  	;pop	ax
 35622 00002CF3 C3                      	retn
 35623                                  
 35624                                  ; -----------------------------------------------------------------------------
 35625                                  ;*** GetLoadUMB - Returns the load UMB number in AL (-1 if not specified)
 35626                                  ; -----------------------------------------------------------------------------
 35627                                  ; ENTRY:  None
 35628                                  ; EXIT:   AL == load UMB
 35629                                  ; ERROR:  None
 35630                                  ; USES:   Flags, AX
 35631                                  ; -----------------------------------------------------------------------------
 35632                                  
 35633                                  ;GetLoadUMB:
 35634                                  ;	;getdata al, UmbLoad
 35635                                  ;	push	ds
 35636                                  ;	push	cs
 35637                                  ;	pop	ds
 35638                                  ;	mov	al,[UmLoad]
 35639                                  ;	pop	ds
 35640                                  ;	retn
 35641                                  
 35642                                  ; -----------------------------------------------------------------------------
 35643                                  ;*** GetLoadSize - Returns the load UMB minimum size (0 if not specified)
 35644                                  ; -----------------------------------------------------------------------------
 35645                                  ; ENTRY:  None
 35646                                  ; EXIT:   AX == load UMB minimum size
 35647                                  ; ERROR:  None
 35648                                  ; USES:   Flags, AX
 35649                                  ; -----------------------------------------------------------------------------
 35650                                  
 35651                                  ; 08/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 35652                                  %if 0
 35653                                  	; 01/01/2023 - Retro DOS v4.2
 35654                                  GetLoadSize:
 35655                                  	; 09/04/2019 - Retro DOS v4.0
 35656                                  	;mov	al,[cs:UmbLoad]
 35657                                  	; 01/01/2023
 35658                                  	; ds = cs
 35659                                  	mov	al,[UmbLoad] 
 35660                                  	;jmp	short GetSize
 35661                                  
 35662                                  	;push	bx
 35663                                  	;;push	si
 35664                                  	;push	ds
 35665                                  	;push	cs
 35666                                  	;pop	ds
 35667                                  
 35668                                  	;mov	al,[UmbLoad]
 35669                                  
 35670                                  	;xor	ah,ah			;    ax==UMB
 35671                                  	;mov	bx,UmbSize		;    bx==array
 35672                                  	;shl	al,1	                ;    ax==offset
 35673                                  	;;add	ax,bx			;    ax==element index
 35674                                  	;;mov	si,ax			; ds:si==element index
 35675                                  
 35676                                  	;;lodsw				;    hh
 35677                                  
 35678                                  	;add	bx,ax
 35679                                  	;mov	ax,[bx]
 35680                                  
 35681                                  	;pop	ds
 35682                                  	;;pop	si
 35683                                  	;pop	bx
 35684                                  	;retn
 35685                                  %endif
 35686                                  
 35687                                  ; -----------------------------------------------------------------------------
 35688                                  ;*** GetSize - Returns the UMB in AL's minimum size (0 if not specified)
 35689                                  ; -----------------------------------------------------------------------------
 35690                                  ; ENTRY:  AL == a UMB number
 35691                                  ; EXIT:   AX == UMB minimum size, as specified by the user
 35692                                  ; ERROR:  None
 35693                                  ; USES:   Flags, AX
 35694                                  ; -----------------------------------------------------------------------------
 35695                                  
 35696                                  ; 08/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 35697                                  GetLoadSize:
 35698                                  	; ds = cs
 35699                                  	;mov	al,[UmbLoad]
 35700                                  	; al = [UmbLoad] 
 35701                                  	; ....
 35702                                  
 35703                                  	; 01/01/2023 - Retro DOS v4.2
 35704                                  GetSize:
 35705                                  	; 09/04/2019 - Retro DOS v4.0
 35706                                  
 35707                                  	;push	bx ; 01/01/2023
 35708                                  	;push	si
 35709                                  	;push	ds
 35710                                  	;push	cs
 35711                                  	;pop	ds
 35712                                  
 35713 00002CF4 30E4                    	xor	ah,ah			;    ax==UMB
 35714 00002CF6 BB[6A1F]                	mov	bx,UmbSize		;    bx==array
 35715 00002CF9 D0E0                    	shl	al,1	                ;    ax==offset
 35716                                  	;add	ax,bx			;    ax==element index
 35717                                  	;mov	si,ax			; ds:si==element index
 35718                                  
 35719                                  	;lodsw				;    ax==size
 35720                                  
 35721 00002CFB 01C3                    	add	bx,ax
 35722                                  	; 01/01/2023
 35723                                  	; ds = cs
 35724 00002CFD 8B07                    	mov	ax,[bx]
 35725                                  	;mov	ax,[cs:bx]
 35726                                  
 35727                                  	;pop	ds
 35728                                  	;pop	si
 35729                                  	;pop	bx ; 01/01/2023
 35730                                  sls10:	; 08/09/2023
 35731 00002CFF C3                      	retn
 35732                                  
 35733                                  ; -----------------------------------------------------------------------------
 35734                                  ;*** StoLoadUMB - Overrides the load UMB number with what's in AL
 35735                                  ; -----------------------------------------------------------------------------
 35736                                  ; ENTRY:   AL == new load UMB
 35737                                  ; EXIT:    None
 35738                                  ; ERROR:   None
 35739                                  ; USES:    Flags, AX
 35740                                  ; -----------------------------------------------------------------------------
 35741                                  ; CAUTION: Should only be used if /L:... was used. Logically, that is the only
 35742                                  ;          time you would ever need this, so that's okay.
 35743                                  ; -----------------------------------------------------------------------------
 35744                                  
 35745                                  ; StoLoadUMB subroutine is not used anywhere
 35746                                  ; of PCDOS 7.1 IBMBIO.COM (& MSDOS 6.21 IO.SYS)
 35747                                  ; Erdogan Tan - 18/07/2023
 35748                                  
 35749                                  ;StoLoadUMB:
 35750                                  ;	;putdata UmbLoad, al
 35751                                  ;	push	es
 35752                                  ;	push	cs
 35753                                  ;	pop	es		; mov [cs:UmbLoad], al !!!! ; 08/09/2023
 35754                                  ;	mov	[es:UmbLoad],al
 35755                                  ;	pop	es
 35756                                  ;	retn
 35757                                  
 35758                                  ; -----------------------------------------------------------------------------
 35759                                  ;*** StoLoadSize - Overrides the load UMB minimum size with what's in AX
 35760                                  ; -----------------------------------------------------------------------------
 35761                                  ; ENTRY:  AL == new load size
 35762                                  ; EXIT:   None
 35763                                  ; ERROR:  None
 35764                                  ; USES:   Flags, AX
 35765                                  ; -----------------------------------------------------------------------------
 35766                                  	; 08/09/2023 - Retro DOS v4.2 IO.SYS (Optimization) 
 35767                                  	; 01/01/2023 - Retro DOS v4.2
 35768                                  StoLoadSize:
 35769                                  	; 01/01/2023
 35770                                  	;push	dx
 35771                                  
 35772                                  	;getdata dl, UmbLoad		; Put UMB# in DL and size in AX
 35773                                  	;
 35774                                  	;push	ds
 35775                                  	;push	cs
 35776                                  	;pop	ds
 35777                                  	;mov	dl,[UmbLoad]
 35778                                  	;pop	ds	
 35779                                  
 35780                                  	; 08/09/2023
 35781                                  	; MSDOS 6.21 IO.SYS - SYSINIT:32B6h
 35782                                  	; PCDOS 7.1 IBMBIO.COM - SYSINIT:3831h
 35783                                  
 35784                                  	;;mov	dl,[UmbLoad]		; BUG ! CL would/must be used here
 35785                                  					; instead of DL (*) ; 18/07/2023
 35786                                  	;mov	dl,[cs:UmbLoad] ; Retro DOS v4.0, v4.1, v4.2
 35787                                  	;cmp	dl,UNSPECIFIED ; 0FFh
 35788                                  	;je	short sls10
 35789                                  			
 35790                                  		; BUG ! stowSiz uses CL instead of DL !
 35791                                  		; (CL is set in ParseL which calls stowSiz)
 35792                                  		; (This BUG existing in PCDOS 7.1 IBMBIO.COM also)
 35793                                  		; Erdogan Tan - 18/07/2023
 35794                                  
 35795                                  	; 08/09/2023 (BugFix)
 35796                                  	;mov	cl,[cs:UmbLoad]
 35797                                  	; 08/09/2023 
 35798                                  	; ds = cs
 35799 00002D00 8A0E[591F]              	mov	cl,[UmbLoad]
 35800 00002D04 80F9FF                  	cmp	cl,UNSPECIFIED ; 0FFh
 35801 00002D07 74F6                    	je	short sls10
 35802                                  
 35803                                  	; 08/09/2023
 35804                                  ;	call	stowSiz			; We've got a function to do just this
 35805                                  ;sls10:	
 35806                                  ;	; 01/01/2023
 35807                                  ;	;pop	dx
 35808                                  ;	retn
 35809                                  	
 35810                                  	; 08/09/2023
 35811                                  	;;jmp	stowSiz
 35812                                  	;jmp	short stowSiz
 35813                                  
 35814                                  ; 08/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 35815                                  %if 1
 35816                                  ; -----------------------------------------------------------------------------
 35817                                  ;*** stowSiz - marks a given UMB as having a given minimum size
 35818                                  ; -----------------------------------------------------------------------------
 35819                                  ; ENTRY:    CL contains UMB number, AX contains size
 35820                                  ; EXIT:     None
 35821                                  ; ERROR:    None
 35822                                  ; USES:     AX, DX, Flags, variables in highvar.inc
 35823                                  ; -----------------------------------------------------------------------------
 35824                                  
 35825                                  ; 13/05/2019
 35826                                  
 35827                                  	; 01/01/2023 - Retro DOS v4.2
 35828                                  stowSiz:
 35829                                  	; 01/01/2023
 35830                                  	;push	bx
 35831                                  	;;push	di ; ?
 35832                                  	;push	es
 35833                                  
 35834                                  	;push	cs
 35835                                  	;pop	es	
 35836                                  
 35837 00002D09 88CB                    	mov	bl,cl			; Now bl==UMB number, AX==size
 35838 00002D0B B700                    	mov	bh,0			;     bx==UMB number, AX==size
 35839 00002D0D D0E3                    	shl	bl,1			;     bx==offset into array, AX=size
 35840                                  	;mov	[es:bx+UmbSize],ax	; Store the size
 35841                                  	; 01/01/2023
 35842 00002D0F 2E8987[6A1F]            	mov	[cs:bx+UmbSize],ax	; Store the size
 35843                                  
 35844                                  	; 01/01/2023
 35845                                  	;pop	es
 35846                                  	;;pop	di ; ?
 35847                                  	;pop	bx
 35848                                  
 35849 00002D14 C3                      	retn
 35850                                  %endif
 35851                                  
 35852                                  ; -----------------------------------------------------------------------------
 35853                                  ;*** hideUMB - marks as HIDDEN all FREE elements in UMB passed as AL
 35854                                  ; -----------------------------------------------------------------------------
 35855                                  ; ENTRY:    AL must indicate a valid UMB; 0==conv && is invalid.
 35856                                  ; EXIT:     None; free elements in UMB marked as hidden
 35857                                  ; ERROR:    None
 35858                                  ; USES:     Flags
 35859                                  ; -----------------------------------------------------------------------------
 35860                                  
 35861                                  	; 01/01/2023 - Retro DOS v4.2
 35862                                  hideUMB:
 35863                                  	; 02/01/2023
 35864 00002D15 52                      	push	dx ; (*)
 35865                                  	; 01/01/2023
 35866                                  	;push	ax
 35867 00002D16 06                      	push	es
 35868                                  
 35869 00002D17 E86800                  	call	findUMB	; (*)	; Returns with carry if err, else ES == MCB
 35870 00002D1A 7224                    	jc	short huX
 35871                                  
 35872                                  ; ------------------------------------------------
 35873                                  ; HU10--ES - MCB inside UMB; if it's a system MCB,
 35874                                  ;            we're not in the same UMB, so exit.
 35875                                  ; ------------------------------------------------
 35876                                  
 35877 00002D1C E84AFF                  hu10:	call	isSysMCB	; Returns with ZF set if owner is SYSTEM
 35878 00002D1F 741F                    	jz	short huX	; If it is, we've finished the UMB.
 35879                                  	;call	isFreeMCB	; Returns with ZF set if owner is 0
 35880 00002D21 26830E010000            	or	word [es:ARENA.OWNER],0
 35881 00002D27 7503                    	jnz	short hu20
 35882                                  
 35883 00002D29 E81700                  	call	hideMCB
 35884                                  hu20:	
 35885                                  	;mov	al,[es:ARENA.SIGNATURE]
 35886                                  	;cmp	al,arena_signature_end  ;'Z'
 35887                                  	; 19/07/2023
 35888 00002D2C 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],'Z'
 35889 00002D32 740C                    	jz	short huX	; 'Z' means this was the last MCB... that's it.
 35890                                  
 35891                                  	;NextMCB es,ax		; Go on forward.
 35892 00002D34 8CC0                    	mov     ax,es
 35893                                  	;add	ax,[es:3]
 35894 00002D36 2603060300              	add     ax,[es:ARENA.SIZE]
 35895 00002D3B 40                      	inc     ax
 35896 00002D3C 8EC0                    	mov     es,ax
 35897                                  
 35898 00002D3E EBDC                    	jmp	short hu10
 35899                                  huX:	
 35900 00002D40 07                      	pop	es
 35901                                  	; 01/01/2023
 35902                                  	;pop	ax
 35903                                  	; 02/01/2023
 35904 00002D41 5A                      	pop	dx ; (*)
 35905 00002D42 C3                      	retn
 35906                                  
 35907                                  ; 02/01/2023
 35908                                  %if 0
 35909                                  
 35910                                  ; -----------------------------------------------------------------------------
 35911                                  ;*** isTiny - returns with ZF set if user didn't specify /S
 35912                                  ; -----------------------------------------------------------------------------
 35913                                  ; ENTRY:    None
 35914                                  ; EXIT:     ZF set if user DIDN'T specify /S
 35915                                  ; ERROR:    None
 35916                                  ; USES:     Flags
 35917                                  ; -----------------------------------------------------------------------------
 35918                                  
 35919                                  	; 02/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 35920                                  isTiny:
 35921                                  	; 02/01/2023
 35922                                  	;push	ax
 35923                                  
 35924                                  	;getdata al,fUmbTiny
 35925                                  	;
 35926                                  	;push	ds
 35927                                  	;push	cs
 35928                                  	;pop	ds
 35929                                  	;mov	al,[fUmbTiny]
 35930                                  	;pop	ds
 35931                                  
 35932                                  	; 09/09/2023
 35933                                  	;mov	al,[cs:fUmbTiny]
 35934                                  	; 02/01/2023
 35935                                  	; ds = cs
 35936                                  	mov	al,[fUmbTiny]
 35937                                  
 35938                                  	or	al,al
 35939                                  	; 02/01/2023
 35940                                  	;pop	ax
 35941                                  	retn
 35942                                  
 35943                                  %endif
 35944                                  
 35945                                  ; -----------------------------------------------------------------------------
 35946                                  ;*** isFreeMCB - returns with ZF set if current MCB (ES:0) is FREE
 35947                                  ; -----------------------------------------------------------------------------
 35948                                  ; ENTRY:    ES:0 should point to an MCB
 35949                                  ; EXIT:     ZF set if MCB is free, else !ZF
 35950                                  ; ERROR:    None
 35951                                  ; USES:     Flags
 35952                                  ; -----------------------------------------------------------------------------
 35953                                  
 35954                                  ;isFreeMCB:
 35955                                  ;	or	word [es:ARENA.OWNER],0
 35956                                  ;	retn
 35957                                  
 35958                                  ; -----------------------------------------------------------------------------
 35959                                  ;*** hideMCB - marks as HIDDEN the MCB at ES:0
 35960                                  ; -----------------------------------------------------------------------------
 35961                                  ; ENTRY:    ES:0 should point to an MCB
 35962                                  ; EXIT:     None; MCB marked as HIDDEN
 35963                                  ; ERROR:    None
 35964                                  ; USES:     None
 35965                                  ; -----------------------------------------------------------------------------
 35966                                  
 35967                                  hideMCB:
 35968 00002D43 26C70601000800          	mov	word [es:ARENA.OWNER],SystemPSPOwner ; 8
 35969 00002D4A 26C70608004849          	mov	word [es:ARENA.NAME+0], 'HI' ; 4948h
 35970 00002D51 26C7060A004444          	mov	word [es:ARENA.NAME+2], 'DD' ; 4444h
 35971 00002D58 26C7060C00454E          	mov	word [es:ARENA.NAME+4], 'EN' ; 4E45h
 35972 00002D5F 26C7060E002020          	mov	word [es:ARENA.NAME+6], '  ' ; 2020h	
 35973 00002D66 C3                      	retn
 35974                                  
 35975                                  ; -----------------------------------------------------------------------------
 35976                                  ;*** unHideMCB - marks as FREE the MCB at ES:0
 35977                                  ; -----------------------------------------------------------------------------
 35978                                  ; ENTRY:    ES:0 should point to an MCB
 35979                                  ; EXIT:     None; MCB marked as FREE
 35980                                  ; ERROR:    None
 35981                                  ; USES:     None
 35982                                  ; -----------------------------------------------------------------------------
 35983                                  
 35984                                  	; 03/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 35985                                  
 35986                                  unHideMCB:
 35987                                  	; 03/01/2023
 35988                                  	;push	ax
 35989 00002D67 26C70601000000          	mov	word [es:ARENA.OWNER],FreePSPOwner ; 0
 35990 00002D6E B82020                  	mov	ax,'  ' ; 2020h
 35991 00002D71 26A30800                	mov	[es:ARENA.NAME+0],ax
 35992 00002D75 26A30A00                	mov	[es:ARENA.NAME+2],ax
 35993 00002D79 26A30C00                	mov	[es:ARENA.NAME+4],ax
 35994 00002D7D 26A30E00                	mov	[es:ARENA.NAME+6],ax
 35995                                  	; 03/01/2023
 35996                                  	;pop	ax
 35997 00002D81 C3                      	retn
 35998                                  
 35999                                  ; -----------------------------------------------------------------------------
 36000                                  ;*** findUMB - makes ES:0 point to the first MCB in UMB given as AL
 36001                                  ;            -- returns UmbHEAD pointer (0x9FFF) if passed AL==0
 36002                                  ; -----------------------------------------------------------------------------
 36003                                  ; ENTRY:    AL should be to a valid UMB number
 36004                                  ; EXIT:     ES:0 points to first MCB in UMB (_not_ the 8+SC MCB that heads it)
 36005                                  ; ERROR:    Carry set if couldn't reach UMB (too high)
 36006                                  ; USES:     Flags, ES
 36007                                  ; -----------------------------------------------------------------------------
 36008                                  
 36009                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 36010                                  	; (SYSINIT:3344h)
 36011                                  findUMB:
 36012                                  	; 01/01/2023
 36013                                  	;push	ax
 36014                                  	; 02/01/2023
 36015 00002D82 51                      	push	cx ; *
 36016                                  	;push	dx
 36017                                  
 36018 00002D83 30E4                    	xor	ah,ah		; Zap ah, so al==ax
 36019                                  
 36020 00002D85 89C2                    	mov	dx,ax		; Store the to-be-found UMB number in DX
 36021                                  
 36022 00002D87 E8D2FE                  	call	UmbHead		; Returns first UMB segment in AX
 36023                                  	; 22/07/2023
 36024                                  	;mov	es,ax ; *
 36025 00002D8A 31C9                    	xor	cx,cx		; Pretend we're on UMB 0 for now...
 36026                                  
 36027                                  	; 22/07/2023
 36028                                  fu10:
 36029 00002D8C 8EC0                    	mov	es,ax ; * ; **
 36030                                  ; ---------------------------------------------
 36031                                  ; FU10--CX - This UMB number; 0 == conventional
 36032                                  ;       DX - The UMB number they're looking for
 36033                                  ;       ES - The current MCB address
 36034                                  ; ---------------------------------------------
 36035                                  
 36036                                  ;fu10:	
 36037 00002D8E 39D1                    	cmp	cx,dx		; If CX==DX, we've found the UMB we're
 36038 00002D90 7417                    	je	short fuX	; searching for--so exit.
 36039                                  
 36040 00002D92 E8D4FE                  	call	isSysMCB	; Returns with ZF set if owner is SYSTEM
 36041 00002D95 7501                    	jnz	short fu20
 36042                                  
 36043 00002D97 41                      	inc	cx		; If it _was_ SYSTEM, we're in a new UMB.
 36044                                  fu20:	
 36045                                  	;mov	al,[es:ARENA.SIGNATURE]
 36046                                  	;cmp	al,arena_signature_end ; 'Z'
 36047                                  	; 19/07/2023
 36048 00002D98 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],arena_signature_end 
 36049 00002D9E 7408                    	je	short fuE	; 'Z' means this was the last MCB... that's it.
 36050                                  
 36051                                  	;NextMCB es,ax		; Go on forward.
 36052                                  	; 22/07/2023
 36053                                  	; ax = es
 36054                                  	;mov	ax,es ; * ; 22/07/2023
 36055                                  	;add	ax,[es:3]
 36056 00002DA0 2603060300              	add	ax,[es:ARENA.SIZE]
 36057 00002DA5 40                      	inc	ax
 36058                                  	; 22/07/2023
 36059                                  	;mov	es,ax ; **
 36060 00002DA6 EBE4                    	jmp	short fu10
 36061                                  fuE:	
 36062 00002DA8 F9                      	stc
 36063                                  fuX:
 36064                                  	; 01/01/2023
 36065                                  	;pop	dx
 36066                                  	; 02/01/2023
 36067 00002DA9 59                      	pop	cx ; *
 36068                                  	;pop	ax		; The address is already in ES.
 36069 00002DAA C3                      	retn
 36070                                  
 36071                                  ; -----------------------------------------------------------------------------
 36072                                  ;*** BigFree - makes ES:0 point to the largest free MCB in UMB given as AL
 36073                                  ; -----------------------------------------------------------------------------
 36074                                  ; ENTRY:    AL should be to a valid UMB number
 36075                                  ; EXIT:     ES:0 points to largest free MCB in UMB, AX returns its size
 36076                                  ; ERROR:    Carry set if couldn't reach UMB (0 or too high)
 36077                                  ; USES:     Flags, ES
 36078                                  ; -----------------------------------------------------------------------------
 36079                                  
 36080                                  	; 01/01/2023 - Retro DOS v4.2
 36081                                  BigFree:
 36082                                  	; 01/01/2023
 36083                                  	;push	bx
 36084 00002DAB 51                      	push	cx
 36085                                  
 36086 00002DAC E8D3FF                  	call	findUMB			; Returns with CF if err, else ES==MCB
 36087 00002DAF 723A                    	jc	short bfX
 36088                                  
 36089 00002DB1 31DB                    	xor	bx,bx			; Segment address of largest free MCB
 36090 00002DB3 31C9                    	xor	cx,cx			; Size of largest free MCB
 36091                                  
 36092                                  ; ---------------------------------------------
 36093                                  ; BF10--ES - Current MCB address
 36094                                  ;       BX - Address of largest free MCB so far
 36095                                  ;       CX - Size of largest free MCB so far
 36096                                  ; ---------------------------------------------
 36097                                  
 36098                                  bf10:	
 36099 00002DB5 E8B1FE                  	call	isSysMCB		; If we've left the MCB, we're done.
 36100 00002DB8 7428                    	jz	short bf30
 36101                                  
 36102                                  	;call	isFreeMCB		; Returns with ZF set if owner is 0
 36103 00002DBA 26830E010000            	or	word [es:ARENA.OWNER],0
 36104 00002DC0 750C                    	jnz	short bf20
 36105                                  
 36106 00002DC2 26A10300                	mov	ax,[es:ARENA.SIZE]
 36107                                  	;cmp	cx,[es:ARENA.SIZE]	; Compare sizes...
 36108 00002DC6 39C1                    	cmp	cx,ax
 36109                                  	;jg	short bf20		; Unless we're bigger,
 36110                                  	; 19/07/2023
 36111 00002DC8 7D04                    	jge	short bf20
 36112                                  
 36113 00002DCA 8CC3                    	mov	bx,es			; Store this new element's address,
 36114                                  	;mov	cx,[es:ARENA.SIZE]	; and its size.
 36115 00002DCC 89C1                    	mov	cx,ax
 36116                                  bf20:	
 36117                                  	;mov	al,[es:ARENA.SIGNATURE]
 36118                                  	;cmp	al,arena_signature_end	; 'Z'
 36119                                  	; 19/07/2023
 36120                                  	;cmp	byte [es:0],'Z'
 36121 00002DCE 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],arena_signature_end
 36122 00002DD4 740C                    	jz	short bf30		; 'Z' means this was the last MCB.
 36123                                  
 36124                                  	;NextMCB es,ax			; Go on forward.
 36125 00002DD6 8CC0                    	mov     ax,es
 36126                                  	;add	ax,[es:3]
 36127 00002DD8 2603060300              	add     ax,[es:ARENA.SIZE]
 36128 00002DDD 40                      	inc     ax
 36129 00002DDE 8EC0                    	mov     es,ax
 36130                                  
 36131 00002DE0 EBD3                    	jmp	short bf10
 36132                                  
 36133 00002DE2 8EC3                    bf30:	mov	es,bx			; Return the address
 36134 00002DE4 89C8                    	mov	ax,cx			; Return the size
 36135 00002DE6 09DB                    	or	bx,bx
 36136 00002DE8 7501                    	jnz	short bfX
 36137                                  bfE:	
 36138 00002DEA F9                      	stc				; (if size==0, there's nothing free)
 36139                                  bfX:
 36140 00002DEB 59                      	pop	cx
 36141                                  	; 01/01/2023
 36142                                  	;pop	bx
 36143 00002DEC C3                      	retn
 36144                                  
 36145                                  ; -----------------------------------------------------------------------------
 36146                                  ;*** isSpecified - sets ZF if UMB in AL wasn't specified in DH/LH line.
 36147                                  ; -----------------------------------------------------------------------------
 36148                                  ; ENTRY:    AL should be to a valid UMB number
 36149                                  ; EXIT:     ZF set if UMB wasn't specified, ZF clear if it was
 36150                                  ; ERROR:    None
 36151                                  ; USES:     Flags
 36152                                  ; -----------------------------------------------------------------------------
 36153                                  
 36154                                  	; 02/01/2023 - Retro DOS v4.2
 36155                                  
 36156                                  isSpecified:
 36157                                  	; 02/01/2023
 36158                                  	;push	ax
 36159                                  
 36160 00002DED 30FF                    	xor	bh,bh
 36161 00002DEF 88C3                    	mov	bl,al
 36162                                  
 36163                                  	;getdata al,DS:UmbUsed[bx]
 36164                                  	;
 36165                                  	;push	ds
 36166                                  	;push	cs
 36167                                  	;pop	ds
 36168                                  	;mov	al,[bx+UmbUsed]
 36169                                  	;pop	ds
 36170                                  	
 36171                                  	;mov	al,[cs:bx+UmbUsed]
 36172                                  	; 02/01/2023
 36173                                  	; ds = cs
 36174 00002DF1 8A87[5A1F]              	mov	al,[bx+UmbUsed]
 36175                                  
 36176 00002DF5 08C0                    	or	al,al			; Sets ZF if al==0 (ie, if unspecified)
 36177                                  
 36178                                  	; 09/09/2023
 36179                                  	; 02/01/2023
 36180                                  	;pop	ax
 36181                                  
 36182 00002DF7 C3                      	retn
 36183                                  
 36184                                  ; -----------------------------------------------------------------------------
 36185                                  ;*** shrinkMCB - breaks an MCB into two pieces, the lowest one's size==AX
 36186                                  ; -----------------------------------------------------------------------------
 36187                                  ; ENTRY:    AX == new size, ES:0 == current MCB
 36188                                  ; EXIT:     None; MCB broken if carry clear
 36189                                  ; ERROR:    Carry set if MCB isn't as large as AX+0x20 (not a useful split)
 36190                                  ; USES:     Flags
 36191                                  ; -----------------------------------------------------------------------------
 36192                                  ; If the size of the to-be-split MCB isn't at least 0x20 bytes greater than
 36193                                  ; the specified new size, the split is useless; if it's only 0x10 bytes, that
 36194                                  ; 0x10 will be used to make a header that mentions a 0-byte free space, and
 36195                                  ; that just sucks up 0x10 bytes for nothing. So we make 0x20 bytes the
 36196                                  ; minimum for performing a split.
 36197                                  ; -----------------------------------------------------------------------------
 36198                                  
 36199                                  MIN_SPLIT_SIZE	equ 20h
 36200                                  
 36201                                  	; 02/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 36202                                  
 36203                                  shrinkMCB:
 36204                                  	;pushreg <bx,cx,es>
 36205                                  	; 02/01/2023
 36206                                  	;push	bx
 36207 00002DF8 51                      	push	cx
 36208 00002DF9 06                      	push	es
 36209                                  
 36210 00002DFA 89C3                    	mov	bx,ax			; Move things around... and
 36211                                  	; 02/01/2023
 36212                                  	;mov	ax,es			; save this one for later.
 36213                                  
 36214 00002DFC 268B0E0300              	mov	cx,[es:ARENA.SIZE]
 36215                                  	; 02/01/2023
 36216 00002E01 89C8                    	mov	ax,cx 
 36217                                  
 36218 00002E03 83E820                  	sub	ax,MIN_SPLIT_SIZE ; 32
 36219                                  	;sub	cx,MIN_SPLIT_SIZE ; 32
 36220                                  	;;cmp	bx,cx			; {New size} vs {Current Size-20h}
 36221                                  	;ja	short smE		; if wanted_size > cur-20h, abort.
 36222                                  	; 18/12/2022
 36223                                  	;cmp	cx,bx
 36224                                  	; 02/01/2023
 36225 00002E06 39D8                    	cmp	ax,bx
 36226 00002E08 7228                    	jb	short smE ; (*)
 36227                                  
 36228 00002E0A 268A160000              	mov	dl,[es:ARENA.SIGNATURE]
 36229                                  	
 36230                                  	;mov	cx,[es:ARENA.SIZE]
 36231                                  	; 02/01/2023
 36232 00002E0F 8CC0                    	mov	ax,es
 36233                                  
 36234 00002E11 26891E0300              	mov	[es:ARENA.SIZE],bx
 36235 00002E16 26C60600004D            	mov	byte [es:ARENA.SIGNATURE],'M'
 36236                                  
 36237 00002E1C 01D8                    	add	ax,bx
 36238 00002E1E 40                      	inc	ax
 36239 00002E1F 8EC0                    	mov	es,ax			; Move to new arena area
 36240                                  
 36241 00002E21 89C8                    	mov	ax,cx
 36242 00002E23 29D8                    	sub	ax,bx
 36243                                  	; 12/12/2022
 36244                                  	; ax > 0
 36245 00002E25 48                      	dec	ax			; And prepare the new size
 36246                                  
 36247                                  	; 18/12/2022
 36248 00002E26 2688160000              	mov	[es:ARENA.SIGNATURE],dl
 36249                                  	;mov	word [es:ARENA.OWNER],0 ; (**)
 36250 00002E2B 26A30300                	mov	[es:ARENA.SIZE],ax
 36251                                  	;mov	ax,'  ' ; 2020h
 36252                                  	;mov	[es:ARENA.NAME+0],ax ; (**)
 36253                                  	;mov	[es:ARENA.NAME+2],ax ; (**)
 36254                                  	;mov	[es:ARENA.NAME+4],ax ; (**)
 36255                                  	;mov	[es:ARENA.NAME+6],ax ; (**)
 36256                                  
 36257                                  	; 18/12/2022
 36258 00002E2F E8A801                  	call	freeMCB	; (**)
 36259                                  
 36260                                  	; 12/12/2022
 36261                                  	; cf=0
 36262                                  	;clc
 36263                                  	; 18/12/2022
 36264                                  	;jmp	short smX
 36265                                  smE:	
 36266                                  	; 18/12/2022
 36267                                  	; cf=1 (*)
 36268                                  	;stc
 36269                                  smX:	
 36270                                  	;popreg	<es,cx,bx>
 36271 00002E32 07                      	pop	es
 36272 00002E33 59                      	pop	cx
 36273                                  	; 02/01/2023
 36274                                  	;pop	bx
 36275 00002E34 C3                      	retn
 36276                                  
 36277                                  ; -----------------------------------------------------------------------------
 36278                                  ;*** hideUMB? - hides as appropriate the UMB in CL
 36279                                  ; -----------------------------------------------------------------------------
 36280                                  ; ENTRY:    CL should be to a valid UMB number, and AX to its address (findUMB)
 36281                                  ; EXIT:     None; UMB is hidden as necessary
 36282                                  ; ERROR:    None
 36283                                  ; USES:     Flags, AX, CX
 36284                                  ; -----------------------------------------------------------------------------
 36285                                  ; PRIMARY LOGIC:
 36286                                  ;
 36287                                  ; If the UMB is specified in the DH/LH statement, then:
 36288                                  ;    If the largest free segment is too small (check specified size), then:
 36289                                  ;       Pretend it wasn't ever specified, and fall out of this IF.
 36290                                  ;    Else, if largest free segment is LARGER than specified size, then:
 36291                                  ;       If /S was given on the command-line, then:
 36292                                  ;          Break that element into two pieces
 36293                                  ;          Set a flag that we're shrinking
 36294                                  ;       Endif
 36295                                  ;    Endif
 36296                                  ; Endif
 36297                                  ; If the UMB is NOT specified (or was removed by the above):
 36298                                  ;    Hide all free elements in the UMB
 36299                                  ;    If the flag that we're shrinking was set, then:
 36300                                  ;       UN-hide the lower portion of the shrunken UMB
 36301                                  ;    ENDIF
 36302                                  ; ENDIF
 36303                                  ; -----------------------------------------------------------------------------
 36304                                  
 36305                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 36306                                  	; (SYSINIT:3426h)
 36307                                  _hideUMB_:
 36308                                  	; 02/01/2023
 36309                                  	; ds = cs
 36310                                  
 36311                                  	; 01/01/2023
 36312                                  	;push	bx
 36313                                  	;push	dx
 36314 00002E35 06                      	push	es
 36315                                  
 36316 00002E36 88C8                    	mov	al,cl
 36317 00002E38 E8B2FF                  	call	isSpecified	; Returns ZF set if al's umb was NOT specified
 36318 00002E3B 742D                    	jz	short hu_20
 36319                                  
 36320 00002E3D 88C8                    	mov	al,cl		; Retrieve the size of the largest
 36321 00002E3F E869FF                  	call	BigFree		; free element in AX; put its address in ES
 36322 00002E42 7226                    	jc	short hu_20	; Oops. Errors mean skip this part.
 36323                                  
 36324 00002E44 50                      	push	ax		; TOS==size of BigFree in UMB (popped as BX)
 36325 00002E45 88C8                    	mov	al,cl		; Retrieve the user's specified
 36326 00002E47 E8AAFE                  	call	GetSize		; minimum size for this umb (into AX)
 36327 00002E4A 5B                      	pop	bx		; Now BX==BigFree, AX==Specified Size
 36328                                  
 36329 00002E4B 09C0                    	or	ax,ax		; If they didn't specify one,
 36330 00002E4D 741B                    	jz	short hu_20	; Skip over all this.
 36331                                  
 36332 00002E4F 39D8                    	cmp	ax,bx		; Ah... if (specified > max free)
 36333 00002E51 7607                    	jbe	short hu_10
 36334                                  
 36335 00002E53 88C8                    	mov	al,cl		;  Then mark that UMB as unused. Nya nya.
 36336 00002E55 E81DFD                  	call	unMarkUMB
 36337 00002E58 EB10                    	jmp	short hu_20
 36338                                  hu_10:	
 36339                                  	;call	isTiny		; Returns ZF clear if user specified /S
 36340                                  	;jz	short hu_20
 36341                                  	; 02/01/2023
 36342                                  ;isTiny:
 36343                                  	;mov	al,[fUmbTiny] ; ds = cs
 36344                                  	;or	al,al
 36345 00002E5A 800E[561F]00            	or	byte [fUmbTiny],0
 36346 00002E5F 7409                    	jz	short hu_20
 36347                                  
 36348 00002E61 E894FF                  	call	shrinkMCB	; They specified /S, so shrink the MCB to AX
 36349 00002E64 7204                    	jc	short hu_20	; Ah... if didn't shrink after all, skip this:
 36350                                  
 36351 00002E66 8CC2                    	mov	dx,es
 36352 00002E68 EB09                    	jmp	short hu_30	; Skip the spec check.. we wanna hide this one.
 36353                                  
 36354 00002E6A 89C8                    hu_20:	mov	ax,cx
 36355 00002E6C E87EFF                  	call	isSpecified	; If they specified this UMB, we're done...
 36356 00002E6F 7510                    	jnz	short hu_X	; so leave.
 36357                                  
 36358 00002E71 31D2                    	xor	dx,dx
 36359                                  hu_30:	
 36360 00002E73 88C8                    	mov	al,cl
 36361                                  
 36362 00002E75 E89DFE                  	call	hideUMB		; Hides everything in UMB #al
 36363                                  
 36364 00002E78 09D2                    	or	dx,dx		; Did we shrink a UMB? If not, DX==0,
 36365 00002E7A 7405                    	jz	short hu_X	; So we should leave.
 36366                                  
 36367 00002E7C 8EC2                    	mov	es,dx		; Ah, but if it isn't, DX==the MCB's address;
 36368 00002E7E E8E6FE                  	call	unHideMCB	; Un-hides the lower portion of that MCB.
 36369                                  hu_X:	
 36370 00002E81 07                      	pop	es
 36371                                  	; 01/01/2023
 36372                                  	;pop	dx
 36373                                  	;pop	bx
 36374 00002E82 C3                      	retn
 36375                                  
 36376                                  ; -----------------------------------------------------------------------------
 36377                                  ;*** UnFreeze - Marks FROZEN elements as FREE
 36378                                  ; -----------------------------------------------------------------------------
 36379                                  ; Entry:  None
 36380                                  ; Exit:   None; all 8+FROZEN elements are marked as FREE, from any UMB.
 36381                                  ; Error:  None
 36382                                  ; Uses:   Flags
 36383                                  ; -----------------------------------------------------------------------------
 36384                                  
 36385                                  	; 03/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 36386                                  UnFreeze:
 36387                                  	; 03/01/2023
 36388                                  	;push	ax
 36389 00002E83 06                      	push	es
 36390                                  
 36391 00002E84 E8D5FD                  	call	UmbHead		; Returns with carry if err, else ES == MCB
 36392 00002E87 721C                    	jc	short ufX
 36393                                  
 36394                                  	; 22/07/2023
 36395                                  uf10:
 36396 00002E89 8EC0                    	mov	es,ax ; *
 36397                                  
 36398                                  ; ------------------------------
 36399                                  ; UF10--ES - Current MCB address
 36400                                  ; ------------------------------
 36401                                  
 36402                                  ;uf10:	
 36403 00002E8B E81900                  	call	isFrozMCB	; Returns with ZF set if MCB is FROZEN
 36404 00002E8E 7505                    	jnz	short uf20
 36405 00002E90 E8D4FE                  	call	unHideMCB
 36406                                  	; 09/09/2023
 36407                                  	; ax <> es
 36408 00002E93 8CC0                    	mov	ax,es ; *
 36409                                  uf20:	
 36410                                  	;mov	al,[es:ARENA.SIGNATURE]
 36411                                  	;cmp	al,arena_signature_end ; 'Z'
 36412                                  	; 22/07/2023
 36413 00002E95 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],arena_signature_end ; 'Z'
 36414 00002E9B 7408                    	jz	short ufX	; 'Z' means this was the last MCB.. that's it.
 36415                                  
 36416                                  	;NextMCB es,ax		; Go on forward.
 36417                                  	; 22/07/2023
 36418                                  	; ax = es
 36419                                  	;mov	ax,es ; *
 36420                                  	;add	ax,[es:3]
 36421 00002E9D 2603060300              	add	ax,[es:ARENA.SIZE]
 36422 00002EA2 40                      	inc	ax
 36423                                  	; 22/07/2023
 36424                                  	;mov	es,ax
 36425 00002EA3 EBE4                    	jmp	short uf10
 36426                                  ufX:	
 36427 00002EA5 07                      	pop	es
 36428                                  	; 03/01/2023
 36429                                  	;pop	ax
 36430 00002EA6 C3                      	retn
 36431                                  
 36432                                  ; -----------------------------------------------------------------------------
 36433                                  ;*** isFrozMCB - returns with ZF set if current MCB (ES:0) is FROZEN
 36434                                  ; -----------------------------------------------------------------------------
 36435                                  ; ENTRY:    ES:0 should point to an MCB
 36436                                  ; EXIT:     ZF set if MCB is frozen, else !ZF
 36437                                  ; ERROR:    None
 36438                                  ; USES:     Flags
 36439                                  ; -----------------------------------------------------------------------------
 36440                                  
 36441                                  isFrozMCB:
 36442                                  	;push	ax
 36443                                  
 36444                                  	;mov	ax,[es:ARENA.OWNER]	; Check the owner...
 36445                                  	;cmp	ax,SystemPSPOwner	; 8 (for US OR Japan) is valid
 36446 00002EA7 26833E010008            	cmp	word [es:ARENA.OWNER],SystemPSPOwner
 36447 00002EAD 7522                    	jne	short ifmX
 36448                                  
 36449                                  	;mov	ax,[es:ARENA.NAME+0]
 36450                                  	;cmp	ax,'FR' ; 5246h
 36451 00002EAF 26813E08004652          	cmp	word [es:ARENA.NAME+0],'FR'
 36452 00002EB6 7519                    	jne	short ifmX
 36453                                  	;mov	ax,[es:ARENA.NAME+2]
 36454                                  	;cmp	ax,'OZ' ; 5A4Fh
 36455 00002EB8 26813E0A004F5A          	cmp	word [es:ARENA.NAME+2],'OZ'
 36456 00002EBF 7510                    	jne	short ifmX
 36457                                  	;mov	ax,[es:ARENA.NAME+4]
 36458                                  	;cmp	ax,'EN' ; 4E45h
 36459 00002EC1 26813E0C00454E          	cmp	word [es:ARENA.NAME+4],'EN'
 36460 00002EC8 7507                    	jne	short ifmX
 36461                                  	;mov	ax,[es:ARENA.NAME+6]
 36462                                  	;cmp	ax,'  ' ; 2020h
 36463 00002ECA 26813E0E002020          	cmp	word [es:ARENA.NAME+6],'  '
 36464                                  ifmX:	
 36465                                  	;pop	ax
 36466 00002ED1 C3                      	retn
 36467                                  
 36468                                  ; -----------------------------------------------------------------------------
 36469                                  ;*** frezMCB - marks as 8+FROZEN the MCB at ES:0
 36470                                  ; -----------------------------------------------------------------------------
 36471                                  ; ENTRY:    ES:0 should point to an MCB
 36472                                  ; EXIT:     None; MCB frozen
 36473                                  ; ERROR:    None
 36474                                  ; USES:     None
 36475                                  ; -----------------------------------------------------------------------------
 36476                                  
 36477                                  frezMCB:
 36478 00002ED2 26C70601000800          	mov	word [es:ARENA.OWNER],SystemPSPOwner ; 8
 36479 00002ED9 26C70608004652          	mov	word [es:ARENA.NAME+0],'FR'
 36480 00002EE0 26C7060A004F5A          	mov	word [es:ARENA.NAME+2],'OZ'
 36481 00002EE7 26C7060C00454E          	mov	word [es:ARENA.NAME+4],'EN'
 36482 00002EEE 26C7060E002020          	mov	word [es:ARENA.NAME+6],'  '
 36483 00002EF5 C3                      	retn
 36484                                  
 36485                                  ; -----------------------------------------------------------------------------
 36486                                  ;*** FreezeUM - Marks FROZEN all UM elements now FREE, save those in load UMB
 36487                                  ; -----------------------------------------------------------------------------
 36488                                  ; Entry:  None
 36489                                  ; Exit:   None; all free elements not in load UMB marked as 8+FROZEN
 36490                                  ; Error:  None
 36491                                  ; Uses:   Flags
 36492                                  ; -----------------------------------------------------------------------------
 36493                                  
 36494                                  	; 01/01/2023 - Retro DOS v4.2  
 36495                                  FreezeUM:
 36496                                  	; 01/01/2023
 36497                                  	;push	ax
 36498                                  	;push	cx
 36499                                  	;push	dx
 36500 00002EF6 06                      	push	es
 36501                                  
 36502                                  	;;call	GetLoadUMB
 36503                                  	; 01/01/2023
 36504                                  	; ds = cs
 36505                                  	;mov	al,[cs:UmbLoad] ; 19/04/2019 - Retro DOS v4.0
 36506 00002EF7 A0[591F]                	mov	al,[UmbLoad] 	
 36507                                  
 36508 00002EFA 30E4                    	xor	ah,ah		; Zap ah, so al==ax
 36509 00002EFC 89C2                    	mov	dx,ax		; Store the load UMB in DX, so we can skip it
 36510                                  
 36511 00002EFE E85BFD                  	call	UmbHead		; Returns first UMB segment in AX
 36512                                  	; 22/07/2023
 36513                                  	;mov	es,ax ; *
 36514 00002F01 31C9                    	xor	cx,cx		; Pretend we're on UMB 0 for now...
 36515                                  
 36516                                  	; 22/07/2023
 36517                                  fum10:
 36518 00002F03 8EC0                    	mov	es,ax ; *
 36519                                  
 36520                                  ; -----------------------------------------
 36521                                  ; FUM10--ES - Current MCB address
 36522                                  ;        CX - Current UMB number
 36523                                  ;        DX - UMB number to skip (load UMB)
 36524                                  ; -----------------------------------------
 36525                                  
 36526                                  ;fum10:	
 36527 00002F05 E861FD                  	call	isSysMCB	; Returns with ZF set if owner is SYSTEM
 36528 00002F08 7501                    	jnz	short fum20
 36529                                  
 36530 00002F0A 41                      	inc	cx		; If it _was_ SYSTEM, we're in a new UMB.
 36531                                  fum20:	
 36532 00002F0B 39D1                    	cmp	cx,dx		; If this is the load UMB, we don't want to
 36533 00002F0D 740B                    	je	short fum30	; freeze anything... so skip that section.
 36534                                  
 36535                                  	;call	isFreeMCB	; Oh. If it's not free, we can't freeze it
 36536 00002F0F 26830E010000            	or	word [es:ARENA.OWNER],0
 36537 00002F15 7503                    	jnz	short fum30	; either.
 36538                                  
 36539 00002F17 E8B8FF                  	call	frezMCB
 36540                                  fum30:	
 36541                                  	;mov	al,[es:ARENA.SIGNATURE]
 36542                                  	;cmp	al,arena_signature_end ; 'Z'
 36543                                  	; 22/07/2023
 36544 00002F1A 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],arena_signature_end ; 'Z'
 36545 00002F20 7408                    	je	short fumX	; 'Z' means this was the last MCB.. that's it.
 36546                                  
 36547                                  	;NextMCB es, ax		; Go on forward.
 36548                                  	; 22/07/2023
 36549                                  	; ax = es
 36550                                  	;mov	ax,es
 36551                                  	;add	ax,[es:3]
 36552 00002F22 2603060300              	add	ax,[es:ARENA.SIZE]
 36553 00002F27 40                      	inc	ax
 36554                                  	; 22/07/2023
 36555                                  	;mov	es,ax ; *
 36556 00002F28 EBD9                    	jmp	short fum10
 36557                                  
 36558 00002F2A 07                      fumX:	pop	es
 36559                                  	; 01/01/2023
 36560                                  	;pop	dx
 36561                                  	;pop	cx
 36562                                  	;pop	ax
 36563 00002F2B C3                      	retn
 36564                                  
 36565                                  ; -----------------------------------------------------------------------------
 36566                                  ;*** UmbTest - returns with carry set if UMBs are not available, else CF==false
 36567                                  ; -----------------------------------------------------------------------------
 36568                                  ; ENTRY:    None
 36569                                  ; EXIT:     Carry is clear if UMBs are available, or set if they are not
 36570                                  ; ERROR:    None
 36571                                  ; USES:     CF (AX,BX,DS,ES pushed 'cause they're used by others)
 36572                                  ; -----------------------------------------------------------------------------
 36573                                  
 36574                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 36575                                  UmbTest:
 36576                                  	; 01/01/2023
 36577                                  	;push	ax
 36578 00002F2C 53                      	push	bx ; *
 36579                                  	;push	ds
 36580 00002F2D 06                      	push	es ; **
 36581                                  
 36582                                  	; 01/01/2023
 36583                                  	; ds = cs
 36584                                  
 36585 00002F2E E871FB                  	call	fm_link			; Link in UMBs (if not already linked)
 36586 00002F31 E80800                  	call	WalkMem			; Check to see if they're really linked
 36587 00002F34 9C                      	pushf				; And remember what we found out
 36588 00002F35 E87BFB                  	call	fm_unlink		; Unlink UMBs (if WE have linked 'em)
 36589 00002F38 9D                      	popf				; And restore what we found out.
 36590                                  
 36591 00002F39 07                      	pop	es ; **
 36592                                  	; 01/01/2023
 36593                                  	;pop	ds
 36594 00002F3A 5B                      	pop	bx ; *
 36595                                  	;pop	ax
 36596 00002F3B C3                      	retn
 36597                                  
 36598                                  ; -----------------------------------------------------------------------------
 36599                                  ;*** WalkMem - travels memory chain and returns carry clear if UMBs are linked
 36600                                  ; -----------------------------------------------------------------------------
 36601                                  ; ENTRY:    None
 36602                                  ; EXIT:     Carry SET if MCB chain stops before 9FFF, CLEAR if stops >= 9FFF.
 36603                                  ; ERROR:    None
 36604                                  ; USES:     Flags
 36605                                  ; -----------------------------------------------------------------------------
 36606                                  
 36607                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 36608                                  	; (SYSINIT:3541h)
 36609                                  
 36610                                  WalkMem:
 36611                                  	;push	ax ; ?
 36612                                  	;push	bx ; ?
 36613                                  	;;push	ds ; ? ; 01/01/2023 (MSDOS 6.21 IO.SYS, SYSINIT:352Fh)
 36614                                  	;push	es ; ? no need to save contents of these registers ?
 36615                                  		   	
 36616 00002F3C B452                    	mov	ah,GET_IN_VARS		; Call int 21h, function 52h...
 36617 00002F3E CD21                    	int	21h
 36618                                  
 36619 00002F40 268B47FE                	mov	ax,[es:bx-2]
 36620                                  	; 22/07/2023
 36621                                  um10:
 36622 00002F44 8EC0                    	mov	es,ax ; * ; **
 36623                                  
 36624                                  ; ------------------------------
 36625                                  ; UM10: ES = Current MCB pointer
 36626                                  ; ------------------------------
 36627                                  
 36628                                  ;um10:
 36629                                  	;mov	al,[es:ARENA.SIGNATURE]
 36630                                  	;cmp	al,arena_signature_end ; 'Z'
 36631                                  	; 22/07/2023
 36632 00002F46 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],arena_signature_end ; 'Z'
 36633 00002F4C 7408                    	je	short um20		; If signature == 'Z', hay no more.
 36634                                  
 36635                                  	;NextMCB es,bx			; Move to the next MCB
 36636                                  
 36637                                  	;mov	bx,es
 36638                                  	;;add	bx,[es:3]
 36639                                  	;add	bx,[es:ARENA.SIZE]
 36640                                  	;inc	bx
 36641                                  	;mov	es,bx
 36642                                  	; 22/07/2023
 36643                                  	; ax = es
 36644                                  	;mov	ax,es ; *
 36645 00002F4E 2603060300              	add	ax,[es:ARENA.SIZE]
 36646 00002F53 40                      	inc	ax
 36647                                  	;mov	es,ax ; **
 36648                                  	
 36649 00002F54 EBEE                    	jmp	short um10		; And restart the loop.
 36650                                  um20:	
 36651                                  	; 22/07/2023
 36652                                  	; ax = es
 36653                                  	;mov	ax,es
 36654                                  
 36655 00002F56 3DFF9F                  	cmp	ax,9FFFh		; This sets CF if ax < 9FFF.
 36656                                  
 36657                                  	;pop	es ; ?
 36658                                  	;;pop	ds ; ? ; 01/01/2023 (MSDOS 6.21 IO.SYS, SYSINIT:353Dh)
 36659                                  	;pop	bx ; ?
 36660                                  	;pop	ax ; ?
 36661                                  	
 36662 00002F59 C3                      	retn
 36663                                  
 36664                                  ; -----------------------------------------------------------------------------
 36665                                  ;*** hl_unlink - unlinks UMBs if fm_umb is set to 0; restores strategy too
 36666                                  ; -----------------------------------------------------------------------------
 36667                                  ; ENTRY:    fm_umb == 1 : leave linked, else unlink
 36668                                  ; EXIT:     None
 36669                                  ; ERROR:    None
 36670                                  ; USES:     AX, BX
 36671                                  ; -----------------------------------------------------------------------------
 36672                                  
 36673                                  	; 01/01/2023 - Retro DOS v4.2
 36674                                  hl_unlink:
 36675 00002F5A 30FF                    	xor	bh,bh
 36676                                  
 36677                                  	;getdata bl,fm_umb		; Restore original link-state
 36678                                  	;
 36679                                  	;push	ds
 36680                                  	;push	cs
 36681                                  	;pop	ds
 36682                                  	;mov	bl,[fm_umb]
 36683                                  	;pop	ds
 36684                                  
 36685                                  	; 01/01/2023
 36686                                  	; ds = cs
 36687                                  	;mov	bl,[cs:fm_umb]
 36688 00002F5C 8A1E[8A1F]              	mov	bl,[fm_umb]
 36689                                  
 36690 00002F60 B80358                  	mov	ax,DOS_SET_UMBLINK ; 5803h
 36691 00002F63 CD21                    	int	21h
 36692 00002F65 C3                      	retn
 36693                                  
 36694                                  ; ----------------------------------------------------------------------
 36695                                  ; HIGHEXIT.INC (MSDOS 6.0 - 1991) 	
 36696                                  ; ----------------------------------------------------------------------
 36697                                  ; 09/04/2019 - Retro DOS v4.0
 36698                                  
 36699                                  ;   Module:   HIGHEXIT.INC - Code executed after LoadHigh or DeviceHigh
 36700                                  ;   Date:     May 14, 1992
 36701                                  
 36702                                  ;   Modification log:
 36703                                  ;
 36704                                  ;     DATE    WHO      DESCRIPTION
 36705                                  ;   --------  -------  --------------------------------------------------------
 36706                                  ;   05/14/92  t-richj  Original
 36707                                  ;   06/21/92  t-richj  Final revisions before check-in
 36708                                  
 36709                                  UMB_HeadIdx	equ	8Ch	; Offset from ES (after func52h) to get UMBHead
 36710                                  
 36711                                  ; -----------------------------------------------------------------------------
 36712                                  ;*** UnHideUMBs - Marks HIDDEN elements as FREE
 36713                                  ; -----------------------------------------------------------------------------
 36714                                  ; ENTRY:  None; perhaps, earlier, HideUMBs was called... if not, we have
 36715                                  ;               very little to do, as no elelments will be marked as HIDDEN.
 36716                                  ; EXIT:   Sets InHigh to zero; carry clear if HideUMBs was called earlier.
 36717                                  ; ERROR:  None
 36718                                  ; USES:   fInHigh (from highvar.inc), carry flag
 36719                                  ; -----------------------------------------------------------------------------
 36720                                  
 36721                                  	; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 36722                                  	; (SYSINIT:357Bh)
 36723                                  
 36724                                  UnHideUMBs:
 36725 00002F66 50                      	push	ax		; Save ax for what we're about to do
 36726                                  
 36727                                  ; -----------------------------------------------------------------------------
 36728                                  ; BUGBUG t-richj 11-8-92: The following six lines were commented out for a good
 36729                                  ;    length of time. Those six constitute a check of whether or not we should
 36730                                  ;    indeed clean up the upper-memory chain; without such a check, COMMAND.COM
 36731                                  ;    will destroy the current link-state and memory-allocation strategy after
 36732                                  ;    every command execution.
 36733                                  ; -----------------------------------------------------------------------------
 36734                                  
 36735                                  	;getdata al,fInHigh	; Get InHigh from data segment
 36736                                  	;
 36737                                  	;push	ds
 36738                                  	;push	cs
 36739                                  	;pop	ds
 36740                                  	;mov	al,[fInHigh]
 36741                                  	;pop	ds	
 36742                                  
 36743                                  	;mov	al,[cs:fInHigh]
 36744                                  	; 31/12/2022
 36745                                  	; ds = cs
 36746 00002F67 A0[551F]                	mov	al,[fInHigh]	
 36747                                  
 36748 00002F6A 08C0                    	or	al,al
 36749 00002F6C 7503                    	jnz	short uhu10	; If didn't call loadhigh/devicehigh earlier,
 36750                                  
 36751 00002F6E 58                      	pop	ax		; then there's nothing to do here... so
 36752 00002F6F F9                      	stc			; restore everything and return. Just like
 36753 00002F70 C3                      	retn			; that.
 36754                                  uhu10:	
 36755 00002F71 E88E00                  	call	linkumb		; Make sure UMBs are linked in.
 36756 00002F74 E81200                  	call	FreeUMBs
 36757                                  
 36758                                  	;putdata fInHigh,0	; We're leaving, so update fInHigh.
 36759                                  	;
 36760                                  	;push	es
 36761                                  	;push	cs
 36762                                  	;pop	es
 36763                                  	;mov	byte [es:fInHigh],0
 36764                                  	;pop	ds
 36765                                  
 36766                                  	; 31/12/2022
 36767                                  	; ds = cs	
 36768                                  	;mov	byte [cs:fInHigh],0
 36769 00002F77 C606[551F]00            	mov	byte [fInHigh],0
 36770                                  
 36771                                  	;call	he_unlink	; Unlink UMBs
 36772                                  	; 31/12/2022
 36773                                  ;;he_unlink:			; unlinks UMBs if fm_umb is set to 0
 36774 00002F7C 30FF                    	xor	bh,bh
 36775                                  
 36776                                  	;getdata bl,fm_umb	; Restore original link-state
 36777                                  	;mov	bl,[cs:fm_umb]	
 36778 00002F7E 8A1E[8A1F]              	mov	bl,[fm_umb]
 36779                                  
 36780 00002F82 B80358                  	mov	ax,DOS_SET_UMBLINK ; 5803h
 36781 00002F85 CD21                    	int	21h
 36782                                  	;;retn
 36783                                  
 36784 00002F87 58                      	pop	ax
 36785                                  	; 12/12/2022
 36786                                  	;clc	; 12/12/2022 (this clc may not be necessary!?)
 36787 00002F88 C3                      	retn
 36788                                  
 36789                                  ; 31/12/2022
 36790                                  ;%if 0
 36791                                  ;
 36792                                  ;; -----------------------------------------------------------------------------
 36793                                  ;;*** he_unlink - unlinks UMBs if fm_umb is set to 0
 36794                                  ;; -----------------------------------------------------------------------------
 36795                                  ;; ENTRY:    fm_umb == 1 : leave linked, else unlink
 36796                                  ;; EXIT:     None
 36797                                  ;; ERROR:    None
 36798                                  ;; USES:     AX, BX
 36799                                  ;; -----------------------------------------------------------------------------
 36800                                  ;
 36801                                  ;he_unlink:
 36802                                  ;	xor	bh, bh
 36803                                  ;
 36804                                  ;	;getdata bl, fm_umb	; Restore original link-state
 36805                                  ;	mov	bl,[cs:fm_umb]	
 36806                                  ;
 36807                                  ;	mov	ax,DOS_SET_UMBLINK ; 5803h
 36808                                  ;	int	21h
 36809                                  ;	retn
 36810                                  ;
 36811                                  ;%endif
 36812                                  
 36813                                  ; -----------------------------------------------------------------------------
 36814                                  ;*** freeUMBs - frees all HIDDEN memory elements in upper-memory.
 36815                                  ; -----------------------------------------------------------------------------
 36816                                  ; ENTRY:    None
 36817                                  ; EXIT:     None; HIDDEN memory elements returned to FREE
 36818                                  ; ERROR:    None (ignore CF)
 36819                                  ; USES:     Flags
 36820                                  ; -----------------------------------------------------------------------------
 36821                                  
 36822                                  FreeUMBs:
 36823 00002F89 50                      	push	ax
 36824 00002F8A 06                      	push	es
 36825                                  
 36826 00002F8B E86700                  	call	HeadUmb		; Returns with carry if err, else ES == MCB
 36827 00002F8E 721C                    	jc	short fusX
 36828                                  fus10:
 36829 00002F90 8EC0                    	mov	es,ax		; Prepare for the loop; ES = current MCB addr.
 36830                                  ;fus10:	
 36831 00002F92 E81A00                  	call	isHideMCB	; Returns with ZF set if owner is 0
 36832 00002F95 7505                    	jnz	short fus20
 36833 00002F97 E84000                  	call	freeMCB
 36834                                  	; 09/09/2023
 36835                                  	; ax <> es
 36836 00002F9A 8CC0                    	mov	ax,es
 36837                                  fus20:	   
 36838                                  	;mov	al,[es:ARENA.SIGNATURE]
 36839                                  	;cmp	al,arena_signature_end ; 'Z'
 36840                                  	; 22/07/2023
 36841 00002F9C 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],arena_signature_end ; 'Z'
 36842 00002FA2 7408                    	jz	short fusX	; That means this was the last MCB--that's it.
 36843                                  	
 36844                                  	; 22/07/2023
 36845                                  	; ax = es
 36846                                  	;mov	ax,es
 36847 00002FA4 2603060300              	add	ax,[es:ARENA.SIZE]
 36848 00002FA9 40                      	inc	ax
 36849                                  	; 22/07/2023
 36850                                  	;mov	es,ax
 36851 00002FAA EBE4                    	jmp	short fus10	; Go on forward.
 36852                                  fusX:	
 36853 00002FAC 07                      	pop	es
 36854 00002FAD 58                      	pop	ax
 36855 00002FAE C3                      	retn
 36856                                  
 36857                                  ; -----------------------------------------------------------------------------
 36858                                  ;*** isHideMCB - returns with ZF set if current MCB (ES:0) is HIDDEN
 36859                                  ; -----------------------------------------------------------------------------
 36860                                  ; ENTRY:    ES:0 should point to an MCB
 36861                                  ; EXIT:     ZF set if MCB is hidden, else !ZF
 36862                                  ; ERROR:    None
 36863                                  ; USES:     Flags
 36864                                  ; -----------------------------------------------------------------------------
 36865                                  
 36866                                  isHideMCB:
 36867                                  	;push	ax
 36868                                  
 36869 00002FAF 26833E010008            	cmp	word [es:ARENA.OWNER],SystemPSPOwner ; If the owner's SYSTEM
 36870 00002FB5 7522                    	jne	short ihm_x			     ; then check for HIDDEN
 36871                                  
 36872                                  	;mov	ax,[es:ARENA.NAME]
 36873                                  	;cmp	ax,'HI' ; 4948h
 36874 00002FB7 26813E08004849          	cmp	word [es:ARENA.NAME+0],'HI'
 36875 00002FBE 7519                    	jne	short ihm_x
 36876                                  	;mov	ax,[es:ARENA.NAME+2]
 36877                                  	;cmp	ax,'DD' ; 4444h
 36878 00002FC0 26813E0A004444          	cmp	word [es:ARENA.NAME+2],'DD'
 36879 00002FC7 7510                    	jne	short ihm_x
 36880                                  	;mov	ax,[es:ARENA.NAME+4]
 36881                                  	;cmp	ax,'EN' ; 4E45h
 36882 00002FC9 26813E0C00454E          	cmp	word [es:ARENA.NAME+4],'EN'
 36883 00002FD0 7507                    	jne	short ihm_x
 36884                                  	;mov	ax,[es:ARENA.NAME+6]
 36885                                  	;cmp	ax,'  ' ; 2020h
 36886 00002FD2 26813E0E002020          	cmp	word [es:ARENA.NAME+6],'  '
 36887                                  ihm_x:	
 36888                                  	;pop	ax
 36889 00002FD9 C3                      	retn
 36890                                  
 36891                                  ; -----------------------------------------------------------------------------
 36892                                  ;*** freeMCB - marks as free the MCB at ES:0
 36893                                  ; -----------------------------------------------------------------------------
 36894                                  ; ENTRY:    ES:0 should point to an MCB
 36895                                  ; EXIT:     None; MCB free'd
 36896                                  ; ERROR:    None
 36897                                  ; USES:     AX
 36898                                  ; -----------------------------------------------------------------------------
 36899                                  
 36900                                  freeMCB:
 36901 00002FDA 26C70601000000          	mov	word [es:ARENA.OWNER],0
 36902 00002FE1 B82020                  	mov	ax,'  ' ; mov ax,2020h ; 31/12/2022
 36903 00002FE4 26A30800                	mov	[es:ARENA.NAME+0],ax
 36904 00002FE8 26A30A00                	mov	[es:ARENA.NAME+2],ax
 36905 00002FEC 26A30C00                	mov	[es:ARENA.NAME+4],ax
 36906 00002FF0 26A30E00                	mov	[es:ARENA.NAME+6],ax
 36907 00002FF4 C3                      	retn
 36908                                  
 36909                                  ; -----------------------------------------------------------------------------
 36910                                  ;*** HeadUmb - returns in AX the address of the first UMB block (0x9FFF)
 36911                                  ; -----------------------------------------------------------------------------
 36912                                  ; ENTRY:  Nothing
 36913                                  ; EXIT:   AX contains 0x9FFF for most systems
 36914                                  ; ERROR:  Carry set if pointer is 0xFFFF (if not set up yet--DH runs into this)
 36915                                  ; USES:   Flags, AX
 36916                                  ; -----------------------------------------------------------------------------
 36917                                  
 36918                                  HeadUmb:
 36919                                  	; 13/05/2019
 36920                                  
 36921                                  	;push	si ; ?
 36922                                  	;push	ds ; ?
 36923                                  	;push	es
 36924                                  	;push	bx ; *
 36925                                  
 36926                                  	; 09/04/2019
 36927                                  	; !!! No need to save es,bx,ds,si above !!! (es,bx are changed here)
 36928                                  
 36929 00002FF5 B452                    	mov	ah,GET_IN_VARS		; Call int 21h, function 52h...
 36930 00002FF7 CD21                    	int	21h
 36931                                  			; DOS - 2+ internal - GET LIST OF LISTS
 36932                                  			; Return: ES:BX -> DOS list of lists
 36933                                  	;mov	ax,[es:8Ch]
 36934 00002FF9 26A18C00                	mov	ax,[es:UMB_HeadIdx]	; And read what's in ES:008C
 36935 00002FFD 83F8FF                  	cmp	ax,0FFFFh
 36936                                  	;je	short xhu_e		; If it's 0xFFFF, it's an error...
 36937                                  
 36938                                  	;clc				; Else, it isn't.
 36939                                  	;jmp	short xhu_x
 36940                                  xhu_e:	
 36941                                  	;stc
 36942 00003000 F5                      	cmc	; 09/04/2019 - Retro DOS v4.0 ; *
 36943                                  xhu_x:	
 36944                                  	;pop	bx ; *
 36945                                  	;pop	es	
 36946                                  	;pop	ds ; ?
 36947                                  	;pop	si ; ?
 36948 00003001 C3                      	retn
 36949                                  
 36950                                  ; -----------------------------------------------------------------------------
 36951                                  ;*** linkumb - links UMBs not already linked in; updates fm_umb as needed
 36952                                  ; -----------------------------------------------------------------------------
 36953                                  ; ENTRY:    None
 36954                                  ; EXIT:     fm_umb == 0 if not linked in previously, 1 if already linked in
 36955                                  ; ERROR:    None
 36956                                  ; USES:     AX, BX, fm_umb
 36957                                  ; -----------------------------------------------------------------------------
 36958                                  
 36959                                  linkumb:
 36960 00003002 B80258                  	mov	ax,DOS_GET_UMBLINK ; 5802h
 36961 00003005 CD21                    	int	21h			; Current link-state is now in al
 36962                                  
 36963 00003007 08C0                    	or	al,al			; BUGBUG: proper check?
 36964 00003009 7508                    	jnz	short lumbX		; Jumps if UMBs already linked in
 36965                                  
 36966 0000300B B80358                  	mov	ax,DOS_SET_UMBLINK ; 5803h
 36967 0000300E BB0100                  	mov	bx,1
 36968 00003011 CD21                    	int	21h
 36969                                  lumbX:
 36970 00003013 C3                      	retn
 36971                                  
 36972                                  ;%endif
 36973                                  
 36974                                  ; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 36975                                  ; (SYSINIT:2B5Fh)
 36976                                  
 36977                                  ; ----------------------------------------------------------------------
 36978                                  ; SYSCONF.ASM (MSDOS 6.0 - 1991) 	
 36979                                  ; ----------------------------------------------------------------------
 36980                                  ; 09/04/2019 - Retro DOS v4.0
 36981                                  
 36982                                  ;----------------------------------------------------------------------------
 36983                                  ;
 36984                                  ; procedure : InitDevLoad
 36985                                  ;
 36986                                  ;	Input : DeviceHi = 0 indicates load DD in low memory
 36987                                  ;			 = 1 indicates load in UMB:
 36988                                  ;		           ConvLoad = 0 indicates a new-style load (see below)
 36989                                  ;		                    = 1 indicates a DOS 5-style load
 36990                                  ;		DevSize  = Size of the device driver file in paras
 36991                                  ;
 36992                                  ;	Output : none
 36993                                  ;
 36994                                  ;	Initializes DevLoadAddr, DevLoadEnd & DevEntry.
 36995                                  ;	Also sets up a header for the Device driver entry for mem utility
 36996                                  ;
 36997                                  ;----------------------------------------------------------------------------
 36998                                  ; For a "new-style load", we break off the current DevEntry and link the umbs
 36999                                  ; as we see fit, using HideUMBs (and UnHideUMBs at exit, though _it_ decides
 37000                                  ; whether it's entitled to do anything). HideUMBs uses the chart built by
 37001                                  ; ParseVar to determine which UMBs to leave FREE, and which not.
 37002                                  ;----------------------------------------------------------------------------
 37003                                  
 37004                                  	; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 37005                                  	; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 37006                                  	; (SYSINIT:364Ah)
 37007                                  InitDevLoad:
 37008                                  	; 01/01/2023
 37009                                  	;push	es ; *
 37010                                  
 37011                                  	; 11/12/2022
 37012                                  	; ds = cs
 37013 00003014 803E[AB1F]00            	cmp	byte [DeviceHi],0
 37014                                  	;cmp	byte [cs:DeviceHi],0	; Are we loading in UMB ?
 37015                                  	;je	short InitForLo		; no, init for lo mem
 37016 00003019 7439                    	je	short initforlo_x ; 09/04/2019
 37017                                  
 37018                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 37019                                  ; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37020                                  ; %if 0
 37021                                  	; 01/01/2023
 37022 0000301B 803E[9B1F]01            	cmp	byte [ConvLoad],1
 37023                                  	;cmp	byte [cs:ConvLoad],1	; Are we loading as per DOS 5?
 37024 00003020 7413                    	je	short InitForConv
 37025                                  
 37026                                  ; There are two stages to preparing upper-memory; first, we mark as 8+HIDDEN
 37027                                  ; any areas not specified on the /L:... chain. Second, we mark as 8+FROZEN
 37028                                  ; any areas left in upper-memory, except for elements in the load UMB...
 37029                                  ; we then malloc space as per Dos-5 style, and mark as free any spaces which
 37030                                  ; are 8+FROZEN (but leave 8+HIDDEN still hidden). The load is performed,
 37031                                  ; and UnHideUMBs later on marks all 8+HIDDEN as free.
 37032                                  
 37033 00003022 E85704                  	call	ShrinkUMB		; Stop using the old device arena
 37034                                  
 37035 00003025 E892FC                  	call	HideUMBs		; Mark up the UM area as we see fit
 37036 00003028 E8CBFE                  	call	FreezeUM		; Hide everything BUT the load area
 37037 0000302B E85700                  	call	GetUMBForDev		; And grab that load area as needed
 37038 0000302E 9C                      	pushf
 37039 0000302F E851FE                  	call	UnFreeze		; Then unhide everything frozen
 37040 00003032 9D                      	popf
 37041                                  	;jc	short InitForLo		; (if carry, it's loading low)
 37042                                  	;jmp	short InitForHi
 37043                                  	; 06/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 37044 00003033 EB0B                    	jmp	short idl0
 37045                                  
 37046                                  ;%endif ; 01/11/2022
 37047                                  
 37048                                  	; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 37049                                  	; (SYSINIT:2B67h)
 37050                                  InitForConv:
 37051                                  	; 11/12/2022
 37052                                  	; ds = cs
 37053 00003035 E83700                  	call	SpaceInUMB		; Do we have space left in the
 37054                                  					;  current UMB ?
 37055 00003038 7308                    	jnc	short InitForHi		; yes, we have
 37056 0000303A E83F04                  	call	ShrinkUMB		; shrink the current UMB in use
 37057 0000303D E84500                  	call	GetUMBForDev		; else try to allocate new UMB
 37058                                  idl0: ; 06/07/2023
 37059 00003040 720D                    	jc	short InitForLo		; we didn't succeed, so load
 37060                                  					;  in low memory
 37061                                  InitForHi:
 37062                                  	; 11/12/2022
 37063                                  	; ds = cs
 37064                                  	;mov	ax,[cs:DevUMBFree]	; get Para addr of free mem
 37065                                  	;mov	dx,[cs:DevUMBAddr]	; UMB start addr
 37066                                  	;add	dx,[cs:DevUMBSize]	; DX = UMB End addr
 37067 00003042 A1[A11F]                	mov	ax,[DevUMBFree]
 37068 00003045 8B16[9D1F]              	mov	dx,[DevUMBAddr]
 37069 00003049 0316[9F1F]              	add	dx,[DevUMBSize]
 37070 0000304D EB0C                    	jmp	short idl1
 37071                                  
 37072                                  InitForLo:
 37073                                  	; 11/12/2022
 37074                                  	; ds = cs
 37075                                  	;mov	byte [cs:DeviceHi],0	; in case we failed to load
 37076 0000304F C606[AB1F]00            	mov	byte [DeviceHi],0
 37077                                  initforlo_x:
 37078                                  	; 11/12/2022
 37079                                  	; ds = cs
 37080                                  					;  into UMB indicate that
 37081                                  					;  we are loading low
 37082                                  	;mov	ax,[cs:memhi]		; AX = Start of Low memory
 37083                                  	;mov	dx,[cs:ALLOCLIM]	; DX = End of Low memory
 37084 00003054 A1[6403]                	mov	ax,[memhi]
 37085 00003057 8B16[A502]              	mov	dx,[ALLOCLIM]
 37086                                  idl1:
 37087 0000305B E86600                  	call	DevSetMark		; setup a sub-arena for DD
 37088                                  	; 11/12/2022
 37089                                  	; ds = cs
 37090                                  	;mov	[cs:DevLoadAddr],ax	; init the Device load address
 37091                                  	;mov	[cs:DevLoadEnd],dx	; init the limit of the block
 37092                                  	;mov	word [cs:DevEntry],0	; init Entry point to DD
 37093                                  	;mov	[cs:DevEntry+2],ax
 37094 0000305E A3[8F1F]                	mov	[DevLoadAddr],ax
 37095 00003061 8916[911F]              	mov	[DevLoadEnd],dx
 37096 00003065 C706[931F]0000          	mov	word [DevEntry],0
 37097 0000306B A3[951F]                	mov	[DevEntry+2],ax
 37098                                  	; 01/01/2023
 37099                                  	;pop	es ; *
 37100 0000306E C3                      	retn
 37101                                  
 37102                                  ;----------------------------------------------------------------------------
 37103                                  ;
 37104                                  ; procedure : SpaceInUMB?
 37105                                  ;
 37106                                  ;	Input : DevUMBAddr, DevUMBSize, DevUMBFree & DevSize
 37107                                  ;	Output : Carry set if no space in UMB
 37108                                  ;		 Carry clear if Space is available for the device in
 37109                                  ;		   current UMB
 37110                                  ;
 37111                                  ;----------------------------------------------------------------------------
 37112                                  
 37113                                  SpaceInUMB:
 37114                                  	; 11/12/2022
 37115                                  	; ds = cs
 37116                                  	;mov	ax,[cs:DevUMBSize]
 37117                                  	;add	ax,[cs:DevUMBAddr]	; End of UMB
 37118                                  	;sub	ax,[cs:DevUMBFree]	; - Free = Remaining space
 37119 0000306F A1[9F1F]                	mov	ax,[DevUMBSize]
 37120 00003072 0306[9D1F]              	add	ax,[DevUMBAddr]		; End of UMB
 37121 00003076 2B06[A11F]              	sub	ax,[DevUMBFree]		; - Free = Remaining space
 37122                                  	; 11/12/2022
 37123                                  	;or	ax,ax			; Nospace ?
 37124                                  	;jnz	short spcinumb1
 37125                                  	;stc
 37126                                  	;retn
 37127                                  	; 11/12/2022
 37128 0000307A 83F801                  	cmp	ax,1
 37129 0000307D 7205                    	jb	short spcinumb2	; cf=1
 37130                                  spcinumb1:
 37131 0000307F 48                      	dec	ax			; space for sub-arena
 37132                                  	; 11/12/2022
 37133                                  	; ds = cs
 37134 00003080 3B06[8D1F]              	cmp	ax,[DevSize]
 37135                                  	;cmp	ax,[cs:DevSize]		; do we have space ?
 37136                                  spcinumb2:
 37137 00003084 C3                      	retn
 37138                                  
 37139                                  ;----------------------------------------------------------------------------
 37140                                  ;
 37141                                  ; procedure : PrepareMark
 37142                                  ;
 37143                                  ;	Input : AX==Address of MCB (not addr of free space), BX==Size
 37144                                  ;	Output : None; MCB marked appropriately and DevUMB* set as needed.
 37145                                  ;
 37146                                  ;----------------------------------------------------------------------------
 37147                                  
 37148                                  ;	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37149                                  ;
 37150                                  ;PrepareMark:
 37151                                  ;	push	ds
 37152                                  ;	mov	ds,ax
 37153                                  ;	mov	word [ARENA.OWNER],8
 37154                                  ;	mov	word [ARENA.NAME],'SD' ; 4453h
 37155                                  ;	pop	ds
 37156                                  ;
 37157                                  ;	inc	ax
 37158                                  ;	mov	[cs:DevUMBAddr],ax
 37159                                  ;	mov	[cs:DevUMBFree],ax
 37160                                  ;	mov	[cs:DevUMBSize],bx	; update the UMB Variables
 37161                                  ;	retn
 37162                                  
 37163                                  ;----------------------------------------------------------------------------
 37164                                  ;
 37165                                  ; procedure : GetUMBForDev
 37166                                  ;
 37167                                  ;	Input : DevSize
 37168                                  ;	Output : Carry set if couldn't allocate a UMB to fit the
 37169                                  ;		 the device.
 37170                                  ;		 If success carry clear
 37171                                  ;
 37172                                  ;	Allocates the biggest UMB for loading devices and updates
 37173                                  ;	DevUMBSize, DevUMBAddr & DevUMBFree if it succeeded in allocating
 37174                                  ;	UMB.
 37175                                  ;
 37176                                  ;	This routine relies on the fact that all of the low memory
 37177                                  ;	is allocated, and any DOS alloc calls should return memory
 37178                                  ;	from the UMB pool.
 37179                                  ;
 37180                                  ;----------------------------------------------------------------------------
 37181                                  
 37182                                  	; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 37183                                  	; (SYSINIT:2BC6h)
 37184                                  
 37185                                  GetUMBForDev:
 37186                                  	; 11/12/2022
 37187                                  	; ds = cs
 37188 00003085 BBFFFF                  	mov	bx,0FFFFh
 37189 00003088 B80048                  	mov	ax,4800h
 37190 0000308B CD21                    	int	21h
 37191                                  		; DOS - 2+ - ALLOCATE MEMORY
 37192                                  		; BX = number of 16-byte paragraphs desired
 37193                                  
 37194 0000308D 09DB                    	or	bx,bx
 37195                                  	;jz	short gufd_err
 37196                                  	; 09/09/2023
 37197 0000308F 742E                    	jz	short gufd_error ; bx = 0
 37198                                  
 37199 00003091 4B                      	dec	bx
 37200                                  	; 11/12/2022
 37201                                  	; ds = cs
 37202 00003092 391E[8D1F]              	cmp	[DevSize],bx
 37203                                  	;cmp	[cs:DevSize],bx
 37204 00003096 7725                    	ja	short gufd_err
 37205                                  
 37206 00003098 43                      	inc	bx
 37207                                  
 37208 00003099 B80048                  	mov	ax,4800h
 37209 0000309C CD21                    	int	21h
 37210 0000309E 721D                    	jc	short gufd_err
 37211                                  
 37212                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37213                                  	;dec	ax
 37214                                  	;call	PrepareMark
 37215                                  	;
 37216                                  PrepareMark:
 37217 000030A0 1E                      	push	ds
 37218 000030A1 48                      	dec	ax
 37219 000030A2 8ED8                    	mov	ds,ax
 37220 000030A4 C70601000800            	mov	word [ARENA.OWNER],8
 37221 000030AA C70608005344            	mov	word [ARENA.NAME],'SD' ; 4453h
 37222 000030B0 40                      	inc	ax
 37223 000030B1 1F                      	pop	ds
 37224                                  	; 11/12/2022
 37225                                  	; ds = cs
 37226                                  	;mov	[cs:DevUMBSize],bx	; update the UMB Variables
 37227                                  	;mov	[cs:DevUMBAddr],ax
 37228                                  	;mov	[cs:DevUMBFree],ax
 37229                                  gufd_x:		; 09/09/2023
 37230 000030B2 891E[9F1F]              	mov	[DevUMBSize],bx		; update the UMB Variables
 37231 000030B6 A3[9D1F]                	mov	[DevUMBAddr],ax
 37232 000030B9 A3[A11F]                	mov	[DevUMBFree],ax
 37233                                  	;
 37234                                  	; 11/12/2022
 37235                                  	; cf=0
 37236                                  	;clc				; mark no error
 37237 000030BC C3                      	retn
 37238                                  
 37239                                  	; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 37240                                  %if 1
 37241                                  gufd_err:
 37242 000030BD 31DB                    	xor	bx,bx ; 0
 37243                                  gufd_error:
 37244 000030BF 31C0                    	xor	ax,ax ; 0
 37245 000030C1 F9                      	stc	; cf=1
 37246 000030C2 EBEE                    	jmp	short gufd_x	
 37247                                  %endif
 37248                                  
 37249                                  ; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 37250                                  %if 0
 37251                                  gufd_err:
 37252                                  	xor	ax,ax ; 0
 37253                                  	; 11/12/2022
 37254                                  	; ds = cs
 37255                                  	;mov	[cs:DevUMBSize],ax	; erase the previous values
 37256                                  	;mov	[cs:DevUMBAddr],ax
 37257                                  	;mov	[cs:DevUMBFree],ax
 37258                                  	mov	[DevUMBSize],ax		; erase the previous values
 37259                                  	mov	[DevUMBAddr],ax
 37260                                  	mov	[DevUMBFree],ax
 37261                                  	stc
 37262                                  	retn
 37263                                  %endif
 37264                                  
 37265                                  ;----------------------------------------------------------------------------
 37266                                  ;
 37267                                  ; procedure : DevSetMark
 37268                                  ;
 37269                                  ;	Input : AX - Free segment were device is going to be loaded
 37270                                  ;	Output : AX - Segment at which device can be loaded (AX=AX+1)
 37271                                  ;
 37272                                  ;	Creates a sub-arena for the device driver
 37273                                  ;	puts 'D' marker in the sub-arena
 37274                                  ;	Put the owner of the sub-arena as (AX+1)
 37275                                  ;	Copies the file name into sub-arena name field
 37276                                  ;
 37277                                  ;	Size field of the sub-arena will be set only at succesful
 37278                                  ;	completion of Device load.
 37279                                  ;
 37280                                  ;----------------------------------------------------------------------------
 37281                                  
 37282                                  	; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 37283                                  	; (SYSINIT:2C13h)
 37284                                  
 37285                                  DevSetMark:
 37286 000030C4 06                      	push	es
 37287                                  	; 03/01/2023
 37288                                  	;push	di
 37289 000030C5 1E                      	push	ds
 37290 000030C6 56                      	push	si
 37291 000030C7 8EC0                    	mov	es,ax
 37292 000030C9 26C606000044            	mov	byte [es:devmark.id],devmark_device ; 'D'
 37293 000030CF 40                      	inc	ax
 37294 000030D0 26A30100                	mov	[es:devmark.seg],ax
 37295                                  
 37296                                  ;-------------- Copy file name
 37297                                  
 37298 000030D4 50                      	push	ax			; save load address
 37299                                  	
 37300                                  	; 09/09/2023
 37301                                  	; ds = cs
 37302                                  	;lds	si,[cs:bpb_addr]	; command line is still there
 37303 000030D5 C536[8103]              	lds	si,[bpb_addr]
 37304                                  
 37305 000030D9 89F7                    	mov	di,si
 37306 000030DB FC                      	cld
 37307                                  dsm_again:
 37308 000030DC AC                      	lodsb
 37309 000030DD 3C3A                    	cmp	al,':'
 37310 000030DF 7504                    	jne	short isit_slash
 37311 000030E1 89F7                    	mov	di,si
 37312 000030E3 EBF7                    	jmp	short dsm_again
 37313                                  isit_slash:
 37314 000030E5 3C5C                    	cmp	al,'\'
 37315 000030E7 7504                    	jne	short isit_null
 37316 000030E9 89F7                    	mov	di,si
 37317 000030EB EBEF                    	jmp	short dsm_again
 37318                                  isit_null:
 37319 000030ED 08C0                    	or	al,al
 37320 000030EF 75EB                    	jnz	short dsm_again
 37321 000030F1 89FE                    	mov	si,di
 37322                                  
 37323 000030F3 BF0800                  	mov	di,devmark.filename ; 8
 37324 000030F6 B90800                  	mov	cx,8			; maximum 8 characters
 37325                                  dsm_next_char:
 37326 000030F9 AC                      	lodsb
 37327 000030FA 08C0                    	or	al,al
 37328 000030FC 7407                    	jz	short blankout
 37329 000030FE 3C2E                    	cmp	al,'.'
 37330 00003100 7403                    	je	short blankout
 37331 00003102 AA                      	stosb
 37332 00003103 E2F4                    	loop	dsm_next_char
 37333                                  blankout:
 37334 00003105 E304                    	jcxz	dsm_exit
 37335 00003107 B020                    	mov	al,' '
 37336 00003109 F3AA                    	rep	stosb			; blank out the rest
 37337                                  dsm_exit:
 37338 0000310B 58                      	pop	ax			; restore load address
 37339 0000310C 5E                      	pop	si
 37340 0000310D 1F                      	pop	ds
 37341                                  	; 03/01/2023
 37342                                  	;pop	di
 37343 0000310E 07                      	pop	es
 37344 0000310F C3                      	retn
 37345                                  
 37346                                  ;----------------------------------------------------------------------------
 37347                                  ;
 37348                                  ; procedure : SizeDevice
 37349                                  ;
 37350                                  ;	Input : ES:SI - points to device file to be sized
 37351                                  ;
 37352                                  ;	Output : Carry set if file cannot be opened or if it is an OS2EXE file
 37353                                  ;
 37354                                  ;	Calculates the size of the device file in paras and stores it
 37355                                  ;	in DevSize
 37356                                  ;
 37357                                  ;----------------------------------------------------------------------------
 37358                                  
 37359                                  	; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 37360                                  SizeDevice:
 37361                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37362                                  	; 11/12/2022 ; *
 37363 00003110 1E                      	push	ds ; *
 37364 00003111 06                      	push	es
 37365 00003112 1F                      	pop	ds
 37366 00003113 89F2                    	mov	dx,si			; ds:dx -> file name
 37367 00003115 B8003D                  	mov	ax,3D00h		; open
 37368 00003118 CD21                    	int	21h
 37369 0000311A 7237                    	jc	short sd_err		; open failed
 37370                                  
 37371 0000311C 89C3                    	mov	bx,ax			; BX - file handle
 37372 0000311E B80242                  	mov	ax,4202h		; seek
 37373 00003121 31C9                    	xor	cx,cx
 37374 00003123 89CA                    	mov	dx,cx			; to end of file
 37375 00003125 CD21                    	int	21h
 37376 00003127 7223                    	jc	short sd_close		; did seek fail (impossible)
 37377 00003129 83C00F                  	add	ax,15			; para convert
 37378 0000312C 83D200                  	adc	dx,0
 37379 0000312F F7C2F0FF                	test	dx,0FFF0h		; size > 0ffffh paras ?
 37380                                  	;jz	short szdev1		; no
 37381                                  	; 22/07/2023
 37382 00003133 7409                    	jz	short sd_ctp
 37383 00003135 2EC706[8D1F]FFFF        	mov	word [cs:DevSize],0FFFFh ; invalid device size
 37384                                  					; assuming that we fail later
 37385 0000313C EB0E                    	jmp	short sd_close
 37386                                  sd_ctp:	
 37387                                  	; 22/07/2023
 37388                                  ;szdev1:
 37389 0000313E B104                    	mov	cl,4			; convert it to paras
 37390 00003140 D3E8                    	shr	ax,cl
 37391 00003142 B10C                    	mov	cl,12
 37392 00003144 D3E2                    	shl	dx,cl
 37393 00003146 09D0                    	or	ax,dx ; * ; cf=0
 37394                                  	;
 37395                                  	; 22/07/2023 - Retro DOS v4.2 IO.SYS (optimized)
 37396                                  	; MSDOS 6.21 IO.SYS - SYSINIT:37A6h 
 37397                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37398                                  	;cmp	ax,[cs:DevSizeOption]
 37399                                  	;ja	short szdev2
 37400                                  	;mov	ax,[cs:DevSizeOption]
 37401                                  	; 12/12/2022
 37402                                  	;clc
 37403                                  ;szdev2:
 37404 00003148 2EA3[8D1F]              	mov	[cs:DevSize],ax		; save file size (in paragraps)
 37405                                  	; 22/07/2023
 37406                                  	;clc ; cf=0 ; *	; CLC is not needed here
 37407                                  			; (OR instruction clears CF) - E.TAN 22/07/2023
 37408                                  
 37409                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37410                                  	; 12/12/2022
 37411                                  	; cf=0
 37412                                  	;clc
 37413                                  sd_close:
 37414 0000314C 9C                      	pushf				; let close not spoil our
 37415                                  					;  carry flag
 37416 0000314D B8003E                  	mov	ax,3E00h		; close
 37417 00003150 CD21                    	int	21h			; we are not checking for err
 37418 00003152 9D                      	popf
 37419                                  sd_err:
 37420                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37421                                  	; 11/12/2022 ; *
 37422 00003153 1F                      	pop     ds ; *
 37423 00003154 C3                      	retn
 37424                                  
 37425                                  ;----------------------------------------------------------------------------
 37426                                  ;
 37427                                  ; procedure : ExecDev
 37428                                  ;
 37429                                  ;	Input : ds:dx -> device to be executed
 37430                                  ;		DevLoadAddr - contains where device has to be loaded
 37431                                  ;
 37432                                  ;	Output : Carry if error
 37433                                  ;		 Carry clear if no error
 37434                                  ;
 37435                                  ;	Loads a device driver using the 4b03h function call
 37436                                  ;
 37437                                  ;----------------------------------------------------------------------------
 37438                                  
 37439                                  	; 01/11/2022
 37440                                  ExecDev:
 37441 00003155 2E8B1E[8F1F]            	mov	bx,[cs:DevLoadAddr]
 37442 0000315A 2E891E[A71F]            	mov	[cs:DevExecAddr],bx	; Load the parameter block
 37443                                  					;  block for exec with
 37444                                  					;  load address
 37445 0000315F 2E891E[A91F]            	mov	[cs:DevExecReloc],bx
 37446 00003164 8CCB                    	mov	bx,cs
 37447 00003166 8EC3                    	mov	es,bx
 37448 00003168 BB[A71F]                	mov	bx,DevExecAddr		; es:bx points to parameters
 37449                                  	;mov	al,3	; (load program only)
 37450                                  	;mov	ah,EXEC ; 4Bh
 37451                                  	; 04/07/2023
 37452 0000316B B8034B                  	mov	ax,(EXEC<<8)|03h
 37453 0000316E CD21                    	int	21h			; load in the device driver
 37454                                   		; DOS - 2+ - LOAD OR EXECUTE (EXEC)
 37455                                  		; DS:DX -> ASCIZ filename
 37456                                  		; ES:BX -> parameter block
 37457                                  		; AL = subfunction 
 37458 00003170 C3                      	retn
 37459                                  
 37460                                  ;----------------------------------------------------------------------------
 37461                                  ;
 37462                                  ; procedure : RetFromUM
 37463                                  ;
 37464                                  ;	Input : None
 37465                                  ;	Output : ConvLoad set if didn't previously call HideUMBs
 37466                                  ;		 ConvLoad clear if did.
 37467                                  ;
 37468                                  ;	Prepares memory for more devices after returning from loading one
 37469                                  ;	using the DOS 6 options (/L:... etc).
 37470                                  ;
 37471                                  ;----------------------------------------------------------------------------
 37472                                  
 37473                                  ; 31/12/2022 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 37474                                  ;  (SYSINIT:37D1h)
 37475                                  
 37476                                  ; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37477                                  ;%if 0
 37478                                  RetFromUM:
 37479                                  	; 31/12/2022
 37480                                  	; ds = cs
 37481 00003171 9C                      	pushf
 37482                                  	;mov	byte [cs:ConvLoad],1
 37483 00003172 C606[9B1F]01            	mov	byte [ConvLoad],1
 37484 00003177 E8ECFD                  	call	UnHideUMBs
 37485 0000317A 7204                    	jc	short rfUM1		; Skip this if didn't HideUMBs
 37486                                  	; 31/12/2022
 37487                                  	; ds = cs
 37488                                  	;;mov	byte [cs:ConvLoad],0
 37489                                  	;mov	byte [ConvLoad],0
 37490                                  	; 09/09/2023
 37491 0000317C FE0E[9B1F]              	dec	byte [ConvLoad] ; -> 0
 37492                                  rfUM1:	
 37493 00003180 9D                      	popf
 37494 00003181 C3                      	retn
 37495                                  
 37496                                  ;%endif ; 01/11/2022
 37497                                  
 37498                                  ;----------------------------------------------------------------------------
 37499                                  ;
 37500                                  ; procedure : RemoveNull
 37501                                  ;
 37502                                  ;	Input : ES:SI points to a null terminated string
 37503                                  ;
 37504                                  ;	Output : none
 37505                                  ;
 37506                                  ;	Replaces the null at the end of a string with blank
 37507                                  ;
 37508                                  ;----------------------------------------------------------------------------
 37509                                  
 37510                                  	; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 37511                                  	; (SYSINIT:2CCEh)
 37512                                  RemoveNull:
 37513                                  	; 11/12/2022
 37514                                  	; ds = cs
 37515                                  rn_next:
 37516 00003182 268A1C                  	mov	bl,[es:si]
 37517 00003185 08DB                    	or	bl,bl			; null ?
 37518 00003187 7403                    	jz	short rn_gotnull
 37519 00003189 46                      	inc	si			; advance the pointer
 37520 0000318A EBF6                    	jmp	short rn_next
 37521                                  rn_gotnull:
 37522                                  	; 11/12/2022
 37523 0000318C 8A1E[C01F]              	mov	bl,[DevSavedDelim]
 37524                                  	;mov	bl,[cs:DevSavedDelim]
 37525 00003190 26881C                  	mov	[es:si],bl		; replace null with blank
 37526                                  	; 02/11/2022
 37527                                  ; 11/12/2022
 37528                                  rba_ok:		; 10/04/2019
 37529 00003193 C3                      	retn
 37530                                  
 37531                                  ;----------------------------------------------------------------------------
 37532                                  ;
 37533                                  ; procedure : RoundBreakAddr
 37534                                  ;
 37535                                  ;	Input : DevBrkAddr
 37536                                  ;	Output : DevBrkAddr
 37537                                  ;
 37538                                  ;	Rounds DevBrkAddr to a para address so that it is of the form xxxx:0
 37539                                  ;
 37540                                  ;----------------------------------------------------------------------------
 37541                                  
 37542                                  RoundBreakAddr:
 37543 00003194 2EA1[971F]              	mov	ax,[cs:DevBrkAddr]
 37544 00003198 E8E0DF                  	call	ParaRound
 37545 0000319B 2E0106[991F]            	add	[cs:DevBrkAddr+2],ax
 37546 000031A0 2EC706[971F]0000        	mov	word [cs:DevBrkAddr],0
 37547 000031A7 2EA1[911F]              	mov	ax,[cs:DevLoadEnd]
 37548 000031AB 2E3906[991F]            	cmp	[cs:DevBrkAddr+2],ax
 37549 000031B0 76E1                    	jbe	short rba_ok
 37550 000031B2 E92711                  	jmp	mem_err
 37551                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37552                                  	; 11/12/2022
 37553                                  ;rba_ok:
 37554                                  ;	retn
 37555                                  
 37556                                  ;----------------------------------------------------------------------------
 37557                                  ;
 37558                                  ; procedure : DevSetBreak
 37559                                  ;
 37560                                  ;	Input : DevBrkAddr
 37561                                  ;	Output : Carry set if Device returned Init failed
 37562                                  ;		 Else carry clear
 37563                                  ;
 37564                                  ;----------------------------------------------------------------------------
 37565                                  
 37566                                  DevSetBreak:
 37567 000031B5 50                      	push	ax
 37568                                  
 37569 000031B6 2EA1[991F]              	mov	ax,[cs:DevBrkAddr+2]	 ;remove the init code
 37570 000031BA 2E803E[EA14]00          	cmp	byte [cs:multdeviceflag],0
 37571 000031C0 750F                    	jne	short set_break_continue ;do not check it.
 37572 000031C2 2E3B06[8F1F]            	cmp	ax,[cs:DevLoadAddr]
 37573 000031C7 7508                    	jne	short set_break_continue ;if not same, then o.k.
 37574                                  
 37575                                  	;cmp	word [cs:DevBrkAddr],0
 37576                                  	;je	short break_failed	;[DevBrkAddr+2]=[memhi] & [DevBrkAddr]=0
 37577                                  	; 12/12/2022
 37578 000031C9 2E833E[971F]01          	cmp	word [cs:DevBrkAddr],1
 37579 000031CF 7204                    	jb	short break_failed
 37580                                  
 37581                                  set_break_continue:
 37582 000031D1 E8C0FF                  	call	RoundBreakAddr
 37583                                  	; 12/12/2022
 37584 000031D4 F8                      	clc
 37585                                  break_failed:
 37586 000031D5 58                      	pop	ax
 37587                                  	;clc
 37588 000031D6 C3                      	retn
 37589                                  
 37590                                  	; 12/12/2022
 37591                                  ;break_failed:
 37592                                  	;pop	ax
 37593                                  	;stc
 37594                                  	;retn
 37595                                  
 37596                                  ;----------------------------------------------------------------------------
 37597                                  ;
 37598                                  ; procedure : DevBreak
 37599                                  ;
 37600                                  ;	Input : DevLoadAddr & DevBrkAddr
 37601                                  ;	Output : none
 37602                                  ;
 37603                                  ;	Marks a succesful install of a device driver
 37604                                  ;	Sets device size field in sub-arena &
 37605                                  ;	Updates Free ptr in UMB or adjusts memhi
 37606                                  ;
 37607                                  ;----------------------------------------------------------------------------
 37608                                  
 37609                                  	; 11/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 37610                                  DevBreak:
 37611                                  	;push	ds ; 11/12/2022
 37612                                  
 37613                                  	; 11/12/2022
 37614 000031D7 0E                      	push	cs
 37615 000031D8 1F                      	pop	ds
 37616                                  	;mov	ax,[cs:DevLoadAddr]
 37617                                  	;mov	bx,[cs:DevBrkAddr+2]
 37618 000031D9 A1[8F1F]                	mov	ax,[DevLoadAddr]
 37619 000031DC 8B1E[991F]              	mov	bx,[DevBrkAddr+2]
 37620                                  	; 11/12/2022
 37621 000031E0 1E                      	push	ds
 37622                                  
 37623 000031E1 48                      	dec	ax			; seg of sub-arena
 37624 000031E2 8ED8                    	mov	ds,ax
 37625 000031E4 40                      	inc	ax			; Back to Device segment
 37626 000031E5 29D8                    	sub	ax,bx
 37627 000031E7 F7D8                    	neg	ax			; size of device in paras
 37628 000031E9 A30300                  	mov	[devmark.size],ax	; store it in sub-arena
 37629                                  	
 37630                                  	; 11/12/2022
 37631 000031EC 1F                      	pop	ds
 37632                                  	; ds = cs
 37633                                   	
 37634 000031ED 803E[AB1F]00            	cmp	byte [DeviceHi],0
 37635                                  	;cmp	byte [cs:DeviceHi],0
 37636 000031F2 7405                    	je	short db_lo
 37637                                  	;mov	[cs:DevUMBFree],bx	; update Free ptr in UMB
 37638                                  	;jmp	short db_exit
 37639                                  	; 11/12/2022
 37640 000031F4 891E[A11F]              	mov	[DevUMBFree],bx
 37641 000031F8 C3                      	retn	
 37642                                  db_lo:
 37643                                  	; 11/12/2022
 37644                                  	; ds = cs
 37645                                  	;mov	[cs:memhi],bx
 37646                                  	;mov	word [cs:memlo],0
 37647 000031F9 891E[6403]              	mov	[memhi],bx
 37648 000031FD C706[6203]0000          	mov	word [memlo],0 ; 18/12/2022
 37649                                  db_exit:
 37650                                  	;pop	ds ; 11/12/2022
 37651                                  	; 17/09/2023
 37652                                  ;sd_ret:	; 09/09/2023
 37653 00003203 C3                      	retn
 37654                                  
 37655                                  ; 10/04/2019 - Retro DOS v4.0
 37656                                  
 37657                                  ;----------------------------------------------------------------------------
 37658                                  ;
 37659                                  ; procedure : ParseSize
 37660                                  ;
 37661                                  ;	Parses the command line for SIZE= command
 37662                                  ;
 37663                                  ;	ES:SI = command line to parsed
 37664                                  ;
 37665                                  ;	returns ptr to command line after SIZE= option in ES:SI
 37666                                  ;	updates the DevSizeOption variable with value supplied
 37667                                  ;	in SIZE=option
 37668                                  ;	Returns carry if the SIZE option was invalid
 37669                                  ;
 37670                                  ;----------------------------------------------------------------------------
 37671                                  
 37672                                  	; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 37673                                  	; (SYSINIT:2D5Ah)
 37674                                  
 37675                                  	; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization) ((&BugFix))
 37676                                  	; (MSDOS 6.21 IO.SYS - SYSINIT:3871h) - Retro DOS v4.2 -
 37677                                  	; (PCDOS 7.1 IO.SYS - SYSINIT:3D6Eh)  - Retro DOS v5.0 -
 37678                                  ParseSize:
 37679                                  	;push	bx
 37680                                  	;mov	bx,si
 37681                                  
 37682                                  	; 09/09/2023
 37683 00003204 56                      	push	si ; * ; mov bx,si
 37684                                  
 37685                                  	; 11/12/2022
 37686                                  	; ds = cs
 37687                                  	;mov	word [cs:DevSizeOption],0 ; init the value
 37688                                  	;mov	[cs:DevCmdLine],si
 37689                                  	;mov	[cs:DevCmdLine+2],es
 37690 00003205 C706[AC1F]0000          	mov	word [DevSizeOption],0 ; init the value
 37691 0000320B 8936[BC1F]              	mov	[DevCmdLine],si
 37692 0000320F 8C06[BE1F]              	mov	[DevCmdLine+2],es	
 37693 00003213 E82400                  	call	SkipDelim
 37694 00003216 26813C5349              	cmp	word [es:si],'SI' ; 4953h
 37695 0000321B 7528                    	jne	short ps_no_size
 37696 0000321D 26817C025A45            	cmp	word [es:si+2],'ZE' ; 455Ah
 37697 00003223 7520                    	jne	short ps_no_size
 37698 00003225 268A4404                	mov	al,[es:si+4]
 37699 00003229 E80B10                  	call	delim
 37700                                  	;jne	short ps_no_size
 37701                                  	; 22/07/2023
 37702 0000322C 7518                    	jne	short ps_no_size_2 ; cf=0 here
 37703 0000322E 83C605                  	add	si,5
 37704 00003231 E81400                  	call	GetHexNum
 37705 00003234 7210                    	jc	short ps_err
 37706                                  	; 11/12/2022
 37707                                  	; ds = cs
 37708                                  	;mov	[cs:DevSizeOption],ax
 37709 00003236 A3[AC1F]                	mov	[DevSizeOption],ax
 37710                                  	
 37711                                  	; 09/09/2023
 37712 00003239 58                      	pop	ax  ; * (discard previous si value on top of stack)
 37713                                  
 37714                                  ;	call	SkipDelim
 37715                                  ;	
 37716                                  ;	; 22/07/2023
 37717                                  ;;ps_no_size_2:
 37718                                  ;	; cf = 0
 37719                                  ;	retn
 37720                                  
 37721                                  	; 09/09/2023
 37722                                  	;jmp	short SkipDelim
 37723                                  
 37724                                  ; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 37725                                  %if 1
 37726                                  	; 01/11/2022
 37727                                  SkipDelim:
 37728                                  sd_next_char:
 37729 0000323A 268A04                  	mov	al,[es:si]
 37730 0000323D E8F70F                  	call	delim
 37731 00003240 7505                    	jnz	short sd_ret ; cf=0 ; 09/09/2023
 37732 00003242 46                      	inc	si
 37733 00003243 EBF5                    	jmp	short sd_next_char ; 01/11/2022
 37734                                  	; 11/12/2022
 37735                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37736                                  ;sd_ret:
 37737                                  	;retn
 37738                                  %endif
 37739                                  
 37740                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37741                                  	;mov	bx,si
 37742                                  ps_no_size:
 37743                                  	;mov	si,bx
 37744                                  	;pop	bx
 37745 00003245 F8                      	clc	; cf=0
 37746                                  	;retn
 37747                                  	; 11/12/2022
 37748                                  ps_err:		; cf=1
 37749                                  ps_no_size_2:	; 09/09/2023 (cf=0)
 37750                                  	; 09/09/2023
 37751 00003246 5E                      	pop	si ; * ; mov si,bx
 37752                                  	; 17/09/2023
 37753                                  sd_ret:	; cf=?
 37754 00003247 C3                      	retn
 37755                                  
 37756                                  ;ps_err:
 37757                                  	; 02/11/2022
 37758                                  	;pop	bx
 37759                                  	;stc
 37760                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37761                                  	; 11/12/2022
 37762                                  	; cf=1
 37763                                  	;stc
 37764                                  	; 11/12/2022
 37765                                  ;sd_ret: 
 37766                                  	; 22/07/2023
 37767                                  	; 12/04/2019
 37768                                  	;retn
 37769                                  
 37770                                  ; 12/04/2019 - Retro DOS v4.0
 37771                                  
 37772                                  ;----------------------------------------------------------------------------
 37773                                  ;
 37774                                  ; procedure : SkipDelim
 37775                                  ;
 37776                                  ;	Skips delimiters in the string pointed to by ES:SI
 37777                                  ;	Returns ptr to first non-delimiter character in ES:SI
 37778                                  ;
 37779                                  ;----------------------------------------------------------------------------
 37780                                  
 37781                                  ; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 37782                                  %if 0
 37783                                  	; 01/11/2022
 37784                                  SkipDelim:
 37785                                  sd_next_char:
 37786                                  	mov	al,[es:si]
 37787                                  	call	delim
 37788                                  	jnz	short sd_ret
 37789                                  	inc	si
 37790                                  	jmp	short sd_next_char ; 01/11/2022
 37791                                  	; 11/12/2022
 37792                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 37793                                  ;sd_ret:
 37794                                  	;retn
 37795                                  %endif
 37796                                  
 37797                                  ;----------------------------------------------------------------------------
 37798                                  ;
 37799                                  ; procedure : GetHexNum
 37800                                  ;
 37801                                  ;	Converts an ascii string terminated by a delimiter into binary.
 37802                                  ;	Assumes that the ES:SI points to a Hexadecimal string
 37803                                  ;
 37804                                  ;	Returns in AX the number of paras equivalent to the
 37805                                  ;	hex number of bytes specified by the hexadecimal string.
 37806                                  ;
 37807                                  ;	Returns carry in case it encountered a non-hex character or
 37808                                  ;	if it encountered crlf
 37809                                  ;
 37810                                  ;----------------------------------------------------------------------------
 37811                                  
 37812                                  ; 13/05/2019
 37813                                  
 37814                                  	; 03/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 37815                                  	; (SYSINIT:38C5h)
 37816                                  
 37817                                  	; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 37818                                  	; (SYSINIT:2DA5h)
 37819                                  GetHexNum:
 37820 00003248 31C0                    	xor	ax,ax
 37821 0000324A 31D2                    	xor	dx,dx
 37822                                  ghn_next:
 37823 0000324C 268A1C                  	mov	bl,[es:si]
 37824 0000324F 80FB0D                  	cmp	bl,cr  ; 0Dh
 37825 00003252 7436                    	je	short ghn_err
 37826 00003254 80FB0A                  	cmp	bl,lf  ; 0Ah
 37827 00003257 7431                    	je	short ghn_err
 37828 00003259 50                      	push	ax
 37829 0000325A 88D8                    	mov	al,bl
 37830 0000325C E8D80F                  	call	delim
 37831 0000325F 58                      	pop	ax
 37832                                  	; 03/01/2023
 37833 00003260 B90400                  	mov	cx,4
 37834 00003263 7410                    	jz	short ghn_into_paras
 37835 00003265 E82400                  	call	GetNibble
 37836                                  	;jc	short ghn_err
 37837                                  	; 11/12/2022
 37838 00003268 7221                    	jc	short ghn_ret ; cf=1
 37839                                  	; 03/01/2023
 37840                                  	;mov	cx,4
 37841                                  ghn_shift1:
 37842 0000326A D1E0                    	shl	ax,1
 37843 0000326C D1D2                    	rcl	dx,1
 37844 0000326E E2FA                    	loop	ghn_shift1
 37845 00003270 08D8                    	or	al,bl
 37846 00003272 46                      	inc	si
 37847 00003273 EBD7                    	jmp	short ghn_next
 37848                                  ghn_into_paras:
 37849 00003275 83C00F                  	add	ax,15
 37850 00003278 83D200                  	adc	dx,0
 37851 0000327B F7C2F0FF                	test	dx,0FFF0h
 37852 0000327F 7509                    	jnz	short ghn_err
 37853                                  	; 03/01/2023
 37854                                  	;mov	cx,4
 37855                                  ghn_shift2:
 37856 00003281 F8                      	clc
 37857 00003282 D1DA                    	rcr	dx,1
 37858 00003284 D1D8                    	rcr	ax,1
 37859 00003286 E2F9                    	loop	ghn_shift2
 37860 00003288 F8                      	clc
 37861 00003289 C3                      	retn
 37862                                  	; 11/12/2022
 37863                                  ghn_err:
 37864                                  gnib_err:
 37865 0000328A F9                      	stc
 37866                                  ghn_ret:
 37867                                  gnib_ret:
 37868 0000328B C3                      	retn
 37869                                  
 37870                                  ;----------------------------------------------------------------------------
 37871                                  ;
 37872                                  ; procedure : GetNibble
 37873                                  ;
 37874                                  ;	Convert one nibble (hex digit) in BL into binary
 37875                                  ;
 37876                                  ;	Returns binary value in BL
 37877                                  ;
 37878                                  ;	Returns carry if BL contains non-hex digit
 37879                                  ;
 37880                                  ;----------------------------------------------------------------------------
 37881                                  
 37882                                  GetNibble:
 37883 0000328C 80FB30                  	cmp	bl,'0'
 37884                                  	;jb	short gnib_err
 37885                                  	; 11/12/2022
 37886 0000328F 72FA                    	jb	short gnib_ret ; cf=1
 37887 00003291 80FB39                  	cmp	bl,'9'
 37888 00003294 7704                    	ja	short is_it_hex
 37889 00003296 80EB30                  	sub	bl,'0'		; clc
 37890 00003299 C3                      	retn
 37891                                  is_it_hex:
 37892 0000329A 80FB41                  	cmp	bl,'A'
 37893                                  	;jb	short gnib_err
 37894                                  	; 11/12/2022
 37895 0000329D 72EC                    	jb	short gnib_ret ; cf=1
 37896 0000329F 80FB46                  	cmp	bl,'F'
 37897 000032A2 77E6                    	ja	short gnib_err ; 11/12/2022
 37898 000032A4 80EB37                  	sub	bl,'A'- 10	; clc
 37899 000032A7 C3                      	retn
 37900                                  
 37901                                  	; 11/12/2022
 37902                                  ;gnib_err:
 37903                                  ;	stc
 37904                                  ;gnib_ret:
 37905                                  ;	retn
 37906                                  
 37907                                  ;============================================================================
 37908                                  
 37909                                  ; 12/04/2019 - Retro DOS v4.0
 37910                                  
 37911                                  ; umb.inc (MSDOS 6.0, 1991)
 37912                                  DOS_ARENA	equ 24h		; offset of arena_head var in DOS data segm.
 37913                                  UMB_ARENA	equ 8Ch		; offset of umb_head in DOS data
 37914                                  
 37915                                  XMM_REQUEST_UMB	equ 10h
 37916                                  XMM_RELEASE_UMB	equ 11h
 37917                                  
 37918                                  ; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 37919                                  
 37920                                  ;---------------------------------------------------------------------------
 37921                                  ;
 37922                                  ; Procedure Name	: umb_insert
 37923                                  ;
 37924                                  ; Inputs		: DOSDATA:UMB_HEAD = start of umb chain
 37925                                  ;			: BX = seg address of UMB to be linked in
 37926                                  ;			: DX = size of UMB to be linked in paras
 37927                                  ;			; DS = data
 37928                                  ;
 37929                                  ; Outputs		: links the UMB into the arena chain
 37930                                  ;
 37931                                  ; Uses			: AX, CX, ES, DX, BX
 37932                                  ;
 37933                                  ;---------------------------------------------------------------------------
 37934                                  
 37935                                  umb_insert:
 37936 000032A8 1E                      	push	ds
 37937                                  
 37938                                  	; 31/12/2022
 37939                                  	; ds = cs
 37940                                  
 37941                                  	;mov	ds,[cs:DevDOSData]
 37942 000032A9 8E1E[BA1F]              	mov	ds,[DevDOSData] ; 31/12/2022 
 37943                                  	;mov	ds,[8Ch]
 37944 000032AD 8E1E8C00                	mov	ds,[UMB_ARENA]		; es = UMB_HEAD
 37945 000032B1 8CD8                    	mov	ax,ds
 37946 000032B3 8EC0                    	mov	es,ax
 37947                                  ui_next:
 37948 000032B5 39D8                    	cmp	ax,bx			; Q: is current block above
 37949                                  					;    new block
 37950 000032B7 770F                    	ja	short ui_insert		; Y: insert it
 37951                                  					; Q: is current block the
 37952                                  					;    last
 37953 000032B9 26803E00005A            	cmp	byte [es:ARENA.SIGNATURE],arena_signature_end ; 'Z'
 37954 000032BF 745C                    	je	short ui_append		; Y: append new block to chain
 37955                                  					; N: get next block
 37956 000032C1 8ED8                    	mov	ds,ax			; M005
 37957                                  	;call	get_next		; ax = es = next block
 37958 000032C3 E83B01                  	call	_get_next_ ; 13/04/2019 - Retro DOS v4.0
 37959 000032C6 EBED                    	jmp	short ui_next
 37960                                  
 37961                                  ui_insert:
 37962 000032C8 8CD9                    	mov	cx,ds			; ds = previous arena
 37963 000032CA 41                      	inc	cx			; top of previous block
 37964                                  
 37965 000032CB 29D9                    	sub	cx,bx
 37966 000032CD F7D9                    	neg	cx			; cx = size of used block
 37967                                  	;mov	byte [0],'M'
 37968 000032CF C60600004D              	mov	byte [ARENA.SIGNATURE],arena_signature_normal ; 'M'
 37969                                  	;mov	word [1],8
 37970 000032D4 C70601000800            	mov	word [ARENA.OWNER],8	; mark as system owned
 37971                                  	;mov	[3],cx
 37972 000032DA 890E0300                	mov	[ARENA.SIZE],cx	
 37973                                  	;mov	word [8],4353h ; 'SC'
 37974 000032DE C70608005343            	mov	word [ARENA.NAME],'SC' ; 4353h
 37975                                  
 37976                                  ; prepare the arena at start of new block
 37977                                  
 37978 000032E4 8EC3                    	mov	es,bx
 37979 000032E6 26C60600004D            	mov	byte [es:ARENA.SIGNATURE],arena_signature_normal ; 'M'
 37980 000032EC 26C70601000000          	mov	word [es:ARENA.OWNER],arena_owner_system ; 0
 37981                                  					; mark as free
 37982 000032F3 83EA02                  	sub	dx,2			; make room for arena at
 37983                                  					; start & end of new block
 37984 000032F6 2689160300              	mov	[es:ARENA.SIZE],dx
 37985                                  
 37986                                  ; prepare arena at end of new block
 37987                                  	
 37988 000032FB 01D3                    	add	bx,dx
 37989 000032FD 43                      	inc	bx
 37990 000032FE 8EC3                    	mov	es,bx			; es=arena at top of new block
 37991 00003300 43                      	inc	bx			; bx=top of new block
 37992                                  
 37993                                  					; ax contains arena just above
 37994                                  					; this block
 37995 00003301 29D8                    	sub	ax,bx			; ax = size of used block
 37996                                  	
 37997 00003303 26C60600004D            	mov	byte [es:ARENA.SIGNATURE],arena_signature_normal
 37998 00003309 26C70601000800          	mov	word [es:ARENA.OWNER],8	; mark as system owned
 37999 00003310 26A30300                	mov	[es:ARENA.SIZE],ax	
 38000 00003314 26C70608005343          	mov	word [es:ARENA.NAME],'SC' ; 4353h
 38001                                  
 38002 0000331B EB47                    	jmp	short ui_done
 38003                                  
 38004                                  ui_append:
 38005                                  					; es = arena of last block	
 38006 0000331D 2603060300              	add	ax,[es:ARENA.SIZE]	; ax=top of last block-1 para
 38007 00003322 26832E030001            	sub	word [es:ARENA.SIZE],1	; reflect the space we are
 38008                                  					; going to rsrv on top of this 
 38009                                  					; block for the next arena.
 38010                                  	; 13/05/2019
 38011 00003328 26C60600004D            	mov	byte [es:ARENA.SIGNATURE],arena_signature_normal
 38012                                  
 38013 0000332E 89C1                    	mov	cx,ax			; cx=top of prev block-1
 38014 00003330 40                      	inc	ax
 38015 00003331 29D8                    	sub	ax,bx			; ax=top of prev block - 
 38016                                  					;    seg. address of new block
 38017 00003333 F7D8                    	neg	ax
 38018                                  
 38019 00003335 8EC1                    	mov	es,cx			; ds = arena of unused block
 38020                                  
 38021 00003337 26C60600004D            	mov	byte [es:ARENA.SIGNATURE],arena_signature_normal
 38022 0000333D 26C70601000800          	mov	word [es:ARENA.OWNER],8	; mark as system owned
 38023 00003344 26A30300                	mov	[es:ARENA.SIZE],ax	
 38024 00003348 26C70608005343          	mov	word [es:ARENA.NAME],'SC'
 38025                                  
 38026                                  ; prepare the arena at start of new block
 38027 0000334F 8EC3                    	mov	es,bx
 38028 00003351 26C60600005A            	mov	byte [es:ARENA.SIGNATURE],arena_signature_end
 38029 00003357 26C70601000000          	mov	word [es:ARENA.OWNER],arena_owner_system
 38030                                  					; mark as free
 38031 0000335E 4A                      	dec	dx			; make room for arena
 38032 0000335F 2689160300              	mov	[es:ARENA.SIZE],dx	
 38033                                  ui_done:
 38034                                  uc_done: ; 31/12/2022 ; *!
 38035 00003364 1F                      	pop	ds
 38036                                  	; ds = cs ; 31/12/2022
 38037                                  ;uc_done:	; 18/12/2022
 38038                                  au_exit:	; 09/09/2023
 38039 00003365 C3                      	retn
 38040                                  
 38041                                  ;----------------------------------------------------------------------------
 38042                                  ;
 38043                                  ; procedure : AllocUMB
 38044                                  ;
 38045                                  ;	Allocate all UMBs and link it to DOS arena chain
 38046                                  ;
 38047                                  ;----------------------------------------------------------------------------
 38048                                  
 38049                                  AllocUMB:
 38050                                  	; 31/12/2022
 38051                                  	; ds = cs
 38052 00003366 E84700                  	call	InitAllocUMB		; link in the first UMB
 38053 00003369 72FA                    	jc	short au_exit		; quit on error
 38054                                  au_next:
 38055 0000336B E87000                  	call	umb_allocate		; allocate
 38056 0000336E 7205                    	jc	short au_coalesce
 38057 00003370 E835FF                  	call	umb_insert		; & insert till no UMBs
 38058 00003373 EBF6                    	jmp	short au_next
 38059                                  au_coalesce:
 38060                                  	; 09/09/2023
 38061                                  ;	call	umb_coalesce		; coalesce all UMBs
 38062                                  ;au_exit:
 38063                                  ;	; 31/12/2022
 38064                                  ;	; ds = cs
 38065                                  ;	retn
 38066                                  
 38067                                  	; 09/09/2023
 38068                                  	;jmp	short umb_coalesce
 38069                                  
 38070                                  ; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 38071                                  
 38072                                  ; 13/04/2019 - Retro DOS v4.0
 38073                                  
 38074                                  ;----------------------------------------------------------------------------
 38075                                  ;
 38076                                  ;**	umb_coalesce - Combine free blocks ahead with current block
 38077                                  ;
 38078                                  ;	Coalesce adds the block following the argument to the argument block,
 38079                                  ;	if it's free.  Coalesce is usually used to join free blocks, but
 38080                                  ;	some callers (such as $setblock) use it to join a free block to it's
 38081                                  ;	preceeding allocated block.
 38082                                  ;
 38083                                  ;	EXIT	'C' clear if OK
 38084                                  ;		  (ds) unchanged, this block updated
 38085                                  ;		  (ax) = address of next block, IF not at end
 38086                                  ;		'C' set if arena trashed
 38087                                  ;	USES	cx, di, ds, es
 38088                                  ;
 38089                                  ;----------------------------------------------------------------------------
 38090                                  
 38091                                  umb_coalesce:
 38092                                  	; 31/12/2022
 38093                                  	; ds = cs
 38094 00003375 1E                      	push	ds ; *!
 38095                                  
 38096 00003376 31FF                    	xor	di, di
 38097                                  
 38098                                  	;mov	es,[cs:DevDOSData]
 38099                                  	; 31/12/2022
 38100 00003378 8E06[BA1F]              	mov	es,[DevDOSData]
 38101 0000337C 268E068C00              	mov	es,[es:UMB_ARENA]	; es = UMB_HEAD
 38102                                  uc_nextfree:
 38103 00003381 8CC0                    	mov	ax,es
 38104 00003383 8ED8                    	mov	ds,ax
 38105                                  	;cmp	[es:1],di
 38106 00003385 26393E0100              	cmp	[es:ARENA.OWNER],di	; Q: is current arena free
 38107 0000338A 7407                    	je	short uc_again		; Y: try to coalesce with next block
 38108                                  					; N: get next arena
 38109 0000338C E86B00                  	call	get_next		; es, ax = next arena
 38110 0000338F 72D3                    	jc	short uc_done	; *!
 38111 00003391 EBEE                    	jmp	short uc_nextfree
 38112                                  uc_again:
 38113 00003393 E86400                  	call	get_next		; es, ax = next arena
 38114 00003396 72CC                    	jc	short uc_done	; *!
 38115                                  uc_check:
 38116 00003398 26393E0100              	cmp     [es:ARENA.OWNER],di	; Q: is arena free
 38117 0000339D 75E2                    	jne	short uc_nextfree	; N: get next free arena
 38118                                  					; Y: coalesce
 38119 0000339F 268B0E0300              	mov     cx,[es:ARENA.SIZE]      ; cx <- next block size
 38120 000033A4 41                      	inc     cx                      ; cx <- cx + 1 (for header size)
 38121                                  	;add	[3],cx
 38122 000033A5 010E0300                	add     [ARENA.SIZE],cx		; current size <- current size + cx
 38123 000033A9 268A0D                  	mov     cl,[es:di]              ; move up signature
 38124 000033AC 880D                    	mov     [di],cl
 38125 000033AE EBE3                    	jmp     short uc_again		; try again
 38126                                  
 38127                                  	; 18/12/2022
 38128                                  ;uc_done:
 38129                                  	;retn
 38130                                  
 38131                                  ;----------------------------------------------------------------------------
 38132                                  ;
 38133                                  ; procedure : InitAllocUMB
 38134                                  ;
 38135                                  ;----------------------------------------------------------------------------
 38136                                  
 38137                                  InitAllocUMB:
 38138                                  	; 31/12/2022
 38139                                  	; ds = cs
 38140 000033B0 E828D7                  	call	IsXMSLoaded
 38141 000033B3 7527                    	jnz	short iau_err		; quit on no XMS driver
 38142 000033B5 B452                    	mov	ah,52h
 38143 000033B7 CD21                    	int	21h			; get DOS DATA seg
 38144                                  	; 31/12/2022
 38145                                  	; ds = cs
 38146                                  	;mov	[cs:DevDOSData],es	; & save it for later
 38147 000033B9 8C06[BA1F]              	mov	[DevDOSData],es		; & save it for later
 38148 000033BD B81043                  	mov	ax,4310h
 38149 000033C0 CD2F                    	int	2Fh
 38150                                  	;mov	[cs:DevXMSAddr],bx	; get XMS driver address
 38151                                  	;mov	[cs:DevXMSAddr+2],es
 38152 000033C2 891E[A31F]              	mov	[DevXMSAddr],bx		; get XMS driver address
 38153 000033C6 8C06[A51F]              	mov	[DevXMSAddr+2],es	
 38154                                  	; 31/12/2022
 38155 000033CA 803E[B91F]00            	cmp	byte [FirstUMBLinked],0 
 38156                                  	;cmp	byte [cs:FirstUMBLinked],0 ; have we already linked a UMB?
 38157                                  	;jne	short ia_1		; quit if we already did it
 38158                                  	; 12/12/2022
 38159 000033CF 770A                    	ja	short ia_1 ; cf=0
 38160 000033D1 E83900                  	call	LinkFirstUMB		; else link the first UMB
 38161                                  	;jc	short iau_err
 38162                                  	; 12/12/2022
 38163 000033D4 7207                    	jc	short iau_err2  ; cf=1
 38164                                  	; 31/12/2022
 38165                                  	; ds = cs
 38166 000033D6 C606[B91F]FF            	mov	byte [FirstUMBLinked],0FFh ; mark that 1st UMB linked
 38167                                  	;mov	byte [cs:FirstUMBLinked],0FFh ; mark that 1st UMB linked
 38168                                  ia_1:
 38169                                  	; 12/12/2022
 38170                                  	; cf=0
 38171                                  	;clc
 38172 000033DB C3                      	retn
 38173                                  iau_err:
 38174 000033DC F9                      	stc
 38175                                  iau_err2:
 38176 000033DD C3                      	retn
 38177                                  
 38178                                  ;-------------------------------------------------------------------------
 38179                                  ;
 38180                                  ; Procedure Name	: umb_allocate
 38181                                  ;
 38182                                  ; Inputs		: DS = data
 38183                                  ;
 38184                                  ; Outputs		: if UMB available
 38185                                  ;				Allocates the largest available UMB and 
 38186                                  ;			  	BX = segment of allocated block
 38187                                  ;				DX = size of allocated block
 38188                                  ;				NC
 38189                                  ;			  else 
 38190                                  ;				CY
 38191                                  ;
 38192                                  ; Uses			: BX, DX
 38193                                  ;
 38194                                  ;-------------------------------------------------------------------------
 38195                                  
 38196                                  umb_allocate:
 38197                                  	; 31/12/2022
 38198                                  	; ds = cs
 38199 000033DE 50                      	push	ax
 38200 000033DF B410                    	mov	ah,XMM_REQUEST_UMB ; 16
 38201 000033E1 BAFFFF                  	mov	dx,0FFFFh		; try to allocate largest
 38202                                  					;   possible
 38203                                  	; 31/12/2022
 38204 000033E4 FF1E[A31F]              	call	far [DevXMSAddr]
 38205                                  	;call	far [cs:DevXMSAddr]
 38206                                  					; dx now contains the size of
 38207                                  					; the largest UMB
 38208 000033E8 09D2                    	or	dx,dx
 38209 000033EA 740B                    	jz	short ua_err
 38210                                  	
 38211 000033EC B410                    	mov	ah,XMM_REQUEST_UMB ; 16
 38212                                  
 38213                                  	; 31/12/2022
 38214 000033EE FF1E[A31F]              	call	far [DevXMSAddr]
 38215                                  	;call	far [cs:DevXMSAddr]
 38216                                  
 38217 000033F2 83F801                  	cmp	ax,1			; Q: was the reqst successful
 38218                                  	;jne	short ua_err		; N: error
 38219                                  	; 27/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 38220 000033F5 7601                    	jna	short ua_done ; if ax=1 then cf=0, else cf=1 (ax=0)
 38221                                  ua_err:
 38222 000033F7 F9                      	stc	
 38223                                  
 38224                                  	;clc
 38225                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38226                                  	; 12/12/2022
 38227                                  	; cf=0
 38228                                  	;clc 
 38229                                  ua_done:
 38230 000033F8 58                      	pop	ax
 38231 000033F9 C3                      	retn
 38232                                  	; 27/07/2023
 38233                                  ;ua_err:
 38234                                  	;stc
 38235                                  	;jmp	short ua_done
 38236                                  
 38237                                  ;----------------------------------------------------------------------------
 38238                                  ;
 38239                                  ;**	get_next - Find Next item in Arena
 38240                                  ;
 38241                                  ;	ENTRY	dS - pointer to block head
 38242                                  ;	EXIT	AX,ES - pointers to next head
 38243                                  ;		'C' set if arena damaged
 38244                                  ;
 38245                                  ;----------------------------------------------------------------------------
 38246                                  
 38247                                  	; 01/11/2022
 38248                                  get_next:
 38249 000033FA 803E00005A              	cmp	byte [0],arena_signature_end ; 'Z'
 38250 000033FF 740A                    	je	short gn_err
 38251                                  _get_next_:
 38252 00003401 8CD8                    	mov     ax,ds                   ; ax=current block
 38253 00003403 03060300                	add     ax,[ARENA.SIZE]		; ax=ax + current block length
 38254 00003407 40                      	inc     ax                      ; remember that header!
 38255 00003408 8EC0                    	mov	es,ax
 38256                                  	;clc
 38257                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38258                                  	; 11/12/2022
 38259                                  	; cf=0
 38260                                  	;clc
 38261 0000340A C3                      	retn
 38262                                  gn_err:
 38263 0000340B F9                      	stc
 38264                                  	; 11/12/2022	
 38265                                  lfu_err:	 ; cf=1
 38266 0000340C C3                      	retn
 38267                                  
 38268                                  ;----------------------------------------------------------------------------
 38269                                  ;
 38270                                  ; procedure : LinkFirstUMB
 38271                                  ;
 38272                                  ;----------------------------------------------------------------------------
 38273                                  
 38274                                  	; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 38275                                  	; (SYSINIT:2F81h)
 38276                                  LinkFirstUMB:
 38277                                  	; 31/12/2022
 38278                                  	; ds = cs
 38279 0000340D E8CEFF                  	call	umb_allocate
 38280 00003410 72FA                    	jc	short lfu_err  ; ds = cs ; 31/12/2022
 38281                                  
 38282                                  ; bx = segment of allocated UMB
 38283                                  ; dx = size of UMB
 38284                                  
 38285                                  	; 31/12/2022
 38286                                  	; ds = cs
 38287                                  
 38288 00003412 CD12                    	int	12h			; ax = size of memory
 38289 00003414 B106                    	mov	cl,6
 38290 00003416 D3E0                    	shl	ax,cl			; ax = size in paragraphs
 38291                                  
 38292 00003418 89C1                    	mov	cx,ax			; cx = size in paras
 38293 0000341A 29D8                    	sub	ax,bx			; ax = - size of unused block
 38294                                  
 38295 0000341C F7D8                    	neg	ax
 38296                                  
 38297                                  	;sub	cx,1			; cx = first umb_arena
 38298                                  	; 09/09/2023
 38299 0000341E 49                      	dec	cx
 38300 0000341F 8EC1                    	mov	es,cx			; es = first umb_arena
 38301                                  	
 38302 00003421 26C60600004D            	mov	byte [es:ARENA.SIGNATURE],arena_signature_normal ; 'M'
 38303 00003427 26C70601000800          	mov	word [es:ARENA.OWNER],8	; mark as system owned
 38304                                  					
 38305 0000342E 26A30300                	mov	[es:ARENA.SIZE],ax	
 38306 00003432 26C70608005343          	mov	word [es:ARENA.NAME],'SC' ; 4353h
 38307                                  
 38308                                  ; put in the arena for the first UMB
 38309                                  
 38310 00003439 8EC3                    	mov	es,bx			; es has first free umb seg
 38311 0000343B 26C60600005A            	mov	byte [es:ARENA.SIGNATURE],arena_signature_end ; 'Z'
 38312 00003441 26C70601000000          	mov	word [es:ARENA.OWNER],arena_owner_system ; 0	
 38313                                  					; mark as free 
 38314 00003448 4A                      	dec	dx			; make room for arena
 38315 00003449 2689160300              	mov	[es:ARENA.SIZE],dx	
 38316                                  
 38317                                  	;mov	es,[cs:DevDOSData]
 38318                                  	; 31/12/2022
 38319 0000344E 8E06[BA1F]              	mov	es,[DevDOSData] ; ds = cs
 38320                                  	; 18/09/2023
 38321 00003452 26890E8C00              	mov	[es:UMB_ARENA],cx
 38322                                  	;mov	di,UMB_ARENA ; 8Ch
 38323                                  	;mov	[es:di],cx		; initialize umb_head in DOS
 38324                                  					;  data segment with the arena
 38325                                  					;  just below Top of Mem
 38326                                  
 38327                                  ; we must now scan the arena chain and update the size of the last arena
 38328                                  
 38329                                  	;mov	di,DOS_ARENA ; 24h
 38330                                  	;mov	es,[es:di]		; es = start arena
 38331                                  	; 18/09/2023
 38332 00003457 268E062400              	mov	es,[es:DOS_ARENA]
 38333 0000345C 31FF                    	xor	di,di
 38334                                  ;scan_next
 38335                                  ; 09/12/2022
 38336                                  scannext:
 38337 0000345E 26803D5A                	cmp	byte [es:di],arena_signature_end  ; 'Z'
 38338 00003462 740C                    	je	short got_last
 38339                                  	
 38340 00003464 8CC0                    	mov	ax,es
 38341 00003466 2603060300              	add	ax,[es:ARENA.SIZE]
 38342 0000346B 40                      	inc	ax
 38343 0000346C 8EC0                    	mov	es,ax
 38344                                  	;jmp	short scan_next
 38345                                  	; 09/12/2022
 38346 0000346E EBEE                    	jmp	short scannext
 38347                                  got_last:
 38348                                  	;sub	word [es:ARENA.SIZE],1
 38349                                  	; 09/09/2023
 38350 00003470 26FF0E0300              	dec	word [es:ARENA.SIZE]
 38351                                  
 38352 00003475 26C60600004D            	mov	byte [es:ARENA.SIGNATURE],arena_signature_normal ; 'M'
 38353                                  	;clc
 38354                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38355                                  	; 11/12/2022
 38356                                  	; cf=0
 38357                                  	;clc
 38358 0000347B C3                      	retn
 38359                                  
 38360                                  ; 11/12/2022
 38361                                  ;;lfu_err:
 38362                                  ;	;stc
 38363                                  ;	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38364                                  ;	; 11/12/2022
 38365                                  ;	; cf=1
 38366                                  ;	;stc
 38367                                  ;	retn
 38368                                  
 38369                                  ;----------------------------------------------------------------------------
 38370                                  ;
 38371                                  ; procedure : ShrinkUMB
 38372                                  ;
 38373                                  ;	Shrinks the current UMB in use, so that the unused portions
 38374                                  ;	of the UMB is given back to the DOS free mem pool
 38375                                  ;
 38376                                  ;----------------------------------------------------------------------------
 38377                                  
 38378                                  ShrinkUMB:
 38379                                  	; 12/12/2022
 38380                                  	; ds = cs
 38381 0000347C 833E[9D1F]00            	cmp	word [DevUMBAddr],0
 38382                                  	;cmp	word [cs:DevUMBAddr],0
 38383 00003481 741F                    	je	short su_exit
 38384 00003483 06                      	push	es
 38385                                  	; 01/01/2023
 38386                                  	;push	bx
 38387                                  	; 12/12/2022
 38388                                  	;mov	bx,[cs:DevUMBFree]
 38389                                  	;sub	bx,[cs:DevUMBAddr]
 38390                                  	;mov	es,[cs:DevUMBAddr]
 38391 00003484 8B1E[A11F]              	mov	bx,[DevUMBFree]
 38392 00003488 2B1E[9D1F]              	sub	bx,[DevUMBAddr]
 38393 0000348C 8E06[9D1F]              	mov	es,[DevUMBAddr]
 38394                                  	
 38395 00003490 B8004A                  	mov	ax,4A00h
 38396 00003493 CD21                    	int	21h
 38397                                  		; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
 38398                                  		; ES = segment address of block to change
 38399                                  		; BX = new size in paragraphs
 38400 00003495 8CC0                    	mov	ax,es
 38401 00003497 48                      	dec	ax
 38402 00003498 8EC0                    	mov	es,ax
 38403 0000349A 26C70601000800          	mov	word [es:ARENA.OWNER],8
 38404                                  	; 01/01/2023
 38405                                  	;pop	bx
 38406 000034A1 07                      	pop	es
 38407                                  su_exit:
 38408 000034A2 C3                      	retn
 38409                                  
 38410                                  ;----------------------------------------------------------------------------
 38411                                  ;
 38412                                  ; procedure : UnlinkUMB
 38413                                  ;
 38414                                  ;	Unlinks the UMBs from the DOS arena chain
 38415                                  ;
 38416                                  ;----------------------------------------------------------------------------
 38417                                  
 38418                                  UnlinkUMB:
 38419                                  	; 12/12/2022
 38420                                  	; ds = cs
 38421 000034A3 1E                      	push	ds
 38422 000034A4 06                      	push	es
 38423                                  	; 12/12/2022
 38424 000034A5 803E[B91F]00            	cmp	byte [FirstUMBLinked],0
 38425                                  	;cmp	byte [cs:FirstUMBLinked],0
 38426 000034AA 7420                    	je	short ulu_x		; nothing to unlink
 38427                                  	; 12/12/2022
 38428 000034AC 8E06[BA1F]              	mov	es,[DevDOSData]
 38429                                  	;mov	es,[cs:DevDOSData]	; get DOS data seg
 38430 000034B0 268E1E2400              	mov	ds,[es:DOS_ARENA]
 38431 000034B5 268B3E8C00              	mov	di,[es:UMB_ARENA]
 38432                                  ulu_next:
 38433 000034BA E83DFF                  	call	get_next
 38434 000034BD 720D                    	jc	short ulu_x
 38435 000034BF 39C7                    	cmp	di,ax			; is the next one UMB ?
 38436 000034C1 7404                    	je	short ulu_found
 38437 000034C3 8ED8                    	mov	ds,ax
 38438 000034C5 EBF3                    	jmp	short ulu_next
 38439                                  ulu_found:
 38440                                  	;mov	byte [0],'Z'
 38441 000034C7 C60600005A              	mov     byte [ARENA.SIGNATURE],arena_signature_end ; 'Z'
 38442                                  ulu_x:
 38443 000034CC 07                      	pop	es
 38444 000034CD 1F                      	pop	ds
 38445 000034CE C3                      	retn
 38446                                  
 38447                                  ; ----------------------------------------------------------------------
 38448                                  ; SYSINIT2.ASM - MSDOS 6.0 - 1991
 38449                                  ; ----------------------------------------------------------------------
 38450                                  ; 14/04/2019 - Retro DOS v4.0
 38451                                  
 38452                                  ; Multiple configuration block support  Created 16-Mar-1992 by JeffPar
 38453                                  ;
 38454                                  ; Summary:
 38455                                  ;
 38456                                  ;   The procedure "organize" crunches the in-memory copy of config.sys
 38457                                  ;   into lines delimited by CR/LF (sometimes no CR, but *always* an LF)
 38458                                  ;   with the leading "keyword=" replaced by single character codes (eg, B
 38459                                  ;   for BUFFERS, D for DEVICE, Z for any unrecognized keyword); see comtab
 38460                                  ;   and/or config.inc for the full list.
 38461                                  ;
 38462                                  ;   [blockname] and INCLUDE are the major syntactical additions for multi-
 38463                                  ;   configuration support. blockname is either MENU, which contains one
 38464                                  ;   or more MENUITEM lines, an optional MENUDEFAULT (which includes optional
 38465                                  ;   time-out), or any user-defined keyword, such as NETWORK, CD-ROM, etc.
 38466                                  ;   INCLUDE allows the current block to name another block for inclusion
 38467                                  ;   during the processing phase of CONFIG.SYS. An INCLUDE is only honored
 38468                                  ;   once, precluding nasty infinite-loop scenarios. If blocks are present
 38469                                  ;   without a MENU block, then only lines inside COMMON blocks are processed.
 38470                                  ;
 38471                                  ; Example:
 38472                                  ;
 38473                                  ;   [menu]
 38474                                  ;   menuitem=misc,Miscellaneous
 38475                                  ;   menuitem=network,Network Configuration
 38476                                  ;   menudefault=network,15
 38477                                  ;
 38478                                  ;   [network]
 38479                                  ;   include misc
 38480                                  ;   device=foo
 38481                                  ;
 38482                                  ;   [misc]
 38483                                  ;   device=bar
 38484                                  ;   include alternate
 38485                                  ;
 38486                                  ;   [alternate]
 38487                                  ;   device=tar
 38488                                  ;
 38489                                  ;
 38490                                  ;   When the menu is displayed
 38491                                  ;
 38492                                  ;    1. Miscellaneous
 38493                                  ;    2. Network Configuration
 38494                                  ;
 38495                                  ;   #2 is highlighted as the default option, and will be automatically
 38496                                  ;   selected after 15 seconds. It will invoke the following lines in the
 38497                                  ;   following order:
 38498                                  ;
 38499                                  ;       DEVICE=BAR
 38500                                  ;       DEVICE=TAR
 38501                                  ;       DEVICE=FOO
 38502                                  ;
 38503                                  
 38504                                  ;MULTI_CONFIG equ 1
 38505                                  
 38506                                  ; the following depend on the positions of the various letters in switchlist
 38507                                  
 38508                                  switchnum	equ 11111000b ; 0F8h	; which switches require number
 38509                                  
 38510                                  flagec35	equ 00000100b ; 4	; electrically compatible 3.5 inch disk drive
 38511                                  flagdrive	equ 00001000b ; 8 
 38512                                  flagcyln	equ 00010000b ; 16
 38513                                  flagseclim	equ 00100000b ; 32
 38514                                  flagheads	equ 01000000b ; 64
 38515                                  flagff		equ 10000000b ; 128
 38516                                  
 38517                                  ;----------------------------------------------------------------------------
 38518                                  ; 19/04/2019 - Retro DOS v4.0
 38519                                  
 38520                                  ; MSDOS 6.21 IO.SYS - SYSINIT:3E78h
 38521                                  
 38522                                  ; 01/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 38523                                  ; MSDOS 5.0 IO.SYS - SYSINIT:3054h
 38524                                  
 38525 000034CF 00                      insert_blank:	db 	0
 38526                                  
 38527                                  ;----------------------------------------------------------------------------
 38528                                  ;
 38529                                  ; procedure : setparms
 38530                                  ;
 38531                                  ; the following set of routines is used to parse the drivparm = command in
 38532                                  ; the config.sys file to change the default drive parameters.
 38533                                  ;
 38534                                  ;----------------------------------------------------------------------------
 38535                                  
 38536                                  setparms:
 38537 000034D0 1E                      	push	ds
 38538 000034D1 50                      	push	ax
 38539 000034D2 53                      	push	bx
 38540 000034D3 51                      	push	cx
 38541 000034D4 52                      	push	dx
 38542                                  
 38543 000034D5 0E                      	push	cs
 38544 000034D6 1F                      	pop	ds
 38545                                  
 38546 000034D7 31DB                    	xor	bx,bx
 38547 000034D9 8A1E[8A49]              	mov	bl,[drive]
 38548                                  	; 18/12/2022
 38549 000034DD 43                      	inc	bx
 38550                                  	;inc	bl			; get it correct for ioctl call
 38551                                  					; (1=a,2=b...)
 38552 000034DE BA[6248]                	mov	dx,deviceparameters
 38553                                  	;mov	ah,IOCTL ; 44h
 38554                                  	;mov	al,GENERIC_IOCTL ; 0Dh
 38555                                  	; 04/07/2023
 38556 000034E1 B80D44                  	mov	ax,(IOCTL<<8)|GENERIC_IOCTL
 38557                                  	;mov	ch,RAWIO ; 8
 38558                                  	;mov	cl,SET_DEVICE_PARAMETERS ; 40h
 38559                                  	; 04/07/2023
 38560 000034E4 B94008                  	mov	cx,(RAWIO<<8)|SET_DEVICE_PARAMETERS 
 38561 000034E7 CD21                    	int	21h
 38562                                  
 38563                                  ; 27/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 38564 000034E9 8A26[8B49]              	mov	ah,[switches]
 38565                                  	;mov	al,[deviceparameters+20]
 38566 000034ED A0[7648]                	mov	al,[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERTRACK]
 38567 000034F0 8A0E[8A49]              	mov	cl,[drive]
 38568                                  ;
 38569                                  ;; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38570                                  ;	;;mov	ax,Bios_Data		; get Bios_Data segment
 38571                                  ;	;mov	ax,KERNEL_SEGMENT ; 70h
 38572                                  ;	; 21/10/2022
 38573                                  ;	;mov	ax,DOSBIODATASEG ; 0070h	
 38574                                  ;	;mov	ds,ax			; set Bios_Data segment
 38575                                  ;
 38576                                  ;	; 27/07/2023
 38577                                  ;	;;test	word [cs:switches],flagec35 ; 4
 38578                                  ;	;test	byte [cs:switches],flagec35
 38579                                  ;	;jz	short not_ec35
 38580                                  ;
 38581                                  ;	; 27/07/2023
 38582                                  ;	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38583                                  ;	;;test	word [switches],flagec35 ; 4
 38584                                  ;	; 12/12/2022
 38585                                  ;	;test	byte [switches],flagec35 ; 4
 38586                                  ;	;jz	short eot_ok
 38587                                  ;	
 38588                                  	;mov	cl,[cs:drive]		; which drive was this for?
 38589                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38590                                  	;mov	cl,[drive]
 38591                                  	; 27/07/2023
 38592                                  	;mov	ax,DOSBIODATASEG ; 0070h	
 38593                                  	;mov	ds,ax
 38594                                  
 38595 000034F4 BA7000                  	mov	dx,DOSBIODATASEG
 38596 000034F7 8EDA                    	mov	ds,dx
 38597                                  
 38598 000034F9 F6C404                  	test	ah,flagec35	; test byte [cs:switches],flagec35
 38599 000034FC 7408                    	jz	short not_ec35
 38600                                  
 38601                                  	;mov	al,1			; assume drive 0
 38602                                  	;shl	al,cl			; set proper bit depending on drive
 38603                                  	;;or	[531h],al ; (MSDOS 6.21 IO.SYS Offset SYINIT:3EACh)
 38604                                  	;or	[ec35_flag],al		; set the bit in the permanent flags
 38605                                  	; 27/07/2023
 38606 000034FE B401                    	mov	ah,1
 38607 00003500 D2E4                    	shl	ah,cl
 38608 00003502 0826[A204]              	or	[ec35_flag],ah
 38609                                  
 38610                                  ; 07/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 38611                                  ;	MSDOS 6.21 IO.SYS - SYINIT:3EB0h	
 38612                                  ; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38613                                  not_ec35:
 38614                                  ;	Now adjust the BIOS's EOT variable if our new drive has more
 38615                                  ;	sectors per track than any old ones.
 38616                                  
 38617                                  	; 27/07/2023
 38618                                  	;;mov	al,[cs:deviceparameters+20]
 38619                                  	;mov	al,[cs:deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERTRACK]
 38620                                  	
 38621                                  	;cmp	al,[12Ch] ; (MSDOS 6.21 IO.SYS Offset SYINIT:3EB4h)
 38622 00003506 3A06[2C01]              	cmp	al,[eot]
 38623 0000350A 7603                    	jbe	short eot_ok
 38624 0000350C A2[2C01]                	mov	[eot],al
 38625                                  eot_ok:
 38626 0000350F 5A                      	pop	dx			; fix up all the registers
 38627 00003510 59                      	pop	cx
 38628 00003511 5B                      	pop	bx
 38629 00003512 58                      	pop	ax
 38630 00003513 1F                      	pop	ds ; 13/05/2019
 38631 00003514 C3                      	retn
 38632                                  
 38633                                  ;----------------------------------------------------------------------------
 38634                                  ;
 38635                                  ; procedure : diddleback
 38636                                  ;
 38637                                  ; replace default values for further drivparm commands
 38638                                  ;
 38639                                  ;----------------------------------------------------------------------------
 38640                                  
 38641                                  diddleback:
 38642 00003515 1E                      	push	ds
 38643 00003516 0E                      	push	cs
 38644 00003517 1F                      	pop	ds
 38645                                  	;mov	word [deviceparameters+4],80
 38646 00003518 C706[6648]5000          	mov	word [deviceparameters+A_DEVICEPARAMETERS.DP_CYLINDERS],80
 38647                                  	;mov	byte [deviceparameters+1],2
 38648 0000351E C606[6348]02            	mov	byte [deviceparameters+A_DEVICEPARAMETERS.DP_DEVICETYPE],DEV_3INCH720KB ; 2
 38649                                  	;mov	word [deviceparameters+2],0
 38650 00003523 C706[6448]0000          	mov	word [deviceparameters+A_DEVICEPARAMETERS.DP_DEVICEATTRIBUTES],0
 38651 00003529 C706[8B49]0000          	mov	word [switches],0	    ; zero all switches
 38652 0000352F 1F                      	pop	ds
 38653 00003530 C3                      	retn
 38654                                  
 38655                                  
 38656                                  ; 03/01/2023
 38657                                  %if 0
 38658                                  
 38659                                  ; 15/04/2019 - Retro DOS v4.0
 38660                                  
 38661                                  ;----------------------------------------------------------------------------
 38662                                  ;
 38663                                  ; procedure : parseline
 38664                                  ;
 38665                                  ; entry point is parseline. al contains the first character in command line.
 38666                                  ;
 38667                                  ;----------------------------------------------------------------------------
 38668                                  
 38669                                  	; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 38670                                  	; (SYSINIT:3EDFh)
 38671                                  
 38672                                  	; 01/11/2022 - Retrodos v4.0 (Modified MSDOS 5.0 IO.SYS)
 38673                                  	; (SYSINIT:30ACh)
 38674                                  parseline:
 38675                                  	; 03/01/2023
 38676                                  	; ds = cs ; *
 38677                                  
 38678                                  	;push	ds ; *
 38679                                  
 38680                                  	;push	cs ; *
 38681                                  	;pop	ds ; *
 38682                                  
 38683                                  nextswtch:
 38684                                  	cmp	al,cr			; carriage return?
 38685                                  	je	short done_line
 38686                                  	cmp	al,lf			; linefeed?
 38687                                  	je	short put_back		; put it back and done
 38688                                  
 38689                                  ; anything less or equal to a space is ignored.
 38690                                  
 38691                                  	cmp	al,' '                  ; space?
 38692                                  	jbe	short getnext		; skip over space
 38693                                  	cmp	al,'/'
 38694                                  	je	short getparm
 38695                                  	stc				; mark error invalid-character-in-input
 38696                                  	;jmp	short exitpl
 38697                                  	; 03/01/2023
 38698                                  swterr:
 38699                                  	retn
 38700                                  
 38701                                  getparm:
 38702                                  	call	check_switch
 38703                                  	mov	[switches],bx		; save switches read so far
 38704                                  	jc	short swterr
 38705                                  getnext:
 38706                                  	call	getchr
 38707                                  	;jc	short done_line
 38708                                  	;jmp	short nextswtch
 38709                                  	; 03/01/2023
 38710                                  	jnc	short nextswtch
 38711                                  ;swterr:
 38712                                  	;jmp	short exitpl		; exit if error
 38713                                  
 38714                                  done_line:
 38715                                  	; 12/12/2022
 38716                                  	test	byte [switches],flagdrive ; 8
 38717                                  	;test	word [switches],flagdrive ; 8 ; see if drive specified
 38718                                  	jnz	short okay
 38719                                  	stc				; mark error no-drive-specified
 38720                                  	;jmp	short exitpl
 38721                                  	; 03/01/2023
 38722                                  	retn
 38723                                  
 38724                                  okay:
 38725                                  	mov	ax,[switches]
 38726                                  	and	ax,0003h	    ; get flag bits for changeline and non-rem
 38727                                  	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_DEVICEATTRIBUTES],ax
 38728                                  	mov	word [deviceparameters+A_DEVICEPARAMETERS.DP_TRACKTABLEENTRIES],0
 38729                                  	;clc			    ; everything is fine
 38730                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38731                                  	; 12/12/2022
 38732                                  	; cf=0
 38733                                  	;clc
 38734                                  	;call	setdeviceparameters
 38735                                  	; 03/01/2023
 38736                                  	jmp	setdeviceparameters
 38737                                  ;exitpl:
 38738                                  	; 03/01/2023
 38739                                  	; ds = cs
 38740                                  	;pop	ds ; *
 38741                                  	retn
 38742                                  put_back:
 38743                                  	inc	word [count]		; one more char to scan
 38744                                  	dec	word [chrptr]		; back up over linefeed
 38745                                  	jmp	short done_line
 38746                                  
 38747                                  %endif
 38748                                  
 38749                                  ;----------------------------------------------------------------------------
 38750                                  ;
 38751                                  ; procedure : check_switch
 38752                                  ;
 38753                                  ; processes a switch in the input. it ensures that the switch is valid, and
 38754                                  ; gets the number, if any required, following the switch. the switch and the
 38755                                  ; number *must* be separated by a colon. carry is set if there is any kind of
 38756                                  ; error.
 38757                                  ;
 38758                                  ;----------------------------------------------------------------------------
 38759                                  
 38760                                  ; 09/09/2023
 38761                                  
 38762                                  err_swtch:
 38763 00003531 31CB                    	xor	bx,cx			; remove this switch from the records
 38764                                  err_check:
 38765 00003533 F9                      	stc
 38766                                  err_chk:
 38767                                  done_swtch:	; 09/09/2023 (cf=0)
 38768 00003534 C3                      	retn
 38769                                  
 38770                                  	; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 38771                                  
 38772                                  check_switch:
 38773 00003535 E8240D                  	call	getchr
 38774                                  	;jc	short err_check
 38775 00003538 72FA                    	jc	short err_chk
 38776 0000353A 24DF                            and     al,0DFh                 ; convert it to upper case
 38777 0000353C 3C41                    	cmp	al,'A'
 38778                                  	;jb	short err_check
 38779 0000353E 72F4                    	jb	short err_chk ; 15/04/2019 - Retro DOS v4.0
 38780 00003540 3C5A                    	cmp	al,'Z'
 38781 00003542 77EF                    	ja	short err_check
 38782                                  
 38783 00003544 06                      	push	es
 38784                                  
 38785 00003545 0E                      	push	cs
 38786 00003546 07                      	pop	es
 38787                                  
 38788                                  	;mov	cl,[switchlist]		; get number of valid switches
 38789                                  	;mov	ch,0
 38790                                  	;mov	di,1+switchlist		; point to string of valid switches
 38791                                  	; 09/09/2023
 38792 00003547 BF[1E4A]                	mov	di,switchlist
 38793 0000354A 8A0D                    	mov	cl,[di]
 38794 0000354C B500                    	mov	ch,0
 38795 0000354E 47                      	inc	di	; 1+switchlist
 38796                                  
 38797 0000354F F2AE                    	repne	scasb
 38798                                  
 38799 00003551 07                      	pop	es
 38800 00003552 75DF                    	jnz	short err_check
 38801                                  
 38802 00003554 B80100                  	mov	ax,1
 38803 00003557 D3E0                    	shl	ax,cl			; set bit to indicate switch
 38804 00003559 8B1E[8B49]              	mov	bx,[switches]		; get switches so far
 38805 0000355D 09C3                    	or	bx,ax			; save this with other switches
 38806 0000355F 89C1                    	mov	cx,ax
 38807                                  	; 12/12/2022
 38808 00003561 A8F8                    	test	al,switchnum ; 0F8h
 38809                                  	;test	ax,switchnum ; 0F8h	; test against switches that require number to follow
 38810 00003563 74CF                    	jz	short done_swtch
 38811                                  
 38812 00003565 E8F40C                  	call	getchr
 38813 00003568 72C7                    	jc	short err_swtch
 38814                                  
 38815 0000356A 3C3A                    	cmp	al,':'
 38816 0000356C 75C3                    	jne	short err_swtch
 38817                                  
 38818 0000356E E8EB0C                  	call	getchr
 38819 00003571 53                      	push	bx			; preserve switches
 38820                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38821                                  	;mov	byte [cs:sepchr],' '	; allow space separators
 38822                                  	; 12/12/2022
 38823                                  	; ds = cs
 38824 00003572 C606[AE02]20            	mov	byte [sepchr],' '
 38825 00003577 E8980D                  	call	getnum
 38826                                  	;mov	byte [cs:sepchr],0
 38827                                  	; 12/12/2022
 38828 0000357A C606[AE02]00            	mov	byte [sepchr],0
 38829 0000357F 5B                      	pop	bx			; restore switches
 38830                                  
 38831                                  ; because getnum does not consider carriage-return or line-feed as ok, we do
 38832                                  ; not check for carry set here. if there is an error, it will be detected
 38833                                  ; further on (hopefully).
 38834                                  
 38835                                  	; 09/09/2023
 38836                                  	;call	process_num
 38837                                  	;jmp	short process_num
 38838                                  
 38839                                  ;done_swtch:
 38840                                  ;	;clc
 38841                                  ;	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38842                                  ;	; 12/12/2022
 38843                                  ;	; cf=0
 38844                                  ;	;clc
 38845                                  ;	retn
 38846                                  
 38847                                  ;----------------------------------------------------------------------------
 38848                                  ;
 38849                                  ; procedure : process_num
 38850                                  ;
 38851                                  ; this routine takes the switch just input, and the number following (if any),
 38852                                  ; and sets the value in the appropriate variable. if the number input is zero
 38853                                  ; then it does nothing - it assumes the default value that is present in the
 38854                                  ; variable at the beginning. zero is ok for form factor and drive, however.
 38855                                  ;
 38856                                  ;----------------------------------------------------------------------------
 38857                                  
 38858                                  	; 02/11/2022 - Retrodos v4.0 (Modified MSDOS 5.0 IO.SYS)
 38859                                  	; (SYSINIT:3156h)
 38860                                  process_num:
 38861 00003580 850E[8B49]              	test	[switches],cx		; if this switch has been done before,
 38862 00003584 752B                    	jnz	short done_ret		; ignore this one.
 38863                                  	; 12/12/2022
 38864 00003586 F6C108                  	test	cl,flagdrive ; 8
 38865                                  	;test	cx,flagdrive ; 8
 38866 00003589 7404                    	jz	short try_f
 38867 0000358B A2[8A49]                	mov	byte [drive],al
 38868                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38869                                  	;jmp	short done_ret
 38870                                  	; 12/12/2022
 38871                                  	; cf=0
 38872 0000358E C3                      	retn	; 13/05/2019
 38873                                  try_f:
 38874                                  	; 12/12/2022
 38875 0000358F F6C180                  	test	cl,flagff ; 80h
 38876                                  	;test	cx,flagff ; 80h
 38877 00003592 7404                    	jz	short try_t
 38878                                  
 38879                                  ; ensure that we do not get bogus form factors that are not supported
 38880                                  
 38881                                  	;mov	[deviceparameters+1],al
 38882 00003594 A2[6348]                	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_DEVICETYPE],al
 38883                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38884                                  	;jmp	short done_ret
 38885                                  	; 12/12/2022
 38886                                  	; cf=0
 38887 00003597 C3                      	retn	; 13/05/2019
 38888                                  try_t:
 38889 00003598 09C0                    	or	ax,ax
 38890 0000359A 7415                    	jz	short done_ret		; if number entered was 0, assume default value
 38891                                  	; 12/12/2022
 38892 0000359C F6C110                  	test	cl,flagcyln ; 10h
 38893                                  	;test	cx,flagcyln ; 10h
 38894 0000359F 7404                    	jz	short try_s
 38895                                  
 38896                                  	;mov	[deviceparameters+4],ax
 38897 000035A1 A3[6648]                	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_CYLINDERS],ax
 38898                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38899                                  	;jmp	short done_ret
 38900                                  	; 12/12/2022
 38901                                  	; cf=0
 38902 000035A4 C3                      	retn	; 13/05/2019
 38903                                  try_s:
 38904                                  	; 12/12/2022
 38905 000035A5 F6C120                  	test	cl,flagseclim ; 20h
 38906                                  	;test	cx,flagseclim ; 20h
 38907 000035A8 7404                    	jz	short try_h
 38908 000035AA A3[8849]                	mov	[slim],ax
 38909                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38910                                  	;jmp	short done_ret
 38911                                  	; 12/12/2022
 38912                                  	; cf=0
 38913 000035AD C3                      	retn	; 13/05/2019
 38914                                  
 38915                                  ; must be for number of heads
 38916                                  
 38917                                  try_h:
 38918 000035AE A3[8649]                	mov	[hlim],ax
 38919                                  done_ret:
 38920                                  	;clc
 38921                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 38922                                  	; 12/12/2022
 38923                                  	; cf=0 (test instruction resets cf)
 38924                                  	;clc
 38925 000035B1 C3                      	retn
 38926                                  
 38927                                  
 38928                                  ; 03/01/2023 - Retro DOS v4.2
 38929                                  %if 1
 38930                                  
 38931                                  ; 15/04/2019 - Retro DOS v4.0
 38932                                  
 38933                                  ;----------------------------------------------------------------------------
 38934                                  ;
 38935                                  ; procedure : parseline
 38936                                  ;
 38937                                  ; entry point is parseline. al contains the first character in command line.
 38938                                  ;
 38939                                  ;----------------------------------------------------------------------------
 38940                                  
 38941                                  	; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 38942                                  	; (SYSINIT:3EDFh)
 38943                                  
 38944                                  	; 01/11/2022 - Retrodos v4.0 (Modified MSDOS 5.0 IO.SYS)
 38945                                  	; (SYSINIT:30ACh)
 38946                                  parseline:
 38947                                  	; 03/01/2023
 38948                                  	; ds = cs ; *
 38949                                  
 38950                                  	;push	ds ; *
 38951                                  
 38952                                  	;push	cs ; *
 38953                                  	;pop	ds ; *
 38954                                  
 38955                                  nextswtch:
 38956 000035B2 3C0D                    	cmp	al,cr			; carriage return?
 38957 000035B4 741C                    	je	short done_line
 38958 000035B6 3C0A                    	cmp	al,lf			; linefeed?
 38959 000035B8 7421                    	je	short put_back		; put it back and done
 38960                                  
 38961                                  ; anything less or equal to a space is ignored.
 38962                                  
 38963 000035BA 3C20                    	cmp	al,' '                  ; space?
 38964 000035BC 760F                    	jbe	short getnext		; skip over space
 38965 000035BE 3C2F                    	cmp	al,'/'
 38966 000035C0 7402                    	je	short getparm
 38967 000035C2 F9                      	stc				; mark error invalid-character-in-input
 38968                                  	;jmp	short exitpl
 38969                                  	; 03/01/2023
 38970                                  swterr:
 38971 000035C3 C3                      	retn
 38972                                  
 38973                                  getparm:
 38974 000035C4 E86EFF                  	call	check_switch
 38975 000035C7 891E[8B49]              	mov	[switches],bx		; save switches read so far
 38976 000035CB 72F6                    	jc	short swterr
 38977                                  getnext:
 38978 000035CD E88C0C                  	call	getchr
 38979                                  	;jc	short done_line
 38980                                  	;jmp	short nextswtch
 38981                                  	; 03/01/2023
 38982 000035D0 73E0                    	jnc	short nextswtch
 38983                                  ;swterr:
 38984                                  	;jmp	short exitpl		; exit if error
 38985                                  
 38986                                  done_line:
 38987                                  	; 12/12/2022
 38988 000035D2 F606[8B49]08            	test	byte [switches],flagdrive ; 8
 38989                                  	;test	word [switches],flagdrive ; 8 ; see if drive specified
 38990 000035D7 750C                    	jnz	short okay
 38991 000035D9 F9                      	stc				; mark error no-drive-specified
 38992                                  	;jmp	short exitpl
 38993                                  	; 03/01/2023
 38994 000035DA C3                      	retn
 38995                                  
 38996                                  ;exitpl:
 38997                                  	; 03/01/2023
 38998                                  	; ds = cs
 38999                                  	;;pop	ds ; *
 39000                                  	;retn
 39001                                  
 39002                                  put_back:
 39003 000035DB FF06[5603]              	inc	word [count]		; one more char to scan
 39004 000035DF FF0E[5A03]              	dec	word [chrptr]		; back up over linefeed
 39005 000035E3 EBED                    	jmp	short done_line
 39006                                  
 39007                                  okay:
 39008 000035E5 A1[8B49]                	mov	ax,[switches]
 39009 000035E8 83E003                  	and	ax,0003h	    ; get flag bits for changeline and non-rem
 39010 000035EB A3[6448]                	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_DEVICEATTRIBUTES],ax
 39011 000035EE C706[8848]0000          	mov	word [deviceparameters+A_DEVICEPARAMETERS.DP_TRACKTABLEENTRIES],0
 39012                                  	;clc			    ; everything is fine
 39013                                  	; 01/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39014                                  	; 12/12/2022
 39015                                  	; cf=0
 39016                                  	;clc
 39017                                  	;call	setdeviceparameters
 39018                                  	; 03/01/2023
 39019                                  	;jmp	short setdeviceparameters
 39020                                  
 39021                                  %endif
 39022                                  
 39023                                  ;	M047 -- Begin modifications (too numerous to mark specifically)
 39024                                  
 39025                                  ;----------------------------------------------------------------------------
 39026                                  ;
 39027                                  ; procedure : setdeviceparameters
 39028                                  ;
 39029                                  ; setdeviceparameters sets up the recommended bpb in each bds in the
 39030                                  ; system based on the form factor. it is assumed that the bpbs for the
 39031                                  ; various form factors are present in the bpbtable. for hard files,
 39032                                  ; the recommended bpb is the same as the bpb on the drive.
 39033                                  ; no attempt is made to preserve registers since we are going to jump to
 39034                                  ; sysinit straight after this routine.
 39035                                  ;
 39036                                  ;	if we return carry, the DRIVPARM will be aborted, but presently
 39037                                  ;	  we always return no carry
 39038                                  ;
 39039                                  ;	note:  there is a routine by the same name in msdioctl.asm
 39040                                  ;
 39041                                  ;----------------------------------------------------------------------------
 39042                                  
 39043                                  ; 15/04/2019 - Retro DOS v4.0
 39044                                  
 39045                                  	; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 39046                                  
 39047                                  	; 03/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 39048                                  	; (SYSINIT:3FC4h)
 39049                                  
 39050                                  	; 09/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 39051                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:4236h)
 39052                                  
 39053                                  setdeviceparameters:
 39054                                  	; 03/01/2023
 39055                                  	; ds = cs
 39056                                  
 39057 000035F4 06                      	push	es
 39058                                  
 39059 000035F5 0E                      	push	cs
 39060 000035F6 07                      	pop	es
 39061                                  
 39062 000035F7 31DB                    	xor	bx,bx
 39063 000035F9 8A1E[6348]              	mov	bl,[deviceparameters+A_DEVICEPARAMETERS.DP_DEVICETYPE]
 39064 000035FD 80FB00                  	cmp	bl,DEV_5INCH ; 0
 39065 00003600 7506                    	jne	short got_80
 39066                                  
 39067 00003602 C706[6648]2800          	mov	word [deviceparameters+A_DEVICEPARAMETERS.DP_CYLINDERS],40
 39068                                  							; 48 tpi=40 cyl
 39069                                  got_80:
 39070 00003608 D1E3                    	shl	bx,1			; get index into bpb table
 39071 0000360A 8BB7[0A4A]              	mov	si,[bpbtable+bx]	; get address of bpb
 39072                                  
 39073                                  	;mov	di,deviceparameters+7	
 39074                                  	; 02/11/2022
 39075 0000360E BF[6948]                	mov	di,deviceparameters+A_DEVICEPARAMETERS.DP_BPB ; es:di -> bpb
 39076 00003611 B91F00                  	mov	cx,A_BPB.size ; 31
 39077                                  	; 09/09/2023
 39078                                  	;mov	cx,59 ; PCDOS 7.1 IBMBIO.COM A_BPB.size
 39079 00003614 FC                      	cld
 39080                                  	;repe	movsb
 39081                                  	; 02/11/2022
 39082 00003615 F3A4                    	rep	movsb
 39083                                  
 39084 00003617 07                      	pop	es
 39085                                  
 39086                                  	; 12/12/2022
 39087 00003618 F606[8B49]20            	test	byte [switches],flagseclim ; 20h
 39088                                  	;test	word [switches],flagseclim ; 20h
 39089 0000361D 7406                    	jz	short see_heads
 39090                                  
 39091 0000361F A1[8849]                	mov	ax,[slim]
 39092                                  	;mov	[deviceparameters+20],ax
 39093 00003622 A3[7648]                	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERTRACK],ax
 39094                                  
 39095                                  see_heads:
 39096                                  	; 12/12/2022
 39097 00003625 F606[8B49]40            	test	byte [switches],flagheads ; 40h
 39098                                  	;test	word [switches],flagheads ; 40h
 39099 0000362A 7406                    	jz	short heads_not_altered
 39100                                  
 39101 0000362C A1[8649]                	mov	ax,[hlim]
 39102                                  	;mov	[deviceparameters+22],ax	
 39103 0000362F A3[7848]                	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_HEADS],ax
 39104                                  
 39105                                  heads_not_altered:
 39106                                  
 39107                                  ; set up correct media descriptor byte and sectors/cluster
 39108                                  ;   sectors/cluster is always 2 except for any one sided disk or 1.44M
 39109                                  
 39110                                  	;mov	byte [deviceparameters+9],2
 39111                                  	; 02/11/2022
 39112                                  	;mov	byte [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERCLUSTER],2
 39113                                  	; 03/01/2023
 39114 00003632 B80200                  	mov	ax,2	
 39115 00003635 A2[6B48]                	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERCLUSTER],al ; 2
 39116                                  
 39117 00003638 B3F0                    	mov	bl,0F0h			; get default mediabyte
 39118                                  
 39119                                  ;	preload the mediadescriptor from the bpb into bh for convenient access
 39120                                  
 39121                                  	;mov	bh,[deviceparameters+17]
 39122                                  	; 02/11/2022
 39123 0000363A 8A3E[7348]              	mov	bh,[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_MEDIADESCRIPTOR]
 39124                                  	
 39125                                  	; 03/01/2023
 39126                                  	; ax = 2
 39127 0000363E 3906[7848]              	cmp	[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_HEADS],ax ; >2 heads?
 39128                                  	;cmp	word [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_HEADS],2 ; >2 heads?
 39129 00003642 773C                    	ja	short got_correct_mediaid ; just use default if heads>2
 39130                                  
 39131 00003644 7524                    	jne	short only_one_head	; one head, do one head stuff
 39132                                  
 39133                                  ;	two head drives will use the mediadescriptor from the bpb
 39134                                  
 39135 00003646 88FB                    	mov	bl,bh			; get mediadescriptor from bpb
 39136                                  
 39137                                  ;	two sided drives have two special cases to look for. One is
 39138                                  ;	   a 320K diskette (40 tracks, 8 secs per track). It uses
 39139                                  ;	   a mediaid of 0fch. The other is 1.44M, which uses only
 39140                                  ;	   one sector/cluster.
 39141                                  
 39142                                  ;	any drive with 18secs/trk, 2 heads, 80 tracks, will be assumed
 39143                                  ;	   to be a 1.44M and use only 1 sector per cluster. Any other
 39144                                  ;	   type of 2 headed drive is all set.
 39145                                  
 39146 00003648 833E[7648]12            	cmp	word [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERTRACK],18
 39147 0000364D 7509                    	jne	short not_144m
 39148 0000364F 833E[6648]50            	cmp	word [deviceparameters+A_DEVICEPARAMETERS.DP_CYLINDERS],80
 39149 00003654 7502                    	jne	short not_144m
 39150                                  
 39151                                  ;	We've got cyl=80, heads=2, secpertrack=18. Set cluster size to 1.
 39152                                  
 39153 00003656 EB24                    	jmp	short got_one_secperclus_drive
 39154                                  
 39155                                  ;	check for 320K
 39156                                  
 39157                                  not_144m:
 39158 00003658 833E[6648]28            	cmp	word [deviceparameters+A_DEVICEPARAMETERS.DP_CYLINDERS],40
 39159 0000365D 7521                    	jne	short got_correct_mediaid
 39160 0000365F 833E[7648]08            	cmp	word [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERTRACK],8
 39161 00003664 751A                    	jne	short got_correct_mediaid
 39162                                  
 39163 00003666 B3FC                    	mov	bl,0FCh
 39164 00003668 EB16                    	jmp	short got_correct_mediaid
 39165                                  
 39166                                  only_one_head:
 39167                                  
 39168                                  ;	if we don't have a 360K drive, then just go use 0f0h as media descr.
 39169                                  
 39170 0000366A 803E[6348]00            	cmp	byte [deviceparameters+A_DEVICEPARAMETERS.DP_DEVICETYPE],DEV_5INCH ; 0
 39171 0000366F 740B                    	je	short got_one_secperclus_drive
 39172                                  
 39173                                  ;	single sided 360K drive uses either 0fch or 0feh, depending on
 39174                                  ;	  whether sectorspertrack is 8 or 9. For our purposes, anything
 39175                                  ;	  besides 8 will be considered 0fch
 39176                                  
 39177 00003671 B3FC                    	mov	bl,0FCh			; single sided 9 sector media id
 39178 00003673 833E[7648]08            	cmp	word [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERTRACK],8
 39179                                  	; 12/12/2022
 39180 00003678 7502                    	jne	short got_one_secperclus_drive ; okay if anything besides 8
 39181                                  
 39182 0000367A B3FE                    	mov	bl,0FEh			; 160K mediaid
 39183                                  
 39184                                  ;	we've either got a one sided drive, or a 1.44M drive
 39185                                  ;	  either case we'll use 1 sector per cluster instead of 2
 39186                                  
 39187                                  got_one_secperclus_drive:
 39188                                  	; 03/01/2023
 39189                                  	; ax = 2
 39190 0000367C 48                      	dec	ax  ; ax = 1
 39191 0000367D A2[6B48]                	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERCLUSTER],al ; 1
 39192                                  	;mov	byte [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERCLUSTER],1
 39193                                  
 39194                                  got_correct_mediaid:
 39195 00003680 881E[7348]              	mov	[deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_MEDIADESCRIPTOR],bl
 39196                                  
 39197                                  ;	 Calculate the correct number of Total Sectors on medium
 39198                                  
 39199 00003684 A1[6648]                	mov	ax,[deviceparameters+A_DEVICEPARAMETERS.DP_CYLINDERS]
 39200 00003687 F726[7848]              	mul	word [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_HEADS]
 39201 0000368B F726[7648]              	mul	word [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERTRACK]
 39202 0000368F A3[7148]                	mov	word [deviceparameters+A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_TOTALSECTORS],ax
 39203 00003692 F8                      	clc				; we currently return no errors
 39204                                  
 39205 00003693 C3                      	retn
 39206                                  
 39207                                  ;	M047 -- end rewritten routine
 39208                                  
 39209                                  ;----------------------------------------------------------------------------
 39210                                  ;
 39211                                  ; procedure : organize
 39212                                  ;
 39213                                  ;----------------------------------------------------------------------------
 39214                                  
 39215                                  ; 09/09/2023 - Retrodos v4.2 IO.SYS (Optimization)
 39216                                  %if 1
 39217                                  end_commd_line:
 39218 00003694 AA                      	stosb				; store line feed char in buffer for the linecount.
 39219                                  	;mov	byte [cs:com_level],0	; reset the command level.
 39220                                  	; 03/01/2023
 39221                                  	; ds = cs
 39222                                  	;mov	byte [com_level],0
 39223                                  	;jmp	short org1
 39224                                  	; 09/09/2023
 39225 00003695 EB0E                    	jmp	short org0
 39226                                  nochar1:
 39227 00003697 F9                      	stc
 39228 00003698 C3                      	retn
 39229                                  %endif
 39230                                  	; 02/11/2022 - Retrodos v4.0 (Modified MSDOS 5.0 IO.SYS)
 39231                                  	; (SYSINIT:3234h)
 39232                                  
 39233                                  	; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 39234                                  	; (SYSINIT:4067h)
 39235                                  
 39236                                  	; 09/09/2023 - Retrodos v4.2 IO.SYS (Optimization)
 39237                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:42D9h)
 39238                                  
 39239                                  organize:
 39240                                  	; 03/01/2023
 39241                                  	; ds = cs
 39242 00003699 8B0E[5603]              	mov	cx,[count]
 39243                                  	;mov	cx,[cs:count]
 39244 0000369D E3F8                    	jcxz	nochar1
 39245                                  
 39246                                  ;ifndef	MULTI_CONFIG
 39247                                  ;
 39248                                  ;;   In MULTI_CONFIG, we map to upper case on a line-by-line basis,
 39249                                  ;;   because we the case of values in SET commands preserved
 39250                                  ;
 39251                                  ;	call	mapcase
 39252                                  ;endif
 39253                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39254                                  	; 03/01/2023 - Retro DOS v4.2
 39255                                  	;call	mapcase
 39256                                  
 39257 0000369F 31F6                    	xor	si,si
 39258 000036A1 89F7                    	mov	di,si
 39259 000036A3 31C0                    	xor	ax,ax
 39260                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)	
 39261                                  	;;mov	byte [cs:com_level],0
 39262                                  	; 12/12/2022
 39263                                  	;mov	[cs:com_level],al ; 0
 39264                                  	; 03/01/2023
 39265                                  	; ds = cs
 39266                                  	; 09/09/2023
 39267                                  	;mov	[com_level],al ; 0
 39268                                  org0:
 39269 000036A5 C606[5003]00            	mov	byte [com_level],0 ; 09/09/2023
 39270                                  org1:
 39271 000036AA E8EF01                  	call	skip_comment
 39272 000036AD 74E5                    	jz	short end_commd_line	; found a comment string and skipped.
 39273 000036AF E8D001                  	call	get2			; not a comment string. then get a char.
 39274 000036B2 3C0A                    	cmp	al,lf ; 0Ah
 39275 000036B4 74DE                    	je	short end_commd_line	; starts with a blank line.
 39276 000036B6 3C20                    	cmp	al,' ' ; 20h
 39277 000036B8 76F0                    	jbe	short org1		; skip leading control characters
 39278                                  	; 09/09/2023
 39279                                  	;jmp	short findit
 39280                                  
 39281                                  ; 09/09/2023
 39282                                  %if 0
 39283                                  end_commd_line:
 39284                                  	stosb				; store line feed char in buffer for the linecount.
 39285                                  	;mov	byte [cs:com_level],0	; reset the command level.
 39286                                  	; 03/01/2023
 39287                                  	; ds = cs
 39288                                  	mov	byte [com_level],0
 39289                                  	jmp	short org1
 39290                                  
 39291                                  nochar1:
 39292                                  	stc
 39293                                  	retn
 39294                                  %endif
 39295                                  
 39296                                  findit:
 39297 000036BA 51                      	push	cx
 39298 000036BB 56                      	push	si
 39299 000036BC 57                      	push	di
 39300 000036BD 89F5                    	mov	bp,si
 39301 000036BF 4D                      	dec	bp
 39302 000036C0 BE[7F47]                        mov     si,comtab		; prepare to search command table
 39303 000036C3 B500                    	mov	ch,0
 39304                                  findcom:
 39305 000036C5 89EF                    	mov	di,bp
 39306 000036C7 8A0C                    	mov	cl,[si]
 39307 000036C9 46                      	inc	si
 39308 000036CA E345                    	jcxz	nocom
 39309                                  
 39310                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39311                                  
 39312                                  ; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 39313                                  
 39314                                  ;ifdef	MULTI_CONFIG
 39315                                  
 39316                                  ;   Simplify future parsing by collapsing ";" onto "REM", and at the same
 39317                                  ;   time skip the upcoming delimiter test (since ";" need not be followed by
 39318                                  ;   anything in particular)
 39319                                  
 39320 000036CC 26803D3B                	cmp	byte [es:di],CONFIG_SEMICOLON  ; ';'
 39321 000036D0 7430                    	je	short semicolon
 39322                                  loopcom:
 39323                                  	;mov	al,[es:di]
 39324                                  	;inc	di
 39325                                  	;and	al,~20h ; 0DFh		; force upper case
 39326                                  	;inc	si                      ; compare to byte @es:di
 39327                                  	;cmp	al,[si-1]
 39328                                  	; 28/07/2023 - Retro DOS v4.2 IO.SYS (optimization)
 39329 000036D2 268A25                  	mov	ah,[es:di]
 39330 000036D5 47                      	inc	di
 39331 000036D6 80E4DF                  	and	ah,~20h ; 0DFh		
 39332 000036D9 AC                      	lodsb			; mov al,[si]
 39333                                  				; inc si
 39334                                  	;cmp	al,ah
 39335                                  	;loope	loopcom
 39336                                  	; 28/07/2023
 39337 000036DA 30C4                    	xor	ah,al		; result: ah = 0 (*) if ah = al
 39338 000036DC E1F4                    	loopz	loopcom
 39339                                  ;else
 39340                                  ;	repe	cmpsb
 39341                                  ;endif
 39342                                  	; 02/11/2022
 39343                                  	; 03/01/2023 - Retro DOS v4.2
 39344                                  	;repe	cmpsb
 39345                                  
 39346                                  	; 28/07/2023
 39347                                  	;lahf
 39348 000036DE 01CE                            add     si,cx                   ; bump to next position without affecting flags
 39349                                  	;sahf
 39350 000036E0 AC                              lodsb                           ; get indicator letter
 39351                                  	;jnz	short findcom
 39352                                          ; 28/07/2023
 39353 000036E1 08E4                    	or	ah,ah			; (*)
 39354 000036E3 75E0                    	jnz	short findcom		
 39355                                  	
 39356 000036E5 26803D0D                	cmp     byte [es:di],cr		; the next char might be cr,lf
 39357 000036E9 7421                    	je	short gotcom0 		; such as in "rem",cr,lf case.
 39358 000036EB 26803D0A                	cmp	byte [es:di],lf
 39359 000036EF 741B                    	je	short gotcom0
 39360                                  
 39361                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39362                                  
 39363                                  ; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 39364                                  
 39365                                  ;ifdef	MULTI_CONFIG
 39366                                  
 39367                                  ; Skip the delimiter test for the BEGIN identifier (it doesn't have one).
 39368                                  
 39369 000036F1 3C5B                    	cmp	al,CONFIG_BEGIN  ; '['
 39370 000036F3 7417                    	je	short gotcom0
 39371                                  ;endif
 39372 000036F5 50                      	push	ax
 39373 000036F6 268A05                  	mov	al,[es:di]		; now the next char. should be a delim.
 39374                                  
 39375                                  ;ifdef	MULTI_CONFIG
 39376                                  
 39377                                  ;   If keyword is *immediately* followed by a question mark (?), then
 39378                                  ;   set the high bit of the ASCII command code (CONFIG_OPTION_QUERY) that is
 39379                                  ;   stored in the CONFIG.SYS memory image.
 39380                                  
 39381 000036F9 3C3F                    	cmp	al,'?'                  ; explicit interactive command?
 39382 000036FB 7509                    	jne	short no_query		; no
 39383 000036FD 58                      	pop	ax                      ; yes, so retrieve the original code
 39384                                  	;or	al,80h ; 03/01/2023
 39385 000036FE 0C80                    	or	al,CONFIG_OPTION_QUERY  ; and set the QUERY bit
 39386 00003700 EB0A                    	jmp	short gotcom0           ;
 39387                                  semicolon:
 39388 00003702 B030                    	mov	al,CONFIG_REM ; '0'
 39389 00003704 EB06                    	jmp	short gotcom0
 39390                                  no_query:
 39391                                  ;endif  ;MULTI_CONFIG
 39392                                  
 39393                                  	; 02/11/2022
 39394                                  	; 03/01/2023 - Retro DOS v4.2
 39395                                  	;push	ax
 39396                                  	;mov	al,[es:di]		; now the next char. should be a delim.
 39397                                  
 39398 00003706 E82E0B                  	call	delim
 39399                                  no_delim:
 39400 00003709 58                      	pop	ax
 39401 0000370A 75B9                    	jnz	short findcom
 39402                                  gotcom0:
 39403 0000370C 5F                      	pop	di
 39404 0000370D 5E                      	pop	si
 39405 0000370E 59                      	pop	cx
 39406 0000370F EB10                    	jmp	short gotcom
 39407                                  nocom:
 39408 00003711 5F                      	pop	di
 39409 00003712 5E                      	pop	si
 39410 00003713 59                      	pop	cx
 39411 00003714 B05A                            mov     al,CONFIG_UNKNOWN  ; 'Z'
 39412 00003716 AA                      	stosb				; save indicator char.
 39413                                  _skipline:
 39414 00003717 E86801                  	call	get2
 39415 0000371A 3C0A                    	cmp	al,lf ; 0Ah		; skip this bad command line
 39416 0000371C 75F9                            jne     short _skipline
 39417                                  	;jmp	short end_commd_line	; handle next command line
 39418                                  	; 09/09/2023
 39419 0000371E E973FF                  	jmp	end_commd_line
 39420                                  gotcom:
 39421 00003721 AA                              stosb                           ; save indicator char in buffer
 39422                                  
 39423                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39424                                  
 39425                                  ; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 39426                                  
 39427                                  ;ifdef	MULTI_CONFIG
 39428                                  
 39429                                  ;   Don't pollute "cmd_indicator" with the CONFIG_OPTION_QUERY bit though;
 39430                                  ;   it screws up the direct comparisons below.
 39431                                  
 39432 00003722 247F                    	and	al,~CONFIG_OPTION_QUERY ; 7Fh
 39433                                  ;endif
 39434                                  	;mov	[cs:cmd_indicator],al	; save it for the future use.
 39435                                  	; 03/01/2023
 39436                                  	; ds = cs
 39437 00003724 A2[5403]                	mov	[cmd_indicator],al	; save it for the future use.
 39438                                  
 39439                                  ;ifdef	MULTI_CONFIG
 39440                                  
 39441                                  ;   There is no whitespace/delimiter between the "begin block" character
 39442                                  ;   ([) and the name of block (eg, [menu]), therefore skip this delimiter
 39443                                  ;   skipping code
 39444                                  
 39445 00003727 3C5B                    	cmp	al,CONFIG_BEGIN
 39446 00003729 7455                    	je	short org31
 39447 0000372B 3C4F                    	cmp	al,CONFIG_SUBMENU ; 'O'
 39448 0000372D 740F                    	je	short no_mapcase
 39449 0000372F 3C45                    	cmp	al,CONFIG_MENUITEM ; 'E'
 39450 00003731 740B                    	je	short no_mapcase
 39451 00003733 3C41                    	cmp	al,CONFIG_MENUDEFAULT ; 'A'
 39452 00003735 7407                    	je	short no_mapcase
 39453 00003737 3C4A                    	cmp	al,CONFIG_INCLUDE ; 'J'
 39454 00003739 7403                    	je	short no_mapcase
 39455 0000373B E8350B                  	call	mapcase			; map case of rest of line to UPPER
 39456                                  no_mapcase:
 39457                                  ;endif
 39458                                  	;; 02/11/2022
 39459                                  	;;mov	[cs:cmd_indicator],al	; save it for the future use.
 39460                                  	;; 03/01/2023
 39461                                  	;; ds = cs
 39462                                  	;mov	[cmd_indicator],al
 39463                                  org2:	
 39464 0000373E E84101                  	call    get2                    ; skip the command name until delimiter
 39465 00003741 3C0A                            cmp     al,lf 	    ; 0Ah
 39466 00003743 740F                    	je	short org21
 39467 00003745 3C0D                    	cmp	al,cr 	    ; 0Dh	
 39468 00003747 740B                    	je	short org21
 39469                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39470                                  	; 03/01/2023 - Retro DOS v4.2
 39471 00003749 3C2F                    	cmp	al, '/'			; T-RICHJ: Added to allow DEVHIGH/L:...
 39472 0000374B 7407                    	je	short org21		; T-RICHJ: to be parsed properly.
 39473                                  
 39474 0000374D E8E70A                  	call	delim
 39475 00003750 75EC                            jnz	short org2
 39476 00003752 EB02                    	jmp	short org3
 39477                                  org21:					;if cr or lf then
 39478 00003754 4E                      	dec	si			; undo si, cx register
 39479 00003755 41                      	inc	cx			;  and continue
 39480                                  org3:	
 39481                                  	;cmp	byte [cs:cmd_indicator],CONFIG_COMMENT ; 'Y'
 39482                                  	;je	short get_cmt_token
 39483                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39484                                  	; 03/01/2023 - Retro DOS v4.2	
 39485                                  	;cmp	byte [cs:cmd_indicator],CONFIG_DEVICE ; 'D'
 39486                                  	;je	short org_file
 39487                                  	;cmp	byte [cs:cmd_indicator],CONFIG_INSTALL ; 'I'
 39488                                  	;je	short org_file
 39489                                  	;cmp	byte [cs:cmd_indicator],CONFIG_INSTALLHIGH ; 'W'
 39490                                  	;je	short org_file
 39491                                  	; 02/11/2022
 39492                                  	; 03/01/2023 - Retro DOS v4.2
 39493                                  	;;cmp	byte [cs:cmd_indicator],CONFIG_DEVICE ; 'D'
 39494                                  	;;je	short org_file
 39495                                  	;cmp	byte [cs:cmd_indicator],CONFIG_SHELL ; 'S'
 39496                                  	;je	short org_file
 39497                                          ;cmp	byte [cs:cmd_indicator],CONFIG_SWITCHES ; '1'
 39498                                  	;je	short org_switch
 39499                                  
 39500                                  	; 03/01/2023
 39501                                  	; ds = cs
 39502                                  
 39503 00003756 803E[5403]59            	cmp	byte [cmd_indicator],CONFIG_COMMENT ; 'Y'
 39504 0000375B 745D                    	je	short get_cmt_token
 39505                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39506                                  	; 03/01/2023 - Retro DOS v4.2	
 39507 0000375D 803E[5403]44            	cmp	byte [cmd_indicator],CONFIG_DEVICE ; 'D'
 39508 00003762 7430                    	je	short org_file
 39509 00003764 803E[5403]49            	cmp	byte [cmd_indicator],CONFIG_INSTALL ; 'I'
 39510 00003769 7429                    	je	short org_file
 39511 0000376B 803E[5403]57            	cmp	byte [cmd_indicator],CONFIG_INSTALLHIGH ; 'W'
 39512 00003770 7422                    	je	short org_file
 39513                                  	; 02/11/2022
 39514                                  	; 03/01/2023 - Retro DOS v4.2
 39515                                  	;cmp	byte [cmd_indicator],CONFIG_DEVICE ; 'D'
 39516                                  	;je	short org_file
 39517 00003772 803E[5403]53                    cmp	byte [cmd_indicator],CONFIG_SHELL ; 'S'
 39518 00003777 741B                    	je	short org_file
 39519 00003779 803E[5403]31                    cmp	byte [cmd_indicator],CONFIG_SWITCHES ; '1'
 39520 0000377E 7403                    	je	short org_switch
 39521                                  	
 39522                                  org31:
 39523 00003780 E99500                  	jmp	org4
 39524                                  
 39525                                  org_switch:
 39526 00003783 E81601                  	call	skip_comment
 39527 00003786 7472                    	jz	short end_commd_line_brdg
 39528                                  
 39529 00003788 E8F700                  	call	get2
 39530 0000378B E8B10A                  	call	org_delim
 39531 0000378E 74F3                    	jz	short org_switch
 39532                                  
 39533 00003790 AA                      	stosb
 39534 00003791 E99300                  	jmp	org5
 39535                                  
 39536                                  org_file:			; get the filename and put 0 at end
 39537 00003794 E80501                  	call	skip_comment
 39538 00003797 7464                    	jz	short org_put_zero
 39539                                  
 39540 00003799 E8E600                  	call	get2		; not a comment
 39541 0000379C E8980A                  	call	delim
 39542 0000379F 74F3                    	jz	short org_file	; skip the possible delimiters
 39543                                  
 39544 000037A1 AA                      	stosb			; copy the first non delim char found in buffer
 39545                                  
 39546                                  org_copy_file:
 39547 000037A2 E8F700                  	call	skip_comment	; comment char in the filename?
 39548 000037A5 7456                    	jz	short org_put_zero ; then stop copying filename at that point
 39549                                  
 39550 000037A7 E8D800                  	call	get2
 39551 000037AA 3C2F                    	cmp	al,'/'		; a switch char? (device=filename/xxx)
 39552 000037AC 7457                    	je	short end_file_slash ; this will be the special case.
 39553                                  
 39554 000037AE AA                      	stosb			; save the char. in buffer
 39555 000037AF E8850A                  	call	delim
 39556 000037B2 7459                    	jz	short end_copy_file
 39557                                  
 39558 000037B4 3C20                    	cmp	al, ' '
 39559 000037B6 77EA                    	ja	short org_copy_file ; keep copying
 39560 000037B8 EB53                    	jmp	short end_copy_file ; otherwise, assume end of the filename.
 39561                                  
 39562                                  get_cmt_token:			; get the token. just max. 2 char.
 39563 000037BA E8C500                  	call	get2
 39564 000037BD 3C20                    	cmp	al,' '		; skip white spaces or "=" char.
 39565 000037BF 74F9                    	je	short get_cmt_token ; (we are allowing the other special
 39566 000037C1 3C09                    	cmp	al,tab ; 9 	;  characters can used for comment id.
 39567 000037C3 74F5                    	je	short get_cmt_token ;  character.)
 39568 000037C5 3C3D                    	cmp	al,'='		; = is special in this case.
 39569 000037C7 74F1                    	je	short get_cmt_token
 39570 000037C9 3C0D                    	cmp	al,cr
 39571 000037CB 7426                    	je	short get_cmt_end ; cannot accept the carriage return
 39572 000037CD 3C0A                    	cmp	al,lf
 39573 000037CF 7422                    	je	short get_cmt_end
 39574                                  
 39575                                  	; 03/01/2023
 39576                                  	; ds = cs
 39577                                  	;mov	[cs:cmmt1],al	; store it
 39578                                  	;mov	byte [cs:cmmt],1 ; 1 char. so far.
 39579 000037D1 A2[5203]                	mov	[cmmt1],al	; store it
 39580 000037D4 C606[5103]01            	mov	byte [cmmt],1	; 1 char. so far.
 39581 000037D9 E8A600                  	call	get2
 39582 000037DC 3C20                    	cmp	al,' ' ; 20h
 39583 000037DE 7413                    	je	short get_cmt_end
 39584 000037E0 3C09                    	cmp	al,tab ; 9
 39585 000037E2 740F                    	je	short get_cmt_end
 39586 000037E4 3C0D                    	cmp	al,cr  ; 0Dh
 39587 000037E6 740B                    	je	short get_cmt_end
 39588 000037E8 3C0A                    	cmp	al,lf  ; 0Ah
 39589 000037EA 740E                    	je	short end_commd_line_brdg
 39590                                  
 39591                                  	;mov	[cs:cmmt2],al
 39592                                  	;inc	byte [cs:cmmt]
 39593                                  	; 03/01/2023
 39594 000037EC A2[5303]                	mov	[cmmt2],al
 39595 000037EF FE06[5103]              	inc	byte [cmmt]
 39596                                  
 39597                                  get_cmt_end:
 39598 000037F3 E88C00                  	call	get2
 39599 000037F6 3C0A                    	cmp	al,lf
 39600 000037F8 75F9                    	jne	short get_cmt_end	; skip it.
 39601                                  end_commd_line_brdg: 
 39602 000037FA E997FE                  	jmp	end_commd_line		; else jmp to end_commd_line
 39603                                  
 39604                                  org_put_zero:				; make the filename in front of
 39605 000037FD 26C60500                	mov	byte [es:di],0		;  the comment string to be an asciiz.
 39606 00003801 47                      	inc	di
 39607 00003802 E98FFE                  	jmp	end_commd_line		;  (maybe null if device=/*)
 39608                                  
 39609                                  end_file_slash: 			; al = "/" option char.
 39610 00003805 26C60500                	mov	byte [es:di],0		; make a filename an asciiz
 39611 00003809 47                      	inc	di			; and
 39612 0000380A AA                      	stosb				; store "/" after that.
 39613 0000380B EB1A                    	jmp	short org5		; continue with the rest of the line
 39614                                  
 39615                                  end_copy_file:
 39616 0000380D 26C645FF00              	mov	byte [es:di-1],0	; make it an asciiz and handle the next char.
 39617 00003812 3C0A                    	cmp	al,lf
 39618 00003814 74E4                    	je	short end_commd_line_brdg
 39619 00003816 EB0F                    	jmp	short org5
 39620                                  
 39621                                  org4:					; org4 skips all delimiters after the command name except for '/'
 39622 00003818 E88100                  	call	skip_comment
 39623 0000381B 74DD                    	jz	short end_commd_line_brdg
 39624                                  
 39625 0000381D E86200                  	call	get2
 39626 00003820 E81C0A                  	call	org_delim		; skip delimiters except '/' (mrw 4/88)
 39627 00003823 74F3                    	jz	short org4
 39628 00003825 EB08                    	jmp	short org51
 39629                                  
 39630                                  org5:					; rest of the line
 39631 00003827 E87200                  	call	skip_comment		; comment?
 39632 0000382A 74CE                    	jz	short end_commd_line_brdg
 39633 0000382C E85300                  	call	get2			; not a comment.
 39634                                  
 39635                                  org51:
 39636 0000382F AA                      	stosb				; copy the character
 39637 00003830 3C22                    	cmp	al,'"' 	; 22h		; a quote ?
 39638 00003832 743A                    	je	short at_quote
 39639 00003834 3C20                    	cmp	al,' '  ; 20h
 39640 00003836 77EF                    	ja	short org5
 39641                                  	
 39642                                  	; 09/09/2023
 39643                                  	; (Note: PCDOS 7.1 IBMBIO.COM does not contain M051 modification)
 39644                                  
 39645                                  					; M051 - Start
 39646                                  	; 03/01/2023
 39647                                  	; ds = cs
 39648 00003838 803E[5403]55                    cmp	byte [cmd_indicator],CONFIG_DEVICEHIGH
 39649                                  	;cmp	byte [cs:cmd_indicator],CONFIG_DEVICEHIGH ; Q: is this devicehigh
 39650 0000383D 7514                    	jne	short not_dh		; N: 
 39651 0000383F 3C0A                    	cmp	al,lf			; Q: is this line feed
 39652 00003841 7416                    	je	short org_dhlf		; Y: stuff a blank before the lf
 39653 00003843 3C0D                    	cmp	al,cr			; Q: is this a cr
 39654 00003845 75E0                    	jne	short org5		; N: 
 39655 00003847 26C645FF20              	mov	byte [es:di-1],' '	; overwrite cr with blank
 39656 0000384C AA                      	stosb				; put cr after blank
 39657 0000384D FE06[CF34]              	inc	byte [insert_blank]
 39658                                  	;inc	byte [cs:insert_blank]	; indicate that blank has been 
 39659                                  					; inserted
 39660 00003851 EBD4                    	jmp	short org5
 39661                                  not_dh:					; M051 - End
 39662                                  
 39663 00003853 3C0A                    	cmp	al,lf			; line feed?
 39664 00003855 740F                    	je	short org1_brdg		; handles the next command line.
 39665 00003857 EBCE                    	jmp	short org5		; handles next char in this line.
 39666                                  
 39667                                  org_dhlf:				; M051 - Start
 39668                                  	; 03/01/2023
 39669                                  	; ds = cs
 39670 00003859 803E[CF34]01            	cmp	byte [insert_blank],1
 39671                                  	;cmp	byte [cs:insert_blank],1 ; Q:has a blank already been inserted
 39672 0000385E 7406                    	je	short org1_brdg		; Y:
 39673 00003860 26C645FF20              	mov	byte [es:di-1],' '	; overwrite lf with blank
 39674 00003865 AA                      	stosb				; put lf after blank
 39675                                  					; M051 - End
 39676                                  org1_brdg:
 39677 00003866 C606[CF34]00            	mov	byte [insert_blank],0 
 39678                                  	;mov	byte [cs:insert_blank],0 ; M051: clear blank indicator for 
 39679                                  					; M051: devicehigh
 39680 0000386B E93CFE                  	jmp	org1
 39681                                  
 39682                                  at_quote:
 39683 0000386E 803E[5003]00            	cmp	byte [com_level],0
 39684                                  	;cmp	byte [cs:com_level],0
 39685 00003873 7407                    	je	short up_level
 39686                                  	;mov	byte [cs:com_level],0	; reset it.
 39687 00003875 C606[5003]00            	mov	byte [com_level],0
 39688 0000387A EBAB                    	jmp	short org5
 39689                                  
 39690                                  up_level:
 39691                                  	;inc	byte [cs:com_level]	; set it.
 39692 0000387C FE06[5003]              	inc	byte [com_level]
 39693 00003880 EBA5                    	jmp	short org5
 39694                                  
 39695                                  ;----------------------------------------------------------------------------
 39696                                  ;
 39697                                  ; procedure : get2
 39698                                  ;
 39699                                  ;----------------------------------------------------------------------------
 39700                                  
 39701                                  	; 02/11/2022 - Retrodos v4.0 (Modified MSDOS 5.0 IO.SYS)
 39702                                  	; (SYSINIT:33FAh)
 39703                                  
 39704                                  	; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 39705                                  	; (SYSINIT:4270h)
 39706                                  get2:
 39707 00003882 E304                    	jcxz	noget
 39708                                  	;
 39709                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39710                                  	;;lods	byte ptr es:[si]
 39711                                  	; 12/12/2022
 39712 00003884 26                      	es	
 39713 00003885 AC                      	lodsb
 39714                                  	;mov	al, [es:si]
 39715                                  	;inc	si
 39716                                  	;
 39717 00003886 49                      	dec	cx
 39718 00003887 C3                      	retn
 39719                                  noget:
 39720 00003888 59                      	pop	cx
 39721                                  	; 03/01/2023
 39722                                  	; ds = cs
 39723                                  	;mov	[cs:count],di ; 13/05/2019
 39724                                  	;mov	[cs:org_count],di
 39725 00003889 893E[5603]              	mov	[count],di
 39726 0000388D 893E[5803]              	mov	[org_count],di
 39727 00003891 31F6                    	xor	si,si
 39728                                  	;mov	[cs:chrptr],si
 39729 00003893 8936[5A03]              	mov	[chrptr],si
 39730                                  
 39731                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39732                                  
 39733                                  ; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 39734                                  
 39735                                  ;ifndef MULTI_CONFIG
 39736                                  ;	retn
 39737                                  ;else
 39738                                  
 39739                                  ;   This was the rather kludgy way out of procedure "organize", but instead
 39740                                  ;   of returning to doconf, we now want to check config.sys BEGIN/END blocks
 39741                                  ;   and the new boot menu stuff...
 39742                                  
 39743 00003897 89F9                    	mov     cx,di
 39744 00003899 E9E300                  	jmp     menu_check
 39745                                  
 39746                                  ;endif
 39747                                  	; 02/11/2022
 39748                                  	; 03/01/2023 - Retro DOS v4.2
 39749                                  	;retn
 39750                                  
 39751                                  ;----------------------------------------------------------------------------
 39752                                  ;
 39753                                  ; procedure : skip_comment
 39754                                  ;
 39755                                  ;skip the commented string until lf, if current es:si-> a comment string.
 39756                                  ;in) es:si-> string
 39757                                  ;	 cx -> length.
 39758                                  ;out) zero flag not set if not found a comment string.
 39759                                  ;	  zero flag set if found a comment string and skipped it. al will contain
 39760                                  ;	  the line feed character at this moment when return.
 39761                                  ;	  ax register destroyed.
 39762                                  ;	  if found, si, cx register adjusted accordingly.
 39763                                  ;
 39764                                  ;----------------------------------------------------------------------------
 39765                                  
 39766                                  	; 03/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 39767                                  	; (SYSINIT:428Dh)
 39768                                  
 39769                                  skip_comment:
 39770 0000389C E3EA                    	jcxz	noget		; get out of the organize routine.
 39771                                  
 39772                                  	; 03/01/2023
 39773                                  	; ds = cs	
 39774                                  
 39775 0000389E 803E[5003]00            	cmp	byte [com_level],0
 39776                                  	;cmp	byte [cs:com_level],0 ; only check it if parameter level is 0.
 39777 000038A3 752C                    	jne	short no_commt	 ; (not inside quotations)
 39778                                  
 39779 000038A5 803E[5103]01            	cmp	byte [cmmt],1
 39780                                  	;cmp	byte [cs:cmmt],1
 39781 000038AA 7225                    	jb	short no_commt
 39782                                  
 39783 000038AC 268A04                  	mov	al,[es:si]
 39784                                  	
 39785 000038AF 3806[5203]              	cmp	[cmmt1],al
 39786                                  	;cmp	[cs:cmmt1],al
 39787 000038B3 751C                    	jne	short no_commt
 39788                                  
 39789 000038B5 803E[5103]02            	cmp	byte [cmmt],2
 39790                                  	;cmp	byte [cs:cmmt],2
 39791 000038BA 750A                    	jne	short skip_cmmt
 39792                                  
 39793 000038BC 268A4401                	mov	al,[es:si+1]
 39794                                  	
 39795 000038C0 3806[5303]              	cmp	[cmmt2],al
 39796                                  	;cmp	[cs:cmmt2],al
 39797 000038C4 750B                    	jne	short no_commt
 39798                                  skip_cmmt:
 39799 000038C6 E3C0                    	jcxz	noget		; get out of organize routine.
 39800 000038C8 268A04                  	mov	al,[es:si]
 39801 000038CB 46                      	inc	si
 39802 000038CC 49                      	dec	cx
 39803 000038CD 3C0A                    	cmp	al,lf		; line feed?
 39804 000038CF 75F5                    	jne	short skip_cmmt
 39805                                  no_commt:
 39806 000038D1 C3                      	retn
 39807                                  
 39808                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 39809                                  ; (SYSINIT:42C8h)
 39810                                  
 39811                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 39812                                  ;%if 0
 39813                                  
 39814                                  ;ifdef	MULTI_CONFIG
 39815                                  
 39816                                  ;----------------------------------------------------------------------------
 39817                                  ;
 39818                                  ;   kbd_read: wait for keystroke
 39819                                  ;
 39820                                  ;   INPUT
 39821                                  ;       DS == CS == sysinitseg
 39822                                  ;
 39823                                  ;   OUTPUT
 39824                                  ;       Carry SET to clean boot, CLEAR otherwise
 39825                                  ;
 39826                                  ;   OTHER REGS USED
 39827                                  ;       All
 39828                                  ;
 39829                                  ;   HISTORY
 39830                                  ;       Created 16-Nov-1992 by JeffPar
 39831                                  ;
 39832                                  ;----------------------------------------------------------------------------
 39833                                  
 39834                                  kbd_read:
 39835 000038D2 F606[2E47]02                    test    byte [bDisableUI],2
 39836 000038D7 7520                            jnz     short kbd_nodelay
 39837                                  
 39838 000038D9 1E                              push    ds              ; the bios timer tick count is incremented
 39839 000038DA 29C0                            sub     ax,ax           ; 18.2 times per second;
 39840 000038DC 8ED8                            mov     ds,ax           ; watch the timer tick count for 37 transitions
 39841                                  	;mov	dx,[046Ch]	; get initial value
 39842                                  kbd_loop:
 39843 000038DE B401                            mov     ah,1            ;
 39844 000038E0 CD16                            int     16h             ; peek the keyboard
 39845 000038E2 7514                            jnz	short kbd_loopdone ; something's there, get out
 39846 000038E4 B402                            mov     ah,2            ; peek the shift states
 39847 000038E6 CD16                            int     16h             ;
 39848 000038E8 A803                            test    al,03h          ; either right or left shift key bits set?
 39849 000038EA 750C                            jnz	short kbd_loopdone ; yes
 39850 000038EC A16C04                          mov     ax,[046Ch]	;
 39851                                  	;sub	ax,dx           ; get difference
 39852                                  	; 15/04/2019 - Retro DOS v4.0
 39853 000038EF 2E2B06[8C03]            	sub	ax,[cs:_timer_lw_] ; MSDOS 6.21 IO.SYS - SYSINIT:42E5h        
 39854                                  
 39855 000038F4 3C25                    	cmp     al,37           ; reached limit?  ; (2 seconds)
 39856 000038F6 72E6                            jb	short kbd_loop	; not yet
 39857                                  kbd_loopdone:
 39858 000038F8 1F                              pop     ds              ; delay complete!
 39859                                  kbd_nodelay:
 39860 000038F9 29DB                            sub     bx,bx           ; assume clean boot
 39861 000038FB B402                            mov     ah,2            ; peek the shift states
 39862 000038FD CD16                            int     16h             ;
 39863 000038FF A803                            test    al,03h          ; either right or left shift key bits set?
 39864 00003901 7407                            jz      short kbd_notshift ; no
 39865 00003903 43                              inc     bx              ; yes
 39866 00003904 43                              inc     bx
 39867                                  	; MSDOS 6.21 IO.SYS - SYSINIT:4301h
 39868 00003905 800E[3247]04            	or	byte [bQueryOpt],4
 39869                                  kbd_notshift:                   ;
 39870 0000390A B401                            mov     ah,1            ; peek the keyboard
 39871 0000390C CD16                            int     16h             ;
 39872 0000390E 743E                            jz	short kbd_test	; no key present
 39873 00003910 08C0                            or      al,al           ; is it a function key?
 39874 00003912 753A                            jnz	short kbd_test	; no
 39875                                  
 39876                                  	; MSDOS 6.21 IO.SYS - SYSINIT:430Bh
 39877 00003914 80FC62                          cmp     ah,62h          ; CTRL F5
 39878 00003917 7405                            je	short kbd_cfg_bypass
 39879                                  	
 39880 00003919 80FC3F                          cmp     ah,3Fh          ; F5 function key?
 39881 0000391C 750D                            jne	short kbd_notf5	; no
 39882                                  kbd_cfg_bypass:
 39883 0000391E BA[C24B]                        mov     dx,_$CleanMsg
 39884 00003921 E8DD0B                          call    print
 39885                                  	; MSDOS 6.21 IO.SYS - SYSINIT:431Bh
 39886 00003924 800E[3247]04            	or	byte [bQueryOpt],4 
 39887 00003929 EB16                            jmp     short kbd_eat   ; yes, clean boot selected
 39888                                  kbd_notf5:
 39889                                  	; MSDOS 6.21 IO.SYS - SYSINIT:4322h
 39890 0000392B 80FC65                          cmp     ah,65h          ; CTRL F8
 39891 0000392E 7405                            je	short kbd_cfg_confirm
 39892                                  
 39893 00003930 80FC42                          cmp     ah,42h          ; F8 function key?
 39894 00003933 7523                            jne	short kbd_exit	; no
 39895                                  kbd_cfg_confirm:
 39896 00003935 BA[004C]                        mov     dx,_$InterMsg
 39897 00003938 E8C60B                          call    print           ;
 39898 0000393B B301                            mov     bl,1            ; yes, interactive-boot option enabled
 39899 0000393D 881E[3247]                      mov     [bQueryOpt],bl  ; change default setting
 39900                                  kbd_eat:                        ;
 39901 00003941 B400                            mov     ah,0            ;
 39902 00003943 CD16                            int     16h             ; eat the key we assumed was a signal
 39903 00003945 C606[3847]FF                    mov	byte [secElapsed],-1
 39904 0000394A 09DB                            or      bx,bx           ;
 39905 0000394C 7405                            jz	short kbd_clean	;
 39906                                  kbd_test:                       ;
 39907 0000394E 80FB02                          cmp     bl,2            ;
 39908 00003951 7205                            jb	short kbd_exit	;
 39909                                  kbd_clean:                      ;
 39910 00003953 E86E08                          call    disable_autoexec; yes, tell COMMAND to skip autoexec.bat
 39911 00003956 F9                              stc                     ; set carry to indicate abort
 39912 00003957 C3                              retn			;
 39913                                  kbd_exit:                       ;
 39914 00003958 F8                              clc                     ; clear carry to indicate success
 39915 00003959 C3                              retn			;
 39916                                  
 39917                                  ;----------------------------------------------------------------------------
 39918                                  ;
 39919                                  ;   set_numlock: set numlock LED
 39920                                  ;
 39921                                  ;   INPUT
 39922                                  ;       ES:SI -> numlock setting (ie, "ON" or "OFF")
 39923                                  ;
 39924                                  ;   OUTPUT
 39925                                  ;       None
 39926                                  ;
 39927                                  ;   OTHER REGS USED
 39928                                  ;       None
 39929                                  ;
 39930                                  ;   HISTORY
 39931                                  ;       Created 16-Nov-1992 by JeffPar
 39932                                  ;
 39933                                  ;----------------------------------------------------------------------------
 39934                                  
 39935                                  	; 04/01/2023 - Retro DOS v4.2
 39936                                  
 39937                                  set_numlock:
 39938                                          ; 04/01/2023
 39939                                  	;push	ax
 39940 0000395A 1E                              push    ds
 39941 0000395B 29C0                            sub     ax,ax
 39942 0000395D 8ED8                            mov     ds,ax
 39943 0000395F 268B04                          mov     ax,[es:si]      ; get 1st 2 bytes of value (ON or OF)
 39944 00003962 2E3B06[A04B]                    cmp     ax,[cs:OnOff+2]	; should we turn it off?
 39945 00003967 7507                            jne	short not_off	; no
 39946 00003969 80261704DF                      and     byte [0417h],~20h ; 0DFh
 39947 0000396E EB0D                            jmp     short set_done
 39948                                  not_off:
 39949 00003970 2E3B06[9E4B]                    cmp     ax,[cs:OnOff]	; should we turn it on?
 39950 00003975 F9                              stc
 39951 00003976 7505                            jne	short set_done	; no
 39952 00003978 800E170420                      or      byte [0417h],20h
 39953                                  set_done:
 39954 0000397D 1F                              pop     ds
 39955                                  	; 04/01/2023
 39956                                  	;pop	ax
 39957 0000397E C3                              retn
 39958                                  
 39959                                  ; 16/04/2019 - Retro DOS v4.0
 39960                                  
 39961                                  ;----------------------------------------------------------------------------
 39962                                  ;
 39963                                  ;   menu_check: check for presence of menu (and other) configuration blocks
 39964                                  ;
 39965                                  ;   INPUT
 39966                                  ;       CX == "organized" config.sys memory image length
 39967                                  ;    ES:SI -> "organized" config.sys memory image
 39968                                  ;       DS == CS == sysinitseg
 39969                                  ;
 39970                                  ;   OUTPUT
 39971                                  ;       Same as above; the idea is that menu_check simply transforms
 39972                                  ;       a block-structured config.sys image into a conventional image,
 39973                                  ;       based on the user's block selection and any other boot-time options
 39974                                  ;       the user may have employed...
 39975                                  ;
 39976                                  ;   OTHER REGS USED
 39977                                  ;       All
 39978                                  ;
 39979                                  ;   NOTES
 39980                                  ;       [count] and [org_count] are set to the new config.sys image length
 39981                                  ;
 39982                                  ;   HISTORY
 39983                                  ;       Created 16-Mar-1992 by JeffPar
 39984                                  ;
 39985                                  ;----------------------------------------------------------------------------
 39986                                  
 39987                                  	; 04/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 39988                                  	; (SYSINIT:4378h)
 39989                                  
 39990                                  menu_check:
 39991                                  
 39992                                  ;   Search for SWITCHES, determine if /N or /F are present; if so, then
 39993                                  ;   disable clean/interactive boot options
 39994                                  
 39995 0000397F 51                              push    cx              ;
 39996 00003980 56                              push    si              ;
 39997 00003981 29DB                            sub     bx,bx           ; remains ZERO until first block
 39998                                  swchk_loop:                     ;
 39999 00003983 E83507                          call    get_char        ; get first char of current line
 40000 00003986 724C                            jc	short swchk_end	; hit eof
 40001 00003988 3C5B                            cmp     al,CONFIG_BEGIN ; '['
 40002 0000398A 7503                            jne	short swchk_next1 ;
 40003 0000398C 43                              inc     bx              ; remember that we've seen a block
 40004 0000398D EB40                            jmp     short swchk_nextline
 40005                                  swchk_next1:                    ;
 40006 0000398F 3C4E                            cmp     al,CONFIG_NUMLOCK
 40007 00003991 750E                            jne	short swchk_next2 ;
 40008 00003993 09DB                            or      bx,bx           ; only do NUMLOCK commands that exist
 40009 00003995 7538                            jnz	short swchk_nextline ; before the first block
 40010 00003997 E8C0FF                          call    set_numlock     ; REM it out so we don't act on it later, too
 40011 0000399A 26C644FF30                      mov     byte [es:si-1],CONFIG_REM
 40012 0000399F EB2E                            jmp     short swchk_nextline
 40013                                  swchk_next2:                    ;
 40014 000039A1 3C31                            cmp     al,CONFIG_SWITCHES
 40015 000039A3 752A                            jne	short swchk_nextline ; this line ain't it
 40016                                  swchk_scan:                     ;
 40017 000039A5 E81307                          call    get_char        ; look for /N or /F
 40018                                  swchk_scan1:                    ;
 40019 000039A8 3C0A                            cmp     al,LF           ; end of line?
 40020 000039AA 7423                            je	short swchk_nextline ; yes
 40021 000039AC 3C2F                            cmp     al,'/'          ; switch-char?
 40022 000039AE 75F5                            jne	short swchk_scan ; no
 40023 000039B0 E80807                          call    get_char        ;
 40024 000039B3 24DF                            and     al,~20h ; 0DFh	; convert to upper case
 40025 000039B5 3A06[E91E]                      cmp     al,[swit_n+1]
 40026 000039B9 7507                            jne	short swchk_scan2 ; no
 40027 000039BB 800E[2E47]01                    or      byte [bDisableUI],1
 40028 000039C0 EBE3                            jmp	short swchk_scan ; continue looking for switches of interest
 40029                                  swchk_scan2:                    ;
 40030 000039C2 3A06[F51E]                      cmp     al,[swit_f+1]
 40031 000039C6 75E0                            jne	short swchk_scan1 ; no
 40032 000039C8 800E[2E47]02                    or      byte [bDisableUI],2
 40033 000039CD EBD6                            jmp     short swchk_scan ; continue looking for switches of interest
 40034                                  swchk_nextline:                 ;
 40035 000039CF E8C306                          call    skip_opt_line   ;
 40036 000039D2 EBAF                            jmp     short swchk_loop ;
 40037                                  swchk_end:                      ;
 40038 000039D4 5E                              pop     si              ;
 40039 000039D5 59                              pop     cx              ;
 40040                                  
 40041                                  ;   Do the keyboard tests for clean/interactive boot now, but only if
 40042                                  ;   the DisableUI flag is still clear
 40043                                  
 40044 000039D6 F606[2E47]01                    test    byte [bDisableUI],1
 40045 000039DB 7508                            jnz	short menu_search
 40046                                  ;
 40047                                  ;   Wait for 2 seconds first, UNLESS the /F bit was set in bDisableUI, or
 40048                                  ;   there is anything at all in the keyboard buffer
 40049                                  ;
 40050 000039DD E8F2FE                          call    kbd_read
 40051 000039E0 7303                            jnc	short menu_search
 40052 000039E2 E9EE01                          jmp	menu_abort
 40053                                  
 40054                                  ;   Search for MENU block; it is allowed to be anywhere in config.sys
 40055                                  
 40056                                  menu_search:
 40057 000039E5 29DB                            sub     bx,bx           ; if no MENU, default to zero for no_selection
 40058 000039E7 BF[7347]                        mov     di,szMenu	;
 40059 000039EA E80304                          call    find_block      ; find the MENU block
 40060 000039ED 7337                            jnc	short menu_found ;
 40061 000039EF C606[6B47]00                    mov     byte [szBoot],0
 40062 000039F4 E90C02                          jmp	no_selection ; not found
 40063                                  
 40064                                  ;   Process the requested menu color(s)
 40065                                  
 40066                                  menu_color:
 40067 000039F7 51                      	push	cx              ;
 40068 000039F8 52                      	push	dx              ;
 40069                                  	;;mov	dx,0007h        ; default color setting
 40070                                  	; 10/09/2023
 40071                                  	;mov	dl,7 ; !*!
 40072 000039F9 E89E06                  	call	get_number	; get first number
 40073 000039FC 80E30F                  	and	bl,0Fh  ; !**!	; first # is foreground color (for low nibble)
 40074 000039FF 88DD                    	mov	ch,bl           ; save it in CH
 40075                                  	; 01/08/2023 - Retro DOS v4.2 IO.SYS (optimization) by Erdogan Tan 
 40076                                  	; (high nibble of dl is 0)
 40077                                  	;and	dl,0F0h	; !*!	; (low nibble of dl would be zero)
 40078                                  	;or	dl,bl		; (low nibble of dl is 7) ! 14/08/2023
 40079 00003A01 88DA                    	mov	dl,bl	; 14/08/2023
 40080 00003A03 E83108                  	call	delim           ; did we hit a delimiter
 40081 00003A06 750E                    	jne	short check_color ; no, all done
 40082 00003A08 E88F06                  	call	get_number	; get next number
 40083 00003A0B 80E30F                  	and	bl,0Fh		; second # is background color (for high nibble)
 40084 00003A0E 88DE                    	mov	dh,bl           ; save it in DH
 40085                                  	; 10/09/2023
 40086                                  	;and	dl,0Fh	; !**!	;
 40087 00003A10 B104                    	mov	cl,4            ;
 40088 00003A12 D2E3                    	shl	bl,cl           ;
 40089 00003A14 08DA                    	or	dl,bl           ;
 40090                                  check_color:
 40091 00003A16 38F5                    	cmp	ch,dh           ; are foreground/background the same?
 40092 00003A18 7503                    	jne	short set_color	; no
 40093 00003A1A 80F208                  	xor	dl,08h          ; yes, so modify the fgnd intensity
 40094                                  set_color:
 40095 00003A1D 8816[2947]              	mov	[bMenuColor],dl ;
 40096 00003A21 5A                      	pop	dx              ;
 40097 00003A22 59                      	pop	cx              ;
 40098 00003A23 E9A900                  	jmp	menu_nextitem
 40099                                  
 40100                                  ;   Back to our regularly scheduled program (the COLOR and other goop
 40101                                  ;   above is there simply to alleviate short jump problems)
 40102                                  
 40103                                  menu_found:
 40104 00003A26 C606[3347]01                    mov     byte [bDefBlock],1
 40105                                          ;mov	word [offDefBlock],0
 40106 00003A2B C606[3747]FF                    mov     byte [secTimeOut],-1
 40107 00003A30 8026[3247]FD                    and     byte [bQueryOpt],~2 ; 0FDh
 40108                                  	; 10/09/2023
 40109 00003A35 29D2                    	sub	dx,dx
 40110 00003A37 8916[3547]              	mov	[offDefBlock],dx ; 0
 40111                                  
 40112 00003A3B E85706                          call    skip_opt_line   ; skip to next line
 40113                                  	; 10/09/2023
 40114                                  	;sub	dx,dx		; initialize total block count (0 => none yet)
 40115                                  
 40116                                  ;   Process the menu block now
 40117                                  
 40118                                  menu_process:
 40119 00003A3E E87A06                          call    get_char        ; get first char of current line
 40120 00003A41 722E                            jc	short to_menu_getdefault ; could happen if menu block at end (rare)
 40121 00003A43 247F                            and     al,~CONFIG_OPTION_QUERY ; 7Fh
 40122 00003A45 3C5B                            cmp     al,CONFIG_BEGIN ; BEGIN implies END
 40123 00003A47 7428                            je	short to_menu_getdefault
 40124 00003A49 3C4F                            cmp     al,CONFIG_SUBMENU
 40125 00003A4B 744D                            je	short menu_item	; go process sub-menu
 40126 00003A4D 3C45                            cmp     al,CONFIG_MENUITEM
 40127 00003A4F 7449                            je	short menu_item	; go process menu item
 40128 00003A51 3C41                            cmp     al,CONFIG_MENUDEFAULT
 40129 00003A53 741E                            je	short menu_default ; go process menu default
 40130 00003A55 3C52                            cmp     al,CONFIG_MENUCOLOR
 40131 00003A57 749E                            je	short menu_color ; go process menu color
 40132 00003A59 3C4E                            cmp     al,CONFIG_NUMLOCK
 40133 00003A5B 740F                            je	short menu_numlock ;
 40134 00003A5D 3C30                            cmp     al,CONFIG_REM   ; allow remarks in menu block
 40135 00003A5F 746E                            je	short menu_nextitem ;
 40136 00003A61 E8C307                          call    any_delim       ; allow blank lines and such
 40137 00003A64 7469                            je	short menu_nextitem ;
 40138 00003A66 F9                              stc                     ;
 40139 00003A67 E82607                          call    print_error     ; non-MENU command!
 40140 00003A6A EB63                            jmp     short menu_nextitem
 40141                                  menu_numlock:
 40142 00003A6C E8EBFE                          call    set_numlock
 40143 00003A6F EB5E                            jmp     short menu_nextitem
 40144                                  to_menu_getdefault:
 40145 00003A71 EB62                            jmp     short menu_getdefault
 40146                                  
 40147                                  ;   Save the offset of the default block name, we'll need it later
 40148                                  
 40149                                  menu_default:
 40150 00003A73 8936[3547]                      mov     [offDefBlock],si; save address of default block name
 40151 00003A77 803E[3847]00                    cmp     byte [secElapsed],0
 40152 00003A7C 751A                            jne	short timeout_skip ; secElapsed is only zero for the FIRST menu,
 40153 00003A7E E8EA05                          call    skip_token      ; and for subsequent menus IF nothing was typed;
 40154 00003A81 724C                            jc	short menu_nextitem ; secElapsed becomes -1 forever as soon as
 40155 00003A83 E8FB05                          call    skip_delim      ; something is typed
 40156 00003A86 7247                            jc	short menu_nextitem ;
 40157 00003A88 89DE                            mov     si,bx           ;
 40158 00003A8A E80D06                          call    get_number      ; get number (of seconds for timeout)
 40159 00003A8D 80FB5A                          cmp     bl,90           ; limit it to a reasonable number
 40160                                  	;jb	short timeout_ok ; (besides, 99 is the largest # my simple
 40161 00003A90 7602                            jna	short timeout_ok ; 01/08/2023
 40162 00003A92 B35A                    	mov     bl,90           ;  display function can handle)
 40163                                  timeout_ok:                     ;
 40164 00003A94 881E[3747]                      mov     [secTimeOut],bl ;
 40165                                  timeout_skip:
 40166 00003A98 EB35                            jmp     short menu_nextitem
 40167                                  
 40168                                  ;   Verify that this is a valid menu item by searching for the named block
 40169                                  
 40170                                  menu_item:
 40171                                  	;cmp	dl,9	; 04/01/2023
 40172 00003A9A 80FA09                          cmp     dl,MAX_MULTI_CONFIG ; have we reached the max # of items yet?
 40173 00003A9D 7330                            jae	short menu_nextitem ;
 40174 00003A9F 89F7                            mov     di,si           ; DS:DI -> block name to search for
 40175 00003AA1 E83303                          call    srch_block      ;
 40176 00003AA4 7406                            je	short menu_itemfound ;
 40177 00003AA6 F9                              stc                     ;
 40178 00003AA7 E8E606                          call    print_error     ; print error and pause
 40179 00003AAA EB23                            jmp     short menu_nextitem ; if not found, ignore this menu item
 40180                                  
 40181                                  ;   srch_block, having succeeded, returns DI -> past the token that it
 40182                                  ;   just matched, which in this case should be a descriptive string; ES:SI
 40183                                  ;   and CX are unmodified
 40184                                  
 40185                                  menu_itemfound:
 40186 00003AAC 42                              inc     dx              ; otherwise, increment total block count
 40187 00003AAD 89D3                            mov     bx,dx           ; and use it to index the arrays of offsets
 40188 00003AAF 8887[3947]                      mov	[abBlockType+bx],al
 40189 00003AB3 01DB                            add     bx,bx           ; of recorded block names and descriptions
 40190                                  
 40191                                  ;   There should be a description immediately following the block name on
 40192                                  ;   MENUITEM line; failing that, we'll just use the block name as the
 40193                                  ;   description...
 40194                                  
 40195 00003AB5 89B7[4347]                      mov     [aoffBlockName+bx],si
 40196 00003AB9 89B7[5747]                      mov     [aoffBlockDesc+bx],si
 40197 00003ABD 89DF                            mov     di,bx           ; skip_delim modifies BX, so stash it in DI
 40198 00003ABF E8A905                          call    skip_token      ;
 40199 00003AC2 720B                            jc	short menu_nextitem ; hit eol/eof
 40200 00003AC4 E8BA05                          call    skip_delim      ;
 40201 00003AC7 7206                            jc	short menu_nextitem ; hit eol/eof
 40202 00003AC9 87DF                            xchg    bx,di           ;
 40203 00003ACB 89BF[5747]                      mov     [aoffBlockDesc+bx],di
 40204                                  
 40205                                  menu_nextitem:
 40206 00003ACF E8C305                          call    skip_opt_line   ;
 40207 00003AD2 E969FF                          jmp     menu_process    ; go back for more lines
 40208                                  
 40209                                  ;   Display menu items now, after determining which one is default
 40210                                  
 40211                                  menu_getdefault:
 40212 00003AD5 08D2                            or      dl,dl           ; where there any valid blocks at all?
 40213 00003AD7 7505                            jnz	short menu_valid ; yes
 40214 00003AD9 29DB                            sub     bx,bx           ; no, so force autoselect of 0
 40215 00003ADB E9ED00                          jmp     menu_autoselect ; (meaning: process common blocks only)
 40216                                  menu_valid:
 40217 00003ADE 29DB                            sub     bx,bx           ;
 40218 00003AE0 8816[3447]                      mov     [bMaxBlock],dl  ; first, record how many blocks we found
 40219 00003AE4 8B3E[3547]                      mov     di,[offDefBlock];
 40220 00003AE8 09FF                            or      di,di           ; does a default block exist?
 40221 00003AEA 741C                            jz	short menu_nodefault ; no
 40222 00003AEC 43                              inc     bx              ; yes, walk name table, looking for default
 40223                                  menu_chkdefault:
 40224 00003AED 53                              push    bx              ;
 40225 00003AEE 01DB                            add     bx,bx           ;
 40226 00003AF0 8BB7[4347]                      mov     si,[aoffBlockName+bx]
 40227 00003AF4 B98000                          mov     cx,128          ; arbitrary maximum length of a name
 40228 00003AF7 1E                              push    ds              ;
 40229 00003AF8 06                              push    es              ;
 40230 00003AF9 1F                              pop     ds              ;
 40231 00003AFA E81A03                          call    comp_names      ; is this block the same as the default?
 40232 00003AFD 1F                              pop     ds              ;
 40233 00003AFE 5B                              pop     bx              ;
 40234 00003AFF 7409                            je	short menu_setdefault ; yes
 40235 00003B01 43                              inc     bx              ;
 40236 00003B02 3A1E[3447]                      cmp     bl,[bMaxBlock]  ; all done searching?
 40237 00003B06 76E5                            jbe	short menu_chkdefault ; not yet
 40238                                  menu_nodefault:
 40239 00003B08 B301                            mov     bl,1            ; if no default, force default to #1
 40240                                  menu_setdefault:
 40241 00003B0A 881E[3347]                      mov     [bDefBlock],bl  ; yes, this will be the initial current block
 40242                                  
 40243                                  ;   If the timeout was explicitly set to 0 (or technically, anything that
 40244                                  ;   failed to resolve to a number, like "NONE" or "EAT POTATOES"), then we're
 40245                                  ;   supposed to skip menu display and run with the specified default block;
 40246                                  ;   however, if the user hit Enter prior to boot, thereby requesting fully
 40247                                  ;   INTERACTIVE boot, then we shall display the menu block anyway (though still
 40248                                  ;   with no timeout)
 40249                                  
 40250 00003B0E 803E[3747]00                    cmp     byte [secTimeOut],0 ; is timeout zero? (ie, assume default)
 40251 00003B13 750A                            jne	short menu_display ; no
 40252 00003B15 F606[3247]01                    test    byte [bQueryOpt],1 ; yes, but was INTERACTIVE requested?
 40253 00003B1A 7503                            jnz	short menu_display ; yes, so *don't* assume default after all
 40254 00003B1C E9C700                          jmp     not_topmenu	;
 40255                                  
 40256                                  ;   Reset the mode, so that we know screen is clean and cursor is home
 40257                                  
 40258                                  menu_display:
 40259 00003B1F B40F                            mov     ah,0Fh          ; get current video mode
 40260 00003B21 CD10                            int     10h             ;
 40261 00003B23 B400                            mov     ah,00h          ; just re-select that mode
 40262 00003B25 CD10                            int     10h             ;
 40263 00003B27 06                              push    es              ;
 40264 00003B28 B84000                          mov     ax,40h          ; reach down into the ROM BIOS data area
 40265 00003B2B 8EC0                            mov     es,ax           ; and save the current (default) video page
 40266 00003B2D 26A14E00                        mov     ax,[es:004Eh]   ; start address and page #, in case the
 40267 00003B31 A3[3047]                        mov     [wCRTStart],ax  ; undocumented QUIET option was enabled
 40268 00003B34 26A06200                        mov     al,[es:0062h]   ;
 40269 00003B38 A2[2F47]                        mov     [bCRTPage],al   ;
 40270 00003B3B A1[2A47]                        mov     ax,[bMenuPage]	; select new page for menu
 40271 00003B3E CD10                            int     10h             ;
 40272 00003B40 B80006                          mov     ax,0600h        ; clear entire screen
 40273 00003B43 8A3E[2947]                      mov     bh,[bMenuColor] ; using this color
 40274 00003B47 29C9                            sub     cx,cx           ; upper left row/col
 40275                                          ;mov	dl,[es:CRT_Cols] 
 40276 00003B49 268A164A00                      mov	dl,[es:4Ah]
 40277 00003B4E FECA                    	dec     dl              ;
 40278                                          ;mov	dh,[es:CRT_Rows];
 40279 00003B50 268A368400                      mov	dh,[es:84h]
 40280 00003B55 08F6                    	or      dh,dh           ; # of rows valid?
 40281 00003B57 7504                            jnz	short menu_clear ; hopefully
 40282 00003B59 8A36[2D47]                      mov     dh,[bLastRow]   ; no, use a default
 40283                                  menu_clear:
 40284 00003B5D CD10                            int     10h             ; clear the screen using the req. attribute
 40285 00003B5F 07                              pop     es              ;
 40286 00003B60 8836[2D47]                      mov     [bLastRow],dh   ; save DH
 40287 00003B64 BA[3D4C]                        mov     dx,_$MenuHeader
 40288 00003B67 E89709                          call    print           ; cursor now on row 3 (numbered from 0)
 40289                                  
 40290 00003B6A F606[2E47]01                    test    byte [bDisableUI],1
 40291 00003B6F 751F                            jnz     short menu_nostatus
 40292 00003B71 8A3E[2A47]                      mov     bh,[bMenuPage]  ;
 40293 00003B75 8A36[2D47]                      mov     dh,[bLastRow]   ; restore DH
 40294 00003B79 B200                            mov     dl,0            ; print the status line on row DH, col 0,
 40295 00003B7B B402                            mov     ah,02h          ; now that we can trash the cursor position
 40296 00003B7D CD10                            int     10h             ;
 40297 00003B7F BA[894C]                        mov     dx,_$StatusLine
 40298 00003B82 E87C09                          call    print           ;
 40299 00003B85 B403                            mov     ah,3            ; get cursor position
 40300 00003B87 CD10                            int     10h             ;
 40301 00003B89 80EA02                          sub     dl,2            ;
 40302 00003B8C 8816[2C47]                      mov     [bLastCol],dl   ; save column where status char will go
 40303                                  
 40304                                  menu_nostatus:
 40305 00003B90 BB0100                          mov     bx,1            ; now prepare to display all the menu items
 40306                                  menu_disploop:
 40307 00003B93 E8B002                          call    print_item	; print item #BL
 40308 00003B96 43                              inc     bx              ; why "inc bx"? because it's a 1-byte opcode
 40309 00003B97 3A1E[3447]                      cmp     bl,[bMaxBlock]  ; all done?
 40310 00003B9B 76F6                            jbe	short menu_disploop ; not yet
 40311                                  
 40312                                  ;   Set cursor position to just below the menu items
 40313                                  
 40314 00003B9D B200                            mov     dl,0            ; select column
 40315 00003B9F 88DE                            mov     dh,bl           ;
 40316 00003BA1 80C604                          add     dh,4            ; select row below menu
 40317 00003BA4 8A3E[2A47]                      mov     bh,[bMenuPage]  ;
 40318 00003BA8 B402                            mov     ah,02h          ; set cursor position beneath the block list
 40319 00003BAA CD10                            int     10h             ;
 40320                                  
 40321 00003BAC BA[764C]                        mov     dx,_$MenuPrmpt
 40322 00003BAF E84F09                          call    print           ;
 40323 00003BB2 E82903                          call    select_item     ; make a selection, return # in BX
 40324 00003BB5 BA[4C4A]                        mov     dx,crlfm	
 40325 00003BB8 E84609                          call    print           ;
 40326 00003BBB FF36[2E47]                      push    word [bDisableUI]
 40327 00003BBF 800E[2E47]01                    or      byte [bDisableUI],1
 40328 00003BC4 E86704                          call    show_status     ; clear the status line now
 40329 00003BC7 8F06[2E47]                      pop     word [bDisableUI]
 40330                                  
 40331                                  ;   Now begins the "re-organization" process...
 40332                                  
 40333                                  menu_autoselect:
 40334 00003BCB 83FBFF                          cmp     bx,-1 ; 0FFFFh	; clean boot requested?
 40335 00003BCE 7508                            jne	short normal_boot ; no
 40336 00003BD0 E8F105                          call    disable_autoexec; basically, add a /D to the command.com line
 40337                                  menu_abort:
 40338 00003BD3 29C9                            sub     cx,cx           ; then immediately exit with 0 config.sys image
 40339 00003BD5 E9E400                          jmp	menu_exit	;
 40340                                  
 40341                                  normal_boot:
 40342 00003BD8 83FBFE                          cmp     bx,-2 ; 0FFFEh	; back to top-level menu?
 40343 00003BDB 7509                            jne	short not_topmenu ; no
 40344 00003BDD 8B0E[5603]                      mov     cx,[count]      ; yes, start all over
 40345 00003BE1 29F6                            sub     si,si           ;
 40346 00003BE3 E9FFFD                          jmp     menu_search
 40347                                  
 40348                                  not_topmenu:
 40349 00003BE6 80BF[3947]4F                    cmp     byte [abBlockType+bx],CONFIG_SUBMENU
 40350 00003BEB 7510                            jne	short not_submenu
 40351 00003BED 01DB                            add     bx,bx           ;
 40352 00003BEF 8BBF[4347]                      mov     di,[aoffBlockName+bx]
 40353 00003BF3 E8E101                          call    srch_block      ; THIS CANNOT FAIL!
 40354 00003BF6 89FE                            mov     si,di           ;
 40355 00003BF8 89D9                            mov     cx,bx           ; ES:SI and CX are ready for another round
 40356 00003BFA E929FE                          jmp     menu_found
 40357                                  
 40358                                  not_submenu:
 40359 00003BFD 01DB                            add     bx,bx           ; get BX -> name of selected block
 40360 00003BFF 8B9F[4347]                      mov     bx,[aoffBlockName+bx]
 40361                                  
 40362                                  ;   BX should now either be ZERO (meaning no block has been selected) or
 40363                                  ;   the offset relative to ES of the block name to be processed (along with
 40364                                  ;   all the "common" lines of course)
 40365                                  
 40366                                  no_selection:
 40367 00003C03 891E[3547]                      mov     [offDefBlock],bx; save selection
 40368 00003C07 8B0E[5603]                      mov     cx,[count]      ; reset ES:SI and CX for reprocessing
 40369 00003C0B 29F6                            sub     si,si           ;
 40370 00003C0D 1E                              push    ds              ;
 40371 00003C0E 8E1E[E614]                      mov     ds,[config_wrkseg]; this is where we'll store new config.sys image
 40372 00003C12 29FF                            sub     di,di           ;
 40373                                  
 40374                                  ;   ES:SI-> config.sys, DS:DI -> new config.sys workspace
 40375                                  ;
 40376                                  ;   Work our way through the config.sys image again, this time copying
 40377                                  ;   all lines that are (A) "common" lines outside any block or (B) lines
 40378                                  ;   within the requested block. Lines inside INCLUDEd blocks are transparently
 40379                                  ;   copied by copy_block in a recursive fashion; the amount of recursion is
 40380                                  ;   limited by the fact INCLUDE statements are REMed by copy_block as they are
 40381                                  ;   processed and by the number of unique INCLUDE stmts in config.sys...
 40382                                  ;
 40383                                  ;   BUGBUG 20-Mar-1992 JeffPar: If we can figure out the lower bound of the
 40384                                  ;   stack we're running on, then we should check it inside copy_block
 40385                                  
 40386                                  copyblock_loop:
 40387 00003C14 53                              push    bx              ; save selected block name
 40388 00003C15 E82F01                          call    copy_block      ; process (named or common) block
 40389 00003C18 5B                              pop     bx              ;
 40390 00003C19 7232                            jc	short move_config ; hit eof
 40391                                  
 40392                                  ;   copy_block can only return for two reasons: it hit eof or a new block
 40393                                  
 40394                                  copyblock_begin:
 40395                                  
 40396                                  ; 10/09/2023
 40397                                  %if 0
 40398                                          push    ax              ;
 40399                                          push    cx              ;
 40400                                          push    si              ;
 40401                                          push    di              ; always do "common" blocks
 40402                                          mov     di,szCommon
 40403                                          push    ds              ;
 40404                                          push    cs              ;
 40405                                          pop     ds              ;
 40406                                          call    comp_names      ;
 40407                                          pop     ds              ;
 40408                                          pop     di              ;
 40409                                          pop     si              ;
 40410                                          pop     cx              ;
 40411                                          pop     ax              ;
 40412                                          je	short copyblock_check
 40413                                  %endif
 40414                                  	; 10/09/2023
 40415 00003C1B 57                      	push	di
 40416 00003C1C BF[7847]                	mov	di,szCommon	; always do "common" blocks
 40417 00003C1F E81602                  	call	comp_names_x	; (comp_names_safe)
 40418 00003C22 5F                      	pop	di
 40419 00003C23 740F                    	je	short copyblock_check
 40420                                  
 40421 00003C25 09DB                            or      bx,bx           ; is there a block name to check?
 40422 00003C27 7414                            jz	short copyblock_skip ; no
 40423 00003C29 57                              push    di              ;
 40424 00003C2A 89DF                            mov     di,bx           ; check block against given block name
 40425 00003C2C 1E                              push    ds              ;
 40426 00003C2D 06                              push    es              ;
 40427 00003C2E 1F                              pop     ds              ;
 40428 00003C2F E8E501                          call    comp_names      ; is this the block we really want to do?
 40429 00003C32 1F                              pop     ds              ;
 40430 00003C33 5F                              pop     di              ;
 40431                                  copyblock_check:
 40432 00003C34 7217                            jc	short move_config ; hit eof
 40433 00003C36 7505                            jne	short copyblock_skip ;
 40434 00003C38 E85A04                          call    skip_opt_line   ;
 40435 00003C3B EBD7                            jmp	short copyblock_loop
 40436                                  
 40437                                  copyblock_skip:                 ;
 40438 00003C3D E85504                          call    skip_opt_line   ; this ain't the block we wanted, so skip it
 40439 00003C40 E87804                          call    get_char        ;
 40440 00003C43 7208                            jc	short move_config ; hit eof
 40441 00003C45 247F                            and     al,~CONFIG_OPTION_QUERY ; 7Fh
 40442 00003C47 3C5B                            cmp     al,CONFIG_BEGIN ;
 40443 00003C49 74D0                            je	short copyblock_begin
 40444 00003C4B EBF0                            jmp     short copyblock_skip ; anything else is just skipped
 40445                                  ;
 40446                                  ;   To create as little risk to the rest of SysInit as little as possible,
 40447                                  ;   and to free the workspace at "config_wrkseg" for creating an environment,
 40448                                  ;   copy the new config.sys image to "confbot"
 40449                                  ;
 40450                                  move_config:
 40451 00003C4D 89F9                            mov     cx,di           ; now copy workspace at DS:DI to "confbot"
 40452 00003C4F 51                              push    cx              ;
 40453                                  ;
 40454                                  ;   But first, copy the CONFIG=<configuration><0> string to the workspace,
 40455                                  ;   since the configuration name only currently exists in the "confbot" area
 40456                                  ;
 40457                                   	;mov	cx,7
 40458 00003C50 B90700                  	mov     cx,szMenu-szBoot-1
 40459 00003C53 BE[6B47]                        mov     si,szBoot	; first copy the CONFIG= part
 40460 00003C56 47                              inc     di              ; skip a byte, in case absolutely nothing
 40461                                                                  ; was copied to the workspace, because we always
 40462                                                                  ; zero the first byte of the workspace (below)
 40463                                  copy_boot: 
 40464                                  	;lods    byte ptr cs:[si];
 40465 00003C57 2E                              cs
 40466 00003C58 AC                      	lodsb
 40467 00003C59 8805                    	mov     [di],al         ;
 40468 00003C5B 47                              inc     di              ;
 40469 00003C5C E2F9                            loop    copy_boot       ;
 40470                                  
 40471 00003C5E 06                              push    es              ; then copy the configuration name
 40472                                          ;mov	cx,128-7	; put an upper limit on the name, to be safe
 40473                                  	; 04/01/2023
 40474 00003C5F B179                    	mov	cl,128-7
 40475 00003C61 2E8B36[3547]            	mov     si,[cs:offDefBlock]; ES:SI -> default block name
 40476 00003C66 09F6                            or      si,si           ; valid?
 40477 00003C68 7505                            jnz	short l1	; yes
 40478 00003C6A 0E                              push    cs              ;
 40479 00003C6B 07                              pop     es              ;
 40480 00003C6C BE[7847]                        mov     si,szCommon
 40481 00003C6F 268A04                  l1:     mov     al,[es:si]      ;
 40482 00003C72 E8B205                          call    any_delim       ;
 40483 00003C75 7406                            je	short l2	;
 40484 00003C77 8805                            mov     [di],al         ;
 40485 00003C79 46                              inc     si              ;
 40486 00003C7A 47                              inc     di              ;
 40487 00003C7B E2F2                            loop    l1              ;
 40488 00003C7D C6050A                  l2:     mov     byte [di],lf	; terminate the configuration string
 40489 00003C80 07                              pop     es              ;
 40490                                  
 40491                                  ;   Now we can copy "config_wrkseg" (DS) to "confbot" (ES)
 40492                                  
 40493 00003C81 29FF                            sub     di,di           ;
 40494 00003C83 2E893E[E414]                    mov     [cs:config_envlen],di
 40495 00003C88 29F6                            sub     si,si           ;
 40496 00003C8A 59                              pop     cx              ; recover the size of "config_wrkseg"
 40497                                  
 40498 00003C8B 51                              push    cx              ;
 40499 00003C8C F3A4                            rep     movsb           ; moved!
 40500 00003C8E 59                              pop     cx              ;
 40501 00003C8F 8CD8                            mov     ax,ds           ;
 40502 00003C91 1F                              pop     ds              ;
 40503                                  
 40504                                  ;   Now that the config_wrkseg is available once again, we shall
 40505                                  ;   use it to create an environment. The first thing to go in will be
 40506                                  ;   the "CONFIG=configuration" thing. It is also important to zero
 40507                                  ;   the first byte of the workspace, so that copy_envvar knows the buffer
 40508                                  ;   is empty.
 40509                                  
 40510 00003C92 06                              push    es              ;
 40511 00003C93 8EC0                            mov     es,ax           ;
 40512 00003C95 46                              inc     si              ; ES:SI -> "CONFIG=configuration"
 40513 00003C96 26C606000000                    mov     byte [es:0],0	; empty the environment block
 40514 00003C9C E82600                          call    copy_envvar     ; copy envvar at ES:SI to "config_wrkseg"
 40515 00003C9F 07                              pop     es
 40516                                  
 40517                                  ;   Before returning, restore the default video page setting but do NOT
 40518                                  ;   do it using INT 10h's Set Active Page function, because if the menu was
 40519                                  ;   displayed on a different page, then it's because we don't want to see
 40520                                  ;   all the device driver/TSR goop (which goes to the default page)
 40521                                  
 40522                                  menu_done:
 40523 00003CA0 803E[2A47]00                    cmp     byte [bMenuPage],0
 40524 00003CA5 7415                            je	short menu_exit	;
 40525 00003CA7 06                              push    es              ;
 40526 00003CA8 B84000                          mov     ax,40h          ;
 40527 00003CAB 8EC0                            mov     es,ax           ;
 40528 00003CAD A1[3047]                        mov     ax,[wCRTStart]  ;
 40529 00003CB0 26A34E00                        mov     [es:004Eh],ax   ;
 40530 00003CB4 A0[2F47]                        mov     al,[bCRTPage]   ;
 40531 00003CB7 26A26200                        mov     [es:0062h],al   ;
 40532 00003CBB 07                              pop     es              ;
 40533                                  menu_exit:
 40534 00003CBC 890E[5603]                      mov     [count],cx      ; set new counts
 40535 00003CC0 890E[5803]                      mov     [org_count],cx  ;
 40536                                          ; 10/09/2023 (*)
 40537                                  	; MSDOS 6.21 IO.SYS - SYSINIT:46D3h
 40538                                  	; PCDOS 7.1 IBMBIO.COM - SYSINIT:491Ah
 40539                                  	;sub	si,si           ; always return ES:SI pointing to config.sys
 40540 00003CC4 C3                      	retn
 40541                                  
 40542                                  ; (*) NOTE: MSDOS 6.0 source code (SYSINIT2.ASM) contains 'sub si,si' at this
 40543                                  ;	position (then 'retn' just after it)
 40544                                  ;	but MSDOS 6.21 and PCDOS 7.1 SYSINITs contain only 'retn' here.
 40545                                  
 40546                                  ;----------------------------------------------------------------------------
 40547                                  ;
 40548                                  ;   copy_envvar: copy the envvar at ES:SI to "config_wrkseg"
 40549                                  ;
 40550                                  ;   INPUT
 40551                                  ;    ES:SI -> environment variable (in the form "var=string<cr/lf>")
 40552                                  ;
 40553                                  ;   OUTPUT
 40554                                  ;       config_envlen (ie, where to put next envvar) updated appropriately
 40555                                  ;       carry set if error (eg, missing =); clear otherwise
 40556                                  ;
 40557                                  ;   OTHER REGS USED
 40558                                  ;       None
 40559                                  ;
 40560                                  ;   NOTES
 40561                                  ;       None
 40562                                  ;
 40563                                  ;   HISTORY
 40564                                  ;       Created 29-Mar-1992 by JeffPar
 40565                                  ;
 40566                                  ;----------------------------------------------------------------------------
 40567                                  
 40568                                  	; 04/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 40569                                  	; (SYSINIT:46D4h)
 40570                                  
 40571                                  copy_envvar:
 40572 00003CC5 51                              push    cx              ;
 40573 00003CC6 56                              push    si              ;
 40574 00003CC7 1E                              push    ds              ;
 40575 00003CC8 06                              push    es              ;
 40576 00003CC9 06                              push    es              ;
 40577 00003CCA 8E06[E614]                      mov     es,[config_wrkseg] ; ES:DI to point to next available byte
 40578 00003CCE 1F                              pop     ds                 ; DS:SI to point to envvar
 40579                                  
 40580                                  ;   Have to calculate the length of the variable name (and if we hit
 40581                                  ;   the end of the line before we hit '=', then it's curtains for this
 40582                                  ;   config.sys line)
 40583                                  ;
 40584                                  ;   The check for NULL is important because copy_envvar is also used to copy
 40585                                  ;   the initial CONFIG= setting, which will have been zapped by a NULL if no
 40586                                  ;   menu block existed (in order to prevent the creation of an environment)
 40587                                  
 40588 00003CCF 29C9                            sub     cx,cx           ;
 40589                                  copy_varlen:                    ;
 40590 00003CD1 AC                              lodsb                   ;
 40591 00003CD2 08C0                            or      al,al           ; NULL?
 40592                                          ;stc	; 10/09/2023 (x)
 40593 00003CD4 746B                            jz	short copy_envexit ; yes, abort
 40594 00003CD6 3C0D                            cmp     al,cr           ;
 40595                                          ;stc	; 10/09/2023 (x)
 40596 00003CD8 7467                            je	short copy_envexit
 40597 00003CDA 3C0A                            cmp     al,lf           ;
 40598                                          ;stc	; 10/09/2023 (x)
 40599 00003CDC 7463                            je	short copy_envexit
 40600 00003CDE 41                              inc     cx              ;
 40601 00003CDF 3C3D                            cmp     al,'='          ;
 40602 00003CE1 75EE                            jne	short copy_varlen
 40603 00003CE3 B000                            mov     al,0            ;
 40604 00003CE5 8A24                            mov     ah,[si]         ; save char after '='
 40605 00003CE7 29CE                            sub     si,cx           ; back up to given varname
 40606 00003CE9 49                              dec     cx              ; CX == # of bytes in varname
 40607 00003CEA 29FF                            sub     di,di           ; start looking for DS:SI at ES:0
 40608                                  copy_varsrch:
 40609 00003CEC 263805                          cmp     byte [es:di],al
 40610 00003CEF 7425                            je	short copy_envprep ; search failed, just copy var
 40611 00003CF1 89FB                            mov     bx,di           ; ES:BX -> start of this varname
 40612 00003CF3 51                              push    cx              ;
 40613 00003CF4 56                              push    si              ;
 40614 00003CF5 F3A6                            repe    cmpsb           ;
 40615 00003CF7 5E                              pop     si              ;
 40616 00003CF8 59                              pop     cx              ;
 40617 00003CF9 7531                            jne	short copy_varnext ; no match, skip to next varname
 40618 00003CFB 26803D3D                        cmp     byte [es:di],'='
 40619 00003CFF 752B                            jne     short copy_varnext ; no match, there's more characters
 40620                                  
 40621                                  ;   Previous occurrence of variable has been found; determine the
 40622                                  ;   entire length and then destroy it
 40623                                  
 40624 00003D01 B9FFFF                          mov     cx,-1           ;
 40625 00003D04 F2AE                            repne   scasb           ; guaranteed to get null (since we put it there)
 40626 00003D06 56                              push    si              ;
 40627 00003D07 89FE                            mov     si,di           ;
 40628 00003D09 89DF                            mov     di,bx           ;
 40629 00003D0B 2E8B0E[E414]                    mov     cx,[cs:config_envlen]
 40630 00003D10 29F1                            sub     cx,si           ; destroy variable now
 40631                                  	;rep movs byte ptr es:[di],byte ptr es:[si]
 40632                                  	;;db 0F3h,26h,0A4h ; MSDOS 6.21 IO.SYS - SYSINIT:4724h
 40633                                  
 40634 00003D12 F3                      	rep	; 0F3h
 40635 00003D13 26                      	es	; 26h
 40636 00003D14 A4                      	movsb	; 0A4h
 40637                                  
 40638 00003D15 5E                      	pop     si
 40639                                  copy_envprep:
 40640 00003D16 80FC0D                          cmp     ah,cr          ; if there is nothing after the '='
 40641 00003D19 741D                            je	short copy_envdel ; then just exit with variable deleted
 40642 00003D1B 80FC0A                          cmp     ah,lf           ;
 40643 00003D1E 7418                            je	short copy_envdel
 40644                                          ;jmp	short copy_envloop
 40645                                  	; 04/01/2023
 40646                                  copy_envloop:                  ;
 40647 00003D20 AC                      	lodsb                   ;
 40648 00003D21 3C0D                    	cmp	al,cr           ;
 40649 00003D23 7410                    	je	short copy_envdone
 40650 00003D25 3C0A                    	cmp	al,lf           ;
 40651 00003D27 740C                    	je	short copy_envdone
 40652 00003D29 AA                      	stosb                   ;
 40653 00003D2A EBF4                    	jmp	short copy_envloop
 40654                                  
 40655                                  copy_varnext:                   ;
 40656 00003D2C 51                              push    cx              ;
 40657 00003D2D B9FFFF                          mov     cx,-1           ;
 40658 00003D30 F2AE                            repne   scasb           ;
 40659 00003D32 59                              pop     cx              ;
 40660 00003D33 EBB7                            jmp	short copy_varsrch
 40661                                  
 40662                                  	; 04/01/2023
 40663                                  ;copy_envloop:                  ;
 40664                                  ;	lodsb                   ;
 40665                                  ;	cmp	al,cr           ;
 40666                                  ;	je	short copy_envdone
 40667                                  ;	cmp	al,lf           ;
 40668                                  ;	je	short copy_envdone
 40669                                  ;	stosb                   ;
 40670                                  ;	jmp	short copy_envloop
 40671                                  
 40672                                  copy_envdone:                   ;
 40673 00003D35 28C0                            sub     al,al           ; do SUB to clear carry as well
 40674 00003D37 AA                              stosb                   ; always null-terminate these puppies
 40675                                  copy_envdel:                    ;
 40676 00003D38 268805                          mov     [es:di],al      ; and stick another null to terminate the env.
 40677 00003D3B 2E893E[E414]                    mov     [cs:config_envlen],di
 40678                                  	; 10/09/2023 (x) - Erdogan Tan
 40679 00003D40 F9                      	stc ; in order to clear carry flag via cmc (compact code trick!)
 40680                                  copy_envexit:                   ;
 40681 00003D41 F5                      	cmc ; (x) ; reverse carry flag status (je -> cf=1)
 40682 00003D42 07                              pop     es              ;
 40683 00003D43 1F                              pop     ds              ;
 40684 00003D44 5E                              pop     si              ;
 40685 00003D45 59                              pop     cx              ;
 40686                                  
 40687                                  copy_done:	; 18/12/2022
 40688 00003D46 C3                              retn
 40689                                  
 40690                                  ;----------------------------------------------------------------------------
 40691                                  ;
 40692                                  ;   copy_block: copy the current block to the new config.sys workspace
 40693                                  ;
 40694                                  ;   INPUT
 40695                                  ;       CX == remaining bytes in "organized" config.sys memory image
 40696                                  ;    ES:SI -> remaining bytes in "organized" config.sys memory image
 40697                                  ;    DS:DI -> new config.sys workspace (equal in size to the original
 40698                                  ;             config.sys image) where the current block is to be copied
 40699                                  ;
 40700                                  ;   OUTPUT
 40701                                  ;       Same as above
 40702                                  ;       AL also equals the last character read from the organized image
 40703                                  ;
 40704                                  ;   OTHER REGS USED
 40705                                  ;       All
 40706                                  ;
 40707                                  ;   NOTES
 40708                                  ;       None
 40709                                  ;
 40710                                  ;   HISTORY
 40711                                  ;       Created 16-Mar-1992 by JeffPar
 40712                                  ;
 40713                                  ;----------------------------------------------------------------------------
 40714                                  
 40715                                  	; 04/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 40716                                  	; (SYSINIT:4759h)
 40717                                  
 40718                                  copy_block:
 40719 00003D47 E87103                          call    get_char        ; check for include
 40720 00003D4A 72FA                            jc	short copy_done	;
 40721 00003D4C 247F                    	and     al,~CONFIG_OPTION_QUERY ; 7Fh
 40722 00003D4E 3C5B                    	cmp     al,CONFIG_BEGIN ; another BEGIN implies END as well
 40723 00003D50 74F4                            je	short copy_done ;
 40724                                  
 40725 00003D52 3C4A                            cmp     al,CONFIG_INCLUDE ; 'J'
 40726 00003D54 88E0                            mov     al,ah           ; AL == the original line code
 40727 00003D56 753A                            jne	short copy_line	; not an "include" line
 40728                                  
 40729                                  ;   We have hit an "INCLUDE" line; first, REM out the line so that we
 40730                                  ;   never try to include the block again (no infinite include loops please),
 40731                                  ;   then search for the named block and call copy_block again.
 40732                                  
 40733 00003D58 26C644FF30                      mov     byte [es:si-1],CONFIG_REM ; '0'
 40734 00003D5D 57                              push    di              ;
 40735                                  
 40736 00003D5E BF[7347]                        mov     di,szMenu
 40737 00003D61 E8D400                          call    comp_names_safe ; don't allow INCLUDE MENU
 40738 00003D64 7426                            je	short copy_skip	;
 40739                                  
 40740 00003D66 BF[7847]                        mov     di,szCommon
 40741 00003D69 E8CC00                          call    comp_names_safe ; don't allow INCLUDE COMMON
 40742 00003D6C 741E                            je	short copy_skip	;
 40743                                  
 40744 00003D6E 89F7                            mov     di,si           ; try to find the block
 40745 00003D70 E86400                          call    srch_block      ;
 40746 00003D73 89FA                            mov     dx,di           ;
 40747                                  	; 10/09/2023
 40748                                  	;pop    di              ;
 40749 00003D75 7514                            jne	short copy_error ; no such block
 40750 00003D77 5F                      	pop	di  ; 10/09/2023
 40751 00003D78 51                              push    cx              ;
 40752 00003D79 89D9                            mov     cx,bx           ;
 40753 00003D7B 56                              push    si              ;
 40754 00003D7C 4A                              dec     dx              ;
 40755 00003D7D 89D6                            mov     si,dx           ;
 40756 00003D7F E80E03                          call    skip_line       ; skip the rest of the "block name" line
 40757 00003D82 E8C2FF                          call    copy_block      ; and copy in the rest of that block
 40758 00003D85 5E                              pop     si              ;
 40759 00003D86 59                              pop     cx              ;
 40760 00003D87 28C0                            sub     al,al           ; force skip_opt_line to skip...
 40761 00003D89 EB2B                            jmp     short copy_nextline
 40762                                  
 40763                                  copy_error:
 40764                                  	; 10/09/2023
 40765 00003D8B F8                      	clc
 40766                                  copy_skip:
 40767 00003D8C 5F                              pop     di
 40768                                  ;copy_error:
 40769                                  	; 10/09/2023 (cf=0)
 40770                                  	;clc                    ;
 40771 00003D8D E80004                          call    print_error     ; note that carry is clear, no pause
 40772 00003D90 EB24                            jmp     short copy_nextline
 40773                                  
 40774                                  ;   Copy the line at ES:SI to the current location at DS:DI
 40775                                  
 40776                                  copy_line:
 40777 00003D92 8805                            mov     [di],al         ;
 40778 00003D94 47                              inc     di              ;
 40779 00003D95 3C20                            cmp     al,' '          ; is this is a "real" line with a "real" code?
 40780 00003D97 721D                            jb	short copy_nextline ; no
 40781 00003D99 2E803E[E914]00                  cmp     byte [cs:config_multi],0
 40782 00003D9F 7409                            je	short copy_loop	; not a multi-config config.sys, don't embed #s
 40783 00003DA1 E81700                          call    get_linenum	; BX == line # of line @ES:SI
 40784 00003DA4 891D                            mov     [di],bx         ; stash it immediately following the line code
 40785 00003DA6 47                              inc     di              ;
 40786 00003DA7 47                              inc     di              ;
 40787 00003DA8 EB08                            jmp     short copy_next ;
 40788                                  copy_loop:                      ;
 40789 00003DAA E80E03                          call    get_char        ;
 40790 00003DAD 7297                            jc	short copy_done ; end of file
 40791 00003DAF 8805                            mov     [di],al         ;
 40792 00003DB1 47                              inc     di              ;
 40793                                  copy_next:
 40794 00003DB2 3C0A                            cmp     al,lf ; 0Ah	; done with line?
 40795 00003DB4 75F4                            jne	short copy_loop	; nope
 40796                                  
 40797                                  copy_nextline:
 40798 00003DB6 E8DC02                          call    skip_opt_line   ;
 40799 00003DB9 EB8C                            jmp     short copy_block
 40800                                  
 40801                                  	; 18/12/2022
 40802                                  ;copy_done:
 40803                                          ;retn
 40804                                  
 40805                                  ;----------------------------------------------------------------------------
 40806                                  ;
 40807                                  ;   get_linenum: return line # (in BX) of current line (@ES:SI)
 40808                                  ;
 40809                                  ;   INPUT
 40810                                  ;    ES:SI -> some line in the config.sys memory image
 40811                                  ;
 40812                                  ;   OUTPUT
 40813                                  ;       BX == line # (relative to 1)
 40814                                  ;
 40815                                  ;   OTHER REGS USED
 40816                                  ;       DX
 40817                                  ;
 40818                                  ;   NOTES
 40819                                  ;       None
 40820                                  ;
 40821                                  ;   HISTORY
 40822                                  ;       Created 16-Mar-1992 by JeffPar
 40823                                  ;
 40824                                  ;----------------------------------------------------------------------------
 40825                                  
 40826                                  get_linenum:
 40827 00003DBB 50                              push    ax              ;
 40828 00003DBC 29DB                            sub     bx,bx           ; BX == line # (to be returned)
 40829 00003DBE 51                              push    cx              ;
 40830 00003DBF 89F2                            mov     dx,si           ; DX == the offset we're looking for
 40831 00003DC1 56                              push    si              ;
 40832 00003DC2 2E8B0E[5603]                    mov     cx,[cs:count]   ;
 40833 00003DC7 29F6                            sub     si,si           ; prepare to scan entire file
 40834                                  get_linenum_loop:               ;
 40835 00003DC9 E8C402                          call    skip_line       ;
 40836 00003DCC 7205                            jc	short get_linenum_done
 40837 00003DCE 43                              inc     bx              ;
 40838 00003DCF 39D6                            cmp     si,dx           ; have we exceeded the desired offset yet?
 40839 00003DD1 72F6                            jb	short get_linenum_loop ; no
 40840                                  get_linenum_done:               ;
 40841 00003DD3 5E                              pop     si              ;
 40842 00003DD4 59                              pop     cx              ;
 40843 00003DD5 58                              pop     ax              ;
 40844 00003DD6 C3                              retn
 40845                                  
 40846                                  ;----------------------------------------------------------------------------
 40847                                  ;
 40848                                  ;   srch_block: searches entire config.sys for block name @ES:DI
 40849                                  ;
 40850                                  ;   INPUT
 40851                                  ;       ES -> config.sys image
 40852                                  ;    ES:DI -> block name to find
 40853                                  ;
 40854                                  ;   OUTPUT
 40855                                  ;       ZF flag set, if found
 40856                                  ;    ES:DI -> just past the name in the block heading, if found
 40857                                  ;       BX == # bytes remaining from that point, if found
 40858                                  ;
 40859                                  ;   OTHER REGS USED
 40860                                  ;       None
 40861                                  ;
 40862                                  ;   NOTES
 40863                                  ;       This differs from "find_block" in that it searches the ENTIRE
 40864                                  ;       config.sys image, not merely the remaining portion, and that it
 40865                                  ;       takes a pointer to block name that is *elsewhere* in the image
 40866                                  ;       (ie, ES) as opposed to some string constant in our own segment (DS).
 40867                                  ;
 40868                                  ;   HISTORY
 40869                                  ;       Created 16-Mar-1992 by JeffPar
 40870                                  ;
 40871                                  ;----------------------------------------------------------------------------
 40872                                  
 40873                                  srch_block:	          ; returns BX -> named block in CONFIG.SYS
 40874 00003DD7 50                              push    ax              ;
 40875 00003DD8 51                              push    cx              ;
 40876 00003DD9 2E8B0E[5603]                    mov     cx,[cs:count]   ;
 40877 00003DDE 56                              push    si              ;
 40878 00003DDF 29F6                            sub     si,si           ;
 40879 00003DE1 1E                              push    ds              ;
 40880 00003DE2 06                              push    es              ;
 40881 00003DE3 1F                              pop     ds              ;
 40882 00003DE4 E80900                          call    find_block      ;
 40883 00003DE7 89F7                            mov     di,si           ;
 40884 00003DE9 89CB                            mov     bx,cx           ;
 40885 00003DEB 1F                              pop     ds              ;
 40886 00003DEC 5E                              pop     si              ;
 40887 00003DED 59                              pop     cx              ;
 40888 00003DEE 58                              pop     ax              ;
 40889                                  find_exit: ; 16/04/2019
 40890 00003DEF C3                              retn			;
 40891                                  
 40892                                  ;----------------------------------------------------------------------------
 40893                                  ;
 40894                                  ;   find_block: searches rest of config.sys for block name @DS:DI
 40895                                  ;
 40896                                  ;   INPUT
 40897                                  ;    DS:DI -> block name to find
 40898                                  ;    ES:SI -> remainder of config.sys image
 40899                                  ;       CX == remaining size of config.sys image
 40900                                  ;
 40901                                  ;   OUTPUT
 40902                                  ;       ZF flag set, if found (also, CF set if EOF)
 40903                                  ;    ES:SI -> where the search stopped (at end of block name or EOF)
 40904                                  ;       CX == # bytes remaining from that point
 40905                                  ;
 40906                                  ;   OTHER REGS USED
 40907                                  ;       AX
 40908                                  ;
 40909                                  ;   NOTES
 40910                                  ;       This differs from "srch_block" in that it searches only the
 40911                                  ;       remaining portion of the config.sys image and leaves SI and CX
 40912                                  ;       pointing to where the search left off, and that it takes a pointer
 40913                                  ;       to search string in our own segment (DS:DI instead of ES:DI).
 40914                                  ;
 40915                                  ;   HISTORY
 40916                                  ;       Created 16-Mar-1992 by JeffPar
 40917                                  ;
 40918                                  ;----------------------------------------------------------------------------
 40919                                  
 40920                                  find_block:
 40921 00003DF0 E8C802                          call    get_char        ; get line code
 40922 00003DF3 72FA                            jc	short find_exit	; end of file
 40923 00003DF5 247F                            and     al,~CONFIG_OPTION_QUERY
 40924 00003DF7 3C5B                            cmp     al,CONFIG_BEGIN ; beginning of a block?
 40925 00003DF9 740C                            je	short check_line ; no
 40926 00003DFB 3C4A                            cmp     al,CONFIG_INCLUDE
 40927 00003DFD 7513                            jne	short next_line	;
 40928 00003DFF 2E800E[E914]01                  or	byte [cs:config_multi],1
 40929 00003E05 EB0B                            jmp     short next_line ;
 40930                                  check_line:
 40931 00003E07 2E800E[E914]01                  or      byte [cs:config_multi],1
 40932 00003E0D E80700                          call    comp_names      ; compare block names
 40933 00003E10 76DD                            jbe	short find_exit	; end of file, or names matched
 40934                                  next_line:
 40935 00003E12 E88002                          call    skip_opt_line   ; no, so skip to next line
 40936 00003E15 EBD9                            jmp	short find_block  ;
 40937                                  ;find_exit:
 40938                                  ;	retn
 40939                                  
 40940                                  ;----------------------------------------------------------------------------
 40941                                  ;
 40942                                  ;   comp_names: compares keyword @DS:DI to position in config.sys @ES:SI
 40943                                  ;
 40944                                  ;   INPUT
 40945                                  ;    DS:DI -> keyword to compare
 40946                                  ;    ES:SI -> position in config.sys
 40947                                  ;       CX == remaining bytes in config.sys
 40948                                  ;
 40949                                  ;   OUTPUT
 40950                                  ;       ZF flag set, if match (also, CF set if EOF)
 40951                                  ;    ES:SI -> where the comparison stopped (at end of block name or EOF)
 40952                                  ;       CX == # bytes remaining from that point
 40953                                  ;
 40954                                  ;   OTHER REGS USED
 40955                                  ;       AX
 40956                                  ;
 40957                                  ;   NOTES
 40958                                  ;       None
 40959                                  ;
 40960                                  ;   HISTORY
 40961                                  ;       Created 16-Mar-1992 by JeffPar
 40962                                  ;
 40963                                  ;----------------------------------------------------------------------------
 40964                                  
 40965                                  comp_names:
 40966 00003E17 57                              push    di              ;
 40967                                  comp_loop:                      ;
 40968 00003E18 E8A002                          call    get_char        ;
 40969 00003E1B 7210                            jc	short comp_exit	;
 40970 00003E1D E80704                          call    any_delim       ; is next character a delimiter?
 40971 00003E20 8A25                            mov     ah,[di]         ; (get next character we're supposed to match)
 40972 00003E22 740B                            je	short comp_almost ; yes, it *could* be a match
 40973 00003E24 47                              inc     di              ;
 40974 00003E25 25DFDF                          and     ax,~2020h ; 0DFDFh 
 40975                                  				; BUGBUG -- assumes both names are alphanumeric -JTP
 40976 00003E28 38E0                            cmp     al,ah           ; match?
 40977 00003E2A 74EC                            je	short comp_loop ; yes, keep looking at the characters
 40978 00003E2C F8                              clc                     ; prevent erroneous eof indication: clear carry
 40979                                  comp_exit:                      ;
 40980 00003E2D 5F                              pop     di              ;
 40981 00003E2E C3                              retn			;
 40982                                  comp_almost:                    ;
 40983 00003E2F 86C4                            xchg    al,ah           ; we don't know for sure if it's a match
 40984 00003E31 E8F303                          call    any_delim       ; until we verify that the second string has
 40985 00003E34 86C4                            xchg    al,ah           ; been exhausted also...
 40986 00003E36 EBF5                            jmp     short comp_exit ; if we are, this call to any_delim will tell...
 40987                                  
 40988                                  ;----------------------------------------------------------------------------
 40989                                  
 40990                                  	; 10/09/2023 - Retrodos v4.2 IO.SYS (Optimization)
 40991                                  comp_names_x:
 40992                                  	;
 40993                                  comp_names_safe:
 40994 00003E38 50                              push    ax
 40995 00003E39 51                              push    cx
 40996 00003E3A 56                              push	si
 40997 00003E3B 1E                              push    ds
 40998 00003E3C 0E                              push    cs
 40999 00003E3D 1F                              pop     ds
 41000 00003E3E E8D6FF                          call    comp_names
 41001 00003E41 1F                              pop     ds
 41002 00003E42 5E                      	pop	si
 41003 00003E43 59                              pop     cx
 41004 00003E44 58                              pop     ax
 41005 00003E45 C3                              retn
 41006                                  
 41007                                  ;----------------------------------------------------------------------------
 41008                                  ;
 41009                                  ;   print_item: display menu item #BL
 41010                                  ;
 41011                                  ;   INPUT
 41012                                  ;       BL == menu item # to display
 41013                                  ;
 41014                                  ;   OUTPUT
 41015                                  ;       Menu item displayed, with appropriate highlighting if BL == bDefBlock
 41016                                  ;
 41017                                  ;   OTHER REGS USED
 41018                                  ;       None
 41019                                  ;
 41020                                  ;   NOTES
 41021                                  ;       This function saves/restores the current cursor position, so you
 41022                                  ;       needn't worry about it.
 41023                                  ;
 41024                                  ;   HISTORY
 41025                                  ;       Created 16-Mar-1992 by JeffPar
 41026                                  ;
 41027                                  ;----------------------------------------------------------------------------
 41028                                  
 41029                                  	; 04/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 41030                                  	; (SYSINIT:485Ah)
 41031                                  
 41032                                  print_item:		; prints menu item #BL (1 to N)
 41033 00003E46 50                              push    ax              ;
 41034 00003E47 53                              push    bx              ;
 41035 00003E48 51                              push    cx              ;
 41036 00003E49 52                              push    dx              ;
 41037 00003E4A 56                              push    si              ;
 41038 00003E4B B403                            mov     ah,03h          ; get cursor position
 41039 00003E4D 8A3E[2A47]                      mov     bh,[bMenuPage]  ; always page zero
 41040 00003E51 CD10                            int     10h             ; DH/DL = row/column
 41041 00003E53 52                              push    dx              ; save it
 41042 00003E54 B402                            mov     ah,02h          ; set cursor position
 41043 00003E56 88DE                            mov     dh,bl           ;
 41044 00003E58 80C603                          add     dh,3            ;
 41045 00003E5B B205                            mov     dl,5            ;
 41046 00003E5D CD10                            int     10h             ; set cursor position for correct row/col
 41047 00003E5F 88D8                            mov     al,bl           ;
 41048 00003E61 0430                            add     al,'0'          ; convert menu item # to ASCII digit
 41049 00003E63 8A26[2947]                      mov     ah,[bMenuColor] ; normal attribute
 41050 00003E67 3A1E[3347]                      cmp     bl,[bDefBlock]  ; are we printing the current block?
 41051 00003E6B 7510                            jne	short print_other ; no
 41052 00003E6D 80CC70                          or      ah,70h          ; yes, set bgnd color to white
 41053 00003E70 88E5                            mov     ch,ah           ;
 41054 00003E72 B104                            mov     cl,4            ;
 41055 00003E74 D2C5                            rol     ch,cl           ;
 41056 00003E76 38E5                            cmp     ch,ah           ; are fgnd/bgnd the same?
 41057 00003E78 7503                            jne	short print_other ; no
 41058 00003E7A 80F408                          xor     ah,08h          ; yes, so modify the fgnd intensity
 41059                                  print_other:                    ;
 41060 00003E7D B700                            mov     bh,0            ;
 41061 00003E7F 01DB                            add     bx,bx           ;
 41062 00003E81 8BBF[5747]                      mov     di,[aoffBlockDesc+bx]
 41063 00003E85 88E3                            mov     bl,ah           ; put the attribute in the correct register now
 41064 00003E87 8A3E[2A47]                      mov     bh,[bMenuPage]  ; get correct video page #
 41065 00003E8B B409                            mov     ah,09h          ; write char/attr
 41066 00003E8D B90100                          mov     cx,1            ;
 41067 00003E90 CD10                            int     10h             ;
 41068 00003E92 FEC2                            inc     dl              ; increment column
 41069 00003E94 B402                            mov     ah,02h          ;
 41070 00003E96 CD10                            int     10h             ;
 41071                                          ;mov	ax,0900h+'.'    ;
 41072 00003E98 B82E09                          mov	ax,092Eh
 41073 00003E9B CD10                    	int     10h             ; display '.'
 41074 00003E9D FEC2                            inc     dl              ; increment column
 41075 00003E9F B402                            mov     ah,02h          ;
 41076 00003EA1 CD10                            int     10h             ;
 41077                                          ;mov	ax,0900h+' '    ;
 41078 00003EA3 B82009                          mov	ax,0920h
 41079 00003EA6 CD10                    	int     10h             ; display ' '
 41080 00003EA8 FEC2                            inc     dl              ; increment column
 41081 00003EAA B402                            mov     ah,02h          ;
 41082 00003EAC CD10                            int     10h             ;
 41083 00003EAE 06                              push    es              ;
 41084                                  print_loop:                     ;
 41085 00003EAF 268A05                          mov     al,[es:di]	; get a character of the description
 41086 00003EB2 47                              inc     di              ;
 41087 00003EB3 3C09                            cmp     al,TAB ; 9	; substitute spaces for tabs
 41088 00003EB5 7502                            jne	short print_nontab ;
 41089 00003EB7 B020                            mov     al,' '          ;
 41090                                  print_nontab:                   ;
 41091 00003EB9 3C20                            cmp     al,' '          ;
 41092 00003EBB 7215                            jb	short print_done ; stop at the 1st character < space
 41093 00003EBD 3C24                            cmp     al,'$'          ;
 41094 00003EBF 7411                            je	short print_done ; also stop on $
 41095 00003EC1 B409                            mov     ah,09h          ; display function #
 41096 00003EC3 CD10                            int     10h             ;
 41097 00003EC5 FEC2                            inc     dl              ; increment column
 41098 00003EC7 80FA4E                          cmp     dl,78           ; far enough?
 41099 00003ECA 7306                            jae	short print_done ; yes
 41100 00003ECC B402                            mov     ah,02h          ;
 41101 00003ECE CD10                            int     10h             ;
 41102 00003ED0 EBDD                            jmp	short  print_loop
 41103                                  print_done:                     ;
 41104 00003ED2 07                              pop     es              ;
 41105 00003ED3 5A                              pop     dx              ;
 41106 00003ED4 B402                            mov     ah,02h          ;
 41107 00003ED6 CD10                            int     10h             ; restore previous row/col
 41108 00003ED8 5E                              pop     si              ;
 41109 00003ED9 5A                              pop     dx              ;
 41110 00003EDA 59                              pop     cx              ;
 41111 00003EDB 5B                              pop     bx              ;
 41112 00003EDC 58                              pop     ax              ;
 41113 00003EDD C3                              retn			;
 41114                                  
 41115                                  ;----------------------------------------------------------------------------
 41116                                  ;
 41117                                  ;   select_item: wait for user to select menu item, with time-out
 41118                                  ;
 41119                                  ;   INPUT
 41120                                  ;       None
 41121                                  ;
 41122                                  ;   OUTPUT
 41123                                  ;       BX == menu item # (1-N), or -1 for clean boot
 41124                                  ;       Selected menu item highlighted
 41125                                  ;       Cursor positioned beneath menu, ready for tty-style output now
 41126                                  ;
 41127                                  ;   OTHER REGS USED
 41128                                  ;       None
 41129                                  ;
 41130                                  ;   NOTES
 41131                                  ;       None
 41132                                  ;
 41133                                  ;   HISTORY
 41134                                  ;       Created 16-Mar-1992 by JeffPar
 41135                                  ;
 41136                                  ;----------------------------------------------------------------------------
 41137                                  
 41138                                  select_item:		; returns digit value in BX (trashes AX/CX/DX)
 41139 00003EDE 8A1E[3347]                      mov     bl,[bDefBlock]  ; BL will be the default block #
 41140 00003EE2 88D8                            mov     al,bl           ;
 41141 00003EE4 E83701                          call    disp_num        ;
 41142 00003EE7 E84401                          call    show_status     ; display current interactive status
 41143 00003EEA 803E[3747]FF                    cmp     byte [secTimeOut],-1
 41144 00003EEF 7452                            je	short input_key	; no time-out, just go to input
 41145 00003EF1 B42C                            mov     ah,GET_TIME ; 2Ch
 41146 00003EF3 CD21                            int     21h             ;
 41147 00003EF5 88F7                            mov     bh,dh           ; BH = initial # of seconds
 41148                                  check_time:
 41149 00003EF7 A0[3747]                        mov     al,[secTimeOut] ;
 41150 00003EFA 2A06[3847]                      sub     al,[secElapsed] ;
 41151 00003EFE 730D                            jae	short show_time	;
 41152 00003F00 800E[3247]02                    or      byte [bQueryOpt],2 ; disable all further prompting
 41153 00003F05 C606[3847]00                    mov     byte [secElapsed],0
 41154 00003F0A E9F600                          jmp	select_done	; time's up!
 41155                                  show_time:
 41156 00003F0D 53                              push    bx              ;
 41157 00003F0E 88C3                            mov     bl,al           ; save # in BL
 41158 00003F10 8A3E[2A47]                      mov     bh,[bMenuPage]  ;
 41159 00003F14 B403                            mov     ah,03h          ; get cursor position
 41160 00003F16 CD10                            int     10h             ;
 41161 00003F18 52                              push    dx              ;
 41162 00003F19 80C208                  	add	dl,8		; move cursor to the right
 41163 00003F1C B402                            mov     ah,02h          ; set cursor position
 41164 00003F1E CD10                            int     10h             ;
 41165 00003F20 BA[E94C]                        mov     dx,_$TimeOut
 41166 00003F23 E8DB05                          call    print           ; print the "Time remaining: " prompt
 41167 00003F26 88D8                            mov     al,bl           ; recover # from BL
 41168 00003F28 98                              cbw                     ; this works because AL is always <= 90
 41169 00003F29 B10A                            mov     cl,10           ;
 41170 00003F2B F6F1                            div     cl              ; AL = tens digit, AH = ones digit
 41171 00003F2D 88E1                            mov     cl,ah           ;
 41172 00003F2F 0430                            add     al,'0'          ;
 41173 00003F31 B40E                            mov     ah,0Eh          ;
 41174 00003F33 CD10                            int     10h             ; write TTY tens digit
 41175 00003F35 88C8                            mov     al,cl           ;
 41176 00003F37 0430                            add     al,'0'          ;
 41177 00003F39 B40E                            mov     ah,0Eh          ;
 41178 00003F3B CD10                            int     10h             ; write TTY ones digit
 41179 00003F3D 5A                              pop     dx
 41180 00003F3E B402                            mov     ah,02h          ; set cursor position back to where it was
 41181 00003F40 CD10                            int     10h             ;
 41182 00003F42 5B                              pop     bx              ;
 41183                                  input_key:
 41184 00003F43 B406                            mov     ah,RAW_CON_IO ; 6
 41185 00003F45 B2FF                            mov     dl,0FFh         ; input request
 41186 00003F47 CD21                            int     21h             ;
 41187 00003F49 751F                            jnz	short got_key	;
 41188 00003F4B 803E[3747]FF                    cmp     byte [secTimeOut],-1; is there a time-out?
 41189 00003F50 74F1                            je	short input_key	; no, just go back to input
 41190 00003F52 B42C                            mov     ah,GET_TIME     ;
 41191 00003F54 CD21                            int     21h             ; DH = seconds
 41192 00003F56 88F4                            mov     ah,dh           ;
 41193 00003F58 28FE                            sub     dh,bh           ; should generally be zero or one
 41194 00003F5A 88E7                            mov     bh,ah           ;
 41195 00003F5C 7302                            jnc	short got_time	;
 41196 00003F5E B601                            mov     dh,1            ; it wrapped back to zero, so assume one
 41197                                  got_time:
 41198 00003F60 08F6                            or      dh,dh           ; any change?
 41199 00003F62 74DF                            jz	short input_key	; no
 41200 00003F64 0036[3847]                      add     [secElapsed],dh ;
 41201 00003F68 EB8D                            jmp	short check_time ;
 41202                                  got_key:
 41203 00003F6A 50                              push    ax              ;
 41204 00003F6B B8FFFF                          mov     ax,-1           ; zap both secTimeOut and secElapsed
 41205 00003F6E 8706[3747]                      xchg    [secTimeOut],ax
 41206 00003F72 3CFF                            cmp     al,-1           ; was time-out already disabled?
 41207 00003F74 740E                            je	short timeout_disabled ; yes
 41208 00003F76 53                              push    bx              ; let's disable # seconds display
 41209 00003F77 B8200A                          mov     ax,0A20h        ; write multiple spaces
 41210 00003F7A 8B1E[2947]                      mov     bx,[bMenuColor]
 41211 00003F7E B95000                          mov     cx,80           ; 80 of them, to be safe
 41212 00003F81 CD10                            int     10h             ; to completely obliterate # seconds display
 41213 00003F83 5B                              pop     bx   		;
 41214                                  
 41215                                  timeout_disabled:
 41216 00003F84 58                              pop     ax              ;
 41217 00003F85 08C0                            or      al,al           ; extended key pressed?
 41218 00003F87 755A                            jnz	short normal_key ; no
 41219 00003F89 CD21                            int     21h             ; get the next part of the key then
 41220 00003F8B 74B6                            jz	short input_key	; hmmm, what happened to the second part?
 41221                                  
 41222 00003F8D 3C48                            cmp     al,48h          ; up arrow?
 41223 00003F8F 7510                            jne	short not_up	; no
 41224 00003F91 80FB01                          cmp     bl,1            ; are we as up as up can get?
 41225 00003F94 76AD                            jbe	short input_key	; yes, ignore it
 41226 00003F96 FE0E[3347]                      dec     byte [bDefBlock] ;
 41227 00003F9A E8A9FE                          call    print_item      ; re-print the current item
 41228 00003F9D FECB                            dec     bl              ; and then print the new current item
 41229 00003F9F EB12                            jmp     short print1
 41230                                  not_up:
 41231 00003FA1 3C50                            cmp     al,50h          ; down arrow?
 41232 00003FA3 7518                            jne	short not_down	; no
 41233 00003FA5 3A1E[3447]                      cmp     bl,[bMaxBlock]  ; are we as down as down can get?
 41234 00003FA9 7310                            jae	short to_input_key ; yes, ignore it
 41235 00003FAB FE06[3347]                      inc     byte [bDefBlock] ;
 41236 00003FAF E894FE                          call    print_item      ; re-print the current item
 41237 00003FB2 43                              inc     bx              ; and then print the new current item
 41238                                  print1: 
 41239 00003FB3 88D8                    	mov     al,bl           ;
 41240                                  print2: 
 41241 00003FB5 E88EFE                  	call    print_item      ;
 41242 00003FB8 E86300                          call    disp_num        ;
 41243                                  to_input_key:
 41244 00003FBB EB86                            jmp	short input_key ; 10/09/2023
 41245                                  not_down:
 41246 00003FBD F606[2E47]01                    test    byte [bDisableUI],1
 41247 00003FC2 75F7                            jnz	short to_input_key ; don't allow F8 or F5
 41248 00003FC4 3C42                            cmp     al,42h          ; F8 function key?
 41249 00003FC6 750B                            jne	short not_f8	; no
 41250 00003FC8 8036[3247]01                    xor     byte [bQueryOpt],1
 41251 00003FCD E85E00                          call    show_status     ;
 41252 00003FD0 E970FF                          jmp     input_key	;
 41253                                  not_f8:
 41254 00003FD3 3C3F                            cmp     al,3Fh          ; F5 function key?
 41255 00003FD5 75E4                            jne	short to_input_key ; no
 41256                                  	; 02/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 41257                                  	; MSDOS 6.21 IO.SYS - SYSINIT:49EBh
 41258                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:4C32h)
 41259 00003FD7 800E[3247]04            	or	byte [bQueryOpt],4 ; no more queries
 41260 00003FDC BBFFFF                          mov     bx,-1           ; special return code (-1) indicating clean boot
 41261 00003FDF B020                            mov     al,' '          ; don't want to display anything really;
 41262 00003FE1 EB26                            jmp     short disp_input ; just want to display the cr/lf sequence...
 41263                                  
 41264                                  normal_key:
 41265 00003FE3 3C0D                            cmp     al,0Dh          ; Enter?
 41266 00003FE5 741C                            je	short select_done ; yes
 41267 00003FE7 3C08                            cmp     al,08h          ; backspace?
 41268 00003FE9 7504                            jne	short not_backspace ; no
 41269 00003FEB BBFEFF                          mov     bx,-2 ; 0FFFEh	; yes, special return code
 41270 00003FEE C3                              retn			;
 41271                                  not_backspace:
 41272 00003FEF 2C30                            sub     al,'0'          ; is greater than '0'?
 41273 00003FF1 76C8                            jbe	short to_input_key ; no
 41274 00003FF3 3A06[3447]                      cmp     al,[bMaxBlock]  ; is less than or equal to the maximum digit?
 41275 00003FF7 77C2                            ja	short to_input_key ; no
 41276 00003FF9 A2[3347]                        mov	[bDefBlock],al  ;
 41277 00003FFC E847FE                          call    print_item      ; redisplay the current selection
 41278 00003FFF 88C3                            mov     bl,al           ; set new selection
 41279 00004001 EBB2                            jmp	short print2
 41280                                  
 41281                                  select_done:
 41282 00004003 B700                            mov     bh,0            ; return a full 16-bit value (for indexing)
 41283 00004005 88D8                            mov     al,bl           ;
 41284 00004007 0430                            add     al,'0'          ; convert it into a digit, then display it
 41285                                  
 41286                                  	; fall into disp_input
 41287                                  
 41288                                  ; 16/04/2019 - Retro DOS v4.0
 41289                                  
 41290                                  ;----------------------------------------------------------------------------
 41291                                  ;
 41292                                  ;   disp_input: display a single character + cr/lf
 41293                                  ;
 41294                                  ;   INPUT
 41295                                  ;       AL == character to display
 41296                                  ;
 41297                                  ;   OUTPUT
 41298                                  ;       None
 41299                                  ;
 41300                                  ;   OTHER REGS USED
 41301                                  ;       None
 41302                                  ;
 41303                                  ;   NOTES
 41304                                  ;       This function is used not only for the menu input selection but
 41305                                  ;       also for the interactive line prompting (the y/n/a thing).
 41306                                  ;
 41307                                  ;   HISTORY
 41308                                  ;       Created 16-Mar-1992 by JeffPar
 41309                                  ;
 41310                                  ;----------------------------------------------------------------------------
 41311                                  
 41312                                  disp_input:
 41313 00004009 50                      	push	ax
 41314                                  	;cmp	al,' '
 41315                                  	;jae	short disp_ok
 41316                                  	;mov	al,' '
 41317                                  	; 10/09/2023 - Retro DOS v4.2 IO:SYS (Optimization)
 41318 0000400A B220                    	mov	dl,' ' ; 20h
 41319 0000400C 38D0                    	cmp	al,dl
 41320 0000400E 7602                    	jna	short disp_input_ok
 41321                                  disp_ok:
 41322 00004010 88C2                    	mov	dl,al
 41323                                  disp_input_ok:
 41324 00004012 B402                    	mov	ah,STD_CON_OUTPUT ; 2
 41325 00004014 CD21                    	int	21h
 41326 00004016 BA[4C4A]                	mov	dx,crlfm
 41327 00004019 E8E504                  	call	print
 41328 0000401C 58                      	pop	ax
 41329 0000401D C3                      	retn
 41330                                  
 41331                                  ;----------------------------------------------------------------------------
 41332                                  
 41333                                  disp_num:
 41334 0000401E 53                              push    bx
 41335 0000401F 0430                            add     al,'0'
 41336 00004021 B40A                            mov     ah,0Ah
 41337 00004023 8B1E[2947]                      mov     bx,[bMenuColor]
 41338 00004027 B90100                          mov     cx,1
 41339 0000402A CD10                            int     10h
 41340 0000402C 5B                              pop     bx
 41341 0000402D C3                              retn
 41342                                  
 41343                                  ;----------------------------------------------------------------------------
 41344                                  ;
 41345                                  ;   show_status: display current interactive mode setting (on/off/none)
 41346                                  ;
 41347                                  ;   INPUT
 41348                                  ;       None
 41349                                  ;
 41350                                  ;   OUTPUT
 41351                                  ;       None
 41352                                  ;
 41353                                  ;   OTHER REGS USED
 41354                                  ;       None
 41355                                  ;
 41356                                  ;   NOTES
 41357                                  ;       None
 41358                                  ;
 41359                                  ;   HISTORY
 41360                                  ;       Created 16-Mar-1992 by JeffPar
 41361                                  ;
 41362                                  ;----------------------------------------------------------------------------
 41363                                  
 41364                                  show_status:
 41365 0000402E 53                              push    bx              ; BL = video page #
 41366 0000402F 8B1E[2947]                      mov     bx,[bMenuColor]
 41367 00004033 B403                            mov     ah,03h          ; get cursor position
 41368 00004035 CD10                            int     10h             ;
 41369 00004037 52                              push    dx              ; save it
 41370 00004038 B402                            mov     ah,02h          ; set cursor position
 41371 0000403A 8B16[2C47]                      mov     dx,[bLastCol]   ; set correct row/col
 41372 0000403E F606[2E47]01                    test    byte [bDisableUI],1
 41373 00004043 740C                            jz	short show_onoff ; just show on/off
 41374 00004045 B200                            mov     dl,0            ;
 41375 00004047 CD10                            int     10h             ;
 41376 00004049 B8200A                          mov     ax,0A20h        ; write multiple spaces
 41377 0000404C B95000                          mov     cx,80           ; 80 of them, to be exact
 41378                                  	; 10/09/2023
 41379                                  	;int	10h             ; to obliterate the status line
 41380 0000404F EB11                            jmp     short show_done ;
 41381                                  show_onoff: 
 41382 00004051 CD10                            int     10h
 41383                                  		; - VIDEO - WRITE CHARACTERS ONLY AT CURSOR POSITION
 41384                                  		; AL = character, BH = display page - alpha mode
 41385                                  		; BL = color of character (graphics mode, PCjr only)
 41386                                  		; CX = number of times to write character
 41387                                  
 41388 00004053 A0[E54C]                        mov     al,[_$NO]	; assume OFF
 41389 00004056 803E[3247]01                    cmp     byte [bQueryOpt],1 ; is interactive mode on?
 41390 0000405B 7503                            jne	short show_noton ; no
 41391 0000405D A0[E14C]                        mov     al,[_$YES]	; yes
 41392                                  show_noton:                     ;
 41393 00004060 B40E                            mov     ah,0Eh          ; write TTY
 41394                                  show_done:	; 10/09/2023
 41395 00004062 CD10                            int     10h             ;
 41396                                  ;show_done:                     ;
 41397 00004064 5A                              pop     dx              ;
 41398 00004065 B402                            mov     ah,02h          ;
 41399 00004067 CD10                            int     10h             ; restore original cursor position
 41400 00004069 5B                              pop     bx              ;
 41401 0000406A C3                              retn			;
 41402                                  
 41403                                  ; 16/04/2019 - Retro DOS v4.0
 41404                                  
 41405                                  ;----------------------------------------------------------------------------
 41406                                  ;
 41407                                  ;   skip_token: advances ES:SI/CX past the current token
 41408                                  ;
 41409                                  ;   INPUT
 41410                                  ;    ES:SI -> position in config.sys
 41411                                  ;       CX == remaining bytes in config.sys
 41412                                  ;
 41413                                  ;   OUTPUT
 41414                                  ;       CF set if EOL/EOF hit
 41415                                  ;       AL == 1st char of delimiter
 41416                                  ;    ES:SI -> just past the delimiter
 41417                                  ;       CX == # bytes remaining from that point
 41418                                  ;
 41419                                  ;   OTHER REGS USED
 41420                                  ;       AX
 41421                                  ;
 41422                                  ;   NOTES
 41423                                  ;       None
 41424                                  ;
 41425                                  ;   HISTORY
 41426                                  ;       Created 16-Mar-1992 by JeffPar
 41427                                  ;
 41428                                  ;----------------------------------------------------------------------------
 41429                                  
 41430                                  skip_token:
 41431 0000406B E84D00                          call    get_char
 41432 0000406E 7210                            jc	short skip_token_done
 41433 00004070 E8B401                          call    any_delim
 41434 00004073 75F6                            jne	short skip_token
 41435                                  skip_check_eol:
 41436 00004075 3C0D                            cmp     al,cr ; 0Dh
 41437 00004077 7406                            je	short skip_token_eol
 41438 00004079 3C0A                            cmp     al,lf ; 0Ah
 41439 0000407B 7402                            je	short skip_token_eol
 41440 0000407D F8                              clc
 41441                                          ;jmp	short skip_token_done
 41442 0000407E C3                      	retn
 41443                                  skip_token_eol:
 41444 0000407F F9                              stc
 41445                                  skip_token_done:
 41446 00004080 C3                              retn
 41447                                  
 41448                                  ;----------------------------------------------------------------------------
 41449                                  ;
 41450                                  ;   skip_delim: advances ES:SI/CX past the current delimiter
 41451                                  ;
 41452                                  ;   INPUT
 41453                                  ;    ES:SI -> position in config.sys
 41454                                  ;       CX == remaining bytes in config.sys
 41455                                  ;
 41456                                  ;   OUTPUT
 41457                                  ;       CF set if EOF hit
 41458                                  ;       AL == 1st char of token
 41459                                  ;    ES:SI -> just past the token
 41460                                  ;       CX == # bytes remaining from that point
 41461                                  ;    ES:BX -> new token (since ES:SI is already pointing 1 byte past token)
 41462                                  ;
 41463                                  ;   OTHER REGS USED
 41464                                  ;       AX
 41465                                  ;
 41466                                  ;   NOTES
 41467                                  ;       None
 41468                                  ;
 41469                                  ;   HISTORY
 41470                                  ;       Created 16-Mar-1992 by JeffPar
 41471                                  ;
 41472                                  ;----------------------------------------------------------------------------
 41473                                  
 41474                                  skip_delim:	; returns carry set if eol/eof
 41475 00004081 E83700                          call    get_char        ;
 41476 00004084 8D5CFF                          lea     bx,[si-1]       ; also returns BX -> next token
 41477 00004087 72F7                            jc	short skip_token_done ;
 41478 00004089 E8AB01                          call    delim           ;
 41479 0000408C 74F3                            je	short skip_delim ;
 41480 0000408E EBE5                            jmp	short skip_check_eol  ; 13/05/2019
 41481                                  
 41482                                  ;----------------------------------------------------------------------------
 41483                                  ;
 41484                                  ;   skip_opt_line: same as skip_line provided AL != LF
 41485                                  ;
 41486                                  ;   INPUT
 41487                                  ;       AL == last character read
 41488                                  ;    ES:SI -> position in config.sys
 41489                                  ;       CX == remaining bytes in config.sys
 41490                                  ;
 41491                                  ;   OUTPUT
 41492                                  ;       CF set if EOF hit
 41493                                  ;       AL == 1st char of new line
 41494                                  ;    ES:SI -> just past 1st char of new line
 41495                                  ;       CX == # bytes remaining from that point
 41496                                  ;
 41497                                  ;   OTHER REGS USED
 41498                                  ;       AX
 41499                                  ;
 41500                                  ;   NOTES
 41501                                  ;       In other words, the purpose here is to skip to the next line,
 41502                                  ;       unless ES:SI is already sitting at the front of the next line (which
 41503                                  ;       it would be if the last character fetched -- AL -- was a linefeed)
 41504                                  ;
 41505                                  ;   HISTORY
 41506                                  ;       Created 16-Mar-1992 by JeffPar
 41507                                  ;
 41508                                  ;----------------------------------------------------------------------------
 41509                                  
 41510                                  ; 03/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 41511                                  ;skip_opt_line:
 41512                                  ;	cmp     al,lf ; 0Ah
 41513                                  ;	je	short skip_line_done
 41514                                       
 41515                                  	; fall into skip_line
 41516                                  
 41517                                  ;----------------------------------------------------------------------------
 41518                                  ;
 41519                                  ;   skip_line: skip to the next line
 41520                                  ;
 41521                                  ;   INPUT
 41522                                  ;    ES:SI -> position in config.sys
 41523                                  ;       CX == remaining bytes in config.sys
 41524                                  ;
 41525                                  ;   OUTPUT
 41526                                  ;       CF set if EOF hit
 41527                                  ;    ES:SI -> just past 1st char of new line
 41528                                  ;       CX == # bytes remaining from that point
 41529                                  ;
 41530                                  ;   OTHER REGS USED
 41531                                  ;       AX
 41532                                  ;
 41533                                  ;   NOTES
 41534                                  ;       None
 41535                                  ;
 41536                                  ;   HISTORY
 41537                                  ;       Created 16-Mar-1992 by JeffPar
 41538                                  ;
 41539                                  ;----------------------------------------------------------------------------
 41540                                  
 41541                                  skip_line:
 41542 00004090 E82800                          call    get_char
 41543 00004093 7204                            jc	short skip_line_done
 41544                                  skip_opt_line:	; 03/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 41545 00004095 3C0A                            cmp     al,lf ; 0Ah
 41546 00004097 75F7                            jne	short skip_line
 41547                                  skip_line_done:
 41548                                  num_done:	; 18/12/2022
 41549 00004099 C3                              retn
 41550                                  
 41551                                  ;----------------------------------------------------------------------------
 41552                                  ;
 41553                                  ;   get_number: return binary equivalent of numeric string
 41554                                  ;
 41555                                  ;   INPUT
 41556                                  ;    ES:SI -> position in config.sys
 41557                                  ;       CX == remaining bytes in config.sys
 41558                                  ;
 41559                                  ;   OUTPUT
 41560                                  ;       AL == non-digit encountered
 41561                                  ;       BX == binary #
 41562                                  ;    ES:SI -> just past 1st non-digit
 41563                                  ;       CX == # bytes remaining from that point
 41564                                  ;
 41565                                  ;   OTHER REGS USED
 41566                                  ;       AX
 41567                                  ;
 41568                                  ;   NOTES
 41569                                  ;       None
 41570                                  ;
 41571                                  ;   HISTORY
 41572                                  ;       Created 16-Mar-1992 by JeffPar
 41573                                  ;
 41574                                  ;----------------------------------------------------------------------------
 41575                                  
 41576                                  ; 13/05/2019
 41577                                  
 41578                                  get_number:
 41579 0000409A 29DB                            sub     bx,bx           ; BX = result
 41580                                  num_loop:
 41581 0000409C E81C00                          call    get_char        ;
 41582 0000409F 72F8                            jc	short num_done	;
 41583 000040A1 3C30                            cmp     al,'0'          ; convert to value
 41584 000040A3 72F4                            jb	short num_done	; no more number
 41585 000040A5 3C39                            cmp     al,'9'          ;
 41586 000040A7 77F0                            ja	short num_done	;
 41587 000040A9 50                              push    ax              ;
 41588 000040AA B80A00                          mov     ax,10           ;
 41589 000040AD 52                              push    dx              ;
 41590 000040AE F7E3                            mul     bx              ;
 41591 000040B0 5A                              pop     dx              ;
 41592 000040B1 89C3                            mov     bx,ax           ;
 41593 000040B3 58                              pop     ax              ;
 41594 000040B4 2C30                            sub     al,'0'          ;
 41595 000040B6 98                              cbw                     ;
 41596 000040B7 01C3                            add     bx,ax           ;
 41597 000040B9 EBE1                            jmp	short num_loop	;
 41598                                  
 41599                                  	; 18/12/2022
 41600                                  ;num_done:
 41601                                          ;retn
 41602                                  
 41603                                  ;----------------------------------------------------------------------------
 41604                                  ;
 41605                                  ;   get_char: return next character, advance ES:SI, and decrement CX
 41606                                  ;
 41607                                  ;   INPUT
 41608                                  ;    ES:SI -> position in config.sys
 41609                                  ;       CX == remaining bytes in config.sys
 41610                                  ;
 41611                                  ;   OUTPUT
 41612                                  ;       AL == next character
 41613                                  ;    ES:SI -> just past next character
 41614                                  ;       CX == # bytes remaining from that point
 41615                                  ;
 41616                                  ;   OTHER REGS USED
 41617                                  ;       AX
 41618                                  ;
 41619                                  ;   NOTES
 41620                                  ;       None
 41621                                  ;
 41622                                  ;   HISTORY
 41623                                  ;       Created 16-Mar-1992 by JeffPar
 41624                                  ;
 41625                                  ;----------------------------------------------------------------------------
 41626                                  
 41627                                  get_char:
 41628 000040BB 83E901                          sub     cx,1            ; use SUB to set carry,zero
 41629 000040BE 7205                            jb	short get_fail	; out of data
 41630                                          ;lods	byte ptr es:[si] ;
 41631 000040C0 26                      	es	
 41632 000040C1 AC                      	lodsb
 41633 000040C2 88C4                            mov     ah,al           ;
 41634 000040C4 C3                              retn			;
 41635                                  get_fail:                       ; restore CX to zero
 41636 000040C5 B90000                          mov     cx,0            ; leave carry set, zero not set
 41637                                  nearby_ret:
 41638 000040C8 C3                              retn
 41639                                  
 41640                                  ;----------------------------------------------------------------------------
 41641                                  ;
 41642                                  ;   query_user: ask user whether to execute current config.sys command
 41643                                  ;
 41644                                  ;   INPUT
 41645                                  ;       AL == current command code
 41646                                  ;    ES:SI -> current command line in config.sys
 41647                                  ;    config_cmd == current command code, but with QUERY bit intact
 41648                                  ;                  (00h used to generate "Process AUTOEXEC.BAT" prompt)
 41649                                  ;
 41650                                  ;   OUTPUT
 41651                                  ;       CF set if command should be ignored (it is also REM'ed out)
 41652                                  ;
 41653                                  ;   OTHER REGS USED
 41654                                  ;       BX, CX, DX, DI
 41655                                  ;
 41656                                  ;   NOTES
 41657                                  ;       None
 41658                                  ;
 41659                                  ;   HISTORY
 41660                                  ;       Created 16-Mar-1992 by JeffPar
 41661                                  ;
 41662                                  ;----------------------------------------------------------------------------
 41663                                  
 41664                                  	; 31/12/2022 - Retro UNIX 386 v4.2 (Modified MSDOS 6.21 IO.SYS)
 41665                                  	; (SYSINIT:4AE5h)
 41666                                  
 41667                                  	; 12/12/2022
 41668                                  query_user:
 41669 000040C9 F606[3247]04                    test    byte [bQueryOpt],4	; answer no to everything?
 41670                                  	; 01/01/2023
 41671 000040CE 7403                    	jz	short qu_1		;
 41672 000040D0 E9B900                  	jmp	skip_all
 41673                                  	; 12/12/2022
 41674                                  	;;jmp	short skip_all		;
 41675                                  	;jnz	short skip_all
 41676                                  qu_1:
 41677 000040D3 F606[3247]02            	test    byte [bQueryOpt],2	; answer yes to everything?
 41678 000040D8 75EE                            jnz	short nearby_ret	; yes (and return carry clear!)
 41679 000040DA 50                              push    ax                      ;
 41680 000040DB A0[E814]                        mov     al,[config_cmd]         ;
 41681 000040DE F606[3247]01                    test    byte [bQueryOpt],1	; query every command?
 41682 000040E3 7506                            jnz	short query_all		; yes
 41683 000040E5 A880                            test    al,CONFIG_OPTION_QUERY  ;
 41684                                  	; 01/01/2023
 41685 000040E7 7502                    	jnz	short query_all		;
 41686                                  	; 12/12/2022
 41687                                  	;;jmp	short do_cmd		;
 41688                                  	;jz	short do_cmd ; cf=0
 41689                                  
 41690                                  	; 01/01/2023
 41691 000040E9 58                      	pop	ax
 41692 000040EA C3                      	retn
 41693                                  
 41694                                  query_all:
 41695                                  
 41696                                  ;   Search for the command code (AL) in "comtab", and then print
 41697                                  ;   out the corresponding keyword, followed by the rest of the actual
 41698                                  ;   line pointed to by ES:SI
 41699                                  
 41700 000040EB 56                              push    si                      ; save pointer to rest of CONFIG.SYS line
 41701 000040EC BA[3B4D]                        mov     dx,_$AutoPrmpt    	;
 41702 000040EF 247F                            and     al,~CONFIG_OPTION_QUERY ; 7Fh
 41703 000040F1 7450                            jz	short generic_prompt	; config_cmd must have been 0
 41704                                  
 41705 000040F3 88C6                            mov     dh,al                   ; save config_cmd in DH
 41706 000040F5 29DB                            sub     bx,bx                   ;
 41707 000040F7 BF[7F47]                        mov     di,comtab		;
 41708                                  find_match:                             ;
 41709 000040FA 8A1D                            mov     bl,[di]                 ; get size of current keyword
 41710 000040FC 08DB                            or      bl,bl                   ;
 41711 000040FE 7425                            jz	short line_print	; end of table
 41712 00004100 47                              inc     di                      ;
 41713 00004101 3A01                            cmp     al,[di+bx]              ; match?
 41714 00004103 7405                            je	short cmd_match		; yes
 41715 00004105 8D7901                          lea     di,[di+bx+1]            ; otherwise, skip this command code
 41716                                  	; 13/05/2019	
 41717 00004108 EBF0                            jmp	short find_match	; loop
 41718                                  cmd_match:                              ;
 41719 0000410A 8A4DFF                          mov     cl,[di-1]               ;
 41720 0000410D B500                            mov	ch,0                    ;
 41721 0000410F B402                            mov     ah,STD_CON_OUTPUT ; 2
 41722                                  cmd_print:                              ;
 41723 00004111 8A05                            mov     al,[di]                 ;
 41724 00004113 47                              inc     di                      ;
 41725 00004114 88C2                            mov     dl,al                   ;
 41726 00004116 CD21                            int     21h                     ;
 41727 00004118 E2F7                            loop    cmd_print               ;
 41728 0000411A B23D                            mov     dl,'='                  ;
 41729 0000411C 80FE56                          cmp     dh,CONFIG_SET  ; 'V'    ; for SET commands, don't display a '='
 41730 0000411F 7502                            jne	short cmd_notset	;
 41731 00004121 B220                            mov     dl,' '                  ;
 41732                                  cmd_notset:
 41733 00004123 CD21                            int     21h                     ; '=' looks funny on SET commands
 41734                                  line_print:                             ;
 41735                                  	;lods	byte ptr es:[si]        ;
 41736 00004125 26                              es
 41737 00004126 AC                      	lodsb
 41738 00004127 08C0                    	or      al,al                   ;
 41739 00004129 7502                            jnz	short non_null		;
 41740 0000412B B020                            mov     al,' '                  ;
 41741                                  non_null:                               ;
 41742 0000412D 3C20                            cmp     al,' '                  ; control code?
 41743 0000412F 720F                            jb	short prompt_user	; yes, assume end of line
 41744 00004131 7505                            jne	short non_space		;
 41745                                          ; 10/09/2023
 41746 00004133 263804                  	cmp	[es:si],al ; 20h
 41747                                  	;cmp	byte [es:si],' '	;
 41748 00004136 7208                            jb	short prompt_user	;
 41749                                  non_space:                              ;
 41750 00004138 88C2                            mov     dl,al                   ;
 41751 0000413A B402                            mov     ah,STD_CON_OUTPUT ; 2	;
 41752 0000413C CD21                            int     21h                     ;
 41753 0000413E EBE5                            jmp	short line_print	;
 41754                                  
 41755                                  prompt_user:                            ;
 41756 00004140 BA[D94C]                        mov     dx,_$InterPrmpt		;
 41757                                  
 41758                                  generic_prompt:
 41759 00004143 E8BB03                          call    print                   ;
 41760                                  input_loop:                             ;
 41761 00004146 B400                            mov     ah,0                    ; read a key
 41762 00004148 CD16                            int     16h                     ;
 41763 0000414A 08C0                            or      al,al                   ; is it a function key?
 41764 0000414C 750F                            jnz	short not_func		; no
 41765 0000414E 80FC3F                          cmp     ah,3Fh                  ; F5 function key?
 41766 00004151 75F3                            jne	short input_loop	; no
 41767 00004153 A0[E54C]                        mov     al,[_$NO] 		;
 41768 00004156 800E[3247]04                    or      byte [bQueryOpt],4	; no more queries
 41769 0000415B EB21                            jmp     short legal_char        ;
 41770                                  not_func:
 41771 0000415D 24DF                            and     al,~20h ; 0DFh		; converting to upper case
 41772 0000415F 3A06[E54C]                      cmp     al,[_$NO]		; verify character is legal
 41773 00004163 7419                            je	short legal_char	;
 41774 00004165 3A06[E14C]                      cmp     al,[_$YES]		;
 41775 00004169 7413                            je	short legal_char	;
 41776 0000416B 803E[E814]00                    cmp     byte [config_cmd],0	;
 41777 00004170 74D4                            je	short input_loop	; don't allow Esc on this query
 41778 00004172 3C1B                            cmp     al,1Bh                  ; Esc?
 41779 00004174 75D0                            jne	short input_loop	;
 41780 00004176 800E[3247]02                    or      byte [bQueryOpt],2	; no more interactive boot prompts
 41781 0000417B A0[E14C]                        mov     al,[_$YES]
 41782                                  legal_char:                             ;
 41783 0000417E E888FE                          call    disp_input              ;
 41784 00004181 5E                              pop     si                      ; restore pointer to rest of CONFIG.SYS line
 41785                                  
 41786 00004182 3A06[E54C]                      cmp     al,[_$NO]		; process line?
 41787 00004186 7403                            je	short skip_cmd		; no
 41788                                  	; 12/12/2022
 41789 00004188 F8                      	clc
 41790                                  do_cmd:
 41791 00004189 58                      	pop     ax			;
 41792                                  	; 12/12/2022
 41793                                  	; cf=0
 41794                                  	;clc				; just do the command
 41795 0000418A C3                      	retn
 41796                                  
 41797                                  skip_cmd:
 41798 0000418B 58                      	pop     ax			;
 41799                                  skip_all:
 41800 0000418C B430                    	mov     ah,CONFIG_REM ; '0'	; fake out the rest of sysinit's processing
 41801 0000418E F9                      	stc
 41802 0000418F C3                      	retn
 41803                                  
 41804                                  ;----------------------------------------------------------------------------
 41805                                  ;
 41806                                  ;   print_error: displays multi-config error conditions
 41807                                  ;
 41808                                  ;   INPUT
 41809                                  ;    Carry set to pause, clear to not
 41810                                  ;    ES:SI -> current command line in config.sys
 41811                                  ;
 41812                                  ;   OUTPUT
 41813                                  ;       None
 41814                                  ;
 41815                                  ;   OTHER REGS USED
 41816                                  ;       None
 41817                                  ;
 41818                                  ;   NOTES
 41819                                  ;       None
 41820                                  ;
 41821                                  ;   HISTORY
 41822                                  ;       Created 16-Mar-1992 by JeffPar
 41823                                  ;
 41824                                  ;----------------------------------------------------------------------------
 41825                                  
 41826                                  print_error:
 41827 00004190 50                              push    ax
 41828 00004191 53                              push    bx
 41829 00004192 51                              push    cx
 41830 00004193 52                              push    dx
 41831 00004194 1E                              push    ds
 41832 00004195 0E                              push    cs
 41833 00004196 1F                              pop     ds
 41834 00004197 9C                              pushf
 41835 00004198 E820FC                          call    get_linenum
 41836 0000419B 891E[AF02]                      mov     [linecount],bx
 41837 0000419F E8C5E7                          call    error_line
 41838 000041A2 9D                              popf
 41839 000041A3 7319                            jnc	short pe_ret
 41840 000041A5 BA[A34B]                        mov     dx,_$PauseMsg
 41841 000041A8 E85603                          call    print
 41842 000041AB B8070C                          mov     ax,0C07h		; flush input buffer, then wait for key
 41843 000041AE CD21                            int     21h			; wait for a key
 41844 000041B0 08C0                            or      al,al			; extended key?
 41845 000041B2 7504                            jnz	short pe_1		; no
 41846 000041B4 B407                            mov     ah,07h			; yes
 41847 000041B6 CD21                            int     21h			; eat it too
 41848                                  pe_1:     
 41849 000041B8 BA[4C4A]                	mov     dx,crlfm
 41850 000041BB E84303                          call    print
 41851                                  pe_ret: 
 41852 000041BE 1F                      	pop     ds
 41853 000041BF 5A                              pop     dx
 41854 000041C0 59                              pop     cx
 41855 000041C1 5B                              pop     bx
 41856 000041C2 58                              pop     ax
 41857 000041C3 C3                      	retn
 41858                                  
 41859                                  ;----------------------------------------------------------------------------
 41860                                  
 41861                                  ;   This function is very simple: it merely prepends a "/D" to the
 41862                                  ;   command-line for the shell; this (undocumented) switch disables
 41863                                  ;   AUTOEXEC.BAT processing and the date/time prompt that is usually
 41864                                  ;   displayed when there's no AUTOEXEC.BAT.
 41865                                  
 41866                                  disable_autoexec:
 41867                                  	; MSDOS 6.21 IO.SYS -  SYSINIT:4BE2h
 41868                                  	; 17/04/2019 - Retro DOS v4.0
 41869                                  
 41870 000041C4 F606[3247]04            	test	byte [bQueryOpt],4
 41871 000041C9 7443                    	jz	short disable_exit
 41872 000041CB F606[2847]01            	test	byte [dae_flag],1
 41873 000041D0 753C                    	jnz	short disable_exit
 41874 000041D2 800E[2847]01            	or	byte [dae_flag],1
 41875                                          ;or	byte [bQueryOpt],2 ; MSDOS 6.0 
 41876 000041D7 810E[3247]0201          	or      word [bQueryOpt],102h	; [bDefBlock] = 1
 41877 000041DD BA4420                  	mov     dx,'D ' ; 2044h
 41878                                  dae_1:
 41879                                  	; 03/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 41880 000041E0 A0[6746]                        mov	al,[def_swchr]
 41881                                  	;mov	al,[command_line-1]     ; get default switchchar
 41882 000041E3 08C0                            or      al,al                   ; anything there?
 41883 000041E5 7427                            jz	short disable_exit	; no, disable_autoexec already called
 41884 000041E7 8A1E[6846]                      mov     bl,[command_line]       ;
 41885 000041EB B700                            mov     bh,0                    ; BX == command-line length
 41886 000041ED 89D9                            mov     cx,bx                   ;
 41887 000041EF 80C303                          add     bl,3                    ;
 41888 000041F2 80FB7E                          cmp     bl,126                  ;
 41889 000041F5 7717                            ja	short disable_exit	;
 41890 000041F7 881E[6846]                      mov     [command_line],bl       ; update length
 41891 000041FB 81C3[6946]                      add     bx,command_line+1	; make sure we move the NULL too
 41892 000041FF 41                              inc     cx                      ; (just for consistency sake)
 41893                                  disable_loop:                           ;
 41894 00004200 8A67FD                          mov     ah,[bx-3]               ;
 41895 00004203 8827                            mov     [bx],ah                 ;
 41896 00004205 4B                              dec     bx                      ;
 41897 00004206 E2F8                            loop    disable_loop            ;
 41898 00004208 8847FE                          mov     [bx-2],al               ;
 41899                                  	;mov	word [bx-1],'D ' ; 2044h ; /D is stuffed into place now
 41900 0000420B 8957FF                  	mov	[bx-1],dx  ; MSDOS 6.21 IO.SYS - SYSINIT:4C29h		
 41901                                          ;mov	byte [command_line-1],0 ;
 41902                                  disable_exit:                           ;
 41903 0000420E C3                              retn
 41904                                  
 41905                                  CheckQueryOpt:	; MSDOS 6.21 IO.YSYS - SYSINIT:4C2Dh
 41906 0000420F 803E[3247]01            	cmp     byte [bQueryOpt],1
 41907 00004214 75F8                    	jnz     short disable_exit
 41908 00004216 F606[2847]02            	test	byte [dae_flag],2
 41909 0000421B 75F1                    	jnz     short disable_exit
 41910 0000421D 800E[2847]02            	or      byte [dae_flag],2
 41911                                  	;mov	dx,' Y' ; (MASM syntax) ; 2059h
 41912                                  	; 10/09/2023 (BugFix)
 41913 00004222 BA5920                  	mov	dx,'Y ' ; (NASM syntax) ; 2059h
 41914 00004225 EBB9                    	jmp     short dae_1
 41915                                  
 41916                                  ;endif  ;MULTI_CONFIG
 41917                                  
 41918                                  ;%endif	; 02/11/2022
 41919                                  
 41920                                  
 41921                                  ; 19/04/2019 - Retro DOS v4.0
 41922                                  
 41923                                  ;----------------------------------------------------------------------------
 41924                                  ;
 41925                                  ; procedure : delim
 41926                                  ;
 41927                                  ;----------------------------------------------------------------------------
 41928                                  
 41929                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 41930                                  ; (SYSINIT:4C45h)
 41931                                  
 41932                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 41933                                  ;%if 0
 41934                                  ;;ifdef	MULTI_CONFIG
 41935                                  ;
 41936                                  any_delim:
 41937 00004227 3C0D                    	cmp	al,cr
 41938 00004229 7427                    	je	short delim_ret
 41939 0000422B 3C0A                    	cmp	al,lf
 41940 0000422D 7423                    	je	short delim_ret
 41941 0000422F 3C5B                    	cmp	al,'['
 41942 00004231 741F                    	je	short delim_ret
 41943 00004233 3C5D                    	cmp	al,']'
 41944 00004235 741B                    	je	short delim_ret
 41945                                  ;
 41946                                  ;;endif ;MULTI_CONFIG
 41947                                  ;%endif ; 02/11/2022
 41948                                  
 41949                                  	; 02/11/2022 - Retrodos v4.0 (Modified MSDOS 5.0 IO.SYS)
 41950                                  	; (SYSINIT:3450h)	
 41951                                  delim:
 41952 00004237 3C2F                    	cmp	al,'/'		; ibm will assume "/" as an delimeter.
 41953 00004239 7417                    	je	short delim_ret
 41954                                  
 41955 0000423B 3C00                    	cmp	al,0		; special case for sysinit!!!
 41956 0000423D 7413                    	je	short delim_ret
 41957                                  
 41958                                  org_delim:			; used by organize routine except for getting
 41959 0000423F 3C20                    	cmp	al,' '          ; the filename.
 41960 00004241 740F                    	je	short delim_ret
 41961 00004243 3C09                            cmp     al,tab ; 9
 41962 00004245 740B                    	je	short delim_ret
 41963 00004247 3C3D                    	cmp	al,'='
 41964 00004249 7407                    	je	short delim_ret
 41965 0000424B 3C2C                    	cmp	al,','
 41966 0000424D 7403                    	je	short delim_ret
 41967 0000424F 3C3B                    	cmp	al,';'
 41968                                  
 41969                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 41970                                  
 41971                                  ; 04/01/2023 - Retro DOS v4.2
 41972                                  ;ifdef	MULTI_CONFIG
 41973                                  ;   Make sure there's no chance of a false EOF indication
 41974 00004251 F8                      	clc
 41975                                  ;endif
 41976                                  	; 02/11/2022
 41977                                  delim_ret:
 41978                                  	; 04/01/2023
 41979                                  	; cf = 0
 41980                                  nl_ret:	; 10/09/2023
 41981 00004252 C3                      	retn
 41982                                  
 41983                                  ;----------------------------------------------------------------------------
 41984                                  ;
 41985                                  ; procedure : newline
 41986                                  ;
 41987                                  ;  newline returns with first character of next line
 41988                                  ;
 41989                                  ;----------------------------------------------------------------------------
 41990                                  
 41991                                  newline:
 41992 00004253 E80600                  	call	getchr			;skip non-control characters
 41993 00004256 72FA                    	jc	short nl_ret
 41994 00004258 3C0A                    	cmp	al,lf			;look for line feed
 41995 0000425A 75F7                    	jne	short newline
 41996                                  
 41997                                  	; 10/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 41998                                  	;call	getchr
 41999                                  ;nl_ret:
 42000                                  	;retn
 42001                                  	; 10/09/2023
 42002                                  	;jmp	short getchr
 42003                                  
 42004                                  ; 10/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 42005                                  %if 1
 42006                                  
 42007                                  ;----------------------------------------------------------------------------
 42008                                  ;
 42009                                  ; procedure : getchr
 42010                                  ;
 42011                                  ;----------------------------------------------------------------------------
 42012                                  
 42013                                  	; 24/10/2022
 42014                                  getchr:
 42015                                  	; 12/12/2022
 42016                                  	;push	cx
 42017                                  	;mov	cx,[count]
 42018                                  	;jcxz	nochar
 42019                                  	; 12/12/2022
 42020 0000425C 833E[5603]01            	cmp	word [count],1 
 42021 00004261 720F                    	jb	short nochar ; cf=1 ([count] = 0)
 42022                                  	
 42023 00004263 8B36[5A03]              	mov	si,[chrptr]
 42024 00004267 268A04                  	mov	al,[es:si]
 42025 0000426A FF0E[5603]              	dec	word [count]
 42026 0000426E FF06[5A03]              	inc	word [chrptr]
 42027                                  	; 12/12/202
 42028                                  	; cf=0
 42029                                  	;clc
 42030                                  ;get_ret:
 42031                                  	;pop	cx
 42032                                  	;retn
 42033                                  nochar: 
 42034                                  	; 12/12/2022
 42035                                  	; cf=1
 42036                                  	;stc
 42037                                  	;jmp	short get_ret
 42038                                  	
 42039 00004272 C3                      	retn
 42040                                  %endif
 42041                                  
 42042                                  ;----------------------------------------------------------------------------
 42043                                  ; 
 42044                                  ; procedure : mapcase
 42045                                  ;
 42046                                  ;----------------------------------------------------------------------------
 42047                                  
 42048                                  	; 02/11/2022 - Retro DOS 4.0 (Modified MSDOS 5.0 IO.SYS)
 42049                                  
 42050                                  	; 04/01/2023 - Retro DOS 4.2 (Modified MSDOS 6.21 IO.SYS)
 42051                                  	; (SYSINIT:4C7Eh)
 42052                                  mapcase:
 42053 00004273 51                      	push	cx
 42054 00004274 56                      	push	si
 42055 00004275 1E                      	push	ds
 42056                                  
 42057 00004276 06                      	push	es
 42058 00004277 1F                      	pop	ds
 42059                                  
 42060                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42061                                  
 42062                                  ; 04/01/2023 - Retro DOS 4.2
 42063                                  
 42064                                  ;ifdef	MULTI_CONFIG
 42065 00004278 88C3                    	mov	bl,al			; same cmd code this line
 42066                                  ;else
 42067                                  ;	xor	si,si
 42068                                  ;endif
 42069                                  	; 02/11/2022
 42070                                  	; 04/01/2023 - Retro DOS 4.2
 42071                                  	;xor	si, si
 42072                                  
 42073                                  convloop:
 42074 0000427A AC                      	lodsb
 42075 0000427B 3C61                    	cmp	al,'a'
 42076 0000427D 7209                    	jb	short noconv
 42077 0000427F 3C7A                    	cmp	al,'z'
 42078 00004281 7705                    	ja	short noconv
 42079 00004283 2C20                    	sub	al,20h
 42080 00004285 8844FF                  	mov	[si-1],al
 42081                                  noconv:
 42082                                  
 42083                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42084                                  
 42085                                  ; 04/01/2023 - Retro DOS 4.2
 42086                                  ;ifdef	MULTI_CONFIG
 42087                                  
 42088                                  ;   When MULTI_CONFIG enabled, "mapcase" is used to map everything to
 42089                                  ;   upper-case a line at a time, after we've been able to figure out whether
 42090                                  ;   the line is a SET command or not (since we don't want to upper-case
 42091                                  ;   anything after the "=" in a SET)
 42092                                  ;
 42093 00004288 80FB56                  	cmp	bl,CONFIG_SET  ; 'V'	; preserve case for part of the line?
 42094 0000428B 7504                    	jne	short check_eol		; no, just check for end-of-line
 42095 0000428D 3C3D                    	cmp	al,'='                  ; separator between SET var and value?
 42096 0000428F 740A                    	je	short convdone		; yes
 42097                                  check_eol:
 42098 00004291 3C0D                    	cmp	al,cr
 42099 00004293 7406                    	je	short convdone
 42100 00004295 3C0A                    	cmp	al,lf
 42101 00004297 7402                    	je	short convdone
 42102                                  ;endif
 42103                                  	; 02/11/2022
 42104 00004299 E2DF                    	loop	convloop
 42105                                  convdone:
 42106 0000429B 1F                      	pop	ds
 42107 0000429C 5E                      	pop	si
 42108 0000429D 59                      	pop	cx
 42109 0000429E C3                      	retn
 42110                                  
 42111                                  ;----------------------------------------------------------------------------
 42112                                  ;
 42113                                  ; procedure : round
 42114                                  ;
 42115                                  ; round the values in memlo and memhi to paragraph boundary.
 42116                                  ; perform bounds check.
 42117                                  ;
 42118                                  ;----------------------------------------------------------------------------
 42119                                  
 42120                                  round:
 42121                                  	; 10/09/2023 - Retro DOS v4.2 IO.SYS (Optimization)
 42122 0000429F 1E                      	push	ds
 42123 000042A0 0E                      	push	cs
 42124 000042A1 1F                      	pop	ds
 42125                                  
 42126 000042A2 50                      	push	ax
 42127                                  	;mov	ax,[cs:memlo]
 42128 000042A3 A1[6203]                	mov	ax,[memlo]
 42129                                  
 42130 000042A6 E8D2CE                  	call	ParaRound		; para round up
 42131                                  
 42132                                  	;add	[cs:memhi],ax
 42133 000042A9 0106[6403]              	add	[memhi],ax
 42134                                  	;mov	word [cs:memlo],0
 42135 000042AD C706[6203]0000          	mov	word [memlo],0
 42136                                  	;mov	ax,[cs:memhi]		; ax = new memhi
 42137 000042B3 A1[6403]                	mov	ax,[memhi]
 42138                                  	;cmp	ax,[cs:ALLOCLIM]	; if new memhi >= alloclim, error
 42139 000042B6 3B06[A502]              	cmp	ax,[ALLOCLIM]
 42140                                  	;jae	short mem_err
 42141                                  	; 17/09/2023
 42142 000042BA 7322                    	jae	short mem_err2 ; ds = cs	
 42143                                  	;test	byte [cs:setdevmarkflag],for_devmark ; 2
 42144 000042BC F606[ED14]02            	test	byte [setdevmarkflag],for_devmark ; 2
 42145 000042C1 7416                    	jz	short skip_set_devmarksize
 42146 000042C3 06                      	push	es
 42147 000042C4 56                      	push	si
 42148                                  	;mov	si,[cs:devmark_addr]
 42149 000042C5 8B36[EB14]              	mov	si,[devmark_addr]
 42150 000042C9 8EC6                    	mov	es,si
 42151 000042CB 29F0                    	sub	ax,si
 42152 000042CD 48                      	dec	ax
 42153                                  	;mov	[es:3],ax
 42154 000042CE 26A30300                	mov	[es:devmark.size],ax	; paragraph
 42155                                  	;and	byte [cs:setdevmarkflag],not_for_devmark ; 0FDh
 42156 000042D2 8026[ED14]FD            	and	byte [setdevmarkflag],not_for_devmark ; 0FDh
 42157 000042D7 5E                      	pop	si
 42158 000042D8 07                      	pop	es
 42159                                  skip_set_devmarksize:
 42160 000042D9 58                      	pop	ax
 42161                                  
 42162                                  	; 10/09/2023
 42163 000042DA 1F                      	pop	ds
 42164                                  
 42165                                  	; 11/12/2022
 42166                                  	; cf = 0
 42167                                  	; 02/11/2022
 42168                                  	;clc	; ? (not needed here)	; clear carry
 42169 000042DB C3                      	retn
 42170                                  
 42171                                  ;----------------------------------------------------------------------------
 42172                                  
 42173                                  mem_err:
 42174                                  	; 11/12/2022
 42175 000042DC 0E                      	push	cs
 42176 000042DD 1F                      	pop	ds
 42177                                  mem_err2:
 42178 000042DE BA[254B]                	mov	dx,badmem
 42179                                  	;push	cs
 42180                                  	;pop	ds
 42181 000042E1 E81D02                  	call	print
 42182 000042E4 E9CDCE                  	jmp	stall
 42183                                  
 42184                                  ;----------------------------------------------------------------------------
 42185                                  ;
 42186                                  ; procedure : calldev
 42187                                  ;
 42188                                  ;----------------------------------------------------------------------------
 42189                                  
 42190                                  	; 02/11/2022 - Retrodos v4.0 (Modified MSDOS 5.0 IO.SYS)
 42191                                  	; (SYSINIT:34E0h)
 42192                                  calldev:
 42193 000042E7 2E8E1E[951F]            	mov	ds,[cs:DevEntry+2]
 42194 000042EC 2E031E[931F]            	add	bx,[cs:DevEntry]	; do a little relocation
 42195 000042F1 8B07                    	mov	ax,[bx]
 42196                                  
 42197 000042F3 2EFF36[931F]            	push	word [cs:DevEntry]
 42198 000042F8 2EA3[931F]              	mov	[cs:DevEntry],ax
 42199 000042FC BB[6F03]                	mov	bx,packet
 42200 000042FF 2EFF1E[931F]            	call	far [cs:DevEntry]
 42201 00004304 2E8F06[931F]            	pop	word [cs:DevEntry]
 42202 00004309 C3                      	retn
 42203                                  
 42204                                  ;----------------------------------------------------------------------------
 42205                                  ;
 42206                                  ; procedure : todigit
 42207                                  ;
 42208                                  ;----------------------------------------------------------------------------
 42209                                  
 42210                                  todigit:
 42211 0000430A 2C30                    	sub	al,'0'
 42212                                  	;jb	short notdig  ; 02/11/2022
 42213                                  	; 12/12/2022
 42214 0000430C 7203                    	jb	short notdig2
 42215                                  	;cmp	al,9
 42216                                  	;ja	short notdig
 42217                                  	;clc
 42218                                  	;retn
 42219                                  	; 12/12/2022
 42220 0000430E 3C0A                    	cmp	al,10
 42221 00004310 F5                      	cmc
 42222                                  notdig:
 42223                                  	;stc
 42224                                  notdig2:
 42225 00004311 C3                      	retn
 42226                                  
 42227                                  ;----------------------------------------------------------------------------
 42228                                  ;
 42229                                  ; procedure : getnum
 42230                                  ;
 42231                                  ; getnum parses a decimal number.
 42232                                  ; returns it in ax, sets zero flag if ax = 0 (may be considered an
 42233                                  ; error), if number is bad carry is set, zero is set, ax=0.
 42234                                  ;
 42235                                  ;----------------------------------------------------------------------------
 42236                                  
 42237                                  getnum:
 42238 00004312 53                      	push	bx
 42239 00004313 31DB                    	xor	bx,bx			; running count is zero
 42240                                  b2:
 42241 00004315 E8F2FF                  	call	todigit 		; do we have a digit ?
 42242 00004318 7247                    	jc	short badnum		; no, bomb
 42243                                  
 42244 0000431A 93                      	xchg	ax,bx			; put total in ax
 42245 0000431B 53                      	push	bx			; save digit (0 to 9)
 42246                                  	;mov	bx,10			; base of arithmetic
 42247                                  	; 12/12/2022
 42248 0000431C B30A                    	mov	bl,10
 42249 0000431E F7E3                    	mul	bx			; shift by one decimal digit
 42250 00004320 5B                      	pop	bx			; get back digit (0 to 9)
 42251 00004321 00D8                    	add	al,bl			; get total
 42252 00004323 80D400                  	adc	ah,0			; make that 16 bits
 42253 00004326 7239                    	jc	short badnum		; too big a number
 42254                                  
 42255 00004328 93                      	xchg	ax,bx			; stash total
 42256                                  
 42257 00004329 E830FF                  	call	getchr			; get next digit
 42258 0000432C 722D                    	jc	short b1		; no more characters
 42259 0000432E 3C20                    	cmp	al,' ' 			; space?
 42260 00004330 741F                    	je	short b15		; then end of digits
 42261 00004332 3C2C                    	cmp	al,',' 			; ',' is a seperator!!!
 42262 00004334 741B                    	je	short b15		; then end of digits.
 42263 00004336 3C09                    	cmp	al, tab ; 9		; tab
 42264 00004338 7417                    	je	short b15
 42265 0000433A 2E3A06[AE02]            	cmp	al,[cs:sepchr]		; allow 0 or special separators
 42266 0000433F 7410                    	je	short b15
 42267 00004341 3C2F                    	cmp	al,'/'			; see if another switch follows
 42268                                  	; 12/12/2022
 42269                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42270                                  	;nop				; cas - remnant of old bad code
 42271                                  	;nop
 42272 00004343 740C                    	je	short b15
 42273 00004345 3C0A                    	cmp	al,lf			; line-feed?
 42274 00004347 7408                    	je	short b15
 42275 00004349 3C0D                    	cmp	al,cr			; carriage return?
 42276 0000434B 7404                    	je	short b15
 42277 0000434D 08C0                    	or	al,al			; end of line separator?
 42278 0000434F 75C4                    	jnz	short b2		; no, try as a valid char...
 42279                                  b15:
 42280 00004351 2EFF06[5603]            	inc	word [cs:count]		; one more character to s...
 42281 00004356 2EFF0E[5A03]            	dec	word [cs:chrptr]	; back up over separator
 42282                                  b1:
 42283 0000435B 89D8                    	mov	ax,bx			; get proper count
 42284 0000435D 09C0                    	or	ax,ax			; clears carry, sets zero accordingly
 42285 0000435F 5B                      	pop	bx
 42286 00004360 C3                      	retn
 42287                                  badnum:
 42288                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42289                                  	;mov	byte [cs:sepchr],0
 42290 00004361 31C0                    	xor	ax,ax			; set zero flag, and ax = 0
 42291                                  	; 12 /12/2022
 42292 00004363 2EA2[AE02]              	mov	[cs:sepchr],al ; 0
 42293 00004367 5B                      	pop	bx
 42294 00004368 F9                      	stc				; and carry set
 42295 00004369 C3                      	retn
 42296                                  
 42297                                  ;****************************************************************************
 42298                                  
 42299                                  setdoscountryinfo:
 42300                                  
 42301                                  ;----------------------------------------------------------------------------
 42302                                  ;input: es:di -> pointer to dos_country_cdpg_info
 42303                                  ;	ds:0  -> buffer.
 42304                                  ;	si = 0
 42305                                  ;	ax = country id
 42306                                  ;	dx = code page id. (if 0, then use ccsyscodepage as a default.)
 42307                                  ;	bx = file handle
 42308                                  ;	this routine can handle maximum 438 country_data entries.
 42309                                  ;
 42310                                  ;output: dos_country_cdpg_info set.
 42311                                  ;	 carry set if any file read failure or wrong information in the file.
 42312                                  ;	 carry set and cx = -1 if cannot find the matching country_id, 
 42313                                  ;	 codepage_id in the file.
 42314                                  ;----------------------------------------------------------------------------
 42315                                  
 42316                                  	; 04/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 42317                                  	; (SYSINIT:4D83h)
 42318                                  
 42319                                  	; 10/09/2023 - Retrodos v4.2 IO.SYS (Optimization)
 42320                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:4FCAh)
 42321                                  
 42322 0000436A 57                      	push	di
 42323 0000436B 50                      	push	ax
 42324 0000436C 52                      	push	dx
 42325                                  
 42326 0000436D 31C9                    	xor	cx,cx
 42327 0000436F 31D2                    	xor	dx,dx
 42328 00004371 B80002                  	mov	ax,512			;read 512 bytes
 42329 00004374 E84301                  	call	readincontrolbuffer	;read the file header
 42330 00004377 724A                    	jc	short setdosdata_fail
 42331                                  
 42332 00004379 06                      	push	es
 42333 0000437A 56                      	push	si
 42334                                  
 42335 0000437B 0E                      	push	cs
 42336 0000437C 07                      	pop	es
 42337                                  
 42338 0000437D BF[CD45]                	mov	di,country_file_signature ; db 0FFh,'COUNTRY'
 42339 00004380 B90800                  	mov	cx,8			;length of the signature
 42340 00004383 F3A6                    	repz	cmpsb
 42341                                  
 42342 00004385 5E                      	pop	si
 42343 00004386 07                      	pop	es
 42344 00004387 753A                    	jnz	short setdosdata_fail 	;signature mismatch
 42345                                  
 42346 00004389 83C612                  	add	si,18			;si -> county info type
 42347 0000438C 803C01                  	cmp	byte [si],1		;only accept type 1 (currently only 1 header type)
 42348 0000438F 7532                    	jne	short setdosdata_fail 	;cannot proceed. error return
 42349                                  
 42350 00004391 46                      	inc	si			;si -> file offset
 42351 00004392 8B14                    	mov	dx,[si]			;get the info file offset.
 42352 00004394 8B4C02                  	mov	cx,[si+2]
 42353 00004397 B80018                  	mov	ax,6144			;read 6144 bytes.
 42354 0000439A E81D01                  	call	readincontrolbuffer	;read info
 42355 0000439D 7224                    	jc	short setdosdata_fail
 42356                                  
 42357 0000439F 8B0C                    	mov	cx,[si]			;get the # of country, codepage combination entries
 42358 000043A1 81F9B601                	cmp	cx,438			;cannot handle more than 438 entries.
 42359 000043A5 771C                    	ja	short setdosdata_fail
 42360                                  
 42361 000043A7 46                      	inc	si
 42362 000043A8 46                      	inc	si			;si -> entry information packet
 42363 000043A9 5A                      	pop	dx			;restore code page id
 42364 000043AA 58                      	pop	ax			;restore country id
 42365 000043AB 5F                      	pop	di
 42366                                  
 42367                                  setdoscntry_find:			;search for desired country_id,codepage_id.
 42368 000043AC 3B4402                  	cmp	ax,[si+2]		;compare country_id
 42369 000043AF 7509                    	jne	short setdoscntry_next
 42370                                  
 42371                                  	;cmp	dx,0			;no user specified code page ?
 42372                                  	;je	short setdoscntry_any_codepage ;then no need to match code page id.
 42373                                  	; 10/09/2023
 42374 000043B1 09D2                    	or	dx,dx ; cmp dx,0
 42375 000043B3 7413                    	jz	short setdoscntry_any_codepage
 42376 000043B5 3B5404                  	cmp	dx,[si+4]		;compare code page id
 42377 000043B8 7411                    	je	short setdoscntry_got_it
 42378                                  
 42379                                  setdoscntry_next:
 42380 000043BA 0334                    	add	si,[si]			;next entry
 42381 000043BC 46                      	inc	si
 42382 000043BD 46                      	inc	si			;take a word for size of entry itself
 42383 000043BE E2EC                    	loop	setdoscntry_find
 42384                                  
 42385                                  	;mov	cx,-1			;signals that bad country id entered.
 42386                                  	; 10/09/2023
 42387 000043C0 49                      	dec	cx ; 0 -> -1
 42388                                  setdoscntry_fail:
 42389 000043C1 F9                      	stc
 42390 000043C2 C3                      	retn
 42391                                  
 42392                                  setdosdata_fail:
 42393 000043C3 5E                      	pop	si
 42394 000043C4 59                      	pop	cx
 42395 000043C5 5F                      	pop	di
 42396 000043C6 EBF9                    	jmp	short setdoscntry_fail
 42397                                  
 42398                                  setdoscntry_any_codepage:		;use the code_page_id of the country_id found.
 42399 000043C8 8B5404                  	mov	dx,[si+4]
 42400                                  
 42401                                  setdoscntry_got_it:			;found the matching entry
 42402 000043CB 2E8916[D545]            	mov	[cs:cntrycodepage_id],dx ;save code page id for this country.
 42403 000043D0 8B540A                  	mov	dx,[si+10]		;get the file offset of country data
 42404 000043D3 8B4C0C                  	mov	cx,[si+12]
 42405 000043D6 B80002                  	mov	ax,512 			;read 512 bytes
 42406 000043D9 E8DE00                  	call	readincontrolbuffer
 42407 000043DC 72E3                    	jc	short setdoscntry_fail
 42408                                  
 42409 000043DE 8B0C                    	mov	cx,[si]			;get the number of entries to handle.
 42410 000043E0 46                      	inc	si
 42411 000043E1 46                      	inc	si			;si -> first entry
 42412                                  
 42413                                  setdoscntry_data:
 42414 000043E2 57                      	push	di			;es:di -> dos_country_cdpg_info
 42415 000043E3 51                      	push	cx			;save # of entry left
 42416 000043E4 56                      	push	si			;si -> current entry in control buffer
 42417                                  
 42418 000043E5 8A4402                  	mov	al,[si+2]		;get data entry id
 42419 000043E8 E8A400                  	call	getcountrydestination	;get the address of destination in es:di
 42420 000043EB 727C                    	jc	short setdoscntry_data_next ;no matching data entry id in dos
 42421                                  
 42422 000043ED 8B5404                  	mov	dx,[si+4]		;get offset of data
 42423 000043F0 8B4C06                  	mov	cx,[si+6]
 42424 000043F3 B80042                  	mov	ax,4200h
 42425 000043F6 F9                      	stc
 42426 000043F7 CD21                    	int	21h			;move pointer
 42427 000043F9 72C8                    	jc	short setdosdata_fail
 42428                                  
 42429 000043FB BA0002                  	mov	dx,512			;start of data buffer
 42430 000043FE B91400                  	mov	cx,20			;read 20 bytes only. we only need to
 42431 00004401 B43F                    	mov	ah,3Fh			;look at the length of the data in the file.
 42432 00004403 F9                      	stc
 42433 00004404 CD21                    	int	21h			;read the country.sys data
 42434 00004406 72BB                    	jc	short setdosdata_fail 	;read failure
 42435                                  
 42436 00004408 39C8                    	cmp	ax,cx
 42437 0000440A 75B7                    	jne	short setdosdata_fail ; 13/05/2019
 42438                                  
 42439 0000440C 8B5404                  	mov	dx,[si+4]		;get offset of data again.
 42440 0000440F 8B4C06                  	mov	cx,[si+6]
 42441 00004412 B80042                  	mov	ax,4200h
 42442 00004415 F9                      	stc
 42443 00004416 CD21                    	int	21h			;move pointer back again
 42444 00004418 72A9                    	jc	short setdosdata_fail
 42445                                  
 42446 0000441A 56                      	push	si
 42447 0000441B BE0802                  	mov	si,(512+8)		;get length of the data from the file
 42448 0000441E 8B0C                    	mov	cx,[si]
 42449 00004420 5E                      	pop	si
 42450 00004421 BA0002                  	mov	dx,512			;start of data buffer
 42451 00004424 83C10A                  	add	cx,10			;signature + a word for the length itself
 42452 00004427 B43F                    	mov	ah,3Fh			;read the data from the file.
 42453 00004429 F9                      	stc
 42454 0000442A CD21                    	int	21h
 42455 0000442C 7295                    	jc	short setdosdata_fail
 42456                                  
 42457 0000442E 39C8                    	cmp	ax,cx
 42458 00004430 7591                    	jne	short setdosdata_fail
 42459                                  
 42460 00004432 8A4402                  	mov	al,[si+2]		;save data id for future use.
 42461 00004435 BE0802                  	mov	si,(512+8)		;si-> data buffer + id tag field
 42462 00004438 8B0C                    	mov	cx,[si]			;get the length of the file
 42463 0000443A 41                      	inc	cx			;take care of a word for lenght of tab
 42464 0000443B 41                      	inc	cx			;itself.
 42465 0000443C 81F9F805                	cmp	cx,(2048-512-8)	; 1528	;fit into the buffer?
 42466 00004440 7781                    	ja	short setdosdata_fail
 42467                                  
 42468                                  	;if	bugfix
 42469 00004442 E83100                  	call	setdbcs_before_copy
 42470                                  	;endif
 42471                                  
 42472 00004445 3C01                    	cmp	al,SetCountryInfo ; 1	;is the data for setcountryinfo table?
 42473 00004447 7511                    	jne	short setdoscntry_mov 	;no, don't worry
 42474                                  
 42475 00004449 26FF7518                	push	word [es:di+country_cdpg_info.ccMono_Ptr-country_cdpg_info.ccCountryInfoLen]  
 42476                                  	;push	word [es:di+24]		;cannot destroy ccmono_ptr address. save them.
 42477 0000444D 26FF751A                	push	word [es:di+country_cdpg_info.ccMono_Ptr-country_cdpg_info.ccCountryInfoLen+2] 
 42478                                  	;push	word [es:di+26]		;at this time di -> cccountryinfolen
 42479                                  	
 42480 00004451 57                      	push	di			;save di
 42481                                  
 42482                                  	;push	ax
 42483                                  	;mov	ax,[cs:cntrycodepage_id] ;do not use the code page info in country_info
 42484                                  	;mov	[si+4],ax		;use the saved one for this !!!!
 42485                                  	;pop	ax
 42486                                  	; 10/09/2023
 42487 00004452 2EFF36[D545]            	push	word [cs:cntrycodepage_id]
 42488 00004457 8F4404                  	pop	word [si+4]
 42489                                  
 42490                                  setdoscntry_mov:
 42491 0000445A F3A4                    	rep	movsb			;copy the table into dos
 42492 0000445C 3C01                    	cmp	al,SetCountryInfo	;was the ccmono_ptr saved?
 42493 0000445E 7509                    	jne	short setdoscntry_data_next
 42494                                  
 42495 00004460 5F                      	pop	di			;restore di
 42496 00004461 268F451A                	pop	word [es:di+country_cdpg_info.ccMono_Ptr-country_cdpg_info.ccCountryInfoLen+2]
 42497                                  	;pop	word [es:di+26]		;restore
 42498 00004465 268F4518                	pop	word [es:di+country_cdpg_info.ccMono_Ptr-country_cdpg_info.ccCountryInfoLen] 
 42499                                  	;pop	word [es:di+24]
 42500                                  
 42501                                  setdoscntry_data_next:
 42502 00004469 5E                      	pop	si			;restore control buffer pointer
 42503 0000446A 59                      	pop	cx			;restore # of entries left
 42504 0000446B 5F                      	pop	di			;restore pointer to dso_country_cdpg
 42505 0000446C 0334                    	add	si,[si]			;try to get the next entry
 42506 0000446E 46                      	inc	si
 42507 0000446F 46                      	inc	si			;take a word of entry length itself
 42508 00004470 49                      	dec	cx
 42509                                  	; 10/09/2023
 42510 00004471 741B                    	jz	short setdoscntry_ok 
 42511                                  	;cmp	cx,0
 42512                                  	;je	short setdoscntry_ok
 42513 00004473 E96CFF                  	jmp	setdoscntry_data
 42514                                  
 42515                                  	; 18/12/2022
 42516                                  ;setdoscntry_ok:
 42517                                  	;retn
 42518                                  
 42519                                  ;----------------------------------------------------------------------------
 42520                                  
 42521                                  	;if	bugfix
 42522                                  
 42523                                  	; 10/09/2023 - Retrodos v4.2 IO.SYS (Optimization)
 42524                                  
 42525                                  setdbcs_before_copy:
 42526 00004476 3C07                    	cmp	al,SetDBCS ; 7		; dbcs vector set?
 42527 00004478 7514                    	jne	short sdbcsbc		; jump if not
 42528                                  	
 42529                                  	; 10/09/2023
 42530 0000447A 50                      	push	ax
 42531 0000447B 31C0                    	xor	ax,ax
 42532 0000447D 263905                  	cmp	[es:di],ax ; 0
 42533 00004480 740B                    	je	short sdbcsbc_pop
 42534                                  	
 42535                                  	;cmp	word [es:di],0		; zero byte data block?
 42536                                  	;je	short sdbcsbc		; jump if so
 42537                                  
 42538 00004482 57                      	push	di
 42539                                  	; 10/09/2023
 42540                                  	;push	ax
 42541 00004483 51                      	push	cx
 42542 00004484 268B0D                  	mov	cx,[es:di]		; load block length
 42543                                  	;add	di,2			; points actual data
 42544 00004487 47                      	inc	di
 42545 00004488 47                      	inc	di
 42546                                  	;xor	al,al			; fill bytes
 42547 00004489 F3AA                    	rep	stosb			; clear data block
 42548 0000448B 59                      	pop	cx
 42549                                  	;pop	ax
 42550 0000448C 5F                      	pop	di
 42551                                  
 42552                                  sdbcsbc_pop:	; 10/09/2023
 42553 0000448D 58                      	pop	ax
 42554                                  sdbcsbc:
 42555                                  setdoscntry_ok:	; 18/12/2022
 42556 0000448E C3                      	retn
 42557                                  
 42558                                  	;endif
 42559                                  
 42560                                  ;----------------------------------------------------------------------------
 42561                                  
 42562                                  getcountrydestination:
 42563                                  
 42564                                  ;----------------------------------------------------------------------------
 42565                                  ;get the destination address in the dos country info table.
 42566                                  ;
 42567                                  ;input: al - data id
 42568                                  ;	es:di -> dos_country_cdpg_info
 42569                                  ;on return:
 42570                                  ;	es:di -> destination address of the matching data id
 42571                                  ;	carry set if no matching data id found in dos.
 42572                                  ;----------------------------------------------------------------------------
 42573                                  
 42574                                  	; 04/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 42575                                  	; (SYSINIT:4EB2h)
 42576                                  
 42577                                  	; 10/09/2023 - Retrodos v4.2 IO.SYS (Optimization)
 42578                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:50F9h)
 42579                                  
 42580 0000448F 51                      	push	cx
 42581                                  	;add	di,74
 42582 00004490 83C74A                  	add	di,country_cdpg_info.ccNumber_of_entries	
 42583                                  					;skip the reserved area, syscodepage etc.
 42584 00004493 268B0D                  	mov	cx,[es:di]		;get the number of entries
 42585 00004496 47                      	inc	di
 42586 00004497 47                      	inc	di			;si -> the first start entry id
 42587                                  
 42588                                  getcntrydest:
 42589 00004498 263805                  	cmp	byte [es:di],al
 42590 0000449B 7413                    	je	short getcntrydest_ok
 42591                                  
 42592 0000449D 26803D01                	cmp	byte [es:di],SetCountryInfo ;was it setcountryinfo entry?
 42593 000044A1 7405                    	je	short getcntrydest_1
 42594                                  
 42595 000044A3 83C705                  	add	di,5			;next data id
 42596 000044A6 EB03                    	jmp	short getcntrydest_loop
 42597                                  
 42598                                  getcntrydest_1:
 42599                                  	;add	di,41
 42600 000044A8 83C729                  	add	di,NEW_COUNTRY_SIZE+3	;next data id
 42601                                  getcntrydest_loop:
 42602 000044AB E2EB                    	loop	getcntrydest
 42603 000044AD F9                      	stc
 42604                                  	;jmp	short getcntrydest_exit
 42605                                  getcntrydest_exit:
 42606                                  	; 10/09/2023
 42607 000044AE 59                      	pop	cx
 42608 000044AF C3                      	retn
 42609                                  
 42610                                  getcntrydest_ok:
 42611                                  	; 10/09/2023
 42612 000044B0 47                      	inc	di
 42613                                  
 42614                                  ;	cmp	al,SetCountryInfo ; 1	;select country info?
 42615                                  ;	jne	short getcntrydest_ok1
 42616                                  ;
 42617                                  ;	;inc	di			;now di -> cccountryinfolen
 42618                                  ;	jmp	short getcntrydest_exit
 42619                                  
 42620                                  	; 10/09/2023
 42621 000044B1 3C01                    	cmp	al,SetCountryInfo ; 1	;select country info?
 42622 000044B3 74F9                    	je	short getcntrydest_exit
 42623                                  
 42624                                  getcntrydest_ok1:
 42625                                  	;les	di,[es:di+1]		;get the destination in es:di
 42626                                  	; 10/09/2023
 42627 000044B5 26C43D                  	les	di,[es:di]
 42628                                  ;getcntrydest_exit:
 42629 000044B8 59                      	pop	cx
 42630 000044B9 C3                      	retn
 42631                                  
 42632                                  ;----------------------------------------------------------------------------
 42633                                  
 42634                                  readincontrolbuffer:
 42635                                  
 42636                                  ;----------------------------------------------------------------------------
 42637                                  ;move file pointer to cx:dx
 42638                                  ;read ax bytes into the control buffer. (should be less than 2 kb)
 42639                                  ;si will be set to 0 hence ds:si points to the control buffer.
 42640                                  ;
 42641                                  ;entry:  cx,dx offset from the start of the file where the read/write pointer
 42642                                  ;	 be moved.
 42643                                  ;	 ax - # of bytes to read
 42644                                  ;	 bx - file handle
 42645                                  ;	 ds - buffer seg.
 42646                                  ;return: the control data information is read into ds:0 - ds:0200.
 42647                                  ;	 cx,dx value destroyed.
 42648                                  ;	 carry set if error in reading file.
 42649                                  ;----------------------------------------------------------------------------
 42650                                  
 42651 000044BA 50                      	push	ax			;# of bytes to read
 42652 000044BB B80042                  	mov	ax,4200h
 42653 000044BE F9                      	stc
 42654 000044BF CD21                    	int	21h			;move pointer
 42655 000044C1 59                      	pop	cx			;# of bytes to read
 42656 000044C2 7209                    	jc	short ricb_exit
 42657                                  
 42658 000044C4 31D2                    	xor	dx,dx			;ds:dx -> control buffer
 42659 000044C6 31F6                    	xor	si,si
 42660 000044C8 B43F                    	mov	ah,3Fh			;read into the buffer
 42661 000044CA F9                      	stc
 42662 000044CB CD21                    	int	21h			;should be less than 1024 bytes.
 42663                                  ricb_exit:
 42664 000044CD C3                      	retn
 42665                                  
 42666                                  ;----------------------------------------------------------------------------
 42667                                  
 42668                                  ;! set_country_path procedure is not called from anywhere !
 42669                                  ; Erdogan Tan - 04/08/2023
 42670                                  %if 0
 42671                                  
 42672                                  set_country_path:
 42673                                  
 42674                                  ;----------------------------------------------------------------------------
 42675                                  ;in:  ds - sysinitseg, es - confbot, si -> start of the asciiz path string
 42676                                  ;     dosinfo_ext, cntry_drv, cntry_root, cntry_path
 42677                                  ;     assumes current directory is the root directory.
 42678                                  ;out: ds:di -> full path (cntry_drv).
 42679                                  ;     set the cntry_drv string from the country=,,path command.
 42680                                  ;     ds, es, si value saved.
 42681                                  ;----------------------------------------------------------------------------
 42682                                  
 42683                                  	; 04/01/2023 - Retrodos v4.2 (Modified MSDOS 6.21 IO.SYS)
 42684                                  	; (SYSINIT:4EF4h)
 42685                                  
 42686                                  	; 10/09/2023 - Retrodos v4.2 IO.SYS (Optimization)
 42687                                  	; (Retrodos v5.0 Pre-Works)
 42688                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:513Bh)
 42689                                  
 42690                                  	push	si
 42691                                  
 42692                                  	push	ds			;switch ds, es
 42693                                  	push	es
 42694                                  	pop	ds
 42695                                  	pop	es			;now ds -> confbot, es -> sysinitseg
 42696                                  
 42697                                  	call	chk_drive_letter	;current ds:[si] is a drive letter?
 42698                                  	jc	short scp_default_drv 	;no, use current default drive.
 42699                                  
 42700                                  	mov	al,[si]
 42701                                  	inc	si
 42702                                  	inc	si			;si -> next char after ":"
 42703                                  	jmp	short scp_setdrv
 42704                                  
 42705                                  scp_default_drv:
 42706                                  	mov	ah,19h
 42707                                  	int	21h
 42708                                  	add	al,"A"			;convert it to a character.
 42709                                  
 42710                                  scp_setdrv:
 42711                                  	mov	[cs:cntry_drv],al	;set the drive letter.
 42712                                  	mov	di,cntry_path
 42713                                  	mov	al,[si]
 42714                                  	cmp	al, "\"
 42715                                  	je	short scp_root_dir
 42716                                  
 42717                                  	cmp	al,"/"			;let's accept "/" as an directory delim
 42718                                  	;je	short scp_root_dir
 42719                                  	;jmp	short scp_path
 42720                                  	; 04/01/2023
 42721                                  	jne	short scp_path
 42722                                  
 42723                                  scp_root_dir:
 42724                                  	dec	di			;di -> cntry_root
 42725                                  scp_path:
 42726                                  	call	move_asciiz		;copy it
 42727                                  
 42728                                  	mov	di,cntry_drv
 42729                                  scpath_exit:
 42730                                  
 42731                                  	push	ds			;switch ds, es
 42732                                  	push	es
 42733                                  	pop	ds
 42734                                  	pop	es			;ds, es value restored
 42735                                  
 42736                                  	pop	si
 42737                                  	retn
 42738                                  
 42739                                  ;----------------------------------------------------------------------------
 42740                                  
 42741                                  chk_drive_letter:
 42742                                  
 42743                                  ;check if ds:[si] is a drive letter followed by ":".
 42744                                  ;assume that every alpha character is already converted to upper case.
 42745                                  ;carry set if not.
 42746                                  
 42747                                  	; 04/01/2023 - Retrodos v4.2
 42748                                  
 42749                                  	push	ax
 42750                                  	cmp	byte [si],"A"
 42751                                  	;jb	short cdletter_no
 42752                                  	jb	short cdletter_exit
 42753                                  	cmp	byte [si],"Z"
 42754                                  	ja	short cdletter_no
 42755                                  	cmp	byte [si+1],":"
 42756                                  	;jne	short cdletter_no
 42757                                  	;jmp	short cdletter_exit
 42758                                  	; 04/01/2023
 42759                                  	je	short cdletter_exit
 42760                                  
 42761                                  cdletter_no:
 42762                                  	stc
 42763                                  cdletter_exit:
 42764                                  	pop	ax
 42765                                  	retn
 42766                                  
 42767                                  %endif
 42768                                  
 42769                                  ;----------------------------------------------------------------------------
 42770                                  
 42771                                  move_asciiz:
 42772                                  
 42773                                  ;in: ds:si -> source es:di -> target
 42774                                  ;out: copy the string until 0.
 42775                                  ;assumes there exists a 0.
 42776                                  
 42777                                  	; 10/09/2023 - Retrodos v4.2 IO.SYS (Optimization)
 42778                                  	; (MSDOS 6.21 IO.SYS - SYSINIT:4F40h)
 42779                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:5187h)
 42780                                  
 42781                                  masciiz_loop:
 42782                                  	; 10/09/2023
 42783 000044CE F604FF                  	test	byte [si],0FFh
 42784 000044D1 A4                      	movsb
 42785                                  	;cmp	byte [si-1],0	; was it 0?
 42786                                  	;jne	short masciiz_loop
 42787 000044D2 75FA                    	jnz	short masciiz_loop ; 10/09/2023
 42788 000044D4 C3                      	retn
 42789                                  
 42790                                  ;----------------------------------------------------------------------------
 42791                                  
 42792                                  ;	ds:dx points to string to output (asciz)
 42793                                  ;
 42794                                  ;	prints <badld_pre> <string> <badld_post>
 42795                                  
 42796                                  badfil:
 42797 000044D5 0E                      	push	cs
 42798 000044D6 07                      	pop	es
 42799                                  
 42800 000044D7 89D6                    	mov	si,dx
 42801                                  badload:
 42802 000044D9 BA[8F4A]                	mov	dx,badld_pre	; want to print config error
 42803 000044DC BB[4C4A]                	mov	bx,crlfm
 42804                                  prnerr:
 42805 000044DF 0E                      	push	cs
 42806 000044E0 1F                      	pop	ds ; *
 42807 000044E1 E81D00                  	call	print
 42808                                  prn1:
 42809 000044E4 268A14                  	mov	dl,[es:si]
 42810 000044E7 08D2                    	or	dl,dl
 42811 000044E9 7407                    	jz	short prn2
 42812 000044EB B402                    	mov	ah,STD_CON_OUTPUT ; 2 
 42813 000044ED CD21                    	int	21h
 42814 000044EF 46                      	inc	si
 42815 000044F0 EBF2                    	jmp	short prn1
 42816                                  prn2:
 42817 000044F2 89DA                    	mov	dx,bx
 42818 000044F4 E80A00                  	call	print
 42819                                  	; 11/12/2022
 42820                                  	; ds = cs ; *
 42821 000044F7 803E[5503]01            	cmp	byte [donotshownum],1
 42822                                  				; suppress line number when handling command.com
 42823                                  	;cmp	byte [cs:donotshownum],1 
 42824 000044FC 7407                    	je	short prnexit
 42825                                  	
 42826                                  	; 18/12/2022
 42827                                  	;call	error_line
 42828 000044FE E966E4                  	jmp	error_line
 42829                                  ;prnexit:
 42830                                  	;retn
 42831                                  
 42832                                  ;----------------------------------------------------------------------------
 42833                                  
 42834                                  print:
 42835 00004501 B409                    	mov	ah,STD_CON_STRING_OUTPUT ; 9
 42836 00004503 CD21                    	int	21h
 42837                                  prnexit:	; 18/12/2022
 42838 00004505 C3                      	retn
 42839                                  
 42840                                  ;----------------------------------------------------------------------------
 42841                                  
 42842                                  ;  open device pointed to by dx, al has access code
 42843                                  ;   if unable to open do a device open null device instead
 42844                                  
 42845                                  	; 02/11/2022 - Retrodos v4.0 (Modified MSDOS 5.0 IO.SYS)
 42846                                  	; (SYSINIT:3764h)
 42847                                  open_dev:
 42848 00004506 E80500                  	call	open_file
 42849 00004509 7309                    	jnc	short open_dev3
 42850                                  
 42851                                  open_dev1:
 42852 0000450B BA[6E45]                	mov	dx,nuldev
 42853                                  	; 18/12/2022
 42854                                  	;call	open_file
 42855                                  ;of_retn:
 42856                                  	;retn
 42857                                  	; 18/12/2022
 42858                                  	;jmp	short open_file
 42859                                  open_file:
 42860 0000450E B43D                    	mov	ah,OPEN	; 3Dh
 42861 00004510 F9                      	stc
 42862 00004511 CD21                    	int	21h
 42863                                  of_retn:	; 18/12/2022
 42864 00004513 C3                      	retn
 42865                                  
 42866                                  open_dev3:
 42867 00004514 89C3                    	mov	bx,ax			; handle from open to bx
 42868                                  	;;xor	ax,ax			; get device info
 42869                                  	;;mov	ah,IOCTL ; 44h
 42870                                  	;mov	ax,(IOCTL<<8) ; 13/05/2019
 42871                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42872                                  	;xor	ax,ax
 42873                                  	;mov	ah,44h	; IOCTL
 42874                                  	; 11/12/2022
 42875 00004516 B80044                  	mov	ax,4400h ; IOCTL<<8 
 42876                                  
 42877 00004519 CD21                    	int	21h
 42878                                  
 42879 0000451B F6C280                  	test	dl,10000000b ; 80h
 42880 0000451E 75F3                    	jnz	short of_retn
 42881                                  
 42882 00004520 B43E                    	mov	ah,CLOSE ; 3Eh
 42883 00004522 CD21                    	int	21h
 42884 00004524 EBE5                    	jmp	short open_dev1
 42885                                  
 42886                                  ;----------------------------------------------------------------------------
 42887                                  
 42888                                  ; 18/12/2022
 42889                                  %if 0
 42890                                  open_file:
 42891                                  	mov	ah,OPEN	; 3Dh
 42892                                  	stc
 42893                                  	int	21h
 42894                                  	retn
 42895                                  %endif
 42896                                  
 42897                                  ;----------------------------------------------------------------------------
 42898                                  
 42899                                  ; test int24. return back to dos with the fake user response of "fail"
 42900                                  
 42901                                  int24:
 42902 00004526 B003                    	mov	al,3			; fail the system call
 42903 00004528 CF                      	iret				; return back to dos.
 42904                                  
 42905                                  ; 19/04/2019 - Retro DOS v4.0
 42906                                  
 42907                                  ;----------------------------------------------------------------------------
 42908                                  ; DATA
 42909                                  ;----------------------------------------------------------------------------
 42910                                  
 42911                                  ;include copyrigh.inc			; copyright statement
 42912                                  
 42913                                  ; MSDOS 6.21 IO.SYS - SYSINIT:4FA3h
 42914                                  
 42915                                  ;MsDosVersion6Copyr:
 42916                                  ;	db	'MS DOS Version 6 (C)Copyright 1981-1993 Microsoft Corp '
 42917                                  ;	db	'Licensed Material - Property of Microsoft All rights reserved '
 42918                                  
 42919                                  ; 22/10/2022
 42920                                  ; MSDOS 5.0 IO.SYS - SYSINIT:378Ch
 42921                                  
 42922                                  ; 28/12/2022
 42923                                  %if 0
 42924                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42925                                  MsDosVersion5Copyr:
 42926                                  	db	'MS DOS Version 5.00 (C)Copyright 1981-1991 Microsoft Corp '
 42927                                  	db	'Licensed Material - Property of Microsoft All rights reserved '
 42928                                  %endif
 42929                                  
 42930                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42931                                  ; 22/10/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 42932                                  ; 20/04/2019 - Retro DOS v4.0
 42933                                  ;BOOTMES:
 42934                                  ;	db      13
 42935                                  ;	db      10
 42936                                  ;	db      "MS-DOS version "
 42937                                  ;	db      MAJOR_VERSION + "0"
 42938                                  ;	db      "."
 42939                                  ;	db      (MINOR_VERSION / 10) + "0"
 42940                                  ;	db      (MINOR_VERSION % 10) + "0"
 42941                                  ;	db      13,10
 42942                                  ;	;db	"Copyright 1981-1993 Microsoft Corp.",13,10,"$"
 42943                                  ;	; 22/10/2022
 42944                                  ;	db	"Copyright 1981-1991 Microsoft Corp.",13,10,"$"
 42945                                  ;	;
 42946                                  ;	db	0
 42947                                  
 42948                                  	; 01/01/2023 - Retro DOS v4.2
 42949                                  
 42950                                  	; 28/12/2022 - Retro DOS v4.1
 42951                                  ;MsDosVersion5Copyr:
 42952                                  ;  	db	13,10,"MS DOS Version 5.0"
 42953                                  ;	db	13,10,"Copyright 1981-1991 Microsoft Corp.",13,10,"$",0	
 42954                                  
 42955                                  	; 12/12/2022
 42956 00004529 00                      	db	0
 42957                                  ; 12/12/2022
 42958                                  BOOTMES:
 42959 0000452A 0D0A                    	db	13,10
 42960                                  	;;;db 	"Retro DOS v4.0 (Modified MSDOS 5.0) "
 42961                                  	; 28/12/2022
 42962                                  	;;db 	"Retro DOS v4.1 (Modified MSDOS 5.0) "
 42963                                  	; 01/01/2023
 42964                                  	;db 	"Retro DOS v4.2 (Modified MSDOS 6.22) "
 42965                                  	; 30/12/2023
 42966 0000452C 526574726F20444F53-     	db 	"Retro DOS v5.0 (Modified PCDOS 7.1) "
 42966 00004535 2076352E3020284D6F-
 42966 0000453E 646966696564205043-
 42966 00004547 444F5320372E312920 
 42967                                  	
 42968 00004550 0D0A                    	db	13,10
 42969 00004552 6279204572646F6761-     	db	"by Erdogan Tan [2023] "
 42969 0000455B 6E2054616E205B3230-
 42969 00004564 32335D20           
 42970 00004568 0D0A                    	db	13,10
 42971 0000456A 0D0A2400                	db	13,10,"$",0
 42972                                  
 42973 0000456E 4E554C00                nuldev:	db	"NUL",0
 42974 00004572 434F4E00                condev:	db	"CON",0
 42975 00004576 41555800                auxdev:	db	"AUX",0
 42976 0000457A 50524E00                prndev:	db	"PRN",0
 42977                                  
 42978                                  ;IFDEF	CONFIGPROC
 42979 0000457E 5C434F4E4649472E53-     config:	db	"\CONFIG.SYS",0
 42979 00004587 595300             
 42980                                  
 42981 0000458A 413A                    cntry_drv:  db	"A:"
 42982 0000458C 5C                      cntry_root: db	"\"
 42983 0000458D 434F554E5452592E53-     cntry_path: db	"COUNTRY.SYS",0
 42983 00004596 595300             
 42984                                  	    ;db	52 dup (0)
 42985 00004599 00<rep 34h>             	    times 52 db 0	
 42986                                  
 42987                                  country_file_signature:
 42988 000045CD FF434F554E545259        	db	0FFh,'COUNTRY'
 42989                                  
 42990                                  cntrycodepage_id: 
 42991 000045D5 0000                    	dw	0 	
 42992                                  
 42993                                  ;ENDIF ; CONFIGPROC
 42994                                  
 42995                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 42996                                  ; (SYSINIT:5081h)
 42997                                  
 42998                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 42999                                  ;ifdef	MULTI_CONFIG
 43000 000045D7 00                      newcmd:  db	0			; non-zero if non-std shell specified
 43001 000045D8 40                      tmplate: db	64                      ; must precede commnd
 43002                                  ;endif
 43003                                  
 43004                                  ;ifdef ROMEXEC
 43005                                  ;	db      7                       ; size of commnd line (excl. null)
 43006                                  ;commnd: db	"COMMAND",0
 43007                                  ;	db	56 dup (0)
 43008                                  ;else
 43009                                  	; 02/11/2022
 43010 000045D9 0C                      	db	12                      ; size of commnd line (excl. null)
 43011 000045DA 5C434F4D4D414E442E-     commnd:	db	"\COMMAND.COM",0
 43011 000045E3 434F4D00           
 43012                                  	;db	51 dup (0)
 43013 000045E7 00<rep 33h>             	times	51 db 0
 43014                                  ;endif
 43015                                  
 43016                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 43017                                  ;ifdef	MULTI_CONFIG
 43018 0000461A 5C434F4D4D414E442E-     commnd2: db 	"\COMMAND.COM",0	; alternate commands to exec,
 43018 00004623 434F4D00           
 43019 00004627 022F5000                	 db	2,"/P",0 		; followed by their respective alternate
 43020 0000462B 5C4D53444F535C434F-     commnd3: db	"\MSDOS\COMMAND.COM",0	; command lines
 43020 00004634 4D4D414E442E434F4D-
 43020 0000463D 00                 
 43021 0000463E 0B413A5C4D53444F53-     	 db	11,"A:\MSDOS /P",0 	;(the drive letter are dynamically replaced)
 43021 00004647 202F5000           
 43022 0000464B 5C444F535C434F4D4D-     commnd4: db	"\DOS\COMMAND.COM",0 	;
 43022 00004654 414E442E434F4D00   
 43023 0000465C 09413A5C444F53202F-     	 db	9,"A:\DOS /P",0		;
 43023 00004665 5000               
 43024                                  def_swchr:	
 43025 00004667 00                      	 db	0			; default switchchar (referenced as command_line-1)
 43026                                  ;endif
 43027                                  	; 30/10/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 43028                                  command_line:
 43029 00004668 022F50                  	db	2,"/P"			; default command.com args
 43030                                  	;db	125 dup (0)
 43031 0000466B 00<rep 7Dh>             	times	125 db 0
 43032                                  
 43033                                  pathstring:
 43034                                  	;db	64 dup (0)
 43035 000046E8 00<rep 40h>             	times	64 db 0
 43036                                  
 43037                                  
 43038                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 43039                                  ; (SYSINIT:51D3h)
 43040                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 43041                                  ;%if 0
 43042                                  
 43043                                  dae_flag:
 43044 00004728 00                      	db	0 ; MSDOS 6.21 IO.SYS - SYSINIT:51D2h 	
 43045                                  
 43046                                  ;ifdef	MULTI_CONFIG
 43047                                  
 43048                                  ; 04/03/2022- Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS, SYSINIT)
 43049                                  MAX_MULTI_CONFIG equ 9	; max # of multi-config menu items supported
 43050                                  
 43051                                  ;   Beware of byte pairs accessed as words (see all "KEEP AFTER" notes below)
 43052                                  
 43053 00004729 07                      bMenuColor:	db      07h ; 1Fh       ; default fgnd/bgnd color
 43054 0000472A 00                      bMenuPage:	db      0               ; menu video page (KEEP AFTER bMenuColor)
 43055 0000472B 05                      		db      5               ; video page function # (KEEP AFTER bMenuPage)
 43056 0000472C 00                      bLastCol:	db      0               ; ending column on status line
 43057 0000472D 18                      bLastRow:	db      24              ; row # of status line (KEEP AFTER bLastCol)
 43058 0000472E 00                      bDisableUI:	db      0               ; 1=disable clean/interactive
 43059                                                                          ; 2=disable default 2-second delay
 43060 0000472F 00                      bCRTPage:	db      0               ; value saved from BIOS data area
 43061 00004730 0000                    wCRTStart:	dw      0               ; value saved from BIOS data area
 43062 00004732 00                      bQueryOpt:	db      0               ; 0=off, 1=prompt all, 2=prompt none, 4=skip all
 43063 00004733 01                      bDefBlock:	db      1               ; default block #
 43064 00004734 00                      bMaxBlock:	db      0               ; maximum block #
 43065 00004735 0000                    offDefBlock:	dw      0               ; offset of name of default block (if any)
 43066 00004737 FF                      secTimeOut:	db      -1 ; 0FFh       ; # of seconds for timeout (-1 == indefinite)
 43067 00004738 00                      secElapsed:	db      0               ; # of seconds elapsed so far (KEEP AFTER secTimeOut)
 43068 00004739 00<rep Ah>              abBlockType:	times MAX_MULTI_CONFIG+1 db 0 ; array of block types
 43069 00004743 0000<rep Ah>            aoffBlockName:	times MAX_MULTI_CONFIG+1 dw 0 ; array of offsets of block names
 43070 00004757 0000<rep Ah>            aoffBlockDesc:	times MAX_MULTI_CONFIG+1 dw 0 ; array of offsets of block descriptions
 43071                                  
 43072 0000476B 434F4E4649473D00        szBoot:		db      "CONFIG=",0
 43073 00004773 4D454E5500              szMenu:		db      "MENU",0
 43074 00004778 434F4D4D4F4E00          szCommon:	db      "COMMON",0
 43075                                  
 43076                                  ;endif	;MULTI_CONFIG
 43077                                  
 43078                                  	; 10/09/2023
 43079                                  	; MSDOS 6.21 IO.SYS - SYSINIT:5229h 	
 43080                                  	; (PCDOS 7.1 IBMBIO.COM - SYSINIT:546Eh)	
 43081                                  
 43082                                  comtab:	 ; label byte
 43083                                  
 43084                                  ;            cmd len    command         cmd code
 43085                                  ;            -------    -------         --------
 43086                                  
 43087                                  ;ifdef MULTI_CONFIG
 43088 0000477F 015B5B                          db      1,      "[",            CONFIG_BEGIN
 43089                                  ;endif
 43090 00004782 05425245414B43                  db      5,      "BREAK",        CONFIG_BREAK
 43091 00004789 074255464645525342              db      7,      "BUFFERS",      CONFIG_BUFFERS
 43092 00004792 07434F4D4D454E5459              db      7,      "COMMENT",      CONFIG_COMMENT
 43093 0000479B 07434F554E54525951              db      7,      "COUNTRY",      CONFIG_COUNTRY
 43094 000047A4 0644455649434544                db      6,      "DEVICE",       CONFIG_DEVICE
 43095 000047AC 0A4445564943454849-             db      10,     "DEVICEHIGH",   CONFIG_DEVICEHIGH
 43095 000047B5 474855             
 43096 000047B8 03444F5348                      db      3,      "DOS",          CONFIG_DOS
 43097 000047BD 08445249565041524D-             db      8,      "DRIVPARM",     CONFIG_DRIVPARM
 43097 000047C6 50                 
 43098 000047C7 044643425358                    db      4,      "FCBS",         CONFIG_FCBS
 43099 000047CD 0546494C455346                  db      5,      "FILES",        CONFIG_FILES
 43100                                  ;ifdef MULTI_CONFIG
 43101 000047D4 07494E434C5544454A              db      7,      "INCLUDE",      CONFIG_INCLUDE
 43102                                  ;endif
 43103 000047DD 07494E5354414C4C49              db      7,      "INSTALL",      CONFIG_INSTALL
 43104 000047E6 0B494E5354414C4C48-             db      11,     "INSTALLHIGH",  CONFIG_INSTALLHIGH
 43104 000047EF 49474857           
 43105 000047F3 094C41535444524956-             db      9,      "LASTDRIVE",    CONFIG_LASTDRIVE
 43105 000047FC 454C               
 43106                                  ;ifdef MULTI_CONFIG
 43107 000047FE 075355424D454E554F              db      7,      "SUBMENU",      CONFIG_SUBMENU
 43108 00004807 094D454E55434F4C4F-             db      9,      "MENUCOLOR",    CONFIG_MENUCOLOR
 43108 00004810 5252               
 43109 00004812 0B4D454E5544454641-             db      11,     "MENUDEFAULT",  CONFIG_MENUDEFAULT
 43109 0000481B 554C5441           
 43110 0000481F 084D454E554954454D-             db      8,      "MENUITEM",     CONFIG_MENUITEM
 43110 00004828 45                 
 43111                                  ;endif
 43112 00004829 0A4D554C5449545241-             db      10,     "MULTITRACK",   CONFIG_MULTITRACK
 43112 00004832 434B4D             
 43113                                  ;ifdef MULTI_CONFIG
 43114 00004835 074E554D4C4F434B4E              db      7,      "NUMLOCK",      CONFIG_NUMLOCK
 43115                                  ;endif
 43116 0000483E 0352454D30                      db      3,      "REM",          CONFIG_REM
 43117                                  ;ifdef MULTI_CONFIG
 43118 00004843 0353455456                      db      3,      "SET",          CONFIG_SET
 43119                                  ;endif
 43120 00004848 055348454C4C53                  db      5,      "SHELL",        CONFIG_SHELL
 43121                                  ;if    STACKSW
 43122 0000484F 06535441434B534B                db      6,      "STACKS",       CONFIG_STACKS
 43123                                  ;endif
 43124 00004857 085357495443484553-             db      8,      "SWITCHES",     CONFIG_SWITCHES
 43124 00004860 31                 
 43125 00004861 00                      	db	0
 43126                                  
 43127                                  	; 10/09/2023
 43128                                  ;aDosdata:  ; PCDOS 7.1 IBMBIO.COM - SYSINIT:5550h 	
 43129                                  	;db	7,	"DOSDATA"	CONFIG_DOSDATRA ;  'T'
 43130                                  	;db	0
 43131                                  
 43132                                  ;%endif ; 02/11/2022
 43133                                  
 43134                                  ; 01/01/2023 - Retro DOS v4.2
 43135                                  %if 0
 43136                                  
 43137                                  comtab:
 43138                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 43139                                  	; (SYSINIT:38EDh)
 43140                                  	db      7,      "BUFFERS",      CONFIG_BUFFERS
 43141                                  	db      5,      "BREAK",        CONFIG_BREAK
 43142                                  	db      6,      "DEVICE",       CONFIG_DEVICE
 43143                                  	db      10,     "DEVICEHIGH",   CONFIG_DEVICEHIGH
 43144                                  	db      5,      "FILES",        CONFIG_FILES
 43145                                  	db      4,      "FCBS",         CONFIG_FCBS
 43146                                  	db      9,      "LASTDRIVE",    CONFIG_LASTDRIVE
 43147                                  	db      10,     "MULTITRACK",   CONFIG_MULTITRACK
 43148                                  	db      8,      "DRIVPARM",     CONFIG_DRIVPARM
 43149                                  	db      6,      "STACKS",       CONFIG_STACKS
 43150                                  	db      7,      "COUNTRY",      CONFIG_COUNTRY
 43151                                  	db      5,      "SHELL",        CONFIG_SHELL
 43152                                  	db      7,      "INSTALL",      CONFIG_INSTALL
 43153                                  	db      7,      "COMMENT",      CONFIG_COMMENT
 43154                                  	db      3,      "REM",          CONFIG_REM
 43155                                  	db      8,      "SWITCHES",     CONFIG_SWITCHES
 43156                                  	db      3,      "DOS",          CONFIG_DOS
 43157                                  	db	0
 43158                                  
 43159                                  %endif
 43160                                  
 43161                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 43162                                  ; (SYSINIT:530Ch)
 43163                                  
 43164                                  deviceparameters:	
 43165                                  	; A_DEVICEPARAMETERS <0,dev_3inch720kb,0,80>
 43166                                  devp.specialfunc:	; deviceparameters +
 43167 00004862 00                      	db	0	; A_DEVICEPARAMETERS.DP_SPECIALFUNCTIONS
 43168                                  devp.devtype:
 43169 00004863 02                      	db	2	; A_DEVICEPARAMETERS.DP_DEVICETYPE
 43170                                  devp.devattr:
 43171 00004864 0000                    	dw	0	; A_DEVICEPARAMETERS.DP_DEVICEATTRIBUTES
 43172                                  devp.cylinders:
 43173 00004866 5000                    	dw	80	; A_DEVICEPARAMETERS.DP_CYLINDERS
 43174                                  
 43175                                  ; 04/08/2023 - Retro DOS v4.2 IO.SYS (optimization)
 43176                                  
 43177                                  	;times	286	db 0
 43178                                  devp.mediatype:		; A_DEVICEPARAMETERS.DP_MEDIATYPE
 43179 00004868 00                      	db	0
 43180                                  devp.bpb:		; A_DEVICEPARAMETERS.DP_BPB
 43181                                  devp.bps:		; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_BYTESPERSECTOR
 43182 00004869 0000                    	dw	0
 43183                                  devp.secperclus:	; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERCLUSTER	
 43184 0000486B 00                      	db	0	
 43185 0000486C 0000                    	dw	0	; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_RESERVEDSECTORS
 43186 0000486E 00                      	db	0	; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_NUMBEROFFATS
 43187 0000486F 0000                    	dw	0	; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_ROOTENTRIES
 43188                                  devp.totalsecs:		; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_TOTALSECTORS
 43189 00004871 0000                    	dw	0
 43190                                  devp.mediaid:		; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_MEDIADESCRIPTOR
 43191 00004873 00                      	db	0
 43192 00004874 0000                    	dw	0	; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERFAT
 43193                                  devp.spt:		; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_SECTORSPERTRACK
 43194 00004876 0000                    	dw	0
 43195                                  devp.heads:		; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_HEADS
 43196 00004878 0000                    	dw	0	
 43197                                  
 43198                                  	;times	68 db 0	; PCDOS 7.1  (FAT32 BPB)
 43199                                  	;times	14 db 0	; MSDOS 6.21
 43200 0000487A 0000                    	dw	0	; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_HIDDENSECTORS
 43201 0000487C 0000                    	dw	0
 43202 0000487E 0000                    	dw	0	; A_DEVICEPARAMETERS.DP_BPB+A_BPB.BPB_BIGTOTALSECTORS
 43203 00004880 0000                    	dw	0
 43204 00004882 00<rep 6h>              	times	6 db 0	
 43205                                  
 43206                                  devp.trktblents:
 43207 00004888 0000                    	dw	0	; A_DEVICEPARAMETERS.DP_TRACKTABLEENTRIES
 43208                                  devp.sectbl:		; A_DEVICEPARAMETERS.DP_SECTORTABLE
 43209 0000488A 00<rep FCh>             	times	252 db 0 ; MAX_SECTORS_IN_TRACK * A_SECTORTABLE.size
 43210                                  			; 63*4 bytes		
 43211                                  
 43212                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 43213                                  ; (SYSINIT:5430h)
 43214                                  	
 43215 00004986 0200                    hlim:	dw	2
 43216 00004988 0900                    slim:	dw	9
 43217                                  
 43218 0000498A 00                      drive:	db	0
 43219                                  
 43220                                  switches:
 43221 0000498B 0000                    	dw	0
 43222                                  
 43223                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 43224                                  ; (SYSINIT:5437h)
 43225                                  
 43226                                  ; the following are the recommended bpbs for the media that
 43227                                  ; we know of so far.
 43228                                  
 43229                                  ; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 43230                                  ; MSDOS 5.0 IO.SYS - SYSINIT:3AA9h
 43231                                  
 43232                                  ; 48 tpi diskettes
 43233                                  
 43234 0000498D 0002                    bpb48t	dw	512
 43235 0000498F 02                      	db	2
 43236 00004990 0100                    	dw	1
 43237 00004992 02                      	db	2
 43238 00004993 7000                    	dw	112
 43239 00004995 D002                    	dw	2*9*40 ; 720
 43240 00004997 FD                      	db	0FDh
 43241 00004998 0200                    	dw	2
 43242 0000499A 0900                    	dw	9
 43243 0000499C 0200                    	dw	2
 43244 0000499E 00000000                	dd	0
 43245 000049A2 00000000                        dd      0
 43246                                  
 43247                                  ; 96tpi diskettes
 43248                                  
 43249 000049A6 0002                    bpb96t:	dw	512
 43250 000049A8 01                      	db	1
 43251 000049A9 0100                    	dw	1
 43252 000049AB 02                      	db	2
 43253 000049AC E000                    	dw	224
 43254 000049AE 6009                    	dw	2*15*80 ; 2400
 43255 000049B0 F9                      	db	0F9h
 43256 000049B1 0700                    	dw	7
 43257 000049B3 0F00                    	dw	15
 43258 000049B5 0200                    	dw	2
 43259 000049B7 00000000                	dd	0
 43260 000049BB 00000000                        dd      0
 43261                                  
 43262                                  ; 3 1/2 inch diskette bpb
 43263                                  
 43264 000049BF 0002                    bpb35:	dw	512
 43265 000049C1 02                      	db	2
 43266 000049C2 0100                    	dw	1
 43267 000049C4 02                      	db	2
 43268 000049C5 7000                    	dw	112
 43269 000049C7 A005                    	dw	2*9*80 ; 1440
 43270 000049C9 F9                      	db	0F9h
 43271 000049CA 0300                    	dw	3
 43272 000049CC 0900                    	dw	9
 43273 000049CE 0200                    	dw	2
 43274 000049D0 00000000                	dd	0
 43275 000049D4 00000000                        dd      0
 43276                                        
 43277 000049D8 0002                    bpb35h:	dw	512
 43278 000049DA 01                      	db	1
 43279 000049DB 0100                    	dw	1
 43280 000049DD 02                      	db	2
 43281 000049DE E000                    	dw	224
 43282 000049E0 400B                    	dw	2*18*80 ; 2880
 43283 000049E2 F0                      	db	0F0h
 43284 000049E3 0900                    	dw	9
 43285 000049E5 1200                    	dw	18
 43286 000049E7 0200                    	dw	2
 43287 000049E9 00000000                	dd	0
 43288 000049ED 00000000                        dd      0
 43289                                  
 43290                                  ; m037 - BEGIN
 43291                                  
 43292 000049F1 0002                    bpb288:	dw	512
 43293 000049F3 02                      	db	2
 43294 000049F4 0100                    	dw	1
 43295 000049F6 02                      	db	2
 43296 000049F7 F000                    	dw	240
 43297 000049F9 8016                    	dw	2*36*80 ; 5760
 43298 000049FB F0                      	db	0F0h
 43299 000049FC 0900                    	dw	9
 43300 000049FE 2400                    	dw	36
 43301 00004A00 0200                    	dw	2
 43302 00004A02 00000000                	dd	0
 43303 00004A06 00000000                        dd      0
 43304                                  
 43305                                  ; m037 - END
 43306                                  
 43307                                  ; 12/05/2019
 43308                                  
 43309                                  align 2
 43310                                  
 43311                                  ; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 43312                                  ; MSDOS 5.0 IO.SYS - SYSINIT:3B26h
 43313                                  
 43314 00004A0A [8D49]                  bpbtable:   dw	    bpb48t		; 48tpi drives
 43315 00004A0C [A649]                  	    dw	    bpb96t		; 96tpi drives
 43316 00004A0E [BF49]                  	    dw	    bpb35		; 3.5" drives
 43317                                  ; the following are not supported, so default to 3.5" media layout
 43318 00004A10 [BF49]                  	    dw	    bpb35		; not used - 8" drives
 43319 00004A12 [BF49]                  	    dw	    bpb35		; not used - 8" drives
 43320 00004A14 [BF49]                  	    dw	    bpb35		; not used - hard files
 43321 00004A16 [BF49]                  	    dw	    bpb35		; not used - tape drives
 43322 00004A18 [D849]                  	    dw	    bpb35h		; 3-1/2" 1.44mb drive
 43323 00004A1A [BF49]                  	    dw	    bpb35		; ERIMO				m037
 43324 00004A1C [F149]                  	    dw	    bpb288		; 2.88 MB diskette drives	m037
 43325                                  
 43326                                  switchlist: 
 43327 00004A1E 08464853544449434E      	db	8,"FHSTDICN"	     ; preserve the positions of n and c.
 43328                                  
 43329                                  ;----------------------------------------------------------------------------
 43330                                  ; Messages
 43331                                  ;----------------------------------------------------------------------------
 43332                                  
 43333                                  ; 19/04/2019 - Retro DOS v4.0
 43334                                  
 43335                                  ; MSDOS 6.21 IO.SYS - SYSINIT:54D1h
 43336                                  
 43337 00004A27 00                      	db 	0
 43338                                  
 43339                                  ; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 43340                                  ; MSDOS 5.0 IO.SYS - SYSINIT:3B44h
 43341                                  
 43342                                  badopm:
 43343 00004A28 0D0A                    	db	0Dh,0Ah 
 43344 00004A2A 556E7265636F676E69-     	db	'Unrecognized command in CONFIG.SYS'
 43344 00004A33 7A656420636F6D6D61-
 43344 00004A3C 6E6420696E20434F4E-
 43344 00004A45 4649472E535953     
 43345                                  crlfm:
 43346 00004A4C 0D0A24                  	db	0Dh,0Ah,'$'
 43347                                  badparm:
 43348 00004A4F 0D0A                    	db	0Dh,0Ah
 43349 00004A51 42616420636F6D6D61-     	db	'Bad command or parameters - $'
 43349 00004A5A 6E64206F7220706172-
 43349 00004A63 616D6574657273202D-
 43349 00004A6C 2024               
 43350                                  badsiz_pre:
 43351 00004A6E 0D0A                    	db	0Dh,0Ah
 43352 00004A70 536563746F72207369-     	db	'Sector size too large in file $'
 43352 00004A79 7A6520746F6F206C61-
 43352 00004A82 72676520696E206669-
 43352 00004A8B 6C652024           
 43353                                  badld_pre:
 43354 00004A8F 0D0A                    	db	0Dh,0Ah
 43355 00004A91 426164206F72206D69-     	db	'Bad or missing $'
 43355 00004A9A 7373696E672024     
 43356                                  badcom:
 43357 00004AA1 436F6D6D616E642049-     	db	'Command Interpreter',0
 43357 00004AAA 6E7465727072657465-
 43357 00004AB3 7200               
 43358                                  badcountry:
 43359 00004AB5 0D0A                    	db	0Dh,0Ah
 43360 00004AB7 496E76616C69642063-     	db	'Invalid country code or code page',0Dh,0Ah,'$'
 43360 00004AC0 6F756E74727920636F-
 43360 00004AC9 6465206F7220636F64-
 43360 00004AD2 6520706167650D0A24 
 43361                                  badcountrycom:
 43362 00004ADB 0D0A                    	db	0Dh,0Ah
 43363 00004ADD 4572726F7220696E20-     	db	'Error in COUNTRY command',0Dh,0Ah,'$'
 43363 00004AE6 434F554E5452592063-
 43363 00004AEF 6F6D6D616E640D0A24 
 43364                                  insufmemory:
 43365 00004AF8 0D0A                    	db	0Dh,0Ah
 43366 00004AFA 496E73756666696369-     	db	'Insufficient memory for COUNTRY.SYS file',0Dh,0Ah,'$'
 43366 00004B03 656E74206D656D6F72-
 43366 00004B0C 7920666F7220434F55-
 43366 00004B15 4E5452592E53595320-
 43366 00004B1E 66696C650D0A24     
 43367                                  badmem:
 43368 00004B25 0D0A                    	db	0Dh,0Ah
 43369 00004B27 436F6E666967757261-     	db	'Configuration too large for memory',0Dh,0Ah,'$'
 43369 00004B30 74696F6E20746F6F20-
 43369 00004B39 6C6172676520666F72-
 43369 00004B42 206D656D6F72790D0A-
 43369 00004B4B 24                 
 43370                                  badblock:
 43371 00004B4C 0D0A                    	db	0Dh,0Ah
 43372 00004B4E 546F6F206D616E7920-     	db	'Too many block devices',0Dh,0Ah,'$'
 43372 00004B57 626C6F636B20646576-
 43372 00004B60 696365730D0A24     
 43373                                  badstack:
 43374 00004B67 0D0A                    	db	0Dh,0Ah
 43375 00004B69 496E76616C69642053-     	db	'Invalid STACK parameters',0Dh,0Ah,'$'
 43375 00004B72 5441434B2070617261-
 43375 00004B7B 6D65746572730D0A24 
 43376                                  	; 18/12/2022
 43377                                  ;badorder:
 43378                                  	;db	0Dh,0Ah
 43379                                  	;db	'Incorrect order in CONFIG.SYS line $'
 43380                                  errorcmd:
 43381 00004B84 4572726F7220696E20-     	db	'Error in CONFIG.SYS line $'
 43381 00004B8D 434F4E4649472E5359-
 43381 00004B96 53206C696E652024   
 43382                                  
 43383                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 43384                                  ; (SYSINIT:566Eh)
 43385                                  
 43386                                  ; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 43387                                  ;%if 0
 43388                                  
 43389 00004B9E 4F4E                    OnOff:	db	'ON'
 43390 00004BA0 4F4646                  OnOff2:	db	'OFF'
 43391                                  
 43392                                  	; 04/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 43393                                  	; (SYSINIT:5673h)
 43394                                  ;StartMsg:
 43395                                  ;	db	'Starting MS-DOS...',0Dh,0Ah
 43396                                  ;	db	0Ah,0
 43397                                  
 43398                                  	; 17/12/2023 - Retro DOS v5.0 (Modified PCDOS 7.1 IBMBIO.COM)
 43399                                  	; (SYSINIT:58F7h)
 43400                                  ;StartMsg:
 43401                                  ;	db	'Starting PC DOS...',0Dh,0Ah
 43402                                  ;	db	0Ah,0
 43403                                  
 43404                                  _$PauseMsg:
 43405                                  	; 17/12/2023
 43406                                  	;db	'Press any key to continue . . .',0Dh,0Ah,'$'
 43407                                  	; 04/08/2023 (PCDOS 7.10 - IBMBIO.COM SYSINIT:590Dh)
 43408 00004BA3 507265737320616E79-     	db	'Press any key to continue...',0Dh,0Ah,'$'
 43408 00004BAC 206B657920746F2063-
 43408 00004BB5 6F6E74696E75652E2E-
 43408 00004BBE 2E0D0A24           
 43409                                  _$CleanMsg:
 43410                                  	;db	'MS-DOS is bypassing your CONFIG.SYS and AUTOEXEC.BAT files.',0Dh,0Ah,'$'
 43411                                  	; 17/12/2023
 43412 00004BC2 504320444F53206973-     	db	'PC DOS is bypassing your CONFIG.SYS and AUTOEXEC.BAT files.',0Dh,0Ah,'$'
 43412 00004BCB 20627970617373696E-
 43412 00004BD4 6720796F757220434F-
 43412 00004BDD 4E4649472E53595320-
 43412 00004BE6 616E64204155544F45-
 43412 00004BEF 5845432E4241542066-
 43412 00004BF8 696C65732E0D0A24   
 43413                                  _$InterMsg:
 43414                                  	;db	'MS-DOS will prompt you to confirm each CONFIG.SYS command.',0Dh,0Ah,'$'
 43415                                  	; 17/12/2023
 43416 00004C00 504320444F53207769-     	db	'PC DOS will prompt you to confirm each CONFIG.SYS command.',0Dh,0Ah,'$'
 43416 00004C09 6C6C2070726F6D7074-
 43416 00004C12 20796F7520746F2063-
 43416 00004C1B 6F6E6669726D206561-
 43416 00004C24 636820434F4E464947-
 43416 00004C2D 2E53595320636F6D6D-
 43416 00004C36 616E642E0D0A24     
 43417                                  _$MenuHeader:
 43418 00004C3D 0D0A                    	db	0Dh,0Ah
 43419                                  	; 17/12/2023
 43420                                  	;db	'  MS-DOS 6.2 Startup Menu',0Dh,0Ah
 43421                                  	;db	'  '
 43422                                  	;times	23 db (0CDh)  ; ALT 205 ; '=======================' ; 06/08/2023
 43423                                  	;db 	0Dh,0Ah,'$'
 43424                                  	; 04/08/2023 (PCDOS 7.10 - IBMBIO.COM SYSINIT:59A7h)
 43425 00004C3F 2020504320444F5320-     	db	'  PC DOS 7.1 Startup Menu',0Dh,0Ah
 43425 00004C48 372E31205374617274-
 43425 00004C51 7570204D656E750D0A 
 43426 00004C5A 2020                    	db	'  '
 43427 00004C5C CD<rep 17h>             	times	23 db (0CDh)  ; ALT 205 ; '=======================' ; 06/08/2023
 43428 00004C73 0D0A24                  	db 	0Dh,0Ah,'$'
 43429                                  _$MenuPrmpt:
 43430 00004C76 2020456E7465722061-     	db	'  Enter a choice: $'
 43430 00004C7F 2063686F6963653A20-
 43430 00004C88 24                 
 43431                                  _$StatusLine:
 43432 00004C89 46353D427970617373-     	db	'F5=Bypass startup files F8=Confirm each line of CONFIG.SYS '
 43432 00004C92 207374617274757020-
 43432 00004C9B 66696C65732046383D-
 43432 00004CA4 436F6E6669726D2065-
 43432 00004CAD 616368206C696E6520-
 43432 00004CB6 6F6620434F4E464947-
 43432 00004CBF 2E53595320         
 43433 00004CC4 616E64204155544F45-     	db	'and AUTOEXEC.BAT [ ]$'
 43433 00004CCD 5845432E424154205B-
 43433 00004CD6 205D24             
 43434                                  _$InterPrmpt:
 43435 00004CD9 205B592C4E5D3F24        	db	' [Y,N]?$'
 43436                                  	; 04/08/2023
 43437                                  	;db	' [Y,N,ESC]?$' ; PCDOS 7.1 - IBMBIO.COM 
 43438 00004CE1 59455324                _$YES:	db	'YES$'
 43439 00004CE5 4E4F2024                _$NO:	db	'NO $'
 43440                                  _$TimeOut:
 43441 00004CE9 54696D652072656D61-     	db	'Time remaining: $'
 43441 00004CF2 696E696E673A2024   
 43442                                  badcomprmpt:
 43443 00004CFA 456E74657220636F72-     	db	'Enter correct name of Command Interpreter (eg, C:\COMMAND.COM)'
 43443 00004D03 72656374206E616D65-
 43443 00004D0C 206F6620436F6D6D61-
 43443 00004D15 6E6420496E74657270-
 43443 00004D1E 726574657220286567-
 43443 00004D27 2C20433A5C434F4D4D-
 43443 00004D30 414E442E434F4D29   
 43444 00004D38 0D0A24                  	db	0Dh,0Ah,'$'
 43445                                  _$AutoPrmpt:
 43446 00004D3B 50726F636573732041-     	db	'Process AUTOEXEC.BAT [Y,N]?$'
 43446 00004D44 55544F455845432E42-
 43446 00004D4D 4154205B592C4E5D3F-
 43446 00004D56 24                 
 43447                                  
 43448                                  ;%endif ; 02/11/2022
 43449                                  
 43450                                  ; 01/01/2023 - Retro DOS v4.2 (Modified MSDOS 6.21 IO.SYS)
 43451                                  ; (SYSINIT:5840h)
 43452                                  
 43453                                  ; 02/11/2022 - Retro DOS v4.0 (Modified MSDOS 5.0 IO.SYS)
 43454                                  ; MSDOS 5.0 IO.SYS - SYSINIT:3CE0h
 43455                                  
 43456                                  TooManyDrivesMsg:
 43457 00004D57 5741524E494E472120-     	db	'WARNING! Logical drives past Z: exist and will be ignored',0Dh,0Ah,'$'
 43457 00004D60 4C6F676963616C2064-
 43457 00004D69 726976657320706173-
 43457 00004D72 74205A3A2065786973-
 43457 00004D7B 7420616E642077696C-
 43457 00004D84 6C2062652069676E6F-
 43457 00004D8D 7265640D0A24       
 43458                                  
 43459                                  ;MSDOS 6.21 IO.SYS - SYSINIT:587Ch
 43460                                  	;db	'Wrong DBLSPACE.BIN version',0Dh,0Ah,'$'
 43461                                  	;db	7 dup(0)
 43462                                  
 43463                                  	;times	7 db 0
 43464                                  	; 02/11/2022 (MSDOS 5.0 IO.SYS SYSINIT compatibility)
 43465                                  ;MSDOS 5.0 IO.SYS - SYSINIT:3D1Ch
 43466                                  	; 09/12/2022
 43467                                  	;times 4 db 0
 43468                                  
 43469                                  ;----------------------------------------------------------------------------
 43470                                  		; 09/12/2022
 43471                                  		;db 0
 43472                                  
 43473                                  number3div	equ ($-SYSINIT$)
 43474                                  number3mod	equ (number3div % 16)
 43475                                  
 43476                                  %if (number3mod>0) & (number3mod<16) ; 17/09/2023
 43477 00004D93 00<rep Dh>              		times (16-number3mod) db 0
 43478                                  %endif
 43479                                  
 43480                                  ;---------------------------------------------------------------------------- 
 43481                                  ; 09/12/2022 - MSDOS 5.0 IO.SYS:3D20h ;;; SI_end = 3D20h for MSDOS 5.0 IO.SYS 
 43482                                  ;---------------------------------------------------------------------------- 
 43483                                  
 43484                                  ;MSDOS 6.21 IO.SYS - SYSINIT:5899h
 43485                                  
 43486                                  ;----------------------------------------------------------------------------
 43487                                  ; 20/04/2019 - Retro DOS v4.0
 43488                                  
 43489                                  ; 09/12/2022
 43490                                  ;
 43491                                  ;bss_start:
 43492                                  ;
 43493                                  ;ABSOLUTE bss_start
 43494                                  ;
 43495                                  ;alignb 16
 43496                                  
 43497                                  SI_end:  ; SI_end equ $
 43498                                  
 43499                                  ;----------------------------------------------------------------------------
 43500                                  
 43501                                  ;sysinitseg	ends
 43502                                  
 43503                                  ; ***************************************************************************
 43504                                  
 43505                                  ; 04/01/2023 - MSDOS 6.21 SYSINIT:SI_end = SYSINIT:58A0h (IOSYS:9F46h)
 43506                                  ; 09/12/2022 - MSDOS 5.0 SYSINIT:SI_end = SYSINIT:3D20h
 43507                                  
 43508                                  SYSINITSIZE	equ SI_end - SYSINIT$
 43509                                  DOSLOADSEG	equ SYSINITSEG+((SYSINITSIZE+15)/16)
 43510                                  
 43511                                  ;----------------------------------------------------------------------------
 43512                                  ; End of Retro DOS v5.0 IBMDOS.COM (IO.SYS) source by Erdogan Tan (2023)
 43513                                  ;----------------------------------------------------------------------------
 43514                                  
 43515                                  ; 21/12/2022 - Retro DOS v4.0 (Modified MSDOS 5.0)
 43516                                  ; 02/10/2023 - Retro DOS v5.0 (Modified PCDOS 7.1)
 43517                                  ;----------------------------------------------------------------------------
 43518                                  ;----------------------------------------------------------------------------
 43519                                  
 43520                                  ; ----------------------------------------------------------------------------
 43521                                  ; START OF PCDOS 7.1 -IBMDOS.COM- KERNEL CODE (MSDOS.SYS) -will be relocated-
 43522                                  ; ----------------------------------------------------------------------------
 43523                                  ; 02/10/2023 - Retro DOS v5.0
 43524                                  ; 04/01/2023 - Retro DOS v4.2
 43525                                  ; 29/12/2022 - Retro DOS v4.1
 43526                                  ; 18/03/2019 - Retro DOS v4.0 
 43527                                  ; 11/06/2018 - Retro DOS v3.0 
 43528                                  
 43529                                  ;MSDOS_BIN_OFFSET:
 43530                                  IBMDOS_BIN_OFFSET: ; this offset must be paragraph aligned
 43531                                  		;; 28/06/2019 ('msdos6.s') 
 43532                                  		;incbin	'MSDOS6.BIN' ; Retro DOS 4.0 - MSDOS 6.21 KERNEL
 43533                                  		
 43534                                  		; 29/12/2022
 43535                                  		;incbin	'MSDOS51.BIN' ; Retro DOS 4.1 - MSDOS 5.0+ KERNEL
 43536                                  
 43537                                  		; 29/09/2023 (PARASTART=3DE0h)
 43538                                  		; 27/09/2023 (BugFix) ((PARASTART=3DD0h))
 43539                                  		; 04/01/2023
 43540                                  		;incbin	'MSDOS6.BIN' ; Retro DOS 4.2 - MSDOS 6.21+ KERNEL		
 43541                                  		
 43542                                  		; 02/10/2023 - Retro DOS v5.0 - PCDOS 7.1 KERNEL		 
 43543 00004DA0 <bin A646h>             		incbin	'IBMDOS7.BIN'
 43544                                  
 43545                                  		;; 28/12/2022 (BugFix)
 43546                                  		;; 22/12/2022
 43547                                  		;; 21/12/2022 ('msdos5.s')
 43548                                  		;incbin 'MSDOS5.BIN'  ; Retro DOS 4.0 - MSDOS 5.0+ KERNEL
 43549                                  
 43550                                  ; 28/09/2023	
 43551                                  ;msdos_bin_size equ $ - MSDOS_BIN_OFFSET
 43552                                  
 43553                                  align 2
 43554                                  
 43555                                  ; 21/12/2022
 43556                                  ;;END_OF_KERNEL:
 43557                                  ;END_OF_KERNEL equ $
 43558                                  
 43559                                  ; 28/09/2023
 43560                                  S3SIZE equ $-$$
 43561                                  KERNEL_SIZE equ S1SIZE+S2SIZE+S3SIZE
 43562                                  
 43563                                  ;=============================================================================
 43564                                  ;	END
 43565                                  ;=============================================================================
 43566                                  ; Retro DOS v5.0 by Erdogan Tan (Redevelopment of PC-DOS 7.1 KERNEL via NASM)
 43567                                  ; ------------------------------
 43568                                  ; OCTOBER 2023, ISTANBUL - TURKIYE.
