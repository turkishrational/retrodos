<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>IDA - IBMDOS71.i64 (IBMDOS.COM) C:\pcdos_7_1\IBMDOS71.i64</title>
</head>
<body bgcolor="#ffffff">
<span style="white-space: pre; font-family: Consolas; color: blue; background: #ffffff">

<span style="color:gray">DOSDATA:0000 </span>;
<span style="color:gray">DOSDATA:0000 </span>; +-------------------------------------------------------------------------+
<span style="color:gray">DOSDATA:0000 </span>; |   This file has been generated by The Interactive Disassembler (IDA)    |
<span style="color:gray">DOSDATA:0000 </span>; |           Copyright (c) 2018 Hex-Rays, &lt;support@hex-rays.com&gt;           |
<span style="color:gray">DOSDATA:0000 </span>; |                            Freeware version                             |
<span style="color:gray">DOSDATA:0000 </span>; +-------------------------------------------------------------------------+
<span style="color:gray">DOSDATA:0000 </span>;
<span style="color:gray">DOSDATA:0000 </span>; Input SHA256 : F426A13B1E2E5A05BC7E56A18D551608D3BDC4CB14045324468860A3725E2084
<span style="color:gray">DOSDATA:0000 </span>; Input MD5    : 7F03764471D91E450F960EAE084831A6
<span style="color:gray">DOSDATA:0000 </span>; Input CRC32  : 4C51484C
<span style="color:gray">DOSDATA:0000
DOSDATA:0000
DOSDATA:0000                 .</span>386
<span style="color:gray">DOSDATA:0000                 </span>.model flat
<span style="color:gray">DOSDATA:0000
DOSDATA:0000 ; ===========================================================================
DOSDATA:0000
DOSDATA:0000 ; Segment type: Regular
DOSDATA:0000 </span>DOSDATA         segment byte public &#039;DOSDATA&#039; use16
<span style="color:gray">DOSDATA:0000                 </span>assume cs:DOSDATA
<span style="color:gray">DOSDATA:0000                 </span>assume es:nothing, ss:nothing, ds:nothing, fs:nothing, gs:nothing
<span style="color:gray">DOSDATA:0000 </span><span style="color:navy">byte_0          db </span><span style="color:#008040">4 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0004 </span>DataVersion     <span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0006 </span>WinoldPatch1    <span style="color:navy">db </span><span style="color:#008040">8 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:000E </span>MYNUM           <span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0010 </span>FCBLRU          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0012 </span>OpenLRU         <span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0014 </span>OEM_HANDLER     <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh
</span><span style="color:gray">DOSDATA:0018 </span>LeaveAddr       <span style="color:navy">dw offset </span>LeaveDOS
<span style="color:gray">DOSDATA:001A </span>RetryCount      <span style="color:navy">dw </span><span style="color:#008040">3                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:001C </span>RetryLoop       <span style="color:navy">dw </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:001E </span>LastBuffer      <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0022 </span>CONTPOS         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0024 </span>arena_head      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0026 </span>DPBHEAD         <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:002A </span>SFT_ADDR        <span style="color:navy">dd </span>SFTABL               <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:002E </span>BCLOCK          <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0032 </span>BCON            <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0036 </span>MAXSEC          <span style="color:navy">dw </span><span style="color:#008040">128                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0038 </span>BUFFHEAD        <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:003C </span>CDSADDR         <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0040 </span>SFTFCB          <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0044 </span>KEEPCOUNT       <span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0046 </span>NUMIO           <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0047 </span>CDSCOUNT        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0048 </span>NULDEV          <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:004C </span><span style="color:navy">word_4C         dw </span><span style="color:#008040">8004h                </span>; Null device attributes = DEVTYP|ISNULL
<span style="color:gray">DOSDATA:004E </span><span style="color:navy">off_4E          dw offset </span>SNULDEV       ; Strategy entry point
<span style="color:gray">DOSDATA:0050 </span><span style="color:navy">off_50          dw offset </span>INULDEV       ; Interrupt entry point
<span style="color:gray">DOSDATA:0052 </span><span style="color:navy">asc_52          db &#039;NUL     &#039;           </span>; Name of null device
<span style="color:gray">DOSDATA:005A </span>SPLICES         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:005B </span>Special_Entries <span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:005D </span>UU_IFS_DOS_CALL <span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0061 </span>ChkCopyProt     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0063 </span>A20OFF_PSP      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0065 </span><span style="color:navy">word_65         dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0067                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0069 </span>BOOTDRIVE       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:006A </span>DDMOVE          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:006B </span>EXT_MEM_SIZE    <span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:006D </span>BufferQueue     <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0071 </span>DirtyBufferCount <span style="color:navy">dw </span><span style="color:#008040">0                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0073 </span>SC_CACHE_PTR    <span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0077 </span>SC_CACHE_COUNT  <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0079 </span>BuffInHMA       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:007A </span>LoMemBuff       <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:007E </span>UU_BUF_EMS_FIRST_PAGE <span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0081 </span>CL0FATENTRY     <span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0083 </span>IoStatFail      <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0084 </span>ALLOCMSAVE      <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0085 </span>A20OFF_COUNT    <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0086 </span>DOS_FLAG        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0087 </span>UNPACK_OFFSET   <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0089 </span>UMBFLAG         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:008A </span><span style="color:navy">word_8A         dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:008C </span>UMB_HEAD        <span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:008E </span>START_ARENA     <span style="color:navy">dw </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0090 </span>JShare          <span style="color:navy">dd </span>BadCall              <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0094 </span>MFT_enter       <span style="color:navy">dd </span>OKCall               <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0098 </span>MFTClose        <span style="color:navy">dd </span>OKCall               <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:009C                 </span><span style="color:navy">dd </span>BadCall
<span style="color:gray">DOSDATA:00A0 </span>MFTCloseP       <span style="color:navy">dd </span>BadCall              <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:00A4 </span>MFTCloN         <span style="color:navy">dd </span>BadCall
<span style="color:gray">DOSDATA:00A8 </span>set_block       <span style="color:navy">dd </span>BadCall              <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:00AC </span>clr_block       <span style="color:navy">dd </span>BadCall              <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:00B0 </span>chk_block       <span style="color:navy">dd </span>OKCall               <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:00B4 </span>MFT_get         <span style="color:navy">dd </span>BadCall
<span style="color:gray">DOSDATA:00B8 </span>ShSave          <span style="color:navy">dd </span>BadCall              <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:00BC </span>ShChk           <span style="color:navy">dd </span>BadCall              <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:00C0 </span>ShCol           <span style="color:navy">dd </span>OKCall               <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:00C4 </span>ShCloseFile     <span style="color:navy">dd </span>BadCall              <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:00C8 </span>ShSU            <span style="color:navy">dd </span>BadCall              <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:00CC </span>SFTABL          <span style="color:navy">dd </span><span style="color:#008040">0FFFFFFFFh           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:00D0                 </span><span style="color:navy">dw </span><span style="color:#008040">5
</span><span style="color:gray">DOSDATA:00D2 </span>SFT0_SFTable    <span style="color:navy">db </span><span style="color:#008040">295 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:01F9 </span>CARPOS          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:01FA </span>STARTPOS        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:01FB </span>INBUF           <span style="color:navy">db </span><span style="color:#008040">128 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:027B </span>CONBUF          <span style="color:navy">db </span><span style="color:#008040">131 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:02FE </span>PFLAG           <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:02FF </span>VDERFLG         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0300 </span>CHARCO          <span style="color:navy">db </span><span style="color:#008040">3                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0301 </span>chSwitch        <span style="color:navy">db &#039;</span><span style="color:green">/&#039;
</span><span style="color:gray">DOSDATA:0302 </span>AllocMethod     <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0303 </span>fShare          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0304 </span>DIFFNAM         <span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0305 </span>MYNAME          <span style="color:navy">db </span><span style="color:#008040">10h </span><span style="color:navy">dup(</span><span style="color:#008040">20h</span><span style="color:navy">)         </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0315 </span>CritPatch       <span style="color:navy">dw offset </span>redir_patch   <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0317                 </span><span style="color:navy">dw offset </span>redir_patch
<span style="color:gray">DOSDATA:0319                 </span><span style="color:navy">dw offset </span>redir_patch
<span style="color:gray">DOSDATA:031B                 </span><span style="color:navy">dw offset </span>redir_patch
<span style="color:gray">DOSDATA:031D                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:031F                 </span><span style="color:navy">db </span><span style="color:#008040">90h                  </span>; SWAPPABLE DATA AREA
<span style="color:gray">DOSDATA:0320 </span>ERRORMODE       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0320                                         </span>; critical error flag
<span style="color:gray">DOSDATA:0321 </span>INDOS           <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0322 </span>WPERR           <span style="color:navy">db </span><span style="color:#008040">0FFh                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0322                                         </span>; drive on which current critical error occurred
<span style="color:gray">DOSDATA:0323 </span>EXTERR_LOCUS    <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0323                                         </span>; locus of last error
<span style="color:gray">DOSDATA:0324 </span>EXTERR          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0324                                         </span>; extended error code of last error
<span style="color:gray">DOSDATA:0326 </span>EXTERR_ACTION   <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0326                                         </span>; suggested action for last error
<span style="color:gray">DOSDATA:0327 </span>EXTERR_CLASS    <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0327                                         </span>; class of last error
<span style="color:gray">DOSDATA:0328 </span>EXTERRPT        <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0328                                         </span>; Extended Error pointer
<span style="color:gray">DOSDATA:032C </span>DMAADD          <span style="color:navy">dd </span><span style="color:#008040">80h                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:032C                                         </span>; current DTA (Disk Transfer Address)
<span style="color:gray">DOSDATA:0330 </span>CurrentPDB      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0332 </span>ConC_Spsave     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0334 </span>exit_code       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0336 </span>CURDRV          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0337 </span>CNTCFLAG        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0338                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0339                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:033A </span>USER_IN_AX      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:033C </span>PROC_ID         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:033E </span>USER_ID         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0340 </span>FirstArena      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0342 </span>BestArena       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0344 </span>LastArena       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0346 </span>ENDMEM          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0348 </span>LASTENT         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:034A </span>FAILERR         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:034B </span>ALLOWED         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:034C </span>NoSetDir        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:034D </span>DidCTRLC        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:034E </span>SpaceFlag       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:034F                 </span><span style="color:navy">db </span><span style="color:#008040">90h
</span><span style="color:gray">DOSDATA:0350 </span>DAY             <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0351 </span>MONTH           <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0352 </span>YEAR            <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0352                                         </span>; YEAR (and CENTURY)
<span style="color:gray">DOSDATA:0354 </span>DAYCNT          <span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0356 </span>WEEKDAY         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0357 </span>CONSWAP         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0358 </span>IDLEINT         <span style="color:navy">db </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0359 </span>fAborting       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:035A </span>DEVCALL_REQLEN  <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:035A                                         </span>; offset DEVCALL
<span style="color:gray">DOSDATA:035B </span>DEVCALL_REQUNIT <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:035C </span>DEVCALL_REQFUNC <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:035D </span>DEVCALL_REQSTAT <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:035F                 </span><span style="color:navy">db </span><span style="color:#008040">8 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">DOSDATA:0367 </span>CALLUNIT        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0368 </span>CALLBR          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0369 </span>CALLVIDM        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:036A </span>CALLXAD_2       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:036C </span>CALLBPB         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:036E </span>CALLSSEC        <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0370 </span>CALLVIDRW       <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0374 </span>CALLNEWSC       <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0378 </span>CALLDEVAD       <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:037C </span>IOCALL          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:037D </span>IOCALL_REQUNIT  <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:037E </span>IOCALL_REQFUNC  <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:037F </span>IOCALL_REQSTAT  <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0381                 </span><span style="color:navy">db </span><span style="color:#008040">8 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">DOSDATA:0389 </span>IOMED           <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:038A </span>IOXAD           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:038E </span>IOSCNT          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0390 </span>IOSSEC          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:olive">; ...
</span><span style="color:gray">DOSDATA:0392 </span>DSKSTCALL       <span style="color:navy">db </span><span style="color:#008040">14                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0393                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0394 </span>DSKSTCOM        <span style="color:navy">db </span><span style="color:#008040">5                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0395 </span>DSKSTST         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0397                 </span><span style="color:navy">db </span><span style="color:#008040">8 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">DOSDATA:039F </span>DSKCHRET        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:03A0 </span>DEVIOBUF_PTR    <span style="color:navy">dw offset </span>DEVIOBUF      <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:03A2 </span>DOSSEG_INIT     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:03A4 </span>DSKSTCNT        <span style="color:navy">dw </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:03A6                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:03A8 </span>CreatePDB       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:03A9 </span>Lock_Buffer     <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:03AD                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:03B1 </span>IOCTL_drvnum    <span style="color:navy">db </span><span style="color:#008040">90h                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:03B2 </span>USERNUM         <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:03B6 </span>TIMEBUF         <span style="color:navy">dw </span><span style="color:#008040">3 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:03BC </span>DEVIOBUF        <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:03BE </span>OPENBUF         <span style="color:navy">db </span><span style="color:#008040">128 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:043E </span>RENBUF          <span style="color:navy">db </span><span style="color:#008040">128 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:04BE </span>SEARCHBUF       <span style="color:navy">db </span><span style="color:#008040">53 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:04F3 </span>DUMMYCDS        <span style="color:navy">db </span><span style="color:#008040">88 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:054B </span>NAME1           <span style="color:navy">db </span><span style="color:#008040">12 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0557 </span>NAME2           <span style="color:navy">db </span><span style="color:#008040">13 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0564 </span>DESTSTART       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0566                 </span><span style="color:navy">db </span><span style="color:#008040">5 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">DOSDATA:056B </span>ATTRIB          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:056C </span>EXTFCB          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:056D </span>SATTRIB         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:056E </span>OPEN_ACCESS     <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:056F </span>FOUNDDEL        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0570 </span>FOUND_DEV       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0571 </span>FSPLICE         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0572 </span>FSHARING        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0573 </span>SECCLUSPOS      <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0574 </span>TRANS           <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0575 </span>READOP          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0576 </span>THISDRV         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0577 </span>CLUSFAC         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0578 </span>CLUSSPLIT       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0579 </span>INSMODE         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:057A </span>CMETA           <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:057B </span>VOLID           <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:057C </span>EXIT_TYPE       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:057E </span>CREATING        <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:057F </span>DELALL          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0580 </span>EXITHOLD        <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0584 </span>USER_SP         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0586 </span>USER_SS         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0588 </span>CONTSTK         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:058A </span>THISDPB         <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:058E </span>CLUSSAVE        <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0590 </span>CLUSSEC         <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0594 </span>PREREAD         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0596 </span>FATBYT          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0598 </span>FATBYTE         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:059A </span>DEVPT           <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:059E </span>THISSFT         <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05A2 </span>THISCDS         <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05A6 </span>THISFCB         <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05AA </span>SFN             <span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05AC </span>JFN             <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05AE </span>PJFN            <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05B2 </span>WFP_START       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05B4 </span>REN_WFP         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05B6 </span>CURR_DIR_END    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05B8 </span>NEXTADD         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05BA </span>LASTPOS         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05BC </span>CLUSNUM         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05BE </span>DIRSEC          <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05C2 </span>DIRSTART        <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05C4 </span>SECPOS          <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05C8 </span>VALSEC          <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05CC </span>BYTSECPOS       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05CE </span>BYTPOS          <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05D2 </span>BYTCNT1         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05D4 </span>BYTCNT2         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05D6 </span>SECCNT          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05D8 </span>ENTFREE         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05DA </span>ENTLAST         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05DC </span>NXTCLUSNUM      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05DE </span>GROWCNT         <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05E2 </span>CURBUF          <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05E6 </span>CONSFT          <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05EA </span>SAVEBX          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05EC </span>SAVEDS          <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05EE </span>RESTORE_TMP     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05F0 </span>NSS             <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05F2 </span>NSP             <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05F4 </span>EXTOPEN_FLAG    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05F6 </span>EXTOPEN_ON      <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05F7 </span>EXTOPEN_IO_MODE <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05F9 </span>SAVE_DI         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05FB </span>SAVE_ES         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05FD </span>SAVE_DX         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:05FF </span>SAVE_CX         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0601 </span>SAVE_BX         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0603 </span>SAVE_SI         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0605 </span>SAVE_DS         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0607 </span>HIGH_SECTOR     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0609 </span>OffsetMagicPatch <span style="color:navy">dw offset </span>MagicPatch   <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:060B </span>DISK_FULL       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:060C </span>TEMP_VAR        <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:060E </span>TEMP_VAR2       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0610 </span>DrvErr          <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0611 </span>DOS34_FLAG      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0613 </span><span style="color:navy">dword_613       dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0617                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:061B </span>AbsRdWr_SS      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:061D </span>AbsRdWr_SP      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:061F                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0620 </span>RENAMEDMA       <span style="color:navy">db </span><span style="color:#008040">384 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:07A0 </span>AUXSTACK        <span style="color:navy">db </span><span style="color:#008040">384 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)           </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0920 </span>DSKSTACK        <span style="color:navy">db &#039;@#IBM:12.01.2003.build_1.32#@ IBMDOS.COM(USA)&#039;,0 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:094E                 </span><span style="color:navy">db </span><span style="color:#008040">338 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)           </span>; IOSTACK (just after DSKSTACK)
<span style="color:gray">DOSDATA:0AA0 </span>PRINTER_FLAG    <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AA1 </span>VOLCHNG_FLAG    <span style="color:navy">db </span><span style="color:#008040">0FFh                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AA2                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0AA3 </span>TEMP_DOSLOC     <span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AA5 </span>LNE_COUNT       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AA7                 </span><span style="color:navy">db </span><span style="color:#008040">0Eh </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">DOSDATA:0AB5 </span>ENTLAST_PREV    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AB7                 </span><span style="color:navy">db </span><span style="color:#008040">24h </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">DOSDATA:0ADB </span>absdrw_extd     <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0ADC </span>DIRSTART_HW     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0ADE </span>CLUSNUM_HW      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AE0 </span>NXTCLUSNUM_HW   <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AE2 </span>LASTPOS_HW      <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AE4 </span>FATBYT_HW       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AE6 </span>DESTSTART_HW    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AE8 </span>CLUSTNUM_HW     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AEA </span>CLUSDATA_HW     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AEA                                         </span>; (0 = release, -1 = allocate) INPUT for PACK
<span style="color:gray">DOSDATA:0AEC </span>CCONTENT_HW     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AEC                                         </span>; UNPACK output
<span style="color:gray">DOSDATA:0AEE </span>ROOTCLUST_HW    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AF0 </span>CCOUNT_HW       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AF0                                         </span>; for ALLOCATE
<span style="color:gray">DOSDATA:0AF2 </span>CLUSTERS_HW     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AF4                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0AF6                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0AF8 </span>CLSKIP_HW       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AFA </span>UCASE_TAB       <span style="color:navy">dw </span><span style="color:#008040">128                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AFC </span>UCASE_TAB_2     <span style="color:navy">db </span><span style="color:#008040">128</span><span style="color:navy">,</span><span style="color:#008040">154</span><span style="color:navy">, </span><span style="color:#008040">69</span><span style="color:navy">, </span><span style="color:#008040">65</span><span style="color:navy">,</span><span style="color:#008040">142</span><span style="color:navy">, </span><span style="color:#008040">65</span><span style="color:navy">,</span><span style="color:#008040">143</span><span style="color:navy">,</span><span style="color:#008040">128 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0AFC                 </span><span style="color:navy">db  </span><span style="color:#008040">69</span><span style="color:navy">, </span><span style="color:#008040">69</span><span style="color:navy">, </span><span style="color:#008040">69</span><span style="color:navy">, </span><span style="color:#008040">73</span><span style="color:navy">, </span><span style="color:#008040">73</span><span style="color:navy">, </span><span style="color:#008040">73</span><span style="color:navy">,</span><span style="color:#008040">142</span><span style="color:navy">,</span><span style="color:#008040">143
</span><span style="color:gray">DOSDATA:0AFC                 </span><span style="color:navy">db </span><span style="color:#008040">144</span><span style="color:navy">,</span><span style="color:#008040">146</span><span style="color:navy">,</span><span style="color:#008040">146</span><span style="color:navy">, </span><span style="color:#008040">79</span><span style="color:navy">,</span><span style="color:#008040">153</span><span style="color:navy">, </span><span style="color:#008040">79</span><span style="color:navy">, </span><span style="color:#008040">85</span><span style="color:navy">, </span><span style="color:#008040">85
</span><span style="color:gray">DOSDATA:0AFC                 </span><span style="color:navy">db  </span><span style="color:#008040">89</span><span style="color:navy">,</span><span style="color:#008040">153</span><span style="color:navy">,</span><span style="color:#008040">154</span><span style="color:navy">,</span><span style="color:#008040">155</span><span style="color:navy">,</span><span style="color:#008040">156</span><span style="color:navy">,</span><span style="color:#008040">157</span><span style="color:navy">,</span><span style="color:#008040">158</span><span style="color:navy">,</span><span style="color:#008040">159
</span><span style="color:gray">DOSDATA:0AFC                 </span><span style="color:navy">db  </span><span style="color:#008040">65</span><span style="color:navy">, </span><span style="color:#008040">73</span><span style="color:navy">, </span><span style="color:#008040">79</span><span style="color:navy">, </span><span style="color:#008040">85</span><span style="color:navy">,</span><span style="color:#008040">165</span><span style="color:navy">,</span><span style="color:#008040">165</span><span style="color:navy">,</span><span style="color:#008040">166</span><span style="color:navy">,</span><span style="color:#008040">167
</span><span style="color:gray">DOSDATA:0AFC                 </span><span style="color:navy">db </span><span style="color:#008040">168</span><span style="color:navy">,</span><span style="color:#008040">169</span><span style="color:navy">,</span><span style="color:#008040">170</span><span style="color:navy">,</span><span style="color:#008040">171</span><span style="color:navy">,</span><span style="color:#008040">172</span><span style="color:navy">,</span><span style="color:#008040">173</span><span style="color:navy">,</span><span style="color:#008040">174</span><span style="color:navy">,</span><span style="color:#008040">175
</span><span style="color:gray">DOSDATA:0AFC                 </span><span style="color:navy">db </span><span style="color:#008040">176</span><span style="color:navy">,</span><span style="color:#008040">177</span><span style="color:navy">,</span><span style="color:#008040">178</span><span style="color:navy">,</span><span style="color:#008040">179</span><span style="color:navy">,</span><span style="color:#008040">180</span><span style="color:navy">,</span><span style="color:#008040">181</span><span style="color:navy">,</span><span style="color:#008040">182</span><span style="color:navy">,</span><span style="color:#008040">183
</span><span style="color:gray">DOSDATA:0AFC                 </span><span style="color:navy">db </span><span style="color:#008040">184</span><span style="color:navy">,</span><span style="color:#008040">185</span><span style="color:navy">,</span><span style="color:#008040">186</span><span style="color:navy">,</span><span style="color:#008040">187</span><span style="color:navy">,</span><span style="color:#008040">188</span><span style="color:navy">,</span><span style="color:#008040">189</span><span style="color:navy">,</span><span style="color:#008040">190</span><span style="color:navy">,</span><span style="color:#008040">191
</span><span style="color:gray">DOSDATA:0AFC                 </span><span style="color:navy">db </span><span style="color:#008040">192</span><span style="color:navy">,</span><span style="color:#008040">193</span><span style="color:navy">,</span><span style="color:#008040">194</span><span style="color:navy">,</span><span style="color:#008040">195</span><span style="color:navy">,</span><span style="color:#008040">196</span><span style="color:navy">,</span><span style="color:#008040">197</span><span style="color:navy">,</span><span style="color:#008040">198</span><span style="color:navy">,</span><span style="color:#008040">199
</span><span style="color:gray">DOSDATA:0AFC                 </span><span style="color:navy">db </span><span style="color:#008040">200</span><span style="color:navy">,</span><span style="color:#008040">201</span><span style="color:navy">,</span><span style="color:#008040">202</span><span style="color:navy">,</span><span style="color:#008040">203</span><span style="color:navy">,</span><span style="color:#008040">204</span><span style="color:navy">,</span><span style="color:#008040">205</span><span style="color:navy">,</span><span style="color:#008040">206</span><span style="color:navy">,</span><span style="color:#008040">207
</span><span style="color:gray">DOSDATA:0AFC                 </span><span style="color:navy">db </span><span style="color:#008040">208</span><span style="color:navy">,</span><span style="color:#008040">209</span><span style="color:navy">,</span><span style="color:#008040">210</span><span style="color:navy">,</span><span style="color:#008040">211</span><span style="color:navy">,</span><span style="color:#008040">212</span><span style="color:navy">,</span><span style="color:#008040">213</span><span style="color:navy">,</span><span style="color:#008040">214</span><span style="color:navy">,</span><span style="color:#008040">215
</span><span style="color:gray">DOSDATA:0AFC                 </span><span style="color:navy">db </span><span style="color:#008040">216</span><span style="color:navy">,</span><span style="color:#008040">217</span><span style="color:navy">,</span><span style="color:#008040">218</span><span style="color:navy">,</span><span style="color:#008040">219</span><span style="color:navy">,</span><span style="color:#008040">220</span><span style="color:navy">,</span><span style="color:#008040">221</span><span style="color:navy">,</span><span style="color:#008040">222</span><span style="color:navy">,</span><span style="color:#008040">223
</span><span style="color:gray">DOSDATA:0AFC                 </span><span style="color:navy">db </span><span style="color:#008040">224</span><span style="color:navy">,</span><span style="color:#008040">225</span><span style="color:navy">,</span><span style="color:#008040">226</span><span style="color:navy">,</span><span style="color:#008040">227</span><span style="color:navy">,</span><span style="color:#008040">228</span><span style="color:navy">,</span><span style="color:#008040">229</span><span style="color:navy">,</span><span style="color:#008040">230</span><span style="color:navy">,</span><span style="color:#008040">231
</span><span style="color:gray">DOSDATA:0AFC                 </span><span style="color:navy">db </span><span style="color:#008040">232</span><span style="color:navy">,</span><span style="color:#008040">233</span><span style="color:navy">,</span><span style="color:#008040">234</span><span style="color:navy">,</span><span style="color:#008040">235</span><span style="color:navy">,</span><span style="color:#008040">236</span><span style="color:navy">,</span><span style="color:#008040">237</span><span style="color:navy">,</span><span style="color:#008040">238</span><span style="color:navy">,</span><span style="color:#008040">239
</span><span style="color:gray">DOSDATA:0AFC                 </span><span style="color:navy">db </span><span style="color:#008040">240</span><span style="color:navy">,</span><span style="color:#008040">241</span><span style="color:navy">,</span><span style="color:#008040">242</span><span style="color:navy">,</span><span style="color:#008040">243</span><span style="color:navy">,</span><span style="color:#008040">244</span><span style="color:navy">,</span><span style="color:#008040">245</span><span style="color:navy">,</span><span style="color:#008040">246</span><span style="color:navy">,</span><span style="color:#008040">247
</span><span style="color:gray">DOSDATA:0AFC                 </span><span style="color:navy">db </span><span style="color:#008040">248</span><span style="color:navy">,</span><span style="color:#008040">249</span><span style="color:navy">,</span><span style="color:#008040">250</span><span style="color:navy">,</span><span style="color:#008040">251</span><span style="color:navy">,</span><span style="color:#008040">252</span><span style="color:navy">,</span><span style="color:#008040">253</span><span style="color:navy">,</span><span style="color:#008040">254</span><span style="color:navy">,</span><span style="color:#008040">255
</span><span style="color:gray">DOSDATA:0B7C </span>FILE_UCASE_TAB  <span style="color:navy">dw </span><span style="color:#008040">128                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0B7E </span>FILE_UCASE_TAB_2 <span style="color:navy">db </span><span style="color:#008040">128</span><span style="color:navy">,</span><span style="color:#008040">154</span><span style="color:navy">, </span><span style="color:#008040">69</span><span style="color:navy">, </span><span style="color:#008040">65</span><span style="color:navy">,</span><span style="color:#008040">142</span><span style="color:navy">, </span><span style="color:#008040">65</span><span style="color:navy">,</span><span style="color:#008040">143</span><span style="color:navy">,</span><span style="color:#008040">128 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0B7E                 </span><span style="color:navy">db  </span><span style="color:#008040">69</span><span style="color:navy">, </span><span style="color:#008040">69</span><span style="color:navy">, </span><span style="color:#008040">69</span><span style="color:navy">, </span><span style="color:#008040">73</span><span style="color:navy">, </span><span style="color:#008040">73</span><span style="color:navy">, </span><span style="color:#008040">73</span><span style="color:navy">,</span><span style="color:#008040">142</span><span style="color:navy">,</span><span style="color:#008040">143
</span><span style="color:gray">DOSDATA:0B7E                 </span><span style="color:navy">db </span><span style="color:#008040">144</span><span style="color:navy">,</span><span style="color:#008040">146</span><span style="color:navy">,</span><span style="color:#008040">146</span><span style="color:navy">, </span><span style="color:#008040">79</span><span style="color:navy">,</span><span style="color:#008040">153</span><span style="color:navy">, </span><span style="color:#008040">79</span><span style="color:navy">, </span><span style="color:#008040">85</span><span style="color:navy">, </span><span style="color:#008040">85
</span><span style="color:gray">DOSDATA:0B7E                 </span><span style="color:navy">db  </span><span style="color:#008040">89</span><span style="color:navy">,</span><span style="color:#008040">153</span><span style="color:navy">,</span><span style="color:#008040">154</span><span style="color:navy">,</span><span style="color:#008040">155</span><span style="color:navy">,</span><span style="color:#008040">156</span><span style="color:navy">,</span><span style="color:#008040">157</span><span style="color:navy">,</span><span style="color:#008040">158</span><span style="color:navy">,</span><span style="color:#008040">159
</span><span style="color:gray">DOSDATA:0B7E                 </span><span style="color:navy">db  </span><span style="color:#008040">65</span><span style="color:navy">, </span><span style="color:#008040">73</span><span style="color:navy">, </span><span style="color:#008040">79</span><span style="color:navy">, </span><span style="color:#008040">85</span><span style="color:navy">,</span><span style="color:#008040">165</span><span style="color:navy">,</span><span style="color:#008040">165</span><span style="color:navy">,</span><span style="color:#008040">166</span><span style="color:navy">,</span><span style="color:#008040">167
</span><span style="color:gray">DOSDATA:0B7E                 </span><span style="color:navy">db </span><span style="color:#008040">168</span><span style="color:navy">,</span><span style="color:#008040">169</span><span style="color:navy">,</span><span style="color:#008040">170</span><span style="color:navy">,</span><span style="color:#008040">171</span><span style="color:navy">,</span><span style="color:#008040">172</span><span style="color:navy">,</span><span style="color:#008040">173</span><span style="color:navy">,</span><span style="color:#008040">174</span><span style="color:navy">,</span><span style="color:#008040">175
</span><span style="color:gray">DOSDATA:0B7E                 </span><span style="color:navy">db </span><span style="color:#008040">176</span><span style="color:navy">,</span><span style="color:#008040">177</span><span style="color:navy">,</span><span style="color:#008040">178</span><span style="color:navy">,</span><span style="color:#008040">179</span><span style="color:navy">,</span><span style="color:#008040">180</span><span style="color:navy">,</span><span style="color:#008040">181</span><span style="color:navy">,</span><span style="color:#008040">182</span><span style="color:navy">,</span><span style="color:#008040">183
</span><span style="color:gray">DOSDATA:0B7E                 </span><span style="color:navy">db </span><span style="color:#008040">184</span><span style="color:navy">,</span><span style="color:#008040">185</span><span style="color:navy">,</span><span style="color:#008040">186</span><span style="color:navy">,</span><span style="color:#008040">187</span><span style="color:navy">,</span><span style="color:#008040">188</span><span style="color:navy">,</span><span style="color:#008040">189</span><span style="color:navy">,</span><span style="color:#008040">190</span><span style="color:navy">,</span><span style="color:#008040">191
</span><span style="color:gray">DOSDATA:0B7E                 </span><span style="color:navy">db </span><span style="color:#008040">192</span><span style="color:navy">,</span><span style="color:#008040">193</span><span style="color:navy">,</span><span style="color:#008040">194</span><span style="color:navy">,</span><span style="color:#008040">195</span><span style="color:navy">,</span><span style="color:#008040">196</span><span style="color:navy">,</span><span style="color:#008040">197</span><span style="color:navy">,</span><span style="color:#008040">198</span><span style="color:navy">,</span><span style="color:#008040">199
</span><span style="color:gray">DOSDATA:0B7E                 </span><span style="color:navy">db </span><span style="color:#008040">200</span><span style="color:navy">,</span><span style="color:#008040">201</span><span style="color:navy">,</span><span style="color:#008040">202</span><span style="color:navy">,</span><span style="color:#008040">203</span><span style="color:navy">,</span><span style="color:#008040">204</span><span style="color:navy">,</span><span style="color:#008040">205</span><span style="color:navy">,</span><span style="color:#008040">206</span><span style="color:navy">,</span><span style="color:#008040">207
</span><span style="color:gray">DOSDATA:0B7E                 </span><span style="color:navy">db </span><span style="color:#008040">208</span><span style="color:navy">,</span><span style="color:#008040">209</span><span style="color:navy">,</span><span style="color:#008040">210</span><span style="color:navy">,</span><span style="color:#008040">211</span><span style="color:navy">,</span><span style="color:#008040">212</span><span style="color:navy">,</span><span style="color:#008040">213</span><span style="color:navy">,</span><span style="color:#008040">214</span><span style="color:navy">,</span><span style="color:#008040">215
</span><span style="color:gray">DOSDATA:0B7E                 </span><span style="color:navy">db </span><span style="color:#008040">216</span><span style="color:navy">,</span><span style="color:#008040">217</span><span style="color:navy">,</span><span style="color:#008040">218</span><span style="color:navy">,</span><span style="color:#008040">219</span><span style="color:navy">,</span><span style="color:#008040">220</span><span style="color:navy">,</span><span style="color:#008040">221</span><span style="color:navy">,</span><span style="color:#008040">222</span><span style="color:navy">,</span><span style="color:#008040">223
</span><span style="color:gray">DOSDATA:0B7E                 </span><span style="color:navy">db </span><span style="color:#008040">224</span><span style="color:navy">,</span><span style="color:#008040">225</span><span style="color:navy">,</span><span style="color:#008040">226</span><span style="color:navy">,</span><span style="color:#008040">227</span><span style="color:navy">,</span><span style="color:#008040">228</span><span style="color:navy">,</span><span style="color:#008040">229</span><span style="color:navy">,</span><span style="color:#008040">230</span><span style="color:navy">,</span><span style="color:#008040">231
</span><span style="color:gray">DOSDATA:0B7E                 </span><span style="color:navy">db </span><span style="color:#008040">232</span><span style="color:navy">,</span><span style="color:#008040">233</span><span style="color:navy">,</span><span style="color:#008040">234</span><span style="color:navy">,</span><span style="color:#008040">235</span><span style="color:navy">,</span><span style="color:#008040">236</span><span style="color:navy">,</span><span style="color:#008040">237</span><span style="color:navy">,</span><span style="color:#008040">238</span><span style="color:navy">,</span><span style="color:#008040">239
</span><span style="color:gray">DOSDATA:0B7E                 </span><span style="color:navy">db </span><span style="color:#008040">240</span><span style="color:navy">,</span><span style="color:#008040">241</span><span style="color:navy">,</span><span style="color:#008040">242</span><span style="color:navy">,</span><span style="color:#008040">243</span><span style="color:navy">,</span><span style="color:#008040">244</span><span style="color:navy">,</span><span style="color:#008040">245</span><span style="color:navy">,</span><span style="color:#008040">246</span><span style="color:navy">,</span><span style="color:#008040">247
</span><span style="color:gray">DOSDATA:0B7E                 </span><span style="color:navy">db </span><span style="color:#008040">248</span><span style="color:navy">,</span><span style="color:#008040">249</span><span style="color:navy">,</span><span style="color:#008040">250</span><span style="color:navy">,</span><span style="color:#008040">251</span><span style="color:navy">,</span><span style="color:#008040">252</span><span style="color:navy">,</span><span style="color:#008040">253</span><span style="color:navy">,</span><span style="color:#008040">254</span><span style="color:navy">,</span><span style="color:#008040">255
</span><span style="color:gray">DOSDATA:0BFE </span>COLLATE_TAB     <span style="color:navy">dw </span><span style="color:#008040">256                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0C00                 </span><span style="color:navy">db  </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">6</span><span style="color:navy">, </span><span style="color:#008040">7
</span><span style="color:gray">DOSDATA:0C00                 </span><span style="color:navy">db  </span><span style="color:#008040">8</span><span style="color:navy">, </span><span style="color:#008040">9</span><span style="color:navy">,</span><span style="color:#008040">10</span><span style="color:navy">,</span><span style="color:#008040">11</span><span style="color:navy">,</span><span style="color:#008040">12</span><span style="color:navy">,</span><span style="color:#008040">13</span><span style="color:navy">,</span><span style="color:#008040">14</span><span style="color:navy">,</span><span style="color:#008040">15
</span><span style="color:gray">DOSDATA:0C00                 </span><span style="color:navy">db </span><span style="color:#008040">16</span><span style="color:navy">,</span><span style="color:#008040">17</span><span style="color:navy">,</span><span style="color:#008040">18</span><span style="color:navy">,</span><span style="color:#008040">19</span><span style="color:navy">,</span><span style="color:#008040">20</span><span style="color:navy">,</span><span style="color:#008040">21</span><span style="color:navy">,</span><span style="color:#008040">22</span><span style="color:navy">,</span><span style="color:#008040">23
</span><span style="color:gray">DOSDATA:0C00                 </span><span style="color:navy">db </span><span style="color:#008040">24</span><span style="color:navy">,</span><span style="color:#008040">25</span><span style="color:navy">,</span><span style="color:#008040">26</span><span style="color:navy">,</span><span style="color:#008040">27</span><span style="color:navy">,</span><span style="color:#008040">28</span><span style="color:navy">,</span><span style="color:#008040">29</span><span style="color:navy">,</span><span style="color:#008040">30</span><span style="color:navy">,</span><span style="color:#008040">31
</span><span style="color:gray">DOSDATA:0C20                 </span><span style="color:navy">db &#039; !&quot;#$%&amp;&#039;,27h,&#039;()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ&#039;
</span><span style="color:gray">DOSDATA:0C20                 </span><span style="color:navy">db &#039;[\]^_`ABCDEFGHIJKLMNOPQRSTUVWXYZ{|}~&#039;
</span><span style="color:gray">DOSDATA:0C7F                 </span><span style="color:navy">db </span><span style="color:#008040">127
</span><span style="color:gray">DOSDATA:0C80                 </span><span style="color:navy">db &#039;CUEAAAACEEEIIIAAEAAOOOUUYOU$$$$$AIOUNN&#039;
</span><span style="color:gray">DOSDATA:0CA6                 </span><span style="color:navy">db </span><span style="color:#008040">166</span><span style="color:navy">,</span><span style="color:#008040">167
</span><span style="color:gray">DOSDATA:0CA8                 </span><span style="color:navy">db &#039;</span><span style="color:green">?&#039;
</span><span style="color:gray">DOSDATA:0CA9                 </span><span style="color:navy">db </span><span style="color:#008040">169</span><span style="color:navy">,</span><span style="color:#008040">170</span><span style="color:navy">,</span><span style="color:#008040">171</span><span style="color:navy">,</span><span style="color:#008040">172
</span><span style="color:gray">DOSDATA:0CAD                 </span><span style="color:navy">db &#039;</span><span style="color:green">!&#039;</span><span style="color:navy">,&#039;&quot;&#039;,&#039;&quot;&#039;
</span><span style="color:gray">DOSDATA:0CB0                 </span><span style="color:navy">db </span><span style="color:#008040">176</span><span style="color:navy">,</span><span style="color:#008040">177</span><span style="color:navy">,</span><span style="color:#008040">178</span><span style="color:navy">,</span><span style="color:#008040">179</span><span style="color:navy">,</span><span style="color:#008040">180</span><span style="color:navy">,</span><span style="color:#008040">181</span><span style="color:navy">,</span><span style="color:#008040">182</span><span style="color:navy">,</span><span style="color:#008040">183
</span><span style="color:gray">DOSDATA:0CB0                 </span><span style="color:navy">db </span><span style="color:#008040">184</span><span style="color:navy">,</span><span style="color:#008040">185</span><span style="color:navy">,</span><span style="color:#008040">186</span><span style="color:navy">,</span><span style="color:#008040">187</span><span style="color:navy">,</span><span style="color:#008040">188</span><span style="color:navy">,</span><span style="color:#008040">189</span><span style="color:navy">,</span><span style="color:#008040">190</span><span style="color:navy">,</span><span style="color:#008040">191
</span><span style="color:gray">DOSDATA:0CB0                 </span><span style="color:navy">db </span><span style="color:#008040">192</span><span style="color:navy">,</span><span style="color:#008040">193</span><span style="color:navy">,</span><span style="color:#008040">194</span><span style="color:navy">,</span><span style="color:#008040">195</span><span style="color:navy">,</span><span style="color:#008040">196</span><span style="color:navy">,</span><span style="color:#008040">197</span><span style="color:navy">,</span><span style="color:#008040">198</span><span style="color:navy">,</span><span style="color:#008040">199
</span><span style="color:gray">DOSDATA:0CB0                 </span><span style="color:navy">db </span><span style="color:#008040">200</span><span style="color:navy">,</span><span style="color:#008040">201</span><span style="color:navy">,</span><span style="color:#008040">202</span><span style="color:navy">,</span><span style="color:#008040">203</span><span style="color:navy">,</span><span style="color:#008040">204</span><span style="color:navy">,</span><span style="color:#008040">205</span><span style="color:navy">,</span><span style="color:#008040">206</span><span style="color:navy">,</span><span style="color:#008040">207
</span><span style="color:gray">DOSDATA:0CB0                 </span><span style="color:navy">db </span><span style="color:#008040">208</span><span style="color:navy">,</span><span style="color:#008040">209</span><span style="color:navy">,</span><span style="color:#008040">210</span><span style="color:navy">,</span><span style="color:#008040">211</span><span style="color:navy">,</span><span style="color:#008040">212</span><span style="color:navy">,</span><span style="color:#008040">213</span><span style="color:navy">,</span><span style="color:#008040">214</span><span style="color:navy">,</span><span style="color:#008040">215
</span><span style="color:gray">DOSDATA:0CB0                 </span><span style="color:navy">db </span><span style="color:#008040">216</span><span style="color:navy">,</span><span style="color:#008040">217</span><span style="color:navy">,</span><span style="color:#008040">218</span><span style="color:navy">,</span><span style="color:#008040">219</span><span style="color:navy">,</span><span style="color:#008040">220</span><span style="color:navy">,</span><span style="color:#008040">221</span><span style="color:navy">,</span><span style="color:#008040">222</span><span style="color:navy">,</span><span style="color:#008040">223
</span><span style="color:gray">DOSDATA:0CB0                 </span><span style="color:navy">db </span><span style="color:#008040">224
</span><span style="color:gray">DOSDATA:0CE1                 </span><span style="color:navy">db &#039;</span><span style="color:green">S&#039;
</span><span style="color:gray">DOSDATA:0CE2                 </span><span style="color:navy">db </span><span style="color:#008040">226</span><span style="color:navy">,</span><span style="color:#008040">227</span><span style="color:navy">,</span><span style="color:#008040">228</span><span style="color:navy">,</span><span style="color:#008040">229</span><span style="color:navy">,</span><span style="color:#008040">230</span><span style="color:navy">,</span><span style="color:#008040">231</span><span style="color:navy">,</span><span style="color:#008040">232</span><span style="color:navy">,</span><span style="color:#008040">233
</span><span style="color:gray">DOSDATA:0CE2                 </span><span style="color:navy">db </span><span style="color:#008040">234</span><span style="color:navy">,</span><span style="color:#008040">235</span><span style="color:navy">,</span><span style="color:#008040">236</span><span style="color:navy">,</span><span style="color:#008040">237</span><span style="color:navy">,</span><span style="color:#008040">238</span><span style="color:navy">,</span><span style="color:#008040">239</span><span style="color:navy">,</span><span style="color:#008040">240</span><span style="color:navy">,</span><span style="color:#008040">241
</span><span style="color:gray">DOSDATA:0CE2                 </span><span style="color:navy">db </span><span style="color:#008040">242</span><span style="color:navy">,</span><span style="color:#008040">243</span><span style="color:navy">,</span><span style="color:#008040">244</span><span style="color:navy">,</span><span style="color:#008040">245</span><span style="color:navy">,</span><span style="color:#008040">246</span><span style="color:navy">,</span><span style="color:#008040">247</span><span style="color:navy">,</span><span style="color:#008040">248</span><span style="color:navy">,</span><span style="color:#008040">249
</span><span style="color:gray">DOSDATA:0CE2                 </span><span style="color:navy">db </span><span style="color:#008040">250</span><span style="color:navy">,</span><span style="color:#008040">251</span><span style="color:navy">,</span><span style="color:#008040">252</span><span style="color:navy">,</span><span style="color:#008040">253</span><span style="color:navy">,</span><span style="color:#008040">254</span><span style="color:navy">,</span><span style="color:#008040">255
</span><span style="color:gray">DOSDATA:0D00 </span>DBCS_TAB        <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0D02 </span>DBCS_TAB_2      <span style="color:navy">db </span><span style="color:#008040">16 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0D12 </span>IBMDOSVERSION   <span style="color:navy">db </span><span style="color:#008040">7
</span><span style="color:gray">DOSDATA:0D13                 </span><span style="color:navy">db </span><span style="color:#008040">10                   </span>; MSVERSION
<span style="color:gray">DOSDATA:0D14 </span>YRTAB           <span style="color:navy">db </span><span style="color:#008040">200</span><span style="color:navy">,</span><span style="color:#008040">166</span><span style="color:navy">,</span><span style="color:#008040">200</span><span style="color:navy">,</span><span style="color:#008040">165</span><span style="color:navy">,</span><span style="color:#008040">200</span><span style="color:navy">,</span><span style="color:#008040">165</span><span style="color:navy">,</span><span style="color:#008040">200</span><span style="color:navy">,</span><span style="color:#008040">165 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0D1C </span>MONTAB          <span style="color:navy">db </span><span style="color:#008040">31                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0D1D </span>february        <span style="color:navy">db </span><span style="color:#008040">28                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0D1E                 </span><span style="color:navy">db </span><span style="color:#008040">31</span><span style="color:navy">, </span><span style="color:#008040">30</span><span style="color:navy">, </span><span style="color:#008040">31</span><span style="color:navy">, </span><span style="color:#008040">30</span><span style="color:navy">, </span><span style="color:#008040">31</span><span style="color:navy">, </span><span style="color:#008040">31</span><span style="color:navy">, </span><span style="color:#008040">30</span><span style="color:navy">, </span><span style="color:#008040">31</span><span style="color:navy">, </span><span style="color:#008040">30</span><span style="color:navy">, </span><span style="color:#008040">31
</span><span style="color:gray">DOSDATA:0D28 </span>FILE_CHAR_TAB   <span style="color:navy">dw </span><span style="color:#008040">22                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0D28                                         </span>; length
<span style="color:gray">DOSDATA:0D2A                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; include all
<span style="color:gray">DOSDATA:0D2B                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0D2C                 </span><span style="color:navy">db </span><span style="color:#008040">255
</span><span style="color:gray">DOSDATA:0D2D                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; exclude 0 - 20h
<span style="color:gray">DOSDATA:0D2E                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0D2F                 </span><span style="color:navy">db </span><span style="color:#008040">20h
</span><span style="color:gray">DOSDATA:0D30                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0D31                 </span><span style="color:navy">db </span><span style="color:#008040">14                   </span>; exclude 14 special
<span style="color:gray">DOSDATA:0D32                 </span><span style="color:navy">db &#039;.&quot;/\[]:|&lt;&gt;+=;,&#039;
</span><span style="color:gray">DOSDATA:0D40                 </span><span style="color:navy">db </span><span style="color:#008040">24 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span>; reserved
<span style="color:gray">DOSDATA:0D58 </span>SysInitTable    <span style="color:navy">dw offset </span>DPBHEAD       <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0D58                                         </span>; SYSINITVARS
<span style="color:gray">DOSDATA:0D5A                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0D5C                 </span><span style="color:navy">dw offset </span>COUNTRY_CDPG
<span style="color:gray">DOSDATA:0D5E                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0D60                 </span><span style="color:navy">db </span><span style="color:#008040">3 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">DOSDATA:0D63 </span>TEMPSEG         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0D65 </span>redir_patch     <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0D66 </span>DosHasHMA       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0D67 </span>FixExePatch     <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0D69 </span>RationalPatchPtr <span style="color:navy">dw </span><span style="color:#008040">0                   </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:0D6B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0D6B
DOSDATA:0D6B </span>MAP_CASE<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:0D6B                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">80h
</span><span style="color:maroon">DOSDATA:0D6D                 </span><span style="color:navy">jb      short </span>L_RET     ; Map no chars below 80H ever
<span style="color:maroon">DOSDATA:0D6F
DOSDATA:0D6F </span>Map1<span style="color:navy">:                                   </span>;
<span style="color:maroon">DOSDATA:0D6F                 </span><span style="color:navy">sub     al, </span><span style="color:#ff8000">80h         </span>; Turn into index value
<span style="color:maroon">DOSDATA:0D71                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSDATA:0D72                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSDATA:0D73                 </span><span style="color:navy">mov     bx, offset </span>UCASE_TAB_2 ; UCASE_TAB+2
<span style="color:maroon">DOSDATA:0D76                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">DOSDATA:0D77                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSDATA:0D78                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSDATA:0D78                 </span><span style="color:navy">xlat                    </span>; Get upper case character
<span style="color:maroon">DOSDATA:0D79                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSDATA:0D7A                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSDATA:0D7B                 </span>assume ds:nothing
<span style="color:maroon">DOSDATA:0D7B
DOSDATA:0D7B </span>L_RET<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSDATA:0D7B                 </span><span style="color:navy">retf
</span><span style="color:maroon">DOSDATA:0D7B </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSDATA:0D7C </span>Dir_Info_Buff   <span style="color:navy">db </span><span style="color:#008040">32 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0D9C </span>Next_Element_Start <span style="color:navy">dw </span><span style="color:#008040">0                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0D9E </span>USER_SP_2F      <span style="color:navy">dw offset </span>FAKE_STACK_2F <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0DA0 </span>FAKE_STACK_2F   <span style="color:navy">dw </span><span style="color:#008040">14 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0DA0                                         </span>; Packet_Temp
<span style="color:gray">DOSDATA:0DBC </span>SCAN_FLAG       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0DBD </span>DATE_FLAG       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0DBF </span>AbsDskErr       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0DBF                                         </span>; Storage for Abs dsk read/write err
<span style="color:gray">DOSDATA:0DC1 </span>NO_NAME_ID      <span style="color:navy">db &#039;NO NAME    &#039;        </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0DC1                                         </span>; null media id
<span style="color:olive">DOSDATA:0DCC                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:maroon">DOSDATA:0DCD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0DCD
DOSDATA:0DCD </span>SNULDEV<span style="color:navy">:                                </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:0DCD                 </span><span style="color:navy">or      word ptr es:[bx+</span><span style="color:#ff8000">3</span><span style="color:navy">], </span><span style="color:green">100h </span>; [es:bx+SRHEAD.REQSTAT+1],(STDON&gt;&gt;8)
<span style="color:maroon">DOSDATA:0DD3
DOSDATA:0DD3 </span>INULDEV<span style="color:navy">:                                </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:0DD3                 </span><span style="color:navy">retf
</span><span style="color:maroon">DOSDATA:0DD3 </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSDATA:0DD4                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0DD5 </span>UmbSave2        <span style="color:navy">db </span><span style="color:#008040">5 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0DDA </span>UmbSaveFlag     <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0DDB </span>ERR_TABLE_21    <span style="color:navy">db    </span><span style="color:#008040">1</span><span style="color:navy">,   </span><span style="color:#008040">7</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,</span><span style="color:#008040">0FFh  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db    </span><span style="color:#008040">2</span><span style="color:navy">,   </span><span style="color:#008040">8</span><span style="color:navy">,   </span><span style="color:#008040">3</span><span style="color:navy">,   </span><span style="color:#008040">2  </span>; CLASS ACTION and LOCUS info for the INT 21h errors
<span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db    </span><span style="color:#008040">3</span><span style="color:navy">,   </span><span style="color:#008040">8</span><span style="color:navy">,   </span><span style="color:#008040">3</span><span style="color:navy">,   </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db    </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">1</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db    </span><span style="color:#008040">5</span><span style="color:navy">,   </span><span style="color:#008040">3</span><span style="color:navy">,   </span><span style="color:#008040">3</span><span style="color:navy">,</span><span style="color:#008040">0FFh
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db    </span><span style="color:#008040">6</span><span style="color:navy">,   </span><span style="color:#008040">7</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db    </span><span style="color:#008040">7</span><span style="color:navy">,   </span><span style="color:#008040">7</span><span style="color:navy">,   </span><span style="color:#008040">5</span><span style="color:navy">,   </span><span style="color:#008040">5
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db    </span><span style="color:#008040">8</span><span style="color:navy">,   </span><span style="color:#008040">1</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">5
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db    </span><span style="color:#008040">9</span><span style="color:navy">,   </span><span style="color:#008040">7</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">5
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">0Ah</span><span style="color:navy">,   </span><span style="color:#008040">7</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">5
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">0Bh</span><span style="color:navy">,   </span><span style="color:#008040">9</span><span style="color:navy">,   </span><span style="color:#008040">3</span><span style="color:navy">,   </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">0Ch</span><span style="color:navy">,   </span><span style="color:#008040">7</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">0Dh</span><span style="color:navy">,   </span><span style="color:#008040">9</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">0Fh</span><span style="color:navy">,   </span><span style="color:#008040">8</span><span style="color:navy">,   </span><span style="color:#008040">3</span><span style="color:navy">,   </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">10h</span><span style="color:navy">,   </span><span style="color:#008040">3</span><span style="color:navy">,   </span><span style="color:#008040">3</span><span style="color:navy">,   </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">11h</span><span style="color:navy">, </span><span style="color:#008040">0Dh</span><span style="color:navy">,   </span><span style="color:#008040">3</span><span style="color:navy">,   </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">12h</span><span style="color:navy">,   </span><span style="color:#008040">8</span><span style="color:navy">,   </span><span style="color:#008040">3</span><span style="color:navy">,   </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">0Ch</span><span style="color:navy">,   </span><span style="color:#008040">3</span><span style="color:navy">,   </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0Ah</span><span style="color:navy">,   </span><span style="color:#008040">2</span><span style="color:navy">,   </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">21h</span><span style="color:navy">, </span><span style="color:#008040">0Ah</span><span style="color:navy">,   </span><span style="color:#008040">2</span><span style="color:navy">,   </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">54h</span><span style="color:navy">,   </span><span style="color:#008040">1</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,</span><span style="color:#008040">0FFh
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">56h</span><span style="color:navy">,   </span><span style="color:#008040">3</span><span style="color:navy">,   </span><span style="color:#008040">3</span><span style="color:navy">,   </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">52h</span><span style="color:navy">,   </span><span style="color:#008040">1</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">32h</span><span style="color:navy">,   </span><span style="color:#008040">9</span><span style="color:navy">,   </span><span style="color:#008040">3</span><span style="color:navy">,   </span><span style="color:#008040">3
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">55h</span><span style="color:navy">, </span><span style="color:#008040">0Ch</span><span style="color:navy">,   </span><span style="color:#008040">3</span><span style="color:navy">,   </span><span style="color:#008040">3
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">57h</span><span style="color:navy">,   </span><span style="color:#008040">9</span><span style="color:navy">,   </span><span style="color:#008040">3</span><span style="color:navy">,   </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">53h</span><span style="color:navy">, </span><span style="color:#008040">0Dh</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">24h</span><span style="color:navy">,   </span><span style="color:#008040">1</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">5
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">26h</span><span style="color:navy">,   </span><span style="color:#008040">1</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">27h</span><span style="color:navy">,   </span><span style="color:#008040">1</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db  </span><span style="color:#008040">5Ah</span><span style="color:navy">, </span><span style="color:#008040">0Dh</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0DDB                 </span><span style="color:navy">db </span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh
</span><span style="color:gray">DOSDATA:0E5B </span>ERR_TABLE_24    <span style="color:navy">db  </span><span style="color:#008040">13h</span><span style="color:navy">, </span><span style="color:#008040">0Bh</span><span style="color:navy">,   </span><span style="color:#008040">7</span><span style="color:navy">,   </span><span style="color:#008040">2  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">14h</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">5</span><span style="color:navy">,   </span><span style="color:#008040">1  </span>; CLASS ACTION and LOCUS info for the INT 24h errors
<span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">15h</span><span style="color:navy">,   </span><span style="color:#008040">5</span><span style="color:navy">,   </span><span style="color:#008040">7</span><span style="color:navy">,</span><span style="color:#008040">0FFh
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">16h</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">5</span><span style="color:navy">,   </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">17h</span><span style="color:navy">, </span><span style="color:#008040">0Bh</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">18h</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">5</span><span style="color:navy">,   </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">19h</span><span style="color:navy">,   </span><span style="color:#008040">5</span><span style="color:navy">,   </span><span style="color:#008040">1</span><span style="color:navy">,   </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">1Ah</span><span style="color:navy">, </span><span style="color:#008040">0Bh</span><span style="color:navy">,   </span><span style="color:#008040">7</span><span style="color:navy">,   </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">1Bh</span><span style="color:navy">, </span><span style="color:#008040">0Bh</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">1Ch</span><span style="color:navy">,   </span><span style="color:#008040">2</span><span style="color:navy">,   </span><span style="color:#008040">7</span><span style="color:navy">,   </span><span style="color:#008040">4
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">1Dh</span><span style="color:navy">,   </span><span style="color:#008040">5</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,</span><span style="color:#008040">0FFh
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">1Eh</span><span style="color:navy">,   </span><span style="color:#008040">5</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,</span><span style="color:#008040">0FFh
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">1Fh</span><span style="color:navy">, </span><span style="color:#008040">0Dh</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,</span><span style="color:#008040">0FFh
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0Ah</span><span style="color:navy">,   </span><span style="color:#008040">2</span><span style="color:navy">,   </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">21h</span><span style="color:navy">, </span><span style="color:#008040">0Ah</span><span style="color:navy">,   </span><span style="color:#008040">2</span><span style="color:navy">,   </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">22h</span><span style="color:navy">, </span><span style="color:#008040">0Bh</span><span style="color:navy">,   </span><span style="color:#008040">7</span><span style="color:navy">,   </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">32h</span><span style="color:navy">,   </span><span style="color:#008040">9</span><span style="color:navy">,   </span><span style="color:#008040">3</span><span style="color:navy">,   </span><span style="color:#008040">3
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">23h</span><span style="color:navy">,   </span><span style="color:#008040">7</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db  </span><span style="color:#008040">24h</span><span style="color:navy">,   </span><span style="color:#008040">1</span><span style="color:navy">,   </span><span style="color:#008040">4</span><span style="color:navy">,   </span><span style="color:#008040">5
</span><span style="color:gray">DOSDATA:0E5B                 </span><span style="color:navy">db </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">0Dh</span><span style="color:navy">,   </span><span style="color:#008040">5</span><span style="color:navy">,</span><span style="color:#008040">0FFh
</span><span style="color:gray">DOSDATA:0EAB </span>ErrMap24        <span style="color:navy">db  </span><span style="color:#008040">13h</span><span style="color:navy">, </span><span style="color:#008040">14h</span><span style="color:navy">, </span><span style="color:#008040">15h</span><span style="color:navy">, </span><span style="color:#008040">16h</span><span style="color:navy">, </span><span style="color:#008040">17h</span><span style="color:navy">, </span><span style="color:#008040">18h</span><span style="color:navy">, </span><span style="color:#008040">19h</span><span style="color:navy">, </span><span style="color:#008040">1Ah </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0EAB                 </span><span style="color:navy">db  </span><span style="color:#008040">1Bh</span><span style="color:navy">, </span><span style="color:#008040">1Ch</span><span style="color:navy">, </span><span style="color:#008040">1Dh</span><span style="color:navy">, </span><span style="color:#008040">1Eh</span><span style="color:navy">, </span><span style="color:#008040">1Fh</span><span style="color:navy">, </span><span style="color:#008040">1Fh</span><span style="color:navy">, </span><span style="color:#008040">1Fh</span><span style="color:navy">, </span><span style="color:#008040">22h
</span><span style="color:gray">DOSDATA:0EBB </span>SPECIAL_VERSION <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0EBD </span>OLD_FIRSTCLUS   <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0EBF </span>exec_init_SP    <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0EC3 </span>exec_init_IP    <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0EC7                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0EC9                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0ECB                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0ECD                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0ECF                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0ED1                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0ED3                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0ED5                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0ED7                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0ED9                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0EDB                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0EDD                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0EDF                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0EE1 </span>Win386_Info     <span style="color:navy">db </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">0                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0EE1                                         </span>; WIN386_SIS version
<span style="color:gray">DOSDATA:0EE3                 </span><span style="color:navy">dd </span><span style="color:#008040">0                    </span>; .Next_Dev_Ptr
<span style="color:gray">DOSDATA:0EE7 </span>Win386_Inf_Virt_Dev_Ptr <span style="color:navy">dd </span><span style="color:#008040">0            </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0EE7                                         </span>; .Virt_Dev_File_Ptr
<span style="color:gray">DOSDATA:0EEB                 </span><span style="color:navy">dd </span><span style="color:#008040">0                    </span>; .Reference_Data
<span style="color:gray">DOSDATA:0EEF </span>Instance_Data_Ptr <span style="color:navy">dw offset </span>Instance_Table
<span style="color:gray">DOSDATA:0EF1 </span><span style="color:navy">word_EF1        dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0EF3                 </span><span style="color:navy">dw offset </span>Unknown_Table
<span style="color:gray">DOSDATA:0EF5                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; Win386_IIS.size
<span style="color:gray">DOSDATA:0EF7 </span>Instance_Table  <span style="color:navy">dw offset </span>CONTPOS       <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0EF9 </span>InsTBL_CONTPOS_seg <span style="color:navy">dw </span><span style="color:#008040">0                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0EFB                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0EFD                 </span><span style="color:navy">dw offset </span>BCON
<span style="color:gray">DOSDATA:0EFF                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0F01                 </span><span style="color:navy">dw </span><span style="color:#008040">4
</span><span style="color:gray">DOSDATA:0F03                 </span><span style="color:navy">dw offset </span>CARPOS
<span style="color:gray">DOSDATA:0F05                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0F07                 </span><span style="color:navy">dw </span><span style="color:#008040">106h
</span><span style="color:gray">DOSDATA:0F09                 </span><span style="color:navy">dw offset </span>CHARCO
<span style="color:gray">DOSDATA:0F0B                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0F0D                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0F0F                 </span><span style="color:navy">dw offset </span>exec_init_SP
<span style="color:gray">DOSDATA:0F11                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0F13                 </span><span style="color:navy">dw </span><span style="color:#008040">22h
</span><span style="color:gray">DOSDATA:0F15                 </span><span style="color:navy">dw offset </span>UMBFLAG
<span style="color:gray">DOSDATA:0F17                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0F19                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0F1B                 </span><span style="color:navy">dw offset </span>UMB_HEAD
<span style="color:gray">DOSDATA:0F1D                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0F1F                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:0F21                 </span><span style="color:navy">dw offset </span>DOS_FLAG
<span style="color:gray">DOSDATA:0F23                 </span><span style="color:navy">dw </span><span style="color:#008040">0C9h
</span><span style="color:gray">DOSDATA:0F25                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0F27                 </span><span style="color:navy">dw offset </span>INDOS_FLAG    ; what for ?
<span style="color:gray">DOSDATA:0F29                 </span><span style="color:navy">dw </span><span style="color:#008040">0C9h
</span><span style="color:gray">DOSDATA:0F2B                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0F2D                 </span><span style="color:navy">dw offset </span>DEVIO_IN_PROGRESS ; &quot;devio call in progress&quot; status flag ptr
<span style="color:gray">DOSDATA:0F2F                 </span><span style="color:navy">dw </span><span style="color:#008040">0C9h
</span><span style="color:gray">DOSDATA:0F31                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:0F33                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0F35                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0F37                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">DOSDATA:0F39                 </span><span style="color:navy">dw </span><span style="color:#008040">0FFFFh
</span><span style="color:gray">DOSDATA:0F3B </span>CL0FATENTRY_HW  <span style="color:navy">dw </span><span style="color:#008040">0FFFFh               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0F3D </span>Unknown_Table   <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0F3F                 </span><span style="color:navy">dw </span><span style="color:#008040">0C9h
</span><span style="color:gray">DOSDATA:0F41                 </span><span style="color:navy">dw offset </span>SFTABL
<span style="color:gray">DOSDATA:0F43                 </span><span style="color:navy">dw offset </span>CARPOS
<span style="color:gray">DOSDATA:0F45                 </span><span style="color:navy">dw </span><span style="color:#008040">0C9h
</span><span style="color:gray">DOSDATA:0F47                 </span><span style="color:navy">dw </span><span style="color:#008040">114Dh                </span>; ?
<span style="color:gray">DOSDATA:0F49                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0F4B                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:0F4D </span>Win386_DOSVars  <span style="color:navy">db </span><span style="color:#008040">5                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0F4D                                         </span>; Major_version
<span style="color:gray">DOSDATA:0F4E                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; Minor_version
<span style="color:gray">DOSDATA:0F4F                 </span><span style="color:navy">dw offset </span>SAVEDS
<span style="color:gray">DOSDATA:0F51                 </span><span style="color:navy">dw offset </span>SAVEBX
<span style="color:gray">DOSDATA:0F53                 </span><span style="color:navy">dw offset </span>INDOS
<span style="color:gray">DOSDATA:0F55                 </span><span style="color:navy">dw offset </span>USER_ID
<span style="color:gray">DOSDATA:0F57                 </span><span style="color:navy">dw offset </span>CritPatch
<span style="color:gray">DOSDATA:0F59                 </span><span style="color:navy">dw offset </span>UMB_HEAD
<span style="color:gray">DOSDATA:0F5B </span>IsWin386        <span style="color:navy">db </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0F5D                 </span><span style="color:navy">db </span><span style="color:#008040">36h</span><span style="color:navy">,</span><span style="color:#008040">0F6h</span><span style="color:navy">, </span><span style="color:#008040">6</span><span style="color:navy">,</span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">,</span><span style="color:#008040">0FFh </span>; Patch for Sidekick
<span style="color:gray">DOSDATA:0F63                 </span><span style="color:navy">db </span><span style="color:#008040">75h</span><span style="color:navy">, </span><span style="color:#008040">0Ch
</span><span style="color:gray">DOSDATA:0F65                 </span><span style="color:navy">db </span><span style="color:#008040">36h</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">36h</span><span style="color:navy">, </span><span style="color:#008040">58h</span><span style="color:navy">, </span><span style="color:#008040">3
</span><span style="color:gray">DOSDATA:0F6A                 </span><span style="color:navy">db </span><span style="color:#008040">0CDh</span><span style="color:navy">, </span><span style="color:#008040">28h
</span><span style="color:gray">DOSDATA:0F6C                 </span><span style="color:navy">db </span><span style="color:#008040">80h</span><span style="color:navy">,</span><span style="color:#008040">3Eh</span><span style="color:navy">,</span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">0    </span>; Patch for PortOfEntry
<span style="color:gray">DOSDATA:0F71                 </span><span style="color:navy">db </span><span style="color:#008040">75h</span><span style="color:navy">, </span><span style="color:#008040">37h
</span><span style="color:gray">DOSDATA:0F73                 </span><span style="color:navy">db </span><span style="color:#008040">0BCh</span><span style="color:navy">, </span><span style="color:#008040">0A0h</span><span style="color:navy">, </span><span style="color:#008040">0Ah
</span><span style="color:gray">DOSDATA:0F76 </span>LocalSFT        <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0F7A </span>DOSINTTABLE     <span style="color:navy">dd </span>DIVOV                <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0F7E </span>DOSINTTABLE_4   <span style="color:navy">dd </span>QUIT                 <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0F82 </span>DOSINTTABLE_8   <span style="color:navy">dd </span>COMMAND              <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0F86 </span>DOSINTTABLE_12  <span style="color:navy">dd </span>ABSDRD               <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0F8A </span>DOSINTTABLE_16  <span style="color:navy">dd </span>ABSDWRT              <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0F8E </span>DOSINTTABLE_20  <span style="color:navy">dd </span>stay_resident        <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0F92 </span>DOSINTTABLE_24  <span style="color:navy">dd </span>INT2F                <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0F96 </span>DOSINTTABLE_28  <span style="color:navy">dd </span>CALL_ENTRY           <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0F9A </span>SS_Save         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0F9C </span>SP_Save         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:0F9E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0F9E
DOSDATA:0F9E </span>ldivov<span style="color:navy">:                                 </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:0F9E                 </span><span style="color:navy">jmp     short </span>divov_cont
<span style="color:maroon">DOSDATA:0FA0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0FA0                 </span><span style="color:navy">call    </span>EnsureA20ON
<span style="color:maroon">DOSDATA:0FA3
DOSDATA:0FA3 </span>divov_cont<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSDATA:0FA3                 </span><span style="color:navy">jmp     cs:</span>DOSINTTABLE
<span style="color:maroon">DOSDATA:0FA8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0FA8
DOSDATA:0FA8 </span>lquit<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:0FA8                 </span><span style="color:navy">jmp     short </span>quit_cont
<span style="color:maroon">DOSDATA:0FAA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0FAA                 </span><span style="color:navy">call    </span>EnsureA20ON
<span style="color:maroon">DOSDATA:0FAD
DOSDATA:0FAD </span>quit_cont<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSDATA:0FAD                 </span><span style="color:navy">jmp     cs:</span>DOSINTTABLE_4
<span style="color:maroon">DOSDATA:0FB2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0FB2
DOSDATA:0FB2 </span>lcommand<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:0FB2                 </span><span style="color:navy">jmp     short </span>command_cont
<span style="color:maroon">DOSDATA:0FB4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0FB4                 </span><span style="color:navy">call    </span>EnsureA20ON
<span style="color:maroon">DOSDATA:0FB7
DOSDATA:0FB7 </span>command_cont<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSDATA:0FB7                 </span><span style="color:navy">jmp     cs:</span>DOSINTTABLE_8
<span style="color:maroon">DOSDATA:0FBC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0FBC
DOSDATA:0FBC </span>labsdrd<span style="color:navy">:                                </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:0FBC                 </span><span style="color:navy">jmp     short </span>absdrd_cont
<span style="color:maroon">DOSDATA:0FBE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0FBE                 </span><span style="color:navy">call    </span>EnsureA20ON
<span style="color:maroon">DOSDATA:0FC1
DOSDATA:0FC1 </span>absdrd_cont<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSDATA:0FC1                 </span><span style="color:navy">jmp     cs:</span>DOSINTTABLE_12
<span style="color:maroon">DOSDATA:0FC6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0FC6
DOSDATA:0FC6 </span>labsdwrt<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:0FC6                 </span><span style="color:navy">jmp     short </span>absdwrt_cont
<span style="color:maroon">DOSDATA:0FC8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0FC8                 </span><span style="color:navy">call    </span>EnsureA20ON
<span style="color:maroon">DOSDATA:0FCB
DOSDATA:0FCB </span>absdwrt_cont<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSDATA:0FCB                 </span><span style="color:navy">jmp     cs:</span>DOSINTTABLE_16
<span style="color:maroon">DOSDATA:0FD0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0FD0
DOSDATA:0FD0 </span>lstay_resident<span style="color:navy">:                         </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:0FD0                 </span><span style="color:navy">jmp     short </span>sr_cont
<span style="color:maroon">DOSDATA:0FD2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0FD2                 </span><span style="color:navy">call    </span>EnsureA20ON
<span style="color:maroon">DOSDATA:0FD5
DOSDATA:0FD5 </span>sr_cont<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSDATA:0FD5                 </span><span style="color:navy">jmp     cs:</span>DOSINTTABLE_20
<span style="color:maroon">DOSDATA:0FDA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0FDA
DOSDATA:0FDA </span>lint2f<span style="color:navy">:                                 </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:0FDA                 </span><span style="color:navy">jmp     short </span>int2f_cont
<span style="color:maroon">DOSDATA:0FDC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0FDC                 </span><span style="color:navy">call    </span>EnsureA20ON
<span style="color:maroon">DOSDATA:0FDF
DOSDATA:0FDF </span>int2f_cont<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSDATA:0FDF                 </span><span style="color:navy">jmp     cs:</span>DOSINTTABLE_24
<span style="color:maroon">DOSDATA:0FE4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0FE4
DOSDATA:0FE4 </span>lcall_entry<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:0FE4                 </span><span style="color:navy">jmp     short </span>callentry_cont
<span style="color:maroon">DOSDATA:0FE6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0FE6                 </span><span style="color:navy">call    </span>EnsureA20ON
<span style="color:maroon">DOSDATA:0FE9
DOSDATA:0FE9 </span>callentry_cont<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">DOSDATA:0FE9                 </span><span style="color:navy">jmp     cs:</span>DOSINTTABLE_28
<span style="color:maroon">DOSDATA:0FE9 </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSDATA:0FEE </span>DosRetAddr23    <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:0FF2 </span>DosRetAddr24    <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:0FF6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:0FF6
DOSDATA:0FF6 </span>LowInt23<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:0FF6                 </span><span style="color:navy">pop     word ptr cs:</span>DosRetAddr23
<span style="color:maroon">DOSDATA:0FFB                 </span><span style="color:navy">pop     word ptr cs:</span>DosRetAddr23<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:maroon">DOSDATA:1000                 </span><span style="color:navy">int     </span><span style="color:green">23h             </span>; DOS - CONTROL &quot;C&quot; EXIT ADDRESS
<span style="color:maroon">DOSDATA:1000                                         </span>; Return: return via RETF 2 with CF set
<span style="color:maroon">DOSDATA:1000                                         </span>; DOS will abort program with errorlevel 0
<span style="color:maroon">DOSDATA:1000                                         </span>; else
<span style="color:maroon">DOSDATA:1000                                         </span>; interrupted DOS call continues
<span style="color:maroon">DOSDATA:1002                 </span><span style="color:navy">call    </span>EnsureA20ON
<span style="color:maroon">DOSDATA:1005                 </span><span style="color:navy">jmp     cs:</span>DosRetAddr23
<span style="color:maroon">DOSDATA:100A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:100A
DOSDATA:100A </span>LowInt24<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:100A                 </span><span style="color:navy">pop     word ptr cs:</span>DosRetAddr24
<span style="color:maroon">DOSDATA:100F                 </span><span style="color:navy">pop     word ptr cs:</span>DosRetAddr24<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:maroon">DOSDATA:1014                 </span><span style="color:navy">int     </span><span style="color:green">24h             </span>; DOS - FATAL ERROR HANDLER ADDRESS
<span style="color:maroon">DOSDATA:1014                                         </span>; Automatically called upon detection of unrecoverable I/O error.
<span style="color:maroon">DOSDATA:1016                 </span><span style="color:navy">call    </span>EnsureA20ON
<span style="color:maroon">DOSDATA:1019                 </span><span style="color:navy">jmp     cs:</span>DosRetAddr24
<span style="color:maroon">DOSDATA:101E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:101E
DOSDATA:101E </span>LowInt28<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:101E                 </span><span style="color:navy">int     </span><span style="color:green">28h             </span>; DOS 2+ internal - KEYBOARD BUSY LOOP
<span style="color:maroon">DOSDATA:1020                 </span><span style="color:navy">call    </span>EnsureA20ON
<span style="color:maroon">DOSDATA:1023                 </span><span style="color:navy">retf
</span><span style="color:maroon">DOSDATA:1024 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:1024
DOSDATA:1024 </span>disa20_xfer<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:1024                 </span><span style="color:navy">call    </span>XMMDisableA20
<span style="color:maroon">DOSDATA:1027                 </span><span style="color:navy">cli
</span><span style="color:maroon">DOSDATA:1028                 </span><span style="color:navy">mov     cs:</span>INDOS<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSDATA:102E                 </span><span style="color:navy">mov     ss:</span>INDOS_FLAG<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSDATA:1034                 </span><span style="color:navy">mov     ss, ax
</span><span style="color:maroon">DOSDATA:1036                 </span><span style="color:navy">mov     sp, di
</span><span style="color:maroon">DOSDATA:1038                 </span><span style="color:navy">sti
</span><span style="color:maroon">DOSDATA:1039                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSDATA:103A                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSDATA:103B                 </span><span style="color:navy">mov     es, dx
</span><span style="color:maroon">DOSDATA:103D                 </span><span style="color:navy">mov     ds, dx
</span><span style="color:maroon">DOSDATA:103F                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:maroon">DOSDATA:1041                 </span><span style="color:navy">retf
</span><span style="color:maroon">DOSDATA:1042 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:1042
DOSDATA:1042 </span>disa20_iret<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:1042                 </span><span style="color:navy">call    </span>XMMDisableA20
<span style="color:maroon">DOSDATA:1045                 </span><span style="color:navy">dec     ds:</span>INDOS
<span style="color:maroon">DOSDATA:1049                 </span><span style="color:navy">dec     ds:</span>INDOS_FLAG
<span style="color:maroon">DOSDATA:104D                 </span><span style="color:navy">mov     ss, ds:</span>USER_SS
<span style="color:maroon">DOSDATA:1051                 </span><span style="color:navy">mov     sp, ds:</span>USER_SP
<span style="color:maroon">DOSDATA:1055                 </span><span style="color:navy">mov     bp, sp
</span><span style="color:maroon">DOSDATA:1057                 </span><span style="color:navy">mov     [bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], al
</span><span style="color:maroon">DOSDATA:105A                 </span><span style="color:navy">les     ax, dword ptr ds:</span>NSS
<span style="color:maroon">DOSDATA:105E                 </span><span style="color:navy">mov     ds:</span>USER_SP<span style="color:navy">, es
</span><span style="color:maroon">DOSDATA:1062                 </span><span style="color:navy">mov     ds:</span>USER_SS<span style="color:navy">, ax
</span><span style="color:maroon">DOSDATA:1065                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSDATA:1066                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSDATA:1067                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSDATA:1068                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSDATA:1069                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSDATA:106A                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSDATA:106B                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSDATA:106C                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSDATA:106D                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSDATA:106E
DOSDATA:106E </span>lirett<span style="color:navy">:                                 </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:106E                 </span><span style="color:navy">iret
</span><span style="color:black">DOSDATA:106F
DOSDATA:106F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSDATA:106F
DOSDATA:106F
DOSDATA:106F </span>XMMDisableA20   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSDATA:106F                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSDATA:1070                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSDATA:1071                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSDATA:1073                 </span><span style="color:navy">call    cs:</span>XMMcontrol
<span style="color:black">DOSDATA:1078                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSDATA:1079                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSDATA:107A                 </span><span style="color:navy">retn
</span><span style="color:black">DOSDATA:107A </span>XMMDisableA20   <span style="color:black">endp
DOSDATA:107A
DOSDATA:107A </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSDATA:107B </span>XMMcontrol      <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:107F                 </span><span style="color:navy">dd </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:1083 </span>SC_STATUS       <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSDATA:1085
DOSDATA:1085 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSDATA:1085
DOSDATA:1085
DOSDATA:1085 </span>EnsureA20ON     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSDATA:1085                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSDATA:1086                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSDATA:1087                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSDATA:1088                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSDATA:1089                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSDATA:108A                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSDATA:108B                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">DOSDATA:108D                 </span><span style="color:navy">mov     ds, si
</span><span style="color:black">DOSDATA:108F                 </span>assume ds:DOSCODE
<span style="color:black">DOSDATA:108F                 </span><span style="color:navy">dec     si
</span><span style="color:black">DOSDATA:1090                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">90h
</span><span style="color:black">DOSDATA:1093                 </span><span style="color:navy">mov     es, si
</span><span style="color:black">DOSDATA:1095                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">80h
</span><span style="color:black">DOSDATA:1098                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4
</span><span style="color:black">DOSDATA:109B                 </span><span style="color:navy">cld
</span><span style="color:black">DOSDATA:109C                 </span><span style="color:navy">repe cmpsw
</span><span style="color:black">DOSDATA:109E                 </span><span style="color:navy">jz      short loc_10A7
</span><span style="color:black">DOSDATA:10A0
DOSDATA:10A0 </span><span style="color:navy">loc_10A0:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSDATA:10A0                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSDATA:10A1                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSDATA:10A2                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSDATA:10A3                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSDATA:10A4                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSDATA:10A5                 </span>assume ds:nothing
<span style="color:black">DOSDATA:10A5                 </span><span style="color:navy">popf
</span><span style="color:black">DOSDATA:10A6                 </span><span style="color:navy">retn
</span><span style="color:black">DOSDATA:10A7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSDATA:10A7
DOSDATA:10A7 </span><span style="color:navy">loc_10A7:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSDATA:10A7                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSDATA:10A8                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSDATA:10A9                 </span><span style="color:navy">mov     ax, cs
</span><span style="color:black">DOSDATA:10AB                 </span><span style="color:navy">mov     cs:</span>SS_Save<span style="color:navy">, ss
</span><span style="color:black">DOSDATA:10B0                 </span><span style="color:navy">mov     cs:</span>SP_Save<span style="color:navy">, sp
</span><span style="color:black">DOSDATA:10B5                 </span><span style="color:navy">mov     ss, ax
</span><span style="color:black">DOSDATA:10B7                 </span>assume ss:DOSCODE
<span style="color:black">DOSDATA:10B7                 </span><span style="color:navy">mov     sp, offset </span>AUXSTACK
<span style="color:black">DOSDATA:10BA                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">5
</span><span style="color:black">DOSDATA:10BC                 </span><span style="color:navy">call    cs:</span>XMMcontrol
<span style="color:black">DOSDATA:10C1                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSDATA:10C3                 </span><span style="color:navy">jz      short loc_10D3
</span><span style="color:black">DOSDATA:10C5                 </span><span style="color:navy">mov     ss, cs:</span>SS_Save
<span style="color:black">DOSDATA:10CA                 </span>assume ss:nothing
<span style="color:black">DOSDATA:10CA                 </span><span style="color:navy">mov     sp, cs:</span>SP_Save
<span style="color:black">DOSDATA:10CF                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSDATA:10D0                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSDATA:10D1                 </span><span style="color:navy">jmp     short loc_10A0
</span><span style="color:black">DOSDATA:10D3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSDATA:10D3
DOSDATA:10D3 </span><span style="color:navy">loc_10D3:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSDATA:10D3                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0Fh
</span><span style="color:black">DOSDATA:10D5                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - GET CURRENT VIDEO MODE
<span style="color:black">DOSDATA:10D5                                         </span>; Return: AH = number of columns on screen
<span style="color:black">DOSDATA:10D5                                         </span>; AL = current video mode
<span style="color:black">DOSDATA:10D5                                         </span>; BH = current active display page
<span style="color:black">DOSDATA:10D7                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">7
</span><span style="color:black">DOSDATA:10D9                 </span><span style="color:navy">jz      short loc_10E0
</span><span style="color:black">DOSDATA:10DB                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSDATA:10DE                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - SET VIDEO MODE
<span style="color:black">DOSDATA:10DE                                         </span>; AL = mode
<span style="color:black">DOSDATA:10E0
DOSDATA:10E0 </span><span style="color:navy">loc_10E0:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSDATA:10E0                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">500h
</span><span style="color:black">DOSDATA:10E3                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - SELECT DISPLAY PAGE
<span style="color:black">DOSDATA:10E3                                         </span>; AL = display page, 0-7  for modes 0 &amp; 1, 0-3  for modes 2 &amp; 3
<span style="color:black">DOSDATA:10E5                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">1213h
</span><span style="color:black">DOSDATA:10E8                 </span><span style="color:navy">push    cs
</span><span style="color:black">DOSDATA:10E9                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSDATA:10EA                 </span>assume ds:DOSCODE
<span style="color:black">DOSDATA:10EA                 </span><span style="color:navy">cld
</span><span style="color:black">DOSDATA:10EB
DOSDATA:10EB </span><span style="color:navy">loc_10EB:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSDATA:10EB                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSDATA:10EC                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">24h </span><span style="color:gray">; &#039;$&#039;
</span><span style="color:black">DOSDATA:10EE                 </span><span style="color:navy">jz      short loc_10F9
</span><span style="color:black">DOSDATA:10F0                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0Eh
</span><span style="color:black">DOSDATA:10F2                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">7
</span><span style="color:black">DOSDATA:10F5                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
<span style="color:black">DOSDATA:10F5                                         </span>; AL = character, BH = display page (alpha modes)
<span style="color:black">DOSDATA:10F5                                         </span>; BL = foreground color (graphics modes)
<span style="color:black">DOSDATA:10F7                 </span><span style="color:navy">jmp     short loc_10EB
</span><span style="color:black">DOSDATA:10F9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSDATA:10F9
DOSDATA:10F9 </span><span style="color:navy">loc_10F9:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSDATA:10F9                 </span><span style="color:navy">sti
</span><span style="color:black">DOSDATA:10FA                 </span><span style="color:navy">jmp     short loc_10F9
</span><span style="color:black">DOSDATA:10FA </span>EnsureA20ON     <span style="color:black">endp
DOSDATA:10FA
DOSDATA:10FA </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSDATA:10FC </span>OldInstanceJunk <span style="color:navy">dw </span><span style="color:#008040">70h                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:10FC                                         </span>; segment of BIOS
<span style="color:gray">DOSDATA:10FE                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; indicate stacks in SYSINIT area
<span style="color:gray">DOSDATA:1100                 </span><span style="color:navy">dw </span><span style="color:#008040">6                    </span>; 6 instance items
<span style="color:gray">DOSDATA:1102 </span>OldInstanceJunk_6 <span style="color:navy">dw </span><span style="color:#008040">0                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:1104                 </span><span style="color:navy">dw offset </span>CONTPOS
<span style="color:gray">DOSDATA:1106                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:1108                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:110A                 </span><span style="color:navy">dw offset </span>BCON
<span style="color:gray">DOSDATA:110C                 </span><span style="color:navy">dw </span><span style="color:#008040">4
</span><span style="color:gray">DOSDATA:110E                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:1110                 </span><span style="color:navy">dw offset </span>CARPOS
<span style="color:gray">DOSDATA:1112                 </span><span style="color:navy">dw </span><span style="color:#008040">106h
</span><span style="color:gray">DOSDATA:1114                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:1116                 </span><span style="color:navy">dw offset </span>CHARCO
<span style="color:gray">DOSDATA:1118                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:111A                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:111C                 </span><span style="color:navy">dw offset </span>exec_init_SP
<span style="color:gray">DOSDATA:111E                 </span><span style="color:navy">dw </span><span style="color:#008040">34
</span><span style="color:gray">DOSDATA:1120                 </span><span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">DOSDATA:1122                 </span><span style="color:navy">dw </span><span style="color:#008040">0Ch                  </span>; ALTAH byte in dos bios
<span style="color:gray">DOSDATA:1124                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:maroon">DOSDATA:1126 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:1126
DOSDATA:1126 </span>RatBugCode<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:1126                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSDATA:1127                 </span><span style="color:navy">mov     cx, </span>ds:10h
<span style="color:maroon">DOSDATA:112B
DOSDATA:112B </span>rbc_loop<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSDATA:112B                 </span><span style="color:navy">loop    </span>rbc_loop
<span style="color:maroon">DOSDATA:112D                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSDATA:112E                 </span><span style="color:navy">retf
</span><span style="color:maroon">DOSDATA:112E </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSDATA:112F </span>UmbSave1        <span style="color:navy">db </span><span style="color:#008040">11 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:113A </span>OLD_FIRSTCLUS_HW <span style="color:navy">dw </span><span style="color:#008040">0                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:113C </span>FastOpenTable   <span style="color:navy">dw </span><span style="color:#008040">2                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:113E </span>FastTable_2     <span style="color:navy">dw offset </span>FastRet       <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:1140                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:1142                 </span><span style="color:navy">dw offset </span>FastRet
<span style="color:gray">DOSDATA:1144                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:1146 </span>FastOpenFlg     <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:1147 </span>FastOpen_Ext_Info <span style="color:navy">db </span><span style="color:#008040">11 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)          </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:1152                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:1154 </span>PATHNAMELEN     <span style="color:navy">dw </span><span style="color:#008040">67                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:1156                 </span><span style="color:navy">db  </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:1156                 </span><span style="color:navy">db  </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:1156                 </span><span style="color:navy">db  </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:1156                 </span><span style="color:navy">db  </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:1175 </span>CurSC_DRIVE     <span style="color:navy">db </span><span style="color:#008040">0FFh                 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:1176 </span>WinoldPatch2    <span style="color:navy">db </span><span style="color:#008040">8 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:117E </span>FIRST_BUFF_ADDR <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:1180 </span>DOSP1_ID        <span style="color:navy">db </span><span style="color:#008040">36h</span><span style="color:navy">,</span><span style="color:#008040">0C5h</span><span style="color:navy">,</span><span style="color:#008040">36h         </span>; Windows 3.1 patches
<span style="color:gray">DOSDATA:1183                 </span><span style="color:navy">db </span><span style="color:#008040">36h</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">,</span><span style="color:#008040">0C5h</span><span style="color:navy">,</span><span style="color:#008040">74h</span><span style="color:navy">, </span><span style="color:#008040">7</span><span style="color:navy">,</span><span style="color:#008040">0E8h
</span><span style="color:gray">DOSDATA:1189                 </span><span style="color:navy">db </span><span style="color:#008040">90h</span><span style="color:navy">,</span><span style="color:#008040">90h
</span><span style="color:gray">DOSDATA:118B </span>DOSP12_ID       <span style="color:navy">db </span><span style="color:#008040">36h</span><span style="color:navy">,</span><span style="color:#008040">0C5h</span><span style="color:navy">,</span><span style="color:#008040">36h
</span><span style="color:gray">DOSDATA:118E                 </span><span style="color:navy">db </span><span style="color:#008040">36h</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">,</span><span style="color:#008040">0C5h</span><span style="color:navy">,</span><span style="color:#008040">74h</span><span style="color:navy">, </span><span style="color:#008040">7</span><span style="color:navy">,</span><span style="color:#008040">0E8h
</span><span style="color:gray">DOSDATA:1194 </span>DOSP3_ID        <span style="color:navy">db </span><span style="color:#008040">51h</span><span style="color:navy">, </span><span style="color:#008040">6</span><span style="color:navy">,</span><span style="color:#008040">57h</span><span style="color:navy">,</span><span style="color:#008040">0BAh
</span><span style="color:gray">DOSDATA:1198                 </span><span style="color:navy">db </span><span style="color:#008040">29h</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">,</span><span style="color:#008040">0E8h
</span><span style="color:gray">DOSDATA:119B                 </span><span style="color:navy">db </span><span style="color:#008040">9Ah</span><span style="color:navy">,</span><span style="color:#008040">0E3h</span><span style="color:navy">,</span><span style="color:#008040">5Fh</span><span style="color:navy">, </span><span style="color:#008040">7
</span><span style="color:gray">DOSDATA:119F </span>DOSP4_ID        <span style="color:navy">db </span><span style="color:#008040">59h
</span><span style="color:gray">DOSDATA:11A0 </span>DOSP5_ID        <span style="color:navy">db </span><span style="color:#008040">51h
</span><span style="color:gray">DOSDATA:11A1                 </span><span style="color:navy">db </span><span style="color:#008040">0ACh</span><span style="color:navy">,</span><span style="color:#008040">3Ch</span><span style="color:navy">,</span><span style="color:#008040">1Ah</span><span style="color:navy">,</span><span style="color:#008040">74h</span><span style="color:navy">, </span><span style="color:#008040">5
</span><span style="color:gray">DOSDATA:11A6                 </span><span style="color:navy">db </span><span style="color:#008040">0E8h
</span><span style="color:gray">DOSDATA:11A7 </span>DOSP7_ID        <span style="color:navy">db </span><span style="color:#008040">2Eh</span><span style="color:navy">,</span><span style="color:#008040">8Ch</span><span style="color:navy">,</span><span style="color:#008040">1Eh
</span><span style="color:gray">DOSDATA:11AA                 </span><span style="color:navy">db </span><span style="color:#008040">7Eh</span><span style="color:navy">, </span><span style="color:#008040">5
</span><span style="color:gray">DOSDATA:11AC                 </span><span style="color:navy">db </span><span style="color:#008040">2Eh</span><span style="color:navy">,</span><span style="color:#008040">89h</span><span style="color:navy">,</span><span style="color:#008040">1Eh
</span><span style="color:gray">DOSDATA:11AF                 </span><span style="color:navy">db </span><span style="color:#008040">7Ch</span><span style="color:navy">, </span><span style="color:#008040">5
</span><span style="color:gray">DOSDATA:11B1                 </span><span style="color:navy">db </span><span style="color:#008040">8Ch</span><span style="color:navy">,</span><span style="color:#008040">0CBh
</span><span style="color:gray">DOSDATA:11B3                 </span><span style="color:navy">db </span><span style="color:#008040">8Eh</span><span style="color:navy">,</span><span style="color:#008040">0DBh
</span><span style="color:gray">DOSDATA:11B5                 </span><span style="color:navy">db </span><span style="color:#008040">0FEh</span><span style="color:navy">, </span><span style="color:#008040">6
</span><span style="color:gray">DOSDATA:11B7                 </span><span style="color:navy">db </span><span style="color:#008040">0CFh</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:11B9                 </span><span style="color:navy">db </span><span style="color:#008040">33h</span><span style="color:navy">,</span><span style="color:#008040">0C0h
</span><span style="color:gray">DOSDATA:11BB </span>DOSP8_ID        <span style="color:navy">db </span><span style="color:#008040">50h</span><span style="color:navy">,</span><span style="color:#008040">36h</span><span style="color:navy">,</span><span style="color:#008040">0A1h
</span><span style="color:gray">DOSDATA:11BE                 </span><span style="color:navy">db </span><span style="color:#008040">0EAh</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">,</span><span style="color:#008040">26h</span><span style="color:navy">,</span><span style="color:#008040">3Bh</span><span style="color:navy">,</span><span style="color:#008040">45h
</span><span style="color:gray">DOSDATA:11C3                 </span><span style="color:navy">db </span><span style="color:#008040">2Fh</span><span style="color:navy">,</span><span style="color:#008040">58h
</span><span style="color:gray">DOSDATA:11C5 </span>DOSP10_ID       <span style="color:navy">db  </span><span style="color:#008040">6</span><span style="color:navy">,</span><span style="color:#008040">1Fh
</span><span style="color:gray">DOSDATA:11C7                 </span><span style="color:navy">db </span><span style="color:#008040">8Bh</span><span style="color:navy">,</span><span style="color:#008040">0DFh
</span><span style="color:gray">DOSDATA:11C9                 </span><span style="color:navy">db </span><span style="color:#008040">33h</span><span style="color:navy">,</span><span style="color:#008040">0C0h</span><span style="color:navy">,</span><span style="color:#008040">8Bh</span><span style="color:navy">,</span><span style="color:#008040">0D0h</span><span style="color:navy">,</span><span style="color:#008040">0E8h
</span><span style="color:gray">DOSDATA:11CE                 </span><span style="color:navy">db </span><span style="color:#008040">0DFh</span><span style="color:navy">,</span><span style="color:#008040">0Eh
</span><span style="color:gray">DOSDATA:11D0                 </span><span style="color:navy">db </span><span style="color:#008040">1Eh</span><span style="color:navy">,</span><span style="color:#008040">36h</span><span style="color:navy">,</span><span style="color:#008040">0C5h</span><span style="color:navy">,</span><span style="color:#008040">36h</span><span style="color:navy">,</span><span style="color:#008040">36h</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">,</span><span style="color:#008040">0E8h</span><span style="color:navy">,</span><span style="color:#008040">0AFh
</span><span style="color:gray">DOSDATA:11D0                 </span><span style="color:navy">db </span><span style="color:#008040">0Eh</span><span style="color:navy">,</span><span style="color:#008040">8Bh</span><span style="color:navy">,</span><span style="color:#008040">0D7h</span><span style="color:navy">,</span><span style="color:#008040">0B4h</span><span style="color:navy">,</span><span style="color:#008040">86h</span><span style="color:navy">,</span><span style="color:#008040">36h</span><span style="color:navy">,</span><span style="color:#008040">8Bh</span><span style="color:navy">,</span><span style="color:#008040">3Eh
</span><span style="color:gray">DOSDATA:11E0                 </span><span style="color:navy">db  </span><span style="color:#008040">9</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">,</span><span style="color:#008040">0F7h</span><span style="color:navy">,</span><span style="color:#008040">0C7h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">,</span><span style="color:#008040">80h</span><span style="color:navy">,</span><span style="color:#008040">74h</span><span style="color:navy">,</span><span style="color:#008040">19h
</span><span style="color:gray">DOSDATA:11E0                 </span><span style="color:navy">db </span><span style="color:#008040">0E8h</span><span style="color:navy">,</span><span style="color:#008040">47h</span><span style="color:navy">,</span><span style="color:#008040">17h</span><span style="color:navy">,</span><span style="color:#008040">8Bh</span><span style="color:navy">,</span><span style="color:#008040">0FAh</span><span style="color:navy">,</span><span style="color:#008040">0Ah</span><span style="color:navy">,</span><span style="color:#008040">0C0h</span><span style="color:navy">,</span><span style="color:#008040">74h
</span><span style="color:gray">DOSDATA:11E0                 </span><span style="color:navy">db </span><span style="color:#008040">10h</span><span style="color:navy">,</span><span style="color:#008040">3Ch</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">,</span><span style="color:#008040">74h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">,</span><span style="color:#008040">1Fh</span><span style="color:navy">,</span><span style="color:#008040">0EBh</span><span style="color:navy">,</span><span style="color:#008040">0CFh
</span><span style="color:gray">DOSDATA:11F8                 </span><span style="color:navy">db </span><span style="color:#008040">5Fh
</span><span style="color:gray">DOSDATA:11F9                 </span><span style="color:navy">db </span><span style="color:#008040">36h</span><span style="color:navy">,</span><span style="color:#008040">0C4h</span><span style="color:navy">,</span><span style="color:#008040">3Eh</span><span style="color:navy">,</span><span style="color:#008040">36h</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">,</span><span style="color:#008040">0E9h</span><span style="color:navy">,</span><span style="color:#008040">0A1h</span><span style="color:navy">, </span><span style="color:#008040">4
</span><span style="color:gray">DOSDATA:1201                 </span><span style="color:navy">db </span><span style="color:#008040">5Fh</span><span style="color:navy">, </span><span style="color:#008040">8Bh</span><span style="color:navy">, </span><span style="color:#008040">0FAh
</span><span style="color:gray">DOSDATA:1204 </span>DOSP13_ID       <span style="color:navy">db </span><span style="color:#008040">0ACh</span><span style="color:navy">,</span><span style="color:#008040">3Ch</span><span style="color:navy">,</span><span style="color:#008040">24h</span><span style="color:navy">,</span><span style="color:#008040">74h</span><span style="color:navy">, </span><span style="color:#008040">8</span><span style="color:navy">,</span><span style="color:#008040">0B3h</span><span style="color:navy">, </span><span style="color:#008040">7</span><span style="color:navy">,</span><span style="color:#008040">0B4h
</span><span style="color:gray">DOSDATA:1204                 </span><span style="color:navy">db </span><span style="color:#008040">0Eh</span><span style="color:navy">,</span><span style="color:#008040">0CDh</span><span style="color:navy">,</span><span style="color:#008040">10h</span><span style="color:navy">,</span><span style="color:#008040">0EBh</span><span style="color:navy">,</span><span style="color:#008040">0F3h</span><span style="color:navy">,</span><span style="color:#008040">0EBh</span><span style="color:navy">,</span><span style="color:#008040">0FEh
</span><span style="color:gray">DOSDATA:1213 </span>XMMERRMSG       <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah
</span><span style="color:gray">DOSDATA:1215                 </span><span style="color:navy">db &#039;A20 Hardware Error&#039;,0Dh,0Ah,&#039;$&#039;
</span><span style="color:gray">DOSDATA:122A </span>COUNTRY_CDPG    <span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:122A                                         </span>; reserved words
<span style="color:gray">DOSDATA:1232                 </span><span style="color:navy">db &#039;\COUNTRY.SYS&#039;,0     </span>; path name of country.sys
<span style="color:gray">DOSDATA:123F                 </span><span style="color:navy">db </span><span style="color:#008040">51 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">DOSDATA:1272                 </span><span style="color:navy">dw </span><span style="color:#008040">437                  </span>; system code page id
<span style="color:gray">DOSDATA:1274                 </span><span style="color:navy">dw </span><span style="color:#008040">6                    </span>; number of entries
<span style="color:gray">DOSDATA:1276 </span>COUNTRY_CDPG_76 <span style="color:navy">db </span><span style="color:#008040">2                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:1276                                         </span>; SetUcase
<span style="color:gray">DOSDATA:1277                 </span><span style="color:navy">dw offset </span>UCASE_TAB
<span style="color:gray">DOSDATA:1279                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:127B                 </span><span style="color:navy">db </span><span style="color:#008040">4                    </span>; SetUcaseFile
<span style="color:gray">DOSDATA:127C                 </span><span style="color:navy">dw offset </span>FILE_UCASE_TAB
<span style="color:gray">DOSDATA:127E                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:1280                 </span><span style="color:navy">db </span><span style="color:#008040">5                    </span>; SetFileList
<span style="color:gray">DOSDATA:1281                 </span><span style="color:navy">dw offset </span>FILE_CHAR_TAB
<span style="color:gray">DOSDATA:1283                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:1285                 </span><span style="color:navy">db </span><span style="color:#008040">6                    </span>; SetCollate
<span style="color:gray">DOSDATA:1286                 </span><span style="color:navy">dw offset </span>COLLATE_TAB
<span style="color:gray">DOSDATA:1288                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:128A                 </span><span style="color:navy">db </span><span style="color:#008040">7                    </span>; SetDBCS
<span style="color:gray">DOSDATA:128B                 </span><span style="color:navy">dw offset </span>DBCS_TAB
<span style="color:gray">DOSDATA:128D                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:128F                 </span><span style="color:navy">db </span><span style="color:#008040">1                    </span>; SetCountryInfo
<span style="color:gray">DOSDATA:1290                 </span><span style="color:navy">dw </span><span style="color:#008040">38                   </span>; NEW_COUNTRY_SIZE
<span style="color:gray">DOSDATA:1292 </span>_COUNTRY_ID     <span style="color:navy">dw </span><span style="color:#008040">1                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:1292                                         </span>; USA country id
<span style="color:gray">DOSDATA:1294                 </span><span style="color:navy">dw </span><span style="color:#008040">437                  </span>; USA system code page id
<span style="color:gray">DOSDATA:1296 </span>COUNTRY_CDPG_108 <span style="color:navy">dw </span><span style="color:#008040">0                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:1296                                         </span>; date format
<span style="color:gray">DOSDATA:1298                 </span><span style="color:navy">db &#039;$&#039;,0,0,0,0          </span>; currency symbol
<span style="color:gray">DOSDATA:129D                 </span><span style="color:navy">db &#039;,&#039;,0                </span>; thousand separator
<span style="color:gray">DOSDATA:129F                 </span><span style="color:navy">db &#039;.&#039;,0                </span>; decimal separator
<span style="color:gray">DOSDATA:12A1                 </span><span style="color:navy">db &#039;-&#039;,0                </span>; date separator
<span style="color:gray">DOSDATA:12A3                 </span><span style="color:navy">db &#039;:&#039;,0                </span>; time separator
<span style="color:gray">DOSDATA:12A5                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; currency format flag
<span style="color:gray">DOSDATA:12A6                 </span><span style="color:navy">db </span><span style="color:#008040">2                    </span>; # of digits after decimal in currency
<span style="color:gray">DOSDATA:12A7                 </span><span style="color:navy">db </span><span style="color:#008040">0                    </span>; time format
<span style="color:gray">DOSDATA:12A8                 </span><span style="color:navy">dw offset </span>MAP_CASE      ; mono case routine entry point
<span style="color:gray">DOSDATA:12AA                 </span><span style="color:navy">dw </span><span style="color:#008040">0                    </span>; segment of entry point
<span style="color:gray">DOSDATA:12AC                 </span><span style="color:navy">db &#039;,&#039;,0                </span>; data list separator
<span style="color:gray">DOSDATA:12AE                 </span><span style="color:navy">dw </span><span style="color:#008040">5 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span>; reserved
<span style="color:gray">DOSDATA:12B8 </span>INDOS_FLAG      <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:12B9 </span>DEVIO_IN_PROGRESS <span style="color:navy">db </span><span style="color:#008040">0                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:12BA </span>_ENU            <span style="color:navy">db &#039;ENU&#039;,0              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:12BE </span>_USA            <span style="color:navy">db &#039;USA&#039;,0
</span><span style="color:gray">DOSDATA:12C2 </span>_US             <span style="color:navy">db &#039;US&#039;
</span><span style="color:gray">DOSDATA:12C4                 </span><span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:12C6                 </span><span style="color:navy">dw </span><span style="color:#008040">2
</span><span style="color:gray">DOSDATA:12C8                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:12CA </span>_AM             <span style="color:navy">db &#039;AM&#039;,0
</span><span style="color:gray">DOSDATA:12CD </span>_PM             <span style="color:navy">db &#039;PM&#039;,0
</span><span style="color:gray">DOSDATA:12D0 </span>_MMDDYY         <span style="color:navy">db &#039;M/d/yy     dddd,MMMMdd,yyyy         &#039;
</span><span style="color:gray">DOSDATA:12F4                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:12F5                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:12F6                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:12F8 </span>VxDpath         <span style="color:navy">db &#039;c:\wina20.386&#039;,0    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:1306                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">DOSDATA:1307 </span>drv_flags_1     <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:1308 </span>drive_flags     <span style="color:navy">db </span><span style="color:#008040">26 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:1322                 </span><span style="color:navy">db </span><span style="color:#008040">1
</span><span style="color:gray">DOSDATA:1323 </span>BiosComBlockPtr <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:1327                 </span><span style="color:navy">db </span><span style="color:#008040">5 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">DOSDATA:132C                 </span><span style="color:navy">dw </span><span style="color:#008040">4
</span><span style="color:gray">DOSDATA:132E                 </span><span style="color:navy">dw offset </span>INDOS_FLAG
<span style="color:gray">DOSDATA:1330                 </span><span style="color:navy">dw offset </span>drive_flags
<span style="color:gray">DOSDATA:1332                 </span><span style="color:navy">dw offset </span>NLS_YES
<span style="color:gray">DOSDATA:1334                 </span><span style="color:navy">dw offset </span>unknown_zero_dd
<span style="color:gray">DOSDATA:1336 </span>NLS_YES         <span style="color:navy">db &#039;</span><span style="color:green">Y&#039;                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:1337 </span>NLS_NO          <span style="color:navy">db &#039;</span><span style="color:green">N&#039;                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:1338 </span>NLS_yes2        <span style="color:navy">db &#039;</span><span style="color:green">y&#039;                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:1339 </span>NLS_no2         <span style="color:navy">db &#039;</span><span style="color:green">n&#039;                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:133A </span>unknown_zero_dd <span style="color:navy">dd </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSDATA:133E </span>Rational386PatchPtr <span style="color:navy">dw </span><span style="color:#008040">0                </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:1340 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSDATA:1340
DOSDATA:1340 </span>MagicPatch<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSDATA:1340                 </span><span style="color:navy">retf
</span><span style="color:maroon">DOSDATA:1340 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:olive">DOSDATA:1341                 </span><span style="color:navy">db  </span><span style="color:#008040">90h
</span><span style="color:olive">DOSDATA:1342                 </span><span style="color:navy">db  </span><span style="color:#008040">90h
</span><span style="color:olive">DOSDATA:1343                 </span><span style="color:navy">db  </span><span style="color:#008040">90h
</span><span style="color:olive">DOSDATA:1344                 </span><span style="color:navy">db  </span><span style="color:#008040">90h
</span><span style="color:olive">DOSDATA:1345                 </span><span style="color:navy">db  </span><span style="color:#008040">90h
</span><span style="color:olive">DOSDATA:1345 </span>DOSDATA         ends
<span style="color:olive">DOSDATA:1345
</span><span style="color:maroon">DOSCODE:3F10 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:3F10 </span>; File Name   : C:\Yedek\pcdos_7_1\IBMDOS.COM
<span style="color:maroon">DOSCODE:3F10 </span>; Format      : Binary file
<span style="color:maroon">DOSCODE:3F10 </span>; Base Address: 0000h Range: 0000h - A646h Loaded length: A646h
<span style="color:maroon">DOSCODE:3F10 </span><span style="color:gray">; ===========================================================================
</span><span style="color:maroon">DOSCODE:3F10
DOSCODE:3F10 </span><span style="color:gray">; Segment type: Regular
</span><span style="color:maroon">DOSCODE:3F10 </span>DOSCODE         segment byte public &#039;DOSCODE&#039; use16
<span style="color:maroon">DOSCODE:3F10                 </span>assume cs:DOSCODE
<span style="color:maroon">DOSCODE:3F10                 </span><span style="color:gray">;org 3F10h
</span><span style="color:maroon">DOSCODE:3F10                 </span>assume es:nothing, ss:nothing, ds:nothing, fs:nothing, gs:nothing
<span style="color:maroon">DOSCODE:3F10
DOSCODE:3F10 </span>$STARTCODE<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:3F10                 </span><span style="color:navy">jmp     </span>DOSINIT
<span style="color:maroon">DOSCODE:3F10 </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSCODE:3F13                 </span><span style="color:navy">dw offset </span>$STARTCODE
<span style="color:gray">DOSCODE:3F15 </span>BioDataSeg      <span style="color:navy">dw </span><span style="color:#008040">70h
</span><span style="color:gray">DOSCODE:3F17 </span>DosDSeg         <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:3F17                                         </span>; DOSDATA segment address
<span style="color:gray">DOSCODE:3F19 </span>MSMAJOR         <span style="color:navy">db </span><span style="color:#008040">7                    </span>; DOS_MAJOR_VERSION
<span style="color:gray">DOSCODE:3F1A </span>MSMINOR         <span style="color:navy">db </span><span style="color:#008040">10                   </span>; DOS_MINOR_VERSION
<span style="color:gray">DOSCODE:3F1B </span>I21_MAP_E_TAB   <span style="color:navy">db </span><span style="color:#008040">38h</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">39h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">2 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">3Ah</span><span style="color:navy">, </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">3Bh </span>; INT 21h Error code mapping table
<span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">3Ch</span><span style="color:navy">, </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">4
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">3Dh</span><span style="color:navy">, </span><span style="color:#008040">6</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">0Ch</span><span style="color:navy">, </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">1Ah
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">3Eh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">6</span><span style="color:navy">, </span><span style="color:#008040">3Fh</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">6</span><span style="color:navy">, </span><span style="color:#008040">5
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">40h</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">6</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">41h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">42h</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">6</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">43h</span><span style="color:navy">, </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">3
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">44h</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">0Fh</span><span style="color:navy">, </span><span style="color:#008040">0Dh</span><span style="color:navy">, </span><span style="color:#008040">1
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">6</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">45h</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">6</span><span style="color:navy">, </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">46h</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">6</span><span style="color:navy">, </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">47h</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1Ah</span><span style="color:navy">, </span><span style="color:#008040">0Fh</span><span style="color:navy">, </span><span style="color:#008040">48h</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">7</span><span style="color:navy">, </span><span style="color:#008040">8</span><span style="color:navy">, </span><span style="color:#008040">49h</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">7</span><span style="color:navy">, </span><span style="color:#008040">9</span><span style="color:navy">, </span><span style="color:#008040">4Ah</span><span style="color:navy">, </span><span style="color:#008040">3
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">7</span><span style="color:navy">, </span><span style="color:#008040">9</span><span style="color:navy">, </span><span style="color:#008040">8</span><span style="color:navy">, </span><span style="color:#008040">4Bh</span><span style="color:navy">, </span><span style="color:#008040">8</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">0Bh</span><span style="color:navy">, </span><span style="color:#008040">0Ah</span><span style="color:navy">, </span><span style="color:#008040">8</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">4Eh</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">3
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">12h</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">12h</span><span style="color:navy">, </span><span style="color:#008040">56h</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">11h
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">57h</span><span style="color:navy">, </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">6</span><span style="color:navy">, </span><span style="color:#008040">8
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">0Dh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">58h</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">5Ah</span><span style="color:navy">, </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">3
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">5Bh</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">5Ch</span><span style="color:navy">, </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">6</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">24h</span><span style="color:navy">, </span><span style="color:#008040">21h
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">65h</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">2
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">68h</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">6</span><span style="color:navy">, </span><span style="color:#008040">67h</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">8</span><span style="color:navy">, </span><span style="color:#008040">1
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">6Ch</span><span style="color:navy">, </span><span style="color:#008040">0Ah</span><span style="color:navy">, </span><span style="color:#008040">3</span><span style="color:navy">, </span><span style="color:#008040">2</span><span style="color:navy">, </span><span style="color:#008040">0Ch</span><span style="color:navy">, </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">8
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">1Ah</span><span style="color:navy">, </span><span style="color:#008040">0Dh</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">69h</span><span style="color:navy">, </span><span style="color:#008040">4</span><span style="color:navy">, </span><span style="color:#008040">0Fh</span><span style="color:navy">, </span><span style="color:#008040">0Dh
</span><span style="color:gray">DOSCODE:3F1B                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">5</span><span style="color:navy">, </span><span style="color:#008040">70h</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0FFh
</span><span style="color:gray">DOSCODE:3FD1                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">DOSCODE:3FD2 </span>DISPATCH        <span style="color:navy">dw offset </span>$ABORT        <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:3FD2                                         </span>; Standard Functions (INT 21h System Calls)
<span style="color:gray">DOSCODE:3FD4                 </span><span style="color:navy">dw offset </span>$STD_CON_INPUT
<span style="color:gray">DOSCODE:3FD6                 </span><span style="color:navy">dw offset </span>$STD_CON_OUTPUT
<span style="color:gray">DOSCODE:3FD8                 </span><span style="color:navy">dw offset </span>$STD_AUX_INPUT
<span style="color:gray">DOSCODE:3FDA                 </span><span style="color:navy">dw offset </span>$STD_AUX_OUTPUT
<span style="color:gray">DOSCODE:3FDC                 </span><span style="color:navy">dw offset </span>$STD_PRINTER_OUTPUT
<span style="color:gray">DOSCODE:3FDE                 </span><span style="color:navy">dw offset </span>$RAW_CON_IO
<span style="color:gray">DOSCODE:3FE0                 </span><span style="color:navy">dw offset </span>$RAW_CON_INPUT
<span style="color:gray">DOSCODE:3FE2                 </span><span style="color:navy">dw offset </span>$STD_CON_INPUT_NO_ECHO
<span style="color:gray">DOSCODE:3FE4                 </span><span style="color:navy">dw offset </span>$STD_CON_STRING_OUTPUT
<span style="color:gray">DOSCODE:3FE6                 </span><span style="color:navy">dw offset </span>$STD_CON_STRING_INPUT
<span style="color:gray">DOSCODE:3FE8                 </span><span style="color:navy">dw offset </span>$STD_CON_INPUT_STATUS
<span style="color:gray">DOSCODE:3FEA                 </span><span style="color:navy">dw offset </span>$STD_CON_INPUT_FLUSH
<span style="color:gray">DOSCODE:3FEC                 </span><span style="color:navy">dw offset </span>$DISK_RESET
<span style="color:gray">DOSCODE:3FEE                 </span><span style="color:navy">dw offset </span>$SET_DEFAULT_DRIVE
<span style="color:gray">DOSCODE:3FF0                 </span><span style="color:navy">dw offset </span>$FCB_OPEN
<span style="color:gray">DOSCODE:3FF2                 </span><span style="color:navy">dw offset </span>$FCB_CLOSE
<span style="color:gray">DOSCODE:3FF4                 </span><span style="color:navy">dw offset </span>$DIR_SEARCH_FIRST
<span style="color:gray">DOSCODE:3FF6                 </span><span style="color:navy">dw offset </span>$DIR_SEARCH_NEXT
<span style="color:gray">DOSCODE:3FF8                 </span><span style="color:navy">dw offset </span>$FCB_DELETE
<span style="color:gray">DOSCODE:3FFA                 </span><span style="color:navy">dw offset </span>$FCB_SEQ_READ
<span style="color:gray">DOSCODE:3FFC                 </span><span style="color:navy">dw offset </span>$FCB_SEQ_WRITE
<span style="color:gray">DOSCODE:3FFE                 </span><span style="color:navy">dw offset </span>$FCB_CREATE
<span style="color:gray">DOSCODE:4000                 </span><span style="color:navy">dw offset </span>$FCB_RENAME
<span style="color:gray">DOSCODE:4002                 </span><span style="color:navy">dw offset </span>NO_OP
<span style="color:gray">DOSCODE:4004                 </span><span style="color:navy">dw offset </span>$GET_DEFAULT_DRIVE
<span style="color:gray">DOSCODE:4006                 </span><span style="color:navy">dw offset </span>$SET_DMA
<span style="color:gray">DOSCODE:4008                 </span><span style="color:navy">dw offset </span>$SLEAZEFUNC
<span style="color:gray">DOSCODE:400A                 </span><span style="color:navy">dw offset </span>$SLEAZEFUNCDL
<span style="color:gray">DOSCODE:400C                 </span><span style="color:navy">dw offset </span>NO_OP
<span style="color:gray">DOSCODE:400E                 </span><span style="color:navy">dw offset </span>NO_OP
<span style="color:gray">DOSCODE:4010                 </span><span style="color:navy">dw offset </span>$GET_DEFAULT_DPB
<span style="color:gray">DOSCODE:4012                 </span><span style="color:navy">dw offset </span>NO_OP
<span style="color:gray">DOSCODE:4014                 </span><span style="color:navy">dw offset </span>$FCB_RANDOM_READ
<span style="color:gray">DOSCODE:4016                 </span><span style="color:navy">dw offset </span>$FCB_RANDOM_WRITE
<span style="color:gray">DOSCODE:4018                 </span><span style="color:navy">dw offset </span>$GET_FCB_FILE_LENGTH
<span style="color:gray">DOSCODE:401A                 </span><span style="color:navy">dw offset </span>$GET_FCB_POSITION
<span style="color:gray">DOSCODE:401C                 </span><span style="color:navy">dw offset </span>$SET_INTERRUPT_VECTOR
<span style="color:gray">DOSCODE:401E                 </span><span style="color:navy">dw offset </span>$CREATE_PROCESS_DATA_BLOCK
<span style="color:gray">DOSCODE:4020                 </span><span style="color:navy">dw offset </span>$FCB_RANDOM_READ_BLOCK
<span style="color:gray">DOSCODE:4022                 </span><span style="color:navy">dw offset </span>$FCB_RANDOM_WRITE_BLOCK
<span style="color:gray">DOSCODE:4024                 </span><span style="color:navy">dw offset </span>$PARSE_FILE_DESCRIPTOR
<span style="color:gray">DOSCODE:4026                 </span><span style="color:navy">dw offset </span>$GET_DATE
<span style="color:gray">DOSCODE:4028                 </span><span style="color:navy">dw offset </span>$SET_DATE
<span style="color:gray">DOSCODE:402A                 </span><span style="color:navy">dw offset </span>$GET_TIME
<span style="color:gray">DOSCODE:402C                 </span><span style="color:navy">dw offset </span>$SET_TIME
<span style="color:gray">DOSCODE:402E                 </span><span style="color:navy">dw offset </span>$SET_VERIFY_ON_WRITE
<span style="color:gray">DOSCODE:4030                 </span><span style="color:navy">dw offset </span>$GET_DMA
<span style="color:gray">DOSCODE:4032                 </span><span style="color:navy">dw offset </span>$GET_VERSION
<span style="color:gray">DOSCODE:4034                 </span><span style="color:navy">dw offset </span>$KEEP_PROCESS
<span style="color:gray">DOSCODE:4036                 </span><span style="color:navy">dw offset </span>$GET_DPB
<span style="color:gray">DOSCODE:4038                 </span><span style="color:navy">dw offset </span>$SET_CTRL_C_TRAPPING
<span style="color:gray">DOSCODE:403A                 </span><span style="color:navy">dw offset </span>$GET_INDOS_FLAG
<span style="color:gray">DOSCODE:403C                 </span><span style="color:navy">dw offset </span>$GET_INTERRUPT_VECTOR
<span style="color:gray">DOSCODE:403E                 </span><span style="color:navy">dw offset </span>$GET_DRIVE_FREESPACE
<span style="color:gray">DOSCODE:4040                 </span><span style="color:navy">dw offset </span>$CHAR_OPER
<span style="color:gray">DOSCODE:4042                 </span><span style="color:navy">dw offset </span>$INTERNATIONAL
<span style="color:gray">DOSCODE:4044                 </span><span style="color:navy">dw offset </span>$MKDIR
<span style="color:gray">DOSCODE:4046                 </span><span style="color:navy">dw offset </span>$RMDIR
<span style="color:gray">DOSCODE:4048                 </span><span style="color:navy">dw offset </span>$CHDIR
<span style="color:gray">DOSCODE:404A                 </span><span style="color:navy">dw offset </span>$CREAT
<span style="color:gray">DOSCODE:404C                 </span><span style="color:navy">dw offset </span>$OPEN
<span style="color:gray">DOSCODE:404E                 </span><span style="color:navy">dw offset </span>$CLOSE
<span style="color:gray">DOSCODE:4050                 </span><span style="color:navy">dw offset </span>$READ
<span style="color:gray">DOSCODE:4052                 </span><span style="color:navy">dw offset </span>$WRITE
<span style="color:gray">DOSCODE:4054                 </span><span style="color:navy">dw offset </span>$UNLINK
<span style="color:gray">DOSCODE:4056                 </span><span style="color:navy">dw offset </span>$LSEEK
<span style="color:gray">DOSCODE:4058                 </span><span style="color:navy">dw offset </span>$CHMOD
<span style="color:gray">DOSCODE:405A                 </span><span style="color:navy">dw offset </span>$IOCTL
<span style="color:gray">DOSCODE:405C                 </span><span style="color:navy">dw offset </span>$DUP
<span style="color:gray">DOSCODE:405E                 </span><span style="color:navy">dw offset </span>$DUP2
<span style="color:gray">DOSCODE:4060                 </span><span style="color:navy">dw offset </span>$CURRENT_DIR
<span style="color:gray">DOSCODE:4062                 </span><span style="color:navy">dw offset </span>$ALLOC
<span style="color:gray">DOSCODE:4064                 </span><span style="color:navy">dw offset </span>$DEALLOC
<span style="color:gray">DOSCODE:4066                 </span><span style="color:navy">dw offset </span>$SETBLOCK
<span style="color:gray">DOSCODE:4068                 </span><span style="color:navy">dw offset </span>$EXEC
<span style="color:gray">DOSCODE:406A                 </span><span style="color:navy">dw offset </span>$EXIT
<span style="color:gray">DOSCODE:406C                 </span><span style="color:navy">dw offset </span>$WAIT
<span style="color:gray">DOSCODE:406E                 </span><span style="color:navy">dw offset </span>$FIND_FIRST
<span style="color:gray">DOSCODE:4070                 </span><span style="color:navy">dw offset </span>$FIND_NEXT
<span style="color:gray">DOSCODE:4072                 </span><span style="color:navy">dw offset </span>$SET_CURRENT_PDB
<span style="color:gray">DOSCODE:4074                 </span><span style="color:navy">dw offset </span>$GET_CURRENT_PDB
<span style="color:gray">DOSCODE:4076                 </span><span style="color:navy">dw offset </span>$GET_IN_VARS
<span style="color:gray">DOSCODE:4078                 </span><span style="color:navy">dw offset </span>$SETDPB
<span style="color:gray">DOSCODE:407A                 </span><span style="color:navy">dw offset </span>$GET_VERIFY_ON_WRITE
<span style="color:gray">DOSCODE:407C                 </span><span style="color:navy">dw offset </span>$DUP_PDB
<span style="color:gray">DOSCODE:407E                 </span><span style="color:navy">dw offset </span>$RENAME
<span style="color:gray">DOSCODE:4080                 </span><span style="color:navy">dw offset </span>$FILE_TIMES
<span style="color:gray">DOSCODE:4082                 </span><span style="color:navy">dw offset </span>$ALLOCOPER
<span style="color:gray">DOSCODE:4084                 </span><span style="color:navy">dw offset </span>$GetExtendedError
<span style="color:gray">DOSCODE:4086                 </span><span style="color:navy">dw offset </span>$CreateTempFile
<span style="color:gray">DOSCODE:4088                 </span><span style="color:navy">dw offset </span>$CreateNewFile
<span style="color:gray">DOSCODE:408A                 </span><span style="color:navy">dw offset </span>$LockOper
<span style="color:gray">DOSCODE:408C                 </span><span style="color:navy">dw offset </span>$ServerCall
<span style="color:gray">DOSCODE:408E                 </span><span style="color:navy">dw offset </span>$UserOper
<span style="color:gray">DOSCODE:4090                 </span><span style="color:navy">dw offset </span>$AssignOper
<span style="color:gray">DOSCODE:4092                 </span><span style="color:navy">dw offset </span>$NameTrans
<span style="color:gray">DOSCODE:4094                 </span><span style="color:navy">dw offset </span>NO_OP
<span style="color:gray">DOSCODE:4096                 </span><span style="color:navy">dw offset </span>$GET_CURRENT_PDB
<span style="color:gray">DOSCODE:4098                 </span><span style="color:navy">dw offset </span>$ECS_Call
<span style="color:gray">DOSCODE:409A                 </span><span style="color:navy">dw offset </span>$SET_PRINTER_FLAG
<span style="color:gray">DOSCODE:409C                 </span><span style="color:navy">dw offset </span>$GetExtCntry
<span style="color:gray">DOSCODE:409E                 </span><span style="color:navy">dw offset </span>$GetSetCdPg
<span style="color:gray">DOSCODE:40A0                 </span><span style="color:navy">dw offset </span>$ExtHandle
<span style="color:gray">DOSCODE:40A2                 </span><span style="color:navy">dw offset </span>$COMMIT
<span style="color:gray">DOSCODE:40A4                 </span><span style="color:navy">dw offset </span>$GSetMediaID
<span style="color:gray">DOSCODE:40A6                 </span><span style="color:navy">dw offset </span>$COMMIT
<span style="color:gray">DOSCODE:40A8                 </span><span style="color:navy">dw offset </span>NO_OP
<span style="color:gray">DOSCODE:40AA                 </span><span style="color:navy">dw offset </span>$Extended_Open ; 6Ch
<span style="color:gray">DOSCODE:40AC                 </span><span style="color:navy">dw offset </span>NO_OP         ; 6Dh, OS/2 &quot;DosMkDir2&quot; - ROM DOS: Find first ROM program
<span style="color:gray">DOSCODE:40AE                 </span><span style="color:navy">dw offset </span>NO_OP         ; 6Eh, OS/2 &quot;DosEnumAttrib&quot; - ROM DOS: Find next ROM program
<span style="color:gray">DOSCODE:40B0                 </span><span style="color:navy">dw offset </span>NO_OP         ; 6Fh, OS/2 &quot;DosQMaxEASize&quot; - ROM DOS: Get/set searched ROM area
<span style="color:gray">DOSCODE:40B2                 </span><span style="color:navy">dw offset </span>$ExtCountryInfo ; 70h, MSDOS 7 (WIN 95) - Get/set extended country information
<span style="color:gray">DOSCODE:40B2                                         </span>;         GET/SET INTERNATIONALIZATION INFORMATION
<span style="color:gray">DOSCODE:40B4                 </span><span style="color:navy">dw offset </span>$LONGNAME     ; 71h, MSDOS 7 (WIN 95) LONG FILENAME FUNCTIONS
<span style="color:gray">DOSCODE:40B6                 </span><span style="color:navy">dw offset </span>$LONGNAME     ; 72h, MSDOS 7 (WIN 95) LFN-FindClose
<span style="color:gray">DOSCODE:40B8                 </span><span style="color:navy">dw offset </span>$FAT32EXT     ; 73h, MSDOS 7 - FAT32 extended drive functions
<span style="color:gray">DOSCODE:40BA </span>FOO             <span style="color:navy">dw offset </span>Leave2F       <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:40BC </span>DTab            <span style="color:navy">dw offset </span>DOSTable      <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:40BE </span>DOSTable        <span style="color:navy">db </span><span style="color:#008040">50                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:40BF                 </span><span style="color:navy">dw offset </span>DOSInstall
<span style="color:gray">DOSCODE:40C1                 </span><span style="color:navy">dw offset </span>DOS_CLOSE
<span style="color:gray">DOSCODE:40C3                 </span><span style="color:navy">dw offset </span>RECSET
<span style="color:gray">DOSCODE:40C5                 </span><span style="color:navy">dw offset </span>DOSGetGroup
<span style="color:gray">DOSCODE:40C7                 </span><span style="color:navy">dw offset </span>PATHCHRCMP
<span style="color:gray">DOSCODE:40C9                 </span><span style="color:navy">dw offset </span>OUTT
<span style="color:gray">DOSCODE:40CB                 </span><span style="color:navy">dw offset </span>NET_I24_ENTRY
<span style="color:gray">DOSCODE:40CD                 </span><span style="color:navy">dw offset </span>PLACEBUF
<span style="color:gray">DOSCODE:40CF                 </span><span style="color:navy">dw offset </span>FREE_SFT
<span style="color:gray">DOSCODE:40D1                 </span><span style="color:navy">dw offset </span>BUFWRITE
<span style="color:gray">DOSCODE:40D3                 </span><span style="color:navy">dw offset </span>SHARE_VIOLATION
<span style="color:gray">DOSCODE:40D5                 </span><span style="color:navy">dw offset </span>SHARE_ERROR
<span style="color:gray">DOSCODE:40D7                 </span><span style="color:navy">dw offset </span>SET_SFT_MODE
<span style="color:gray">DOSCODE:40D9                 </span><span style="color:navy">dw offset </span>DATE16
<span style="color:gray">DOSCODE:40DB                 </span><span style="color:navy">dw offset </span>Idle
<span style="color:gray">DOSCODE:40DD                 </span><span style="color:navy">dw offset </span>SCANPLACE
<span style="color:gray">DOSCODE:40DF                 </span><span style="color:navy">dw offset </span>Idle
<span style="color:gray">DOSCODE:40E1                 </span><span style="color:navy">dw offset </span>StrCpy
<span style="color:gray">DOSCODE:40E3                 </span><span style="color:navy">dw offset </span>StrLen
<span style="color:gray">DOSCODE:40E5                 </span><span style="color:navy">dw offset </span>UCase
<span style="color:gray">DOSCODE:40E7                 </span><span style="color:navy">dw offset </span>POINTCOMP
<span style="color:gray">DOSCODE:40E9                 </span><span style="color:navy">dw offset </span>CHECKFLUSH
<span style="color:gray">DOSCODE:40EB                 </span><span style="color:navy">dw offset </span>SFFromSFN
<span style="color:gray">DOSCODE:40ED                 </span><span style="color:navy">dw offset </span>GetCDSFromDrv
<span style="color:gray">DOSCODE:40EF                 </span><span style="color:navy">dw offset </span>Get_User_Stack
<span style="color:gray">DOSCODE:40F1                 </span><span style="color:navy">dw offset </span>GETTHISDRV
<span style="color:gray">DOSCODE:40F3                 </span><span style="color:navy">dw offset </span>DriveFromText
<span style="color:gray">DOSCODE:40F5                 </span><span style="color:navy">dw offset </span>SETYEAR
<span style="color:gray">DOSCODE:40F7                 </span><span style="color:navy">dw offset </span>DSUM
<span style="color:gray">DOSCODE:40F9                 </span><span style="color:navy">dw offset </span>DSLIDE
<span style="color:gray">DOSCODE:40FB                 </span><span style="color:navy">dw offset </span>StrCmp
<span style="color:gray">DOSCODE:40FD                 </span><span style="color:navy">dw offset </span>InitCDS
<span style="color:gray">DOSCODE:40FF                 </span><span style="color:navy">dw offset </span>pJFNFromHandle
<span style="color:gray">DOSCODE:4101                 </span><span style="color:navy">dw offset </span>$NameTrans
<span style="color:gray">DOSCODE:4103                 </span><span style="color:navy">dw offset </span>CAL_LK
<span style="color:gray">DOSCODE:4105                 </span><span style="color:navy">dw offset </span>DEVNAME
<span style="color:gray">DOSCODE:4107                 </span><span style="color:navy">dw offset </span>Idle
<span style="color:gray">DOSCODE:4109                 </span><span style="color:navy">dw offset </span>DStrLen
<span style="color:gray">DOSCODE:410B                 </span><span style="color:navy">dw offset </span>NLS_OPEN
<span style="color:gray">DOSCODE:410D                 </span><span style="color:navy">dw offset </span>$CLOSE
<span style="color:gray">DOSCODE:410F                 </span><span style="color:navy">dw offset </span>NLS_LSEEK
<span style="color:gray">DOSCODE:4111                 </span><span style="color:navy">dw offset </span>$READ
<span style="color:gray">DOSCODE:4113                 </span><span style="color:navy">dw offset </span>FastInit
<span style="color:gray">DOSCODE:4115                 </span><span style="color:navy">dw offset </span>NLS_IOCTL
<span style="color:gray">DOSCODE:4117                 </span><span style="color:navy">dw offset </span>GetDevList
<span style="color:gray">DOSCODE:4119                 </span><span style="color:navy">dw offset </span>NLS_GETEXT
<span style="color:gray">DOSCODE:411B                 </span><span style="color:navy">dw offset </span>MSG_RETRIEVAL
<span style="color:gray">DOSCODE:411D                 </span><span style="color:navy">dw offset </span>NO_OP
<span style="color:gray">DOSCODE:411F                 </span><span style="color:navy">dw offset </span>int_2Fh_1230h
<span style="color:gray">DOSCODE:4121                 </span><span style="color:navy">dw offset </span>int_2Fh_1231h
<span style="color:black">DOSCODE:4123 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4123 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR STATCHK
</span><span style="color:black">DOSCODE:4123
DOSCODE:4123 </span>$SET_CTRL_C_TRAPPING<span style="color:navy">:                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4123                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">7           </span>; Is this a valid subfunction?
<span style="color:black">DOSCODE:4125                 </span><span style="color:navy">jbe     short </span><span style="color:gray">scct_1    </span>; yes
<span style="color:black">DOSCODE:4127                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:4129                 </span><span style="color:navy">iret
</span><span style="color:black">DOSCODE:412A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:412A
DOSCODE:412A </span><span style="color:gray">scct_1</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:412A                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:412B                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:4130                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:4131                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:4132                 </span><span style="color:navy">mov     si, offset </span>CNTCFLAG
<span style="color:black">DOSCODE:4135                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:4137                 </span><span style="color:navy">or      ax, ax          </span>; Check for subfunction 0
<span style="color:black">DOSCODE:4139                 </span><span style="color:navy">jnz     short </span><span style="color:gray">scct_2
</span><span style="color:black">DOSCODE:413B                 </span><span style="color:navy">mov     dl, [si]        </span>; DS:SI --&gt; Ctrl C Status byte
<span style="color:black">DOSCODE:413D                 </span><span style="color:navy">jmp     short </span><span style="color:gray">scct_9s
</span><span style="color:black">DOSCODE:413F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:413F
DOSCODE:413F </span><span style="color:gray">scct_2</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:413F                 </span><span style="color:navy">dec     ax
</span><span style="color:black">DOSCODE:4140                 </span><span style="color:navy">jnz     short </span><span style="color:gray">scct_3
</span><span style="color:black">DOSCODE:4142                 </span><span style="color:navy">and     dl, </span><span style="color:green">1           </span>; mask off bit 0 of DL and
<span style="color:black">DOSCODE:4145                 </span><span style="color:navy">mov     [si], dl        </span>; save it as new Ctrl C status
<span style="color:black">DOSCODE:4147                 </span><span style="color:navy">jmp     short </span><span style="color:gray">scct_9s
</span><span style="color:black">DOSCODE:4149 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4149
DOSCODE:4149 </span><span style="color:gray">scct_3</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4149                 </span><span style="color:navy">dec     ax
</span><span style="color:black">DOSCODE:414A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">scct_4
</span><span style="color:black">DOSCODE:414C                 </span><span style="color:navy">and     dl, </span><span style="color:green">1           </span>; mask off bit 0 of DL and
<span style="color:black">DOSCODE:414F                 </span><span style="color:navy">xchg    dl, [si]        </span>; exchange DL with old status byte
<span style="color:black">DOSCODE:4151                 </span><span style="color:navy">jmp     short </span><span style="color:gray">scct_9s
</span><span style="color:black">DOSCODE:4153 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4153
DOSCODE:4153 </span><span style="color:gray">scct_4</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4153                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3           </span>; test for 5 after it was dec twice
<span style="color:black">DOSCODE:4155                 </span><span style="color:navy">jnz     short </span><span style="color:gray">scct_5
</span><span style="color:black">DOSCODE:4157                 </span><span style="color:navy">mov     dl, ds:</span>BOOTDRIVE ; return boot drive in DL
<span style="color:black">DOSCODE:415B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">scct_9s
</span><span style="color:black">DOSCODE:415D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:415D
DOSCODE:415D </span><span style="color:gray">scct_5</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:415D                 </span><span style="color:navy">jb      short </span><span style="color:gray">scct_9s
</span><span style="color:black">DOSCODE:415F                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">4           </span>; test for 6 after it was dec twice
<span style="color:black">DOSCODE:4161                 </span><span style="color:navy">jnz     short </span><span style="color:gray">scct_6
</span><span style="color:black">DOSCODE:4163                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">0A07h       </span>; 7.10 ; (MINOR_VERSION&lt;&lt;8)+MAJOR_VERSION
<span style="color:black">DOSCODE:4166                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">0           </span>; DOSREVNM
<span style="color:black">DOSCODE:4169                 </span><span style="color:navy">cmp     ds:</span>DosHasHMA<span style="color:navy">, dh </span>; is DOS in HMA? no
<span style="color:black">DOSCODE:416D                 </span><span style="color:navy">jz      short </span><span style="color:gray">scct_9s
</span><span style="color:black">DOSCODE:416F                 </span><span style="color:navy">mov     dh, </span><span style="color:#ff8000">10h         </span>; yes
<span style="color:black">DOSCODE:4171                 </span><span style="color:navy">jmp     short </span><span style="color:gray">scct_9s   </span>; return version &amp; &#039;DOS in HMA&#039; status
<span style="color:black">DOSCODE:4173 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4173
DOSCODE:4173 </span><span style="color:gray">scct_6</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4173                 </span><span style="color:navy">and     ds:</span>DOS_FLAG<span style="color:navy">, </span><span style="color:green">0DFh </span>; clear bit 5 of DOS flag
<span style="color:black">DOSCODE:4178                 </span><span style="color:navy">cmp     dl, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:417B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">scct_9s
</span><span style="color:black">DOSCODE:417D                 </span><span style="color:navy">or      ds:</span>DOS_FLAG<span style="color:navy">, </span><span style="color:green">20h </span>; set bit 5 of DOS flag
<span style="color:black">DOSCODE:4182
DOSCODE:4182 </span><span style="color:gray">scct_9s</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4182                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:4183                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:4184                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4185                 </span><span style="color:navy">iret
</span><span style="color:black">DOSCODE:4186 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4186
DOSCODE:4186 </span><span style="color:gray">SetCtrlShortEntry</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4186                 </span><span style="color:navy">jmp     short </span>$SET_CTRL_C_TRAPPING
<span style="color:black">DOSCODE:4188 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4188
DOSCODE:4188 </span>$SET_CURRENT_PDB<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4188                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:4189                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:418E                 </span><span style="color:navy">mov     ds:</span>CurrentPDB<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:4192                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4193                 </span><span style="color:navy">iret
</span><span style="color:black">DOSCODE:4194 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4194
DOSCODE:4194 </span>$GET_CURRENT_PDB<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4194                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:4195                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:419A                 </span><span style="color:navy">mov     bx, ds:</span>CurrentPDB
<span style="color:black">DOSCODE:419E                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:419F                 </span><span style="color:navy">iret
</span><span style="color:black">DOSCODE:41A0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:41A0
DOSCODE:41A0 </span>$SET_PRINTER_FLAG<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:41A0                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:41A1                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:41A6                 </span><span style="color:navy">mov     ds:</span>PRINTER_FLAG<span style="color:navy">, al
</span><span style="color:black">DOSCODE:41A9                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:41AA                 </span><span style="color:navy">iret
</span><span style="color:black">DOSCODE:41AA </span><span style="color:gray">; END OF FUNCTION CHUNK FOR STATCHK
</span><span style="color:maroon">DOSCODE:41AB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:41AB
DOSCODE:41AB </span>QUIT<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:41AB                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:maroon">DOSCODE:41AD                 </span><span style="color:navy">jmp     short </span>SAVREGS
<span style="color:black">DOSCODE:41AF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:41AF </span><span style="color:gray">; START OF FUNCTION CHUNK FOR STATCHK
</span><span style="color:black">DOSCODE:41AF
DOSCODE:41AF </span>BADCALL<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:41AF                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">DOSCODE:41B1
DOSCODE:41B1 </span>irett<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:41B1                 </span><span style="color:navy">iret
</span><span style="color:black">DOSCODE:41B1 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR STATCHK
</span><span style="color:maroon">DOSCODE:41B2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:41B2
DOSCODE:41B2 </span>CALL_ENTRY<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:41B2                 </span><span style="color:navy">push    ds              </span>; System call entry point and dispatcher
<span style="color:maroon">DOSCODE:41B2                                         </span>; ***
<span style="color:maroon">DOSCODE:41B2                                         </span>; An alternative method of entering the system
<span style="color:maroon">DOSCODE:41B2                                         </span>; is to perform a CALL 5 in the program segment prefix
<span style="color:maroon">DOSCODE:41B2                                         </span>; with the contents of CL indicating what system call
<span style="color:maroon">DOSCODE:41B2                                         </span>; the user would like
<span style="color:maroon">DOSCODE:41B3                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:maroon">DOSCODE:41B8                 </span><span style="color:navy">pop     ds:</span>SAVEDS
<span style="color:maroon">DOSCODE:41BC                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:41BD                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:41BE                 </span><span style="color:navy">pop     ds:</span>USER_SP
<span style="color:maroon">DOSCODE:41C2                 </span><span style="color:navy">pushf                   </span>; Re-order the stack
<span style="color:maroon">DOSCODE:41C2                                         </span>; to simulate an interrupt 21h.
<span style="color:maroon">DOSCODE:41C3                 </span><span style="color:navy">cli
</span><span style="color:maroon">DOSCODE:41C4                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:41C5                 </span><span style="color:navy">push    ds:</span>USER_SP      ; Stack now ordered as if INT had been used
<span style="color:maroon">DOSCODE:41C9                 </span><span style="color:navy">push    ds:</span>SAVEDS
<span style="color:maroon">DOSCODE:41CD                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:41CE                 </span><span style="color:navy">cmp     cl, </span><span style="color:green">36          </span>; MAXCALL
<span style="color:maroon">DOSCODE:41CE                                         </span>; This entry point doesn&#039;t get as many calls
<span style="color:maroon">DOSCODE:41D1                 </span><span style="color:navy">ja      short </span>BADCALL
<span style="color:maroon">DOSCODE:41D3                 </span><span style="color:navy">mov     ah, cl
</span><span style="color:maroon">DOSCODE:41D5                 </span><span style="color:navy">jmp     short </span>SAVREGS
<span style="color:black">DOSCODE:41D7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:41D7 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR STATCHK
</span><span style="color:black">DOSCODE:41D7
DOSCODE:41D7 </span>COMMAND<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:41D7                 </span><span style="color:navy">cli                     </span>; This is the normal INT 21h entry point.
<span style="color:black">DOSCODE:41D7                                         </span>; We first perform a quick test to see if
<span style="color:black">DOSCODE:41D7                                         </span>; we need to perform expensive DOS-entry
<span style="color:black">DOSCODE:41D7                                         </span>; functions. Certain system calls are done
<span style="color:black">DOSCODE:41D7                                         </span>; without interrupts being enabled.
<span style="color:black">DOSCODE:41D8                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">73h
</span><span style="color:black">DOSCODE:41DB                 </span><span style="color:navy">ja      short </span>BADCALL
<span style="color:black">DOSCODE:41DD
DOSCODE:41DD </span>SAVREGS<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:41DD                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">33h         </span>; Check Minimum special case number
<span style="color:black">DOSCODE:41E0                 </span><span style="color:navy">jb      short </span><span style="color:gray">SaveAllRegs
</span><span style="color:black">DOSCODE:41E2                 </span><span style="color:navy">jz      short </span><span style="color:gray">SetCtrlShortEntry
</span><span style="color:black">DOSCODE:41E4                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">64h         </span>; Check Maximum case number
<span style="color:black">DOSCODE:41E7                 </span><span style="color:navy">ja      short </span><span style="color:gray">SaveAllRegs
</span><span style="color:black">DOSCODE:41E9                 </span><span style="color:navy">jz      short </span>$SET_PRINTER_FLAG
<span style="color:black">DOSCODE:41EB                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">51h
</span><span style="color:black">DOSCODE:41EE                 </span><span style="color:navy">jz      short </span>$GET_CURRENT_PDB
<span style="color:black">DOSCODE:41F0                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">50h
</span><span style="color:black">DOSCODE:41F3                 </span><span style="color:navy">jz      short </span>$SET_CURRENT_PDB
<span style="color:black">DOSCODE:41F5                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">62h
</span><span style="color:black">DOSCODE:41F8                 </span><span style="color:navy">jz      short </span>$GET_CURRENT_PDB
<span style="color:black">DOSCODE:41FA
DOSCODE:41FA </span><span style="color:gray">SaveAllRegs</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:41FA                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:41FB                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:41FC                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:41FD                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:41FE                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:41FF                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:4200                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:4201                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:4202                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:4203                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:black">DOSCODE:4205                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:420A                 </span><span style="color:navy">mov     ds:</span>SAVEDS<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:420D                 </span><span style="color:navy">mov     ax, ds:</span>USER_SP
<span style="color:black">DOSCODE:4210                 </span><span style="color:navy">mov     ds:</span>SAVEBX<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:4214                 </span><span style="color:navy">mov     ds:</span>NSP<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:4217                 </span><span style="color:navy">mov     ax, ds:</span>USER_SS
<span style="color:black">DOSCODE:421A                 </span><span style="color:navy">mov     ds:</span>NSS<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:421D                 </span><span style="color:navy">xor     ax, ax          </span>; 0
<span style="color:black">DOSCODE:421F                 </span><span style="color:navy">test    ds:</span>IsWin386<span style="color:navy">, </span><span style="color:green">1  </span>; WIN386 patch. Do not update USER_ID
<span style="color:black">DOSCODE:4224                 </span><span style="color:navy">mov     ds:</span>FSHARING<span style="color:navy">, al </span>; allow redirection
<span style="color:black">DOSCODE:4227                 </span><span style="color:navy">jnz     short </span><span style="color:gray">set_indos_flag </span>; if win386 present
<span style="color:black">DOSCODE:4229                 </span><span style="color:navy">mov     ds:</span>USER_ID<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:422C
DOSCODE:422C </span><span style="color:gray">set_indos_flag</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:422C                 </span><span style="color:navy">inc     ds:</span>INDOS        ; Flag that we&#039;re in the DOS
<span style="color:black">DOSCODE:4230                 </span><span style="color:navy">inc     ds:</span>INDOS_FLAG   ; duplicated INDOS flag (what for ?)
<span style="color:black">DOSCODE:4234                 </span><span style="color:navy">mov     ax, ds:</span>CurrentPDB
<span style="color:black">DOSCODE:4237                 </span><span style="color:navy">mov     ds:</span>USER_SP<span style="color:navy">, sp
</span><span style="color:black">DOSCODE:423B                 </span><span style="color:navy">mov     ds:</span>USER_SS<span style="color:navy">, ss
</span><span style="color:black">DOSCODE:423F                 </span><span style="color:navy">mov     ds:</span>PROC_ID<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:4242                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">DOSCODE:4244                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:4245                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:4246                 </span><span style="color:navy">mov     </span>word ptr ds:2Eh<span style="color:navy">, sp </span>; [PDB.USER_STACK]
<span style="color:black">DOSCODE:424A                 </span><span style="color:navy">mov     </span>word ptr ds:30h<span style="color:navy">, ss </span>; [PDB.USER_STACK+2]
<span style="color:black">DOSCODE:424E                 </span><span style="color:navy">mov     ss, cs:</span>DosDSeg
<span style="color:black">DOSCODE:4253
DOSCODE:4253 </span>REDISP<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4253                 </span><span style="color:navy">mov     sp, offset </span>AUXSTACK
<span style="color:black">DOSCODE:4256                 </span><span style="color:navy">sti
</span><span style="color:black">DOSCODE:4257                 </span><span style="color:navy">mov     bx, ss
</span><span style="color:black">DOSCODE:4259                 </span><span style="color:navy">mov     ds, bx
</span><span style="color:black">DOSCODE:425B                 </span><span style="color:navy">xchg    ax, bx
</span><span style="color:black">DOSCODE:425C                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:425E                 </span><span style="color:navy">mov     ds:</span>EXTOPEN_ON<span style="color:navy">, al </span>; Clear extended open flag
<span style="color:black">DOSCODE:4261                 </span><span style="color:navy">and     ds:</span>DOS34_FLAG<span style="color:navy">, </span><span style="color:green">800h </span>; EXEC_AWARE_REDIR
<span style="color:black">DOSCODE:4261                                         </span>; clear all bits except bit 11
<span style="color:black">DOSCODE:4267                 </span><span style="color:navy">mov     ds:</span>CONSWAP<span style="color:navy">, al  </span>; random clean up of possibly mis-set flags
<span style="color:black">DOSCODE:426A                 </span><span style="color:navy">mov     ds:</span>NoSetDir<span style="color:navy">, al </span>; set directories on search
<span style="color:black">DOSCODE:426D                 </span><span style="color:navy">mov     ds:</span>FAILERR<span style="color:navy">, al  </span>; FAIL not in progress
<span style="color:black">DOSCODE:4270                 </span><span style="color:navy">inc     ax
</span><span style="color:black">DOSCODE:4271                 </span><span style="color:navy">mov     ds:</span>IDLEINT<span style="color:navy">, al  </span>; presume that we can issue INT 28h
<span style="color:black">DOSCODE:4274                 </span><span style="color:navy">xchg    ax, bx          </span>; Restore AX and BX = 1
<span style="color:black">DOSCODE:4275                 </span><span style="color:navy">mov     bl, ah
</span><span style="color:black">DOSCODE:4277                 </span><span style="color:navy">add     bx, bx          </span>; 2 bytes per call in table
<span style="color:black">DOSCODE:4279                 </span><span style="color:navy">cld
</span><span style="color:black">DOSCODE:427A                 </span><span style="color:navy">or      ah, ah
</span><span style="color:black">DOSCODE:427C                 </span><span style="color:navy">jz      short </span><span style="color:gray">DSKROUT
</span><span style="color:black">DOSCODE:427E                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">59h         </span>; GETEXTENDEDERROR
<span style="color:black">DOSCODE:4281                 </span><span style="color:navy">jz      short </span><span style="color:gray">DISPCALL
</span><span style="color:black">DOSCODE:4283                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">0Ch         </span>; STD_CON_INPUT_FLUSH ; 12
<span style="color:black">DOSCODE:4286                 </span><span style="color:navy">ja      short </span><span style="color:gray">DSKROUT
</span><span style="color:black">DOSCODE:4288
DOSCODE:4288 </span>IOROUT<span style="color:navy">:                                 </span>;
<span style="color:black">DOSCODE:4288                 </span><span style="color:navy">cmp     ds:</span>ERRORMODE<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; Are we in an INT 24h
<span style="color:black">DOSCODE:428D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">DISPCALL  </span>; Stay on AUXSTACK if INT 24h
<span style="color:black">DOSCODE:428F                 </span><span style="color:navy">mov     sp, offset </span>PRINTER_FLAG ; mov sp,IOSTACK
<span style="color:black">DOSCODE:4292                 </span><span style="color:navy">jmp     short </span><span style="color:gray">DISPCALL
</span><span style="color:black">DOSCODE:4294 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4294
DOSCODE:4294 </span><span style="color:gray">DSKROUT</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4294                 </span><span style="color:navy">mov     ds:</span>USER_IN_AX<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:4297                 </span><span style="color:navy">mov     word ptr ds:</span>WPERR<span style="color:navy">, </span><span style="color:#ff8000">1FFh
</span><span style="color:black">DOSCODE:429D                 </span><span style="color:navy">mov     ds:</span>ERRORMODE<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:42A2                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:42A3                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">82h
</span><span style="color:black">DOSCODE:42A5                 </span><span style="color:navy">int     </span><span style="color:green">2Ah             </span>; Microsoft Networks - END DOS CRITICAL SECTIONS 0 THROUGH 7
<span style="color:black">DOSCODE:42A7                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:42A8                 </span><span style="color:navy">mov     ds:</span>IDLEINT<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:42AD                 </span><span style="color:navy">mov     sp, offset </span>DSKSTACK <span style="color:gray">; &quot;@#IBM:12.01.2003.build_1.32#@ IBMDOS.CO&quot;...
</span><span style="color:black">DOSCODE:42B0                 </span><span style="color:navy">test    ds:</span>CNTCFLAG<span style="color:navy">, </span><span style="color:green">0FFh
</span><span style="color:black">DOSCODE:42B5                 </span><span style="color:navy">jz      short </span><span style="color:gray">DISPCALL
</span><span style="color:black">DOSCODE:42B7                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:42B8                 </span><span style="color:navy">call    </span>DSKSTATCHK
<span style="color:black">DOSCODE:42BB                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:42BC
DOSCODE:42BC </span><span style="color:gray">DISPCALL</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:42BC                 </span><span style="color:navy">mov     bx, cs:</span>DISPATCH<span style="color:navy">[bx]
</span><span style="color:black">DOSCODE:42C1                 </span><span style="color:navy">xchg    bx, ds:</span>SAVEBX
<span style="color:black">DOSCODE:42C5                 </span><span style="color:navy">mov     ds, ds:</span>SAVEDS
<span style="color:black">DOSCODE:42C9                 </span><span style="color:navy">call    ss:</span>SAVEBX
<span style="color:black">DOSCODE:42CE                 </span><span style="color:navy">and     ss:</span>DOS_FLAG<span style="color:navy">, </span><span style="color:green">0DBh
</span><span style="color:black">DOSCODE:42D4
DOSCODE:42D4 </span>LeaveDOS<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:42D4                 </span><span style="color:navy">cli
</span><span style="color:black">DOSCODE:42D5                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:42DA                 </span><span style="color:navy">cmp     ds:</span>A20OFF_COUNT<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:42DF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">disa20
</span><span style="color:black">DOSCODE:42E1
DOSCODE:42E1 </span><span style="color:gray">LeaveA20On</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:42E1                 </span><span style="color:navy">dec     ds:</span>INDOS
<span style="color:black">DOSCODE:42E5                 </span><span style="color:navy">dec     ds:</span>INDOS_FLAG
<span style="color:black">DOSCODE:42E9                 </span><span style="color:navy">mov     ss, ds:</span>USER_SS
<span style="color:black">DOSCODE:42ED                 </span><span style="color:navy">mov     sp, ds:</span>USER_SP
<span style="color:black">DOSCODE:42F1                 </span><span style="color:navy">mov     bp, sp
</span><span style="color:black">DOSCODE:42F3                 </span><span style="color:navy">mov     [bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], al
</span><span style="color:black">DOSCODE:42F6                 </span><span style="color:navy">les     ax, dword ptr ds:</span>NSS
<span style="color:black">DOSCODE:42FA                 </span><span style="color:navy">mov     ds:</span>USER_SS<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:42FD                 </span><span style="color:navy">mov     ds:</span>USER_SP<span style="color:navy">, es
</span><span style="color:black">DOSCODE:4301                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:4302                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:4303                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:4304                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:4305                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:4306                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:4307                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:4308                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4309                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:430A                 </span><span style="color:navy">iret
</span><span style="color:black">DOSCODE:430B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:430B
DOSCODE:430B </span><span style="color:gray">disa20</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:430B                 </span><span style="color:navy">mov     bx, ds:</span>A20OFF_PSP
<span style="color:black">DOSCODE:430F                 </span><span style="color:navy">cmp     bx, ds:</span>CurrentPDB
<span style="color:black">DOSCODE:4313                 </span><span style="color:navy">jnz     short </span><span style="color:gray">LeaveA20On
</span><span style="color:black">DOSCODE:4315                 </span><span style="color:navy">dec     ds:</span>A20OFF_COUNT
<span style="color:black">DOSCODE:4319                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:431A                 </span><span style="color:navy">mov     bx, offset </span>disa20_iret
<span style="color:black">DOSCODE:431D                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:431E                 </span><span style="color:navy">retf
</span><span style="color:black">DOSCODE:431E </span><span style="color:gray">; END OF FUNCTION CHUNK FOR STATCHK
</span><span style="color:black">DOSCODE:431F
DOSCODE:431F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:431F
DOSCODE:431F
DOSCODE:431F </span>restore_world   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:431F                 </span><span style="color:navy">mov     es, cs:</span>DosDSeg
<span style="color:black">DOSCODE:4324                 </span><span style="color:navy">pop     es:</span>RESTORE_TMP
<span style="color:black">DOSCODE:4329                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:432A                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:432B                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:432C                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:432D                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:432E                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:432F                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:4330                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4331                 </span><span style="color:navy">jmp     es:</span>RESTORE_TMP
<span style="color:black">DOSCODE:4331 </span><span style="background:red">restore_world   endp</span><span style="background:red"> ; sp-analysis failed</span>
<span style="color:black">DOSCODE:4331
DOSCODE:4336
DOSCODE:4336 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4336
DOSCODE:4336
DOSCODE:4336 </span>save_world      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4336                 </span><span style="color:navy">mov     es, cs:</span>DosDSeg
<span style="color:black">DOSCODE:433B                 </span><span style="color:navy">pop     es:</span>RESTORE_TMP
<span style="color:black">DOSCODE:4340                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:4341                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:4342                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:4343                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:4344                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:4345                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:4346                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:4347                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:4348                 </span><span style="color:navy">push    es:</span>RESTORE_TMP
<span style="color:black">DOSCODE:434D                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:434E                 </span><span style="color:navy">mov     bp, sp
</span><span style="color:black">DOSCODE:4350                 </span><span style="color:navy">mov     es, word ptr [bp+</span><span style="color:green">20</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:4353                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:4354                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4354 </span><span style="background:red">save_world      endp</span><span style="background:red"> ; sp-analysis failed</span>
<span style="color:black">DOSCODE:4354
DOSCODE:4355
DOSCODE:4355 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4355
DOSCODE:4355
DOSCODE:4355 </span>Get_User_Stack  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4355                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:435A                 </span><span style="color:navy">lds     si, dword ptr ds:</span>USER_SP
<span style="color:black">DOSCODE:435E                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:435E </span>Get_User_Stack  <span style="color:black">endp
DOSCODE:435E
DOSCODE:435E </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSCODE:435F </span>ERRIN           <span style="color:navy">db </span><span style="color:#008040">2                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:4360                 </span><span style="color:navy">db </span><span style="color:#008040">6
</span><span style="color:gray">DOSCODE:4361                 </span><span style="color:navy">db </span><span style="color:#008040">0Ch
</span><span style="color:gray">DOSCODE:4362                 </span><span style="color:navy">db </span><span style="color:#008040">4
</span><span style="color:gray">DOSCODE:4363                 </span><span style="color:navy">db </span><span style="color:#008040">8
</span><span style="color:gray">DOSCODE:4364                 </span><span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">DOSCODE:4365 </span>ERROUT          <span style="color:navy">db </span><span style="color:#008040">80h
</span><span style="color:gray">DOSCODE:4366                 </span><span style="color:navy">db </span><span style="color:#008040">40h
</span><span style="color:gray">DOSCODE:4367                 </span><span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">DOSCODE:4368                 </span><span style="color:navy">db </span><span style="color:#008040">10h
</span><span style="color:gray">DOSCODE:4369                 </span><span style="color:navy">db </span><span style="color:#008040">4
</span><span style="color:gray">DOSCODE:436A                 </span><span style="color:navy">db </span><span style="color:#008040">3
</span><span style="color:black">DOSCODE:436B
DOSCODE:436B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:436B
DOSCODE:436B
DOSCODE:436B </span>AbsSetup        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:436B                 </span><span style="color:navy">mov     ss:</span>absdrw_extd<span style="color:navy">, ah </span>; Extended ABS Disk Read/Write flag
<span style="color:black">DOSCODE:436B                                         </span>; (AH=1 for INT 21h ax=7305h function)
<span style="color:black">DOSCODE:4370                 </span><span style="color:navy">or      ah, ah
</span><span style="color:black">DOSCODE:4372                 </span><span style="color:navy">jnz     short </span><span style="color:gray">AbsSetup1 </span>; INT 21h AX=7305h
<span style="color:black">DOSCODE:4372                                         </span>; INT 25h
<span style="color:black">DOSCODE:4374                 </span><span style="color:navy">inc     ss:</span>INDOS_FLAG   ; Windows DOSBOX&#039;s INDOS flag ?
<span style="color:black">DOSCODE:4379                 </span><span style="color:navy">inc     ss:</span>INDOS
<span style="color:black">DOSCODE:437E
DOSCODE:437E </span><span style="color:gray">AbsSetup1</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:437E                 </span><span style="color:navy">sti
</span><span style="color:black">DOSCODE:437F                 </span><span style="color:navy">cld
</span><span style="color:black">DOSCODE:4380                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:4381                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:4382                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4383                 </span><span style="color:navy">call    </span>GETBP
<span style="color:black">DOSCODE:4386                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4387                 </span><span style="color:navy">jb      short </span>errdriv
<span style="color:black">DOSCODE:4389
DOSCODE:4389 </span>AbsSetup2<span style="color:navy">:
</span><span style="color:black">DOSCODE:4389                 </span><span style="color:navy">mov     ss:</span>HIGH_SECTOR<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:4390                 </span><span style="color:navy">call    </span>RW32_CONVERT
<span style="color:black">DOSCODE:4393                 </span><span style="color:navy">jb      short </span>errdriv
<span style="color:black">DOSCODE:4395                 </span><span style="color:navy">call    </span>null_sub
<span style="color:black">DOSCODE:4398                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:4399                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:439A                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:439B                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:439C                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:439D                 </span><span style="color:navy">mov     si, offset </span>OPENBUF
<span style="color:black">DOSCODE:43A0                 </span><span style="color:navy">mov     [si], al
</span><span style="color:black">DOSCODE:43A2                 </span><span style="color:navy">add     byte ptr [si], </span><span style="color:#ff8000">41h </span><span style="color:gray">; &#039;A&#039;
</span><span style="color:black">DOSCODE:43A5                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">1</span><span style="color:navy">], </span><span style="color:#ff8000">3Ah </span><span style="color:gray">; &#039;:&#039;
</span><span style="color:black">DOSCODE:43AA                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">300h
</span><span style="color:black">DOSCODE:43AD                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:43AE                 </span><span style="color:navy">int     </span><span style="color:green">2Ah             </span>; Microsoft Networks - CHECK DIRECT I/O
<span style="color:black">DOSCODE:43AE                                         </span>; DS:SI -&gt; ASCIZ disk device name (may be full path or only drive
<span style="color:black">DOSCODE:43AE                                         </span>; specifier--must include the colon)
<span style="color:black">DOSCODE:43AE                                         </span>; Return: CF clear if absolute disk access allowed
<span style="color:black">DOSCODE:43B0                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:43B1                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:43B2                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:43B3                 </span><span style="color:navy">jnb     short </span><span style="color:gray">AbsSetup_retn
</span><span style="color:black">DOSCODE:43B5
DOSCODE:43B5 </span>errdriv<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:43B5                 </span><span style="color:navy">mov     ss:</span>EXTERR<span style="color:navy">, </span><span style="color:green">32h  </span>; error_not_supported
<span style="color:black">DOSCODE:43BC                 </span><span style="color:navy">mov     ss:</span>AbsDskErr<span style="color:navy">, </span><span style="color:#ff8000">207h </span>; disk error ? (bad address mark)
<span style="color:black">DOSCODE:43C3
DOSCODE:43C3 </span><span style="color:gray">AbsSetup_retn</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:43C3                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:43C3 </span>AbsSetup        <span style="color:black">endp
DOSCODE:43C3
</span><span style="color:maroon">DOSCODE:43C4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:43C4
DOSCODE:43C4 </span>ABSDRD<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:43C4                 </span><span style="color:navy">xor     ah, ah          </span>; Interrupt 25h handler (ah=0)
<span style="color:maroon">DOSCODE:43C6                 </span><span style="color:navy">xor     si, si          </span>; clear read/write mode flags
<span style="color:maroon">DOSCODE:43C6                                         </span>; (used with INT 21h ax=7305h)
<span style="color:maroon">DOSCODE:43C8
DOSCODE:43C8 </span>FAT32_ABSDRD<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:43C8                 </span><span style="color:navy">cli                     </span>; ah=1
<span style="color:maroon">DOSCODE:43C9                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:43CA </span><span style="color:gray">; START OF FUNCTION CHUNK FOR FAT32_ABSDWRT
</span><span style="color:black">DOSCODE:43CA
DOSCODE:43CA </span><span style="color:gray">absdrd_1</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:43CA                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:43CB                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:black">DOSCODE:43CD                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:43D2                 </span><span style="color:navy">mov     ds:</span>TEMPSEG<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:43D5                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:43D6                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:43D7                 </span><span style="color:navy">jnb     short </span><span style="color:gray">absdrd_2  </span>; (not jumped from ABSDWRT) absolute disk read
<span style="color:black">DOSCODE:43D7                                         </span>; (jumped from ABSDRWT)
<span style="color:black">DOSCODE:43D9                 </span><span style="color:navy">or      ah, ah
</span><span style="color:black">DOSCODE:43DB                 </span><span style="color:navy">stc                     </span>; absolute disk write
<span style="color:black">DOSCODE:43DC                 </span><span style="color:navy">jmp     short </span><span style="color:gray">absdrd_3
</span><span style="color:black">DOSCODE:43DE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:43DE
DOSCODE:43DE </span><span style="color:gray">absdrd_2</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:43DE                 </span><span style="color:navy">or      ah, ah
</span><span style="color:black">DOSCODE:43E0
DOSCODE:43E0 </span><span style="color:gray">absdrd_3</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:43E0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">absdrd_4  </span>; EXTENDED ABSOLUTE DISK READ/WRITE
<span style="color:black">DOSCODE:43E2                 </span><span style="color:navy">mov     ds:</span>AbsRdWr_SS<span style="color:navy">, ss
</span><span style="color:black">DOSCODE:43E6                 </span><span style="color:navy">mov     ds:</span>AbsRdWr_SP<span style="color:navy">, sp
</span><span style="color:black">DOSCODE:43EA                 </span><span style="color:navy">mov     ss, cs:</span>DosDSeg
<span style="color:black">DOSCODE:43EF                 </span><span style="color:navy">mov     sp, offset </span>DSKSTACK <span style="color:gray">; &quot;@#IBM:12.01.2003.build_1.32#@ IBMDOS.CO&quot;...
</span><span style="color:black">DOSCODE:43F2
DOSCODE:43F2 </span><span style="color:gray">absdrd_4</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:43F2                 </span><span style="color:navy">mov     ds, ds:</span>TEMPSEG
<span style="color:black">DOSCODE:43F6                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:43F7                 </span><span style="color:navy">call    </span>save_world
<span style="color:black">DOSCODE:43FA                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:43FB                 </span><span style="color:navy">jnb     short </span><span style="color:gray">absdrd_5  </span>; absolute disk read
<span style="color:black">DOSCODE:43FD                 </span><span style="color:navy">jmp     </span><span style="color:gray">absdrwt_3       </span>; (jumping back to) absolute disk write
<span style="color:black">DOSCODE:4400 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4400
DOSCODE:4400 </span><span style="color:gray">absdrd_5</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4400                 </span><span style="color:navy">call    </span>AbsSetup
<span style="color:black">DOSCODE:4403                 </span><span style="color:navy">jb      short </span>ILEAVE
<span style="color:black">DOSCODE:4405                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:4408                 </span><span style="color:navy">mov     ss:</span>CurSC_DRIVE<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; invalidate secondary cache
<span style="color:black">DOSCODE:440E                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:4411                 </span><span style="color:navy">call    </span>DSKREAD
<span style="color:black">DOSCODE:4414                 </span><span style="color:navy">jnz     short </span>ERR_LEAVE
<span style="color:black">DOSCODE:4416                 </span><span style="color:navy">mov     cx, di
</span><span style="color:black">DOSCODE:4418                 </span><span style="color:navy">mov     ss:</span>TEMP_VAR2<span style="color:navy">, ds
</span><span style="color:black">DOSCODE:441D                 </span><span style="color:navy">mov     ss:</span>TEMP_VAR<span style="color:navy">, bx </span>; CX = # of contiguous sectors read
<span style="color:black">DOSCODE:441D                                         </span>; ES:BP -&gt; Drive Parameter Block (DPB)
<span style="color:black">DOSCODE:441D                                         </span>; [HIGH_SECTOR]:DX = physical sector # of 1st sector in extent
<span style="color:black">DOSCODE:441D                                         </span>; [TEMP_VAR2]:[TEMP_VAR] = Transfer address
<span style="color:black">DOSCODE:4422                 </span><span style="color:navy">call    </span>DskRdBufScan
<span style="color:black">DOSCODE:4425                 </span><span style="color:navy">jmp     short </span>ILEAVE
<span style="color:black">DOSCODE:4427 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4427
DOSCODE:4427 </span><span style="color:gray">TLEAVE</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4427                 </span><span style="color:navy">jz      short </span>ILEAVE
<span style="color:black">DOSCODE:4429
DOSCODE:4429 </span>ERR_LEAVE<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4429                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:442A                 </span><span style="color:navy">push    cs
</span><span style="color:black">DOSCODE:442B                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:442C                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:442C                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:442E                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:4431                 </span><span style="color:navy">mov     di, offset </span>ERRIN
<span style="color:black">DOSCODE:4434                 </span><span style="color:navy">repne scasb
</span><span style="color:black">DOSCODE:4436                 </span><span style="color:navy">jnz     short </span>LEAVECODE
<span style="color:black">DOSCODE:4438                 </span><span style="color:navy">mov     ah, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [ES:DI+NUMERR-1]
<span style="color:black">DOSCODE:443C
DOSCODE:443C </span>LEAVECODE<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:443C                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:443D                 </span>assume es:nothing
<span style="color:black">DOSCODE:443D                 </span><span style="color:navy">mov     ss:</span>AbsDskErr<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:4441                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:4442
DOSCODE:4442 </span>ILEAVE<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4442                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:4443                 </span><span style="color:navy">call    </span>restore_world
<span style="color:black">DOSCODE:4446                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:4447                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:4448                 </span><span style="color:navy">cmp     ss:</span>absdrw_extd<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; FAT32- EXTENDED ABSOLUTE DISK READ/WRITE flag
<span style="color:black">DOSCODE:444E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ILEAVE_EXTD </span>; INT 21h AX=7305h
<span style="color:black">DOSCODE:444E                                         </span>; INT 25h
<span style="color:black">DOSCODE:4450                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:4451                 </span><span style="color:navy">cli
</span><span style="color:black">DOSCODE:4452                 </span><span style="color:navy">mov     ax, ss:</span>AbsDskErr
<span style="color:black">DOSCODE:4456                 </span><span style="color:navy">dec     ss:</span>INDOS
<span style="color:black">DOSCODE:445B                 </span><span style="color:navy">dec     ss:</span>INDOS_FLAG
<span style="color:black">DOSCODE:4460                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:4461                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:4462                 </span><span style="color:navy">mov     ss, es:</span>AbsRdWr_SS
<span style="color:black">DOSCODE:4467                 </span>assume ss:DOSCODE
<span style="color:black">DOSCODE:4467                 </span><span style="color:navy">mov     sp, es:</span>AbsRdWr_SP
<span style="color:black">DOSCODE:446C                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:446D                 </span><span style="color:navy">sti
</span><span style="color:black">DOSCODE:446E                 </span><span style="color:navy">retf
</span><span style="color:black">DOSCODE:446F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:446F
DOSCODE:446F </span><span style="color:gray">ILEAVE_EXTD</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:446F                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:4470                 </span><span style="color:navy">mov     ax, ss:</span>AbsDskErr
<span style="color:black">DOSCODE:4474                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:4475                 </span><span style="color:navy">sti
</span><span style="color:black">DOSCODE:4476                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4476 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR FAT32_ABSDWRT
</span><span style="color:maroon">DOSCODE:4477 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4477
DOSCODE:4477 </span>ABSDWRT<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4477                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:maroon">DOSCODE:4479                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:447C
DOSCODE:447C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:447C
DOSCODE:447C
DOSCODE:447C </span>FAT32_ABSDWRT   <span style="color:black">proc far                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:447C
DOSCODE:447C </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:43CA SIZE 000000AD BYTES
</span><span style="color:black">DOSCODE:447C
DOSCODE:447C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:447E                 </span><span style="color:navy">jb      short </span><span style="color:gray">absdrwt_2 </span>; floppy disk
<span style="color:black">DOSCODE:447E                                         </span>; hard disk
<span style="color:black">DOSCODE:4480                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:4481                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:4482                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:4487                 </span><span style="color:navy">xor     bh, bh
</span><span style="color:black">DOSCODE:4489                 </span><span style="color:navy">mov     bl, al          </span>;
<span style="color:black">DOSCODE:4489                                         </span>; NOTE: PCDOS 7.1 kernel does not set
<span style="color:black">DOSCODE:4489                                         </span>; DOS_FLAG bit 6 or drive_flags bit 7
<span style="color:black">DOSCODE:4489                                         </span>; (It appears that these bits are set
<span style="color:black">DOSCODE:4489                                         </span>; by Windows or a system utility or
<span style="color:black">DOSCODE:4489                                         </span>; driver that knows the addresses of
<span style="color:black">DOSCODE:4489                                         </span>; these FLAGs in the DOSDATA segment.)
<span style="color:black">DOSCODE:4489                                         </span>; Erdogan Tan - 03/01/2024
<span style="color:black">DOSCODE:448B                 </span><span style="color:navy">test    ds:</span>drive_flags<span style="color:navy">[bx], </span><span style="color:green">80h </span>; test bit 7 (locked bit) ; 29/01/2024
<span style="color:black">DOSCODE:4490                 </span><span style="color:navy">jnz     short </span><span style="color:gray">absdwrt_1 </span>; locked (logical drive) -allowed to abs write-
<span style="color:black">DOSCODE:4490                                         </span>; NOTE: lock/unlock are MSDOS/PCDOS 7 extd functions
<span style="color:black">DOSCODE:4492                 </span><span style="color:navy">test    ds:</span>DOS_FLAG<span style="color:navy">, </span><span style="color:green">40h </span>; test bit 6 (large disk support -windows- bit?)
<span style="color:black">DOSCODE:4492                                         </span>; NOTE: Retro DOS v5 kernel must set this bit.
<span style="color:black">DOSCODE:4497
DOSCODE:4497 </span><span style="color:gray">absdwrt_1</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4497                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4498                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:4499                 </span><span style="color:navy">jnz     short </span><span style="color:gray">absdrwt_2 </span>; allowed
<span style="color:black">DOSCODE:449B                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:449C                 </span><span style="color:navy">call    </span>errdriv         ; error
<span style="color:black">DOSCODE:449F                 </span><span style="color:navy">retf
</span><span style="color:black">DOSCODE:44A0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:44A0
DOSCODE:44A0 </span><span style="color:gray">absdrwt_2</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:44A0                 </span><span style="color:navy">cli
</span><span style="color:black">DOSCODE:44A1                 </span><span style="color:navy">stc                     </span>; writable disk
<span style="color:black">DOSCODE:44A1                                         </span>; (&#039;jumped from ABSDWRT&#039; sign for common r/w code)
<span style="color:black">DOSCODE:44A2                 </span><span style="color:navy">jmp     </span><span style="color:gray">absdrd_1        </span>; jump to ABSDRD (common r/w) code
<span style="color:black">DOSCODE:44A5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:44A5
DOSCODE:44A5 </span><span style="color:gray">absdrwt_3</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:44A5                 </span><span style="color:navy">call    </span>AbsSetup
<span style="color:black">DOSCODE:44A8                 </span><span style="color:navy">jb      short </span>ILEAVE
<span style="color:black">DOSCODE:44AA                 </span><span style="color:navy">call    </span>chk_set_first_access
<span style="color:black">DOSCODE:44AD                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:44B0                 </span><span style="color:navy">mov     ss:</span>CurSC_DRIVE<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; invalidate secondary cache
<span style="color:black">DOSCODE:44B6                 </span><span style="color:navy">call    </span>Fastxxx_Purge   ; purge fatopen
<span style="color:black">DOSCODE:44B9                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:44BC                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:44BD                 </span><span style="color:navy">call    </span>DskWrtBufPurge
<span style="color:black">DOSCODE:44C0                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:44C1                 </span><span style="color:navy">call    </span>DSKWRITE
<span style="color:black">DOSCODE:44C4                 </span><span style="color:navy">jmp     </span><span style="color:gray">TLEAVE
</span><span style="color:black">DOSCODE:44C4 </span>FAT32_ABSDWRT   <span style="color:black">endp
DOSCODE:44C4
DOSCODE:44C7
DOSCODE:44C7 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:44C7
DOSCODE:44C7
DOSCODE:44C7 </span>GETBP           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:44C7                 </span><span style="color:navy">push    ax              </span>; logical unit number
<span style="color:black">DOSCODE:44C8                 </span><span style="color:navy">add     al, </span><span style="color:#ff8000">1           </span>; no increment; need carry flag
<span style="color:black">DOSCODE:44CA                 </span><span style="color:navy">jb      short </span><span style="color:gray">SKIPGET
</span><span style="color:black">DOSCODE:44CC                 </span><span style="color:navy">call    </span>GETTHISDRV
<span style="color:black">DOSCODE:44CF                 </span><span style="color:navy">jnb     short </span><span style="color:gray">SKIPGET   </span>; good drive
<span style="color:black">DOSCODE:44D1                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:44D3                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">1Ah         </span>; error_not_DOS_disk
<span style="color:black">DOSCODE:44D6                 </span><span style="color:navy">jz      short </span><span style="color:gray">SKIPGET   </span>; unknown media
<span style="color:black">DOSCODE:44D8                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:44D9                 </span><span style="color:navy">mov     ds:</span>EXTERR<span style="color:navy">, ax   </span>; invalid drive or Non DOS drive
<span style="color:black">DOSCODE:44DC                 </span><span style="color:navy">mov     ds:</span>AbsDskErr<span style="color:navy">, </span><span style="color:#ff8000">201h
</span><span style="color:black">DOSCODE:44E2
DOSCODE:44E2 </span><span style="color:gray">SKIPGET</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:44E2                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:44E3                 </span><span style="color:navy">jnb     short </span><span style="color:gray">GETBP_@f
</span><span style="color:black">DOSCODE:44E5                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:44E6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:44E6
DOSCODE:44E6 </span><span style="color:gray">GETBP_@f</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:44E6                 </span><span style="color:navy">les     bp, ds:</span>THISCDS
<span style="color:black">DOSCODE:44EA                 </span><span style="color:navy">test    byte ptr es:[bp+</span><span style="color:#ff8000">44h</span><span style="color:navy">], </span><span style="color:green">80h </span>; [es:bp+curdir.flags+1],
<span style="color:black">DOSCODE:44EA                                         </span>; curdir_isnet&gt;&gt;8
<span style="color:black">DOSCODE:44EF                 </span><span style="color:navy">jz      short </span><span style="color:gray">GETBP_CDS
</span><span style="color:black">DOSCODE:44F1
DOSCODE:44F1 </span><span style="color:gray">GETBP_err</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:44F1                 </span><span style="color:navy">mov     ds:</span>EXTERR<span style="color:navy">, </span><span style="color:#ff8000">32h </span><span style="color:gray">; &#039;2&#039; </span>; error_not_supported
<span style="color:black">DOSCODE:44F7                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:44F8                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:44F9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:44F9
DOSCODE:44F9 </span><span style="color:gray">GETBP_CDS</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:44F9                 </span><span style="color:navy">les     bp, es:[bp+</span><span style="color:#ff8000">45h</span><span style="color:navy">] </span>; [ES:BP+curdir.devptr]
<span style="color:black">DOSCODE:44FD                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:44FE                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">DOSCODE:4500                 </span><span style="color:navy">or      ax, bp
</span><span style="color:black">DOSCODE:4502                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:4503                 </span><span style="color:navy">jz      short </span><span style="color:gray">GETBP_err </span>; zero address, error
<span style="color:black">DOSCODE:4503 </span>GETBP           <span style="color:black">endp
DOSCODE:4503
DOSCODE:4505
DOSCODE:4505 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4505
DOSCODE:4505
DOSCODE:4505 </span>GOTDPB          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4505                 </span><span style="color:navy">mov     word ptr ds:</span>THISDPB<span style="color:navy">, bp
</span><span style="color:black">DOSCODE:4509                 </span><span style="color:navy">mov     word ptr ds:</span>THISDPB<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:450D                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:450D </span>GOTDPB          <span style="color:black">endp
DOSCODE:450D
DOSCODE:450E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:450E </span><span style="color:gray">; START OF FUNCTION CHUNK FOR $IOCTL
</span><span style="color:black">DOSCODE:450E
DOSCODE:450E </span>SYS_RET_OK<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:450E                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:black">DOSCODE:4511                 </span><span style="color:navy">and     word ptr [si+</span><span style="color:#ff8000">16h</span><span style="color:navy">], </span><span style="color:green">0FFFEh </span>; [SI+user_env.user_F],~f_Carry
<span style="color:black">DOSCODE:4515
DOSCODE:4515 </span><span style="color:gray">DO_RET</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4515                 </span><span style="color:navy">mov     [si], ax
</span><span style="color:black">DOSCODE:4517                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4518 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4518
DOSCODE:4518 </span>SYS_RET_ERR<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4518                 </span><span style="color:navy">xor     ah, ah          </span>; hack to allow for smaller error rets
<span style="color:black">DOSCODE:451A                 </span><span style="color:navy">call    </span>ETAB_LK         ; Make sure code is OK, EXTERR gets set
<span style="color:black">DOSCODE:451D                 </span><span style="color:navy">call    </span>ErrorMap
<span style="color:black">DOSCODE:4520
DOSCODE:4520 </span>From_GetSet<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4520                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:black">DOSCODE:4523                 </span><span style="color:navy">or      word ptr [si+</span><span style="color:#ff8000">16h</span><span style="color:navy">], </span><span style="color:green">1 </span>; [SI+user_env.user_F],f_Carry
<span style="color:black">DOSCODE:4527                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:4528                 </span><span style="color:navy">jmp     short </span><span style="color:gray">DO_RET
</span><span style="color:black">DOSCODE:4528 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR $IOCTL
</span><span style="color:maroon">DOSCODE:452A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:452A
DOSCODE:452A </span>NO_OP<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:452A                 </span><span style="color:navy">xor     al, al          </span>; obsolete system calls dispatch to here
<span style="color:maroon">DOSCODE:452C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:452D
DOSCODE:452D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:452D
DOSCODE:452D
DOSCODE:452D </span>FCB_RET_ERR     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:452D                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:452F                 </span><span style="color:navy">mov     ss:</span>EXTERR<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:4533                 </span><span style="color:navy">call    </span>ErrorMap
<span style="color:black">DOSCODE:4536                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh        </span>; -1
<span style="color:black">DOSCODE:4538                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4538 </span>FCB_RET_ERR     <span style="color:black">endp
DOSCODE:4538
DOSCODE:4539
DOSCODE:4539 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4539
DOSCODE:4539
DOSCODE:4539 </span>ErrorMap        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4539                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:453A                 </span><span style="color:navy">mov     si, offset </span>ERR_TABLE_21
<span style="color:black">DOSCODE:453D                 </span><span style="color:navy">cmp     ss:</span>FAILERR<span style="color:navy">, </span><span style="color:#ff8000">0   </span>; Check for SPECIAL case.
<span style="color:black">DOSCODE:4543                 </span><span style="color:navy">jz      short </span><span style="color:gray">EXTENDED_NORMAL </span>; All is OK.
<span style="color:black">DOSCODE:4545                 </span><span style="color:navy">mov     ss:</span>EXTERR<span style="color:navy">, </span><span style="color:green">53h  </span>; error_FAIL_I24 ; real reason
<span style="color:black">DOSCODE:454C
DOSCODE:454C </span><span style="color:gray">EXTENDED_NORMAL</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:454C                 </span><span style="color:navy">call    </span>CAL_LK          ; Set CLASS,ACTION,LOCUS for EXTERR
<span style="color:black">DOSCODE:454F                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:4550                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4550 </span>ErrorMap        <span style="color:black">endp
DOSCODE:4550
DOSCODE:4551
DOSCODE:4551 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4551
DOSCODE:4551
DOSCODE:4551 </span>CAL_LK          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4551                 </span><span style="color:navy">push    ds              </span>; Look up and set CLASS ACTION and LOCUS values
<span style="color:black">DOSCODE:4551                                         </span>;  for GetExtendedError
<span style="color:black">DOSCODE:4552                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:4553                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:4554                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg  ; DOSDATA segment
<span style="color:black">DOSCODE:4559                 </span><span style="color:navy">mov     bx, ds:</span>EXTERR   ; Get error in BL
<span style="color:black">DOSCODE:455D
DOSCODE:455D </span><span style="color:gray">TABLK1</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:455D                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:455E                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:4560                 </span><span style="color:navy">jz      short </span><span style="color:gray">GOT_VALS  </span>; End of table
<span style="color:black">DOSCODE:4562                 </span><span style="color:navy">cmp     al, bl
</span><span style="color:black">DOSCODE:4564                 </span><span style="color:navy">jz      short </span><span style="color:gray">GOT_VALS  </span>; Got entry
<span style="color:black">DOSCODE:4566                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">3           </span>; Next table entry
<span style="color:black">DOSCODE:4569                 </span><span style="color:navy">jmp     short </span><span style="color:gray">TABLK1
</span><span style="color:black">DOSCODE:456B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:456B
DOSCODE:456B </span><span style="color:gray">GOT_VALS</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:456B                 </span><span style="color:navy">lodsw
</span><span style="color:black">DOSCODE:456C                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:456F                 </span><span style="color:navy">jz      short </span><span style="color:gray">NO_SET_ACT
</span><span style="color:black">DOSCODE:4571                 </span><span style="color:navy">mov     ds:</span>EXTERR_ACTION<span style="color:navy">, ah </span>; Set ACTION
<span style="color:black">DOSCODE:4575
DOSCODE:4575 </span><span style="color:gray">NO_SET_ACT</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4575                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:4577                 </span><span style="color:navy">jz      short </span><span style="color:gray">NO_SET_CLS
</span><span style="color:black">DOSCODE:4579                 </span><span style="color:navy">mov     ds:</span>EXTERR_CLASS<span style="color:navy">, al </span>; Set CLASS
<span style="color:black">DOSCODE:457C
DOSCODE:457C </span><span style="color:gray">NO_SET_CLS</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:457C                 </span><span style="color:navy">lodsb                   </span>; Get LOCUS
<span style="color:black">DOSCODE:457D                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:457F                 </span><span style="color:navy">jz      short </span><span style="color:gray">NO_SET_LOC
</span><span style="color:black">DOSCODE:4581                 </span><span style="color:navy">mov     ds:</span>EXTERR_LOCUS<span style="color:navy">, al
</span><span style="color:black">DOSCODE:4584
DOSCODE:4584 </span><span style="color:gray">NO_SET_LOC</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4584                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:4585                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:4586                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4587                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4587 </span>CAL_LK          <span style="color:black">endp
DOSCODE:4587
DOSCODE:4588
DOSCODE:4588 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4588
DOSCODE:4588
DOSCODE:4588 </span>ETAB_LK         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4588                 </span><span style="color:navy">push    ds              </span>; check for appropriate error code
<span style="color:black">DOSCODE:4589                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:458A                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:458B                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:458C                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:458D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:458E                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:458E                 </span><span style="color:navy">mov     </span>EXTERR<span style="color:navy">, ax      </span>; Set EXTERR with &quot;real&quot; error
<span style="color:black">DOSCODE:4591                 </span><span style="color:navy">mov     si, offset </span>I21_MAP_E_TAB
<span style="color:black">DOSCODE:4594                 </span><span style="color:navy">mov     bh, al          </span>; Real code to BH
<span style="color:black">DOSCODE:4596                 </span><span style="color:navy">mov     bl, byte ptr </span>USER_IN_AX<span style="color:navy">+</span><span style="color:green">1 </span>; Sys call to BL
<span style="color:black">DOSCODE:459A
DOSCODE:459A </span><span style="color:gray">TABLK2</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:459A                 </span><span style="color:navy">lods    word ptr cs:[si]
</span><span style="color:black">DOSCODE:459C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0FFh        </span>; End of table?
<span style="color:black">DOSCODE:459E                 </span><span style="color:navy">jz      short </span><span style="color:gray">NOT_IN_TABLE
</span><span style="color:black">DOSCODE:45A0                 </span><span style="color:navy">cmp     al, bl          </span>; Found call?
<span style="color:black">DOSCODE:45A2                 </span><span style="color:navy">jz      short </span><span style="color:gray">GOT_CALL  </span>; Yes
<span style="color:black">DOSCODE:45A4                 </span><span style="color:navy">xchg    ah, al
</span><span style="color:black">DOSCODE:45A6                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:45A8                 </span><span style="color:navy">add     si, ax          </span>; Next table entry
<span style="color:black">DOSCODE:45AA                 </span><span style="color:navy">jmp     short </span><span style="color:gray">TABLK2
</span><span style="color:black">DOSCODE:45AC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:45AC
DOSCODE:45AC </span><span style="color:gray">NOT_IN_TABLE</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:45AC                 </span><span style="color:navy">mov     al, bh          </span>; Restore original code
<span style="color:black">DOSCODE:45AE                 </span><span style="color:navy">jmp     short </span><span style="color:gray">NO_MAP
</span><span style="color:black">DOSCODE:45B0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:45B0
DOSCODE:45B0 </span><span style="color:gray">GOT_CALL</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:45B0                 </span><span style="color:navy">mov     cl, ah
</span><span style="color:black">DOSCODE:45B2                 </span><span style="color:navy">xor     ch, ch          </span>; Count of valid err codes to CX
<span style="color:black">DOSCODE:45B4
DOSCODE:45B4 </span><span style="color:gray">CHECK_CODE</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:45B4                 </span><span style="color:navy">lods    byte ptr cs:[si]
</span><span style="color:black">DOSCODE:45B6                 </span><span style="color:navy">cmp     al, bh          </span>; Code OK?
<span style="color:black">DOSCODE:45B8                 </span><span style="color:navy">jz      short </span><span style="color:gray">NO_MAP    </span>; Yes
<span style="color:black">DOSCODE:45BA                 </span><span style="color:navy">loop    </span><span style="color:gray">CHECK_CODE
</span><span style="color:black">DOSCODE:45BC
DOSCODE:45BC </span><span style="color:gray">NO_MAP</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:45BC                 </span><span style="color:navy">xor     ah, ah          </span>; AX is now valid code
<span style="color:black">DOSCODE:45BE                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:45BF                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:45C0                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:45C1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:45C2                 </span>assume ds:nothing
<span style="color:black">DOSCODE:45C2                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:45C2 </span><span style="background:red">ETAB_LK         endp</span><span style="background:red"> ; sp-analysis failed</span>
<span style="color:black">DOSCODE:45C2
DOSCODE:45C3
DOSCODE:45C3 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:45C3
DOSCODE:45C3
DOSCODE:45C3 </span>SetBad          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:45C3                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1           </span>; error_invalid_function
<span style="color:black">DOSCODE:45C6                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:45C7                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:45CC                 </span><span style="color:navy">mov     ds:</span>EXTERR_LOCUS<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; errLOC_Unk
<span style="color:black">DOSCODE:45D1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:45D2                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:45D3                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:45D3 </span>SetBad          <span style="color:black">endp
DOSCODE:45D3
DOSCODE:45D4
DOSCODE:45D4 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:45D4
DOSCODE:45D4
DOSCODE:45D4 </span>BadCall         <span style="color:black">proc far                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:45D4                 </span><span style="color:navy">call    </span>SetBad
<span style="color:black">DOSCODE:45D7                 </span><span style="color:navy">retf
</span><span style="color:black">DOSCODE:45D7 </span>BadCall         <span style="color:black">endp
DOSCODE:45D7
DOSCODE:45D8
DOSCODE:45D8 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:45D8
DOSCODE:45D8
DOSCODE:45D8 </span>OKCall          <span style="color:black">proc far                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:45D8                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:45D9                 </span><span style="color:navy">retf
</span><span style="color:black">DOSCODE:45D9 </span>OKCall          <span style="color:black">endp
DOSCODE:45D9
</span><span style="color:maroon">DOSCODE:45DA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:45DA
DOSCODE:45DA </span>INT2F<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:45DA                 </span><span style="color:navy">sti
</span><span style="color:maroon">DOSCODE:45DB                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">11h         </span>; MultNET
<span style="color:maroon">DOSCODE:45DE                 </span><span style="color:navy">jnz     short </span>INT2FSHR
<span style="color:maroon">DOSCODE:45E0
DOSCODE:45E0 </span>TestInstall<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:45E0                 </span><span style="color:navy">or      al, al
</span><span style="color:maroon">DOSCODE:45E2                 </span><span style="color:navy">jz      short </span>Leave2F
<span style="color:maroon">DOSCODE:45E4
DOSCODE:45E4 </span>BadFunc<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:45E4                 </span><span style="color:navy">call    </span>SetBad
<span style="color:maroon">DOSCODE:45E7
DOSCODE:45E7 </span>Leave2F<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:45E7                 </span><span style="color:navy">retf    </span><span style="color:green">2
</span><span style="color:maroon">DOSCODE:45EA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:45EA
DOSCODE:45EA </span>INT2FSHR<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:45EA                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">10h         </span>; MultSHARE
<span style="color:maroon">DOSCODE:45ED                 </span><span style="color:navy">jz      short </span>TestInstall
<span style="color:maroon">DOSCODE:45EF                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">14h         </span>; NLSFUNC
<span style="color:maroon">DOSCODE:45F2                 </span><span style="color:navy">jz      short </span>TestInstall
<span style="color:maroon">DOSCODE:45F4                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">12h         </span>; MultDOS
<span style="color:maroon">DOSCODE:45F7                 </span><span style="color:navy">jnz     short </span>check_win
<span style="color:maroon">DOSCODE:45F9                 </span><span style="color:navy">jmp     </span>DispatchDOS
<span style="color:maroon">DOSCODE:45FC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:45FC
DOSCODE:45FC </span>check_win<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:45FC                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">16h         </span>; MultWin386
<span style="color:maroon">DOSCODE:45FF                 </span><span style="color:navy">jz      short </span>Win386_Msg
<span style="color:maroon">DOSCODE:4601                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">46h         </span>; WINOLDAP
<span style="color:maroon">DOSCODE:4604                 </span><span style="color:navy">jnz     short </span>next_i2f
<span style="color:maroon">DOSCODE:4606                 </span><span style="color:navy">jmp     </span>Winold_swap
<span style="color:maroon">DOSCODE:4609 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4609
DOSCODE:4609 </span>next_i2f<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4609                 </span><span style="color:navy">jmp     far ptr </span><span style="background:red"><span style="color:navy">70h:5</span></span>
<span style="color:maroon">DOSCODE:460E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:460E
DOSCODE:460E </span>Win386_Msg<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:460E                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:460F                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:maroon">DOSCODE:4614                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3           </span>; win386 2.xx instance data call?
<span style="color:maroon">DOSCODE:4616                 </span><span style="color:navy">jnz     short </span>Win386_Msg_exit
<span style="color:maroon">DOSCODE:4618                 </span><span style="color:navy">jmp     </span>OldWin386Init   ; yes, return instance data
<span style="color:maroon">DOSCODE:461B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:461B
DOSCODE:461B </span>Win386_Msg_exit<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:461B                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">6           </span>; Win386_Exit  ; is it an exit call?
<span style="color:maroon">DOSCODE:461D                 </span><span style="color:navy">jnz     short </span>Win386_Msg_devcall
<span style="color:maroon">DOSCODE:461F                 </span><span style="color:navy">jmp     </span>Win386_Leaving
<span style="color:maroon">DOSCODE:4622 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4622
DOSCODE:4622 </span>Win386_Msg_devcall<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4622                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">7           </span>; Win386_Devcall ; is it call from DOSMGR?
<span style="color:maroon">DOSCODE:4624                 </span><span style="color:navy">jnz     short </span>Win386_Msg_init
<span style="color:maroon">DOSCODE:4626                 </span><span style="color:navy">jmp     </span>Win386_Query
<span style="color:maroon">DOSCODE:4629 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4629
DOSCODE:4629 </span>Win386_Msg_init<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4629                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5           </span>; Win386_Init ; is it an init call?
<span style="color:maroon">DOSCODE:462B                 </span><span style="color:navy">jz      short </span>Win386_Starting
<span style="color:maroon">DOSCODE:462D                 </span><span style="color:navy">jmp     </span>win_nexti2f
<span style="color:maroon">DOSCODE:4630 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4630
DOSCODE:4630 </span>Win386_Starting<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4630                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:4631                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:4632                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:4633                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:4634                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:4635                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:4636                 </span><span style="color:navy">mov     di, offset </span>INBUF
<span style="color:maroon">DOSCODE:4639                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">5
</span><span style="color:maroon">DOSCODE:463C                 </span><span style="color:navy">cld
</span><span style="color:maroon">DOSCODE:463D
DOSCODE:463D </span>Win386_s_floop<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:463D                 </span><span style="color:navy">mov     ax, &#039;</span><span style="color:green">OC&#039;        </span>; 4F43h (&#039;CO&#039; in NASM syntax)
<span style="color:maroon">DOSCODE:4640                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:4641                 </span><span style="color:navy">mov     ax, &#039; </span><span style="color:green">N&#039;        </span>; 204Eh (&#039;N &#039; in NASM syntax)
<span style="color:maroon">DOSCODE:4644                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:4645                 </span><span style="color:navy">add     di, </span><span style="color:green">55
</span><span style="color:maroon">DOSCODE:4648                 </span><span style="color:navy">loop    </span>Win386_s_floop
<span style="color:maroon">DOSCODE:464A                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:464B                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:464C                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:464D                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:464E                 </span><span style="color:navy">test    dx, </span><span style="color:green">1           </span>; is this really win386?
<span style="color:maroon">DOSCODE:4652                 </span><span style="color:navy">jz      short </span>Win386_vchk ; yes
<span style="color:maroon">DOSCODE:4654                 </span><span style="color:navy">jmp     </span>win_nexti2f     ; win 286 dos extender
<span style="color:maroon">DOSCODE:4657 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4657
DOSCODE:4657 </span>Win386_vchk<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4657                 </span><span style="color:navy">mov     word ptr ds:</span>Win386_Inf_Virt_Dev_Ptr<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:465D                 </span><span style="color:navy">mov     word ptr ds:</span>Win386_Inf_Virt_Dev_Ptr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:4663                 </span><span style="color:navy">cmp     di, </span><span style="color:#ff8000">400h        </span>; version &gt;= 400
<span style="color:maroon">DOSCODE:4667                 </span><span style="color:navy">jnb     short </span>jmp_to_noVxD31
<span style="color:maroon">DOSCODE:4669
DOSCODE:4669 </span>Win386_vxd<span style="color:navy">:
</span><span style="color:maroon">DOSCODE:4669                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:466A                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:466B                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:466C                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:466D                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:466E                 </span><span style="color:navy">mov     bx, ds:</span>UMB_HEAD
<span style="color:maroon">DOSCODE:4672                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:4673                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:4676                 </span><span style="color:navy">jz      short </span>Vxd31
<span style="color:maroon">DOSCODE:4678                 </span><span style="color:navy">mov     ds:</span>UmbSaveFlag<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:467D                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:467E                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:467F                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:4680                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:4681                 </span><span style="color:navy">mov     ds, bx
</span><span style="color:maroon">DOSCODE:4683                 </span><span style="color:navy">xor     si, si
</span><span style="color:maroon">DOSCODE:4685                 </span><span style="color:navy">clc                     </span>; not necessary (XOR already clears CF)
<span style="color:maroon">DOSCODE:4686
DOSCODE:4686 </span>restore_ubmhead<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4686                 </span><span style="color:navy">cld                     </span>; !! PCDOS 7.1 bug !!
<span style="color:maroon">DOSCODE:4686                                         </span>; jump from &#039;Win386_Leaving&#039; here was/is wrong
<span style="color:maroon">DOSCODE:4686                                         </span>; (DI and SI would be reversed for &#039;Win386_Leaving&#039;)
<span style="color:maroon">DOSCODE:4686                                         </span>; Erdogan Tan - 05/01/2024
<span style="color:maroon">DOSCODE:4687                 </span><span style="color:navy">mov     di, offset </span>UmbSave1
<span style="color:maroon">DOSCODE:468A                 </span><span style="color:navy">mov     cx, </span><span style="color:green">11
</span><span style="color:maroon">DOSCODE:468D                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">DOSCODE:468F                 </span><span style="color:navy">mov     di, offset </span>UmbSave2
<span style="color:maroon">DOSCODE:4692                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">5
</span><span style="color:maroon">DOSCODE:4694                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">DOSCODE:4696                 </span><span style="color:navy">jnb     short </span>restore_ubmhead_c ; (not jumped from &#039;Win386_Leaving&#039;)
<span style="color:maroon">DOSCODE:4698                 </span><span style="color:navy">jmp     </span>restore_ubmhead_ok ; (jumped from &#039;Win386_Leaving&#039; just after &#039;stc&#039;)
<span style="color:maroon">DOSCODE:469B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:469B
DOSCODE:469B </span>restore_ubmhead_c<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:469B                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:469C                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:469D
DOSCODE:469D </span>Vxd31<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:469D                 </span><span style="color:navy">test    ds:</span>DOS_FLAG<span style="color:navy">, </span><span style="color:green">2  </span>; SUPPRESS_WINA20
<span style="color:maroon">DOSCODE:46A2                 </span><span style="color:navy">jz      short </span>Dont_Supress
<span style="color:maroon">DOSCODE:46A4                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:46A5                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:46A6                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:46A7                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:46A8                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:46A9                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:46AA
DOSCODE:46AA </span>jmp_to_noVxD31<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:46AA                 </span><span style="color:navy">jmp     short </span>noVxD31
<span style="color:maroon">DOSCODE:46AC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:46AC
DOSCODE:46AC </span>Dont_Supress<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:46AC                 </span><span style="color:navy">mov     al, ds:</span>BOOTDRIVE
<span style="color:maroon">DOSCODE:46AF                 </span><span style="color:navy">add     al, </span><span style="color:#ff8000">40h </span><span style="color:gray">; &#039;@&#039;   </span>; &#039;A&#039;-1
<span style="color:maroon">DOSCODE:46B1                 </span><span style="color:navy">mov     byte ptr ds:</span>VxDpath<span style="color:navy">, al </span><span style="color:gray">; &quot;c:\\wina20.386&quot;
</span><span style="color:maroon">DOSCODE:46B4                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">6C00h       </span>; ExtOpen&lt;&lt;8
<span style="color:maroon">DOSCODE:46B7                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">2080h       </span>; read access, compatibility mode
<span style="color:maroon">DOSCODE:46B7                                         </span>; no inherit, suppress crit err
<span style="color:maroon">DOSCODE:46BA                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">7           </span>; hidden,system,read-only attr
<span style="color:maroon">DOSCODE:46BD                 </span><span style="color:navy">cwd
</span><span style="color:maroon">DOSCODE:46BE                 </span><span style="color:navy">inc     dx              </span>; dx bit 0 = 1 ; fail if file does not exist
<span style="color:maroon">DOSCODE:46BF                 </span><span style="color:navy">mov     si, offset </span>VxDpath <span style="color:gray">; &quot;c:\\wina20.386&quot;
</span><span style="color:maroon">DOSCODE:46C2                 </span><span style="color:navy">mov     di, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:46C5                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 4.0 - EXTENDED OPEN/CREATE
<span style="color:maroon">DOSCODE:46C5                                         </span>; BL = open mode as in AL for normal open (INT 21h/AH=3Dh)
<span style="color:maroon">DOSCODE:46C5                                         </span>; BH = flags, CX = create attribute, DL = action if file exists/does not exists
<span style="color:maroon">DOSCODE:46C5                                         </span>; DH = 00h (reserved), DS:SI -&gt; ASCIZ file name
<span style="color:maroon">DOSCODE:46C7                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:46C8                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:46C9                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:46CA                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:46CB                 </span><span style="color:navy">jnb     short </span>VxDthere  ; we found the VxD, go ahead
<span style="color:maroon">DOSCODE:46CD                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:46CE                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:46CF                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:46D0                 </span><span style="color:navy">mov     si, offset </span>NoVxDErrMsg <span style="color:gray">; &quot;You must have the file WINA20.386 in th&quot;...
</span><span style="color:maroon">DOSCODE:46D3                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">DOSCODE:46D4                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:46D5                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:46D5                 </span><span style="color:navy">mov     cx, </span><span style="color:green">99          </span>; VxDMesLen
<span style="color:maroon">DOSCODE:46D8                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2           </span>; write char to console
<span style="color:maroon">DOSCODE:46DA                 </span><span style="color:navy">cld
</span><span style="color:maroon">DOSCODE:46DB
DOSCODE:46DB </span>vxdlp<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:46DB                 </span><span style="color:navy">lodsb
</span><span style="color:maroon">DOSCODE:46DC                 </span><span style="color:navy">xchg    dl, al
</span><span style="color:maroon">DOSCODE:46DE                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - DISPLAY OUTPUT
<span style="color:maroon">DOSCODE:46DE                                         </span>; DL = character to send to standard output
<span style="color:maroon">DOSCODE:46E0                 </span><span style="color:navy">loop    </span>vxdlp
<span style="color:maroon">DOSCODE:46E2                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:46E3                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:46E4                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:46E4                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:46E5                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:46E6                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:46E7                 </span><span style="color:navy">inc     cx
</span><span style="color:maroon">DOSCODE:46E8                 </span><span style="color:navy">jmp     short </span>jmp_to_win_nexti2f
<span style="color:maroon">DOSCODE:46EA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:46EA
DOSCODE:46EA </span>VxDthere<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:46EA                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:maroon">DOSCODE:46EC                 </span><span style="color:navy">mov     ah, </span><span style="color:green">3Eh
</span><span style="color:maroon">DOSCODE:46EE                 </span><span style="color:navy">int     </span><span style="color:green">21h             </span>; DOS - 2+ - CLOSE A FILE WITH HANDLE
<span style="color:maroon">DOSCODE:46EE                                         </span>; BX = file handle
<span style="color:maroon">DOSCODE:46F0                 </span><span style="color:navy">mov     bx, offset </span>Win386_Info
<span style="color:maroon">DOSCODE:46F3                 </span><span style="color:navy">mov     word ptr [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">], offset </span>VxDpath <span style="color:gray">; &quot;c:\\wina20.386&quot;
</span><span style="color:maroon">DOSCODE:46F8                 </span><span style="color:navy">mov     word ptr [bx+</span><span style="color:#ff8000">8</span><span style="color:navy">], ds
</span><span style="color:maroon">DOSCODE:46FB                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:46FC                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:46FD
DOSCODE:46FD </span>noVxD31<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:46FD                 </span><span style="color:navy">or      ds:</span>IsWin386<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:4702                 </span><span style="color:navy">or      ds:</span>redir_patch<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:4707                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:4708                 </span><span style="color:navy">mov     dx, bx
</span><span style="color:maroon">DOSCODE:470A                 </span><span style="color:navy">mov     bx, offset </span>Win386_Info
<span style="color:maroon">DOSCODE:470D                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">2</span><span style="color:navy">], dx
</span><span style="color:maroon">DOSCODE:4710                 </span><span style="color:navy">mov     word ptr [bx+</span><span style="color:#ff8000">4</span><span style="color:navy">], es
</span><span style="color:maroon">DOSCODE:4713                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:4714                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:4715                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:4716
DOSCODE:4716 </span>jmp_to_win_nexti2f<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4716                 </span><span style="color:navy">jmp     </span>win_nexti2f
<span style="color:maroon">DOSCODE:4719 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4719
DOSCODE:4719 </span>Win386_Leaving<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4719                 </span><span style="color:navy">test    dx, </span><span style="color:green">1           </span>; is this really win386?
<span style="color:maroon">DOSCODE:471D                 </span><span style="color:navy">jnz     short </span>jmp_to_win_nexti2f ; NO! It&#039;s win 286 dos extender!
<span style="color:maroon">DOSCODE:471F
DOSCODE:471F </span>Win386_Leaving_c<span style="color:navy">:                       </span>; was umb_arena saved at win start up ?
<span style="color:maroon">DOSCODE:471F                 </span><span style="color:navy">cmp     ds:</span>UmbSaveFlag<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:4724                 </span><span style="color:navy">jnz     short </span>noumb     ; not saved
<span style="color:maroon">DOSCODE:4726                 </span><span style="color:navy">mov     ds:</span>UmbSaveFlag<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; clear UmbSaveFlag
<span style="color:maroon">DOSCODE:4726                                         </span>; and restore previously saved umb_head
<span style="color:maroon">DOSCODE:472B                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:472C                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:472D                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:472E                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:472F                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:4730                 </span><span style="color:navy">mov     es, ds:</span>UMB_HEAD
<span style="color:maroon">DOSCODE:4734                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:4734                 </span><span style="color:navy">xor     di, di
</span><span style="color:maroon">DOSCODE:4736                 </span><span style="color:navy">stc                     </span>; CF=1 is a sign to jump &#039;restore_ubmhead_ok&#039; address
<span style="color:maroon">DOSCODE:4736                                         </span>; from -the common code at- &#039;restore_ubmhead&#039; address
<span style="color:maroon">DOSCODE:4736                                         </span>; (.. but this is a BUG!)
<span style="color:maroon">DOSCODE:4736                                         </span>; ;
<span style="color:maroon">DOSCODE:4737                 </span><span style="color:navy">jmp     </span>restore_ubmhead ; !! PCDOS 7.1 bug !!
<span style="color:maroon">DOSCODE:4737                                         </span>; (jumped code does not restore umbhead,
<span style="color:maroon">DOSCODE:4737                                         </span>; MSDOS 6.22 code was correct, modification is wrong)
<span style="color:maroon">DOSCODE:4737                                         </span>; Erdogan Tan - 05/01/2024
<span style="color:maroon">DOSCODE:4737                                         </span>;
<span style="color:maroon">DOSCODE:4737                                         </span>; Correct code here, would be:
<span style="color:maroon">DOSCODE:4737                                         </span>;    cld
<span style="color:maroon">DOSCODE:4737                                         </span>;    mov  si,UmbSave1
<span style="color:maroon">DOSCODE:4737                                         </span>;    mov  cx,11
<span style="color:maroon">DOSCODE:4737                                         </span>;    rep  movsb
<span style="color:maroon">DOSCODE:4737                                         </span>;    mov  si,UmbSave2
<span style="color:maroon">DOSCODE:4737                                         </span>;    mov  cl,5
<span style="color:maroon">DOSCODE:4737                                         </span>;    rep  movsb
<span style="color:maroon">DOSCODE:473A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:473A
DOSCODE:473A </span>restore_ubmhead_ok<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:473A                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:473B                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:473C                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:473D                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:473E                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:473E                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:473F
DOSCODE:473F </span>noumb<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:473F                 </span><span style="color:navy">and     ds:</span>IsWin386<span style="color:navy">, </span><span style="color:green">0FEh
</span><span style="color:maroon">DOSCODE:4744                 </span><span style="color:navy">and     ds:</span>redir_patch<span style="color:navy">, </span><span style="color:green">0
</span><span style="color:maroon">DOSCODE:4749                 </span><span style="color:navy">jmp     short </span>win_nexti2f
<span style="color:maroon">DOSCODE:474B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:474B
DOSCODE:474B </span>Win386_Query<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:474B                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">15h         </span>; Win386_DOSMGR ; is this from DOSMGR?
<span style="color:maroon">DOSCODE:474E                 </span><span style="color:navy">jnz     short </span>win_nexti2f ; no, ignore it &amp; chain to next
<span style="color:maroon">DOSCODE:4750                 </span><span style="color:navy">or      cx, cx          </span>; is it an instance query?
<span style="color:maroon">DOSCODE:4752                 </span><span style="color:navy">jnz     short </span>dosmgr_func ; no, some DOSMGR query
<span style="color:maroon">DOSCODE:4754                 </span><span style="color:navy">inc     cx              </span>; indicate that data is instanced
<span style="color:maroon">DOSCODE:4755                 </span><span style="color:navy">mov     bx, offset </span>Win386_DOSVars
<span style="color:maroon">DOSCODE:4758                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:4759                 </span><span style="color:navy">pop     es              </span>; es:bx points at offset table
<span style="color:maroon">DOSCODE:475A                 </span><span style="color:navy">jmp     short </span>PopIret
<span style="color:maroon">DOSCODE:475C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:475C
DOSCODE:475C </span>OldWin386Init<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:475C                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:475D                 </span><span style="color:navy">mov     si, offset </span>OldInstanceJunk ; ds:si = instance table
<span style="color:maroon">DOSCODE:4760                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5248h       </span>; &#039;HR&#039; ; indicate instance data present
<span style="color:maroon">DOSCODE:4763                 </span><span style="color:navy">jmp     short </span>win_nexti2f2
<span style="color:maroon">DOSCODE:4765 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4765
DOSCODE:4765 </span>dosmgr_func<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4765                 </span><span style="color:navy">dec     cx
</span><span style="color:maroon">DOSCODE:4766                 </span><span style="color:navy">jz      short </span>win386_patch ; call to patch DOS
<span style="color:maroon">DOSCODE:4768                 </span><span style="color:navy">dec     cx
</span><span style="color:maroon">DOSCODE:4769                 </span><span style="color:navy">jz      short </span>PopIret   ; remove DOS patches, ignore
<span style="color:maroon">DOSCODE:476B                 </span><span style="color:navy">dec     cx
</span><span style="color:maroon">DOSCODE:476C                 </span><span style="color:navy">jz      short </span>win386_size ; get size of DOS data structures
<span style="color:maroon">DOSCODE:476E                 </span><span style="color:navy">dec     cx
</span><span style="color:maroon">DOSCODE:476F                 </span><span style="color:navy">jz      short </span>jmp_to_win386_inst ; instance more data
<span style="color:maroon">DOSCODE:4771                 </span><span style="color:navy">loop    </span>PopIret         ; no functions above this
<span style="color:maroon">DOSCODE:4773                 </span><span style="color:navy">mov     ax, es          </span>; Get DOS device driver size
<span style="color:maroon">DOSCODE:4773                                         </span>; ax = device header segment
<span style="color:maroon">DOSCODE:4775                 </span><span style="color:navy">dec     ax              </span>; get arena header
<span style="color:maroon">DOSCODE:4776                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:4777                 </span><span style="color:navy">mov     es, ax          </span>; arena header for device driver
<span style="color:maroon">DOSCODE:4779                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:4779                 </span><span style="color:navy">cmp     byte ptr es:[di], </span><span style="color:#ff8000">44h </span><span style="color:gray">; &#039;D&#039; </span>; is it a device arena?
<span style="color:maroon">DOSCODE:477D                 </span><span style="color:navy">jnz     short </span>cantsize  ; no
<span style="color:maroon">DOSCODE:477F                 </span><span style="color:navy">inc     ax              </span>; get back device header segment
<span style="color:maroon">DOSCODE:4780                 </span><span style="color:navy">cmp     es:[di+</span><span style="color:#ff8000">1</span><span style="color:navy">], ax   </span>; owner field pointing at driver?
<span style="color:maroon">DOSCODE:4784                 </span><span style="color:navy">jnz     short </span>cantsize  ; no
<span style="color:maroon">DOSCODE:4786                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">3</span><span style="color:navy">]   </span>; get arena size in paragraphs
<span style="color:maroon">DOSCODE:478A                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:478B                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:478B                 </span><span style="color:navy">mov     bx, </span><span style="color:green">16
</span><span style="color:maroon">DOSCODE:478E                 </span><span style="color:navy">mul     bx
</span><span style="color:maroon">DOSCODE:4790                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:maroon">DOSCODE:4792                 </span><span style="color:navy">mov     bx, dx
</span><span style="color:maroon">DOSCODE:4794                 </span><span style="color:navy">jmp     short </span>win386_done ; return with device driver size
<span style="color:maroon">DOSCODE:4796 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4796
DOSCODE:4796 </span>cantsize<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4796                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:4797                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">DOSCODE:4799
DOSCODE:4799 </span>win386_inst<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4799                 </span><span style="color:navy">xor     dx, dx          </span>; ask DOSMGR to use its methods
<span style="color:maroon">DOSCODE:479B                 </span><span style="color:navy">jmp     short </span>PopIret
<span style="color:maroon">DOSCODE:479D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:479D
DOSCODE:479D </span>win386_patch<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:479D                 </span><span style="color:navy">mov     bx, dx          </span>; move patch bitfield to bx
<span style="color:maroon">DOSCODE:479F                 </span><span style="color:navy">jmp     short </span>win386_done ; done, return
<span style="color:maroon">DOSCODE:47A1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:47A1
DOSCODE:47A1 </span>win386_size<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:47A1                 </span><span style="color:navy">test    dl, </span><span style="color:green">1           </span>; check for CDS size bit
<span style="color:maroon">DOSCODE:47A4                 </span><span style="color:navy">jz      short </span>PopIret   ; no, unknown structure -- return
<span style="color:maroon">DOSCODE:47A6                 </span><span style="color:navy">mov     cl, </span><span style="color:green">88          </span>; cx = CDS size
<span style="color:maroon">DOSCODE:47A8                 </span><span style="color:navy">jmp     short </span>win386_done ; return with the size
<span style="color:maroon">DOSCODE:47AA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:47AA
DOSCODE:47AA </span>jmp_to_win386_inst<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:47AA                 </span><span style="color:navy">jmp     short </span>win386_inst
<span style="color:maroon">DOSCODE:47AC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:47AC
DOSCODE:47AC </span>win386_done<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:47AC                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0B97Ch      </span>; WIN_OP_DONE
<span style="color:maroon">DOSCODE:47AF                 </span><span style="color:navy">mov     dx, </span><span style="color:green">0A2ABh      </span>; DOSMGR_OP_DONE
<span style="color:maroon">DOSCODE:47B2
DOSCODE:47B2 </span>PopIret<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:47B2                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:47B3                 </span><span style="color:navy">iret
</span><span style="color:maroon">DOSCODE:47B4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:47B4
DOSCODE:47B4 </span>win_nexti2f<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:47B4                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:47B5
DOSCODE:47B5 </span>win_nexti2f2<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:47B5                 </span><span style="color:navy">jmp     </span>next_i2f
<span style="color:black">DOSCODE:47B8
DOSCODE:47B8 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:47B8
DOSCODE:47B8
DOSCODE:47B8 </span>getwinlast      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:47B8                 </span><span style="color:navy">mov     si, ds:</span>CurrentPDB
<span style="color:black">DOSCODE:47BC                 </span><span style="color:navy">dec     si
</span><span style="color:black">DOSCODE:47BD                 </span><span style="color:navy">mov     es, si
</span><span style="color:black">DOSCODE:47BF                 </span><span style="color:navy">add     si, es:</span><span style="color:green">3
</span><span style="color:black">DOSCODE:47C4                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:47C4 </span>getwinlast      <span style="color:black">endp
DOSCODE:47C4
</span><span style="color:maroon">DOSCODE:47C5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:47C5
DOSCODE:47C5 </span>Winold_swap<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:47C5                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:47C6                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:47C7                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:47C8                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:47C9                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:47CA                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:maroon">DOSCODE:47CF                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1           </span>; swap Windows out call
<span style="color:maroon">DOSCODE:47D1                 </span><span style="color:navy">jnz     short </span>swapin    ; no, check if Swap in call
<span style="color:maroon">DOSCODE:47D3                 </span><span style="color:navy">call    </span>getwinlast
<span style="color:maroon">DOSCODE:47D6                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:47D7                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:47D8                 </span><span style="color:navy">mov     ds, si          </span>; ds = memory arena of Windows
<span style="color:maroon">DOSCODE:47DA                 </span><span style="color:navy">xor     si, si
</span><span style="color:maroon">DOSCODE:47DC                 </span><span style="color:navy">mov     di, offset </span>WinoldPatch1
<span style="color:maroon">DOSCODE:47DF                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">8
</span><span style="color:maroon">DOSCODE:47E2                 </span><span style="color:navy">cld
</span><span style="color:maroon">DOSCODE:47E3                 </span><span style="color:navy">rep movsb               </span>; save first 8 bytes
<span style="color:maroon">DOSCODE:47E5                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">8
</span><span style="color:maroon">DOSCODE:47E7                 </span><span style="color:navy">mov     di, offset </span>WinoldPatch2
<span style="color:maroon">DOSCODE:47EA                 </span><span style="color:navy">rep movsb               </span>; save next 8 bytes
<span style="color:maroon">DOSCODE:47EC                 </span><span style="color:navy">jmp     short </span>winold_done
<span style="color:maroon">DOSCODE:47EE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:47EE
DOSCODE:47EE </span>swapin<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:47EE                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2           </span>; swap Windows in call?
<span style="color:maroon">DOSCODE:47F0                 </span><span style="color:navy">jnz     short </span>winold_done ; no, something else, pass it on
<span style="color:maroon">DOSCODE:47F2                 </span><span style="color:navy">call    </span>getwinlast
<span style="color:maroon">DOSCODE:47F5                 </span><span style="color:navy">mov     es, si
</span><span style="color:maroon">DOSCODE:47F7                 </span><span style="color:navy">xor     di, di
</span><span style="color:maroon">DOSCODE:47F9                 </span><span style="color:navy">mov     si, offset </span>WinoldPatch1
<span style="color:maroon">DOSCODE:47FC                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">8
</span><span style="color:maroon">DOSCODE:47FF                 </span><span style="color:navy">cld
</span><span style="color:maroon">DOSCODE:4800                 </span><span style="color:navy">rep movsb               </span>; restore first 8 bytes
<span style="color:maroon">DOSCODE:4802                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">8
</span><span style="color:maroon">DOSCODE:4804                 </span><span style="color:navy">mov     si, offset </span>WinoldPatch2
<span style="color:maroon">DOSCODE:4807                 </span><span style="color:navy">rep movsb               </span>; restore next 8 bytes
<span style="color:maroon">DOSCODE:4809
DOSCODE:4809 </span>winold_done<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4809                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:480A                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:480B                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:480C                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:480D                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:480E                 </span><span style="color:navy">jmp     </span>next_i2f        ; chain on
<span style="color:maroon">DOSCODE:4811 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4811
DOSCODE:4811 </span>int_2Fh_1231h<span style="color:navy">:                          </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:4811                 </span><span style="color:navy">push    ds              </span>; Windows95 - SET/CLEAR &quot;REPORT WINDOWS TO DOS PROGRAMS&quot; FLAG
<span style="color:maroon">DOSCODE:4812                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:maroon">DOSCODE:4817                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">DOSCODE:4819                 </span><span style="color:navy">or      dl, dl
</span><span style="color:maroon">DOSCODE:481B                 </span><span style="color:navy">jnz     short </span>not_1231_dl_0
<span style="color:maroon">DOSCODE:481D                 </span><span style="color:navy">mov     ds:</span>IsWin386<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">1 </span>; set byte after &quot;IsWIN386&quot; to 01h
<span style="color:maroon">DOSCODE:4822                 </span><span style="color:navy">jmp     short </span>int_2f_1231h_retn
<span style="color:maroon">DOSCODE:4824 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4824                 </span><span style="color:navy">nop
</span><span style="color:maroon">DOSCODE:4825
DOSCODE:4825 </span>not_1231_dl_0<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4825                 </span><span style="color:navy">cmp     dl, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:4828                 </span><span style="color:navy">jnz     short </span>not_1231_dl_1 ; clear &quot;IsWIN386&quot; bit 1
<span style="color:maroon">DOSCODE:482A                 </span><span style="color:navy">or      ds:</span>IsWin386<span style="color:navy">, </span><span style="color:green">2  </span>; set &quot;IsWIN386&quot; bit 1
<span style="color:maroon">DOSCODE:482F                 </span><span style="color:navy">jmp     short </span>int_2f_1231h_retn
<span style="color:maroon">DOSCODE:4831 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4831                 </span><span style="color:navy">nop
</span><span style="color:maroon">DOSCODE:4832
DOSCODE:4832 </span>not_1231_dl_1<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4832                 </span><span style="color:navy">cmp     dl, </span><span style="color:#ff8000">2
</span><span style="color:maroon">DOSCODE:4835                 </span><span style="color:navy">jnz     short </span>not_1231_dl_2
<span style="color:maroon">DOSCODE:4837                 </span><span style="color:navy">and     ds:</span>IsWin386<span style="color:navy">, </span><span style="color:green">0FDh </span>; clear bit 1
<span style="color:maroon">DOSCODE:483C                 </span><span style="color:navy">jmp     short </span>int_2f_1231h_retn
<span style="color:maroon">DOSCODE:483E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:483E
DOSCODE:483E </span>not_1231_dl_2<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:483E                 </span><span style="color:navy">inc     ax              </span>; return error, ax = 1
<span style="color:maroon">DOSCODE:483F                 </span><span style="color:navy">stc
</span><span style="color:maroon">DOSCODE:4840
DOSCODE:4840 </span>int_2f_1231h_retn<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4840                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:4841                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:4842 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4842
DOSCODE:4842 </span>DispatchDOS<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4842                 </span><span style="color:navy">push    cs:</span>FOO          ; push return address
<span style="color:maroon">DOSCODE:4847                 </span><span style="color:navy">push    cs:</span>DTab         ; push table address
<span style="color:maroon">DOSCODE:484C                 </span><span style="color:navy">push    ax              </span>; push index
<span style="color:maroon">DOSCODE:484D                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">DOSCODE:484E                 </span><span style="color:navy">mov     bp, sp          </span>; stack looks like:
<span style="color:maroon">DOSCODE:484E                                         </span>;  0  BP
<span style="color:maroon">DOSCODE:484E                                         </span>;  2  DISPATCH
<span style="color:maroon">DOSCODE:484E                                         </span>;  4  TABLE
<span style="color:maroon">DOSCODE:484E                                         </span>;  6  RETURN
<span style="color:maroon">DOSCODE:484E                                         </span>;  8  LONG-RETURN
<span style="color:maroon">DOSCODE:484E                                         </span>;  C  FLAGS
<span style="color:maroon">DOSCODE:484E                                         </span>;  E  AX
<span style="color:maroon">DOSCODE:4850                 </span><span style="color:navy">mov     ax, [bp+</span><span style="color:green">14</span><span style="color:navy">]     </span>; get AX value
<span style="color:maroon">DOSCODE:4853                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSCODE:4854                 </span><span style="color:navy">call    </span>TableDispatch
<span style="color:maroon">DOSCODE:4857                 </span><span style="color:navy">jmp     </span>BadFunc         ; return indicates invalid function
<span style="color:maroon">DOSCODE:485A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:485A
DOSCODE:485A </span>DOSGetGroup<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:485A                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:maroon">DOSCODE:485F                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:4860 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4860
DOSCODE:4860 </span>DOSInstall<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:4860                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:4862                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4863
DOSCODE:4863 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4863
DOSCODE:4863
DOSCODE:4863 </span>RW32_CONVERT    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4863                 </span><span style="color:navy">inc     cx              </span>; -1 -&gt; 0
<span style="color:black">DOSCODE:4864                 </span><span style="color:navy">jz      short </span><span style="color:gray">new32format
</span><span style="color:black">DOSCODE:4866                 </span><span style="color:navy">dec     cx
</span><span style="color:black">DOSCODE:4867                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:bp+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:486C                 </span><span style="color:navy">jz      short </span><span style="color:gray">rw32_conv_err </span>; FAT32 fs
<span style="color:black">DOSCODE:486E                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:486F                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:4870                 </span><span style="color:navy">mov     dl, es:[bp+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:bp+DPB.CLUSTER_MASK]
<span style="color:black">DOSCODE:4874                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">] </span>; [es:bp+DPB.MAX_CLUSTER]
<span style="color:black">DOSCODE:4878                 </span><span style="color:navy">cmp     dl, </span><span style="color:#ff8000">0FEh        </span>; 254 ; Sectors/cluster - 1
<span style="color:black">DOSCODE:487B                 </span><span style="color:navy">jz      short </span><span style="color:gray">letold    </span>; removable
<span style="color:black">DOSCODE:487D                 </span><span style="color:navy">inc     dl
</span><span style="color:black">DOSCODE:487F                 </span><span style="color:navy">xor     dh, dh
</span><span style="color:black">DOSCODE:4881                 </span><span style="color:navy">mul     dx
</span><span style="color:black">DOSCODE:4883                 </span><span style="color:navy">or      dx, dx          </span>; &gt; 32mb ?
<span style="color:black">DOSCODE:4885
DOSCODE:4885 </span><span style="color:gray">letold</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4885                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:4886                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:4887                 </span><span style="color:navy">jz      short </span><span style="color:gray">old_style </span>; no
<span style="color:black">DOSCODE:4889
DOSCODE:4889 </span><span style="color:gray">rw32_conv_err</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4889                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:488A                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:488B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:488B
DOSCODE:488B </span><span style="color:gray">new32format</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:488B                 </span><span style="color:navy">mov     dx, [bx+</span><span style="color:#ff8000">2</span><span style="color:navy">]      </span>; [BX+ABS_32RW.SECTOR_RBA+2]
<span style="color:black">DOSCODE:488E                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:488F                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg  ; set up ds to DOSDATA
<span style="color:black">DOSCODE:4894                 </span><span style="color:navy">mov     ds:</span>HIGH_SECTOR<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:4898                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4899                 </span><span style="color:navy">mov     dx, [bx]        </span>; [BX+ABS_32RW.SECTOR_RBA]
<span style="color:black">DOSCODE:489B                 </span><span style="color:navy">mov     cx, [bx+</span><span style="color:#ff8000">4</span><span style="color:navy">]      </span>; [BX+ABS_32RW.ABS_RW_COUNT]
<span style="color:black">DOSCODE:489E                 </span><span style="color:navy">lds     bx, [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [BX+ABS_32RW.BUFFER_ADDR]
<span style="color:black">DOSCODE:48A1
DOSCODE:48A1 </span><span style="color:gray">old_style</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:48A1                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:48A2                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:48A2 </span>RW32_CONVERT    <span style="color:black">endp
DOSCODE:48A2
DOSCODE:48A3
DOSCODE:48A3 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:48A3
DOSCODE:48A3
DOSCODE:48A3 </span>Fastxxx_Purge   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:48A3                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:48A4                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:48A5                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:48A6                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:48A7                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:48AC                 </span><span style="color:navy">test    ds:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">80h </span>; Fast_yes ; fastopen installed ?
<span style="color:black">DOSCODE:48B1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:48B2                 </span><span style="color:navy">jz      short </span><span style="color:gray">nofast    </span>; no
<span style="color:black">DOSCODE:48B4                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1           </span>; FastOpen_ID
<span style="color:black">DOSCODE:48B6                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">5           </span>; FONC_purge
<span style="color:black">DOSCODE:48B8                 </span><span style="color:navy">mov     dl, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; set up drive number
<span style="color:black">DOSCODE:48BC                 </span><span style="color:navy">call    </span>Fast_Dispatch   ; call fastopen/seek
<span style="color:black">DOSCODE:48BF
DOSCODE:48BF </span><span style="color:gray">nofast</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:48BF                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:48C0                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:48C1                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:48C2                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:48C2 </span>Fastxxx_Purge   <span style="color:black">endp
DOSCODE:48C2
DOSCODE:48C2 </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSCODE:48C3 </span>DIVMES          <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:48C3                 </span><span style="color:navy">db &#039;Divide overflow&#039;,0Dh,0Ah
</span><span style="color:gray">DOSCODE:48D6 </span>DivMesLen       <span style="color:navy">dw </span><span style="color:#008040">19                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:48D8 </span>NoVxDErrMsg     <span style="color:navy">db &#039;You must have the file WINA20.386 in the root of your boot drive&#039;,0Dh </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:48D8                 </span><span style="color:navy">db </span><span style="color:green">0Ah
</span><span style="color:gray">DOSCODE:48D8                 </span><span style="color:navy">db &#039;to run Windows in Enhanced Mode&#039;,0Dh,0Ah
</span><span style="color:gray">DOSCODE:493B </span>CANCHAR         <span style="color:navy">db </span><span style="color:#008040">1Bh                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:493B                                         </span>; CANCEL ; Cancel line character
<span style="color:gray">DOSCODE:493C </span>ESCCHAR         <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:493C                                         </span>; ESCCH ; Lead-in character for escape sequences
<span style="color:gray">DOSCODE:493D </span>ESCTAB          <span style="color:navy">db </span><span style="color:#008040">40h                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:493D                                         </span>; Ctrl-Z - F6
<span style="color:gray">DOSCODE:493E                 </span><span style="color:navy">db </span><span style="color:#008040">4Dh                  </span>; Copy one char - --&gt;
<span style="color:gray">DOSCODE:493F                 </span><span style="color:navy">db </span><span style="color:#008040">3Bh                  </span>; Copy one char - F1
<span style="color:gray">DOSCODE:4940                 </span><span style="color:navy">db </span><span style="color:#008040">53h                  </span>; Skip one char - DEL
<span style="color:gray">DOSCODE:4941                 </span><span style="color:navy">db </span><span style="color:#008040">3Ch                  </span>; Copy to char - F2
<span style="color:gray">DOSCODE:4942                 </span><span style="color:navy">db </span><span style="color:#008040">3Eh                  </span>; Skip to char - F4
<span style="color:gray">DOSCODE:4943                 </span><span style="color:navy">db </span><span style="color:#008040">3Dh                  </span>; Copy line - F3
<span style="color:gray">DOSCODE:4944                 </span><span style="color:navy">db </span><span style="color:#008040">3Dh                  </span>; Kill line (no change to template ) - Not used
<span style="color:gray">DOSCODE:4945                 </span><span style="color:navy">db </span><span style="color:#008040">3Fh                  </span>; Reedit line (new template) - F5
<span style="color:gray">DOSCODE:4946                 </span><span style="color:navy">db </span><span style="color:#008040">4Bh                  </span>; Backspace - &lt;--
<span style="color:gray">DOSCODE:4947                 </span><span style="color:navy">db </span><span style="color:#008040">52h                  </span>; Enter insert mode - INS (toggle)
<span style="color:gray">DOSCODE:4948                 </span><span style="color:navy">db </span><span style="color:#008040">52h                  </span>; Exit insert mode - INS (toggle)
<span style="color:gray">DOSCODE:4949                 </span><span style="color:navy">db </span><span style="color:#008040">41h                  </span>; Escape character - F7
<span style="color:gray">DOSCODE:494A                 </span><span style="color:navy">db </span><span style="color:#008040">41h                  </span>; End of table
<span style="color:gray">DOSCODE:494B </span>ESCFUNC         <span style="color:navy">dw offset </span>GETCH         <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:494B                                         </span>; Ignore the escape sequence
<span style="color:gray">DOSCODE:494D                 </span><span style="color:navy">dw offset </span>TWOESC
<span style="color:gray">DOSCODE:494F                 </span><span style="color:navy">dw offset </span>EXITINS
<span style="color:gray">DOSCODE:4951                 </span><span style="color:navy">dw offset </span>EXITINS       ; ENTERINS
<span style="color:gray">DOSCODE:4953                 </span><span style="color:navy">dw offset </span>BACKSP
<span style="color:gray">DOSCODE:4955                 </span><span style="color:navy">dw offset </span>REEDIT
<span style="color:gray">DOSCODE:4957                 </span><span style="color:navy">dw offset </span>KILNEW
<span style="color:gray">DOSCODE:4959                 </span><span style="color:navy">dw offset </span>COPYLIN
<span style="color:gray">DOSCODE:495B                 </span><span style="color:navy">dw offset </span>SKIPSTR
<span style="color:gray">DOSCODE:495D                 </span><span style="color:navy">dw offset </span>COPYSTR
<span style="color:gray">DOSCODE:495F                 </span><span style="color:navy">dw offset </span>SKIPONE
<span style="color:gray">DOSCODE:4961                 </span><span style="color:navy">dw offset </span>COPYONE
<span style="color:gray">DOSCODE:4963                 </span><span style="color:navy">dw offset </span>COPYONE
<span style="color:gray">DOSCODE:4965                 </span><span style="color:navy">dw offset </span>CTRLZ
<span style="color:black">DOSCODE:4967 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4967 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR FINDOLD
</span><span style="color:black">DOSCODE:4967
DOSCODE:4967 </span><span style="color:gray">OEMFunctionKey</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4967                 </span><span style="color:navy">call    </span>$STD_CON_INPUT_NO_ECHO
<span style="color:black">DOSCODE:496A                 </span><span style="color:navy">mov     cl, </span><span style="color:green">14          </span>; ESCTABLEN
<span style="color:black">DOSCODE:496C                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:496D                 </span><span style="color:navy">mov     di, offset </span>ESCTAB
<span style="color:black">DOSCODE:4970                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:4971                 </span><span style="color:navy">push    cs
</span><span style="color:black">DOSCODE:4972                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:4973                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:4973                 </span><span style="color:navy">repne scasb
</span><span style="color:black">DOSCODE:4975                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:4976                 </span>assume es:nothing
<span style="color:black">DOSCODE:4976                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:4977                 </span><span style="color:navy">shl     cx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:4979                 </span><span style="color:navy">mov     bp, cx
</span><span style="color:black">DOSCODE:497B                 </span><span style="color:navy">jmp     cs:</span>ESCFUNC<span style="color:navy">[bp]
</span><span style="color:black">DOSCODE:497B </span><span style="color:gray">; END OF FUNCTION CHUNK FOR FINDOLD
</span><span style="color:black">DOSCODE:4980
DOSCODE:4980 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4980
DOSCODE:4980
DOSCODE:4980 </span>$GET_DATE       <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:4980                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:4981                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4982                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:4982                 </span><span style="color:navy">call    </span>READTIME
<span style="color:black">DOSCODE:4985                 </span><span style="color:navy">mov     ax, </span>YEAR
<span style="color:black">DOSCODE:4988                 </span><span style="color:navy">mov     bx, word ptr </span>DAY
<span style="color:black">DOSCODE:498C                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:black">DOSCODE:498F                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], bx      </span>; [SI+user_env.user_DX]
<span style="color:black">DOSCODE:4992                 </span><span style="color:navy">add     ax, </span><span style="color:green">1980
</span><span style="color:black">DOSCODE:4995                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], ax      </span>; [SI+user_env.user_CX]
<span style="color:black">DOSCODE:4998                 </span><span style="color:navy">mov     al, ss:</span>WEEKDAY
<span style="color:black">DOSCODE:499C
DOSCODE:499C </span>_RET24<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:499C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:499C </span>$GET_DATE       <span style="color:black">endp
DOSCODE:499C
DOSCODE:499D
DOSCODE:499D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:499D
DOSCODE:499D
DOSCODE:499D </span>$SET_DATE       <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:499D                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh        </span>; -1
<span style="color:black">DOSCODE:499F                 </span><span style="color:navy">sub     cx, </span><span style="color:green">1980        </span>; Fix bias in year
<span style="color:black">DOSCODE:49A3                 </span><span style="color:navy">jb      short </span>_RET24    ; Error if not big enough
<span style="color:black">DOSCODE:49A5                 </span><span style="color:navy">cmp     cx, </span><span style="color:green">119         </span>; Year must be less than 2100
<span style="color:black">DOSCODE:49A8                 </span><span style="color:navy">ja      short </span>RET24
<span style="color:black">DOSCODE:49AA                 </span><span style="color:navy">or      dh, dh
</span><span style="color:black">DOSCODE:49AC                 </span><span style="color:navy">jz      short </span>_RET24
<span style="color:black">DOSCODE:49AE                 </span><span style="color:navy">or      dl, dl
</span><span style="color:black">DOSCODE:49B0                 </span><span style="color:navy">jz      short </span>_RET24    ; Error if either month or day is 0
<span style="color:black">DOSCODE:49B2                 </span><span style="color:navy">cmp     dh, </span><span style="color:green">12          </span>; Check against max. month
<span style="color:black">DOSCODE:49B5                 </span><span style="color:navy">ja      short </span>RET24
<span style="color:black">DOSCODE:49B7                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:49B8                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:49B9                 </span><span style="color:navy">call    </span>DODATE
<span style="color:black">DOSCODE:49BC
DOSCODE:49BC </span>RET24<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:49BC                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:49BC </span>$SET_DATE       <span style="color:black">endp
DOSCODE:49BC
DOSCODE:49BD
DOSCODE:49BD </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:49BD
DOSCODE:49BD
DOSCODE:49BD </span>$GET_TIME       <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:49BD                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:49BE                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:49BF                 </span><span style="color:navy">call    </span>READTIME
<span style="color:black">DOSCODE:49C2                 </span><span style="color:navy">call    </span>Get_User_Stack  ; Get pointer to user registers
<span style="color:black">DOSCODE:49C5                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], dx      </span>; [SI+user_env.user_DX]
<span style="color:black">DOSCODE:49C8                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], cx      </span>; [SI+user_env.user_CX]
<span style="color:black">DOSCODE:49CB
DOSCODE:49CB </span>set_time_ok<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:49CB                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">DOSCODE:49CD
DOSCODE:49CD </span>RET26<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:49CD                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:49CD </span>$GET_TIME       <span style="color:black">endp
DOSCODE:49CD
DOSCODE:49CE
DOSCODE:49CE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:49CE
DOSCODE:49CE
DOSCODE:49CE </span>$SET_TIME       <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:49CE                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh        </span>; Flag in case of error
<span style="color:black">DOSCODE:49D0                 </span><span style="color:navy">cmp     ch, </span><span style="color:green">24          </span>; Check hours
<span style="color:black">DOSCODE:49D3                 </span><span style="color:navy">jnb     short </span>RET26
<span style="color:black">DOSCODE:49D5                 </span><span style="color:navy">cmp     cl, </span><span style="color:green">60          </span>; Check minutes
<span style="color:black">DOSCODE:49D8                 </span><span style="color:navy">jnb     short </span>RET26
<span style="color:black">DOSCODE:49DA                 </span><span style="color:navy">cmp     dh, </span><span style="color:green">60          </span>; Check seconds
<span style="color:black">DOSCODE:49DD                 </span><span style="color:navy">jnb     short </span>RET26
<span style="color:black">DOSCODE:49DF                 </span><span style="color:navy">cmp     dl, </span><span style="color:green">100         </span>; Check 1/100&#039;s
<span style="color:black">DOSCODE:49E2                 </span><span style="color:navy">jnb     short </span>RET26
<span style="color:black">DOSCODE:49E4                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:49E5                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:49E6                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:49E7                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:49E8                 </span><span style="color:navy">mov     bx, offset </span>TIMEBUF
<span style="color:black">DOSCODE:49EB                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:49EE                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:49F0                 </span><span style="color:navy">cwd
</span><span style="color:black">DOSCODE:49F1                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:49F2                 </span><span style="color:navy">call    </span>SETREAD
<span style="color:black">DOSCODE:49F5                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:49F6                 </span><span style="color:navy">lds     si, </span>BCLOCK
<span style="color:black">DOSCODE:49FA                 </span>assume ds:nothing
<span style="color:black">DOSCODE:49FA                 </span><span style="color:navy">call    </span>DEVIOCALL2      ; Get correct day count
<span style="color:black">DOSCODE:49FD                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:49FE                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:49FF                 </span><span style="color:navy">call    </span>SETWRITE
<span style="color:black">DOSCODE:4A02                 </span><span style="color:navy">pop     ds:</span>TIMEBUF<span style="color:navy">+</span><span style="color:green">4
</span><span style="color:black">DOSCODE:4A06                 </span><span style="color:navy">pop     ds:</span>TIMEBUF<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:4A0A                 </span><span style="color:navy">lds     si, ds:</span>BCLOCK
<span style="color:black">DOSCODE:4A0E                 </span><span style="color:navy">call    </span>DEVIOCALL2      ; Set the time
<span style="color:black">DOSCODE:4A11                 </span><span style="color:navy">jmp     short </span>set_time_ok
<span style="color:black">DOSCODE:4A11 </span>$SET_TIME       <span style="color:black">endp
DOSCODE:4A11
DOSCODE:4A13
DOSCODE:4A13 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4A13
DOSCODE:4A13
DOSCODE:4A13 </span>DATE16          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4A13                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:4A18                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:4A19                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:4A1A                 </span><span style="color:navy">call    </span>READTIME
<span style="color:black">DOSCODE:4A1D                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:4A1E                 </span><span style="color:navy">add     cl, cl
</span><span style="color:black">DOSCODE:4A20                 </span><span style="color:navy">add     cl, cl
</span><span style="color:black">DOSCODE:4A22                 </span><span style="color:navy">add     cx, cx
</span><span style="color:black">DOSCODE:4A24                 </span><span style="color:navy">add     cx, cx
</span><span style="color:black">DOSCODE:4A26                 </span><span style="color:navy">add     cx, cx
</span><span style="color:black">DOSCODE:4A28                 </span><span style="color:navy">shr     dh, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:4A2A                 </span><span style="color:navy">or      cl, dh
</span><span style="color:black">DOSCODE:4A2C                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">DOSCODE:4A2E                 </span><span style="color:navy">mov     ax, word ptr ds:</span>MONTH
<span style="color:black">DOSCODE:4A31                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:black">DOSCODE:4A33                 </span><span style="color:navy">shl     al, cl
</span><span style="color:black">DOSCODE:4A35                 </span><span style="color:navy">add     ax, ax
</span><span style="color:black">DOSCODE:4A37                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:4A38                 </span><span style="color:navy">or      al, ds:</span>DAY
<span style="color:black">DOSCODE:4A3C
DOSCODE:4A3C </span>RET21<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4A3C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4A3C </span>DATE16          <span style="color:black">endp
DOSCODE:4A3C
DOSCODE:4A3D
DOSCODE:4A3D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4A3D
DOSCODE:4A3D
DOSCODE:4A3D </span>READTIME        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4A3D                 </span><span style="color:navy">mov     ds:</span>DATE_FLAG<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; reset date flag for CPMIO
<span style="color:black">DOSCODE:4A43                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:4A44                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:4A45                 </span><span style="color:navy">mov     bx, offset </span>TIMEBUF
<span style="color:black">DOSCODE:4A48                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:4A4B                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:4A4D                 </span><span style="color:navy">cwd
</span><span style="color:black">DOSCODE:4A4E                 </span><span style="color:navy">call    </span>SETREAD
<span style="color:black">DOSCODE:4A51                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:4A52                 </span><span style="color:navy">lds     si, ds:</span>BCLOCK
<span style="color:black">DOSCODE:4A56                 </span><span style="color:navy">call    </span>DEVIOCALL2      ; Get correct date and time
<span style="color:black">DOSCODE:4A59                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4A5A                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:4A5B                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:4A5C                 </span><span style="color:navy">mov     ax, ds:</span>TIMEBUF
<span style="color:black">DOSCODE:4A5F                 </span><span style="color:navy">mov     cx, ds:</span>TIMEBUF<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:4A63                 </span><span style="color:navy">mov     dx, ds:</span>TIMEBUF<span style="color:navy">+</span><span style="color:green">4
</span><span style="color:black">DOSCODE:4A67                 </span><span style="color:navy">cmp     ax, ds:</span>DAYCNT   ; See if day count is the same
<span style="color:black">DOSCODE:4A6B                 </span><span style="color:navy">jz      short </span>RET21
<span style="color:black">DOSCODE:4A6D                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">43830       </span>; FOURYEARS*30 ; Number of days in 120 years
<span style="color:black">DOSCODE:4A70                 </span><span style="color:navy">jnb     short </span>RET22     ; Ignore if too large
<span style="color:black">DOSCODE:4A72                 </span><span style="color:navy">mov     ds:</span>DAYCNT<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:4A75                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:4A76                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:4A77                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:4A78                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:4A7A                 </span><span style="color:navy">mov     cx, </span><span style="color:green">1461        </span>; FOURYEARS ; Number of days in 4 years
<span style="color:black">DOSCODE:4A7D                 </span><span style="color:navy">div     cx
</span><span style="color:black">DOSCODE:4A7F                 </span><span style="color:navy">add     ax, ax
</span><span style="color:black">DOSCODE:4A81                 </span><span style="color:navy">add     ax, ax
</span><span style="color:black">DOSCODE:4A83                 </span><span style="color:navy">add     ax, ax          </span>; Multiply by 8 (no. of half-years)
<span style="color:black">DOSCODE:4A85                 </span><span style="color:navy">mov     cx, ax          </span>; &lt;240 implies AH=0
<span style="color:black">DOSCODE:4A87                 </span><span style="color:navy">mov     si, offset </span>YRTAB ; Table of days in each year
<span style="color:black">DOSCODE:4A8A                 </span><span style="color:navy">call    </span>DSLIDE          ; Find out which of four years we&#039;re in
<span style="color:black">DOSCODE:4A8D                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1           </span>; Convert half-years to whole years
<span style="color:black">DOSCODE:4A8F                 </span><span style="color:navy">jnb     short </span><span style="color:gray">SK        </span>; Extra half-year?
<span style="color:black">DOSCODE:4A91                 </span><span style="color:navy">add     dx, </span><span style="color:green">200
</span><span style="color:black">DOSCODE:4A95
DOSCODE:4A95 </span><span style="color:gray">SK</span><span style="color:navy">:                                     </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4A95                 </span><span style="color:navy">call    </span>SETYEAR
<span style="color:black">DOSCODE:4A98                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">1           </span>; At least at first month in year
<span style="color:black">DOSCODE:4A9A                 </span><span style="color:navy">mov     si, offset </span>MONTAB ; Table of days in each month
<span style="color:black">DOSCODE:4A9D                 </span><span style="color:navy">call    </span>DSLIDE          ; Find out which month we&#039;re in
<span style="color:black">DOSCODE:4AA0                 </span><span style="color:navy">mov     ds:</span>MONTH<span style="color:navy">, cl
</span><span style="color:black">DOSCODE:4AA4                 </span><span style="color:navy">inc     dx              </span>; Remainder is day of month (start with one)
<span style="color:black">DOSCODE:4AA5                 </span><span style="color:navy">mov     ds:</span>DAY<span style="color:navy">, dl
</span><span style="color:black">DOSCODE:4AA9                 </span><span style="color:navy">call    </span>WKDAY           ; Set day of week
<span style="color:black">DOSCODE:4AAC                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:4AAD                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:4AAE                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:4AAF
DOSCODE:4AAF </span>RET22<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4AAF                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4AAF </span>READTIME        <span style="color:black">endp
DOSCODE:4AAF
DOSCODE:4AB0
DOSCODE:4AB0 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4AB0
DOSCODE:4AB0
DOSCODE:4AB0 </span>DSLIDE          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4AB0                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0           </span>; (AH is already ZERO here!) 6/1/2024
<span style="color:black">DOSCODE:4AB2
DOSCODE:4AB2 </span><span style="color:gray">DSLIDE1</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4AB2                 </span><span style="color:navy">lodsb                   </span>; Get count of days
<span style="color:black">DOSCODE:4AB3                 </span><span style="color:navy">cmp     dx, ax          </span>; See if it will fit
<span style="color:black">DOSCODE:4AB5                 </span><span style="color:navy">jb      short </span>RET22
<span style="color:black">DOSCODE:4AB7                 </span><span style="color:navy">sub     dx, ax
</span><span style="color:black">DOSCODE:4AB9                 </span><span style="color:navy">inc     cx              </span>; Count one more month/year
<span style="color:black">DOSCODE:4ABA                 </span><span style="color:navy">jmp     short </span><span style="color:gray">DSLIDE1
</span><span style="color:black">DOSCODE:4ABA </span>DSLIDE          <span style="color:black">endp
DOSCODE:4ABA
DOSCODE:4ABC
DOSCODE:4ABC </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4ABC
DOSCODE:4ABC
DOSCODE:4ABC </span>SETYEAR         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4ABC                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:4AC1                 </span><span style="color:navy">mov     byte ptr ds:</span>YEAR<span style="color:navy">, cl
</span><span style="color:black">DOSCODE:4AC5
DOSCODE:4AC5 </span>CHKYR<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4AC5                 </span><span style="color:navy">test    cl, </span><span style="color:green">3           </span>; Check for leap year
<span style="color:black">DOSCODE:4AC8                 </span><span style="color:navy">mov     al, </span><span style="color:green">28          </span>; 28 days if no leap year
<span style="color:black">DOSCODE:4ACA                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SAVFEB
</span><span style="color:black">DOSCODE:4ACC                 </span><span style="color:navy">inc     al              </span>; Add leap day
<span style="color:black">DOSCODE:4ACE
DOSCODE:4ACE </span><span style="color:gray">SAVFEB</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4ACE                 </span><span style="color:navy">mov     ds:</span>february<span style="color:navy">, al </span>; [MONTAB+1],AL ; Store for February
<span style="color:black">DOSCODE:4AD1
DOSCODE:4AD1 </span>RET23<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4AD1                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4AD1 </span>SETYEAR         <span style="color:black">endp
DOSCODE:4AD1
DOSCODE:4AD2
DOSCODE:4AD2 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4AD2
DOSCODE:4AD2
DOSCODE:4AD2 </span>DODATE          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4AD2                 </span><span style="color:navy">call    </span>CHKYR           ; Set Feb. up for new year
<span style="color:black">DOSCODE:4AD5                 </span><span style="color:navy">mov     al, dh
</span><span style="color:black">DOSCODE:4AD7                 </span><span style="color:navy">mov     bx, (offset </span>YRTAB<span style="color:navy">+</span><span style="color:green">7</span><span style="color:navy">) </span>; MONTAB-1
<span style="color:black">DOSCODE:4ADA                 </span><span style="color:navy">xlat                    </span>; Look up days in month
<span style="color:black">DOSCODE:4ADB                 </span><span style="color:navy">cmp     al, dl
</span><span style="color:black">DOSCODE:4ADD                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh        </span>; -1
<span style="color:black">DOSCODE:4ADF                 </span><span style="color:navy">jb      short </span>RET23     ; Error if too many days
<span style="color:black">DOSCODE:4AE1                 </span><span style="color:navy">call    </span>SETYEAR
<span style="color:black">DOSCODE:4AE4                 </span><span style="color:navy">mov     word ptr ds:</span>DAY<span style="color:navy">, dx </span>; Set both day and month
<span style="color:black">DOSCODE:4AE8                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:4AEA                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:4AEC                 </span><span style="color:navy">mov     ax, </span><span style="color:green">1461        </span>; FOURYEARS
<span style="color:black">DOSCODE:4AEF                 </span><span style="color:navy">mov     bx, dx
</span><span style="color:black">DOSCODE:4AF1                 </span><span style="color:navy">mul     cx
</span><span style="color:black">DOSCODE:4AF3                 </span><span style="color:navy">mov     cl, byte ptr ds:</span>YEAR
<span style="color:black">DOSCODE:4AF7                 </span><span style="color:navy">and     cl, </span><span style="color:green">3
</span><span style="color:black">DOSCODE:4AFA                 </span><span style="color:navy">mov     si, offset </span>YRTAB
<span style="color:black">DOSCODE:4AFD                 </span><span style="color:navy">mov     dx, ax
</span><span style="color:black">DOSCODE:4AFF                 </span><span style="color:navy">add     cx, cx          </span>; Two entries per year, so double count
<span style="color:black">DOSCODE:4B01                 </span><span style="color:navy">call    </span>DSUM            ; Add up the days in each year
<span style="color:black">DOSCODE:4B04                 </span><span style="color:navy">mov     cl, bh          </span>; Month of year
<span style="color:black">DOSCODE:4B06                 </span><span style="color:navy">mov     si, offset </span>MONTAB
<span style="color:black">DOSCODE:4B09                 </span><span style="color:navy">dec     cx              </span>; Account for months starting with one
<span style="color:black">DOSCODE:4B0A                 </span><span style="color:navy">call    </span>DSUM            ; Add up days in each month
<span style="color:black">DOSCODE:4B0D                 </span><span style="color:navy">mov     cl, bl          </span>; Day of month
<span style="color:black">DOSCODE:4B0F                 </span><span style="color:navy">dec     cx              </span>; Account for days starting with one
<span style="color:black">DOSCODE:4B10                 </span><span style="color:navy">add     dx, cx          </span>; Add in to day total
<span style="color:black">DOSCODE:4B12                 </span><span style="color:navy">xchg    ax, dx          </span>; Get day count in AX
<span style="color:black">DOSCODE:4B13                 </span><span style="color:navy">mov     ds:</span>DAYCNT<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:4B16                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:4B17                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:4B18                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:4B19                 </span><span style="color:navy">mov     bx, offset </span>TIMEBUF
<span style="color:black">DOSCODE:4B1C                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:4B1F                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:4B21                 </span><span style="color:navy">cwd
</span><span style="color:black">DOSCODE:4B22                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:4B23                 </span><span style="color:navy">call    </span>SETREAD
<span style="color:black">DOSCODE:4B26                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:4B27                 </span><span style="color:navy">lds     si, ds:</span>BCLOCK
<span style="color:black">DOSCODE:4B2B                 </span><span style="color:navy">call    </span>DEVIOCALL2      ; Get correct date and time
<span style="color:black">DOSCODE:4B2E                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4B2F                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:4B30                 </span><span style="color:navy">call    </span>SETWRITE
<span style="color:black">DOSCODE:4B33                 </span><span style="color:navy">pop     ds:</span>TIMEBUF
<span style="color:black">DOSCODE:4B37                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:4B38                 </span><span style="color:navy">lds     si, ds:</span>BCLOCK
<span style="color:black">DOSCODE:4B3C                 </span><span style="color:navy">call    </span>DEVIOCALL2      ; Set the date
<span style="color:black">DOSCODE:4B3F                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4B40                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:4B41                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:4B42
DOSCODE:4B42 </span>WKDAY<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4B42                 </span><span style="color:navy">mov     ax, ds:</span>DAYCNT
<span style="color:black">DOSCODE:4B45                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:4B47                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">7
</span><span style="color:black">DOSCODE:4B4A                 </span><span style="color:navy">inc     ax
</span><span style="color:black">DOSCODE:4B4B                 </span><span style="color:navy">inc     ax              </span>; First day was Tuesday
<span style="color:black">DOSCODE:4B4C                 </span><span style="color:navy">div     cx              </span>; Compute day of week
<span style="color:black">DOSCODE:4B4E                 </span><span style="color:navy">mov     ds:</span>WEEKDAY<span style="color:navy">, dl
</span><span style="color:black">DOSCODE:4B52                 </span><span style="color:navy">xor     al, al          </span>; Flag OK
<span style="color:black">DOSCODE:4B54                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4B54 </span>DODATE          <span style="color:black">endp
DOSCODE:4B54
DOSCODE:4B55
DOSCODE:4B55 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4B55
DOSCODE:4B55
DOSCODE:4B55 </span>DSUM            <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4B55                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:4B57                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">DSUM9
</span><span style="color:black">DOSCODE:4B59
DOSCODE:4B59 </span><span style="color:gray">DSUM1</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4B59                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:4B5A                 </span><span style="color:navy">add     dx, ax
</span><span style="color:black">DOSCODE:4B5C                 </span><span style="color:navy">loop    </span><span style="color:gray">DSUM1
</span><span style="color:black">DOSCODE:4B5E
DOSCODE:4B5E </span><span style="color:gray">DSUM9</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4B5E                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4B5E </span>DSUM            <span style="color:black">endp
DOSCODE:4B5E
DOSCODE:4B5F
DOSCODE:4B5F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4B5F
DOSCODE:4B5F
DOSCODE:4B5F </span>$GET_VERSION    <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:4B5F                 </span><span style="color:navy">lds     cx, ss:</span>USERNUM
<span style="color:black">DOSCODE:4B64                 </span><span style="color:navy">mov     bx, ds
</span><span style="color:black">DOSCODE:4B66                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:4B67                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4B68                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:4B68                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:4B6A                 </span><span style="color:navy">jnz     short </span>Norm_Vers
<span style="color:black">DOSCODE:4B6C                 </span><span style="color:navy">xor     bh, bh          </span>; return 0 (not ROMDOS version)
<span style="color:black">DOSCODE:4B6E
DOSCODE:4B6E </span>Norm_Vers<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4B6E                 </span><span style="color:navy">mov     ds, </span>CurrentPDB  ; Get the version number from the
<span style="color:black">DOSCODE:4B6E                                         </span>; current app&#039;s PSP segment
<span style="color:black">DOSCODE:4B72                 </span>assume ds:nothing
<span style="color:black">DOSCODE:4B72                 </span><span style="color:navy">mov     ax, </span>word ptr ds:40h ; [PDB.Version]
<span style="color:black">DOSCODE:4B72                                         </span>; AX = DOS version number
<span style="color:black">DOSCODE:4B75                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:black">DOSCODE:4B78
DOSCODE:4B78 </span>gdrvfspc_ret<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4B78                 </span><span style="color:navy">mov     [si], ax        </span>; [SI+user_env.user_AX]
<span style="color:black">DOSCODE:4B7A                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], cx      </span>; [SI+user_env.user_CX]
<span style="color:black">DOSCODE:4B7D
DOSCODE:4B7D </span>set_user_bx<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4B7D                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], bx      </span>; [SI+user_env.user_BX]
<span style="color:black">DOSCODE:4B80                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4B80 </span>$GET_VERSION    <span style="color:black">endp
DOSCODE:4B80
</span><span style="color:maroon">DOSCODE:4B81 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4B81
DOSCODE:4B81 </span>$GET_VERIFY_ON_WRITE<span style="color:navy">:                   </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:4B81                 </span><span style="color:navy">mov     al, ss:</span>VDERFLG
<span style="color:maroon">DOSCODE:4B85                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:4B86 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4B86
DOSCODE:4B86 </span>$SET_VERIFY_ON_WRITE<span style="color:navy">:                   </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:4B86                 </span><span style="color:navy">and     al, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:4B88                 </span><span style="color:navy">mov     ss:</span>VDERFLG<span style="color:navy">, al
</span><span style="color:maroon">DOSCODE:4B8C
DOSCODE:4B8C </span>RET27<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4B8C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4B8D
DOSCODE:4B8D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4B8D
DOSCODE:4B8D
DOSCODE:4B8D </span>$INTERNATIONAL  <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:4B8D
DOSCODE:4B8D </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:4BE2 SIZE 0000002E BYTES
</span><span style="color:black">DOSCODE:4B8D
DOSCODE:4B8D                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0FFh        </span>; -1 means country code is in BX
<span style="color:black">DOSCODE:4B8F                 </span><span style="color:navy">jz      short </span>BX_HAS_CODE
<span style="color:black">DOSCODE:4B91                 </span><span style="color:navy">mov     bl, al          </span>; Put AL country code in BX
<span style="color:black">DOSCODE:4B93                 </span><span style="color:navy">xor     bh, bh
</span><span style="color:black">DOSCODE:4B95
DOSCODE:4B95 </span>BX_HAS_CODE<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4B95                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:4B96                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:4B97                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:4B98                 </span><span style="color:navy">pop     di              </span>; User buffer to ES:DI
<span style="color:black">DOSCODE:4B99                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:4B9A                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4B9B                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:4B9B                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:black">DOSCODE:4B9E                 </span><span style="color:navy">jz      short </span>international_set
<span style="color:black">DOSCODE:4BA0                 </span><span style="color:navy">or      bx, bx
</span><span style="color:black">DOSCODE:4BA2                 </span><span style="color:navy">jnz     short </span>international_find
<span style="color:black">DOSCODE:4BA4                 </span><span style="color:navy">mov     si, offset </span>COUNTRY_CDPG
<span style="color:black">DOSCODE:4BA7                 </span><span style="color:navy">jmp     short </span>international_copy
<span style="color:black">DOSCODE:4BA9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4BA9
DOSCODE:4BA9 </span>international_find<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4BA9                 </span><span style="color:navy">xor     bp, bp          </span>; 0 ; flag it for GetCntry only
<span style="color:black">DOSCODE:4BAB                 </span><span style="color:navy">call    </span>international_get
<span style="color:black">DOSCODE:4BAE                 </span><span style="color:navy">jb      short </span>errtn
<span style="color:black">DOSCODE:4BB0                 </span><span style="color:navy">or      bx, bx          </span>; nlsfunc finished it ?
<span style="color:black">DOSCODE:4BB2                 </span><span style="color:navy">jnz     short </span>international_copy ; no, copy by myself
<span style="color:black">DOSCODE:4BB4                 </span><span style="color:navy">mov     bx, dx          </span>; put country back
<span style="color:black">DOSCODE:4BB6                 </span><span style="color:navy">jmp     short </span>international_ok3
<span style="color:black">DOSCODE:4BB6 </span>$INTERNATIONAL  <span style="color:black">endp
DOSCODE:4BB6
DOSCODE:4BB8
DOSCODE:4BB8 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4BB8
DOSCODE:4BB8
DOSCODE:4BB8 </span>international_get <span style="color:black">proc near             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4BB8                 </span><span style="color:navy">mov     si, offset </span>COUNTRY_CDPG
<span style="color:black">DOSCODE:4BBB                 </span><span style="color:navy">cmp     bx, ss:[si+</span><span style="color:#ff8000">68h</span><span style="color:navy">] </span>; [SI+DOS_CCDPG.ccDosCountry]
<span style="color:black">DOSCODE:4BBF                 </span><span style="color:navy">jz      short </span>RET27     ; = current country id
<span style="color:black">DOSCODE:4BC1                 </span><span style="color:navy">mov     dx, bx
</span><span style="color:black">DOSCODE:4BC3                 </span><span style="color:navy">xor     bx, bx          </span>; bx = 0, default code page
<span style="color:black">DOSCODE:4BC5                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1400h
</span><span style="color:black">DOSCODE:4BC8                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; - Multiplex - NLSFUNC.COM - INSTALLATION CHECK
<span style="color:black">DOSCODE:4BC8                                         </span>; Return: AL = 00h not installed, OK to install
<span style="color:black">DOSCODE:4BC8                                         </span>; 01h not installed, not OK
<span style="color:black">DOSCODE:4BC8                                         </span>; FFh installed
<span style="color:black">DOSCODE:4BCA                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0FFh        </span>; not in memory
<span style="color:black">DOSCODE:4BCC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">interr
</span><span style="color:black">DOSCODE:4BCE                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1403h       </span>; set country info
<span style="color:black">DOSCODE:4BD1                 </span><span style="color:navy">or      bp, bp          </span>; GetCntry ?
<span style="color:black">DOSCODE:4BD3                 </span><span style="color:navy">jnz     short </span><span style="color:gray">stcdpg
</span><span style="color:black">DOSCODE:4BD5                 </span><span style="color:navy">inc     ax              </span>; AX = 1404h ; get country info
<span style="color:black">DOSCODE:4BD6
DOSCODE:4BD6 </span><span style="color:gray">stcdpg</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4BD6                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; - Multiplex - NLSFUNC.COM - GET COUNTRY INFO
<span style="color:black">DOSCODE:4BD6                                         </span>; BX = code page, DX = country code, DS:SI -&gt; internal code page structure
<span style="color:black">DOSCODE:4BD6                                         </span>; ES:DI -&gt; user buffer
<span style="color:black">DOSCODE:4BD6                                         </span>; Return: AL = status
<span style="color:black">DOSCODE:4BD8                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:4BDA                 </span><span style="color:navy">jz      short </span>RET27
<span style="color:black">DOSCODE:4BDC
DOSCODE:4BDC </span><span style="color:gray">setcarry</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4BDC                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:4BDD                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4BDE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4BDE
DOSCODE:4BDE </span><span style="color:gray">interr</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4BDE                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:4BE0                 </span><span style="color:navy">jmp     short </span><span style="color:gray">setcarry
</span><span style="color:black">DOSCODE:4BE0 </span>international_get <span style="color:black">endp
DOSCODE:4BE0
DOSCODE:4BE2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4BE2 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR $INTERNATIONAL
</span><span style="color:black">DOSCODE:4BE2
DOSCODE:4BE2 </span>international_copy<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4BE2                 </span><span style="color:navy">mov     bx, ss:[si+</span><span style="color:#ff8000">68h</span><span style="color:navy">] </span>; [ss:SI+DOS_CCDPG.ccDosCountry]
<span style="color:black">DOSCODE:4BE6                 </span><span style="color:navy">mov     si, offset </span>COUNTRY_CDPG_108 ; COUNTRY_CDPG+DOS_CCDPG.ccDFormat
<span style="color:black">DOSCODE:4BE9                 </span><span style="color:navy">mov     cx, </span><span style="color:green">12          </span>; OLD_COUNTRY_SIZE/2
<span style="color:black">DOSCODE:4BEC                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:4BED                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:4BEE                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4BEF                 </span><span style="color:navy">rep movsw
</span><span style="color:black">DOSCODE:4BF1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4BF2                 </span>assume ds:nothing
<span style="color:black">DOSCODE:4BF2
DOSCODE:4BF2 </span>international_ok3<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4BF2                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:black">DOSCODE:4BF5                 </span><span style="color:navy">call    </span>set_user_bx     ; MOV [SI+user_env.user_BX],BX
<span style="color:black">DOSCODE:4BF8
DOSCODE:4BF8 </span>international_ok<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4BF8                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:black">DOSCODE:4BFA                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:black">DOSCODE:4BFD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4BFD
DOSCODE:4BFD </span>international_set<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4BFD                 </span><span style="color:navy">mov     bp, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:4C00                 </span><span style="color:navy">call    </span>international_get
<span style="color:black">DOSCODE:4C03                 </span><span style="color:navy">jnb     short </span>international_ok
<span style="color:black">DOSCODE:4C05
DOSCODE:4C05 </span>errtn<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4C05                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:4C07                 </span><span style="color:navy">jz      short </span>errtn2
<span style="color:black">DOSCODE:4C09
DOSCODE:4C09 </span>errtn1<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4C09                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:black">DOSCODE:4C0C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4C0C
DOSCODE:4C0C </span>errtn2<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4C0C                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; error_invalid_function
<span style="color:black">DOSCODE:4C0E                 </span><span style="color:navy">jmp     short </span>errtn1    ; NLSFUNC not existent
<span style="color:black">DOSCODE:4C0E </span><span style="color:gray">; END OF FUNCTION CHUNK FOR $INTERNATIONAL
</span><span style="color:maroon">DOSCODE:4C10 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4C10
DOSCODE:4C10 </span>$ExtCountryInfo<span style="color:navy">:                        </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:4C10                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2           </span>; INT 21h, AH = 70h (06/01/2024 - Erdogan Tan)
<span style="color:maroon">DOSCODE:4C10                                         </span>; GET/SET INTERNATIONALIZATION INFORMATION
<span style="color:maroon">DOSCODE:4C10                                         </span>; ****
<span style="color:maroon">DOSCODE:4C10                                         </span>; AL = subfunction
<span style="color:maroon">DOSCODE:4C10                                         </span>; 00h SET general internationalization info
<span style="color:maroon">DOSCODE:4C10                                         </span>;     CX = buffer size (up to 38 bytes)
<span style="color:maroon">DOSCODE:4C10                                         </span>;     DS:SI -&gt; buffer containing internationalization info
<span style="color:maroon">DOSCODE:4C10                                         </span>;  first three bytes are skipped, the rest is copied to somewhere
<span style="color:maroon">DOSCODE:4C10                                         </span>;  in the DOS data segment
<span style="color:maroon">DOSCODE:4C10                                         </span>; 01h SET extended internationalization info
<span style="color:maroon">DOSCODE:4C10                                         </span>;     CX = number of bytes to set (up to 58 bytes)
<span style="color:maroon">DOSCODE:4C10                                         </span>;     DS:SI -&gt; buffer containing internationalization info
<span style="color:maroon">DOSCODE:4C10                                         </span>; 02h GET extended internationalization info
<span style="color:maroon">DOSCODE:4C10                                         </span>;     CX = buffer size in bytes (up to 58 bytes used)
<span style="color:maroon">DOSCODE:4C10                                         </span>;     ES:DI -&gt; buffer
<span style="color:maroon">DOSCODE:4C10                                         </span>; ****
<span style="color:maroon">DOSCODE:4C10                                         </span>; (Ref: Ralf Brown&#039;s Interrupt List) - had some mistakes -
<span style="color:maroon">DOSCODE:4C12                 </span><span style="color:navy">ja      short </span>errtn2
<span style="color:maroon">DOSCODE:4C14                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:4C15                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:4C16                 </span><span style="color:navy">jnz     short </span>ext_cntry_inf_1
<span style="color:maroon">DOSCODE:4C18                 </span><span style="color:navy">pop     es              </span>; AX = GET 35 bytes info (from offset 3 to 37)
<span style="color:maroon">DOSCODE:4C18                                         </span>; (38 bytes buffer is used)
<span style="color:maroon">DOSCODE:4C19                 </span><span style="color:navy">mov     di, offset </span>_COUNTRY_ID
<span style="color:maroon">DOSCODE:4C1C                 </span><span style="color:navy">mov     ax, es:[di-</span><span style="color:green">2</span><span style="color:navy">]   </span>; NEW_COUNTRY_SIZE = 38
<span style="color:maroon">DOSCODE:4C20                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">3           </span>; skip the 1st 3 bytes of the buffer
<span style="color:maroon">DOSCODE:4C23                 </span><span style="color:navy">add     si, bx
</span><span style="color:maroon">DOSCODE:4C25                 </span><span style="color:navy">jmp     short </span>ext_cntry_inf_4
<span style="color:maroon">DOSCODE:4C27 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4C27
DOSCODE:4C27 </span>ext_cntry_inf_1<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4C27                 </span><span style="color:navy">dec     al
</span><span style="color:maroon">DOSCODE:4C29                 </span><span style="color:navy">jnz     short </span>ext_cntry_inf_2 ; AX = 2
<span style="color:maroon">DOSCODE:4C2B                 </span><span style="color:navy">pop     es              </span>; AX = 1 (set)
<span style="color:maroon">DOSCODE:4C2C                 </span><span style="color:navy">mov     di, offset </span>_ENU <span style="color:gray">; &quot;ENU&quot;
</span><span style="color:maroon">DOSCODE:4C2F                 </span><span style="color:navy">jmp     short </span>ext_cntry_inf_3
<span style="color:maroon">DOSCODE:4C31 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4C31
DOSCODE:4C31 </span>ext_cntry_inf_2<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4C31                 </span><span style="color:navy">pop     ds              </span>; AX = 2 (get)
<span style="color:maroon">DOSCODE:4C32                 </span><span style="color:navy">mov     si, offset </span>_ENU <span style="color:gray">; &quot;ENU&quot;
</span><span style="color:maroon">DOSCODE:4C35
DOSCODE:4C35 </span>ext_cntry_inf_3<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4C35                 </span><span style="color:navy">xor     bx, bx          </span>; 0
<span style="color:maroon">DOSCODE:4C37                 </span><span style="color:navy">mov     ax, </span><span style="color:green">58          </span>; 3Ah
<span style="color:maroon">DOSCODE:4C3A
DOSCODE:4C3A </span>ext_cntry_inf_4<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4C3A                 </span><span style="color:navy">cmp     cx, ax          </span>; &gt; 38 ? (58)
<span style="color:maroon">DOSCODE:4C3C                 </span><span style="color:navy">jb      short </span>ext_cntry_inf_5 ; no
<span style="color:maroon">DOSCODE:4C3E                 </span><span style="color:navy">mov     cx, ax          </span>; yes, decrease size to 38 (58)
<span style="color:maroon">DOSCODE:4C40
DOSCODE:4C40 </span>ext_cntry_inf_5<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4C40                 </span><span style="color:navy">mov     ax, cx          </span>; buffer (filled) size
<span style="color:maroon">DOSCODE:4C42                 </span><span style="color:navy">sub     cx, bx          </span>; copy byte count
<span style="color:maroon">DOSCODE:4C44                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">DOSCODE:4C46                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:4C47                 </span><span style="color:navy">jmp     </span>ret_ax_to_user_cx ; ax -&gt; user&#039;s cx
<span style="color:black">DOSCODE:4C4A
DOSCODE:4C4A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4C4A
DOSCODE:4C4A
DOSCODE:4C4A </span>$GetExtCntry    <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:4C4A                 </span><span style="color:navy">cmp     al, </span><span style="color:green">20h         </span>; CAP_ONE_CHAR  ; &lt; 20h
<span style="color:black">DOSCODE:4C4C                 </span><span style="color:navy">jb      short </span>notcap
<span style="color:black">DOSCODE:4C4E                 </span><span style="color:navy">test    al, </span><span style="color:green">80h         </span>; UPPER_TABLE
<span style="color:black">DOSCODE:4C50                 </span><span style="color:navy">jnz     short </span>fileupper ; file upper case
<span style="color:black">DOSCODE:4C52                 </span><span style="color:navy">mov     bx, offset </span>UCASE_TAB_2 ; UCASE_TAB+2
<span style="color:black">DOSCODE:4C52                                         </span>; get normal upper case
<span style="color:black">DOSCODE:4C55                 </span><span style="color:navy">jmp     short </span>capit
<span style="color:black">DOSCODE:4C57 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4C57
DOSCODE:4C57 </span>fileupper<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4C57                 </span><span style="color:navy">and     al, </span><span style="color:green">7Fh
</span><span style="color:black">DOSCODE:4C59                 </span><span style="color:navy">mov     bx, offset </span>FILE_UCASE_TAB_2 ; FILE_UCASE_TAB+2
<span style="color:black">DOSCODE:4C59                                         </span>; get file upper case
<span style="color:black">DOSCODE:4C5C
DOSCODE:4C5C </span>capit<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4C5C                 </span><span style="color:navy">cmp     al, </span><span style="color:green">20h         </span>; CAP_ONE_CHAR ; cap one char ?
<span style="color:black">DOSCODE:4C5E                 </span><span style="color:navy">jnz     short </span>chkyes
<span style="color:black">DOSCODE:4C60                 </span><span style="color:navy">mov     al, dl          </span>; set up AL
<span style="color:black">DOSCODE:4C62                 </span><span style="color:navy">call    </span>GETLET3         ; upper case it
<span style="color:black">DOSCODE:4C65                 </span><span style="color:navy">call    </span>Get_User_Stack  ; get user stack
<span style="color:black">DOSCODE:4C68                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], al      </span>; [SI+user_env.user_DX]
<span style="color:black">DOSCODE:4C6B                 </span><span style="color:navy">jmp     short </span>nono      ; done
<span style="color:black">DOSCODE:4C6D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4C6D
DOSCODE:4C6D </span>chkyes<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4C6D                 </span><span style="color:navy">cmp     al, </span><span style="color:green">23h         </span>; CHECK_YES_NO
<span style="color:black">DOSCODE:4C6F                 </span><span style="color:navy">jnz     short </span>capstring ; no
<span style="color:black">DOSCODE:4C6F                                         </span>; Yes/No
<span style="color:black">DOSCODE:4C71                 </span><span style="color:navy">xor     ax, ax          </span>; presume NO
<span style="color:black">DOSCODE:4C73                 </span><span style="color:navy">cmp     dl, ss:</span>NLS_YES
<span style="color:black">DOSCODE:4C78                 </span><span style="color:navy">jz      short </span>yesyes    ; Y(ES)
<span style="color:black">DOSCODE:4C7A                 </span><span style="color:navy">cmp     dl, ss:</span>NLS_yes2
<span style="color:black">DOSCODE:4C7F                 </span><span style="color:navy">jz      short </span>yesyes    ; y(es)
<span style="color:black">DOSCODE:4C81                 </span><span style="color:navy">cmp     dl, ss:</span>NLS_NO
<span style="color:black">DOSCODE:4C86                 </span><span style="color:navy">jz      short </span>nono      ; N(O)
<span style="color:black">DOSCODE:4C88                 </span><span style="color:navy">cmp     dl, ss:</span>NLS_no2
<span style="color:black">DOSCODE:4C8D                 </span><span style="color:navy">jz      short </span>nono      ; n(o)
<span style="color:black">DOSCODE:4C8F                 </span><span style="color:navy">inc     ax              </span>; not YES or NO
<span style="color:black">DOSCODE:4C90
DOSCODE:4C90 </span>yesyes<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4C90                 </span><span style="color:navy">inc     ax              </span>; YES = 1
<span style="color:black">DOSCODE:4C91
DOSCODE:4C91 </span>nono<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4C91                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:black">DOSCODE:4C94 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4C94
DOSCODE:4C94 </span>capstring<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4C94                 </span><span style="color:navy">mov     si, dx
</span><span style="color:black">DOSCODE:4C96                 </span><span style="color:navy">cmp     al, </span><span style="color:green">21h         </span>; CAP_STRING
<span style="color:black">DOSCODE:4C98                 </span><span style="color:navy">jnz     short </span>capascii
<span style="color:black">DOSCODE:4C9A                 </span><span style="color:navy">jcxz    short </span>nono
<span style="color:black">DOSCODE:4C9C
DOSCODE:4C9C </span>concap<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4C9C                 </span><span style="color:navy">lodsb                   </span>; get char
<span style="color:black">DOSCODE:4C9D                 </span><span style="color:navy">call    </span>GETLET3         ; upper case it
<span style="color:black">DOSCODE:4CA0                 </span><span style="color:navy">mov     [si-</span><span style="color:green">1</span><span style="color:navy">], al      </span>; store back
<span style="color:black">DOSCODE:4CA3                 </span><span style="color:navy">loop    </span>concap          ; continue
<span style="color:black">DOSCODE:4CA5                 </span><span style="color:navy">jmp     short </span>nono      ; done
<span style="color:black">DOSCODE:4CA7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4CA7
DOSCODE:4CA7 </span>capascii<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4CA7                 </span><span style="color:navy">cmp     al, </span><span style="color:green">22h         </span>; CAP_ASCIIZ
<span style="color:black">DOSCODE:4CA9                 </span><span style="color:navy">jnz     short </span>capinval
<span style="color:black">DOSCODE:4CAB
DOSCODE:4CAB </span>concap2<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4CAB                 </span><span style="color:navy">lodsb                   </span>; get char
<span style="color:black">DOSCODE:4CAC                 </span><span style="color:navy">or      al, al          </span>; end of string ?
<span style="color:black">DOSCODE:4CAE                 </span><span style="color:navy">jz      short </span>nono      ; yes
<span style="color:black">DOSCODE:4CB0                 </span><span style="color:navy">call    </span>GETLET3         ; upper case it
<span style="color:black">DOSCODE:4CB3                 </span><span style="color:navy">mov     [si-</span><span style="color:green">1</span><span style="color:navy">], al      </span>; store back
<span style="color:black">DOSCODE:4CB6                 </span><span style="color:navy">jmp     short </span>concap2   ; continue
<span style="color:black">DOSCODE:4CB8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4CB8
DOSCODE:4CB8 </span>notcap<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4CB8                 </span><span style="color:navy">cmp     cx, </span><span style="color:#ff8000">5           </span>; minimum size is 5
<span style="color:black">DOSCODE:4CBB                 </span><span style="color:navy">jb      short </span>capinval  ; sizeerror
<span style="color:black">DOSCODE:4CBD
DOSCODE:4CBD </span>GEC_CONT<span style="color:navy">:
</span><span style="color:black">DOSCODE:4CBD                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:4CBE                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4CBF                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:4CBF                 </span><span style="color:navy">mov     si, offset </span>COUNTRY_CDPG
<span style="color:black">DOSCODE:4CC2                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:4CC4                 </span><span style="color:navy">jnz     short </span>GETCNTRY  ;
<span style="color:black">DOSCODE:4CC4                                         </span>; AL = 0 (INT 21h, AX=6500h)
<span style="color:black">DOSCODE:4CC4                                         </span>; Set extended country-dependent information
<span style="color:black">DOSCODE:4CC4                                         </span>; (SET GENERAL INTERNATIONALIZATION INFO)
<span style="color:black">DOSCODE:4CC6                 </span><span style="color:navy">sub     cx, </span><span style="color:#ff8000">7           </span>; minimum 8 bytes
<span style="color:black">DOSCODE:4CC9                 </span><span style="color:navy">jbe     short </span>capinval  ; error_invalid_function
<span style="color:black">DOSCODE:4CCB                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">48h</span><span style="color:navy">]    </span>; [SI+DOS_CCDPG.ccSysCodePage]
<span style="color:black">DOSCODE:4CCE                 </span><span style="color:navy">lea     si, [si+</span><span style="color:#ff8000">66h</span><span style="color:navy">]    </span>; SI+DOS_CCDPG.ccCountryInfoLen
<span style="color:black">DOSCODE:4CD1                 </span><span style="color:navy">mov     ax, [si]
</span><span style="color:black">DOSCODE:4CD3                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">4
</span><span style="color:black">DOSCODE:4CD6                 </span><span style="color:navy">cmp     cx, ax
</span><span style="color:black">DOSCODE:4CD8                 </span><span style="color:navy">jbe     short </span>set_inter_info
<span style="color:black">DOSCODE:4CDA                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">DOSCODE:4CDC
DOSCODE:4CDC </span>set_inter_info<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4CDC                 </span><span style="color:navy">mov     ax, cx
</span><span style="color:black">DOSCODE:4CDE                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">4
</span><span style="color:black">DOSCODE:4CE1                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">1</span><span style="color:navy">], ax   </span>; info length/size (will be written)
<span style="color:black">DOSCODE:4CE5                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">6           </span>; DOS_CCDPG.ccDFormat
<span style="color:black">DOSCODE:4CE8                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">7           </span>; points to date format
<span style="color:black">DOSCODE:4CEB                 </span><span style="color:navy">call    </span>XCHGP           ; ds:si = user&#039;s buffer + 6
<span style="color:black">DOSCODE:4CEB                                         </span>; es:di = country info buffer + 7
<span style="color:black">DOSCODE:4CEE                 </span><span style="color:navy">jmp     short </span>OK_RETN
<span style="color:black">DOSCODE:4CF0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4CF0
DOSCODE:4CF0 </span>GETCNTRY<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4CF0                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">0FFFFh      </span>; -1 ; active country ?
<span style="color:black">DOSCODE:4CF3                 </span><span style="color:navy">jnz     short </span>GETCDPG
<span style="color:black">DOSCODE:4CF5                 </span><span style="color:navy">mov     dx, [si+</span><span style="color:#ff8000">68h</span><span style="color:navy">]    </span>; [SI+DOS_CCDPG.ccDosCountry]
<span style="color:black">DOSCODE:4CF8
DOSCODE:4CF8 </span>GETCDPG<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4CF8                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">0FFFFh      </span>; -1 ; active code page?
<span style="color:black">DOSCODE:4CFB                 </span><span style="color:navy">jnz     short </span>CHKAGAIN
<span style="color:black">DOSCODE:4CFD                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">6Ah</span><span style="color:navy">]    </span>; [SI+DOS_CCDPG.ccDosCodePage] ; get active code page
<span style="color:black">DOSCODE:4D00
DOSCODE:4D00 </span>CHKAGAIN<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4D00                 </span><span style="color:navy">cmp     dx, [si+</span><span style="color:#ff8000">68h</span><span style="color:navy">]    </span>; [SI+DOS_CCDPG.ccDosCountry] ; same ?
<span style="color:black">DOSCODE:4D03                 </span><span style="color:navy">jnz     short </span>CHKNLS    ; no
<span style="color:black">DOSCODE:4D05                 </span><span style="color:navy">cmp     bx, [si+</span><span style="color:#ff8000">6Ah</span><span style="color:navy">]    </span>; [SI+DOS_CCDPG.ccDosCodePage] ; same ?
<span style="color:black">DOSCODE:4D08                 </span><span style="color:navy">jnz     short </span>CHKNLS    ; no
<span style="color:black">DOSCODE:4D0A
DOSCODE:4D0A </span>CHKTYPE<span style="color:navy">:                                </span>; yes, same code page and same country id
<span style="color:black">DOSCODE:4D0A                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">48h</span><span style="color:navy">]    </span>; [SI+DOS_CCDPG.ccSysCodePage]
<span style="color:black">DOSCODE:4D0D                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:4D0E                 </span><span style="color:navy">mov     cx, [si+</span><span style="color:#ff8000">4Ah</span><span style="color:navy">]    </span>; [SI+DOS_CCDPG.ccNumber_of_entries]
<span style="color:black">DOSCODE:4D11                 </span><span style="color:navy">mov     si, offset </span>COUNTRY_CDPG_76 ; COUNTRY_CDPG+DOS_CCDPG.ccSetUcase
<span style="color:black">DOSCODE:4D14
DOSCODE:4D14 </span>NXTENTRY<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4D14                 </span><span style="color:navy">cmp     al, [si]        </span>; compare info type
<span style="color:black">DOSCODE:4D16                 </span><span style="color:navy">jz      short </span>FOUNDIT
<span style="color:black">DOSCODE:4D18                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">5           </span>; next entry
<span style="color:black">DOSCODE:4D1B                 </span><span style="color:navy">loop    </span>NXTENTRY
<span style="color:black">DOSCODE:4D1D                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:4D1E
DOSCODE:4D1E </span>capinval<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4D1E                 </span><span style="color:navy">jmp     </span>errtn2          ; error_invalid_function
<span style="color:black">DOSCODE:4D21 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4D21
DOSCODE:4D21 </span>FOUNDIT<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4D21                 </span><span style="color:navy">movsb                   </span>; move info id byte
<span style="color:black">DOSCODE:4D22                 </span><span style="color:navy">pop     cx              </span>; restore char count
<span style="color:black">DOSCODE:4D23                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1           </span>; SetCountryInfo ; select country info type ?
<span style="color:black">DOSCODE:4D25                 </span><span style="color:navy">jz      short </span>setsize   ; yes
<span style="color:black">DOSCODE:4D27                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4           </span>; 4 bytes will be moved
<span style="color:black">DOSCODE:4D2A                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5           </span>; 5 bytes will be returned in CX
<span style="color:black">DOSCODE:4D2D
DOSCODE:4D2D </span>OK_RETN<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4D2D                 </span><span style="color:navy">rep movsb               </span>; copy info
<span style="color:black">DOSCODE:4D2F                 </span><span style="color:navy">mov     cx, ax          </span>; CX = actual length returned
<span style="color:black">DOSCODE:4D31                 </span><span style="color:navy">mov     ax, bx          </span>; return sys code page in ax
<span style="color:black">DOSCODE:4D33
DOSCODE:4D33 </span>GETDONE<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4D33                 </span><span style="color:navy">call    </span>Get_User_Stack  ; return actual length to user&#039;s CX
<span style="color:black">DOSCODE:4D36                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], cx      </span>; [SI+user_env.user_CX]
<span style="color:black">DOSCODE:4D39
DOSCODE:4D39 </span>nono_jmp<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4D39                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:black">DOSCODE:4D3C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4D3C
DOSCODE:4D3C </span>setsize<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4D3C                 </span><span style="color:navy">sub     cx, </span><span style="color:#ff8000">3           </span>; size after length field
<span style="color:black">DOSCODE:4D3F                 </span><span style="color:navy">cmp     [si], cx        </span>; less than table size
<span style="color:black">DOSCODE:4D41                 </span><span style="color:navy">jnb     short </span><span style="color:gray">setsize2  </span>; no
<span style="color:black">DOSCODE:4D43                 </span><span style="color:navy">mov     cx, [si]        </span>; truncate to table size
<span style="color:black">DOSCODE:4D45
DOSCODE:4D45 </span><span style="color:gray">setsize2</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4D45                 </span><span style="color:navy">mov     es:[di], cx     </span>; copy actual length to user&#039;s buffer
<span style="color:black">DOSCODE:4D48                 </span><span style="color:navy">inc     di              </span>; update index
<span style="color:black">DOSCODE:4D49                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:4D4A                 </span><span style="color:navy">inc     si
</span><span style="color:black">DOSCODE:4D4B                 </span><span style="color:navy">inc     si
</span><span style="color:black">DOSCODE:4D4C                 </span><span style="color:navy">mov     ax, cx
</span><span style="color:black">DOSCODE:4D4E                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">3           </span>; AX has the actual length
<span style="color:black">DOSCODE:4D51                 </span><span style="color:navy">jmp     short </span>OK_RETN
<span style="color:black">DOSCODE:4D53 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4D53
DOSCODE:4D53 </span>CHKNLS<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4D53                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:4D55                 </span><span style="color:navy">mov     bp, ax
</span><span style="color:black">DOSCODE:4D57                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1400h
</span><span style="color:black">DOSCODE:4D5A                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; - Multiplex - NLSFUNC.COM - INSTALLATION CHECK
<span style="color:black">DOSCODE:4D5A                                         </span>; Return: AL = 00h not installed, OK to install
<span style="color:black">DOSCODE:4D5A                                         </span>; 01h not installed, not OK
<span style="color:black">DOSCODE:4D5A                                         </span>; FFh installed
<span style="color:black">DOSCODE:4D5C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:4D5E                 </span><span style="color:navy">jz      short </span><span style="color:gray">NLSNXT    </span>; in memory
<span style="color:black">DOSCODE:4D60
DOSCODE:4D60 </span>sizeerror<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4D60                 </span><span style="color:navy">jmp     short </span>capinval
<span style="color:black">DOSCODE:4D62 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4D62
DOSCODE:4D62 </span><span style="color:gray">NLSNXT</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4D62                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1402h
</span><span style="color:black">DOSCODE:4D65                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; - Multiplex - NLSFUNC.COM - GET COUNTRY INFO
<span style="color:black">DOSCODE:4D65                                         </span>; BP = subfunction, BX = code page
<span style="color:black">DOSCODE:4D65                                         </span>; DX = country code, DS:SI -&gt; internal code page structure
<span style="color:black">DOSCODE:4D65                                         </span>; ES:DI -&gt; user buffer, CX = size of user buffer
<span style="color:black">DOSCODE:4D65                                         </span>; Return: AL = status
<span style="color:black">DOSCODE:4D65                                         </span>; 00h successful
<span style="color:black">DOSCODE:4D65                                         </span>; else DOS error code
<span style="color:black">DOSCODE:4D67                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:4D69                 </span><span style="color:navy">jnz     short </span>NLSERROR
<span style="color:black">DOSCODE:4D6B                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">48h</span><span style="color:navy">]    </span>; [SI+DOS_CCDPG.ccSysCodePage]
<span style="color:black">DOSCODE:4D6E                 </span><span style="color:navy">jmp     short </span>GETDONE
<span style="color:black">DOSCODE:4D70 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4D70
DOSCODE:4D70 </span>NLSERROR<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4D70                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:black">DOSCODE:4D70 </span>$GetExtCntry    <span style="color:black">endp
DOSCODE:4D70
DOSCODE:4D73
DOSCODE:4D73 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4D73
DOSCODE:4D73
DOSCODE:4D73 </span>$GetSetCdPg     <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:4D73                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:4D74                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:4D75                 </span><span style="color:navy">mov     si, offset </span>COUNTRY_CDPG
<span style="color:black">DOSCODE:4D78                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1           </span>; get global code page
<span style="color:black">DOSCODE:4D7A                 </span><span style="color:navy">jnz     short </span>setglpg
<span style="color:black">DOSCODE:4D7C                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">6Ah</span><span style="color:navy">]    </span>; [SI+DOS_CCDPG.ccDosCodePage]
<span style="color:black">DOSCODE:4D7F                 </span><span style="color:navy">mov     dx, [si+</span><span style="color:#ff8000">48h</span><span style="color:navy">]    </span>; [SI+DOS_CCDPG.ccSysCodePage]
<span style="color:black">DOSCODE:4D82                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:black">DOSCODE:4D85                 </span><span style="color:navy">call    </span>set_user_bx
<span style="color:black">DOSCODE:4D88                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], dx      </span>; [SI+user_env.user_DX]
<span style="color:black">DOSCODE:4D8B
DOSCODE:4D8B </span>OK_RETURN<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4D8B                 </span><span style="color:navy">jmp     short </span>nono_jmp
<span style="color:black">DOSCODE:4D8D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4D8D
DOSCODE:4D8D </span>setglpg<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4D8D                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2           </span>; set global codepage
<span style="color:black">DOSCODE:4D8F                 </span><span style="color:navy">jnz     short </span>nomem
<span style="color:black">DOSCODE:4D91                 </span><span style="color:navy">mov     dx, [si+</span><span style="color:#ff8000">68h</span><span style="color:navy">]    </span>; [SI+DOS_CCDPG.ccDosCountry]
<span style="color:black">DOSCODE:4D94                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1400h
</span><span style="color:black">DOSCODE:4D97                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; - Multiplex - NLSFUNC.COM - INSTALLATION CHECK
<span style="color:black">DOSCODE:4D97                                         </span>; Return: AL = 00h not installed, OK to install
<span style="color:black">DOSCODE:4D97                                         </span>; 01h not installed, not OK
<span style="color:black">DOSCODE:4D97                                         </span>; FFh installed
<span style="color:black">DOSCODE:4D99                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:4D9B                 </span><span style="color:navy">jnz     short </span>nomem
<span style="color:black">DOSCODE:4D9D                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1401h
</span><span style="color:black">DOSCODE:4DA0                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; - Multiplex - NLSFUNC.COM - CHANGE CODE PAGE
<span style="color:black">DOSCODE:4DA0                                         </span>; DS:SI -&gt; internal code page structure
<span style="color:black">DOSCODE:4DA0                                         </span>; BX = new code page, DX = country code???
<span style="color:black">DOSCODE:4DA0                                         </span>; Return: AL = status
<span style="color:black">DOSCODE:4DA0                                         </span>; 00h successful
<span style="color:black">DOSCODE:4DA0                                         </span>; else DOS error code
<span style="color:black">DOSCODE:4DA2                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:4DA4                 </span><span style="color:navy">jz      short </span>OK_RETURN
<span style="color:black">DOSCODE:4DA6                 </span><span style="color:navy">cmp     al, </span><span style="color:green">65          </span>; set device code page failed
<span style="color:black">DOSCODE:4DA8                 </span><span style="color:navy">jnz     short </span>seterr
<span style="color:black">DOSCODE:4DAA                 </span><span style="color:navy">cbw
</span><span style="color:black">DOSCODE:4DAB                 </span><span style="color:navy">mov     </span>EXTERR<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:4DAE                 </span><span style="color:navy">mov     </span>EXTERR_ACTION<span style="color:navy">, </span><span style="color:#ff8000">6 </span>; errACT_Ignore
<span style="color:black">DOSCODE:4DB3                 </span><span style="color:navy">mov     </span>EXTERR_CLASS<span style="color:navy">, </span><span style="color:#ff8000">5 </span>; errCLASS_HrdFail
<span style="color:black">DOSCODE:4DB8                 </span><span style="color:navy">mov     </span>EXTERR_LOCUS<span style="color:navy">, </span><span style="color:#ff8000">4 </span>; errLOC_SerDev
<span style="color:black">DOSCODE:4DBD                 </span><span style="color:navy">jmp     </span>From_GetSet
<span style="color:black">DOSCODE:4DC0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4DC0
DOSCODE:4DC0 </span>seterr<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4DC0                 </span><span style="color:navy">jmp     short </span>NLSERROR  ; transfer SYS_RET_ERR
<span style="color:black">DOSCODE:4DC2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:4DC2
DOSCODE:4DC2 </span>nomem<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4DC2                 </span><span style="color:navy">jmp     short </span>sizeerror ; function not defined
<span style="color:black">DOSCODE:4DC2 </span>$GetSetCdPg     <span style="color:black">endp
DOSCODE:4DC2
</span><span style="color:maroon">DOSCODE:4DC4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4DC4
DOSCODE:4DC4 </span>$GET_DRIVE_FREESPACE<span style="color:navy">:                   </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:4DC4                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:4DC5                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:4DC6                 </span><span style="color:navy">mov     al, dl
</span><span style="color:maroon">DOSCODE:4DC8                 </span><span style="color:navy">call    </span>GETTHISDRV      ; Get drive
<span style="color:maroon">DOSCODE:4DCB                 </span><span style="color:navy">jb      short </span>BADFDRV   ; User FAILed to I 24
<span style="color:maroon">DOSCODE:4DCD                 </span><span style="color:navy">call    </span>DISK_INFO
<span style="color:maroon">DOSCODE:4DD0                 </span><span style="color:navy">jnb     short </span>gdrvfspc_1
<span style="color:maroon">DOSCODE:4DD2                 </span><span style="color:navy">xchg    dx, bx
</span><span style="color:maroon">DOSCODE:4DD4                 </span><span style="color:navy">jmp     short </span>BADFDRV
<span style="color:maroon">DOSCODE:4DD6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4DD6
DOSCODE:4DD6 </span>gdrvfspc_1<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4DD6                 </span><span style="color:navy">xor     ah, ah          </span>; Chuck Fat ID byte
<span style="color:maroon">DOSCODE:4DD8                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:4DD9                 </span><span style="color:navy">call    </span>TestNet
<span style="color:maroon">DOSCODE:4DDC                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:4DDD                 </span><span style="color:navy">jb      short </span>gdrvfspc_2
<span style="color:maroon">DOSCODE:4DDF                 </span><span style="color:navy">call    </span>modify_cluster_count ;
<span style="color:maroon">DOSCODE:4DDF                                         </span>; if hw of total clusters (di) &gt; 0
<span style="color:maroon">DOSCODE:4DDF                                         </span>; sectors per cluster and cluster counts
<span style="color:maroon">DOSCODE:4DDF                                         </span>; will be modified (shifted)
<span style="color:maroon">DOSCODE:4DDF                                         </span>; (but sectors per clust * clust count will be same)
<span style="color:maroon">DOSCODE:4DDF                                         </span>; /// disk size -calculation- limit = 2 GB ///
<span style="color:maroon">DOSCODE:4DE2
DOSCODE:4DE2 </span>gdrvfspc_2<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4DE2                 </span><span style="color:navy">xchg    dx, bx          </span>; bx = free clusters (after xchg)
<span style="color:maroon">DOSCODE:4DE4
DOSCODE:4DE4 </span>DoSt<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4DE4                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:4DE7                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], dx      </span>; [SI+user_env.user_DX] ; total clusters
<span style="color:maroon">DOSCODE:4DEA                 </span><span style="color:navy">jmp     </span>gdrvfspc_ret    ; ax = sectors per cluster (modified)
<span style="color:maroon">DOSCODE:4DED </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4DED
DOSCODE:4DED </span>BADFDRV<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4DED                 </span><span style="color:navy">call    </span>FCB_RET_ERR
<span style="color:maroon">DOSCODE:4DF0                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:maroon">DOSCODE:4DF3                 </span><span style="color:navy">jmp     short </span>DoSt
<span style="color:maroon">DOSCODE:4DF5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4DF5
DOSCODE:4DF5 </span>$GET_DMA<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:4DF5                 </span><span style="color:navy">mov     bx, word ptr ss:</span>DMAADD ; Get Disk Transfer Address
<span style="color:maroon">DOSCODE:4DFA                 </span><span style="color:navy">mov     cx, word ptr ss:</span>DMAADD<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:maroon">DOSCODE:4DFF                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:4E02                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">10h</span><span style="color:navy">], cx
</span><span style="color:maroon">DOSCODE:4E05                 </span><span style="color:navy">jmp     </span>set_user_bx
<span style="color:maroon">DOSCODE:4E08 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4E08
DOSCODE:4E08 </span>$SET_DMA<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:4E08                 </span><span style="color:navy">mov     word ptr ss:</span>DMAADD<span style="color:navy">, dx </span>; Set Disk Transfer Address
<span style="color:maroon">DOSCODE:4E0D                 </span><span style="color:navy">mov     word ptr ss:</span>DMAADD<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:4E12                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:4E13 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4E13
DOSCODE:4E13 </span>$GET_DEFAULT_DRIVE<span style="color:navy">:                     </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:4E13                 </span><span style="color:navy">mov     al, ss:</span>CURDRV
<span style="color:maroon">DOSCODE:4E17                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:4E18 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4E18
DOSCODE:4E18 </span>$SET_DEFAULT_DRIVE<span style="color:navy">:                     </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:4E18                 </span><span style="color:navy">mov     al, dl
</span><span style="color:maroon">DOSCODE:4E1A                 </span><span style="color:navy">inc     al              </span>; A=1, B=2...
<span style="color:maroon">DOSCODE:4E1C                 </span><span style="color:navy">call    </span>GetVisDrv       ; see if visible drive
<span style="color:maroon">DOSCODE:4E1F                 </span><span style="color:navy">jb      short </span>SETRET    ; errors do not set
<span style="color:maroon">DOSCODE:4E21                 </span><span style="color:navy">mov     ss:</span>CURDRV<span style="color:navy">, al   </span>; no, set
<span style="color:maroon">DOSCODE:4E25
DOSCODE:4E25 </span>SETRET<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4E25                 </span><span style="color:navy">mov     al, ss:</span>CDSCOUNT ; let user see what the count really is
<span style="color:maroon">DOSCODE:4E29                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4E2A
DOSCODE:4E2A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4E2A
DOSCODE:4E2A
DOSCODE:4E2A </span>$GET_INTERRUPT_VECTOR <span style="color:black">proc near         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4E2A                 </span><span style="color:navy">call    </span>RECSET
<span style="color:black">DOSCODE:4E2D                 </span><span style="color:navy">les     bx, es:[bx]
</span><span style="color:black">DOSCODE:4E30                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:black">DOSCODE:4E33
DOSCODE:4E33 </span>set_user_es_bx<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4E33                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">10h</span><span style="color:navy">], es </span>; [SI+user_env.user_ES]
<span style="color:black">DOSCODE:4E36                 </span><span style="color:navy">jmp     </span>set_user_bx
<span style="color:black">DOSCODE:4E36 </span>$GET_INTERRUPT_VECTOR <span style="color:black">endp
DOSCODE:4E36
</span><span style="color:maroon">DOSCODE:4E39 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4E39
DOSCODE:4E39 </span>$SET_INTERRUPT_VECTOR<span style="color:navy">:                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:4E39                 </span><span style="color:navy">call    </span>RECSET
<span style="color:maroon">DOSCODE:4E3C                 </span><span style="color:navy">cli
</span><span style="color:maroon">DOSCODE:4E3D                 </span><span style="color:navy">mov     es:[bx], dx
</span><span style="color:maroon">DOSCODE:4E40                 </span><span style="color:navy">mov     word ptr es:[bx+</span><span style="color:#ff8000">2</span><span style="color:navy">], ds
</span><span style="color:maroon">DOSCODE:4E44                 </span><span style="color:navy">sti
</span><span style="color:maroon">DOSCODE:4E45                 </span><span style="color:navy">test    ss:</span>DOS_FLAG<span style="color:navy">, </span><span style="color:green">4  </span>; EXECA20OF
<span style="color:maroon">DOSCODE:4E45                                         </span>; was the previous call an int 21h exec call ?
<span style="color:maroon">DOSCODE:4E4B                 </span><span style="color:navy">jnz     short </span>siv_1     ; yes
<span style="color:maroon">DOSCODE:4E4D                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:4E4E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4E4E
DOSCODE:4E4E </span>siv_1<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4E4E                 </span><span style="color:navy">cmp     ss:</span>A20OFF_COUNT<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:4E54                 </span><span style="color:navy">jnz     short </span>siv_2
<span style="color:maroon">DOSCODE:4E56                 </span><span style="color:navy">mov     ss:</span>A20OFF_COUNT<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; indicate to dos dispatcher to
<span style="color:maroon">DOSCODE:4E56                                         </span>; turn A20 Off before returning to user
<span style="color:maroon">DOSCODE:4E5C
DOSCODE:4E5C </span>siv_2<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4E5C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4E5D
DOSCODE:4E5D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:4E5D
DOSCODE:4E5D
DOSCODE:4E5D </span>RECSET          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:4E5D                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:4E5F                 </span><span style="color:navy">mov     es, bx
</span><span style="color:black">DOSCODE:4E61                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:4E61                 </span><span style="color:navy">mov     bl, al
</span><span style="color:black">DOSCODE:4E63                 </span><span style="color:navy">shl     bx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:4E65                 </span><span style="color:navy">shl     bx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:4E67                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:4E67 </span>RECSET          <span style="color:black">endp
DOSCODE:4E67
</span><span style="color:maroon">DOSCODE:4E68 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4E68
DOSCODE:4E68 </span>$CHAR_OPER<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:4E68                 </span><span style="color:navy">or      al, al          </span>; get switch?
<span style="color:maroon">DOSCODE:4E6A                 </span><span style="color:navy">mov     dl, &#039;</span><span style="color:green">/&#039;         </span>; assume yes
<span style="color:maroon">DOSCODE:4E6C                 </span><span style="color:navy">jz      short </span>chop_1    ; jump if yes
<span style="color:maroon">DOSCODE:4E6E                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2           </span>; check device availability?
<span style="color:maroon">DOSCODE:4E70                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">0FFh        </span>; -1 ; assume yes
<span style="color:maroon">DOSCODE:4E72                 </span><span style="color:navy">jz      short </span>chop_1    ; jump if yes
<span style="color:maroon">DOSCODE:4E74                 </span><span style="color:navy">retn                    </span>; otherwise just quit
<span style="color:maroon">DOSCODE:4E75 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4E75
DOSCODE:4E75 </span>chop_1<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4E75                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:4E78                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], dx      </span>; [SI+user_env.user_DX]
<span style="color:maroon">DOSCODE:4E78                                         </span>; store value for user
<span style="color:maroon">DOSCODE:4E7B                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:4E7C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4E7C
DOSCODE:4E7C </span>$GetExtendedError<span style="color:navy">:                      </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:4E7C                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:4E7D                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:4E7E                 </span><span style="color:navy">mov     ax, </span>EXTERR
<span style="color:maroon">DOSCODE:4E81                 </span><span style="color:navy">les     di, </span>EXTERRPT
<span style="color:maroon">DOSCODE:4E85                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:4E85                 </span><span style="color:navy">mov     bx, word ptr </span>EXTERR_ACTION ; BL = Action, BH = Class
<span style="color:maroon">DOSCODE:4E89                 </span><span style="color:navy">mov     ch, </span>EXTERR_LOCUS
<span style="color:maroon">DOSCODE:4E8D                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:4E90                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], di    </span>; [SI+user_env.user_DI]
<span style="color:maroon">DOSCODE:4E93                 </span><span style="color:navy">call    </span>set_user_es_bx
<span style="color:maroon">DOSCODE:4E96                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], cx      </span>; [SI+user_env.user_CX]
<span style="color:maroon">DOSCODE:4E99
DOSCODE:4E99 </span>_jmp_to_SYS_RET_OK<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4E99                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:4E9C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4E9C
DOSCODE:4E9C </span>$ECS_Call<span style="color:navy">:                              </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:4E9C                 </span><span style="color:navy">or      al, al
</span><span style="color:maroon">DOSCODE:4E9E                 </span><span style="color:navy">jnz     short </span>_okok
<span style="color:maroon">DOSCODE:4EA0                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:4EA3                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:green">8</span><span style="color:navy">], offset </span>DBCS_TAB_2 ; [SI+user_env.user_SI],
<span style="color:maroon">DOSCODE:4EA3                                         </span>; DBCS_TAB+2
<span style="color:maroon">DOSCODE:4EA8                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:4EA9                 </span><span style="color:navy">mov     es, cs:</span>DosDSeg
<span style="color:maroon">DOSCODE:4EAE                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:green">14</span><span style="color:navy">], es </span>; [SI+user_env.user_DS]
<span style="color:maroon">DOSCODE:4EB1                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:4EB2
DOSCODE:4EB2 </span>_okok<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4EB2                 </span><span style="color:navy">jmp     short </span>_jmp_to_SYS_RET_OK
<span style="color:maroon">DOSCODE:4EB4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4EB4
DOSCODE:4EB4 </span>$LONGNAME<span style="color:navy">:                              </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:4EB4                 </span><span style="color:navy">xor     al, al          </span>; longname functions are not supported
<span style="color:maroon">DOSCODE:4EB6
DOSCODE:4EB6 </span>lfn_error<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4EB6                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:4EB9                 </span><span style="color:navy">or      word ptr [si+</span><span style="color:#ff8000">16h</span><span style="color:navy">], </span><span style="color:green">1 </span>; [SI+user_env.user_F],f_Carry
<span style="color:maroon">DOSCODE:4EBD                 </span><span style="color:navy">stc
</span><span style="color:maroon">DOSCODE:4EBE                 </span><span style="color:navy">mov     [si], ax        </span>; [SI+user_env.user_ax]
<span style="color:maroon">DOSCODE:4EC0                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:4EC1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4EC1
DOSCODE:4EC1 </span>$FAT32EXT<span style="color:navy">:                              </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:4EC1                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5           </span>; INT 21h AX = 7305h
<span style="color:maroon">DOSCODE:4EC3                 </span><span style="color:navy">jbe     short </span>valid_fat32_ext_function
<span style="color:maroon">DOSCODE:4EC5                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; error_invalid_function
<span style="color:maroon">DOSCODE:4EC7
DOSCODE:4EC7 </span>fat32_ext_func_err<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4EC7                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:maroon">DOSCODE:4ECA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4ECA
DOSCODE:4ECA </span>function_5_invalid_cx<span style="color:navy">:                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4ECA                 </span><span style="color:navy">mov     al, </span><span style="color:green">57h         </span>; error_invalid_parameter
<span style="color:maroon">DOSCODE:4ECC
DOSCODE:4ECC </span>fat32_ext_func_err_j<span style="color:navy">:                   </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4ECC                 </span><span style="color:navy">jmp     short </span>fat32_ext_func_err
<span style="color:maroon">DOSCODE:4ECE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4ECE
DOSCODE:4ECE </span>valid_fat32_ext_function<span style="color:navy">:               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4ECE                 </span><span style="color:navy">jnz     short </span>not_function_5
<span style="color:maroon">DOSCODE:4ED0                 </span><span style="color:navy">cmp     cx, </span><span style="color:green">0FFFFh      </span>; Function 5 - FAT32 - EXTENDED ABSOLUTE DISK READ/WRITE
<span style="color:maroon">DOSCODE:4ED3                 </span><span style="color:navy">jnz     short </span>function_5_invalid_cx
<span style="color:maroon">DOSCODE:4ED5                 </span><span style="color:navy">test    si, </span><span style="color:green">9FFEh       </span>; read/write mode flags
<span style="color:maroon">DOSCODE:4ED9                 </span><span style="color:navy">jnz     short </span>function_5_invalid_cx
<span style="color:maroon">DOSCODE:4EDB                 </span><span style="color:navy">mov     al, dl          </span>; drive number, 1 = A
<span style="color:maroon">DOSCODE:4EDD                 </span><span style="color:navy">dec     al
</span><span style="color:maroon">DOSCODE:4EDF                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:4EE1                 </span><span style="color:navy">test    si, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:4EE5                 </span><span style="color:navy">jz      short </span>function_5_read
<span style="color:maroon">DOSCODE:4EE7                 </span><span style="color:navy">call    near ptr </span>FAT32_ABSDWRT ; INT 21h AX = 7305h (SI bit 0 = 1)
<span style="color:maroon">DOSCODE:4EEA                 </span><span style="color:navy">jmp     short </span>fat32_absdrw_ret
<span style="color:maroon">DOSCODE:4EEC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4EEC
DOSCODE:4EEC </span>function_5_read<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4EEC                 </span><span style="color:navy">call    </span>FAT32_ABSDRD    ; INT 21h AX = 7305h (SI bit 0 = 0)
<span style="color:maroon">DOSCODE:4EEF
DOSCODE:4EEF </span>fat32_absdrw_ret<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4EEF                 </span><span style="color:navy">jb      short </span>lfn_error
<span style="color:maroon">DOSCODE:4EF1                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:4EF4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4EF4
DOSCODE:4EF4 </span>not_function_5<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4EF4                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3
</span><span style="color:maroon">DOSCODE:4EF6                 </span><span style="color:navy">jz      short </span>function_73_3 ; Function 3 - FAT32 - GET EXTENDED FREE SPACE ON DRIVE
<span style="color:maroon">DOSCODE:4EF8                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2
</span><span style="color:maroon">DOSCODE:4EFA                 </span><span style="color:navy">jb      short </span>chk_drive_lock_flush
<span style="color:maroon">DOSCODE:4EFC                 </span><span style="color:navy">jmp     </span>$GET_DPB        ; Function 2 - FAT32 - &quot;Get_ExtDPB&quot; - GET EXTENDED DPB
<span style="color:maroon">DOSCODE:4EFC                                         </span>; Function 4 - FAT32 - Set DPB TO USE FOR FORMATTING
<span style="color:maroon">DOSCODE:4EFF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4EFF
DOSCODE:4EFF </span>chk_drive_lock_flush<span style="color:navy">:                   </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4EFF                 </span><span style="color:navy">cmp     dl, </span><span style="color:green">26          </span>; MSDOS 7 - DRIVE LOCKING AND FLUSHING
<span style="color:maroon">DOSCODE:4F02                 </span><span style="color:navy">jbe     short </span>drv_lock_flush_1
<span style="color:maroon">DOSCODE:4F04                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Fh         </span>; invalid drive number
<span style="color:maroon">DOSCODE:4F06
DOSCODE:4F06 </span>drv_lock_flush_err<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4F06                 </span><span style="color:navy">jmp     short </span>fat32_ext_func_err_j ; ax = error code
<span style="color:maroon">DOSCODE:4F08 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4F08
DOSCODE:4F08 </span>drv_lock_flush_1<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4F08                 </span><span style="color:navy">dec     dl
</span><span style="color:maroon">DOSCODE:4F0A                 </span><span style="color:navy">jns     short </span>drv_lock_flush_2
<span style="color:maroon">DOSCODE:4F0C                 </span><span style="color:navy">mov     dl, ss:</span>CURDRV   ; 0 = default/current drive)
<span style="color:maroon">DOSCODE:4F11
DOSCODE:4F11 </span>drv_lock_flush_2<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4F11                 </span><span style="color:navy">mov     dh, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:4F13                 </span><span style="color:navy">mov     bx, dx
</span><span style="color:maroon">DOSCODE:4F15                 </span><span style="color:navy">cmp     cl, </span><span style="color:#ff8000">1           </span>; which flag to get or set
<span style="color:maroon">DOSCODE:4F18                 </span><span style="color:navy">jbe     short </span>drv_lock_flush_3
<span style="color:maroon">DOSCODE:4F1A                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; error_invalid_function
<span style="color:maroon">DOSCODE:4F1C                 </span><span style="color:navy">jmp     short </span>drv_lock_flush_err
<span style="color:maroon">DOSCODE:4F1E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4F1E
DOSCODE:4F1E </span>drv_lock_flush_3<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4F1E                 </span><span style="color:navy">mov     ah, ss:</span>drive_flags<span style="color:navy">[bx]
</span><span style="color:maroon">DOSCODE:4F23                 </span><span style="color:navy">or      cl, cl
</span><span style="color:maroon">DOSCODE:4F25                 </span><span style="color:navy">jz      short </span>get_set_indctd_flag ; use bit 1 and bit 2
<span style="color:maroon">DOSCODE:4F27                 </span><span style="color:navy">or      al, al          </span>; get drive&#039;s dirty-buffers flag
<span style="color:maroon">DOSCODE:4F29                 </span><span style="color:navy">jz      short </span>get_dirty_buf_flag ; use bit 3
<span style="color:maroon">DOSCODE:4F2B                 </span><span style="color:navy">and     ah, </span><span style="color:green">0F7h        </span>; clear bit 3
<span style="color:maroon">DOSCODE:4F2E                 </span><span style="color:navy">and     ch, </span><span style="color:green">8           </span>; izolate bit 3 of the new flag value
<span style="color:maroon">DOSCODE:4F31                 </span><span style="color:navy">or      ah, ch          </span>; set AH bit 3 according to CH bit 3
<span style="color:maroon">DOSCODE:4F33                 </span><span style="color:navy">mov     ss:</span>drive_flags<span style="color:navy">[bx], ah </span>; set or reset dirty buffer flag
<span style="color:maroon">DOSCODE:4F38                 </span><span style="color:navy">test    ah, </span><span style="color:green">8
</span><span style="color:maroon">DOSCODE:4F3B                 </span><span style="color:navy">jnz     short </span>set_dirty_flag_ok ; bit 3 is set/1
<span style="color:maroon">DOSCODE:4F3D                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:4F3F                 </span><span style="color:navy">call    </span>FLUSHBUF
<span style="color:maroon">DOSCODE:4F42
DOSCODE:4F42 </span>set_dirty_flag_ok<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4F42                 </span><span style="color:navy">jmp     short </span>jmp_to_SYS_RET_OK
<span style="color:maroon">DOSCODE:4F44 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4F44
DOSCODE:4F44 </span>get_dirty_buf_flag<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4F44                 </span><span style="color:navy">and     ah, </span><span style="color:green">8           </span>; izolate dirty buffers flag
<span style="color:maroon">DOSCODE:4F47                 </span><span style="color:navy">jmp     short </span>mov_flag_cl_to_al ; AH = new flag and 08h (bit 3 used)
<span style="color:maroon">DOSCODE:4F49 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4F49
DOSCODE:4F49 </span>get_set_indctd_flag<span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4F49                 </span><span style="color:navy">or      al, al
</span><span style="color:maroon">DOSCODE:4F4B                 </span><span style="color:navy">jz      short </span>get_indicated_flag
<span style="color:maroon">DOSCODE:4F4D                 </span><span style="color:navy">and     ah, </span><span style="color:green">0F9h        </span>; clear bit 1 and bit 2
<span style="color:maroon">DOSCODE:4F50                 </span><span style="color:navy">test    ch, </span><span style="color:green">2           </span>; new value for indicated flag
<span style="color:maroon">DOSCODE:4F53                 </span><span style="color:navy">jz      short </span>reset_indctd_flags ; bit 1 is zero
<span style="color:maroon">DOSCODE:4F55                 </span><span style="color:navy">or      ah, </span><span style="color:green">6           </span>; set bit 1 and bit 2
<span style="color:maroon">DOSCODE:4F58
DOSCODE:4F58 </span>reset_indctd_flags<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4F58                 </span><span style="color:navy">mov     ss:</span>drive_flags<span style="color:navy">[bx], ah
</span><span style="color:maroon">DOSCODE:4F5D                 </span><span style="color:navy">jmp     short </span>jmp_to_SYS_RET_OK
<span style="color:maroon">DOSCODE:4F5F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4F5F
DOSCODE:4F5F </span>get_indicated_flag<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4F5F                 </span><span style="color:navy">and     ah, </span><span style="color:green">6           </span>; AH = new flag and 06h (bits 1 and 2 used)
<span style="color:maroon">DOSCODE:4F62
DOSCODE:4F62 </span>mov_flag_cl_to_al<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4F62                 </span><span style="color:navy">mov     al, cl          </span>; value of CL on entry
<span style="color:maroon">DOSCODE:4F64
DOSCODE:4F64 </span>ret_ax_to_user_cx<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4F64                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:4F67                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], ax      </span>; [SI+user_env.user_cx] ; requested flag
<span style="color:maroon">DOSCODE:4F6A
DOSCODE:4F6A </span>jmp_to_SYS_RET_OK<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4F6A                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:4F6D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4F6D
DOSCODE:4F6D </span>function_73_3<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4F6D                 </span><span style="color:navy">mov     si, dx          </span>; FAT32 - GET EXTENDED FREE SPACE ON DRIVE
<span style="color:maroon">DOSCODE:4F6D                                         </span>; AX = 7303h
<span style="color:maroon">DOSCODE:4F6D                                         </span>; DS:DX -&gt; ASCIZ string for drive (&quot;C:\&quot; or &quot;\\SERVER\Share&quot;)
<span style="color:maroon">DOSCODE:4F6D                                         </span>; ES:DI -&gt; buffer for extended free space structure
<span style="color:maroon">DOSCODE:4F6D                                         </span>; CX = length of buffer for extended free space
<span style="color:maroon">DOSCODE:4F6F                 </span><span style="color:navy">call    </span>DriveFromText
<span style="color:maroon">DOSCODE:4F72                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:maroon">DOSCODE:4F73                 </span><span style="color:navy">lodsw
</span><span style="color:maroon">DOSCODE:4F74                 </span><span style="color:navy">dec     dl
</span><span style="color:maroon">DOSCODE:4F76                 </span><span style="color:navy">cmp     dl, </span><span style="color:green">26
</span><span style="color:maroon">DOSCODE:4F79                 </span><span style="color:navy">jnb     short </span>func_73_3_err2
<span style="color:maroon">DOSCODE:4F7B                 </span><span style="color:navy">or      ah, ah
</span><span style="color:maroon">DOSCODE:4F7D                 </span><span style="color:navy">jnz     short </span>func_73_3_err2
<span style="color:maroon">DOSCODE:4F7F                 </span><span style="color:navy">call    </span>PATHCHRCMP
<span style="color:maroon">DOSCODE:4F82                 </span><span style="color:navy">jnz     short </span>func_73_3_err2
<span style="color:maroon">DOSCODE:4F84                 </span><span style="color:navy">inc     dl
</span><span style="color:maroon">DOSCODE:4F86                 </span><span style="color:navy">cmp     cx, </span><span style="color:green">44          </span>; buffer (Structure) size must be 44
<span style="color:maroon">DOSCODE:4F89                 </span><span style="color:navy">jb      short </span>func_73_3_err4
<span style="color:maroon">DOSCODE:4F8B                 </span><span style="color:navy">cmp     word ptr es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; buffer structure version (must be 0)
<span style="color:maroon">DOSCODE:4F90                 </span><span style="color:navy">jnz     short </span>func_73_3_err3
<span style="color:maroon">DOSCODE:4F92                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:4F93                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:4F94                 </span><span style="color:navy">mov     al, dl
</span><span style="color:maroon">DOSCODE:4F96                 </span><span style="color:navy">call    </span>GETTHISDRV
<span style="color:maroon">DOSCODE:4F99                 </span><span style="color:navy">jnb     short </span>fill_efs_struc_b
<span style="color:maroon">DOSCODE:4F9B
DOSCODE:4F9B </span>func_73_3_err1<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4F9B                 </span><span style="color:navy">call    </span>FCB_RET_ERR
<span style="color:maroon">DOSCODE:4F9E
DOSCODE:4F9E </span>func_73_3_err2<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4F9E                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Fh         </span>; error_invalid_drive
<span style="color:maroon">DOSCODE:4FA0
DOSCODE:4FA0 </span>jmp_to_SYS_RET_ERR<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4FA0                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:maroon">DOSCODE:4FA3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4FA3
DOSCODE:4FA3 </span>func_73_3_err3<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4FA3                 </span><span style="color:navy">mov     al, </span><span style="color:green">57h         </span>; error_invalid_parameter
<span style="color:maroon">DOSCODE:4FA5
DOSCODE:4FA5 </span>jmp_to_jmp_SYS_RET_ERR<span style="color:navy">:                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4FA5                 </span><span style="color:navy">jmp     short </span>jmp_to_SYS_RET_ERR
<span style="color:maroon">DOSCODE:4FA7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4FA7
DOSCODE:4FA7 </span>func_73_3_err4<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4FA7                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">18h         </span>; error_bad_length
<span style="color:maroon">DOSCODE:4FA9                 </span><span style="color:navy">jmp     short </span>jmp_to_jmp_SYS_RET_ERR
<span style="color:maroon">DOSCODE:4FAB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:4FAB
DOSCODE:4FAB </span>fill_efs_struc_b<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4FAB                 </span><span style="color:navy">call    </span>DISK_INFO
<span style="color:maroon">DOSCODE:4FAE                 </span><span style="color:navy">jb      short </span>func_73_3_err1
<span style="color:maroon">DOSCODE:4FB0                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:maroon">DOSCODE:4FB2                 </span><span style="color:navy">push    si              </span>; si:dx = free cluster count
<span style="color:maroon">DOSCODE:4FB3                 </span><span style="color:navy">push    di              </span>; di:bx = number of clusters
<span style="color:maroon">DOSCODE:4FB4                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:4FB7                 </span><span style="color:navy">mov     es, word ptr [si+</span><span style="color:#ff8000">10h</span><span style="color:navy">] </span>; user&#039;s buffer segment (in ES)
<span style="color:maroon">DOSCODE:4FBA                 </span><span style="color:navy">mov     di, [si+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">]    </span>; user&#039;s buffer offset/address (in DI)
<span style="color:maroon">DOSCODE:4FBD                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">10h</span><span style="color:navy">], bx </span>; total number of clusters on the drive
<span style="color:maroon">DOSCODE:4FC1                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">20h</span><span style="color:navy">], bx </span>; total allocation units, without adjustment for compression
<span style="color:maroon">DOSCODE:4FC5                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:4FC6                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">12h</span><span style="color:navy">], bx </span>; total number of clusters on the drive, hw
<span style="color:maroon">DOSCODE:4FCA                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">22h</span><span style="color:navy">], bx </span>; total allocation units, hw
<span style="color:maroon">DOSCODE:4FCE                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">], dx </span>; number of available clusters
<span style="color:maroon">DOSCODE:4FD2                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">1Ch</span><span style="color:navy">], dx </span>; number of available allocation units, without adjustment
<span style="color:maroon">DOSCODE:4FD6                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:4FD7                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], dx </span>; number of available clusters, hw
<span style="color:maroon">DOSCODE:4FDB                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">1Eh</span><span style="color:navy">], dx </span>; number of available allocation units, hw
<span style="color:maroon">DOSCODE:4FDF                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">8</span><span style="color:navy">], cx   </span>; bytes per sector
<span style="color:maroon">DOSCODE:4FE3                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], ax   </span>; sectors per cluster (with adjustment for compression)
<span style="color:maroon">DOSCODE:4FE7                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:maroon">DOSCODE:4FE9                 </span><span style="color:navy">mul     bx              </span>; 32 bit multiplication
<span style="color:maroon">DOSCODE:4FEB                 </span><span style="color:navy">jb      short </span>dsk_cap_calc_overf ; disk capacity calculation overflow error
<span style="color:maroon">DOSCODE:4FED                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:maroon">DOSCODE:4FEF                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">20h</span><span style="color:navy">] </span>; total allocation units, lw
<span style="color:maroon">DOSCODE:4FF3                 </span><span style="color:navy">mul     cx
</span><span style="color:maroon">DOSCODE:4FF5                 </span><span style="color:navy">add     dx, bx
</span><span style="color:maroon">DOSCODE:4FF7                 </span><span style="color:navy">jnb     short </span>dsk_cap_calc_ok
<span style="color:maroon">DOSCODE:4FF9
DOSCODE:4FF9 </span>dsk_cap_calc_overf<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4FF9                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh      </span>; set to 0FFFFFFFFh
<span style="color:maroon">DOSCODE:4FFC                 </span><span style="color:navy">mov     dx, ax
</span><span style="color:maroon">DOSCODE:4FFE
DOSCODE:4FFE </span>dsk_cap_calc_ok<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:4FFE                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">1Ah</span><span style="color:navy">], dx
</span><span style="color:maroon">DOSCODE:5002                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">18h</span><span style="color:navy">], ax </span>; total number of physical sectors on the drive,
<span style="color:maroon">DOSCODE:5002                                         </span>; without adjustment for compression
<span style="color:maroon">DOSCODE:5006                 </span><span style="color:navy">mov     ax, cx          </span>; 32 bit multiplication
<span style="color:maroon">DOSCODE:5008                 </span><span style="color:navy">mul     word ptr es:[di+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">] </span>; number of available clusters, hw
<span style="color:maroon">DOSCODE:500C                 </span><span style="color:navy">jb      short </span>dsk_free_calc_overf
<span style="color:maroon">DOSCODE:500E                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:maroon">DOSCODE:5010                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">] </span>; number of available clusters, lw
<span style="color:maroon">DOSCODE:5014                 </span><span style="color:navy">mul     cx
</span><span style="color:maroon">DOSCODE:5016                 </span><span style="color:navy">add     dx, bx
</span><span style="color:maroon">DOSCODE:5018                 </span><span style="color:navy">jnb     short </span>dsk_free_calc_ok
<span style="color:maroon">DOSCODE:501A
DOSCODE:501A </span>dsk_free_calc_overf<span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:501A                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:501D                 </span><span style="color:navy">mov     dx, ax
</span><span style="color:maroon">DOSCODE:501F
DOSCODE:501F </span>dsk_free_calc_ok<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:501F                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">16h</span><span style="color:navy">], dx </span>; hw
<span style="color:maroon">DOSCODE:5023                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">14h</span><span style="color:navy">], ax </span>; number of physical sectors available on the drive,
<span style="color:maroon">DOSCODE:5023                                         </span>; without adjustment for compression
<span style="color:maroon">DOSCODE:5027                 </span><span style="color:navy">xor     ax, ax          </span>; 0
<span style="color:maroon">DOSCODE:5029                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], ax </span>; number of bytes per sector, high word = 0
<span style="color:maroon">DOSCODE:502D                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">6</span><span style="color:navy">], ax   </span>; number of sectors per cluster, high word = 0
<span style="color:maroon">DOSCODE:5031                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">24h</span><span style="color:navy">], ax </span>; reserved, 8 bytes zero
<span style="color:maroon">DOSCODE:5035                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">26h</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:5039                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">28h</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:503D                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">2Ah</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:5041                 </span><span style="color:navy">mov     ax, </span><span style="color:green">44
</span><span style="color:maroon">DOSCODE:5044                 </span><span style="color:navy">mov     es:[di], ax     </span>; size of returned structure = 44
<span style="color:maroon">DOSCODE:5047                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:504A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:504A
DOSCODE:504A </span>Set_DPBforFormat<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:504A                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">24 </span>; [SI+user_env.user_CX]
<span style="color:maroon">DOSCODE:504A                                         </span>; size of buffer (must be at least 18h)
<span style="color:maroon">DOSCODE:504E                 </span><span style="color:navy">jnb     short </span>setdpbf_2
<span style="color:maroon">DOSCODE:5050                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">18h         </span>; error_bad_length
<span style="color:maroon">DOSCODE:5052
DOSCODE:5052 </span>setdpbf_1<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5052                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:maroon">DOSCODE:5055 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5055
DOSCODE:5055 </span>setdpbf_2<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5055                 </span><span style="color:navy">push    es              </span>; ES:BP = Drive parameter block
<span style="color:maroon">DOSCODE:5056                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">DOSCODE:5057                 </span><span style="color:navy">mov     es, word ptr [si+</span><span style="color:#ff8000">10h</span><span style="color:navy">] </span>; [SI+user_env.user_ES]
<span style="color:maroon">DOSCODE:505A                 </span><span style="color:navy">mov     di, [si+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">]    </span>; [SI+user_env.user_DI]
<span style="color:maroon">DOSCODE:505D                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:505E                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:505F                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:505F                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; (call) function number
<span style="color:maroon">DOSCODE:5063                 </span><span style="color:navy">cmp     word ptr es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; structure version (must be 0)
<span style="color:maroon">DOSCODE:5068                 </span><span style="color:navy">jnz     short </span>setdpbf_3
<span style="color:maroon">DOSCODE:506A                 </span><span style="color:navy">cmp     word ptr es:[di+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; (must be 0)
<span style="color:maroon">DOSCODE:506F                 </span><span style="color:navy">jnz     short </span>setdpbf_3
<span style="color:maroon">DOSCODE:5071                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">4           </span>; (max) 5 functions (0 to 4)
<span style="color:maroon">DOSCODE:5074                 </span><span style="color:navy">jbe     short </span>setdpbf_4
<span style="color:maroon">DOSCODE:5076
DOSCODE:5076 </span>setdpbf_3<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5076                 </span><span style="color:navy">mov     al, </span><span style="color:green">57h         </span>; error_invalid_parameter
<span style="color:maroon">DOSCODE:5078                 </span><span style="color:navy">jmp     short </span>setdpbf_1
<span style="color:maroon">DOSCODE:507A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:507A
DOSCODE:507A </span>setdpbf_4<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:507A                 </span><span style="color:navy">mov     word ptr es:[di], </span><span style="color:#ff8000">18h </span>; (call) size
<span style="color:maroon">DOSCODE:507F                 </span><span style="color:navy">or      al, al
</span><span style="color:maroon">DOSCODE:5081                 </span><span style="color:navy">jz      short </span>setdpbf_5 ; invalidate DPB counts
<span style="color:maroon">DOSCODE:5083                 </span><span style="color:navy">jmp     </span>setdpbf_18
<span style="color:maroon">DOSCODE:5086 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5086
DOSCODE:5086 </span>setdpbf_5<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5086                 </span><span style="color:navy">xor     dx, dx          </span>; 0
<span style="color:maroon">DOSCODE:5088                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">]    </span>; DPB.MAX_CLUSTER
<span style="color:maroon">DOSCODE:508B                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; DPB.FAT_SIZE
<span style="color:maroon">DOSCODE:508F                 </span><span style="color:navy">jnz     short </span>setdpbf_6 ; not FAT32
<span style="color:maroon">DOSCODE:5091                 </span><span style="color:navy">mov     dx, [si+</span><span style="color:#ff8000">2Fh</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:5094                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">]    </span>; DPB.LAST_CLUSTER
<span style="color:maroon">DOSCODE:5097
DOSCODE:5097 </span>setdpbf_6<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5097                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:509B                 </span><span style="color:navy">mov     cx, es:[di+</span><span style="color:#ff8000">8</span><span style="color:navy">]   </span>; new DPB free count
<span style="color:maroon">DOSCODE:509B                                         </span>; (00000000h=no change, FFFFFFFFh=unknown)
<span style="color:maroon">DOSCODE:509F                 </span><span style="color:navy">or      ax, ax
</span><span style="color:maroon">DOSCODE:50A1                 </span><span style="color:navy">jnz     short </span>setdpbf_7
<span style="color:maroon">DOSCODE:50A3                 </span><span style="color:navy">jcxz    short </span>setdpbf_11
<span style="color:maroon">DOSCODE:50A5
DOSCODE:50A5 </span>setdpbf_7<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:50A5                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:50A8                 </span><span style="color:navy">jnz     short </span>setdpbf_8
<span style="color:maroon">DOSCODE:50AA                 </span><span style="color:navy">cmp     cx, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:50AD                 </span><span style="color:navy">jz      short </span>setdpbf_10 ; (set as UNKNOWN/INITIAL)
<span style="color:maroon">DOSCODE:50AF
DOSCODE:50AF </span>setdpbf_8<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:50AF                 </span><span style="color:navy">cmp     ax, dx          </span>; must be &lt; DPB.LAST_CLUSTER
<span style="color:maroon">DOSCODE:50B1                 </span><span style="color:navy">jnz     short </span>setdpbf_9
<span style="color:maroon">DOSCODE:50B3                 </span><span style="color:navy">cmp     cx, bx
</span><span style="color:maroon">DOSCODE:50B5
DOSCODE:50B5 </span>setdpbf_9<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:50B5                 </span><span style="color:navy">jnb     short </span>setdpbf_3
<span style="color:maroon">DOSCODE:50B7
DOSCODE:50B7 </span>setdpbf_10<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:50B7                 </span><span style="color:navy">or      byte ptr [si+</span><span style="color:#ff8000">18h</span><span style="color:navy">], </span><span style="color:green">1 </span>; DPB.FIRST_ACCESS (bit 0 = 1)
<span style="color:maroon">DOSCODE:50BB                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], cx    </span>; DPB.FREE_CNT
<span style="color:maroon">DOSCODE:50BE                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; DP.FAT_SIZE
<span style="color:maroon">DOSCODE:50C2                 </span><span style="color:navy">jnz     short </span>setdpbf_11 ; FAT12 or FAT16
<span style="color:maroon">DOSCODE:50C4                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">21h</span><span style="color:navy">], ax    </span>; DPB.FREE_CNT_HW
<span style="color:maroon">DOSCODE:50C7
DOSCODE:50C7 </span>setdpbf_11<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:50C7                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:50CB                 </span><span style="color:navy">mov     cx, es:[di+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">] </span>; new DPB next-free
<span style="color:maroon">DOSCODE:50CB                                         </span>; (00000000h=no change, FFFFFFFFh=unknown)
<span style="color:maroon">DOSCODE:50CF                 </span><span style="color:navy">or      ax, ax
</span><span style="color:maroon">DOSCODE:50D1                 </span><span style="color:navy">jnz     short </span>setdpbf_12
<span style="color:maroon">DOSCODE:50D3                 </span><span style="color:navy">jcxz    short </span>setdpbf_17
<span style="color:maroon">DOSCODE:50D5
DOSCODE:50D5 </span>setdpbf_12<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:50D5                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:50D8                 </span><span style="color:navy">jnz     short </span>setdpbf_13
<span style="color:maroon">DOSCODE:50DA                 </span><span style="color:navy">cmp     cx, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:50DD                 </span><span style="color:navy">jz      short </span>setdpbf_16 ; (set as UNKNOWN/INITIAL)
<span style="color:maroon">DOSCODE:50DF
DOSCODE:50DF </span>setdpbf_13<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:50DF                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">0           </span>; must be &gt;= 2
<span style="color:maroon">DOSCODE:50E2                 </span><span style="color:navy">jnz     short </span>setdpbf_14
<span style="color:maroon">DOSCODE:50E4                 </span><span style="color:navy">cmp     cx, </span><span style="color:#ff8000">2
</span><span style="color:maroon">DOSCODE:50E7
DOSCODE:50E7 </span>setdpbf_14<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:50E7                 </span><span style="color:navy">jb      short </span>setdpbf_3
<span style="color:maroon">DOSCODE:50E9                 </span><span style="color:navy">cmp     ax, dx          </span>; must be &lt; DPB.LAST_CLUSTER
<span style="color:maroon">DOSCODE:50EB                 </span><span style="color:navy">jnz     short </span>setdpbf_15
<span style="color:maroon">DOSCODE:50ED                 </span><span style="color:navy">cmp     cx, bx
</span><span style="color:maroon">DOSCODE:50EF
DOSCODE:50EF </span>setdpbf_15<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:50EF                 </span><span style="color:navy">ja      short </span>setdpbf_3
<span style="color:maroon">DOSCODE:50F1
DOSCODE:50F1 </span>setdpbf_16<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:50F1                 </span><span style="color:navy">or      byte ptr [si+</span><span style="color:#ff8000">18h</span><span style="color:navy">], </span><span style="color:green">1 </span>; DPB.FIRST_ACCESS (bit 0 = 1)
<span style="color:maroon">DOSCODE:50F5                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">], cx    </span>; DPB.NEXT_FREE
<span style="color:maroon">DOSCODE:50F8                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; DPB.FAT_SIZE
<span style="color:maroon">DOSCODE:50FC                 </span><span style="color:navy">jnz     short </span>setdpbf_17 ; FAT16 or FAT12
<span style="color:maroon">DOSCODE:50FE                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">3Bh</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:5101                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">39h</span><span style="color:navy">], cx    </span>; DPB.FAT32_NXTFREE
<span style="color:maroon">DOSCODE:5104
DOSCODE:5104 </span>setdpbf_17<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5104                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">7304h       </span>; done (successful)
<span style="color:maroon">DOSCODE:5107                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:510A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:510A
DOSCODE:510A </span>setdpbf_18<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:510A                 </span><span style="color:navy">dec     al
</span><span style="color:maroon">DOSCODE:510C                 </span><span style="color:navy">jnz     short </span>setdpbf_19
<span style="color:maroon">DOSCODE:510E                 </span><span style="color:navy">push    ds              </span>; rebuild DPB from BPB
<span style="color:maroon">DOSCODE:510F                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:5110                 </span><span style="color:navy">lds     si, es:[di+</span><span style="color:#ff8000">8</span><span style="color:navy">]   </span>; BIOS Parameter Block
<span style="color:maroon">DOSCODE:5114                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSCODE:5115                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:5116                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4558h       </span>; &#039;XE&#039; (NASM syntax)
<span style="color:maroon">DOSCODE:5119                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">4152h       </span>; &#039;RA&#039; (NASM syntax)
<span style="color:maroon">DOSCODE:511C                 </span><span style="color:navy">call    </span>$SETDPB
<span style="color:maroon">DOSCODE:511F                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:5122 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5122
DOSCODE:5122 </span>setdpbf_19<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5122                 </span><span style="color:navy">dec     al
</span><span style="color:maroon">DOSCODE:5124                 </span><span style="color:navy">jnz     short </span>setdpbf_20 ;
<span style="color:maroon">DOSCODE:5124                                         </span>; force media change
<span style="color:maroon">DOSCODE:5124                                         </span>; (next access to drive rebuild DPB)
<span style="color:maroon">DOSCODE:5126                 </span><span style="color:navy">or      byte ptr [si+</span><span style="color:#ff8000">18h</span><span style="color:navy">], </span><span style="color:green">80h </span>; DPB.FIRST_ACCESS (bit 7 = 1)
<span style="color:maroon">DOSCODE:512A                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:512D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:512D
DOSCODE:512D </span>setdpbf_20<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:512D                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; DPB.FAT_SIZE
<span style="color:maroon">DOSCODE:5131                 </span><span style="color:navy">jz      short </span>setdpbf_22 ; FAT32
<span style="color:maroon">DOSCODE:5133                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Fh         </span>; error_invalid_drive
<span style="color:maroon">DOSCODE:5133                                         </span>; (function 3 or 4 are only for drives with FAT32 fs)
<span style="color:maroon">DOSCODE:5135
DOSCODE:5135 </span>setdpbf_21<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5135                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:maroon">DOSCODE:5138 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5138
DOSCODE:5138 </span>setdpbf_22<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5138                 </span><span style="color:navy">dec     al
</span><span style="color:maroon">DOSCODE:513A                 </span><span style="color:navy">jz      short </span>setdpbf_30 ; get/set active FAT number and mirroring
<span style="color:maroon">DOSCODE:513C                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">35h</span><span style="color:navy">]    </span>; get/set root directory cluster number
<span style="color:maroon">DOSCODE:513C                                         </span>; DPB.ROOT_CLUSTER
<span style="color:maroon">DOSCODE:513F                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">], ax </span>; (ret) previous root directory cluster number
<span style="color:maroon">DOSCODE:5143                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">37h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:5146                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:514A                 </span><span style="color:navy">mov     cx, es:[di+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:514E                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">8</span><span style="color:navy">]   </span>; (call) new root directory cluster number
<span style="color:maroon">DOSCODE:5152                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh      </span>; -1 --&gt; return only previous root dir cluster number
<span style="color:maroon">DOSCODE:5155                 </span><span style="color:navy">jnz     short </span>setdpbf_23
<span style="color:maroon">DOSCODE:5157                 </span><span style="color:navy">cmp     cx, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:515A                 </span><span style="color:navy">jz      short </span>setdpbf_29
<span style="color:maroon">DOSCODE:515C
DOSCODE:515C </span>setdpbf_23<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:515C                 </span><span style="color:navy">cmp     cx, </span><span style="color:#ff8000">0           </span>; cluster number must be &gt;= 2
<span style="color:maroon">DOSCODE:515F                 </span><span style="color:navy">jnz     short </span>setdpbf_24
<span style="color:maroon">DOSCODE:5161                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">2
</span><span style="color:maroon">DOSCODE:5164
DOSCODE:5164 </span>setdpbf_24<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5164                 </span><span style="color:navy">jnb     short </span>setdpbf_26
<span style="color:maroon">DOSCODE:5166
DOSCODE:5166 </span>setdpbf_25<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5166                 </span><span style="color:navy">jmp     </span>setdpbf_3       ; error (invalid parameter)
<span style="color:maroon">DOSCODE:5169 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5169
DOSCODE:5169 </span>setdpbf_26<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5169                 </span><span style="color:navy">cmp     cx, [si+</span><span style="color:#ff8000">2Fh</span><span style="color:navy">]    </span>; must be &lt;= DPB.LAST_CLUSTER
<span style="color:maroon">DOSCODE:516C                 </span><span style="color:navy">jnz     short </span>setdpbf_27
<span style="color:maroon">DOSCODE:516E                 </span><span style="color:navy">cmp     ax, [si+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:5171
DOSCODE:5171 </span>setdpbf_27<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5171                 </span><span style="color:navy">ja      short </span>setdpbf_25 ; error
<span style="color:maroon">DOSCODE:5173                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">37h</span><span style="color:navy">], cx    </span>; DPB.ROOT_CLUSTER
<span style="color:maroon">DOSCODE:5176                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">35h</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:5179                 </span><span style="color:navy">or      byte ptr [si+</span><span style="color:#ff8000">18h</span><span style="color:navy">], </span><span style="color:green">2 </span>; DPB.FIRST_ACCESS (bit 1 = 1)
<span style="color:maroon">DOSCODE:517D                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:517E                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:517F                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSCODE:5180                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:5181                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:maroon">DOSCODE:5184                 </span><span style="color:navy">call    </span>update_fat32_fsinfo
<span style="color:maroon">DOSCODE:5187                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:maroon">DOSCODE:518A                 </span><span style="color:navy">jnb     short </span>setdpbf_29
<span style="color:maroon">DOSCODE:518C                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1Fh         </span>; error_gen_failure
<span style="color:maroon">DOSCODE:518E
DOSCODE:518E </span>setdpbf_28<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:518E                 </span><span style="color:navy">jmp     short </span>setdpbf_21
<span style="color:maroon">DOSCODE:5190 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5190
DOSCODE:5190 </span>setdpbf_29<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5190                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:5193 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5193
DOSCODE:5193 </span>setdpbf_30<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5193                 </span><span style="color:navy">and     word ptr [si+</span><span style="color:#ff8000">23h</span><span style="color:navy">], </span><span style="color:green">8Fh </span>; DPB.EXT_FLAGS (clear bit 4-6)
<span style="color:maroon">DOSCODE:5198                 </span><span style="color:navy">mov     cx, [si+</span><span style="color:#ff8000">23h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:519B                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">], cx </span>; (ret) previous active FAT/mirroring state
<span style="color:maroon">DOSCODE:519F                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>;
<span style="color:maroon">DOSCODE:519F                                         </span>; put zero to Set_DPBforFormat struc offset 14
<span style="color:maroon">DOSCODE:51A5                 </span><span style="color:navy">mov     dx, es:[di+</span><span style="color:#ff8000">8</span><span style="color:navy">]   </span>; (call) new active FAT/mirroring state,
<span style="color:maroon">DOSCODE:51A5                                         </span>;  or FFFFFFFFh to get
<span style="color:maroon">DOSCODE:51A9                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:51AC                 </span><span style="color:navy">jnz     short </span>setdpbf_31
<span style="color:maroon">DOSCODE:51AE                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:51B1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:51B1
DOSCODE:51B1 </span>setdpbf_31<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:51B1                 </span><span style="color:navy">test    dx, </span><span style="color:green">0FF70h
</span><span style="color:maroon">DOSCODE:51B5                 </span><span style="color:navy">jz      short </span>setdpbf_33 ; bit 4-6 of DBP.EXT_FLAGS must be 0
<span style="color:maroon">DOSCODE:51B7                 </span><span style="color:navy">mov     al, </span><span style="color:green">57h         </span>; error_invalid_parameter
<span style="color:maroon">DOSCODE:51B9
DOSCODE:51B9 </span>setdpbf_32<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:51B9                 </span><span style="color:navy">jmp     short </span>setdpbf_28
<span style="color:maroon">DOSCODE:51BB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:51BB
DOSCODE:51BB </span>setdpbf_33<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:51BB                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; error_invalid_function
<span style="color:maroon">DOSCODE:51BB                                         </span>; (modification is not allowed)
<span style="color:maroon">DOSCODE:51BD                 </span><span style="color:navy">jmp     short </span>setdpbf_32
<span style="color:maroon">DOSCODE:51BF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:51BF
DOSCODE:51BF </span>$PARSE_FILE_DESCRIPTOR<span style="color:navy">:                 </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:51BF                 </span><span style="color:navy">call    </span>MAKEFCB
<span style="color:maroon">DOSCODE:51C2                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:51C3                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:51C6                 </span><span style="color:navy">pop     word ptr [si+</span><span style="color:#ff8000">8</span><span style="color:navy">] </span>; [SI+user_env.user_SI]
<span style="color:maroon">DOSCODE:51C9                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:51CA
DOSCODE:51CA </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:51CA
DOSCODE:51CA
DOSCODE:51CA </span>set_exerr_locus_unk <span style="color:black">proc near           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:51CA                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:51CB                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; errLOC_Unk
<span style="color:black">DOSCODE:51CD
DOSCODE:51CD </span>set_exerr_locus<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:51CD                 </span><span style="color:navy">mov     ss:</span>EXTERR_LOCUS<span style="color:navy">, al
</span><span style="color:black">DOSCODE:51D1                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:51D2                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:51D2 </span>set_exerr_locus_unk <span style="color:black">endp
DOSCODE:51D2
DOSCODE:51D3
DOSCODE:51D3 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:51D3
DOSCODE:51D3
DOSCODE:51D3 </span>set_exerr_locus_disk <span style="color:black">proc near          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:51D3                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:51D4                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2           </span>; errLOC_Disk
<span style="color:black">DOSCODE:51D6                 </span><span style="color:navy">jmp     short </span>set_exerr_locus
<span style="color:black">DOSCODE:51D6 </span>set_exerr_locus_disk <span style="color:black">endp
DOSCODE:51D6
DOSCODE:51D8
DOSCODE:51D8 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:51D8
DOSCODE:51D8
DOSCODE:51D8 </span>set_exerr_locus_ser <span style="color:black">proc near           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:51D8                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:51D9                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">4           </span>; errLOC_SerDev
<span style="color:black">DOSCODE:51DB                 </span><span style="color:navy">jmp     short </span>set_exerr_locus
<span style="color:black">DOSCODE:51DB </span>set_exerr_locus_ser <span style="color:black">endp
DOSCODE:51DB
DOSCODE:51DD
DOSCODE:51DD </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:51DD
DOSCODE:51DD
DOSCODE:51DD </span>set_exerr_locus_mem <span style="color:black">proc near           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:51DD                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:51DE                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">5           </span>; errLOC_Mem
<span style="color:black">DOSCODE:51E0                 </span><span style="color:navy">jmp     short </span>set_exerr_locus
<span style="color:black">DOSCODE:51E0 </span>set_exerr_locus_mem <span style="color:black">endp
DOSCODE:51E0
</span><span style="color:maroon">DOSCODE:51E2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:51E2
DOSCODE:51E2 </span>$SLEAZEFUNC<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:51E2                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">0           </span>; default drive
<span style="color:maroon">DOSCODE:51E4
DOSCODE:51E4 </span>$SLEAZEFUNCDL<span style="color:navy">:                          </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:51E4                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:51E5                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:51E6                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:51E6                 </span><span style="color:navy">mov     al, dl
</span><span style="color:maroon">DOSCODE:51E8                 </span><span style="color:navy">call    </span>GETTHISDRV      ; Get CDS structure
<span style="color:maroon">DOSCODE:51EB                 </span><span style="color:navy">jb      short </span>BADSLDRIVE
<span style="color:maroon">DOSCODE:51ED                 </span><span style="color:navy">call    </span>DISK_INFO
<span style="color:maroon">DOSCODE:51F0                 </span><span style="color:navy">jb      short </span>BADSLDRIVE
<span style="color:maroon">DOSCODE:51F2                 </span><span style="color:navy">mov     byte ptr </span>FATBYTE<span style="color:navy">, ah </span>; FAT (MEDIA) ID byte
<span style="color:maroon">DOSCODE:51F6                 </span><span style="color:navy">xor     ah, ah          </span>; AH = 0
<span style="color:maroon">DOSCODE:51F6                                         </span>; AL = sectors per cluster
<span style="color:maroon">DOSCODE:51F8                 </span><span style="color:navy">push    di              </span>; di:bx = number of clusters
<span style="color:maroon">DOSCODE:51F9                 </span><span style="color:navy">call    </span>TestNet
<span style="color:maroon">DOSCODE:51FC                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:51FD                 </span><span style="color:navy">jb      short </span>sleazefunc1
<span style="color:maroon">DOSCODE:51FF                 </span><span style="color:navy">push    cx              </span>; bytes per sector
<span style="color:maroon">DOSCODE:5200                 </span><span style="color:navy">call    </span>modify_cluster_count
<span style="color:maroon">DOSCODE:5203                 </span><span style="color:navy">pop     cx              </span>; ax = sectors per cluster (modified)
<span style="color:maroon">DOSCODE:5203                                         </span>; dx = number of clusters (modified)
<span style="color:maroon">DOSCODE:5203                                         </span>; if bytes per cluster &gt; 16384
<span style="color:maroon">DOSCODE:5203                                         </span>;    and hw of cluster count &gt; 0
<span style="color:maroon">DOSCODE:5203                                         </span>;    bx = 0FFFEh (invalidated parms sign)
<span style="color:maroon">DOSCODE:5204
DOSCODE:5204 </span>sleazefunc1<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5204                 </span><span style="color:navy">mov     di, offset </span>FATBYTE
<span style="color:maroon">DOSCODE:5207                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:520A                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], cx      </span>; [SI+user_env.user_CX]
<span style="color:maroon">DOSCODE:520D                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], bx      </span>; [SI+user_env.user_DX]
<span style="color:maroon">DOSCODE:5210                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], di      </span>; [SI+user_env.user_BX]
<span style="color:maroon">DOSCODE:5213                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], ss </span>; [SI+user_env.user_DS]
<span style="color:maroon">DOSCODE:5213                                         </span>; stash correct pointer
<span style="color:maroon">DOSCODE:5216                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:5217 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5217
DOSCODE:5217 </span>BADSLDRIVE<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5217                 </span><span style="color:navy">jmp     </span>FCB_RET_ERR     ; error
<span style="color:maroon">DOSCODE:521A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:521A
DOSCODE:521A </span>$GET_INDOS_FLAG<span style="color:navy">:                        </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:521A                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:521D                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], offset </span>INDOS ; [SI+user_env.user_BX]
<span style="color:maroon">DOSCODE:5222
DOSCODE:5222 </span>getin_segm<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5222                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">10h</span><span style="color:navy">], ss </span>; [SI+user_env.user_ES]
<span style="color:maroon">DOSCODE:5225                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:5226 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5226
DOSCODE:5226 </span>$GET_IN_VARS<span style="color:navy">:                           </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5226                 </span><span style="color:navy">call    </span>Get_User_Stack  ; Return Pointer to DOS Variables
<span style="color:maroon">DOSCODE:5229                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], offset </span>DPBHEAD ; [SI+user_env.user_BX],
<span style="color:maroon">DOSCODE:5229                                         </span>; SYSINITVARS
<span style="color:maroon">DOSCODE:522E                 </span><span style="color:navy">jmp     short </span>getin_segm
<span style="color:maroon">DOSCODE:5230 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5230
DOSCODE:5230 </span>$GET_DEFAULT_DPB<span style="color:navy">:                       </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5230                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:5232
DOSCODE:5232 </span>$GET_DPB<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5232                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:5233                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:5234                 </span><span style="color:navy">mov     al, dl
</span><span style="color:maroon">DOSCODE:5236                 </span><span style="color:navy">call    </span>GETTHISDRV      ; Get CDS structure
<span style="color:maroon">DOSCODE:5239                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Fh         </span>; error_invalid_drive
<span style="color:maroon">DOSCODE:523B                 </span><span style="color:navy">jnb     short </span>getdpb_3
<span style="color:maroon">DOSCODE:523D
DOSCODE:523D </span>getdpb_1<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:523D                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:5240                 </span><span style="color:navy">cmp     word ptr [si], </span><span style="color:#ff8000">7302h </span>; INT 21h, AX = 7302h ? Get_ExtDPB
<span style="color:maroon">DOSCODE:5240                                         </span>; GET EXTENDED DPB
<span style="color:maroon">DOSCODE:5244                 </span><span style="color:navy">jz      short </span>getdpb_2
<span style="color:maroon">DOSCODE:5246                 </span><span style="color:navy">cmp     word ptr [si], </span><span style="color:#ff8000">7304h </span>; INT 21h, AX = 7304h ? Set_DPBforFormat
<span style="color:maroon">DOSCODE:5246                                         </span>; Set DPB TO USE FOR FORMATTING
<span style="color:maroon">DOSCODE:524A                 </span><span style="color:navy">jnz     short </span>ISNODRV
<span style="color:maroon">DOSCODE:524C
DOSCODE:524C </span>getdpb_2<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:524C                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:maroon">DOSCODE:524F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:524F
DOSCODE:524F </span>ISNODRV<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:524F                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh        </span>; -1 ; invalid (or network) drive
<span style="color:maroon">DOSCODE:5251                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:5252 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5252
DOSCODE:5252 </span>getdpb_3<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5252                 </span><span style="color:navy">les     di, </span>THISCDS
<span style="color:maroon">DOSCODE:5256                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">44h</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:DI+curdir.flags+1],
<span style="color:maroon">DOSCODE:5256                                         </span>; (curdir_isnet&gt;&gt;8)
<span style="color:maroon">DOSCODE:525B                 </span><span style="color:navy">jnz     short </span>getdpb_1
<span style="color:maroon">DOSCODE:525D                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:maroon">DOSCODE:5260                 </span><span style="color:navy">call    </span>FATREAD_CDS
<span style="color:maroon">DOSCODE:5263                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:maroon">DOSCODE:5266                 </span><span style="color:navy">mov     al, </span><span style="color:green">53h         </span>; error_FAIL_I24
<span style="color:maroon">DOSCODE:5268                 </span><span style="color:navy">jb      short </span>getdpb_1
<span style="color:maroon">DOSCODE:526A                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:526D                 </span><span style="color:navy">cmp     word ptr [si], </span><span style="color:#ff8000">7304h </span>; INT 21h, AX = 7304h ?
<span style="color:maroon">DOSCODE:5271                 </span><span style="color:navy">jnz     short </span>getdpb_4
<span style="color:maroon">DOSCODE:5273                 </span><span style="color:navy">jmp     </span>Set_DPBforFormat
<span style="color:maroon">DOSCODE:5276 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5276
DOSCODE:5276 </span>getdpb_4<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5276                 </span><span style="color:navy">cmp     word ptr [si], </span><span style="color:#ff8000">7302h </span>; INT 21h, AX = 7302h ?
<span style="color:maroon">DOSCODE:527A                 </span><span style="color:navy">jz      short </span>getdpb_5
<span style="color:maroon">DOSCODE:527C                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:5281                 </span><span style="color:navy">jz      short </span>getdpb_1
<span style="color:maroon">DOSCODE:5283                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], bp
</span><span style="color:maroon">DOSCODE:5286                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], es
</span><span style="color:maroon">DOSCODE:5289                 </span><span style="color:navy">xor     al, al          </span>; status = 0 = successful
<span style="color:maroon">DOSCODE:528B                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:528C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:528C
DOSCODE:528C </span>getdpb_5<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:528C                 </span><span style="color:navy">mov     al, </span><span style="color:green">18h         </span>; error_bad_length
<span style="color:maroon">DOSCODE:528E                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">63 </span>; [SI+user_env.user_CX]
<span style="color:maroon">DOSCODE:528E                                         </span>; length of buffer (must be 63 bytes)
<span style="color:maroon">DOSCODE:5292                 </span><span style="color:navy">jb      short </span>getdpb_2  ; error
<span style="color:maroon">DOSCODE:5294                 </span><span style="color:navy">push    es              </span>; ES:BP = Drive parameter block
<span style="color:maroon">DOSCODE:5295                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">DOSCODE:5296                 </span><span style="color:navy">mov     es, word ptr [si+</span><span style="color:green">16</span><span style="color:navy">] </span>; [SI+user_env.user_ES]
<span style="color:maroon">DOSCODE:5299                 </span><span style="color:navy">mov     di, [si+</span><span style="color:green">10</span><span style="color:navy">]     </span>; [SI+user_env.user_DI]
<span style="color:maroon">DOSCODE:529C                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">8</span><span style="color:navy">]      </span>; [SI+user_env.user_SI] (!)
<span style="color:maroon">DOSCODE:529F                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:52A0                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:52A1                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:52A1                 </span><span style="color:navy">mov     ax, </span><span style="color:green">61          </span>; length of following data (003Dh)
<span style="color:maroon">DOSCODE:52A4                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:52A5                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:maroon">DOSCODE:52A7                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:52A8                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">DOSCODE:52AA                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:52AB                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">0F1A6h      </span>; (!) signature (undocumented),
<span style="color:maroon">DOSCODE:52AB                                         </span>;  must be 0F1A6h to get device driver
<span style="color:maroon">DOSCODE:52AB                                         </span>;  address and next-DBP pointer
<span style="color:maroon">DOSCODE:52AB                                         </span>; (Ref: Ralf Brown&#039;s Interrupt List)
<span style="color:maroon">DOSCODE:52AF                 </span><span style="color:navy">jz      short </span>getdpb_6
<span style="color:maroon">DOSCODE:52B1                 </span><span style="color:navy">xor     ax, ax          </span>; 0
<span style="color:maroon">DOSCODE:52B3                 </span><span style="color:navy">dec     ax              </span>; -1
<span style="color:maroon">DOSCODE:52B4                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">19h</span><span style="color:navy">], ax </span>; pointer to next DPB (invalidated)
<span style="color:maroon">DOSCODE:52B8                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:52BC                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">13h</span><span style="color:navy">], ax </span>; pointer to driver address (invalidated)
<span style="color:maroon">DOSCODE:52C0                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:52C4
DOSCODE:52C4 </span>getdpb_6<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:52C4                 </span><span style="color:navy">cmp     word ptr es:[di+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; FAT (16 bit) size ?
<span style="color:maroon">DOSCODE:52C9                 </span><span style="color:navy">jz      short </span>getdpb_8  ; FAT32
<span style="color:maroon">DOSCODE:52C9                                         </span>; FAT16 or FAT12
<span style="color:maroon">DOSCODE:52CB                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">] </span>; DPB.MAX_CLUSTER
<span style="color:maroon">DOSCODE:52CF                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">], ax </span>; DPB.LAST_CLUSTER
<span style="color:maroon">DOSCODE:52D3                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">] </span>; DPB.FAT_SIZE
<span style="color:maroon">DOSCODE:52D7                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">31h</span><span style="color:navy">], ax </span>; DPB.FAT32_SIZE
<span style="color:maroon">DOSCODE:52DB                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">] </span>; DPB.NEXT_FREE
<span style="color:maroon">DOSCODE:52DF                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">39h</span><span style="color:navy">], ax </span>; DPB.FAT32_NXTFREE
<span style="color:maroon">DOSCODE:52E3                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">] </span>; DPB.FIRST_SECTOR
<span style="color:maroon">DOSCODE:52E7                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">29h</span><span style="color:navy">], ax </span>; DPB.FCLUS_FSECTOR
<span style="color:maroon">DOSCODE:52EB                 </span><span style="color:navy">xor     ax, ax          </span>; 0
<span style="color:maroon">DOSCODE:52ED                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">2Fh</span><span style="color:navy">], ax </span>; DPB.LAST_CLUSTER high word
<span style="color:maroon">DOSCODE:52F1                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">33h</span><span style="color:navy">], ax </span>; DPB.FAT32_SIZE high word
<span style="color:maroon">DOSCODE:52F5                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">3Bh</span><span style="color:navy">], ax </span>; DPB.FAT32_NXTFREE high word
<span style="color:maroon">DOSCODE:52F9                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">2Bh</span><span style="color:navy">], ax </span>; DPB.FCLUS_FSECTOR high word
<span style="color:maroon">DOSCODE:52FD                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">35h</span><span style="color:navy">], ax </span>; DPB.ROOT_CLUSTER
<span style="color:maroon">DOSCODE:5301                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">37h</span><span style="color:navy">], ax </span>; DPB.ROOT_CLUSTER high word
<span style="color:maroon">DOSCODE:5305                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">23h</span><span style="color:navy">], ax </span>; DPB.EXT_FLAGS
<span style="color:maroon">DOSCODE:5309                 </span><span style="color:navy">dec     ax              </span>; -1
<span style="color:maroon">DOSCODE:530A                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">25h</span><span style="color:navy">], ax </span>; DPB.FSINFO_SECTOR (invalidated)
<span style="color:maroon">DOSCODE:530E                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">27h</span><span style="color:navy">], ax </span>; DPB.BKBOOT_SECTOR (invalidated)
<span style="color:maroon">DOSCODE:5312                 </span><span style="color:navy">cmp     ax, es:[di+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">] </span>; DPB.FREE_COUNT (= -1 ?)
<span style="color:maroon">DOSCODE:5316                 </span><span style="color:navy">jz      short </span>getdpb_7
<span style="color:maroon">DOSCODE:5318                 </span><span style="color:navy">inc     ax              </span>; -1 -&gt; 0
<span style="color:maroon">DOSCODE:5319
DOSCODE:5319 </span>getdpb_7<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5319                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">21h</span><span style="color:navy">], ax </span>; DPB.PB.FREE_COUNT high word
<span style="color:maroon">DOSCODE:531D
DOSCODE:531D </span>getdpb_8<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:531D                 </span><span style="color:navy">xor     ax, ax          </span>; status = 0 = successful
<span style="color:maroon">DOSCODE:531F                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:5322 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5322
DOSCODE:5322 </span>$DISK_RESET<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5322                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh        </span>; -1
<span style="color:maroon">DOSCODE:5324                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:5325                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:5326                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:5326                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:maroon">DOSCODE:5329                 </span><span style="color:navy">or      byte ptr </span>DOS34_FLAG<span style="color:navy">, </span><span style="color:green">4 </span>; FROM_DISK_RESET
<span style="color:maroon">DOSCODE:532E                 </span><span style="color:navy">call    </span>FLUSHBUF
<span style="color:maroon">DOSCODE:5331                 </span><span style="color:navy">and     byte ptr </span>DOS34_FLAG<span style="color:navy">, </span><span style="color:green">0FBh </span>; NO_FROM_DISK_RESET
<span style="color:maroon">DOSCODE:5336                 </span><span style="color:navy">les     bp, </span>DPBHEAD
<span style="color:maroon">DOSCODE:533A
DOSCODE:533A </span>drst_1<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:533A                 </span><span style="color:navy">cmp     bp, </span><span style="color:green">0FFFFh      </span>; -1 ?
<span style="color:maroon">DOSCODE:533D                 </span><span style="color:navy">jz      short </span>drst_2    ; yes, it is the last DPB
<span style="color:maroon">DOSCODE:533F                 </span><span style="color:navy">call    </span>update_fat32_fsinfo ; update FSINFO (sector) parameters
<span style="color:maroon">DOSCODE:5342                 </span><span style="color:navy">les     bp, es:[bp+</span><span style="color:#ff8000">19h</span><span style="color:navy">] </span>; DPB.NEXT_DPB
<span style="color:maroon">DOSCODE:5346                 </span><span style="color:navy">jmp     short </span>drst_1
<span style="color:maroon">DOSCODE:5348 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5348
DOSCODE:5348 </span>drst_2<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5348                 </span><span style="color:navy">mov     </span>SC_STATUS<span style="color:navy">, </span><span style="color:#ff8000">0    </span>; Throw out secondary cache
<span style="color:maroon">DOSCODE:534E                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:maroon">DOSCODE:5351                 </span><span style="color:navy">mov     word ptr </span>LastBuffer<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, bx </span>; Invalidate &#039;last-buffer&#039; used
<span style="color:maroon">DOSCODE:5355                 </span><span style="color:navy">mov     word ptr </span>LastBuffer<span style="color:navy">, bx
</span><span style="color:maroon">DOSCODE:5359                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:maroon">DOSCODE:535C                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:535F                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:5360                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1120h
</span><span style="color:maroon">DOSCODE:5363                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - FLUSH ALL DISK BUFFERS
<span style="color:maroon">DOSCODE:5363                                         </span>; DS = DOS CS
<span style="color:maroon">DOSCODE:5363                                         </span>; Return: CF clear (successful)
<span style="color:maroon">DOSCODE:5365                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:5366                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:5366 </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSCODE:5367 </span>word3           <span style="color:navy">dw </span><span style="color:#008040">3                    </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:5369
DOSCODE:5369 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5369
DOSCODE:5369
DOSCODE:5369 </span>$SETDPB         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5369                 </span><span style="color:navy">mov     di, bp          </span>; Buffer address (es:bp)
<span style="color:black">DOSCODE:536B                 </span><span style="color:navy">inc     di              </span>; Skip over dpb_drive and dpb_UNIT
<span style="color:black">DOSCODE:536C                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:536D                 </span><span style="color:navy">lodsw                   </span>; dpb_sector_size ; bytes per sector
<span style="color:black">DOSCODE:536E                 </span><span style="color:navy">stosw                   </span>; .BPB_BYTESPERSECTOR
<span style="color:black">DOSCODE:536F                 </span><span style="color:navy">cmp     cx, </span><span style="color:#ff8000">4558h       </span>; &#039;XE&#039; (NASM syntax)
<span style="color:black">DOSCODE:536F                                         </span>; CX = signature 4558h (&#039;EX&#039;) for FAT32 extended BPB/DPB
<span style="color:black">DOSCODE:5373                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_fat32_extension
</span><span style="color:black">DOSCODE:5375                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">4152h       </span>; &#039;RA&#039; (NASM syntax)
<span style="color:black">DOSCODE:5375                                         </span>; DX = signature 4152h (&#039;AR&#039;) for FAT32 extended BPB/DPB
<span style="color:black">DOSCODE:5379                 </span><span style="color:navy">jz      short </span><span style="color:gray">chk_fat32_conditions
</span><span style="color:black">DOSCODE:537B
DOSCODE:537B </span><span style="color:gray">not_fat32_extension</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:537B                 </span><span style="color:navy">xor     cx, cx          </span>; 0 ; (Do not use FAT32 extensions -32 bit parameters-)
<span style="color:black">DOSCODE:537D
DOSCODE:537D </span><span style="color:gray">chk_fat32_conditions</span><span style="color:navy">:                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:537D                 </span><span style="color:navy">push    cx              </span>; (*)
<span style="color:black">DOSCODE:537E                 </span><span style="color:navy">cmp     byte ptr [si+</span><span style="color:#ff8000">3</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; .BPB_NUMBEROFFATS
<span style="color:black">DOSCODE:5382                 </span><span style="color:navy">jz      short </span><span style="color:gray">nofat
</span><span style="color:black">DOSCODE:5384                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">9</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; .BPB_SECTORSPERFAT ; BPB_FATSz16
<span style="color:black">DOSCODE:5388                 </span><span style="color:navy">jnz     short </span><span style="color:gray">yesfat
</span><span style="color:black">DOSCODE:538A                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:green">29</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; .BPB_FAT32VERSION ; BPB_FSVer
<span style="color:black">DOSCODE:538E                 </span><span style="color:navy">jz      short </span><span style="color:gray">yesfat
</span><span style="color:black">DOSCODE:5390
DOSCODE:5390 </span><span style="color:gray">nofat</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5390                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:5392                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], al   </span>; DPB.FAT_COUNT = 0
<span style="color:black">DOSCODE:5396                 </span><span style="color:navy">add     di, </span><span style="color:green">15          </span>; DPB.DRIVER_ADDR
<span style="color:black">DOSCODE:5399                 </span><span style="color:navy">add     si, </span><span style="color:green">11          </span>; .BPB_SECTORSPERTRACK
<span style="color:black">DOSCODE:539C                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:green">15</span><span style="color:navy">], ax  </span>; DPB.FAT_SIZE = 0
<span style="color:black">DOSCODE:53A0                 </span><span style="color:navy">jmp     </span><span style="color:gray">setend
</span><span style="color:black">DOSCODE:53A3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:53A3
DOSCODE:53A3 </span><span style="color:gray">yesfat</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:53A3                 </span><span style="color:navy">mov     dx, ax          </span>; bytes per sector
<span style="color:black">DOSCODE:53A5                 </span><span style="color:navy">lodsb                   </span>; .BPB_SECTORSPERCLUSTER
<span style="color:black">DOSCODE:53A6                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:53A8                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:53AA                 </span><span style="color:navy">jz      short </span><span style="color:gray">nofat
</span><span style="color:black">DOSCODE:53AC                 </span><span style="color:navy">dec     al
</span><span style="color:black">DOSCODE:53AE                 </span><span style="color:navy">stosb                   </span>; DPB.CLUSTER_MASK ; Sectors/cluster - 1
<span style="color:black">DOSCODE:53AF                 </span><span style="color:navy">inc     al
</span><span style="color:black">DOSCODE:53B1
DOSCODE:53B1 </span><span style="color:gray">LOG2LOOP</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:53B1                 </span><span style="color:navy">test    al, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:53B3                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SAVLOG
</span><span style="color:black">DOSCODE:53B5                 </span><span style="color:navy">inc     ah
</span><span style="color:black">DOSCODE:53B7                 </span><span style="color:navy">shr     al, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:53B9                 </span><span style="color:navy">jmp     short </span><span style="color:gray">LOG2LOOP
</span><span style="color:black">DOSCODE:53BB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:53BB
DOSCODE:53BB </span><span style="color:gray">SAVLOG</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:53BB                 </span><span style="color:navy">mov     al, ah
</span><span style="color:black">DOSCODE:53BD                 </span><span style="color:navy">stosb                   </span>; DPB.CLUSTER_SHIFT ; Log2 of sectors/cluster
<span style="color:black">DOSCODE:53BE                 </span><span style="color:navy">mov     bl, al
</span><span style="color:black">DOSCODE:53C0                 </span><span style="color:navy">movsw                   </span>; .BPB_RESERVEDSECTORS -&gt; DPB.FIRST_FAT
<span style="color:black">DOSCODE:53C1                 </span><span style="color:navy">lodsb                   </span>; .BPB_NUMBEROFFATS
<span style="color:black">DOSCODE:53C2                 </span><span style="color:navy">stosb                   </span>; DPB.FAT_COUNT
<span style="color:black">DOSCODE:53C3                 </span><span style="color:navy">mov     bh, al
</span><span style="color:black">DOSCODE:53C5                 </span><span style="color:navy">lodsw                   </span>; .BPB_ROOTENTRIES
<span style="color:black">DOSCODE:53C6                 </span><span style="color:navy">stosw                   </span>; DPB.ROOT_ENTRIES
<span style="color:black">DOSCODE:53C7                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">5
</span><span style="color:black">DOSCODE:53C9                 </span><span style="color:navy">shr     dx, cl          </span>; Directory entries per sector
<span style="color:black">DOSCODE:53CB                 </span><span style="color:navy">dec     ax
</span><span style="color:black">DOSCODE:53CC                 </span><span style="color:navy">add     ax, dx          </span>; Round Up
<span style="color:black">DOSCODE:53CE                 </span><span style="color:navy">mov     cx, dx
</span><span style="color:black">DOSCODE:53D0                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:53D2                 </span><span style="color:navy">div     cx
</span><span style="color:black">DOSCODE:53D4                 </span><span style="color:navy">mov     cx, ax          </span>; Number of root directory sectors
<span style="color:black">DOSCODE:53D6                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:53D7                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:53D8                 </span><span style="color:navy">movsw                   </span>; .BPB_TOTALSECTORS -&gt; DPB.MAX_CLUSTER (temporary)
<span style="color:black">DOSCODE:53D9                 </span><span style="color:navy">lodsb                   </span>; .BPB_MEDIADESCRIPTOR
<span style="color:black">DOSCODE:53DA                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:green">23</span><span style="color:navy">], al  </span>; DPB.MEDIA
<span style="color:black">DOSCODE:53DE                 </span><span style="color:navy">lodsw                   </span>; .BPB_SECTORSPERFAT
<span style="color:black">DOSCODE:53DF                 </span><span style="color:navy">stosw                   </span>; DPB.FAT_SIZE
<span style="color:black">DOSCODE:53E0                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:53E2                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:53E4                 </span><span style="color:navy">jnz     short </span><span style="color:gray">savlog1   </span>; 16 bit FAT size
<span style="color:black">DOSCODE:53E6                 </span><span style="color:navy">pop     dx              </span>; (*) FAT32 extensions
<span style="color:black">DOSCODE:53E6                                         </span>; (use 32 bit FAT and Root Dir size if &gt;0)
<span style="color:black">DOSCODE:53E7                 </span><span style="color:navy">push    dx              </span>; (*)
<span style="color:black">DOSCODE:53E8                 </span><span style="color:navy">or      dx, dx
</span><span style="color:black">DOSCODE:53EA                 </span><span style="color:navy">jz      short </span><span style="color:gray">savlog1   </span>; Do not use FAT32 extensions
<span style="color:black">DOSCODE:53EA                                         </span>; (do not use 32 bit FAT size field)
<span style="color:black">DOSCODE:53EC                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:green">12</span><span style="color:navy">]     </span>; .BPB_SECTORSPERFAT32 ; BPB_FATSz32
<span style="color:black">DOSCODE:53EF                 </span><span style="color:navy">mov     dx, [si+</span><span style="color:green">14</span><span style="color:navy">]     </span>; .BPB_SECTORSPERFAT32+2
<span style="color:black">DOSCODE:53F2
DOSCODE:53F2 </span><span style="color:gray">savlog1</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:53F2                 </span><span style="color:navy">push    cx              </span>; (**) Root directory sectors
<span style="color:black">DOSCODE:53F3                 </span><span style="color:navy">mov     cx, ax          </span>; 32 bit multiply
<span style="color:black">DOSCODE:53F5                 </span><span style="color:navy">mov     al, bh          </span>; FAT count
<span style="color:black">DOSCODE:53F7                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:53F9                 </span><span style="color:navy">mul     dx
</span><span style="color:black">DOSCODE:53FB                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:black">DOSCODE:53FC                 </span><span style="color:navy">mov     dl, bh          </span>; FAT count
<span style="color:black">DOSCODE:53FE                 </span><span style="color:navy">xor     dh, dh
</span><span style="color:black">DOSCODE:5400                 </span><span style="color:navy">mul     dx
</span><span style="color:black">DOSCODE:5402                 </span><span style="color:navy">add     dx, cx
</span><span style="color:black">DOSCODE:5404                 </span><span style="color:navy">pop     cx              </span>; (**)
<span style="color:black">DOSCODE:5405                 </span><span style="color:navy">cmp     ax, dx
</span><span style="color:black">DOSCODE:5407                 </span><span style="color:navy">jnz     short </span><span style="color:gray">savlog2
</span><span style="color:black">DOSCODE:5409                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:540B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">savlog2
</span><span style="color:black">DOSCODE:540D                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:540E                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:540F                 </span><span style="color:navy">jmp     short </span><span style="color:gray">setend
</span><span style="color:black">DOSCODE:5411 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5411
DOSCODE:5411 </span><span style="color:gray">savlog2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5411                 </span><span style="color:navy">add     ax, es:[bp+</span><span style="color:#ff8000">6</span><span style="color:navy">]   </span>; dx:ax = (total) FAT sectors
<span style="color:black">DOSCODE:5411                                         </span>; add ax,[es:bp+DPB.FIRST_FAT]
<span style="color:black">DOSCODE:5415                 </span><span style="color:navy">adc     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:5418                 </span><span style="color:navy">stosw                   </span>; DPB.DIR_SECTOR
<span style="color:black">DOSCODE:5419                 </span><span style="color:navy">add     ax, cx          </span>; + root directory size
<span style="color:black">DOSCODE:541B                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:green">11</span><span style="color:navy">], ax  </span>; DPB.FIRST_SECTOR ; First data sector
<span style="color:black">DOSCODE:541F                 </span><span style="color:navy">adc     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:5422                 </span><span style="color:navy">pop     cx              </span>; (*)
<span style="color:black">DOSCODE:5423                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:5424                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">savlog3
</span><span style="color:black">DOSCODE:5426                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:green">41</span><span style="color:navy">], ax  </span>; DPB.BIG_FIRST_SECTOR ; FAT32 first sector field
<span style="color:black">DOSCODE:542A                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:green">43</span><span style="color:navy">], dx
</span><span style="color:black">DOSCODE:542E
DOSCODE:542E </span><span style="color:gray">savlog3</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:542E                 </span><span style="color:navy">mov     cl, bl          </span>; cluster shift
<span style="color:black">DOSCODE:5430                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:green">13</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; DPB.MAX_CLUSTER
<span style="color:black">DOSCODE:5430                                         </span>; (contains 16 bit .BPB_TOTALSECTORS as temporary)
<span style="color:black">DOSCODE:5435                 </span><span style="color:navy">jnz     short </span><span style="color:gray">normal_dpb
</span><span style="color:black">DOSCODE:5437                 </span><span style="color:navy">xor     ch, ch
</span><span style="color:black">DOSCODE:5439                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:543A                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">8</span><span style="color:navy">]      </span>; SI points to .BPB_SECTORSPERTRACK and SI+8 is
<span style="color:black">DOSCODE:543A                                         </span>; .BPB_BIGTOTALSECTORS (32 bit total sectors)
<span style="color:black">DOSCODE:543D                 </span><span style="color:navy">mov     dx, [si+</span><span style="color:green">10</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:5440                 </span><span style="color:navy">sub     bx, ax
</span><span style="color:black">DOSCODE:5442                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:5443                 </span><span style="color:navy">sbb     dx, ax          </span>; dx:bx = data sectors (for cluster count calc)
<span style="color:black">DOSCODE:5445                 </span><span style="color:navy">or      cx, cx
</span><span style="color:black">DOSCODE:5447                 </span><span style="color:navy">jz      short </span><span style="color:gray">norot
</span><span style="color:black">DOSCODE:5449
DOSCODE:5449 </span><span style="color:gray">rott</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5449                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:544A                 </span><span style="color:navy">rcr     dx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:544C                 </span><span style="color:navy">rcr     bx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:544E                 </span><span style="color:navy">loop    </span><span style="color:gray">rott
</span><span style="color:black">DOSCODE:5450
DOSCODE:5450 </span><span style="color:gray">norot</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5450                 </span><span style="color:navy">mov     ax, bx          </span>; dx:ax = cluster count
<span style="color:black">DOSCODE:5452                 </span><span style="color:navy">jmp     short </span><span style="color:gray">setend
</span><span style="color:black">DOSCODE:5454 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5454
DOSCODE:5454 </span><span style="color:gray">normal_dpb</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5454                 </span><span style="color:navy">sub     ax, es:[bp+</span><span style="color:green">13</span><span style="color:navy">]  </span>; first sector - total sectors
<span style="color:black">DOSCODE:5458                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:545A                 </span><span style="color:navy">neg     ax              </span>; data sectors = total sectors - first sector
<span style="color:black">DOSCODE:545C                 </span><span style="color:navy">shr     ax, cl          </span>; cluster count
<span style="color:black">DOSCODE:545E
DOSCODE:545E </span><span style="color:gray">setend</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:545E                 </span><span style="color:navy">pop     cx              </span>; (*) 0 = not 32 bit fat sectors
<span style="color:black">DOSCODE:545F                 </span><span style="color:navy">push    cx              </span>; (*)
<span style="color:black">DOSCODE:5460                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:5463                 </span><span style="color:navy">adc     dx, </span><span style="color:#ff8000">0           </span>; calculated # clusters HW
<span style="color:black">DOSCODE:5466                 </span><span style="color:navy">mov     bx, ax          </span>; calculated # clusters LW
<span style="color:black">DOSCODE:5468                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:green">15</span><span style="color:navy">]  </span>; FAT size (16 bit)
<span style="color:black">DOSCODE:546C                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">setend1   </span>; Do not use 32 bit FAT sectors field
<span style="color:black">DOSCODE:546E                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:5470                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:5472                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setend1
</span><span style="color:black">DOSCODE:5474                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:green">12</span><span style="color:navy">]     </span>; .BPB_SECTORSPERFAT32  ; 32 bit FAT size field.
<span style="color:black">DOSCODE:5477                 </span><span style="color:navy">mov     cx, [si+</span><span style="color:green">14</span><span style="color:navy">]     </span>; .BPB_SECTORSPERFAT32+2
<span style="color:black">DOSCODE:547A
DOSCODE:547A </span><span style="color:gray">setend1</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:547A                 </span><span style="color:navy">push    dx              </span>; cx:ax = FAT size (in sectors)
<span style="color:black">DOSCODE:547A                                         </span>; dx:bx = calculated number of clusters
<span style="color:black">DOSCODE:547B                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:black">DOSCODE:547C                 </span><span style="color:navy">mul     word ptr es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">] </span>; DPB.SECTOR_SIZE
<span style="color:black">DOSCODE:5480                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:black">DOSCODE:5481                 </span><span style="color:navy">mul     word ptr es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:5485                 </span><span style="color:navy">add     dx, cx          </span>; dx:ax = FAT size in bytes
<span style="color:black">DOSCODE:5487                 </span><span style="color:navy">pop     cx              </span>; calculated # clusters HW
<span style="color:black">DOSCODE:5488                 </span><span style="color:navy">or      cx, cx
</span><span style="color:black">DOSCODE:548A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setend2   </span>; FAT32
<span style="color:black">DOSCODE:548C                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">0FF6h
</span><span style="color:black">DOSCODE:5490                 </span><span style="color:navy">jb      short </span><span style="color:gray">setend_fat12 </span>; FAT12
<span style="color:black">DOSCODE:5492
DOSCODE:5492 </span><span style="color:gray">setend2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5492                 </span><span style="color:navy">or      cx, cx          </span>; HW of calculated cluster count
<span style="color:black">DOSCODE:5494                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setend3
</span><span style="color:black">DOSCODE:5496                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">0FFF6h
</span><span style="color:black">DOSCODE:5499                 </span><span style="color:navy">jb      short </span><span style="color:gray">setend4   </span>; FAT16
<span style="color:black">DOSCODE:549B
DOSCODE:549B </span><span style="color:gray">setend3</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:549B                 </span><span style="color:navy">shr     dx, </span><span style="color:green">1           </span>; FAT32 ; 4 byte (32 bit) cluster number
<span style="color:black">DOSCODE:549B                                         </span>; fatsiz/4 = # of fat entries
<span style="color:black">DOSCODE:549D                 </span><span style="color:navy">rcr     ax, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:549F                 </span><span style="color:navy">shr     dx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:54A1                 </span><span style="color:navy">jz      short </span><span style="color:gray">setend5   </span>; dx = 0
<span style="color:black">DOSCODE:54A3                 </span><span style="color:navy">rcr     ax, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:54A5                 </span><span style="color:navy">jmp     short </span><span style="color:gray">setend_fat16
</span><span style="color:black">DOSCODE:54A7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:54A7
DOSCODE:54A7 </span><span style="color:gray">setend4</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:54A7                 </span><span style="color:navy">shr     dx, </span><span style="color:green">1           </span>; FAT16 ; 2 byte (16 bit) cluster number
<span style="color:black">DOSCODE:54A7                                         </span>; fatsiz/2 = # of fat entries
<span style="color:black">DOSCODE:54A9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setend_faterr </span>; dx &gt; 0
<span style="color:black">DOSCODE:54AB
DOSCODE:54AB </span><span style="color:gray">setend5</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:54AB                 </span><span style="color:navy">rcr     ax, </span><span style="color:green">1           </span>; FAT16 ; 2 byte (16 bit) cluster number
<span style="color:black">DOSCODE:54AB                                         </span>; fatsiz/2 = # of fat entries
<span style="color:black">DOSCODE:54AD                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">0FF7h       </span>; 4096-10+1
<span style="color:black">DOSCODE:54B0                 </span><span style="color:navy">jb      short </span><span style="color:gray">setend_faterr
</span><span style="color:black">DOSCODE:54B2                 </span><span style="color:navy">jmp     short </span><span style="color:gray">setend_fat16
</span><span style="color:black">DOSCODE:54B4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:54B4
DOSCODE:54B4 </span><span style="color:gray">setend_fat12</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:54B4                 </span><span style="color:navy">add     ax, ax          </span>; FAT12 ; 1.5 byte (12 bit) cluster number
<span style="color:black">DOSCODE:54B4                                         </span>; (fatsiz*2)/3 = # of fat entries
<span style="color:black">DOSCODE:54B6                 </span><span style="color:navy">adc     dx, dx
</span><span style="color:black">DOSCODE:54B8                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">3           </span>; if our fatspace is more than we need
<span style="color:black">DOSCODE:54B8                                         </span>; use calculated size
<span style="color:black">DOSCODE:54BB                 </span><span style="color:navy">jnb     short </span><span style="color:gray">setend_faterr
</span><span style="color:black">DOSCODE:54BD                 </span><span style="color:navy">div     cs:</span>word3
<span style="color:black">DOSCODE:54C2
DOSCODE:54C2 </span><span style="color:gray">setend_fat16</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:54C2                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:54C5                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:54C8                 </span><span style="color:navy">cmp     dx, cx          </span>; is fat big enough?
<span style="color:black">DOSCODE:54CA                 </span><span style="color:navy">ja      short </span><span style="color:gray">setend_faterr
</span><span style="color:black">DOSCODE:54CC                 </span><span style="color:navy">cmp     ax, bx
</span><span style="color:black">DOSCODE:54CE                 </span><span style="color:navy">jbe     short </span><span style="color:gray">setend_fat32 </span>; use max value that&#039;ll fit
<span style="color:black">DOSCODE:54D0
DOSCODE:54D0 </span><span style="color:gray">setend_faterr</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:54D0                 </span><span style="color:navy">mov     ax, bx          </span>; use calculated value
<span style="color:black">DOSCODE:54D2                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">DOSCODE:54D4
DOSCODE:54D4 </span><span style="color:gray">setend_fat32</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:54D4                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:green">15</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; DPB.FAT_SIZE ; 16 bit FAT size
<span style="color:black">DOSCODE:54D9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setend6
</span><span style="color:black">DOSCODE:54DB                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:green">17</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; DPB.DIR_SECTOR
<span style="color:black">DOSCODE:54DB                                         </span>; (16 bit directory sector field)
<span style="color:black">DOSCODE:54E1                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:green">13</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; DPB.MAX_CLUSTER (16 bit)
<span style="color:black">DOSCODE:54E7                 </span><span style="color:navy">jmp     short </span><span style="color:gray">setend7
</span><span style="color:black">DOSCODE:54E9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:54E9
DOSCODE:54E9 </span><span style="color:gray">setend6</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:54E9                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:green">13</span><span style="color:navy">], ax  </span>; DPB.MAX_CLUSTER = calculated last cluster number
<span style="color:black">DOSCODE:54ED
DOSCODE:54ED </span><span style="color:gray">setend7</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:54ED                 </span><span style="color:navy">pop     cx              </span>; (*) 1 = use FAT32 extensions
<span style="color:black">DOSCODE:54ED                                         </span>;     0 = don&#039;t use FAT32 extensions (32 bit fields)
<span style="color:black">DOSCODE:54EE                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">setend_fat </span>; do not use FAT32 extensions
<span style="color:black">DOSCODE:54F0                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:green">45</span><span style="color:navy">], ax  </span>; DPB.MAX_CLUSTER32 ; dx:ax = last cluster number
<span style="color:black">DOSCODE:54F4                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:green">47</span><span style="color:navy">], dx
</span><span style="color:black">DOSCODE:54F8                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:black">DOSCODE:54FB                 </span><span style="color:navy">lea     di, [bp+</span><span style="color:green">33</span><span style="color:navy">]     </span>; DPB.FREE_CNT_HW
<span style="color:black">DOSCODE:54FB                                         </span>; High word of free cluster count
<span style="color:black">DOSCODE:54FE                 </span><span style="color:navy">stosw                   </span>; -1 ; 0FFFFh
<span style="color:black">DOSCODE:54FF                 </span><span style="color:navy">lea     si, [si+</span><span style="color:green">16</span><span style="color:navy">]     </span>; FAT32 flags
<span style="color:black">DOSCODE:5502                 </span><span style="color:navy">movsw                   </span>; DPB FAT32 flags ; [bp+23h]
<span style="color:black">DOSCODE:5503                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:5506                 </span><span style="color:navy">lodsw                   </span>; FSINFO structure sector number
<span style="color:black">DOSCODE:5507                 </span><span style="color:navy">mov     dx, [si-</span><span style="color:green">24h</span><span style="color:navy">]    </span>; .BPB_RESERVEDSECTORS ; Number of reserved sectors.
<span style="color:black">DOSCODE:550A                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:550C                 </span><span style="color:navy">jz      short </span><span style="color:gray">setend8
</span><span style="color:black">DOSCODE:550E                 </span><span style="color:navy">cmp     ax, dx
</span><span style="color:black">DOSCODE:5510                 </span><span style="color:navy">jb      short </span><span style="color:gray">setend9
</span><span style="color:black">DOSCODE:5512
DOSCODE:5512 </span><span style="color:gray">setend8</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5512                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh      </span>; -1 ; invalid
<span style="color:black">DOSCODE:5515
DOSCODE:5515 </span><span style="color:gray">setend9</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5515                 </span><span style="color:navy">stosw                   </span>; DPB FSINFO structure sector number
<span style="color:black">DOSCODE:5515                                         </span>; [bp+25h]
<span style="color:black">DOSCODE:5516                 </span><span style="color:navy">lodsw                   </span>; Sector number of the backup boot sector
<span style="color:black">DOSCODE:5517                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:5519                 </span><span style="color:navy">jz      short </span><span style="color:gray">setend10
</span><span style="color:black">DOSCODE:551B                 </span><span style="color:navy">cmp     ax, dx
</span><span style="color:black">DOSCODE:551D                 </span><span style="color:navy">jb      short </span><span style="color:gray">setend11
</span><span style="color:black">DOSCODE:551F
DOSCODE:551F </span><span style="color:gray">setend10</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:551F                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh      </span>; -1 ; invalid
<span style="color:black">DOSCODE:5522
DOSCODE:5522 </span><span style="color:gray">setend11</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5522                 </span><span style="color:navy">stosw                   </span>; DPB backup boot sector address
<span style="color:black">DOSCODE:5522                                         </span>; [bp+27h]
<span style="color:black">DOSCODE:5523                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">8           </span>; [bp+31h]
<span style="color:black">DOSCODE:5526                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:5528                 </span><span style="color:navy">mov     ax, es:[di-</span><span style="color:green">34</span><span style="color:navy">]  </span>; [bp+0Fh] ; DPB.MAX_CLUSTER
<span style="color:black">DOSCODE:552C                 </span><span style="color:navy">cmp     ax, dx
</span><span style="color:black">DOSCODE:552E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setend12  </span>; &gt; 0 (not FAT32)
<span style="color:black">DOSCODE:5530                 </span><span style="color:navy">mov     ax, [si-</span><span style="color:green">16</span><span style="color:navy">]     </span>; FAT32 Sectors per FAT ; .BPB_SECTORSPERFAT32
<span style="color:black">DOSCODE:5533                 </span><span style="color:navy">mov     dx, [si-</span><span style="color:green">14</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:5536
DOSCODE:5536 </span><span style="color:gray">setend12</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5536                 </span><span style="color:navy">stosw                   </span>; DPB FAT32 FAT size in sectors ; [bp+31h]
<span style="color:black">DOSCODE:5537                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:black">DOSCODE:5539                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:553A                 </span><span style="color:navy">sub     si, </span><span style="color:#ff8000">8           </span>; Root directory cluster number
<span style="color:black">DOSCODE:553D                 </span><span style="color:navy">movsw                   </span>; DPB Root Dir Cluster ; [bp+35h]
<span style="color:black">DOSCODE:553E                 </span><span style="color:navy">movsw
</span><span style="color:black">DOSCODE:553F                 </span><span style="color:navy">xor     ax, ax          </span>; DPB reserved ; [bp+39h]
<span style="color:black">DOSCODE:5541                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:5542                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:5543
DOSCODE:5543 </span><span style="color:gray">setend_fat</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5543                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:5545                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:green">29</span><span style="color:navy">], ax  </span>; DPB.NEXT_FREE ; last allocated cluster #
<span style="color:black">DOSCODE:5549                 </span><span style="color:navy">dec     ax
</span><span style="color:black">DOSCODE:554A                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:green">31</span><span style="color:navy">], ax  </span>; DPB.FREE_CNT (-1 = unknown)
<span style="color:black">DOSCODE:554E                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:554E </span>$SETDPB         <span style="color:black">endp
DOSCODE:554E
DOSCODE:554F
DOSCODE:554F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:554F
DOSCODE:554F
DOSCODE:554F </span>$DUP_PDB        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:554F                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:5554                 </span>assume ds:nothing
<span style="color:black">DOSCODE:5554                 </span><span style="color:navy">mov     ds:</span>CreatePDB<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; indicate a new process
<span style="color:black">DOSCODE:5559                 </span><span style="color:navy">mov     ds, ds:</span>CurrentPDB
<span style="color:black">DOSCODE:555D                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:555E                 </span><span style="color:navy">jmp     short </span><span style="color:gray">CreateCopy
</span><span style="color:black">DOSCODE:5560 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5560
DOSCODE:5560 </span>$CREATE_PROCESS_DATA_BLOCK<span style="color:navy">:             </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:5560                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:black">DOSCODE:5563                 </span><span style="color:navy">mov     ds, word ptr [si+</span><span style="color:#ff8000">14h</span><span style="color:navy">] </span>; [SI+user_env.user_CS]
<span style="color:black">DOSCODE:5566                 </span><span style="color:navy">push    word ptr ds:</span><span style="color:green">2   </span>; [PDB.BLOCK_LEN]
<span style="color:black">DOSCODE:556A
DOSCODE:556A </span><span style="color:gray">CreateCopy</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:556A                 </span><span style="color:navy">mov     es, dx
</span><span style="color:black">DOSCODE:556C                 </span><span style="color:navy">xor     si, si          </span>; copy entire PDB
<span style="color:black">DOSCODE:556E                 </span><span style="color:navy">mov     di, si
</span><span style="color:black">DOSCODE:5570                 </span><span style="color:navy">mov     cx, </span><span style="color:green">128
</span><span style="color:black">DOSCODE:5573                 </span><span style="color:navy">rep movsw
</span><span style="color:black">DOSCODE:5575                 </span><span style="color:navy">mov     cx, </span><span style="color:green">20          </span>; FILPERPROC
<span style="color:black">DOSCODE:5578                 </span><span style="color:navy">mov     di, </span><span style="color:green">18h         </span>; PDB.JFN_TABLE
<span style="color:black">DOSCODE:557B                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:557C                 </span><span style="color:navy">lds     si, </span>ds:34h      ; [PDB.JFN_Pointer]
<span style="color:black">DOSCODE:5580                 </span><span style="color:navy">rep movsb
</span><span style="color:black">DOSCODE:5582                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:5583                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:5588                 </span><span style="color:navy">cmp     ds:</span>CreatePDB<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:558D                 </span><span style="color:navy">jz      short </span><span style="color:gray">Create_PDB_cont
</span><span style="color:black">DOSCODE:558F                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:5594                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:5596                 </span><span style="color:navy">mov     cx, </span><span style="color:green">20
</span><span style="color:black">DOSCODE:5599
DOSCODE:5599 </span><span style="color:gray">Create_dup_jfn</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5599                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:559A                 </span><span style="color:navy">call    </span>SFFromHandle
<span style="color:black">DOSCODE:559D                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh        </span>; unassigned JFN
<span style="color:black">DOSCODE:559F                 </span><span style="color:navy">jb      short </span><span style="color:gray">CreateStash
</span><span style="color:black">DOSCODE:55A1                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:green">10h </span>; [ES:DI+SF_ENTRY.sf_flags+1],
<span style="color:black">DOSCODE:55A1                                         </span>; (sf_no_inherit&gt;&gt;8)
<span style="color:black">DOSCODE:55A6                 </span><span style="color:navy">jnz     short </span><span style="color:gray">CreateStash </span>; if no-inherit bit is set, skip dup.
<span style="color:black">DOSCODE:55A8                 </span><span style="color:navy">mov     ah, es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_mode]
<span style="color:black">DOSCODE:55AC                 </span><span style="color:navy">and     ah, </span><span style="color:green">0F0h        </span>; SHARING_MASK
<span style="color:black">DOSCODE:55AF                 </span><span style="color:navy">cmp     ah, </span><span style="color:green">70h         </span>; SHARING_NET_FCB
<span style="color:black">DOSCODE:55B2                 </span><span style="color:navy">jz      short </span><span style="color:gray">CreateStash
</span><span style="color:black">DOSCODE:55B4                 </span><span style="color:navy">mov     word ptr ds:</span>THISSFT<span style="color:navy">, di
</span><span style="color:black">DOSCODE:55B8                 </span><span style="color:navy">mov     word ptr ds:</span>THISSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:55BC                 </span><span style="color:navy">call    </span>DOS_DUP
<span style="color:black">DOSCODE:55BF                 </span><span style="color:navy">call    </span>pJFNFromHandle
<span style="color:black">DOSCODE:55C2                 </span><span style="color:navy">mov     al, es:[di]
</span><span style="color:black">DOSCODE:55C5
DOSCODE:55C5 </span><span style="color:gray">CreateStash</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:55C5                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:55C6                 </span><span style="color:navy">mov     es:[bx+</span><span style="color:#ff8000">18h</span><span style="color:navy">], al </span>; [ES:BX+PDB.JFN_TABLE]
<span style="color:black">DOSCODE:55CA                 </span><span style="color:navy">inc     bx              </span>; next jfn
<span style="color:black">DOSCODE:55CB                 </span><span style="color:navy">loop    </span><span style="color:gray">Create_dup_jfn
</span><span style="color:black">DOSCODE:55CD                 </span><span style="color:navy">mov     bx, ds:</span>CurrentPDB ; get current process
<span style="color:black">DOSCODE:55D1                 </span><span style="color:navy">mov     es:</span><span style="color:green">16h</span><span style="color:navy">, bx      </span>; [ES:PDB.PARENT_PID]
<span style="color:black">DOSCODE:55D6                 </span><span style="color:navy">mov     ds:</span>CurrentPDB<span style="color:navy">, es
</span><span style="color:black">DOSCODE:55DA                 </span><span style="color:navy">mov     ds, bx
</span><span style="color:black">DOSCODE:55DC
DOSCODE:55DC </span><span style="color:gray">Create_PDB_cont</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:55DC                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:55DD                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:55E2                 </span><span style="color:navy">mov     ds:</span>CreatePDB<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:55E7                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:55E8                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:55E8 </span>$DUP_PDB        <span style="color:black">endp
DOSCODE:55E8
DOSCODE:55E9
DOSCODE:55E9 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:55E9
DOSCODE:55E9
DOSCODE:55E9 </span>SETMEM          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:55E9                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:55EB                 </span><span style="color:navy">mov     ds, cx
</span><span style="color:black">DOSCODE:55ED                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:55ED                 </span><span style="color:navy">mov     es, dx
</span><span style="color:black">DOSCODE:55EF                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">88h         </span>; addr_int_terminate
<span style="color:black">DOSCODE:55F2                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">0Ah         </span>; SAVEXIT
<span style="color:black">DOSCODE:55F5                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:55F7                 </span><span style="color:navy">rep movsw
</span><span style="color:black">DOSCODE:55F9                 </span><span style="color:navy">mov     es:</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">DOSCODE:55FD                 </span><span style="color:navy">sub     ax, dx
</span><span style="color:black">DOSCODE:55FF                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">0FFFh       </span>; MAXDIF
<span style="color:black">DOSCODE:5602                 </span><span style="color:navy">jbe     short </span><span style="color:gray">HAVDIF
</span><span style="color:black">DOSCODE:5604                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">0FFFh       </span>; MAXDIF
<span style="color:black">DOSCODE:5607
DOSCODE:5607 </span><span style="color:gray">HAVDIF</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5607                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">10h         </span>; Allow for 100h byte &quot;stack&quot; in .COM files
<span style="color:black">DOSCODE:560A                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">0Ch         </span>; ENTRYPOINTSEG
<span style="color:black">DOSCODE:560D                 </span><span style="color:navy">sub     bx, ax
</span><span style="color:black">DOSCODE:560F                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:black">DOSCODE:5611                 </span><span style="color:navy">shl     ax, cl
</span><span style="color:black">DOSCODE:5613                 </span><span style="color:navy">mov     ds, dx
</span><span style="color:black">DOSCODE:5615                 </span>assume ds:nothing
<span style="color:black">DOSCODE:5615                 </span><span style="color:navy">mov     ds:</span><span style="color:green">6</span><span style="color:navy">, ax        </span>; [PDB.CPM_CALL+1]
<span style="color:black">DOSCODE:5618                 </span><span style="color:navy">mov     ds:</span><span style="color:green">8</span><span style="color:navy">, bx        </span>; [PDB.CPM_CALL+3]
<span style="color:black">DOSCODE:561C                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FEF0h      </span>; WRAPOFFSET
<span style="color:black">DOSCODE:561F                 </span><span style="color:navy">jz      short </span><span style="color:gray">addr_ok
</span><span style="color:black">DOSCODE:5621                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">6</span><span style="color:navy">, </span><span style="color:#ff8000">0C0h </span>; [PDB.CPM_CALL+1],0C0h
<span style="color:black">DOSCODE:5627                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">8</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; [PDB.CPM_CALL+3],0
<span style="color:black">DOSCODE:562D
DOSCODE:562D </span><span style="color:gray">addr_ok</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:562D                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">20CDh </span>; PDB.EXIT_CALL],(int_abort*256) + mi_INT
<span style="color:black">DOSCODE:5633                 </span><span style="color:navy">mov     byte ptr ds:</span><span style="color:green">5</span><span style="color:navy">, </span><span style="color:#ff8000">9Ah </span>; [PDB.CPM_CALL],mi_Long_CALL
<span style="color:black">DOSCODE:5638                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">50h</span><span style="color:navy">, </span><span style="color:#ff8000">21CDh </span>; [PDB.CALL_SYSTEM],(int_command*256) + mi_INT
<span style="color:black">DOSCODE:563E                 </span><span style="color:navy">mov     byte ptr ds:</span><span style="color:green">52h</span><span style="color:navy">, </span><span style="color:#ff8000">0CBh </span>; [PDB.CALL_SYSTEM+2],mi_Long_RET
<span style="color:black">DOSCODE:5643                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">34h</span><span style="color:navy">, </span><span style="color:#ff8000">18h </span>; [PDB.JFN_Pointer],PDB.JFN_TABLE
<span style="color:black">DOSCODE:5649                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">36h</span><span style="color:navy">, ds </span>; PDB.JFN_Pointer+2],DS
<span style="color:black">DOSCODE:564D                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">32h</span><span style="color:navy">, </span><span style="color:#ff8000">14h </span>; [PDB.JFN_Length],FILPERPROC
<span style="color:black">DOSCODE:5653                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">38h</span><span style="color:navy">, </span><span style="color:green">0FFFFh </span>; [PDB.Next_PDB],-1
<span style="color:black">DOSCODE:5659                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">3Ah</span><span style="color:navy">, </span><span style="color:green">0FFFFh </span>; [PDB.Next_PDB+2],-1
<span style="color:black">DOSCODE:565F                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">40h</span><span style="color:navy">, </span><span style="color:#ff8000">0A07h </span>; [ES:PDB.Version],
<span style="color:black">DOSCODE:565F                                         </span>; (MINOR_VERSION*256)+MAJOR_VERSION
<span style="color:black">DOSCODE:5666                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5666 </span>SETMEM          <span style="color:black">endp
DOSCODE:5666
</span><span style="color:maroon">DOSCODE:5667 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5667
DOSCODE:5667 </span>$GSetMediaID<span style="color:navy">:                           </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5667                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:5668                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:5669                 </span><span style="color:navy">lds     si, ss:</span>THISCDS
<span style="color:maroon">DOSCODE:566E                 </span><span style="color:navy">lds     si, [si+</span><span style="color:#ff8000">45h</span><span style="color:navy">]    </span>; [si+curdir.devptr]
<span style="color:maroon">DOSCODE:566E                                         </span>; local pointer to DPB or net device
<span style="color:maroon">DOSCODE:5671                 </span><span style="color:navy">mov     si, [si+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">]    </span>; [si+DPB.FAT_SIZE]
<span style="color:maroon">DOSCODE:5674                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">866h        </span>; assume get for IOCTL
<span style="color:maroon">DOSCODE:5674                                         </span>; major function = Generic IOCtl (08h)
<span style="color:maroon">DOSCODE:5674                                         </span>; minor function = GetMediaId (66h)
<span style="color:maroon">DOSCODE:5677                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1           </span>; set ?
<span style="color:maroon">DOSCODE:5679                 </span><span style="color:navy">jb      short </span>doioctl1  ; get
<span style="color:maroon">DOSCODE:567B                 </span><span style="color:navy">ja      short </span>errorfunc ; invalid
<span style="color:maroon">DOSCODE:567D                 </span><span style="color:navy">mov     cl, </span><span style="color:green">46h         </span>; minor function = SetMediaId (46h)
<span style="color:maroon">DOSCODE:567F                 </span><span style="color:navy">or      si, si
</span><span style="color:maroon">DOSCODE:5681                 </span><span style="color:navy">jz      short </span>doioctl2  ; FAT32 fs
<span style="color:maroon">DOSCODE:5683
DOSCODE:5683 </span>doioctl1<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5683                 </span><span style="color:navy">or      si, si
</span><span style="color:maroon">DOSCODE:5685                 </span><span style="color:navy">jnz     short </span>doioctl   ; FAT fs (FAT12, FAT16)
<span style="color:maroon">DOSCODE:5687                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:5688                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:5689                 </span><span style="color:navy">mov     si, dx          </span>; disk info
<span style="color:maroon">DOSCODE:5689                                         </span>; .................................
<span style="color:maroon">DOSCODE:5689                                         </span>; 00h    WORD    0000h (info level)
<span style="color:maroon">DOSCODE:5689                                         </span>; 02h    DWORD   disk serial number (binary)
<span style="color:maroon">DOSCODE:5689                                         </span>; 06h 11 BYTEs   volume label or &quot;NO NAME    &quot; if none present
<span style="color:maroon">DOSCODE:5689                                         </span>; 11h  8 BYTEs   (AL=00h only) filesystem type
<span style="color:maroon">DOSCODE:5689                                         </span>;     &quot;FAT12   &quot;
<span style="color:maroon">DOSCODE:5689                                         </span>;     &quot;FAT16   &quot;
<span style="color:maroon">DOSCODE:5689                                         </span>;     &quot;FAT32   &quot; ; PCDOS 7.1
<span style="color:maroon">DOSCODE:5689                                         </span>;     &quot;CDROM   &quot;
<span style="color:maroon">DOSCODE:5689                                         </span>;     &quot;CD001   &quot;
<span style="color:maroon">DOSCODE:5689                                         </span>;     &quot;CDAUDIO &quot;
<span style="color:maroon">DOSCODE:5689                                         </span>; .................................
<span style="color:maroon">DOSCODE:5689                                         </span>; ; (ref: Ralf Brown&#039;s Interrupt List)
<span style="color:maroon">DOSCODE:568B                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">11h</span><span style="color:navy">], </span><span style="color:#ff8000">4146h </span>; &#039;FA&#039;
<span style="color:maroon">DOSCODE:5690                 </span><span style="color:navy">jnz     short </span>doioctl
<span style="color:maroon">DOSCODE:5692                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">13h</span><span style="color:navy">], </span><span style="color:#ff8000">3354h </span>; &#039;T3&#039;
<span style="color:maroon">DOSCODE:5697                 </span><span style="color:navy">jnz     short </span>doioctl
<span style="color:maroon">DOSCODE:5699                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">15h</span><span style="color:navy">], </span><span style="color:#ff8000">2032h </span>; &#039;2 &#039;
<span style="color:maroon">DOSCODE:569E                 </span><span style="color:navy">jnz     short </span>doioctl
<span style="color:maroon">DOSCODE:56A0                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">17h</span><span style="color:navy">], </span><span style="color:#ff8000">2020h </span>; &#039;  &#039;
<span style="color:maroon">DOSCODE:56A5                 </span><span style="color:navy">jnz     short </span>doioctl
<span style="color:maroon">DOSCODE:56A7
DOSCODE:56A7 </span>doioctl2<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:56A7                 </span><span style="color:navy">mov     ch, </span><span style="color:green">48h         </span>; new generic ioctl function (FAT32)
<span style="color:maroon">DOSCODE:56A7                                         </span>; (major function bit 6 is 1)
<span style="color:maroon">DOSCODE:56A9
DOSCODE:56A9 </span>doioctl<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:56A9                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:56AA                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:56AB                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Dh         </span>; generic IOCTL
<span style="color:maroon">DOSCODE:56AD                 </span><span style="color:navy">call    </span>$IOCTL          ; let IOCTL take care of it
<span style="color:maroon">DOSCODE:56B0                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:56B1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:56B1
DOSCODE:56B1 </span>errorfunc<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:56B1                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; error_invalid_function
<span style="color:maroon">DOSCODE:56B3                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:black">DOSCODE:56B6
DOSCODE:56B6 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:56B6
DOSCODE:56B6
DOSCODE:56B6 </span>StrCmp          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:56B6                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:56B7                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:56B8                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:56B9
DOSCODE:56B9 </span><span style="color:gray">Cmplp</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:56B9                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:56BA                 </span><span style="color:navy">call    </span>UCase           ; convert to upper case
<span style="color:black">DOSCODE:56BD                 </span><span style="color:navy">call    </span>PATHCHRCMP      ; convert &#039;/&#039; to &#039;\&#039;
<span style="color:black">DOSCODE:56C0                 </span><span style="color:navy">mov     ah, al
</span><span style="color:black">DOSCODE:56C2                 </span><span style="color:navy">mov     al, es:[di]
</span><span style="color:black">DOSCODE:56C5                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:56C6                 </span><span style="color:navy">call    </span>UCase
<span style="color:black">DOSCODE:56C9                 </span><span style="color:navy">call    </span>PATHCHRCMP
<span style="color:black">DOSCODE:56CC                 </span><span style="color:navy">cmp     ah, al
</span><span style="color:black">DOSCODE:56CE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">PopRet    </span>; Strings dif
<span style="color:black">DOSCODE:56D0                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:56D2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">Cmplp     </span>; More string
<span style="color:black">DOSCODE:56D4
DOSCODE:56D4 </span><span style="color:gray">PopRet</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:56D4                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:56D5                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:56D6                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:56D7                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:56D7 </span>StrCmp          <span style="color:black">endp
DOSCODE:56D7
DOSCODE:56D8
DOSCODE:56D8 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:56D8
DOSCODE:56D8
DOSCODE:56D8 </span>StrCpy          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:56D8                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:56D9
DOSCODE:56D9 </span><span style="color:gray">CPYLoop</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:56D9                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:56DA                 </span><span style="color:navy">call    </span>UCase           ; convert to upper case
<span style="color:black">DOSCODE:56DD                 </span><span style="color:navy">call    </span>PATHCHRCMP      ; convert / to \
<span style="color:black">DOSCODE:56E0                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:56E1                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:56E3                 </span><span style="color:navy">jnz     short </span><span style="color:gray">CPYLoop
</span><span style="color:black">DOSCODE:56E5                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:56E6                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:56E6 </span>StrCpy          <span style="color:black">endp
DOSCODE:56E6
DOSCODE:56E7
DOSCODE:56E7 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:56E7
DOSCODE:56E7
DOSCODE:56E7 </span>FStrCpy         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:56E7                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:56E8
DOSCODE:56E8 </span><span style="color:gray">FCPYLoop</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:56E8                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:56E9                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:56EA                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:56EC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">FCPYLoop
</span><span style="color:black">DOSCODE:56EE                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:56EF                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:56EF </span>FStrCpy         <span style="color:black">endp
DOSCODE:56EF
DOSCODE:56F0
DOSCODE:56F0 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:56F0
DOSCODE:56F0
DOSCODE:56F0 </span>StrLen          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:56F0                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:56F1                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:56F2                 </span><span style="color:navy">mov     cx, </span><span style="color:green">65535       </span>; -1 ; 0FFFFh
<span style="color:black">DOSCODE:56F5                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">DOSCODE:56F7                 </span><span style="color:navy">repne scasb
</span><span style="color:black">DOSCODE:56F9                 </span><span style="color:navy">not     cx
</span><span style="color:black">DOSCODE:56FB                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:56FC                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:56FD                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:56FD </span>StrLen          <span style="color:black">endp
DOSCODE:56FD
DOSCODE:56FE
DOSCODE:56FE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:56FE
DOSCODE:56FE
DOSCODE:56FE </span>DStrLen         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:56FE                 </span><span style="color:navy">call    </span>XCHGP
<span style="color:black">DOSCODE:5701                 </span><span style="color:navy">call    </span>StrLen
<span style="color:black">DOSCODE:5704                 </span><span style="color:navy">call    </span>XCHGP
<span style="color:black">DOSCODE:5707                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5707 </span>DStrLen         <span style="color:black">endp
DOSCODE:5707
DOSCODE:5708
DOSCODE:5708 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5708
DOSCODE:5708
DOSCODE:5708 </span>XCHGP           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5708                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:5709                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:570A                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:570B                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:570C                 </span><span style="color:navy">xchg    si, di
</span><span style="color:black">DOSCODE:570E
DOSCODE:570E </span>xchgp_retn<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:570E                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:570E </span>XCHGP           <span style="color:black">endp
DOSCODE:570E
DOSCODE:570F
DOSCODE:570F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:570F
DOSCODE:570F
DOSCODE:570F </span>Idle            <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:570F                 </span><span style="color:navy">cmp     ss:</span>FSHARING<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:5715                 </span><span style="color:navy">jnz     short </span>xchgp_retn
<span style="color:black">DOSCODE:5717                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:5718                 </span><span style="color:navy">mov     cx, ss:</span>RetryLoop
<span style="color:black">DOSCODE:571D                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">Idle3
</span><span style="color:black">DOSCODE:571F
DOSCODE:571F </span><span style="color:gray">Idle1</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:571F                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:5720                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:5722
DOSCODE:5722 </span><span style="color:gray">Idle2</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5722                 </span><span style="color:navy">loop    </span><span style="color:gray">Idle2
</span><span style="color:black">DOSCODE:5724                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:5725                 </span><span style="color:navy">loop    </span><span style="color:gray">Idle1
</span><span style="color:black">DOSCODE:5727
DOSCODE:5727 </span><span style="color:gray">Idle3</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5727                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:5728                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5728 </span>Idle            <span style="color:black">endp
DOSCODE:5728
DOSCODE:5729
DOSCODE:5729 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5729
DOSCODE:5729 </span><span style="color:gray">; Attributes: bp-based frame
</span><span style="color:black">DOSCODE:5729
DOSCODE:5729 </span>TableDispatch   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5729
DOSCODE:5729 </span><span style="color:green">TFrame.Index    </span><span style="color:navy">= byte ptr  </span><span style="color:#008040">4
</span><span style="color:black">DOSCODE:5729 </span><span style="color:green">TFrame.Tab      </span><span style="color:navy">= word ptr  </span><span style="color:#008040">6
</span><span style="color:black">DOSCODE:5729
DOSCODE:5729                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:572A                 </span><span style="color:navy">mov     bp, sp
</span><span style="color:black">DOSCODE:572C                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:572D                 </span><span style="color:navy">mov     bx, [bp+</span><span style="color:green">TFrame.Tab</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:5730                 </span><span style="color:navy">mov     bl, cs:[bx]
</span><span style="color:black">DOSCODE:5733                 </span><span style="color:navy">cmp     [bp+</span><span style="color:green">TFrame.Index</span><span style="color:navy">], bl
</span><span style="color:black">DOSCODE:5736                 </span><span style="color:navy">jnb     short </span><span style="color:gray">TableError
</span><span style="color:black">DOSCODE:5738                 </span><span style="color:navy">mov     bl, [bp+</span><span style="color:green">TFrame.Index</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:573B                 </span><span style="color:navy">xor     bh, bh
</span><span style="color:black">DOSCODE:573D                 </span><span style="color:navy">shl     bx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:573F                 </span><span style="color:navy">inc     bx
</span><span style="color:black">DOSCODE:5740                 </span><span style="color:navy">add     bx, [bp+</span><span style="color:green">TFrame.Tab</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:5743                 </span><span style="color:navy">mov     bx, cs:[bx]
</span><span style="color:black">DOSCODE:5746                 </span><span style="color:navy">mov     [bp+</span><span style="color:green">TFrame.Tab</span><span style="color:navy">], bx
</span><span style="color:black">DOSCODE:5749                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:574A                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:574B                 </span><span style="color:navy">add     sp, </span><span style="color:green">4
</span><span style="color:black">DOSCODE:574E                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:574F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:574F
DOSCODE:574F </span><span style="color:gray">TableError</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:574F                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:5750                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:5751                 </span><span style="color:navy">retn    </span><span style="color:green">6
</span><span style="color:black">DOSCODE:5751 </span><span style="background:red">TableDispatch   endp</span><span style="background:red"> ; sp-analysis failed</span>
<span style="color:black">DOSCODE:5751
DOSCODE:5754
DOSCODE:5754 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5754
DOSCODE:5754
DOSCODE:5754 </span>TestNet         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5754                 </span><span style="color:navy">mov     es, cs:</span>DosDSeg
<span style="color:black">DOSCODE:5759                 </span><span style="color:navy">les     di, es:</span>THISCDS
<span style="color:black">DOSCODE:575E                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:black">DOSCODE:5761                 </span><span style="color:navy">jz      short </span><span style="color:gray">CMCRet    </span>; UNC? carry is clear
<span style="color:black">DOSCODE:5763                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">44h</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:DI+curdir.flags+1],
<span style="color:black">DOSCODE:5763                                         </span>; (curdir_isnet&gt;&gt;8)
<span style="color:black">DOSCODE:5768                 </span><span style="color:navy">jnz     short </span><span style="color:gray">CMCRet    </span>; jump has carry clear
<span style="color:black">DOSCODE:576A                 </span><span style="color:navy">retn                    </span>; carry is clear
<span style="color:black">DOSCODE:576B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:576B
DOSCODE:576B </span><span style="color:gray">CMCRet</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:576B                 </span><span style="color:navy">cmc
</span><span style="color:black">DOSCODE:576C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:576C </span>TestNet         <span style="color:black">endp
DOSCODE:576C
DOSCODE:576D
DOSCODE:576D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:576D
DOSCODE:576D
DOSCODE:576D </span>IsSFTNet        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:576D                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:DI+SF_ENTRY.sf_flags+1],
<span style="color:black">DOSCODE:576D                                         </span>; (sf_isnet&gt;&gt;8)
<span style="color:black">DOSCODE:5772                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5772 </span>IsSFTNet        <span style="color:black">endp
DOSCODE:5772
</span><span style="color:maroon">DOSCODE:5773 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5773
DOSCODE:5773 </span>FastInit<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5773                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:5774                 </span><span style="color:navy">mov     es, cs:</span>DosDSeg
<span style="color:maroon">DOSCODE:5779                 </span><span style="color:navy">mov     di, offset </span>FastTable_2 ; points to fastxxx entry
<span style="color:maroon">DOSCODE:577C                 </span><span style="color:navy">dec     bx              </span>; decrement index
<span style="color:maroon">DOSCODE:577D                 </span><span style="color:navy">mov     dx, bx
</span><span style="color:maroon">DOSCODE:577F                 </span><span style="color:navy">shl     bx, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:5781                 </span><span style="color:navy">shl     bx, </span><span style="color:green">1           </span>; each entry is DWORD
<span style="color:maroon">DOSCODE:5783                 </span><span style="color:navy">add     di, bx
</span><span style="color:maroon">DOSCODE:5785                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:5789                 </span><span style="color:navy">mov     cx, cs          </span>; get DOS segment
<span style="color:maroon">DOSCODE:578B                 </span><span style="color:navy">cmp     ax, cx          </span>; first time installed ?
<span style="color:maroon">DOSCODE:578D                 </span><span style="color:navy">jz      short </span>ok_install ; yes
<span style="color:maroon">DOSCODE:578F                 </span><span style="color:navy">or      ax, ax
</span><span style="color:maroon">DOSCODE:5791                 </span><span style="color:navy">stc
</span><span style="color:maroon">DOSCODE:5792                 </span><span style="color:navy">jnz     short </span>FSret     ; already installed !
<span style="color:maroon">DOSCODE:5794
DOSCODE:5794 </span>ok_install<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5794                 </span><span style="color:navy">cmp     si, </span><span style="color:green">0FFFFh      </span>; Query only ?
<span style="color:maroon">DOSCODE:5797                 </span><span style="color:navy">jz      short </span>FSret     ; yes
<span style="color:maroon">DOSCODE:5799                 </span><span style="color:navy">mov     cx, ds          </span>; get FASTXXX entry segment
<span style="color:maroon">DOSCODE:579B                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], cx   </span>; initialize routine entry
<span style="color:maroon">DOSCODE:579B                                         </span>; initialize routine offset
<span style="color:maroon">DOSCODE:579F                 </span><span style="color:navy">mov     es:[di], si
</span><span style="color:maroon">DOSCODE:57A2                 </span><span style="color:navy">mov     di, offset </span>FastOpenFlg ; FastFlg
<span style="color:maroon">DOSCODE:57A5                 </span><span style="color:navy">add     di, dx          </span>; index to a FASTXXX flag
<span style="color:maroon">DOSCODE:57A7                 </span><span style="color:navy">or      byte ptr es:[di], </span><span style="color:green">80h </span>; Fast_yes
<span style="color:maroon">DOSCODE:57A7                                         </span>; indicate installed
<span style="color:maroon">DOSCODE:57AB
DOSCODE:57AB </span>FSret<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:57AB                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:57AC                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:57AD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:57AD
DOSCODE:57AD </span>FastRet<span style="color:navy">:                                </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:57AD                 </span><span style="color:navy">stc
</span><span style="color:maroon">DOSCODE:57AE                 </span><span style="color:navy">sbb     ax, ax          </span>; AX = -1, CF = 1
<span style="color:maroon">DOSCODE:57B0                 </span><span style="color:navy">retf
</span><span style="color:maroon">DOSCODE:57B1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:57B1
DOSCODE:57B1 </span>NLS_OPEN<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:57B1                 </span><span style="color:navy">mov     al, cl          </span>; set up correct interface for $OPEN
<span style="color:maroon">DOSCODE:57B3                 </span><span style="color:navy">call    </span>$OPEN
<span style="color:maroon">DOSCODE:57B6                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:57B7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:57B7
DOSCODE:57B7 </span>NLS_LSEEK<span style="color:navy">:                              </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:57B7                 </span><span style="color:navy">push    ss:</span>USER_SP      ; save user stack
<span style="color:maroon">DOSCODE:57BC                 </span><span style="color:navy">push    ss:</span>USER_SS
<span style="color:maroon">DOSCODE:57C1                 </span><span style="color:navy">call    </span>Fake_User_Stack
<span style="color:maroon">DOSCODE:57C4                 </span><span style="color:navy">mov     ax, bp          </span>; set up correct interface for $LSEEK
<span style="color:maroon">DOSCODE:57C6                 </span><span style="color:navy">call    </span>$LSEEK
<span style="color:maroon">DOSCODE:57C9
DOSCODE:57C9 </span>NLS_SEEK_RET<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:57C9                 </span><span style="color:navy">pop     ss:</span>USER_SS      ; restore user stack
<span style="color:maroon">DOSCODE:57CE                 </span><span style="color:navy">pop     ss:</span>USER_SP
<span style="color:maroon">DOSCODE:57D3                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:57D4
DOSCODE:57D4 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:57D4
DOSCODE:57D4
DOSCODE:57D4 </span>Fake_User_Stack <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:57D4                 </span><span style="color:navy">mov     ax, ss:</span>USER_SP_2F ; replace with INT 2Fh stack
<span style="color:black">DOSCODE:57D8                 </span><span style="color:navy">mov     ss:</span>USER_SP<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:57DC                 </span><span style="color:navy">mov     ax, ss
</span><span style="color:black">DOSCODE:57DE                 </span><span style="color:navy">mov     ss:</span>USER_SS<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:57E2                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:57E2 </span>Fake_User_Stack <span style="color:black">endp
DOSCODE:57E2
</span><span style="color:maroon">DOSCODE:57E3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:57E3
DOSCODE:57E3 </span>GetDevList<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:57E3                 </span><span style="color:navy">mov     si, offset </span>SysInitTable
<span style="color:maroon">DOSCODE:57E6                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:maroon">DOSCODE:57EB                 </span><span style="color:navy">lds     si, [si]
</span><span style="color:maroon">DOSCODE:57ED                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">22h</span><span style="color:navy">]    </span>; [SI+SYSI.DEV]
<span style="color:maroon">DOSCODE:57F0                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">24h</span><span style="color:navy">]    </span>; [SI+SYSI.DEV+2]
<span style="color:maroon">DOSCODE:57F3                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:57F4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:57F4
DOSCODE:57F4 </span>NLS_IOCTL<span style="color:navy">:                              </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:57F4                 </span><span style="color:navy">push    ss:</span>USER_SP
<span style="color:maroon">DOSCODE:57F9                 </span><span style="color:navy">push    ss:</span>USER_SS
<span style="color:maroon">DOSCODE:57FE                 </span><span style="color:navy">call    </span>Fake_User_Stack
<span style="color:maroon">DOSCODE:5801                 </span><span style="color:navy">mov     ax, bp          </span>; set up correct interface for $IOCTL
<span style="color:maroon">DOSCODE:5803                 </span><span style="color:navy">call    </span>$IOCTL
<span style="color:maroon">DOSCODE:5806                 </span><span style="color:navy">jmp     short </span>NLS_SEEK_RET
<span style="color:maroon">DOSCODE:5808 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5808
DOSCODE:5808 </span>NLS_GETEXT<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5808                 </span><span style="color:navy">mov     ax, ss:</span>EXTERR   ; return extended error
<span style="color:maroon">DOSCODE:580C
DOSCODE:580C </span>MSG_RETRIEVAL<span style="color:navy">:                          </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:580C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:580D
DOSCODE:580D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:580D
DOSCODE:580D
DOSCODE:580D </span>ECritDisk       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:580D                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:580E                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:5810                 </span><span style="color:navy">mov     cl, ss:</span>redir_patch
<span style="color:black">DOSCODE:5815                 </span><span style="color:navy">jcxz    short </span>ECritDisk_3
<span style="color:black">DOSCODE:5817                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:5818                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:5819                 </span><span style="color:navy">mov     ax, </span><span style="color:green">8001h
</span><span style="color:black">DOSCODE:581C
DOSCODE:581C </span>ECritDisk_1<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:581C                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:581D                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:581F                 </span><span style="color:navy">mov     cl, ss:</span>IsWin386
<span style="color:black">DOSCODE:5824                 </span><span style="color:navy">jcxz    short </span>ECritDisk2
<span style="color:black">DOSCODE:5826                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:5827                 </span><span style="color:navy">int     </span><span style="color:green">2Ah             </span>; Microsoft Networks - BEGIN DOS CRITICAL SECTION
<span style="color:black">DOSCODE:5827                                         </span>; AL = critical section number (00h-0Fh)
<span style="color:black">DOSCODE:5829                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:582A                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:582B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:582B
DOSCODE:582B </span>ECritDisk2<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:582B                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:582C                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:582F                 </span><span style="color:navy">mov     es, cx
</span><span style="color:black">DOSCODE:5831                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:5831                 </span><span style="color:navy">pushf                   </span>; simulate INT 2Ah
<span style="color:black">DOSCODE:5832                 </span><span style="color:navy">call    </span>es:00A8h        ; call far (INT 2Ah vector)
<span style="color:black">DOSCODE:5837                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:5838                 </span>assume es:nothing
<span style="color:black">DOSCODE:5838                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:5839                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:583A                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:583B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:583B
DOSCODE:583B </span>ECritDisk_3<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:583B                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:583C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:583C </span>ECritDisk       <span style="color:black">endp
DOSCODE:583C
DOSCODE:583D
DOSCODE:583D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:583D
DOSCODE:583D
DOSCODE:583D </span>LCritDisk       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:583D                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:583E                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:5840                 </span><span style="color:navy">mov     cl, ss:</span>redir_patch
<span style="color:black">DOSCODE:5845                 </span><span style="color:navy">jcxz    short </span>ECritDisk_3
<span style="color:black">DOSCODE:5847                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:5848                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:5849                 </span><span style="color:navy">mov     ax, </span><span style="color:green">8101h
</span><span style="color:black">DOSCODE:584C                 </span><span style="color:navy">jmp     short </span>ECritDisk_1
<span style="color:black">DOSCODE:584C </span>LCritDisk       <span style="color:black">endp
DOSCODE:584C
DOSCODE:584E
DOSCODE:584E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:584E
DOSCODE:584E
DOSCODE:584E </span>ECritDevice     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:584E                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:584F                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:5851                 </span><span style="color:navy">mov     cl, ss:</span>redir_patch
<span style="color:black">DOSCODE:5856                 </span><span style="color:navy">jcxz    short </span>ECritDisk_3
<span style="color:black">DOSCODE:5858                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:5859                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:585A                 </span><span style="color:navy">mov     ax, </span><span style="color:green">8002h
</span><span style="color:black">DOSCODE:585D                 </span><span style="color:navy">jmp     short </span>ECritDisk_1
<span style="color:black">DOSCODE:585D </span>ECritDevice     <span style="color:black">endp
DOSCODE:585D
DOSCODE:585F
DOSCODE:585F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:585F
DOSCODE:585F
DOSCODE:585F </span>LCritDevice     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:585F                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:5860                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:5862                 </span><span style="color:navy">mov     cl, ss:</span>redir_patch
<span style="color:black">DOSCODE:5867                 </span><span style="color:navy">jcxz    short </span>ECritDisk_3
<span style="color:black">DOSCODE:5869                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:586A                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:586B                 </span><span style="color:navy">mov     ax, </span><span style="color:green">8102h
</span><span style="color:black">DOSCODE:586E                 </span><span style="color:navy">jmp     short </span>ECritDisk_1
<span style="color:black">DOSCODE:586E </span>LCritDevice     <span style="color:black">endp
DOSCODE:586E
DOSCODE:5870
DOSCODE:5870 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5870
DOSCODE:5870
DOSCODE:5870 </span>$STD_CON_INPUT_NO_ECHO <span style="color:black">proc near        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5870                 </span><span style="color:navy">push    ds              </span>; Input character from console, no echo
<span style="color:black">DOSCODE:5871                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:5872
DOSCODE:5872 </span><span style="color:gray">INTEST</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5872                 </span><span style="color:navy">call    near ptr </span>STATCHK
<span style="color:black">DOSCODE:5875                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GET
</span><span style="color:black">DOSCODE:5877                 </span><span style="color:navy">cmp     ss:</span>PRINTER_FLAG<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; is printer idle?
<span style="color:black">DOSCODE:587D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">no_sys_wait
</span><span style="color:black">DOSCODE:587F                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">5           </span>; get input status with system wait
<span style="color:black">DOSCODE:5881                 </span><span style="color:navy">call    </span>IOFUNC
<span style="color:black">DOSCODE:5884
DOSCODE:5884 </span><span style="color:gray">no_sys_wait</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5884                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">84h
</span><span style="color:black">DOSCODE:5886                 </span><span style="color:navy">int     </span><span style="color:green">2Ah             </span>; Microsoft Networks - KEYBOARD BUSY LOOP
<span style="color:black">DOSCODE:5888                 </span><span style="color:navy">cmp     byte ptr ss:</span>DATE_FLAG<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; date is updated may be every
<span style="color:black">DOSCODE:588E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NoUpdate  </span>; 255 x ? ms if no one calls
<span style="color:black">DOSCODE:5890                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:5891                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:5892                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:5893                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:5894                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:5895                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:5896                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:5897                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:5897                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:5899                 </span><span style="color:navy">call    </span>Save_Restore_Packet ; save DEVCALL packet
<span style="color:black">DOSCODE:589C                 </span><span style="color:navy">call    </span>READTIME
<span style="color:black">DOSCODE:589F                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:58A2                 </span><span style="color:navy">call    </span>Save_Restore_Packet ; restore DEVCALL packet
<span style="color:black">DOSCODE:58A5                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:58A6                 </span>assume ds:nothing
<span style="color:black">DOSCODE:58A6                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:58A7                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:58A8                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:58A9                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:58AA
DOSCODE:58AA </span><span style="color:gray">NoUpdate</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:58AA                 </span><span style="color:navy">inc     ss:</span>DATE_FLAG
<span style="color:black">DOSCODE:58AF                 </span><span style="color:navy">jmp     short </span><span style="color:gray">INTEST
</span><span style="color:black">DOSCODE:58B1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:58B1
DOSCODE:58B1 </span><span style="color:gray">GET</span><span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:58B1                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:58B3                 </span><span style="color:navy">call    </span>IOFUNC
<span style="color:black">DOSCODE:58B6                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:58B7                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:58B8                 </span><span style="color:navy">mov     ss:</span>SCAN_FLAG<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:58BE                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0           </span>; extended code ?
<span style="color:black">DOSCODE:58C0                 </span><span style="color:navy">jnz     short </span>noscan
<span style="color:black">DOSCODE:58C2                 </span><span style="color:navy">inc     ss:</span>SCAN_FLAG    ; set this flag for ALT_Q key
<span style="color:black">DOSCODE:58C7
DOSCODE:58C7 </span>noscan<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:58C7                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:58C7 </span>$STD_CON_INPUT_NO_ECHO <span style="color:black">endp
DOSCODE:58C7
</span><span style="color:maroon">DOSCODE:58C8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:58C8
DOSCODE:58C8 </span>$STD_CON_STRING_OUTPUT<span style="color:navy">:                 </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:58C8                 </span><span style="color:navy">mov     si, dx          </span>; Console String Output
<span style="color:maroon">DOSCODE:58CA
DOSCODE:58CA </span>NEXT_STR1<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:58CA                 </span><span style="color:navy">lodsb
</span><span style="color:maroon">DOSCODE:58CB                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">24h </span><span style="color:gray">; &#039;$&#039;
</span><span style="color:maroon">DOSCODE:58CD                 </span><span style="color:navy">jz      short </span>noscan
<span style="color:maroon">DOSCODE:58CF                 </span><span style="color:navy">call    </span>OUTT
<span style="color:maroon">DOSCODE:58D2                 </span><span style="color:navy">jmp     short </span>NEXT_STR1
<span style="color:black">DOSCODE:58D4
DOSCODE:58D4 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:58D4
DOSCODE:58D4
DOSCODE:58D4 </span>$STD_CON_STRING_INPUT <span style="color:black">proc near         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:58D4                 </span><span style="color:navy">push    ss              </span>; Input Line from Console
<span style="color:black">DOSCODE:58D5                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:58D6                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:58D6                 </span><span style="color:navy">mov     si, dx
</span><span style="color:black">DOSCODE:58D8                 </span><span style="color:navy">xor     ch, ch          </span>; 0
<span style="color:black">DOSCODE:58DA                 </span><span style="color:navy">lodsw
</span><span style="color:black">DOSCODE:58DB                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:58DD                 </span><span style="color:navy">jz      short </span>noscan    ; Buffer is 0 length!!?
<span style="color:black">DOSCODE:58DF                 </span><span style="color:navy">mov     bl, ah          </span>; Init template counter
<span style="color:black">DOSCODE:58E1                 </span><span style="color:navy">mov     bh, ch
</span><span style="color:black">DOSCODE:58E3                 </span><span style="color:navy">cmp     al, bl
</span><span style="color:black">DOSCODE:58E5                 </span><span style="color:navy">jbe     short </span><span style="color:gray">NOEDIT    </span>; If length of buffer inconsistent
<span style="color:black">DOSCODE:58E5                                         </span>;  with contents
<span style="color:black">DOSCODE:58E7                 </span><span style="color:navy">cmp     byte ptr [bx+si], </span><span style="color:#ff8000">0Dh </span>; c_CR
<span style="color:black">DOSCODE:58EA                 </span><span style="color:navy">jz      short </span><span style="color:gray">EDITON    </span>; If CR correctly placed EDIT is OK
<span style="color:black">DOSCODE:58EC
DOSCODE:58EC </span><span style="color:gray">NOEDIT</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:58EC                 </span><span style="color:navy">mov     bl, ch          </span>; Reset buffer
<span style="color:black">DOSCODE:58EE
DOSCODE:58EE </span><span style="color:gray">EDITON</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:58EE                 </span><span style="color:navy">mov     dl, al
</span><span style="color:black">DOSCODE:58F0                 </span><span style="color:navy">dec     dx              </span>; DL is # of bytes we can put in the buffer
<span style="color:black">DOSCODE:58F0 </span>$STD_CON_STRING_INPUT <span style="color:black">endp
DOSCODE:58F0
DOSCODE:58F1 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR FINDOLD
</span><span style="color:black">DOSCODE:58F1
DOSCODE:58F1 </span><span style="color:gray">NEWLIN</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:58F1                 </span><span style="color:navy">mov     al, ss:</span>CARPOS
<span style="color:black">DOSCODE:58F5                 </span><span style="color:navy">mov     ss:</span>STARTPOS<span style="color:navy">, al </span>; Remember position in raw buffer
<span style="color:black">DOSCODE:58F9                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:58FA                 </span><span style="color:navy">mov     di, offset </span>INBUF ; Build the new line here
<span style="color:black">DOSCODE:58FD                 </span><span style="color:navy">mov     ss:</span>INSMODE<span style="color:navy">, ch  </span>; Insert mode off
<span style="color:black">DOSCODE:5902                 </span><span style="color:navy">mov     bh, ch          </span>; No chars from template yet
<span style="color:black">DOSCODE:5904                 </span><span style="color:navy">mov     dh, ch          </span>; No chars to new line yet
<span style="color:black">DOSCODE:5906                 </span><span style="color:navy">call    </span>$STD_CON_INPUT_NO_ECHO ; Get first char
<span style="color:black">DOSCODE:5909                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; Linefeed ; c_LF
<span style="color:black">DOSCODE:590B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GOTCH
</span><span style="color:black">DOSCODE:590D
DOSCODE:590D </span>GETCH<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:590D                 </span><span style="color:navy">call    </span>$STD_CON_INPUT_NO_ECHO
<span style="color:black">DOSCODE:5910
DOSCODE:5910 </span><span style="color:gray">GOTCH</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5910                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">6           </span>; Ignore ^F
<span style="color:black">DOSCODE:5912                 </span><span style="color:navy">jz      short </span>GETCH
<span style="color:black">DOSCODE:5914                 </span><span style="color:navy">cmp     al, cs:</span>ESCCHAR  ; function-key lead byte ?
<span style="color:black">DOSCODE:5919                 </span><span style="color:navy">jz      short </span><span style="color:gray">ESCAPE    </span>; change reserved keyword
<span style="color:black">DOSCODE:591B                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">7Fh         </span>; c_DEL ; destructive backspace
<span style="color:black">DOSCODE:591D                 </span><span style="color:navy">jz      short </span>BACKSP
<span style="color:black">DOSCODE:591F                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">8           </span>; c_BS ; destructive backspaces
<span style="color:black">DOSCODE:5921                 </span><span style="color:navy">jz      short </span>BACKSP
<span style="color:black">DOSCODE:5923                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; c_CR ; CR terminates the line.
<span style="color:black">DOSCODE:5925                 </span><span style="color:navy">jz      short </span><span style="color:gray">ENDLIN
</span><span style="color:black">DOSCODE:5927                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; c_LF ; LF goes to a new line
<span style="color:black">DOSCODE:5929                 </span><span style="color:navy">jz      short </span><span style="color:gray">PHYCRLF   </span>; and keeps on reading.
<span style="color:black">DOSCODE:592B                 </span><span style="color:navy">cmp     al, cs:</span>CANCHAR  ; ^X (or ESC) deletes the line
<span style="color:black">DOSCODE:5930                 </span><span style="color:navy">jz      short </span>KILNEW    ;  and starts over
<span style="color:black">DOSCODE:5932
DOSCODE:5932 </span><span style="color:gray">SAVCH</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5932                 </span><span style="color:navy">cmp     dh, dl
</span><span style="color:black">DOSCODE:5934                 </span><span style="color:navy">jnb     short </span><span style="color:gray">BUFFUL    </span>; buffer is full
<span style="color:black">DOSCODE:5936                 </span><span style="color:navy">stosb                   </span>; save the input character
<span style="color:black">DOSCODE:5937                 </span><span style="color:navy">inc     dh              </span>; increment count in buffer
<span style="color:black">DOSCODE:5939                 </span><span style="color:navy">call    </span>BUFOUT          ; Print control chars nicely
<span style="color:black">DOSCODE:593C                 </span><span style="color:navy">cmp     ss:</span>INSMODE<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:5942                 </span><span style="color:navy">jnz     short </span>GETCH     ; insertmode =&gt; don&#039;t advance template
<span style="color:black">DOSCODE:5944                 </span><span style="color:navy">cmp     bh, bl
</span><span style="color:black">DOSCODE:5946                 </span><span style="color:navy">jnb     short </span>GETCH     ; no more characters in template
<span style="color:black">DOSCODE:5948                 </span><span style="color:navy">inc     si              </span>; Skip to next char in template
<span style="color:black">DOSCODE:5949                 </span><span style="color:navy">inc     bh              </span>; remember position in template
<span style="color:black">DOSCODE:594B                 </span><span style="color:navy">jmp     short </span>GETCH
<span style="color:black">DOSCODE:594D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:594D
DOSCODE:594D </span><span style="color:gray">BUFFUL</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:594D                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">7           </span>; Bell to signal full buffer
<span style="color:black">DOSCODE:594F                 </span><span style="color:navy">call    </span>OUTT
<span style="color:black">DOSCODE:5952                 </span><span style="color:navy">jmp     short </span>GETCH
<span style="color:black">DOSCODE:5954 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5954
DOSCODE:5954 </span><span style="color:gray">ESCAPE</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5954                 </span><span style="color:navy">jmp     </span><span style="color:gray">OEMFunctionKey  </span>; let the OEM&#039;s handle the key dispatch
<span style="color:black">DOSCODE:5957 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5957
DOSCODE:5957 </span><span style="color:gray">ENDLIN</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5957                 </span><span style="color:navy">stosb                   </span>; Put the CR in the buffer
<span style="color:black">DOSCODE:5958                 </span><span style="color:navy">call    </span>OUTT            ; Echo it
<span style="color:black">DOSCODE:595B                 </span><span style="color:navy">pop     di              </span>; Get start of user buffer
<span style="color:black">DOSCODE:595C                 </span><span style="color:navy">mov     [di-</span><span style="color:green">1</span><span style="color:navy">], dh      </span>; Tell user how many bytes
<span style="color:black">DOSCODE:595F                 </span><span style="color:navy">inc     dh              </span>; DH is length including CR
<span style="color:black">DOSCODE:5961
DOSCODE:5961 </span>COPYNEW<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5961                 </span><span style="color:navy">push    ds              </span>; XCHG ES,DS
<span style="color:black">DOSCODE:5962                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:5963                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:5964                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:5964                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:5965                 </span>assume es:nothing
<span style="color:black">DOSCODE:5965                 </span><span style="color:navy">mov     si, offset </span>INBUF
<span style="color:black">DOSCODE:5968                 </span><span style="color:navy">mov     cl, dh          </span>; set up count
<span style="color:black">DOSCODE:596A                 </span><span style="color:navy">rep movsb               </span>; Copy final line to user buffer
<span style="color:black">DOSCODE:596A </span><span style="color:gray">; END OF FUNCTION CHUNK FOR FINDOLD
</span><span style="color:maroon">DOSCODE:596C
DOSCODE:596C </span>OLDBAK_RETN<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:596C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:596D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:596D </span><span style="color:gray">; START OF FUNCTION CHUNK FOR FINDOLD
</span><span style="color:black">DOSCODE:596D
DOSCODE:596D </span><span style="color:gray">PHYCRLF</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:596D                 </span><span style="color:navy">call    </span>CRLF            ; Output a CRLF to the user screen
<span style="color:black">DOSCODE:596D                                         </span>; and do NOT store it into the buffer
<span style="color:black">DOSCODE:5970
DOSCODE:5970 </span><span style="color:gray">GETCH_j</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5970                 </span><span style="color:navy">jmp     short </span>GETCH
<span style="color:black">DOSCODE:5970 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR FINDOLD
</span><span style="color:maroon">DOSCODE:5972 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5972
DOSCODE:5972 </span>LineDel<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5972                 </span><span style="color:navy">or      dh, dh          </span>; Delete the previous line
<span style="color:maroon">DOSCODE:5974                 </span><span style="color:navy">jz      short </span>GETCH
<span style="color:maroon">DOSCODE:5976                 </span><span style="color:navy">call    </span>BackSpace
<span style="color:maroon">DOSCODE:5979                 </span><span style="color:navy">jmp     short </span>LineDel
<span style="color:black">DOSCODE:597B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:597B </span><span style="color:gray">; START OF FUNCTION CHUNK FOR FINDOLD
</span><span style="color:black">DOSCODE:597B
DOSCODE:597B </span>KILNEW<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:597B                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">5Ch </span><span style="color:gray">; &#039;\&#039;
</span><span style="color:black">DOSCODE:597D                 </span><span style="color:navy">call    </span>OUTT            ; Print the CANCEL indicator
<span style="color:black">DOSCODE:5980                 </span><span style="color:navy">pop     si              </span>; Remember start of edit buffer
<span style="color:black">DOSCODE:5981
DOSCODE:5981 </span><span style="color:gray">PUTNEW</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5981                 </span><span style="color:navy">call    </span>CRLF            ; Go to next line on screen
<span style="color:black">DOSCODE:5984                 </span><span style="color:navy">mov     al, ss:</span>STARTPOS
<span style="color:black">DOSCODE:5988                 </span><span style="color:navy">call    </span>TAB             ; Tab over
<span style="color:black">DOSCODE:598B                 </span><span style="color:navy">jmp     </span><span style="color:gray">NEWLIN          </span>; Start over again
<span style="color:black">DOSCODE:598E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:598E
DOSCODE:598E </span>BACKSP<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:598E                 </span><span style="color:navy">call    </span>BackSpace       ; Destructively back up one char position
<span style="color:black">DOSCODE:5991                 </span><span style="color:navy">jmp     short </span><span style="color:gray">GETCH_j
</span><span style="color:black">DOSCODE:5991 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR FINDOLD
</span><span style="color:black">DOSCODE:5993
DOSCODE:5993 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5993
DOSCODE:5993
DOSCODE:5993 </span>BackSpace       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5993                 </span><span style="color:navy">or      dh, dh
</span><span style="color:black">DOSCODE:5995                 </span><span style="color:navy">jz      short </span>OLDBAK    ; No chars in line,
<span style="color:black">DOSCODE:5995                                         </span>;  do nothing to line
<span style="color:black">DOSCODE:5997                 </span><span style="color:navy">call    </span>BACKUP          ; Do the backup
<span style="color:black">DOSCODE:599A                 </span><span style="color:navy">mov     al, es:[di]     </span>; Get the deleted char
<span style="color:black">DOSCODE:599D                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;   </span>; Was a normal char
<span style="color:black">DOSCODE:599F                 </span><span style="color:navy">jnb     short </span>OLDBAK
<span style="color:black">DOSCODE:59A1                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">9
</span><span style="color:black">DOSCODE:59A3                 </span><span style="color:navy">jz      short </span>BAKTAB    ; Was a tab, fix up users display
<span style="color:black">DOSCODE:59A5                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">15h         </span>; &quot;U&quot;-&quot;@&quot; ; ctrl-U is a section symbol
<span style="color:black">DOSCODE:59A5                                         </span>;  not ^U
<span style="color:black">DOSCODE:59A7                 </span><span style="color:navy">jz      short </span>OLDBAK
<span style="color:black">DOSCODE:59A9                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">14h         </span>; &quot;T&quot;-&quot;@&quot; ; ctrl-T is a paragraphs symbol
<span style="color:black">DOSCODE:59A9                                         </span>;  not ^T
<span style="color:black">DOSCODE:59AB                 </span><span style="color:navy">jz      short </span>OLDBAK
<span style="color:black">DOSCODE:59AD                 </span><span style="color:navy">call    </span>BACKMES
<span style="color:black">DOSCODE:59B0
DOSCODE:59B0 </span>OLDBAK<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:59B0                 </span><span style="color:navy">cmp     ss:</span>INSMODE<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:59B6                 </span><span style="color:navy">jnz     short </span>OLDBAK_RETN ; In insert mode, done
<span style="color:black">DOSCODE:59B8                 </span><span style="color:navy">or      bh, bh
</span><span style="color:black">DOSCODE:59BA                 </span><span style="color:navy">jz      short </span>OLDBAK_RETN ;
<span style="color:black">DOSCODE:59BA                                         </span>; Not advanced in template,
<span style="color:black">DOSCODE:59BA                                         </span>;  stay where we are
<span style="color:black">DOSCODE:59BC                 </span><span style="color:navy">dec     bh              </span>; Go back in template
<span style="color:black">DOSCODE:59BE                 </span><span style="color:navy">dec     si
</span><span style="color:black">DOSCODE:59BF                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:59C0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:59C0
DOSCODE:59C0 </span>BAKTAB<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:59C0                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:59C1                 </span><span style="color:navy">dec     di              </span>; Back up one char
<span style="color:black">DOSCODE:59C2                 </span><span style="color:navy">std                     </span>; Go backward
<span style="color:black">DOSCODE:59C3                 </span><span style="color:navy">mov     cl, dh          </span>; Number of chars currently in line
<span style="color:black">DOSCODE:59C5                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">DOSCODE:59C7                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:59C8                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">7           </span>; Max
<span style="color:black">DOSCODE:59CA                 </span><span style="color:navy">jcxz    short </span>FIGTAB    ; At start, do nothing
<span style="color:black">DOSCODE:59CC
DOSCODE:59CC </span>FNDPOS<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:59CC                 </span><span style="color:navy">scasb                   </span>; Look back
<span style="color:black">DOSCODE:59CD                 </span><span style="color:navy">jbe     short </span>CHKCNT
<span style="color:black">DOSCODE:59CF                 </span><span style="color:navy">cmp     byte ptr es:[di+</span><span style="color:#ff8000">1</span><span style="color:navy">], </span><span style="color:#ff8000">9
</span><span style="color:black">DOSCODE:59D4                 </span><span style="color:navy">jz      short </span>HAVTAB    ; Found a tab
<span style="color:black">DOSCODE:59D6                 </span><span style="color:navy">dec     bl              </span>; Back one char if non tab control char
<span style="color:black">DOSCODE:59D8
DOSCODE:59D8 </span>CHKCNT<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:59D8                 </span><span style="color:navy">loop    </span>FNDPOS
<span style="color:black">DOSCODE:59DA
DOSCODE:59DA </span>FIGTAB<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:59DA                 </span><span style="color:navy">sub     bl, ss:</span>STARTPOS
<span style="color:black">DOSCODE:59DF
DOSCODE:59DF </span>HAVTAB<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:59DF                 </span><span style="color:navy">sub     bl, dh
</span><span style="color:black">DOSCODE:59E1                 </span><span style="color:navy">add     cl, bl
</span><span style="color:black">DOSCODE:59E3                 </span><span style="color:navy">and     cl, </span><span style="color:green">7           </span>; CX has correct number to erase
<span style="color:black">DOSCODE:59E6                 </span><span style="color:navy">cld                     </span>; Back to normal
<span style="color:black">DOSCODE:59E7                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:59E8                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:59E9                 </span><span style="color:navy">jz      short </span>OLDBAK    ; Nothing to erase
<span style="color:black">DOSCODE:59EB
DOSCODE:59EB </span>TABBAK<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:59EB                 </span><span style="color:navy">call    </span>BACKMES
<span style="color:black">DOSCODE:59EE                 </span><span style="color:navy">loop    </span>TABBAK          ; Erase correct number of chars
<span style="color:black">DOSCODE:59F0                 </span><span style="color:navy">jmp     short </span>OLDBAK
<span style="color:black">DOSCODE:59F0 </span>BackSpace       <span style="color:black">endp
DOSCODE:59F0
DOSCODE:59F2
DOSCODE:59F2 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:59F2
DOSCODE:59F2
DOSCODE:59F2 </span>BACKUP          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:59F2                 </span><span style="color:navy">dec     dh              </span>; Back up in line
<span style="color:black">DOSCODE:59F4                 </span><span style="color:navy">dec     di
</span><span style="color:black">DOSCODE:59F4 </span>BACKUP          <span style="color:black">endp
DOSCODE:59F4
DOSCODE:59F5
DOSCODE:59F5 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:59F5
DOSCODE:59F5
DOSCODE:59F5 </span>BACKMES         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:59F5                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">8           </span>; c_BS ; Backspace
<span style="color:black">DOSCODE:59F7                 </span><span style="color:navy">call    </span>OUTT
<span style="color:black">DOSCODE:59FA                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;   </span>; SPACE char ; Erase
<span style="color:black">DOSCODE:59FC                 </span><span style="color:navy">call    </span>OUTT
<span style="color:black">DOSCODE:59FF                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">8           </span>; Backspace
<span style="color:black">DOSCODE:5A01                 </span><span style="color:navy">jmp     </span>OUTT            ; Done
<span style="color:black">DOSCODE:5A01 </span>BACKMES         <span style="color:black">endp
DOSCODE:5A01
DOSCODE:5A04 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5A04 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR FINDOLD
</span><span style="color:black">DOSCODE:5A04
DOSCODE:5A04 </span>TWOESC<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5A04                 </span><span style="color:navy">mov     al, cs:</span>ESCCHAR  ; User really wants an ESC character
<span style="color:black">DOSCODE:5A04                                         </span>;  in his line
<span style="color:black">DOSCODE:5A08                 </span><span style="color:navy">jmp     </span><span style="color:gray">SAVCH
</span><span style="color:black">DOSCODE:5A0B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5A0B
DOSCODE:5A0B </span>COPYLIN<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5A0B                 </span><span style="color:navy">mov     cl, bl          </span>; Total size of template
<span style="color:black">DOSCODE:5A0D                 </span><span style="color:navy">sub     cl, bh          </span>; Minus position in template,
<span style="color:black">DOSCODE:5A0D                                         </span>;  is number to move
<span style="color:black">DOSCODE:5A0F                 </span><span style="color:navy">jmp     short </span><span style="color:gray">COPYEACH
</span><span style="color:black">DOSCODE:5A11 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5A11
DOSCODE:5A11 </span>COPYSTR<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5A11                 </span><span style="color:navy">call    </span>FINDOLD         ; Find the char
<span style="color:black">DOSCODE:5A14                 </span><span style="color:navy">jmp     short </span><span style="color:gray">COPYEACH  </span>; Copy up to it
<span style="color:black">DOSCODE:5A16 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5A16
DOSCODE:5A16 </span>COPYONE<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5A16                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:5A18
DOSCODE:5A18 </span><span style="color:gray">COPYEACH</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5A18                 </span><span style="color:navy">mov     ss:</span>INSMODE<span style="color:navy">, </span><span style="color:#ff8000">0   </span>; All copies turn off insert mode
<span style="color:black">DOSCODE:5A1E                 </span><span style="color:navy">cmp     dh, dl
</span><span style="color:black">DOSCODE:5A20                 </span><span style="color:navy">jz      short </span>GETCH2    ; At end of line, can&#039;t do anything
<span style="color:black">DOSCODE:5A22                 </span><span style="color:navy">cmp     bh, bl
</span><span style="color:black">DOSCODE:5A24                 </span><span style="color:navy">jz      short </span>GETCH2    ; At end of template, can&#039;t do anything
<span style="color:black">DOSCODE:5A26                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:5A27                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:5A28                 </span><span style="color:navy">call    </span>BUFOUT
<span style="color:black">DOSCODE:5A2B                 </span><span style="color:navy">inc     bh              </span>; Ahead in template
<span style="color:black">DOSCODE:5A2D                 </span><span style="color:navy">inc     dh              </span>; Ahead in line
<span style="color:black">DOSCODE:5A2F                 </span><span style="color:navy">loop    </span><span style="color:gray">COPYEACH
</span><span style="color:black">DOSCODE:5A31
DOSCODE:5A31 </span>GETCH2<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5A31                 </span><span style="color:navy">jmp     </span>GETCH
<span style="color:black">DOSCODE:5A34 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5A34
DOSCODE:5A34 </span>SKIPONE<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5A34                 </span><span style="color:navy">cmp     bh, bl
</span><span style="color:black">DOSCODE:5A36                 </span><span style="color:navy">jz      short </span>GETCH2    ; At end of template
<span style="color:black">DOSCODE:5A38                 </span><span style="color:navy">inc     bh              </span>; Ahead in template
<span style="color:black">DOSCODE:5A3A                 </span><span style="color:navy">inc     si
</span><span style="color:black">DOSCODE:5A3B                 </span><span style="color:navy">jmp     short </span>GETCH2
<span style="color:black">DOSCODE:5A3D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5A3D
DOSCODE:5A3D </span>SKIPSTR<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5A3D                 </span><span style="color:navy">call    </span>FINDOLD         ; Find out how far to go
<span style="color:black">DOSCODE:5A40                 </span><span style="color:navy">add     si, cx          </span>; Go there
<span style="color:black">DOSCODE:5A42                 </span><span style="color:navy">add     bh, cl
</span><span style="color:black">DOSCODE:5A44                 </span><span style="color:navy">jmp     short </span>GETCH2
<span style="color:black">DOSCODE:5A44 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR FINDOLD
</span><span style="color:black">DOSCODE:5A46
DOSCODE:5A46 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5A46
DOSCODE:5A46
DOSCODE:5A46 </span>FINDOLD         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5A46
DOSCODE:5A46 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:4967 SIZE 00000019 BYTES
</span><span style="color:black">DOSCODE:5A46 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:58F1 SIZE 0000007B BYTES
</span><span style="color:black">DOSCODE:5A46 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:596D SIZE 00000005 BYTES
</span><span style="color:black">DOSCODE:5A46 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:597B SIZE 00000018 BYTES
</span><span style="color:black">DOSCODE:5A46 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:5A04 SIZE 00000042 BYTES
</span><span style="color:black">DOSCODE:5A46
DOSCODE:5A46                 </span><span style="color:navy">call    </span>$STD_CON_INPUT_NO_ECHO
<span style="color:black">DOSCODE:5A49                 </span><span style="color:navy">cmp     al, cs:</span>ESCCHAR  ; did he type a function key?
<span style="color:black">DOSCODE:5A4E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">FINDSETUP </span>; no, set up for scan
<span style="color:black">DOSCODE:5A50                 </span><span style="color:navy">call    </span>$STD_CON_INPUT_NO_ECHO ; eat next char
<span style="color:black">DOSCODE:5A53                 </span><span style="color:navy">jmp     short </span><span style="color:gray">NOTFND    </span>; go try again
<span style="color:black">DOSCODE:5A55 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5A55
DOSCODE:5A55 </span><span style="color:gray">FINDSETUP</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5A55                 </span><span style="color:navy">mov     cl, bl
</span><span style="color:black">DOSCODE:5A57                 </span><span style="color:navy">sub     cl, bh          </span>; CX is number of chars to end of template
<span style="color:black">DOSCODE:5A59                 </span><span style="color:navy">jz      short </span><span style="color:gray">NOTFND    </span>; At end of template
<span style="color:black">DOSCODE:5A5B                 </span><span style="color:navy">dec     cx              </span>; Cannot point past end, limit search
<span style="color:black">DOSCODE:5A5C                 </span><span style="color:navy">jz      short </span><span style="color:gray">NOTFND    </span>; If only one char in template, forget it
<span style="color:black">DOSCODE:5A5E                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:5A5F                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:5A60                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:5A61                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:5A61                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:5A62                 </span><span style="color:navy">mov     di, si          </span>; Template to ES:DI
<span style="color:black">DOSCODE:5A64                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:5A65                 </span><span style="color:navy">repne scasb             </span>; Look
<span style="color:black">DOSCODE:5A67                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:5A68                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:5A69                 </span>assume es:nothing
<span style="color:black">DOSCODE:5A69                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOTFND    </span>; Didn&#039;t find the char
<span style="color:black">DOSCODE:5A6B                 </span><span style="color:navy">not     cl              </span>; Turn how far to go into how far we went
<span style="color:black">DOSCODE:5A6D                 </span><span style="color:navy">add     cl, bl          </span>; Add size of template
<span style="color:black">DOSCODE:5A6F                 </span><span style="color:navy">sub     cl, bh          </span>; Subtract current pos,
<span style="color:black">DOSCODE:5A6F                                         </span>;  result distance to skip
<span style="color:black">DOSCODE:5A71
DOSCODE:5A71 </span>FINDOLD_RETN<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5A71                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5A72 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5A72
DOSCODE:5A72 </span><span style="color:gray">NOTFND</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5A72                 </span><span style="color:navy">pop     bp              </span>; Chuck return address
<span style="color:black">DOSCODE:5A73
DOSCODE:5A73 </span><span style="color:gray">GETCH2_j</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5A73                 </span><span style="color:navy">jmp     short </span>GETCH2
<span style="color:black">DOSCODE:5A75 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5A75
DOSCODE:5A75 </span>REEDIT<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5A75                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">40h </span><span style="color:gray">; &#039;@&#039;   </span>; Output re-edit character
<span style="color:black">DOSCODE:5A77                 </span><span style="color:navy">call    </span>OUTT
<span style="color:black">DOSCODE:5A7A                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:5A7B                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:5A7C                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:5A7D                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:5A7E                 </span><span style="color:navy">call    </span>COPYNEW         ; Copy current line into template
<span style="color:black">DOSCODE:5A81                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:5A82                 </span>assume ds:nothing
<span style="color:black">DOSCODE:5A82                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:5A83                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:5A84                 </span><span style="color:navy">mov     bl, dh          </span>; Size of line is new size template
<span style="color:black">DOSCODE:5A86                 </span><span style="color:navy">jmp     </span><span style="color:gray">PUTNEW          </span>; Start over again
<span style="color:black">DOSCODE:5A89 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5A89
DOSCODE:5A89 </span>EXITINS<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5A89                 </span><span style="color:navy">not     ss:</span>INSMODE      ; ENTERINS
<span style="color:black">DOSCODE:5A8E                 </span><span style="color:navy">jmp     short </span><span style="color:gray">GETCH2_j
</span><span style="color:black">DOSCODE:5A90 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5A90
DOSCODE:5A90 </span>CTRLZ<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5A90                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1Ah         </span>; &quot;Z&quot;-&quot;@&quot;
<span style="color:black">DOSCODE:5A92                 </span><span style="color:navy">jmp     </span><span style="color:gray">SAVCH
</span><span style="color:black">DOSCODE:5A92 </span><span style="background:red">FINDOLD         endp</span><span style="background:red"> ; sp-analysis failed</span>
<span style="color:black">DOSCODE:5A92
DOSCODE:5A95
DOSCODE:5A95 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5A95
DOSCODE:5A95
DOSCODE:5A95 </span>CRLF            <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5A95                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Dh         </span>; c_CR
<span style="color:black">DOSCODE:5A97                 </span><span style="color:navy">call    </span>OUTT
<span style="color:black">DOSCODE:5A9A                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Ah         </span>; c_LF
<span style="color:black">DOSCODE:5A9C                 </span><span style="color:navy">jmp     </span>OUTT
<span style="color:black">DOSCODE:5A9C </span>CRLF            <span style="color:black">endp
DOSCODE:5A9C
</span><span style="color:maroon">DOSCODE:5A9F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5A9F
DOSCODE:5A9F </span>$RAW_CON_IO<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5A9F                 </span><span style="color:navy">mov     al, dl          </span>; Input/Output raw char from console, no echo
<span style="color:maroon">DOSCODE:5AA1                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0FFh        </span>; -1 if input
<span style="color:maroon">DOSCODE:5AA3                 </span><span style="color:navy">jnz     short </span>RAWOUT
<span style="color:maroon">DOSCODE:5AA5                 </span><span style="color:navy">les     di, dword ptr ss:</span>USER_SP ; Get pointer to register save area
<span style="color:maroon">DOSCODE:5AAA                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:maroon">DOSCODE:5AAC                 </span><span style="color:navy">call    </span>GET_IO_SFT
<span style="color:maroon">DOSCODE:5AAF                 </span><span style="color:navy">jb      short </span>FINDOLD_RETN
<span style="color:maroon">DOSCODE:5AB1                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:5AB3                 </span><span style="color:navy">call    </span>IOFUNC
<span style="color:maroon">DOSCODE:5AB6                 </span><span style="color:navy">jnz     short </span>RESFLG
<span style="color:maroon">DOSCODE:5AB8                 </span><span style="color:navy">call    </span>SPOOLINT
<span style="color:maroon">DOSCODE:5ABB                 </span><span style="color:navy">or      byte ptr es:[di+</span><span style="color:#ff8000">16h</span><span style="color:navy">], </span><span style="color:green">40h </span>; [ES:DI+user_env.user_F],40h
<span style="color:maroon">DOSCODE:5ABB                                         </span>; Set user&#039;s zero flag
<span style="color:maroon">DOSCODE:5AC0                 </span><span style="color:navy">xor     al, al
</span><span style="color:maroon">DOSCODE:5AC2
DOSCODE:5AC2 </span>RET17<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5AC2                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:5AC3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5AC3
DOSCODE:5AC3 </span>RESFLG<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5AC3                 </span><span style="color:navy">and     byte ptr es:[di+</span><span style="color:#ff8000">16h</span><span style="color:navy">], </span><span style="color:green">0BFh </span>; [ES:DI+user_env.user_F],0FFh-40h
<span style="color:maroon">DOSCODE:5AC3                                         </span>; Reset user&#039;s zero flag
<span style="color:maroon">DOSCODE:5AC8
DOSCODE:5AC8 </span>rci0<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5AC8                 </span><span style="color:navy">call    </span>SPOOLINT
<span style="color:maroon">DOSCODE:5ACB
DOSCODE:5ACB </span>$RAW_CON_INPUT<span style="color:navy">:                         </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5ACB                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:5ACC                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:maroon">DOSCODE:5ACE                 </span><span style="color:navy">call    </span>GET_IO_SFT
<span style="color:maroon">DOSCODE:5AD1                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:5AD2                 </span><span style="color:navy">jb      short </span>RET17
<span style="color:maroon">DOSCODE:5AD4                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:5AD6                 </span><span style="color:navy">call    </span>IOFUNC
<span style="color:maroon">DOSCODE:5AD9                 </span><span style="color:navy">jnz     short </span>rci5
<span style="color:maroon">DOSCODE:5ADB                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">84h
</span><span style="color:maroon">DOSCODE:5ADD                 </span><span style="color:navy">int     </span><span style="color:green">2Ah             </span>; Microsoft Networks - KEYBOARD BUSY LOOP
<span style="color:maroon">DOSCODE:5ADF                 </span><span style="color:navy">jmp     short </span>rci0
<span style="color:maroon">DOSCODE:5AE1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5AE1
DOSCODE:5AE1 </span>rci5<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5AE1                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:maroon">DOSCODE:5AE3                 </span><span style="color:navy">call    </span>IOFUNC
<span style="color:maroon">DOSCODE:5AE6                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5AE7
DOSCODE:5AE7 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5AE7
DOSCODE:5AE7
DOSCODE:5AE7 </span>RAWOUT          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5AE7                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:5AE8                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:5AEB                 </span><span style="color:navy">call    </span>GET_IO_SFT
<span style="color:black">DOSCODE:5AEE                 </span><span style="color:navy">jb      short </span><span style="color:gray">RAWRET1
</span><span style="color:black">DOSCODE:5AF0                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">5</span><span style="color:navy">]      </span>; [SI+SF_ENTRY.sf_flags]
<span style="color:black">DOSCODE:5AF0                                         </span>; DS set up by get_io_sft
<span style="color:black">DOSCODE:5AF3                 </span><span style="color:navy">and     bx, </span><span style="color:green">8080h       </span>; sf_isnet+devid_device
<span style="color:black">DOSCODE:5AF7                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">80h         </span>; devid_device
<span style="color:black">DOSCODE:5AFB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">RAWNORM
</span><span style="color:black">DOSCODE:5AFD                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:5AFE                 </span><span style="color:navy">lds     bx, [si+</span><span style="color:#ff8000">7</span><span style="color:navy">]      </span>; [SI+SF_ENTRY.sf_devptr]
<span style="color:black">DOSCODE:5AFE                                         </span>; output to special?
<span style="color:black">DOSCODE:5B01                 </span><span style="color:navy">test    byte ptr [bx+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">10h </span>; ISSPEC
<span style="color:black">DOSCODE:5B05                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:5B06                 </span><span style="color:navy">jz      short </span><span style="color:gray">RAWNORM   </span>; if not, do normally
<span style="color:black">DOSCODE:5B08                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:5B09                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:5B0B                 </span><span style="color:navy">mov     ds, bx
</span><span style="color:black">DOSCODE:5B0D                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:5B0D                 </span><span style="color:navy">pushf                   </span>; simulate INT 29h
<span style="color:black">DOSCODE:5B0E                 </span><span style="color:navy">call    </span>ds:00A4h        ; call far [29h*4] ; call far [00A4h]
<span style="color:black">DOSCODE:5B12                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:5B13                 </span>assume ds:nothing
<span style="color:black">DOSCODE:5B13
DOSCODE:5B13 </span><span style="color:gray">RAWRET</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5B13                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:5B14
DOSCODE:5B14 </span><span style="color:gray">RAWRET1</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5B14                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:5B15
DOSCODE:5B15 </span>RAWRET2<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5B15                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5B16 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5B16
DOSCODE:5B16 </span><span style="color:gray">RAWNORM</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5B16                 </span><span style="color:navy">call    </span>RAWOUT3
<span style="color:black">DOSCODE:5B19                 </span><span style="color:navy">jmp     short </span><span style="color:gray">RAWRET
</span><span style="color:black">DOSCODE:5B19 </span>RAWOUT          <span style="color:black">endp
DOSCODE:5B19
DOSCODE:5B1B
DOSCODE:5B1B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5B1B
DOSCODE:5B1B
DOSCODE:5B1B </span>RAWOUT2         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5B1B                 </span><span style="color:navy">call    </span>GET_IO_SFT      ; Output the character in AL to handle in BX
<span style="color:black">DOSCODE:5B1E                 </span><span style="color:navy">jb      short </span>RAWRET2
<span style="color:black">DOSCODE:5B1E </span>RAWOUT2         <span style="color:black">endp
DOSCODE:5B1E
DOSCODE:5B20
DOSCODE:5B20 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5B20
DOSCODE:5B20
DOSCODE:5B20 </span>RAWOUT3         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5B20                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:5B21                 </span><span style="color:navy">jmp     short </span><span style="color:gray">RAWOSTRT
</span><span style="color:black">DOSCODE:5B23 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5B23
DOSCODE:5B23 </span><span style="color:gray">ROLP</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5B23                 </span><span style="color:navy">call    </span>SPOOLINT
<span style="color:black">DOSCODE:5B26                 </span><span style="color:navy">or      ss:</span>DOS34_FLAG<span style="color:navy">, </span><span style="color:green">200h </span>; [ss:DOS34_FLAG],CTRL_BREAK_FLAG
<span style="color:black">DOSCODE:5B2D                 </span><span style="color:navy">call    </span>DSKSTATCHK      ; check control break
<span style="color:black">DOSCODE:5B30
DOSCODE:5B30 </span><span style="color:gray">RAWOSTRT</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5B30                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:5B32                 </span><span style="color:navy">call    </span>IOFUNC
<span style="color:black">DOSCODE:5B35                 </span><span style="color:navy">jz      short </span><span style="color:gray">ROLP
</span><span style="color:black">DOSCODE:5B37                 </span><span style="color:navy">inc     ax              </span>; fail on I24 if ax = -1
<span style="color:black">DOSCODE:5B38                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:5B39                 </span><span style="color:navy">jz      short </span><span style="color:gray">nosend    </span>; yes, do not send char
<span style="color:black">DOSCODE:5B3B                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:5B3D                 </span><span style="color:navy">call    </span>IOFUNC
<span style="color:black">DOSCODE:5B40
DOSCODE:5B40 </span><span style="color:gray">nosend</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5B40                 </span><span style="color:navy">clc                     </span>; Clear carry indicating successful
<span style="color:black">DOSCODE:5B41                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5B41 </span>RAWOUT3         <span style="color:black">endp
DOSCODE:5B41
DOSCODE:5B42
DOSCODE:5B42 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5B42
DOSCODE:5B42
DOSCODE:5B42 </span>Save_Restore_Packet <span style="color:black">proc near           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5B42                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:5B43                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:5B44                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:5B45                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:5B46                 </span><span style="color:navy">mov     di, offset </span>FAKE_STACK_2F
<span style="color:black">DOSCODE:5B49                 </span><span style="color:navy">mov     si, offset </span>DEVCALL_REQLEN ; DEVCALL
<span style="color:black">DOSCODE:5B4C                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:5B4E                 </span><span style="color:navy">jz      short </span><span style="color:gray">save_packet
</span><span style="color:black">DOSCODE:5B50                 </span><span style="color:navy">xchg    si, di
</span><span style="color:black">DOSCODE:5B52
DOSCODE:5B52 </span><span style="color:gray">save_packet</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5B52                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:5B53                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:5B54                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:5B54                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:5B55                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:5B56                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:5B56                 </span><span style="color:navy">mov     cx, </span><span style="color:green">11
</span><span style="color:black">DOSCODE:5B59                 </span><span style="color:navy">rep movsw
</span><span style="color:black">DOSCODE:5B5B                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:5B5C                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:5B5D                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:5B5E                 </span>assume es:nothing
<span style="color:black">DOSCODE:5B5E                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:5B5F                 </span>assume ds:nothing
<span style="color:black">DOSCODE:5B5F                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5B5F </span>Save_Restore_Packet <span style="color:black">endp
DOSCODE:5B5F
</span><span style="color:maroon">DOSCODE:5B60 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5B60
DOSCODE:5B60 </span>$STD_CON_INPUT<span style="color:navy">:                         </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5B60                 </span><span style="color:navy">call    </span>$STD_CON_INPUT_NO_ECHO
<span style="color:maroon">DOSCODE:5B63                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:5B64                 </span><span style="color:navy">call    </span>OUTT
<span style="color:maroon">DOSCODE:5B67                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:5B68
DOSCODE:5B68 </span>CON_INPUT_RETN<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5B68                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5B69 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5B69 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR OUTT
</span><span style="color:black">DOSCODE:5B69
DOSCODE:5B69 </span><span style="color:gray">outch2</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5B69                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:5B6A                 </span><span style="color:navy">call    near ptr </span>STATCHK
<span style="color:black">DOSCODE:5B6D                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:5B6E                 </span><span style="color:navy">jmp     short </span><span style="color:gray">OUTSKIP
</span><span style="color:black">DOSCODE:5B6E </span><span style="color:gray">; END OF FUNCTION CHUNK FOR OUTT
</span><span style="color:maroon">DOSCODE:5B70 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5B70
DOSCODE:5B70 </span>$STD_CON_OUTPUT<span style="color:navy">:                        </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5B70                 </span><span style="color:navy">mov     al, dl
</span><span style="color:black">DOSCODE:5B72
DOSCODE:5B72 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5B72
DOSCODE:5B72
DOSCODE:5B72 </span>OUTT            <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5B72
DOSCODE:5B72 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:5B69 SIZE 00000007 BYTES
</span><span style="color:black">DOSCODE:5B72 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:5BF1 SIZE 00000008 BYTES
</span><span style="color:black">DOSCODE:5B72 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:5BFC SIZE 00000008 BYTES
</span><span style="color:black">DOSCODE:5B72 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:5C51 SIZE 00000007 BYTES
</span><span style="color:black">DOSCODE:5B72
DOSCODE:5B72                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">DOSCODE:5B74                 </span><span style="color:navy">jb      short </span><span style="color:gray">CTRLOUT
</span><span style="color:black">DOSCODE:5B76                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">7Fh
</span><span style="color:black">DOSCODE:5B78                 </span><span style="color:navy">jz      short </span><span style="color:gray">OUTCH
</span><span style="color:black">DOSCODE:5B7A                 </span><span style="color:navy">inc     ss:</span>CARPOS
<span style="color:black">DOSCODE:5B7F
DOSCODE:5B7F </span><span style="color:gray">OUTCH</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5B7F                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:5B80                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:5B81                 </span><span style="color:navy">inc     ss:</span>CHARCO       ; invoke statchk...
<span style="color:black">DOSCODE:5B86                 </span><span style="color:navy">and     ss:</span>CHARCO<span style="color:navy">, </span><span style="color:green">3Fh  </span>; every 64th character
<span style="color:black">DOSCODE:5B8C                 </span><span style="color:navy">jz      short </span><span style="color:gray">outch2
</span><span style="color:black">DOSCODE:5B8E
DOSCODE:5B8E </span><span style="color:gray">OUTSKIP</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5B8E                 </span><span style="color:navy">call    </span>RAWOUT          ; output the character
<span style="color:black">DOSCODE:5B91                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:5B92                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:5B93                 </span><span style="color:navy">test    ss:</span>PFLAG<span style="color:navy">, </span><span style="color:green">0FFh  </span>; -1
<span style="color:black">DOSCODE:5B99                 </span><span style="color:navy">jz      short </span>CON_INPUT_RETN
<span style="color:black">DOSCODE:5B9B                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:5B9C                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:5B9D                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:5B9E                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:5BA1                 </span><span style="color:navy">call    </span>GET_IO_SFT
<span style="color:black">DOSCODE:5BA4                 </span><span style="color:navy">jb      short </span><span style="color:gray">TRIPOPJ
</span><span style="color:black">DOSCODE:5BA6                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">5</span><span style="color:navy">]      </span>; [SI+SF_ENTRY.sf_flags]
<span style="color:black">DOSCODE:5BA9                 </span><span style="color:navy">test    bh, </span><span style="color:green">80h         </span>; (sf_isnet&gt;&gt;8)
<span style="color:black">DOSCODE:5BAC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">TRIPOPJ
</span><span style="color:black">DOSCODE:5BAE                 </span><span style="color:navy">test    bl, </span><span style="color:green">80h         </span>; devid_device
<span style="color:black">DOSCODE:5BB1                 </span><span style="color:navy">jz      short </span><span style="color:gray">TRIPOPJ
</span><span style="color:black">DOSCODE:5BB3                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">4
</span><span style="color:black">DOSCODE:5BB6                 </span><span style="color:navy">call    </span>GET_IO_SFT      ; GET_IO_SFT will set up DS:SI to sft entry
<span style="color:black">DOSCODE:5BB9                 </span><span style="color:navy">jb      short </span><span style="color:gray">TRIPOPJ
</span><span style="color:black">DOSCODE:5BBB                 </span><span style="color:navy">test    byte ptr [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:green">8 </span>; [SI+SF_ENTRY.sf_flags+1],
<span style="color:black">DOSCODE:5BBB                                         </span>; (sf_net_spool&gt;&gt;8) ; StdPrn redirected?
<span style="color:black">DOSCODE:5BBF                 </span><span style="color:navy">jz      short </span><span style="color:gray">LISSTRT2J
</span><span style="color:black">DOSCODE:5BC1                 </span><span style="color:navy">mov     ss:</span>PFLAG<span style="color:navy">, </span><span style="color:#ff8000">0     </span>; If a spool, NEVER echo
<span style="color:black">DOSCODE:5BC7
DOSCODE:5BC7 </span><span style="color:gray">TRIPOPJ</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5BC7                 </span><span style="color:navy">jmp     </span><span style="color:gray">TRIPOP
</span><span style="color:black">DOSCODE:5BCA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5BCA
DOSCODE:5BCA </span><span style="color:gray">LISSTRT2J</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5BCA                 </span><span style="color:navy">jmp     </span><span style="color:gray">LISSTRT2
</span><span style="color:black">DOSCODE:5BCD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5BCD
DOSCODE:5BCD </span><span style="color:gray">CTRLOUT</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5BCD                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; c_CR
<span style="color:black">DOSCODE:5BCF                 </span><span style="color:navy">jz      short </span><span style="color:gray">ZERPOS
</span><span style="color:black">DOSCODE:5BD1                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">8           </span>; c_BS
<span style="color:black">DOSCODE:5BD3                 </span><span style="color:navy">jz      short </span><span style="color:gray">BACKPOS
</span><span style="color:black">DOSCODE:5BD5                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">9           </span>; c_HT
<span style="color:black">DOSCODE:5BD7                 </span><span style="color:navy">jnz     short </span><span style="color:gray">OUTCH
</span><span style="color:black">DOSCODE:5BD9                 </span><span style="color:navy">mov     al, ss:</span>CARPOS
<span style="color:black">DOSCODE:5BDD                 </span><span style="color:navy">or      al, </span><span style="color:green">0F8h
</span><span style="color:black">DOSCODE:5BDF                 </span><span style="color:navy">neg     al
</span><span style="color:black">DOSCODE:5BDF </span>OUTT            <span style="color:black">endp
DOSCODE:5BDF
DOSCODE:5BE1
DOSCODE:5BE1 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5BE1
DOSCODE:5BE1
DOSCODE:5BE1 </span>TAB             <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5BE1                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:5BE2                 </span><span style="color:navy">mov     cl, al
</span><span style="color:black">DOSCODE:5BE4                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:5BE6                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">POPTAB
</span><span style="color:black">DOSCODE:5BE8
DOSCODE:5BE8 </span><span style="color:gray">TABLP</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5BE8                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">DOSCODE:5BEA                 </span><span style="color:navy">call    </span>OUTT
<span style="color:black">DOSCODE:5BED                 </span><span style="color:navy">loop    </span><span style="color:gray">TABLP
</span><span style="color:black">DOSCODE:5BEF
DOSCODE:5BEF </span><span style="color:gray">POPTAB</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5BEF                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:5BF0                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5BF0 </span>TAB             <span style="color:black">endp
DOSCODE:5BF0
DOSCODE:5BF1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5BF1 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR OUTT
</span><span style="color:black">DOSCODE:5BF1
DOSCODE:5BF1 </span><span style="color:gray">ZERPOS</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5BF1                 </span><span style="color:navy">mov     ss:</span>CARPOS<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:5BF7                 </span><span style="color:navy">jmp     short </span><span style="color:gray">OUTCH
</span><span style="color:black">DOSCODE:5BF7 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR OUTT
</span><span style="color:maroon">DOSCODE:5BF9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5BF9
DOSCODE:5BF9 </span>j_OUTT<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5BF9                 </span><span style="color:navy">jmp     </span>OUTT
<span style="color:black">DOSCODE:5BFC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5BFC </span><span style="color:gray">; START OF FUNCTION CHUNK FOR OUTT
</span><span style="color:black">DOSCODE:5BFC
DOSCODE:5BFC </span><span style="color:gray">BACKPOS</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5BFC                 </span><span style="color:navy">dec     ss:</span>CARPOS
<span style="color:black">DOSCODE:5C01                 </span><span style="color:navy">jmp     </span><span style="color:gray">OUTCH
</span><span style="color:black">DOSCODE:5C01 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR OUTT
</span><span style="color:black">DOSCODE:5C04
DOSCODE:5C04 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5C04
DOSCODE:5C04
DOSCODE:5C04 </span>BUFOUT          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5C04                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">DOSCODE:5C06                 </span><span style="color:navy">jnb     short </span>j_OUTT    ; Normal char
<span style="color:black">DOSCODE:5C08                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">9
</span><span style="color:black">DOSCODE:5C0A                 </span><span style="color:navy">jz      short </span>j_OUTT    ; OUT knows how to expand tabs
<span style="color:black">DOSCODE:5C0C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">15h         </span>; &quot;U&quot;-&quot;@&quot; ; turn ^U to section symbol
<span style="color:black">DOSCODE:5C0E                 </span><span style="color:navy">jz      short </span><span style="color:gray">CTRLU
</span><span style="color:black">DOSCODE:5C10                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">14h         </span>; &quot;T&quot;-&quot;@&quot; ; turn ^T to paragraph symbol
<span style="color:black">DOSCODE:5C12                 </span><span style="color:navy">jz      short </span><span style="color:gray">CTRLU
</span><span style="color:black">DOSCODE:5C14                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:5C15                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">5Eh </span><span style="color:gray">; &#039;^&#039;
</span><span style="color:black">DOSCODE:5C17                 </span><span style="color:navy">call    </span>OUTT            ; Print &#039;^&#039; before control chars
<span style="color:black">DOSCODE:5C1A                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:5C1B                 </span><span style="color:navy">or      al, </span><span style="color:green">40h         </span>; Turn it into Upper case mate
<span style="color:black">DOSCODE:5C1D
DOSCODE:5C1D </span><span style="color:gray">CTRLU</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5C1D                 </span><span style="color:navy">call    </span>OUTT
<span style="color:black">DOSCODE:5C20
DOSCODE:5C20 </span>BUFOUT_RETN<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5C20                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5C20 </span>BUFOUT          <span style="color:black">endp
DOSCODE:5C20
</span><span style="color:maroon">DOSCODE:5C21 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5C21
DOSCODE:5C21 </span>$STD_AUX_INPUT<span style="color:navy">:                         </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5C21                 </span><span style="color:navy">call    near ptr </span>STATCHK
<span style="color:maroon">DOSCODE:5C24                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">3
</span><span style="color:maroon">DOSCODE:5C27                 </span><span style="color:navy">call    </span>GET_IO_SFT
<span style="color:maroon">DOSCODE:5C2A                 </span><span style="color:navy">jb      short </span>BUFOUT_RETN
<span style="color:maroon">DOSCODE:5C2C                 </span><span style="color:navy">jmp     short </span>TAISTRT
<span style="color:maroon">DOSCODE:5C2E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5C2E
DOSCODE:5C2E </span>AUXILP<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5C2E                 </span><span style="color:navy">call    </span>SPOOLINT
<span style="color:maroon">DOSCODE:5C31
DOSCODE:5C31 </span>TAISTRT<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5C31                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:5C33                 </span><span style="color:navy">call    </span>IOFUNC
<span style="color:maroon">DOSCODE:5C36                 </span><span style="color:navy">jz      short </span>AUXILP
<span style="color:maroon">DOSCODE:5C38                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:maroon">DOSCODE:5C3A                 </span><span style="color:navy">call    </span>IOFUNC
<span style="color:maroon">DOSCODE:5C3D                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:5C3E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5C3E
DOSCODE:5C3E </span>$STD_AUX_OUTPUT<span style="color:navy">:                        </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5C3E                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:5C3F                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">3
</span><span style="color:maroon">DOSCODE:5C42                 </span><span style="color:navy">jmp     short </span>SENDOUT
<span style="color:maroon">DOSCODE:5C44 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5C44
DOSCODE:5C44 </span>$STD_PRINTER_OUTPUT<span style="color:navy">:                    </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5C44                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:5C45                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:5C48
DOSCODE:5C48 </span>SENDOUT<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5C48                 </span><span style="color:navy">mov     al, dl
</span><span style="color:maroon">DOSCODE:5C4A                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:5C4B                 </span><span style="color:navy">call    near ptr </span>STATCHK
<span style="color:maroon">DOSCODE:5C4E                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:5C4F                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:5C50                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:5C51 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR OUTT
</span><span style="color:black">DOSCODE:5C51
DOSCODE:5C51 </span><span style="color:gray">LISSTRT2</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5C51                 </span><span style="color:navy">call    </span>RAWOUT2
<span style="color:black">DOSCODE:5C54
DOSCODE:5C54 </span><span style="color:gray">TRIPOP</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5C54                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:5C55                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:5C56                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:5C57
DOSCODE:5C57 </span>SCIS_RETN<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5C57                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5C57 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR OUTT
</span><span style="color:maroon">DOSCODE:5C58 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5C58
DOSCODE:5C58 </span>$STD_CON_INPUT_STATUS<span style="color:navy">:                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5C58                 </span><span style="color:navy">call    near ptr </span>STATCHK
<span style="color:maroon">DOSCODE:5C5B                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0           </span>; no xor!!
<span style="color:maroon">DOSCODE:5C5D                 </span><span style="color:navy">jz      short </span>SCIS_RETN
<span style="color:maroon">DOSCODE:5C5F                 </span><span style="color:navy">dec     ax              </span>; -1
<span style="color:maroon">DOSCODE:5C60                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:5C61 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5C61
DOSCODE:5C61 </span>$STD_CON_INPUT_FLUSH<span style="color:navy">:                   </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5C61                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:5C62                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:5C63                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:maroon">DOSCODE:5C65                 </span><span style="color:navy">call    </span>GET_IO_SFT
<span style="color:maroon">DOSCODE:5C68                 </span><span style="color:navy">jb      short </span>BADJFNCON
<span style="color:maroon">DOSCODE:5C6A                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:5C6C                 </span><span style="color:navy">call    </span>IOFUNC
<span style="color:maroon">DOSCODE:5C6F
DOSCODE:5C6F </span>BADJFNCON<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5C6F                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:5C70                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:5C71                 </span><span style="color:navy">mov     ah, al
</span><span style="color:maroon">DOSCODE:5C73                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:5C75                 </span><span style="color:navy">jz      short </span>REDISPJ
<span style="color:maroon">DOSCODE:5C77                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">6
</span><span style="color:maroon">DOSCODE:5C79                 </span><span style="color:navy">jz      short </span>REDISPJ
<span style="color:maroon">DOSCODE:5C7B                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">7
</span><span style="color:maroon">DOSCODE:5C7D                 </span><span style="color:navy">jz      short </span>REDISPJ
<span style="color:maroon">DOSCODE:5C7F                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">8
</span><span style="color:maroon">DOSCODE:5C81                 </span><span style="color:navy">jz      short </span>REDISPJ
<span style="color:maroon">DOSCODE:5C83                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah
</span><span style="color:maroon">DOSCODE:5C85                 </span><span style="color:navy">jz      short </span>REDISPJ
<span style="color:maroon">DOSCODE:5C87                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:5C89                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:5C8A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5C8A
DOSCODE:5C8A </span>REDISPJ<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5C8A                 </span><span style="color:navy">cli
</span><span style="color:maroon">DOSCODE:5C8B                 </span><span style="color:navy">jmp     </span>REDISP
<span style="color:maroon">DOSCODE:5C8E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5C8E
DOSCODE:5C8E </span>$GET_FCB_POSITION<span style="color:navy">:                      </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5C8E                 </span><span style="color:navy">call    </span>GetExtended     ; point to FCB
<span style="color:maroon">DOSCODE:5C91                 </span><span style="color:navy">call    </span>GetExtent       ; DX:AX is current record
<span style="color:maroon">DOSCODE:5C94                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">21h</span><span style="color:navy">], ax    </span>; [SI+SYS_FCB.RR] ; drop in low order piece
<span style="color:maroon">DOSCODE:5C97                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">23h</span><span style="color:navy">], dl    </span>; [SI+SYS_FCB.RR+2] ; drop in high order piece
<span style="color:maroon">DOSCODE:5C9A                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], </span><span style="color:green">64 </span>; [SI+SYS_FCB.RECSIZ]
<span style="color:maroon">DOSCODE:5C9E                 </span><span style="color:navy">jnb     short </span>GetFCBBye
<span style="color:maroon">DOSCODE:5CA0                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">24h</span><span style="color:navy">], dh    </span>; [SI+SYS_FCB.RR+2+1]
<span style="color:maroon">DOSCODE:5CA0                                         </span>; Set 4th byte only if record size &lt; 64
<span style="color:maroon">DOSCODE:5CA3
DOSCODE:5CA3 </span>GetFCBBye<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5CA3                 </span><span style="color:navy">jmp     </span>NO_OP           ; jmp FCB_RET_OK
<span style="color:maroon">DOSCODE:5CA6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5CA6
DOSCODE:5CA6 </span>$FCB_DELETE<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5CA6                 </span><span style="color:navy">mov     di, offset </span>OPENBUF
<span style="color:maroon">DOSCODE:5CA9                 </span><span style="color:navy">call    </span>TransFCB        ; convert FCB to path
<span style="color:maroon">DOSCODE:5CAC                 </span><span style="color:navy">jb      short </span>BadPath   ; signal no deletions
<span style="color:maroon">DOSCODE:5CAE                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:5CAF                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:5CB0                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:5CB0                 </span><span style="color:navy">call    </span>DOS_DELETE
<span style="color:maroon">DOSCODE:5CB3                 </span><span style="color:navy">jnb     short </span>GetFCBBye ; do a good return
<span style="color:maroon">DOSCODE:5CB5
DOSCODE:5CB5 </span>BadPath<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5CB5                 </span><span style="color:navy">jmp     </span>FCB_RET_ERR     ; let someone else signal the error
<span style="color:maroon">DOSCODE:5CB8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5CB8
DOSCODE:5CB8 </span>$GET_FCB_FILE_LENGTH<span style="color:navy">:                   </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5CB8                 </span><span style="color:navy">call    </span>GetExtended     ; get real FCB pointer
<span style="color:maroon">DOSCODE:5CB8                                         </span>; DX points to Input FCB
<span style="color:maroon">DOSCODE:5CBB                 </span><span style="color:navy">mov     di, offset </span>OPENBUF ; appropriate buffer in DOSDATA
<span style="color:maroon">DOSCODE:5CBE                 </span><span style="color:navy">push    ds              </span>; save pointer to true FCB
<span style="color:maroon">DOSCODE:5CBF                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:5CC0                 </span><span style="color:navy">call    </span>TransFCB        ; Trans name DS:DX, sets SATTRIB
<span style="color:maroon">DOSCODE:5CC3                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:5CC4                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:5CC5                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:5CC5                 </span><span style="color:navy">jb      short </span>BadPath
<span style="color:maroon">DOSCODE:5CC7                 </span><span style="color:navy">push    ds              </span>; save pointer
<span style="color:maroon">DOSCODE:5CC8                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:5CC9                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:5CCA                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:5CCB                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:5CCB                 </span><span style="color:navy">call    </span>GET_FILE_INFO   ; grab the info
<span style="color:maroon">DOSCODE:5CCE                 </span><span style="color:navy">pop     si              </span>; get pointer back
<span style="color:maroon">DOSCODE:5CCF                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:5CD0                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:5CD0                 </span><span style="color:navy">jb      short </span>BadPath   ; invalid something
<span style="color:maroon">DOSCODE:5CD2                 </span><span style="color:navy">mov     dx, bx          </span>; get high order size
<span style="color:maroon">DOSCODE:5CD4                 </span><span style="color:navy">mov     ax, di          </span>; get low order size
<span style="color:maroon">DOSCODE:5CD6                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">]    </span>; [SI+SYS_FCB.RECSIZ]
<span style="color:maroon">DOSCODE:5CD6                                         </span>; get his record size
<span style="color:maroon">DOSCODE:5CD9                 </span><span style="color:navy">or      bx, bx          </span>; empty record =&gt; 0 size for file
<span style="color:maroon">DOSCODE:5CDB                 </span><span style="color:navy">jnz     short </span>GetSize   ; not empty
<span style="color:maroon">DOSCODE:5CDD                 </span><span style="color:navy">mov     bl, </span><span style="color:green">128
</span><span style="color:maroon">DOSCODE:5CDF
DOSCODE:5CDF </span>GetSize<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5CDF                 </span><span style="color:navy">xchg    ax, dx          </span>; move high order for divide
<span style="color:maroon">DOSCODE:5CE0                 </span><span style="color:navy">xor     dx, dx          </span>; clear out high
<span style="color:maroon">DOSCODE:5CE2                 </span><span style="color:navy">div     bx
</span><span style="color:maroon">DOSCODE:5CE4                 </span><span style="color:navy">push    ax              </span>; save dividend
<span style="color:maroon">DOSCODE:5CE5                 </span><span style="color:navy">mov     ax, di          </span>; get low order piece
<span style="color:maroon">DOSCODE:5CE7                 </span><span style="color:navy">div     bx
</span><span style="color:maroon">DOSCODE:5CE9                 </span><span style="color:navy">mov     cx, dx          </span>; save remainder
<span style="color:maroon">DOSCODE:5CEB                 </span><span style="color:navy">pop     dx              </span>; get high order dividend
<span style="color:maroon">DOSCODE:5CEC                 </span><span style="color:navy">jcxz    short </span>LengthStore
<span style="color:maroon">DOSCODE:5CEE                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:5CF1                 </span><span style="color:navy">adc     dx, </span><span style="color:#ff8000">0           </span>; 32-bit increment
<span style="color:maroon">DOSCODE:5CF4
DOSCODE:5CF4 </span>LengthStore<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5CF4                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">21h</span><span style="color:navy">], ax    </span>; [SI+SYS_FCB.RR] ; store low order
<span style="color:maroon">DOSCODE:5CF7                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">23h</span><span style="color:navy">], dl    </span>; [SI+SYS_FCB.RR+2] ; store high order
<span style="color:maroon">DOSCODE:5CFA                 </span><span style="color:navy">or      dh, dh
</span><span style="color:maroon">DOSCODE:5CFC                 </span><span style="color:navy">jz      short </span>GetFCBBye ; not storing insignificant zero
<span style="color:maroon">DOSCODE:5CFE                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">24h</span><span style="color:navy">], dh    </span>; [SI+SYS_FCB.RR+3] ; save that high piece
<span style="color:maroon">DOSCODE:5D01
DOSCODE:5D01 </span>GoodRet<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5D01                 </span><span style="color:navy">jmp     short </span>GetFCBBye
<span style="color:maroon">DOSCODE:5D03 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5D03
DOSCODE:5D03 </span>$FCB_CLOSE<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5D03                 </span><span style="color:navy">xor     al, al          </span>; default search attributes
<span style="color:maroon">DOSCODE:5D05                 </span><span style="color:navy">call    </span>GetExtended     ; DS:SI point to real FCB
<span style="color:maroon">DOSCODE:5D08                 </span><span style="color:navy">jz      short </span>NoAttr    ; not extended
<span style="color:maroon">DOSCODE:5D0A                 </span><span style="color:navy">mov     al, [si-</span><span style="color:green">1</span><span style="color:navy">]      </span>; get attributes
<span style="color:maroon">DOSCODE:5D0D
DOSCODE:5D0D </span>NoAttr<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5D0D                 </span><span style="color:navy">mov     ss:</span>ATTRIB<span style="color:navy">, al   </span>; stash away found attributes
<span style="color:maroon">DOSCODE:5D11                 </span><span style="color:navy">call    </span>SFTFromFCB
<span style="color:maroon">DOSCODE:5D14                 </span><span style="color:navy">jb      short </span>GoodRet
<span style="color:maroon">DOSCODE:5D16                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_attr]
<span style="color:maroon">DOSCODE:5D1A                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:maroon">DOSCODE:5D1C                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:5D1D                 </span><span style="color:navy">call    </span>CheckShare
<span style="color:maroon">DOSCODE:5D20                 </span><span style="color:navy">jnz     short </span>NoStash
<span style="color:maroon">DOSCODE:5D22                 </span><span style="color:navy">mov     al, ss:</span>ATTRIB
<span style="color:maroon">DOSCODE:5D26                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], al   </span>; [ES:DI+SF_ENTRY.sf_attr]
<span style="color:maroon">DOSCODE:5D26                                         </span>; attempted attribute for close
<span style="color:maroon">DOSCODE:5D2A
DOSCODE:5D2A </span>NoStash<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5D2A                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:5D2B                 </span><span style="color:navy">lds     ax, [si+</span><span style="color:#ff8000">14h</span><span style="color:navy">]    </span>; [SI+SYS_FCB.FDATE]
<span style="color:maroon">DOSCODE:5D2B                                         </span>; move in the time and date
<span style="color:maroon">DOSCODE:5D2E                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_date]
<span style="color:maroon">DOSCODE:5D32                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">], ds </span>; [ES:DI+SF_ENTRY.sf_time]
<span style="color:maroon">DOSCODE:5D36                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:5D37                 </span><span style="color:navy">lds     ax, [si+</span><span style="color:#ff8000">10h</span><span style="color:navy">]    </span>; [SI+SYS_FCB.FILSIZ]
<span style="color:maroon">DOSCODE:5D3A                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">11h</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_size]
<span style="color:maroon">DOSCODE:5D3E                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">13h</span><span style="color:navy">], ds </span>; [ES:DI+SF_ENTRY.sf_size+2]
<span style="color:maroon">DOSCODE:5D42                 </span><span style="color:navy">or      word ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">4000h </span>; [ES:DI+SF_ENTRY.sf_flags],
<span style="color:maroon">DOSCODE:5D42                                         </span>; sf_close_nodate
<span style="color:maroon">DOSCODE:5D48                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:5D49                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:5D4A                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:5D4A                 </span><span style="color:navy">call    </span>DOS_CLOSE
<span style="color:maroon">DOSCODE:5D4D                 </span><span style="color:navy">les     di, </span>THISSFT
<span style="color:maroon">DOSCODE:5D51                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:5D52                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], cl   </span>; [ES:DI+SF_ENTRY.sf_attr]
<span style="color:maroon">DOSCODE:5D52                                         </span>; restore SFT attribute
<span style="color:maroon">DOSCODE:5D56                 </span><span style="color:navy">pushf
</span><span style="color:maroon">DOSCODE:5D57                 </span><span style="color:navy">cmp     word ptr es:[di], </span><span style="color:#ff8000">0 </span>; [ES:DI+SF_ENTRY.sf_ref_count],0
<span style="color:maroon">DOSCODE:5D57                                         </span>; zero ref count gets blasted
<span style="color:maroon">DOSCODE:5D5B                 </span><span style="color:navy">jnz     short </span>CloseOK
<span style="color:maroon">DOSCODE:5D5D                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:5D5E                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">4Dh </span><span style="color:gray">; &#039;M&#039;
</span><span style="color:maroon">DOSCODE:5D60                 </span><span style="color:navy">call    </span>BlastSFT
<span style="color:maroon">DOSCODE:5D63                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:5D64
DOSCODE:5D64 </span>CloseOK<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5D64                 </span><span style="color:navy">popf
</span><span style="color:maroon">DOSCODE:5D65
DOSCODE:5D65 </span>CloseOK2<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5D65                 </span><span style="color:navy">jnb     short </span>GoodRet
<span style="color:maroon">DOSCODE:5D67                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">6           </span>; error_invalid_handle
<span style="color:maroon">DOSCODE:5D69                 </span><span style="color:navy">jz      short </span>GoodRet
<span style="color:maroon">DOSCODE:5D6B                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2           </span>; error_file_not_found
<span style="color:maroon">DOSCODE:5D6D
DOSCODE:5D6D </span>fcb_close_err<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:5D6D                 </span><span style="color:navy">jmp     </span>FCB_RET_ERR     ; fren90
<span style="color:maroon">DOSCODE:5D70 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:5D70
DOSCODE:5D70 </span>$FCB_RENAME<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:5D70                 </span><span style="color:navy">call    </span>GetExtended     ; get pointer to real FCB
<span style="color:maroon">DOSCODE:5D73                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:5D74                 </span><span style="color:navy">mov     al, [si]        </span>; get drive byte
<span style="color:maroon">DOSCODE:5D76                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">10h         </span>; point to destination
<span style="color:maroon">DOSCODE:5D79                 </span><span style="color:navy">mov     di, offset </span>RENBUF
<span style="color:maroon">DOSCODE:5D7C                 </span><span style="color:navy">push    word ptr [si]
</span><span style="color:maroon">DOSCODE:5D7E                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:5D7F                 </span><span style="color:navy">push    si              </span>; save source pointer for TransFCB
<span style="color:maroon">DOSCODE:5D80                 </span><span style="color:navy">mov     [si], al        </span>; drop in real drive
<span style="color:maroon">DOSCODE:5D82                 </span><span style="color:navy">mov     dx, si          </span>; let TransFCB know where the FCB is
<span style="color:maroon">DOSCODE:5D84                 </span><span style="color:navy">call    </span>TransFCB        ; munch this pathname
<span style="color:maroon">DOSCODE:5D87                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:5D88                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:5D89                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:5D89                 </span><span style="color:navy">pop     word ptr [si]   </span>; get path back
<span style="color:maroon">DOSCODE:5D8B                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:5D8C                 </span><span style="color:navy">jb      short </span>fcb_close_err
<span style="color:maroon">DOSCODE:5D8E                 </span><span style="color:navy">mov     si, ss:</span>WFP_START
<span style="color:maroon">DOSCODE:5D93                 </span><span style="color:navy">mov     ss:</span>REN_WFP<span style="color:navy">, si
</span><span style="color:maroon">DOSCODE:5D98                 </span><span style="color:navy">mov     di, offset </span>OPENBUF
<span style="color:maroon">DOSCODE:5D9B                 </span><span style="color:navy">call    </span>TransFCB
<span style="color:maroon">DOSCODE:5D9E                 </span><span style="color:navy">jb      short </span>fcb_close_err
<span style="color:maroon">DOSCODE:5DA0                 </span><span style="color:navy">mov     ss:</span>PATHNAMELEN<span style="color:navy">, </span><span style="color:green">67 </span>; set pathname length to 67
<span style="color:maroon">DOSCODE:5DA0                                         </span>; DIRSTRLEN = 67
<span style="color:maroon">DOSCODE:5DA7                 </span><span style="color:navy">call    </span>DOS_RENAME
<span style="color:maroon">DOSCODE:5DAA                 </span><span style="color:navy">jb      short </span>fcb_close_err ; fren90
<span style="color:maroon">DOSCODE:5DAC                 </span><span style="color:navy">jmp     short </span>CloseOK2
<span style="color:black">DOSCODE:5DAE
DOSCODE:5DAE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5DAE
DOSCODE:5DAE
DOSCODE:5DAE </span>SaveFCBInfo     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5DAE                 </span><span style="color:navy">les     di, ss:</span>THISSFT
<span style="color:black">DOSCODE:5DB3                 </span><span style="color:navy">call    </span>IsSFTNet
<span style="color:black">DOSCODE:5DB6                 </span><span style="color:navy">jz      short </span><span style="color:gray">SaveLocal
</span><span style="color:black">DOSCODE:5DB8                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">] </span>; [ES:DI+sf_serial_ID]
<span style="color:black">DOSCODE:5DBC                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">1Ch</span><span style="color:navy">], ax    </span>; [SI+fcb_netID]
<span style="color:black">DOSCODE:5DBF                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">80h         </span>; FCBNETWORK
<span style="color:black">DOSCODE:5DC1                 </span><span style="color:navy">jmp     short </span><span style="color:gray">SaveSFN
</span><span style="color:black">DOSCODE:5DC3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5DC3
DOSCODE:5DC3 </span><span style="color:gray">SaveLocal</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5DC3                 </span><span style="color:navy">call    </span>CheckShare
<span style="color:black">DOSCODE:5DC6                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SaveShare </span>; sharer present
<span style="color:black">DOSCODE:5DC8
DOSCODE:5DC8 </span>SaveNoShare<span style="color:navy">:                            </span>; no sharer
<span style="color:black">DOSCODE:5DC8                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">80h </span>;
<span style="color:black">DOSCODE:5DC8                                         </span>; [ES:DI+SF_ENTRY.sf_flags],devid_device
<span style="color:black">DOSCODE:5DCD                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SaveNoShareDev </span>; Device
<span style="color:black">DOSCODE:5DCF                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_dirsec]
<span style="color:black">DOSCODE:5DD3                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">], ax    </span>; [SI+fcb_nsl_dirsec]
<span style="color:black">DOSCODE:5DD6                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">] </span>; [es:di+SF_ENTRY.sf_dirsec+2]
<span style="color:black">DOSCODE:5DDA                 </span><span style="color:navy">mov     bl, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+SF_ENTRY.sf_attr]
<span style="color:black">DOSCODE:5DDE                 </span><span style="color:navy">mov     bh, bl
</span><span style="color:black">DOSCODE:5DE0                 </span><span style="color:navy">ror     bl, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:5DE2                 </span><span style="color:navy">add     bh, bh
</span><span style="color:black">DOSCODE:5DE4                 </span><span style="color:navy">or      bl, bh
</span><span style="color:black">DOSCODE:5DE6                 </span><span style="color:navy">and     bl, </span><span style="color:green">0C0h
</span><span style="color:black">DOSCODE:5DE9                 </span><span style="color:navy">or      al, bl
</span><span style="color:black">DOSCODE:5DEB                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">18h</span><span style="color:navy">], al    </span>; [si+fcb_sfn] ; sector number = 22 bits
<span style="color:black">DOSCODE:5DEE                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_dirpos]
<span style="color:black">DOSCODE:5DEE                                         </span>; location in sector
<span style="color:black">DOSCODE:5DF2                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], al    </span>; [SI+fcb_nsl_dirpos]
<span style="color:black">DOSCODE:5DF5                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">2Bh</span><span style="color:navy">] </span>; [es:di+SF_ENTRY.sf_chain] ; .sf_chain ! (MSDOS 6.22)
<span style="color:black">DOSCODE:5DF5                                         </span>; first cluster (32 bit) !?
<span style="color:black">DOSCODE:5DF9                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">], ax    </span>; [SI+fcb_nsl_firclus]
<span style="color:black">DOSCODE:5DFC                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:5DFE
DOSCODE:5DFE </span><span style="color:gray">SetFCBBits</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5DFE                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_flags]
<span style="color:black">DOSCODE:5E02                 </span><span style="color:navy">and     al, </span><span style="color:green">0C0h        </span>; mask off drive bits
<span style="color:black">DOSCODE:5E04                 </span><span style="color:navy">or      al, es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_mode]
<span style="color:black">DOSCODE:5E04                                         </span>; stick in open mode
<span style="color:black">DOSCODE:5E08                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">1Ah</span><span style="color:navy">], al    </span>; [SI+fcb_nsl_bits] ; save dirty info
<span style="color:black">DOSCODE:5E0B                 </span><span style="color:navy">or      bl, bl
</span><span style="color:black">DOSCODE:5E0D                 </span><span style="color:navy">jz      short </span><span style="color:gray">SaveNoSFN </span>; do not save SFN if local file
<span style="color:black">DOSCODE:5E0F                 </span><span style="color:navy">jmp     short </span><span style="color:gray">SaveSFN   </span>; go and save SFN
<span style="color:black">DOSCODE:5E11 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5E11
DOSCODE:5E11 </span><span style="color:gray">SaveNoShareDev</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5E11                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:5E12                 </span><span style="color:navy">les     ax, es:[di+</span><span style="color:#ff8000">7</span><span style="color:navy">]   </span>; [es:di+SF_ENTRY.sf_devptr]
<span style="color:black">DOSCODE:5E16                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">1Ah</span><span style="color:navy">], ax    </span>; [SI+fcb_nsld_drvptr]
<span style="color:black">DOSCODE:5E19                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">1Ch</span><span style="color:navy">], es </span>; [si+fcb_nsld_drvptr+2]
<span style="color:black">DOSCODE:5E1C                 </span><span style="color:navy">pop     es              </span>; FCBDEVICE
<span style="color:black">DOSCODE:5E1D                 </span><span style="color:navy">mov     bl, </span><span style="color:green">40h
</span><span style="color:black">DOSCODE:5E1F                 </span><span style="color:navy">jmp     short </span><span style="color:gray">SetFCBBits </span>; go and save SFN
<span style="color:black">DOSCODE:5E21 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5E21
DOSCODE:5E21 </span><span style="color:gray">SaveShare</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5E21                 </span><span style="color:navy">call    ss:</span>ShSave       ; call far [ss:JShare+(10*4)] ; 10 = ShSave
<span style="color:black">DOSCODE:5E26
DOSCODE:5E26 </span><span style="color:gray">SaveSFN</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5E26                 </span><span style="color:navy">lea     ax, [di-</span><span style="color:green">6</span><span style="color:navy">]      </span>; [DI-SFT.SFTable]
<span style="color:black">DOSCODE:5E29                 </span><span style="color:navy">sub     ax, word ptr ss:</span>SFTFCB ; Adjust for offset to table.
<span style="color:black">DOSCODE:5E2E                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:5E2F                 </span><span style="color:navy">mov     bl, </span><span style="color:green">59          </span>; SF_ENTRY.size
<span style="color:black">DOSCODE:5E31                 </span><span style="color:navy">div     bl
</span><span style="color:black">DOSCODE:5E33                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">18h</span><span style="color:navy">], al    </span>; [SI+fcb_sfn] ; last used SFN
<span style="color:black">DOSCODE:5E36                 </span><span style="color:navy">pop     bx              </span>; bx = FCB type (net/Share or local)
<span style="color:black">DOSCODE:5E37
DOSCODE:5E37 </span><span style="color:gray">SaveNoSFN</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5E37                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_flags] ; get real drive
<span style="color:black">DOSCODE:5E3B                 </span><span style="color:navy">and     al, </span><span style="color:green">3Fh
</span><span style="color:black">DOSCODE:5E3D                 </span><span style="color:navy">or      al, bl
</span><span style="color:black">DOSCODE:5E3F                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">19h</span><span style="color:navy">], al    </span>; [SI+fcb_l_drive]
<span style="color:black">DOSCODE:5E42                 </span><span style="color:navy">mov     ax, ss:</span>FCBLRU   ; get lru count
<span style="color:black">DOSCODE:5E46                 </span><span style="color:navy">inc     ax
</span><span style="color:black">DOSCODE:5E47                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">], ax </span>; [ES:DI+sf_LRU]
<span style="color:black">DOSCODE:5E4B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SimpleStuff </span>;
<span style="color:black">DOSCODE:5E4B                                         </span>; lru flag overflowed
<span style="color:black">DOSCODE:5E4D                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">15h         </span>; SF_ENTRY.sf_position
<span style="color:black">DOSCODE:5E50                 </span><span style="color:navy">call    </span>ResetLRU
<span style="color:black">DOSCODE:5E53
DOSCODE:5E53 </span><span style="color:gray">SimpleStuff</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5E53                 </span><span style="color:navy">mov     ss:</span>FCBLRU<span style="color:navy">, ax   </span>; Set new LRU to AX
<span style="color:black">DOSCODE:5E57                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5E57 </span>SaveFCBInfo     <span style="color:black">endp
DOSCODE:5E57
DOSCODE:5E58
DOSCODE:5E58 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5E58
DOSCODE:5E58
DOSCODE:5E58 </span>ResetLRU        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5E58                 </span><span style="color:navy">mov     ax, </span><span style="color:green">8000h
</span><span style="color:black">DOSCODE:5E5B                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:5E5C                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:5E5D                 </span><span style="color:navy">les     di, ss:</span>SFTFCB   ; get pointer to head
<span style="color:black">DOSCODE:5E62                 </span><span style="color:navy">mov     cx, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [ES:DI+SFT.SFCount]
<span style="color:black">DOSCODE:5E66                 </span><span style="color:navy">lea     di, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [DI+SFT.SFTable] ; point at table
<span style="color:black">DOSCODE:5E69
DOSCODE:5E69 </span><span style="color:gray">ovScan</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5E69                 </span><span style="color:navy">sub     es:[bx+di], ax  </span>; decrement lru count
<span style="color:black">DOSCODE:5E6C                 </span><span style="color:navy">ja      short </span><span style="color:gray">ovLoop
</span><span style="color:black">DOSCODE:5E6E                 </span><span style="color:navy">mov     es:[bx+di], ax  </span>; truncate at 0
<span style="color:black">DOSCODE:5E71
DOSCODE:5E71 </span><span style="color:gray">ovLoop</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5E71                 </span><span style="color:navy">add     di, </span><span style="color:green">59          </span>; SF_ENTRY.size
<span style="color:black">DOSCODE:5E74                 </span><span style="color:navy">loop    </span><span style="color:gray">ovScan          </span>; advance to next
<span style="color:black">DOSCODE:5E76                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:5E77                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:5E78                 </span><span style="color:navy">mov     es:[bx+di], ax
</span><span style="color:black">DOSCODE:5E7B                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5E7B </span>ResetLRU        <span style="color:black">endp
DOSCODE:5E7B
DOSCODE:5E7C
DOSCODE:5E7C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5E7C
DOSCODE:5E7C
DOSCODE:5E7C </span>LRUFCB          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5E7C                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:5E7D                 </span><span style="color:navy">call    </span>save_world
<span style="color:black">DOSCODE:5E80                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:5E85                 </span><span style="color:navy">or      al, al          </span>; Check if regenerate allocation
<span style="color:black">DOSCODE:5E87                 </span><span style="color:navy">jnz     short </span><span style="color:gray">lru1      </span>; Try to find SFT to use
<span style="color:black">DOSCODE:5E89                 </span><span style="color:navy">les     di, ds:</span>LocalSFT
<span style="color:black">DOSCODE:5E8D                 </span><span style="color:navy">mov     cx, es
</span><span style="color:black">DOSCODE:5E8F                 </span><span style="color:navy">or      cx, di          </span>; is address == 0?
<span style="color:black">DOSCODE:5E91                 </span><span style="color:navy">jz      short </span><span style="color:gray">lru1      </span>; invalid local SFT, find one
<span style="color:black">DOSCODE:5E93
DOSCODE:5E93 </span><span style="color:gray">gotlocalSFT</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5E93                 </span><span style="color:navy">mov     word ptr ds:</span>THISSFT<span style="color:navy">, di
</span><span style="color:black">DOSCODE:5E97                 </span><span style="color:navy">mov     word ptr ds:</span>THISSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:5E9B                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:5E9C                 </span><span style="color:navy">jmp     </span><span style="color:gray">LRUDone         </span>; clear up SFT and return
<span style="color:black">DOSCODE:5E9F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5E9F
DOSCODE:5E9F </span><span style="color:gray">lru1</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5E9F                 </span><span style="color:navy">les     di, ds:</span>SFTFCB   ; es:di = SF Table for FCBs
<span style="color:black">DOSCODE:5EA3                 </span><span style="color:navy">mov     cx, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; cx = number of SFTs
<span style="color:black">DOSCODE:5EA7                 </span><span style="color:navy">lea     di, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [di+SFT.SFTable] ; es:di = first SFT
<span style="color:black">DOSCODE:5EAA                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFFh      </span>; (max. LRU value)
<span style="color:black">DOSCODE:5EAD                 </span><span style="color:navy">mov     si, bx
</span><span style="color:black">DOSCODE:5EAF                 </span><span style="color:navy">mov     dx, bx
</span><span style="color:black">DOSCODE:5EB1                 </span><span style="color:navy">mov     bp, bx
</span><span style="color:black">DOSCODE:5EB3
DOSCODE:5EB3 </span><span style="color:gray">findSFT</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5EB3                 </span><span style="color:navy">or      word ptr es:[di], </span><span style="color:green">0 </span>; [es:di+SF_ENTRY.sf_ref_count]
<span style="color:black">DOSCODE:5EB3                                         </span>; reference count = 0 ?
<span style="color:black">DOSCODE:5EB7                 </span><span style="color:navy">jz      short </span><span style="color:gray">gotSFT    </span>; yes, SFT is free
<span style="color:black">DOSCODE:5EB9                 </span><span style="color:navy">cmp     word ptr es:[di], </span><span style="color:green">0FFFFh </span>; [es:di+SF_ENTRY.sf_ref_count],
<span style="color:black">DOSCODE:5EB9                                         </span>; sf_busy
<span style="color:black">DOSCODE:5EBD                 </span><span style="color:navy">jz      short </span><span style="color:gray">gotSFT    </span>; not busy, can use it
<span style="color:black">DOSCODE:5EBF                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">8000h </span>; [ES:DI+SF_ENTRY.sf_flags],
<span style="color:black">DOSCODE:5EBF                                         </span>; sf_isnet
<span style="color:black">DOSCODE:5EC5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">lru5      </span>; network SFT, get net/Share LRU
<span style="color:black">DOSCODE:5EC7                 </span><span style="color:navy">call    </span>CheckShare
<span style="color:black">DOSCODE:5ECA                 </span><span style="color:navy">jnz     short </span><span style="color:gray">lru5
</span><span style="color:black">DOSCODE:5ECC
DOSCODE:5ECC </span><span style="color:gray">hackpoint</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5ECC                 </span><span style="color:navy">mov     word ptr ds:</span>LocalSFT<span style="color:navy">, di
</span><span style="color:black">DOSCODE:5ED0                 </span><span style="color:navy">mov     word ptr ds:</span>LocalSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es </span>; store local SFT address
<span style="color:black">DOSCODE:5ED4                 </span><span style="color:navy">or      al, al          </span>; Is operation = REGEN?
<span style="color:black">DOSCODE:5ED6                 </span><span style="color:navy">jz      short </span><span style="color:gray">gotlocalSFT </span>; yes, return this SFT for reuse
<span style="color:black">DOSCODE:5ED8                 </span><span style="color:navy">cmp     es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">], bx </span>; [es:di+sf_LRU],bx ; SFT.LRU &lt; min?
<span style="color:black">DOSCODE:5EDC                 </span><span style="color:navy">jnb     short </span><span style="color:gray">lru4      </span>; no, skip
<span style="color:black">DOSCODE:5EDE                 </span><span style="color:navy">mov     bx, es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">] </span>; [es:di+sf_LRU] ; yes, store new min
<span style="color:black">DOSCODE:5EE2                 </span><span style="color:navy">mov     si, di          </span>; store SFT position
<span style="color:black">DOSCODE:5EE4
DOSCODE:5EE4 </span><span style="color:gray">lru4</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5EE4                 </span><span style="color:navy">add     di, </span><span style="color:green">59          </span>; SF_ENTRY.size ; go to next SFT
<span style="color:black">DOSCODE:5EE7                 </span><span style="color:navy">loop    </span><span style="color:gray">findSFT
</span><span style="color:black">DOSCODE:5EE9                 </span><span style="color:navy">dec     cx
</span><span style="color:black">DOSCODE:5EEA                 </span><span style="color:navy">mov     di, si
</span><span style="color:black">DOSCODE:5EEC                 </span><span style="color:navy">cmp     si, cx          </span>; local SFT available?
<span style="color:black">DOSCODE:5EEE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">gotSFT    </span>; yes, return it
<span style="color:black">DOSCODE:5EF0                 </span><span style="color:navy">mov     di, bp
</span><span style="color:black">DOSCODE:5EF2                 </span><span style="color:navy">cmp     bp, cx          </span>; net/Share SFT available?
<span style="color:black">DOSCODE:5EF4                 </span><span style="color:navy">jnz     short </span><span style="color:gray">gotnetSFT </span>; yes, return it
<span style="color:black">DOSCODE:5EF6                 </span><span style="color:navy">jmp     short </span><span style="color:gray">errorbadSFT </span>; error, no FCB available.
<span style="color:black">DOSCODE:5EF8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5EF8
DOSCODE:5EF8 </span><span style="color:gray">lru5</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5EF8                 </span><span style="color:navy">cmp     es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">], dx </span>; [es:di+sf_LRU],dx ; SFT.LRU &lt; min?
<span style="color:black">DOSCODE:5EFC                 </span><span style="color:navy">jnb     short </span><span style="color:gray">lru4      </span>; no, skip
<span style="color:black">DOSCODE:5EFE                 </span><span style="color:navy">mov     dx, es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">] </span>; [es:di+sf_LRU]
<span style="color:black">DOSCODE:5EFE                                         </span>; yes, store new minimum
<span style="color:black">DOSCODE:5F02                 </span><span style="color:navy">mov     bp, di
</span><span style="color:black">DOSCODE:5F04                 </span><span style="color:navy">jmp     short </span><span style="color:gray">lru4
</span><span style="color:black">DOSCODE:5F06 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5F06
DOSCODE:5F06 </span><span style="color:gray">gotSFT</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5F06                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:5F08                 </span><span style="color:navy">jz      short </span><span style="color:gray">hackpoint </span>; save es:di in LocalSFT
<span style="color:black">DOSCODE:5F0A                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">DOSCODE:5F0C                 </span><span style="color:navy">cmp     word ptr ds:</span>LocalSFT<span style="color:navy">, di </span>; Offset same?
<span style="color:black">DOSCODE:5F10                 </span><span style="color:navy">jnz     short </span><span style="color:gray">notinvalid
</span><span style="color:black">DOSCODE:5F12                 </span><span style="color:navy">cmp     word ptr ds:</span>LocalSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax </span>; Segments same?
<span style="color:black">DOSCODE:5F16                 </span><span style="color:navy">jnz     short </span><span style="color:gray">notinvalid </span>; no, no need to invalidate
<span style="color:black">DOSCODE:5F18                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:5F1A                 </span><span style="color:navy">mov     word ptr ds:</span>LocalSFT<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:5F1D                 </span><span style="color:navy">mov     word ptr ds:</span>LocalSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">DOSCODE:5F20
DOSCODE:5F20 </span><span style="color:gray">notinvalid</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5F20                 </span><span style="color:navy">jmp     </span><span style="color:gray">gotlocalSFT
</span><span style="color:black">DOSCODE:5F23 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5F23
DOSCODE:5F23 </span><span style="color:gray">gotnetSFT</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5F23                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:5F25                 </span><span style="color:navy">jnz     short </span><span style="color:gray">closenet
</span><span style="color:black">DOSCODE:5F27                 </span><span style="color:navy">mov     word ptr ds:</span>LocalSFT<span style="color:navy">, di </span>; store local SFT address
<span style="color:black">DOSCODE:5F2B                 </span><span style="color:navy">mov     word ptr ds:</span>LocalSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:5F2F
DOSCODE:5F2F </span><span style="color:gray">closenet</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5F2F                 </span><span style="color:navy">mov     word ptr ds:</span>THISSFT<span style="color:navy">, di </span>; set thissft
<span style="color:black">DOSCODE:5F33                 </span><span style="color:navy">mov     word ptr ds:</span>THISSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:5F37
DOSCODE:5F37 </span><span style="color:gray">LRUClose</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5F37                 </span><span style="color:navy">cmp     word ptr es:[di], </span><span style="color:#ff8000">0 </span>; [es:di+SF_ENTRY.sf_ref_count]
<span style="color:black">DOSCODE:5F37                                         </span>; is ref count still &lt;&gt; 0?
<span style="color:black">DOSCODE:5F3B                 </span><span style="color:navy">jz      short </span><span style="color:gray">LRUDone   </span>; nope, all done
<span style="color:black">DOSCODE:5F3D                 </span><span style="color:navy">call    </span>DOS_CLOSE
<span style="color:black">DOSCODE:5F40                 </span><span style="color:navy">jnb     short </span><span style="color:gray">LRUClose  </span>; no error =&gt; clean up
<span style="color:black">DOSCODE:5F42                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">6           </span>; error_invalid_handle
<span style="color:black">DOSCODE:5F44                 </span><span style="color:navy">jz      short </span><span style="color:gray">LRUClose
</span><span style="color:black">DOSCODE:5F46
DOSCODE:5F46 </span><span style="color:gray">errorbadSFT</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5F46                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:5F47                 </span><span style="color:navy">jmp     short </span><span style="color:gray">LRUDead
</span><span style="color:black">DOSCODE:5F49 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5F49
DOSCODE:5F49 </span><span style="color:gray">LRUDone</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5F49                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">DOSCODE:5F4B                 </span><span style="color:navy">call    </span>BlastSFT        ; fill SFT with 0 (AL), &#039;C&#039; cleared
<span style="color:black">DOSCODE:5F4E
DOSCODE:5F4E </span><span style="color:gray">LRUDead</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5F4E                 </span><span style="color:navy">call    </span>restore_world
<span style="color:black">DOSCODE:5F51                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:5F52                 </span><span style="color:navy">mov     es, cs:</span>DosDSeg
<span style="color:black">DOSCODE:5F57                 </span><span style="color:navy">les     di, es:</span>THISSFT  ; es:di points at allocated SFT
<span style="color:black">DOSCODE:5F5C                 </span><span style="color:navy">jb      short </span><span style="color:gray">LruFCB_err
</span><span style="color:black">DOSCODE:5F5E                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5F5F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5F5F
DOSCODE:5F5F </span><span style="color:gray">LruFCB_err</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5F5F                 </span><span style="color:navy">mov     al, </span><span style="color:green">23h         </span>; error_FCB_unavailable
<span style="color:black">DOSCODE:5F61                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5F61 </span>LRUFCB          <span style="color:black">endp
DOSCODE:5F61
DOSCODE:5F62
DOSCODE:5F62 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5F62
DOSCODE:5F62
DOSCODE:5F62 </span>RegenCopyName   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5F62                 </span><span style="color:navy">lodsb                   </span>; load character
<span style="color:black">DOSCODE:5F63                 </span><span style="color:navy">call    </span>UCase           ; convert char to upper case
<span style="color:black">DOSCODE:5F66                 </span><span style="color:navy">stosb                   </span>; store converted character
<span style="color:black">DOSCODE:5F67                 </span><span style="color:navy">loop    </span>RegenCopyName
<span style="color:black">DOSCODE:5F69                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5F69 </span>RegenCopyName   <span style="color:black">endp
DOSCODE:5F69
DOSCODE:5F6A
DOSCODE:5F6A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5F6A
DOSCODE:5F6A
DOSCODE:5F6A </span>FCBRegen        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5F6A
DOSCODE:5F6A </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:5FFB SIZE 0000006A BYTES
</span><span style="color:black">DOSCODE:5F6A
DOSCODE:5F6A                 </span><span style="color:navy">mov     al, [si+</span><span style="color:#ff8000">19h</span><span style="color:navy">]    </span>; [SI+fcb_l_drive]
<span style="color:black">DOSCODE:5F6D                 </span><span style="color:navy">test    al, </span><span style="color:green">80h         </span>; FCBSPECIAL
<span style="color:black">DOSCODE:5F6F                 </span><span style="color:navy">jz      short </span><span style="color:gray">RegenNoSharing
</span><span style="color:black">DOSCODE:5F71                 </span><span style="color:navy">call    </span>CheckShare      ; test for sharer
<span style="color:black">DOSCODE:5F74                 </span><span style="color:navy">jnz     short </span><span style="color:gray">RegenFail </span>; yep, fail this.
<span style="color:black">DOSCODE:5F76                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1100h
</span><span style="color:black">DOSCODE:5F79                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - INSTALLATION CHECK
<span style="color:black">DOSCODE:5F79                                         </span>; Return: AL = 00h  not installed, OK to install
<span style="color:black">DOSCODE:5F79                                         </span>; 01h  not installed, not OK to install
<span style="color:black">DOSCODE:5F79                                         </span>; FFh  installed
<span style="color:black">DOSCODE:5F7B                 </span><span style="color:navy">or      al, al          </span>; is it there?
<span style="color:black">DOSCODE:5F7D                 </span><span style="color:navy">jz      short </span><span style="color:gray">RegenDead </span>; no, just fail the operation
<span style="color:black">DOSCODE:5F7F
DOSCODE:5F7F </span><span style="color:gray">RegenFail</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5F7F                 </span><span style="color:navy">mov     ax, ss:</span>USER_IN_AX
<span style="color:black">DOSCODE:5F83                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">10h         </span>; FCB_CLOSE
<span style="color:black">DOSCODE:5F86                 </span><span style="color:navy">jz      short </span><span style="color:gray">RegenDead
</span><span style="color:black">DOSCODE:5F88                 </span><span style="color:navy">call    </span>FCBHardErr      ; massive hard error
<span style="color:black">DOSCODE:5F8B
DOSCODE:5F8B </span><span style="color:gray">RegenDead</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5F8B                 </span><span style="color:navy">stc                     </span>; carry set
<span style="color:black">DOSCODE:5F8C
DOSCODE:5F8C </span><span style="color:gray">FCBRegen_retn</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5F8C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5F8D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5F8D
DOSCODE:5F8D </span><span style="color:gray">RegenNoSharing</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5F8D                 </span><span style="color:navy">call    </span>CheckShare
<span style="color:black">DOSCODE:5F90                 </span><span style="color:navy">jnz     short </span><span style="color:gray">RegenFail
</span><span style="color:black">DOSCODE:5F92                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:5F93                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0           </span>; indicate it is a regen operation
<span style="color:black">DOSCODE:5F95                 </span><span style="color:navy">call    </span>LRUFCB
<span style="color:black">DOSCODE:5F98                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:5F99                 </span><span style="color:navy">jb      short </span><span style="color:gray">FCBRegen_retn
</span><span style="color:black">DOSCODE:5F9B                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">8002h </span>; [ES:DI+SF_ENTRY.sf_mode],
<span style="color:black">DOSCODE:5F9B                                         </span>; sf_isFCB+open_for_both+SHARING_COMPAT
<span style="color:black">DOSCODE:5FA1                 </span><span style="color:navy">and     al, </span><span style="color:green">3Fh         </span>; get drive number for flags
<span style="color:black">DOSCODE:5FA3                 </span><span style="color:navy">cbw
</span><span style="color:black">DOSCODE:5FA4                 </span><span style="color:navy">or      ax, </span><span style="color:green">4000h       </span>; sf_close_nodate ; normal FCB operation
<span style="color:black">DOSCODE:5FA7                 </span><span style="color:navy">mov     cl, [si+</span><span style="color:#ff8000">1Ah</span><span style="color:navy">]    </span>; [SI+fcb_nsl_bits] ; stick in dirty bits.
<span style="color:black">DOSCODE:5FAA                 </span><span style="color:navy">mov     ch, cl
</span><span style="color:black">DOSCODE:5FAC                 </span><span style="color:navy">and     ch, </span><span style="color:green">0C0h        </span>; mask off the dirty/device bits
<span style="color:black">DOSCODE:5FAF                 </span><span style="color:navy">or      al, ch
</span><span style="color:black">DOSCODE:5FB1                 </span><span style="color:navy">and     cl, </span><span style="color:green">0Fh         </span>; access_mask  ; get the mode bits
<span style="color:black">DOSCODE:5FB4                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], cl   </span>; [ES:DI+SF_ENTRY.sf_mode]
<span style="color:black">DOSCODE:5FB8                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], ax   </span>; [ES:DI+SF_ENTRY.sf_flags],AX ; initial flags
<span style="color:black">DOSCODE:5FBC                 </span><span style="color:navy">mov     ax, ss:</span>PROC_ID
<span style="color:black">DOSCODE:5FC0                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">31h</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_PID]
<span style="color:black">DOSCODE:5FC4                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:5FC5                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:5FC6                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:5FC7                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:5FC8                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:5FC9                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:5FCA                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:5FCA                 </span><span style="color:navy">mov     di, offset </span>NAME1
<span style="color:black">DOSCODE:5FCD                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">8
</span><span style="color:black">DOSCODE:5FD0                 </span><span style="color:navy">inc     si              </span>; Skip past drive byte to name in FCB
<span style="color:black">DOSCODE:5FD1                 </span><span style="color:navy">call    </span>RegenCopyName   ; copy the name to NAME1
<span style="color:black">DOSCODE:5FD4                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:5FD5                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:5FD6                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:5FD6                 </span><span style="color:navy">mov     </span>ATTRIB<span style="color:navy">, </span><span style="color:#ff8000">16h     </span>; attr_hidden+attr_system+attr_directory
<span style="color:black">DOSCODE:5FDB                 </span><span style="color:navy">call    </span>DEVNAME
<span style="color:black">DOSCODE:5FDE                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:5FDF                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:5FE0                 </span>assume es:nothing
<span style="color:black">DOSCODE:5FE0                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:5FE1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:5FE2                 </span>assume ds:nothing
<span style="color:black">DOSCODE:5FE2                 </span><span style="color:navy">jb      short </span><span style="color:gray">RegenFileNoSharing </span>; not found on device list =&gt; file
<span style="color:black">DOSCODE:5FE4                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], bh   </span>; [ES:DI+SF_ENTRY.sf_flags] ; device parms
<span style="color:black">DOSCODE:5FE8                 </span><span style="color:navy">mov     byte ptr es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [ES:DI+SF_ENTRY.sf_attr] ; attribute
<span style="color:black">DOSCODE:5FED                 </span><span style="color:navy">lds     si, ss:</span>DEVPT    ; get device driver
<span style="color:black">DOSCODE:5FED </span>FCBRegen        <span style="color:black">endp
DOSCODE:5FED
DOSCODE:5FF2
DOSCODE:5FF2 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:5FF2
DOSCODE:5FF2
DOSCODE:5FF2 </span>regen_save_dpb  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5FF2                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">7</span><span style="color:navy">], si   </span>; [ES:DI+SF_ENTRY.sf_devptr]
<span style="color:black">DOSCODE:5FF6                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">9</span><span style="color:navy">], ds </span>; [ES:DI+SF_ENTRY.sf_devptr+2]
<span style="color:black">DOSCODE:5FFA                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:5FFA </span>regen_save_dpb  <span style="color:black">endp
DOSCODE:5FFA
DOSCODE:5FFB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5FFB </span><span style="color:gray">; START OF FUNCTION CHUNK FOR FCBRegen
</span><span style="color:black">DOSCODE:5FFB
DOSCODE:5FFB </span><span style="color:gray">RegenDeadJ</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5FFB                 </span><span style="color:navy">jmp     short </span><span style="color:gray">RegenDead
</span><span style="color:black">DOSCODE:5FFD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:5FFD
DOSCODE:5FFD </span><span style="color:gray">RegenFileNoSharing</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:5FFD                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_flags]
<span style="color:black">DOSCODE:6001                 </span><span style="color:navy">and     ax, </span><span style="color:green">3Fh
</span><span style="color:black">DOSCODE:6004                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:6005                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:6006                 </span><span style="color:navy">call    </span>FIND_DPB
<span style="color:black">DOSCODE:6009                 </span><span style="color:navy">call    </span>regen_save_dpb
<span style="color:black">DOSCODE:600C                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:600D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:600E                 </span><span style="color:navy">jb      short </span><span style="color:gray">RegenDeadJ
</span><span style="color:black">DOSCODE:6010                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">]    </span>; [SI+fcb_nsl_dirsec]
<span style="color:black">DOSCODE:6013                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_dirsec]
<span style="color:black">DOSCODE:6017                 </span><span style="color:navy">mov     al, [si+</span><span style="color:#ff8000">18h</span><span style="color:navy">]    </span>; [si+fcb_sfn]
<span style="color:black">DOSCODE:601A                 </span><span style="color:navy">and     al, </span><span style="color:green">0C0h        </span>; get the 2 attribute bits
<span style="color:black">DOSCODE:601C                 </span><span style="color:navy">mov     ah, al
</span><span style="color:black">DOSCODE:601E                 </span><span style="color:navy">rol     ah, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:6020                 </span><span style="color:navy">shr     al, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:6022                 </span><span style="color:navy">or      al, ah
</span><span style="color:black">DOSCODE:6024                 </span><span style="color:navy">and     al, </span><span style="color:green">3Fh         </span>; mask off unused bits
<span style="color:black">DOSCODE:6026                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], al   </span>; [es:di+SF_ENTRY.sf_attr]
<span style="color:black">DOSCODE:602A                 </span><span style="color:navy">mov     al, [si+</span><span style="color:#ff8000">18h</span><span style="color:navy">]    </span>; [si+fcb_sfn]
<span style="color:black">DOSCODE:602D                 </span><span style="color:navy">and     al, </span><span style="color:green">3Fh         </span>; mask off top 2 bits -- attr bits
<span style="color:black">DOSCODE:602F                 </span><span style="color:navy">sub     ah, ah
</span><span style="color:black">DOSCODE:6031                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">], ax </span>; [es:di+SF_ENTRY.sf_dirsec+2]
<span style="color:black">DOSCODE:6031                                         </span>; update high word
<span style="color:black">DOSCODE:6035                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">]    </span>; [SI+fcb_nsl_firclus]
<span style="color:black">DOSCODE:6038                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">2Bh</span><span style="color:navy">], ax </span>; [es:di+SF_ENTRY.sf_chain] ; .sf_chain ! (MSDOS 6.22)
<span style="color:black">DOSCODE:6038                                         </span>; first cluster (32 bit) !?
<span style="color:black">DOSCODE:603C                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">35h</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_lstclus]
<span style="color:black">DOSCODE:6040                 </span><span style="color:navy">xor     ax, ax          </span>; 0
<span style="color:black">DOSCODE:6042                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">], ax </span>; [es:di+SF_ENTRY.sf_chain+2] ; .sf_chain ! (MSDOS 6.22)
<span style="color:black">DOSCODE:6042                                         </span>; high word of first cluster (32 bit) !?
<span style="color:black">DOSCODE:6046                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">37h</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_lstclus+2]
<span style="color:black">DOSCODE:604A                 </span><span style="color:navy">mov     al, [si+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">]    </span>; [SI+fcb_nsl_dirpos]
<span style="color:black">DOSCODE:604D                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], al </span>; [ES:DI+SF_ENTRY.sf_dirpos]
<span style="color:black">DOSCODE:6051                 </span><span style="color:navy">inc     word ptr es:[di] </span>; Increment reference count
<span style="color:black">DOSCODE:6054                 </span><span style="color:navy">call    </span>set_sftfcb_entry ; put SFT entry number in the SFTFCB table
<span style="color:black">DOSCODE:6054                                         </span>; as FCB index number
<span style="color:black">DOSCODE:6057                 </span><span style="color:navy">lea     si, [si+</span><span style="color:#ff8000">1</span><span style="color:navy">]      </span>; [SI+SYS_FCB.name]
<span style="color:black">DOSCODE:605A                 </span><span style="color:navy">lea     di, [di+</span><span style="color:#ff8000">20h</span><span style="color:navy">]    </span>; [DI+SF_ENTRY.sf_name]
<span style="color:black">DOSCODE:605D                 </span><span style="color:navy">mov     cx, </span><span style="color:green">11          </span>; SYS_FCB.EXTENT-SYS_FCB.name ; 12-1
<span style="color:black">DOSCODE:6060                 </span><span style="color:navy">call    </span>RegenCopyName
<span style="color:black">DOSCODE:6063                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:6064                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6064 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR FCBRegen
</span><span style="color:black">DOSCODE:6065
DOSCODE:6065 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:6065
DOSCODE:6065
DOSCODE:6065 </span>BlastSFT        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6065                 </span><span style="color:navy">call    </span>SFT_FREE
<span style="color:black">DOSCODE:6068                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:6069                 </span><span style="color:navy">mov     cx, </span><span style="color:green">59          </span>; SF_ENTRY.size
<span style="color:black">DOSCODE:606C                 </span><span style="color:navy">rep stosb
</span><span style="color:black">DOSCODE:606E                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:606F                 </span><span style="color:navy">sub     ax, ax          </span>; 0
<span style="color:black">DOSCODE:6071                 </span><span style="color:navy">mov     es:[di], ax     </span>; word [ES:DI+SF_ENTRY.sf_ref_count],0
<span style="color:black">DOSCODE:6074                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">], ax </span>; %define sf_LRU SF_ENTRY.sf_position
<span style="color:black">DOSCODE:6074                                         </span>; word [es:di+sf_LRU],0
<span style="color:black">DOSCODE:6078                 </span><span style="color:navy">dec     ax              </span>; -1
<span style="color:black">DOSCODE:6079                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">17h</span><span style="color:navy">], ax </span>; %define sf_OpenAge SF_ENTRY.sf_position+2
<span style="color:black">DOSCODE:6079                                         </span>; word [es:di+sf_OpenAge],-1
<span style="color:black">DOSCODE:607D                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:607D </span>BlastSFT        <span style="color:black">endp
DOSCODE:607D
DOSCODE:607E
DOSCODE:607E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:607E
DOSCODE:607E
DOSCODE:607E </span>CheckFCB        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:607E                 </span><span style="color:navy">test    byte ptr [si+</span><span style="color:#ff8000">19h</span><span style="color:navy">], </span><span style="color:green">0C0h </span>; [si+fcb_l_drive],
<span style="color:black">DOSCODE:607E                                         </span>; FCBNETWORK|FCBSHARE|FCBDEVICE
<span style="color:black">DOSCODE:6082                 </span><span style="color:navy">jz      short </span><span style="color:gray">BadSFT
</span><span style="color:black">DOSCODE:6084                 </span><span style="color:navy">les     di, ss:</span>SFTFCB
<span style="color:black">DOSCODE:6089                 </span><span style="color:navy">cmp     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], al   </span>; [ES:DI+SFT.SFCount]
<span style="color:black">DOSCODE:608D                 </span><span style="color:navy">jb      short </span><span style="color:gray">BadSFT
</span><span style="color:black">DOSCODE:608F                 </span><span style="color:navy">mov     bl, </span><span style="color:green">59
</span><span style="color:black">DOSCODE:6091                 </span><span style="color:navy">mul     bl
</span><span style="color:black">DOSCODE:6093                 </span><span style="color:navy">lea     di, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [DI+SFT.SFTable]
<span style="color:black">DOSCODE:6096                 </span><span style="color:navy">add     di, ax
</span><span style="color:black">DOSCODE:6098                 </span><span style="color:navy">mov     ax, ss:</span>PROC_ID
<span style="color:black">DOSCODE:609C                 </span><span style="color:navy">cmp     es:[di+</span><span style="color:#ff8000">31h</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_PID]
<span style="color:black">DOSCODE:60A0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">BadSFT    </span>; must match process
<span style="color:black">DOSCODE:60A2                 </span><span style="color:navy">cmp     word ptr es:[di], </span><span style="color:#ff8000">0 </span>; [ES:DI+SF_ENTRY.sf_ref_count]
<span style="color:black">DOSCODE:60A6                 </span><span style="color:navy">jz      short </span><span style="color:gray">BadSFT    </span>; must also be in use
<span style="color:black">DOSCODE:60A8                 </span><span style="color:navy">mov     al, [si+</span><span style="color:#ff8000">19h</span><span style="color:navy">]    </span>; [SI+fcb_l_drive]
<span style="color:black">DOSCODE:60AB                 </span><span style="color:navy">test    al, </span><span style="color:green">80h         </span>; FCBSPECIAL ; a special FCB?
<span style="color:black">DOSCODE:60AD                 </span><span style="color:navy">jz      short </span><span style="color:gray">CheckNoShare </span>; No. try local or device
<span style="color:black">DOSCODE:60AF                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:60B0                 </span><span style="color:navy">and     al, </span><span style="color:green">0C0h        </span>; FCBMASK
<span style="color:black">DOSCODE:60B2                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0C0h        </span>; FCBSHARE ; net FCB?
<span style="color:black">DOSCODE:60B4                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:60B5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">CheckNet  </span>; no
<span style="color:black">DOSCODE:60B5                                         </span>; yes
<span style="color:black">DOSCODE:60B7                 </span><span style="color:navy">call    ss:</span>ShChk        ; Call far [ss:JShare+(11*4)] ; 11 = ShChk
<span style="color:black">DOSCODE:60BC                 </span><span style="color:navy">jb      short </span><span style="color:gray">BadSFT
</span><span style="color:black">DOSCODE:60BE
DOSCODE:60BE </span><span style="color:gray">CheckD</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:60BE                 </span><span style="color:navy">and     al, </span><span style="color:green">3Fh
</span><span style="color:black">DOSCODE:60C0                 </span><span style="color:navy">mov     ah, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_flags]
<span style="color:black">DOSCODE:60C4                 </span><span style="color:navy">and     ah, </span><span style="color:green">3Fh
</span><span style="color:black">DOSCODE:60C7                 </span><span style="color:navy">cmp     ah, al
</span><span style="color:black">DOSCODE:60C9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">BadSFT
</span><span style="color:black">DOSCODE:60CB
DOSCODE:60CB </span>CheckD_retn<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:60CB                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:60CC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:60CC
DOSCODE:60CC </span><span style="color:gray">BadSFT</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:60CC                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:60CD                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:60CE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:60CE
DOSCODE:60CE </span><span style="color:gray">CheckNet</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:60CE                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">1Ch</span><span style="color:navy">]    </span>; [SI+fcb_netID]
<span style="color:black">DOSCODE:60D1                 </span><span style="color:navy">cmp     ax, es:[di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">] </span>; %define sf_serial_ID SF_ENTRY.sf_firclus
<span style="color:black">DOSCODE:60D1                                         </span>; [ES:DI+sf_serial_ID]
<span style="color:black">DOSCODE:60D5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">BadSFT
</span><span style="color:black">DOSCODE:60D7                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:60D8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:60D8
DOSCODE:60D8 </span><span style="color:gray">CheckNoShare</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:60D8                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">1Ah</span><span style="color:navy">]    </span>; [SI+fcb_nsld_drvptr]
<span style="color:black">DOSCODE:60DB                 </span><span style="color:navy">cmp     bx, es:[di+</span><span style="color:#ff8000">7</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_devptr]
<span style="color:black">DOSCODE:60DF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">BadSFT
</span><span style="color:black">DOSCODE:60E1                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">1Ch</span><span style="color:navy">]    </span>; [SI+fcb_nsld_drvptr+2]
<span style="color:black">DOSCODE:60E4                 </span><span style="color:navy">cmp     bx, es:[di+</span><span style="color:#ff8000">9</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:60E8                 </span><span style="color:navy">jnz     short </span><span style="color:gray">BadSFT    </span>; [ES:DI+SF_ENTRY.sf_devptr+2]
<span style="color:black">DOSCODE:60EA                 </span><span style="color:navy">jmp     short </span><span style="color:gray">CheckD
</span><span style="color:black">DOSCODE:60EA </span>CheckFCB        <span style="color:black">endp
DOSCODE:60EA
DOSCODE:60EC
DOSCODE:60EC </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:60EC
DOSCODE:60EC
DOSCODE:60EC </span>SFTFromFCB      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:60EC                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:60ED                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:60EE                 </span><span style="color:navy">mov     al, [si+</span><span style="color:#ff8000">18h</span><span style="color:navy">]    </span>; [SI+fcb_sfn] ; set SFN for check
<span style="color:black">DOSCODE:60F1                 </span><span style="color:navy">call    </span>CheckFCB
<span style="color:black">DOSCODE:60F4                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:60F5                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:60F6                 </span><span style="color:navy">mov     word ptr ss:</span>THISSFT<span style="color:navy">, di
</span><span style="color:black">DOSCODE:60FB                 </span><span style="color:navy">mov     word ptr ss:</span>THISSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:6100                 </span><span style="color:navy">jnb     short </span><span style="color:gray">Set_SFT   </span>; no problems, just set thissft
<span style="color:black">DOSCODE:6102                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:6103                 </span><span style="color:navy">call    </span>save_world
<span style="color:black">DOSCODE:6106                 </span><span style="color:navy">call    </span>FCBRegen
<span style="color:black">DOSCODE:6109                 </span><span style="color:navy">call    </span>restore_world
<span style="color:black">DOSCODE:610C                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:610D                 </span><span style="color:navy">mov     ax, ss:</span>EXTERR
<span style="color:black">DOSCODE:6111                 </span><span style="color:navy">jb      short </span>CheckD_retn
<span style="color:black">DOSCODE:6113
DOSCODE:6113 </span><span style="color:gray">Set_SFT</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6113                 </span><span style="color:navy">les     di, ss:</span>THISSFT
<span style="color:black">DOSCODE:6118                 </span><span style="color:navy">push    ss:</span>PROC_ID      ; set process id
<span style="color:black">DOSCODE:611D                 </span><span style="color:navy">pop     word ptr es:[di+</span><span style="color:#ff8000">31h</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_PID]
<span style="color:black">DOSCODE:6121                 </span><span style="color:navy">retn                    </span>; cf=0
<span style="color:black">DOSCODE:6121 </span>SFTFromFCB      <span style="color:black">endp
DOSCODE:6121
DOSCODE:6122
DOSCODE:6122 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:6122
DOSCODE:6122
DOSCODE:6122 </span>FCBHardErr      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6122                 </span><span style="color:navy">mov     es, cs:</span>DosDSeg
<span style="color:black">DOSCODE:6127                 </span><span style="color:navy">mov     ax, </span><span style="color:green">23h         </span>; error_FCB_unavailable
<span style="color:black">DOSCODE:612A                 </span><span style="color:navy">mov     es:</span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">8   </span>; Allowed_FAIL
<span style="color:black">DOSCODE:6130                 </span><span style="color:navy">les     bp, es:</span>THISDPB
<span style="color:black">DOSCODE:6135                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">1           </span>; Fake some registers
<span style="color:black">DOSCODE:6138                 </span><span style="color:navy">mov     cx, di
</span><span style="color:black">DOSCODE:613A                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:613C                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], dx </span>; [es:bp+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:6140                 </span><span style="color:navy">jz      short </span><span style="color:gray">fcbharderr_fat32 </span>; FAT32
<span style="color:black">DOSCODE:6142                 </span><span style="color:navy">mov     es:</span>HIGH_SECTOR<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:6147                 </span><span style="color:navy">mov     dx, es:[bp+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">] </span>; [es:bp+DPB.FIRST_SECTOR]
<span style="color:black">DOSCODE:614B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">fcbharderr_fat
</span><span style="color:black">DOSCODE:614D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:614D
DOSCODE:614D </span><span style="color:gray">fcbharderr_fat32</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:614D                 </span><span style="color:navy">mov     dx, es:[bp+</span><span style="color:#ff8000">2Bh</span><span style="color:navy">] </span>; [es:bp+DPB.FCLUS_FSECTOR+2]
<span style="color:black">DOSCODE:6151                 </span><span style="color:navy">mov     es:</span>HIGH_SECTOR<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:6156                 </span><span style="color:navy">mov     dx, es:[bp+</span><span style="color:#ff8000">29h</span><span style="color:navy">] </span>; [es:bp+DPB.FCLUS_FSECTOR]
<span style="color:black">DOSCODE:615A
DOSCODE:615A </span><span style="color:gray">fcbharderr_fat</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:615A                 </span><span style="color:navy">call    </span>HARDERR
<span style="color:black">DOSCODE:615D                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:615E                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:615E </span>FCBHardErr      <span style="color:black">endp
DOSCODE:615E
DOSCODE:615F
DOSCODE:615F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:615F
DOSCODE:615F
DOSCODE:615F </span>GetRR           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:615F                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">21h</span><span style="color:navy">]    </span>; [SI+SYS_FCB.RR]
<span style="color:black">DOSCODE:6162                 </span><span style="color:navy">mov     dx, [si+</span><span style="color:#ff8000">23h</span><span style="color:navy">]    </span>; [SI+SYS_FCB.RR+2]
<span style="color:black">DOSCODE:6165                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">64          </span>; ignore MSB of RR if recsiz &gt; 64
<span style="color:black">DOSCODE:6168                 </span><span style="color:navy">jb      short </span>GetRRBye
<span style="color:black">DOSCODE:6168 </span>GetRR           <span style="color:black">endp
DOSCODE:6168
DOSCODE:616A </span><span style="color:gray">; START OF FUNCTION CHUNK FOR GetExtent
</span><span style="color:black">DOSCODE:616A
DOSCODE:616A </span><span style="color:gray">GetExtent_bye</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:616A                 </span><span style="color:navy">xor     dh, dh
</span><span style="color:black">DOSCODE:616A </span><span style="color:gray">; END OF FUNCTION CHUNK FOR GetExtent
</span><span style="color:maroon">DOSCODE:616C
DOSCODE:616C </span>GetRRBye<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:616C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:616D
DOSCODE:616D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:616D
DOSCODE:616D
DOSCODE:616D </span>GetExtent       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:616D
DOSCODE:616D </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:616A SIZE 00000002 BYTES
</span><span style="color:black">DOSCODE:616D
DOSCODE:616D                 </span><span style="color:navy">mov     al, [si+</span><span style="color:#ff8000">20h</span><span style="color:navy">]    </span>; [SI+SYS_FCB.NR]
<span style="color:black">DOSCODE:6170                 </span><span style="color:navy">mov     dx, [si+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">]    </span>; [SI+SYS_FCB.EXTENT]
<span style="color:black">DOSCODE:6173                 </span><span style="color:navy">shl     al, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:6175                 </span><span style="color:navy">shr     dx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:6177                 </span><span style="color:navy">rcr     al, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:6179                 </span><span style="color:navy">mov     ah, dl
</span><span style="color:black">DOSCODE:617B                 </span><span style="color:navy">mov     dl, dh
</span><span style="color:black">DOSCODE:617D                 </span><span style="color:navy">jmp     short </span><span style="color:gray">GetExtent_bye
</span><span style="color:black">DOSCODE:617D </span>GetExtent       <span style="color:black">endp
DOSCODE:617D
DOSCODE:617F
DOSCODE:617F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:617F
DOSCODE:617F
DOSCODE:617F </span>SetExtent       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:617F                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:6180                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:6181                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">DOSCODE:6183                 </span><span style="color:navy">and     al, </span><span style="color:green">7Fh         </span>; next rec field
<span style="color:black">DOSCODE:6185                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">20h</span><span style="color:navy">], al    </span>; [SI+SYS_FCB.NR]
<span style="color:black">DOSCODE:6188                 </span><span style="color:navy">and     cl, </span><span style="color:green">80h         </span>; save upper bit
<span style="color:black">DOSCODE:618B                 </span><span style="color:navy">shl     cx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:618D                 </span><span style="color:navy">rcl     dx, </span><span style="color:green">1           </span>; move high bit of CX to low bit of DX
<span style="color:black">DOSCODE:618F                 </span><span style="color:navy">mov     al, ch
</span><span style="color:black">DOSCODE:6191                 </span><span style="color:navy">mov     ah, dl
</span><span style="color:black">DOSCODE:6193                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">], ax    </span>; [SI+SYS_FCB.EXTENT],AX  ; all done
<span style="color:black">DOSCODE:6196                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:6197                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:6198                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6198 </span>SetExtent       <span style="color:black">endp
DOSCODE:6198
DOSCODE:6199
DOSCODE:6199 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:6199
DOSCODE:6199
DOSCODE:6199 </span>GetExtended     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6199                 </span><span style="color:navy">mov     si, dx
</span><span style="color:black">DOSCODE:619B                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0FFh </span>; -1 ; look for extention
<span style="color:black">DOSCODE:619E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GetBye    </span>; not there
<span style="color:black">DOSCODE:61A0                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">7           </span>; point to FCB
<span style="color:black">DOSCODE:61A3
DOSCODE:61A3 </span><span style="color:gray">GetBye</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:61A3                 </span><span style="color:navy">cmp     si, dx          </span>; set condition codes
<span style="color:black">DOSCODE:61A5
DOSCODE:61A5 </span>getextd_retn<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:61A5                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:61A5 </span>GetExtended     <span style="color:black">endp
DOSCODE:61A5
DOSCODE:61A6
DOSCODE:61A6 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:61A6
DOSCODE:61A6
DOSCODE:61A6 </span>GetRecSize      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:61A6                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">]    </span>; [SI+SYS_FCB.RECSIZ] ; get his record size
<span style="color:black">DOSCODE:61A9                 </span><span style="color:navy">or      bx, bx          </span>; is it nul?
<span style="color:black">DOSCODE:61AB                 </span><span style="color:navy">jnz     short </span>getextd_retn
<span style="color:black">DOSCODE:61AD                 </span><span style="color:navy">mov     bl, </span><span style="color:green">128         </span>; use default size
<span style="color:black">DOSCODE:61AF                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], bx    </span>; stuff it back
<span style="color:black">DOSCODE:61B2                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:61B2 </span>GetRecSize      <span style="color:black">endp
DOSCODE:61B2
</span><span style="color:maroon">DOSCODE:61B3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:61B3
DOSCODE:61B3 </span>$FCB_RANDOM_WRITE_BLOCK<span style="color:navy">:                </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:61B3                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Ah         </span>; RANDOM+BLOCK
<span style="color:maroon">DOSCODE:61B5                 </span><span style="color:navy">jmp     short </span>FCBIO
<span style="color:maroon">DOSCODE:61B7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:61B7
DOSCODE:61B7 </span>$FCB_RANDOM_READ_BLOCK<span style="color:navy">:                 </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:61B7                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Eh         </span>; RANDOM+FCBREAD+BLOCK
<span style="color:maroon">DOSCODE:61B9                 </span><span style="color:navy">jmp     short </span>FCBIO
<span style="color:maroon">DOSCODE:61BB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:61BB
DOSCODE:61BB </span>$FCB_SEQ_READ<span style="color:navy">:                          </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:61BB                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">4           </span>; FCBREAD
<span style="color:maroon">DOSCODE:61BD                 </span><span style="color:navy">jmp     short </span>FCBIO
<span style="color:maroon">DOSCODE:61BF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:61BF
DOSCODE:61BF </span>$FCB_SEQ_WRITE<span style="color:navy">:                         </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:61BF                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:61C1                 </span><span style="color:navy">jmp     short </span>FCBIO
<span style="color:maroon">DOSCODE:61C3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:61C3
DOSCODE:61C3 </span>$FCB_RANDOM_READ<span style="color:navy">:                       </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:61C3                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">6           </span>; RANDOM+FCBREAD
<span style="color:maroon">DOSCODE:61C5                 </span><span style="color:navy">jmp     short </span>FCBIO
<span style="color:maroon">DOSCODE:61C7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:61C7
DOSCODE:61C7 </span>$FCB_RANDOM_WRITE<span style="color:navy">:                      </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:61C7                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2           </span>; RANDOM
<span style="color:maroon">DOSCODE:61C9
DOSCODE:61C9 </span>FCBIO<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:61C9                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">DOSCODE:61CA                 </span><span style="color:navy">mov     bp, sp
</span><span style="color:maroon">DOSCODE:61CC                 </span><span style="color:navy">sub     sp, </span><span style="color:green">20
</span><span style="color:maroon">DOSCODE:61CF                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">20</span><span style="color:navy">], al     </span>; FCBOp
<span style="color:maroon">DOSCODE:61D2                 </span><span style="color:navy">mov     byte ptr [bp-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; FCBErr
<span style="color:maroon">DOSCODE:61D6                 </span><span style="color:navy">call    </span>GetExtended
<span style="color:maroon">DOSCODE:61D9                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">20</span><span style="color:navy">], </span><span style="color:green">8 </span>; test FCBOp,BLOCK
<span style="color:maroon">DOSCODE:61DD                 </span><span style="color:navy">jnz     short </span>GetPos
<span style="color:maroon">DOSCODE:61DF                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:61E2
DOSCODE:61E2 </span>GetPos<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:61E2                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">3</span><span style="color:navy">], cx      </span>; mov cRec,cx
<span style="color:maroon">DOSCODE:61E5                 </span><span style="color:navy">call    </span>GetExtent       ; RecPos = GetExtent ();
<span style="color:maroon">DOSCODE:61E8                 </span><span style="color:navy">call    </span>GetRecSize      ; RecSize = GetRecSize ();
<span style="color:maroon">DOSCODE:61EB                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">9</span><span style="color:navy">], bx      </span>; RecSize
<span style="color:maroon">DOSCODE:61EE                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">20</span><span style="color:navy">], </span><span style="color:green">2 </span>; test FCBOp,RANDOM
<span style="color:maroon">DOSCODE:61F2                 </span><span style="color:navy">jz      short </span>GetRec
<span style="color:maroon">DOSCODE:61F4                 </span><span style="color:navy">call    </span>GetRR
<span style="color:maroon">DOSCODE:61F7
DOSCODE:61F7 </span>GetRec<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:61F7                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">7</span><span style="color:navy">], ax      </span>; mov RecPosL,ax
<span style="color:maroon">DOSCODE:61FA                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">5</span><span style="color:navy">], dx      </span>; mov RecPosH,dx
<span style="color:maroon">DOSCODE:61FD                 </span><span style="color:navy">call    </span>SetExtent
<span style="color:maroon">DOSCODE:6200                 </span><span style="color:navy">mov     ax, [bp-</span><span style="color:green">5</span><span style="color:navy">]      </span>; RecPosH
<span style="color:maroon">DOSCODE:6203                 </span><span style="color:navy">mul     bx
</span><span style="color:maroon">DOSCODE:6205                 </span><span style="color:navy">mov     di, ax
</span><span style="color:maroon">DOSCODE:6207                 </span><span style="color:navy">mov     ax, [bp-</span><span style="color:green">7</span><span style="color:navy">]      </span>; RecPosL
<span style="color:maroon">DOSCODE:620A                 </span><span style="color:navy">mul     bx              </span>; bPos = RecPos * RecSize
<span style="color:maroon">DOSCODE:620C                 </span><span style="color:navy">add     dx, di
</span><span style="color:maroon">DOSCODE:620E                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">13</span><span style="color:navy">], ax     </span>; bPosL
<span style="color:maroon">DOSCODE:6211                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">11</span><span style="color:navy">], dx     </span>; bPosH
<span style="color:maroon">DOSCODE:6214                 </span><span style="color:navy">mov     ax, [bp-</span><span style="color:green">3</span><span style="color:navy">]      </span>; cRec
<span style="color:maroon">DOSCODE:6217                 </span><span style="color:navy">mul     bx              </span>; cByte = cRec * RecSize
<span style="color:maroon">DOSCODE:6219                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">15</span><span style="color:navy">], ax     </span>; cByte
<span style="color:maroon">DOSCODE:621C                 </span><span style="color:navy">add     ax, word ptr ss:</span>DMAADD ; if (cByte+DMA &gt; 64K) {
<span style="color:maroon">DOSCODE:6221                 </span><span style="color:navy">adc     dx, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:6224                 </span><span style="color:navy">jz      short </span>DoOper
<span style="color:maroon">DOSCODE:6226                 </span><span style="color:navy">mov     byte ptr [bp-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">2 </span>; FCBErr = FTRIM;
<span style="color:maroon">DOSCODE:622A                 </span><span style="color:navy">mov     ax, word ptr ss:</span>DMAADD ; cRec = (64K-DMA)/RecSize;
<span style="color:maroon">DOSCODE:622E                 </span><span style="color:navy">neg     ax
</span><span style="color:maroon">DOSCODE:6230                 </span><span style="color:navy">jnz     short </span>DoDiv
<span style="color:maroon">DOSCODE:6232                 </span><span style="color:navy">dec     ax
</span><span style="color:maroon">DOSCODE:6233
DOSCODE:6233 </span>DoDiv<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6233                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:maroon">DOSCODE:6235                 </span><span style="color:navy">div     bx
</span><span style="color:maroon">DOSCODE:6237                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">3</span><span style="color:navy">], ax      </span>; cRec
<span style="color:maroon">DOSCODE:623A                 </span><span style="color:navy">mul     bx              </span>; cByte = cRec * RecSize;
<span style="color:maroon">DOSCODE:623C                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">15</span><span style="color:navy">], ax     </span>; cByte
<span style="color:maroon">DOSCODE:623C                                         </span>; }
<span style="color:maroon">DOSCODE:623F
DOSCODE:623F </span>DoOper<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:623F                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:maroon">DOSCODE:6241                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">17</span><span style="color:navy">], bx     </span>; cResult = 0;
<span style="color:maroon">DOSCODE:6244                 </span><span style="color:navy">cmp     [bp-</span><span style="color:green">15</span><span style="color:navy">], bx     </span>; if (cByte &lt;&gt; 0 ||
<span style="color:maroon">DOSCODE:6247                 </span><span style="color:navy">jnz     short </span>DoGetExt
<span style="color:maroon">DOSCODE:6249                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:green">2 </span>; test FCBErr,FTRIM
<span style="color:maroon">DOSCODE:6249                                         </span>; (FCBErr&amp;FTRIM) == 0) {
<span style="color:maroon">DOSCODE:624D                 </span><span style="color:navy">jz      short </span>DoGetExt
<span style="color:maroon">DOSCODE:624F                 </span><span style="color:navy">jmp     short </span>SkipOp
<span style="color:maroon">DOSCODE:6251 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:6251
DOSCODE:6251 </span>DoGetExt<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6251                 </span><span style="color:navy">call    </span>SFTFromFCB      ; if (!SFTFromFCB (SFT,FCB))
<span style="color:maroon">DOSCODE:6254                 </span><span style="color:navy">jnb     short </span>ContinueOp
<span style="color:maroon">DOSCODE:6256
DOSCODE:6256 </span>FCBDeath<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6256                 </span><span style="color:navy">call    </span>FCB_RET_ERR     ; signal error, map for extended
<span style="color:maroon">DOSCODE:6259                 </span><span style="color:navy">mov     word ptr [bp-</span><span style="color:green">19</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; cRecRes
<span style="color:maroon">DOSCODE:6259                                         </span>; no bytes transferred
<span style="color:maroon">DOSCODE:625E                 </span><span style="color:navy">mov     byte ptr [bp-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">1 </span>; MOV FCBErr,FEOF
<span style="color:maroon">DOSCODE:6262                 </span><span style="color:navy">jmp     </span>FCBSave
<span style="color:maroon">DOSCODE:6265 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:6265
DOSCODE:6265 </span>ContinueOp<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6265                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:6266                 </span><span style="color:navy">lds     ax, [si+</span><span style="color:#ff8000">10h</span><span style="color:navy">]    </span>; [SI+SYS_FCB.FILSIZ]
<span style="color:maroon">DOSCODE:6269                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">11h</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_size]
<span style="color:maroon">DOSCODE:626D                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">13h</span><span style="color:navy">], ds </span>; [ES:DI+SF_ENTRY.sf_size+2]
<span style="color:maroon">DOSCODE:6271                 </span><span style="color:navy">lds     ax, [bp-</span><span style="color:green">13</span><span style="color:navy">]     </span>; bPos (bPosL, bPosH)
<span style="color:maroon">DOSCODE:6274                 </span><span style="color:navy">mov     dx, ds
</span><span style="color:maroon">DOSCODE:6276                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:6277                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_position]
<span style="color:maroon">DOSCODE:627B                 </span><span style="color:navy">xchg    dx, es:[di+</span><span style="color:#ff8000">17h</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_position+2]
<span style="color:maroon">DOSCODE:627F                 </span><span style="color:navy">push    dx              </span>; save away Open age.
<span style="color:maroon">DOSCODE:6280                 </span><span style="color:navy">mov     cx, [bp-</span><span style="color:green">15</span><span style="color:navy">]     </span>; cByte
<span style="color:maroon">DOSCODE:6283                 </span><span style="color:navy">mov     di, offset </span>DOS_READ
<span style="color:maroon">DOSCODE:6286                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">20</span><span style="color:navy">], </span><span style="color:green">4 </span>; test FCBOp,FCBREAD
<span style="color:maroon">DOSCODE:628A                 </span><span style="color:navy">jnz     short </span>DoContext
<span style="color:maroon">DOSCODE:628C                 </span><span style="color:navy">mov     di, offset </span>DOS_WRITE
<span style="color:maroon">DOSCODE:628F
DOSCODE:628F </span>DoContext<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:628F                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">DOSCODE:6290                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:6291                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:6292                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:6293                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:6294                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:6294                 </span><span style="color:navy">call    di </span><span style="color:gray">; </span>DOS_READ   ; DOS_READ or DOS_WRITE
<span style="color:maroon">DOSCODE:6296                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:6297                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:6298                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:6298                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSCODE:6299                 </span><span style="color:navy">jb      short </span>FCBDeath
<span style="color:maroon">DOSCODE:629B                 </span><span style="color:navy">cmp     ss:</span>DISK_FULL<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:62A1                 </span><span style="color:navy">jz      short </span>NODSKFULL
<span style="color:maroon">DOSCODE:62A3                 </span><span style="color:navy">mov     ss:</span>DISK_FULL<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:62A9
DOSCODE:62A9 </span>NODSKFULL<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:62A9                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">17</span><span style="color:navy">], cx     </span>; cResult
<span style="color:maroon">DOSCODE:62AC                 </span><span style="color:navy">call    </span>SaveFCBInfo     ; SaveFCBInfo (FCB);
<span style="color:maroon">DOSCODE:62AF                 </span><span style="color:navy">pop     word ptr es:[di+</span><span style="color:#ff8000">17h</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_position+2]
<span style="color:maroon">DOSCODE:62AF                                         </span>; restore open age
<span style="color:maroon">DOSCODE:62AF                                         </span>; (sf_OpenAge = SF_ENTRY.sf_position+2)
<span style="color:maroon">DOSCODE:62B3                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:62B4                 </span><span style="color:navy">les     ax, es:[di+</span><span style="color:#ff8000">11h</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_size]
<span style="color:maroon">DOSCODE:62B8                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">10h</span><span style="color:navy">], ax    </span>; [SI+SYS_FCB.FILSIZ]
<span style="color:maroon">DOSCODE:62BB                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">12h</span><span style="color:navy">], es </span>; [SI+SYS_FCB.FILSIZ+2]
<span style="color:maroon">DOSCODE:62BE                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:62BF
DOSCODE:62BF </span>SkipOp<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:62BF                 </span><span style="color:navy">mov     ax, [bp-</span><span style="color:green">17</span><span style="color:navy">]     </span>; cResult
<span style="color:maroon">DOSCODE:62C2                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:maroon">DOSCODE:62C4                 </span><span style="color:navy">div     word ptr [bp-</span><span style="color:green">9</span><span style="color:navy">] </span>; cRecRes = cResult / RecSize;
<span style="color:maroon">DOSCODE:62C7                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">19</span><span style="color:navy">], ax     </span>; cRecRes
<span style="color:maroon">DOSCODE:62CA                 </span><span style="color:navy">add     [bp-</span><span style="color:green">7</span><span style="color:navy">], ax      </span>; RecPosL
<span style="color:maroon">DOSCODE:62CD                 </span><span style="color:navy">adc     word ptr [bp-</span><span style="color:green">5</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; RecPosH
<span style="color:maroon">DOSCODE:62CD                                         </span>; RecPos += cRecResult;
<span style="color:maroon">DOSCODE:62D1                 </span><span style="color:navy">cmp     ax, [bp-</span><span style="color:green">3</span><span style="color:navy">]      </span>; if (cRecRes &lt;&gt; cRec)
<span style="color:maroon">DOSCODE:62D4                 </span><span style="color:navy">jz      short </span>TryBlank
<span style="color:maroon">DOSCODE:62D6                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">20</span><span style="color:navy">], </span><span style="color:green">4 </span>; test FCBOp,FCBREAD
<span style="color:maroon">DOSCODE:62D6                                         </span>; if (OP&amp;FCBRead || !DEVICE)
<span style="color:maroon">DOSCODE:62DA                 </span><span style="color:navy">jnz     short </span>SetEOF
<span style="color:maroon">DOSCODE:62DC                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:DI+SF_ENTRY.sf_flags],
<span style="color:maroon">DOSCODE:62DC                                         </span>; devid_device
<span style="color:maroon">DOSCODE:62E1                 </span><span style="color:navy">jnz     short </span>TryBlank
<span style="color:maroon">DOSCODE:62E3
DOSCODE:62E3 </span>SetEOF<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:62E3                 </span><span style="color:navy">mov     byte ptr [bp-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">1 </span>; mov FCBErr,FEOF
<span style="color:maroon">DOSCODE:62E7
DOSCODE:62E7 </span>TryBlank<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:62E7                 </span><span style="color:navy">or      dx, dx          </span>; if (cResult%RecSize &lt;&gt; 0) {
<span style="color:maroon">DOSCODE:62E9                 </span><span style="color:navy">jz      short </span>SetExt
<span style="color:maroon">DOSCODE:62EB                 </span><span style="color:navy">add     word ptr [bp-</span><span style="color:green">7</span><span style="color:navy">], </span><span style="color:#ff8000">1 </span>; RecPosL
<span style="color:maroon">DOSCODE:62EF                 </span><span style="color:navy">adc     word ptr [bp-</span><span style="color:green">5</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; RecPosH
<span style="color:maroon">DOSCODE:62EF                                         </span>; RecPos++;
<span style="color:maroon">DOSCODE:62F3                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">20</span><span style="color:navy">], </span><span style="color:green">4 </span>; test FCBOp,FCBREAD
<span style="color:maroon">DOSCODE:62F3                                         </span>; if(OP&amp;FCBRead) &lt;&gt; 0) {
<span style="color:maroon">DOSCODE:62F7                 </span><span style="color:navy">jz      short </span>SetExt
<span style="color:maroon">DOSCODE:62F9                 </span><span style="color:navy">inc     word ptr [bp-</span><span style="color:green">19</span><span style="color:navy">] </span>; cRecRes++;
<span style="color:maroon">DOSCODE:62FC                 </span><span style="color:navy">mov     byte ptr [bp-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">3 </span>; FCBErr = FTRIM | FEOF;
<span style="color:maroon">DOSCODE:6300                 </span><span style="color:navy">mov     cx, [bp-</span><span style="color:green">9</span><span style="color:navy">]      </span>; Blank (RecSize-cResult%RecSize,
<span style="color:maroon">DOSCODE:6300                                         </span>;        DMA+cResult);
<span style="color:maroon">DOSCODE:6303                 </span><span style="color:navy">sub     cx, dx
</span><span style="color:maroon">DOSCODE:6305                 </span><span style="color:navy">xor     al, al
</span><span style="color:maroon">DOSCODE:6307                 </span><span style="color:navy">les     di, ss:</span>DMAADD
<span style="color:maroon">DOSCODE:630C                 </span><span style="color:navy">add     di, [bp-</span><span style="color:green">17</span><span style="color:navy">]     </span>; cResult
<span style="color:maroon">DOSCODE:630F                 </span><span style="color:navy">rep stosb               </span>; } }
<span style="color:maroon">DOSCODE:6311
DOSCODE:6311 </span>SetExt<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6311                 </span><span style="color:navy">mov     dx, [bp-</span><span style="color:green">5</span><span style="color:navy">]      </span>; RecPosH
<span style="color:maroon">DOSCODE:6314                 </span><span style="color:navy">mov     ax, [bp-</span><span style="color:green">7</span><span style="color:navy">]      </span>; RecPosL
<span style="color:maroon">DOSCODE:6317                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">20</span><span style="color:navy">], </span><span style="color:green">2 </span>; test FCBOp,RANDOM
<span style="color:maroon">DOSCODE:6317                                         </span>; if ((OP&amp;Random) == 0 ||
<span style="color:maroon">DOSCODE:631B                 </span><span style="color:navy">jz      short </span>DoSetExt
<span style="color:maroon">DOSCODE:631D                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">20</span><span style="color:navy">], </span><span style="color:green">8 </span>; test FCBOp,BLOCK
<span style="color:maroon">DOSCODE:631D                                         </span>; (OP&amp;BLOCK) &lt;&gt; 0)
<span style="color:maroon">DOSCODE:6321                 </span><span style="color:navy">jz      short </span>TrySetRR
<span style="color:maroon">DOSCODE:6323
DOSCODE:6323 </span>DoSetExt<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6323                 </span><span style="color:navy">call    </span>SetExtent       ; SetExtent (RecPos, FCB);
<span style="color:maroon">DOSCODE:6326
DOSCODE:6326 </span>TrySetRR<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6326                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">20</span><span style="color:navy">], </span><span style="color:green">8 </span>; test FCBOp,BLOCK
<span style="color:maroon">DOSCODE:632A                 </span><span style="color:navy">jz      short </span>TryReturn
<span style="color:maroon">DOSCODE:632C                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">21h</span><span style="color:navy">], ax    </span>; FCB-&gt;RR = RecPos;
<span style="color:maroon">DOSCODE:632C                                         </span>; [SI+SYS_FCB.RR]
<span style="color:maroon">DOSCODE:632F                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">23h</span><span style="color:navy">], dl    </span>; [SI+SYS_FCB.RR+2]
<span style="color:maroon">DOSCODE:6332                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], </span><span style="color:green">64 </span>; [SI+SYS_FCB.RECSIZ]
<span style="color:maroon">DOSCODE:6336                 </span><span style="color:navy">jnb     short </span>TryReturn
<span style="color:maroon">DOSCODE:6338                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">24h</span><span style="color:navy">], dh    </span>; Set 4th byte only if record size &lt; 64
<span style="color:maroon">DOSCODE:6338                                         </span>; [SI+SYS_FCB.RR+2+1]
<span style="color:maroon">DOSCODE:633B
DOSCODE:633B </span>TryReturn<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:633B                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">20</span><span style="color:navy">], </span><span style="color:green">4 </span>; test FCBOp,FCBREAD
<span style="color:maroon">DOSCODE:633B                                         </span>; if (!(FCBOP &amp; FCBREAD)) {
<span style="color:maroon">DOSCODE:633F                 </span><span style="color:navy">jnz     short </span>FCBSave
<span style="color:maroon">DOSCODE:6341                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:6342                 </span><span style="color:navy">call    </span>DATE16
<span style="color:maroon">DOSCODE:6345                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:6346                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">14h</span><span style="color:navy">], ax    </span>; FCB-&gt;FDate = date;
<span style="color:maroon">DOSCODE:6346                                         </span>; [SI+SYS_FCB.FDATE]
<span style="color:maroon">DOSCODE:6349                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">16h</span><span style="color:navy">], dx    </span>; FCB-&gt;FTime = time;
<span style="color:maroon">DOSCODE:6349                                         </span>; [SI+SYS_FCB.FTIME]
<span style="color:maroon">DOSCODE:634C
DOSCODE:634C </span>FCBSave<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:634C                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">20</span><span style="color:navy">], </span><span style="color:green">8 </span>; test FCBOp,BLOCK
<span style="color:maroon">DOSCODE:634C                                         </span>; if ((op&amp;BLOCK) &lt;&gt; 0)
<span style="color:maroon">DOSCODE:6350                 </span><span style="color:navy">jz      short </span>DoReturn
<span style="color:maroon">DOSCODE:6352                 </span><span style="color:navy">mov     cx, [bp-</span><span style="color:green">19</span><span style="color:navy">]     </span>; cRecRes ; user_CX = cRecRes;
<span style="color:maroon">DOSCODE:6355                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:6358                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], cx      </span>; [SI+user_env.user_CX]
<span style="color:maroon">DOSCODE:635B
DOSCODE:635B </span>DoReturn<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:635B                 </span><span style="color:navy">mov     al, [bp-</span><span style="color:green">1</span><span style="color:navy">]      </span>; FCBErr ; return (FCBERR);
<span style="color:maroon">DOSCODE:635E                 </span><span style="color:navy">mov     sp, bp
</span><span style="color:maroon">DOSCODE:6360                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSCODE:6361                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:6362 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:6362
DOSCODE:6362 </span>$FCB_OPEN<span style="color:navy">:                              </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:6362                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2           </span>; SHARING_COMPAT+open_for_both
<span style="color:maroon">DOSCODE:6365                 </span><span style="color:navy">mov     cx, offset </span>DOS_OPEN
<span style="color:maroon">DOSCODE:6368
DOSCODE:6368 </span>DoAccess<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6368                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:6369                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:636A                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:636B                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:636C                 </span><span style="color:navy">mov     di, offset </span>OPENBUF
<span style="color:maroon">DOSCODE:636F                 </span><span style="color:navy">call    </span>TransFCB        ; crunch the fcb
<span style="color:maroon">DOSCODE:6372                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:6373                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:6374                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:6375                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:6376                 </span><span style="color:navy">jnb     short </span>FindFCB   ; everything seems ok
<span style="color:maroon">DOSCODE:6378
DOSCODE:6378 </span>FCBOpenErr<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6378                 </span><span style="color:navy">jmp     </span>FCB_RET_ERR
<span style="color:maroon">DOSCODE:637B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:637B
DOSCODE:637B </span>FindFCB<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:637B                 </span><span style="color:navy">call    </span>GetExtended
<span style="color:maroon">DOSCODE:637E                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:637F                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; indicate Open/Create operation
<span style="color:maroon">DOSCODE:6381                 </span><span style="color:navy">call    </span>LRUFCB          ; get a sft entry (no error)
<span style="color:maroon">DOSCODE:6384                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:6385                 </span><span style="color:navy">jb      short </span>HardMessage
<span style="color:maroon">DOSCODE:6387                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">8000h </span>; [es:di+SF_ENTRY.sf_mode],
<span style="color:maroon">DOSCODE:6387                                         </span>; sf_isFCB
<span style="color:maroon">DOSCODE:638D                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:638E                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:638F                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:6390                 </span><span style="color:navy">mov     si, cx
</span><span style="color:maroon">DOSCODE:6392                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:6393                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:6394                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:6394                 </span><span style="color:navy">call    si              </span>; DOS_OPEN or DOS_CREATE
<span style="color:maroon">DOSCODE:6396                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:6397                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:6398                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:6399                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:6399                 </span><span style="color:navy">les     di, ss:</span>THISSFT
<span style="color:maroon">DOSCODE:639E                 </span><span style="color:navy">jnb     short </span>FCBOK     ; operation succeeded
<span style="color:maroon">DOSCODE:63A0
DOSCODE:63A0 </span>failopen<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:63A0                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:63A1                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">52h </span><span style="color:gray">; &#039;R&#039;   </span>; clear out field (free sft)
<span style="color:maroon">DOSCODE:63A3                 </span><span style="color:navy">call    </span>BlastSFT
<span style="color:maroon">DOSCODE:63A6                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:63A7                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">4           </span>; error_too_many_open_files
<span style="color:maroon">DOSCODE:63AA                 </span><span style="color:navy">jz      short </span>HardMessage
<span style="color:maroon">DOSCODE:63AC                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">24h         </span>; error_sharing_buffer_exceeded
<span style="color:maroon">DOSCODE:63AF                 </span><span style="color:navy">jnz     short </span>DeadFCB
<span style="color:maroon">DOSCODE:63B1
DOSCODE:63B1 </span>HardMessage<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:63B1                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:63B2                 </span><span style="color:navy">call    </span>FCBHardErr
<span style="color:maroon">DOSCODE:63B5                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:63B6
DOSCODE:63B6 </span>DeadFCB<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:63B6                 </span><span style="color:navy">jmp     short </span>FCBOpenErr
<span style="color:maroon">DOSCODE:63B8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:63B8
DOSCODE:63B8 </span>FCBOK<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:63B8                 </span><span style="color:navy">call    </span>IsSFTNet        ; Non Fat file?
<span style="color:maroon">DOSCODE:63BB                 </span><span style="color:navy">jnz     short </span>FCBOK2    ; yes
<span style="color:maroon">DOSCODE:63BD                 </span><span style="color:navy">call    </span>CheckShare      ; share around?
<span style="color:maroon">DOSCODE:63C0                 </span><span style="color:navy">jnz     short </span>FCBOK1    ; yes
<span style="color:maroon">DOSCODE:63C2                 </span><span style="color:navy">mov     word ptr ss:</span>LocalSFT<span style="color:navy">, di
</span><span style="color:maroon">DOSCODE:63C7                 </span><span style="color:navy">mov     word ptr ss:</span>LocalSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:maroon">DOSCODE:63CC
DOSCODE:63CC </span>FCBOK1<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:63CC                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">80h </span>; [es:di+SFTENTRY.sf_flags],
<span style="color:maroon">DOSCODE:63CC                                         </span>; devid_device
<span style="color:maroon">DOSCODE:63D1                 </span><span style="color:navy">jnz     short </span>FCBOK2    ; local device
<span style="color:maroon">DOSCODE:63D1                                         </span>; local (disk) file
<span style="color:maroon">DOSCODE:63D3                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">8 </span>; [es:di+SFTENTRY.sf_attr],
<span style="color:maroon">DOSCODE:63D3                                         </span>; attr_volume_id
<span style="color:maroon">DOSCODE:63D8                 </span><span style="color:navy">jnz     short </span>FCBOK2
<span style="color:maroon">DOSCODE:63DA                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:63DB                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:63DC                 </span><span style="color:navy">les     di, es:[di+</span><span style="color:#ff8000">7</span><span style="color:navy">]   </span>; [es:di+SF_ENTRY.sf_devptr]
<span style="color:maroon">DOSCODE:63DC                                         </span>; local file&#039;s DPB
<span style="color:maroon">DOSCODE:63E0                 </span><span style="color:navy">cmp     word ptr es:[di+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:di+DPB.FAT_SIZE]
<span style="color:maroon">DOSCODE:63E5                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:63E6                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:63E7                 </span><span style="color:navy">jnz     short </span>FCBOK2    ; not FAT32
<span style="color:maroon">DOSCODE:63E9                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">0Fh         </span>; error_invalid_drive ; for FAT32
<span style="color:maroon">DOSCODE:63EC                 </span><span style="color:navy">jmp     short </span>failopen
<span style="color:maroon">DOSCODE:63EE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:63EE
DOSCODE:63EE </span>FCBOK2<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:63EE                 </span><span style="color:navy">inc     word ptr es:[di] </span>; inc word [ES:DI+SF_ENTRY.sf_ref_count]
<span style="color:maroon">DOSCODE:63F1                 </span><span style="color:navy">call    </span>set_sftfcb_entry
<span style="color:maroon">DOSCODE:63F4                 </span><span style="color:navy">call    </span>SaveFCBInfo
<span style="color:maroon">DOSCODE:63F7                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:DI+SF_ENTRY.sf_flags],
<span style="color:maroon">DOSCODE:63F7                                         </span>; devid_device
<span style="color:maroon">DOSCODE:63FC                 </span><span style="color:navy">jnz     short </span>FCBNoDrive
<span style="color:maroon">DOSCODE:63FE                 </span><span style="color:navy">mov     al, [si]
</span><span style="color:maroon">DOSCODE:6400                 </span><span style="color:navy">call    </span>GETTHISDRV
<span style="color:maroon">DOSCODE:6403                 </span><span style="color:navy">inc     al
</span><span style="color:maroon">DOSCODE:6405                 </span><span style="color:navy">mov     [si], al
</span><span style="color:maroon">DOSCODE:6407
DOSCODE:6407 </span>FCBNoDrive<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6407                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], </span><span style="color:green">80h </span>; [SI+SYS_FCB.RECSIZ],128
<span style="color:maroon">DOSCODE:6407                                         </span>; default record size
<span style="color:maroon">DOSCODE:640C                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:640D                 </span><span style="color:navy">les     ax, es:[di+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">] </span>; [es:di+SF_ENTRY.sf_time]
<span style="color:maroon">DOSCODE:6411                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">16h</span><span style="color:navy">], ax    </span>; [si+SYS_FCB.FTIME]
<span style="color:maroon">DOSCODE:6414                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">14h</span><span style="color:navy">], es </span>; [si+SYS_FCB.FDATE]
<span style="color:maroon">DOSCODE:6417                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:6418                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:6419                 </span><span style="color:navy">les     ax, es:[di+</span><span style="color:#ff8000">11h</span><span style="color:navy">] </span>; [es:di+SF_ENTRY.sf_size]
<span style="color:maroon">DOSCODE:641D                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">10h</span><span style="color:navy">], ax    </span>; [si+SYS_FCB.FILSIZ]
<span style="color:maroon">DOSCODE:6420                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">12h</span><span style="color:navy">], es </span>; [si+SYS_FCB.FILSIZ+2]
<span style="color:maroon">DOSCODE:6423                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:6424                 </span><span style="color:navy">xor     ax, ax          </span>; 0
<span style="color:maroon">DOSCODE:6426                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">], ax    </span>; [si+SYS_FCB.EXTENT] ; beginning of file
<span style="color:maroon">DOSCODE:6429                 </span><span style="color:navy">les     di, ss:</span>SFTFCB   ; pointer to head of the list
<span style="color:maroon">DOSCODE:642E                 </span><span style="color:navy">mov     ah, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:si+SFT.SFCount]
<span style="color:maroon">DOSCODE:642E                                         </span>; number of SFTs to scan
<span style="color:maroon">DOSCODE:6432
DOSCODE:6432 </span>OpenScan<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6432                 </span><span style="color:navy">cmp     al, [si+</span><span style="color:#ff8000">18h</span><span style="color:navy">]    </span>; [SI+fcb_sfn]
<span style="color:maroon">DOSCODE:6435                 </span><span style="color:navy">jz      short </span>SkipCheck
<span style="color:maroon">DOSCODE:6437                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:6438                 </span><span style="color:navy">call    </span>CheckFCB        ; do they match
<span style="color:maroon">DOSCODE:643B                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:643C                 </span><span style="color:navy">jnb     short </span>OpenFound ; found a match!
<span style="color:maroon">DOSCODE:643E
DOSCODE:643E </span>SkipCheck<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:643E                 </span><span style="color:navy">inc     al              </span>; advance to next FCB
<span style="color:maroon">DOSCODE:6440                 </span><span style="color:navy">cmp     al, ah          </span>; table full?
<span style="color:maroon">DOSCODE:6442                 </span><span style="color:navy">jnz     short </span>OpenScan  ; no, go for more
<span style="color:maroon">DOSCODE:6444
DOSCODE:6444 </span>OpenDone<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6444                 </span><span style="color:navy">xor     al, al          </span>; return success
<span style="color:maroon">DOSCODE:6446                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:6447 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:6447
DOSCODE:6447 </span>OpenFound<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6447                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">18h</span><span style="color:navy">], al    </span>; [SI+fcb_sfn] ; assign with this
<span style="color:maroon">DOSCODE:644A                 </span><span style="color:navy">inc     word ptr es:[di] </span>; inc word [ES:DI+SF_ENTRY.sf_ref_count]
<span style="color:maroon">DOSCODE:644D                 </span><span style="color:navy">call    </span>set_sftfcb_entry
<span style="color:maroon">DOSCODE:6450                 </span><span style="color:navy">mov     ax, ss:</span>FCBLRU   ; update LRU counts
<span style="color:maroon">DOSCODE:6454                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">], ax </span>; [es:di+sf_LRU]
<span style="color:maroon">DOSCODE:6458                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:6459                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:645A                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:645A                 </span><span style="color:navy">les     di, </span>THISSFT
<span style="color:maroon">DOSCODE:645E                 </span><span style="color:navy">dec     word ptr es:[di] </span>; dec word [ES:DI+SF_ENTRY.sf_ref_count]
<span style="color:maroon">DOSCODE:645E                                         </span>; free the newly allocated SFT
<span style="color:maroon">DOSCODE:6461                 </span><span style="color:navy">call    </span>ShareEnd
<span style="color:maroon">DOSCODE:6464                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">43h </span><span style="color:gray">; &#039;C&#039;
</span><span style="color:maroon">DOSCODE:6466                 </span><span style="color:navy">call    </span>BlastSFT
<span style="color:maroon">DOSCODE:6469                 </span><span style="color:navy">jmp     short </span>OpenDone
<span style="color:maroon">DOSCODE:646B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:646B
DOSCODE:646B </span>$FCB_CREATE<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:646B                 </span><span style="color:navy">mov     cx, offset </span>DOS_CREATE
<span style="color:maroon">DOSCODE:646E                 </span><span style="color:navy">xor     ax, ax          </span>; attributes to create
<span style="color:maroon">DOSCODE:6470                 </span><span style="color:navy">call    </span>GetExtended     ; get extended FCB
<span style="color:maroon">DOSCODE:6473                 </span><span style="color:navy">jz      short </span>DoAccessJ ; not an extended FCB
<span style="color:maroon">DOSCODE:6475                 </span><span style="color:navy">mov     al, [si-</span><span style="color:green">1</span><span style="color:navy">]      </span>; get attributes
<span style="color:maroon">DOSCODE:6478
DOSCODE:6478 </span>DoAccessJ<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6478                 </span><span style="color:navy">jmp     </span>DoAccess
<span style="color:maroon">DOSCODE:647B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:647B
DOSCODE:647B </span>$DIR_SEARCH_FIRST<span style="color:navy">:                      </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:647B                 </span><span style="color:navy">mov     word ptr ss:</span>THISFCB<span style="color:navy">, dx
</span><span style="color:maroon">DOSCODE:6480                 </span><span style="color:navy">mov     word ptr ss:</span>THISFCB<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:6485                 </span><span style="color:navy">mov     si, dx
</span><span style="color:maroon">DOSCODE:6487                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:648A                 </span><span style="color:navy">jnz     short </span>NORMFCB4
<span style="color:maroon">DOSCODE:648C                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">7           </span>; point to drive select byte
<span style="color:maroon">DOSCODE:648F
DOSCODE:648F </span>NORMFCB4<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:648F                 </span><span style="color:navy">push    word ptr [si]   </span>; save original drive byte
<span style="color:maroon">DOSCODE:6491                 </span><span style="color:navy">mov     di, ss
</span><span style="color:maroon">DOSCODE:6493                 </span><span style="color:navy">mov     es, di
</span><span style="color:maroon">DOSCODE:6495                 </span>assume es:DOSCODE
<span style="color:maroon">DOSCODE:6495                 </span><span style="color:navy">mov     di, offset </span>OPENBUF
<span style="color:maroon">DOSCODE:6498                 </span><span style="color:navy">call    </span>TransFCB        ; convert the FCB, set SATTRIB EXTFCB
<span style="color:maroon">DOSCODE:649B                 </span><span style="color:navy">jnb     short </span>SearchIt
<span style="color:maroon">DOSCODE:649D                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:649E
DOSCODE:649E </span>dcf_errj<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:649E                 </span><span style="color:navy">jmp     </span>FCB_RET_ERR
<span style="color:maroon">DOSCODE:64A1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:64A1
DOSCODE:64A1 </span>SearchIt<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:64A1                 </span><span style="color:navy">mov     di, ss
</span><span style="color:maroon">DOSCODE:64A3                 </span><span style="color:navy">mov     ds, di
</span><span style="color:maroon">DOSCODE:64A5                 </span><span style="color:navy">les     di, </span>DMAADD
<span style="color:maroon">DOSCODE:64A9                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:64A9                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:64AA                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:64AB                 </span><span style="color:navy">mov     word ptr </span>DMAADD<span style="color:navy">, offset </span>SEARCHBUF
<span style="color:maroon">DOSCODE:64B1                 </span><span style="color:navy">mov     word ptr </span>DMAADD<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:64B5                 </span><span style="color:navy">or      </span>DOS34_FLAG<span style="color:navy">, </span><span style="color:green">400h </span>; SEARCH_FASTOPEN
<span style="color:maroon">DOSCODE:64BB                 </span><span style="color:navy">call    </span>DOS_SEARCH_FIRST
<span style="color:maroon">DOSCODE:64BE                 </span><span style="color:navy">pop     word ptr </span>DMAADD<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:maroon">DOSCODE:64C2                 </span><span style="color:navy">pop     word ptr </span>DMAADD
<span style="color:maroon">DOSCODE:64C6                 </span><span style="color:navy">jnb     short </span>SearchSet
<span style="color:maroon">DOSCODE:64C8                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:64C9                 </span><span style="color:navy">jmp     short </span>dcf_errj
<span style="color:maroon">DOSCODE:64CB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:64CB
DOSCODE:64CB </span>SearchSet<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:64CB                 </span><span style="color:navy">mov     si, offset </span>SEARCHBUF
<span style="color:maroon">DOSCODE:64CE                 </span><span style="color:navy">les     di, </span>THISFCB
<span style="color:maroon">DOSCODE:64D2                 </span><span style="color:navy">test    </span>EXTFCB<span style="color:navy">, </span><span style="color:green">0FFh
</span><span style="color:maroon">DOSCODE:64D7                 </span><span style="color:navy">jz      short </span>NORMFCB1
<span style="color:maroon">DOSCODE:64D9                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">7           </span>; point past the extension
<span style="color:maroon">DOSCODE:64DC
DOSCODE:64DC </span>NORMFCB1<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:64DC                 </span><span style="color:navy">pop     bx              </span>; get original drive byte
<span style="color:maroon">DOSCODE:64DD                 </span><span style="color:navy">or      bl, bl
</span><span style="color:maroon">DOSCODE:64DF                 </span><span style="color:navy">jnz     short </span>SearchDrv
<span style="color:maroon">DOSCODE:64E1                 </span><span style="color:navy">mov     bl, </span>CURDRV
<span style="color:maroon">DOSCODE:64E5                 </span><span style="color:navy">inc     bl
</span><span style="color:maroon">DOSCODE:64E7
DOSCODE:64E7 </span>SearchDrv<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:64E7                 </span><span style="color:navy">lodsb
</span><span style="color:maroon">DOSCODE:64E8                 </span><span style="color:navy">xchg    al, bl
</span><span style="color:maroon">DOSCODE:64EA                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">DOSCODE:64EB                 </span><span style="color:navy">mov     cx, </span><span style="color:green">10          </span>; 20/2
<span style="color:maroon">DOSCODE:64EE                 </span><span style="color:navy">rep movsw
</span><span style="color:maroon">DOSCODE:64F0                 </span><span style="color:navy">xchg    al, bl
</span><span style="color:maroon">DOSCODE:64F2                 </span><span style="color:navy">stosb
</span><span style="color:maroon">DOSCODE:64F3                 </span><span style="color:navy">les     di, </span>DMAADD
<span style="color:maroon">DOSCODE:64F7                 </span><span style="color:navy">test    </span>EXTFCB<span style="color:navy">, </span><span style="color:green">0FFh
</span><span style="color:maroon">DOSCODE:64FC                 </span><span style="color:navy">jz      short </span>NORMFCB2
<span style="color:maroon">DOSCODE:64FE                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:6500                 </span><span style="color:navy">stosb
</span><span style="color:maroon">DOSCODE:6501                 </span><span style="color:navy">inc     al
</span><span style="color:maroon">DOSCODE:6503                 </span><span style="color:navy">mov     ah, al
</span><span style="color:maroon">DOSCODE:6505                 </span><span style="color:navy">stosb
</span><span style="color:maroon">DOSCODE:6506                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:6507                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:6508                 </span><span style="color:navy">mov     al, </span>SATTRIB
<span style="color:maroon">DOSCODE:650B                 </span><span style="color:navy">stosb
</span><span style="color:maroon">DOSCODE:650C
DOSCODE:650C </span>NORMFCB2<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:650C                 </span><span style="color:navy">mov     al, bl          </span>; User Drive byte
<span style="color:maroon">DOSCODE:650E                 </span><span style="color:navy">stosb
</span><span style="color:maroon">DOSCODE:650F                 </span><span style="color:navy">mov     cx, </span><span style="color:green">16          </span>; 32 / 2 words of dir entry
<span style="color:maroon">DOSCODE:6512                 </span><span style="color:navy">rep movsw
</span><span style="color:maroon">DOSCODE:6514                 </span><span style="color:navy">jmp     </span>NO_OP           ; FCB_RET_OK
<span style="color:maroon">DOSCODE:6517 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:6517
DOSCODE:6517 </span>$DIR_SEARCH_NEXT<span style="color:navy">:                       </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:6517                 </span><span style="color:navy">mov     word ptr ss:</span>THISFCB<span style="color:navy">, dx
</span><span style="color:maroon">DOSCODE:651C                 </span><span style="color:navy">mov     word ptr ss:</span>THISFCB<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:6521                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:6523                 </span><span style="color:navy">mov     ss:</span>SATTRIB<span style="color:navy">, al
</span><span style="color:maroon">DOSCODE:6527                 </span><span style="color:navy">mov     ss:</span>EXTFCB<span style="color:navy">, al
</span><span style="color:maroon">DOSCODE:652B                 </span><span style="color:navy">mov     di, ss
</span><span style="color:maroon">DOSCODE:652D                 </span><span style="color:navy">mov     es, di
</span><span style="color:maroon">DOSCODE:652F                 </span>assume es:DOSCODE
<span style="color:maroon">DOSCODE:652F                 </span><span style="color:navy">mov     di, offset </span>SEARCHBUF
<span style="color:maroon">DOSCODE:6532                 </span><span style="color:navy">mov     si, dx
</span><span style="color:maroon">DOSCODE:6534                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:6537                 </span><span style="color:navy">jnz     short </span>NORMFCB6
<span style="color:maroon">DOSCODE:6539                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">6
</span><span style="color:maroon">DOSCODE:653C                 </span><span style="color:navy">lodsb
</span><span style="color:maroon">DOSCODE:653D                 </span><span style="color:navy">mov     ss:</span>SATTRIB<span style="color:navy">, al
</span><span style="color:maroon">DOSCODE:6541                 </span><span style="color:navy">dec     ss:</span>EXTFCB
<span style="color:maroon">DOSCODE:6546
DOSCODE:6546 </span>NORMFCB6<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6546                 </span><span style="color:navy">lodsb
</span><span style="color:maroon">DOSCODE:6547                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:6548                 </span><span style="color:navy">mov     al, [si+</span><span style="color:green">20</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:654B                 </span><span style="color:navy">stosb
</span><span style="color:maroon">DOSCODE:654C                 </span><span style="color:navy">mov     cx, </span><span style="color:green">10          </span>; 20/2
<span style="color:maroon">DOSCODE:654F                 </span><span style="color:navy">rep movsw
</span><span style="color:maroon">DOSCODE:6551                 </span><span style="color:navy">mov     di, ss
</span><span style="color:maroon">DOSCODE:6553                 </span><span style="color:navy">mov     ds, di
</span><span style="color:maroon">DOSCODE:6555                 </span><span style="color:navy">les     di, </span>DMAADD
<span style="color:maroon">DOSCODE:6559                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:6559                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:655A                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:655B                 </span><span style="color:navy">mov     di, offset </span>SEARCHBUF
<span style="color:maroon">DOSCODE:655E                 </span><span style="color:navy">mov     word ptr </span>DMAADD<span style="color:navy">, di
</span><span style="color:maroon">DOSCODE:6562                 </span><span style="color:navy">mov     word ptr </span>DMAADD<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:6566                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:maroon">DOSCODE:6568                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">DOSCODE:656A                 </span>assume es:DOSCODE
<span style="color:maroon">DOSCODE:656A                 </span><span style="color:navy">call    </span>DOS_SEARCH_NEXT
<span style="color:maroon">DOSCODE:656D                 </span><span style="color:navy">pop     word ptr </span>DMAADD<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:maroon">DOSCODE:6571                 </span><span style="color:navy">pop     word ptr </span>DMAADD
<span style="color:maroon">DOSCODE:6575                 </span><span style="color:navy">jb      short </span>SearchNoMore
<span style="color:maroon">DOSCODE:6577                 </span><span style="color:navy">jmp     </span>SearchSet
<span style="color:maroon">DOSCODE:657A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:657A
DOSCODE:657A </span>SearchNoMore<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:657A                 </span><span style="color:navy">les     di, </span>THISFCB
<span style="color:maroon">DOSCODE:657E                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:657E                 </span><span style="color:navy">test    </span>EXTFCB<span style="color:navy">, </span><span style="color:green">0FFh
</span><span style="color:maroon">DOSCODE:6583                 </span><span style="color:navy">jz      short </span>NORMFCB8
<span style="color:maroon">DOSCODE:6585                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">7           </span>; point past the extension
<span style="color:maroon">DOSCODE:6588
DOSCODE:6588 </span>NORMFCB8<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6588                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:6589                 </span><span style="color:navy">mov     es:[di], bl
</span><span style="color:maroon">DOSCODE:658C                 </span><span style="color:navy">jmp     </span>FCB_RET_ERR
<span style="color:maroon">DOSCODE:658F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:658F
DOSCODE:658F </span>FindError<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:658F                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3           </span>; error_path_not_found
<span style="color:maroon">DOSCODE:6591
DOSCODE:6591 </span>FF_errj<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6591                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR     ; error and map into one
<span style="color:maroon">DOSCODE:6594 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:6594
DOSCODE:6594 </span>$FIND_FIRST<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:6594                 </span><span style="color:navy">mov     si, dx
</span><span style="color:maroon">DOSCODE:6596                 </span><span style="color:navy">mov     ss:</span>SATTRIB<span style="color:navy">, cl  </span>; Search attribute
<span style="color:maroon">DOSCODE:659B                 </span><span style="color:navy">mov     di, offset </span>OPENBUF
<span style="color:maroon">DOSCODE:659E                 </span><span style="color:navy">call    </span>TransPathSet    ; convert the path
<span style="color:maroon">DOSCODE:65A1                 </span><span style="color:navy">jb      short </span>FindError
<span style="color:maroon">DOSCODE:65A3
DOSCODE:65A3 </span>Find_it<span style="color:navy">:
</span><span style="color:maroon">DOSCODE:65A3                 </span><span style="color:navy">mov     di, ss
</span><span style="color:maroon">DOSCODE:65A5                 </span><span style="color:navy">mov     ds, di
</span><span style="color:maroon">DOSCODE:65A7                 </span><span style="color:navy">les     di, </span>DMAADD
<span style="color:maroon">DOSCODE:65AB                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:65AC                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:65AD                 </span><span style="color:navy">mov     word ptr </span>DMAADD<span style="color:navy">, offset </span>SEARCHBUF
<span style="color:maroon">DOSCODE:65B3                 </span><span style="color:navy">mov     word ptr </span>DMAADD<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:65B7                 </span><span style="color:navy">or      </span>DOS34_FLAG<span style="color:navy">, </span><span style="color:green">400h </span>; SEARCH_FASTOPEN
<span style="color:maroon">DOSCODE:65BD                 </span><span style="color:navy">call    </span>DOS_SEARCH_FIRST ; Find it
<span style="color:maroon">DOSCODE:65C0                 </span><span style="color:navy">pop     word ptr </span>DMAADD<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:maroon">DOSCODE:65C4                 </span><span style="color:navy">pop     word ptr </span>DMAADD
<span style="color:maroon">DOSCODE:65C8                 </span><span style="color:navy">jb      short </span>FF_errj
<span style="color:maroon">DOSCODE:65CA
DOSCODE:65CA </span>FindSet<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:65CA                 </span><span style="color:navy">mov     si, offset </span>SEARCHBUF
<span style="color:maroon">DOSCODE:65CD                 </span><span style="color:navy">les     di, </span>DMAADD
<span style="color:maroon">DOSCODE:65D1                 </span><span style="color:navy">mov     cx, </span><span style="color:green">10
</span><span style="color:maroon">DOSCODE:65D4                 </span><span style="color:navy">rep movsw
</span><span style="color:maroon">DOSCODE:65D6                 </span><span style="color:navy">movsb
</span><span style="color:maroon">DOSCODE:65D7                 </span><span style="color:navy">push    si              </span>; Save pointer to start of entry
<span style="color:maroon">DOSCODE:65D8                 </span><span style="color:navy">mov     al, [si+</span><span style="color:green">11</span><span style="color:navy">]     </span>; [SI+dir_entry.dir_attr]
<span style="color:maroon">DOSCODE:65DB                 </span><span style="color:navy">stosb
</span><span style="color:maroon">DOSCODE:65DC                 </span><span style="color:navy">add     si, </span><span style="color:green">22          </span>; dir_entry.dir_time
<span style="color:maroon">DOSCODE:65DF                 </span><span style="color:navy">movsw                   </span>; dir_time
<span style="color:maroon">DOSCODE:65E0                 </span><span style="color:navy">movsw                   </span>; dir_date
<span style="color:maroon">DOSCODE:65E1                 </span><span style="color:navy">inc     si              </span>; Skip dir_first
<span style="color:maroon">DOSCODE:65E2                 </span><span style="color:navy">inc     si
</span><span style="color:maroon">DOSCODE:65E3                 </span><span style="color:navy">movsw                   </span>; dir_size (2 words)
<span style="color:maroon">DOSCODE:65E4                 </span><span style="color:navy">movsw
</span><span style="color:maroon">DOSCODE:65E5                 </span><span style="color:navy">pop     si              </span>; Point back to dir_name
<span style="color:maroon">DOSCODE:65E6                 </span><span style="color:navy">call    </span>PackName
<span style="color:maroon">DOSCODE:65E9                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:65EC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:65EC
DOSCODE:65EC </span>$FIND_NEXT<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:65EC                 </span><span style="color:navy">mov     di, ss
</span><span style="color:maroon">DOSCODE:65EE                 </span><span style="color:navy">mov     es, di
</span><span style="color:maroon">DOSCODE:65F0                 </span>assume es:DOSCODE
<span style="color:maroon">DOSCODE:65F0                 </span><span style="color:navy">mov     di, offset </span>SEARCHBUF
<span style="color:maroon">DOSCODE:65F3                 </span><span style="color:navy">lds     si, ss:</span>DMAADD
<span style="color:maroon">DOSCODE:65F8                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:65F8                 </span><span style="color:navy">mov     cx, </span><span style="color:green">10
</span><span style="color:maroon">DOSCODE:65FB                 </span><span style="color:navy">rep movsw
</span><span style="color:maroon">DOSCODE:65FD                 </span><span style="color:navy">movsb
</span><span style="color:maroon">DOSCODE:65FE                 </span><span style="color:navy">mov     di, ss
</span><span style="color:maroon">DOSCODE:6600                 </span><span style="color:navy">mov     ds, di
</span><span style="color:maroon">DOSCODE:6602                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:6602                 </span><span style="color:navy">les     di, </span>DMAADD
<span style="color:maroon">DOSCODE:6606                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:6606                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:6607                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:6608                 </span><span style="color:navy">mov     di, offset </span>SEARCHBUF
<span style="color:maroon">DOSCODE:660B                 </span><span style="color:navy">mov     word ptr </span>DMAADD<span style="color:navy">, di
</span><span style="color:maroon">DOSCODE:660F                 </span><span style="color:navy">mov     word ptr </span>DMAADD<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:6613                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:maroon">DOSCODE:6615                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">DOSCODE:6617                 </span>assume es:DOSCODE
<span style="color:maroon">DOSCODE:6617                 </span><span style="color:navy">call    </span>DOS_SEARCH_NEXT ; Find it
<span style="color:maroon">DOSCODE:661A                 </span><span style="color:navy">pop     word ptr </span>DMAADD<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:maroon">DOSCODE:661E                 </span><span style="color:navy">pop     word ptr </span>DMAADD
<span style="color:maroon">DOSCODE:6622                 </span><span style="color:navy">jnb     short </span>FindSet   ; No error, set info
<span style="color:maroon">DOSCODE:6624                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:black">DOSCODE:6627
DOSCODE:6627 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:6627
DOSCODE:6627
DOSCODE:6627 </span>PackName        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6627                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4           </span>; Convert file names from FCB to ASCIZ format
<span style="color:black">DOSCODE:662A                 </span><span style="color:navy">rep movsw
</span><span style="color:black">DOSCODE:662C
DOSCODE:662C </span><span style="color:gray">main_kill_tail</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:662C                 </span><span style="color:navy">cmp     byte ptr es:[di-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">DOSCODE:6631                 </span><span style="color:navy">jnz     short </span><span style="color:gray">find_check_dot
</span><span style="color:black">DOSCODE:6633                 </span><span style="color:navy">dec     di              </span>; Back up over trailing space
<span style="color:black">DOSCODE:6634                 </span><span style="color:navy">inc     cx
</span><span style="color:black">DOSCODE:6635                 </span><span style="color:navy">cmp     cx, </span><span style="color:#ff8000">8
</span><span style="color:black">DOSCODE:6638                 </span><span style="color:navy">jb      short </span><span style="color:gray">main_kill_tail
</span><span style="color:black">DOSCODE:663A
DOSCODE:663A </span><span style="color:gray">find_check_dot</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:663A                 </span><span style="color:navy">cmp     word ptr [si], </span><span style="color:#ff8000">2020h
</span><span style="color:black">DOSCODE:663E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">got_ext   </span>; Some chars in extension
<span style="color:black">DOSCODE:6640                 </span><span style="color:navy">cmp     byte ptr [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">DOSCODE:6644                 </span><span style="color:navy">jz      short </span><span style="color:gray">find_done </span>; No extension
<span style="color:black">DOSCODE:6646
DOSCODE:6646 </span><span style="color:gray">got_ext</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6646                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2Eh </span><span style="color:gray">; &#039;.&#039;
</span><span style="color:black">DOSCODE:6648                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:6649                 </span><span style="color:navy">movsw
</span><span style="color:black">DOSCODE:664A                 </span><span style="color:navy">movsb
</span><span style="color:black">DOSCODE:664B
DOSCODE:664B </span><span style="color:gray">ext_kill_tail</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:664B                 </span><span style="color:navy">cmp     byte ptr es:[di-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">DOSCODE:6650                 </span><span style="color:navy">jnz     short </span><span style="color:gray">find_done
</span><span style="color:black">DOSCODE:6652                 </span><span style="color:navy">dec     di              </span>; Back up over trailing space
<span style="color:black">DOSCODE:6653                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ext_kill_tail
</span><span style="color:black">DOSCODE:6655 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6655
DOSCODE:6655 </span><span style="color:gray">find_done</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6655                 </span><span style="color:navy">xor     ax, ax          </span>; NUL terminate
<span style="color:black">DOSCODE:6657                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:6658                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6658 </span>PackName        <span style="color:black">endp
DOSCODE:6658
</span><span style="color:maroon">DOSCODE:6659 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:6659
DOSCODE:6659 </span>GET_FAST_SEARCH<span style="color:navy">:                        </span>;
<span style="color:maroon">DOSCODE:6659                 </span><span style="color:navy">or      ss:</span>DOS34_FLAG<span style="color:navy">, </span><span style="color:green">400h </span>; SEARCH_FASTOPEN
<span style="color:maroon">DOSCODE:6660                 </span><span style="color:navy">call    </span>DOS_SEARCH_FIRST
<span style="color:maroon">DOSCODE:6663                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6664
DOSCODE:6664 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:6664
DOSCODE:6664
DOSCODE:6664 </span>$CURRENT_DIR    <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:6664                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:6667                 </span><span style="color:navy">mov     al, dl          </span>; get drive number (0=def, 1=A)
<span style="color:black">DOSCODE:6669                 </span><span style="color:navy">call    </span>GetVisDrv
<span style="color:black">DOSCODE:666C                 </span><span style="color:navy">jnb     short </span>CurrentValidate
<span style="color:black">DOSCODE:666E
DOSCODE:666E </span>CurdirErr<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:666E                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:6671                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:6672                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:6677                 </span>assume ds:nothing
<span style="color:black">DOSCODE:6677                 </span><span style="color:navy">mov     al, ds:</span>DrvErr
<span style="color:black">DOSCODE:667A                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:667B
DOSCODE:667B </span>curdir_errj<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:667B                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:black">DOSCODE:667E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:667E
DOSCODE:667E </span>CurrentValidate<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:667E                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:667F                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:6680                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:6685                 </span><span style="color:navy">mov     ds:</span>NoSetDir<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:668A
DOSCODE:668A </span>DoCheck<span style="color:navy">:
</span><span style="color:black">DOSCODE:668A                 </span><span style="color:navy">mov     di, offset </span>OPENBUF
<span style="color:black">DOSCODE:668D                 </span><span style="color:navy">call    </span>ValidateCDS
<span style="color:black">DOSCODE:6690                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:6691                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:6692                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:6693                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:6694                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:6695                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:6696                 </span>assume es:nothing
<span style="color:black">DOSCODE:6696                 </span><span style="color:navy">jb      short </span>CurdirErr
<span style="color:black">DOSCODE:6698                 </span><span style="color:navy">add     si, [si+</span><span style="color:#ff8000">4Fh</span><span style="color:navy">]    </span>; [SI+curdir.end]
<span style="color:black">DOSCODE:669B                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">5Ch </span><span style="color:gray">; &#039;\&#039; </span>; root or subdirs present?
<span style="color:black">DOSCODE:669E                 </span><span style="color:navy">jnz     short </span>CurrentCopy
<span style="color:black">DOSCODE:66A0                 </span><span style="color:navy">inc     si
</span><span style="color:black">DOSCODE:66A1
DOSCODE:66A1 </span>CurrentCopy<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:66A1                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:66A2                 </span><span style="color:navy">lodsb                   </span>; get char
<span style="color:black">DOSCODE:66A3                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:66A5                 </span><span style="color:navy">jz      short </span>FOK
<span style="color:black">DOSCODE:66A7                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5
</span><span style="color:black">DOSCODE:66A9                 </span><span style="color:navy">jz      short </span>FCHANGE
<span style="color:black">DOSCODE:66AB                 </span><span style="color:navy">jmp     short </span>FFF
<span style="color:black">DOSCODE:66AD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:66AD
DOSCODE:66AD </span>FCPYNEXT<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:66AD                 </span><span style="color:navy">lodsb                   </span>; get char
<span style="color:black">DOSCODE:66AE
DOSCODE:66AE </span>FFF<span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:66AE                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Ch </span><span style="color:gray">; &#039;\&#039;   </span>; beginning of directory ?
<span style="color:black">DOSCODE:66B0                 </span><span style="color:navy">jnz     short </span>FOK       ; no
<span style="color:black">DOSCODE:66B2                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:66B3                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:66B4                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5           </span>; 1st char of dir is 05?
<span style="color:black">DOSCODE:66B6                 </span><span style="color:navy">jnz     short </span>FOK       ; no
<span style="color:black">DOSCODE:66B8
DOSCODE:66B8 </span>FCHANGE<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:66B8                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0E5h        </span>; make it E5
<span style="color:black">DOSCODE:66BA
DOSCODE:66BA </span>FOK<span style="color:navy">:                                    </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:66BA                 </span><span style="color:navy">stosb                   </span>; put into user&#039;s buffer
<span style="color:black">DOSCODE:66BB                 </span><span style="color:navy">or      al, al          </span>; final char
<span style="color:black">DOSCODE:66BD                 </span><span style="color:navy">jnz     short </span>FCPYNEXT  ; no
<span style="color:black">DOSCODE:66BF                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:66C0                 </span><span style="color:navy">xor     al, al          </span>; MZ 19 Jan 84
<span style="color:black">DOSCODE:66C2                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:66C5                 </span><span style="color:navy">jmp     </span>SYS_RET_OK      ; no more, bye!
<span style="color:black">DOSCODE:66C5 </span>$CURRENT_DIR    <span style="color:black">endp
DOSCODE:66C5
</span><span style="color:maroon">DOSCODE:66C8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:66C8
DOSCODE:66C8 </span>$RMDIR<span style="color:navy">:                                 </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:66C8                 </span><span style="color:navy">push    dx              </span>; Save ptr to name
<span style="color:maroon">DOSCODE:66C9                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:66CA                 </span><span style="color:navy">mov     si, dx
</span><span style="color:maroon">DOSCODE:66CC                 </span><span style="color:navy">mov     di, offset </span>OPENBUF
<span style="color:maroon">DOSCODE:66CF                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:66D0                 </span><span style="color:navy">call    </span>TransPathNoSet  ; Translate the name
<span style="color:maroon">DOSCODE:66D3                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:66D4                 </span><span style="color:navy">jnb     short </span>rmlset
<span style="color:maroon">DOSCODE:66D6                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:66D7                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:66D8                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3           </span>; error_path_not_found
<span style="color:maroon">DOSCODE:66DA
DOSCODE:66DA </span>rmdir_chdir_errj<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:66DA                 </span><span style="color:navy">jmp     short </span>curdir_errj
<span style="color:maroon">DOSCODE:66DC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:66DC
DOSCODE:66DC </span>rmlset<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:66DC                 </span><span style="color:navy">cmp     ss:</span>CMETA<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:66E2                 </span><span style="color:navy">jnz     short </span>rmerr
<span style="color:maroon">DOSCODE:66E4                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:66E5                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:66E6                 </span>assume es:DOSCODE
<span style="color:maroon">DOSCODE:66E6                 </span><span style="color:navy">xor     al, al          </span>; al = 0 , ie drive a:
<span style="color:maroon">DOSCODE:66E8
DOSCODE:66E8 </span>rmloop<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:66E8                 </span><span style="color:navy">call    </span>GetCDSFromDrv   ; Get curdir for drive in al
<span style="color:maroon">DOSCODE:66EB                 </span><span style="color:navy">jb      short </span>rmcont    ; If error, exit loop &amp; cont normally
<span style="color:maroon">DOSCODE:66ED                 </span><span style="color:navy">test    word ptr [si+</span><span style="color:#ff8000">43h</span><span style="color:navy">], </span><span style="color:green">4000h </span>; [SI+curdir.flags],curdir_inuse
<span style="color:maroon">DOSCODE:66F2                 </span><span style="color:navy">jz      short </span>rmdir_nxt
<span style="color:maroon">DOSCODE:66F4                 </span><span style="color:navy">call    </span>StrCmp          ; Are the 2 paths the same?
<span style="color:maroon">DOSCODE:66F7                 </span><span style="color:navy">jz      short </span>rmerr     ; Yes, report error.
<span style="color:maroon">DOSCODE:66F9
DOSCODE:66F9 </span>rmdir_nxt<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:66F9                 </span><span style="color:navy">inc     al              </span>; Go check next drive.
<span style="color:maroon">DOSCODE:66FB                 </span><span style="color:navy">jmp     short </span>rmloop
<span style="color:maroon">DOSCODE:66FD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:66FD
DOSCODE:66FD </span>rmerr<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:66FD                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:66FE                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:66FF                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">10h         </span>; error_current_directory
<span style="color:maroon">DOSCODE:6701
DOSCODE:6701 </span>rmdir_chdir_errj2<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6701                 </span><span style="color:navy">jmp     short </span>rmdir_chdir_errj
<span style="color:maroon">DOSCODE:6703 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:6703
DOSCODE:6703 </span>rmcont<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6703                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:6704                 </span><span style="color:navy">pop     dx              </span>; Restore ptr the name
<span style="color:maroon">DOSCODE:6705                 </span><span style="color:navy">mov     si, offset </span>DOS_RMDIR
<span style="color:maroon">DOSCODE:6708                 </span><span style="color:navy">call    </span>TestNet
<span style="color:maroon">DOSCODE:670B                 </span><span style="color:navy">mov     di, </span><span style="color:green">67          </span>; DIRSTRLEN
<span style="color:maroon">DOSCODE:670E                 </span><span style="color:navy">jnb     short </span>rmcont2   ; local directory
<span style="color:maroon">DOSCODE:6710                 </span><span style="color:navy">mov     di, </span><span style="color:green">128
</span><span style="color:maroon">DOSCODE:6713
DOSCODE:6713 </span>rmcont2<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6713                 </span><span style="color:navy">mov     ss:</span>PATHNAMELEN<span style="color:navy">, di
</span><span style="color:maroon">DOSCODE:6718                 </span><span style="color:navy">jmp     </span>DoDirCall
<span style="color:maroon">DOSCODE:671B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:671B
DOSCODE:671B </span>$CHDIR<span style="color:navy">:                                 </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:671B                 </span><span style="color:navy">mov     ss:</span>PATHNAMELEN<span style="color:navy">, </span><span style="color:green">67 </span>; DIRSTRLEN
<span style="color:maroon">DOSCODE:6722                 </span><span style="color:navy">mov     di, offset </span>OPENBUF
<span style="color:maroon">DOSCODE:6725                 </span><span style="color:navy">mov     si, dx
</span><span style="color:maroon">DOSCODE:6727                 </span><span style="color:navy">call    </span>TransPath       ; go munge the path and get real CDS
<span style="color:maroon">DOSCODE:672A                 </span><span style="color:navy">jnb     short </span>ChDirCrack ; no errors, try path
<span style="color:maroon">DOSCODE:672C
DOSCODE:672C </span>ChDirErrP<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:672C                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3           </span>; error_path_not_found
<span style="color:maroon">DOSCODE:672E
DOSCODE:672E </span>chdir_errj<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:672E                 </span><span style="color:navy">jmp     short </span>rmdir_chdir_errj2
<span style="color:maroon">DOSCODE:6730 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:6730
DOSCODE:6730 </span>ChDirCrack<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6730                 </span><span style="color:navy">cmp     ds:</span>CMETA<span style="color:navy">, </span><span style="color:#ff8000">0FFh  </span>; No meta chars allowed.
<span style="color:maroon">DOSCODE:6735                 </span><span style="color:navy">jnz     short </span>ChDirErrP
<span style="color:maroon">DOSCODE:6737                 </span><span style="color:navy">les     di, ds:</span>THISCDS
<span style="color:maroon">DOSCODE:673B                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:673B                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh      </span>; if (ThisCDS == NULL)
<span style="color:maroon">DOSCODE:673E                 </span><span style="color:navy">jz      short </span>ChDirErrP ;     error ();
<span style="color:maroon">DOSCODE:6740                 </span><span style="color:navy">call    </span>DOS_CHDIR       ; Find out if the directory exists.
<span style="color:maroon">DOSCODE:6743                 </span><span style="color:navy">jb      short </span>chdir_errj
<span style="color:maroon">DOSCODE:6745                 </span><span style="color:navy">les     di, ds:</span>THISCDS  ; Get back CDS to see if a join as seen.
<span style="color:maroon">DOSCODE:6749                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">43h</span><span style="color:navy">], </span><span style="color:green">2000h </span>;
<span style="color:maroon">DOSCODE:6749                                         </span>; [ES:DI+curdir.flags],curdir_splice
<span style="color:maroon">DOSCODE:674F                 </span><span style="color:navy">mov     dx, ds:</span>DIRSTART_HW
<span style="color:maroon">DOSCODE:6753                 </span><span style="color:navy">jz      short </span>GotCDS
<span style="color:maroon">DOSCODE:6755                 </span><span style="color:navy">push    es              </span>; The CDS was joined.
<span style="color:maroon">DOSCODE:6756                 </span><span style="color:navy">push    di              </span>; Let&#039;s go back and grab the logical CDS.
<span style="color:maroon">DOSCODE:6757                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:6758                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:6759                 </span><span style="color:navy">call    </span>Get_User_Stack  ; get original text
<span style="color:maroon">DOSCODE:675C                 </span><span style="color:navy">mov     di, [si+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [SI+user_env.user_DX]
<span style="color:maroon">DOSCODE:675F                 </span><span style="color:navy">mov     ds, word ptr [si+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">] </span>; [SI+user_env.user_DS]
<span style="color:maroon">DOSCODE:6762                 </span><span style="color:navy">mov     si, offset </span>OPENBUF
<span style="color:maroon">DOSCODE:6765                 </span><span style="color:navy">xchg    si, di
</span><span style="color:maroon">DOSCODE:6767                 </span><span style="color:navy">xor     al, al          </span>; do no splicing
<span style="color:maroon">DOSCODE:6769                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:676A                 </span><span style="color:navy">call    </span>TransPathNoSet  ; Munge path
<span style="color:maroon">DOSCODE:676D                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:676E                 </span><span style="color:navy">les     di, ds:</span>THISCDS  ; get new CDS
<span style="color:maroon">DOSCODE:6772                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">49h</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; [es:di+curdir.ID],-1
<span style="color:maroon">DOSCODE:6778                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">4Bh</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; [es:di+curdir.ID+2],-1
<span style="color:maroon">DOSCODE:677E                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:677F                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:6780                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:6781                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:6782
DOSCODE:6782 </span>GotCDS<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6782                 </span><span style="color:navy">call    </span>Check_PathLen
<span style="color:maroon">DOSCODE:6785                 </span><span style="color:navy">ja      short </span>ChDirErrP
<span style="color:maroon">DOSCODE:6787                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">43h</span><span style="color:navy">], </span><span style="color:green">8000h </span>;
<span style="color:maroon">DOSCODE:6787                                         </span>; [ES:DI+curdir.flags],curdir_isnet
<span style="color:maroon">DOSCODE:678D                 </span><span style="color:navy">jnz     short </span>SkipRecency
<span style="color:maroon">DOSCODE:678F                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">43h</span><span style="color:navy">], </span><span style="color:green">2000h </span>; for Join and Subst
<span style="color:maroon">DOSCODE:678F                                         </span>; [ES:DI+curdir.flags],curdir_splice
<span style="color:maroon">DOSCODE:6795                 </span><span style="color:navy">jz      short </span>setdirclus
<span style="color:maroon">DOSCODE:6797                 </span><span style="color:navy">mov     cx, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:maroon">DOSCODE:679A                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:maroon">DOSCODE:679C
DOSCODE:679C </span>setdirclus<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:679C                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">49h</span><span style="color:navy">], cx </span>; [ES:DI+curdir.ID]
<span style="color:maroon">DOSCODE:67A0                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4Bh</span><span style="color:navy">], dx </span>; [ES:DI+curdir.ID+2]
<span style="color:maroon">DOSCODE:67A4                 </span><span style="color:navy">les     di, ds:</span>THISCDS  ; get logical CDS
<span style="color:maroon">DOSCODE:67A8
DOSCODE:67A8 </span>SkipRecency<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:67A8                 </span><span style="color:navy">call    </span>FStrCpy
<span style="color:maroon">DOSCODE:67AB                 </span><span style="color:navy">xor     al, al
</span><span style="color:maroon">DOSCODE:67AD
DOSCODE:67AD </span>mkdir_ok<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:67AD                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:67B0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:67B0
DOSCODE:67B0 </span>$MKDIR<span style="color:navy">:                                 </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:67B0                 </span><span style="color:navy">mov     ss:</span>PATHNAMELEN<span style="color:navy">, </span><span style="color:green">67 </span>; DIRSTRLEN
<span style="color:maroon">DOSCODE:67B7
DOSCODE:67B7 </span>mkdir_x<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:67B7                 </span><span style="color:navy">mov     si, offset </span>DOS_MKDIR
<span style="color:maroon">DOSCODE:67BA
DOSCODE:67BA </span>DoDirCall<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:67BA                 </span><span style="color:navy">mov     di, offset </span>OPENBUF
<span style="color:maroon">DOSCODE:67BD                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:67BE                 </span><span style="color:navy">mov     si, dx          </span>; get source
<span style="color:maroon">DOSCODE:67C0                 </span><span style="color:navy">call    </span>TransPath       ; go munge the path
<span style="color:maroon">DOSCODE:67C3                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:67C4                 </span><span style="color:navy">jnb     short </span>MkDirCrack ; no errors, try path
<span style="color:maroon">DOSCODE:67C6
DOSCODE:67C6 </span>MkErrP<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:67C6                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3           </span>; error_path_not_found
<span style="color:maroon">DOSCODE:67C8
DOSCODE:67C8 </span>MkErr<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:67C8                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:maroon">DOSCODE:67CB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:67CB
DOSCODE:67CB </span>MkDirCrack<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:67CB                 </span><span style="color:navy">cmp     ss:</span>CMETA<span style="color:navy">, </span><span style="color:#ff8000">0FFh  </span>; -1
<span style="color:maroon">DOSCODE:67D1                 </span><span style="color:navy">jnz     short </span>MkErrP
<span style="color:maroon">DOSCODE:67D3                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:67D4                 </span><span style="color:navy">call    </span>Check_PathLen   ; check path len &gt; [PATNAMELEN]
<span style="color:maroon">DOSCODE:67D4                                         </span>; &gt; 67 or 128
<span style="color:maroon">DOSCODE:67D7                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:67D8                 </span><span style="color:navy">jbe     short </span>pathok
<span style="color:maroon">DOSCODE:67DA                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">5           </span>; error_access_denied
<span style="color:maroon">DOSCODE:67DC                 </span><span style="color:navy">jmp     short </span>MkErr
<span style="color:maroon">DOSCODE:67DE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:67DE
DOSCODE:67DE </span>pathok<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:67DE                 </span><span style="color:navy">call    si              </span>; go get file
<span style="color:maroon">DOSCODE:67E0                 </span><span style="color:navy">jb      short </span>MkErr     ; error
<span style="color:maroon">DOSCODE:67E2                 </span><span style="color:navy">jmp     short </span>mkdir_ok  ; ok
<span style="color:black">DOSCODE:67E4
DOSCODE:67E4 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:67E4
DOSCODE:67E4
DOSCODE:67E4 </span>Check_PathLen   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:67E4                 </span><span style="color:navy">mov     si, ss:</span>WFP_START
<span style="color:black">DOSCODE:67E4 </span>Check_PathLen   <span style="color:black">endp
DOSCODE:67E4
DOSCODE:67E9
DOSCODE:67E9 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:67E9
DOSCODE:67E9
DOSCODE:67E9 </span>Check_PathLen2  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:67E9                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:67EA                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:67EB                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:67EB                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:67EC                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:67ED                 </span><span style="color:navy">call    </span>DStrLen
<span style="color:black">DOSCODE:67F0                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:67F1                 </span><span style="color:navy">cmp     cx, </span>PATHNAMELEN
<span style="color:black">DOSCODE:67F5                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:67F6                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:67F6 </span>Check_PathLen2  <span style="color:black">endp
DOSCODE:67F6
DOSCODE:67F6 </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSCODE:67F7 </span>IOCTLJMPTABLE   <span style="color:navy">dw offset </span>ioctl_getset_data <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:67F9                 </span><span style="color:navy">dw offset </span>ioctl_getset_data ; 1
<span style="color:gray">DOSCODE:67FB                 </span><span style="color:navy">dw offset </span>ioctl_control_string ; 2
<span style="color:gray">DOSCODE:67FD                 </span><span style="color:navy">dw offset </span>ioctl_control_string
<span style="color:gray">DOSCODE:67FF                 </span><span style="color:navy">dw offset </span>ioctl_get_dev
<span style="color:gray">DOSCODE:6801                 </span><span style="color:navy">dw offset </span>ioctl_get_dev ; 5
<span style="color:gray">DOSCODE:6803                 </span><span style="color:navy">dw offset </span>ioctl_status
<span style="color:gray">DOSCODE:6805                 </span><span style="color:navy">dw offset </span>ioctl_status
<span style="color:gray">DOSCODE:6807                 </span><span style="color:navy">dw offset </span>ioctl_rem_media
<span style="color:gray">DOSCODE:6809                 </span><span style="color:navy">dw offset </span>ioctl_drive_attr ; 9
<span style="color:gray">DOSCODE:680B                 </span><span style="color:navy">dw offset </span>ioctl_handle_redir
<span style="color:gray">DOSCODE:680D                 </span><span style="color:navy">dw offset </span>Set_Retry_Parameters
<span style="color:gray">DOSCODE:680F                 </span><span style="color:navy">dw offset </span>GENERICIOCTLHANDLE ; 0Ch
<span style="color:gray">DOSCODE:6811                 </span><span style="color:navy">dw offset </span>GENERICIOCTL  ; 0Dh
<span style="color:gray">DOSCODE:6813                 </span><span style="color:navy">dw offset </span>ioctl_drive_owner
<span style="color:gray">DOSCODE:6815                 </span><span style="color:navy">dw offset </span>ioctl_drive_owner
<span style="color:gray">DOSCODE:6817                 </span><span style="color:navy">dw offset </span>GENERICIOCTLHANDLE ; query_handle_support
<span style="color:gray">DOSCODE:6819                 </span><span style="color:navy">dw offset </span>GENERICIOCTL  ; query_device_support ; 11h
<span style="color:black">DOSCODE:681B
DOSCODE:681B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:681B
DOSCODE:681B
DOSCODE:681B </span>$IOCTL          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:681B
DOSCODE:681B </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:450E SIZE 0000001C BYTES
</span><span style="color:black">DOSCODE:681B </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:6AC7 SIZE 0000004A BYTES
</span><span style="color:black">DOSCODE:681B
DOSCODE:681B                 </span><span style="color:navy">mov     si, ds          </span>; Stash DS for calls 2,3,4 and 5
<span style="color:black">DOSCODE:681D                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:681E                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:681F                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">11h         </span>; al must be between 0 &amp; 11h
<span style="color:black">DOSCODE:6821                 </span><span style="color:navy">ja      short </span><span style="color:gray">ioctl_bad_funj2
</span><span style="color:black">DOSCODE:6823                 </span><span style="color:navy">mov     di, ax
</span><span style="color:black">DOSCODE:6825                 </span><span style="color:navy">and     di, </span><span style="color:green">0FFh
</span><span style="color:black">DOSCODE:6829                 </span><span style="color:navy">add     di, di
</span><span style="color:black">DOSCODE:682B                 </span><span style="color:navy">jmp     cs:</span>IOCTLJMPTABLE<span style="color:navy">[di]
</span><span style="color:black">DOSCODE:6830 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6830
DOSCODE:6830 </span><span style="color:gray">ioctl_bad_funj2</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6830                 </span><span style="color:navy">jmp     </span><span style="color:gray">ioctl_bad_fun
</span><span style="color:black">DOSCODE:6833 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6833
DOSCODE:6833 </span>ioctl_getset_data<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6833                 </span><span style="color:navy">call    </span>SFFromHandle
<span style="color:black">DOSCODE:6836                 </span><span style="color:navy">jnb     short </span><span style="color:gray">ioctl_check_permissions </span>; have valid handle
<span style="color:black">DOSCODE:6838
DOSCODE:6838 </span><span style="color:gray">ioctl_bad_handle</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6838                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">6           </span>; error_invalid_handle
<span style="color:black">DOSCODE:683A
DOSCODE:683A </span><span style="color:gray">ioctl_error</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:683A                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:black">DOSCODE:683D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:683D
DOSCODE:683D </span><span style="color:gray">ioctl_check_permissions</span><span style="color:navy">:                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:683D                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:683F                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_flags]
<span style="color:black">DOSCODE:6843                 </span><span style="color:navy">jz      short </span><span style="color:gray">ioctl_read
</span><span style="color:black">DOSCODE:6845                 </span><span style="color:navy">or      dh, dh
</span><span style="color:black">DOSCODE:6847                 </span><span style="color:navy">jz      short </span><span style="color:gray">ioctl_check_device
</span><span style="color:black">DOSCODE:6849                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Dh         </span>; error_invalid_data ; no DH &lt;&gt; 0
<span style="color:black">DOSCODE:684B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ioctl_error
</span><span style="color:black">DOSCODE:684D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:684D
DOSCODE:684D </span><span style="color:gray">ioctl_check_device</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:684D                 </span><span style="color:navy">test    al, </span><span style="color:green">80h         </span>; devid_device  ; can I set this handle?
<span style="color:black">DOSCODE:684F                 </span><span style="color:navy">jz      short </span><span style="color:gray">ioctl_bad_funj2
</span><span style="color:black">DOSCODE:6851                 </span><span style="color:navy">or      dl, </span><span style="color:green">80h         </span>; devid_device
<span style="color:black">DOSCODE:6851                                         </span>; Make sure user doesn&#039;t
<span style="color:black">DOSCODE:6851                                         </span>; turn off the device bit!!
<span style="color:black">DOSCODE:6854                 </span><span style="color:navy">call    </span>set_exerr_locus_ser
<span style="color:black">DOSCODE:6857                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], dl   </span>; [ES:DI+SF_ENTRY.sf_flags]
<span style="color:black">DOSCODE:685B
DOSCODE:685B </span><span style="color:gray">ioctl_ok</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:685B                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:black">DOSCODE:685E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:685E
DOSCODE:685E </span><span style="color:gray">ioctl_read</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:685E                 </span><span style="color:navy">call    </span>set_exerr_locus_disk
<span style="color:black">DOSCODE:6861                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:6863                 </span><span style="color:navy">test    al, </span><span style="color:green">80h         </span>; devid_device
<span style="color:black">DOSCODE:6865                 </span><span style="color:navy">jz      short </span><span style="color:gray">ioctl_no_high
</span><span style="color:black">DOSCODE:6867                 </span><span style="color:navy">call    </span>set_exerr_locus_ser
<span style="color:black">DOSCODE:686A                 </span><span style="color:navy">les     di, es:[di+</span><span style="color:#ff8000">7</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_devptr]
<span style="color:black">DOSCODE:686A                                         </span>; Get device pointer
<span style="color:black">DOSCODE:686E                 </span><span style="color:navy">mov     ah, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [ES:DI+SYSDEV.ATT+1] ; Get high byte
<span style="color:black">DOSCODE:6872
DOSCODE:6872 </span><span style="color:gray">ioctl_no_high</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6872                 </span><span style="color:navy">mov     dx, ax
</span><span style="color:black">DOSCODE:6874                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:black">DOSCODE:6877                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], dx      </span>; [SI+user_env.user_DX]
<span style="color:black">DOSCODE:687A
DOSCODE:687A </span><span style="color:gray">ioctl_ok_j</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:687A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ioctl_ok
</span><span style="color:black">DOSCODE:687C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:687C
DOSCODE:687C </span>ioctl_control_string<span style="color:navy">:                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:687C                 </span><span style="color:navy">call    </span>SFFromHandle
<span style="color:black">DOSCODE:687F                 </span><span style="color:navy">jb      short </span><span style="color:gray">ioctl_bad_handle
</span><span style="color:black">DOSCODE:6881                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:DI+SF_ENTRY.sf_flags],
<span style="color:black">DOSCODE:6881                                         </span>; devid_device
<span style="color:black">DOSCODE:6886
DOSCODE:6886 </span><span style="color:gray">ioctl_bad_funj</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6886                 </span><span style="color:navy">jz      short </span><span style="color:gray">ioctl_bad_funj2
</span><span style="color:black">DOSCODE:6888                 </span><span style="color:navy">call    </span>set_exerr_locus_ser
<span style="color:black">DOSCODE:688B                 </span><span style="color:navy">les     di, es:[di+</span><span style="color:#ff8000">7</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_devptr]
<span style="color:black">DOSCODE:688F                 </span><span style="color:navy">xor     bl, bl
</span><span style="color:black">DOSCODE:6891                 </span><span style="color:navy">jmp     </span><span style="color:gray">ioctl_do_string
</span><span style="color:black">DOSCODE:6894 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6894
DOSCODE:6894 </span>ioctl_status<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6894                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:6896                 </span><span style="color:navy">sub     al, </span><span style="color:#ff8000">6           </span>; 6=0,7=1
<span style="color:black">DOSCODE:6898                 </span><span style="color:navy">jz      short </span><span style="color:gray">ioctl_get_status
</span><span style="color:black">DOSCODE:689A                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:689C
DOSCODE:689C </span><span style="color:gray">ioctl_get_status</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:689C                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:689D                 </span><span style="color:navy">call    </span>GET_IO_SFT
<span style="color:black">DOSCODE:68A0                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:68A1                 </span><span style="color:navy">jnb     short </span><span style="color:gray">DO_IOFUNC
</span><span style="color:black">DOSCODE:68A3
DOSCODE:68A3 </span><span style="color:gray">ioctl_bad_handle_j</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:68A3                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ioctl_bad_handle </span>; invalid SFT
<span style="color:black">DOSCODE:68A5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:68A5
DOSCODE:68A5 </span><span style="color:gray">DO_IOFUNC</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:68A5                 </span><span style="color:navy">call    </span>IOFUNC
<span style="color:black">DOSCODE:68A8                 </span><span style="color:navy">mov     ah, al
</span><span style="color:black">DOSCODE:68AA                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:68AC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ioctl_status_ret
</span><span style="color:black">DOSCODE:68AE                 </span><span style="color:navy">inc     al
</span><span style="color:black">DOSCODE:68B0
DOSCODE:68B0 </span><span style="color:gray">ioctl_status_ret</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:68B0                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ioctl_ok_j
</span><span style="color:black">DOSCODE:68B2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:68B2
DOSCODE:68B2 </span>Set_Retry_Parameters<span style="color:navy">:                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:68B2                 </span><span style="color:navy">mov     </span>RetryLoop<span style="color:navy">, cx
</span><span style="color:black">DOSCODE:68B6                 </span><span style="color:navy">or      dx, dx
</span><span style="color:black">DOSCODE:68B8                 </span><span style="color:navy">jz      short </span><span style="color:gray">ioctl_bad_funj
</span><span style="color:black">DOSCODE:68BA                 </span><span style="color:navy">mov     </span>RetryCount<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:68BE                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ioctl_status_ret
</span><span style="color:black">DOSCODE:68C0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:68C0
DOSCODE:68C0 </span>GENERICIOCTLHANDLE<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:68C0                 </span><span style="color:navy">call    </span>SFFromHandle
<span style="color:black">DOSCODE:68C3                 </span><span style="color:navy">jb      short </span><span style="color:gray">ioctl_bad_handle_j
</span><span style="color:black">DOSCODE:68C5                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:DI+SF_ENTRY.sf_flags+1],
<span style="color:black">DOSCODE:68C5                                         </span>; (sf_isnet&gt;&gt;8)
<span style="color:black">DOSCODE:68CA                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ioctl_bad_funj3
</span><span style="color:black">DOSCODE:68CC                 </span><span style="color:navy">call    </span>set_exerr_locus_ser
<span style="color:black">DOSCODE:68CF                 </span><span style="color:navy">les     di, es:[di+</span><span style="color:#ff8000">7</span><span style="color:navy">]   </span>; [es:di+SF_ENTRY.sf_devptr]
<span style="color:black">DOSCODE:68D3                 </span><span style="color:navy">mov     </span>IOCTL_drvnum<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; invalidate drive number
<span style="color:black">DOSCODE:68D3                                         </span>; (for extended -lock/unlock- functions)
<span style="color:black">DOSCODE:68D8                 </span><span style="color:navy">jmp     short </span><span style="color:gray">Do_GenIOCTL
</span><span style="color:black">DOSCODE:68DA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:68DA
DOSCODE:68DA </span>GENERICIOCTL<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:68DA                 </span><span style="color:navy">call    </span>set_exerr_locus_disk
<span style="color:black">DOSCODE:68DD                 </span><span style="color:navy">cmp     ch, </span><span style="color:green">48h         </span>; category (extended, disk lock/unlock)
<span style="color:black">DOSCODE:68E0                 </span><span style="color:navy">jz      short </span><span style="color:gray">GenIOCTL_chk_net </span>; extended (MSDOS/PCDOS 7)
<span style="color:black">DOSCODE:68E2                 </span><span style="color:navy">cmp     ch, </span><span style="color:#ff8000">8           </span>; IOC_DC ; category (disk control, normal)
<span style="color:black">DOSCODE:68E5                 </span><span style="color:navy">jz      short </span><span style="color:gray">GenIOCTL_chk_net </span>; Only disk devices are allowed to use
<span style="color:black">DOSCODE:68E5                                         </span>; Generic IOCTL
<span style="color:black">DOSCODE:68E7
DOSCODE:68E7 </span><span style="color:gray">ioctl_bad_funj3</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:68E7                 </span><span style="color:navy">jmp     </span><span style="color:gray">ioctl_bad_fun   </span>; no handles with Generic IOCTL
<span style="color:black">DOSCODE:68EA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:68EA
DOSCODE:68EA </span><span style="color:gray">GenIOCTL_chk_net</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:68EA                 </span><span style="color:navy">mov     </span>IOCTL_drvnum<span style="color:navy">, bl </span>; drive number
<span style="color:black">DOSCODE:68EE                 </span><span style="color:navy">call    </span>Check_If_Net
<span style="color:black">DOSCODE:68F1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ioctl_bad_funj3
</span><span style="color:black">DOSCODE:68F3
DOSCODE:68F3 </span><span style="color:gray">Do_GenIOCTL</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:68F3                 </span><span style="color:navy">cmp     ch, </span><span style="color:green">48h         </span>; category code 48h for FAT32
<span style="color:black">DOSCODE:68F6                 </span><span style="color:navy">jz      short </span><span style="color:gray">GenioCTL_extended </span>; MSDOS/PCDOS 7 functions
<span style="color:black">DOSCODE:68F6                                         </span>; (lock/unlock)
<span style="color:black">DOSCODE:68F8                 </span><span style="color:navy">cmp     ch, </span><span style="color:#ff8000">8           </span>; disk control (for FAT12/16)
<span style="color:black">DOSCODE:68FB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GenIOCTL_normal
</span><span style="color:black">DOSCODE:68FD
DOSCODE:68FD </span><span style="color:gray">GenioCTL_extended</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:68FD                 </span><span style="color:navy">cmp     cl, </span><span style="color:green">6Ah         </span>; UNLOCK LOGICAL VOLUME
<span style="color:black">DOSCODE:6900                 </span><span style="color:navy">jz      short </span><span style="color:gray">GenIOCTL_chk_lock
</span><span style="color:black">DOSCODE:6902                 </span><span style="color:navy">cmp     cl, </span><span style="color:green">4Ah         </span>; LOCK LOGICAL VOLUME
<span style="color:black">DOSCODE:6905                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GenIOCTL_normal
</span><span style="color:black">DOSCODE:6907
DOSCODE:6907 </span><span style="color:gray">GenIOCTL_chk_lock</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6907                 </span><span style="color:navy">cmp     cl, </span><span style="color:green">4Ah         </span>; LOCK LOGICAL VOLUME
<span style="color:black">DOSCODE:690A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GenIOCTL_lock_unlock
</span><span style="color:black">DOSCODE:690C                 </span><span style="color:navy">cmp     bh, </span><span style="color:#ff8000">4           </span>; lock level (0-4)
<span style="color:black">DOSCODE:690F                 </span><span style="color:navy">jz      short </span><span style="color:gray">GenIOCTL_lock_unlock
</span><span style="color:black">DOSCODE:6911                 </span><span style="color:navy">or      bh, bh
</span><span style="color:black">DOSCODE:6913                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ioctl_bad_fun
</span><span style="color:black">DOSCODE:6915
DOSCODE:6915 </span><span style="color:gray">GenIOCTL_lock_unlock</span><span style="color:navy">:                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6915                 </span><span style="color:navy">mov     bl, </span>IOCTL_drvnum ; drive number (1=A:, 2=B: ..)
<span style="color:black">DOSCODE:6919                 </span><span style="color:navy">xor     bh, bh
</span><span style="color:black">DOSCODE:691B                 </span><span style="color:navy">dec     bx
</span><span style="color:black">DOSCODE:691C                 </span><span style="color:navy">cmp     bl, </span><span style="color:green">26          </span>; logical disk number limit
<span style="color:black">DOSCODE:691F                 </span><span style="color:navy">jnb     short </span><span style="color:gray">ioctl_bad_fun
</span><span style="color:black">DOSCODE:6921                 </span><span style="color:navy">cmp     cl, </span><span style="color:green">6Ah         </span>; UNLOCK LOGICAL VOLUME
<span style="color:black">DOSCODE:6924                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GenIOCTL_lock
</span><span style="color:black">DOSCODE:6926                 </span><span style="color:navy">and     </span>drive_flags<span style="color:navy">[bx], </span><span style="color:green">7Fh </span>; UNLOCK
<span style="color:black">DOSCODE:692B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">GenIOCTL_OK
</span><span style="color:black">DOSCODE:692D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:692D
DOSCODE:692D </span><span style="color:gray">GenIOCTL_lock</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:692D                 </span><span style="color:navy">or      </span>drive_flags<span style="color:navy">[bx], </span><span style="color:green">80h </span>; LOCK
<span style="color:black">DOSCODE:6932
DOSCODE:6932 </span><span style="color:gray">GenIOCTL_OK</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6932                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:black">DOSCODE:6935 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6935
DOSCODE:6935 </span><span style="color:gray">GenIOCTL_normal</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6935                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">40h </span>; [ES:DI+SYSDEV.ATT],DEV320
<span style="color:black">DOSCODE:693A                 </span><span style="color:navy">jz      short </span><span style="color:gray">ioctl_bad_fun
</span><span style="color:black">DOSCODE:693C                 </span><span style="color:navy">mov     </span>IOCALL_REQFUNC<span style="color:navy">, </span><span style="color:#ff8000">13h </span>; [IOCALL_REQFUNC],GENIOCTL ; 19
<span style="color:black">DOSCODE:6941                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">10h         </span>; IOCTL_QUERY_HANDLE
<span style="color:black">DOSCODE:6943                 </span><span style="color:navy">jl      short </span><span style="color:gray">SetIOCtlBlock
</span><span style="color:black">DOSCODE:6945                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">80h </span>; byte [ES:DI+SYSDEV.ATT],IOQUERY
<span style="color:black">DOSCODE:694A                 </span><span style="color:navy">jz      short </span><span style="color:gray">ioctl_bad_fun </span>; No support for query
<span style="color:black">DOSCODE:694C                 </span><span style="color:navy">mov     </span>IOCALL_REQFUNC<span style="color:navy">, </span><span style="color:#ff8000">19h </span>; IOCTL_QUERY
<span style="color:black">DOSCODE:6951
DOSCODE:6951 </span><span style="color:gray">SetIOCtlBlock</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6951                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:6952                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:6953                 </span><span style="color:navy">mov     </span>IOCALL<span style="color:navy">, </span><span style="color:#ff8000">17h     </span>; IOCTL_REQ.size ; 23
<span style="color:black">DOSCODE:6958                 </span><span style="color:navy">mov     </span>IOCALL_REQUNIT<span style="color:navy">, bl
</span><span style="color:black">DOSCODE:695C                 </span><span style="color:navy">mov     </span>IOMED<span style="color:navy">, ch       </span>; [IOCALL+IOCTL_REQ.MAJORFUNCTION]
<span style="color:black">DOSCODE:6960                 </span><span style="color:navy">mov     byte ptr </span>IOXAD<span style="color:navy">, cl </span>; [IOCALL+IOCTL_REQ.MINORFUNCTION]
<span style="color:black">DOSCODE:6964                 </span><span style="color:navy">mov     word ptr </span>IOXAD<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, si </span>; [IOCALL+IOCTL_REQ.REG_SI]
<span style="color:black">DOSCODE:6968                 </span><span style="color:navy">mov     word ptr </span>IOXAD<span style="color:navy">+</span><span style="color:green">3</span><span style="color:navy">, di </span>; [IOCALL+IOCTL_REQ.REG_DI]
<span style="color:black">DOSCODE:696C                 </span><span style="color:navy">mov     </span>IOSCNT<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, dx    </span>; [IOCALL+IOCTL_REQ.GENERICIOCTL_PACKET]
<span style="color:black">DOSCODE:6970                 </span><span style="color:navy">mov     </span>IOSSEC<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, si    </span>; [IOCALL+IOCTL_REQ.GENERICIOCTL_PACKET+2]
<span style="color:black">DOSCODE:6974                 </span><span style="color:navy">mov     bx, offset </span>IOCALL
<span style="color:black">DOSCODE:6977                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:6978                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:6979                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:6979                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:697A                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:697B                 </span>assume ds:nothing
<span style="color:black">DOSCODE:697B                 </span><span style="color:navy">jmp     </span><span style="color:gray">ioctl_do_IO
</span><span style="color:black">DOSCODE:697E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:697E
DOSCODE:697E </span><span style="color:gray">ioctl_bad_fun</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:697E                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; error_invalid_function
<span style="color:black">DOSCODE:6980                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:black">DOSCODE:6983 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6983                 </span><span style="color:navy">jmp     </span><span style="color:gray">ioctl_bad_handle
</span><span style="color:black">DOSCODE:6986 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6986
DOSCODE:6986 </span>ioctl_rem_media<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6986                 </span><span style="color:navy">call    </span>Check_If_Net
<span style="color:black">DOSCODE:6989                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ioctl_bad_fun
</span><span style="color:black">DOSCODE:698B                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">8 </span>; [es:di+SYSDEV.ATT+1],(DEVOPCL&gt;&gt;8)
<span style="color:black">DOSCODE:6990                 </span><span style="color:navy">jz      short </span><span style="color:gray">ioctl_bad_fun
</span><span style="color:black">DOSCODE:6992                 </span><span style="color:navy">mov     ss:</span>IOCALL_REQFUNC<span style="color:navy">, </span><span style="color:#ff8000">0Fh </span>; DEVRMD
<span style="color:black">DOSCODE:6998                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Dh         </span>; REMHL
<span style="color:black">DOSCODE:699A                 </span><span style="color:navy">mov     ah, bl
</span><span style="color:black">DOSCODE:699C                 </span><span style="color:navy">mov     word ptr ss:</span>IOCALL<span style="color:navy">, ax </span>; [SS:IOCALL_REQLEN]
<span style="color:black">DOSCODE:69A0                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:69A2                 </span><span style="color:navy">mov     ss:</span>IOCALL_REQSTAT<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:69A6                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:69A7                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:69A8                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:69A8                 </span><span style="color:navy">mov     si, di
</span><span style="color:black">DOSCODE:69AA                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:69AB                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:69AC                 </span><span style="color:navy">mov     bx, offset </span>IOCALL
<span style="color:black">DOSCODE:69AF                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:69B0                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:69B1                 </span><span style="color:navy">call    </span>DEVIOCALL2
<span style="color:black">DOSCODE:69B4                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:69B5                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:69B6                 </span>assume ds:nothing
<span style="color:black">DOSCODE:69B6                 </span><span style="color:navy">mov     ax, ss:</span>IOCALL_REQSTAT
<span style="color:black">DOSCODE:69BA                 </span><span style="color:navy">and     ah, </span><span style="color:green">2           </span>; STBUI&gt;&gt;8
<span style="color:black">DOSCODE:69BD                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">9
</span><span style="color:black">DOSCODE:69BF                 </span><span style="color:navy">shr     ax, cl
</span><span style="color:black">DOSCODE:69C1
DOSCODE:69C1 </span><span style="color:gray">ioctl_da_ok_j</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:69C1                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:black">DOSCODE:69C4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:69C4
DOSCODE:69C4 </span>ioctl_drive_attr<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:69C4                 </span><span style="color:navy">mov     al, bl
</span><span style="color:black">DOSCODE:69C6                 </span><span style="color:navy">call    </span>GETTHISDRV
<span style="color:black">DOSCODE:69C9                 </span><span style="color:navy">jb      short </span>ioctl_drv_err
<span style="color:black">DOSCODE:69CB                 </span><span style="color:navy">call    </span>Get_Driver_BL
<span style="color:black">DOSCODE:69CE                 </span><span style="color:navy">jb      short </span>ioctl_drv_err ; drive not valid
<span style="color:black">DOSCODE:69D0                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">942h        </span>; 0942h -&gt; Attribute word
<span style="color:black">DOSCODE:69D0                                         </span>; bit 11 - open/close/remmedia calls supported
<span style="color:black">DOSCODE:69D0                                         </span>; bit 8 - (new type driver)
<span style="color:black">DOSCODE:69D0                                         </span>; bit 6 - Generic IOCTL call supported
<span style="color:black">DOSCODE:69D0                                         </span>; bit 1 - driver supports 32-bit sector addressing
<span style="color:black">DOSCODE:69D3                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ioctl_drive_attr2 </span>; NET device
<span style="color:black">DOSCODE:69D5                 </span><span style="color:navy">mov     dx, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+SYSDEV.ATT]
<span style="color:black">DOSCODE:69D5                                         </span>; get device attribute word
<span style="color:black">DOSCODE:69D9
DOSCODE:69D9 </span><span style="color:gray">ioctl_drive_attr2</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:69D9                 </span><span style="color:navy">mov     bl, al          </span>; drive number (A=0)
<span style="color:black">DOSCODE:69DB                 </span><span style="color:navy">les     di, ss:</span>THISCDS  ; NOTE: PCDOS 7.1 has bug here,
<span style="color:black">DOSCODE:69DB                                         </span>; ds must be same with ss here...
<span style="color:black">DOSCODE:69DB                                         </span>; because there is &#039;les di, [ds:THISCDS]&#039; in
<span style="color:black">DOSCODE:69DB                                         </span>; Get_Driver_BL
<span style="color:black">DOSCODE:69DB                                         </span>; and a second &#039;test byte ptr es:[ di+44h],80h&#039;
<span style="color:black">DOSCODE:69DB                                         </span>; is not necessary; also its result (jnz)
<span style="color:black">DOSCODE:69DB                                         </span>; overwrites DS. /// Erdogan Tan - 30/01/2024
<span style="color:black">DOSCODE:69E0                 </span>assume es:nothing
<span style="color:black">DOSCODE:69E0                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">44h</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:DI+curdir.flags+1],
<span style="color:black">DOSCODE:69E0                                         </span>; (curdir_isnet&gt;&gt;8)
<span style="color:black">DOSCODE:69E5                 </span><span style="color:navy">jz      short </span><span style="color:gray">IOCTLShare
</span><span style="color:black">DOSCODE:69E7                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">1000h       </span>; remote device (bit 12)
<span style="color:black">DOSCODE:69EA
DOSCODE:69EA </span><span style="color:gray">IOCTLShare</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:69EA                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:69EB                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:69EC                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:69EC                 </span><span style="color:navy">mov     si, offset </span>OPENBUF
<span style="color:black">DOSCODE:69EF                 </span><span style="color:navy">add     bl, </span><span style="color:#ff8000">41h </span><span style="color:gray">; &#039;A&#039;
</span><span style="color:black">DOSCODE:69F2                 </span><span style="color:navy">mov     [si], bl
</span><span style="color:black">DOSCODE:69F4                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">1</span><span style="color:navy">], </span><span style="color:#ff8000">3Ah </span><span style="color:gray">; &#039;:&#039;
</span><span style="color:black">DOSCODE:69F9                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">300h
</span><span style="color:black">DOSCODE:69FC                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:69FD                 </span><span style="color:navy">int     </span><span style="color:green">2Ah             </span>; Microsoft Networks - CHECK DIRECT I/O
<span style="color:black">DOSCODE:69FD                                         </span>; DS:SI -&gt; ASCIZ disk device name (may be full path or only drive
<span style="color:black">DOSCODE:69FD                                         </span>; specifier--must include the colon)
<span style="color:black">DOSCODE:69FD                                         </span>; Return: CF clear if absolute disk access allowed
<span style="color:black">DOSCODE:69FF                 </span><span style="color:navy">jnb     short </span><span style="color:gray">IOCTLLocal
</span><span style="color:black">DOSCODE:6A01                 </span><span style="color:navy">or      dx, </span><span style="color:green">200h        </span>; Shared, bit 9
<span style="color:black">DOSCODE:6A05
DOSCODE:6A05 </span><span style="color:gray">IOCTLLocal</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6A05                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">44h</span><span style="color:navy">], </span><span style="color:green">10h </span>; [ES:DI+curdir.flags+1],(curdir_local&gt;&gt;8)
<span style="color:black">DOSCODE:6A0A                 </span><span style="color:navy">jz      short </span><span style="color:gray">ioctl_set_DX
</span><span style="color:black">DOSCODE:6A0C                 </span><span style="color:navy">or      dx, </span><span style="color:green">8000h
</span><span style="color:black">DOSCODE:6A10
DOSCODE:6A10 </span><span style="color:gray">ioctl_set_DX</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6A10                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:black">DOSCODE:6A13                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], dx
</span><span style="color:black">DOSCODE:6A16
DOSCODE:6A16 </span><span style="color:gray">ioctl_gd_ok_j</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6A16                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ioctl_da_ok_j
</span><span style="color:black">DOSCODE:6A18 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6A18
DOSCODE:6A18 </span>ioctl_drv_err<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6A18                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Fh         </span>; error_invalid_drive
<span style="color:black">DOSCODE:6A1A
DOSCODE:6A1A </span><span style="color:gray">ioctl_gd_err_j</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6A1A                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:black">DOSCODE:6A1D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6A1D
DOSCODE:6A1D </span>ioctl_handle_redir<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6A1D                 </span><span style="color:navy">call    </span>SFFromHandle    ; ES:DI -&gt; SFT
<span style="color:black">DOSCODE:6A20                 </span><span style="color:navy">jnb     short </span><span style="color:gray">ioctl_got_sft </span>; have valid handle
<span style="color:black">DOSCODE:6A22                 </span><span style="color:navy">jmp     </span><span style="color:gray">ioctl_bad_handle
</span><span style="color:black">DOSCODE:6A25 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6A25
DOSCODE:6A25 </span><span style="color:gray">ioctl_got_sft</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6A25                 </span><span style="color:navy">mov     dx, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_flags] ; Get flags
<span style="color:black">DOSCODE:6A29                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ioctl_set_DX
</span><span style="color:black">DOSCODE:6A2B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6A2B
DOSCODE:6A2B </span><span style="color:gray">ioctl_bad_funj5</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6A2B                 </span><span style="color:navy">jmp     </span><span style="color:gray">ioctl_bad_fun
</span><span style="color:black">DOSCODE:6A2E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6A2E
DOSCODE:6A2E </span>ioctl_get_dev<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6A2E                 </span><span style="color:navy">call    </span>Check_If_Net
<span style="color:black">DOSCODE:6A31                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ioctl_bad_funj5
</span><span style="color:black">DOSCODE:6A33
DOSCODE:6A33 </span><span style="color:gray">ioctl_do_string</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6A33                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [ES:DI+SYSDEV.ATT+1],(DEVIOCTL&gt;&gt;8)
<span style="color:black">DOSCODE:6A38                 </span><span style="color:navy">jz      short </span><span style="color:gray">ioctl_bad_funj5
</span><span style="color:black">DOSCODE:6A3A                 </span><span style="color:navy">mov     </span>IOCALL_REQFUNC<span style="color:navy">, </span><span style="color:#ff8000">3 </span>; DEVRDIOCTL ; IOCTL read
<span style="color:black">DOSCODE:6A3F                 </span><span style="color:navy">test    al, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:6A41                 </span><span style="color:navy">jz      short </span><span style="color:gray">ioctl_control_call
</span><span style="color:black">DOSCODE:6A43                 </span><span style="color:navy">mov     </span>IOCALL_REQFUNC<span style="color:navy">, </span><span style="color:#ff8000">0Ch </span>; DEVWRIOCTL ; IOCTL write
<span style="color:black">DOSCODE:6A48
DOSCODE:6A48 </span><span style="color:gray">ioctl_control_call</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6A48                 </span><span style="color:navy">mov     al, </span><span style="color:green">20          </span>; It is 22 in
<span style="color:black">DOSCODE:6A48                                         </span>; MSDOS 6.22 MSDOS.SYS and Windows ME IO.SYS
<span style="color:black">DOSCODE:6A4A                 </span><span style="color:navy">mov     ah, bl
</span><span style="color:black">DOSCODE:6A4C                 </span><span style="color:navy">mov     word ptr </span>IOCALL<span style="color:navy">, ax </span>; [IOCALL_REQLEN]
<span style="color:black">DOSCODE:6A4F                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:6A51                 </span><span style="color:navy">mov     </span>IOCALL_REQSTAT<span style="color:navy">, ax </span>; [IOCALL_REQSTAT]
<span style="color:black">DOSCODE:6A54                 </span><span style="color:navy">mov     </span>IOMED<span style="color:navy">, al
</span><span style="color:black">DOSCODE:6A57                 </span><span style="color:navy">mov     </span>IOSCNT<span style="color:navy">, cx
</span><span style="color:black">DOSCODE:6A5B                 </span><span style="color:navy">mov     word ptr </span>IOXAD<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:6A5F                 </span><span style="color:navy">mov     word ptr </span>IOXAD<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, si
</span><span style="color:black">DOSCODE:6A63                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:6A64                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:6A65                 </span>assume ds:nothing
<span style="color:black">DOSCODE:6A65                 </span><span style="color:navy">mov     si, di
</span><span style="color:black">DOSCODE:6A67                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:6A68                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:6A69                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:6A69                 </span><span style="color:navy">mov     bx, offset </span>IOCALL
<span style="color:black">DOSCODE:6A6C
DOSCODE:6A6C </span><span style="color:gray">ioctl_do_IO</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6A6C                 </span><span style="color:navy">call    </span>DEVIOCALL2
<span style="color:black">DOSCODE:6A6F                 </span><span style="color:navy">test    byte ptr ss:</span>IOCALL_REQSTAT<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:green">80h </span>; (STERR&gt;&gt;8)
<span style="color:black">DOSCODE:6A75                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ioctl_string_err
</span><span style="color:black">DOSCODE:6A77                 </span><span style="color:navy">mov     ax, ss:</span>IOSCNT
<span style="color:black">DOSCODE:6A7B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ioctl_gd_ok_j
</span><span style="color:black">DOSCODE:6A7D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6A7D
DOSCODE:6A7D </span><span style="color:gray">ioctl_string_err</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6A7D                 </span><span style="color:navy">mov     di, ss:</span>IOCALL_REQSTAT
<span style="color:black">DOSCODE:6A82                 </span><span style="color:navy">and     di, </span><span style="color:green">0FFh        </span>; STECODE
<span style="color:black">DOSCODE:6A86                 </span><span style="color:navy">mov     ax, di
</span><span style="color:black">DOSCODE:6A88                 </span><span style="color:navy">call    </span>SET_I24_EXTENDED_ERROR
<span style="color:black">DOSCODE:6A8B                 </span><span style="color:navy">mov     ax, ss:</span>EXTERR
<span style="color:black">DOSCODE:6A8F                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ioctl_gd_err_j
</span><span style="color:black">DOSCODE:6A8F </span>$IOCTL          <span style="color:black">endp
DOSCODE:6A8F
DOSCODE:6A91
DOSCODE:6A91 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:6A91
DOSCODE:6A91
DOSCODE:6A91 </span>Get_Driver_BL   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6A91                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:6A92                 </span><span style="color:navy">mov     al, bl          </span>; drive number (0=default)
<span style="color:black">DOSCODE:6A94                 </span><span style="color:navy">call    </span>GETTHISDRV
<span style="color:black">DOSCODE:6A97                 </span><span style="color:navy">jb      short </span><span style="color:gray">ioctl_bad_drv
</span><span style="color:black">DOSCODE:6A99                 </span><span style="color:navy">xor     bl, bl
</span><span style="color:black">DOSCODE:6A9B                 </span><span style="color:navy">mov     ds:</span>EXTERR_LOCUS<span style="color:navy">, </span><span style="color:#ff8000">3 </span>; errLOC_Net
<span style="color:black">DOSCODE:6AA0                 </span><span style="color:navy">les     di, ds:</span>THISCDS
<span style="color:black">DOSCODE:6AA4                 </span>assume es:nothing
<span style="color:black">DOSCODE:6AA4                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">44h</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:DI+curdir.flags+1],
<span style="color:black">DOSCODE:6AA4                                         </span>; (curdir_isnet&gt;&gt;8)
<span style="color:black">DOSCODE:6AA9                 </span><span style="color:navy">les     di, es:[di+</span><span style="color:#ff8000">45h</span><span style="color:navy">] </span>; [ES:DI+curdir.devptr]
<span style="color:black">DOSCODE:6AAD                 </span><span style="color:navy">jnz     short </span><span style="color:gray">got_dev_ptr </span>; Is net
<span style="color:black">DOSCODE:6AAF                 </span><span style="color:navy">call    </span>set_exerr_locus_disk ; mov byte [EXTERR_LOCUS],errLOC_Disk ; 2
<span style="color:black">DOSCODE:6AB2                 </span><span style="color:navy">mov     bl, es:[di+</span><span style="color:#ff8000">1</span><span style="color:navy">]   </span>; [ES:DI+DPB.UNIT] ; Unit number
<span style="color:black">DOSCODE:6AB6                 </span><span style="color:navy">les     di, es:[di+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [ES:DI+DPB.DRIVER_ADDR] ; Driver addr
<span style="color:black">DOSCODE:6ABA
DOSCODE:6ABA </span><span style="color:gray">got_dev_ptr</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6ABA                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:6ABB
DOSCODE:6ABB </span><span style="color:gray">ioctl_bad_drv</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6ABB                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:6ABC                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6ABC </span>Get_Driver_BL   <span style="color:black">endp
DOSCODE:6ABC
DOSCODE:6ABD
DOSCODE:6ABD </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:6ABD
DOSCODE:6ABD
DOSCODE:6ABD </span>Check_If_Net    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6ABD                 </span><span style="color:navy">call    </span>Get_Driver_BL
<span style="color:black">DOSCODE:6AC0                 </span><span style="color:navy">jb      short </span><span style="color:gray">ioctl_drv_err_pop </span>; invalid drive letter
<span style="color:black">DOSCODE:6AC2                 </span><span style="color:navy">retn                    </span>; ZF = 1 if not a net device
<span style="color:black">DOSCODE:6AC3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6AC3
DOSCODE:6AC3 </span><span style="color:gray">ioctl_drv_err_pop</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6AC3                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:6AC4                 </span><span style="color:navy">jmp     </span>ioctl_drv_err
<span style="color:black">DOSCODE:6AC4 </span><span style="background:red">Check_If_Net    endp</span><span style="background:red"> ; sp-analysis failed</span>
<span style="color:black">DOSCODE:6AC4
DOSCODE:6AC7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6AC7 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR $IOCTL
</span><span style="color:black">DOSCODE:6AC7
DOSCODE:6AC7 </span><span style="color:gray">ioctl_bad_funj4</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6AC7                 </span><span style="color:navy">jmp     </span><span style="color:gray">ioctl_bad_fun
</span><span style="color:black">DOSCODE:6ACA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6ACA
DOSCODE:6ACA </span><span style="color:gray">ioctl_string_errj</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6ACA                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ioctl_string_err
</span><span style="color:black">DOSCODE:6ACC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6ACC
DOSCODE:6ACC </span>ioctl_drive_owner<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6ACC                 </span><span style="color:navy">call    </span>Check_If_Net
<span style="color:black">DOSCODE:6ACF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ioctl_bad_funj4
</span><span style="color:black">DOSCODE:6AD1                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">40h </span>; [ES:DI+SYSDEV.ATT],DEV320
<span style="color:black">DOSCODE:6AD6                 </span><span style="color:navy">jz      short </span><span style="color:gray">ioctl_bad_funj4
</span><span style="color:black">DOSCODE:6AD8                 </span><span style="color:navy">mov     ds:</span>IOCALL_REQFUNC<span style="color:navy">, </span><span style="color:green">23 </span>; DEVGETOWN ; default to get owner
<span style="color:black">DOSCODE:6ADD                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Eh         </span>; Get Owner ?
<span style="color:black">DOSCODE:6ADF                 </span><span style="color:navy">jz      short </span><span style="color:gray">GetOwner
</span><span style="color:black">DOSCODE:6AE1                 </span><span style="color:navy">mov     ds:</span>IOCALL_REQFUNC<span style="color:navy">, </span><span style="color:green">24 </span>; DEVSETOWN
<span style="color:black">DOSCODE:6AE6
DOSCODE:6AE6 </span><span style="color:gray">GetOwner</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6AE6                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Dh         </span>; OWNHL
<span style="color:black">DOSCODE:6AE8                 </span><span style="color:navy">mov     ah, bl          </span>; Unit number
<span style="color:black">DOSCODE:6AEA                 </span><span style="color:navy">mov     word ptr ds:</span>IOCALL<span style="color:navy">, ax </span>; [IOCALL_REQLEN]
<span style="color:black">DOSCODE:6AED                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:6AEF                 </span><span style="color:navy">mov     ds:</span>IOCALL_REQSTAT<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:6AF2                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:6AF3                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:6AF4                 </span><span style="color:navy">mov     si, di          </span>; DS:SI -&gt; driver
<span style="color:black">DOSCODE:6AF6                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:6AF7                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:6AF8                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:6AF8                 </span><span style="color:navy">mov     bx, offset </span>IOCALL ; ES:BX -&gt; Call header
<span style="color:black">DOSCODE:6AFB                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:6AFC                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:6AFD                 </span><span style="color:navy">call    </span>DEVIOCALL2
<span style="color:black">DOSCODE:6B00                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:6B01                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:6B02                 </span><span style="color:navy">test    byte ptr ss:</span>IOCALL_REQSTAT<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:green">80h </span>; (STERR&gt;&gt;8)
<span style="color:black">DOSCODE:6B08                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ioctl_string_errj
</span><span style="color:black">DOSCODE:6B0A                 </span><span style="color:navy">mov     al, ss:</span>IOCALL_REQUNIT ; Get owner returned by device
<span style="color:black">DOSCODE:6B0A                                         </span>; owner returned is 1-based.
<span style="color:black">DOSCODE:6B0E                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:black">DOSCODE:6B0E </span><span style="color:gray">; END OF FUNCTION CHUNK FOR $IOCTL
</span><span style="color:black">DOSCODE:6B11
DOSCODE:6B11 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:6B11
DOSCODE:6B11
DOSCODE:6B11 </span>DOS_DELETE      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6B11                 </span><span style="color:navy">call    </span>TestNet
<span style="color:black">DOSCODE:6B14                 </span><span style="color:navy">jnb     short </span><span style="color:gray">LOCAL_DELETE
</span><span style="color:black">DOSCODE:6B16                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1113h
</span><span style="color:black">DOSCODE:6B19                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - DELETE REMOTE FILE
<span style="color:black">DOSCODE:6B19                                         </span>; SS = DS = DOS CS, SDA first filename pointer -&gt; fully-qualified filename in DOS CS
<span style="color:black">DOSCODE:6B19                                         </span>; SDA CDS pointer -&gt; current directory structure for drive with file
<span style="color:black">DOSCODE:6B19                                         </span>; Return: CF set on error
<span style="color:black">DOSCODE:6B1B                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6B1C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6B1C
DOSCODE:6B1C </span><span style="color:gray">LOCAL_DELETE</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6B1C                 </span><span style="color:navy">mov     ds:</span>FOUNDDEL<span style="color:navy">, </span><span style="color:#ff8000">0  </span>; No files found and no files deleted
<span style="color:black">DOSCODE:6B21                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:6B24                 </span><span style="color:navy">mov     word ptr ds:</span>CREATING<span style="color:navy">, </span><span style="color:green">0E500h </span>; DIRFREE*256+0 ; Assume not del *.*
<span style="color:black">DOSCODE:6B2A                 </span><span style="color:navy">mov     si, ds:</span>WFP_START
<span style="color:black">DOSCODE:6B2E
DOSCODE:6B2E </span><span style="color:gray">SKPNUL</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6B2E                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:6B2F                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:6B31                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SKPNUL    </span>; go to end
<span style="color:black">DOSCODE:6B33                 </span><span style="color:navy">sub     si, </span><span style="color:#ff8000">4           </span>; Back over possible &quot;*.*&quot;
<span style="color:black">DOSCODE:6B36                 </span><span style="color:navy">cmp     word ptr [si], </span><span style="color:#ff8000">2E2Ah </span>; &quot;*.&quot;
<span style="color:black">DOSCODE:6B3A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">TEST_QUEST
</span><span style="color:black">DOSCODE:6B3C                 </span><span style="color:navy">cmp     byte ptr [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:#ff8000">2Ah </span><span style="color:gray">; &#039;*&#039;
</span><span style="color:black">DOSCODE:6B40                 </span><span style="color:navy">jz      short </span><span style="color:gray">CHECK_ATTS
</span><span style="color:black">DOSCODE:6B42
DOSCODE:6B42 </span><span style="color:gray">TEST_QUEST</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6B42                 </span><span style="color:navy">sub     si, </span><span style="color:#ff8000">9           </span>; Back over possible &quot;????????.???&quot;
<span style="color:black">DOSCODE:6B45                 </span><span style="color:navy">xchg    di, si
</span><span style="color:black">DOSCODE:6B47                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:6B48                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:6B49                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3F3Fh       </span>; &#039;??&#039;
<span style="color:black">DOSCODE:6B4C                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4           </span>; four sets of &quot;??&quot;
<span style="color:black">DOSCODE:6B4F                 </span><span style="color:navy">repe scasw
</span><span style="color:black">DOSCODE:6B51                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOT_ALL
</span><span style="color:black">DOSCODE:6B53                 </span><span style="color:navy">xchg    di, si
</span><span style="color:black">DOSCODE:6B55                 </span><span style="color:navy">lodsw
</span><span style="color:black">DOSCODE:6B56                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">3F2Eh       </span>; &quot;.?&quot;
<span style="color:black">DOSCODE:6B59                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOT_ALL
</span><span style="color:black">DOSCODE:6B5B                 </span><span style="color:navy">lodsw
</span><span style="color:black">DOSCODE:6B5C                 </span><span style="color:navy">cmp     ax, &#039;</span><span style="color:green">??&#039;        </span>; 3F3Fh
<span style="color:black">DOSCODE:6B5F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOT_ALL
</span><span style="color:black">DOSCODE:6B61
DOSCODE:6B61 </span><span style="color:gray">CHECK_ATTS</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6B61                 </span><span style="color:navy">mov     al, ds:</span>SATTRIB
<span style="color:black">DOSCODE:6B64                 </span><span style="color:navy">and     al, </span><span style="color:green">1Fh         </span>; attr_hidden+attr_system+attr_directory+attr_volume_id+attr_read_only
<span style="color:black">DOSCODE:6B64                                         </span>; Look only at hidden bits
<span style="color:black">DOSCODE:6B66                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1Fh
</span><span style="color:black">DOSCODE:6B68                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOT_ALL
</span><span style="color:black">DOSCODE:6B6A                 </span><span style="color:navy">mov     ds:</span>DELALL<span style="color:navy">, </span><span style="color:#ff8000">0    </span>; DEL *.* - flag deleting all
<span style="color:black">DOSCODE:6B6F
DOSCODE:6B6F </span><span style="color:gray">NOT_ALL</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6B6F                 </span><span style="color:navy">mov     ds:</span>NoSetDir<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:6B74                 </span><span style="color:navy">call    </span>GetPathNoSet
<span style="color:black">DOSCODE:6B77                 </span><span style="color:navy">jnb     short </span><span style="color:gray">Del_found </span>; [CURBUF+2]:SI = First Cluster field in dir entry
<span style="color:black">DOSCODE:6B77                                         </span>; [CURBUF+2]:BX = Directory entry
<span style="color:black">DOSCODE:6B79                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_bad_path
</span><span style="color:black">DOSCODE:6B7B                 </span><span style="color:navy">or      cl, cl
</span><span style="color:black">DOSCODE:6B7D                 </span><span style="color:navy">jz      short </span><span style="color:gray">_bad_path
</span><span style="color:black">DOSCODE:6B7F
DOSCODE:6B7F </span><span style="color:gray">No_file</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6B7F                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2           </span>; error_file_not_found
<span style="color:black">DOSCODE:6B82
DOSCODE:6B82 </span><span style="color:gray">ErrorReturn</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6B82                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:6B83                 </span><span style="color:navy">jmp     </span><span style="color:gray">No_Set_Flag
</span><span style="color:black">DOSCODE:6B86 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6B86
DOSCODE:6B86 </span><span style="color:gray">_bad_path</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6B86                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3           </span>; error_path_not_found
<span style="color:black">DOSCODE:6B89                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ErrorReturn
</span><span style="color:black">DOSCODE:6B8B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6B8B
DOSCODE:6B8B </span><span style="color:gray">Del_found</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6B8B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOT_DIR   </span>; Check for dir specified
<span style="color:black">DOSCODE:6B8D                 </span><span style="color:navy">cmp     ds:</span>DELALL<span style="color:navy">, </span><span style="color:#ff8000">0    </span>; DelAll = 0 allows delete of dir.
<span style="color:black">DOSCODE:6B92                 </span><span style="color:navy">jz      short </span><span style="color:gray">NOT_DIR
</span><span style="color:black">DOSCODE:6B94
DOSCODE:6B94 </span><span style="color:gray">Del_access_err</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6B94                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5
</span><span style="color:black">DOSCODE:6B97                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ErrorReturn
</span><span style="color:black">DOSCODE:6B99 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6B99
DOSCODE:6B99 </span><span style="color:gray">NOT_DIR</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6B99                 </span><span style="color:navy">or      ah, ah          </span>; Check if device name
<span style="color:black">DOSCODE:6B9B                 </span><span style="color:navy">js      short </span><span style="color:gray">Del_access_err </span>; Can&#039;t delete I/O devices
<span style="color:black">DOSCODE:6B9D
DOSCODE:6B9D </span><span style="color:gray">DELFILE</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6B9D                 </span><span style="color:navy">or      ds:</span>FOUNDDEL<span style="color:navy">, </span><span style="color:green">1  </span>; FILEFOUND ; file found, not deleted yet
<span style="color:black">DOSCODE:6BA2                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:6BA3                 </span><span style="color:navy">mov     ah, ds:</span>DELALL
<span style="color:black">DOSCODE:6BA7                 </span><span style="color:navy">lds     di, ds:</span>CURBUF
<span style="color:black">DOSCODE:6BAB                 </span><span style="color:navy">test    ss:</span>ATTRIB<span style="color:navy">, </span><span style="color:green">1    </span>; attr_read_only ; are we deleting RO files too?
<span style="color:black">DOSCODE:6BB1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">DoDelete
</span><span style="color:black">DOSCODE:6BB3                 </span><span style="color:navy">test    byte ptr [bx+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], </span><span style="color:green">1 </span>; [BX+dir_entry.dir_attr],attr_read_only
<span style="color:black">DOSCODE:6BB7                 </span><span style="color:navy">jz      short </span><span style="color:gray">DoDelete  </span>; not read only
<span style="color:black">DOSCODE:6BB9
DOSCODE:6BB9 </span><span style="color:gray">Skip_it</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6BB9                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:6BBA                 </span><span style="color:navy">jmp     short </span><span style="color:gray">DELNXT    </span>; Skip it (Note ES:BP not set)
<span style="color:black">DOSCODE:6BBC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6BBC
DOSCODE:6BBC </span><span style="color:gray">DoDelete</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6BBC                 </span><span style="color:navy">call    </span>REN_DEL_Check   ; Sets ES:BP = [THISDPB]
<span style="color:black">DOSCODE:6BBF                 </span><span style="color:navy">jb      short </span><span style="color:gray">Skip_it
</span><span style="color:black">DOSCODE:6BC1
DOSCODE:6BC1 </span>DEL_SHARE_OK<span style="color:navy">:                           </span>;
<span style="color:black">DOSCODE:6BC1                 </span><span style="color:navy">test    byte ptr [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [DI+BUFFINFO.buf_flags],buf_dirty
<span style="color:black">DOSCODE:6BC5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">yesdirty
</span><span style="color:black">DOSCODE:6BC7                 </span><span style="color:navy">call    </span>INC_DIRTY_COUNT
<span style="color:black">DOSCODE:6BCA                 </span><span style="color:navy">or      byte ptr [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [DI+BUFFINFO.buf_flags],buf_dirty
<span style="color:black">DOSCODE:6BCE
DOSCODE:6BCE </span><span style="color:gray">yesdirty</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6BCE                 </span><span style="color:navy">mov     [bx], ah        </span>; [BX+dir_entry.dir_name],AH ; Put in E5h or 0
<span style="color:black">DOSCODE:6BD0                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:6BD2                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], bx
</span><span style="color:black">DOSCODE:6BD6                 </span><span style="color:navy">jnz     short </span><span style="color:gray">yesdirty_fc_1 </span>; not FAT32
<span style="color:black">DOSCODE:6BD8                 </span><span style="color:navy">mov     bx, [si-</span><span style="color:green">6</span><span style="color:navy">]      </span>; high word of the first cluster (FAT32)
<span style="color:black">DOSCODE:6BDB
DOSCODE:6BDB </span><span style="color:gray">yesdirty_fc_1</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6BDB                 </span><span style="color:navy">mov     ss:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:6BE0                 </span><span style="color:navy">mov     bx, [si]
</span><span style="color:black">DOSCODE:6BE2                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:6BE3                 </span><span style="color:navy">or      ds:</span>FOUNDDEL<span style="color:navy">, </span><span style="color:green">10h </span>; FILEDELETED
<span style="color:black">DOSCODE:6BE8                 </span><span style="color:navy">cmp     ds:</span>CLUSTNUM_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:6BED                 </span><span style="color:navy">jnz     short </span><span style="color:gray">yesdirty_fc_2
</span><span style="color:black">DOSCODE:6BEF                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:6BF2
DOSCODE:6BF2 </span><span style="color:gray">yesdirty_fc_2</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6BF2                 </span><span style="color:navy">jb      short </span><span style="color:gray">DELNXT    </span>; File has invalid FIRCLUS (too small)
<span style="color:black">DOSCODE:6BF4                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:bp+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:6BF9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">yesdirty_fc_3
</span><span style="color:black">DOSCODE:6BFB                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:6BFC                 </span><span style="color:navy">mov     bx, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:6C00                 </span><span style="color:navy">cmp     bx, es:[bp+</span><span style="color:#ff8000">2Fh</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:6C04                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:6C05                 </span><span style="color:navy">jnz     short </span><span style="color:gray">yesdirty_fc_4
</span><span style="color:black">DOSCODE:6C07                 </span><span style="color:navy">cmp     bx, es:[bp+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:6C0B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">yesdirty_fc_4
</span><span style="color:black">DOSCODE:6C0D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6C0D
DOSCODE:6C0D </span><span style="color:gray">yesdirty_fc_3</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6C0D                 </span><span style="color:navy">cmp     bx, es:[bp+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">] </span>; [ES:BP+DPB.MAX_CLUSTER]
<span style="color:black">DOSCODE:6C11
DOSCODE:6C11 </span><span style="color:gray">yesdirty_fc_4</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6C11                 </span><span style="color:navy">ja      short </span><span style="color:gray">DELNXT    </span>; File has invalid FIRCLUS (too big)
<span style="color:black">DOSCODE:6C13                 </span><span style="color:navy">call    </span>RELEASE         ; Free file data
<span style="color:black">DOSCODE:6C16                 </span><span style="color:navy">jb      short </span><span style="color:gray">No_fileJ
</span><span style="color:black">DOSCODE:6C18                 </span><span style="color:navy">call    </span>FastOpen_Delete
<span style="color:black">DOSCODE:6C1B
DOSCODE:6C1B </span><span style="color:gray">DELNXT</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6C1B                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:6C1F                 </span>assume es:nothing
<span style="color:black">DOSCODE:6C1F                 </span><span style="color:navy">call    </span>GETENTRY        ; Registers need to be reset
<span style="color:black">DOSCODE:6C22                 </span><span style="color:navy">jb      short </span><span style="color:gray">No_fileJ
</span><span style="color:black">DOSCODE:6C24                 </span><span style="color:navy">call    </span>NEXTENT
<span style="color:black">DOSCODE:6C27                 </span><span style="color:navy">jb      short </span><span style="color:gray">DELNXT2
</span><span style="color:black">DOSCODE:6C29                 </span><span style="color:navy">jmp     </span><span style="color:gray">DELFILE
</span><span style="color:black">DOSCODE:6C2C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6C2C
DOSCODE:6C2C </span><span style="color:gray">DELNXT2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6C2C                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:6C30                 </span><span style="color:navy">call    </span>update_fat32_fsinfo
<span style="color:black">DOSCODE:6C33                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; [ES:BP+DPB.DRIVE]
<span style="color:black">DOSCODE:6C37                 </span><span style="color:navy">call    </span>FLUSHBUF
<span style="color:black">DOSCODE:6C3A                 </span><span style="color:navy">jb      short </span><span style="color:gray">No_fileJ
</span><span style="color:black">DOSCODE:6C3C                 </span><span style="color:navy">test    ds:</span>FOUNDDEL<span style="color:navy">, </span><span style="color:green">10h </span>; FILEDELETE
<span style="color:black">DOSCODE:6C41                 </span><span style="color:navy">jz      short </span><span style="color:gray">DelError
</span><span style="color:black">DOSCODE:6C43                 </span><span style="color:navy">test    ds:</span>ATTRIB<span style="color:navy">, </span><span style="color:green">8    </span>; attr_volume_id
<span style="color:black">DOSCODE:6C48                 </span><span style="color:navy">jz      short </span><span style="color:gray">No_Set_Flag
</span><span style="color:black">DOSCODE:6C4A                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:6C4B                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:6C4C                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:6C4D                 </span><span style="color:navy">les     di, ds:</span>THISCDS
<span style="color:black">DOSCODE:6C51                 </span><span style="color:navy">xor     bh, bh
</span><span style="color:black">DOSCODE:6C53                 </span><span style="color:navy">mov     ah, es:[di]     </span>; Get drive
<span style="color:black">DOSCODE:6C56                 </span><span style="color:navy">sub     ah, &#039;</span><span style="color:green">A&#039;         </span>; Convert to 0-based
<span style="color:black">DOSCODE:6C59                 </span><span style="color:navy">mov     ds:</span>VOLCHNG_FLAG<span style="color:navy">, ah
</span><span style="color:black">DOSCODE:6C5D                 </span><span style="color:navy">call    </span>Set_Media_ID
<span style="color:black">DOSCODE:6C60                 </span><span style="color:navy">call    </span>FATREAD_CDS     ; force media check
<span style="color:black">DOSCODE:6C63                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:6C64                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:6C65                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:6C66
DOSCODE:6C66 </span><span style="color:gray">No_Set_Flag</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6C66                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:6C69                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6C6A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6C6A
DOSCODE:6C6A </span><span style="color:gray">DelError</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6C6A                 </span><span style="color:navy">test    ds:</span>FOUNDDEL<span style="color:navy">, </span><span style="color:green">1  </span>; FILEFOUND ; not deleted. Did we find file?
<span style="color:black">DOSCODE:6C6F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">Del_access_errJ </span>; yes. Access denied
<span style="color:black">DOSCODE:6C71
DOSCODE:6C71 </span><span style="color:gray">No_fileJ</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6C71                 </span><span style="color:navy">jmp     </span><span style="color:gray">No_file         </span>; Nope
<span style="color:black">DOSCODE:6C74 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6C74
DOSCODE:6C74 </span><span style="color:gray">Del_access_errJ</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6C74                 </span><span style="color:navy">jmp     </span><span style="color:gray">Del_access_err
</span><span style="color:black">DOSCODE:6C74 </span>DOS_DELETE      <span style="color:black">endp
DOSCODE:6C74
DOSCODE:6C77
DOSCODE:6C77 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:6C77
DOSCODE:6C77
DOSCODE:6C77 </span>REN_DEL_Check   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6C77                 </span><span style="color:navy">push    ds              </span>; check for access for rename and delete
<span style="color:black">DOSCODE:6C78                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:6C79                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:6C7A                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:6C7B                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:6C7C                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:6C7D                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:6C7E                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:6C7E                 </span><span style="color:navy">mov     di, ss:</span>WFP_START ; points to name
<span style="color:black">DOSCODE:6C83                 </span><span style="color:navy">mov     si, bx
</span><span style="color:black">DOSCODE:6C85                 </span><span style="color:navy">mov     ds, word ptr ss:</span>CURBUF<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:6C8A                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:6C8A                 </span><span style="color:navy">mov     bx, di          </span>; Set backup limit for skipback
<span style="color:black">DOSCODE:6C8C                 </span><span style="color:navy">inc     bx              </span>; Skip over d: to point to leading &#039;\&#039;
<span style="color:black">DOSCODE:6C8D                 </span><span style="color:navy">inc     bx
</span><span style="color:black">DOSCODE:6C8E                 </span><span style="color:navy">call    </span>StrLen          ; CX is length of ES:DI including NUL
<span style="color:black">DOSCODE:6C91                 </span><span style="color:navy">dec     cx              </span>; Don&#039;t include nul in count
<span style="color:black">DOSCODE:6C92                 </span><span style="color:navy">add     di, cx          </span>; Point to NUL at end of string
<span style="color:black">DOSCODE:6C94                 </span><span style="color:navy">call    </span>SkipBack        ; Back up one element
<span style="color:black">DOSCODE:6C97                 </span><span style="color:navy">inc     di              </span>; Point to start of last element
<span style="color:black">DOSCODE:6C98                 </span><span style="color:navy">mov     ss:</span>SAVE_BX<span style="color:navy">, di  </span>; save for DOS_RENAME
<span style="color:black">DOSCODE:6C9D                 </span><span style="color:navy">call    </span>PackName        ; Transfer name from entry to ASCIZ tail.
<span style="color:black">DOSCODE:6CA0                 </span><span style="color:navy">pop     si              </span>; Get back entry pointers
<span style="color:black">DOSCODE:6CA1                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:6CA2                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:6CA3                 </span><span style="color:navy">push    si              </span>; Back on stack
<span style="color:black">DOSCODE:6CA4                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:6CA5                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:6CA6                 </span><span style="color:navy">push    es              </span>; (not necessary) ; 31/01/2024
<span style="color:black">DOSCODE:6CA7                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:6CA8                 </span><span style="color:navy">call    </span>ShCloseFile     ; Call far [JShare+(13*4)] ; 13 = ShCloseFile
<span style="color:black">DOSCODE:6CAC                 </span><span style="color:navy">cmp     </span>fShare<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:6CB1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">rdc_1
</span><span style="color:black">DOSCODE:6CB3                 </span><span style="color:navy">mov     word ptr </span>THISSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:6CB7                 </span><span style="color:navy">mov     word ptr </span>THISSFT<span style="color:navy">, di
</span><span style="color:black">DOSCODE:6CBB                 </span><span style="color:navy">jmp     short </span><span style="color:gray">rdc_2
</span><span style="color:black">DOSCODE:6CBD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6CBD
DOSCODE:6CBD </span><span style="color:gray">rdc_1</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6CBD                 </span><span style="color:navy">mov     word ptr </span>THISSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:black">DOSCODE:6CC1                 </span><span style="color:navy">mov     word ptr </span>THISSFT<span style="color:navy">, </span><span style="color:#ff8000">765h </span>; AUXSTACK-SF_ENTRY.size
<span style="color:black">DOSCODE:6CC1                                         </span>; RENAMEDMA+(384-59)
<span style="color:black">DOSCODE:6CC7
DOSCODE:6CC7 </span><span style="color:gray">rdc_2</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6CC7                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:6CC8                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:6CC9                 </span>assume es:nothing
<span style="color:black">DOSCODE:6CC9                 </span><span style="color:navy">xor     ah, ah          </span>; Indicate file to DOOPEN (high bit off)
<span style="color:black">DOSCODE:6CCB                 </span><span style="color:navy">call    </span>DOOPEN          ; Fill in SFT for share check
<span style="color:black">DOSCODE:6CCE                 </span><span style="color:navy">les     di, </span>THISSFT
<span style="color:black">DOSCODE:6CD2                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:#ff8000">10h </span>; [ES:DI+SF_ENTRY.sf_mode],SHARING_DENY_BOTH
<span style="color:black">DOSCODE:6CD2                                         </span>; requires exclusive access
<span style="color:black">DOSCODE:6CD8                 </span><span style="color:navy">mov     word ptr es:[di], </span><span style="color:#ff8000">1 </span>; [ES:DI+SF_ENTRY.sf_ref_count],1 ; Pretend open
<span style="color:black">DOSCODE:6CDD                 </span><span style="color:navy">call    </span>ShareEnter
<span style="color:black">DOSCODE:6CE0                 </span><span style="color:navy">jb      short </span><span style="color:gray">CheckDone
</span><span style="color:black">DOSCODE:6CE2                 </span><span style="color:navy">les     di, </span>THISSFT
<span style="color:black">DOSCODE:6CE6                 </span><span style="color:navy">mov     word ptr es:[di], </span><span style="color:#ff8000">0 </span>; [ES:DI+SF_ENTRY.sf_ref_count]
<span style="color:black">DOSCODE:6CE6                                         </span>; Pretend closed and free
<span style="color:black">DOSCODE:6CEB                 </span><span style="color:navy">call    </span>ShareEnd        ; Tell sharer we&#039;re done with THISSFT
<span style="color:black">DOSCODE:6CEE                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:6CEF
DOSCODE:6CEF </span><span style="color:gray">CheckDone</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6CEF                 </span><span style="color:navy">les     bp, </span>THISDPB
<span style="color:black">DOSCODE:6CF3                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:6CF4                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:6CF5                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:6CF6                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:6CF7                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:6CF8                 </span>assume ds:nothing
<span style="color:black">DOSCODE:6CF8                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6CF8 </span>REN_DEL_Check   <span style="color:black">endp
DOSCODE:6CF8
DOSCODE:6CF9
DOSCODE:6CF9 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:6CF9
DOSCODE:6CF9
DOSCODE:6CF9 </span>FastOpen_Delete <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6CF9
DOSCODE:6CF9 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:6D16 SIZE 0000000B BYTES
</span><span style="color:black">DOSCODE:6CF9
DOSCODE:6CF9                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:6CFA                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:6CFB                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:6CFC                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:6CFD                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:6CFE                 </span><span style="color:navy">mov     si, ss:</span>WFP_START ; ds:si points to path name
<span style="color:black">DOSCODE:6D03                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3           </span>; FONC_delete
<span style="color:black">DOSCODE:6D05                 </span><span style="color:navy">jmp     short </span>fastinvoke
<span style="color:black">DOSCODE:6D05 </span>FastOpen_Delete <span style="color:black">endp
DOSCODE:6D05
</span><span style="color:maroon">DOSCODE:6D07 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:6D07
DOSCODE:6D07 </span>FastOpen_Rename<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:6D07                 </span><span style="color:navy">pushf
</span><span style="color:maroon">DOSCODE:6D08                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:6D09                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:6D0A                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:6D0B                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:6D0C                 </span><span style="color:navy">mov     si, ss:</span>REN_WFP  ; ds:si--&gt;Path name addrs
<span style="color:maroon">DOSCODE:6D11                 </span><span style="color:navy">mov     di, offset </span>NAME1 ; FONC_Rename
<span style="color:maroon">DOSCODE:6D14                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:6D16 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR FastOpen_Update
</span><span style="color:black">DOSCODE:6D16 </span><span style="color:gray">;   ADDITIONAL PARENT FUNCTION FastOpen_Delete
</span><span style="color:black">DOSCODE:6D16
DOSCODE:6D16 </span>fastinvoke<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6D16                 </span><span style="color:navy">mov     bx, offset </span>FastTable_2
<span style="color:black">DOSCODE:6D19                 </span><span style="color:navy">call    dword ptr [bx]
</span><span style="color:black">DOSCODE:6D1B                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:6D1C                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:6D1D                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:6D1E                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:6D1F                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:6D20                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6D20 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR FastOpen_Update
</span><span style="color:black">DOSCODE:6D21
DOSCODE:6D21 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:6D21
DOSCODE:6D21
DOSCODE:6D21 </span>FastOpen_Update <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6D21
DOSCODE:6D21 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:6D16 SIZE 0000000B BYTES
</span><span style="color:black">DOSCODE:6D21
DOSCODE:6D21                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:6D22                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:6D23                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:6D24                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:6D25                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:6D26                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">4           </span>; FONC_update
<span style="color:black">DOSCODE:6D28                 </span><span style="color:navy">jmp     short </span>fastinvoke
<span style="color:black">DOSCODE:6D28 </span>FastOpen_Update <span style="color:black">endp
DOSCODE:6D28
DOSCODE:6D2A
DOSCODE:6D2A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:6D2A
DOSCODE:6D2A
DOSCODE:6D2A </span>Fast_Dispatch   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6D2A                 </span><span style="color:navy">mov     si, offset </span>FastTable_2
<span style="color:black">DOSCODE:6D2D                 </span><span style="color:navy">call    dword ptr ss:[si] </span>; CALL far [SS:SI]
<span style="color:black">DOSCODE:6D30                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6D30 </span>Fast_Dispatch   <span style="color:black">endp
DOSCODE:6D30
DOSCODE:6D31
DOSCODE:6D31 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:6D31
DOSCODE:6D31
DOSCODE:6D31 </span>DOS_RENAME      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6D31                 </span><span style="color:navy">call    </span>TestNet
<span style="color:black">DOSCODE:6D34                 </span><span style="color:navy">jnb     short </span><span style="color:gray">LOCAL_RENAME
</span><span style="color:black">DOSCODE:6D36                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1111h
</span><span style="color:black">DOSCODE:6D39                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - RENAME REMOTE FILE
<span style="color:black">DOSCODE:6D39                                         </span>; SS = DS = DOS CS, SDA first filename pointer = offset of fully-qualified old name
<span style="color:black">DOSCODE:6D39                                         </span>; SDA CDS pointer -&gt; current directory
<span style="color:black">DOSCODE:6D39                                         </span>; Return: CF set on error
<span style="color:black">DOSCODE:6D3B                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6D3C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6D3C
DOSCODE:6D3C </span><span style="color:gray">LOCAL_RENAME</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6D3C                 </span><span style="color:navy">call    </span>set_exerr_locus_disk
<span style="color:black">DOSCODE:6D3F                 </span><span style="color:navy">mov     si, ds:</span>WFP_START
<span style="color:black">DOSCODE:6D43                 </span><span style="color:navy">mov     di, ds:</span>REN_WFP
<span style="color:black">DOSCODE:6D47                 </span><span style="color:navy">mov     al, [si]
</span><span style="color:black">DOSCODE:6D49                 </span><span style="color:navy">mov     ah, [di]
</span><span style="color:black">DOSCODE:6D4B                 </span><span style="color:navy">or      ax, </span><span style="color:green">2020h       </span>; Lower case
<span style="color:black">DOSCODE:6D4E                 </span><span style="color:navy">cmp     al, ah
</span><span style="color:black">DOSCODE:6D50                 </span><span style="color:navy">jz      short </span><span style="color:gray">SAMEDRV
</span><span style="color:black">DOSCODE:6D52                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">11h         </span>; error_not_same_device
<span style="color:black">DOSCODE:6D55                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:6D56                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6D57 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6D57
DOSCODE:6D57 </span><span style="color:gray">SAMEDRV</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6D57                 </span><span style="color:navy">push    word ptr ds:</span>DMAADD<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:6D5B                 </span><span style="color:navy">push    word ptr ds:</span>DMAADD
<span style="color:black">DOSCODE:6D5F                 </span><span style="color:navy">mov     word ptr ds:</span>DMAADD<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:black">DOSCODE:6D63                 </span><span style="color:navy">mov     word ptr ds:</span>DMAADD<span style="color:navy">, offset </span>RENAMEDMA
<span style="color:black">DOSCODE:6D69                 </span><span style="color:navy">mov     ds:</span>FOUND_DEV<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; Rename fails on DEVS, assume not a dev
<span style="color:black">DOSCODE:6D6E                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:6D71                 </span><span style="color:navy">call    </span>DOS_SEARCH_FIRST ; Sets [NoSetDir] to 1,
<span style="color:black">DOSCODE:6D71                                         </span>; [CURBUF+2]:BX points to entry
<span style="color:black">DOSCODE:6D74                 </span><span style="color:navy">jnb     short </span><span style="color:gray">Check_Dev
</span><span style="color:black">DOSCODE:6D76                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">12h         </span>; error_no_more_files
<span style="color:black">DOSCODE:6D79                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GOTERR
</span><span style="color:black">DOSCODE:6D7B                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2           </span>; error_file_not_found
<span style="color:black">DOSCODE:6D7E
DOSCODE:6D7E </span><span style="color:gray">GOTERR</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6D7E                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:6D7F
DOSCODE:6D7F </span><span style="color:gray">RENAME_POP</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6D7F                 </span><span style="color:navy">pop     word ptr ds:</span>DMAADD
<span style="color:black">DOSCODE:6D83                 </span><span style="color:navy">pop     word ptr ds:</span>DMAADD<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:6D87                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:6D8A                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6D8B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6D8B
DOSCODE:6D8B </span><span style="color:gray">Check_Dev</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6D8B                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5           </span>; error_access_denied
<span style="color:black">DOSCODE:6D8E                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:6D8F                 </span><span style="color:navy">lds     si, ds:</span>DMAADD   ; check if source a dir
<span style="color:black">DOSCODE:6D93                 </span><span style="color:navy">add     si, </span><span style="color:green">21          </span>; find_buf.attr
<span style="color:black">DOSCODE:6D96                 </span><span style="color:navy">test    byte ptr [si+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], </span><span style="color:green">10h </span>; [SI+dir_entry.dir_attr],attr_directory
<span style="color:black">DOSCODE:6D9A                 </span><span style="color:navy">jz      short </span><span style="color:gray">notdir
</span><span style="color:black">DOSCODE:6D9C                 </span><span style="color:navy">mov     si, ds:</span>REN_WFP  ; if yes
<span style="color:black">DOSCODE:6DA0                 </span><span style="color:navy">call    </span>Check_PathLen2  ; make sure path length &lt; PATHNAMELEN (67)
<span style="color:black">DOSCODE:6DA3
DOSCODE:6DA3 </span><span style="color:gray">notdir</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6DA3                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:6DA4                 </span><span style="color:navy">ja      short </span><span style="color:gray">GOTERR
</span><span style="color:black">DOSCODE:6DA6                 </span><span style="color:navy">cmp     ds:</span>FOUND_DEV<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:6DAB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GOTERR
</span><span style="color:black">DOSCODE:6DAD                 </span><span style="color:navy">mov     si, bx
</span><span style="color:black">DOSCODE:6DAF                 </span><span style="color:navy">add     si, </span><span style="color:green">26          </span>; dir_entry.dir_first
<span style="color:black">DOSCODE:6DB2                 </span><span style="color:navy">call    </span>REN_DEL_Check
<span style="color:black">DOSCODE:6DB5                 </span><span style="color:navy">jnb     short </span><span style="color:gray">REN_OK1
</span><span style="color:black">DOSCODE:6DB7                 </span><span style="color:navy">mov     ax, </span><span style="color:green">20h         </span>; error_sharing_violation
<span style="color:black">DOSCODE:6DBA
DOSCODE:6DBA </span><span style="color:gray">RENAME_POPJ</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6DBA                 </span><span style="color:navy">jmp     short </span><span style="color:gray">RENAME_POP
</span><span style="color:black">DOSCODE:6DBC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6DBC
DOSCODE:6DBC </span><span style="color:gray">REN_OK1</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6DBC                 </span><span style="color:navy">lds     si, ds:</span>DMAADD
<span style="color:black">DOSCODE:6DC0                 </span><span style="color:navy">add     si, </span><span style="color:green">21          </span>; find_buf.attr
<span style="color:black">DOSCODE:6DC3                 </span><span style="color:navy">test    byte ptr [si+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], </span><span style="color:green">10h </span>; [SI+dir_entry.dir_attr],attr_directory
<span style="color:black">DOSCODE:6DC7                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SWAP_SOURCE
</span><span style="color:black">DOSCODE:6DC9                 </span><span style="color:navy">call    </span>FastOpen_Delete ; delete dir info in fastopen
<span style="color:black">DOSCODE:6DCC
DOSCODE:6DCC </span><span style="color:gray">SWAP_SOURCE</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6DCC                 </span><span style="color:navy">mov     ax, ds:</span>WFP_START ; Swap source and destination
<span style="color:black">DOSCODE:6DCF                 </span><span style="color:navy">mov     si, ds:</span>REN_WFP
<span style="color:black">DOSCODE:6DD3                 </span><span style="color:navy">mov     ds:</span>WFP_START<span style="color:navy">, si
</span><span style="color:black">DOSCODE:6DD7                 </span><span style="color:navy">mov     ds:</span>REN_WFP<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:6DDA                 </span><span style="color:navy">mov     ds:</span>CURR_DIR_END<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; -1 ; No current dir on dest
<span style="color:black">DOSCODE:6DE0                 </span><span style="color:navy">mov     word ptr ds:</span>CREATING<span style="color:navy">, </span><span style="color:green">0E5FFh </span>; DIRFREE*256+0FFh
<span style="color:black">DOSCODE:6DE0                                         </span>; Creating, not DEL *.*
<span style="color:black">DOSCODE:6DE6                 </span><span style="color:navy">call    </span>GetPathNoSet
<span style="color:black">DOSCODE:6DE9                 </span><span style="color:navy">jb      short </span><span style="color:gray">NODEST
</span><span style="color:black">DOSCODE:6DEB                 </span><span style="color:navy">or      ah, ah          </span>; Device?
<span style="color:black">DOSCODE:6DED                 </span><span style="color:navy">jns     short </span><span style="color:gray">SAVEDEST  </span>; No, continue
<span style="color:black">DOSCODE:6DEF
DOSCODE:6DEF </span><span style="color:gray">BAD_ACC</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6DEF                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5           </span>; error_access_denied
<span style="color:black">DOSCODE:6DF2                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:6DF3
DOSCODE:6DF3 </span><span style="color:gray">RENAME_CLEAN</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6DF3                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:6DF4                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:6DF5                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:6DF9                 </span><span style="color:navy">call    </span>update_fat32_fsinfo
<span style="color:black">DOSCODE:6DFC                 </span><span style="color:navy">mov     al, ds:</span>THISDRV
<span style="color:black">DOSCODE:6DFF                 </span><span style="color:navy">call    </span>FLUSHBUF
<span style="color:black">DOSCODE:6E02                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:6E03                 </span><span style="color:navy">cmp     ds:</span>FAILERR<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:6E08                 </span><span style="color:navy">jnz     short </span><span style="color:gray">BAD_ERR
</span><span style="color:black">DOSCODE:6E0A                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:6E0B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">RENAME_POPJ
</span><span style="color:black">DOSCODE:6E0D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6E0D
DOSCODE:6E0D </span><span style="color:gray">BAD_ERR</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6E0D                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:6E0E                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3           </span>; error_path_not_foun
<span style="color:black">DOSCODE:6E11                 </span><span style="color:navy">jmp     </span><span style="color:gray">GOTERR
</span><span style="color:black">DOSCODE:6E14 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6E14
DOSCODE:6E14 </span><span style="color:gray">NODEST</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6E14                 </span><span style="color:navy">jnz     short </span><span style="color:gray">BAD_PATH
</span><span style="color:black">DOSCODE:6E16                 </span><span style="color:navy">cmp     ds:</span>FAILERR<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:6E1B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">BAD_PATH  </span>; Search for dest failed
<span style="color:black">DOSCODE:6E1D                 </span><span style="color:navy">or      cl, cl
</span><span style="color:black">DOSCODE:6E1F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SAVEDEST
</span><span style="color:black">DOSCODE:6E21
DOSCODE:6E21 </span><span style="color:gray">BAD_PATH</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6E21                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:6E24                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:6E25                 </span><span style="color:navy">jmp     short </span><span style="color:gray">RENAME_POPJ
</span><span style="color:black">DOSCODE:6E27 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6E27
DOSCODE:6E27 </span><span style="color:gray">SAVEDEST</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6E27                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:6E28                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:6E29                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:6E29                 </span><span style="color:navy">mov     di, offset </span>NAME2
<span style="color:black">DOSCODE:6E2C                 </span><span style="color:navy">mov     si, offset </span>NAME1
<span style="color:black">DOSCODE:6E2F                 </span><span style="color:navy">mov     cx, </span><span style="color:green">11
</span><span style="color:black">DOSCODE:6E32                 </span><span style="color:navy">rep movsb               </span>; Save dest with metas at NAME2
<span style="color:black">DOSCODE:6E34                 </span><span style="color:navy">mov     ax, ds:</span>DIRSTART_HW
<span style="color:black">DOSCODE:6E37                 </span><span style="color:navy">mov     ds:</span>DESTSTART_HW<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:6E3A                 </span><span style="color:navy">mov     ax, ds:</span>DIRSTART
<span style="color:black">DOSCODE:6E3D                 </span><span style="color:navy">mov     ds:</span>DESTSTART<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:6E40
DOSCODE:6E40 </span><span style="color:gray">BUILDDEST</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6E40                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:6E41                 </span><span style="color:navy">pop     es              </span>; needed due to JMP BUILDDEST below
<span style="color:black">DOSCODE:6E42                 </span><span style="color:navy">mov     bx, (offset </span>RENAMEDMA<span style="color:navy">+</span><span style="color:green">15h</span><span style="color:navy">) </span>; Source of replace chars
<span style="color:black">DOSCODE:6E45                 </span><span style="color:navy">mov     di, offset </span>NAME1 ; Real dest name goes here
<span style="color:black">DOSCODE:6E48                 </span><span style="color:navy">mov     si, offset </span>NAME2 ; Raw dest
<span style="color:black">DOSCODE:6E4B                 </span><span style="color:navy">mov     cx, </span><span style="color:green">11
</span><span style="color:black">DOSCODE:6E4E                 </span><span style="color:navy">call    </span>NEW_RENAME      ; replace ? chars
<span style="color:black">DOSCODE:6E51                 </span><span style="color:navy">mov     ds:</span>ATTRIB<span style="color:navy">, </span><span style="color:#ff8000">16h  </span>; attr_all
<span style="color:black">DOSCODE:6E51                                         </span>; Stop duplicates with any attributes
<span style="color:black">DOSCODE:6E56                 </span><span style="color:navy">mov     ds:</span>CREATING<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:6E5B                 </span><span style="color:navy">call    </span>DEVNAME         ; Check if we built a device name
<span style="color:black">DOSCODE:6E5E                 </span><span style="color:navy">jnb     short </span><span style="color:gray">BAD_ACC
</span><span style="color:black">DOSCODE:6E60                 </span><span style="color:navy">mov     bx, ds:</span>DESTSTART_HW
<span style="color:black">DOSCODE:6E64                 </span><span style="color:navy">mov     ds:</span>ROOTCLUST_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:6E68                 </span><span style="color:navy">mov     bx, ds:</span>DESTSTART
<span style="color:black">DOSCODE:6E6C                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:6E70                 </span>assume es:nothing
<span style="color:black">DOSCODE:6E70                 </span><span style="color:navy">call    </span>SETDIRSRCH      ; Reset search to start of dir
<span style="color:black">DOSCODE:6E73                 </span><span style="color:navy">jb      short </span><span style="color:gray">BAD_ACCJ  </span>; Screw up
<span style="color:black">DOSCODE:6E75                 </span><span style="color:navy">call    </span>FINDENTRY       ; See if new name already exists
<span style="color:black">DOSCODE:6E78                 </span><span style="color:navy">jnb     short </span><span style="color:gray">BAD_ACCJ  </span>; Error if found
<span style="color:black">DOSCODE:6E7A                 </span><span style="color:navy">cmp     ds:</span>FAILERR<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:6E7F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">BAD_ACCJ  </span>; Find failed because user FAILed to I 24
<span style="color:black">DOSCODE:6E81                 </span><span style="color:navy">mov     ax, ds:</span>DESTSTART ; DIRSTART of dest
<span style="color:black">DOSCODE:6E84                 </span><span style="color:navy">mov     dx, ds:</span>DESTSTART_HW
<span style="color:black">DOSCODE:6E88                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:6E8C                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:bp+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:6E91                 </span><span style="color:navy">jnz     short </span><span style="color:gray">builddst_1 </span>; not FAT32
<span style="color:black">DOSCODE:6E93                 </span><span style="color:navy">cmp     dx, word ptr ds:</span>RENAMEDMA<span style="color:navy">+</span><span style="color:green">11h
</span><span style="color:black">DOSCODE:6E97                 </span><span style="color:navy">jnz     short </span><span style="color:gray">builddst_2
</span><span style="color:black">DOSCODE:6E99
DOSCODE:6E99 </span><span style="color:gray">builddst_1</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6E99                 </span><span style="color:navy">cmp     ax, word ptr ds:</span>RENAMEDMA<span style="color:navy">+</span><span style="color:green">0Fh </span>; DIRSTART_HW of source
<span style="color:black">DOSCODE:6E9D                 </span><span style="color:navy">jz      short </span><span style="color:gray">SIMPLE_RENAME </span>; If =, just give new name
<span style="color:black">DOSCODE:6E9F
DOSCODE:6E9F </span><span style="color:gray">builddst_2</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6E9F                 </span><span style="color:navy">mov     al, ds:</span>RENAMEDMA<span style="color:navy">+</span><span style="color:green">20h </span>; RENAMEDMA+21+dir_entry.dir_attr]
<span style="color:black">DOSCODE:6EA2                 </span><span style="color:navy">test    al, </span><span style="color:green">10h         </span>; attr_directory
<span style="color:black">DOSCODE:6EA4                 </span><span style="color:navy">jnz     short </span><span style="color:gray">BAD_ACCJ  </span>; Can only do a simple rename on dirs,
<span style="color:black">DOSCODE:6EA4                                         </span>; otherwise the . and .. entries get wiped.
<span style="color:black">DOSCODE:6EA6                 </span><span style="color:navy">mov     ds:</span>ATTRIB<span style="color:navy">, al
</span><span style="color:black">DOSCODE:6EA9                 </span><span style="color:navy">mov     word ptr ds:</span>THISSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:black">DOSCODE:6EAD                 </span><span style="color:navy">mov     si, (offset </span>RENAMEDMA<span style="color:navy">+</span><span style="color:green">145h</span><span style="color:navy">) </span>; AUXSTACK-SF_ENTRY.size
<span style="color:black">DOSCODE:6EAD                                         </span>; RENAMEDMA+325
<span style="color:black">DOSCODE:6EB0                 </span><span style="color:navy">mov     word ptr ds:</span>THISSFT<span style="color:navy">, si
</span><span style="color:black">DOSCODE:6EB4                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:#ff8000">2 </span>; [SI+SF_ENTRY.sf_mode],
<span style="color:black">DOSCODE:6EB4                                         </span>; SHARING_COMPAT+open_for_both
<span style="color:black">DOSCODE:6EB9                 </span><span style="color:navy">xor     cx, cx          </span>; Set &quot;device ID&quot; for call into makenode
<span style="color:black">DOSCODE:6EBB                 </span><span style="color:navy">call    </span>RENAME_MAKE     ; This is in mknode
<span style="color:black">DOSCODE:6EBE                 </span><span style="color:navy">jnb     short </span><span style="color:gray">GOT_DEST
</span><span style="color:black">DOSCODE:6EC0
DOSCODE:6EC0 </span><span style="color:gray">BAD_ACCJ</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6EC0                 </span><span style="color:navy">jmp     </span><span style="color:gray">BAD_ACC
</span><span style="color:black">DOSCODE:6EC3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6EC3
DOSCODE:6EC3 </span><span style="color:gray">GOT_DEST</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6EC3                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:6EC4                 </span><span style="color:navy">les     di, ds:</span>THISSFT  ; RENAME_MAKE entered this into sharing
<span style="color:black">DOSCODE:6EC8                 </span><span style="color:navy">call    </span>ShareEnd        ; we need to remove it.
<span style="color:black">DOSCODE:6ECB                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:6ECC                 </span><span style="color:navy">les     di, ds:</span>CURBUF
<span style="color:black">DOSCODE:6ED0                 </span><span style="color:navy">call    </span>SET_BUF_DIRTY
<span style="color:black">DOSCODE:6ED3                 </span><span style="color:navy">mov     di, bx
</span><span style="color:black">DOSCODE:6ED5                 </span><span style="color:navy">add     di, </span><span style="color:green">11          </span>; dir_entry.dir_attr ; skip name
<span style="color:black">DOSCODE:6ED8                 </span><span style="color:navy">mov     si, (offset </span>RENAMEDMA<span style="color:navy">+</span><span style="color:green">20h</span><span style="color:navy">) </span>; RENAMEDMA+21+dir_entry.dir_attr
<span style="color:black">DOSCODE:6EDB                 </span><span style="color:navy">mov     cx, </span><span style="color:green">21          </span>; dir_entry.size-dir_entry.dir_attr
<span style="color:black">DOSCODE:6EDE                 </span><span style="color:navy">rep movsb
</span><span style="color:black">DOSCODE:6EE0                 </span><span style="color:navy">call    </span>GET_SOURCE
<span style="color:black">DOSCODE:6EE3                 </span><span style="color:navy">jb      short </span><span style="color:gray">RENAME_OVER
</span><span style="color:black">DOSCODE:6EE5                 </span><span style="color:navy">mov     di, bx
</span><span style="color:black">DOSCODE:6EE7                 </span><span style="color:navy">mov     es, word ptr ds:</span>CURBUF<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:6EEB                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:6EEB                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0E5h        </span>; DIRFREE
<span style="color:black">DOSCODE:6EED                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:6EEE                 </span><span style="color:navy">jmp     short </span><span style="color:gray">DIRTY_IT
</span><span style="color:black">DOSCODE:6EF0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6EF0
DOSCODE:6EF0 </span><span style="color:gray">SIMPLE_RENAME</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6EF0                 </span><span style="color:navy">call    </span>GET_SOURCE
<span style="color:black">DOSCODE:6EF3                 </span><span style="color:navy">jb      short </span><span style="color:gray">RENAME_OVER
</span><span style="color:black">DOSCODE:6EF5                 </span><span style="color:navy">mov     di, bx
</span><span style="color:black">DOSCODE:6EF7                 </span><span style="color:navy">mov     es, word ptr ds:</span>CURBUF<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:6EFB                 </span>assume es:nothing
<span style="color:black">DOSCODE:6EFB                 </span><span style="color:navy">mov     si, offset </span>NAME1
<span style="color:black">DOSCODE:6EFE                 </span><span style="color:navy">mov     cx, </span><span style="color:green">11
</span><span style="color:black">DOSCODE:6F01                 </span><span style="color:navy">rep movsb
</span><span style="color:black">DOSCODE:6F03
DOSCODE:6F03 </span><span style="color:gray">DIRTY_IT</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6F03                 </span><span style="color:navy">mov     di, word ptr ds:</span>CURBUF
<span style="color:black">DOSCODE:6F07                 </span><span style="color:navy">call    </span>SET_BUF_DIRTY
<span style="color:black">DOSCODE:6F0A                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:6F0B                 </span><span style="color:navy">lds     si, ds:</span>DMAADD
<span style="color:black">DOSCODE:6F0F                 </span><span style="color:navy">add     si, </span><span style="color:green">21          </span>; find_buf.attr
<span style="color:black">DOSCODE:6F12                 </span><span style="color:navy">test    byte ptr [si+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], </span><span style="color:green">10h </span>; [SI+dir_entry.dir_attr],
<span style="color:black">DOSCODE:6F12                                         </span>; attr_directory
<span style="color:black">DOSCODE:6F16                 </span><span style="color:navy">jz      short </span><span style="color:gray">NOT_DIR2
</span><span style="color:black">DOSCODE:6F18                 </span><span style="color:navy">call    </span>FastOpen_Rename
<span style="color:black">DOSCODE:6F1B
DOSCODE:6F1B </span><span style="color:gray">NOT_DIR2</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6F1B                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:6F1C                 </span><span style="color:navy">mov     si, (offset </span>RENAMEDMA<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">)
</span><span style="color:black">DOSCODE:6F1F                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:6F22                 </span><span style="color:navy">mov     ds:</span>CREATING<span style="color:navy">, </span><span style="color:#ff8000">0  </span>; Correct setting for search
<span style="color:black">DOSCODE:6F27                 </span><span style="color:navy">call    </span>RENAME_NEXT
<span style="color:black">DOSCODE:6F2A                 </span><span style="color:navy">jb      short </span><span style="color:gray">RENAME_OVER
</span><span style="color:black">DOSCODE:6F2C                 </span><span style="color:navy">lea     si, [bx+</span><span style="color:#ff8000">1Ah</span><span style="color:navy">]    </span>; [BX+dir_entry.dir_first]
<span style="color:black">DOSCODE:6F2F                 </span><span style="color:navy">call    </span>REN_DEL_Check
<span style="color:black">DOSCODE:6F32                 </span><span style="color:navy">jnb     short </span><span style="color:gray">REN_OK2
</span><span style="color:black">DOSCODE:6F34                 </span><span style="color:navy">mov     ax, </span><span style="color:green">20h         </span>; error_sharing_violation
<span style="color:black">DOSCODE:6F37
DOSCODE:6F37 </span><span style="color:gray">jmp_to_rename_clean</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6F37                 </span><span style="color:navy">jmp     </span><span style="color:gray">RENAME_CLEAN
</span><span style="color:black">DOSCODE:6F3A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6F3A
DOSCODE:6F3A </span><span style="color:gray">REN_OK2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6F3A                 </span><span style="color:navy">mov     al, ds:</span>RENAMEDMA<span style="color:navy">+</span><span style="color:green">20h </span>; [RENAMEDMA+21+dir_entry.dir_attr]
<span style="color:black">DOSCODE:6F3D                 </span><span style="color:navy">test    al, </span><span style="color:green">10h         </span>; attr_directory
<span style="color:black">DOSCODE:6F3F                 </span><span style="color:navy">jz      short </span><span style="color:gray">Ren_Directory
</span><span style="color:black">DOSCODE:6F41                 </span><span style="color:navy">call    </span>FastOpen_Delete
<span style="color:black">DOSCODE:6F44
DOSCODE:6F44 </span><span style="color:gray">jmp_to_builddest</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6F44                 </span><span style="color:navy">jmp     </span><span style="color:gray">BUILDDEST
</span><span style="color:black">DOSCODE:6F47 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6F47
DOSCODE:6F47 </span><span style="color:gray">Ren_Directory</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6F47                 </span><span style="color:navy">call    </span>FastOpen_Rename
<span style="color:black">DOSCODE:6F4A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">jmp_to_builddest
</span><span style="color:black">DOSCODE:6F4C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6F4C
DOSCODE:6F4C </span><span style="color:gray">RENAME_OVER</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6F4C                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:6F4D                 </span><span style="color:navy">jmp     short </span><span style="color:gray">jmp_to_rename_clean
</span><span style="color:black">DOSCODE:6F4D </span>DOS_RENAME      <span style="color:black">endp
DOSCODE:6F4D
DOSCODE:6F4F
DOSCODE:6F4F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:6F4F
DOSCODE:6F4F
DOSCODE:6F4F </span>GET_SOURCE      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6F4F                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:6F53                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:6F55                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], bx </span>; DPB.FAT_SIZE &gt; 0 ?
<span style="color:black">DOSCODE:6F59                 </span><span style="color:navy">jnz     short </span><span style="color:gray">gs_cont   </span>; yes, it is not FAT32
<span style="color:black">DOSCODE:6F5B                 </span><span style="color:navy">mov     bx, word ptr ds:</span>RENAMEDMA<span style="color:navy">+</span><span style="color:green">11h </span>; DirStart+2
<span style="color:black">DOSCODE:6F5F
DOSCODE:6F5F </span><span style="color:gray">gs_cont</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6F5F                 </span><span style="color:navy">mov     ds:</span>ROOTCLUST_HW<span style="color:navy">, bx </span>; hw of cluster number
<span style="color:black">DOSCODE:6F63                 </span><span style="color:navy">mov     bx, word ptr ds:</span>RENAMEDMA<span style="color:navy">+</span><span style="color:green">0Fh </span>; DirStart
<span style="color:black">DOSCODE:6F67                 </span><span style="color:navy">call    </span>SETDIRSRCH
<span style="color:black">DOSCODE:6F6A                 </span><span style="color:navy">jb      short </span><span style="color:gray">gs_ret_label
</span><span style="color:black">DOSCODE:6F6C                 </span><span style="color:navy">call    </span>STARTSRCH
<span style="color:black">DOSCODE:6F6F                 </span><span style="color:navy">mov     ax, word ptr ds:</span>RENAMEDMA<span style="color:navy">+</span><span style="color:green">0Dh </span>; Lastent
<span style="color:black">DOSCODE:6F72                 </span><span style="color:navy">call    </span>GETENT
<span style="color:black">DOSCODE:6F75
DOSCODE:6F75 </span><span style="color:gray">gs_ret_label</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6F75                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6F75 </span>GET_SOURCE      <span style="color:black">endp
DOSCODE:6F75
DOSCODE:6F76
DOSCODE:6F76 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:6F76
DOSCODE:6F76
DOSCODE:6F76 </span>NEW_RENAME      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6F76                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:6F77                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">?&#039;         </span>; 3Fh
<span style="color:black">DOSCODE:6F79                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOCHG
</span><span style="color:black">DOSCODE:6F7B                 </span><span style="color:navy">mov     al, [bx]        </span>; Get replace char
<span style="color:black">DOSCODE:6F7D
DOSCODE:6F7D </span><span style="color:gray">NOCHG</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6F7D                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:6F7E                 </span><span style="color:navy">inc     bx              </span>; Next replace char
<span style="color:black">DOSCODE:6F7F                 </span><span style="color:navy">loop    </span>NEW_RENAME
<span style="color:black">DOSCODE:6F81                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6F81 </span>NEW_RENAME      <span style="color:black">endp
DOSCODE:6F81
DOSCODE:6F82
DOSCODE:6F82 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:6F82
DOSCODE:6F82
DOSCODE:6F82 </span>GET_FILE_INFO   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6F82                 </span><span style="color:navy">call    </span>TestNet
<span style="color:black">DOSCODE:6F85                 </span><span style="color:navy">jnb     short </span><span style="color:gray">LOCAL_INFO
</span><span style="color:black">DOSCODE:6F87                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">110Fh
</span><span style="color:black">DOSCODE:6F8A                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - GET REMOTE FILE&#039;S ATTRIBUTES
<span style="color:black">DOSCODE:6F8A                                         </span>; SS = DOS CS, SDA first filename pointer -&gt; fully-qualified name of file
<span style="color:black">DOSCODE:6F8A                                         </span>; SDA CDS pointer -&gt; current directory
<span style="color:black">DOSCODE:6F8A                                         </span>; Return: CF set on error, AX = file attributes
<span style="color:black">DOSCODE:6F8C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6F8D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6F8D
DOSCODE:6F8D </span><span style="color:gray">LOCAL_INFO</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6F8D                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:6F90                 </span><span style="color:navy">mov     ds:</span>NoSetDir<span style="color:navy">, </span><span style="color:#ff8000">1  </span>; if we find a dir, don&#039;t change to it
<span style="color:black">DOSCODE:6F95                 </span><span style="color:navy">call    </span>GET_FAST_PATH
<span style="color:black">DOSCODE:6F98                 </span><span style="color:navy">jnb     short </span><span style="color:gray">info_check_dev
</span><span style="color:black">DOSCODE:6F9A
DOSCODE:6F9A </span>NO_PATH<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6F9A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">bad_path1
</span><span style="color:black">DOSCODE:6F9C                 </span><span style="color:navy">or      cl, cl
</span><span style="color:black">DOSCODE:6F9E                 </span><span style="color:navy">jz      short </span><span style="color:gray">bad_path1
</span><span style="color:black">DOSCODE:6FA0
DOSCODE:6FA0 </span>info_no_file<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6FA0                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2           </span>; error_file_not_found
<span style="color:black">DOSCODE:6FA3
DOSCODE:6FA3 </span><span style="color:gray">BadRet</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6FA3                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:6FA4
DOSCODE:6FA4 </span><span style="color:gray">JustRet</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6FA4                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:6FA7                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6FA8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6FA8
DOSCODE:6FA8 </span><span style="color:gray">bad_path1</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6FA8                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3           </span>; error_path_not_found
<span style="color:black">DOSCODE:6FAB                 </span><span style="color:navy">jmp     short </span><span style="color:gray">BadRet
</span><span style="color:black">DOSCODE:6FAD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6FAD
DOSCODE:6FAD </span><span style="color:gray">info_check_dev</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6FAD                 </span><span style="color:navy">or      ah, ah
</span><span style="color:black">DOSCODE:6FAF                 </span><span style="color:navy">js      short </span>info_no_file ; device
<span style="color:black">DOSCODE:6FB1                 </span><span style="color:navy">cmp     word ptr ds:</span>CURBUF<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; -1 ; is it a root dir?
<span style="color:black">DOSCODE:6FB6                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_root  </span>; no, CurBuf ptr is valid
<span style="color:black">DOSCODE:6FB8                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:6FBA                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">10h         </span>; attr_directory
<span style="color:black">DOSCODE:6FBC                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:6FBD                 </span><span style="color:navy">jmp     short </span><span style="color:gray">JustRet
</span><span style="color:black">DOSCODE:6FBF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6FBF
DOSCODE:6FBF </span><span style="color:gray">not_root</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6FBF                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:6FC0                 </span><span style="color:navy">mov     ds, word ptr ds:</span>CURBUF<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:6FC4                 </span><span style="color:navy">mov     si, bx
</span><span style="color:black">DOSCODE:6FC6                 </span><span style="color:navy">xor     bx, bx          </span>; Assume size=0 (dir)
<span style="color:black">DOSCODE:6FC8                 </span><span style="color:navy">mov     di, bx
</span><span style="color:black">DOSCODE:6FCA                 </span><span style="color:navy">mov     cx, [si+</span><span style="color:#ff8000">16h</span><span style="color:navy">]    </span>; [SI+dir_entry.dir_time]
<span style="color:black">DOSCODE:6FCD                 </span><span style="color:navy">mov     dx, [si+</span><span style="color:#ff8000">18h</span><span style="color:navy">]    </span>; [SI+dir_entry.dir_date]
<span style="color:black">DOSCODE:6FD0                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:6FD2                 </span><span style="color:navy">mov     al, [si+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">]    </span>; [SI+dir_entry.dir_attr]
<span style="color:black">DOSCODE:6FD5                 </span><span style="color:navy">test    al, </span><span style="color:green">10h         </span>; attr_directory
<span style="color:black">DOSCODE:6FD7                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NO_SIZE
</span><span style="color:black">DOSCODE:6FD9                 </span><span style="color:navy">mov     di, [si+</span><span style="color:#ff8000">1Ch</span><span style="color:navy">]    </span>; [SI+dir_entry.dir_size_l]
<span style="color:black">DOSCODE:6FDC                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">1Eh</span><span style="color:navy">]    </span>; [SI+dir_entry.dir_size_h]
<span style="color:black">DOSCODE:6FDF
DOSCODE:6FDF </span><span style="color:gray">NO_SIZE</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6FDF                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:6FE0                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:6FE1
DOSCODE:6FE1 </span>OK_BYE<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6FE1                 </span><span style="color:navy">jmp     short </span><span style="color:gray">JustRet
</span><span style="color:black">DOSCODE:6FE1 </span>GET_FILE_INFO   <span style="color:black">endp
DOSCODE:6FE1
DOSCODE:6FE3
DOSCODE:6FE3 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:6FE3
DOSCODE:6FE3
DOSCODE:6FE3 </span>SET_FILE_ATTRIBUTE <span style="color:black">proc near            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6FE3                 </span><span style="color:navy">test    ax, </span><span style="color:green">0FFD8h      </span>; ~attr_changeable
<span style="color:black">DOSCODE:6FE6                 </span><span style="color:navy">jz      short </span><span style="color:gray">set_look
</span><span style="color:black">DOSCODE:6FE8
DOSCODE:6FE8 </span><span style="color:gray">_BAD_ACC</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6FE8                 </span><span style="color:navy">call    </span>set_exerr_locus_unk
<span style="color:black">DOSCODE:6FEB                 </span><span style="color:navy">mov     ds:</span>EXTERR_CLASS<span style="color:navy">, </span><span style="color:#ff8000">7 </span>; errCLASS_Apperr
<span style="color:black">DOSCODE:6FF0                 </span><span style="color:navy">mov     ds:</span>EXTERR_ACTION<span style="color:navy">, </span><span style="color:#ff8000">4 </span>; errACT_Abort
<span style="color:black">DOSCODE:6FF5                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5           </span>; error_access_denied
<span style="color:black">DOSCODE:6FF8                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:6FF9                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:6FFA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:6FFA
DOSCODE:6FFA </span><span style="color:gray">set_look</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:6FFA                 </span><span style="color:navy">call    </span>TestNet
<span style="color:black">DOSCODE:6FFD                 </span><span style="color:navy">jnb     short </span><span style="color:gray">LOCAL_SET
</span><span style="color:black">DOSCODE:6FFF                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:7000                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">110Eh
</span><span style="color:black">DOSCODE:7003                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - SET REMOTE FILE&#039;S ATTRIBUTES
<span style="color:black">DOSCODE:7003                                         </span>; SS = DOS CS, SDA first filename pointer -&gt; fully-qualified name of file
<span style="color:black">DOSCODE:7003                                         </span>; SDA CDS pointer -&gt; current directory
<span style="color:black">DOSCODE:7003                                         </span>; STACK: WORD new file attributes
<span style="color:black">DOSCODE:7003                                         </span>; Return: CF set on error
<span style="color:black">DOSCODE:7005                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:7006                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7007 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7007
DOSCODE:7007 </span><span style="color:gray">LOCAL_SET</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7007                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:700A                 </span><span style="color:navy">push    ax              </span>; Save new attributes
<span style="color:black">DOSCODE:700B                 </span><span style="color:navy">mov     ds:</span>NoSetDir<span style="color:navy">, </span><span style="color:#ff8000">1  </span>; if we find a dir, don&#039;t change to it
<span style="color:black">DOSCODE:7010                 </span><span style="color:navy">call    </span>GETPATH
<span style="color:black">DOSCODE:7013                 </span><span style="color:navy">jnb     short </span><span style="color:gray">set_check_device
</span><span style="color:black">DOSCODE:7015                 </span><span style="color:navy">pop     bx              </span>; Clean stack (don&#039;t zap AX)
<span style="color:black">DOSCODE:7016                 </span><span style="color:navy">jmp     short </span>NO_PATH
<span style="color:black">DOSCODE:7018 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7018
DOSCODE:7018 </span><span style="color:gray">set_check_device</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7018                 </span><span style="color:navy">or      ah, ah
</span><span style="color:black">DOSCODE:701A                 </span><span style="color:navy">jns     short </span><span style="color:gray">set_check_share
</span><span style="color:black">DOSCODE:701C                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:701D                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:7020                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_BAD_ACC  </span>; device
<span style="color:black">DOSCODE:7022 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7022
DOSCODE:7022 </span><span style="color:gray">set_check_share</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7022                 </span><span style="color:navy">pop     ax              </span>; Get new attributes
<span style="color:black">DOSCODE:7023                 </span><span style="color:navy">cmp     word ptr ds:</span>CURBUF<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; -1 ; is this the root dir
<span style="color:black">DOSCODE:7028                 </span><span style="color:navy">jz      short </span><span style="color:gray">cannot_set_root </span>; return error
<span style="color:black">DOSCODE:702A                 </span><span style="color:navy">call    </span>REN_DEL_Check
<span style="color:black">DOSCODE:702D                 </span><span style="color:navy">jnb     short </span><span style="color:gray">set_do
</span><span style="color:black">DOSCODE:702F                 </span><span style="color:navy">mov     ax, </span><span style="color:green">20h         </span>; error_sharing_violation
<span style="color:black">DOSCODE:7032
DOSCODE:7032 </span><span style="color:gray">jmp_to_OK_BYE</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7032                 </span><span style="color:navy">jmp     short </span>OK_BYE
<span style="color:black">DOSCODE:7034 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7034
DOSCODE:7034 </span><span style="color:gray">cannot_set_root</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7034                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5           </span>; error_access_denied
<span style="color:black">DOSCODE:7037                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:7038                 </span><span style="color:navy">jmp     short </span>OK_BYE
<span style="color:black">DOSCODE:703A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:703A
DOSCODE:703A </span><span style="color:gray">set_do</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:703A                 </span><span style="color:navy">les     di, ds:</span>CURBUF
<span style="color:black">DOSCODE:703E                 </span><span style="color:navy">and     byte ptr es:[bx+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], </span><span style="color:green">0D8h </span>; [ES:BX+dir_entry.dir_attr],
<span style="color:black">DOSCODE:703E                                         </span>; ~attr_changeable
<span style="color:black">DOSCODE:7043                 </span><span style="color:navy">or      es:[bx+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], al
</span><span style="color:black">DOSCODE:7047                 </span><span style="color:navy">call    </span>SET_BUF_DIRTY
<span style="color:black">DOSCODE:704A                 </span><span style="color:navy">mov     al, ds:</span>THISDRV
<span style="color:black">DOSCODE:704D                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:704E                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:704F                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0           </span>; dir entry update
<span style="color:black">DOSCODE:7051                 </span><span style="color:navy">mov     dl, al          </span>; drive number A=0,B=1,,
<span style="color:black">DOSCODE:7053                 </span><span style="color:navy">mov     di, bx
</span><span style="color:black">DOSCODE:7055                 </span><span style="color:navy">call    </span>FastOpen_Update
<span style="color:black">DOSCODE:7058                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:7059                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:705A                 </span><span style="color:navy">call    </span>FLUSHBUF
<span style="color:black">DOSCODE:705D                 </span><span style="color:navy">jnb     short </span><span style="color:gray">jmp_to_OK_BYE
</span><span style="color:black">DOSCODE:705F                 </span><span style="color:navy">jmp     </span>info_no_file
<span style="color:black">DOSCODE:705F </span>SET_FILE_ATTRIBUTE <span style="color:black">endp
DOSCODE:705F
DOSCODE:7062
DOSCODE:7062 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7062
DOSCODE:7062
DOSCODE:7062 </span>GET_FAST_PATH   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7062                 </span><span style="color:navy">or      ss:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">1 </span>; FastOpen_Set
<span style="color:black">DOSCODE:7068                 </span><span style="color:navy">call    </span>GETPATH
<span style="color:black">DOSCODE:706B                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:706C                 </span><span style="color:navy">and     ss:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">80h </span>; Fast_yes
<span style="color:black">DOSCODE:7072                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:7073                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7073 </span>GET_FAST_PATH   <span style="color:black">endp
DOSCODE:7073
DOSCODE:7074
DOSCODE:7074 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7074
DOSCODE:7074
DOSCODE:7074 </span>DOS_DUP         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7074                 </span><span style="color:navy">mov     es, cs:</span>DosDSeg
<span style="color:black">DOSCODE:7079                 </span><span style="color:navy">les     di, es:</span>THISSFT
<span style="color:black">DOSCODE:707E
DOSCODE:707E </span>DOS_Dup_Direct<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:707E                 </span><span style="color:navy">call    </span>IsSFTNet
<span style="color:black">DOSCODE:7081                 </span><span style="color:navy">jnz     short </span><span style="color:gray">DO_INC
</span><span style="color:black">DOSCODE:7083                 </span><span style="color:navy">call    </span>DEV_OPEN_SFT
<span style="color:black">DOSCODE:7086
DOSCODE:7086 </span><span style="color:gray">DO_INC</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7086                 </span><span style="color:navy">inc     word ptr es:[di] </span>; [ES:DI+SF_ENTRY.sf_ref_count]
<span style="color:black">DOSCODE:7089                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7089 </span>DOS_DUP         <span style="color:black">endp
DOSCODE:7089
</span><span style="color:maroon">DOSCODE:708A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:708A
DOSCODE:708A </span>DOS_CREATE<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:708A                 </span><span style="color:navy">xor     ah, ah          </span>; 0 ; Truncate is OK
<span style="color:maroon">DOSCODE:708C
DOSCODE:708C </span>Create_inter<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:708C                 </span><span style="color:navy">test    al, </span><span style="color:green">80h         </span>; ~(attr_all+attr_ignore+attr_volume_id)
<span style="color:maroon">DOSCODE:708E                 </span><span style="color:navy">jnz     short </span>AttErr
<span style="color:maroon">DOSCODE:7090                 </span><span style="color:navy">test    al, </span><span style="color:green">8           </span>; attr_volume_id
<span style="color:maroon">DOSCODE:7092                 </span><span style="color:navy">jz      short </span>NoReset
<span style="color:maroon">DOSCODE:7094                 </span><span style="color:navy">or      byte ptr ds:</span>DOS34_FLAG<span style="color:navy">, </span><span style="color:green">80h </span>; DBCS_VOLID
<span style="color:maroon">DOSCODE:7099                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">8           </span>; attr_volume_id
<span style="color:maroon">DOSCODE:709B
DOSCODE:709B </span>NoReset<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:709B                 </span><span style="color:navy">or      al, </span><span style="color:green">20h         </span>; attr_archive ; File changed
<span style="color:maroon">DOSCODE:709D                 </span><span style="color:navy">test    al, </span><span style="color:green">50h         </span>; attr_directory+attr_device
<span style="color:maroon">DOSCODE:709F                 </span><span style="color:navy">jz      short </span>ATT_OK
<span style="color:maroon">DOSCODE:70A1
DOSCODE:70A1 </span>AttErr<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:70A1                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5           </span>; Attribute problem
<span style="color:maroon">DOSCODE:70A4                 </span><span style="color:navy">call    </span>set_exerr_locus_unk ; MOV byte [EXTERR_LOCUS],errLOC_Unk ; 1
<span style="color:maroon">DOSCODE:70A7                 </span><span style="color:navy">jmp     short </span>SET_MKND_ERR ; Gotta use MKDIR to make dirs,
<span style="color:maroon">DOSCODE:70A7                                         </span>; NEVER allow attr_device to be set
<span style="color:maroon">DOSCODE:70A9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:70A9
DOSCODE:70A9 </span>ATT_OK<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:70A9                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:maroon">DOSCODE:70AD                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:70AE                 </span><span style="color:navy">les     si, ds:</span>THISCDS
<span style="color:maroon">DOSCODE:70B2                 </span><span style="color:navy">cmp     si, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:maroon">DOSCODE:70B5                 </span><span style="color:navy">jnz     short </span>TEST_RE_NET
<span style="color:maroon">DOSCODE:70B7                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:70B8                 </span><span style="color:navy">test    ds:</span>EXTOPEN_ON<span style="color:navy">, </span><span style="color:green">1 </span>; EXT_OPEN_ON  ; extended open ?
<span style="color:maroon">DOSCODE:70BD                 </span><span style="color:navy">jz      short </span>NOEXTOP   ; no, do normal
<span style="color:maroon">DOSCODE:70BF
DOSCODE:70BF </span>IFS_extopen<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:70BF                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:70C0                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">112Eh       </span>; (MultNET SHL 8) OR 46
<span style="color:maroon">DOSCODE:70C3
DOSCODE:70C3 </span>NOEXTOP2<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:70C3                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - DOS 4 IFSFUNC.EXE - ???
<span style="color:maroon">DOSCODE:70C3                                         </span>; SS = DS = DOS CS, STACK: WORD ??? low byte = ???
<span style="color:maroon">DOSCODE:70C3                                         </span>; Return: CF set on error
<span style="color:maroon">DOSCODE:70C3                                         </span>; CF clear if successful
<span style="color:maroon">DOSCODE:70C5                 </span><span style="color:navy">pop     bx              </span>; (BX is trashed anyway)
<span style="color:maroon">DOSCODE:70C6                 </span><span style="color:navy">mov     ds:</span>EXTOPEN_ON<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:70CB                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:70CC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:70CC
DOSCODE:70CC </span>NOEXTOP<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:70CC                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:70CD                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1118h       </span>; Multiplex - NETWORK REDIRECTOR - CREATE/TRUNCATE FILE
<span style="color:maroon">DOSCODE:70CD                                         </span>; ES:DI -&gt; uninitialized SFT, SS = DOS CS
<span style="color:maroon">DOSCODE:70CD                                         </span>; SDA first filename pointer -&gt; fully-qualified name of file
<span style="color:maroon">DOSCODE:70CD                                         </span>; STACK: WORD file creation mode???
<span style="color:maroon">DOSCODE:70D0                 </span><span style="color:navy">jmp     short </span>NOEXTOP2
<span style="color:maroon">DOSCODE:70D2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:70D2
DOSCODE:70D2 </span>TEST_RE_NET<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:70D2                 </span><span style="color:navy">test    byte ptr es:[si+</span><span style="color:#ff8000">44h</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:SI+curdir.flags+1],curdir_isnet&gt;&gt;8
<span style="color:maroon">DOSCODE:70D7                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:70D8                 </span><span style="color:navy">jz      short </span>LOCAL_CREATE
<span style="color:maroon">DOSCODE:70DA                 </span><span style="color:navy">call    </span>Set_EXT_mode
<span style="color:maroon">DOSCODE:70DD                 </span><span style="color:navy">jb      short </span>dochk
<span style="color:maroon">DOSCODE:70DF                 </span><span style="color:navy">or      word ptr es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">2 </span>; [ES:DI+SF_ENTRY.sf_mode],SHARING_COMPAT+open_for_both
<span style="color:maroon">DOSCODE:70E4
DOSCODE:70E4 </span>dochk<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:70E4                 </span><span style="color:navy">test    ds:</span>EXTOPEN_ON<span style="color:navy">, </span><span style="color:green">1 </span>; EXT_OPEN_ON
<span style="color:maroon">DOSCODE:70E9                 </span><span style="color:navy">jnz     short </span>IFS_extopen
<span style="color:maroon">DOSCODE:70EB                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:70EC                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1117h       </span>; Multiplex - NETWORK REDIRECTOR - CREATE/TRUNCATE REMOTE FILE
<span style="color:maroon">DOSCODE:70EC                                         </span>; ES:DI -&gt; uninitialized SFT, SS = DOS CS
<span style="color:maroon">DOSCODE:70EC                                         </span>; SDA first filename pointer -&gt; fully-qualified name of file to open
<span style="color:maroon">DOSCODE:70EC                                         </span>; SDA CDS pointer -&gt; current directory
<span style="color:maroon">DOSCODE:70EC                                         </span>; Return: CF set on error
<span style="color:maroon">DOSCODE:70EF                 </span><span style="color:navy">jmp     short </span>NOEXTOP2
<span style="color:maroon">DOSCODE:70F1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:70F1
DOSCODE:70F1 </span>LOCAL_CREATE<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:70F1                 </span><span style="color:navy">call    </span>Set_EXT_mode
<span style="color:maroon">DOSCODE:70F4                 </span><span style="color:navy">jb      short </span>setdone
<span style="color:maroon">DOSCODE:70F6                 </span><span style="color:navy">or      word ptr es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">2 </span>; [ES:DI+SF_ENTRY.sf_mode],SHARING_COMPAT+open_for_both
<span style="color:maroon">DOSCODE:70FB
DOSCODE:70FB </span>setdone<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:70FB                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:maroon">DOSCODE:70FE                 </span><span style="color:navy">call    </span>MakeNode
<span style="color:maroon">DOSCODE:7101                 </span><span style="color:navy">jnb     short </span>Create_ok
<span style="color:maroon">DOSCODE:7103                 </span><span style="color:navy">mov     ds:</span>VOLCHNG_FLAG<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; -1
<span style="color:maroon">DOSCODE:7108                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:710B </span><span style="color:gray">; START OF FUNCTION CHUNK FOR DOS_MKDIR
</span><span style="color:black">DOSCODE:710B
DOSCODE:710B </span>SET_MKND_ERR<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:710B                 </span><span style="color:navy">mov     bx, offset </span>CRTERRTAB
<span style="color:black">DOSCODE:710E                 </span><span style="color:navy">xlat    byte ptr cs:[bx]
</span><span style="color:black">DOSCODE:7110                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:7111                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7111 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR DOS_MKDIR
</span><span style="color:black">DOSCODE:7111 </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSCODE:7112 </span>CRTERRTAB       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:7113                 </span><span style="color:navy">db </span><span style="color:#008040">5                    </span>; error_access_denied ; MakeNode error 1
<span style="color:gray">DOSCODE:7114                 </span><span style="color:navy">db </span><span style="color:#008040">52h                  </span>; error_cannot_make
<span style="color:gray">DOSCODE:7115                 </span><span style="color:navy">db </span><span style="color:#008040">50h                  </span>; error_file_exists
<span style="color:gray">DOSCODE:7116                 </span><span style="color:navy">db </span><span style="color:#008040">3                    </span>; error_path_not_found
<span style="color:gray">DOSCODE:7117                 </span><span style="color:navy">db </span><span style="color:#008040">5                    </span>; error_access_denied
<span style="color:gray">DOSCODE:7118                 </span><span style="color:navy">db </span><span style="color:#008040">20h                  </span>; error_sharing_violation ; MakeNode error 6
<span style="color:gray">DOSCODE:7119                 </span><span style="color:navy">db </span><span style="color:#008040">2                    </span>; error_file_not_found ; MakeNode error 7
<span style="color:maroon">DOSCODE:711A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:711A
DOSCODE:711A </span>Create_ok<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:711A                 </span><span style="color:navy">call    </span>FastOpen_Delete
<span style="color:maroon">DOSCODE:711D                 </span><span style="color:navy">mov     al, ds:</span>SATTRIB
<span style="color:maroon">DOSCODE:7120                 </span><span style="color:navy">test    al, </span><span style="color:green">8           </span>; attr_volume_id
<span style="color:maroon">DOSCODE:7122                 </span><span style="color:navy">jz      short </span>NoVolLabel
<span style="color:maroon">DOSCODE:7124                 </span><span style="color:navy">les     di, ds:</span>THISCDS
<span style="color:maroon">DOSCODE:7128                 </span><span style="color:navy">mov     ah, es:[di]     </span>; [ES:DI+curdir.text] ; get drive letter
<span style="color:maroon">DOSCODE:712B                 </span><span style="color:navy">sub     ah, </span><span style="color:#ff8000">41h </span><span style="color:gray">; &#039;A&#039;   </span>; convert to drive number
<span style="color:maroon">DOSCODE:712E                 </span><span style="color:navy">mov     ds:</span>VOLCHNG_FLAG<span style="color:navy">, ah </span>; Set flag to indicate volid change
<span style="color:maroon">DOSCODE:7132                 </span><span style="color:navy">mov     bh, </span><span style="color:#ff8000">1           </span>; set volume id to boot record
<span style="color:maroon">DOSCODE:7134                 </span><span style="color:navy">call    </span>Set_Media_ID
<span style="color:maroon">DOSCODE:7137                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:maroon">DOSCODE:713A                 </span><span style="color:navy">call    </span>FATREAD_CDS     ; force a media check
<span style="color:maroon">DOSCODE:713D                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:maroon">DOSCODE:7140
DOSCODE:7140 </span>NoVolLabel<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7140                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2
</span><span style="color:maroon">DOSCODE:7143                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:maroon">DOSCODE:7147                 </span><span style="color:navy">call    ds:</span>ShSU         ; call far [JShare+(14*4)] ; 14 = ShSU
<span style="color:maroon">DOSCODE:714B                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:maroon">DOSCODE:714E                 </span><span style="color:navy">jmp     </span>SET_SFT_MODE
<span style="color:maroon">DOSCODE:7151 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:7151
DOSCODE:7151 </span>DOS_Create_New<span style="color:navy">:                         </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:7151                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:7153                 </span><span style="color:navy">jmp     </span>Create_inter
<span style="color:black">DOSCODE:7156
DOSCODE:7156 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7156
DOSCODE:7156
DOSCODE:7156 </span>Set_Media_ID    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7156                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:7157                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:7158                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:7159                 </span><span style="color:navy">inc     ah
</span><span style="color:black">DOSCODE:715B                 </span><span style="color:navy">mov     bl, ah
</span><span style="color:black">DOSCODE:715D                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Dh         </span>; generic IOCTL
<span style="color:black">DOSCODE:715F                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4866h       </span>; ch = FAT32 disk drive (CATEGORY CODE)
<span style="color:black">DOSCODE:715F                                         </span>; cl = minor code,
<span style="color:black">DOSCODE:715F                                         </span>;      get volume serial number (and name)
<span style="color:black">DOSCODE:7162                 </span><span style="color:navy">mov     dx, offset </span>FAKE_STACK_2F ; Packet_Temp
<span style="color:black">DOSCODE:7165
DOSCODE:7165 </span><span style="color:gray">Set_Media_ID_1</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7165                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:7166                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:7167                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:7168                 </span><span style="color:navy">xor     bh, bh
</span><span style="color:black">DOSCODE:716A                 </span><span style="color:navy">call    </span>$IOCTL
<span style="color:black">DOSCODE:716D                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:716E                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:716F                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:7170                 </span><span style="color:navy">jnb     short </span><span style="color:gray">Set_Media_ID_2
</span><span style="color:black">DOSCODE:7172                 </span><span style="color:navy">cmp     ch, </span><span style="color:green">48h         </span>; is it FAT32 disk drive request?
<span style="color:black">DOSCODE:7175                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:7176                 </span><span style="color:navy">jnz     short </span><span style="color:gray">geterr    </span>; (ch=8 request failed!)
<span style="color:black">DOSCODE:7178                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">8           </span>; set category code for (old) FAT disk drive
<span style="color:black">DOSCODE:7178                                         </span>; (except FAT32)
<span style="color:black">DOSCODE:717A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">Set_Media_ID_1 </span>; and try again
<span style="color:black">DOSCODE:717C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:717C
DOSCODE:717C </span><span style="color:gray">Set_Media_ID_2</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:717C                 </span><span style="color:navy">or      bh, bh
</span><span style="color:black">DOSCODE:717E                 </span><span style="color:navy">jz      short </span><span style="color:gray">NoName
</span><span style="color:black">DOSCODE:7180                 </span><span style="color:navy">mov     si, offset </span>NAME1
<span style="color:black">DOSCODE:7183                 </span><span style="color:navy">jmp     short </span><span style="color:gray">doset
</span><span style="color:black">DOSCODE:7185 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7185
DOSCODE:7185 </span><span style="color:gray">NoName</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7185                 </span><span style="color:navy">mov     si, offset </span>NO_NAME_ID <span style="color:gray">; &quot;NO NAME    &quot;
</span><span style="color:black">DOSCODE:7188
DOSCODE:7188 </span><span style="color:gray">doset</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7188                 </span><span style="color:navy">mov     di, dx
</span><span style="color:black">DOSCODE:718A                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">6           </span>; MEDIA_ID_INFO.MEDIA_Label
<span style="color:black">DOSCODE:718D                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:718E                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:718F                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:718F                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:7190                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:7191                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:7191                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:7192                 </span><span style="color:navy">mov     cx, </span><span style="color:green">11
</span><span style="color:black">DOSCODE:7195                 </span><span style="color:navy">rep movsb
</span><span style="color:black">DOSCODE:7197                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:7198                 </span><span style="color:navy">mov     cl, </span><span style="color:green">46h         </span>; set volume serial number (and name)
<span style="color:black">DOSCODE:719A                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Dh         </span>; generic IOCTL
<span style="color:black">DOSCODE:719C                 </span><span style="color:navy">xor     bh, bh
</span><span style="color:black">DOSCODE:719E                 </span><span style="color:navy">call    </span>$IOCTL
<span style="color:black">DOSCODE:71A1
DOSCODE:71A1 </span><span style="color:gray">geterr</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:71A1                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:71A2                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:71A3                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:71A4                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:71A5                 </span>assume es:nothing
<span style="color:black">DOSCODE:71A5                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:71A6                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:71A6 </span>Set_Media_ID    <span style="color:black">endp
DOSCODE:71A6
DOSCODE:71A7
DOSCODE:71A7 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:71A7
DOSCODE:71A7
DOSCODE:71A7 </span>Set_EXT_mode    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:71A7                 </span><span style="color:navy">test    ss:</span>EXTOPEN_ON<span style="color:navy">, </span><span style="color:green">1 </span>; EXT_OPEN_ON ; from extended open
<span style="color:black">DOSCODE:71AD                 </span><span style="color:navy">jz      short </span><span style="color:gray">NOTEX     </span>; no, do normal
<span style="color:black">DOSCODE:71AF                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:71B0                 </span><span style="color:navy">mov     ax, ss:</span>SAVE_BX
<span style="color:black">DOSCODE:71B4                 </span><span style="color:navy">or      es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], ax   </span>; [ES:DI+SF_ENTRY.sf_mode]
<span style="color:black">DOSCODE:71B8                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:71B9                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:71BA
DOSCODE:71BA </span><span style="color:gray">NOTEX</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:71BA                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:71BA </span>Set_EXT_mode    <span style="color:black">endp
DOSCODE:71BA
</span><span style="color:maroon">DOSCODE:71BB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:71BB
DOSCODE:71BB </span>DOS_OPEN<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:71BB                 </span><span style="color:navy">mov     </span>NoSetDir<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:71C0                 </span><span style="color:navy">call    </span>Check_Access_AX
<span style="color:maroon">DOSCODE:71C3                 </span><span style="color:navy">jb      short </span>do_ret_label
<span style="color:maroon">DOSCODE:71C5                 </span><span style="color:navy">les     di, </span>THISSFT
<span style="color:maroon">DOSCODE:71C9                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:maroon">DOSCODE:71CB                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], al   </span>; [ES:DI+SF_ENTRY.sf_mode]
<span style="color:maroon">DOSCODE:71CF                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:71D0                 </span><span style="color:navy">les     si, </span>THISCDS
<span style="color:maroon">DOSCODE:71D4                 </span><span style="color:navy">cmp     si, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:maroon">DOSCODE:71D7                 </span><span style="color:navy">jnz     short </span>TEST_RE_NET1
<span style="color:maroon">DOSCODE:71D9                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:71DA                 </span><span style="color:navy">test    </span>EXTOPEN_ON<span style="color:navy">, </span><span style="color:green">1   </span>; EXT_OPEN_ON
<span style="color:maroon">DOSCODE:71DF                 </span><span style="color:navy">jz      short </span>_NOEXTOP  ; do normal
<span style="color:maroon">DOSCODE:71E1
DOSCODE:71E1 </span>_IFS_extopen<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:71E1                 </span><span style="color:navy">mov     al, byte ptr </span>SAVE_BX
<span style="color:maroon">DOSCODE:71E4                 </span><span style="color:navy">push    ax              </span>; pass create attr to IFS
<span style="color:maroon">DOSCODE:71E5                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">112Eh       </span>; (MultNET*256)+46
<span style="color:maroon">DOSCODE:71E8                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - DOS 4 IFSFUNC.EXE - ???
<span style="color:maroon">DOSCODE:71E8                                         </span>; SS = DS = DOS CS, STACK: WORD ??? low byte = ???
<span style="color:maroon">DOSCODE:71E8                                         </span>; Return: CF set on error
<span style="color:maroon">DOSCODE:71E8                                         </span>; CF clear if successful
<span style="color:maroon">DOSCODE:71EA                 </span><span style="color:navy">pop     bx              </span>; trash bx
<span style="color:maroon">DOSCODE:71EB
DOSCODE:71EB </span>do_ret_label<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:71EB                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:71EC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:71EC
DOSCODE:71EC </span>_NOEXTOP<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:71EC                 </span><span style="color:navy">test    </span>DOS_FLAG<span style="color:navy">, </span><span style="color:green">1     </span>; EXECOPEN
<span style="color:maroon">DOSCODE:71F1                 </span><span style="color:navy">jz      short </span>not_exec_open
<span style="color:maroon">DOSCODE:71F3                 </span><span style="color:navy">test    byte ptr </span>DOS34_FLAG<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:green">8 </span>; (EXEC_AWARE_REDIR&gt;&gt;8)
<span style="color:maroon">DOSCODE:71F8                 </span><span style="color:navy">jz      short </span>not_exec_open
<span style="color:maroon">DOSCODE:71FA                 </span><span style="color:navy">mov     al, </span><span style="color:green">23h         </span>; SHARING_DENY_WRITE+EXEC_OPEN
<span style="color:maroon">DOSCODE:71FC
DOSCODE:71FC </span>not_exec_open<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:71FC                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:71FD                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1116h
</span><span style="color:maroon">DOSCODE:7200                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - OPEN EXISTING REMOTE FILE
<span style="color:maroon">DOSCODE:7200                                         </span>; ES:DI -&gt; uninitialized SFT, SS = DOS CS
<span style="color:maroon">DOSCODE:7200                                         </span>; SDA first filename pointer -&gt; fully-qualified name of file to open
<span style="color:maroon">DOSCODE:7200                                         </span>; STACK: WORD file open mode
<span style="color:maroon">DOSCODE:7200                                         </span>; Return: CF set on error
<span style="color:maroon">DOSCODE:7202                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:7203                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:7204 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:7204
DOSCODE:7204 </span>TEST_RE_NET1<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7204                 </span><span style="color:navy">test    word ptr es:[si+</span><span style="color:#ff8000">43h</span><span style="color:navy">], </span><span style="color:green">8000h </span>; [ES:SI+curdir.flags],curdir_isnet
<span style="color:maroon">DOSCODE:720A                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:720B                 </span><span style="color:navy">jz      short </span>LOCAL_OPEN
<span style="color:maroon">DOSCODE:720D                 </span><span style="color:navy">test    </span>EXTOPEN_ON<span style="color:navy">, </span><span style="color:green">1   </span>; EXT_OPEN_ON
<span style="color:maroon">DOSCODE:7212                 </span><span style="color:navy">jnz     short </span>_IFS_extopen
<span style="color:maroon">DOSCODE:7214                 </span><span style="color:navy">jmp     short </span>_NOEXTOP  ; do_net_int2f
<span style="color:maroon">DOSCODE:7216 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:7216
DOSCODE:7216 </span>LOCAL_OPEN<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7216                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:maroon">DOSCODE:7219                 </span><span style="color:navy">or      </span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">5  </span>; FastOpen_Set+Special_Fill_Set
<span style="color:maroon">DOSCODE:721E                 </span><span style="color:navy">call    </span>GETPATH
<span style="color:maroon">DOSCODE:7221                 </span><span style="color:navy">jnb     short </span>Open_found
<span style="color:maroon">DOSCODE:7223                 </span><span style="color:navy">jnz     short </span>bad_path2
<span style="color:maroon">DOSCODE:7225                 </span><span style="color:navy">or      cl, cl
</span><span style="color:maroon">DOSCODE:7227                 </span><span style="color:navy">jz      short </span>bad_path2
<span style="color:maroon">DOSCODE:7229                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2           </span>; error_file_not_found
<span style="color:maroon">DOSCODE:722C
DOSCODE:722C </span>OpenBadRet<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:722C                 </span><span style="color:navy">and     ss:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">80h
</span><span style="color:maroon">DOSCODE:7232                 </span><span style="color:navy">stc
</span><span style="color:maroon">DOSCODE:7233                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:maroon">DOSCODE:7236                 </span><span style="color:navy">jmp     </span>Clear_FastOpen  ; (retn)
<span style="color:maroon">DOSCODE:7239 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:7239
DOSCODE:7239 </span>bad_path2<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7239                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3           </span>; error_path_not_found
<span style="color:maroon">DOSCODE:723C                 </span><span style="color:navy">jmp     short </span>OpenBadRet
<span style="color:maroon">DOSCODE:723E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:723E
DOSCODE:723E </span>Open_Bad_Access<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:723E                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5           </span>; error_access_denied
<span style="color:maroon">DOSCODE:7241                 </span><span style="color:navy">jmp     short </span>OpenBadRet
<span style="color:maroon">DOSCODE:7243 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:7243
DOSCODE:7243 </span>Open_found<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7243                 </span><span style="color:navy">jz      short </span>Open_Bad_Access
<span style="color:maroon">DOSCODE:7245                 </span><span style="color:navy">or      ah, ah
</span><span style="color:maroon">DOSCODE:7247                 </span><span style="color:navy">js      short </span>open_ok   ; Devices don&#039;t have attributes
<span style="color:maroon">DOSCODE:7249                 </span><span style="color:navy">mov     es, word ptr </span>CURBUF<span style="color:navy">+</span><span style="color:green">2 </span>; get buffer location
<span style="color:maroon">DOSCODE:724D                 </span>assume es:DOSCODE
<span style="color:maroon">DOSCODE:724D                 </span><span style="color:navy">mov     al, es:[bx+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">] </span>; [ES:BX+dir_entry.dir_attr]
<span style="color:maroon">DOSCODE:7251                 </span><span style="color:navy">test    al, </span><span style="color:green">8           </span>; attr_volume_id
<span style="color:maroon">DOSCODE:7253                 </span><span style="color:navy">jnz     short </span>Open_Bad_Access ; can&#039;t open volume ids
<span style="color:maroon">DOSCODE:7255                 </span><span style="color:navy">test    al, </span><span style="color:green">1           </span>; attr_read_only ; check write on read only
<span style="color:maroon">DOSCODE:7257                 </span><span style="color:navy">jz      short </span>open_ok
<span style="color:maroon">DOSCODE:7259                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:725A                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:725B                 </span><span style="color:navy">lds     si, </span>THISSFT
<span style="color:maroon">DOSCODE:725F                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:725F                 </span><span style="color:navy">mov     cx, [si+</span><span style="color:#ff8000">2</span><span style="color:navy">]      </span>; [SI+SF_ENTRY.sf_mode]
<span style="color:maroon">DOSCODE:7262                 </span><span style="color:navy">test    cx, </span><span style="color:green">8000h       </span>; sf_isFCB ; is it FCB?
<span style="color:maroon">DOSCODE:7266                 </span><span style="color:navy">jnz     short </span>ResetAccess ; yes, reset the access
<span style="color:maroon">DOSCODE:7268                 </span><span style="color:navy">mov     dl, cl
</span><span style="color:maroon">DOSCODE:726A                 </span><span style="color:navy">and     dl, </span><span style="color:green">0F0h        </span>; SHARING_MASK
<span style="color:maroon">DOSCODE:726D                 </span><span style="color:navy">cmp     dl, </span><span style="color:green">70h         </span>; SHARING_NET_FCB ; is it net FCB?
<span style="color:maroon">DOSCODE:7270                 </span><span style="color:navy">jnz     short </span>NormalOpen ; no
<span style="color:maroon">DOSCODE:7272
DOSCODE:7272 </span>ResetAccess<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7272                 </span><span style="color:navy">and     cx, </span><span style="color:green">0FFFCh      </span>; ~3 ; ~open_mode_mask ; clear access
<span style="color:maroon">DOSCODE:7275                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], cx      </span>; [SI+SF_ENTRY.sf_mode]
<span style="color:maroon">DOSCODE:7278                 </span><span style="color:navy">jmp     short </span>FillSFT
<span style="color:maroon">DOSCODE:727A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:727A
DOSCODE:727A </span>NormalOpen<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:727A                 </span><span style="color:navy">and     cl, </span><span style="color:green">3           </span>; it was &#039;and cl,0Fh&#039; in MSDOS 6.22
<span style="color:maroon">DOSCODE:727A                                         </span>; (and cl,access_mask)
<span style="color:maroon">DOSCODE:727A                                         </span>; this may be open_mode_mask
<span style="color:maroon">DOSCODE:727D                 </span><span style="color:navy">cmp     cl, </span><span style="color:#ff8000">0           </span>; open_for_read ; is it open for read?
<span style="color:maroon">DOSCODE:7280                 </span><span style="color:navy">jz      short </span>FillSFT   ; yes
<span style="color:maroon">DOSCODE:7282                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:7283                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:7284                 </span><span style="color:navy">jmp     short </span>Open_Bad_Access
<span style="color:maroon">DOSCODE:7286 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:7286
DOSCODE:7286 </span>FillSFT<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7286                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:7287                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:7288
DOSCODE:7288 </span>open_ok<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7288                 </span><span style="color:navy">call    </span>DOOPEN          ; Fill in SFT
<span style="color:maroon">DOSCODE:728B                 </span><span style="color:navy">and     ss:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">80h </span>; Fast_yes
<span style="color:maroon">DOSCODE:7291                 </span><span style="color:navy">call    </span>DO_SHARE_CHECK
<span style="color:maroon">DOSCODE:7294                 </span><span style="color:navy">jnb     short </span>SHARE_OK
<span style="color:maroon">DOSCODE:7296                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:maroon">DOSCODE:7299                 </span><span style="color:navy">jmp     short </span>Clear_FastOpen ; (retn)
<span style="color:maroon">DOSCODE:729B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:729B
DOSCODE:729B </span>SHARE_OK<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:729B                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3
</span><span style="color:maroon">DOSCODE:729E                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:maroon">DOSCODE:72A2                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:72A2                 </span><span style="color:navy">call    ds:</span>ShSU         ; call far [JShare+(14*4)] ; 14 = ShSU
<span style="color:maroon">DOSCODE:72A6                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:maroon">DOSCODE:72A9
DOSCODE:72A9 </span>SET_SFT_MODE<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:72A9                 </span><span style="color:navy">les     di, ds:</span>THISSFT  ; Finish SFT initialization for new reference
<span style="color:maroon">DOSCODE:72AD                 </span><span style="color:navy">call    </span>DEV_OPEN_SFT
<span style="color:maroon">DOSCODE:72B0                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">8000h </span>; [ES:DI+SF_ENTRY.sf_mode],sf_isFCB
<span style="color:maroon">DOSCODE:72B6                 </span><span style="color:navy">jz      short </span>Clear_FastOpen ; sf_mode correct
<span style="color:maroon">DOSCODE:72B8                 </span><span style="color:navy">mov     ax, ds:</span>CurrentPDB
<span style="color:maroon">DOSCODE:72BB                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">31h</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_PID]
<span style="color:maroon">DOSCODE:72BB                                         </span>; For FCB sf_PID=PDB
<span style="color:maroon">DOSCODE:72BF
DOSCODE:72BF </span>Clear_FastOpen<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:72BF                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:72C0
DOSCODE:72C0 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:72C0
DOSCODE:72C0
DOSCODE:72C0 </span>SHARE_ERROR     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:72C0                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">8000h </span>; [ES:DI+SF_ENTRY.sf_mode],sf_isFCB
<span style="color:black">DOSCODE:72C6                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_HARD_ERR
</span><span style="color:black">DOSCODE:72C8                 </span><span style="color:navy">mov     cl, es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_mode]
<span style="color:black">DOSCODE:72CC                 </span><span style="color:navy">and     cl, </span><span style="color:green">0F0h        </span>; SHARING_MASK
<span style="color:black">DOSCODE:72CF                 </span><span style="color:navy">cmp     cl, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:72D2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_NO_HARD_ERR
</span><span style="color:black">DOSCODE:72D4
DOSCODE:72D4 </span><span style="color:gray">_HARD_ERR</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:72D4                 </span><span style="color:navy">call    </span>SHARE_VIOLATION
<span style="color:black">DOSCODE:72D7                 </span><span style="color:navy">jnb     short </span>Clear_FastOpen ; User wants retry
<span style="color:black">DOSCODE:72D9
DOSCODE:72D9 </span><span style="color:gray">_NO_HARD_ERR</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:72D9                 </span><span style="color:navy">mov     ax, </span><span style="color:green">20h
</span><span style="color:black">DOSCODE:72DC                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:72DD                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:72DD </span>SHARE_ERROR     <span style="color:black">endp
DOSCODE:72DD
DOSCODE:72DE
DOSCODE:72DE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:72DE
DOSCODE:72DE
DOSCODE:72DE </span>DO_SHARE_CHECK  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:72DE                 </span><span style="color:navy">call    </span>ECritDisk       ; enter critical section
<span style="color:black">DOSCODE:72E1
DOSCODE:72E1 </span><span style="color:gray">OPN_RETRY</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:72E1                 </span><span style="color:navy">mov     cx, ds:</span>RetryCount
<span style="color:black">DOSCODE:72E5
DOSCODE:72E5 </span><span style="color:gray">OpenShareRetry</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:72E5                 </span><span style="color:navy">push    cx              </span>; Save number left to do
<span style="color:black">DOSCODE:72E6                 </span><span style="color:navy">call    </span>SHARE_CHECK     ; Final Check
<span style="color:black">DOSCODE:72E9                 </span><span style="color:navy">pop     cx              </span>; CX = # left
<span style="color:black">DOSCODE:72EA                 </span><span style="color:navy">jnb     short </span><span style="color:gray">Share_Ok2 </span>; No problem with access
<span style="color:black">DOSCODE:72EC                 </span><span style="color:navy">call    </span>Idle
<span style="color:black">DOSCODE:72EF                 </span><span style="color:navy">loop    </span><span style="color:gray">OpenShareRetry  </span>; One more retry used up
<span style="color:black">DOSCODE:72F1                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:black">DOSCODE:72F5                 </span><span style="color:navy">call    </span>SHARE_ERROR
<span style="color:black">DOSCODE:72F8                 </span><span style="color:navy">jnb     short </span><span style="color:gray">OPN_RETRY </span>; User wants more retry
<span style="color:black">DOSCODE:72FA
DOSCODE:72FA </span><span style="color:gray">Share_Ok2</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:72FA                 </span><span style="color:navy">call    </span>LCritDisk       ; leave critical section
<span style="color:black">DOSCODE:72FD                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:72FD </span>DO_SHARE_CHECK  <span style="color:black">endp
DOSCODE:72FD
DOSCODE:72FE
DOSCODE:72FE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:72FE
DOSCODE:72FE
DOSCODE:72FE </span>Check_Access_AX <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:72FE                 </span><span style="color:navy">mov     ds:</span>OPEN_ACCESS<span style="color:navy">, al </span>; Sharing Mode (bit 4 to 7)
<span style="color:black">DOSCODE:72FE                                         </span>; Access Mode (bit 0 to 3)
<span style="color:black">DOSCODE:7301                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:7302                 </span><span style="color:navy">mov     bl, al
</span><span style="color:black">DOSCODE:7304                 </span><span style="color:navy">and     bl, </span><span style="color:green">0F0h        </span>; SHARING_MASK
<span style="color:black">DOSCODE:7307                 </span><span style="color:navy">cmp     ds:</span>FSHARING<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:730C                 </span><span style="color:navy">jz      short </span><span style="color:gray">CheckShareMode </span>; not through server call, must be ok
<span style="color:black">DOSCODE:730E                 </span><span style="color:navy">cmp     bl, </span><span style="color:green">70h         </span>; SHARING_NET_FCB
<span style="color:black">DOSCODE:7311                 </span><span style="color:navy">jz      short </span><span style="color:gray">CheckAccessMode </span>; we have an FCB
<span style="color:black">DOSCODE:7313
DOSCODE:7313 </span><span style="color:gray">CheckShareMode</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7313                 </span><span style="color:navy">cmp     bl, </span><span style="color:green">40h         </span>; is this a good sharing mode?
<span style="color:black">DOSCODE:7316                 </span><span style="color:navy">ja      short </span><span style="color:gray">Make_Bad_Access
</span><span style="color:black">DOSCODE:7318
DOSCODE:7318 </span><span style="color:gray">CheckAccessMode</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7318                 </span><span style="color:navy">mov     bl, al
</span><span style="color:black">DOSCODE:731A                 </span><span style="color:navy">and     bl, </span><span style="color:green">3           </span>; access_mask = 0Fh
<span style="color:black">DOSCODE:731D                 </span><span style="color:navy">cmp     bl, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:7320                 </span><span style="color:navy">ja      short </span><span style="color:gray">Make_Bad_Access
</span><span style="color:black">DOSCODE:7322                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:7323                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:7324                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7325 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7325
DOSCODE:7325 </span><span style="color:gray">Make_Bad_Access</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7325                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0Ch         </span>; error_invalid_access
<span style="color:black">DOSCODE:7328                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:7329                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:732A                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:732A </span>Check_Access_AX <span style="color:black">endp
DOSCODE:732A
DOSCODE:732B
DOSCODE:732B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:732B
DOSCODE:732B
DOSCODE:732B </span>DISK_INFO       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:732B                 </span><span style="color:navy">call    </span>TestNet
<span style="color:black">DOSCODE:732E                 </span><span style="color:navy">jnb     short </span><span style="color:gray">LOCAL_DSK_INFO
</span><span style="color:black">DOSCODE:7330                 </span><span style="color:navy">xor     si, si          </span>; free cluster count hw = 0
<span style="color:black">DOSCODE:7332                 </span><span style="color:navy">xor     di, di          </span>; number of clusters hw = 0
<span style="color:black">DOSCODE:7334                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">110Ch
</span><span style="color:black">DOSCODE:7337                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - GET DISK SPACE
<span style="color:black">DOSCODE:7337                                         </span>; ES:DI -&gt; current directory
<span style="color:black">DOSCODE:7337                                         </span>; Return: AL = sectors per cluster, BX = total clusters
<span style="color:black">DOSCODE:7337                                         </span>; CX = bytes per sector, DX = number of available clusters
<span style="color:black">DOSCODE:7339                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:733C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">dsk_info_1
</span><span style="color:black">DOSCODE:733E                 </span><span style="color:navy">mov     di, bx
</span><span style="color:black">DOSCODE:7340
DOSCODE:7340 </span><span style="color:gray">dsk_info_1</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7340                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:7343                 </span><span style="color:navy">jnz     short </span><span style="color:gray">disk_info_retn
</span><span style="color:black">DOSCODE:7345                 </span><span style="color:navy">mov     si, dx
</span><span style="color:black">DOSCODE:7347
DOSCODE:7347 </span><span style="color:gray">disk_info_retn</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7347                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7348 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7348
DOSCODE:7348 </span><span style="color:gray">LOCAL_DSK_INFO</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7348                 </span><span style="color:navy">call    </span>set_exerr_locus_disk ; mov byte [EXTERR_LOCUS],errLOC_Disk
<span style="color:black">DOSCODE:734B                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:734E                 </span><span style="color:navy">call    </span>FATREAD_CDS     ; perform media check
<span style="color:black">DOSCODE:7351                 </span><span style="color:navy">jb      short </span><span style="color:gray">dsk_info_2
</span><span style="color:black">DOSCODE:7353                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:7355                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, ax </span>; clear high word of cluster number
<span style="color:black">DOSCODE:7358                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">2           </span>; Get first FAT sector into CURBUF
<span style="color:black">DOSCODE:735B                 </span><span style="color:navy">call    </span>UNPACK
<span style="color:black">DOSCODE:735E
DOSCODE:735E </span><span style="color:gray">dsk_info_2</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:735E                 </span><span style="color:navy">jnb     short </span><span style="color:gray">dsk_info_3
</span><span style="color:black">DOSCODE:7360                 </span><span style="color:navy">jmp     </span><span style="color:gray">CRIT_LEAVE
</span><span style="color:black">DOSCODE:7363 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7363
DOSCODE:7363 </span><span style="color:gray">dsk_info_3</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7363                 </span><span style="color:navy">lds     si, ds:</span>CURBUF
<span style="color:black">DOSCODE:7367                 </span><span style="color:navy">mov     ah, [si+</span><span style="color:green">24</span><span style="color:navy">]     </span>; [SI+BUFINSIZ] ; get FAT ID BYTE
<span style="color:black">DOSCODE:736A                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:736B                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:736C                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:736C                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">DOSCODE:736E                 </span><span style="color:navy">mov     di, si
</span><span style="color:black">DOSCODE:7370                 </span><span style="color:navy">mov     dx, es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">] </span>; [ES:BP+DPB.FREE_CNT] ; get free count
<span style="color:black">DOSCODE:7374                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], si </span>; FAT32 (16 bit FAT size = 0) ?
<span style="color:black">DOSCODE:7378                 </span><span style="color:navy">jz      short </span><span style="color:gray">dsk_info_4 </span>; yes
<span style="color:black">DOSCODE:737A                 </span><span style="color:navy">mov     cx, es:[bp+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">] </span>; [ES:BP+DPB.MAX_CLUSTER]
<span style="color:black">DOSCODE:737E                 </span><span style="color:navy">jmp     short </span><span style="color:gray">dsk_info_5 </span>; zf=0, si=di=0
<span style="color:black">DOSCODE:7380 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7380
DOSCODE:7380 </span><span style="color:gray">dsk_info_4</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7380                 </span><span style="color:navy">mov     di, es:[bp+</span><span style="color:#ff8000">2Fh</span><span style="color:navy">] </span>; DPB.LAST_CLUSTER+2
<span style="color:black">DOSCODE:7384                 </span><span style="color:navy">mov     cx, es:[bp+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">] </span>; DPB.LAST_CLUSTER
<span style="color:black">DOSCODE:7388                 </span><span style="color:navy">mov     si, es:[bp+</span><span style="color:#ff8000">21h</span><span style="color:navy">] </span>; DPB.FREE_CNT_HW ; hw of free cluster count
<span style="color:black">DOSCODE:738C                 </span><span style="color:navy">cmp     dx, si          </span>; same (zero) ?
<span style="color:black">DOSCODE:738E
DOSCODE:738E </span><span style="color:gray">dsk_info_5</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:738E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">dsk_info_6 </span>; not same (not zero)
<span style="color:black">DOSCODE:7390                 </span><span style="color:navy">inc     dx
</span><span style="color:black">DOSCODE:7391                 </span><span style="color:navy">jz      short </span><span style="color:gray">dsk_info_8 </span>; 0FFFFh -&gt; 0 (free count is invalid/initial)
<span style="color:black">DOSCODE:7391                                         </span>; free count calculation is needed
<span style="color:black">DOSCODE:7393                 </span><span style="color:navy">dec     dx
</span><span style="color:black">DOSCODE:7394
DOSCODE:7394 </span><span style="color:gray">dsk_info_6</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7394                 </span><span style="color:navy">cmp     si, di          </span>; same hw ?
<span style="color:black">DOSCODE:7396                 </span><span style="color:navy">jnz     short </span><span style="color:gray">dsk_info_7 </span>; no
<span style="color:black">DOSCODE:7398                 </span><span style="color:navy">cmp     dx, cx          </span>; same lw ?
<span style="color:black">DOSCODE:739A
DOSCODE:739A </span><span style="color:gray">dsk_info_7</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:739A                 </span><span style="color:navy">jb      short </span><span style="color:gray">GotVal    </span>; free cluster count &lt; last cluster number
<span style="color:black">DOSCODE:739C                 </span><span style="color:navy">xor     dx, dx          </span>; 0
<span style="color:black">DOSCODE:739E
DOSCODE:739E </span><span style="color:gray">dsk_info_8</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:739E                 </span><span style="color:navy">xor     si, si          </span>; 0
<span style="color:black">DOSCODE:73A0                 </span><span style="color:navy">sub     cx, </span><span style="color:#ff8000">1           </span>; last cluster number - 1 = number of clusters
<span style="color:black">DOSCODE:73A3                 </span><span style="color:navy">sbb     di, si
</span><span style="color:black">DOSCODE:73A5                 </span><span style="color:navy">or      byte ptr es:[bp+</span><span style="color:#ff8000">18h</span><span style="color:navy">], </span><span style="color:green">1 </span>; DPB.FIRST_ACCESS ; set first access
<span style="color:black">DOSCODE:73AA
DOSCODE:73AA </span><span style="color:gray">SCANFREE</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:73AA                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:73AB                 </span><span style="color:navy">push    </span>CCONTENT_HW
<span style="color:black">DOSCODE:73AF                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:73B0                 </span><span style="color:navy">call    </span>UNPACK
<span style="color:black">DOSCODE:73B3                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:73B4                 </span><span style="color:navy">pop     </span>CCONTENT_HW
<span style="color:black">DOSCODE:73B8                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:73B9                 </span><span style="color:navy">jb      short </span><span style="color:gray">CRIT_LEAVE
</span><span style="color:black">DOSCODE:73BB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOTFREECLUS
</span><span style="color:black">DOSCODE:73BD                 </span><span style="color:navy">inc     dx              </span>; a free one
<span style="color:black">DOSCODE:73BE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOTFREECLUS
</span><span style="color:black">DOSCODE:73C0                 </span><span style="color:navy">inc     si              </span>; increase hw of free cluster count
<span style="color:black">DOSCODE:73C1
DOSCODE:73C1 </span><span style="color:gray">NOTFREECLUS</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:73C1                 </span><span style="color:navy">inc     bx              </span>; next cluster
<span style="color:black">DOSCODE:73C2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOTFREECLUS2
</span><span style="color:black">DOSCODE:73C4                 </span><span style="color:navy">inc     </span>CLUSTNUM_HW     ; increase hw of (next) cluster number
<span style="color:black">DOSCODE:73C8
DOSCODE:73C8 </span><span style="color:gray">NOTFREECLUS2</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:73C8                 </span><span style="color:navy">sub     cx, </span><span style="color:#ff8000">1           </span>; decrease remain cluster count for calculation
<span style="color:black">DOSCODE:73CB                 </span><span style="color:navy">sbb     di, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:73CE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SCANFREE
</span><span style="color:black">DOSCODE:73D0                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">NOTFREECLUS3 </span>; calculation completed
<span style="color:black">DOSCODE:73D2                 </span><span style="color:navy">jmp     short </span><span style="color:gray">SCANFREE
</span><span style="color:black">DOSCODE:73D4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:73D4
DOSCODE:73D4 </span><span style="color:gray">NOTFREECLUS3</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:73D4                 </span><span style="color:navy">mov     di, </span>CLUSTNUM_HW
<span style="color:black">DOSCODE:73D8                 </span><span style="color:navy">sub     bx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:73DB                 </span><span style="color:navy">sbb     di, </span><span style="color:#ff8000">0           </span>; di:bx = last cluster number
<span style="color:black">DOSCODE:73DE
DOSCODE:73DE </span><span style="color:gray">ReturnVals</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:73DE                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:73E0                 </span><span style="color:navy">sub     bx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:73E3                 </span><span style="color:navy">sbb     di, cx          </span>; di:bx = number of clusters
<span style="color:black">DOSCODE:73E5                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [ES:BP+DPB.CLUSTER_MASK] ; spc - 1
<span style="color:black">DOSCODE:73E9                 </span><span style="color:navy">inc     al              </span>; sectors per cluster
<span style="color:black">DOSCODE:73EB                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], dx </span>; [ES:BP+DPB.FREE_CNT] ; free cluster count, lw
<span style="color:black">DOSCODE:73EF                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], cx </span>; FAT32 (16 bit FAT size = 0) ?
<span style="color:black">DOSCODE:73F3                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ReturnVals2 </span>; no
<span style="color:black">DOSCODE:73F5                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">21h</span><span style="color:navy">], si </span>; DPB.FREE_CNT_HW ; hw of free cluster count
<span style="color:black">DOSCODE:73F9                 </span><span style="color:navy">call    </span>update_fat32_fsinfo
<span style="color:black">DOSCODE:73FC
DOSCODE:73FC </span><span style="color:gray">ReturnVals2</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:73FC                 </span><span style="color:navy">mov     cx, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [ES:BP+DPB.SECTOR_SIZE] ; bytes per sector
<span style="color:black">DOSCODE:7400                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:7401
DOSCODE:7401 </span><span style="color:gray">CRIT_LEAVE</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7401                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:7404                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7405 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7405
DOSCODE:7405 </span><span style="color:gray">GotVal</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7405                 </span><span style="color:navy">mov     bx, cx
</span><span style="color:black">DOSCODE:7407                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ReturnVals
</span><span style="color:black">DOSCODE:7407 </span>DISK_INFO       <span style="color:black">endp
DOSCODE:7407
</span><span style="color:maroon">DOSCODE:7409 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:7409
DOSCODE:7409 </span>modify_spc<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7409                 </span><span style="color:navy">push    ax              </span>; ax = sectors per cluster
<span style="color:maroon">DOSCODE:740A                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:740B                 </span><span style="color:navy">mul     cx              </span>; bytes per sector
<span style="color:maroon">DOSCODE:740D                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:7410                 </span><span style="color:navy">jnz     short </span>mspc_1
<span style="color:maroon">DOSCODE:7412                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">16384       </span>; 16 kilobytes (per cluster)
<span style="color:maroon">DOSCODE:7412                                         </span>; ***
<span style="color:maroon">DOSCODE:7412                                         </span>; actual disk size limit
<span style="color:maroon">DOSCODE:7412                                         </span>; without invalidating cluster counts is
<span style="color:maroon">DOSCODE:7412                                         </span>; 2 GB (512K clusters * 8 sectors per cluster)
<span style="color:maroon">DOSCODE:7412                                         </span>;      (128K clusters * 32 sectors per cluster)
<span style="color:maroon">DOSCODE:7415
DOSCODE:7415 </span>mspc_1<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7415                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:7416                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:7417                 </span><span style="color:navy">jbe     short </span>mspc_3    ; bytes per cluster &lt;= 16 KB
<span style="color:maroon">DOSCODE:7417                                         </span>; ***
<span style="color:maroon">DOSCODE:7417                                         </span>; bytes per cluster &gt; 16 KB
<span style="color:maroon">DOSCODE:7419                 </span><span style="color:navy">xor     di, di          </span>; 0
<span style="color:maroon">DOSCODE:741B                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFEh      </span>; (invalidated)
<span style="color:maroon">DOSCODE:741E                 </span><span style="color:navy">or      si, si          </span>; hw of free cluster count
<span style="color:maroon">DOSCODE:7420                 </span><span style="color:navy">jz      short </span>mspc_2    ; si = 0
<span style="color:maroon">DOSCODE:7422                 </span><span style="color:navy">mov     si, di          </span>; si = 0
<span style="color:maroon">DOSCODE:7424                 </span><span style="color:navy">mov     dx, bx          </span>; dx = bx = 0FFFEh (invalidated)
<span style="color:maroon">DOSCODE:7426
DOSCODE:7426 </span>mspc_2<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7426                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:7427 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:7427
DOSCODE:7427 </span>mspc_3<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7427                 </span><span style="color:navy">shl     ax, </span><span style="color:green">1           </span>; sectors per clust = sectors per clust * 2
<span style="color:maroon">DOSCODE:7427                                         </span>; (ax &lt;= 32768)
<span style="color:maroon">DOSCODE:7429                 </span><span style="color:navy">shr     di, </span><span style="color:green">1           </span>; cluster count = cluster count /2
<span style="color:maroon">DOSCODE:7429                                         </span>; di:bx = modified value of total clusters
<span style="color:maroon">DOSCODE:742B
DOSCODE:742B </span>mspc_4<span style="color:navy">:
</span><span style="color:maroon">DOSCODE:742B                 </span><span style="color:navy">rcr     bx, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:742D                 </span><span style="color:navy">shr     si, </span><span style="color:green">1           </span>; free clusters = free clusters / 2
<span style="color:maroon">DOSCODE:742F                 </span><span style="color:navy">rcr     dx, </span><span style="color:green">1           </span>; si:dx = modified value of free clusters
<span style="color:maroon">DOSCODE:7431
DOSCODE:7431 </span>modify_cluster_count<span style="color:navy">:                   </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7431                 </span><span style="color:navy">or      di, di          </span>; hw of cluster count
<span style="color:maroon">DOSCODE:7433                 </span><span style="color:navy">jnz     short </span>modify_spc
<span style="color:maroon">DOSCODE:7435                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7436
DOSCODE:7436 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7436
DOSCODE:7436
DOSCODE:7436 </span>update_fat32_fsinfo <span style="color:black">proc near           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7436                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:7437                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:7438                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:743A                 </span><span style="color:navy">mov     dx, es:[bp+</span><span style="color:#ff8000">25h</span><span style="color:navy">] </span>; DPB.FSINFO_SECTOR
<span style="color:black">DOSCODE:743E                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], cx </span>; DPB.FAT_SIZE
<span style="color:black">DOSCODE:743E                                         </span>; (16bit FAT size field = 0 for FAT32 fs)
<span style="color:black">DOSCODE:7442                 </span><span style="color:navy">jnz     short </span><span style="color:gray">u_fat32_inf_1
</span><span style="color:black">DOSCODE:7444                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:black">DOSCODE:7447                 </span><span style="color:navy">jnz     short </span><span style="color:gray">u_fat32_inf_2
</span><span style="color:black">DOSCODE:7449
DOSCODE:7449 </span><span style="color:gray">u_fat32_inf_1</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7449                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:744A                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:744B                 </span><span style="color:navy">and     byte ptr es:[bp+</span><span style="color:#ff8000">18h</span><span style="color:navy">], </span><span style="color:green">0F4h </span>; clear bit 0,1 and 3
<span style="color:black">DOSCODE:744B                                         </span>; bit 0 - FSINFO update (dirty) bit
<span style="color:black">DOSCODE:744B                                         </span>; bit 1 - BPB_RootClus update bit
<span style="color:black">DOSCODE:744B                                         </span>; bit 3 - BPB_ExtFlags update bit
<span style="color:black">DOSCODE:7450                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7451 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7451
DOSCODE:7451 </span><span style="color:gray">u_fat32_inf_2</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7451                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:7452                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:7453                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:7454                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:7455                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:7456                 </span><span style="color:navy">cmp     ss:</span>BuffInHMA<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; is buffers in HMA?
<span style="color:black">DOSCODE:745C                 </span><span style="color:navy">jz      short </span><span style="color:gray">u_fat32_inf_3 </span>; no
<span style="color:black">DOSCODE:745E                 </span><span style="color:navy">lds     di, ss:</span>LoMemBuff ; read it into scratch buffer
<span style="color:black">DOSCODE:7463                 </span>assume ds:nothing
<span style="color:black">DOSCODE:7463                 </span><span style="color:navy">sub     di, </span><span style="color:green">24          </span>; BUFINSIZ ; space for buffer header
<span style="color:black">DOSCODE:7463                                         </span>; (buffer header size = 24)
<span style="color:black">DOSCODE:7466                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:7467                 </span><span style="color:navy">jmp     short </span><span style="color:gray">u_fat32_inf_4
</span><span style="color:black">DOSCODE:7469 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7469
DOSCODE:7469 </span><span style="color:gray">u_fat32_inf_3</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7469                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:746A                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:746B                 </span><span style="color:navy">call    </span>GETCURHEAD      ; ds:di = first buffer in queue
<span style="color:black">DOSCODE:746E                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:746F                 </span><span style="color:navy">call    </span>BUFWRITE        ; BufWrite writes a buffer to the disk,
<span style="color:black">DOSCODE:746F                                         </span>;  if it&#039;s dirty.
<span style="color:black">DOSCODE:7472                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:7473                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:7474                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:7475
DOSCODE:7475 </span><span style="color:gray">u_fat32_inf_4</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7475                 </span><span style="color:navy">jb      short </span><span style="color:gray">u_fat32_inf_5
</span><span style="color:black">DOSCODE:7477                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:7479                 </span><span style="color:navy">lea     bx, [di+</span><span style="color:green">24</span><span style="color:navy">]     </span>; buffer data address
<span style="color:black">DOSCODE:747C                 </span><span style="color:navy">mov     ss:</span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">18h </span>; Allowed_FAIL+Allowed_RETRY
<span style="color:black">DOSCODE:7482                 </span><span style="color:navy">mov     ss:</span>HIGH_SECTOR<span style="color:navy">, cx </span>; 0
<span style="color:black">DOSCODE:7487                 </span><span style="color:navy">inc     cx              </span>; cx = sector count
<span style="color:black">DOSCODE:7487                                         </span>; es:bp = DPB
<span style="color:black">DOSCODE:7488                 </span><span style="color:navy">push    bx              </span>; ds:bx = buffer (data) address
<span style="color:black">DOSCODE:7489                 </span><span style="color:navy">push    dx              </span>; HIGH_SECTOR:dx = disk sector address
<span style="color:black">DOSCODE:748A                 </span><span style="color:navy">call    </span>DREAD           ; read fs info sector
<span style="color:black">DOSCODE:748D                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:748E                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:748F                 </span><span style="color:navy">jb      short </span><span style="color:gray">u_fat32_inf_5
</span><span style="color:black">DOSCODE:7491                 </span><span style="color:navy">cmp     word ptr [bx], </span><span style="color:#ff8000">5252h </span>; &#039;RR&#039;
<span style="color:black">DOSCODE:7495                 </span><span style="color:navy">jnz     short </span><span style="color:gray">u_fat32_inf_5
</span><span style="color:black">DOSCODE:7497                 </span><span style="color:navy">cmp     word ptr [bx+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:#ff8000">4161h </span>; &#039;aA&#039; ; (NASM syntax)
<span style="color:black">DOSCODE:749C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">u_fat32_inf_5
</span><span style="color:black">DOSCODE:749E                 </span><span style="color:navy">cmp     word ptr [bx+</span><span style="color:#ff8000">1E4h</span><span style="color:navy">], </span><span style="color:#ff8000">7272h </span>; &#039;rr&#039; at offset 484
<span style="color:black">DOSCODE:74A4                 </span><span style="color:navy">jnz     short </span><span style="color:gray">u_fat32_inf_5
</span><span style="color:black">DOSCODE:74A6                 </span><span style="color:navy">cmp     word ptr [bx+</span><span style="color:#ff8000">1E6h</span><span style="color:navy">], </span><span style="color:#ff8000">6141h </span>; &#039;Aa&#039; at offset 486
<span style="color:black">DOSCODE:74AC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">u_fat32_inf_5
</span><span style="color:black">DOSCODE:74AE                 </span><span style="color:navy">cmp     word ptr [bx+</span><span style="color:#ff8000">1FEh</span><span style="color:navy">], </span><span style="color:green">0AA55h </span>; boot signature at offset 510
<span style="color:black">DOSCODE:74B4                 </span><span style="color:navy">jnz     short </span><span style="color:gray">u_fat32_inf_5
</span><span style="color:black">DOSCODE:74B6                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">] </span>; DPB.FREE_CNT
<span style="color:black">DOSCODE:74BA                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">1E8h</span><span style="color:navy">], ax   </span>; FSINFO.Free_Count at offset 488
<span style="color:black">DOSCODE:74BE                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">21h</span><span style="color:navy">] </span>; DPB.FREE_CNT+2
<span style="color:black">DOSCODE:74C2                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">1EAh</span><span style="color:navy">], ax   </span>; FSINFO.Free_Count+2
<span style="color:black">DOSCODE:74C6                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">39h</span><span style="color:navy">] </span>; DPB.FAT32_NXTFREE
<span style="color:black">DOSCODE:74CA                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">1ECh</span><span style="color:navy">], ax   </span>; FSINFO.Nxt_Free at offset 492
<span style="color:black">DOSCODE:74CE                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">3Bh</span><span style="color:navy">] </span>; DPB.FAT32_NXTFREE+2
<span style="color:black">DOSCODE:74D2                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">1EEh</span><span style="color:navy">], ax   </span>; FSINFO.Nxt_Free+2
<span style="color:black">DOSCODE:74D6                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:74D8                 </span><span style="color:navy">mov     ss:</span>HIGH_SECTOR<span style="color:navy">, cx </span>; 0
<span style="color:black">DOSCODE:74DD                 </span><span style="color:navy">inc     cx              </span>; 1
<span style="color:black">DOSCODE:74DE                 </span><span style="color:navy">call    </span>DWRITE
<span style="color:black">DOSCODE:74E1
DOSCODE:74E1 </span><span style="color:gray">u_fat32_inf_5</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:74E1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:74E2                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:74E3                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:74E4                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:74E5                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:74E6                 </span><span style="color:navy">jmp     </span><span style="color:gray">u_fat32_inf_1
</span><span style="color:black">DOSCODE:74E6 </span>update_fat32_fsinfo <span style="color:black">endp
DOSCODE:74E6
DOSCODE:74E9
DOSCODE:74E9 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:74E9
DOSCODE:74E9
DOSCODE:74E9 </span>DOS_SEARCH_FIRST <span style="color:black">proc near              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:74E9                 </span><span style="color:navy">les     di, ds:</span>THISCDS
<span style="color:black">DOSCODE:74ED                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:black">DOSCODE:74F0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">TEST_RE_NET2
</span><span style="color:black">DOSCODE:74F2                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1119h       </span>; (MultNET&lt;&lt;8)|25
<span style="color:black">DOSCODE:74F5                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - ???
<span style="color:black">DOSCODE:74F7                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:74F8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:74F8
DOSCODE:74F8 </span><span style="color:gray">TEST_RE_NET2</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:74F8                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">44h</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:DI+curdir.flags+1],
<span style="color:black">DOSCODE:74F8                                         </span>; curdir_isnet&gt;&gt;8
<span style="color:black">DOSCODE:74FD                 </span><span style="color:navy">jz      short </span><span style="color:gray">LOCAL_SEARCH_FIRST
</span><span style="color:black">DOSCODE:74FF                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">111Bh       </span>; (MultNET&lt;&lt;8)|27
<span style="color:black">DOSCODE:7502                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - FINDFIRST
<span style="color:black">DOSCODE:7502                                         </span>; SS = DS = DOS CS, [DTA] = uninitialized 21-byte findfirst search data
<span style="color:black">DOSCODE:7502                                         </span>; SDA first filename pointer -&gt; fully-qualified search template
<span style="color:black">DOSCODE:7502                                         </span>; SDA CDS pointer -&gt; current directory
<span style="color:black">DOSCODE:7502                                         </span>; Return: CF set on error
<span style="color:black">DOSCODE:7504                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7505 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7505
DOSCODE:7505 </span><span style="color:gray">LOCAL_SEARCH_FIRST</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7505                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:7508                 </span><span style="color:navy">test    byte ptr ds:</span>DOS34_FLAG<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:green">4 </span>; (SEARCH_FASTOPEN&gt;&gt;8)
<span style="color:black">DOSCODE:750D                 </span><span style="color:navy">jz      short </span><span style="color:gray">NOFN
</span><span style="color:black">DOSCODE:750F                 </span><span style="color:navy">or      ds:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">1 </span>; FastOpen_Set
<span style="color:black">DOSCODE:7514
DOSCODE:7514 </span><span style="color:gray">NOFN</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7514                 </span><span style="color:navy">mov     ds:</span>NoSetDir<span style="color:navy">, </span><span style="color:#ff8000">1  </span>; if we find a dir, don&#039;t change to it
<span style="color:black">DOSCODE:7519
DOSCODE:7519 </span>CHECK_QUESTION<span style="color:navy">:
</span><span style="color:black">DOSCODE:7519                 </span><span style="color:navy">mov     si, ss
</span><span style="color:black">DOSCODE:751B                 </span><span style="color:navy">mov     ds, si
</span><span style="color:black">DOSCODE:751D                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:751D                 </span><span style="color:navy">mov     si, </span>WFP_START   ; ds:si -&gt; final path
<span style="color:black">DOSCODE:7521
DOSCODE:7521 </span><span style="color:gray">getnext</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7521                 </span><span style="color:navy">lodsb                   </span>; get char
<span style="color:black">DOSCODE:7522                 </span><span style="color:navy">or      al, al          </span>; is it null ?
<span style="color:black">DOSCODE:7524                 </span><span style="color:navy">jz      short </span><span style="color:gray">NO_Question </span>; yes
<span style="color:black">DOSCODE:7526                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3Fh </span><span style="color:gray">; &#039;?&#039;   </span>; is &#039;?&#039;
<span style="color:black">DOSCODE:7528                 </span><span style="color:navy">jnz     short </span><span style="color:gray">getnext   </span>; no
<span style="color:black">DOSCODE:752A                 </span><span style="color:navy">and     </span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">80h </span>; Fast_yes ; reset fastopen
<span style="color:black">DOSCODE:752F
DOSCODE:752F </span><span style="color:gray">NO_Question</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:752F                 </span><span style="color:navy">call    </span>GETPATH
<span style="color:black">DOSCODE:7532                 </span><span style="color:navy">jnb     short </span><span style="color:gray">find_check_dev
</span><span style="color:black">DOSCODE:7534                 </span><span style="color:navy">jnz     short </span><span style="color:gray">bad_path3
</span><span style="color:black">DOSCODE:7536                 </span><span style="color:navy">or      cl, cl
</span><span style="color:black">DOSCODE:7538                 </span><span style="color:navy">jz      short </span><span style="color:gray">bad_path3
</span><span style="color:black">DOSCODE:753A
DOSCODE:753A </span>find_no_more<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:753A                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">12h         </span>; error_no_more_files
<span style="color:black">DOSCODE:753D
DOSCODE:753D </span><span style="color:gray">BadBye</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:753D                 </span><span style="color:navy">and     ss:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">80h </span>; Fast_yes  ; reset fastopen
<span style="color:black">DOSCODE:7543                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:7544                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:7547                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7548 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7548
DOSCODE:7548 </span><span style="color:gray">bad_path3</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7548                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3           </span>; error_path_not_found
<span style="color:black">DOSCODE:754B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">BadBye
</span><span style="color:black">DOSCODE:754D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:754D
DOSCODE:754D </span><span style="color:gray">find_check_dev</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:754D                 </span><span style="color:navy">or      ah, ah
</span><span style="color:black">DOSCODE:754F                 </span><span style="color:navy">jns     short </span><span style="color:gray">found_entry
</span><span style="color:black">DOSCODE:7551                 </span><span style="color:navy">mov     </span>LASTENT<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; Cause DOS_SEARCH_NEXT to fail
<span style="color:black">DOSCODE:7557                 </span><span style="color:navy">inc     </span>FOUND_DEV       ; Tell DOS_RENAME we found a device
<span style="color:black">DOSCODE:755B
DOSCODE:755B </span><span style="color:gray">found_entry</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:755B                 </span><span style="color:navy">les     di, </span>DMAADD
<span style="color:black">DOSCODE:755F                 </span><span style="color:navy">mov     si, </span>WFP_START   ; get pointer to beginning
<span style="color:black">DOSCODE:7563                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:7564                 </span><span style="color:navy">sub     al, </span><span style="color:#ff8000">40h </span><span style="color:gray">; &#039;@&#039;   </span>; &#039;A&#039;-1  ; logical drive
<span style="color:black">DOSCODE:7566                 </span><span style="color:navy">stosb                   </span>; High bit not set (local)
<span style="color:black">DOSCODE:7567
DOSCODE:7567 </span>found_it<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7567                 </span><span style="color:navy">les     di, </span>DMAADD
<span style="color:black">DOSCODE:756B                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:756C                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:756D                 </span><span style="color:navy">test    </span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">10h </span>; Set_For_Search ; from fastopen
<span style="color:black">DOSCODE:7572                 </span><span style="color:navy">jz      short </span><span style="color:gray">notfast
</span><span style="color:black">DOSCODE:7574                 </span><span style="color:navy">mov     si, bx
</span><span style="color:black">DOSCODE:7576                 </span><span style="color:navy">mov     ds, word ptr </span>CURBUF<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:757A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">movmov
</span><span style="color:black">DOSCODE:757C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:757C
DOSCODE:757C </span><span style="color:gray">notfast</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:757C                 </span><span style="color:navy">mov     si, offset </span>NAME1 ; find_buf 2 = formatted name
<span style="color:black">DOSCODE:757F
DOSCODE:757F </span><span style="color:gray">movmov</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:757F                 </span><span style="color:navy">movsb
</span><span style="color:black">DOSCODE:7580                 </span><span style="color:navy">cmp     byte ptr es:[di-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">5
</span><span style="color:black">DOSCODE:7585                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOTKANJB
</span><span style="color:black">DOSCODE:7587                 </span><span style="color:navy">mov     byte ptr es:[di-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">0E5h
</span><span style="color:black">DOSCODE:758C
DOSCODE:758C </span><span style="color:gray">NOTKANJB</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:758C                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">5
</span><span style="color:black">DOSCODE:758F                 </span><span style="color:navy">rep movsw
</span><span style="color:black">DOSCODE:7591                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7592                 </span>assume ds:nothing
<span style="color:black">DOSCODE:7592                 </span><span style="color:navy">mov     al, ds:</span>ATTRIB
<span style="color:black">DOSCODE:7595                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:7596                 </span><span style="color:navy">push    ax              </span>; Save AH device info
<span style="color:black">DOSCODE:7597                 </span><span style="color:navy">mov     ax, ds:</span>LASTENT
<span style="color:black">DOSCODE:759A                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:759B                 </span><span style="color:navy">mov     ax, ds:</span>DIRSTART
<span style="color:black">DOSCODE:759E                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:759F                 </span><span style="color:navy">mov     ax, ds:</span>DIRSTART_HW
<span style="color:black">DOSCODE:75A2                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:75A3                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:75A6                 </span><span style="color:navy">pop     ax              </span>; Recover AH device info
<span style="color:black">DOSCODE:75A7                 </span><span style="color:navy">or      ah, ah
</span><span style="color:black">DOSCODE:75A9                 </span><span style="color:navy">js      short </span><span style="color:gray">DOSREL    </span>; Device entry is DOSGROUP relative
<span style="color:black">DOSCODE:75AB                 </span><span style="color:navy">cmp     word ptr ds:</span>CURBUF<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; -1
<span style="color:black">DOSCODE:75B0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">OKSTORE
</span><span style="color:black">DOSCODE:75B2                 </span><span style="color:navy">test    ds:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">10h </span>; Set_For_Search
<span style="color:black">DOSCODE:75B2                                         </span>; from fastopen and is good
<span style="color:black">DOSCODE:75B7                 </span><span style="color:navy">jnz     short </span><span style="color:gray">OKSTORE
</span><span style="color:black">DOSCODE:75B9                 </span><span style="color:navy">mov     word ptr es:[di-</span><span style="color:green">8</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; Cause DOS_SEARCH_NEXT to fail
<span style="color:black">DOSCODE:75B9                                         </span>; by stuffing a -1 at Lastent
<span style="color:black">DOSCODE:75BF                 </span><span style="color:navy">jmp     </span>find_no_more
<span style="color:black">DOSCODE:75C2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:75C2
DOSCODE:75C2 </span><span style="color:gray">OKSTORE</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:75C2                 </span><span style="color:navy">mov     ds, word ptr ds:</span>CURBUF<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:75C6
DOSCODE:75C6 </span><span style="color:gray">DOSREL</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:75C6                 </span><span style="color:navy">mov     si, bx          </span>; start of entry
<span style="color:black">DOSCODE:75C8                 </span><span style="color:navy">mov     cx, </span><span style="color:green">16          </span>; dir_entry.size&gt;&gt;1
<span style="color:black">DOSCODE:75CB                 </span><span style="color:navy">mov     ax, di          </span>; save the 1st byte addr
<span style="color:black">DOSCODE:75CD                 </span><span style="color:navy">rep movsw
</span><span style="color:black">DOSCODE:75CF                 </span><span style="color:navy">mov     di, ax          </span>; restore 1st byte addr
<span style="color:black">DOSCODE:75D1                 </span><span style="color:navy">cmp     byte ptr es:[di], </span><span style="color:#ff8000">5 </span>; special char check
<span style="color:black">DOSCODE:75D5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NO05
</span><span style="color:black">DOSCODE:75D7                 </span><span style="color:navy">mov     byte ptr es:[di], </span><span style="color:#ff8000">0E5h </span>; convert it back to E5
<span style="color:black">DOSCODE:75DB
DOSCODE:75DB </span><span style="color:gray">NO05</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:75DB                 </span><span style="color:navy">and     ss:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">80h </span>; Fast_yes
<span style="color:black">DOSCODE:75E1                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:75E2                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:75E3                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:75E3                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:75E4                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:75E7                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:75E7 </span>DOS_SEARCH_FIRST <span style="color:black">endp
DOSCODE:75E7
</span><span style="color:maroon">DOSCODE:75E8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:75E8
DOSCODE:75E8 </span>DOS_SEARCH_NEXT_X<span style="color:navy">:                      </span>; DOS_SEARCH_NEXT (MSDOS 6.22, Win ME)
<span style="color:maroon">DOSCODE:75E8                 </span><span style="color:navy">les     di, </span>DMAADD
<span style="color:black">DOSCODE:75EC
DOSCODE:75EC </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:75EC
DOSCODE:75EC
DOSCODE:75EC </span>DOS_SEARCH_NEXT <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:75EC                 </span><span style="color:navy">mov     al, es:[di]
</span><span style="color:black">DOSCODE:75EF                 </span><span style="color:navy">test    al, </span><span style="color:green">80h         </span>; Test for NET
<span style="color:black">DOSCODE:75F1                 </span><span style="color:navy">jz      short </span><span style="color:gray">LOCAL_SEARCH_NEXT
</span><span style="color:black">DOSCODE:75F3                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">111Ch       </span>; (MultNET&lt;&lt;8)|28
<span style="color:black">DOSCODE:75F6                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - FINDNEXT
<span style="color:black">DOSCODE:75F6                                         </span>; SS = DS = DOS CS, [DTA] = 21-byte findfirst search data
<span style="color:black">DOSCODE:75F6                                         </span>; Return: CF set on error, AX = DOS error code
<span style="color:black">DOSCODE:75F6                                         </span>; CF clear if successful
<span style="color:black">DOSCODE:75F8                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:75F9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:75F9
DOSCODE:75F9 </span><span style="color:gray">LOCAL_SEARCH_NEXT</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:75F9                 </span><span style="color:navy">mov     </span>EXTERR_LOCUS<span style="color:navy">, </span><span style="color:#ff8000">2 </span>; errLOC_Disk
<span style="color:black">DOSCODE:75FE                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:7601                 </span><span style="color:navy">mov     word ptr </span>THISCDS<span style="color:navy">, offset </span>DUMMYCDS
<span style="color:black">DOSCODE:7607                 </span><span style="color:navy">mov     word ptr </span>THISCDS<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:black">DOSCODE:760B                 </span><span style="color:navy">add     al, </span><span style="color:#ff8000">40h </span><span style="color:gray">; &#039;@&#039;   </span>; &#039;A&#039; - 1
<span style="color:black">DOSCODE:760D                 </span><span style="color:navy">call    </span>InitCDS
<span style="color:black">DOSCODE:7610                 </span><span style="color:navy">jb      short </span>No_files  ; Bogus drive letter
<span style="color:black">DOSCODE:7612                 </span><span style="color:navy">les     di, </span>THISCDS     ; Get CDS pointer
<span style="color:black">DOSCODE:7616                 </span><span style="color:navy">les     bp, es:[di+</span><span style="color:#ff8000">45h</span><span style="color:navy">] </span>; [ES:DI+curdir.devptr] ; Get DPB pointer
<span style="color:black">DOSCODE:761A                 </span><span style="color:navy">mov     word ptr </span>THISDPB<span style="color:navy">, bp
</span><span style="color:black">DOSCODE:761E                 </span><span style="color:navy">mov     word ptr </span>THISDPB<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:7622                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:7626                 </span><span style="color:navy">mov     </span>THISDRV<span style="color:navy">, al
</span><span style="color:black">DOSCODE:7629                 </span><span style="color:navy">mov     word ptr </span>CREATING<span style="color:navy">, </span><span style="color:green">0E500h </span>; (DIRFREE*256)+0
<span style="color:black">DOSCODE:762F                 </span><span style="color:navy">mov     </span>NoSetDir<span style="color:navy">, </span><span style="color:#ff8000">1     </span>; if we find a dir, don&#039;t change to it
<span style="color:black">DOSCODE:7634                 </span><span style="color:navy">lds     si, </span>DMAADD
<span style="color:black">DOSCODE:7638                 </span>assume ds:nothing
<span style="color:black">DOSCODE:7638                 </span><span style="color:navy">lodsb                   </span>; Drive Byte
<span style="color:black">DOSCODE:7638 </span>DOS_SEARCH_NEXT <span style="color:black">endp
DOSCODE:7638
DOSCODE:7639
DOSCODE:7639 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7639
DOSCODE:7639
DOSCODE:7639 </span>RENAME_NEXT     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7639                 </span><span style="color:navy">mov     di, ss
</span><span style="color:black">DOSCODE:763B                 </span><span style="color:navy">mov     es, di
</span><span style="color:black">DOSCODE:763D                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:763D                 </span><span style="color:navy">mov     di, offset </span>NAME1
<span style="color:black">DOSCODE:7640                 </span><span style="color:navy">movsb                   </span>; Search name
<span style="color:black">DOSCODE:7641                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">5
</span><span style="color:black">DOSCODE:7644                 </span><span style="color:navy">rep movsw
</span><span style="color:black">DOSCODE:7646                 </span><span style="color:navy">lodsb                   </span>; Attribute
<span style="color:black">DOSCODE:7647                 </span><span style="color:navy">mov     ss:</span>ATTRIB<span style="color:navy">, al
</span><span style="color:black">DOSCODE:764B                 </span><span style="color:navy">lodsw                   </span>; LastEnt
<span style="color:black">DOSCODE:764C                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:764E                 </span><span style="color:navy">js      short </span>No_files
<span style="color:black">DOSCODE:7650
DOSCODE:7650 </span>cont_load<span style="color:navy">:                              </span>; Save LastEnt
<span style="color:black">DOSCODE:7650                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:7651                 </span><span style="color:navy">lodsw                   </span>; DirStart
<span style="color:black">DOSCODE:7652                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:black">DOSCODE:7654                 </span><span style="color:navy">lodsw                   </span>; DIRSTART_HW
<span style="color:black">DOSCODE:7655                 </span><span style="color:navy">mov     bp, ss
</span><span style="color:black">DOSCODE:7657                 </span><span style="color:navy">mov     ds, bp
</span><span style="color:black">DOSCODE:7659                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:7659                 </span><span style="color:navy">les     bp, </span>THISDPB     ; Recover ES:BP
<span style="color:black">DOSCODE:765D                 </span>assume es:nothing
<span style="color:black">DOSCODE:765D                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:bp+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:7662                 </span><span style="color:navy">jz      short </span><span style="color:gray">cont_load2 </span>; FAT32 fs
<span style="color:black">DOSCODE:7664                 </span><span style="color:navy">xor     ax, ax          </span>; 0
<span style="color:black">DOSCODE:7666
DOSCODE:7666 </span><span style="color:gray">cont_load2</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7666                 </span><span style="color:navy">mov     </span>ROOTCLUST_HW<span style="color:navy">, ax </span>; 0 or DIRSTART_HW
<span style="color:black">DOSCODE:7669                 </span><span style="color:navy">call    </span>SETDIRSRCH
<span style="color:black">DOSCODE:766C                 </span><span style="color:navy">jb      short </span><span style="color:gray">No_files_pop
</span><span style="color:black">DOSCODE:766E
DOSCODE:766E </span>SEARCH_GOON<span style="color:navy">:
</span><span style="color:black">DOSCODE:766E                 </span><span style="color:navy">call    </span>STARTSRCH
<span style="color:black">DOSCODE:7671                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:7672                 </span><span style="color:navy">call    </span>GETENT
<span style="color:black">DOSCODE:7675                 </span><span style="color:navy">jb      short </span>No_files
<span style="color:black">DOSCODE:7677                 </span><span style="color:navy">call    </span>NEXTENT
<span style="color:black">DOSCODE:767A                 </span><span style="color:navy">jb      short </span>No_files
<span style="color:black">DOSCODE:767C                 </span><span style="color:navy">xor     ah, ah          </span>; If Search_Next, can&#039;t be a DEV
<span style="color:black">DOSCODE:767E                 </span><span style="color:navy">jmp     </span>found_it
<span style="color:black">DOSCODE:7681 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7681
DOSCODE:7681 </span><span style="color:gray">No_files_pop</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7681                 </span><span style="color:navy">pop     ax              </span>; Clean stack
<span style="color:black">DOSCODE:7682
DOSCODE:7682 </span>No_files<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7682                 </span><span style="color:navy">jmp     </span>find_no_more
<span style="color:black">DOSCODE:7682 </span>RENAME_NEXT     <span style="color:black">endp
DOSCODE:7682
DOSCODE:7685
DOSCODE:7685 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7685
DOSCODE:7685
DOSCODE:7685 </span>DOS_ABORT       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7685                 </span><span style="color:navy">mov     es, ss:</span>CurrentPDB
<span style="color:black">DOSCODE:768A                 </span><span style="color:navy">mov     cx, es:</span><span style="color:green">32h      </span>; [ES:PDB.JFN_Length] ; Number of JFNs
<span style="color:black">DOSCODE:768F
DOSCODE:768F </span><span style="color:gray">reset_free_jfn</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:768F                 </span><span style="color:navy">mov     bx, cx
</span><span style="color:black">DOSCODE:7691                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:7692                 </span><span style="color:navy">dec     bx              </span>; get jfn (start with last one)
<span style="color:black">DOSCODE:7693                 </span><span style="color:navy">call    </span>$CLOSE
<span style="color:black">DOSCODE:7696                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:7697                 </span><span style="color:navy">loop    </span><span style="color:gray">reset_free_jfn  </span>; and do &#039;em all
<span style="color:black">DOSCODE:7699                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:769A                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:769B                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">111Dh
</span><span style="color:black">DOSCODE:769E                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - CLOSE ALL REMOTE FILES FOR PROCESS
<span style="color:black">DOSCODE:769E                                         </span>; DS???, SS = DOS CS
<span style="color:black">DOSCODE:76A0                 </span><span style="color:navy">call    </span>MFTCloseP       ; call far [JShare+(4*4)] ; 4 = MFTCloseP
<span style="color:black">DOSCODE:76A4                 </span><span style="color:navy">les     di, ss:</span>SFTFCB   ; (FCB cache) grab the pointer to the table
<span style="color:black">DOSCODE:76A9
DOSCODE:76A9 </span><span style="color:gray">SFTFCB_check</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:76A9                 </span><span style="color:navy">mov     cx, es
</span><span style="color:black">DOSCODE:76AB                 </span><span style="color:navy">or      cx, di
</span><span style="color:black">DOSCODE:76AD                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">FCBScanDone </span>; (FCB cache table) not installed
<span style="color:black">DOSCODE:76AF                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:76B0                 </span><span style="color:navy">mov     cx, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [es:di+SFT.SFCount]
<span style="color:black">DOSCODE:76B4                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">SFTFCB_check2
</span><span style="color:black">DOSCODE:76B6                 </span><span style="color:navy">lea     di, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [DI+SFT.SFTable]
<span style="color:black">DOSCODE:76B9                 </span><span style="color:navy">mov     ax, ss:</span>PROC_ID
<span style="color:black">DOSCODE:76BD
DOSCODE:76BD </span><span style="color:gray">FCBTest</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:76BD                 </span><span style="color:navy">cmp     es:[di+</span><span style="color:#ff8000">31h</span><span style="color:navy">], ax </span>; [es:di+SF_ENTRY.sf_PID]
<span style="color:black">DOSCODE:76C1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">FCBNext   </span>; not one of ours, skip it
<span style="color:black">DOSCODE:76C3                 </span><span style="color:navy">call    </span>SFT_FREE        ; blast ref count
<span style="color:black">DOSCODE:76C6
DOSCODE:76C6 </span><span style="color:gray">FCBNext</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:76C6                 </span><span style="color:navy">add     di, </span><span style="color:green">59          </span>; SF_ENTRY.size
<span style="color:black">DOSCODE:76C9                 </span><span style="color:navy">loop    </span><span style="color:gray">FCBTest
</span><span style="color:black">DOSCODE:76CB
DOSCODE:76CB </span><span style="color:gray">SFTFCB_check2</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:76CB                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:76CC                 </span><span style="color:navy">les     di, es:[di]
</span><span style="color:black">DOSCODE:76CF                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:76D2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SFTFCB_check
</span><span style="color:black">DOSCODE:76D4
DOSCODE:76D4 </span><span style="color:gray">FCBScanDone</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:76D4                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:76D6
DOSCODE:76D6 </span><span style="color:gray">Scan</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:76D6                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:76D7                 </span><span style="color:navy">call    </span>SFFromSFN
<span style="color:black">DOSCODE:76DA                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:76DB                 </span><span style="color:navy">jnb     short </span><span style="color:gray">Scan1
</span><span style="color:black">DOSCODE:76DD                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:76DE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:76DE
DOSCODE:76DE </span><span style="color:gray">Scan1</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:76DE                 </span><span style="color:navy">cmp     word ptr es:[di], </span><span style="color:green">0FFFFh </span>; sf_busy ; -1
<span style="color:black">DOSCODE:76DE                                         </span>; Is Sft busy?
<span style="color:black">DOSCODE:76E2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">scan_next </span>; no
<span style="color:black">DOSCODE:76E4                 </span><span style="color:navy">mov     ax, ss:</span>PROC_ID
<span style="color:black">DOSCODE:76E8                 </span><span style="color:navy">cmp     es:[di+</span><span style="color:#ff8000">31h</span><span style="color:navy">], ax </span>; [es:di+SF_ENTRY.sf_PID]
<span style="color:black">DOSCODE:76EC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">scan_next
</span><span style="color:black">DOSCODE:76EE                 </span><span style="color:navy">mov     ax, ss:</span>USER_ID
<span style="color:black">DOSCODE:76F2                 </span><span style="color:navy">sub     ax, es:[di+</span><span style="color:#ff8000">2Fh</span><span style="color:navy">] </span>; [es:di+SF_ENTRY.sf_UID]
<span style="color:black">DOSCODE:76F6                 </span><span style="color:navy">jnz     short </span><span style="color:gray">scan_next
</span><span style="color:black">DOSCODE:76F8                 </span><span style="color:navy">call    </span>SFT_FREE
<span style="color:black">DOSCODE:76FB
DOSCODE:76FB </span><span style="color:gray">scan_next</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:76FB                 </span><span style="color:navy">inc     bx
</span><span style="color:black">DOSCODE:76FC                 </span><span style="color:navy">jmp     short </span><span style="color:gray">Scan
</span><span style="color:black">DOSCODE:76FC </span>DOS_ABORT       <span style="color:black">endp
DOSCODE:76FC
DOSCODE:76FE
DOSCODE:76FE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:76FE
DOSCODE:76FE
DOSCODE:76FE </span>DOS_CLOSE       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:76FE                 </span><span style="color:navy">les     di, </span>THISSFT
<span style="color:black">DOSCODE:7702                 </span><span style="color:navy">mov     bx, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_flags]
<span style="color:black">DOSCODE:7706                 </span><span style="color:navy">test    bh, </span><span style="color:green">80h         </span>; (sf_isnet&gt;&gt;8)
<span style="color:black">DOSCODE:7709                 </span><span style="color:navy">jz      short </span>LocalClose
<span style="color:black">DOSCODE:770B                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1106h
</span><span style="color:black">DOSCODE:770E                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - CLOSE REMOTE FILE
<span style="color:black">DOSCODE:770E                                         </span>; ES:DI -&gt; SFT
<span style="color:black">DOSCODE:770E                                         </span>; SFT DPB field -&gt; DPB of drive containing file
<span style="color:black">DOSCODE:770E                                         </span>; Return: CF set on error, AX = DOS error code
<span style="color:black">DOSCODE:770E                                         </span>; CF clear if successful
<span style="color:black">DOSCODE:7710                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7711 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7711
DOSCODE:7711 </span>LocalClose<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7711                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:7714                 </span><span style="color:navy">call    </span>SetSFTTimes
<span style="color:black">DOSCODE:7717                 </span><span style="color:navy">call    </span>FREE_SFT        ; dec ref count or mark as busy
<span style="color:black">DOSCODE:771A                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:771B                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:771C                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:771D                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:771E                 </span><span style="color:navy">call    </span>ShareEnd
<span style="color:black">DOSCODE:7721                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:7722                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:7722 </span>DOS_CLOSE       <span style="color:black">endp
DOSCODE:7722
</span><span style="color:maroon">DOSCODE:7723
DOSCODE:7723 </span>CloseEntry<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7723                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:7724                 </span><span style="color:navy">test    bx, </span><span style="color:green">0C0h        </span>; devid_file_clean+devid_device
<span style="color:maroon">DOSCODE:7728                 </span><span style="color:navy">jz      short </span>rdir
<span style="color:maroon">DOSCODE:772A                 </span><span style="color:navy">jmp     </span>FREE_SFT_OK
<span style="color:maroon">DOSCODE:772D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:772D
DOSCODE:772D </span>rdir<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:772D                 </span><span style="color:navy">call    </span>DirFromSFT
<span style="color:maroon">DOSCODE:7730                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">5           </span>; error_access_denied
<span style="color:maroon">DOSCODE:7732                 </span><span style="color:navy">jb      short </span>jmp_to_CloseFinish
<span style="color:maroon">DOSCODE:7734                 </span><span style="color:navy">test    word ptr [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">4 </span>; [SI+SF_ENTRY.sf_mode],
<span style="color:maroon">DOSCODE:7734                                         </span>; devid_device_null ; bit 2 - null device
<span style="color:maroon">DOSCODE:7739                 </span><span style="color:navy">jnz     short </span>clook
<span style="color:maroon">DOSCODE:773B                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:773C                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:773D                 </span><span style="color:navy">lds     bx, [si+</span><span style="color:#ff8000">7</span><span style="color:navy">]      </span>; [si+SF_ENTRY.sf_devptr]
<span style="color:maroon">DOSCODE:7740                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:7740                 </span><span style="color:navy">mov     bl, [bx]        </span>; DPB.DRIVE
<span style="color:maroon">DOSCODE:7742                 </span><span style="color:navy">xor     bh, bh          </span>; 0
<span style="color:maroon">DOSCODE:7744                 </span><span style="color:navy">test    ss:</span>drive_flags<span style="color:navy">[bx], </span><span style="color:green">4 </span>; bit 2 - last access date/time flag?
<span style="color:maroon">DOSCODE:774A                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:774B                 </span><span style="color:navy">jz      short </span>skip_upd_laccdt ; no support for last access date&amp;time
<span style="color:maroon">DOSCODE:774D                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:774E                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:774F                 </span><span style="color:navy">call    </span>DATE16
<span style="color:maroon">DOSCODE:7752                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">12h</span><span style="color:navy">], ax </span>; [es:di+dir_entry.dir_lstaccdate]
<span style="color:maroon">DOSCODE:7756
DOSCODE:7756 </span>skip_upd_laccdt<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7756                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:7757
DOSCODE:7757 </span>clook<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7757                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:7758                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:7759                 </span><span style="color:navy">lea     si, [si+</span><span style="color:#ff8000">20h</span><span style="color:navy">]    </span>; [SI+SF_ENTRY.sf_name]
<span style="color:maroon">DOSCODE:775C                 </span><span style="color:navy">call    </span>XCHGP
<span style="color:maroon">DOSCODE:775F                 </span><span style="color:navy">call    </span>MetaCompare
<span style="color:maroon">DOSCODE:7762                 </span><span style="color:navy">call    </span>XCHGP
<span style="color:maroon">DOSCODE:7765                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:7766                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:7767                 </span><span style="color:navy">jz      short </span>CLOSE_GO  ; Name OK
<span style="color:maroon">DOSCODE:7769
DOSCODE:7769 </span>Bye<span style="color:navy">:
</span><span style="color:maroon">DOSCODE:7769                 </span><span style="color:navy">mov     di, si
</span><span style="color:maroon">DOSCODE:776B                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:776C                 </span><span style="color:navy">pop     es              </span>; ES:DI points to SFT
<span style="color:maroon">DOSCODE:776D                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:776E                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:776F                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:776F                 </span><span style="color:navy">stc
</span><span style="color:maroon">DOSCODE:7770                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2           </span>; error_file_not_found
<span style="color:maroon">DOSCODE:7772
DOSCODE:7772 </span>jmp_to_CloseFinish<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7772                 </span><span style="color:navy">jmp     </span>CloseFinish2
<span style="color:maroon">DOSCODE:7775 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:7775
DOSCODE:7775 </span>CLOSE_GO<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7775                 </span><span style="color:navy">mov     al, [si+</span><span style="color:#ff8000">4</span><span style="color:navy">]      </span>; [SI+SF_ENTRY.sf_attr]
<span style="color:maroon">DOSCODE:7778                 </span><span style="color:navy">test    word ptr [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">8000h </span>; [SI+SF_ENTRY.sf_mode],sf_isFCB
<span style="color:maroon">DOSCODE:777D                 </span><span style="color:navy">jz      short </span>nofcb
<span style="color:maroon">DOSCODE:777F                 </span><span style="color:navy">mov     ch, es:[di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">] </span>; [ES:DI+dir_entry.dir_attr]
<span style="color:maroon">DOSCODE:7783                 </span><span style="color:navy">mov     ss:</span>ATTRIB<span style="color:navy">, al
</span><span style="color:maroon">DOSCODE:7787                 </span><span style="color:navy">jmp     short </span>setattr
<span style="color:maroon">DOSCODE:7789 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:7789
DOSCODE:7789 </span>nofcb<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7789                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], al </span>; [ES:DI+dir_entry.dir_attr]
<span style="color:maroon">DOSCODE:778D
DOSCODE:778D </span>setattr<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:778D                 </span><span style="color:navy">or      byte ptr es:[di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], </span><span style="color:green">20h </span>; [ES:DI+dir_entry.dir_attr],
<span style="color:maroon">DOSCODE:778D                                         </span>; attr_archive
<span style="color:maroon">DOSCODE:7792                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">1Ah</span><span style="color:navy">] </span>; [ES:DI+dir_entry.dir_first]
<span style="color:maroon">DOSCODE:7796                 </span><span style="color:navy">mov     ss:</span>OLD_FIRSTCLUS<span style="color:navy">, ax </span>; save old first cluster
<span style="color:maroon">DOSCODE:779A                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">14h</span><span style="color:navy">] </span>; [ES:DI+dir_entry.dir_fclus_hi]
<span style="color:maroon">DOSCODE:779E                 </span><span style="color:navy">mov     ss:</span>OLD_FIRSTCLUS_HW<span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:77A2                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">2Bh</span><span style="color:navy">]    </span>; [SI+SF_ENTRY.sf_chain]
<span style="color:maroon">DOSCODE:77A2                                         </span>; first cluster (32 bit) low word !?
<span style="color:maroon">DOSCODE:77A5                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">1Ah</span><span style="color:navy">], ax </span>; [ES:DI+dir_entry.dir_first]
<span style="color:maroon">DOSCODE:77A9                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">]    </span>; [SI+SF_ENTRY.sf_chain+2]
<span style="color:maroon">DOSCODE:77A9                                         </span>; first cluster (32 bit) high word !?
<span style="color:maroon">DOSCODE:77AC                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">14h</span><span style="color:navy">], ax </span>; [ES:DI+dir_entry.dir_fclus_hi]
<span style="color:maroon">DOSCODE:77B0                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:77B1                 </span><span style="color:navy">lds     ax, [si+</span><span style="color:#ff8000">11h</span><span style="color:navy">]    </span>; [SI+SF_ENTRY.sf_size]
<span style="color:maroon">DOSCODE:77B4                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:77B4                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">1Ch</span><span style="color:navy">], ax </span>; [ES:DI+dir_entry.dir_size_l]
<span style="color:maroon">DOSCODE:77B8                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">1Eh</span><span style="color:navy">], ds </span>; [ES:DI+dir_entry.dir_size_h]
<span style="color:maroon">DOSCODE:77BC                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:77BD                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:77BE                 </span><span style="color:navy">lds     ax, [si+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">]    </span>; [SI+SF_ENTRY.sf_time]
<span style="color:maroon">DOSCODE:77C1                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">16h</span><span style="color:navy">], ax </span>; [ES:DI+dir_entry.dir_time]
<span style="color:maroon">DOSCODE:77C5                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">18h</span><span style="color:navy">], ds </span>; [ES:DI+dir_entry.dir_date]
<span style="color:maroon">DOSCODE:77C9                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:77CA                 </span><span style="color:navy">test    byte ptr es:[bx+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [ES:BX+BUFFINFO.buf_flags],
<span style="color:maroon">DOSCODE:77CA                                         </span>; buf_dirty
<span style="color:maroon">DOSCODE:77CF                 </span><span style="color:navy">jnz     short </span>yesdirty4
<span style="color:maroon">DOSCODE:77D1                 </span><span style="color:navy">call    </span>INC_DIRTY_COUNT
<span style="color:maroon">DOSCODE:77D4                 </span><span style="color:navy">or      byte ptr es:[bx+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [ES:BX+BUFFINFO.buf_flags],
<span style="color:maroon">DOSCODE:77D4                                         </span>; buf_dirty
<span style="color:maroon">DOSCODE:77D9
DOSCODE:77D9 </span>yesdirty4<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:77D9                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:77DA                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:77DB                 </span><span style="color:navy">mov     cx, [si+</span><span style="color:#ff8000">2Bh</span><span style="color:navy">]    </span>; [es:di+SF_ENTRY.sf_chain]
<span style="color:maroon">DOSCODE:77DB                                         </span>; first cluster (32 bit) low word !?
<span style="color:maroon">DOSCODE:77DE                 </span><span style="color:navy">mov     al, ss:</span>THISDRV
<span style="color:maroon">DOSCODE:77E2                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:77E3                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0           </span>; dir entry update
<span style="color:maroon">DOSCODE:77E5                 </span><span style="color:navy">mov     dl, al
</span><span style="color:maroon">DOSCODE:77E7                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:77E8                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">]    </span>; [es:di+SF_ENTRY.sf_chain+2]
<span style="color:maroon">DOSCODE:77E8                                         </span>; first cluster (32 bit) high word !?
<span style="color:maroon">DOSCODE:77EB                 </span><span style="color:navy">or      bx, bx
</span><span style="color:maroon">DOSCODE:77ED                 </span><span style="color:navy">jnz     short </span>do_update2
<span style="color:maroon">DOSCODE:77EF                 </span><span style="color:navy">or      cx, cx
</span><span style="color:maroon">DOSCODE:77F1                 </span><span style="color:navy">jnz     short </span>do_update2
<span style="color:maroon">DOSCODE:77F3                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">3           </span>; do a delete cache entry
<span style="color:maroon">DOSCODE:77F5                 </span><span style="color:navy">mov     dh, [si+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">]    </span>; [SI+SF_ENTRY.sf_dirpos]
<span style="color:maroon">DOSCODE:77F8                 </span><span style="color:navy">lds     di, [si+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">]    </span>; [SI+SF_ENTRY.sf_dirsec]
<span style="color:maroon">DOSCODE:77FB                 </span><span style="color:navy">mov     cx, ds          </span>; cx:di = dir sector
<span style="color:maroon">DOSCODE:77FD                 </span><span style="color:navy">jmp     short </span>do_update
<span style="color:maroon">DOSCODE:77FF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:77FF
DOSCODE:77FF </span>do_update2<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:77FF                 </span><span style="color:navy">cmp     bx, ss:</span>OLD_FIRSTCLUS_HW ; same as old first cluster?
<span style="color:maroon">DOSCODE:7804                 </span><span style="color:navy">jnz     short </span>do_update3 ; no
<span style="color:maroon">DOSCODE:7806                 </span><span style="color:navy">cmp     cx, ss:</span>OLD_FIRSTCLUS
<span style="color:maroon">DOSCODE:780B                 </span><span style="color:navy">jz      short </span>do_update ; yes
<span style="color:maroon">DOSCODE:780D
DOSCODE:780D </span>do_update3<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:780D                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2           </span>; delete the old entry
<span style="color:maroon">DOSCODE:780F                 </span><span style="color:navy">mov     cx, ss:</span>OLD_FIRSTCLUS
<span style="color:maroon">DOSCODE:7814                 </span><span style="color:navy">mov     bx, ss:</span>OLD_FIRSTCLUS_HW
<span style="color:maroon">DOSCODE:7819
DOSCODE:7819 </span>do_update<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7819                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:781A                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:781B                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:781B                 </span><span style="color:navy">xchg    bx, si
</span><span style="color:maroon">DOSCODE:781D                 </span><span style="color:navy">call    </span>FastOpen_Update ; invoke fastopen
<span style="color:maroon">DOSCODE:7820                 </span><span style="color:navy">xchg    bx, si
</span><span style="color:maroon">DOSCODE:7822                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:7823                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:7824                 </span><span style="color:navy">call    </span>FLUSHBUF        ; flush all relevant buffers
<span style="color:maroon">DOSCODE:7827                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:7828                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:7829                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">5           </span>; error_access_denied
<span style="color:maroon">DOSCODE:782B                 </span><span style="color:navy">jb      short </span>CloseFinish
<span style="color:maroon">DOSCODE:782D
DOSCODE:782D </span>FREE_SFT_OK<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:782D                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">8080h </span>; [ES:DI+SF_ENTRY.sf_flags],
<span style="color:maroon">DOSCODE:782D                                         </span>; sf_isnet+devid_device
<span style="color:maroon">DOSCODE:7833                 </span><span style="color:navy">jnz     short </span>CloseFinish2
<span style="color:maroon">DOSCODE:7835                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:7836                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">DOSCODE:7837                 </span><span style="color:navy">les     bp, es:[di+</span><span style="color:#ff8000">7</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_devptr]
<span style="color:maroon">DOSCODE:783B                 </span><span style="color:navy">call    </span>update_fat32_fsinfo
<span style="color:maroon">DOSCODE:783E                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSCODE:783F                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:7840                 </span><span style="color:navy">jmp     short </span>CloseFinish2
<span style="color:maroon">DOSCODE:7842 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:7842
DOSCODE:7842 </span>CloseFinish<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7842                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:7843                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:7844                 </span><span style="color:navy">lds     bx, es:[di+</span><span style="color:#ff8000">7</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_devptr]
<span style="color:maroon">DOSCODE:7848                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:7848                 </span><span style="color:navy">mov     bl, [bx]        </span>; DPB.DRIVE
<span style="color:maroon">DOSCODE:784A                 </span><span style="color:navy">xor     bh, bh          </span>; 0
<span style="color:maroon">DOSCODE:784C                 </span><span style="color:navy">and     ss:</span>drive_flags<span style="color:navy">[bx], </span><span style="color:green">0FBh </span>; clear bit 2
<span style="color:maroon">DOSCODE:7852                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:7853                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:7854                 </span><span style="color:navy">stc
</span><span style="color:maroon">DOSCODE:7855
DOSCODE:7855 </span>CloseFinish2<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7855                 </span><span style="color:navy">pushf
</span><span style="color:maroon">DOSCODE:7856                 </span><span style="color:navy">call    </span>DEV_CLOSE_SFT
<span style="color:maroon">DOSCODE:7859 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:7859                 </span><span style="color:navy">popf
</span><span style="color:maroon">DOSCODE:785A                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:785B                 </span><span style="color:navy">pushf
</span><span style="color:maroon">DOSCODE:785C                 </span><span style="color:navy">loop    </span>NoFree
<span style="color:maroon">DOSCODE:785E                 </span><span style="color:navy">call    </span>SFT_FREE
<span style="color:black">DOSCODE:7861 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR DOS_COMMIT
</span><span style="color:black">DOSCODE:7861
DOSCODE:7861 </span>NoFree<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7861                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:7864                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:7865                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7865 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR DOS_COMMIT
</span><span style="color:black">DOSCODE:7866
DOSCODE:7866 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7866
DOSCODE:7866
DOSCODE:7866 </span>FREE_SFT        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7866                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:7867                 </span><span style="color:navy">mov     ax, es:[di]     </span>; [ES:DI+SF_ENTRY.sf_ref_count]
<span style="color:black">DOSCODE:786A                 </span><span style="color:navy">dec     ax
</span><span style="color:black">DOSCODE:786B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SetCount
</span><span style="color:black">DOSCODE:786D                 </span><span style="color:navy">dec     ax
</span><span style="color:black">DOSCODE:786E
DOSCODE:786E </span><span style="color:gray">SetCount</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:786E                 </span><span style="color:navy">xchg    ax, es:[di]
</span><span style="color:black">DOSCODE:7871                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:7872                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7872 </span>FREE_SFT        <span style="color:black">endp
DOSCODE:7872
DOSCODE:7873
DOSCODE:7873 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7873
DOSCODE:7873
DOSCODE:7873 </span>DirFromSFT      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7873                 </span><span style="color:navy">call    </span>set_exerr_locus_disk
<span style="color:black">DOSCODE:7876                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:7877                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:7878                 </span><span style="color:navy">mov     dx, es:[di+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_dirsec+2]
<span style="color:black">DOSCODE:787C                 </span><span style="color:navy">mov     ds:</span>HIGH_SECTOR<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:7880                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:7881                 </span><span style="color:navy">mov     dx, es:[di+</span><span style="color:#ff8000">1Bh</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_dirsec]
<span style="color:black">DOSCODE:7885                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:7886                 </span><span style="color:navy">call    </span>FATREAD_SFT
<span style="color:black">DOSCODE:7889                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:788A                 </span><span style="color:navy">pop     ds:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:788E                 </span><span style="color:navy">jb      short </span><span style="color:gray">PopDone
</span><span style="color:black">DOSCODE:7890                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">DOSCODE:7892                 </span><span style="color:navy">mov     ds:</span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">18h </span>; Allowed_FAIL+Allowed_RETRY
<span style="color:black">DOSCODE:7897                 </span><span style="color:navy">call    </span>GETBUFFR
<span style="color:black">DOSCODE:789A                 </span><span style="color:navy">jb      short </span><span style="color:gray">PopDone
</span><span style="color:black">DOSCODE:789C                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:789D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:789E                 </span><span style="color:navy">les     di, ss:</span>CURBUF
<span style="color:black">DOSCODE:78A3                 </span><span style="color:navy">or      byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">4 </span>; [ES:DI+BUFFINFO.buf_flags],
<span style="color:black">DOSCODE:78A3                                         </span>; buf_isDIR
<span style="color:black">DOSCODE:78A8                 </span><span style="color:navy">mov     bx, di
</span><span style="color:black">DOSCODE:78AA                 </span><span style="color:navy">lea     di, [di+</span><span style="color:#ff8000">18h</span><span style="color:navy">]    </span>; [DI+BUFINSIZ] ; Point to buffer
<span style="color:black">DOSCODE:78AD                 </span><span style="color:navy">mov     al, </span><span style="color:green">32          </span>; dir_entry.size
<span style="color:black">DOSCODE:78AF                 </span><span style="color:navy">mul     byte ptr [si+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">] </span>; [SI+SF_ENTRY.sf_dirpos]
<span style="color:black">DOSCODE:78B2                 </span><span style="color:navy">add     di, ax          </span>; Point at the entry
<span style="color:black">DOSCODE:78B4                 </span><span style="color:navy">retn                    </span>; carry is clear
<span style="color:black">DOSCODE:78B5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:78B5
DOSCODE:78B5 </span><span style="color:gray">PopDone</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:78B5                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:78B6                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:78B7
DOSCODE:78B7 </span>PopDone_retn<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:78B7                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:78B7 </span>DirFromSFT      <span style="color:black">endp
DOSCODE:78B7
DOSCODE:78B8
DOSCODE:78B8 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:78B8
DOSCODE:78B8
DOSCODE:78B8 </span>DOS_COMMIT      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:78B8
DOSCODE:78B8 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:7861 SIZE 00000005 BYTES
</span><span style="color:black">DOSCODE:78B8
DOSCODE:78B8                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:black">DOSCODE:78BC                 </span><span style="color:navy">mov     bx, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:78C0                 </span><span style="color:navy">test    bl, </span><span style="color:green">0C0h
</span><span style="color:black">DOSCODE:78C3                 </span><span style="color:navy">jnz     short </span>PopDone_retn
<span style="color:black">DOSCODE:78C5                 </span><span style="color:navy">test    bh, </span><span style="color:green">80h
</span><span style="color:black">DOSCODE:78C8                 </span><span style="color:navy">jz      short </span><span style="color:gray">LOCAL_COMMIT
</span><span style="color:black">DOSCODE:78CA                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1107h
</span><span style="color:black">DOSCODE:78CD                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - COMMIT REMOTE FILE
<span style="color:black">DOSCODE:78CD                                         </span>; ES:DI -&gt; SFT
<span style="color:black">DOSCODE:78CD                                         </span>; SFT DPB field -&gt; DPB of drive containing file
<span style="color:black">DOSCODE:78CD                                         </span>; Return: CF set on error, AX = DOS error code
<span style="color:black">DOSCODE:78CD                                         </span>; CF clear if successful
<span style="color:black">DOSCODE:78CF
DOSCODE:78CF </span>localcommit_retn<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:78CF                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:78D0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:78D0
DOSCODE:78D0 </span><span style="color:gray">LOCAL_COMMIT</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:78D0                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:78D3                 </span><span style="color:navy">call    </span>SetSFTTimes
<span style="color:black">DOSCODE:78D6                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:78D9                 </span><span style="color:navy">call    </span>CloseEntry
<span style="color:black">DOSCODE:78DC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:78DC                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:78DD                 </span><span style="color:navy">call    </span>DEV_OPEN_SFT
<span style="color:black">DOSCODE:78E0                 </span><span style="color:navy">jmp     </span>NoFree
<span style="color:black">DOSCODE:78E0 </span>DOS_COMMIT      <span style="color:black">endp
DOSCODE:78E0
DOSCODE:78E3
DOSCODE:78E3 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:78E3
DOSCODE:78E3
DOSCODE:78E3 </span>SetSFTTimes     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:78E3                 </span><span style="color:navy">test    bx, </span><span style="color:green">40C0h       </span>; sf_close_nodate+devid_file_clean+devid_device
<span style="color:black">DOSCODE:78E7                 </span><span style="color:navy">jnz     short </span>localcommit_retn
<span style="color:black">DOSCODE:78E9                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:78EA                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:78EB                 </span><span style="color:navy">call    </span>DATE16          ; Date/Time to AX/DX
<span style="color:black">DOSCODE:78EE                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_date]
<span style="color:black">DOSCODE:78F2                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">], dx </span>; [ES:DI+SF_ENTRY.sf_time]
<span style="color:black">DOSCODE:78F6                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:78F8                 </span><span style="color:navy">call    ds:</span>ShSU         ; call far [JShare+(14*4)] ; 14 = ShSU
<span style="color:black">DOSCODE:78FC                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:78FD                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:78FE                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:78FE </span>SetSFTTimes     <span style="color:black">endp
DOSCODE:78FE
DOSCODE:78FF
DOSCODE:78FF </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:78FF
DOSCODE:78FF
DOSCODE:78FF </span>DOS_MKDIR       <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:78FF
DOSCODE:78FF </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:710B SIZE 00000007 BYTES
</span><span style="color:black">DOSCODE:78FF </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:790A SIZE 00000008 BYTES
</span><span style="color:black">DOSCODE:78FF </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:7912 SIZE 000000DD BYTES
</span><span style="color:black">DOSCODE:78FF </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:79F2 SIZE 00000031 BYTES
</span><span style="color:black">DOSCODE:78FF
DOSCODE:78FF                 </span><span style="color:navy">call    </span>TestNet
<span style="color:black">DOSCODE:7902                 </span><span style="color:navy">jnb     short </span>LOCAL_MKDIR
<span style="color:black">DOSCODE:7904                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1103h
</span><span style="color:black">DOSCODE:7907                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - MAKE REMOTE DIRECTORY
<span style="color:black">DOSCODE:7907                                         </span>; SS = DOS CS
<span style="color:black">DOSCODE:7907                                         </span>; SDA first filename pointer -&gt; fully-qualified directory name
<span style="color:black">DOSCODE:7907                                         </span>; SDA CDS pointer -&gt; current directory
<span style="color:black">DOSCODE:7907                                         </span>; Return: CF set on error, AX = DOS error code
<span style="color:black">DOSCODE:7907                                         </span>; CF clear if successful
<span style="color:black">DOSCODE:7909                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7909 </span>DOS_MKDIR       <span style="color:black">endp
DOSCODE:7909
DOSCODE:790A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:790A </span><span style="color:gray">; START OF FUNCTION CHUNK FOR DOS_CHDIR
</span><span style="color:black">DOSCODE:790A </span><span style="color:gray">;   ADDITIONAL PARENT FUNCTION DOS_MKDIR
</span><span style="color:black">DOSCODE:790A
DOSCODE:790A </span>NODEACCERRJ<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:790A                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5           </span>; error_access_denied
<span style="color:black">DOSCODE:790D
DOSCODE:790D </span>_BadRet<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:790D                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:790E
DOSCODE:790E </span><span style="color:gray">chdir_mkdir_done</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:790E                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:7911                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7911 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR DOS_CHDIR
</span><span style="color:black">DOSCODE:7912 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7912 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR DOS_MKDIR
</span><span style="color:black">DOSCODE:7912
DOSCODE:7912 </span>PATHNFJ<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7912                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:7915                 </span><span style="color:navy">jmp     </span>SET_MKND_ERR
<span style="color:black">DOSCODE:7918 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7918
DOSCODE:7918 </span>LOCAL_MKDIR<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7918                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:791B                 </span><span style="color:navy">mov     word ptr ds:</span>THISSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ss
</span><span style="color:black">DOSCODE:791F                 </span><span style="color:navy">mov     word ptr ds:</span>THISSFT<span style="color:navy">, offset </span>RENBUF
<span style="color:black">DOSCODE:7925                 </span><span style="color:navy">mov     word ptr ds:</span>RENBUF<span style="color:navy">+</span><span style="color:green">33h</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; [RENBUF+SF_ENTRY.sf_MFT]
<span style="color:black">DOSCODE:7925                                         </span>; make sure SHARER won&#039;t complain.
<span style="color:black">DOSCODE:792B                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">10h         </span>; attr_directory
<span style="color:black">DOSCODE:792D                 </span><span style="color:navy">call    </span>MakeNode
<span style="color:black">DOSCODE:7930                 </span><span style="color:navy">jb      short </span>PATHNFJ
<span style="color:black">DOSCODE:7932                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:7935                 </span><span style="color:navy">jz      short </span>NODEACCERRJ ; Can&#039;t make a device into a directory
<span style="color:black">DOSCODE:7937                 </span><span style="color:navy">les     bp, ds:</span>THISDPB  ; Makenode zaps this
<span style="color:black">DOSCODE:793B                 </span><span style="color:navy">lds     di, ds:</span>CURBUF
<span style="color:black">DOSCODE:793F                 </span><span style="color:navy">sub     si, di
</span><span style="color:black">DOSCODE:7941                 </span><span style="color:navy">push    si              </span>; Pointer to dir_first
<span style="color:black">DOSCODE:7942                 </span><span style="color:navy">lds     ax, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [DI+BUFFINFO.buf_sector]
<span style="color:black">DOSCODE:7945                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:7946                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:7947                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:7948                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7949                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:7949                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:794B                 </span><span style="color:navy">mov     dx, ax          </span>; 0
<span style="color:black">DOSCODE:794D                 </span><span style="color:navy">xchg    dx, </span>DIRSTART_HW ; Null directory
<span style="color:black">DOSCODE:7951                 </span><span style="color:navy">xchg    ax, </span>DIRSTART
<span style="color:black">DOSCODE:7955                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:bp+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:795A                 </span><span style="color:navy">jnz     short </span>LOCAL_MKDIR_cont ; not FAT32
<span style="color:black">DOSCODE:795C                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">35h</span><span style="color:navy">], ax </span>; [es:bp+DPB.ROOT_CLUSTER]
<span style="color:black">DOSCODE:7960                 </span><span style="color:navy">jnz     short </span>LOCAL_MKDIR_cont
<span style="color:black">DOSCODE:7962                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">37h</span><span style="color:navy">], dx </span>; [es:bp+DPB.ROOT_CLUSTER+2]
<span style="color:black">DOSCODE:7966                 </span><span style="color:navy">jnz     short </span>LOCAL_MKDIR_cont
<span style="color:black">DOSCODE:7968                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:796A                 </span><span style="color:navy">xor     dx, dx          </span>; dx:ax = 0 for root directory
<span style="color:black">DOSCODE:796C
DOSCODE:796C </span>LOCAL_MKDIR_cont<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:796C                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:796D                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:796E                 </span><span style="color:navy">call    </span>NEWDIR
<span style="color:black">DOSCODE:7971                 </span><span style="color:navy">jb      short </span>NODEEXISTSPOPDEL
<span style="color:black">DOSCODE:7973                 </span><span style="color:navy">call    </span>GETENT
<span style="color:black">DOSCODE:7976                 </span><span style="color:navy">jb      short </span>NODEEXISTSPOPDEL
<span style="color:black">DOSCODE:7978                 </span><span style="color:navy">les     di, </span>CURBUF
<span style="color:black">DOSCODE:797C                 </span><span style="color:navy">call    </span>SET_BUF_DIRTY
<span style="color:black">DOSCODE:797F
DOSCODE:797F </span>yesdirty5<span style="color:navy">:
</span><span style="color:black">DOSCODE:797F                 </span><span style="color:navy">add     di, </span><span style="color:green">24
</span><span style="color:black">DOSCODE:7982                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">202Eh       </span>; &quot;. &quot; ; (NASM syntax)
<span style="color:black">DOSCODE:7985                 </span><span style="color:navy">mov     dx, </span>DIRSTART_HW
<span style="color:black">DOSCODE:7989                 </span><span style="color:navy">mov     </span>CLUSTERS_HW<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:798D                 </span><span style="color:navy">mov     dx, </span>DIRSTART
<span style="color:black">DOSCODE:7991                 </span><span style="color:navy">call    </span>SETDOTENT
<span style="color:black">DOSCODE:7994                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2E2Eh       </span>; &quot;..&quot;
<span style="color:black">DOSCODE:7997                 </span><span style="color:navy">pop     dx              </span>; Parent
<span style="color:black">DOSCODE:7998                 </span><span style="color:navy">pop     </span>CLUSTERS_HW
<span style="color:black">DOSCODE:799C                 </span><span style="color:navy">call    </span>SETDOTENT
<span style="color:black">DOSCODE:799F                 </span><span style="color:navy">les     bp, </span>THISDPB
<span style="color:black">DOSCODE:79A3                 </span><span style="color:navy">mov     </span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">18h    </span>; Allowed_FAIL+Allowed_RETRY
<span style="color:black">DOSCODE:79A8                 </span><span style="color:navy">pop     dx              </span>; Entry sector
<span style="color:black">DOSCODE:79A9                 </span><span style="color:navy">pop     </span>HIGH_SECTOR
<span style="color:black">DOSCODE:79AD                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">DOSCODE:79AF                 </span><span style="color:navy">call    </span>GETBUFFR        ; Pre read
<span style="color:black">DOSCODE:79B2                 </span><span style="color:navy">jb      short </span>NODEEXISTSP
<span style="color:black">DOSCODE:79B4                 </span><span style="color:navy">mov     ax, </span>DIRSTART_HW
<span style="color:black">DOSCODE:79B7                 </span><span style="color:navy">mov     dx, </span>DIRSTART
<span style="color:black">DOSCODE:79BB                 </span><span style="color:navy">lds     di, </span>CURBUF
<span style="color:black">DOSCODE:79BF                 </span>assume ds:nothing
<span style="color:black">DOSCODE:79BF                 </span><span style="color:navy">or      byte ptr [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">4 </span>; [DI+BUFFINFO.buf_flags],buf_isDIR
<span style="color:black">DOSCODE:79C3                 </span><span style="color:navy">pop     si              </span>; dir_first pointer
<span style="color:black">DOSCODE:79C4                 </span><span style="color:navy">add     si, di
</span><span style="color:black">DOSCODE:79C6                 </span><span style="color:navy">mov     [si], dx        </span>; dir_entry.dir_first
<span style="color:black">DOSCODE:79C8                 </span><span style="color:navy">mov     [si-</span><span style="color:green">6</span><span style="color:navy">], ax      </span>; dir_entry.dir_fclus_hi
<span style="color:black">DOSCODE:79CB                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:79CD                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], dx      </span>; Zero size
<span style="color:black">DOSCODE:79D0                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], dx
</span><span style="color:black">DOSCODE:79D3
DOSCODE:79D3 </span>DIRUP<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:79D3                 </span><span style="color:navy">test    byte ptr [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [DI+BUFFINFO.buf_flags],buf_dirty
<span style="color:black">DOSCODE:79D7                 </span><span style="color:navy">jnz     short </span>yesdirty6 ; already dirty
<span style="color:black">DOSCODE:79D9                 </span><span style="color:navy">call    </span>INC_DIRTY_COUNT
<span style="color:black">DOSCODE:79DC                 </span><span style="color:navy">or      byte ptr [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [DI+BUFFINFO.buf_flags],buf_dirty
<span style="color:black">DOSCODE:79E0
DOSCODE:79E0 </span>yesdirty6<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:79E0                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:79E1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:79E2                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:79E2                 </span><span style="color:navy">call    </span>update_fat32_fsinfo
<span style="color:black">DOSCODE:79E5                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; [ES:BP+DPB.DRIVE]
<span style="color:black">DOSCODE:79E9                 </span><span style="color:navy">call    </span>FLUSHBUF
<span style="color:black">DOSCODE:79EC                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5           </span>; error_access_denied
<span style="color:black">DOSCODE:79EC </span><span style="color:gray">; END OF FUNCTION CHUNK FOR DOS_MKDIR
</span><span style="color:black">DOSCODE:79EF </span><span style="color:gray">; START OF FUNCTION CHUNK FOR DOS_CHDIR
</span><span style="color:black">DOSCODE:79EF
DOSCODE:79EF </span><span style="color:gray">lmd_cd_done</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:79EF                 </span><span style="color:navy">jmp     </span><span style="color:gray">chdir_mkdir_done
</span><span style="color:black">DOSCODE:79EF </span><span style="color:gray">; END OF FUNCTION CHUNK FOR DOS_CHDIR
</span><span style="color:black">DOSCODE:79F2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:79F2 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR DOS_MKDIR
</span><span style="color:black">DOSCODE:79F2
DOSCODE:79F2 </span>NODEEXISTSPOPDEL<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:79F2                 </span><span style="color:navy">pop     dx              </span>; Parent
<span style="color:black">DOSCODE:79F3                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:79F4                 </span><span style="color:navy">pop     dx              </span>; Entry sector
<span style="color:black">DOSCODE:79F5                 </span><span style="color:navy">pop     </span>HIGH_SECTOR
<span style="color:black">DOSCODE:79F9                 </span><span style="color:navy">les     bp, </span>THISDPB
<span style="color:black">DOSCODE:79FD                 </span><span style="color:navy">mov     </span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">18h    </span>; Allowed_FAIL+Allowed_RETRY
<span style="color:black">DOSCODE:7A02                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">DOSCODE:7A04                 </span><span style="color:navy">call    </span>GETBUFFR        ; Pre read
<span style="color:black">DOSCODE:7A07                 </span><span style="color:navy">jb      short </span>NODEEXISTSP
<span style="color:black">DOSCODE:7A09                 </span><span style="color:navy">lds     di, </span>CURBUF
<span style="color:black">DOSCODE:7A0D                 </span>assume ds:nothing
<span style="color:black">DOSCODE:7A0D                 </span><span style="color:navy">or      byte ptr [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">4 </span>; [DI+BUFFINFO.buf_flags],buf_isDIR
<span style="color:black">DOSCODE:7A11                 </span><span style="color:navy">pop     si              </span>; dir_first pointer
<span style="color:black">DOSCODE:7A12                 </span><span style="color:navy">add     si, di
</span><span style="color:black">DOSCODE:7A14                 </span><span style="color:navy">sub     si, </span><span style="color:green">26          </span>; dir_entry.dir_first
<span style="color:black">DOSCODE:7A14                                         </span>; Point back to start of dir entry
<span style="color:black">DOSCODE:7A17                 </span><span style="color:navy">mov     byte ptr [si], </span><span style="color:#ff8000">0E5h </span>; Free the entry
<span style="color:black">DOSCODE:7A1A                 </span><span style="color:navy">call    </span>DIRUP           ; Error doesn&#039;t matter since erroring anyway
<span style="color:black">DOSCODE:7A1D
DOSCODE:7A1D </span><span style="color:gray">NODEEXISTS</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7A1D                 </span><span style="color:navy">jmp     </span>NODEACCERRJ
<span style="color:black">DOSCODE:7A20 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7A20
DOSCODE:7A20 </span>NODEEXISTSP<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7A20                 </span><span style="color:navy">pop     si              </span>; Clean stack
<span style="color:black">DOSCODE:7A21                 </span><span style="color:navy">jmp     short </span><span style="color:gray">NODEEXISTS
</span><span style="color:black">DOSCODE:7A21 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR DOS_MKDIR
</span><span style="color:black">DOSCODE:7A23
DOSCODE:7A23 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7A23
DOSCODE:7A23
DOSCODE:7A23 </span>DOS_CHDIR       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7A23
DOSCODE:7A23 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:790A SIZE 00000008 BYTES
</span><span style="color:black">DOSCODE:7A23 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:79EF SIZE 00000003 BYTES
</span><span style="color:black">DOSCODE:7A23 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:7ABB SIZE 00000003 BYTES
</span><span style="color:black">DOSCODE:7A23
DOSCODE:7A23                 </span><span style="color:navy">call    </span>TestNet
<span style="color:black">DOSCODE:7A26                 </span><span style="color:navy">jnb     short </span><span style="color:gray">LOCAL_CHDIR
</span><span style="color:black">DOSCODE:7A28                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1105h
</span><span style="color:black">DOSCODE:7A2B                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - CHDIR
<span style="color:black">DOSCODE:7A2B                                         </span>; SS = DOS CS
<span style="color:black">DOSCODE:7A2B                                         </span>; SDA first filename pointer -&gt; fully-qualified directory name
<span style="color:black">DOSCODE:7A2B                                         </span>; SDA CDS pointer -&gt; current directory
<span style="color:black">DOSCODE:7A2B                                         </span>; Return: CF set on error, AX = DOS error code
<span style="color:black">DOSCODE:7A2B                                         </span>; CF clear if successful
<span style="color:black">DOSCODE:7A2D                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7A2E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7A2E
DOSCODE:7A2E </span><span style="color:gray">LOCAL_CHDIR</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7A2E                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:7A31                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">44h</span><span style="color:navy">], </span><span style="color:green">20h </span>; [ES:DI+curdir.flags+1],
<span style="color:black">DOSCODE:7A31                                         </span>; (curdir_splice&gt;&gt;8)
<span style="color:black">DOSCODE:7A36                 </span><span style="color:navy">jz      short </span><span style="color:gray">nojoin
</span><span style="color:black">DOSCODE:7A38                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">4Bh</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; [ES:DI+curdir.ID+2]
<span style="color:black">DOSCODE:7A3E                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">49h</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; [ES:DI+curdir.ID]
<span style="color:black">DOSCODE:7A44
DOSCODE:7A44 </span><span style="color:gray">nojoin</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7A44                 </span><span style="color:navy">mov     ds:</span>NoSetDir<span style="color:navy">, </span><span style="color:#ff8000">0  </span>; FALSE
<span style="color:black">DOSCODE:7A49                 </span><span style="color:navy">mov     ds:</span>SATTRIB<span style="color:navy">, </span><span style="color:#ff8000">16h </span>; attr_directory+attr_system+attr_hidden
<span style="color:black">DOSCODE:7A4E                 </span><span style="color:navy">or      ds:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:7A53                 </span><span style="color:navy">call    </span>GETPATH
<span style="color:black">DOSCODE:7A56                 </span><span style="color:navy">lahf
</span><span style="color:black">DOSCODE:7A57                 </span><span style="color:navy">and     ds:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">80h </span>; FastOpen_Set ; set fastopen flag
<span style="color:black">DOSCODE:7A5C                 </span><span style="color:navy">sahf
</span><span style="color:black">DOSCODE:7A5D                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3           </span>; error_path_not_found
<span style="color:black">DOSCODE:7A60                 </span><span style="color:navy">jb      short </span><span style="color:gray">ChDirDone
</span><span style="color:black">DOSCODE:7A62                 </span><span style="color:navy">jnz     short </span>NOTDIRPATH ; Path not a DIR
<span style="color:black">DOSCODE:7A64                 </span><span style="color:navy">mov     cx, ds:</span>DIRSTART
<span style="color:black">DOSCODE:7A68                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:7A69
DOSCODE:7A69 </span><span style="color:gray">ChDirDone</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7A69                 </span><span style="color:navy">jmp     short </span><span style="color:gray">lmd_cd_done
</span><span style="color:black">DOSCODE:7A69 </span>DOS_CHDIR       <span style="color:black">endp
DOSCODE:7A69
DOSCODE:7A6B
DOSCODE:7A6B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7A6B
DOSCODE:7A6B
DOSCODE:7A6B </span>DOS_RMDIR       <span style="color:black">proc near               </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:7A6B
DOSCODE:7A6B </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:7ABB SIZE 00000003 BYTES
</span><span style="color:black">DOSCODE:7A6B
DOSCODE:7A6B                 </span><span style="color:navy">call    </span>TestNet
<span style="color:black">DOSCODE:7A6E                 </span><span style="color:navy">jnb     short </span><span style="color:gray">LOCAL_RMDIR
</span><span style="color:black">DOSCODE:7A70                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1101h
</span><span style="color:black">DOSCODE:7A73                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - REMOVE REMOTE DIRECTORY
<span style="color:black">DOSCODE:7A73                                         </span>; SS = DOS CS
<span style="color:black">DOSCODE:7A73                                         </span>; SDA first filename pointer -&gt; fully-qualified directory name
<span style="color:black">DOSCODE:7A73                                         </span>; SDA CDS pointer -&gt; current directory
<span style="color:black">DOSCODE:7A73                                         </span>; Return: CF set on error, AX = DOS error code
<span style="color:black">DOSCODE:7A73                                         </span>; CF clear if successful
<span style="color:black">DOSCODE:7A75                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7A76 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7A76
DOSCODE:7A76 </span><span style="color:gray">LOCAL_RMDIR</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7A76                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:7A79                 </span><span style="color:navy">mov     ds:</span>NoSetDir<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:7A7E                 </span><span style="color:navy">mov     ds:</span>SATTRIB<span style="color:navy">, </span><span style="color:#ff8000">16h </span>; attr_directory+attr_system+attr_hidden
<span style="color:black">DOSCODE:7A83                 </span><span style="color:navy">call    </span>GETPATH
<span style="color:black">DOSCODE:7A86                 </span><span style="color:navy">jb      short </span><span style="color:gray">NOPATH    </span>; Path not found
<span style="color:black">DOSCODE:7A88                 </span><span style="color:navy">jnz     short </span>NOTDIRPATH ; Path not a DIR
<span style="color:black">DOSCODE:7A8A                 </span><span style="color:navy">mov     di, ds:</span>DIRSTART
<span style="color:black">DOSCODE:7A8E                 </span><span style="color:navy">or      di, di          </span>; Root ?
<span style="color:black">DOSCODE:7A90                 </span><span style="color:navy">jnz     short </span><span style="color:gray">LOCAL_RMDIR_cont </span>; No
<span style="color:black">DOSCODE:7A92                 </span><span style="color:navy">cmp     ds:</span>DIRSTART_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:7A97                 </span><span style="color:navy">jz      short </span>NOTDIRPATH ; root directory
<span style="color:black">DOSCODE:7A99
DOSCODE:7A99 </span><span style="color:gray">LOCAL_RMDIR_cont</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7A99                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:bp+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:7A9E                 </span><span style="color:navy">jnz     short </span>rmdir_get_buf ; not FAT32
<span style="color:black">DOSCODE:7AA0                 </span><span style="color:navy">cmp     di, es:[bp+</span><span style="color:#ff8000">35h</span><span style="color:navy">] </span>; [es:bp+DPB.ROOT_CLUSTER]
<span style="color:black">DOSCODE:7AA4                 </span><span style="color:navy">jnz     short </span>rmdir_get_buf
<span style="color:black">DOSCODE:7AA6                 </span><span style="color:navy">mov     di, ds:</span>DIRSTART_HW
<span style="color:black">DOSCODE:7AAA                 </span><span style="color:navy">cmp     di, es:[bp+</span><span style="color:#ff8000">37h</span><span style="color:navy">] </span>; [es:bp+DPB.ROOT_CLUSTER+2]
<span style="color:black">DOSCODE:7AAE                 </span><span style="color:navy">jnz     short </span>rmdir_get_buf
<span style="color:black">DOSCODE:7AB0                 </span><span style="color:navy">jmp     short </span>NOTDIRPATH
<span style="color:black">DOSCODE:7AB2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7AB2
DOSCODE:7AB2 </span><span style="color:gray">NOPATH</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7AB2                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3           </span>; error_path_not_found
<span style="color:black">DOSCODE:7AB5                 </span><span style="color:navy">jmp     </span>_BadRet
<span style="color:black">DOSCODE:7AB8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7AB8
DOSCODE:7AB8 </span>NOTDIRPATHPOP<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7AB8                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:7AB9                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:7ABA
DOSCODE:7ABA </span>NOTDIRPATHPOP2<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7ABA                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:7ABA </span>DOS_RMDIR       <span style="color:black">endp
DOSCODE:7ABA
DOSCODE:7ABB </span><span style="color:gray">; START OF FUNCTION CHUNK FOR DOS_CHDIR
</span><span style="color:black">DOSCODE:7ABB </span><span style="color:gray">;   ADDITIONAL PARENT FUNCTION DOS_RMDIR
</span><span style="color:black">DOSCODE:7ABB
DOSCODE:7ABB </span>NOTDIRPATH<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7ABB                 </span><span style="color:navy">jmp     </span>NODEACCERRJ
<span style="color:black">DOSCODE:7ABB </span><span style="color:gray">; END OF FUNCTION CHUNK FOR DOS_CHDIR
</span><span style="color:maroon">DOSCODE:7ABE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:7ABE
DOSCODE:7ABE </span>rmdir_get_buf<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7ABE                 </span><span style="color:navy">lds     di, ds:</span>CURBUF
<span style="color:maroon">DOSCODE:7AC2                 </span><span style="color:navy">sub     bx, di          </span>; Compute true offset
<span style="color:maroon">DOSCODE:7AC4                 </span><span style="color:navy">push    bx              </span>; Save entry pointer
<span style="color:maroon">DOSCODE:7AC5                 </span><span style="color:navy">les     di, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [DI+BUFFINFO.buf_sector]
<span style="color:maroon">DOSCODE:7AC8                 </span><span style="color:navy">push    es              </span>; Save sector number
<span style="color:maroon">DOSCODE:7AC9                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:7ACA                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:7ACB                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:7ACC                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:7ACC                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:7ACD                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:7ACE                 </span>assume es:DOSCODE
<span style="color:maroon">DOSCODE:7ACE                 </span><span style="color:navy">mov     di, offset </span>NAME1
<span style="color:maroon">DOSCODE:7AD1                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3Fh </span><span style="color:gray">; &#039;?&#039;
</span><span style="color:maroon">DOSCODE:7AD4                 </span><span style="color:navy">mov     cx, </span><span style="color:green">10
</span><span style="color:maroon">DOSCODE:7AD7                 </span><span style="color:navy">rep stosb               </span>; al = &#039;?&#039;
<span style="color:maroon">DOSCODE:7AD9                 </span><span style="color:navy">stosw                   </span>; ah = 0 ; Nul terminate it
<span style="color:maroon">DOSCODE:7ADA                 </span><span style="color:navy">call    </span>STARTSRCH       ; Set search
<span style="color:maroon">DOSCODE:7ADD                 </span><span style="color:navy">call    </span>GETENTRY        ; Get start of directory
<span style="color:maroon">DOSCODE:7AE0                 </span><span style="color:navy">jb      short </span>NOTDIRPATHPOP ; Screw up
<span style="color:maroon">DOSCODE:7AE2                 </span><span style="color:navy">mov     ds, word ptr </span>CURBUF<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:maroon">DOSCODE:7AE6                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:7AE6                 </span><span style="color:navy">mov     si, bx
</span><span style="color:maroon">DOSCODE:7AE8                 </span><span style="color:navy">lodsw
</span><span style="color:maroon">DOSCODE:7AE9                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">202Eh       </span>; First entry &#039;.&#039;?
<span style="color:maroon">DOSCODE:7AEC                 </span><span style="color:navy">jnz     short </span>NOTDIRPATHPOP ; Nope
<span style="color:maroon">DOSCODE:7AEE                 </span><span style="color:navy">add     si, </span><span style="color:green">30          </span>; Next entry
<span style="color:maroon">DOSCODE:7AF1                 </span><span style="color:navy">lodsw
</span><span style="color:maroon">DOSCODE:7AF2                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">2E2Eh       </span>; Second entry &#039;..&#039;?
<span style="color:maroon">DOSCODE:7AF5                 </span><span style="color:navy">jnz     short </span>NOTDIRPATHPOP ; Nope
<span style="color:maroon">DOSCODE:7AF7                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:7AF8                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:7AF9                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:7AF9                 </span><span style="color:navy">mov     </span>LASTENT<span style="color:navy">, </span><span style="color:#ff8000">2      </span>; Skip . and ..
<span style="color:maroon">DOSCODE:7AFF                 </span><span style="color:navy">call    </span>GETENTRY        ; Get next entry
<span style="color:maroon">DOSCODE:7B02                 </span><span style="color:navy">jb      short </span>NOTDIRPATHPOP ; Screw up
<span style="color:maroon">DOSCODE:7B04                 </span><span style="color:navy">mov     </span>ATTRIB<span style="color:navy">, </span><span style="color:#ff8000">16h     </span>; attr_directory+attr_hidden+attr_system
<span style="color:maroon">DOSCODE:7B09                 </span><span style="color:navy">call    </span>SRCH            ; Do a search
<span style="color:maroon">DOSCODE:7B0C                 </span><span style="color:navy">jnb     short </span>NOTDIRPATHPOP
<span style="color:maroon">DOSCODE:7B0E                 </span><span style="color:navy">cmp     </span>FAILERR<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:7B13                 </span><span style="color:navy">jnz     short </span>NOTDIRPATHPOP ; Failure of search due to I 24 FAIL
<span style="color:maroon">DOSCODE:7B15                 </span><span style="color:navy">les     bp, </span>THISDPB
<span style="color:maroon">DOSCODE:7B19                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:7B19                 </span><span style="color:navy">mov     bx, </span>DIRSTART_HW
<span style="color:maroon">DOSCODE:7B1D                 </span><span style="color:navy">mov     </span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:maroon">DOSCODE:7B21                 </span><span style="color:navy">mov     bx, </span>DIRSTART
<span style="color:maroon">DOSCODE:7B25                 </span><span style="color:navy">call    </span>RELEASE         ; Release data in sub dir
<span style="color:maroon">DOSCODE:7B28                 </span><span style="color:navy">jb      short </span>NOTDIRPATHPOP
<span style="color:maroon">DOSCODE:7B2A                 </span><span style="color:navy">call    </span>update_fat32_fsinfo
<span style="color:maroon">DOSCODE:7B2D                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:7B2E                 </span><span style="color:navy">pop     </span>HIGH_SECTOR
<span style="color:maroon">DOSCODE:7B32                 </span><span style="color:navy">mov     </span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">18h
</span><span style="color:maroon">DOSCODE:7B37                 </span><span style="color:navy">xor     al, al          </span>; Pre read
<span style="color:maroon">DOSCODE:7B39                 </span><span style="color:navy">call    </span>GETBUFFR        ; Get sector back
<span style="color:maroon">DOSCODE:7B3C                 </span><span style="color:navy">jnb     short </span>rmdir_fde
<span style="color:maroon">DOSCODE:7B3E                 </span><span style="color:navy">jmp     </span>NOTDIRPATHPOP2
<span style="color:maroon">DOSCODE:7B41 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:7B41
DOSCODE:7B41 </span>rmdir_fde<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7B41                 </span><span style="color:navy">lds     di, </span>CURBUF
<span style="color:maroon">DOSCODE:7B45                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:7B45                 </span><span style="color:navy">or      byte ptr [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">4 </span>; [DI+BUFFINFO.buf_flags],buf_isDIR
<span style="color:maroon">DOSCODE:7B49                 </span><span style="color:navy">pop     bx              </span>; Pointer to start of entry
<span style="color:maroon">DOSCODE:7B4A                 </span><span style="color:navy">add     bx, di          </span>; Corrected
<span style="color:maroon">DOSCODE:7B4C                 </span><span style="color:navy">mov     byte ptr [bx], </span><span style="color:#ff8000">0E5h </span>; Free the entry
<span style="color:maroon">DOSCODE:7B4F                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:7B50                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:7B51                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:7B52                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:7B52                 </span><span style="color:navy">call    </span>FastOpen_Delete
<span style="color:maroon">DOSCODE:7B55                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:7B56                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:7B56                 </span><span style="color:navy">jmp     </span>DIRUP
<span style="color:black">DOSCODE:7B59
DOSCODE:7B59 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7B59
DOSCODE:7B59
DOSCODE:7B59 </span>SWAPBACK        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7B59                 </span><span style="color:navy">mov     ds:</span>CONSWAP<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:7B5E                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7B5E </span>SWAPBACK        <span style="color:black">endp
DOSCODE:7B5E
DOSCODE:7B5F
DOSCODE:7B5F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7B5F
DOSCODE:7B5F
DOSCODE:7B5F </span>SWAPCON         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7B5F                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:7B60                 </span><span style="color:navy">mov     ax, word ptr ds:</span>THISSFT
<span style="color:black">DOSCODE:7B63                 </span><span style="color:navy">mov     ds:</span>CONSWAP<span style="color:navy">, </span><span style="color:#ff8000">1   </span>; ConSwap = TRUE
<span style="color:black">DOSCODE:7B68                 </span><span style="color:navy">mov     word ptr ds:</span>CONSFT<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:7B6B                 </span><span style="color:navy">mov     ax, word ptr ds:</span>THISSFT<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:7B6E                 </span><span style="color:navy">mov     word ptr ds:</span>CONSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">DOSCODE:7B71                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:7B72                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7B72 </span>SWAPCON         <span style="color:black">endp
DOSCODE:7B72
</span><span style="color:maroon">DOSCODE:7B73 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:7B73
DOSCODE:7B73 </span>dos_read_acc_err<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:7B73                 </span><span style="color:navy">jmp     </span>SET_ACC_ERR
<span style="color:black">DOSCODE:7B76
DOSCODE:7B76 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7B76
DOSCODE:7B76
DOSCODE:7B76 </span>DOS_READ        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7B76                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:black">DOSCODE:7B7A                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:7B7E                 </span><span style="color:navy">and     al, </span><span style="color:green">3           </span>; open_mode_mask ?
<span style="color:black">DOSCODE:7B7E                                         </span>; (it was 0Fh -access_mask- in MSDOS6.22 MSDOS.SYS)
<span style="color:black">DOSCODE:7B80                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1           </span>; open_for_write
<span style="color:black">DOSCODE:7B82                 </span><span style="color:navy">jz      short </span>dos_read_acc_err
<span style="color:black">DOSCODE:7B84                 </span><span style="color:navy">call    </span>SETUP
<span style="color:black">DOSCODE:7B87                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">NoIORet
</span><span style="color:black">DOSCODE:7B89                 </span><span style="color:navy">call    </span>IsSFTNet
<span style="color:black">DOSCODE:7B8C                 </span><span style="color:navy">jz      short </span><span style="color:gray">LOCAL_READ
</span><span style="color:black">DOSCODE:7B8E                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1108h
</span><span style="color:black">DOSCODE:7B91                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - READ FROM REMOTE FILE
<span style="color:black">DOSCODE:7B91                                         </span>; ES:DI -&gt; SFT
<span style="color:black">DOSCODE:7B91                                         </span>; SFT DPB field -&gt; DPB of drive containing file
<span style="color:black">DOSCODE:7B91                                         </span>; CX = number of bytes, SS = DOS CS, SDA DTA field -&gt; user buffer
<span style="color:black">DOSCODE:7B91                                         </span>; Return: CF set on error, CX = bytes read
<span style="color:black">DOSCODE:7B93                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7B94 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7B94
DOSCODE:7B94 </span><span style="color:gray">NoIORet</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7B94                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:7B95                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7B96 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7B96
DOSCODE:7B96 </span><span style="color:gray">LOCAL_READ</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7B96                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:DI+SF_ENTRY.sf_flags],devid_device
<span style="color:black">DOSCODE:7B9B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">READDEV
</span><span style="color:black">DOSCODE:7B9D                 </span><span style="color:navy">mov     ds:</span>EXTERR_LOCUS<span style="color:navy">, </span><span style="color:#ff8000">2 </span>; errLOC_Disk
<span style="color:black">DOSCODE:7BA2                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:7BA5                 </span><span style="color:navy">call    </span>DISKREAD
<span style="color:black">DOSCODE:7BA8                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:7BAB                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7BAC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7BAC
DOSCODE:7BAC </span><span style="color:gray">READDEV</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7BAC                 </span><span style="color:navy">mov     ds:</span>EXTERR_LOCUS<span style="color:navy">, </span><span style="color:#ff8000">4 </span>; errLOC_SerDev
<span style="color:black">DOSCODE:7BB1                 </span><span style="color:navy">mov     bl, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_flags]
<span style="color:black">DOSCODE:7BB5                 </span><span style="color:navy">les     di, ds:</span>DMAADD
<span style="color:black">DOSCODE:7BB9                 </span><span style="color:navy">test    bl, </span><span style="color:green">40h         </span>; devid_device_EOF ; End of file?
<span style="color:black">DOSCODE:7BBC                 </span><span style="color:navy">jz      short </span><span style="color:gray">ENDRDDEVJ3
</span><span style="color:black">DOSCODE:7BBE                 </span><span style="color:navy">test    bl, </span><span style="color:green">4           </span>; devid_device_null ; NUL device?
<span style="color:black">DOSCODE:7BC1                 </span><span style="color:navy">jz      short </span><span style="color:gray">TESTRAW   </span>; no
<span style="color:black">DOSCODE:7BC3                 </span><span style="color:navy">xor     al, al          </span>; Indicate EOF by setting zero
<span style="color:black">DOSCODE:7BC5
DOSCODE:7BC5 </span><span style="color:gray">ENDRDDEVJ3</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7BC5                 </span><span style="color:navy">jmp     </span><span style="color:gray">ENDRDDEVJ
</span><span style="color:black">DOSCODE:7BC8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7BC8
DOSCODE:7BC8 </span><span style="color:gray">TESTRAW</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7BC8                 </span><span style="color:navy">test    bl, </span><span style="color:green">20h         </span>; devid_device_raw ; Raw mode?
<span style="color:black">DOSCODE:7BCB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">DVRDRAW   </span>; Yes, let the device do all local editing
<span style="color:black">DOSCODE:7BCD                 </span><span style="color:navy">test    bl, </span><span style="color:green">1           </span>; devid_device_con_in ; Is it console device?
<span style="color:black">DOSCODE:7BD0                 </span><span style="color:navy">jz      short </span><span style="color:gray">NOTRDCON  </span>; no
<span style="color:black">DOSCODE:7BD2                 </span><span style="color:navy">jmp     </span><span style="color:gray">READCON         </span>; yes
<span style="color:black">DOSCODE:7BD5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7BD5
DOSCODE:7BD5 </span><span style="color:gray">DVRDRAW</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7BD5                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:7BD6                 </span><span style="color:navy">pop     ds              </span>; Xaddr to DS:DI
<span style="color:black">DOSCODE:7BD7                 </span><span style="color:navy">test    ss:</span>IsWin386<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:7BDD                 </span><span style="color:navy">jz      short </span><span style="color:gray">ReadRawRetry </span>; not present
<span style="color:black">DOSCODE:7BDF                 </span><span style="color:navy">test    bl, </span><span style="color:green">1           </span>; devid_device_con_in ; is it console device?
<span style="color:black">DOSCODE:7BE2                 </span><span style="color:navy">jz      short </span><span style="color:gray">ReadRawRetry </span>; no, do normal read
<span style="color:black">DOSCODE:7BE4                 </span><span style="color:navy">jmp     </span><span style="color:gray">do_polling      </span>; yes, do win386 polling loop
<span style="color:black">DOSCODE:7BE7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7BE7
DOSCODE:7BE7 </span><span style="color:gray">ReadRawRetry</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7BE7                 </span><span style="color:navy">mov     bx, di          </span>; DS:BX transfer addr
<span style="color:black">DOSCODE:7BE9                 </span><span style="color:navy">xor     ax, ax          </span>; Media Byte, unit = 0
<span style="color:black">DOSCODE:7BEB                 </span><span style="color:navy">cwd                     </span>; Start at 0
<span style="color:black">DOSCODE:7BEC                 </span><span style="color:navy">call    </span>SETREAD
<span style="color:black">DOSCODE:7BEF                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:7BF0                 </span><span style="color:navy">lds     si, ss:</span>THISSFT
<span style="color:black">DOSCODE:7BF5                 </span><span style="color:navy">call    </span>DEVIOCALL
<span style="color:black">DOSCODE:7BF8                 </span><span style="color:navy">mov     dx, di
</span><span style="color:black">DOSCODE:7BFA                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">86h         </span>; Read error
<span style="color:black">DOSCODE:7BFC                 </span><span style="color:navy">mov     di, ss:</span>DEVCALL_REQSTAT
<span style="color:black">DOSCODE:7C01                 </span><span style="color:navy">or      di, di
</span><span style="color:black">DOSCODE:7C03                 </span><span style="color:navy">jns     short </span><span style="color:gray">CRDROK    </span>; no errors
<span style="color:black">DOSCODE:7C05                 </span><span style="color:navy">call    </span>CHARHARD
<span style="color:black">DOSCODE:7C08                 </span><span style="color:navy">mov     di, dx          </span>; DS:DI is Xaddr
<span style="color:black">DOSCODE:7C0A                 </span><span style="color:navy">sub     cx, ss:</span>CALLBPB  ; [ss:CALLSCNT]
<span style="color:black">DOSCODE:7C0F                 </span><span style="color:navy">add     di, ss:</span>CALLBPB  ; [ss:CALLSCNT]
<span style="color:black">DOSCODE:7C14                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:7C16                 </span><span style="color:navy">jz      short </span><span style="color:gray">CRDROK    </span>; Ignore
<span style="color:black">DOSCODE:7C18                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:7C1A                 </span><span style="color:navy">jz      short </span>CRDFERR   ; fail
<span style="color:black">DOSCODE:7C1C                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7C1D                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ReadRawRetry </span>; Retry
<span style="color:black">DOSCODE:7C1F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7C1F
DOSCODE:7C1F </span>CRDFERR<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7C1F                 </span><span style="color:navy">pop     di              </span>; Clean stack
<span style="color:black">DOSCODE:7C20
DOSCODE:7C20 </span><span style="color:gray">DEVIOFERR</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7C20                 </span><span style="color:navy">les     di, ss:</span>THISSFT
<span style="color:black">DOSCODE:7C25                 </span><span style="color:navy">jmp     </span>SET_ACC_ERR_DS
<span style="color:black">DOSCODE:7C28 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7C28
DOSCODE:7C28 </span><span style="color:gray">CRDROK</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7C28                 </span><span style="color:navy">pop     di              </span>; Chuck saved seg of Xaddr
<span style="color:black">DOSCODE:7C29                 </span><span style="color:navy">mov     di, dx
</span><span style="color:black">DOSCODE:7C2B                 </span><span style="color:navy">add     di, ss:</span>CALLBPB  ; [ss:CALLSCNT] ; Amount transferred
<span style="color:black">DOSCODE:7C30                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ENDRDDEVJ3
</span><span style="color:black">DOSCODE:7C32 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7C32
DOSCODE:7C32 </span><span style="color:gray">NOTRDCON</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7C32                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:7C33                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7C34                 </span><span style="color:navy">mov     bx, di
</span><span style="color:black">DOSCODE:7C36                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:7C38                 </span><span style="color:navy">cwd
</span><span style="color:black">DOSCODE:7C39                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:7C3A                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:7C3D                 </span><span style="color:navy">call    </span>SETREAD
<span style="color:black">DOSCODE:7C40                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:7C41                 </span><span style="color:navy">lds     si, ss:</span>THISSFT
<span style="color:black">DOSCODE:7C46                 </span><span style="color:navy">lds     si, [si+</span><span style="color:#ff8000">7</span><span style="color:navy">]      </span>; [SI+SF_ENTRY.sf_devptr]
<span style="color:black">DOSCODE:7C49
DOSCODE:7C49 </span><span style="color:gray">DVRDLP</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7C49                 </span><span style="color:navy">call    </span>DSKSTATCHK
<span style="color:black">DOSCODE:7C4C                 </span><span style="color:navy">call    </span>DEVIOCALL2
<span style="color:black">DOSCODE:7C4F                 </span><span style="color:navy">push    di              </span>; Save &quot;count&quot; done
<span style="color:black">DOSCODE:7C50                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">86h
</span><span style="color:black">DOSCODE:7C52                 </span><span style="color:navy">mov     di, ss:</span>DEVCALL_REQSTAT
<span style="color:black">DOSCODE:7C57                 </span><span style="color:navy">or      di, di
</span><span style="color:black">DOSCODE:7C59                 </span><span style="color:navy">jns     short </span><span style="color:gray">CRDOK
</span><span style="color:black">DOSCODE:7C5B                 </span><span style="color:navy">call    </span>CHARHARD
<span style="color:black">DOSCODE:7C5E                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:7C5F                 </span><span style="color:navy">mov     ss:</span>CALLBPB<span style="color:navy">, </span><span style="color:#ff8000">1   </span>; [SS:CALLSCNT]
<span style="color:black">DOSCODE:7C66                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:7C68                 </span><span style="color:navy">jz      short </span><span style="color:gray">DVRDLP    </span>; Retry
<span style="color:black">DOSCODE:7C6A                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:7C6C                 </span><span style="color:navy">jz      short </span><span style="color:gray">DEVIOFERR </span>; FAIL
<span style="color:black">DOSCODE:7C6E                 </span><span style="color:navy">xor     al, al          </span>; Ignore, Pick some random character
<span style="color:black">DOSCODE:7C70                 </span><span style="color:navy">jmp     short </span><span style="color:gray">DVRDIGN
</span><span style="color:black">DOSCODE:7C72 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7C72
DOSCODE:7C72 </span><span style="color:gray">CRDOK</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7C72                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:7C73                 </span><span style="color:navy">cmp     ss:</span>CALLBPB<span style="color:navy">, </span><span style="color:#ff8000">1   </span>; [SS:CALLSCNT]
<span style="color:black">DOSCODE:7C79                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ENDRDDEVJ
</span><span style="color:black">DOSCODE:7C7B                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:7C7C                 </span><span style="color:navy">mov     ds, ss:</span>CALLXAD_2 ; [SS:CALLXAD+2]
<span style="color:black">DOSCODE:7C81                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:7C81                 </span><span style="color:navy">mov     al, [di]        </span>; Get the character we just read
<span style="color:black">DOSCODE:7C83                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7C84                 </span>assume ds:nothing
<span style="color:black">DOSCODE:7C84
DOSCODE:7C84 </span><span style="color:gray">DVRDIGN</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7C84                 </span><span style="color:navy">inc     word ptr ss:</span>CALLBR ; [SS:CALLXAD] ; Next character
<span style="color:black">DOSCODE:7C89                 </span><span style="color:navy">mov     ss:</span>DEVCALL_REQSTAT<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:7C90                 </span><span style="color:navy">inc     di              </span>; Next character
<span style="color:black">DOSCODE:7C91                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1Ah         </span>; ^Z?
<span style="color:black">DOSCODE:7C93                 </span><span style="color:navy">jz      short </span><span style="color:gray">ENDRDDEVJ </span>; Yes, done zero set (EOF)
<span style="color:black">DOSCODE:7C95                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; c_CR ; CR?
<span style="color:black">DOSCODE:7C97                 </span><span style="color:navy">loopne  </span><span style="color:gray">DVRDLP          </span>; Loop if no, else done
<span style="color:black">DOSCODE:7C99                 </span><span style="color:navy">inc     ax              </span>; Resets zero flag so NOT EOF, unless
<span style="color:black">DOSCODE:7C9A
DOSCODE:7C9A </span><span style="color:gray">ENDRDDEVJ</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7C9A                 </span><span style="color:navy">jmp     </span><span style="color:gray">ENDRDDEV
</span><span style="color:black">DOSCODE:7C9D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7C9D
DOSCODE:7C9D </span><span style="color:gray">do_polling</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7C9D                 </span><span style="color:navy">mov     bx, di          </span>; ds:bx is Xfer address
<span style="color:black">DOSCODE:7C9F                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:7CA1                 </span><span style="color:navy">cwd
</span><span style="color:black">DOSCODE:7CA2                 </span><span style="color:navy">call    </span>SETREAD         ; prepare device packet
<span style="color:black">DOSCODE:7CA5
DOSCODE:7CA5 </span><span style="color:gray">do_io</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7CA5                 </span><span style="color:navy">mov     byte ptr es:[bx+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:#ff8000">5 </span>; DEVRDND ; Change command code
<span style="color:black">DOSCODE:7CAA                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:7CAB                 </span><span style="color:navy">lds     si, ss:</span>THISSFT  ; get device header
<span style="color:black">DOSCODE:7CB0                 </span><span style="color:navy">call    </span>DEVIOCALL       ; call device driver
<span style="color:black">DOSCODE:7CB3                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7CB4                 </span><span style="color:navy">test    word ptr es:[bx+</span><span style="color:#ff8000">3</span><span style="color:navy">], </span><span style="color:green">8000h </span>; [es:bx+SRHEAD.REQSTAT],
<span style="color:black">DOSCODE:7CB4                                         </span>; STERR ; check if error
<span style="color:black">DOSCODE:7CBA                 </span><span style="color:navy">jz      short </span><span style="color:gray">check_busy </span>; no
<span style="color:black">DOSCODE:7CBC                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:7CBD                 </span><span style="color:navy">mov     dx, di
</span><span style="color:black">DOSCODE:7CBF
DOSCODE:7CBF </span><span style="color:gray">invoke_charhard</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7CBF                 </span><span style="color:navy">call    </span>CHARHARD        ; invoke int 24h handler
<span style="color:black">DOSCODE:7CC2                 </span><span style="color:navy">mov     di, dx
</span><span style="color:black">DOSCODE:7CC4                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:7CC6                 </span><span style="color:navy">jz      short </span><span style="color:gray">pop_done_read </span>; ignore by user,assume read is done
<span style="color:black">DOSCODE:7CC8                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:7CCA                 </span><span style="color:navy">jz      short </span><span style="color:gray">devrderr  </span>; user issued a &#039;fail&#039;,indicate error
<span style="color:black">DOSCODE:7CCC                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7CCD                 </span><span style="color:navy">jmp     short </span><span style="color:gray">do_io     </span>; user issued a retry
<span style="color:black">DOSCODE:7CCF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7CCF
DOSCODE:7CCF </span><span style="color:gray">check_busy</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7CCF                 </span><span style="color:navy">test    word ptr es:[bx+</span><span style="color:#ff8000">3</span><span style="color:navy">], </span><span style="color:green">200h </span>; [es:bx+SRHEAD.REQSTAT],0200h
<span style="color:black">DOSCODE:7CCF                                         </span>; see if busy bit set
<span style="color:black">DOSCODE:7CD5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">no_char
</span><span style="color:black">DOSCODE:7CD7                 </span><span style="color:navy">mov     byte ptr es:[bx+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:#ff8000">4 </span>; DEVRD ; command code is READ now
<span style="color:black">DOSCODE:7CDC                 </span><span style="color:navy">mov     word ptr es:[bx+</span><span style="color:green">18</span><span style="color:navy">], </span><span style="color:#ff8000">1 </span>; change count to 1 character
<span style="color:black">DOSCODE:7CE2                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:7CE3                 </span><span style="color:navy">lds     si, ss:</span>THISSFT
<span style="color:black">DOSCODE:7CE8                 </span><span style="color:navy">call    </span>DEVIOCALL
<span style="color:black">DOSCODE:7CEB                 </span><span style="color:navy">mov     dx, di
</span><span style="color:black">DOSCODE:7CED                 </span><span style="color:navy">mov     di, es:[bx+</span><span style="color:#ff8000">3</span><span style="color:navy">]   </span>; [es:bx+SRHEAD.REQSTAT]
<span style="color:black">DOSCODE:7CED                                         </span>; get returned status
<span style="color:black">DOSCODE:7CF1                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">86h
</span><span style="color:black">DOSCODE:7CF3                 </span><span style="color:navy">test    di, </span><span style="color:green">8000h       </span>; STERR ; was there an error during read?
<span style="color:black">DOSCODE:7CF7                 </span><span style="color:navy">jnz     short </span><span style="color:gray">invoke_charhard
</span><span style="color:black">DOSCODE:7CF9
DOSCODE:7CF9 </span>next_char<span style="color:navy">:                              </span>; no,read next character
<span style="color:black">DOSCODE:7CF9                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7CFA                 </span><span style="color:navy">mov     di, dx
</span><span style="color:black">DOSCODE:7CFC                 </span><span style="color:navy">dec     cx              </span>; decrement count
<span style="color:black">DOSCODE:7CFD                 </span><span style="color:navy">jz      short </span><span style="color:gray">done_read </span>; all characters read in
<span style="color:black">DOSCODE:7CFF                 </span><span style="color:navy">inc     word ptr es:[bx+</span><span style="color:green">14</span><span style="color:navy">] </span>; update transfer address
<span style="color:black">DOSCODE:7D03                 </span><span style="color:navy">jmp     short </span><span style="color:gray">do_io     </span>; read next character in
<span style="color:black">DOSCODE:7D05 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7D05
DOSCODE:7D05 </span><span style="color:gray">devrderr</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7D05                 </span><span style="color:navy">pop     di              </span>; discard segment address
<span style="color:black">DOSCODE:7D06                 </span><span style="color:navy">les     di, ss:</span>THISSFT
<span style="color:black">DOSCODE:7D0B                 </span><span style="color:navy">jmp     </span>SET_ACC_ERR_DS  ; indicate error
<span style="color:black">DOSCODE:7D0E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7D0E
DOSCODE:7D0E </span><span style="color:gray">no_char</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7D0E                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:7D0F                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">84h
</span><span style="color:black">DOSCODE:7D11                 </span><span style="color:navy">int     </span><span style="color:green">2Ah             </span>; Microsoft Networks - KEYBOARD BUSY LOOP
<span style="color:black">DOSCODE:7D11                                         </span>; indicate idle to WIN386
<span style="color:black">DOSCODE:7D13                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:7D14                 </span><span style="color:navy">jmp     short </span><span style="color:gray">do_io
</span><span style="color:black">DOSCODE:7D16 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7D16
DOSCODE:7D16 </span><span style="color:gray">pop_done_read</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7D16                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7D17
DOSCODE:7D17 </span><span style="color:gray">done_read</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7D17                 </span><span style="color:navy">add     di, ss:</span>CALLBPB  ; [ss:CALLSCNT]
<span style="color:black">DOSCODE:7D1C                 </span><span style="color:navy">jmp     </span><span style="color:gray">ENDRDDEVJ3      </span>; jump back to normal DOS raw read exit
<span style="color:black">DOSCODE:7D1F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7D1F
DOSCODE:7D1F </span><span style="color:gray">TRANBUF</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7D1F                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:7D20                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:7D21                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Dh         </span>; c_CR ; Check for carriage return
<span style="color:black">DOSCODE:7D23                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NORMCH
</span><span style="color:black">DOSCODE:7D25                 </span><span style="color:navy">mov     byte ptr [si], </span><span style="color:#ff8000">0Ah </span>; c_LF
<span style="color:black">DOSCODE:7D28
DOSCODE:7D28 </span><span style="color:gray">NORMCH</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7D28                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Ah         </span>; c_LF
<span style="color:black">DOSCODE:7D2A                 </span><span style="color:navy">loopne  </span><span style="color:gray">TRANBUF
</span><span style="color:black">DOSCODE:7D2C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ENDRDCON
</span><span style="color:black">DOSCODE:7D2E                 </span><span style="color:navy">xor     si, si          </span>; Cause a new buffer to be read
<span style="color:black">DOSCODE:7D30                 </span><span style="color:navy">call    </span>OUTT            ; Transmit linefeed
<span style="color:black">DOSCODE:7D33                 </span><span style="color:navy">or      al, </span><span style="color:green">1           </span>; Clear zero flag--not end of file
<span style="color:black">DOSCODE:7D35
DOSCODE:7D35 </span><span style="color:gray">ENDRDCON</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7D35                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:7D36                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7D37                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:7D37                 </span><span style="color:navy">call    </span>SWAPBACK
<span style="color:black">DOSCODE:7D3A                 </span><span style="color:navy">mov     </span>CONTPOS<span style="color:navy">, si
</span><span style="color:black">DOSCODE:7D3E
DOSCODE:7D3E </span><span style="color:gray">ENDRDDEV</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7D3E                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:7D3F                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7D40                 </span><span style="color:navy">mov     </span>NEXTADD<span style="color:navy">, di
</span><span style="color:black">DOSCODE:7D44                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SETSFTC   </span>; Zero set if Ctrl-Z found in input
<span style="color:black">DOSCODE:7D46                 </span><span style="color:navy">les     di, </span>THISSFT
<span style="color:black">DOSCODE:7D4A                 </span><span style="color:navy">and     byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">0BFh </span>; [ES:DI+SF_ENTRY.sf_flags],
<span style="color:black">DOSCODE:7D4A                                         </span>; ~devid_device_EOF
<span style="color:black">DOSCODE:7D4A                                         </span>; Mark as no more data available
<span style="color:black">DOSCODE:7D4F
DOSCODE:7D4F </span><span style="color:gray">SETSFTC</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7D4F                 </span><span style="color:navy">call    </span>SETSFT
<span style="color:black">DOSCODE:7D52                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7D53 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7D53
DOSCODE:7D53 </span><span style="color:gray">READCON</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7D53                 </span><span style="color:navy">call    </span>SWAPCON
<span style="color:black">DOSCODE:7D56                 </span><span style="color:navy">mov     si, </span>CONTPOS
<span style="color:black">DOSCODE:7D5A                 </span><span style="color:navy">or      si, si
</span><span style="color:black">DOSCODE:7D5C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">TRANBUF
</span><span style="color:black">DOSCODE:7D5E                 </span><span style="color:navy">cmp     </span>CONBUF<span style="color:navy">, </span><span style="color:green">80h     </span>; 128
<span style="color:black">DOSCODE:7D63                 </span><span style="color:navy">jz      short </span><span style="color:gray">GETBUF
</span><span style="color:black">DOSCODE:7D65                 </span><span style="color:navy">mov     word ptr </span>CONBUF<span style="color:navy">, </span><span style="color:green">0FF80h </span>;
<span style="color:black">DOSCODE:7D65                                         </span>; Set up 128-byte buffer with no template
<span style="color:black">DOSCODE:7D6B
DOSCODE:7D6B </span><span style="color:gray">GETBUF</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7D6B                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:7D6C                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:7D6D                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:7D6E                 </span><span style="color:navy">mov     dx, offset </span>CONBUF
<span style="color:black">DOSCODE:7D71                 </span><span style="color:navy">call    </span>$STD_CON_STRING_INPUT ; Get input buffer
<span style="color:black">DOSCODE:7D74                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:7D75                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:7D76                 </span><span style="color:navy">mov     si, (offset </span>CONBUF<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">)
</span><span style="color:black">DOSCODE:7D79                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:7D7A                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">1Ah </span>; Check for Ctrl-Z in first character
<span style="color:black">DOSCODE:7D7D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">TRANBUF
</span><span style="color:black">DOSCODE:7D7F                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1Ah
</span><span style="color:black">DOSCODE:7D81                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:7D82                 </span><span style="color:navy">dec     di
</span><span style="color:black">DOSCODE:7D83                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Ah         </span>; c_LF
<span style="color:black">DOSCODE:7D85                 </span><span style="color:navy">call    </span>OUTT            ; Send linefeed
<span style="color:black">DOSCODE:7D88                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">DOSCODE:7D8A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ENDRDCON
</span><span style="color:black">DOSCODE:7D8A </span>DOS_READ        <span style="color:black">endp
DOSCODE:7D8A
DOSCODE:7D8C
DOSCODE:7D8C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7D8C
DOSCODE:7D8C </span><span style="color:gray">; Attributes: thunk
</span><span style="color:black">DOSCODE:7D8C
DOSCODE:7D8C </span>BadMode         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7D8C                 </span><span style="color:navy">jmp     </span>SET_ACC_ERR
<span style="color:black">DOSCODE:7D8C </span>BadMode         <span style="color:black">endp
DOSCODE:7D8C
DOSCODE:7D8F
DOSCODE:7D8F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7D8F
DOSCODE:7D8F
DOSCODE:7D8F </span>DOS_WRITE       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7D8F                 </span><span style="color:navy">les     di, </span>THISSFT
<span style="color:black">DOSCODE:7D93                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_mode]
<span style="color:black">DOSCODE:7D97                 </span><span style="color:navy">and     al, </span><span style="color:green">3           </span>; open_mode_mask ?
<span style="color:black">DOSCODE:7D99                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0           </span>; open_for_read
<span style="color:black">DOSCODE:7D9B                 </span><span style="color:navy">jz      short </span>BadMode
<span style="color:black">DOSCODE:7D9D
DOSCODE:7D9D </span>Check_FCB_RO<span style="color:navy">:                           </span>;
<span style="color:black">DOSCODE:7D9D                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:DI+SF_ENTRY.sf_mode+1],
<span style="color:black">DOSCODE:7D9D                                         </span>; (sf_isFCB&gt;&gt;8)
<span style="color:black">DOSCODE:7DA2                 </span><span style="color:navy">jz      short </span><span style="color:gray">WRITE_NO_MODE </span>; Not an FCB
<span style="color:black">DOSCODE:7DA4                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">1 </span>; [ES:DI+SF_ENTRY.sf_attr],
<span style="color:black">DOSCODE:7DA4                                         </span>; attr_read_only
<span style="color:black">DOSCODE:7DA9                 </span><span style="color:navy">jnz     short </span>BadMode   ; Can&#039;t write to Read_Only files via FCB
<span style="color:black">DOSCODE:7DAB
DOSCODE:7DAB </span><span style="color:gray">WRITE_NO_MODE</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7DAB                 </span><span style="color:navy">call    </span>SETUP
<span style="color:black">DOSCODE:7DAE                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:green">80h </span>; call IsSFTNet
<span style="color:black">DOSCODE:7DAE                                         </span>; [ES:DI+SF_ENTRY.sf_flags+1],(sf_isnet&gt;&gt;8)
<span style="color:black">DOSCODE:7DB3                 </span><span style="color:navy">jz      short </span><span style="color:gray">LOCAL_WRITE
</span><span style="color:black">DOSCODE:7DB5                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1109h
</span><span style="color:black">DOSCODE:7DB8                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - WRITE TO REMOTE FILE
<span style="color:black">DOSCODE:7DB8                                         </span>; ES:DI -&gt; SFT
<span style="color:black">DOSCODE:7DB8                                         </span>; SFT DPB field -&gt; DPB of drive containing file
<span style="color:black">DOSCODE:7DB8                                         </span>; CX = number of bytes, SS = DOS CS, SDA DTA field -&gt; user buffer
<span style="color:black">DOSCODE:7DB8                                         </span>; Return: CF set on error, CX = bytes written
<span style="color:black">DOSCODE:7DBA                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7DBB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7DBB
DOSCODE:7DBB </span><span style="color:gray">LOCAL_WRITE</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7DBB                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:DI+SF_ENTRY.sf_flags],devid_device
<span style="color:black">DOSCODE:7DBB                                         </span>; Check for named device I/O
<span style="color:black">DOSCODE:7DC0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">WRTDEV
</span><span style="color:black">DOSCODE:7DC2                 </span><span style="color:navy">mov     </span>EXTERR_LOCUS<span style="color:navy">, </span><span style="color:#ff8000">2 </span>; errLOC_Disk
<span style="color:black">DOSCODE:7DC7                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:7DCA                 </span><span style="color:navy">call    </span>DISKWRITE
<span style="color:black">DOSCODE:7DCD                 </span><span style="color:navy">jb      short </span><span style="color:gray">nocommit
</span><span style="color:black">DOSCODE:7DCF                 </span><span style="color:navy">les     di, </span>THISSFT
<span style="color:black">DOSCODE:7DD3                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3</span><span style="color:navy">], </span><span style="color:green">40h </span>; [ES:DI+SF_ENTRY.sf_mode+1],
<span style="color:black">DOSCODE:7DD3                                         </span>; (AUTO_COMMIT_WRITE&gt;&gt;8)
<span style="color:black">DOSCODE:7DD8                 </span><span style="color:navy">jz      short </span><span style="color:gray">nocommit
</span><span style="color:black">DOSCODE:7DDA                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:7DDB                 </span><span style="color:navy">call    </span>DOS_COMMIT
<span style="color:black">DOSCODE:7DDE                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:7DDF
DOSCODE:7DDF </span><span style="color:gray">nocommit</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7DDF                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:7DE2                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7DE3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7DE3
DOSCODE:7DE3 </span><span style="color:gray">DVWRTRAW</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7DE3                 </span><span style="color:navy">xor     ax, ax          </span>; Media Byte, unit = 0
<span style="color:black">DOSCODE:7DE5                 </span><span style="color:navy">call    </span>SETWRITE
<span style="color:black">DOSCODE:7DE8                 </span><span style="color:navy">push    ds              </span>; Save seg of transfer
<span style="color:black">DOSCODE:7DE9                 </span><span style="color:navy">lds     si, ss:</span>THISSFT
<span style="color:black">DOSCODE:7DEE                 </span>assume ds:nothing
<span style="color:black">DOSCODE:7DEE                 </span><span style="color:navy">call    </span>DEVIOCALL       ; DS:SI -&gt; DEVICE
<span style="color:black">DOSCODE:7DF1                 </span><span style="color:navy">mov     dx, di          </span>; Offset part of Xaddr saved in DX
<span style="color:black">DOSCODE:7DF3                 </span><span style="color:navy">mov     di, ss:</span>DEVCALL_REQSTAT
<span style="color:black">DOSCODE:7DF8                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">87h
</span><span style="color:black">DOSCODE:7DFA                 </span><span style="color:navy">or      di, di
</span><span style="color:black">DOSCODE:7DFC                 </span><span style="color:navy">jns     short </span><span style="color:gray">CWRTROK
</span><span style="color:black">DOSCODE:7DFE                 </span><span style="color:navy">call    </span>CHARHARD
<span style="color:black">DOSCODE:7E01                 </span><span style="color:navy">mov     di, ss:</span>CALLBPB  ; [ss:CALLSCNT]
<span style="color:black">DOSCODE:7E06                 </span><span style="color:navy">mov     bx, dx          </span>; update ptr &amp; count to reflect
<span style="color:black">DOSCODE:7E06                                         </span>; number of chars xferred
<span style="color:black">DOSCODE:7E08                 </span><span style="color:navy">sub     cx, di
</span><span style="color:black">DOSCODE:7E0A                 </span><span style="color:navy">add     bx, di
</span><span style="color:black">DOSCODE:7E0C                 </span><span style="color:navy">mov     di, bx          </span>; Recall transfer addr
<span style="color:black">DOSCODE:7E0E                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:7E10                 </span><span style="color:navy">jz      short </span><span style="color:gray">CWRTROK   </span>; Ignore
<span style="color:black">DOSCODE:7E12                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:7E14                 </span><span style="color:navy">jz      short </span><span style="color:gray">CWRFERR
</span><span style="color:black">DOSCODE:7E16                 </span><span style="color:navy">pop     ds              </span>; Recover saved seg of transfer
<span style="color:black">DOSCODE:7E17                 </span><span style="color:navy">jmp     short </span><span style="color:gray">DVWRTRAW  </span>; Try again
<span style="color:black">DOSCODE:7E19 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7E19
DOSCODE:7E19 </span><span style="color:gray">CWRFERR</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7E19                 </span><span style="color:navy">pop     ax              </span>; Chuck saved seg of transfer
<span style="color:black">DOSCODE:7E1A                 </span><span style="color:navy">jmp     </span>CRDFERR         ; Will pop one more stack element
<span style="color:black">DOSCODE:7E1D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7E1D
DOSCODE:7E1D </span><span style="color:gray">CWRTROK</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7E1D                 </span><span style="color:navy">pop     ax              </span>; Chuck saved seg of transfer
<span style="color:black">DOSCODE:7E1E                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7E1F                 </span><span style="color:navy">mov     ax, ds:</span>CALLBPB  ; [CALLSCNT]
<span style="color:black">DOSCODE:7E1F                                         </span>; Get actual number of bytes transferred
<span style="color:black">DOSCODE:7E22
DOSCODE:7E22 </span><span style="color:gray">ENDWRDEV</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7E22                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:black">DOSCODE:7E26                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">DOSCODE:7E28                 </span><span style="color:navy">call    </span>ADDREC
<span style="color:black">DOSCODE:7E2B                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7E2C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7E2C
DOSCODE:7E2C </span><span style="color:gray">WRTNUL</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7E2C                 </span><span style="color:navy">mov     dx, cx          </span>; Entire transfer done
<span style="color:black">DOSCODE:7E2E
DOSCODE:7E2E </span><span style="color:gray">WRTCOOKJ</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7E2E                 </span><span style="color:navy">jmp     </span><span style="color:gray">WRTCOOKDONE
</span><span style="color:black">DOSCODE:7E31 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7E31
DOSCODE:7E31 </span><span style="color:gray">WRTDEV</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7E31                 </span><span style="color:navy">mov     ds:</span>EXTERR_LOCUS<span style="color:navy">, </span><span style="color:#ff8000">4 </span>; errLOC_SerDev
<span style="color:black">DOSCODE:7E36                 </span><span style="color:navy">or      byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [ES:DI+SF_ENTRY.sf_flags],
<span style="color:black">DOSCODE:7E36                                         </span>; devid_device_EOF
<span style="color:black">DOSCODE:7E36                                         </span>; Reset EOF for input
<span style="color:black">DOSCODE:7E3B                 </span><span style="color:navy">mov     bl, es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_flags]
<span style="color:black">DOSCODE:7E3F                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:7E41                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">ENDWRDEV  </span>; problem of creating on a device
<span style="color:black">DOSCODE:7E43                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:7E44                 </span><span style="color:navy">mov     al, bl
</span><span style="color:black">DOSCODE:7E46                 </span><span style="color:navy">lds     bx, ds:</span>DMAADD   ; Xaddr to DS:BX
<span style="color:black">DOSCODE:7E4A                 </span><span style="color:navy">mov     di, bx          </span>; Xaddr to DS:DI
<span style="color:black">DOSCODE:7E4C                 </span><span style="color:navy">cwd                     </span>; Set starting point
<span style="color:black">DOSCODE:7E4D                 </span><span style="color:navy">test    al, </span><span style="color:green">20h         </span>; devid_device_raw
<span style="color:black">DOSCODE:7E4F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">DVWRTRAW
</span><span style="color:black">DOSCODE:7E51
DOSCODE:7E51 </span>TEST_DEV_CON<span style="color:navy">:                           </span>;
<span style="color:black">DOSCODE:7E51                 </span><span style="color:navy">test    al, </span><span style="color:green">2           </span>; devid_device_con_out
<span style="color:black">DOSCODE:7E51                                         </span>; Console output device?
<span style="color:black">DOSCODE:7E53                 </span><span style="color:navy">jnz     short </span><span style="color:gray">WRITECON  </span>; yes
<span style="color:black">DOSCODE:7E55                 </span><span style="color:navy">test    al, </span><span style="color:green">4           </span>; devid_device_null
<span style="color:black">DOSCODE:7E57                 </span><span style="color:navy">jnz     short </span><span style="color:gray">WRTNUL
</span><span style="color:black">DOSCODE:7E59                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:black">DOSCODE:7E5B                 </span><span style="color:navy">cmp     byte ptr [bx], </span><span style="color:#ff8000">1Ah </span>; ^Z?
<span style="color:black">DOSCODE:7E5E                 </span><span style="color:navy">jz      short </span><span style="color:gray">WRTCOOKJ  </span>; Yes, transfer nothing
<span style="color:black">DOSCODE:7E60                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:7E61                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:7E64                 </span><span style="color:navy">call    </span>SETWRITE
<span style="color:black">DOSCODE:7E67                 </span><span style="color:navy">lds     si, ss:</span>THISSFT
<span style="color:black">DOSCODE:7E6C                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:7E6D                 </span><span style="color:navy">lds     si, [si+</span><span style="color:#ff8000">7</span><span style="color:navy">]      </span>; [SI+SF_ENTRY.sf_devptr]
<span style="color:black">DOSCODE:7E70
DOSCODE:7E70 </span><span style="color:gray">DVWRTLP</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7E70                 </span><span style="color:navy">call    </span>DSKSTATCHK
<span style="color:black">DOSCODE:7E73                 </span><span style="color:navy">call    </span>DEVIOCALL2
<span style="color:black">DOSCODE:7E76                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:7E77                 </span><span style="color:navy">mov     di, ss:</span>DEVCALL_REQSTAT
<span style="color:black">DOSCODE:7E7C                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">87h
</span><span style="color:black">DOSCODE:7E7E                 </span><span style="color:navy">or      di, di
</span><span style="color:black">DOSCODE:7E80                 </span><span style="color:navy">jns     short </span><span style="color:gray">CWROK
</span><span style="color:black">DOSCODE:7E82                 </span><span style="color:navy">call    </span>CHARHARD
<span style="color:black">DOSCODE:7E85                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:7E86                 </span><span style="color:navy">mov     ss:</span>CALLBPB<span style="color:navy">, </span><span style="color:#ff8000">1   </span>; [SS:CALLSCNT]
<span style="color:black">DOSCODE:7E8D                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:7E8F                 </span><span style="color:navy">jz      short </span><span style="color:gray">DVWRTLP   </span>; Retry
<span style="color:black">DOSCODE:7E91                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:7E93                 </span><span style="color:navy">jz      short </span><span style="color:gray">DVWRTIGN  </span>; Ignore
<span style="color:black">DOSCODE:7E95                 </span><span style="color:navy">jmp     </span>CRDFERR         ; Fail, pops one stack element
<span style="color:black">DOSCODE:7E98 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7E98
DOSCODE:7E98 </span><span style="color:gray">CWROK</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7E98                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:7E99                 </span><span style="color:navy">cmp     ss:</span>CALLBPB<span style="color:navy">, </span><span style="color:#ff8000">0   </span>; [SS:CALLSCNT]
<span style="color:black">DOSCODE:7E9F                 </span><span style="color:navy">jz      short </span><span style="color:gray">WRTCOOKDONE
</span><span style="color:black">DOSCODE:7EA1
DOSCODE:7EA1 </span><span style="color:gray">DVWRTIGN</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7EA1                 </span><span style="color:navy">inc     dx
</span><span style="color:black">DOSCODE:7EA2                 </span><span style="color:navy">inc     word ptr ss:</span>CALLBR ; [SS:CALLXAD]
<span style="color:black">DOSCODE:7EA7                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:7EA8                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:7EA9                 </span><span style="color:navy">mov     ds, ss:</span>CALLXAD_2 ; [SS:CALLXAD+2]
<span style="color:black">DOSCODE:7EAE                 </span><span style="color:navy">cmp     byte ptr [di], </span><span style="color:#ff8000">1Ah </span>; ^Z?
<span style="color:black">DOSCODE:7EB1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7EB2                 </span><span style="color:navy">jz      short </span><span style="color:gray">WRTCOOKDONE
</span><span style="color:black">DOSCODE:7EB4                 </span><span style="color:navy">mov     ss:</span>DEVCALL_REQSTAT<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:7EBB                 </span><span style="color:navy">loop    </span><span style="color:gray">DVWRTLP
</span><span style="color:black">DOSCODE:7EBD
DOSCODE:7EBD </span><span style="color:gray">WRTCOOKDONE</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7EBD                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:black">DOSCODE:7EBF                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7EC0                 </span><span style="color:navy">jmp     </span><span style="color:gray">ENDWRDEV
</span><span style="color:black">DOSCODE:7EC3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7EC3
DOSCODE:7EC3 </span><span style="color:gray">WRITECON</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7EC3                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:7EC4                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:7EC5                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7EC6                 </span><span style="color:navy">call    </span>SWAPCON
<span style="color:black">DOSCODE:7EC9                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7ECA                 </span><span style="color:navy">mov     si, bx
</span><span style="color:black">DOSCODE:7ECC                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:7ECD
DOSCODE:7ECD </span><span style="color:gray">WRCONLP</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7ECD                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:7ECE                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1Ah         </span>; ^Z?
<span style="color:black">DOSCODE:7ED0                 </span><span style="color:navy">jz      short </span><span style="color:gray">CONEOF    </span>; yes
<span style="color:black">DOSCODE:7ED2                 </span><span style="color:navy">call    </span>OUTT
<span style="color:black">DOSCODE:7ED5                 </span><span style="color:navy">loop    </span><span style="color:gray">WRCONLP
</span><span style="color:black">DOSCODE:7ED7
DOSCODE:7ED7 </span><span style="color:gray">CONEOF</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7ED7                 </span><span style="color:navy">pop     ax              </span>; Count
<span style="color:black">DOSCODE:7ED8                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7ED9                 </span><span style="color:navy">sub     ax, cx          </span>; Amount actually written
<span style="color:black">DOSCODE:7EDB                 </span><span style="color:navy">call    </span>SWAPBACK
<span style="color:black">DOSCODE:7EDE                 </span><span style="color:navy">jmp     </span><span style="color:gray">ENDWRDEV
</span><span style="color:black">DOSCODE:7EDE </span><span style="background:red">DOS_WRITE       endp</span><span style="background:red"> ; sp-analysis failed</span>
<span style="color:black">DOSCODE:7EDE
DOSCODE:7EE1
DOSCODE:7EE1 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7EE1
DOSCODE:7EE1
DOSCODE:7EE1 </span>GET_IO_SFT      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7EE1                 </span><span style="color:navy">cmp     ss:</span>CONSWAP<span style="color:navy">, </span><span style="color:#ff8000">0   </span>; Convert JFN num in BX to sf_entry in DS:SI
<span style="color:black">DOSCODE:7EE7                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GetRedir
</span><span style="color:black">DOSCODE:7EE9
DOSCODE:7EE9 </span><span style="color:gray">GetNormal</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7EE9                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:7EEA                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7EEB                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:7EEC                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:7EED                 </span><span style="color:navy">call    </span>SFFromHandle
<span style="color:black">DOSCODE:7EF0                 </span><span style="color:navy">jb      short </span><span style="color:gray">RET44P
</span><span style="color:black">DOSCODE:7EF2                 </span><span style="color:navy">mov     si, es
</span><span style="color:black">DOSCODE:7EF4                 </span><span style="color:navy">mov     ds, si
</span><span style="color:black">DOSCODE:7EF6                 </span><span style="color:navy">mov     si, di
</span><span style="color:black">DOSCODE:7EF8
DOSCODE:7EF8 </span><span style="color:gray">RET44P</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7EF8                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:7EF9                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:7EFA                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7EFB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7EFB
DOSCODE:7EFB </span><span style="color:gray">GetRedir</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7EFB                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:7EFE                 </span><span style="color:navy">ja      short </span><span style="color:gray">GetNormal
</span><span style="color:black">DOSCODE:7F00                 </span><span style="color:navy">lds     si, ss:</span>CONSFT
<span style="color:black">DOSCODE:7F05                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:7F06
DOSCODE:7F06 </span>get_io_sft_retn<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7F06                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7F06 </span>GET_IO_SFT      <span style="color:black">endp
DOSCODE:7F06
DOSCODE:7F07
DOSCODE:7F07 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7F07
DOSCODE:7F07
DOSCODE:7F07 </span>DIRREAD         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7F07                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:7F09                 </span><span style="color:navy">cmp     ds:</span>DIRSTART_HW<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:7F0D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SubDir
</span><span style="color:black">DOSCODE:7F0F                 </span><span style="color:navy">cmp     ds:</span>DIRSTART<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:7F13                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SubDir
</span><span style="color:black">DOSCODE:7F15                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:black">DOSCODE:7F16                 </span><span style="color:navy">jmp     short </span><span style="color:gray">DoRead
</span><span style="color:black">DOSCODE:7F18 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7F18
DOSCODE:7F18 </span><span style="color:gray">SubDir</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7F18                 </span><span style="color:navy">mov     dl, al
</span><span style="color:black">DOSCODE:7F1A                 </span><span style="color:navy">mov     cl, es:[bp+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [ES:BP+DPB.CLUSTER_SHIFT]
<span style="color:black">DOSCODE:7F1E                 </span><span style="color:navy">and     dl, es:[bp+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [ES:BP+DPB.CLUSTER_MASK]
<span style="color:black">DOSCODE:7F22                 </span><span style="color:navy">shr     ax, cl
</span><span style="color:black">DOSCODE:7F24
DOSCODE:7F24 </span><span style="color:gray">DoRead</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7F24                 </span><span style="color:navy">mov     ds:</span>SECCLUSPOS<span style="color:navy">, dl
</span><span style="color:black">DOSCODE:7F28                 </span><span style="color:navy">mov     cx, ax          </span>; (CX) = number of clusters to skip.
<span style="color:black">DOSCODE:7F2A                 </span><span style="color:navy">mov     ah, dl          </span>; (AH) = remainder
<span style="color:black">DOSCODE:7F2C                 </span><span style="color:navy">mov     bx, ds:</span>CLUSNUM_HW
<span style="color:black">DOSCODE:7F30                 </span><span style="color:navy">mov     ds:</span>NXTCLUSNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:7F34                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:7F38                 </span><span style="color:navy">mov     dx, ds:</span>DIRSEC<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:7F3C                 </span><span style="color:navy">mov     bx, ds:</span>CLUSNUM
<span style="color:black">DOSCODE:7F40                 </span><span style="color:navy">mov     ds:</span>HIGH_SECTOR<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:7F44                 </span><span style="color:navy">mov     dx, ds:</span>DIRSEC
<span style="color:black">DOSCODE:7F48                 </span><span style="color:navy">add     dl, ah
</span><span style="color:black">DOSCODE:7F4A                 </span><span style="color:navy">adc     dh, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:7F4D                 </span><span style="color:navy">adc     ds:</span>HIGH_SECTOR<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:7F52                 </span><span style="color:navy">mov     ds:</span>NXTCLUSNUM<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:7F56                 </span><span style="color:navy">jcxz    short </span>FIRSTCLUSTER
<span style="color:black">DOSCODE:7F58
DOSCODE:7F58 </span><span style="color:gray">SKPCLLP</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7F58                 </span><span style="color:navy">call    </span>UNPACK
<span style="color:black">DOSCODE:7F5B
DOSCODE:7F5B </span><span style="color:gray">dirread_cont</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7F5B                 </span><span style="color:navy">jb      short </span>get_io_sft_retn
<span style="color:black">DOSCODE:7F5D                 </span><span style="color:navy">push    ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:7F61                 </span><span style="color:navy">pop     ds:</span>CLUSTERS_HW
<span style="color:black">DOSCODE:7F65                 </span><span style="color:navy">push    ds:</span>CCONTENT_HW
<span style="color:black">DOSCODE:7F69                 </span><span style="color:navy">pop     ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:7F6D                 </span><span style="color:navy">xchg    bx, di
</span><span style="color:black">DOSCODE:7F6F                 </span><span style="color:navy">call    </span>IsEOF           ; test for eof based on fat size
<span style="color:black">DOSCODE:7F72                 </span><span style="color:navy">jnb     short </span><span style="color:gray">HAVESKIPPED
</span><span style="color:black">DOSCODE:7F74                 </span><span style="color:navy">loop    </span><span style="color:gray">SKPCLLP
</span><span style="color:black">DOSCODE:7F76
DOSCODE:7F76 </span><span style="color:gray">HAVESKIPPED</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7F76                 </span><span style="color:navy">mov     ds:</span>NXTCLUSNUM<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:7F7A                 </span><span style="color:navy">mov     bx, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:7F7E                 </span><span style="color:navy">mov     ds:</span>NXTCLUSNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:7F82                 </span><span style="color:navy">mov     dx, di
</span><span style="color:black">DOSCODE:7F84                 </span><span style="color:navy">mov     bx, ds:</span>CLUSTERS_HW
<span style="color:black">DOSCODE:7F88                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:7F8C                 </span><span style="color:navy">mov     bl, ah
</span><span style="color:black">DOSCODE:7F8E                 </span><span style="color:navy">call    </span>FIGREC
<span style="color:black">DOSCODE:7F91
DOSCODE:7F91 </span>FIRSTCLUSTER<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7F91                 </span><span style="color:navy">mov     ds:</span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">18h </span>; Allowed_RETRY+Allowed_FAIL
<span style="color:black">DOSCODE:7F96                 </span><span style="color:navy">xor     al, al          </span>; Indicate pre-read
<span style="color:black">DOSCODE:7F98                 </span><span style="color:navy">call    </span>GETBUFFR
<span style="color:black">DOSCODE:7F9B                 </span><span style="color:navy">jb      short </span><span style="color:gray">dirread_cont
</span><span style="color:black">DOSCODE:7F9D
DOSCODE:7F9D </span>SET_BUF_AS_DIR<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7F9D                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:7F9E                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:7F9F                 </span><span style="color:navy">lds     si, ds:</span>CURBUF
<span style="color:black">DOSCODE:7FA3                 </span><span style="color:navy">or      byte ptr [si+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">4 </span>; [SI+BUFFINFO.buf_flags],buf_isDIR
<span style="color:black">DOSCODE:7FA7                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:7FA8                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:7FA9
DOSCODE:7FA9 </span>dirread_retn<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7FA9                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:7FA9 </span>DIRREAD         <span style="color:black">endp
DOSCODE:7FA9
DOSCODE:7FAA
DOSCODE:7FAA </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:7FAA
DOSCODE:7FAA
DOSCODE:7FAA </span>FATSECRD        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7FAA
DOSCODE:7FAA </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:8027 SIZE 00000007 BYTES
</span><span style="color:black">DOSCODE:7FAA
DOSCODE:7FAA                 </span><span style="color:navy">mov     ss:</span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">18h </span>; Allowed_RETRY+Allowed_FAIL
<span style="color:black">DOSCODE:7FB0                 </span><span style="color:navy">mov     di, cx
</span><span style="color:black">DOSCODE:7FB2                 </span><span style="color:navy">mov     cl, es:[bp+</span><span style="color:#ff8000">8</span><span style="color:navy">]   </span>; [ES:BP+DPB.FAT_COUNT]
<span style="color:black">DOSCODE:7FB6                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">] </span>; [ES:BP+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:7FBA                 </span><span style="color:navy">xor     ch, ch
</span><span style="color:black">DOSCODE:7FBC                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:7FBE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">FATSECRD_cont </span>; not FAT32
<span style="color:black">DOSCODE:7FC0                 </span><span style="color:navy">test    byte ptr es:[bp+</span><span style="color:#ff8000">23h</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:BP+DPB.EXT_FLAGS]
<span style="color:black">DOSCODE:7FC5                 </span><span style="color:navy">jz      short </span><span style="color:gray">FATSECRD_cont
</span><span style="color:black">DOSCODE:7FC7                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1           </span>; only one FAT is active
<span style="color:black">DOSCODE:7FCA
DOSCODE:7FCA </span><span style="color:gray">FATSECRD_cont</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7FCA                 </span><span style="color:navy">push    ss:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:7FCF                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:7FD0
DOSCODE:7FD0 </span><span style="color:gray">NXTFAT</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7FD0                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:7FD1                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:7FD2                 </span><span style="color:navy">push    ss:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:7FD7                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:7FD8                 </span><span style="color:navy">mov     cx, di
</span><span style="color:black">DOSCODE:7FDA                 </span><span style="color:navy">call    </span>DSKREAD
<span style="color:black">DOSCODE:7FDD                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:7FDE                 </span><span style="color:navy">pop     ss:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:7FE3                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:7FE4                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:7FE5                 </span><span style="color:navy">jz      short </span><span style="color:gray">RET41P
</span><span style="color:black">DOSCODE:7FE7                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:7FE9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NXTFAT2   </span>; not FAT32
<span style="color:black">DOSCODE:7FEB                 </span><span style="color:navy">add     dx, es:[bp+</span><span style="color:#ff8000">31h</span><span style="color:navy">] </span>; DPB.FAT32_SIZE
<span style="color:black">DOSCODE:7FEF                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:7FF0                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">33h</span><span style="color:navy">] </span>; DPB.FAT32_SIZE+2
<span style="color:black">DOSCODE:7FF4                 </span><span style="color:navy">adc     ss:</span>HIGH_SECTOR<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:7FF9                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:7FFA                 </span><span style="color:navy">jmp     short </span><span style="color:gray">NXTFAT3
</span><span style="color:black">DOSCODE:7FFC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:7FFC
DOSCODE:7FFC </span><span style="color:gray">NXTFAT2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:7FFC                 </span><span style="color:navy">add     dx, ax
</span><span style="color:black">DOSCODE:7FFE                 </span><span style="color:navy">adc     ss:</span>HIGH_SECTOR<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8004
DOSCODE:8004 </span><span style="color:gray">NXTFAT3</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8004                 </span><span style="color:navy">loop    </span><span style="color:gray">NXTFAT
</span><span style="color:black">DOSCODE:8006                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:8007                 </span><span style="color:navy">pop     ss:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:800C                 </span><span style="color:navy">mov     cx, di
</span><span style="color:black">DOSCODE:800C </span>FATSECRD        <span style="color:black">endp
DOSCODE:800C
DOSCODE:800E
DOSCODE:800E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:800E
DOSCODE:800E
DOSCODE:800E </span>DREAD           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:800E                 </span><span style="color:navy">call    </span>DSKREAD
<span style="color:black">DOSCODE:8011                 </span><span style="color:navy">jz      short </span>dirread_retn
<span style="color:black">DOSCODE:8013                 </span><span style="color:navy">mov     ss:</span>READOP<span style="color:navy">, </span><span style="color:#ff8000">0    </span>; Read
<span style="color:black">DOSCODE:8019                 </span><span style="color:navy">call    </span>HARDERRRW
<span style="color:black">DOSCODE:801C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1           </span>; RETRY
<span style="color:black">DOSCODE:801E                 </span><span style="color:navy">jz      short </span>DREAD
<span style="color:black">DOSCODE:8020                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3           </span>; FAIL
<span style="color:black">DOSCODE:8022                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:8023                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NO_CAR    </span>; IGNORE
<span style="color:black">DOSCODE:8025                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:8026
DOSCODE:8026 </span><span style="color:gray">NO_CAR</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8026                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8026 </span>DREAD           <span style="color:black">endp
DOSCODE:8026
DOSCODE:8027 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8027 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR FATSECRD
</span><span style="color:black">DOSCODE:8027
DOSCODE:8027 </span><span style="color:gray">RET41P</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8027                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:8028                 </span><span style="color:navy">pop     ss:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:802D                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:802D </span><span style="color:gray">; END OF FUNCTION CHUNK FOR FATSECRD
</span><span style="color:black">DOSCODE:802E
DOSCODE:802E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:802E
DOSCODE:802E
DOSCODE:802E </span>CHECK_WRITE_LOCK <span style="color:black">proc near              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:802E                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">8 </span>; [ES:DI+SF_ENTRY.sf_attr],
<span style="color:black">DOSCODE:802E                                         </span>; attr_volume_id
<span style="color:black">DOSCODE:8033                 </span><span style="color:navy">jz      short </span><span style="color:gray">write_cont
</span><span style="color:black">DOSCODE:8035                 </span><span style="color:navy">call    </span>SET_ACC_ERR_DS
<span style="color:black">DOSCODE:8038                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8039 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8039
DOSCODE:8039 </span><span style="color:gray">write_cont</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8039                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:803A                 </span><span style="color:navy">or      cx, cx
</span><span style="color:black">DOSCODE:803C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">Not_Truncate
</span><span style="color:black">DOSCODE:803E                 </span><span style="color:navy">dec     cx              </span>; -1 ; check for lock on whole file
<span style="color:black">DOSCODE:803F
DOSCODE:803F </span><span style="color:gray">Not_Truncate</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:803F                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">80h         </span>; check write access
<span style="color:black">DOSCODE:8041                 </span><span style="color:navy">call    </span>LOCK_CHECK      ; check lock
<span style="color:black">DOSCODE:8044                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:8045                 </span><span style="color:navy">jnb     short </span><span style="color:gray">WRITE_OK  </span>; lock ok
<span style="color:black">DOSCODE:8047                 </span><span style="color:navy">call    </span>WRITE_LOCK_VIOLATION ; issue I24
<span style="color:black">DOSCODE:804A                 </span><span style="color:navy">jnb     short </span><span style="color:gray">write_cont </span>; retry
<span style="color:black">DOSCODE:804C
DOSCODE:804C </span><span style="color:gray">WRITE_OK</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:804C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:804C </span>CHECK_WRITE_LOCK <span style="color:black">endp
DOSCODE:804C
DOSCODE:804D
DOSCODE:804D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:804D
DOSCODE:804D
DOSCODE:804D </span>CHECK_READ_LOCK <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:804D                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">8 </span>; [ES:DI+SF_ENTRY.sf_attr],
<span style="color:black">DOSCODE:804D                                         </span>; attr_volume_id
<span style="color:black">DOSCODE:8052                 </span><span style="color:navy">jz      short </span><span style="color:gray">do_retry
</span><span style="color:black">DOSCODE:8054                 </span><span style="color:navy">call    </span>SET_ACC_ERR
<span style="color:black">DOSCODE:8057                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8058 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8058
DOSCODE:8058 </span><span style="color:gray">do_retry</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8058                 </span><span style="color:navy">xor     al, al          </span>; check read access
<span style="color:black">DOSCODE:805A                 </span><span style="color:navy">call    </span>LOCK_CHECK      ; check lock
<span style="color:black">DOSCODE:805D                 </span><span style="color:navy">jnb     short </span><span style="color:gray">READLOCK_OK </span>; lock ok
<span style="color:black">DOSCODE:805F                 </span><span style="color:navy">call    </span>READ_LOCK_VIOLATION ; issue I24
<span style="color:black">DOSCODE:8062                 </span><span style="color:navy">jnb     short </span><span style="color:gray">do_retry  </span>; retry
<span style="color:black">DOSCODE:8064
DOSCODE:8064 </span><span style="color:gray">READLOCK_OK</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8064                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8064 </span>CHECK_READ_LOCK <span style="color:black">endp
DOSCODE:8064
DOSCODE:8065
DOSCODE:8065 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8065
DOSCODE:8065
DOSCODE:8065 </span>DSKREAD         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8065                 </span><span style="color:navy">push    cx              </span>; DS:BX = Transfer address
<span style="color:black">DOSCODE:8065                                         </span>; [HIGH_SECTOR]:DX = Disk sector address
<span style="color:black">DOSCODE:8065                                         </span>; CX = Sector count
<span style="color:black">DOSCODE:8065                                         </span>; ES:BP = DPB
<span style="color:black">DOSCODE:8066                 </span><span style="color:navy">mov     ah, es:[bp+</span><span style="color:#ff8000">17h</span><span style="color:navy">] </span>; [ES:BP+DPB.MEDIA]
<span style="color:black">DOSCODE:806A                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">1</span><span style="color:navy">]   </span>; [ES:BP+DPB.UNIT]
<span style="color:black">DOSCODE:806E                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:806F                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:8070                 </span><span style="color:navy">call    </span>SETREAD
<span style="color:black">DOSCODE:8073                 </span><span style="color:navy">jmp     short </span>DODSKOP
<span style="color:black">DOSCODE:8073 </span>DSKREAD         <span style="color:black">endp
DOSCODE:8073
DOSCODE:8075
DOSCODE:8075 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8075
DOSCODE:8075
DOSCODE:8075 </span>DWRITE          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8075                 </span><span style="color:navy">call    </span>DSKWRITE
<span style="color:black">DOSCODE:8078                 </span><span style="color:navy">jnz     short </span><span style="color:gray">dwrite1
</span><span style="color:black">DOSCODE:807A                 </span><span style="color:navy">retn                    </span>; Carry clear (retz)
<span style="color:black">DOSCODE:807B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:807B
DOSCODE:807B </span><span style="color:gray">dwrite1</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:807B                 </span><span style="color:navy">mov     ss:</span>READOP<span style="color:navy">, </span><span style="color:#ff8000">1    </span>; Write
<span style="color:black">DOSCODE:8081                 </span><span style="color:navy">call    </span>HARDERRRW
<span style="color:black">DOSCODE:8084                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1           </span>; Check for retry
<span style="color:black">DOSCODE:8086                 </span><span style="color:navy">jz      short </span>DWRITE
<span style="color:black">DOSCODE:8088                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3           </span>; Check for FAIL
<span style="color:black">DOSCODE:808A                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:808B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NO_CAR2   </span>; Ignore
<span style="color:black">DOSCODE:808D                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:808E
DOSCODE:808E </span><span style="color:gray">NO_CAR2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:808E                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:808E </span>DWRITE          <span style="color:black">endp
DOSCODE:808E
DOSCODE:808F
DOSCODE:808F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:808F
DOSCODE:808F
DOSCODE:808F </span>DSKWRITE        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:808F                 </span><span style="color:navy">push    cx              </span>; DS:BX = Transfer address
<span style="color:black">DOSCODE:808F                                         </span>; [HIGH_SECTOR]:DX = Disk sector address
<span style="color:black">DOSCODE:808F                                         </span>; CX = Sector count
<span style="color:black">DOSCODE:808F                                         </span>; ES:BP = DPB
<span style="color:black">DOSCODE:8090                 </span><span style="color:navy">mov     ah, es:[bp+</span><span style="color:#ff8000">17h</span><span style="color:navy">] </span>; [ES:BP+DPB.MEDIA]
<span style="color:black">DOSCODE:8094                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">1</span><span style="color:navy">]   </span>; [ES:BP+DPB.UNIT]
<span style="color:black">DOSCODE:8098                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:8099                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:809A                 </span><span style="color:navy">call    </span>SETWRITE
<span style="color:black">DOSCODE:809D
DOSCODE:809D </span>DODSKOP<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:809D                 </span><span style="color:navy">mov     cx, ds
</span><span style="color:black">DOSCODE:809F                 </span><span style="color:navy">pop     ds              </span>; DS:BP points to DPB
<span style="color:black">DOSCODE:80A0                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:80A1                 </span><span style="color:navy">lds     si, ds:[bp+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [ds:BP+DPB.DRIVER_ADDR]
<span style="color:black">DOSCODE:80A5                 </span><span style="color:navy">call    </span>DEVIOCALL2
<span style="color:black">DOSCODE:80A8                 </span><span style="color:navy">mov     ds, cx
</span><span style="color:black">DOSCODE:80AA                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:80AB                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:80AC                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:80AD                 </span><span style="color:navy">mov     cx, ss:</span>CALLBPB  ; [SS:CALLSCNT] ; Number of sectors transferred
<span style="color:black">DOSCODE:80B2                 </span><span style="color:navy">mov     ax, ss:</span>DEVCALL_REQSTAT
<span style="color:black">DOSCODE:80B6                 </span><span style="color:navy">sub     cx, di
</span><span style="color:black">DOSCODE:80B8                 </span><span style="color:navy">neg     cx              </span>; Number of sectors not transferred
<span style="color:black">DOSCODE:80BA                 </span><span style="color:navy">test    ax, </span><span style="color:green">8000h       </span>; test ah,(STERR&gt;&gt;8)
<span style="color:black">DOSCODE:80BD                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:80BD </span>DSKWRITE        <span style="color:black">endp
DOSCODE:80BD
DOSCODE:80BE
DOSCODE:80BE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:80BE
DOSCODE:80BE
DOSCODE:80BE </span>HARDERRRW       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:80BE                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Fh         </span>; error_I24_wrong_disk
<span style="color:black">DOSCODE:80C0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">DO_ERR
</span><span style="color:black">DOSCODE:80C2                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:80C3                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:80C4                 </span><span style="color:navy">les     ax, ss:</span>CALLVIDRW
<span style="color:black">DOSCODE:80C9                 </span><span style="color:navy">mov     word ptr ss:</span>EXTERRPT<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:80CD                 </span><span style="color:navy">mov     word ptr ss:</span>EXTERRPT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:80D2                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:80D3                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:80D4
DOSCODE:80D4 </span><span style="color:gray">DO_ERR</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:80D4                 </span><span style="color:navy">call    </span>HARDERR
<span style="color:black">DOSCODE:80D7                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:80D7 </span>HARDERRRW       <span style="color:black">endp
DOSCODE:80D7
DOSCODE:80D8
DOSCODE:80D8 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:80D8
DOSCODE:80D8
DOSCODE:80D8 </span>SETUP           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:80D8                 </span><span style="color:navy">lds     si, es:[di+</span><span style="color:#ff8000">7</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_devptr]
<span style="color:black">DOSCODE:80DC                 </span><span style="color:navy">mov     word ptr ss:</span>THISDPB<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:black">DOSCODE:80E1                 </span><span style="color:navy">mov     bx, ss
</span><span style="color:black">DOSCODE:80E3                 </span><span style="color:navy">mov     ds, bx
</span><span style="color:black">DOSCODE:80E5                 </span><span style="color:navy">mov     bx, word ptr ds:</span>DMAADD
<span style="color:black">DOSCODE:80E9                 </span><span style="color:navy">mov     word ptr ds:</span>THISDPB<span style="color:navy">, si
</span><span style="color:black">DOSCODE:80ED                 </span><span style="color:navy">mov     ds:</span>NEXTADD<span style="color:navy">, bx  </span>; Set NEXTADD to start of Xaddr
<span style="color:black">DOSCODE:80F1                 </span><span style="color:navy">mov     ds:</span>TRANS<span style="color:navy">, </span><span style="color:#ff8000">0     </span>; No transferes
<span style="color:black">DOSCODE:80F6                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_position]
<span style="color:black">DOSCODE:80FA                 </span><span style="color:navy">mov     dx, es:[di+</span><span style="color:#ff8000">17h</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_position+2]
<span style="color:black">DOSCODE:80FE                 </span><span style="color:navy">mov     word ptr ds:</span>BYTPOS<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8101                 </span><span style="color:navy">mov     word ptr ds:</span>BYTPOS<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, dx
</span><span style="color:black">DOSCODE:8105                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">8080h </span>; [ES:DI+SF_ENTRY.sf_flags],
<span style="color:black">DOSCODE:8105                                         </span>; sf_isnet+devid_device
<span style="color:black">DOSCODE:810B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOSETSTUFF
</span><span style="color:black">DOSCODE:810D                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:810E                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:8112                 </span><span style="color:navy">mov     bl, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; [ES:BP+DPB.DRIVE]
<span style="color:black">DOSCODE:8116                 </span><span style="color:navy">push    cx              </span>; SHR32 and DIV32 use CX.
<span style="color:black">DOSCODE:8117                 </span><span style="color:navy">mov     ds:</span>THISDRV<span style="color:navy">, bl
</span><span style="color:black">DOSCODE:811B                 </span><span style="color:navy">mov     bx, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [ES:BP+DPB.SECTOR_SIZE]
<span style="color:black">DOSCODE:811F                 </span><span style="color:navy">call    </span>DIV32           ; DX:AX/BX = CX:AX + DX (rem)
<span style="color:black">DOSCODE:8122                 </span><span style="color:navy">mov     ds:</span>BYTSECPOS<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:8126                 </span><span style="color:navy">mov     word ptr ds:</span>SECPOS<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8129                 </span><span style="color:navy">mov     word ptr ds:</span>SECPOS<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, cx
</span><span style="color:black">DOSCODE:812D                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:black">DOSCODE:812F                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">DOSCODE:8131                 </span><span style="color:navy">and     bl, es:[bp+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [ES:BP+DPB.CLUSTER_MASK]
<span style="color:black">DOSCODE:8135                 </span><span style="color:navy">mov     ds:</span>SECCLUSPOS<span style="color:navy">, bl
</span><span style="color:black">DOSCODE:8139                 </span><span style="color:navy">call    </span>SHR32           ; (DX:AX SHR dpb_cluster_shift)
<span style="color:black">DOSCODE:813C                 </span><span style="color:navy">pop     cx              </span>; CX = byte count.
<span style="color:black">DOSCODE:813D                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:bp+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:8142                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setup_1   </span>; not FAT32
<span style="color:black">DOSCODE:8144                 </span><span style="color:navy">cmp     dx, es:[bp+</span><span style="color:#ff8000">2Fh</span><span style="color:navy">] </span>; [ES:BP+DPB.LAST_CLUSTER+2]
<span style="color:black">DOSCODE:8148                 </span><span style="color:navy">jnz     short </span><span style="color:gray">setup_2
</span><span style="color:black">DOSCODE:814A                 </span><span style="color:navy">cmp     ax, es:[bp+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">] </span>; [ES:BP+DPB.LAST_CLUSTER]
<span style="color:black">DOSCODE:814E                 </span><span style="color:navy">jmp     short </span><span style="color:gray">setup_2
</span><span style="color:black">DOSCODE:8150 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8150
DOSCODE:8150 </span><span style="color:gray">setup_1</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8150                 </span><span style="color:navy">or      dx, dx
</span><span style="color:black">DOSCODE:8152                 </span><span style="color:navy">jnz     short </span><span style="color:gray">EOFERR
</span><span style="color:black">DOSCODE:8154                 </span><span style="color:navy">cmp     ax, es:[bp+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">] </span>; [ES:BP+DPB.MAX_CLUSTER]
<span style="color:black">DOSCODE:8158
DOSCODE:8158 </span><span style="color:gray">setup_2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8158                 </span><span style="color:navy">ja      short </span><span style="color:gray">EOFERR
</span><span style="color:black">DOSCODE:815A                 </span><span style="color:navy">mov     ds:</span>CLUSNUM<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:815D                 </span><span style="color:navy">mov     ds:</span>CLUSNUM_HW<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:8161                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:8162
DOSCODE:8162 </span><span style="color:gray">NOSETSTUFF</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8162                 </span><span style="color:navy">mov     ax, cx          </span>; Byte count.
<span style="color:black">DOSCODE:8164                 </span><span style="color:navy">add     ax, word ptr ds:</span>DMAADD ; See if it will fit in one segment
<span style="color:black">DOSCODE:8168                 </span><span style="color:navy">jb      short </span><span style="color:gray">setup_3   </span>; Must be less than 64K
<span style="color:black">DOSCODE:816A                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:816B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:816B
DOSCODE:816B </span><span style="color:gray">setup_3</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:816B                 </span><span style="color:navy">mov     ax, word ptr ds:</span>DMAADD
<span style="color:black">DOSCODE:816E                 </span><span style="color:navy">neg     ax              </span>; Amount of room left in segment
<span style="color:black">DOSCODE:8170                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NoDec
</span><span style="color:black">DOSCODE:8172                 </span><span style="color:navy">dec     ax
</span><span style="color:black">DOSCODE:8173
DOSCODE:8173 </span><span style="color:gray">NoDec</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8173                 </span><span style="color:navy">mov     cx, ax          </span>; Can do this much
<span style="color:black">DOSCODE:8175                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">NOROOM    </span>; Silly user gave Xaddr of FFFF in segment
<span style="color:black">DOSCODE:8177                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8178 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8178
DOSCODE:8178 </span><span style="color:gray">EOFERR</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8178                 </span><span style="color:navy">pop     es              </span>; ES:DI point to SFT
<span style="color:black">DOSCODE:8179                 </span><span style="color:navy">xor     cx, cx          </span>; No bytes read
<span style="color:black">DOSCODE:817B
DOSCODE:817B </span><span style="color:gray">NOROOM</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:817B                 </span><span style="color:navy">pop     bx              </span>; Kill return address
<span style="color:black">DOSCODE:817C                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:817D                 </span><span style="color:navy">retn                    </span>; RETURN TO CALLER OF CALLER
<span style="color:black">DOSCODE:817D </span>SETUP           <span style="color:black">endp
DOSCODE:817D
DOSCODE:817E
DOSCODE:817E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:817E
DOSCODE:817E
DOSCODE:817E </span>BREAKDOWN       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:817E                 </span><span style="color:navy">mov     ax, ds:</span>BYTSECPOS
<span style="color:black">DOSCODE:8181                 </span><span style="color:navy">mov     bx, cx
</span><span style="color:black">DOSCODE:8183                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:8185                 </span><span style="color:navy">jz      short </span><span style="color:gray">SAVFIR    </span>; Partial first sector?
<span style="color:black">DOSCODE:8187                 </span><span style="color:navy">sub     ax, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [ES:BP+DPB.SECTOR_SIZE]
<span style="color:black">DOSCODE:818B                 </span><span style="color:navy">neg     ax              </span>; Max number of bytes left in first sector
<span style="color:black">DOSCODE:818D                 </span><span style="color:navy">sub     bx, ax          </span>; Subtract from total length
<span style="color:black">DOSCODE:818F                 </span><span style="color:navy">jnb     short </span><span style="color:gray">SAVFIR
</span><span style="color:black">DOSCODE:8191                 </span><span style="color:navy">add     ax, bx          </span>; Don&#039;t use all of the rest of the sector
<span style="color:black">DOSCODE:8193                 </span><span style="color:navy">xor     bx, bx          </span>; And no bytes are left
<span style="color:black">DOSCODE:8195
DOSCODE:8195 </span><span style="color:gray">SAVFIR</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8195                 </span><span style="color:navy">mov     ds:</span>BYTCNT1<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8198                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:black">DOSCODE:819A                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:819C                 </span><span style="color:navy">div     word ptr es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">] </span>; [ES:BP+DPB.SECTOR_SIZE]
<span style="color:black">DOSCODE:819C                                         </span>; How many whole sectors?
<span style="color:black">DOSCODE:81A0                 </span><span style="color:navy">mov     ds:</span>SECCNT<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:81A3                 </span><span style="color:navy">mov     ds:</span>BYTCNT2<span style="color:navy">, dx  </span>; Bytes remaining for last sector
<span style="color:black">DOSCODE:81A7
DOSCODE:81A7 </span>_RET45<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:81A7                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:81A7 </span>BREAKDOWN       <span style="color:black">endp
DOSCODE:81A7
DOSCODE:81A8
DOSCODE:81A8 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:81A8
DOSCODE:81A8
DOSCODE:81A8 </span>READ_LOCK_VIOLATION <span style="color:black">proc near           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:81A8                 </span><span style="color:navy">mov     ds:</span>READOP<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:81AD
DOSCODE:81AD </span>ERR_ON_CHECK<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:81AD                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:DI+SF_ENTRY.sf_mode+1],
<span style="color:black">DOSCODE:81AD                                         </span>; (sf_isFCB&gt;&gt;8)
<span style="color:black">DOSCODE:81B2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">HARD_ERR
</span><span style="color:black">DOSCODE:81B4                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:81B5                 </span><span style="color:navy">mov     cl, es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_mode]
<span style="color:black">DOSCODE:81B9                 </span><span style="color:navy">and     cl, </span><span style="color:green">0F0h        </span>; SHARING_MASK
<span style="color:black">DOSCODE:81BC                 </span><span style="color:navy">cmp     cl, </span><span style="color:#ff8000">0           </span>; SHARING_COMPAT
<span style="color:black">DOSCODE:81BF                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:81C0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NO_HARD_ERR
</span><span style="color:black">DOSCODE:81C2
DOSCODE:81C2 </span><span style="color:gray">HARD_ERR</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:81C2                 </span><span style="color:navy">call    </span>LOCK_VIOLATION
<span style="color:black">DOSCODE:81C5                 </span><span style="color:navy">jnb     short </span>_RET45
<span style="color:black">DOSCODE:81C7
DOSCODE:81C7 </span><span style="color:gray">NO_HARD_ERR</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:81C7                 </span><span style="color:navy">xor     cx, cx          </span>; No bytes transferred
<span style="color:black">DOSCODE:81C9                 </span><span style="color:navy">mov     ax, </span><span style="color:green">21h         </span>; error_lock_violation
<span style="color:black">DOSCODE:81CC                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:81CD
DOSCODE:81CD </span>RET3<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:81CD                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:81CD </span>READ_LOCK_VIOLATION <span style="color:black">endp
DOSCODE:81CD
DOSCODE:81CE
DOSCODE:81CE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:81CE
DOSCODE:81CE
DOSCODE:81CE </span>WRITE_LOCK_VIOLATION <span style="color:black">proc near          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:81CE                 </span><span style="color:navy">mov     ds:</span>READOP<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:81D3                 </span><span style="color:navy">jmp     short </span>ERR_ON_CHECK
<span style="color:black">DOSCODE:81D3 </span>WRITE_LOCK_VIOLATION <span style="color:black">endp
DOSCODE:81D3
DOSCODE:81D5
DOSCODE:81D5 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:81D5
DOSCODE:81D5
DOSCODE:81D5 </span>DISKREAD        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:81D5
DOSCODE:81D5 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:821D SIZE 00000006 BYTES
</span><span style="color:black">DOSCODE:81D5 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:822C SIZE 0000008E BYTES
</span><span style="color:black">DOSCODE:81D5 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:82BD SIZE 0000001A BYTES
</span><span style="color:black">DOSCODE:81D5
DOSCODE:81D5                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">11h</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_size]
<span style="color:black">DOSCODE:81D9                 </span><span style="color:navy">mov     bx, es:[di+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_size+2]
<span style="color:black">DOSCODE:81DD                 </span><span style="color:navy">sub     ax, word ptr ds:</span>BYTPOS
<span style="color:black">DOSCODE:81E1                 </span><span style="color:navy">sbb     bx, word ptr ds:</span>BYTPOS<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:81E5                 </span><span style="color:navy">jb      short </span><span style="color:gray">RDERR     </span>; Read starts past EOF
<span style="color:black">DOSCODE:81E7                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ENUF      </span>; More than 64k to EOF
<span style="color:black">DOSCODE:81E9                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:81EB                 </span><span style="color:navy">jz      short </span><span style="color:gray">RDERR     </span>; Read starts at EOF
<span style="color:black">DOSCODE:81ED                 </span><span style="color:navy">cmp     ax, cx
</span><span style="color:black">DOSCODE:81EF                 </span><span style="color:navy">jnb     short </span><span style="color:gray">ENUF      </span>; I/O fits
<span style="color:black">DOSCODE:81F1                 </span><span style="color:navy">mov     cx, ax          </span>; Limit read to up til EOF
<span style="color:black">DOSCODE:81F3
DOSCODE:81F3 </span><span style="color:gray">ENUF</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:81F3                 </span><span style="color:navy">call    </span>CHECK_READ_LOCK
<span style="color:black">DOSCODE:81F6                 </span><span style="color:navy">jb      short </span>RET3
<span style="color:black">DOSCODE:81F8
DOSCODE:81F8 </span>_READ_OK<span style="color:navy">:                               </span>; There are no locks
<span style="color:black">DOSCODE:81F8                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:81FC                 </span><span style="color:navy">call    </span>BREAKDOWN
<span style="color:black">DOSCODE:81FF                 </span><span style="color:navy">mov     cx, ds:</span>CLUSNUM
<span style="color:black">DOSCODE:8203                 </span><span style="color:navy">mov     dx, ds:</span>CLUSNUM_HW
<span style="color:black">DOSCODE:8207                 </span><span style="color:navy">call    </span>FNDCLUS
<span style="color:black">DOSCODE:820A                 </span><span style="color:navy">jb      short </span>SET_ACC_ERR_DS ; ds=ss
<span style="color:black">DOSCODE:820C                 </span><span style="color:navy">cmp     ds:</span>CLSKIP_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8211                 </span><span style="color:navy">jnz     short </span><span style="color:gray">RDERR
</span><span style="color:black">DOSCODE:8213                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">SKIPERR
</span><span style="color:black">DOSCODE:8215
DOSCODE:8215 </span><span style="color:gray">RDERR</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8215                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0Eh         </span>; read/data/fail
<span style="color:black">DOSCODE:8217                 </span><span style="color:navy">jmp     </span>WRTERR22
<span style="color:black">DOSCODE:8217 </span>DISKREAD        <span style="color:black">endp
DOSCODE:8217
DOSCODE:821A
DOSCODE:821A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:821A
DOSCODE:821A </span><span style="color:gray">; Attributes: thunk
</span><span style="color:black">DOSCODE:821A
DOSCODE:821A </span>SETSFTJ2        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:821A                 </span><span style="color:navy">jmp     </span>SETSFT
<span style="color:black">DOSCODE:821A </span>SETSFTJ2        <span style="color:black">endp
DOSCODE:821A
DOSCODE:821D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:821D </span><span style="color:gray">; START OF FUNCTION CHUNK FOR DISKREAD
</span><span style="color:black">DOSCODE:821D
DOSCODE:821D </span><span style="color:gray">CANOT_READ</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:821D                 </span><span style="color:navy">pop     cx              </span>; Clean stack
<span style="color:black">DOSCODE:821E                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:821F                 </span><span style="color:navy">pop     ds:</span>CCONTENT_HW  ; PCDOS 7.1 BUG!?
<span style="color:black">DOSCODE:821F </span><span style="color:gray">; END OF FUNCTION CHUNK FOR DISKREAD    </span>; I think, this would be &#039;pop ss:CCONTENT_HW&#039;
<span style="color:black">DOSCODE:821F                                         </span>; because ds&lt;&gt;ss while jumping here.
<span style="color:black">DOSCODE:821F                                         </span>; Erdogan Tan - 09/02/2024
<span style="color:black">DOSCODE:8223
DOSCODE:8223 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8223
DOSCODE:8223
DOSCODE:8223 </span>SET_ACC_ERR_DS  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8223                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:8224                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:8224 </span>SET_ACC_ERR_DS  <span style="color:black">endp
DOSCODE:8224
DOSCODE:8225
DOSCODE:8225 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8225
DOSCODE:8225
DOSCODE:8225 </span>SET_ACC_ERR     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8225                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:8227                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5           </span>; error_access_denied
<span style="color:black">DOSCODE:822A                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:822B                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:822B </span>SET_ACC_ERR     <span style="color:black">endp
DOSCODE:822B
DOSCODE:822C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:822C </span><span style="color:gray">; START OF FUNCTION CHUNK FOR DISKREAD
</span><span style="color:black">DOSCODE:822C
DOSCODE:822C </span><span style="color:gray">SKIPERR</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:822C                 </span><span style="color:navy">mov     ds:</span>LASTPOS<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:8230                 </span><span style="color:navy">mov     ds:</span>CLUSNUM<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:8234                 </span><span style="color:navy">mov     bx, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:8238                 </span><span style="color:navy">mov     ds:</span>CLUSNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:823C                 </span><span style="color:navy">cmp     ds:</span>BYTCNT1<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8241                 </span><span style="color:navy">jz      short </span><span style="color:gray">RDMID
</span><span style="color:black">DOSCODE:8243                 </span><span style="color:navy">call    </span>BUFRD
<span style="color:black">DOSCODE:8246                 </span><span style="color:navy">jb      short </span>SET_ACC_ERR_DS ; ds=ss
<span style="color:black">DOSCODE:8248
DOSCODE:8248 </span><span style="color:gray">RDMID</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8248                 </span><span style="color:navy">cmp     ds:</span>SECCNT<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:824D                 </span><span style="color:navy">jz      short </span><span style="color:gray">RDLAST
</span><span style="color:black">DOSCODE:824F                 </span><span style="color:navy">call    </span>NEXTSEC
<span style="color:black">DOSCODE:8252                 </span><span style="color:navy">jb      short </span>SETSFTJ2
<span style="color:black">DOSCODE:8254                 </span><span style="color:navy">mov     ds:</span>TRANS<span style="color:navy">, </span><span style="color:#ff8000">1     </span>; A transfer is taking place
<span style="color:black">DOSCODE:8259                 </span><span style="color:navy">mov     dl, ds:</span>SECCLUSPOS ;
<span style="color:black">DOSCODE:8259                                         </span>; (dx/DL = Extent start) ((dh = ?))
<span style="color:black">DOSCODE:825D                 </span><span style="color:navy">mov     cx, ds:</span>SECCNT
<span style="color:black">DOSCODE:8261                 </span><span style="color:navy">mov     bx, ds:</span>CLUSNUM_HW
<span style="color:black">DOSCODE:8265                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:8269                 </span><span style="color:navy">mov     bx, ds:</span>CLUSNUM
<span style="color:black">DOSCODE:826D
DOSCODE:826D </span><span style="color:gray">RDLP</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:826D                 </span><span style="color:navy">call    </span>OPTIMIZE
<span style="color:black">DOSCODE:8270                 </span><span style="color:navy">jb      short </span>SET_ACC_ERR_DS ; ds=ss
<span style="color:black">DOSCODE:8272                 </span><span style="color:navy">push    ds:</span>CCONTENT_HW  ; (Next physical cluster, hw)
<span style="color:black">DOSCODE:8276                 </span><span style="color:navy">push    di              </span>; DI = Next physical cluster.
<span style="color:black">DOSCODE:8277                 </span><span style="color:navy">push    ax              </span>; AX = # of sectors remaining.
<span style="color:black">DOSCODE:8278                 </span><span style="color:navy">push    bx              </span>; [DMAADD+2]:BX = Transfer address.
<span style="color:black">DOSCODE:8279                 </span><span style="color:navy">mov     ds:</span>ALLOWED<span style="color:navy">, </span><span style="color:green">38h </span>; Allowed_RETRY+Allowed_FAIL+Allowed_IGNORE
<span style="color:black">DOSCODE:827E                 </span><span style="color:navy">mov     ds, word ptr ds:</span>DMAADD<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:8282                 </span><span style="color:navy">push    dx              </span>; [HIGH_SECTOR]:DX = phys. sector #.
<span style="color:black">DOSCODE:8283                 </span><span style="color:navy">push    cx              </span>; CX = # of contiguous sectors to read.
<span style="color:black">DOSCODE:8284                 </span><span style="color:navy">call    </span>null_sub
<span style="color:black">DOSCODE:8287                 </span><span style="color:navy">call    </span>DREAD
<span style="color:black">DOSCODE:828A                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:828B                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:828C                 </span><span style="color:navy">pop     ss:</span>TEMP_VAR
<span style="color:black">DOSCODE:8291                 </span><span style="color:navy">jb      short </span><span style="color:gray">CANOT_READ </span>; ds&lt;&gt;ss
<span style="color:black">DOSCODE:8293                 </span><span style="color:navy">mov     ss:</span>TEMP_VAR2<span style="color:navy">, ds
</span><span style="color:black">DOSCODE:8298                 </span><span style="color:navy">call    </span>DskRdBufScan
<span style="color:black">DOSCODE:829B                 </span><span style="color:navy">mov     cx, ss
</span><span style="color:black">DOSCODE:829D                 </span><span style="color:navy">mov     ds, cx
</span><span style="color:black">DOSCODE:829F                 </span><span style="color:navy">pop     cx              </span>; # of sectors remaining.
<span style="color:black">DOSCODE:82A0                 </span><span style="color:navy">pop     bx              </span>; Next physical cluster.
<span style="color:black">DOSCODE:82A1                 </span><span style="color:navy">pop     ds:</span>CLUSTNUM_HW  ; (Next physical cluster, hw)
<span style="color:black">DOSCODE:82A5                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">RDLAST
</span><span style="color:black">DOSCODE:82A7                 </span><span style="color:navy">call    </span>IsEOF           ; test for eof on fat size
<span style="color:black">DOSCODE:82AA                 </span><span style="color:navy">jnb     short </span>SETSFT
<span style="color:black">DOSCODE:82AC                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:82AE                 </span><span style="color:navy">add     ds:</span>LASTPOS<span style="color:navy">, </span><span style="color:#ff8000">1   </span>; We&#039;ll be using next cluster
<span style="color:black">DOSCODE:82B3                 </span><span style="color:navy">adc     ds:</span>LASTPOS_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:82B8                 </span><span style="color:navy">jmp     short </span><span style="color:gray">RDLP
</span><span style="color:black">DOSCODE:82B8 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR DISKREAD
</span><span style="color:black">DOSCODE:82BA
DOSCODE:82BA </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:82BA
DOSCODE:82BA </span><span style="color:gray">; Attributes: thunk
</span><span style="color:black">DOSCODE:82BA
DOSCODE:82BA </span>j_SET_ACC_ERR_DS <span style="color:black">proc near              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:82BA                 </span><span style="color:navy">jmp     </span>SET_ACC_ERR_DS
<span style="color:black">DOSCODE:82BA </span>j_SET_ACC_ERR_DS <span style="color:black">endp
DOSCODE:82BA
DOSCODE:82BD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:82BD </span><span style="color:gray">; START OF FUNCTION CHUNK FOR DISKREAD
</span><span style="color:black">DOSCODE:82BD
DOSCODE:82BD </span><span style="color:gray">RDLAST</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:82BD                 </span><span style="color:navy">mov     ax, ds:</span>BYTCNT2
<span style="color:black">DOSCODE:82C0                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:82C2                 </span><span style="color:navy">jz      short </span>SETSFT
<span style="color:black">DOSCODE:82C4                 </span><span style="color:navy">mov     ds:</span>BYTCNT1<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:82C7                 </span><span style="color:navy">call    </span>NEXTSEC
<span style="color:black">DOSCODE:82CA                 </span><span style="color:navy">jb      short </span>SETSFT
<span style="color:black">DOSCODE:82CC                 </span><span style="color:navy">mov     ds:</span>BYTSECPOS<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:82D2                 </span><span style="color:navy">call    </span>BUFRD
<span style="color:black">DOSCODE:82D5                 </span><span style="color:navy">jb      short </span>j_SET_ACC_ERR_DS ; ds=ss
<span style="color:black">DOSCODE:82D5 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR DISKREAD
</span><span style="color:black">DOSCODE:82D7
DOSCODE:82D7 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:82D7
DOSCODE:82D7
DOSCODE:82D7 </span>SETSFT          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:82D7                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:black">DOSCODE:82DB
DOSCODE:82DB </span>SETCLUS<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:82DB                 </span><span style="color:navy">mov     cx, ds:</span>NEXTADD
<span style="color:black">DOSCODE:82DF                 </span><span style="color:navy">sub     cx, word ptr ds:</span>DMAADD ; Number of bytes transfered
<span style="color:black">DOSCODE:82E3                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:DI+SF_ENTRY.sf_flags],
<span style="color:black">DOSCODE:82E3                                         </span>; devid_device
<span style="color:black">DOSCODE:82E8                 </span><span style="color:navy">jnz     short </span>ADDREC    ; don&#039;t set clusters if device
<span style="color:black">DOSCODE:82EA                 </span><span style="color:navy">mov     ax, ds:</span>CLUSNUM_HW
<span style="color:black">DOSCODE:82ED                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">37h</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_lstclus+2]
<span style="color:black">DOSCODE:82F1                 </span><span style="color:navy">mov     ax, ds:</span>LASTPOS_HW
<span style="color:black">DOSCODE:82F4                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_cluspos_hw] ; PCDOS 7.1 &amp; Win ME
<span style="color:black">DOSCODE:82F4                                         </span>; [ES:DI+SF_ENTRY.sf_firclus] ; MSDOS 5.0-6.22
<span style="color:black">DOSCODE:82F8                 </span><span style="color:navy">mov     ax, ds:</span>CLUSNUM
<span style="color:black">DOSCODE:82FB                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">35h</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_lstclus]
<span style="color:black">DOSCODE:82FF                 </span><span style="color:navy">mov     ax, ds:</span>LASTPOS
<span style="color:black">DOSCODE:8302                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">19h</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_cluspos]
<span style="color:black">DOSCODE:8302 </span>SETSFT          <span style="color:black">endp
DOSCODE:8302
DOSCODE:8306
DOSCODE:8306 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8306
DOSCODE:8306
DOSCODE:8306 </span>ADDREC          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8306                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">RET28
</span><span style="color:black">DOSCODE:8308                 </span><span style="color:navy">add     es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">], cx </span>; [ES:DI+SF_ENTRY.sf_position]
<span style="color:black">DOSCODE:8308                                         </span>; Update current position
<span style="color:black">DOSCODE:830C                 </span><span style="color:navy">adc     word ptr es:[di+</span><span style="color:#ff8000">17h</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [ES:DI+SF_ENTRY.sf_position+2]
<span style="color:black">DOSCODE:8311
DOSCODE:8311 </span><span style="color:gray">RET28</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8311                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:8312                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8312 </span>ADDREC          <span style="color:black">endp
DOSCODE:8312
DOSCODE:8313
DOSCODE:8313 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8313
DOSCODE:8313
DOSCODE:8313 </span>DskRdBufScan    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8313                 </span><span style="color:navy">cmp     ss:</span>DirtyBufferCount<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; Any dirty buffers?
<span style="color:black">DOSCODE:8319                 </span><span style="color:navy">jz      short </span><span style="color:gray">bufx      </span>; -no, skip all work.
<span style="color:black">DOSCODE:831B                 </span><span style="color:navy">mov     bx, ss:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:8320                 </span><span style="color:navy">add     cx, dx
</span><span style="color:black">DOSCODE:8322                 </span><span style="color:navy">mov     si, bx
</span><span style="color:black">DOSCODE:8324                 </span><span style="color:navy">adc     si, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8327                 </span><span style="color:navy">call    </span>GETCURHEAD      ; DS:DI -&gt; 1st buf in queue.
<span style="color:black">DOSCODE:832A                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">2</span><span style="color:navy">]      </span>; [di+BUFFINFO.buf_prev]
<span style="color:black">DOSCODE:832D                 </span><span style="color:navy">mov     ss:</span>FIRST_BUFF_ADDR<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8331                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; [es:bp+DPB.DRIVE]
<span style="color:black">DOSCODE:8335
DOSCODE:8335 </span><span style="color:gray">bufq</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8335                 </span><span style="color:navy">cmp     al, [di+</span><span style="color:#ff8000">4</span><span style="color:navy">]      </span>; [di+BUFFINFO.buf_ID] ; Same drive?
<span style="color:black">DOSCODE:8338                 </span><span style="color:navy">jnz     short </span><span style="color:gray">bufq1     </span>; no
<span style="color:black">DOSCODE:833A                 </span><span style="color:navy">cmp     bx, [di+</span><span style="color:#ff8000">8</span><span style="color:navy">]      </span>; [di+BUFFINFO.buf_sector+2]
<span style="color:black">DOSCODE:833D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">bufq01
</span><span style="color:black">DOSCODE:833F                 </span><span style="color:navy">cmp     dx, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [di+BUFFINFO.buf_sector]
<span style="color:black">DOSCODE:8342
DOSCODE:8342 </span><span style="color:gray">bufq01</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8342                 </span><span style="color:navy">ja      short </span><span style="color:gray">bufq1
</span><span style="color:black">DOSCODE:8344                 </span><span style="color:navy">cmp     si, [di+</span><span style="color:#ff8000">8</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:8347                 </span><span style="color:navy">jnz     short </span><span style="color:gray">bufq02
</span><span style="color:black">DOSCODE:8349                 </span><span style="color:navy">cmp     cx, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:834C
DOSCODE:834C </span><span style="color:gray">bufq02</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:834C                 </span><span style="color:navy">ja      short </span><span style="color:gray">bufq2
</span><span style="color:black">DOSCODE:834E
DOSCODE:834E </span><span style="color:gray">bufq1</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:834E                 </span><span style="color:navy">cmp     di, ss:</span>FIRST_BUFF_ADDR ; Scanned entire buffer queue?
<span style="color:black">DOSCODE:8353                 </span><span style="color:navy">mov     di, [di]        </span>; [di+BUFFINFO.buf_next]
<span style="color:black">DOSCODE:8355                 </span><span style="color:navy">jnz     short </span><span style="color:gray">bufq      </span>; -no, do next buffer
<span style="color:black">DOSCODE:8357
DOSCODE:8357 </span><span style="color:gray">bufx</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8357                 </span><span style="color:navy">retn                    </span>; Exit.
<span style="color:black">DOSCODE:8358 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8358
DOSCODE:8358 </span><span style="color:gray">bufq2</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8358                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:8359                 </span><span style="color:navy">test    byte ptr [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [di+BUFFINFO.buf_flags],buf_dirty
<span style="color:black">DOSCODE:835D                 </span><span style="color:navy">jz      short </span><span style="color:gray">bufq3
</span><span style="color:black">DOSCODE:835F                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:8360                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:8361                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:8362                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:8363                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:8364                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:black">DOSCODE:8366                 </span><span style="color:navy">sub     ax, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [di+BUFFINFO.buf_sector]
<span style="color:black">DOSCODE:8369                 </span><span style="color:navy">neg     ax
</span><span style="color:black">DOSCODE:836B                 </span><span style="color:navy">mov     cx, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [es:bp+DPB.SECTOR_SIZE]
<span style="color:black">DOSCODE:836F                 </span><span style="color:navy">lea     si, [di+</span><span style="color:#ff8000">18h</span><span style="color:navy">]    </span>; [di+BUFINSIZ]
<span style="color:black">DOSCODE:8372                 </span><span style="color:navy">mul     cx
</span><span style="color:black">DOSCODE:8374                 </span><span style="color:navy">les     di, dword ptr ss:</span>TEMP_VAR
<span style="color:black">DOSCODE:8379                 </span><span style="color:navy">add     di, ax
</span><span style="color:black">DOSCODE:837B                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:837D                 </span><span style="color:navy">cmp     ss:</span>DDMOVE<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8383                 </span><span style="color:navy">jz      short near ptr </span><span style="color:gray">bufq03</span><span style="color:navy">+</span><span style="color:green">1 </span>; rep movsw
<span style="color:black">DOSCODE:8383                                         </span>; (skip 32 bit prefix)
<span style="color:black">DOSCODE:8385                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:8387
DOSCODE:8387 </span><span style="color:gray">bufq03</span><span style="color:navy">:                                 </span><span style="color:red">; ...
</span><span style="color:black">DOSCODE:8387                 </span><span style="color:navy">rep movsd
</span><span style="color:black">DOSCODE:838A                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:838B                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:838C                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:838D                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:838E                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:838F
DOSCODE:838F </span><span style="color:gray">bufq3</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:838F                 </span><span style="color:navy">mov     ax, di
</span><span style="color:black">DOSCODE:8391                 </span><span style="color:navy">call    </span>SCANPLACE
<span style="color:black">DOSCODE:8394                 </span><span style="color:navy">cmp     ax, ss:</span>FIRST_BUFF_ADDR
<span style="color:black">DOSCODE:8399                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:839A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">bufq
</span><span style="color:black">DOSCODE:839C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:839C </span>DskRdBufScan    <span style="color:black">endp
DOSCODE:839C
DOSCODE:839D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:839D </span><span style="color:gray">; START OF FUNCTION CHUNK FOR DISKWRITE
</span><span style="color:black">DOSCODE:839D
DOSCODE:839D </span><span style="color:gray">WRTEOFJ</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:839D                 </span><span style="color:navy">jmp     </span><span style="color:gray">WRTEOF
</span><span style="color:black">DOSCODE:839D </span><span style="color:gray">; END OF FUNCTION CHUNK FOR DISKWRITE
</span><span style="color:black">DOSCODE:83A0
DOSCODE:83A0 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:83A0
DOSCODE:83A0
DOSCODE:83A0 </span>dskwrt_retj     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:83A0                 </span><span style="color:navy">jmp     </span>dskwrt_retn
<span style="color:black">DOSCODE:83A0 </span>dskwrt_retj     <span style="color:black">endp
DOSCODE:83A0
DOSCODE:83A3
DOSCODE:83A3 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:83A3
DOSCODE:83A3
DOSCODE:83A3 </span>DISKWRITE       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:83A3
DOSCODE:83A3 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:839D SIZE 00000003 BYTES
</span><span style="color:black">DOSCODE:83A3
DOSCODE:83A3                 </span><span style="color:navy">call    </span>CHECK_WRITE_LOCK
<span style="color:black">DOSCODE:83A6                 </span><span style="color:navy">jb      short </span>dskwrt_retj
<span style="color:black">DOSCODE:83A8                 </span><span style="color:navy">and     word ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">0BFBFh </span>; [ES:DI+SF_ENTRY.sf_flags],
<span style="color:black">DOSCODE:83A8                                         </span>; ~(sf_close_nodate|devid_file_clean)
<span style="color:black">DOSCODE:83AE                 </span><span style="color:navy">les     ax, es:[di+</span><span style="color:#ff8000">11h</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_size]
<span style="color:black">DOSCODE:83B2                 </span><span style="color:navy">mov     ds:</span>TEMP_VAR2<span style="color:navy">, es
</span><span style="color:black">DOSCODE:83B6                 </span><span style="color:navy">mov     ds:</span>TEMP_VAR<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:83B9                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:83BD                 </span><span style="color:navy">call    </span>BREAKDOWN
<span style="color:black">DOSCODE:83C0                 </span><span style="color:navy">mov     ax, word ptr ds:</span>BYTPOS
<span style="color:black">DOSCODE:83C3                 </span><span style="color:navy">mov     dx, word ptr ds:</span>BYTPOS<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:83C7                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">WRTEOFJ   </span>; Make the file length = sf_position
<span style="color:black">DOSCODE:83C9                 </span><span style="color:navy">add     ax, cx
</span><span style="color:black">DOSCODE:83CB                 </span><span style="color:navy">adc     dx, </span><span style="color:#ff8000">0           </span>; DX:AX = last byte to write + 1.
<span style="color:black">DOSCODE:83CE                 </span><span style="color:navy">jnb     short </span><span style="color:gray">dskwrt_1
</span><span style="color:black">DOSCODE:83D0
DOSCODE:83D0 </span><span style="color:gray">ACC_ERRWJ2</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:83D0                 </span><span style="color:navy">jmp     </span><span style="color:gray">SET_ACC_ERRW
</span><span style="color:black">DOSCODE:83D3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:83D3
DOSCODE:83D3 </span><span style="color:gray">dskwrt_1</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:83D3                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3</span><span style="color:navy">], </span><span style="color:green">10h </span>; [es:di+SF_ENTRY.sf_mode+1],10h
<span style="color:black">DOSCODE:83D8                 </span><span style="color:navy">jnz     short </span><span style="color:gray">dskwrt_3  </span>; &gt; 2GB file size (up to 4GB) allowed
<span style="color:black">DOSCODE:83DA                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">7FFFh       </span>; check for 2GB file size limit
<span style="color:black">DOSCODE:83DE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">dskwrt_2
</span><span style="color:black">DOSCODE:83E0                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:83E3
DOSCODE:83E3 </span><span style="color:gray">dskwrt_2</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:83E3                 </span><span style="color:navy">ja      short </span><span style="color:gray">ACC_ERRWJ2 </span>; error,
<span style="color:black">DOSCODE:83E3                                         </span>; file position/pointer overs 2GB limit!
<span style="color:black">DOSCODE:83E5
DOSCODE:83E5 </span><span style="color:gray">dskwrt_3</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:83E5                 </span><span style="color:navy">mov     bx, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [ES:BP+DPB.SECTOR_SIZE]
<span style="color:black">DOSCODE:83E9                 </span><span style="color:navy">call    </span>DIV32           ; DX:AX/BX = CX:AX + DX (rem.).
<span style="color:black">DOSCODE:83EC                 </span><span style="color:navy">mov     si, ax
</span><span style="color:black">DOSCODE:83EE                 </span><span style="color:navy">mov     ds:</span>HIGH_SECTOR<span style="color:navy">, cx
</span><span style="color:black">DOSCODE:83F2                 </span><span style="color:navy">or      dx, dx
</span><span style="color:black">DOSCODE:83F4                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:83F5                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">DOSCODE:83F7                 </span><span style="color:navy">jnz     short </span><span style="color:gray">CALCLUS
</span><span style="color:black">DOSCODE:83F9                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">1           </span>; DX:AX must be zero base indexed
<span style="color:black">DOSCODE:83FC                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:83FF
DOSCODE:83FF </span><span style="color:gray">CALCLUS</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:83FF                 </span><span style="color:navy">call    </span>SHR32           ; 32 bit shift right (dx:ax)
<span style="color:black">DOSCODE:8402                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:8403                 </span><span style="color:navy">xchg    cx, dx
</span><span style="color:black">DOSCODE:8405                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:8406                 </span><span style="color:navy">push    ax              </span>; !*! cx:ax = Last cluster to write
<span style="color:black">DOSCODE:8407                 </span><span style="color:navy">push    dx              </span>; # of bytes in last sector to write
<span style="color:black">DOSCODE:8408                 </span><span style="color:navy">mov     dx, ds:</span>TEMP_VAR2
<span style="color:black">DOSCODE:840C                 </span><span style="color:navy">mov     ax, ds:</span>TEMP_VAR ; DX:AX = current file size (in bytes).
<span style="color:black">DOSCODE:840F                 </span><span style="color:navy">call    </span>DIV32
<span style="color:black">DOSCODE:8412                 </span><span style="color:navy">mov     ds:</span>TEMP_VAR2<span style="color:navy">, cx
</span><span style="color:black">DOSCODE:8416                 </span><span style="color:navy">mov     ds:</span>VALSEC<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, cx
</span><span style="color:black">DOSCODE:841A                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">DOSCODE:841C                 </span><span style="color:navy">mov     bx, si
</span><span style="color:black">DOSCODE:841E                 </span><span style="color:navy">or      dx, dx
</span><span style="color:black">DOSCODE:8420                 </span><span style="color:navy">jz      short </span><span style="color:gray">NORND
</span><span style="color:black">DOSCODE:8422                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">1           </span>; Round up if any remainder
<span style="color:black">DOSCODE:8425                 </span><span style="color:navy">adc     ds:</span>VALSEC<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:842A
DOSCODE:842A </span><span style="color:gray">NORND</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:842A                 </span><span style="color:navy">mov     ds:</span>VALSEC<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:842D                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:842F                 </span><span style="color:navy">mov     word ptr ds:</span>GROWCNT<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8432                 </span><span style="color:navy">mov     word ptr ds:</span>GROWCNT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8435                 </span><span style="color:navy">mov     di, ds:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:8439                 </span><span style="color:navy">pop     ax              </span>; # of bytes in last sector to write
<span style="color:black">DOSCODE:843A                 </span><span style="color:navy">cmp     di, ds:</span>TEMP_VAR2
<span style="color:black">DOSCODE:843E                 </span><span style="color:navy">jb      short </span><span style="color:gray">NOGROW
</span><span style="color:black">DOSCODE:8440                 </span><span style="color:navy">jz      short </span><span style="color:gray">lowsec
</span><span style="color:black">DOSCODE:8442                 </span><span style="color:navy">sub     bx, cx
</span><span style="color:black">DOSCODE:8444                 </span><span style="color:navy">sbb     di, ds:</span>TEMP_VAR2
<span style="color:black">DOSCODE:8448                 </span><span style="color:navy">jmp     short </span><span style="color:gray">yesgrow
</span><span style="color:black">DOSCODE:844A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:844A
DOSCODE:844A </span><span style="color:gray">lowsec</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:844A                 </span><span style="color:navy">xor     di, di
</span><span style="color:black">DOSCODE:844C                 </span><span style="color:navy">sub     bx, cx
</span><span style="color:black">DOSCODE:844E                 </span><span style="color:navy">jb      short </span><span style="color:gray">NOGROW
</span><span style="color:black">DOSCODE:8450                 </span><span style="color:navy">jz      short </span><span style="color:gray">TESTTAIL
</span><span style="color:black">DOSCODE:8452
DOSCODE:8452 </span><span style="color:gray">yesgrow</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8452                 </span><span style="color:navy">mov     cx, dx
</span><span style="color:black">DOSCODE:8454                 </span><span style="color:navy">xchg    ax, bx
</span><span style="color:black">DOSCODE:8455                 </span><span style="color:navy">mul     word ptr es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">] </span>; [ES:BP+DPB.SECTOR_SIZE]
<span style="color:black">DOSCODE:8455                                         </span>; Bytes of full sector growth
<span style="color:black">DOSCODE:8459                 </span><span style="color:navy">mov     ds:</span>HIGH_SECTOR<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:845D                 </span><span style="color:navy">mov     ds:</span>TEMP_VAR2<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8460                 </span><span style="color:navy">mov     ax, di
</span><span style="color:black">DOSCODE:8462                 </span><span style="color:navy">mul     word ptr es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">] </span>; [ES:BP+DPB.SECTOR_SIZE]
<span style="color:black">DOSCODE:8466                 </span><span style="color:navy">add     ax, ds:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:846A                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:black">DOSCODE:846B                 </span><span style="color:navy">mov     ax, ds:</span>TEMP_VAR2
<span style="color:black">DOSCODE:846E                 </span><span style="color:navy">sub     ax, cx          </span>; Take off current &quot;tail&quot;
<span style="color:black">DOSCODE:8470                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8473                 </span><span style="color:navy">add     ax, bx          </span>; Add on new &quot;tail&quot;
<span style="color:black">DOSCODE:8475                 </span><span style="color:navy">adc     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8478                 </span><span style="color:navy">jmp     short </span><span style="color:gray">SETGRW
</span><span style="color:black">DOSCODE:847A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:847A
DOSCODE:847A </span><span style="color:gray">HAVSTART</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:847A                 </span><span style="color:navy">mov     ds:</span>CLSKIP_HW<span style="color:navy">, si
</span><span style="color:black">DOSCODE:847E                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">DOSCODE:8480                 </span><span style="color:navy">call    </span>SKPCLP
<span style="color:black">DOSCODE:8483                 </span><span style="color:navy">mov     ax, ds:</span>CLSKIP_HW
<span style="color:black">DOSCODE:8486                 </span><span style="color:navy">cmp     ax, cx
</span><span style="color:black">DOSCODE:8488                 </span><span style="color:navy">jnz     short </span><span style="color:gray">HAVSTART_cont
</span><span style="color:black">DOSCODE:848A                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">DOWRTJ
</span><span style="color:black">DOSCODE:848C
DOSCODE:848C </span><span style="color:gray">HAVSTART_cont</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:848C                 </span><span style="color:navy">mov     ds:</span>CCOUNT_HW<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:848F                 </span><span style="color:navy">call    </span>ALLOCATE
<span style="color:black">DOSCODE:8492                 </span><span style="color:navy">jnb     short </span><span style="color:gray">DOWRTJ
</span><span style="color:black">DOSCODE:8494
DOSCODE:8494 </span><span style="color:gray">WRTERR</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8494                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0Fh         </span>; write/data/fail/abort
<span style="color:black">DOSCODE:8496
DOSCODE:8496 </span>WRTERR22<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8496                 </span><span style="color:navy">mov     al, ds:</span>THISDRV
<span style="color:black">DOSCODE:8499                 </span><span style="color:navy">xor     cx, cx          </span>; No bytes transferred
<span style="color:black">DOSCODE:849B                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:black">DOSCODE:849F                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:84A0
DOSCODE:84A0 </span>dskwrt_retn<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:84A0                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:84A1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:84A1
DOSCODE:84A1 </span><span style="color:gray">DOWRTJ</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:84A1                 </span><span style="color:navy">jmp     </span><span style="color:gray">DOWRT
</span><span style="color:black">DOSCODE:84A4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:84A4
DOSCODE:84A4 </span><span style="color:gray">TESTTAIL</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:84A4                 </span><span style="color:navy">sub     ax, dx
</span><span style="color:black">DOSCODE:84A6                 </span><span style="color:navy">jbe     short </span><span style="color:gray">NOGROW
</span><span style="color:black">DOSCODE:84A8                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:84AA
DOSCODE:84AA </span><span style="color:gray">SETGRW</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:84AA                 </span><span style="color:navy">mov     word ptr ds:</span>GROWCNT<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:84AD                 </span><span style="color:navy">mov     word ptr ds:</span>GROWCNT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, dx
</span><span style="color:black">DOSCODE:84B1
DOSCODE:84B1 </span><span style="color:gray">NOGROW</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:84B1                 </span><span style="color:navy">mov     cx, ds:</span>CLUSNUM  ; First cluster accessed
<span style="color:black">DOSCODE:84B5                 </span><span style="color:navy">mov     dx, ds:</span>CLUSNUM_HW
<span style="color:black">DOSCODE:84B9                 </span><span style="color:navy">call    </span>FNDCLUS
<span style="color:black">DOSCODE:84BC                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:84BD                 </span><span style="color:navy">pop     si              </span>; !*! si:ax = Last cluster
<span style="color:black">DOSCODE:84BE                 </span><span style="color:navy">jb      short </span><span style="color:gray">ACC_ERRWJ </span>; ds=ss
<span style="color:black">DOSCODE:84C0                 </span><span style="color:navy">mov     ds:</span>CLUSNUM<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:84C4                 </span><span style="color:navy">mov     ds:</span>LASTPOS<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:84C8                 </span><span style="color:navy">sub     ax, dx          </span>; Last cluster minus current cluster
<span style="color:black">DOSCODE:84CA                 </span><span style="color:navy">sbb     si, ds:</span>LASTPOS_HW
<span style="color:black">DOSCODE:84CE                 </span><span style="color:navy">mov     dx, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:84D2                 </span><span style="color:navy">mov     ds:</span>CLUSNUM_HW<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:84D6                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOGROW2
</span><span style="color:black">DOSCODE:84D8                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:84DA                 </span><span style="color:navy">jz      short </span><span style="color:gray">DOWRT
</span><span style="color:black">DOSCODE:84DC
DOSCODE:84DC </span><span style="color:gray">NOGROW2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:84DC                 </span><span style="color:navy">cmp     cx, ds:</span>CLSKIP_HW
<span style="color:black">DOSCODE:84E0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">dskwrt_4
</span><span style="color:black">DOSCODE:84E2                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">HAVSTART
</span><span style="color:black">DOSCODE:84E4
DOSCODE:84E4 </span><span style="color:gray">dskwrt_4</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:84E4                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:84E5                 </span><span style="color:navy">push    ds:</span>CLSKIP_HW
<span style="color:black">DOSCODE:84E9                 </span><span style="color:navy">mov     ds:</span>CCOUNT_HW<span style="color:navy">, si
</span><span style="color:black">DOSCODE:84ED                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">DOSCODE:84EF                 </span><span style="color:navy">call    </span>ALLOCATE
<span style="color:black">DOSCODE:84F2                 </span><span style="color:navy">pop     ds:</span>CLSKIP_HW
<span style="color:black">DOSCODE:84F6                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:84F7                 </span><span style="color:navy">jb      short </span><span style="color:gray">WRTERR
</span><span style="color:black">DOSCODE:84F9                 </span><span style="color:navy">mov     dx, ds:</span>LASTPOS
<span style="color:black">DOSCODE:84FD                 </span><span style="color:navy">add     dx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:8500                 </span><span style="color:navy">adc     ds:</span>LASTPOS_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8505                 </span><span style="color:navy">sub     cx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:8508                 </span><span style="color:navy">sbb     ds:</span>CLSKIP_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:850D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">dskwrt_5
</span><span style="color:black">DOSCODE:850F                 </span><span style="color:navy">or      cx, cx
</span><span style="color:black">DOSCODE:8511
DOSCODE:8511 </span><span style="color:gray">dskwrt_5</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8511                 </span><span style="color:navy">jz      short </span><span style="color:gray">NOSKIP
</span><span style="color:black">DOSCODE:8513                 </span><span style="color:navy">call    </span>SKPCLP
<span style="color:black">DOSCODE:8516                 </span><span style="color:navy">jnb     short </span><span style="color:gray">NOSKIP
</span><span style="color:black">DOSCODE:8518
DOSCODE:8518 </span><span style="color:gray">ACC_ERRWJ</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8518                 </span><span style="color:navy">jmp     </span><span style="color:gray">SET_ACC_ERRW
</span><span style="color:black">DOSCODE:851B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:851B
DOSCODE:851B </span><span style="color:gray">NOSKIP</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:851B                 </span><span style="color:navy">mov     ds:</span>CLUSNUM<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:851F                 </span><span style="color:navy">mov     ax, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:8522                 </span><span style="color:navy">mov     ds:</span>CLUSNUM_HW<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8525                 </span><span style="color:navy">mov     ds:</span>LASTPOS<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:8529
DOSCODE:8529 </span><span style="color:gray">DOWRT</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8529                 </span><span style="color:navy">cmp     ds:</span>BYTCNT1<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:852E                 </span><span style="color:navy">jz      short </span><span style="color:gray">WRTMID
</span><span style="color:black">DOSCODE:8530                 </span><span style="color:navy">mov     bx, ds:</span>CLUSNUM_HW
<span style="color:black">DOSCODE:8534                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:8538                 </span><span style="color:navy">mov     bx, ds:</span>CLUSNUM
<span style="color:black">DOSCODE:853C                 </span><span style="color:navy">call    </span>BUFWRT
<span style="color:black">DOSCODE:853F                 </span><span style="color:navy">jb      short </span><span style="color:gray">ACC_ERRWJ </span>; ds=ss
<span style="color:black">DOSCODE:8541
DOSCODE:8541 </span><span style="color:gray">WRTMID</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8541                 </span><span style="color:navy">mov     ax, ds:</span>SECCNT
<span style="color:black">DOSCODE:8544                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:8546                 </span><span style="color:navy">jnz     short </span><span style="color:gray">WRTMID2
</span><span style="color:black">DOSCODE:8548                 </span><span style="color:navy">jmp     </span><span style="color:gray">WRTLAST
</span><span style="color:black">DOSCODE:854B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:854B
DOSCODE:854B </span><span style="color:gray">WRTMID2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:854B                 </span><span style="color:navy">add     word ptr ds:</span>SECPOS<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:854F                 </span><span style="color:navy">adc     word ptr ds:</span>SECPOS<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8554                 </span><span style="color:navy">call    </span>NEXTSEC
<span style="color:black">DOSCODE:8557                 </span><span style="color:navy">jb      short </span><span style="color:gray">SET_ACC_ERRW </span>; ds=ss
<span style="color:black">DOSCODE:8559                 </span><span style="color:navy">mov     ds:</span>TRANS<span style="color:navy">, </span><span style="color:#ff8000">1     </span>; A transfer is taking place
<span style="color:black">DOSCODE:855E                 </span><span style="color:navy">mov     dl, ds:</span>SECCLUSPOS ; DL = Extent start
<span style="color:black">DOSCODE:8562                 </span><span style="color:navy">mov     bx, ds:</span>CLUSNUM_HW
<span style="color:black">DOSCODE:8566                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:856A                 </span><span style="color:navy">mov     bx, ds:</span>CLUSNUM
<span style="color:black">DOSCODE:856E                 </span><span style="color:navy">mov     cx, ds:</span>SECCNT
<span style="color:black">DOSCODE:8572
DOSCODE:8572 </span><span style="color:gray">WRTLP</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8572                 </span><span style="color:navy">call    </span>OPTIMIZE
<span style="color:black">DOSCODE:8575                 </span><span style="color:navy">jb      short </span><span style="color:gray">SET_ACC_ERRW </span>; ds=ss
<span style="color:black">DOSCODE:8577                 </span><span style="color:navy">push    ds:</span>CCONTENT_HW
<span style="color:black">DOSCODE:857B                 </span><span style="color:navy">push    di              </span>; CCONTENT_HW:DI = Next physical cluster
<span style="color:black">DOSCODE:857C                 </span><span style="color:navy">push    ax              </span>; AX = # sectors remaining
<span style="color:black">DOSCODE:857D                 </span><span style="color:navy">call    </span>DskWrtBufPurge  ; DS trashed.
<span style="color:black">DOSCODE:8580                 </span><span style="color:navy">mov     ds, word ptr ss:</span>DMAADD<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:8585                 </span><span style="color:navy">mov     ss:</span>ALLOWED<span style="color:navy">, </span><span style="color:green">38h </span>; Allowed_RETRY+Allowed_FAIL+Allowed_IGNORE
<span style="color:black">DOSCODE:858B
DOSCODE:858B </span><span style="color:gray">DWRITE_LUP</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:858B                 </span><span style="color:navy">call    </span>DSKWRITE
<span style="color:black">DOSCODE:858E                 </span><span style="color:navy">jz      short </span><span style="color:gray">DWRITE_OKAY </span>; ds&lt;&gt;ss
<span style="color:black">DOSCODE:8590                 </span><span style="color:navy">cmp     al, </span><span style="color:green">27h         </span>; error_handle_Disk_Full
<span style="color:black">DOSCODE:8592                 </span><span style="color:navy">jz      short </span><span style="color:gray">DWRITE_DISK_FULL
</span><span style="color:black">DOSCODE:8594                 </span><span style="color:navy">mov     ss:</span>READOP<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:859A                 </span><span style="color:navy">call    </span>HARDERRRW
<span style="color:black">DOSCODE:859D                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1           </span>; Check for retry
<span style="color:black">DOSCODE:859F                 </span><span style="color:navy">jz      short </span><span style="color:gray">DWRITE_LUP
</span><span style="color:black">DOSCODE:85A1                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3           </span>; Check for FAIL
<span style="color:black">DOSCODE:85A3                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:85A4                 </span><span style="color:navy">jnz     short </span><span style="color:gray">DWRITE_OKAY </span>; Ignore
<span style="color:black">DOSCODE:85A6                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:85A7
DOSCODE:85A7 </span><span style="color:gray">DWRITE_OKAY</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:85A7                 </span><span style="color:navy">pop     cx              </span>; CX = # sectors remaining
<span style="color:black">DOSCODE:85A8                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:85A9                 </span><span style="color:navy">pop     ss:</span>CLUSTNUM_HW  ; CLUSTNUM_HW:BX = Next physical cluster
<span style="color:black">DOSCODE:85AE                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:85AF                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:85B0                 </span><span style="color:navy">jb      short </span><span style="color:gray">SET_ACC_ERRW </span>; ds=ss
<span style="color:black">DOSCODE:85B2                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">WRTLAST
</span><span style="color:black">DOSCODE:85B4                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:85B6                 </span><span style="color:navy">add     ds:</span>LASTPOS<span style="color:navy">, </span><span style="color:#ff8000">1   </span>; We&#039;ll be using next cluster
<span style="color:black">DOSCODE:85BB                 </span><span style="color:navy">adc     ds:</span>LASTPOS_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:85C0                 </span><span style="color:navy">jmp     short </span><span style="color:gray">WRTLP
</span><span style="color:black">DOSCODE:85C2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:85C2
DOSCODE:85C2 </span><span style="color:gray">DWRITE_DISK_FULL</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:85C2                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:85C3                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:85C4                 </span><span style="color:navy">pop     cx              </span>; unjunk stack
<span style="color:black">DOSCODE:85C5                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:85C6                 </span><span style="color:navy">pop     ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:85CA                 </span><span style="color:navy">mov     ds:</span>DISK_FULL<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:85CF                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:85D0                 </span><span style="color:navy">jmp     </span><span style="color:gray">WRTERR          </span>; go to disk full exit
<span style="color:black">DOSCODE:85D3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:85D3
DOSCODE:85D3 </span><span style="color:gray">SET_ACC_ERRW</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:85D3                 </span><span style="color:navy">jmp     </span>SET_ACC_ERR_DS
<span style="color:black">DOSCODE:85D6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:85D6
DOSCODE:85D6 </span><span style="color:gray">WRTLAST</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:85D6                 </span><span style="color:navy">mov     ax, ds:</span>BYTCNT2
<span style="color:black">DOSCODE:85D9                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:85DB                 </span><span style="color:navy">jz      short </span><span style="color:gray">FINWRT
</span><span style="color:black">DOSCODE:85DD                 </span><span style="color:navy">mov     ds:</span>BYTCNT1<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:85E0                 </span><span style="color:navy">call    </span>NEXTSEC
<span style="color:black">DOSCODE:85E3                 </span><span style="color:navy">jb      short </span><span style="color:gray">SET_ACC_ERRW
</span><span style="color:black">DOSCODE:85E5                 </span><span style="color:navy">mov     ds:</span>BYTSECPOS<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:85EB                 </span><span style="color:navy">call    </span>BUFWRT
<span style="color:black">DOSCODE:85EE
DOSCODE:85EE </span><span style="color:gray">SET_ACC_ERRWJ</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:85EE                 </span><span style="color:navy">jb      short </span><span style="color:gray">SET_ACC_ERRW
</span><span style="color:black">DOSCODE:85F0
DOSCODE:85F0 </span><span style="color:gray">FINWRT</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:85F0                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:black">DOSCODE:85F4                 </span><span style="color:navy">mov     ax, word ptr ds:</span>GROWCNT
<span style="color:black">DOSCODE:85F7                 </span><span style="color:navy">mov     cx, word ptr ds:</span>GROWCNT<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:85FB                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:85FD                 </span><span style="color:navy">jnz     short </span><span style="color:gray">UPDATE_size
</span><span style="color:black">DOSCODE:85FF                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">SAMSIZ
</span><span style="color:black">DOSCODE:8601
DOSCODE:8601 </span><span style="color:gray">UPDATE_size</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8601                 </span><span style="color:navy">add     es:[di+</span><span style="color:#ff8000">11h</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_size]
<span style="color:black">DOSCODE:8605                 </span><span style="color:navy">adc     es:[di+</span><span style="color:#ff8000">13h</span><span style="color:navy">], cx </span>; [ES:DI+SF_ENTRY.sf_size+2]
<span style="color:black">DOSCODE:8609                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:860C                 </span><span style="color:navy">call    ds:</span>ShSU         ; call far [JShare+(14*4)] ; 14 = ShSU
<span style="color:black">DOSCODE:8610
DOSCODE:8610 </span><span style="color:gray">SAMSIZ</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8610                 </span><span style="color:navy">jmp     </span>SETCLUS         ; ES:DI already points to SFT
<span style="color:black">DOSCODE:8613 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8613
DOSCODE:8613 </span><span style="color:gray">WRTEOF</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8613                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">DOSCODE:8615                 </span><span style="color:navy">or      cx, dx
</span><span style="color:black">DOSCODE:8617                 </span><span style="color:navy">jnz     short </span><span style="color:gray">WRTEOF1
</span><span style="color:black">DOSCODE:8619                 </span><span style="color:navy">jmp     </span><span style="color:gray">KILLFIL
</span><span style="color:black">DOSCODE:861C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:861C
DOSCODE:861C </span><span style="color:gray">WRTEOF1</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:861C                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">7FFFh       </span>; 2GB file size limit
<span style="color:black">DOSCODE:8620                 </span><span style="color:navy">jnz     short </span><span style="color:gray">WRTEOF2
</span><span style="color:black">DOSCODE:8622                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:8625
DOSCODE:8625 </span><span style="color:gray">WRTEOF2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8625                 </span><span style="color:navy">jbe     short </span><span style="color:gray">WRTEOF3
</span><span style="color:black">DOSCODE:8627                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:8628                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:black">DOSCODE:862C                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3</span><span style="color:navy">], </span><span style="color:green">10h </span>; [es:di+SF_ENTRY.sf_mode+1],10h
<span style="color:black">DOSCODE:8631                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:8632                 </span><span style="color:navy">jz      short </span><span style="color:gray">SET_ACC_ERRW </span>; &gt; 2GB file size not allowed
<span style="color:black">DOSCODE:8634
DOSCODE:8634 </span><span style="color:gray">WRTEOF3</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8634                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:8637                 </span><span style="color:navy">sbb     dx, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:863A                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:863B                 </span><span style="color:navy">mov     bx, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [ES:BP+DPB.SECTOR_SIZE]
<span style="color:black">DOSCODE:863F                 </span><span style="color:navy">call    </span>DIV32
<span style="color:black">DOSCODE:8642                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:8643                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">DOSCODE:8645                 </span><span style="color:navy">mov     ds:</span>HIGH_SECTOR<span style="color:navy">, cx
</span><span style="color:black">DOSCODE:8649                 </span><span style="color:navy">call    </span>SHR32
<span style="color:black">DOSCODE:864C                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">DOSCODE:864E                 </span><span style="color:navy">call    </span>FNDCLUS
<span style="color:black">DOSCODE:8651
DOSCODE:8651 </span><span style="color:gray">SET_ACC_ERRWJ2</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8651                 </span><span style="color:navy">jb      short </span><span style="color:gray">SET_ACC_ERRWJ
</span><span style="color:black">DOSCODE:8653                 </span><span style="color:navy">mov     ax, ds:</span>CLSKIP_HW
<span style="color:black">DOSCODE:8656                 </span><span style="color:navy">cmp     ax, cx
</span><span style="color:black">DOSCODE:8658                 </span><span style="color:navy">jnz     short </span><span style="color:gray">dskwrt_6
</span><span style="color:black">DOSCODE:865A                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">RELFILE
</span><span style="color:black">DOSCODE:865C
DOSCODE:865C </span><span style="color:gray">dskwrt_6</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:865C                 </span><span style="color:navy">mov     ds:</span>CCOUNT_HW<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:865F                 </span><span style="color:navy">call    </span>ALLOCATE
<span style="color:black">DOSCODE:8662                 </span><span style="color:navy">jb      short </span><span style="color:gray">WRTERRJ   </span>; disk full
<span style="color:black">DOSCODE:8664
DOSCODE:8664 </span><span style="color:gray">UPDATE</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8664                 </span><span style="color:navy">mov     ax, word ptr ds:</span>BYTPOS
<span style="color:black">DOSCODE:8667                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:black">DOSCODE:866B                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">11h</span><span style="color:navy">], ax </span>; ES:DI+SF_ENTRY.sf_size]
<span style="color:black">DOSCODE:866F                 </span><span style="color:navy">mov     ax, word ptr ds:</span>BYTPOS<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:8672                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">13h</span><span style="color:navy">], ax </span>; ES:DI+SF_ENTRY.sf_size+2]
<span style="color:black">DOSCODE:8676                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:8679                 </span><span style="color:navy">call    ds:</span>ShSU         ; call far [JShare+(14*4)] ; 14 = ShSU
<span style="color:black">DOSCODE:867D                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:867F                 </span><span style="color:navy">jmp     </span>ADDREC
<span style="color:black">DOSCODE:8682 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8682
DOSCODE:8682 </span><span style="color:gray">WRTERRJ</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8682                 </span><span style="color:navy">jmp     </span><span style="color:gray">WRTERR
</span><span style="color:black">DOSCODE:8685 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8685
DOSCODE:8685 </span><span style="color:gray">RELFILE</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8685                 </span><span style="color:navy">push    es              </span>; Reset Lstclus and cluspos to
<span style="color:black">DOSCODE:8686                 </span><span style="color:navy">les     di, ds:</span>THISSFT  ; beginning of file if current
<span style="color:black">DOSCODE:868A                 </span><span style="color:navy">push    ax              </span>; cluspos is past EOF.
<span style="color:black">DOSCODE:868B                 </span><span style="color:navy">mov     ax, ds:</span>LASTPOS_HW
<span style="color:black">DOSCODE:868E                 </span><span style="color:navy">cmp     ax, es:[di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_firclus]
<span style="color:black">DOSCODE:868E                                         </span>; [ES:DI+SF_ENTRY.sf_cluspos_hw] !?
<span style="color:black">DOSCODE:8692                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:8693                 </span><span style="color:navy">jnz     short </span><span style="color:gray">dskwrt_7
</span><span style="color:black">DOSCODE:8695                 </span><span style="color:navy">cmp     dx, es:[di+</span><span style="color:#ff8000">19h</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_cluspos]
<span style="color:black">DOSCODE:8699
DOSCODE:8699 </span><span style="color:gray">dskwrt_7</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8699                 </span><span style="color:navy">jnb     short </span><span style="color:gray">SKIPRESET
</span><span style="color:black">DOSCODE:869B                 </span><span style="color:navy">mov     dx, es:[di+</span><span style="color:#ff8000">2Bh</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_chain]
<span style="color:black">DOSCODE:869B                                         </span>; first cluster (32 bit) lw !?
<span style="color:black">DOSCODE:869F                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">19h</span><span style="color:navy">], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:86A5                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">35h</span><span style="color:navy">], dx </span>; [ES:DI+SF_ENTRY.sf_lstclus]
<span style="color:black">DOSCODE:86A9                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:86AF                 </span><span style="color:navy">mov     dx, es:[di+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_chain]
<span style="color:black">DOSCODE:86AF                                         </span>; first cluster (32 bit) hw !?
<span style="color:black">DOSCODE:86B3                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">37h</span><span style="color:navy">], dx </span>; [ES:DI+SF_ENTRY.sf_lstclus+2]
<span style="color:black">DOSCODE:86B7
DOSCODE:86B7 </span><span style="color:gray">SKIPRESET</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:86B7                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:86B8                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:86BA                 </span><span style="color:navy">dec     dx
</span><span style="color:black">DOSCODE:86BB                 </span><span style="color:navy">mov     ds:</span>CLUSDATA_HW<span style="color:navy">, dx </span>; 0FFFFh
<span style="color:black">DOSCODE:86BF                 </span><span style="color:navy">call    </span>RELBLKS
<span style="color:black">DOSCODE:86C2
DOSCODE:86C2 </span><span style="color:gray">dskwrt_8</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:86C2                 </span><span style="color:navy">jb      short </span><span style="color:gray">SET_ACC_ERRWJ2 </span>; ds=ss
<span style="color:black">DOSCODE:86C4
DOSCODE:86C4 </span><span style="color:gray">UPDATEJ</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:86C4                 </span><span style="color:navy">jmp     short </span><span style="color:gray">UPDATE
</span><span style="color:black">DOSCODE:86C6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:86C6
DOSCODE:86C6 </span><span style="color:gray">KILLFIL</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:86C6                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:86C8                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:86C9                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:black">DOSCODE:86CD                 </span><span style="color:navy">xchg    bx, es:[di+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_chain+2]
<span style="color:black">DOSCODE:86CD                                         </span>; first cluster (32 bit) hw !?
<span style="color:black">DOSCODE:86D1                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:86D5                 </span><span style="color:navy">xor     bx, bx          </span>; 0
<span style="color:black">DOSCODE:86D7                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], bx </span>; [ES:DI+SF_ENTRY.sf_firclus]
<span style="color:black">DOSCODE:86D7                                         </span>; [ES:DI+SF_ENTRY.sf_cluspos_hw] !?
<span style="color:black">DOSCODE:86DB                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">37h</span><span style="color:navy">], bx </span>; [ES:DI+SF_ENTRY.sf_lstclus+2]
<span style="color:black">DOSCODE:86DF                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">19h</span><span style="color:navy">], bx </span>; [ES:DI+SF_ENTRY.sf_cluspos]
<span style="color:black">DOSCODE:86E3                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">35h</span><span style="color:navy">], bx </span>; [ES:DI+SF_ENTRY.sf_lstclus]
<span style="color:black">DOSCODE:86E7                 </span><span style="color:navy">xchg    bx, es:[di+</span><span style="color:#ff8000">2Bh</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_chain]
<span style="color:black">DOSCODE:86E7                                         </span>; first cluster (32 bit) !?
<span style="color:black">DOSCODE:86EB                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:86EC                 </span><span style="color:navy">cmp     bx, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:86F0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">dskwrt_9
</span><span style="color:black">DOSCODE:86F2                 </span><span style="color:navy">or      bx, bx
</span><span style="color:black">DOSCODE:86F4
DOSCODE:86F4 </span><span style="color:gray">dskwrt_9</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:86F4                 </span><span style="color:navy">jz      short </span><span style="color:gray">UPDATEJ
</span><span style="color:black">DOSCODE:86F6                 </span><span style="color:navy">push    es              </span>; since first cluster # is 0
<span style="color:black">DOSCODE:86F7                 </span><span style="color:navy">push    bp              </span>; we must delete the old cache entry
<span style="color:black">DOSCODE:86F8                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:86F9                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:86FA                 </span><span style="color:navy">les     bp, ds:</span>THISDPB  ; get current DPB
<span style="color:black">DOSCODE:86FE                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:86FF                 </span><span style="color:navy">mov     dl, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; get current drive
<span style="color:black">DOSCODE:8703                 </span><span style="color:navy">mov     cx, bx          </span>; first cluster #
<span style="color:black">DOSCODE:8705                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2           </span>; delete cache entry by drive:firclus
<span style="color:black">DOSCODE:8707                 </span><span style="color:navy">call    </span>FastOpen_Update ; call fastopen
<span style="color:black">DOSCODE:870A                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:870B                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:870C                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:870D                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:870E                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:870F                 </span><span style="color:navy">call    </span>RELEASE
<span style="color:black">DOSCODE:8712                 </span><span style="color:navy">jmp     short </span><span style="color:gray">dskwrt_8
</span><span style="color:black">DOSCODE:8712 </span>DISKWRITE       <span style="color:black">endp
DOSCODE:8712
DOSCODE:8714
DOSCODE:8714 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8714
DOSCODE:8714
DOSCODE:8714 </span>DskWrtBufPurge  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8714                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:8715                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:8716                 </span><span style="color:navy">mov     bx, ss:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:871B                 </span><span style="color:navy">add     cx, dx
</span><span style="color:black">DOSCODE:871D                 </span><span style="color:navy">mov     si, bx
</span><span style="color:black">DOSCODE:871F                 </span><span style="color:navy">adc     si, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8722                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; [es:bp+DPB.DRIVE]
<span style="color:black">DOSCODE:8726                 </span><span style="color:navy">call    </span>GETCURHEAD
<span style="color:black">DOSCODE:8729
DOSCODE:8729 </span><span style="color:gray">_bufq</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8729                 </span><span style="color:navy">cmp     al, [di+</span><span style="color:#ff8000">4</span><span style="color:navy">]      </span>; [di+BUFFINFO.buf_ID] ; Same drive?
<span style="color:black">DOSCODE:872C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">bufq5     </span>; no
<span style="color:black">DOSCODE:872E                 </span><span style="color:navy">cmp     bx, [di+</span><span style="color:#ff8000">8</span><span style="color:navy">]      </span>; [di+BUFFINFO.buf_sector+2]
<span style="color:black">DOSCODE:8731                 </span><span style="color:navy">jnz     short </span><span style="color:gray">bufq04
</span><span style="color:black">DOSCODE:8733                 </span><span style="color:navy">cmp     dx, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [di+BUFFINFO.buf_sector]
<span style="color:black">DOSCODE:8736
DOSCODE:8736 </span><span style="color:gray">bufq04</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8736                 </span><span style="color:navy">ja      short </span><span style="color:gray">bufq5
</span><span style="color:black">DOSCODE:8738                 </span><span style="color:navy">cmp     si, [di+</span><span style="color:#ff8000">8</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:873B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">bufq05
</span><span style="color:black">DOSCODE:873D                 </span><span style="color:navy">cmp     cx, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:8740
DOSCODE:8740 </span><span style="color:gray">bufq05</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8740                 </span><span style="color:navy">jbe     short </span><span style="color:gray">bufq5
</span><span style="color:black">DOSCODE:8742                 </span><span style="color:navy">test    byte ptr [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [di+BUFFINFO.buf_flags],buf_dirty
<span style="color:black">DOSCODE:8746                 </span><span style="color:navy">jz      short </span><span style="color:gray">bufq4
</span><span style="color:black">DOSCODE:8748                 </span><span style="color:navy">call    </span>DEC_DIRTY_COUNT
<span style="color:black">DOSCODE:874B
DOSCODE:874B </span><span style="color:gray">bufq4</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:874B                 </span><span style="color:navy">mov     word ptr [di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:#ff8000">20FFh </span>; [di+BUFFINFO.buf_ID],
<span style="color:black">DOSCODE:874B                                         </span>; ((buf_visit&lt;&lt;8)|0FFh)
<span style="color:black">DOSCODE:8750                 </span><span style="color:navy">call    </span>SCANPLACE
<span style="color:black">DOSCODE:8753                 </span><span style="color:navy">jmp     short </span><span style="color:gray">bufq6
</span><span style="color:black">DOSCODE:8755 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8755
DOSCODE:8755 </span><span style="color:gray">bufq5</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8755                 </span><span style="color:navy">mov     di, [di]        </span>; [di+BUFFINFO.buf_next]
<span style="color:black">DOSCODE:8757
DOSCODE:8757 </span><span style="color:gray">bufq6</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8757                 </span><span style="color:navy">cmp     di, ss:</span>FIRST_BUFF_ADDR
<span style="color:black">DOSCODE:875C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_bufq     </span>; go do next buffer.
<span style="color:black">DOSCODE:875E                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:875F                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:8760                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8760 </span>DskWrtBufPurge  <span style="color:black">endp
DOSCODE:8760
DOSCODE:8761
DOSCODE:8761 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8761
DOSCODE:8761
DOSCODE:8761 </span>DIV32           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8761                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">512
</span><span style="color:black">DOSCODE:8765                 </span><span style="color:navy">jnz     short </span><span style="color:gray">div5
</span><span style="color:black">DOSCODE:8767                 </span><span style="color:navy">mov     cx, dx
</span><span style="color:black">DOSCODE:8769                 </span><span style="color:navy">mov     dx, ax          </span>; CX:AX = Dividend
<span style="color:black">DOSCODE:876B                 </span><span style="color:navy">and     dx, </span><span style="color:green">1FFh        </span>; DX = Remainder
<span style="color:black">DOSCODE:876F                 </span><span style="color:navy">mov     al, ah
</span><span style="color:black">DOSCODE:8771                 </span><span style="color:navy">mov     ah, cl
</span><span style="color:black">DOSCODE:8773                 </span><span style="color:navy">mov     cl, ch
</span><span style="color:black">DOSCODE:8775                 </span><span style="color:navy">xor     ch, ch
</span><span style="color:black">DOSCODE:8777                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:8779                 </span><span style="color:navy">rcr     ax, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:877B                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:877C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:877C
DOSCODE:877C </span><span style="color:gray">div5</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:877C                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">DOSCODE:877E                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:black">DOSCODE:8780                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:8782                 </span><span style="color:navy">div     bx              </span>; 0:AX/BX
<span style="color:black">DOSCODE:8784                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:black">DOSCODE:8785                 </span><span style="color:navy">div     bx              </span>; DX:AX/BX
<span style="color:black">DOSCODE:8787                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8787 </span>DIV32           <span style="color:black">endp
DOSCODE:8787
DOSCODE:8788
DOSCODE:8788 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8788
DOSCODE:8788
DOSCODE:8788 </span>SHR32           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8788                 </span><span style="color:navy">mov     cl, es:[bp+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; [ES:BP+DPB.CLUSTER_SHIFT]
<span style="color:black">DOSCODE:878C                 </span><span style="color:navy">xor     ch, ch          </span>; ZF=1
<span style="color:black">DOSCODE:878E                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">norota
</span><span style="color:black">DOSCODE:8790
DOSCODE:8790 </span><span style="color:gray">rotashft2</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8790                 </span><span style="color:navy">shr     dx, </span><span style="color:green">1           </span>; ZF reflects state of DX.
<span style="color:black">DOSCODE:8792                 </span><span style="color:navy">rcr     ax, </span><span style="color:green">1           </span>; ZF not affected.
<span style="color:black">DOSCODE:8794                 </span><span style="color:navy">loop    </span><span style="color:gray">rotashft2
</span><span style="color:black">DOSCODE:8796
DOSCODE:8796 </span><span style="color:gray">norota</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8796                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8796 </span>SHR32           <span style="color:black">endp
DOSCODE:8796
DOSCODE:8797
DOSCODE:8797 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8797
DOSCODE:8797
DOSCODE:8797 </span>FINDENTRY       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8797                 </span><span style="color:navy">call    </span>STARTSRCH
<span style="color:black">DOSCODE:879A                 </span><span style="color:navy">mov     al, ds:</span>ATTRIB
<span style="color:black">DOSCODE:879D                 </span><span style="color:navy">and     al, </span><span style="color:green">9Eh         </span>; ~attr_ignore
<span style="color:black">DOSCODE:879F                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">8           </span>; attr_volume_id
<span style="color:black">DOSCODE:87A1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOTVOLSRCH
</span><span style="color:black">DOSCODE:87A3                 </span><span style="color:navy">call    </span>SETROOTSRCH
<span style="color:black">DOSCODE:87A6
DOSCODE:87A6 </span><span style="color:gray">NOTVOLSRCH</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:87A6                 </span><span style="color:navy">call    </span>GETENTRY
<span style="color:black">DOSCODE:87A9                 </span><span style="color:navy">jnb     short </span>SRCH
<span style="color:black">DOSCODE:87AB                 </span><span style="color:navy">jb      short </span>SETESRET_j
<span style="color:black">DOSCODE:87AD
DOSCODE:87AD </span>SRCH<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:87AD                 </span><span style="color:navy">mov     ds:</span>LNE_COUNT<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; reset long name entry count
<span style="color:black">DOSCODE:87B3
DOSCODE:87B3 </span>SRCH2<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:87B3                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:87B4                 </span><span style="color:navy">mov     ds, word ptr ds:</span>CURBUF<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:87B8                 </span><span style="color:navy">mov     ah, [bx]        </span>; [BX+dir_entry.dir_name]
<span style="color:black">DOSCODE:87BA                 </span><span style="color:navy">or      ah, ah
</span><span style="color:black">DOSCODE:87BC                 </span><span style="color:navy">jz      short </span>FREE
<span style="color:black">DOSCODE:87BE                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:87BF                 </span><span style="color:navy">mov     al, [bx+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">]    </span>; [BX+dir_entry.dir_attr]
<span style="color:black">DOSCODE:87C2                 </span><span style="color:navy">call    </span>check_longname
<span style="color:black">DOSCODE:87C5                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:87C6                 </span><span style="color:navy">jz      short </span>NEXTENT2
<span style="color:black">DOSCODE:87C8                 </span><span style="color:navy">cmp     ah, ss:</span>DELALL
<span style="color:black">DOSCODE:87CD                 </span><span style="color:navy">jz      short </span>FREE
<span style="color:black">DOSCODE:87CF                 </span><span style="color:navy">test    byte ptr [bx+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], </span><span style="color:green">8 </span>; [BX+dir_entry.dir_attr],
<span style="color:black">DOSCODE:87CF                                         </span>; attr_volume_id
<span style="color:black">DOSCODE:87D3                 </span><span style="color:navy">jz      short </span><span style="color:gray">CHKFNAM
</span><span style="color:black">DOSCODE:87D5                 </span><span style="color:navy">inc     ss:</span>VOLID
<span style="color:black">DOSCODE:87DA
DOSCODE:87DA </span><span style="color:gray">CHKFNAM</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:87DA                 </span><span style="color:navy">mov     si, ss
</span><span style="color:black">DOSCODE:87DC                 </span><span style="color:navy">mov     es, si
</span><span style="color:black">DOSCODE:87DE                 </span><span style="color:navy">mov     si, bx
</span><span style="color:black">DOSCODE:87E0                 </span><span style="color:navy">mov     di, offset </span>NAME1
<span style="color:black">DOSCODE:87E3                 </span><span style="color:navy">cmp     ss:</span>NAME1<span style="color:navy">, </span><span style="color:#ff8000">0E5h
</span><span style="color:black">DOSCODE:87E9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NO_E5
</span><span style="color:black">DOSCODE:87EB                 </span><span style="color:navy">mov     ss:</span>NAME1<span style="color:navy">, </span><span style="color:#ff8000">5
</span><span style="color:black">DOSCODE:87F1
DOSCODE:87F1 </span><span style="color:gray">NO_E5</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:87F1                 </span><span style="color:navy">call    </span>MetaCompare
<span style="color:black">DOSCODE:87F4                 </span><span style="color:navy">jz      short </span>FOUND
<span style="color:black">DOSCODE:87F6                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:87F6 </span>FINDENTRY       <span style="color:black">endp
DOSCODE:87F6
DOSCODE:87F7
DOSCODE:87F7 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:87F7
DOSCODE:87F7
DOSCODE:87F7 </span>NEXTENT         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:87F7                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:87FB                 </span><span style="color:navy">call    </span>NEXTENTRY
<span style="color:black">DOSCODE:87FE                 </span><span style="color:navy">jnb     short </span>SRCH
<span style="color:black">DOSCODE:8800
DOSCODE:8800 </span>SETESRET_j<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8800                 </span><span style="color:navy">jmp     short </span><span style="color:gray">SETESRET
</span><span style="color:black">DOSCODE:8802 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8802
DOSCODE:8802 </span>NEXTENT2<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8802                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:8803                 </span><span style="color:navy">inc     ds:</span>LNE_COUNT    ; Long Name entry count
<span style="color:black">DOSCODE:8807
DOSCODE:8807 </span><span style="color:gray">NEXTENT3</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8807                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:880B                 </span><span style="color:navy">call    </span>NEXTENTRY
<span style="color:black">DOSCODE:880E                 </span><span style="color:navy">jnb     short </span>SRCH2
<span style="color:black">DOSCODE:8810                 </span><span style="color:navy">jmp     short </span><span style="color:gray">SETESRET
</span><span style="color:black">DOSCODE:8812 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8812
DOSCODE:8812 </span>FREE<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8812                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:8813                 </span><span style="color:navy">mov     cx, ds:</span>LASTENT
<span style="color:black">DOSCODE:8817                 </span><span style="color:navy">cmp     cx, ds:</span>ENTFREE
<span style="color:black">DOSCODE:881B                 </span><span style="color:navy">jnb     short </span><span style="color:gray">TSTALL
</span><span style="color:black">DOSCODE:881D                 </span><span style="color:navy">mov     ds:</span>ENTFREE<span style="color:navy">, cx
</span><span style="color:black">DOSCODE:8821
DOSCODE:8821 </span><span style="color:gray">TSTALL</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8821                 </span><span style="color:navy">cmp     ah, ds:</span>DELALL
<span style="color:black">DOSCODE:8825                 </span><span style="color:navy">jz      short </span><span style="color:gray">NEXTENT3
</span><span style="color:black">DOSCODE:8827                 </span><span style="color:navy">mov     ds:</span>ENTLAST<span style="color:navy">, cx
</span><span style="color:black">DOSCODE:882B                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:882C                 </span><span style="color:navy">jmp     short </span><span style="color:gray">SETESRET
</span><span style="color:black">DOSCODE:882E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:882E
DOSCODE:882E </span>FOUND<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:882E                 </span><span style="color:navy">mov     ch, [si]
</span><span style="color:black">DOSCODE:8830                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:8831                 </span><span style="color:navy">mov     ah, ds:</span>ATTRIB
<span style="color:black">DOSCODE:8835                 </span><span style="color:navy">and     ah, </span><span style="color:green">9Eh         </span>; ~attr_ignore
<span style="color:black">DOSCODE:8838                 </span><span style="color:navy">lea     si, [si+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">]    </span>; [SI+dir_entry.dir_first-dir_entry.dir_attr]
<span style="color:black">DOSCODE:883B                 </span><span style="color:navy">test    ch, </span><span style="color:green">8           </span>; attr_volume_id
<span style="color:black">DOSCODE:883E                 </span><span style="color:navy">jz      short </span><span style="color:gray">check_one_volume_id
</span><span style="color:black">DOSCODE:8840                 </span><span style="color:navy">test    ah, </span><span style="color:green">8           </span>; attr_volume_id
<span style="color:black">DOSCODE:8843                 </span><span style="color:navy">jz      short </span>NEXTENT
<span style="color:black">DOSCODE:8845                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:8847                 </span><span style="color:navy">jmp     short </span><span style="color:gray">RETFF
</span><span style="color:black">DOSCODE:8849 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8849
DOSCODE:8849 </span><span style="color:gray">check_one_volume_id</span><span style="color:navy">:                    </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8849                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">8           </span>; attr_volume_id
<span style="color:black">DOSCODE:884C                 </span><span style="color:navy">jz      short </span>NEXTENT
<span style="color:black">DOSCODE:884E                 </span><span style="color:navy">call    </span>MatchAttributes
<span style="color:black">DOSCODE:8851                 </span><span style="color:navy">jz      short </span><span style="color:gray">RETFF
</span><span style="color:black">DOSCODE:8853                 </span><span style="color:navy">test    ds:</span>CREATING<span style="color:navy">, </span><span style="color:green">0FFh </span>; -1
<span style="color:black">DOSCODE:8858                 </span><span style="color:navy">jz      short </span>NEXTENT
<span style="color:black">DOSCODE:885A
DOSCODE:885A </span><span style="color:gray">RETFF</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:885A                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:885E                 </span><span style="color:navy">mov     ah, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; [ES:BP+DPB.DRIVE]
<span style="color:black">DOSCODE:8862
DOSCODE:8862 </span><span style="color:gray">SETESRET</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8862                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:8863                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:8864                 </span><span style="color:navy">push    ds:</span>ENTLAST
<span style="color:black">DOSCODE:8868                 </span><span style="color:navy">pop     ds:</span>ENTLAST_PREV ; previous ENTLAST
<span style="color:black">DOSCODE:886C                 </span><span style="color:navy">jnb     short </span><span style="color:gray">SETESRETN
</span><span style="color:black">DOSCODE:886E                 </span><span style="color:navy">mov     ds:</span>LNE_COUNT<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; reset long name entry count
<span style="color:black">DOSCODE:8874
DOSCODE:8874 </span><span style="color:gray">SETESRETN</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8874                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8874 </span>NEXTENT         <span style="color:black">endp
DOSCODE:8874
DOSCODE:8875
DOSCODE:8875 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8875
DOSCODE:8875
DOSCODE:8875 </span>MetaCompare     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8875                 </span><span style="color:navy">mov     cx, </span><span style="color:green">11
</span><span style="color:black">DOSCODE:8878
DOSCODE:8878 </span><span style="color:gray">WILDCRD</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8878                 </span><span style="color:navy">repe cmpsb
</span><span style="color:black">DOSCODE:887A                 </span><span style="color:navy">jz      short </span><span style="color:gray">MetaRet
</span><span style="color:black">DOSCODE:887C                 </span><span style="color:navy">cmp     byte ptr es:[di-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">3Fh </span><span style="color:gray">; &#039;?&#039;
</span><span style="color:black">DOSCODE:8881                 </span><span style="color:navy">jz      short </span><span style="color:gray">WILDCRD
</span><span style="color:black">DOSCODE:8883
DOSCODE:8883 </span><span style="color:gray">MetaRet</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8883                 </span><span style="color:navy">retn                    </span>; Zero set, Match
<span style="color:black">DOSCODE:8883 </span>MetaCompare     <span style="color:black">endp
DOSCODE:8883
DOSCODE:8884
DOSCODE:8884 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8884
DOSCODE:8884
DOSCODE:8884 </span>NEXTENTRY       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8884                 </span><span style="color:navy">mov     ax, ds:</span>LASTENT
<span style="color:black">DOSCODE:8887                 </span><span style="color:navy">cmp     ax, ds:</span>ENTLAST
<span style="color:black">DOSCODE:888B                 </span><span style="color:navy">jz      short </span><span style="color:gray">NONE
</span><span style="color:black">DOSCODE:888D                 </span><span style="color:navy">inc     ax
</span><span style="color:black">DOSCODE:888E                 </span><span style="color:navy">lea     bx, [bx+</span><span style="color:green">32</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:8891                 </span><span style="color:navy">cmp     bx, dx
</span><span style="color:black">DOSCODE:8893                 </span><span style="color:navy">jnz     short </span><span style="color:gray">HAVIT
</span><span style="color:black">DOSCODE:8895                 </span><span style="color:navy">cmp     ds:</span>DIRSTART<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:889A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">nextentry_cont
</span><span style="color:black">DOSCODE:889C                 </span><span style="color:navy">cmp     ds:</span>DIRSTART_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:88A1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">nextentry_cont
</span><span style="color:black">DOSCODE:88A3                 </span><span style="color:navy">cmp     ax, es:[bp+</span><span style="color:#ff8000">9</span><span style="color:navy">]   </span>; [es:bp+DPB.ROOT_ENTRIES]
<span style="color:black">DOSCODE:88A3                                         </span>; Number of root directory entries
<span style="color:black">DOSCODE:88A7                 </span><span style="color:navy">jnb     short </span><span style="color:gray">NONE
</span><span style="color:black">DOSCODE:88A9                 </span><span style="color:navy">jmp     short </span>GETENT
<span style="color:black">DOSCODE:88AB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:88AB
DOSCODE:88AB </span><span style="color:gray">nextentry_cont</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:88AB                 </span><span style="color:navy">mov     bl, ds:</span>SECCLUSPOS
<span style="color:black">DOSCODE:88AF                 </span><span style="color:navy">inc     bl
</span><span style="color:black">DOSCODE:88B1                 </span><span style="color:navy">cmp     bl, ds:</span>CLUSFAC
<span style="color:black">DOSCODE:88B5                 </span><span style="color:navy">jb      short </span><span style="color:gray">SAMECLUS
</span><span style="color:black">DOSCODE:88B7                 </span><span style="color:navy">mov     bx, ds:</span>NXTCLUSNUM_HW
<span style="color:black">DOSCODE:88BB                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:88BF                 </span><span style="color:navy">mov     bx, ds:</span>NXTCLUSNUM
<span style="color:black">DOSCODE:88C3                 </span><span style="color:navy">call    </span>IsEOF
<span style="color:black">DOSCODE:88C6                 </span><span style="color:navy">jnb     short </span><span style="color:gray">NONE
</span><span style="color:black">DOSCODE:88C8                 </span><span style="color:navy">cmp     ds:</span>CLUSTNUM_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:88CD                 </span><span style="color:navy">jnz     short </span>GETENT
<span style="color:black">DOSCODE:88CF                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:88D2                 </span><span style="color:navy">jnb     short </span>GETENT
<span style="color:black">DOSCODE:88D4
DOSCODE:88D4 </span><span style="color:gray">NONE</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:88D4                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:88D5                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:88D6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:88D6
DOSCODE:88D6 </span><span style="color:gray">HAVIT</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:88D6                 </span><span style="color:navy">mov     ds:</span>LASTENT<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:88D9                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:88DA
DOSCODE:88DA </span>nextentry_retn<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:88DA                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:88DB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:88DB
DOSCODE:88DB </span><span style="color:gray">SAMECLUS</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:88DB                 </span><span style="color:navy">mov     ds:</span>SECCLUSPOS<span style="color:navy">, bl
</span><span style="color:black">DOSCODE:88DF                 </span><span style="color:navy">mov     ds:</span>LASTENT<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:88E2                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:88E3                 </span><span style="color:navy">lds     di, ds:</span>CURBUF
<span style="color:black">DOSCODE:88E7                 </span><span style="color:navy">lds     dx, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [DI+BUFFINFO.buf_sector]
<span style="color:black">DOSCODE:88EA                 </span><span style="color:navy">mov     ss:</span>HIGH_SECTOR<span style="color:navy">, ds
</span><span style="color:black">DOSCODE:88EF                 </span><span style="color:navy">add     dx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:88F2                 </span><span style="color:navy">adc     ss:</span>HIGH_SECTOR<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:88F8                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:88F9                 </span><span style="color:navy">call    </span>FIRSTCLUSTER
<span style="color:black">DOSCODE:88FC                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:88FE                 </span><span style="color:navy">jmp     short </span>SETENTRY
<span style="color:black">DOSCODE:88FE </span>NEXTENTRY       <span style="color:black">endp
DOSCODE:88FE
DOSCODE:8900
DOSCODE:8900 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8900
DOSCODE:8900
DOSCODE:8900 </span>GETENTRY        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8900                 </span><span style="color:navy">mov     ax, ds:</span>LASTENT
<span style="color:black">DOSCODE:8903
DOSCODE:8903 </span>GETENT<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8903                 </span><span style="color:navy">mov     ds:</span>LASTENT<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8906                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">5
</span><span style="color:black">DOSCODE:8908                 </span><span style="color:navy">rol     ax, cl
</span><span style="color:black">DOSCODE:890A                 </span><span style="color:navy">mov     dx, ax
</span><span style="color:black">DOSCODE:890C                 </span><span style="color:navy">and     ax, </span><span style="color:green">0FFE0h      </span>; ~(32-1)
<span style="color:black">DOSCODE:890F                 </span><span style="color:navy">and     dx, </span><span style="color:green">1Fh
</span><span style="color:black">DOSCODE:8912                 </span><span style="color:navy">mov     bx, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [ES:BP+DPB.SECTOR_SIZE]
<span style="color:black">DOSCODE:8916                 </span><span style="color:navy">and     bl, </span><span style="color:green">0E0h        </span>; Must be multiple of 32
<span style="color:black">DOSCODE:8919                 </span><span style="color:navy">div     bx
</span><span style="color:black">DOSCODE:891B                 </span><span style="color:navy">mov     bx, dx          </span>; Position within sector
<span style="color:black">DOSCODE:891B                                         </span>; NOTE: This BX value is not used in DIRREAD
<span style="color:black">DOSCODE:891B                                         </span>; Erdogan Tan - 14/02/2024
<span style="color:black">DOSCODE:891D                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:891E                 </span><span style="color:navy">call    </span>DIRREAD
<span style="color:black">DOSCODE:8921                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:8922                 </span><span style="color:navy">jb      short </span>nextentry_retn
<span style="color:black">DOSCODE:8924
DOSCODE:8924 </span>SETENTRY<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8924                 </span><span style="color:navy">mov     dx, word ptr ds:</span>CURBUF
<span style="color:black">DOSCODE:8928                 </span><span style="color:navy">add     dx, </span><span style="color:green">24          </span>; BUFINSIZ
<span style="color:black">DOSCODE:892B                 </span><span style="color:navy">add     bx, dx
</span><span style="color:black">DOSCODE:892D                 </span><span style="color:navy">add     dx, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [ES:BP+DPB.SECTOR_SIZE]
<span style="color:black">DOSCODE:8931                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:8932                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8932 </span>GETENTRY        <span style="color:black">endp
DOSCODE:8932
DOSCODE:8932 </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSCODE:8933 </span>sft_fcb_table   <span style="color:navy">db </span><span style="color:#008040">20 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)            </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:8947 </span>sftfcb_cluster  <span style="color:navy">dw </span><span style="color:#008040">2 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)             </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:894B </span>sftfcb_direntry <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:894D                 </span><span style="color:navy">db </span><span style="color:#008040">114 </span><span style="color:navy">dup(</span><span style="color:#008040">0</span><span style="color:navy">)           </span>; 6*20 = 120 ; entry size = 6 bytes
<span style="color:gray">DOSCODE:89BF </span>SRCH_CLUSTER    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:89C1 </span>SRCH_CLUSTER_HW <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:89C3
DOSCODE:89C3 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:89C3
DOSCODE:89C3
DOSCODE:89C3 </span>SETDIRSRCH      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:89C3                 </span><span style="color:navy">cmp     ds:</span>ROOTCLUST_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:89C8                 </span><span style="color:navy">jnz     short </span>SETDIRSRCH_FAT32
<span style="color:black">DOSCODE:89CA                 </span><span style="color:navy">or      bx, bx
</span><span style="color:black">DOSCODE:89CC                 </span><span style="color:navy">jz      short </span>SETROOTSRCH
<span style="color:black">DOSCODE:89CE
DOSCODE:89CE </span>SETDIRSRCH_FAT32<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:89CE                 </span><span style="color:navy">mov     ax, ds:</span>ROOTCLUST_HW
<span style="color:black">DOSCODE:89D1                 </span><span style="color:navy">mov     ds:</span>DIRSTART_HW<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:89D4                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:89D7                 </span><span style="color:navy">mov     ds:</span>DIRSTART<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:89DB                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [ES:BP+DPB.CLUSTER_MASK]
<span style="color:black">DOSCODE:89DF                 </span><span style="color:navy">inc     al
</span><span style="color:black">DOSCODE:89E1                 </span><span style="color:navy">mov     ds:</span>CLUSFAC<span style="color:navy">, al
</span><span style="color:black">DOSCODE:89E4                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:89E5                 </span><span style="color:navy">test    ds:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">2 </span>; [FastOpenFlg],Lookup_Success
<span style="color:black">DOSCODE:89EA                 </span><span style="color:navy">jnz     short </span><span style="color:gray">UNP_OK
</span><span style="color:black">DOSCODE:89EC                 </span><span style="color:navy">call    </span>UNPACK
<span style="color:black">DOSCODE:89EF                 </span><span style="color:navy">jnb     short </span><span style="color:gray">UNP_OK
</span><span style="color:black">DOSCODE:89F1                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:89F2                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:89F3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:89F3
DOSCODE:89F3 </span><span style="color:gray">UNP_OK</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:89F3                 </span><span style="color:navy">mov     ds:</span>CLUSNUM<span style="color:navy">, di  </span>; CCONTENT_HW:DI = Contents of FAT
<span style="color:black">DOSCODE:89F3                                         </span>; for given cluster (from UNPACK)
<span style="color:black">DOSCODE:89F7                 </span><span style="color:navy">mov     dx, ds:</span>CCONTENT_HW
<span style="color:black">DOSCODE:89FB                 </span><span style="color:navy">mov     ds:</span>CLUSNUM_HW<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:89FF                 </span><span style="color:navy">mov     cs:</span>SRCH_CLUSTER<span style="color:navy">, bx </span>; Directory start cluster number
<span style="color:black">DOSCODE:89FF                                         </span>; for searching/locating (directory entry)
<span style="color:black">DOSCODE:8A04                 </span><span style="color:navy">mov     dx, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:8A08                 </span><span style="color:navy">mov     cs:</span>SRCH_CLUSTER_HW<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:8A0D                 </span><span style="color:navy">mov     dx, bx
</span><span style="color:black">DOSCODE:8A0F                 </span><span style="color:navy">xor     bl, bl
</span><span style="color:black">DOSCODE:8A11                 </span><span style="color:navy">mov     ds:</span>SECCLUSPOS<span style="color:navy">, bl </span>;
<span style="color:black">DOSCODE:8A11                                         </span>; CLUSTNUM_HW:DX = Physical cluster number
<span style="color:black">DOSCODE:8A15                 </span><span style="color:navy">call    </span>FIGREC
<span style="color:black">DOSCODE:8A18                 </span><span style="color:navy">mov     si, ds:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:8A1C                 </span><span style="color:navy">mov     ds:</span>DIRSEC<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, si
</span><span style="color:black">DOSCODE:8A20                 </span><span style="color:navy">mov     ds:</span>DIRSEC<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:8A24                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:8A25                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:8A26                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8A26 </span>SETDIRSRCH      <span style="color:black">endp
DOSCODE:8A26
DOSCODE:8A27
DOSCODE:8A27 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8A27
DOSCODE:8A27
DOSCODE:8A27 </span>SETROOTSRCH     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8A27                 </span><span style="color:navy">mov     ds:</span>ROOTCLUST_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8A2D                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; DPB.FAT_SIZE
<span style="color:black">DOSCODE:8A32                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SETROOTSRCH_FAT </span>; not FAT32
<span style="color:black">DOSCODE:8A34
DOSCODE:8A34 </span>SETROOTSRCH_FAT32<span style="color:navy">:                      </span>;
<span style="color:black">DOSCODE:8A34                 </span><span style="color:navy">mov     bx, es:[bp+</span><span style="color:#ff8000">37h</span><span style="color:navy">] </span>; DPB.ROOT_CLUSTER+2
<span style="color:black">DOSCODE:8A38                 </span><span style="color:navy">mov     ds:</span>ROOTCLUST_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:8A3C                 </span><span style="color:navy">cmp     bx, es:[bp+</span><span style="color:#ff8000">2Fh</span><span style="color:navy">] </span>; DPB.LAST_CLUSTER+2
<span style="color:black">DOSCODE:8A40                 </span><span style="color:navy">mov     bx, es:[bp+</span><span style="color:#ff8000">35h</span><span style="color:navy">] </span>; DPB.ROOT_CLUSTER
<span style="color:black">DOSCODE:8A44                 </span><span style="color:navy">jnz     short </span><span style="color:gray">sdsrch_fat32_1
</span><span style="color:black">DOSCODE:8A46                 </span><span style="color:navy">cmp     bx, es:[bp+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">] </span>; DPB.LAST_CLUSTER
<span style="color:black">DOSCODE:8A4A
DOSCODE:8A4A </span><span style="color:gray">sdsrch_fat32_1</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8A4A                 </span><span style="color:navy">ja      short </span><span style="color:gray">sdsrch_fat32_3
</span><span style="color:black">DOSCODE:8A4C                 </span><span style="color:navy">cmp     ds:</span>ROOTCLUST_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8A51                 </span><span style="color:navy">jnz     short </span><span style="color:gray">sdsrch_fat32_2
</span><span style="color:black">DOSCODE:8A53                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:8A56                 </span><span style="color:navy">jb      short </span><span style="color:gray">sdsrch_fat32_3
</span><span style="color:black">DOSCODE:8A58
DOSCODE:8A58 </span><span style="color:gray">sdsrch_fat32_2</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8A58                 </span><span style="color:navy">jmp     </span>SETDIRSRCH_FAT32
<span style="color:black">DOSCODE:8A5B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8A5B
DOSCODE:8A5B </span><span style="color:gray">sdsrch_fat32_3</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8A5B                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:8A5C                 </span><span style="color:navy">jmp     short </span><span style="color:gray">setdirsrch_retn
</span><span style="color:black">DOSCODE:8A5E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8A5E
DOSCODE:8A5E </span><span style="color:gray">SETROOTSRCH_FAT</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8A5E                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:8A60                 </span><span style="color:navy">mov     ds:</span>DIRSEC<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8A63                 </span><span style="color:navy">mov     ds:</span>DIRSTART<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8A66                 </span><span style="color:navy">mov     ds:</span>DIRSTART_HW<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8A69                 </span><span style="color:navy">mov     cs:</span>SRCH_CLUSTER_HW<span style="color:navy">, ax </span>; search start dir cluster num = 1
<span style="color:black">DOSCODE:8A69                                         </span>; (root directory)
<span style="color:black">DOSCODE:8A6D                 </span><span style="color:navy">inc     ax
</span><span style="color:black">DOSCODE:8A6E                 </span><span style="color:navy">mov     cs:</span>SRCH_CLUSTER<span style="color:navy">, ax </span>; 1 ; FAT root directory (&lt;2)
<span style="color:black">DOSCODE:8A72                 </span><span style="color:navy">dec     ax              </span>; 0
<span style="color:black">DOSCODE:8A73                 </span><span style="color:navy">mov     ds:</span>SECCLUSPOS<span style="color:navy">, al
</span><span style="color:black">DOSCODE:8A76                 </span><span style="color:navy">dec     ax              </span>; -1
<span style="color:black">DOSCODE:8A77                 </span><span style="color:navy">mov     ds:</span>CLUSNUM<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8A7A                 </span><span style="color:navy">mov     ds:</span>CLUSNUM_HW<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8A7D                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">] </span>; [ES:BP+DPB.FIRST_SECTOR]
<span style="color:black">DOSCODE:8A81                 </span><span style="color:navy">mov     dx, es:[bp+</span><span style="color:#ff8000">11h</span><span style="color:navy">] </span>; [ES:BP+DPB.DIR_SECTOR]
<span style="color:black">DOSCODE:8A85                 </span><span style="color:navy">sub     ax, dx
</span><span style="color:black">DOSCODE:8A87                 </span><span style="color:navy">mov     ds:</span>CLUSFAC<span style="color:navy">, al
</span><span style="color:black">DOSCODE:8A8A                 </span><span style="color:navy">mov     ds:</span>DIRSEC<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:8A8E                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:8A8F
DOSCODE:8A8F </span><span style="color:gray">setdirsrch_retn</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8A8F                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8A8F </span>SETROOTSRCH     <span style="color:black">endp
DOSCODE:8A8F
DOSCODE:8A90
DOSCODE:8A90 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8A90
DOSCODE:8A90
DOSCODE:8A90 </span>set_sftfcb_entry <span style="color:black">proc near              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8A90                 </span><span style="color:navy">push    ax              </span>; set SFT number and entry
<span style="color:black">DOSCODE:8A90                                         </span>; in the new internal table
<span style="color:black">DOSCODE:8A90                                         </span>; (only for FCB calls)
<span style="color:black">DOSCODE:8A91                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:8A92                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:8A93                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:8A94                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:8A95                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:8A96                 </span><span style="color:navy">push    di              </span>; ES:DI = SFT entry
<span style="color:black">DOSCODE:8A97                 </span><span style="color:navy">call    </span>find_sft_entry_number ;
<span style="color:black">DOSCODE:8A97                                         </span>; ax = SFT entry index number
<span style="color:black">DOSCODE:8A97                                         </span>;      of the last SFT entry
<span style="color:black">DOSCODE:8A9A                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:8A9C                 </span><span style="color:navy">mov     cx, </span><span style="color:green">20          </span>; find empty entry (slot) in the table
<span style="color:black">DOSCODE:8A9F
DOSCODE:8A9F </span><span style="color:gray">set_sftfcbe_1</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8A9F                 </span><span style="color:navy">cmp     cs:(</span>sftfcb_cluster<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">)[bx], </span><span style="color:#ff8000">0 </span>; [cs:bx+sftfcb.cluster+2]
<span style="color:black">DOSCODE:8A9F                                         </span>; directory (search) starting cluster, hw
<span style="color:black">DOSCODE:8AA5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">set_sftfcbe_2
</span><span style="color:black">DOSCODE:8AA7                 </span><span style="color:navy">cmp     cs:</span>sftfcb_cluster<span style="color:navy">[bx], </span><span style="color:#ff8000">0 </span>; [cs:bx+sftfcb.cluster]
<span style="color:black">DOSCODE:8AA7                                         </span>; directory (search) starting cluster, lw
<span style="color:black">DOSCODE:8AAD
DOSCODE:8AAD </span><span style="color:gray">set_sftfcbe_2</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8AAD                 </span><span style="color:navy">jnz     short </span><span style="color:gray">set_sftfcbe_3 </span>; not empty (sfcb table) entry
<span style="color:black">DOSCODE:8AAF                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:8AB0                 </span><span style="color:navy">mov     cx, cs:</span>SRCH_CLUSTER ; search start dir cluster number
<span style="color:black">DOSCODE:8AB5                 </span><span style="color:navy">mov     cs:</span>sftfcb_cluster<span style="color:navy">[bx], cx </span>; directory start cluster
<span style="color:black">DOSCODE:8ABA                 </span><span style="color:navy">mov     cx, cs:</span>SRCH_CLUSTER_HW
<span style="color:black">DOSCODE:8ABF                 </span><span style="color:navy">mov     cs:</span>sftfcb_cluster<span style="color:navy">[bx], cx </span>; PCDOS 7.1 BUG! (This would be
<span style="color:black">DOSCODE:8ABF                                         </span>; &#039;cs:sftfcb_cluster+2[bx],cx&#039;)
<span style="color:black">DOSCODE:8ABF                                         </span>; Erdogan Tan - 23/01/2024
<span style="color:black">DOSCODE:8AC4                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:8AC5                 </span><span style="color:navy">mov     dx, ss:</span>LASTENT  ; LAST (found) entry in the directory
<span style="color:black">DOSCODE:8ACA                 </span><span style="color:navy">mov     cs:</span>sftfcb_direntry<span style="color:navy">[bx], dx </span>; [cs:bx+sftfcb.direntry]
<span style="color:black">DOSCODE:8ACA                                         </span>; directory entry number
<span style="color:black">DOSCODE:8ACF                 </span><span style="color:navy">xchg    ax, bx
</span><span style="color:black">DOSCODE:8AD0                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:8AD2                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">6           </span>; sftfcb table has 6 byte entries
<span style="color:black">DOSCODE:8AD5                 </span><span style="color:navy">div     cx
</span><span style="color:black">DOSCODE:8AD7                 </span><span style="color:navy">xchg    ax, bx
</span><span style="color:black">DOSCODE:8AD8                 </span><span style="color:navy">mov     cs:</span>sft_fcb_table<span style="color:navy">[bx], al </span>; put SFT entry number in SFT-FCB
<span style="color:black">DOSCODE:8AD8                                         </span>; table (offset is FCB index number 0 to 19)
<span style="color:black">DOSCODE:8ADD                 </span><span style="color:navy">jmp     short </span><span style="color:gray">set_setfcbe_4
</span><span style="color:black">DOSCODE:8ADF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8ADF
DOSCODE:8ADF </span><span style="color:gray">set_sftfcbe_3</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8ADF                 </span><span style="color:navy">add     bx, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:8AE2                 </span><span style="color:navy">loop    </span><span style="color:gray">set_sftfcbe_1
</span><span style="color:black">DOSCODE:8AE4
DOSCODE:8AE4 </span><span style="color:gray">set_setfcbe_4</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8AE4                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:8AE5                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:8AE6                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:8AE7                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:8AE8                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:8AE9                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:8AEA                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:8AEB                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8AEB </span>set_sftfcb_entry <span style="color:black">endp
DOSCODE:8AEB
DOSCODE:8AEC
DOSCODE:8AEC </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8AEC
DOSCODE:8AEC
DOSCODE:8AEC </span>find_sft_entry_number <span style="color:black">proc near         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8AEC                 </span><span style="color:navy">push    es              </span>; es:di = SFT entry
<span style="color:black">DOSCODE:8AED                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:8AEF                 </span><span style="color:navy">mov     dx, es
</span><span style="color:black">DOSCODE:8AF1                 </span><span style="color:navy">mov     es, cs:</span>DosDSeg
<span style="color:black">DOSCODE:8AF6                 </span><span style="color:navy">les     bx, es:</span>SFT_ADDR ; address of the first SFT
<span style="color:black">DOSCODE:8AFB
DOSCODE:8AFB </span><span style="color:gray">f_sfte_1</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8AFB                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">DOSCODE:8AFD                 </span><span style="color:navy">cmp     ax, dx          </span>; same SFT segment ?
<span style="color:black">DOSCODE:8AFF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">f_sfte_2  </span>; no
<span style="color:black">DOSCODE:8B01                 </span><span style="color:navy">mov     ax, di
</span><span style="color:black">DOSCODE:8B03                 </span><span style="color:navy">sub     ax, bx          </span>; ax = entry offset
<span style="color:black">DOSCODE:8B05                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">6           </span>; ax = offset from start of the SFT table
<span style="color:black">DOSCODE:8B05                                         </span>; SFT.SFTable
<span style="color:black">DOSCODE:8B08                 </span><span style="color:navy">mov     bx, </span><span style="color:green">59          </span>; SF_ENTRY.size (SFT entry size)
<span style="color:black">DOSCODE:8B0B                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:8B0D                 </span><span style="color:navy">div     bx              </span>; ax = SFT entry index in the table
<span style="color:black">DOSCODE:8B0F                 </span><span style="color:navy">add     ax, cx          </span>; ax = SFT index number (for requested SFT entry)
<span style="color:black">DOSCODE:8B11                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:8B12                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8B13 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8B13
DOSCODE:8B13 </span><span style="color:gray">f_sfte_2</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8B13                 </span><span style="color:navy">add     cx, es:[bx+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; SFT.SFCount ; number of entries in the table
<span style="color:black">DOSCODE:8B17                 </span><span style="color:navy">les     bx, es:[bx]     </span>; SFT.SFLink
<span style="color:black">DOSCODE:8B1A                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">0FFFFh      </span>; the last SFT
<span style="color:black">DOSCODE:8B1D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">f_sfte_1
</span><span style="color:black">DOSCODE:8B1F                 </span><span style="color:navy">stc                     </span>; (not found)
<span style="color:black">DOSCODE:8B20                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:8B21                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8B21 </span>find_sft_entry_number <span style="color:black">endp
DOSCODE:8B21
DOSCODE:8B22
DOSCODE:8B22 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8B22
DOSCODE:8B22
DOSCODE:8B22 </span>int_2Fh_1230h   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8B22                 </span><span style="color:navy">call    </span>find_sft_entry_number ; Windows95 - FIND SFT ENTRY IN INTERNAL FILE TABLES
<span style="color:black">DOSCODE:8B25                 </span><span style="color:navy">jb      short </span><span style="color:gray">find_sfte_i_error
</span><span style="color:black">DOSCODE:8B27                 </span><span style="color:navy">push    es              </span>; ax = SFT enty index number (of the requested SFT entry)
<span style="color:black">DOSCODE:8B28                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:8B29                 </span><span style="color:navy">push    cs
</span><span style="color:black">DOSCODE:8B2A                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:8B2B                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:8B2B                 </span><span style="color:navy">mov     cx, </span><span style="color:green">20          </span>; statically allocated with 20 entries,
<span style="color:black">DOSCODE:8B2B                                         </span>; and used only for FCB calls
<span style="color:black">DOSCODE:8B2E                 </span><span style="color:navy">mov     di, offset </span>sft_fcb_table ; new file system (internal) table
<span style="color:black">DOSCODE:8B2E                                         </span>;  only for fcb calls
<span style="color:black">DOSCODE:8B31
DOSCODE:8B31 </span><span style="color:gray">scan_next_sftfcb</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8B31                 </span><span style="color:navy">repne scasb
</span><span style="color:black">DOSCODE:8B33                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:8B34                 </span><span style="color:navy">jnz     short </span><span style="color:gray">sfte_i_notfound </span>; not found (cf=1)
<span style="color:black">DOSCODE:8B36                 </span><span style="color:navy">lea     bx, [di-</span><span style="color:green">1</span><span style="color:navy">]      </span>; offset of the entry in the table
<span style="color:black">DOSCODE:8B39                 </span><span style="color:navy">sub     bx, offset </span>sft_fcb_table ;
<span style="color:black">DOSCODE:8B39                                         </span>; index into new file system table
<span style="color:black">DOSCODE:8B3D                 </span><span style="color:navy">mov     dx, bx
</span><span style="color:black">DOSCODE:8B3F                 </span><span style="color:navy">add     bx, bx          </span>; 2*bx
<span style="color:black">DOSCODE:8B41                 </span><span style="color:navy">add     bx, dx          </span>; 3*bx
<span style="color:black">DOSCODE:8B43                 </span><span style="color:navy">add     bx, bx          </span>; bx = 6*bx  ; entry size = 6 bytes
<span style="color:black">DOSCODE:8B45                 </span><span style="color:navy">mov     si, es:(</span>sftfcb_cluster<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">)[bx] </span>; dir start cluster number, hw
<span style="color:black">DOSCODE:8B4A                 </span><span style="color:navy">mov     dx, es:</span>sftfcb_direntry<span style="color:navy">[bx] </span>; directory entry number
<span style="color:black">DOSCODE:8B4F                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:8B50                 </span><span style="color:navy">mov     cx, es:</span>sftfcb_cluster<span style="color:navy">[bx] </span>; dir start cluster number, lw
<span style="color:black">DOSCODE:8B55                 </span><span style="color:navy">or      cx, cx
</span><span style="color:black">DOSCODE:8B57                 </span><span style="color:navy">jnz     short </span><span style="color:gray">sfte_i_found
</span><span style="color:black">DOSCODE:8B59                 </span><span style="color:navy">or      si, si
</span><span style="color:black">DOSCODE:8B5B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">sfte_i_found
</span><span style="color:black">DOSCODE:8B5D                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:8B5E                 </span><span style="color:navy">or      cx, cx
</span><span style="color:black">DOSCODE:8B60                 </span><span style="color:navy">jnz     short </span><span style="color:gray">scan_next_sftfcb
</span><span style="color:black">DOSCODE:8B62                 </span><span style="color:navy">stc                     </span>; not found (cf=1)
<span style="color:black">DOSCODE:8B63                 </span><span style="color:navy">jmp     short </span><span style="color:gray">sfte_i_notfound
</span><span style="color:black">DOSCODE:8B65 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8B65
DOSCODE:8B65 </span><span style="color:gray">sfte_i_found</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8B65                 </span><span style="color:navy">pop     ax              </span>; clear stack
<span style="color:black">DOSCODE:8B66                 </span><span style="color:navy">clc                     </span>; found (cf=0)
<span style="color:black">DOSCODE:8B67
DOSCODE:8B67 </span><span style="color:gray">sfte_i_notfound</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8B67                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:8B68                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:8B69                 </span>assume es:nothing
<span style="color:black">DOSCODE:8B69
DOSCODE:8B69 </span><span style="color:gray">find_sfte_i_error</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8B69                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8B6C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8B6C </span>int_2Fh_1230h   <span style="color:black">endp
DOSCODE:8B6C
DOSCODE:8B6D
DOSCODE:8B6D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8B6D
DOSCODE:8B6D
DOSCODE:8B6D </span>SFT_FREE        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8B6D                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:8B6E                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:8B6F                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:8B70                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:8B71                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:8B72                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:8B73                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:8B74                 </span><span style="color:navy">mov     word ptr es:[di], </span><span style="color:#ff8000">0 </span>; [ES:DI+SF_ENTRY.sf_ref_Count]
<span style="color:black">DOSCODE:8B79                 </span><span style="color:navy">call    </span>int_2Fh_1230h
<span style="color:black">DOSCODE:8B7C                 </span><span style="color:navy">jb      short </span><span style="color:gray">sftf_1
</span><span style="color:black">DOSCODE:8B7E                 </span><span style="color:navy">mov     cs:(</span>sftfcb_cluster<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">)[bx], </span><span style="color:#ff8000">0 </span>; clear directory start cluster
<span style="color:black">DOSCODE:8B7E                                         </span>;  in the new (sftfcb) table
<span style="color:black">DOSCODE:8B85                 </span><span style="color:navy">mov     cs:</span>sftfcb_cluster<span style="color:navy">[bx], </span><span style="color:#ff8000">0 </span>; ((empty entry))
<span style="color:black">DOSCODE:8B8C
DOSCODE:8B8C </span><span style="color:gray">sftf_1</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8B8C                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:8B8D                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:8B8E                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:8B8F                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:8B90                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:8B91                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:8B92                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:8B93                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8B93 </span>SFT_FREE        <span style="color:black">endp
DOSCODE:8B93
DOSCODE:8B94
DOSCODE:8B94 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8B94
DOSCODE:8B94
DOSCODE:8B94 </span>check_longname  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8B94                 </span><span style="color:navy">and     al, </span><span style="color:green">0Fh
</span><span style="color:black">DOSCODE:8B96                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0Fh
</span><span style="color:black">DOSCODE:8B98                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8B98 </span>check_longname  <span style="color:black">endp
DOSCODE:8B98
DOSCODE:8B99
DOSCODE:8B99 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8B99
DOSCODE:8B99
DOSCODE:8B99 </span>GETPATH         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8B99                 </span><span style="color:navy">mov     word ptr ds:</span>CREATING<span style="color:navy">, </span><span style="color:green">0E500h </span>; DIRFREE*256+0
<span style="color:black">DOSCODE:8B99 </span>GETPATH         <span style="color:black">endp                    </span>; Not Creating, not DEL *.*
<span style="color:black">DOSCODE:8B99
DOSCODE:8B9F
DOSCODE:8B9F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8B9F
DOSCODE:8B9F
DOSCODE:8B9F </span>GetPathNoSet    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8B9F
DOSCODE:8B9F </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:8C9D SIZE 000001B6 BYTES
</span><span style="color:black">DOSCODE:8B9F
DOSCODE:8B9F                 </span><span style="color:navy">call    </span>set_exerr_locus_disk
<span style="color:black">DOSCODE:8BA2                 </span><span style="color:navy">mov     word ptr ds:</span>CURBUF<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; -1 ; initial setting
<span style="color:black">DOSCODE:8BA8                 </span><span style="color:navy">mov     di, ds:</span>WFP_START ; point to the beginning of the name
<span style="color:black">DOSCODE:8BAC                 </span><span style="color:navy">cmp     word ptr [di+</span><span style="color:#ff8000">1</span><span style="color:navy">], </span><span style="color:#ff8000">5C3Ah </span>; &#039;:\&#039;
<span style="color:black">DOSCODE:8BB1                 </span><span style="color:navy">jz      short </span><span style="color:gray">CrackIt
</span><span style="color:black">DOSCODE:8BB3                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:8BB6                 </span><span style="color:navy">mov     si, di          </span>; not required ! (15/02/2024)
<span style="color:black">DOSCODE:8BB6                                         </span>; (it is written in CHKDEV proc already!)
<span style="color:black">DOSCODE:8BB8                 </span><span style="color:navy">call    </span>CHKDEV
<span style="color:black">DOSCODE:8BBB                 </span><span style="color:navy">jb      short </span><span style="color:gray">InternalError
</span><span style="color:black">DOSCODE:8BBD
DOSCODE:8BBD </span><span style="color:gray">Build_devJ</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8BBD                 </span><span style="color:navy">mov     al, ds:</span>SATTRIB
<span style="color:black">DOSCODE:8BC0                 </span><span style="color:navy">mov     ds:</span>ATTRIB<span style="color:navy">, al
</span><span style="color:black">DOSCODE:8BC3                 </span><span style="color:navy">call    </span>set_exerr_locus_unk
<span style="color:black">DOSCODE:8BC6                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:8BC7                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:8BC8                 </span><span style="color:navy">mov     si, offset </span>NAME1
<span style="color:black">DOSCODE:8BCB                 </span><span style="color:navy">mov     di, ds:</span>WFP_START
<span style="color:black">DOSCODE:8BCF                 </span><span style="color:navy">mov     dx, di
</span><span style="color:black">DOSCODE:8BD1                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">8           </span>; 8 chars in device name
<span style="color:black">DOSCODE:8BD4
DOSCODE:8BD4 </span><span style="color:gray">MoveLoop</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8BD4                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:8BD5                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:8BD6                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">DOSCODE:8BD8                 </span><span style="color:navy">jz      short </span><span style="color:gray">NoSave
</span><span style="color:black">DOSCODE:8BDA                 </span><span style="color:navy">mov     dx, di
</span><span style="color:black">DOSCODE:8BDC
DOSCODE:8BDC </span><span style="color:gray">NoSave</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8BDC                 </span><span style="color:navy">loop    </span><span style="color:gray">MoveLoop
</span><span style="color:black">DOSCODE:8BDE                 </span><span style="color:navy">mov     di, dx
</span><span style="color:black">DOSCODE:8BE0                 </span><span style="color:navy">mov     [di], cl        </span>; 0 ; end of string
<span style="color:black">DOSCODE:8BE2                 </span><span style="color:navy">call    </span>Build_device_ent ; Clears carry sets zero
<span style="color:black">DOSCODE:8BE5                 </span><span style="color:navy">inc     al              </span>; reset zero
<span style="color:black">DOSCODE:8BE7                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8BE8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8BE8
DOSCODE:8BE8 </span><span style="color:gray">InternalError</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8BE8                 </span><span style="color:navy">jmp     short </span><span style="color:gray">InternalError
</span><span style="color:black">DOSCODE:8BEA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8BEA
DOSCODE:8BEA </span><span style="color:gray">CrackIt</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8BEA                 </span><span style="color:navy">mov     ds:</span>ATTRIB<span style="color:navy">, </span><span style="color:#ff8000">16h  </span>; attr_directory+attr_system+attr_hidden
<span style="color:black">DOSCODE:8BEF                 </span><span style="color:navy">les     di, ds:</span>THISCDS
<span style="color:black">DOSCODE:8BF3                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:8BF6                 </span><span style="color:navy">mov     bx, es:[di+</span><span style="color:#ff8000">4Bh</span><span style="color:navy">] </span>; [ES:DI+curdir.ID+2]
<span style="color:black">DOSCODE:8BFA                 </span><span style="color:navy">mov     ds:</span>ROOTCLUST_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:8BFE                 </span><span style="color:navy">mov     bx, es:[di+</span><span style="color:#ff8000">49h</span><span style="color:navy">] </span>; [ES:DI+curdir.ID]
<span style="color:black">DOSCODE:8C02                 </span><span style="color:navy">mov     si, ds:</span>CURR_DIR_END
<span style="color:black">DOSCODE:8C06                 </span><span style="color:navy">cmp     si, ax          </span>; if Current directory is not part
<span style="color:black">DOSCODE:8C08                 </span><span style="color:navy">jz      short </span><span style="color:gray">NO_CURR_D </span>; then we must crack from root
<span style="color:black">DOSCODE:8C0A                 </span><span style="color:navy">cmp     ds:</span>ROOTCLUST_HW<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8C0E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">CrackIt2
</span><span style="color:black">DOSCODE:8C10                 </span><span style="color:navy">cmp     bx, ax          </span>; is the current directory cluster valid
<span style="color:black">DOSCODE:8C12
DOSCODE:8C12 </span><span style="color:gray">CrackIt2</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8C12                 </span><span style="color:navy">jz      short </span><span style="color:gray">NO_CURR_D </span>; no, crack from the root
<span style="color:black">DOSCODE:8C14                 </span><span style="color:navy">test    ds:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:8C19                 </span><span style="color:navy">jz      short </span><span style="color:gray">GOT_SEARCH_CLUSTER
</span><span style="color:black">DOSCODE:8C1B                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:8C1C                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:8C1D                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:8C1E                 </span><span style="color:navy">push    word ptr [si-</span><span style="color:green">1</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:8C21                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:8C22                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:8C23                 </span><span style="color:navy">push    ds:</span>ROOTCLUST_HW
<span style="color:black">DOSCODE:8C27                 </span><span style="color:navy">mov     byte ptr [si-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8C2B                 </span><span style="color:navy">mov     si, ds:</span>WFP_START
<span style="color:black">DOSCODE:8C2F                 </span><span style="color:navy">mov     bx, offset </span>FastOpenTable
<span style="color:black">DOSCODE:8C32                 </span><span style="color:navy">mov     di, offset </span>Dir_Info_Buff
<span style="color:black">DOSCODE:8C35                 </span><span style="color:navy">mov     cx, offset </span>FastOpen_Ext_Info
<span style="color:black">DOSCODE:8C38                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; FONC_Look_up
<span style="color:black">DOSCODE:8C3A                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:8C3B                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:8C3C                 </span><span style="color:navy">call    dword ptr [bx+</span><span style="color:#ff8000">2</span><span style="color:navy">] </span>; call far [BX+fastopen_entry.name_caching]
<span style="color:black">DOSCODE:8C3F                 </span><span style="color:navy">jb      short </span><span style="color:gray">GO_Chk_end1
</span><span style="color:black">DOSCODE:8C41                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8C44                 </span><span style="color:navy">jz      short </span><span style="color:gray">GO_Chk_end
</span><span style="color:black">DOSCODE:8C46                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:8C47                 </span><span style="color:navy">jmp     short </span><span style="color:gray">GO_Chk_end
</span><span style="color:black">DOSCODE:8C49 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8C49
DOSCODE:8C49 </span><span style="color:gray">GO_Chk_end1</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8C49                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:8C4A
DOSCODE:8C4A </span><span style="color:gray">GO_Chk_end</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8C4A                 </span><span style="color:navy">pop     ds:</span>ROOTCLUST_HW
<span style="color:black">DOSCODE:8C4E                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:8C4F                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:8C50                 </span><span style="color:navy">pop     word ptr [si-</span><span style="color:green">1</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:8C53                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:8C54                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:8C55                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:8C56                 </span><span style="color:navy">jnb     short </span><span style="color:gray">GOT_SEARCH_CLUSTER </span>; crack based on cur dir
<span style="color:black">DOSCODE:8C58
DOSCODE:8C58 </span><span style="color:gray">NO_CURR_D</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8C58                 </span><span style="color:navy">mov     si, ds:</span>WFP_START
<span style="color:black">DOSCODE:8C5C                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:8C5F                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:8C63                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ROOTPATH
</span><span style="color:black">DOSCODE:8C65 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8C65
DOSCODE:8C65 </span><span style="color:gray">GOT_SEARCH_CLUSTER</span><span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8C65                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:8C69                 </span><span style="color:navy">call    </span>SETDIRSRCH
<span style="color:black">DOSCODE:8C6C                 </span><span style="color:navy">jnb     short </span><span style="color:gray">FINDPATH
</span><span style="color:black">DOSCODE:8C6E                 </span><span style="color:navy">xor     cl, cl          </span>; set zero
<span style="color:black">DOSCODE:8C70                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:8C71                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8C71 </span>GetPathNoSet    <span style="color:black">endp
DOSCODE:8C71
DOSCODE:8C72
DOSCODE:8C72 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8C72
DOSCODE:8C72
DOSCODE:8C72 </span>CHKDEV          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8C72                 </span><span style="color:navy">mov     si, di
</span><span style="color:black">DOSCODE:8C74                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:8C75                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:8C76                 </span><span style="color:navy">mov     di, offset </span>NAME1
<span style="color:black">DOSCODE:8C79                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">9
</span><span style="color:black">DOSCODE:8C7C
DOSCODE:8C7C </span><span style="color:gray">TESTLOOP</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8C7C                 </span><span style="color:navy">call    </span>GETLET
<span style="color:black">DOSCODE:8C7F                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2Eh </span><span style="color:gray">; &#039;.&#039;
</span><span style="color:black">DOSCODE:8C81                 </span><span style="color:navy">jz      short </span><span style="color:gray">TESTDEVICE
</span><span style="color:black">DOSCODE:8C83                 </span><span style="color:navy">call    </span>PATHCHRCMP
<span style="color:black">DOSCODE:8C86                 </span><span style="color:navy">jz      short </span><span style="color:gray">NOTDEV
</span><span style="color:black">DOSCODE:8C88                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:8C8A                 </span><span style="color:navy">jz      short </span><span style="color:gray">TESTDEVICE
</span><span style="color:black">DOSCODE:8C8C                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:8C8D                 </span><span style="color:navy">loop    </span><span style="color:gray">TESTLOOP
</span><span style="color:black">DOSCODE:8C8F
DOSCODE:8C8F </span><span style="color:gray">NOTDEV</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8C8F                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:8C90                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8C91 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8C91
DOSCODE:8C91 </span><span style="color:gray">TESTDEVICE</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8C91                 </span><span style="color:navy">inc     cx
</span><span style="color:black">DOSCODE:8C92                 </span><span style="color:navy">inc     cx
</span><span style="color:black">DOSCODE:8C93                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">DOSCODE:8C95                 </span><span style="color:navy">rep stosb
</span><span style="color:black">DOSCODE:8C97                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:8C98                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:8C99                 </span><span style="color:navy">call    </span>DEVNAME
<span style="color:black">DOSCODE:8C9C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8C9C </span>CHKDEV          <span style="color:black">endp
DOSCODE:8C9C
DOSCODE:8C9D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8C9D </span><span style="color:gray">; START OF FUNCTION CHUNK FOR GetPathNoSet
</span><span style="color:black">DOSCODE:8C9D
DOSCODE:8C9D </span><span style="color:gray">ROOTPATH</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8C9D                 </span><span style="color:navy">call    </span>SETROOTSRCH
<span style="color:black">DOSCODE:8CA0                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8CA3                 </span><span style="color:navy">jnz     short </span><span style="color:gray">FINDPATH
</span><span style="color:black">DOSCODE:8CA5                 </span><span style="color:navy">mov     al, ds:</span>SATTRIB
<span style="color:black">DOSCODE:8CA8                 </span><span style="color:navy">mov     ds:</span>ATTRIB<span style="color:navy">, al
</span><span style="color:black">DOSCODE:8CAB                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:8CAD                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8CAE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8CAE
DOSCODE:8CAE </span><span style="color:gray">FINDPATH</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8CAE                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:8CAF                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:8CB0                 </span><span style="color:navy">mov     di, si
</span><span style="color:black">DOSCODE:8CB2                 </span><span style="color:navy">mov     cx, ds:</span>DIRSTART ; Get start clus of dir being searched
<span style="color:black">DOSCODE:8CB6                 </span><span style="color:navy">cmp     ds:</span>CURR_DIR_END<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; -1
<span style="color:black">DOSCODE:8CBB                 </span><span style="color:navy">jz      short </span><span style="color:gray">NOIDS     </span>; No current dir part
<span style="color:black">DOSCODE:8CBD                 </span><span style="color:navy">cmp     di, ds:</span>CURR_DIR_END
<span style="color:black">DOSCODE:8CC1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOIDS     </span>; Not to current dir end yet
<span style="color:black">DOSCODE:8CC3                 </span><span style="color:navy">les     di, ds:</span>THISCDS
<span style="color:black">DOSCODE:8CC7                 </span><span style="color:navy">mov     ax, ds:</span>DIRSTART_HW
<span style="color:black">DOSCODE:8CCA                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4Bh</span><span style="color:navy">], ax </span>; [ES:DI+curdir.ID+2]
<span style="color:black">DOSCODE:8CCA                                         </span>; Set current directory cluster
<span style="color:black">DOSCODE:8CCE                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">49h</span><span style="color:navy">], cx </span>; [ES:DI+curdir.ID]
<span style="color:black">DOSCODE:8CD2
DOSCODE:8CD2 </span><span style="color:gray">NOIDS</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8CD2                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:8CD3                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:8CD4                 </span><span style="color:navy">mov     di, offset </span>NAME1
<span style="color:black">DOSCODE:8CD7                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2020h
</span><span style="color:black">DOSCODE:8CDA                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:8CDB                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:8CDC                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:8CDD                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:8CDE                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:8CDF                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:8CE0                 </span><span style="color:navy">mov     di, offset </span>NAME1
<span style="color:black">DOSCODE:8CE3                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:8CE5
DOSCODE:8CE5 </span><span style="color:gray">GetNam</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8CE5                 </span><span style="color:navy">inc     cl              </span>; not required ! (15/02/2024)
<span style="color:black">DOSCODE:8CE7                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:8CE8                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2Eh </span><span style="color:gray">; &#039;.&#039;
</span><span style="color:black">DOSCODE:8CEA                 </span><span style="color:navy">jz      short </span><span style="color:gray">_SetExt
</span><span style="color:black">DOSCODE:8CEC                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:8CEE                 </span><span style="color:navy">jz      short </span><span style="color:gray">_GetDone
</span><span style="color:black">DOSCODE:8CF0                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Ch </span><span style="color:gray">; &#039;\&#039;
</span><span style="color:black">DOSCODE:8CF2                 </span><span style="color:navy">jz      short </span><span style="color:gray">_GetDone
</span><span style="color:black">DOSCODE:8CF4                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3Fh </span><span style="color:gray">; &#039;?&#039;
</span><span style="color:black">DOSCODE:8CF6                 </span><span style="color:navy">jnz     short </span><span style="color:gray">StoNam
</span><span style="color:black">DOSCODE:8CF8                 </span><span style="color:navy">or      ah, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:8CFB
DOSCODE:8CFB </span><span style="color:gray">StoNam</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8CFB                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:8CFC                 </span><span style="color:navy">jmp     short </span><span style="color:gray">GetNam
</span><span style="color:black">DOSCODE:8CFE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8CFE
DOSCODE:8CFE </span><span style="color:gray">_SetExt</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8CFE                 </span><span style="color:navy">mov     di, (offset </span>NAME1<span style="color:navy">+</span><span style="color:green">8</span><span style="color:navy">)
</span><span style="color:black">DOSCODE:8D01
DOSCODE:8D01 </span><span style="color:gray">GetExt</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8D01                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:8D02                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:8D04                 </span><span style="color:navy">jz      short </span><span style="color:gray">_GetDone
</span><span style="color:black">DOSCODE:8D06                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Ch </span><span style="color:gray">; &#039;\&#039;
</span><span style="color:black">DOSCODE:8D08                 </span><span style="color:navy">jz      short </span><span style="color:gray">_GetDone
</span><span style="color:black">DOSCODE:8D0A                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3Fh </span><span style="color:gray">; &#039;?&#039;
</span><span style="color:black">DOSCODE:8D0C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">StoExt
</span><span style="color:black">DOSCODE:8D0E                 </span><span style="color:navy">or      ah, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:8D11
DOSCODE:8D11 </span><span style="color:gray">StoExt</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8D11                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:8D12                 </span><span style="color:navy">jmp     short </span><span style="color:gray">GetExt
</span><span style="color:black">DOSCODE:8D14 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8D14
DOSCODE:8D14 </span><span style="color:gray">_BADPATH_j</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8D14                 </span><span style="color:navy">jmp     </span><span style="color:gray">_BADPATH
</span><span style="color:black">DOSCODE:8D17 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8D17
DOSCODE:8D17 </span><span style="color:gray">_GetDone</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8D17                 </span><span style="color:navy">dec     si
</span><span style="color:black">DOSCODE:8D18                 </span><span style="color:navy">mov     cl, ah          </span>; 0 or 1
<span style="color:black">DOSCODE:8D1A                 </span><span style="color:navy">or      cl, </span><span style="color:green">80h
</span><span style="color:black">DOSCODE:8D1D                 </span><span style="color:navy">pop     di              </span>; Start of this element
<span style="color:black">DOSCODE:8D1E                 </span><span style="color:navy">pop     es              </span>; Restore ES:BP
<span style="color:black">DOSCODE:8D1F                 </span><span style="color:navy">cmp     si, di
</span><span style="color:black">DOSCODE:8D21                 </span><span style="color:navy">jz      short </span><span style="color:gray">_BADPATH_j </span>; NUL parse (two delims most likely)
<span style="color:black">DOSCODE:8D23
DOSCODE:8D23 </span>check_device<span style="color:navy">:
</span><span style="color:black">DOSCODE:8D23                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:8D24                 </span><span style="color:navy">mov     al, [si]
</span><span style="color:black">DOSCODE:8D26                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:8D28                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOT_LAST
</span><span style="color:black">DOSCODE:8D2A                 </span><span style="color:navy">mov     bh, ds:</span>SATTRIB
<span style="color:black">DOSCODE:8D2E                 </span><span style="color:navy">mov     ds:</span>ATTRIB<span style="color:navy">, bh
</span><span style="color:black">DOSCODE:8D32
DOSCODE:8D32 </span><span style="color:gray">NOT_LAST</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8D32                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:8D33                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:8D34                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:8D35                 </span><span style="color:navy">call    </span>DEVNAME
<span style="color:black">DOSCODE:8D38                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:8D39                 </span><span style="color:navy">jb      short </span><span style="color:gray">FindFile  </span>; Not a device
<span style="color:black">DOSCODE:8D3B                 </span><span style="color:navy">or      al, al          </span>; Test next char again
<span style="color:black">DOSCODE:8D3D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">FILEINPATH_j </span>; Device name in middle of path
<span style="color:black">DOSCODE:8D3F                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:8D40                 </span><span style="color:navy">jmp     </span><span style="color:gray">Build_devJ
</span><span style="color:black">DOSCODE:8D43 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8D43
DOSCODE:8D43 </span><span style="color:gray">BADPATHPOP_j</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8D43                 </span><span style="color:navy">jmp     </span><span style="color:gray">BADPATHPOP
</span><span style="color:black">DOSCODE:8D46 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8D46
DOSCODE:8D46 </span><span style="color:gray">FindFile</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8D46                 </span><span style="color:navy">cmp     ds:</span>NAME1<span style="color:navy">, </span><span style="color:#ff8000">0E5h
</span><span style="color:black">DOSCODE:8D4B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOE5
</span><span style="color:black">DOSCODE:8D4D                 </span><span style="color:navy">mov     ds:</span>NAME1<span style="color:navy">, </span><span style="color:#ff8000">5
</span><span style="color:black">DOSCODE:8D52
DOSCODE:8D52 </span><span style="color:gray">NOE5</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8D52                 </span><span style="color:navy">push    di              </span>; Start of this element
<span style="color:black">DOSCODE:8D53                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:8D54                 </span><span style="color:navy">push    cx              </span>; CL return from NameTrans
<span style="color:black">DOSCODE:8D55                 </span><span style="color:navy">call    </span>LookupPath      ; call fastopen to get dir entry
<span style="color:black">DOSCODE:8D58                 </span><span style="color:navy">jnb     short </span><span style="color:gray">DIR_FOUND </span>; found dir entry
<span style="color:black">DOSCODE:8D5A                 </span><span style="color:navy">call    </span>FINDENTRY
<span style="color:black">DOSCODE:8D5D
DOSCODE:8D5D </span><span style="color:gray">DIR_FOUND</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8D5D                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:8D5E                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:8D5F                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:8D60                 </span><span style="color:navy">jb      short </span><span style="color:gray">BADPATHPOP_j
</span><span style="color:black">DOSCODE:8D62                 </span><span style="color:navy">lds     di, ds:</span>CURBUF
<span style="color:black">DOSCODE:8D66                 </span><span style="color:navy">test    byte ptr [bx+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], </span><span style="color:green">10h </span>; [BX+dir_entry.dir_attr],attr_directory
<span style="color:black">DOSCODE:8D6A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GO_NEXT
</span><span style="color:black">DOSCODE:8D6C
DOSCODE:8D6C </span><span style="color:gray">FILEINPATH_j</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8D6C                 </span><span style="color:navy">jmp     </span><span style="color:gray">FILEINPATH      </span>; Error or end of path
<span style="color:black">DOSCODE:8D6F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8D6F
DOSCODE:8D6F </span><span style="color:gray">GO_NEXT</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8D6F                 </span><span style="color:navy">cmp     ss:</span>NoSetDir<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8D75                 </span><span style="color:navy">jz      short </span><span style="color:gray">SetDir
</span><span style="color:black">DOSCODE:8D77                 </span><span style="color:navy">mov     dx, di          </span>; Save pointer to entry
<span style="color:black">DOSCODE:8D79                 </span><span style="color:navy">mov     cx, ds
</span><span style="color:black">DOSCODE:8D7B                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:8D7C                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:8D7D                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:8D7E                 </span><span style="color:navy">test    ds:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">1 </span>; FastOpen_Set
<span style="color:black">DOSCODE:8D83                 </span><span style="color:navy">jz      short </span><span style="color:gray">_nofast
</span><span style="color:black">DOSCODE:8D85                 </span><span style="color:navy">test    ds:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">2 </span>; Lookup_Success
<span style="color:black">DOSCODE:8D8A                 </span><span style="color:navy">jz      short </span><span style="color:gray">_nofast
</span><span style="color:black">DOSCODE:8D8C                 </span><span style="color:navy">mov     di, ds:</span>Next_Element_Start ; no need to insert it again
<span style="color:black">DOSCODE:8D90
DOSCODE:8D90 </span><span style="color:gray">_nofast</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8D90                 </span><span style="color:navy">cmp     byte ptr [di], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:8D93                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NEXT_ONE
</span><span style="color:black">DOSCODE:8D95                 </span><span style="color:navy">jmp     </span><span style="color:gray">_SETRET
</span><span style="color:black">DOSCODE:8D98 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8D98
DOSCODE:8D98 </span><span style="color:gray">NEXT_ONE</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8D98                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:8D99                 </span><span style="color:navy">mov     di, dx
</span><span style="color:black">DOSCODE:8D9B                 </span><span style="color:navy">mov     ds, cx
</span><span style="color:black">DOSCODE:8D9D
DOSCODE:8D9D </span><span style="color:gray">SetDir</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8D9D                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:8D9F                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], dx </span>; cmp [es:bp+DPB.FAT_SIZE],0
<span style="color:black">DOSCODE:8DA3                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SetDir2
</span><span style="color:black">DOSCODE:8DA5                 </span><span style="color:navy">mov     dx, [si-</span><span style="color:green">6</span><span style="color:navy">]      </span>; dir_entry.dir_fclus_hi
<span style="color:black">DOSCODE:8DA8
DOSCODE:8DA8 </span><span style="color:gray">SetDir2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8DA8                 </span><span style="color:navy">mov     ss:</span>ROOTCLUST_HW<span style="color:navy">, dx </span>; 0
<span style="color:black">DOSCODE:8DAD                 </span><span style="color:navy">mov     dx, [si]        </span>; dir_entry.dir_first
<span style="color:black">DOSCODE:8DAF                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:8DB0                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:8DB1                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:8DB2                 </span><span style="color:navy">test    ds:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">2 </span>; Lookup_Success
<span style="color:black">DOSCODE:8DB7                 </span><span style="color:navy">jz      short </span><span style="color:gray">DO_NORMAL </span>; fastopen not in memory
<span style="color:black">DOSCODE:8DB7                                         </span>;  or path not not found
<span style="color:black">DOSCODE:8DB9                 </span><span style="color:navy">mov     bx, dx
</span><span style="color:black">DOSCODE:8DBB                 </span><span style="color:navy">mov     di, ds:</span>CLUSNUM  ; clusnum was set in LookupPath
<span style="color:black">DOSCODE:8DBF                 </span><span style="color:navy">push    ax              </span>; save device id (AH)
<span style="color:black">DOSCODE:8DC0                 </span><span style="color:navy">call    </span>SETDIRSRCH
<span style="color:black">DOSCODE:8DC3                 </span><span style="color:navy">pop     ax              </span>; restore device id (AH)
<span style="color:black">DOSCODE:8DC4                 </span><span style="color:navy">add     sp, </span><span style="color:green">2           </span>; pop ds in stack
<span style="color:black">DOSCODE:8DC7                 </span><span style="color:navy">jmp     short </span><span style="color:gray">FAST_OPEN_SKIP
</span><span style="color:black">DOSCODE:8DC9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8DC9
DOSCODE:8DC9 </span><span style="color:gray">DO_NORMAL</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8DC9                 </span><span style="color:navy">pop     ds              </span>; DS = [curbuf + 2]
<span style="color:black">DOSCODE:8DCA                 </span><span style="color:navy">sub     bx, di          </span>; Offset into sector of start of entry
<span style="color:black">DOSCODE:8DCC                 </span><span style="color:navy">sub     si, di          </span>; Offset into sector of dir_first
<span style="color:black">DOSCODE:8DCE                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:8DCF                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:8DD0                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:8DD1                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:8DD2                 </span><span style="color:navy">lds     bx, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [DI+BUFFINFO.buf_sector]
<span style="color:black">DOSCODE:8DD5                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:8DD6                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:8DD7                 </span><span style="color:navy">mov     bx, dx
</span><span style="color:black">DOSCODE:8DD9                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:8DDA                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:8DDB                 </span><span style="color:navy">call    </span>SETDIRSRCH
<span style="color:black">DOSCODE:8DDE                 </span><span style="color:navy">pop     ds:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:8DE2                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:8DE3                 </span><span style="color:navy">jb      short </span><span style="color:gray">SKIP_GETB
</span><span style="color:black">DOSCODE:8DE5                 </span><span style="color:navy">mov     ds:</span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">18h </span>; Allowed_RETRY+Allowed_FAIL
<span style="color:black">DOSCODE:8DEA                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">DOSCODE:8DEC                 </span><span style="color:navy">call    </span>GETBUFFR        ; Get the entry buffer back
<span style="color:black">DOSCODE:8DEF
DOSCODE:8DEF </span><span style="color:gray">SKIP_GETB</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8DEF                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:8DF0                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:8DF1                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:8DF2                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:8DF3                 </span><span style="color:navy">jnb     short </span><span style="color:gray">SET_THE_BUF
</span><span style="color:black">DOSCODE:8DF5                 </span><span style="color:navy">pop     di              </span>; Start of next element
<span style="color:black">DOSCODE:8DF6                 </span><span style="color:navy">mov     si, di          </span>; Point with SI
<span style="color:black">DOSCODE:8DF8                 </span><span style="color:navy">jmp     short </span><span style="color:gray">_BADPATH
</span><span style="color:black">DOSCODE:8DFA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8DFA
DOSCODE:8DFA </span><span style="color:gray">SET_THE_BUF</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8DFA                 </span><span style="color:navy">call    </span>SET_BUF_AS_DIR
<span style="color:black">DOSCODE:8DFD                 </span><span style="color:navy">mov     di, word ptr ds:</span>CURBUF
<span style="color:black">DOSCODE:8E01                 </span><span style="color:navy">add     si, di          </span>; Get the offsets back
<span style="color:black">DOSCODE:8E03                 </span><span style="color:navy">add     bx, di
</span><span style="color:black">DOSCODE:8E05
DOSCODE:8E05 </span><span style="color:gray">FAST_OPEN_SKIP</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8E05                 </span><span style="color:navy">pop     di              </span>; Start of next element
<span style="color:black">DOSCODE:8E06                 </span><span style="color:navy">call    </span>InsertPath      ; insert dir entry info
<span style="color:black">DOSCODE:8E09                 </span><span style="color:navy">mov     al, [di]
</span><span style="color:black">DOSCODE:8E0B                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:8E0D                 </span><span style="color:navy">jz      short </span><span style="color:gray">_SETRET   </span>; At end
<span style="color:black">DOSCODE:8E0F                 </span><span style="color:navy">inc     di              </span>; Skip over &quot;/&quot;
<span style="color:black">DOSCODE:8E10                 </span><span style="color:navy">mov     si, di          </span>; Point with SI
<span style="color:black">DOSCODE:8E12                 </span><span style="color:navy">call    </span>PATHCHRCMP
<span style="color:black">DOSCODE:8E15                 </span><span style="color:navy">jnz     short </span><span style="color:gray">find_bad_name </span>; oops
<span style="color:black">DOSCODE:8E17                 </span><span style="color:navy">jmp     </span><span style="color:gray">FINDPATH        </span>; Next element
<span style="color:black">DOSCODE:8E1A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8E1A
DOSCODE:8E1A </span><span style="color:gray">find_bad_name</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8E1A                 </span><span style="color:navy">dec     si              </span>; Undo above INC to get failure point
<span style="color:black">DOSCODE:8E1B
DOSCODE:8E1B </span><span style="color:gray">_BADPATH</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8E1B                 </span><span style="color:navy">xor     cl, cl          </span>; Set zero
<span style="color:black">DOSCODE:8E1D                 </span><span style="color:navy">jmp     short </span><span style="color:gray">BADPRET
</span><span style="color:black">DOSCODE:8E1F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8E1F
DOSCODE:8E1F </span><span style="color:gray">FILEINPATH</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8E1F                 </span><span style="color:navy">pop     di              </span>; Start of next element
<span style="color:black">DOSCODE:8E20                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:8E21                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:8E22                 </span><span style="color:navy">test    ds:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">1 </span>; FastOpen_Set
<span style="color:black">DOSCODE:8E27                 </span><span style="color:navy">jz      short </span><span style="color:gray">NO_FAST
</span><span style="color:black">DOSCODE:8E29                 </span><span style="color:navy">test    ds:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">2 </span>; Lookup_Success
<span style="color:black">DOSCODE:8E2E                 </span><span style="color:navy">jz      short </span><span style="color:gray">NO_FAST
</span><span style="color:black">DOSCODE:8E30                 </span><span style="color:navy">mov     di, ds:</span>Next_Element_Start
<span style="color:black">DOSCODE:8E34
DOSCODE:8E34 </span><span style="color:gray">NO_FAST</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8E34                 </span><span style="color:navy">mov     al, [di]
</span><span style="color:black">DOSCODE:8E36                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:8E38                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NO_FAST2
</span><span style="color:black">DOSCODE:8E3A                 </span><span style="color:navy">call    </span>InsertPath      ; insert dir entry info
<span style="color:black">DOSCODE:8E3D                 </span><span style="color:navy">inc     al              </span>; Reset zero
<span style="color:black">DOSCODE:8E3F
DOSCODE:8E3F </span><span style="color:gray">_SETRET</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8E3F                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8E40 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8E40
DOSCODE:8E40 </span><span style="color:gray">NO_FAST2</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8E40                 </span><span style="color:navy">mov     si, di          </span>; Path too long
<span style="color:black">DOSCODE:8E42                 </span><span style="color:navy">jmp     short </span><span style="color:gray">BADPRET
</span><span style="color:black">DOSCODE:8E44 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8E44
DOSCODE:8E44 </span><span style="color:gray">BADPATHPOP</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8E44                 </span><span style="color:navy">pop     si              </span>; Start of next element
<span style="color:black">DOSCODE:8E45                 </span><span style="color:navy">mov     al, [si]
</span><span style="color:black">DOSCODE:8E47                 </span><span style="color:navy">mov     si, di          </span>; Start of bad element
<span style="color:black">DOSCODE:8E49                 </span><span style="color:navy">or      al, al          </span>; zero if bad element is last,
<span style="color:black">DOSCODE:8E49                                         </span>; non-zero if path too long
<span style="color:black">DOSCODE:8E4B
DOSCODE:8E4B </span><span style="color:gray">BADPRET</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8E4B                 </span><span style="color:navy">mov     al, ds:</span>SATTRIB
<span style="color:black">DOSCODE:8E4E                 </span><span style="color:navy">mov     ds:</span>ATTRIB<span style="color:navy">, al   </span>; Make sure return correct
<span style="color:black">DOSCODE:8E51                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:8E52                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8E52 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR GetPathNoSet
</span><span style="color:black">DOSCODE:8E53
DOSCODE:8E53 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8E53
DOSCODE:8E53
DOSCODE:8E53 </span>STARTSRCH       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8E53                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:8E57                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:8E59                 </span><span style="color:navy">mov     ds:</span>LASTENT<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8E5C                 </span><span style="color:navy">mov     ds:</span>VOLID<span style="color:navy">, al    </span>; No volume ID found
<span style="color:black">DOSCODE:8E5F                 </span><span style="color:navy">dec     ax
</span><span style="color:black">DOSCODE:8E60                 </span><span style="color:navy">mov     ds:</span>ENTFREE<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8E63                 </span><span style="color:navy">mov     ds:</span>ENTLAST<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:8E66                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8E66 </span>STARTSRCH       <span style="color:black">endp
DOSCODE:8E66
DOSCODE:8E67
DOSCODE:8E67 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8E67
DOSCODE:8E67
DOSCODE:8E67 </span>MatchAttributes <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8E67                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:8E68                 </span><span style="color:navy">mov     al, ss:</span>ATTRIB
<span style="color:black">DOSCODE:8E6C                 </span><span style="color:navy">not     al
</span><span style="color:black">DOSCODE:8E6E                 </span><span style="color:navy">and     al, ch
</span><span style="color:black">DOSCODE:8E70                 </span><span style="color:navy">and     al, </span><span style="color:green">16h         </span>; attr_all
<span style="color:black">DOSCODE:8E72                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:8E73                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8E73 </span>MatchAttributes <span style="color:black">endp
DOSCODE:8E73
DOSCODE:8E74
DOSCODE:8E74 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8E74
DOSCODE:8E74
DOSCODE:8E74 </span>DEVNAME         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8E74                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:8E75                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:8E76                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:8E77                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:8E78                 </span><span style="color:navy">push    word ptr ds:</span>NAME1
<span style="color:black">DOSCODE:8E7C                 </span><span style="color:navy">cmp     ds:</span>NAME1<span style="color:navy">, </span><span style="color:#ff8000">5
</span><span style="color:black">DOSCODE:8E81                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOKTR
</span><span style="color:black">DOSCODE:8E83                 </span><span style="color:navy">mov     ds:</span>NAME1<span style="color:navy">, </span><span style="color:#ff8000">0E5h
</span><span style="color:black">DOSCODE:8E88
DOSCODE:8E88 </span><span style="color:gray">NOKTR</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8E88                 </span><span style="color:navy">test    ds:</span>ATTRIB<span style="color:navy">, </span><span style="color:green">8    </span>; attr_volume_id
<span style="color:black">DOSCODE:8E8D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">RET31
</span><span style="color:black">DOSCODE:8E8F                 </span><span style="color:navy">mov     si, offset </span>NULDEV
<span style="color:black">DOSCODE:8E92
DOSCODE:8E92 </span><span style="color:gray">LOOKIO</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8E92                 </span><span style="color:navy">test    word ptr [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">8000h </span>; [SI+SYSDEV.ATT],DEVTYP
<span style="color:black">DOSCODE:8E97                 </span><span style="color:navy">jz      short </span><span style="color:gray">SKIPDEV   </span>; Skip block devices (NET and LOCAL)
<span style="color:black">DOSCODE:8E99                 </span><span style="color:navy">mov     ax, si
</span><span style="color:black">DOSCODE:8E9B                 </span><span style="color:navy">add     si, </span><span style="color:green">10          </span>; SYSDEV.NAME
<span style="color:black">DOSCODE:8E9E                 </span><span style="color:navy">mov     di, offset </span>NAME1
<span style="color:black">DOSCODE:8EA1                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4           </span>; All devices are 8 letters
<span style="color:black">DOSCODE:8EA4                 </span><span style="color:navy">repe cmpsw              </span>; Check for name in list
<span style="color:black">DOSCODE:8EA6                 </span><span style="color:navy">xchg    ax, si
</span><span style="color:black">DOSCODE:8EA7                 </span><span style="color:navy">jz      short </span><span style="color:gray">IOCHK     </span>; Found it?
<span style="color:black">DOSCODE:8EA9
DOSCODE:8EA9 </span><span style="color:gray">SKIPDEV</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8EA9                 </span><span style="color:navy">lds     si, [si]        </span>; Get address of next device
<span style="color:black">DOSCODE:8EAB                 </span><span style="color:navy">cmp     si, </span><span style="color:green">0FFFFh      </span>; -1 ; At end of list?
<span style="color:black">DOSCODE:8EAE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">LOOKIO
</span><span style="color:black">DOSCODE:8EB0
DOSCODE:8EB0 </span><span style="color:gray">RET31</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8EB0                 </span><span style="color:navy">stc                     </span>; Not found
<span style="color:black">DOSCODE:8EB1
DOSCODE:8EB1 </span><span style="color:gray">RETNV</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8EB1                 </span><span style="color:navy">mov     cx, ss
</span><span style="color:black">DOSCODE:8EB3                 </span><span style="color:navy">mov     ds, cx
</span><span style="color:black">DOSCODE:8EB5                 </span><span style="color:navy">pop     word ptr ds:</span>NAME1
<span style="color:black">DOSCODE:8EB9                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:8EBA                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:8EBB                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:8EBC                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:8EBD                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8EBE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8EBE
DOSCODE:8EBE </span><span style="color:gray">IOCHK</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8EBE                 </span><span style="color:navy">mov     word ptr ss:</span>DEVPT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds </span>; Save pointer to device
<span style="color:black">DOSCODE:8EC3                 </span><span style="color:navy">mov     bh, [si+</span><span style="color:#ff8000">4</span><span style="color:navy">]      </span>; [SI+SYSDEV.ATT]
<span style="color:black">DOSCODE:8EC6                 </span><span style="color:navy">or      bh, </span><span style="color:green">0C0h
</span><span style="color:black">DOSCODE:8EC9                 </span><span style="color:navy">and     bh, </span><span style="color:green">0DFh        </span>; ~(020h)
<span style="color:black">DOSCODE:8ECC                 </span><span style="color:navy">mov     word ptr ss:</span>DEVPT<span style="color:navy">, si
</span><span style="color:black">DOSCODE:8ED1                 </span><span style="color:navy">jmp     short </span><span style="color:gray">RETNV
</span><span style="color:black">DOSCODE:8ED1 </span>DEVNAME         <span style="color:black">endp
DOSCODE:8ED1
DOSCODE:8ED3
DOSCODE:8ED3 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8ED3
DOSCODE:8ED3
DOSCODE:8ED3 </span>Build_device_ent <span style="color:black">proc near              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8ED3                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2020h
</span><span style="color:black">DOSCODE:8ED6                 </span><span style="color:navy">mov     di, (offset </span>NAME1<span style="color:navy">+</span><span style="color:green">8</span><span style="color:navy">) </span>; DEVFCB+8 ; Point to extent field
<span style="color:black">DOSCODE:8ED9                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:8EDA                 </span><span style="color:navy">stosb                   </span>; Blank out extent field
<span style="color:black">DOSCODE:8EDB                 </span><span style="color:navy">mov     al, </span><span style="color:green">40h         </span>; attr_device
<span style="color:black">DOSCODE:8EDD                 </span><span style="color:navy">stosb                   </span>; Set attribute field
<span style="color:black">DOSCODE:8EDE                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:8EE0                 </span><span style="color:navy">mov     cx, </span><span style="color:green">10
</span><span style="color:black">DOSCODE:8EE3                 </span><span style="color:navy">rep stosw
</span><span style="color:black">DOSCODE:8EE5                 </span><span style="color:navy">call    </span>DATE16
<span style="color:black">DOSCODE:8EE8                 </span><span style="color:navy">mov     di, (offset </span>NAME2<span style="color:navy">+</span><span style="color:green">0Ah</span><span style="color:navy">) </span>; DEVFCB+dir_entry.dir_time
<span style="color:black">DOSCODE:8EEB                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:black">DOSCODE:8EEC                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:8EED                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:black">DOSCODE:8EEE                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:8EEF                 </span><span style="color:navy">mov     si, di          </span>; SI points to dir_first field
<span style="color:black">DOSCODE:8EF1                 </span><span style="color:navy">mov     ax, word ptr ds:</span>DEVPT
<span style="color:black">DOSCODE:8EF4                 </span><span style="color:navy">stosw                   </span>; Dir_first points to device
<span style="color:black">DOSCODE:8EF5                 </span><span style="color:navy">mov     ax, word ptr ds:</span>DEVPT<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:8EF8                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:8EF9                 </span><span style="color:navy">mov     ah, bh          </span>; Put device atts in AH
<span style="color:black">DOSCODE:8EFB                 </span><span style="color:navy">mov     bx, offset </span>NAME1 ; DEVFCB
<span style="color:black">DOSCODE:8EFE                 </span><span style="color:navy">xor     al, al          </span>; Set zero, clear carry
<span style="color:black">DOSCODE:8F00                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8F00 </span>Build_device_ent <span style="color:black">endp
DOSCODE:8F00
DOSCODE:8F01
DOSCODE:8F01 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8F01
DOSCODE:8F01 </span><span style="color:gray">; Attributes: bp-based frame
</span><span style="color:black">DOSCODE:8F01
DOSCODE:8F01 </span>ValidateCDS     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8F01
DOSCODE:8F01 </span><span style="color:green">SaveCDS         </span><span style="color:navy">= dword ptr </span><span style="color:#008040">-6
</span><span style="color:black">DOSCODE:8F01 </span><span style="color:green">Temp            </span><span style="color:navy">= word ptr </span><span style="color:#008040">-2
</span><span style="color:black">DOSCODE:8F01
DOSCODE:8F01                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:8F02                 </span><span style="color:navy">mov     bp, sp
</span><span style="color:black">DOSCODE:8F04                 </span><span style="color:navy">sub     sp, </span><span style="color:green">6
</span><span style="color:black">DOSCODE:8F07                 </span><span style="color:navy">mov     [bp+</span><span style="color:green">Temp</span><span style="color:navy">], di
</span><span style="color:black">DOSCODE:8F0A                 </span><span style="color:navy">lds     si, ss:</span>THISCDS
<span style="color:black">DOSCODE:8F0F                 </span><span style="color:navy">mov     word ptr [bp+</span><span style="color:green">SaveCDS</span><span style="color:navy">], si
</span><span style="color:black">DOSCODE:8F12                 </span><span style="color:navy">mov     word ptr [bp+</span><span style="color:green">SaveCDS</span><span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">], ds
</span><span style="color:black">DOSCODE:8F15                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:8F18                 </span><span style="color:navy">test    word ptr [si+</span><span style="color:#ff8000">43h</span><span style="color:navy">], </span><span style="color:green">8000h </span>; [SI+curdir.flags],curdir_isnet
<span style="color:black">DOSCODE:8F1D                 </span><span style="color:navy">jz      short </span><span style="color:gray">_DoSplice
</span><span style="color:black">DOSCODE:8F1F                 </span><span style="color:navy">jmp     </span><span style="color:gray">FatFail
</span><span style="color:black">DOSCODE:8F22 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:8F22
DOSCODE:8F22 </span><span style="color:gray">_DoSplice</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8F22                 </span><span style="color:navy">xor     dl, dl
</span><span style="color:black">DOSCODE:8F24                 </span><span style="color:navy">xchg    dl, ss:</span>NoSetDir
<span style="color:black">DOSCODE:8F29                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:8F2A                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:8F2B                 </span><span style="color:navy">call    </span>FStrCpy
<span style="color:black">DOSCODE:8F2E                 </span><span style="color:navy">mov     si, [bp+</span><span style="color:green">Temp</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:8F31                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:8F32                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:8F33                 </span><span style="color:navy">call    </span>Splice
<span style="color:black">DOSCODE:8F36                 </span><span style="color:navy">push    ss              </span>; FatReadCDS (ThisCDS);
<span style="color:black">DOSCODE:8F37                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:8F38                 </span><span style="color:navy">mov     ds:</span>NoSetDir<span style="color:navy">, dl
</span><span style="color:black">DOSCODE:8F3C                 </span><span style="color:navy">les     di, ds:</span>THISCDS
<span style="color:black">DOSCODE:8F40                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:8F41                 </span><span style="color:navy">call    </span>FATREAD_CDS
<span style="color:black">DOSCODE:8F44                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:8F45                 </span><span style="color:navy">jb      short </span><span style="color:gray">FatFail
</span><span style="color:black">DOSCODE:8F47                 </span><span style="color:navy">lds     si, ds:</span>THISCDS
<span style="color:black">DOSCODE:8F4B                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">4Bh</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; if (ThisCDS-&gt;ID == -1) {
<span style="color:black">DOSCODE:8F4F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_DoSplice2
</span><span style="color:black">DOSCODE:8F51                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">49h</span><span style="color:navy">], </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:8F55
DOSCODE:8F55 </span><span style="color:gray">_DoSplice2</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8F55                 </span><span style="color:navy">jnz     short </span><span style="color:gray">RestoreCDS
</span><span style="color:black">DOSCODE:8F57                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:8F58                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:8F59                 </span><span style="color:navy">push    ss:</span>WFP_START
<span style="color:black">DOSCODE:8F5E                 </span><span style="color:navy">cmp     si, word ptr [bp+</span><span style="color:green">SaveCDS</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:8F61                 </span><span style="color:navy">jnz     short </span><span style="color:gray">DoChdir
</span><span style="color:black">DOSCODE:8F63                 </span><span style="color:navy">mov     di, [bp+</span><span style="color:green">Temp</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:8F66                 </span><span style="color:navy">mov     ss:</span>WFP_START<span style="color:navy">, di
</span><span style="color:black">DOSCODE:8F6B                 </span><span style="color:navy">call    </span>FStrCpy
<span style="color:black">DOSCODE:8F6E
DOSCODE:8F6E </span><span style="color:gray">DoChdir</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8F6E                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:8F6F                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:8F70                 </span><span style="color:navy">push    word ptr ds:</span>SATTRIB
<span style="color:black">DOSCODE:8F74                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:8F75                 </span><span style="color:navy">call    </span>DOS_CHDIR
<span style="color:black">DOSCODE:8F78                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:8F79                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:8F7A                 </span><span style="color:navy">pop     ds:</span>WFP_START
<span style="color:black">DOSCODE:8F7E                 </span><span style="color:navy">mov     ds:</span>SATTRIB<span style="color:navy">, bl
</span><span style="color:black">DOSCODE:8F82                 </span><span style="color:navy">mov     di, ds:</span>DIRSTART_HW
<span style="color:black">DOSCODE:8F86                 </span><span style="color:navy">lds     si, [bp+</span><span style="color:green">SaveCDS</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:8F89                 </span><span style="color:navy">jnb     short </span><span style="color:gray">SetCluster
</span><span style="color:black">DOSCODE:8F8B                 </span><span style="color:navy">mov     word ptr ss:</span>THISCDS<span style="color:navy">, si
</span><span style="color:black">DOSCODE:8F90                 </span><span style="color:navy">mov     word ptr ss:</span>THISCDS<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:black">DOSCODE:8F95                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:8F97                 </span><span style="color:navy">xor     di, di
</span><span style="color:black">DOSCODE:8F99                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">3</span><span style="color:navy">], cl
</span><span style="color:black">DOSCODE:8F9C
DOSCODE:8F9C </span><span style="color:gray">SetCluster</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8F9C                 </span><span style="color:navy">lds     si, ss:</span>THISCDS
<span style="color:black">DOSCODE:8FA1                 </span><span style="color:navy">test    word ptr [si+</span><span style="color:#ff8000">43h</span><span style="color:navy">], </span><span style="color:green">2000h </span>; [SI+curdir.flags],curdir_splice
<span style="color:black">DOSCODE:8FA6                 </span><span style="color:navy">jz      short </span><span style="color:gray">_setdirclus
</span><span style="color:black">DOSCODE:8FA8                 </span><span style="color:navy">mov     cx, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:black">DOSCODE:8FAB                 </span><span style="color:navy">mov     di, cx
</span><span style="color:black">DOSCODE:8FAD
DOSCODE:8FAD </span><span style="color:gray">_setdirclus</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8FAD                 </span><span style="color:navy">mov     ss:</span>DIRSTART_HW<span style="color:navy">, di
</span><span style="color:black">DOSCODE:8FB2                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4Bh</span><span style="color:navy">], di    </span>; [SI+curdir.ID+2]
<span style="color:black">DOSCODE:8FB5                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">49h</span><span style="color:navy">], cx    </span>; [SI+curdir.ID]
<span style="color:black">DOSCODE:8FB8
DOSCODE:8FB8 </span><span style="color:gray">RestoreCDS</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8FB8                 </span><span style="color:navy">les     di, [bp+</span><span style="color:green">SaveCDS</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:8FBB                 </span><span style="color:navy">mov     word ptr ss:</span>THISCDS<span style="color:navy">, di
</span><span style="color:black">DOSCODE:8FC0                 </span><span style="color:navy">mov     word ptr ss:</span>THISCDS<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:8FC5                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:8FC6
DOSCODE:8FC6 </span><span style="color:gray">FatFail</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8FC6                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:8FC9                 </span><span style="color:navy">les     di, [bp+</span><span style="color:green">SaveCDS</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:8FCC                 </span><span style="color:navy">mov     sp, bp
</span><span style="color:black">DOSCODE:8FCE                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:8FCF                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:8FCF </span>ValidateCDS     <span style="color:black">endp
DOSCODE:8FCF
DOSCODE:8FD0
DOSCODE:8FD0 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:8FD0
DOSCODE:8FD0
DOSCODE:8FD0 </span>CheckThisDevice <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8FD0                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:8FD1                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:8FD2                 </span><span style="color:navy">mov     di, si
</span><span style="color:black">DOSCODE:8FD4                 </span><span style="color:navy">mov     al, [si]
</span><span style="color:black">DOSCODE:8FD6                 </span><span style="color:navy">call    </span>PATHCHRCMP      ; is it a path char?
<span style="color:black">DOSCODE:8FD9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ParseDev  </span>; no, go attempt to parse device
<span style="color:black">DOSCODE:8FDB                 </span><span style="color:navy">inc     si              </span>; simulate LODSB
<span style="color:black">DOSCODE:8FDC                 </span><span style="color:navy">lodsw
</span><span style="color:black">DOSCODE:8FDD                 </span><span style="color:navy">or      ax, </span><span style="color:green">2020h
</span><span style="color:black">DOSCODE:8FE0                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">6564h       </span>; cmp ax,&#039;de&#039; ; (NASM syntax)
<span style="color:black">DOSCODE:8FE3                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NotDevice </span>; assume not device
<span style="color:black">DOSCODE:8FE5                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:8FE6                 </span><span style="color:navy">or      al, </span><span style="color:green">20h
</span><span style="color:black">DOSCODE:8FE8                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">76h </span><span style="color:gray">; &#039;v&#039;   </span>; cmp al,&#039;v&#039;
<span style="color:black">DOSCODE:8FEA                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NotDevice </span>; assume not device
<span style="color:black">DOSCODE:8FEC                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:8FED                 </span><span style="color:navy">call    </span>PATHCHRCMP      ; do we have the last path separator?
<span style="color:black">DOSCODE:8FF0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NotDevice </span>; no. go for it.
<span style="color:black">DOSCODE:8FF2
DOSCODE:8FF2 </span><span style="color:gray">ParseDev</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:8FF2                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:8FF3                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:8FF4                 </span><span style="color:navy">call    </span>NameTrans
<span style="color:black">DOSCODE:8FF7                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0 </span>; parse entire string?
<span style="color:black">DOSCODE:8FFA                 </span><span style="color:navy">stc                     </span>; simulate a Carry return from DevName
<span style="color:black">DOSCODE:8FFB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SkipSearch </span>; no parse. simulate a file return.
<span style="color:black">DOSCODE:8FFD                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:8FFE                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:8FFF                 </span><span style="color:navy">mov     al, ds:</span>SATTRIB
<span style="color:black">DOSCODE:9002                 </span><span style="color:navy">mov     ds:</span>ATTRIB<span style="color:navy">, al   </span>; set Attrib for DevName
<span style="color:black">DOSCODE:9005                 </span><span style="color:navy">call    </span>DEVNAME
<span style="color:black">DOSCODE:9008
DOSCODE:9008 </span><span style="color:gray">SkipSearch</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9008                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:9009                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:900A
DOSCODE:900A </span><span style="color:gray">CheckReturn</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:900A                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:900B                 </span><span style="color:navy">jnb     short </span><span style="color:gray">Check_Done </span>; if device then do not reset pointer
<span style="color:black">DOSCODE:900D                 </span><span style="color:navy">mov     si, di
</span><span style="color:black">DOSCODE:900F
DOSCODE:900F </span><span style="color:gray">Check_Done</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:900F                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:9010                 </span><span style="color:navy">cmc                     </span>; invert carry. Carry =&gt; device
<span style="color:black">DOSCODE:9011                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9012 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9012
DOSCODE:9012 </span><span style="color:gray">NotDevice</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9012                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:9013                 </span><span style="color:navy">jmp     short </span><span style="color:gray">CheckReturn
</span><span style="color:black">DOSCODE:9013 </span>CheckThisDevice <span style="color:black">endp
DOSCODE:9013
DOSCODE:9015
DOSCODE:9015 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9015
DOSCODE:9015
DOSCODE:9015 </span>LookupPath      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9015                 </span><span style="color:navy">test    ss:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">1 </span>; FastOpen_Set
<span style="color:black">DOSCODE:901B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">FASTINST  </span>; flg is set in DOSOPEN
<span style="color:black">DOSCODE:901D
DOSCODE:901D </span><span style="color:gray">NOLOOK</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:901D                 </span><span style="color:navy">jmp     </span><span style="color:gray">NOLOOKUP
</span><span style="color:black">DOSCODE:9020 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9020
DOSCODE:9020 </span><span style="color:gray">FASTINST</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9020                 </span><span style="color:navy">test    ss:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">8 </span>; No_Lookup ; no more lookup?
<span style="color:black">DOSCODE:9026                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOLOOK    </span>; yes
<span style="color:black">DOSCODE:9028                 </span><span style="color:navy">mov     bx, offset </span>FastOpenTable
<span style="color:black">DOSCODE:902B                 </span><span style="color:navy">mov     si, ss:</span>WFP_START ; si points to path name
<span style="color:black">DOSCODE:9030                 </span><span style="color:navy">mov     di, offset </span>Dir_Info_Buff
<span style="color:black">DOSCODE:9033                 </span><span style="color:navy">mov     cx, offset </span>FastOpen_Ext_Info
<span style="color:black">DOSCODE:9036                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; FONC_Look_up
<span style="color:black">DOSCODE:9038                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:9039                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:903A                 </span><span style="color:navy">call    dword ptr [bx+</span><span style="color:#ff8000">2</span><span style="color:navy">] </span>; call far [BX+fastopen_entry.name_caching]
<span style="color:black">DOSCODE:903D                 </span><span style="color:navy">jnb     short </span><span style="color:gray">FASTINST2
</span><span style="color:black">DOSCODE:903F                 </span><span style="color:navy">jmp     </span><span style="color:gray">NOTFOUND        </span>; fastopen not in memory
<span style="color:black">DOSCODE:9042 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9042
DOSCODE:9042 </span><span style="color:gray">FASTINST2</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9042                 </span><span style="color:navy">lea     bx, [si-</span><span style="color:green">2</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:9045                 </span><span style="color:navy">cmp     bx, ss:</span>WFP_START ; path found ?
<span style="color:black">DOSCODE:904A                 </span><span style="color:navy">jz      short </span><span style="color:gray">NOTFOUND  </span>; no
<span style="color:black">DOSCODE:904C                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0 </span>; partiallyfound
<span style="color:black">DOSCODE:904F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">parfnd    </span>; is attribute matched ?
<span style="color:black">DOSCODE:9051                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:9052                 </span><span style="color:navy">mov     cl, ss:</span>ATTRIB
<span style="color:black">DOSCODE:9057                 </span><span style="color:navy">mov     ch, ss:</span>SATTRIB
<span style="color:black">DOSCODE:905C                 </span><span style="color:navy">mov     ss:</span>ATTRIB<span style="color:navy">, ch   </span>; attrib=sattrib
<span style="color:black">DOSCODE:9061                 </span><span style="color:navy">mov     ch, es:[di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">] </span>; [ES:DI+dir_entry.dir_attr]
<span style="color:black">DOSCODE:9065                 </span><span style="color:navy">call    </span>MatchAttributes
<span style="color:black">DOSCODE:9068                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:9069                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOLOOKUP  </span>; not matched
<span style="color:black">DOSCODE:906B                 </span><span style="color:navy">cmp     ss:</span>NoSetDir<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9071                 </span><span style="color:navy">jz      short </span><span style="color:gray">parfnd
</span><span style="color:black">DOSCODE:9073                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9076                 </span><span style="color:navy">jnz     short </span><span style="color:gray">parfnd
</span><span style="color:black">DOSCODE:9078                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], </span><span style="color:green">10h
</span><span style="color:black">DOSCODE:907D                 </span><span style="color:navy">jz      short </span><span style="color:gray">parfnd
</span><span style="color:black">DOSCODE:907F                 </span><span style="color:navy">mov     bx, cx
</span><span style="color:black">DOSCODE:9081                 </span><span style="color:navy">jmp     short </span><span style="color:gray">parfnd2
</span><span style="color:black">DOSCODE:9083 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9083
DOSCODE:9083 </span><span style="color:gray">parfnd</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9083                 </span><span style="color:navy">mov     bx, cx
</span><span style="color:black">DOSCODE:9085                 </span><span style="color:navy">mov     ax, [bx+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">]    </span>; [bx+FEI.dirstart]
<span style="color:black">DOSCODE:9088                 </span><span style="color:navy">mov     ss:</span>DIRSTART<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:908C                 </span><span style="color:navy">mov     ax, [bx+</span><span style="color:#ff8000">7</span><span style="color:navy">]      </span>; [bx+FEI.clusnum+2]
<span style="color:black">DOSCODE:908F                 </span><span style="color:navy">mov     ss:</span>CLUSNUM_HW<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:9093                 </span><span style="color:navy">mov     ax, [bx+</span><span style="color:#ff8000">5</span><span style="color:navy">]      </span>; [bx+FEI.clusnum]
<span style="color:black">DOSCODE:9096                 </span><span style="color:navy">mov     ss:</span>CLUSNUM<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:909A
DOSCODE:909A </span><span style="color:gray">parfnd2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:909A                 </span><span style="color:navy">mov     ss:</span>Next_Element_Start<span style="color:navy">, si
</span><span style="color:black">DOSCODE:909F                 </span><span style="color:navy">mov     ax, [bx+</span><span style="color:#ff8000">9</span><span style="color:navy">]      </span>; [bx+FEI.lastent]
<span style="color:black">DOSCODE:90A2                 </span><span style="color:navy">mov     ss:</span>LASTENT<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:90A6                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:90A7                 </span><span style="color:navy">les     bx, ss:</span>THISDPB
<span style="color:black">DOSCODE:90AC                 </span><span style="color:navy">mov     ah, es:[bx]     </span>; [ES:BX+DPB.DRIVE]
<span style="color:black">DOSCODE:90AF                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:90B0                 </span><span style="color:navy">mov     word ptr ss:</span>CURBUF<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; indicate not root dir
<span style="color:black">DOSCODE:90B7                 </span><span style="color:navy">mov     word ptr ss:</span>CURBUF<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es </span>; [curbuf+2].bx points to
<span style="color:black">DOSCODE:90BC                 </span><span style="color:navy">mov     bx, di          </span>; start of entry
<span style="color:black">DOSCODE:90BE                 </span><span style="color:navy">lea     si, [di+</span><span style="color:#ff8000">1Ah</span><span style="color:navy">]    </span>; [DI+dir_entry.dir_first]
<span style="color:black">DOSCODE:90BE                                         </span>; [curbuf+2]:si points to dir_first field
<span style="color:black">DOSCODE:90C1                 </span><span style="color:navy">or      ss:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">12h </span>; Lookup_Success+Set_For_Search
<span style="color:black">DOSCODE:90C7                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:90C8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:90C8
DOSCODE:90C8 </span><span style="color:gray">NOTFOUND</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:90C8                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh      </span>; -1  ; not in memory ?
<span style="color:black">DOSCODE:90CB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">Partial_Success </span>; yes, in memory
<span style="color:black">DOSCODE:90CD                 </span><span style="color:navy">mov     ss:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; no more fastopen
<span style="color:black">DOSCODE:90D3
DOSCODE:90D3 </span><span style="color:gray">Partial_Success</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:90D3                 </span><span style="color:navy">and     ss:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">0FBh </span>; Special_Fill_Reset
<span style="color:black">DOSCODE:90D9
DOSCODE:90D9 </span><span style="color:gray">NOLOOKUP</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:90D9                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:90DA                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:90DA </span>LookupPath      <span style="color:black">endp
DOSCODE:90DA
DOSCODE:90DB
DOSCODE:90DB </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:90DB
DOSCODE:90DB
DOSCODE:90DB </span>InsertPath      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:90DB                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:90DC                 </span><span style="color:navy">test    ss:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">1 </span>; FastOpen_Set
<span style="color:black">DOSCODE:90DC                                         </span>; only DOSOPEN can take advantage of
<span style="color:black">DOSCODE:90E2                 </span><span style="color:navy">jz      short </span><span style="color:gray">GET_NEXT_ELEMENT </span>; the FastOpen
<span style="color:black">DOSCODE:90E4                 </span><span style="color:navy">test    ss:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">2 </span>; Lookup_Success ; Lookup just happened
<span style="color:black">DOSCODE:90EA                 </span><span style="color:navy">jz      short </span><span style="color:gray">INSERT_DIR_INFO </span>; no
<span style="color:black">DOSCODE:90EC                 </span><span style="color:navy">and     ss:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">0FDh </span>; Lookup_Reset
<span style="color:black">DOSCODE:90EC                                         </span>; we got dir info from fastopen so
<span style="color:black">DOSCODE:90F2                 </span><span style="color:navy">mov     di, ss:</span>Next_Element_Start ; no need to insert it again
<span style="color:black">DOSCODE:90F7                 </span><span style="color:navy">jmp     short </span><span style="color:gray">GET_NEXT2
</span><span style="color:black">DOSCODE:90F9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:90F9
DOSCODE:90F9 </span><span style="color:gray">INSERT_DIR_INFO</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:90F9                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:90FA                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:90FB                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:90FC                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:90FD                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:90FE                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:90FF                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:9100                 </span><span style="color:navy">lds     di, ss:</span>CURBUF
<span style="color:black">DOSCODE:9105                 </span><span style="color:navy">mov     si, offset </span>FastOpen_Ext_Info
<span style="color:black">DOSCODE:9108                 </span><span style="color:navy">lds     ax, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [DI+BUFFINFO.buf_sector]
<span style="color:black">DOSCODE:9108                                         </span>; get directory sector
<span style="color:black">DOSCODE:910B                 </span><span style="color:navy">mov     ss:[si+</span><span style="color:#ff8000">1</span><span style="color:navy">], ax   </span>; [SS:SI+FEI.dirsec]
<span style="color:black">DOSCODE:910F                 </span><span style="color:navy">mov     word ptr ss:[si+</span><span style="color:#ff8000">3</span><span style="color:navy">], ds </span>; [SS:SI+FEI.dirsec+2]
<span style="color:black">DOSCODE:9113                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:9114                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:9115                 </span><span style="color:navy">mov     ax, ds:</span>CLUSNUM_HW ; save next cluster number
<span style="color:black">DOSCODE:9118                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">7</span><span style="color:navy">], ax      </span>; [si+FEI.clusnum+2]
<span style="color:black">DOSCODE:911B                 </span><span style="color:navy">mov     ax, ds:</span>CLUSNUM
<span style="color:black">DOSCODE:911E                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">5</span><span style="color:navy">], ax      </span>; [si+FEI.clusnum]
<span style="color:black">DOSCODE:9121                 </span><span style="color:navy">mov     ax, ds:</span>LASTENT  ; save lastentry for search first
<span style="color:black">DOSCODE:9124                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">9</span><span style="color:navy">], ax      </span>; [si+FEI.lastent]
<span style="color:black">DOSCODE:9127                 </span><span style="color:navy">mov     ax, ds:</span>DIRSTART ; save  for search first
<span style="color:black">DOSCODE:912A                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], ax    </span>; [si+FEI.dirstart]
<span style="color:black">DOSCODE:912D                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:black">DOSCODE:912F                 </span><span style="color:navy">add     di, </span><span style="color:green">24          </span>; BUFINSIZ
<span style="color:black">DOSCODE:9132                 </span><span style="color:navy">sub     ax, di          </span>; AX = relative to start of sector
<span style="color:black">DOSCODE:9134                 </span><span style="color:navy">mov     cl, </span><span style="color:green">32          </span>; dir_entry.size
<span style="color:black">DOSCODE:9136                 </span><span style="color:navy">div     cl
</span><span style="color:black">DOSCODE:9138                 </span><span style="color:navy">mov     [si], al        </span>; mov [si+FEI.dirpos],al
<span style="color:black">DOSCODE:9138                                         </span>; save directory entry # in buffer
<span style="color:black">DOSCODE:913A                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:913B                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:913C                 </span><span style="color:navy">mov     ds, word ptr ds:</span>CURBUF<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:9140                 </span><span style="color:navy">mov     di, bx
</span><span style="color:black">DOSCODE:9142                 </span><span style="color:navy">cmp     word ptr [di+</span><span style="color:#ff8000">1Ah</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [DI+dir_entry.dir_first]
<span style="color:black">DOSCODE:9142                                         </span>; never insert info when file is empty
<span style="color:black">DOSCODE:9146                 </span><span style="color:navy">jz      short </span><span style="color:gray">SKIP_INSERT </span>; newly created file
<span style="color:black">DOSCODE:9146                                         </span>;
<span style="color:black">DOSCODE:9146                                         </span>; ; 21/02/2024 - Erdogan Tan
<span style="color:black">DOSCODE:9146                                         </span>; ; Note: PCDOS 7.1 IBMDOS.COM code doesn&#039;t check high word
<span style="color:black">DOSCODE:9146                                         </span>; ;   of the 1st cluster here
<span style="color:black">DOSCODE:9146                                         </span>; ;;;
<span style="color:black">DOSCODE:9146                                         </span>; ; 21/02/2024 - Retro DOS v5.0
<span style="color:black">DOSCODE:9146                                         </span>; ;jnz    short dont_skip_insert
<span style="color:black">DOSCODE:9146                                         </span>; ;;cmp   word [di+14h],0
<span style="color:black">DOSCODE:9146                                         </span>; ;cmp    word [di+dir_entry.dir_fclus_hi],0
<span style="color:black">DOSCODE:9146                                         </span>; ;jz short SKIP_INSERT
<span style="color:black">DOSCODE:9146                                         </span>; ;dont_skip_insert:  ; Retro DOS v5.0
<span style="color:black">DOSCODE:9146                                         </span>; ;;;
<span style="color:black">DOSCODE:9148                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:9149                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:914A                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2           </span>; FONC_insert
<span style="color:black">DOSCODE:914A                                         </span>; call fastopen insert operation
<span style="color:black">DOSCODE:914C                 </span><span style="color:navy">mov     si, offset </span>FastOpenTable
<span style="color:black">DOSCODE:914F                 </span><span style="color:navy">call    dword ptr es:[si+</span><span style="color:#ff8000">2</span><span style="color:navy">] </span>; call far [ES:SI+fastopen_entry.name_caching]
<span style="color:black">DOSCODE:9153                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:9154
DOSCODE:9154 </span><span style="color:gray">SKIP_INSERT</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9154                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:9155                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:9156                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:9157                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:9158                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9159                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:915A                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:915B
DOSCODE:915B </span><span style="color:gray">GET_NEXT2</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:915B                 </span><span style="color:navy">or      ss:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">8 </span>; No_Lookup
<span style="color:black">DOSCODE:9161
DOSCODE:9161 </span><span style="color:gray">GET_NEXT_ELEMENT</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9161                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:9162                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9162 </span>InsertPath      <span style="color:black">endp
DOSCODE:9162
DOSCODE:9162 </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSCODE:9163 </span>LenTab          <span style="color:navy">db </span><span style="color:#008040">22                   </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:9163                                         </span>; length of packets
<span style="color:gray">DOSCODE:9163                                         </span>; DRDWRHL
<span style="color:gray">DOSCODE:9164                 </span><span style="color:navy">db </span><span style="color:#008040">14                   </span>; DRDNDHL
<span style="color:gray">DOSCODE:9165                 </span><span style="color:navy">db </span><span style="color:#008040">22                   </span>; DRDWRHL
<span style="color:gray">DOSCODE:9166                 </span><span style="color:navy">db </span><span style="color:#008040">13                   </span>; DSTATHL
<span style="color:gray">DOSCODE:9167                 </span><span style="color:navy">db </span><span style="color:#008040">13                   </span>; DFLSHL
<span style="color:gray">DOSCODE:9167                                         </span>; (This was 15 in MSDOS 6.22 MSDOS.SYS &amp; Win ME IO.SYS)
<span style="color:gray">DOSCODE:9168                 </span><span style="color:navy">db </span><span style="color:#008040">14                   </span>; DRDNDHL
<span style="color:gray">DOSCODE:9169 </span>CmdTab          <span style="color:navy">db </span><span style="color:#008040">86h                  </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:9169                                         </span>; 0 input
<span style="color:gray">DOSCODE:916A                 </span><span style="color:navy">db </span><span style="color:#008040">4                    </span>; DEVRD ; Read
<span style="color:gray">DOSCODE:916B                 </span><span style="color:navy">db </span><span style="color:#008040">86h                  </span>; 1 input status
<span style="color:gray">DOSCODE:916C                 </span><span style="color:navy">db </span><span style="color:#008040">5                    </span>; DEVRDND
<span style="color:gray">DOSCODE:916D                 </span><span style="color:navy">db </span><span style="color:#008040">87h                  </span>; 2 output
<span style="color:gray">DOSCODE:916E                 </span><span style="color:navy">db </span><span style="color:#008040">8                    </span>; DEVWRT ; Write
<span style="color:gray">DOSCODE:916F                 </span><span style="color:navy">db </span><span style="color:#008040">87h                  </span>; 3 output status
<span style="color:gray">DOSCODE:9170                 </span><span style="color:navy">db </span><span style="color:#008040">10                   </span>; DEVOST ; Output status
<span style="color:gray">DOSCODE:9171                 </span><span style="color:navy">db </span><span style="color:#008040">86h                  </span>; 4 input flush
<span style="color:gray">DOSCODE:9172                 </span><span style="color:navy">db </span><span style="color:#008040">7                    </span>; DEVIFL ; Input flush
<span style="color:gray">DOSCODE:9173                 </span><span style="color:navy">db </span><span style="color:#008040">86h                  </span>; 5 input status with system WAIT
<span style="color:gray">DOSCODE:9174                 </span><span style="color:navy">db </span><span style="color:#008040">5                    </span>; DEVRDND ; Non destructive read no wait (char devs)
<span style="color:black">DOSCODE:9175
DOSCODE:9175 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9175
DOSCODE:9175
DOSCODE:9175 </span>IOFUNC          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9175                 </span><span style="color:navy">mov     word ptr ss:</span>IOXAD<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ss
</span><span style="color:black">DOSCODE:917A                 </span><span style="color:navy">mov     word ptr ss:</span>IOXAD<span style="color:navy">, offset </span>DEVIOBUF
<span style="color:black">DOSCODE:9181                 </span><span style="color:navy">mov     ss:</span>IOSCNT<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:9188                 </span><span style="color:navy">mov     ss:</span>DEVIOBUF<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:918C                 </span><span style="color:navy">test    byte ptr [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:green">80h </span>; [SI+SF_ENTRY.sf_flags+1],(sf_isnet&gt;&gt;8)
<span style="color:black">DOSCODE:9190                 </span><span style="color:navy">jz      short </span><span style="color:gray">IOTO22
</span><span style="color:black">DOSCODE:9192                 </span><span style="color:navy">jmp     </span><span style="color:gray">IOTOFILE
</span><span style="color:black">DOSCODE:9195 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9195
DOSCODE:9195 </span><span style="color:gray">IOTO22</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9195                 </span><span style="color:navy">test    byte ptr [si+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">80h </span>; [SI+SF_ENTRY.sf_flags],devid_device
<span style="color:black">DOSCODE:9199                 </span><span style="color:navy">jnz     short </span><span style="color:gray">IOTO33
</span><span style="color:black">DOSCODE:919B                 </span><span style="color:navy">jmp     </span><span style="color:gray">IOTOFILE
</span><span style="color:black">DOSCODE:919E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:919E
DOSCODE:919E </span><span style="color:gray">IOTO33</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:919E                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:919F                 </span><span style="color:navy">call    </span>save_world
<span style="color:black">DOSCODE:91A2                 </span><span style="color:navy">mov     dx, ds
</span><span style="color:black">DOSCODE:91A4                 </span><span style="color:navy">mov     bx, ss
</span><span style="color:black">DOSCODE:91A6                 </span><span style="color:navy">mov     ds, bx
</span><span style="color:black">DOSCODE:91A8                 </span><span style="color:navy">mov     es, bx
</span><span style="color:black">DOSCODE:91AA                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:91AC                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">5           </span>; system wait enabled?
<span style="color:black">DOSCODE:91AF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">_no_sys_wait
</span><span style="color:black">DOSCODE:91B1                 </span><span style="color:navy">mov     bh, </span><span style="color:#ff8000">4           </span>; Set bit 10 in status word for driver
<span style="color:black">DOSCODE:91B3
DOSCODE:91B3 </span><span style="color:gray">_no_sys_wait</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:91B3                 </span><span style="color:navy">mov     ds:</span>IOCALL_REQSTAT<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:91B7                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:91B9                 </span><span style="color:navy">mov     ds:</span>IOMED<span style="color:navy">, bl
</span><span style="color:black">DOSCODE:91BD                 </span><span style="color:navy">mov     bl, ah          </span>; get function
<span style="color:black">DOSCODE:91BF                 </span><span style="color:navy">mov     ah, cs:</span>LenTab<span style="color:navy">[bx]
</span><span style="color:black">DOSCODE:91C4                 </span><span style="color:navy">add     bx, bx
</span><span style="color:black">DOSCODE:91C6                 </span><span style="color:navy">mov     cx, word ptr cs:</span>CmdTab<span style="color:navy">[bx]
</span><span style="color:black">DOSCODE:91CB                 </span><span style="color:navy">mov     bx, offset </span>IOCALL
<span style="color:black">DOSCODE:91CE                 </span><span style="color:navy">mov     ds:</span>IOCALL<span style="color:navy">, ah   </span>; [IOCALL_REQLEN]
<span style="color:black">DOSCODE:91D2                 </span><span style="color:navy">mov     ds:</span>IOCALL_REQFUNC<span style="color:navy">, ch
</span><span style="color:black">DOSCODE:91D6                 </span><span style="color:navy">mov     ds, dx
</span><span style="color:black">DOSCODE:91D8                 </span><span style="color:navy">call    </span>DEVIOCALL
<span style="color:black">DOSCODE:91DB                 </span><span style="color:navy">mov     di, ss:</span>IOCALL_REQSTAT
<span style="color:black">DOSCODE:91E0                 </span><span style="color:navy">and     di, di
</span><span style="color:black">DOSCODE:91E2                 </span><span style="color:navy">js      short </span><span style="color:gray">DevErr
</span><span style="color:black">DOSCODE:91E4
DOSCODE:91E4 </span><span style="color:gray">OKDevIO</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:91E4                 </span><span style="color:navy">mov     ax, ss
</span><span style="color:black">DOSCODE:91E6                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">DOSCODE:91E8                 </span><span style="color:navy">cmp     ch, </span><span style="color:#ff8000">5           </span>; DEVRDND
<span style="color:black">DOSCODE:91EB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">DNODRD
</span><span style="color:black">DOSCODE:91ED                 </span><span style="color:navy">mov     al, ds:</span>IOMED    ; [IORCHR]
<span style="color:black">DOSCODE:91F0                 </span><span style="color:navy">mov     byte ptr ds:</span>DEVIOBUF<span style="color:navy">, al
</span><span style="color:black">DOSCODE:91F3
DOSCODE:91F3 </span><span style="color:gray">DNODRD</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:91F3                 </span><span style="color:navy">mov     ah, byte ptr ds:</span>IOCALL_REQSTAT<span style="color:navy">+</span><span style="color:green">1
</span><span style="color:black">DOSCODE:91F7                 </span><span style="color:navy">not     ah              </span>; Zero = busy, not zero = ready
<span style="color:black">DOSCODE:91F9                 </span><span style="color:navy">and     ah, </span><span style="color:green">2           </span>; STBUI&gt;&gt;8
<span style="color:black">DOSCODE:91FC                 </span><span style="color:navy">call    </span>restore_world
<span style="color:black">DOSCODE:91FF                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:9200                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:9201                 </span><span style="color:navy">mov     al, ss:</span>IoStatFail ; assume fail error
<span style="color:black">DOSCODE:9205                 </span><span style="color:navy">cbw                     </span>; sign extend to word
<span style="color:black">DOSCODE:9206                 </span><span style="color:navy">inc     ax              </span>; 21/02/2024 - Erdogan Tan
<span style="color:black">DOSCODE:9206                                         </span>; this may be a BUG
<span style="color:black">DOSCODE:9206                                         </span>; MSDOS 6.22 MSDOS.SYS &amp; Win ME IO.SYS code is
<span style="color:black">DOSCODE:9206                                         </span>;  cbw
<span style="color:black">DOSCODE:9206                                         </span>;  cmp  ax,-1
<span style="color:black">DOSCODE:9206                                         </span>;  jne  short not_fail_ret
<span style="color:black">DOSCODE:9206                                         </span>;  inc  byte [ss:IoStatFail]
<span style="color:black">DOSCODE:9206                                         </span>;  popf
<span style="color:black">DOSCODE:9206                                         </span>;  retn
<span style="color:black">DOSCODE:9207                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_fail_ret
</span><span style="color:black">DOSCODE:9209                 </span><span style="color:navy">dec     ax
</span><span style="color:black">DOSCODE:920A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_fail_ret </span>; jns ?
<span style="color:black">DOSCODE:920C                 </span><span style="color:navy">inc     ss:</span>IoStatFail
<span style="color:black">DOSCODE:9211                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:9212                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9213 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9213
DOSCODE:9213 </span><span style="color:gray">not_fail_ret</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9213                 </span><span style="color:navy">mov     ax, ss:</span>DEVIOBUF
<span style="color:black">DOSCODE:9217                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:9218                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9219 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9219
DOSCODE:9219 </span><span style="color:gray">DevErr</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9219                 </span><span style="color:navy">mov     ah, cl
</span><span style="color:black">DOSCODE:921B                 </span><span style="color:navy">call    </span>CHARHARD
<span style="color:black">DOSCODE:921E                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:9220                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NO_RETRY
</span><span style="color:black">DOSCODE:9222                 </span><span style="color:navy">call    </span>restore_world
<span style="color:black">DOSCODE:9225                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:9226                 </span><span style="color:navy">jmp     </span>IOFUNC
<span style="color:black">DOSCODE:9229 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9229
DOSCODE:9229 </span><span style="color:gray">NO_RETRY</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9229                 </span><span style="color:navy">and     byte ptr ss:</span>IOCALL_REQSTAT<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:green">0FDh </span>; [SS:IOCALL_REQSTAT+1],
<span style="color:black">DOSCODE:9229                                         </span>; ~(STBUI&gt;&gt;8)
<span style="color:black">DOSCODE:922F                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:9231                 </span><span style="color:navy">jnz     short </span><span style="color:gray">not_fail
</span><span style="color:black">DOSCODE:9233                 </span><span style="color:navy">dec     ss:</span>IoStatFail   ; set flag indicating fail on I24
<span style="color:black">DOSCODE:9238
DOSCODE:9238 </span><span style="color:gray">not_fail</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9238                 </span><span style="color:navy">jmp     short </span><span style="color:gray">OKDevIO
</span><span style="color:black">DOSCODE:923A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:923A
DOSCODE:923A </span><span style="color:gray">IOTOFILE</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:923A                 </span><span style="color:navy">or      ah, ah
</span><span style="color:black">DOSCODE:923C                 </span><span style="color:navy">jz      short </span>IOIN
<span style="color:black">DOSCODE:923E                 </span><span style="color:navy">dec     ah
</span><span style="color:black">DOSCODE:9240                 </span><span style="color:navy">jz      short </span><span style="color:gray">IOIST
</span><span style="color:black">DOSCODE:9242                 </span><span style="color:navy">dec     ah
</span><span style="color:black">DOSCODE:9244                 </span><span style="color:navy">jz      short </span><span style="color:gray">IOUT
</span><span style="color:black">DOSCODE:9246                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9247 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9247
DOSCODE:9247 </span><span style="color:gray">IOIST</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9247                 </span><span style="color:navy">push    word ptr [si+</span><span style="color:#ff8000">15h</span><span style="color:navy">] </span>; [SI+SF_ENTRY.sf_position]
<span style="color:black">DOSCODE:924A                 </span><span style="color:navy">push    word ptr [si+</span><span style="color:#ff8000">17h</span><span style="color:navy">] </span>; [SI+SF_ENTRY.sf_position+2]
<span style="color:black">DOSCODE:924D                 </span><span style="color:navy">call    </span>IOIN
<span style="color:black">DOSCODE:9250 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9250                 </span><span style="color:navy">pop     word ptr [si+</span><span style="color:#ff8000">17h</span><span style="color:navy">] </span>; [SI+SF_ENTRY.sf_position+2]
<span style="color:black">DOSCODE:9253                 </span><span style="color:navy">pop     word ptr [si+</span><span style="color:#ff8000">15h</span><span style="color:navy">] </span>; [SI+SF_ENTRY.sf_position]
<span style="color:black">DOSCODE:9256                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9257 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9257
DOSCODE:9257 </span><span style="color:gray">IOUT</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9257                 </span><span style="color:navy">call    </span>SETXADDR
<span style="color:black">DOSCODE:925A                 </span><span style="color:navy">call    </span>DOS_WRITE
<span style="color:black">DOSCODE:925D                 </span><span style="color:navy">call    </span>RESTXADDR
<span style="color:black">DOSCODE:9260 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9260
DOSCODE:9260 </span>IOUT_retn<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9260                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9260 </span>IOFUNC          <span style="color:black">endp
DOSCODE:9260
DOSCODE:9261
DOSCODE:9261 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9261
DOSCODE:9261 </span><span style="color:gray">; Attributes: noreturn
</span><span style="color:black">DOSCODE:9261
DOSCODE:9261 </span>IOIN            <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9261                 </span><span style="color:navy">call    </span>SETXADDR
<span style="color:black">DOSCODE:9264                 </span><span style="color:navy">or      ss:</span>DOS34_FLAG<span style="color:navy">, </span><span style="color:green">40h </span>; Disable_EOF_I24
<span style="color:black">DOSCODE:926A                 </span><span style="color:navy">call    </span>DOS_READ
<span style="color:black">DOSCODE:926D                 </span><span style="color:navy">and     ss:</span>DOS34_FLAG<span style="color:navy">, </span><span style="color:green">0FFBFh </span>; NO_Disable_EOF_I24
<span style="color:black">DOSCODE:9273                 </span><span style="color:navy">or      cx, cx
</span><span style="color:black">DOSCODE:9275                 </span><span style="color:navy">call    </span>RESTXADDR
<span style="color:black">DOSCODE:9278 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9278                 </span><span style="color:navy">mov     al, byte ptr ss:</span>DEVIOBUF ; Get byte from trans addr
<span style="color:black">DOSCODE:927C                 </span><span style="color:navy">jnz     short </span>IOUT_retn
<span style="color:black">DOSCODE:927E                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1Ah         </span>; ^Z if no bytes
<span style="color:black">DOSCODE:9280                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9280 </span>IOIN            <span style="color:black">endp
DOSCODE:9280
DOSCODE:9281
DOSCODE:9281 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9281
DOSCODE:9281
DOSCODE:9281 </span>SETXADDR        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9281                 </span><span style="color:navy">pop     ss:</span>CALLBPB      ; [SS:CALLSCNT] ; Return address
<span style="color:black">DOSCODE:9286                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:9287                 </span><span style="color:navy">call    </span>save_world
<span style="color:black">DOSCODE:928A                 </span><span style="color:navy">mov     word ptr ss:</span>THISSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:black">DOSCODE:928F                 </span><span style="color:navy">lds     cx, ss:</span>DMAADD
<span style="color:black">DOSCODE:9294                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:9295                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:9296                 </span><span style="color:navy">lds     cx, ss:</span>IOXAD
<span style="color:black">DOSCODE:929B                 </span><span style="color:navy">mov     word ptr ss:</span>DMAADD<span style="color:navy">, cx </span>; Set byte trans addr
<span style="color:black">DOSCODE:92A0                 </span><span style="color:navy">mov     word ptr ss:</span>DMAADD<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:black">DOSCODE:92A5                 </span><span style="color:navy">mov     cx, ss
</span><span style="color:black">DOSCODE:92A7                 </span><span style="color:navy">mov     ds, cx
</span><span style="color:black">DOSCODE:92A9                 </span><span style="color:navy">mov     word ptr ds:</span>THISSFT<span style="color:navy">, si </span>; Finish setting SFT pointer
<span style="color:black">DOSCODE:92AD                 </span><span style="color:navy">mov     cx, ds:</span>IOSCNT   ; ioscnt specifies length of buffer
<span style="color:black">DOSCODE:92B1                 </span><span style="color:navy">jmp     ds:</span>CALLBPB      ; [CALLSCNT]
<span style="color:black">DOSCODE:92B1 </span>SETXADDR        <span style="color:black">endp
DOSCODE:92B1
DOSCODE:92B5
DOSCODE:92B5 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:92B5
DOSCODE:92B5 </span><span style="color:gray">; Attributes: noreturn
</span><span style="color:black">DOSCODE:92B5
DOSCODE:92B5 </span>RESTXADDR       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:92B5                 </span><span style="color:navy">pop     ds:</span>CALLBPB      ; [CALLSCNT] ; Return address
<span style="color:black">DOSCODE:92B9                 </span><span style="color:navy">pop     word ptr ds:</span>DMAADD<span style="color:navy">+</span><span style="color:green">2 </span>; Restore Disk trans addr
<span style="color:black">DOSCODE:92BD                 </span><span style="color:navy">pop     word ptr ds:</span>DMAADD
<span style="color:black">DOSCODE:92C1                 </span><span style="color:navy">call    </span>restore_world
<span style="color:black">DOSCODE:92C1 </span>RESTXADDR       <span style="color:black">endp
DOSCODE:92C1
</span><span style="color:maroon">DOSCODE:92C4                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:92C5                 </span><span style="color:navy">jmp     ss:</span>CALLBPB      ; [SS:CALLSCNT] ; Return address
<span style="color:black">DOSCODE:92CA
DOSCODE:92CA </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:92CA
DOSCODE:92CA
DOSCODE:92CA </span>DEV_OPEN_SFT    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:92CA                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:92CB                 </span><span style="color:navy">call    </span>save_world
<span style="color:black">DOSCODE:92CE                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Dh         </span>; DEVOPN
<span style="color:black">DOSCODE:92D0                 </span><span style="color:navy">jmp     short </span>DO_OPCLS
<span style="color:black">DOSCODE:92D0 </span>DEV_OPEN_SFT    <span style="color:black">endp
DOSCODE:92D0
DOSCODE:92D2
DOSCODE:92D2 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:92D2
DOSCODE:92D2
DOSCODE:92D2 </span>DEV_CLOSE_SFT   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:92D2                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:92D3                 </span><span style="color:navy">call    </span>save_world
<span style="color:black">DOSCODE:92D6                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Eh         </span>; DEVCLS
<span style="color:black">DOSCODE:92D8
DOSCODE:92D8 </span>DO_OPCLS<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:92D8                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:green">80h </span>; [es:di+SF_ENTRY.sf_flags+1],(sf_isnet&gt;&gt;8)
<span style="color:black">DOSCODE:92DD                 </span><span style="color:navy">jnz     short </span><span style="color:gray">OPCLS_DONE </span>; NOP on net SFTs
<span style="color:black">DOSCODE:92DF                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:92E1                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:DI+SF_ENTRY.sf_flags],devid_device
<span style="color:black">DOSCODE:92E6                 </span><span style="color:navy">les     di, es:[di+</span><span style="color:#ff8000">7</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_devptr] ; Get DPB or device
<span style="color:black">DOSCODE:92EA                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GOT_DEV_ADDR
</span><span style="color:black">DOSCODE:92EC                 </span><span style="color:navy">cmp     ss:</span>fShare<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:92F2                 </span><span style="color:navy">jbe     short </span><span style="color:gray">OPCLS_DONE
</span><span style="color:black">DOSCODE:92F4                 </span><span style="color:navy">mov     cx, es:[di]     </span>; [ES:DI+DPB.DRIVE]
<span style="color:black">DOSCODE:92F7                 </span><span style="color:navy">mov     ah, ch          </span>; [ES:DI+DPB.UNIT]
<span style="color:black">DOSCODE:92F9                 </span><span style="color:navy">les     di, es:[di+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [ES:DI+DPB.DRIVER_ADDR]
<span style="color:black">DOSCODE:92FD
DOSCODE:92FD </span><span style="color:gray">GOT_DEV_ADDR</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:92FD                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">8 </span>; [ES:DI+SYSDEV.ATT+1],(DEVOPCL&gt;&gt;8)
<span style="color:black">DOSCODE:9302                 </span><span style="color:navy">jz      short </span><span style="color:gray">OPCLS_DONE
</span><span style="color:black">DOSCODE:9304                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:9305                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:9306                 </span><span style="color:navy">mov     si, di          </span>; DS:SI -&gt; device
<span style="color:black">DOSCODE:9308
DOSCODE:9308 </span><span style="color:gray">OPCLS_RETRY</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9308                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:9309                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:930A                 </span><span style="color:navy">mov     di, offset </span>DEVCALL_REQLEN ; DEVCALL
<span style="color:black">DOSCODE:930D                 </span><span style="color:navy">mov     bx, di
</span><span style="color:black">DOSCODE:930F                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:9310                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Dh         </span>; DOPCLHL
<span style="color:black">DOSCODE:9312                 </span><span style="color:navy">stosb                   </span>; Length
<span style="color:black">DOSCODE:9313                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:9314                 </span><span style="color:navy">xchg    ah, al          </span>; Unit
<span style="color:black">DOSCODE:9316                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:9317                 </span><span style="color:navy">xchg    ah, al
</span><span style="color:black">DOSCODE:9319                 </span><span style="color:navy">mov     word ptr es:[di], </span><span style="color:#ff8000">0 </span>; Status
<span style="color:black">DOSCODE:931E                 </span><span style="color:navy">push    ax              </span>; Save Unit,Command
<span style="color:black">DOSCODE:931F                 </span><span style="color:navy">call    </span>DEVIOCALL2
<span style="color:black">DOSCODE:9322                 </span><span style="color:navy">mov     di, es:[bx+</span><span style="color:#ff8000">3</span><span style="color:navy">]   </span>; [ES:BX+SRHEAD.REQSTAT]
<span style="color:black">DOSCODE:9326                 </span><span style="color:navy">and     di, di
</span><span style="color:black">DOSCODE:9328                 </span><span style="color:navy">jns     short </span><span style="color:gray">OPCLS_DONEP </span>; No error
<span style="color:black">DOSCODE:932A                 </span><span style="color:navy">test    byte ptr [si+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">80h </span>; [SI+SYSDEV.ATT+1],(DEVTYP&gt;&gt;8)
<span style="color:black">DOSCODE:932E                 </span><span style="color:navy">jz      short </span><span style="color:gray">BLKDEV
</span><span style="color:black">DOSCODE:9330                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">86h         </span>; Read error in data, Char dev
<span style="color:black">DOSCODE:9332                 </span><span style="color:navy">jmp     short </span><span style="color:gray">HRDERR
</span><span style="color:black">DOSCODE:9334 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9334
DOSCODE:9334 </span><span style="color:gray">BLKDEV</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9334                 </span><span style="color:navy">mov     al, cl          </span>; Drive number
<span style="color:black">DOSCODE:9336                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">6           </span>; Read error in data, Blk dev
<span style="color:black">DOSCODE:9338
DOSCODE:9338 </span><span style="color:gray">HRDERR</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9338                 </span><span style="color:navy">call    </span>CHARHARD
<span style="color:black">DOSCODE:933B                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:933D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">OPCLS_DONEP </span>; IGNORE or FAIL
<span style="color:black">DOSCODE:933D                                         </span>; Note that FAIL is essentually IGNORED
<span style="color:black">DOSCODE:933F                 </span><span style="color:navy">pop     ax              </span>; Get back Unit, Command
<span style="color:black">DOSCODE:9340                 </span><span style="color:navy">jmp     short </span><span style="color:gray">OPCLS_RETRY
</span><span style="color:black">DOSCODE:9342 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9342
DOSCODE:9342 </span><span style="color:gray">OPCLS_DONEP</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9342                 </span><span style="color:navy">pop     ax              </span>; Clean stack
<span style="color:black">DOSCODE:9343
DOSCODE:9343 </span><span style="color:gray">OPCLS_DONE</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9343                 </span><span style="color:navy">call    </span>restore_world
<span style="color:black">DOSCODE:9346                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:9347                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9347 </span>DEV_CLOSE_SFT   <span style="color:black">endp
DOSCODE:9347
DOSCODE:9348
DOSCODE:9348 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9348
DOSCODE:9348
DOSCODE:9348 </span>DEVIOCALL       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9348                 </span><span style="color:navy">lds     si, [si+</span><span style="color:#ff8000">7</span><span style="color:navy">]      </span>; CALLNEWSC, HIGH_SECTOR &amp; CALLDEVAD
<span style="color:black">DOSCODE:9348 </span>DEVIOCALL       <span style="color:black">endp                    </span>; LDS SI,[SI+SF_ENTRY.sf_devptr]
<span style="color:black">DOSCODE:9348
DOSCODE:934B
DOSCODE:934B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:934B
DOSCODE:934B
DOSCODE:934B </span>DEVIOCALL2      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:934B                 </span><span style="color:navy">call    </span>ECritDevice
<span style="color:black">DOSCODE:934E                 </span><span style="color:navy">test    byte ptr [si+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">80h </span>; [SI+SYSDEV.ATT+1],(DEVTYP&gt;&gt;8)
<span style="color:black">DOSCODE:9352                 </span><span style="color:navy">jnz     short </span><span style="color:gray">chardev2
</span><span style="color:black">DOSCODE:9354                 </span><span style="color:navy">mov     al, es:[bx+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [ES:BX+SRHEAD.REQFUNC]
<span style="color:black">DOSCODE:9358                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">4           </span>; DEVRD
<span style="color:black">DOSCODE:935A                 </span><span style="color:navy">jz      short </span><span style="color:gray">chkext
</span><span style="color:black">DOSCODE:935C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">8           </span>; DEVWRT
<span style="color:black">DOSCODE:935E                 </span><span style="color:navy">jz      short </span><span style="color:gray">chkext
</span><span style="color:black">DOSCODE:9360                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">9           </span>; DEVWRTV
<span style="color:black">DOSCODE:9362                 </span><span style="color:navy">jnz     short </span><span style="color:gray">chardev2
</span><span style="color:black">DOSCODE:9364
DOSCODE:9364 </span><span style="color:gray">chkext</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9364                 </span><span style="color:navy">test    byte ptr [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">2 </span>; [SI+SYSDEV.ATT],EXTDRVR
<span style="color:black">DOSCODE:9368                 </span><span style="color:navy">jz      short </span><span style="color:gray">chksector
</span><span style="color:black">DOSCODE:936A                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh      </span>; -1 ; old sector
<span style="color:black">DOSCODE:936D                 </span><span style="color:navy">add     byte ptr es:[bx], </span><span style="color:#ff8000">8 </span>; make length to 30
<span style="color:black">DOSCODE:9371                 </span><span style="color:navy">xchg    ax, ss:</span>CALLSSEC
<span style="color:black">DOSCODE:9376                 </span><span style="color:navy">mov     ss:</span>CALLNEWSC<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:937A                 </span><span style="color:navy">mov     ax, ss:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:937E                 </span><span style="color:navy">mov     ss:</span>CALLNEWSC<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">DOSCODE:9382                 </span><span style="color:navy">jmp     short </span><span style="color:gray">chardev2
</span><span style="color:black">DOSCODE:9384 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9384
DOSCODE:9384 </span><span style="color:gray">chksector</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9384                 </span><span style="color:navy">cmp     ss:</span>HIGH_SECTOR<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; if &gt;32mb
<span style="color:black">DOSCODE:938A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">chardev3  </span>; then fake error
<span style="color:black">DOSCODE:938C
DOSCODE:938C </span><span style="color:gray">chardev2</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:938C                 </span><span style="color:navy">inc     ss:</span>DEVIO_IN_PROGRESS ; lock (deviocall in progress)
<span style="color:black">DOSCODE:9391                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [SI+SYSDEV.STRAT]
<span style="color:black">DOSCODE:9394                 </span><span style="color:navy">mov     word ptr ss:</span>CALLDEVAD<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:9398                 </span><span style="color:navy">mov     word ptr ss:</span>CALLDEVAD<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:black">DOSCODE:939D                 </span><span style="color:navy">call    ss:</span>CALLDEVAD
<span style="color:black">DOSCODE:93A2                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">8</span><span style="color:navy">]      </span>; [SI+SYSDEV.INT]
<span style="color:black">DOSCODE:93A5                 </span><span style="color:navy">mov     word ptr ss:</span>CALLDEVAD<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:93A9                 </span><span style="color:navy">call    ss:</span>CALLDEVAD
<span style="color:black">DOSCODE:93AE                 </span><span style="color:navy">dec     ss:</span>DEVIO_IN_PROGRESS ; unlock (deviocall completed)
<span style="color:black">DOSCODE:93B3
DOSCODE:93B3 </span><span style="color:gray">dev_exit</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:93B3                 </span><span style="color:navy">call    </span>LCritDevice
<span style="color:black">DOSCODE:93B6                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:93B7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:93B7
DOSCODE:93B7 </span><span style="color:gray">chardev3</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:93B7                 </span><span style="color:navy">mov     word ptr es:[bx+</span><span style="color:#ff8000">3</span><span style="color:navy">], </span><span style="color:green">8107h </span>; [ES:BX+SRHEAD.REQSTAT],
<span style="color:black">DOSCODE:93B7                                         </span>; STERR+STDON+error_I24_not_DOS_disk
<span style="color:black">DOSCODE:93BD                 </span><span style="color:navy">jmp     short </span><span style="color:gray">dev_exit
</span><span style="color:black">DOSCODE:93BD </span>DEVIOCALL2      <span style="color:black">endp
DOSCODE:93BD
DOSCODE:93BF
DOSCODE:93BF </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:93BF
DOSCODE:93BF
DOSCODE:93BF </span>SETREAD         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:93BF                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:93C0                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:93C1                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:93C2                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4           </span>; DEVRD
<span style="color:black">DOSCODE:93C4
DOSCODE:93C4 </span>SETCALLHEAD<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:93C4                 </span><span style="color:navy">mov     al, </span><span style="color:green">22          </span>; DRDWRHL
<span style="color:black">DOSCODE:93C6                 </span><span style="color:navy">mov     di, ss
</span><span style="color:black">DOSCODE:93C8                 </span><span style="color:navy">mov     es, di
</span><span style="color:black">DOSCODE:93CA                 </span><span style="color:navy">mov     di, offset </span>DEVCALL_REQLEN ; DEVCALL
<span style="color:black">DOSCODE:93CD                 </span><span style="color:navy">stosb                   </span>; length
<span style="color:black">DOSCODE:93CE                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:93CF                 </span><span style="color:navy">stosb                   </span>; Unit
<span style="color:black">DOSCODE:93D0                 </span><span style="color:navy">mov     es:[di], cl     </span>; Command code
<span style="color:black">DOSCODE:93D3                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:93D4                 </span><span style="color:navy">mov     word ptr es:[di], </span><span style="color:#ff8000">0 </span>; Status
<span style="color:black">DOSCODE:93D9                 </span><span style="color:navy">add     di, </span><span style="color:green">10
</span><span style="color:black">DOSCODE:93DC                 </span><span style="color:navy">mov     es:[di], ah     </span>; Media byte
<span style="color:black">DOSCODE:93DF                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:93E0                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">DOSCODE:93E2                 </span><span style="color:navy">mov     es:[di], bx     </span>; Transfer addr
<span style="color:black">DOSCODE:93E5                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], ds
</span><span style="color:black">DOSCODE:93E9                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">4
</span><span style="color:black">DOSCODE:93EC                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:93ED                 </span><span style="color:navy">stosw                   </span>; Count
<span style="color:black">DOSCODE:93EE                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:black">DOSCODE:93EF                 </span><span style="color:navy">stosw                   </span>; Start
<span style="color:black">DOSCODE:93F0                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:black">DOSCODE:93F1                 </span><span style="color:navy">xchg    dx, cx
</span><span style="color:black">DOSCODE:93F3                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:93F4                 </span><span style="color:navy">mov     bx, offset </span>DEVCALL_REQLEN ; DEVCALL
<span style="color:black">DOSCODE:93F7                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:93F7 </span>SETREAD         <span style="color:black">endp
DOSCODE:93F7
DOSCODE:93F8
DOSCODE:93F8 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:93F8
DOSCODE:93F8
DOSCODE:93F8 </span>SETWRITE        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:93F8                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:93F9                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:93FA                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:93FB                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">8           </span>; DEVWRT
<span style="color:black">DOSCODE:93FD                 </span><span style="color:navy">add     cl, ss:</span>VDERFLG
<span style="color:black">DOSCODE:9402                 </span><span style="color:navy">jmp     short </span>SETCALLHEAD
<span style="color:black">DOSCODE:9402 </span>SETWRITE        <span style="color:black">endp
DOSCODE:9402
</span><span style="color:maroon">DOSCODE:9404 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:9404                 </span><span style="color:navy">stc
</span><span style="color:maroon">DOSCODE:9405                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:9406 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:9406                 </span><span style="color:navy">clc
</span><span style="color:maroon">DOSCODE:9407                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:9408 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:9408                 </span><span style="color:navy">stc
</span><span style="color:maroon">DOSCODE:9409                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:940A
DOSCODE:940A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:940A
DOSCODE:940A
DOSCODE:940A </span>BUILDDIR        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:940A                 </span><span style="color:navy">mov     ax, ds:</span>ENTFREE
<span style="color:black">DOSCODE:940D                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:9410                 </span><span style="color:navy">jz      short </span><span style="color:gray">CHECK_IF_ROOT
</span><span style="color:black">DOSCODE:9412                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:9413                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9414 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9414
DOSCODE:9414 </span><span style="color:gray">CHECK_IF_ROOT</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9414                 </span><span style="color:navy">cmp     ds:</span>DIRSTART_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9419                 </span><span style="color:navy">jnz     short </span>NEWDIR
<span style="color:black">DOSCODE:941B                 </span><span style="color:navy">cmp     ds:</span>DIRSTART<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9420                 </span><span style="color:navy">jnz     short </span>NEWDIR
<span style="color:black">DOSCODE:9422                 </span><span style="color:navy">stc                     </span>; Can&#039;t grow root
<span style="color:black">DOSCODE:9423
DOSCODE:9423 </span><span style="color:gray">builddir_retn</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9423                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9424 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9424
DOSCODE:9424 </span>NEWDIR<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9424                 </span><span style="color:navy">mov     bx, ds:</span>DIRSTART_HW
<span style="color:black">DOSCODE:9428                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:942C                 </span><span style="color:navy">or      bx, bx
</span><span style="color:black">DOSCODE:942E                 </span><span style="color:navy">mov     bx, ds:</span>DIRSTART
<span style="color:black">DOSCODE:9432                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NEWDIR2
</span><span style="color:black">DOSCODE:9434                 </span><span style="color:navy">or      bx, bx
</span><span style="color:black">DOSCODE:9436                 </span><span style="color:navy">jz      short </span><span style="color:gray">NULLDIR
</span><span style="color:black">DOSCODE:9438
DOSCODE:9438 </span><span style="color:gray">NEWDIR2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9438                 </span><span style="color:navy">call    </span>GETEOF
<span style="color:black">DOSCODE:943B                 </span><span style="color:navy">jb      short </span><span style="color:gray">builddir_retn </span>; Screw up
<span style="color:black">DOSCODE:943D
DOSCODE:943D </span><span style="color:gray">NULLDIR</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:943D                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:943F                 </span><span style="color:navy">mov     ds:</span>CCOUNT_HW<span style="color:navy">, cx </span>; 0
<span style="color:black">DOSCODE:9443                 </span><span style="color:navy">inc     cx              </span>; 1
<span style="color:black">DOSCODE:9444                 </span><span style="color:navy">call    </span>ALLOCATE
<span style="color:black">DOSCODE:9447                 </span><span style="color:navy">jb      short </span><span style="color:gray">builddir_retn
</span><span style="color:black">DOSCODE:9449                 </span><span style="color:navy">mov     dx, ds:</span>DIRSTART
<span style="color:black">DOSCODE:944D                 </span><span style="color:navy">cmp     dx, ds:</span>DIRSTART_HW
<span style="color:black">DOSCODE:9451                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ADDINGDIR
</span><span style="color:black">DOSCODE:9453                 </span><span style="color:navy">or      dx, dx
</span><span style="color:black">DOSCODE:9455                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ADDINGDIR
</span><span style="color:black">DOSCODE:9457                 </span><span style="color:navy">push    ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:945B                 </span><span style="color:navy">pop     ds:</span>ROOTCLUST_HW
<span style="color:black">DOSCODE:945F                 </span><span style="color:navy">call    </span>SETDIRSRCH
<span style="color:black">DOSCODE:9462                 </span><span style="color:navy">jb      short </span><span style="color:gray">builddir_retn
</span><span style="color:black">DOSCODE:9464                 </span><span style="color:navy">mov     ds:</span>LASTENT<span style="color:navy">, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:946A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">GOTDIRREC
</span><span style="color:black">DOSCODE:946C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:946C
DOSCODE:946C </span><span style="color:gray">ADDINGDIR</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:946C                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:946D                 </span><span style="color:navy">push    ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9471                 </span><span style="color:navy">mov     bx, ds:</span>CLUSNUM_HW
<span style="color:black">DOSCODE:9475                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:9479                 </span><span style="color:navy">mov     bx, ds:</span>CLUSNUM
<span style="color:black">DOSCODE:947D                 </span><span style="color:navy">call    </span>IsEOF
<span style="color:black">DOSCODE:9480                 </span><span style="color:navy">pop     ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9484                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9485                 </span><span style="color:navy">jb      short </span><span style="color:gray">NOTFIRSTGROW
</span><span style="color:black">DOSCODE:9487                 </span><span style="color:navy">mov     ds:</span>CLUSNUM<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:948B                 </span><span style="color:navy">push    cx              </span>; (not necessary)
<span style="color:black">DOSCODE:948C                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:948D                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:948E                 </span><span style="color:navy">mov     ax, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9491                 </span><span style="color:navy">mov     ds:</span>CLUSNUM_HW<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:9494                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1           </span>; CLUSNUM update
<span style="color:black">DOSCODE:9496                 </span><span style="color:navy">mov     dl, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; drive #
<span style="color:black">DOSCODE:949A                 </span><span style="color:navy">mov     cx, ds:</span>DIRSTART ; first cluster #
<span style="color:black">DOSCODE:949E                 </span><span style="color:navy">mov     bp, bx          </span>; CLUSNUM
<span style="color:black">DOSCODE:94A0                 </span><span style="color:navy">call    </span>FastOpen_Update ; update CLUSNUM in the fastopen cache
<span style="color:black">DOSCODE:94A3                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:94A4                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:94A5                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:94A6
DOSCODE:94A6 </span><span style="color:gray">NOTFIRSTGROW</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:94A6                 </span><span style="color:navy">mov     dx, bx
</span><span style="color:black">DOSCODE:94A8                 </span><span style="color:navy">xor     bl, bl
</span><span style="color:black">DOSCODE:94AA                 </span><span style="color:navy">call    </span>FIGREC
<span style="color:black">DOSCODE:94AD
DOSCODE:94AD </span><span style="color:gray">GOTDIRREC</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:94AD                 </span><span style="color:navy">mov     cl, es:[bp+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [ES:BP+DPB.CLUSTER_MASK]
<span style="color:black">DOSCODE:94B1                 </span><span style="color:navy">inc     cx
</span><span style="color:black">DOSCODE:94B2                 </span><span style="color:navy">xor     ch, ch
</span><span style="color:black">DOSCODE:94B4
DOSCODE:94B4 </span><span style="color:gray">ZERODIR</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:94B4                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:94B5                 </span><span style="color:navy">mov     ds:</span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">18h </span>; Allowed_FAIL+Allowed_RETRY
<span style="color:black">DOSCODE:94BA                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:94BC                 </span><span style="color:navy">call    </span>GETBUFFR
<span style="color:black">DOSCODE:94BF                 </span><span style="color:navy">jnb     short </span><span style="color:gray">GET_SSIZE
</span><span style="color:black">DOSCODE:94C1                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:94C2                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:94C3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:94C3
DOSCODE:94C3 </span><span style="color:gray">GET_SSIZE</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:94C3                 </span><span style="color:navy">mov     cx, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [ES:BP+DPB.SECTOR_SIZE]
<span style="color:black">DOSCODE:94C7                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:94C8                 </span><span style="color:navy">les     di, ds:</span>CURBUF
<span style="color:black">DOSCODE:94CC                 </span><span style="color:navy">or      byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">4 </span>; [ES:DI+BUFFINFO.buf_flags],buf_isDIR
<span style="color:black">DOSCODE:94D1                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:94D2                 </span><span style="color:navy">add     di, </span><span style="color:green">24
</span><span style="color:black">DOSCODE:94D5                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:94D7                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:94D9                 </span><span style="color:navy">rep stosw
</span><span style="color:black">DOSCODE:94DB                 </span><span style="color:navy">jnb     short </span><span style="color:gray">EVENZ
</span><span style="color:black">DOSCODE:94DD                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:94DE
DOSCODE:94DE </span><span style="color:gray">EVENZ</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:94DE                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:94DF                 </span><span style="color:navy">call    </span>SET_BUF_DIRTY
<span style="color:black">DOSCODE:94E2                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:94E3                 </span><span style="color:navy">add     dx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:94E6                 </span><span style="color:navy">adc     ds:</span>HIGH_SECTOR<span style="color:navy">, cx
</span><span style="color:black">DOSCODE:94EA                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:94EB                 </span><span style="color:navy">loop    </span><span style="color:gray">ZERODIR
</span><span style="color:black">DOSCODE:94ED                 </span><span style="color:navy">mov     ax, ds:</span>LASTENT
<span style="color:black">DOSCODE:94F0                 </span><span style="color:navy">inc     ax
</span><span style="color:black">DOSCODE:94F1                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:94F2                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:94F2 </span>BUILDDIR        <span style="color:black">endp
DOSCODE:94F2
DOSCODE:94F3
DOSCODE:94F3 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:94F3
DOSCODE:94F3
DOSCODE:94F3 </span>SETDOTENT       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:94F3                 </span><span style="color:navy">stosw                   </span>; set up a . or .. directory entry
<span style="color:black">DOSCODE:94F3                                         </span>;  for a directory
<span style="color:black">DOSCODE:94F4                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4
</span><span style="color:black">DOSCODE:94F7                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">2020h
</span><span style="color:black">DOSCODE:94FA                 </span><span style="color:navy">rep stosw
</span><span style="color:black">DOSCODE:94FC                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:94FD                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">10h         </span>; Set up attribute
<span style="color:black">DOSCODE:94FF                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:9500                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">8
</span><span style="color:black">DOSCODE:9503                 </span><span style="color:navy">mov     ax, ds:</span>CLUSTERS_HW
<span style="color:black">DOSCODE:9506                 </span><span style="color:navy">stosw                   </span>; Set up first cluster field, hw
<span style="color:black">DOSCODE:9507                 </span><span style="color:navy">mov     si, word ptr ds:</span>THISSFT ; Initialize time and date of creation
<span style="color:black">DOSCODE:950B                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">]    </span>; [SI+SF_ENTRY.sf_time]
<span style="color:black">DOSCODE:950E                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:950F                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">]    </span>; [SI+SF_ENTRY.sf_date]
<span style="color:black">DOSCODE:9512                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:9513                 </span><span style="color:navy">mov     ax, dx          </span>; Set up first cluster field, lw
<span style="color:black">DOSCODE:9515                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:9516                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:black">DOSCODE:9517                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:9518                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:9519                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9519 </span>SETDOTENT       <span style="color:black">endp
DOSCODE:9519
DOSCODE:951A
DOSCODE:951A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:951A
DOSCODE:951A
DOSCODE:951A </span>MakeNode        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:951A
DOSCODE:951A </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:953B SIZE 00000003 BYTES
</span><span style="color:black">DOSCODE:951A </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:955F SIZE 00000040 BYTES
</span><span style="color:black">DOSCODE:951A </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:95A3 SIZE 00000009 BYTES
</span><span style="color:black">DOSCODE:951A </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:95E9 SIZE 00000030 BYTES
</span><span style="color:black">DOSCODE:951A
DOSCODE:951A                 </span><span style="color:navy">mov     word ptr ds:</span>CREATING<span style="color:navy">, </span><span style="color:green">0E5FFh </span>; DIRFREE*256 + 0FFh
<span style="color:black">DOSCODE:951A                                         </span>; Creating, not DEL *.*
<span style="color:black">DOSCODE:9520                 </span><span style="color:navy">push    ax              </span>; Save AH value
<span style="color:black">DOSCODE:9521                 </span><span style="color:navy">mov     ds:</span>NoSetDir<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9526                 </span><span style="color:navy">mov     ds:</span>SATTRIB<span style="color:navy">, al
</span><span style="color:black">DOSCODE:9529                 </span><span style="color:navy">call    </span>GetPathNoSet
<span style="color:black">DOSCODE:952C                 </span><span style="color:navy">mov     dl, cl
</span><span style="color:black">DOSCODE:952E                 </span><span style="color:navy">xchg    ax, cx          </span>; Device ID to CH
<span style="color:black">DOSCODE:952F                 </span><span style="color:navy">pop     ax              </span>; Get back AH
<span style="color:black">DOSCODE:9530                 </span><span style="color:navy">jnb     short </span><span style="color:gray">make_exists </span>; File existed
<span style="color:black">DOSCODE:9532                 </span><span style="color:navy">jnz     short </span><span style="color:gray">make_err_4 </span>; Path bad
<span style="color:black">DOSCODE:9534                 </span><span style="color:navy">cmp     dl, </span><span style="color:#ff8000">80h         </span>; Check &quot;CL&quot; return from GETPATH
<span style="color:black">DOSCODE:9537                 </span><span style="color:navy">jz      short </span>RENAME_MAKE ; jz short make_type
<span style="color:black">DOSCODE:9537                                         </span>; Name simply not found, and no metas
<span style="color:black">DOSCODE:9539
DOSCODE:9539 </span><span style="color:gray">make_err_4</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9539                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">4           </span>; case 1 bad path
<span style="color:black">DOSCODE:9539 </span>MakeNode        <span style="color:black">endp
DOSCODE:9539
DOSCODE:953B </span><span style="color:gray">; START OF FUNCTION CHUNK FOR RENAME_MAKE
</span><span style="color:black">DOSCODE:953B </span><span style="color:gray">;   ADDITIONAL PARENT FUNCTION MakeNode
</span><span style="color:black">DOSCODE:953B
DOSCODE:953B </span>make_err_ret<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:953B                 </span><span style="color:navy">cbw
</span><span style="color:black">DOSCODE:953C                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:953D                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:953D </span><span style="color:gray">; END OF FUNCTION CHUNK FOR RENAME_MAKE
</span><span style="color:black">DOSCODE:953E
DOSCODE:953E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:953E
DOSCODE:953E
DOSCODE:953E </span>RENAME_MAKE     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:953E
DOSCODE:953E </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:953B SIZE 00000003 BYTES
</span><span style="color:black">DOSCODE:953E </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:959F SIZE 00000004 BYTES
</span><span style="color:black">DOSCODE:953E </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:95B8 SIZE 00000031 BYTES
</span><span style="color:black">DOSCODE:953E
DOSCODE:953E                 </span><span style="color:navy">test    ds:</span>EXTOPEN_ON<span style="color:navy">, </span><span style="color:green">1 </span>; make_type:
<span style="color:black">DOSCODE:953E                                         </span>; EXT_OPEN_ON
<span style="color:black">DOSCODE:9543                 </span><span style="color:navy">jz      short </span><span style="color:gray">make_type2
</span><span style="color:black">DOSCODE:9545                 </span><span style="color:navy">or      ds:</span>EXTOPEN_ON<span style="color:navy">, </span><span style="color:green">4 </span>; EXT_FILE_NOT_EXISTS
<span style="color:black">DOSCODE:954A                 </span><span style="color:navy">test    byte ptr ds:</span>EXTOPEN_FLAG<span style="color:navy">, </span><span style="color:green">0F0h
</span><span style="color:black">DOSCODE:954F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">make_type2
</span><span style="color:black">DOSCODE:9551                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:9552                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">7           </span>; file not found
<span style="color:black">DOSCODE:9555
DOSCODE:9555 </span>make_retn<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9555                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9556 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9556
DOSCODE:9556 </span><span style="color:gray">make_type2</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9556                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:black">DOSCODE:955A                 </span><span style="color:navy">xor     ax, ax          </span>; nothing exists Disk Node
<span style="color:black">DOSCODE:955C                 </span><span style="color:navy">stc                     </span>; Not found
<span style="color:black">DOSCODE:955D                 </span><span style="color:navy">jmp     short </span><span style="color:gray">make_new
</span><span style="color:black">DOSCODE:955D </span>RENAME_MAKE     <span style="color:black">endp
DOSCODE:955D
DOSCODE:955F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:955F </span><span style="color:gray">; START OF FUNCTION CHUNK FOR MakeNode
</span><span style="color:black">DOSCODE:955F
DOSCODE:955F </span><span style="color:gray">make_exists</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:955F                 </span><span style="color:navy">jz      short </span><span style="color:gray">make_exists_dir
</span><span style="color:black">DOSCODE:9561                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3           </span>; file exists type 3
<span style="color:black">DOSCODE:9561                                         </span>;  (error or device node)
<span style="color:black">DOSCODE:9563                 </span><span style="color:navy">test    ds:</span>ATTRIB<span style="color:navy">, </span><span style="color:green">18h  </span>; attr_volume_id+attr_directory
<span style="color:black">DOSCODE:9568                 </span><span style="color:navy">jnz     short </span><span style="color:gray">make_err_ret_5 </span>; Cannot already exist as Disk or Device Node
<span style="color:black">DOSCODE:9568                                         </span>;  if making DIR or Volume ID
<span style="color:black">DOSCODE:956A                 </span><span style="color:navy">or      ch, ch
</span><span style="color:black">DOSCODE:956C                 </span><span style="color:navy">js      short </span><span style="color:gray">make_share </span>; No further checks on attributes if device
<span style="color:black">DOSCODE:956E                 </span><span style="color:navy">or      ah, ah
</span><span style="color:black">DOSCODE:9570                 </span><span style="color:navy">jnz     short </span>make_err_ret ; truncating NOT OK (AL = 3)
<span style="color:black">DOSCODE:9572                 </span><span style="color:navy">push    cx              </span>; Save device ID
<span style="color:black">DOSCODE:9573                 </span><span style="color:navy">mov     es, word ptr ds:</span>CURBUF<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:9577                 </span><span style="color:navy">mov     ch, es:[bx+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">] </span>; [ES:BX+dir_entry.dir_attr]
<span style="color:black">DOSCODE:9577                                         </span>; Get file attributes
<span style="color:black">DOSCODE:957B                 </span><span style="color:navy">test    ch, </span><span style="color:green">1           </span>; attr_read_only
<span style="color:black">DOSCODE:957E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">make_err_ret_5P </span>; Cannot create on read only files
<span style="color:black">DOSCODE:9580                 </span><span style="color:navy">call    </span>MatchAttributes
<span style="color:black">DOSCODE:9583                 </span><span style="color:navy">pop     cx              </span>; Devid back in CH
<span style="color:black">DOSCODE:9584                 </span><span style="color:navy">jnz     short </span><span style="color:gray">make_err_ret_5 </span>; Attributes not ok
<span style="color:black">DOSCODE:9586                 </span><span style="color:navy">xor     al, al          </span>; AL = 0, Disk Node
<span style="color:black">DOSCODE:9588
DOSCODE:9588 </span><span style="color:gray">make_share</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9588                 </span><span style="color:navy">cbw
</span><span style="color:black">DOSCODE:9589                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:958A                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:958B                 </span><span style="color:navy">mov     ah, ch          </span>; Device ID to AH
<span style="color:black">DOSCODE:958D                 </span><span style="color:navy">call    </span>DOOPEN          ; Fill in SFT for share check
<span style="color:black">DOSCODE:9590                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:black">DOSCODE:9594                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:9595                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:9596                 </span><span style="color:navy">call    </span>ShareEnter
<span style="color:black">DOSCODE:9599                 </span><span style="color:navy">jnb     short </span><span style="color:gray">MakeEndShare
</span><span style="color:black">DOSCODE:959B                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:959C                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:959D                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:959E                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:959E </span><span style="color:gray">; END OF FUNCTION CHUNK FOR MakeNode
</span><span style="color:black">DOSCODE:959F </span><span style="color:gray">; START OF FUNCTION CHUNK FOR RENAME_MAKE
</span><span style="color:black">DOSCODE:959F
DOSCODE:959F </span><span style="color:gray">Make_Share_ret</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:959F                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:95A1                 </span><span style="color:navy">jmp     short </span>make_err_ret
<span style="color:black">DOSCODE:95A1 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR RENAME_MAKE
</span><span style="color:black">DOSCODE:95A3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:95A3 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR MakeNode
</span><span style="color:black">DOSCODE:95A3
DOSCODE:95A3 </span><span style="color:gray">make_err_ret_5P</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:95A3                 </span><span style="color:navy">pop     cx              </span>; Get back device ID
<span style="color:black">DOSCODE:95A4
DOSCODE:95A4 </span><span style="color:gray">make_err_ret_5</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:95A4                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">5           </span>; Attribute mismatch
<span style="color:black">DOSCODE:95A6                 </span><span style="color:navy">jmp     short </span>make_err_ret
<span style="color:black">DOSCODE:95A8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:95A8
DOSCODE:95A8 </span><span style="color:gray">make_exists_dir</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:95A8                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; exists as directory, always an error
<span style="color:black">DOSCODE:95AA                 </span><span style="color:navy">jmp     short </span>make_err_ret
<span style="color:black">DOSCODE:95AA </span><span style="color:gray">; END OF FUNCTION CHUNK FOR MakeNode
</span><span style="color:black">DOSCODE:95AC
DOSCODE:95AC </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:95AC
DOSCODE:95AC
DOSCODE:95AC </span>make_save       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:95AC                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:95AD                 </span><span style="color:navy">mov     ax, cx          </span>; Device ID to AH
<span style="color:black">DOSCODE:95AF                 </span><span style="color:navy">call    </span>NEWENTRY
<span style="color:black">DOSCODE:95B2                 </span><span style="color:navy">pop     ax              </span>; 0 if Disk, 3 if File
<span style="color:black">DOSCODE:95B3                 </span><span style="color:navy">jnb     short </span>make_retn
<span style="color:black">DOSCODE:95B5                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2           </span>; create failed case 2
<span style="color:black">DOSCODE:95B7
DOSCODE:95B7 </span>make_save_retn<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:95B7                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:95B7 </span>make_save       <span style="color:black">endp
DOSCODE:95B7
DOSCODE:95B8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:95B8 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR RENAME_MAKE
</span><span style="color:black">DOSCODE:95B8
DOSCODE:95B8 </span><span style="color:gray">make_new</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:95B8                 </span><span style="color:navy">call    </span>make_save
<span style="color:black">DOSCODE:95BB                 </span><span style="color:navy">jb      short </span>make_save_retn ; case 2 fail
<span style="color:black">DOSCODE:95BD                 </span><span style="color:navy">test    ds:</span>ATTRIB<span style="color:navy">, </span><span style="color:green">10h  </span>; attr_directory
<span style="color:black">DOSCODE:95C2                 </span><span style="color:navy">jnz     short </span>make_save_retn ; Don&#039;t &quot;open&quot; directories,
<span style="color:black">DOSCODE:95C2                                         </span>; so don&#039;t tell the sharer about them
<span style="color:black">DOSCODE:95C4                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:95C5                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:95C6                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:95C7                 </span><span style="color:navy">call    </span>ShareEnter
<span style="color:black">DOSCODE:95CA                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:95CB                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:95CC                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:95CD                 </span><span style="color:navy">jnb     short </span>make_save_retn
<span style="color:black">DOSCODE:95CF                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:95D0                 </span><span style="color:navy">les     di, ds:</span>CURBUF
<span style="color:black">DOSCODE:95D4                 </span><span style="color:navy">mov     byte ptr es:[bx], </span><span style="color:#ff8000">0E5h </span>; DIRFREE ; nuke newly created entry
<span style="color:black">DOSCODE:95D8                 </span><span style="color:navy">call    </span>SET_BUF_DIRTY
<span style="color:black">DOSCODE:95DB                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:95DF                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; get drive for flush
<span style="color:black">DOSCODE:95E3                 </span><span style="color:navy">call    </span>FLUSHBUF        ; write out buffer
<span style="color:black">DOSCODE:95E6                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:95E7                 </span><span style="color:navy">jmp     short </span><span style="color:gray">Make_Share_ret
</span><span style="color:black">DOSCODE:95E7 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR RENAME_MAKE
</span><span style="color:black">DOSCODE:95E9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:95E9 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR MakeNode
</span><span style="color:black">DOSCODE:95E9
DOSCODE:95E9 </span><span style="color:gray">MakeEndShare</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:95E9                 </span><span style="color:navy">les     di, ds:</span>THISSFT  ; grab SFT
<span style="color:black">DOSCODE:95ED                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:95EF                 </span><span style="color:navy">call    </span>ECritDisk       ; call ECritSFT
<span style="color:black">DOSCODE:95F2                 </span><span style="color:navy">xchg    ax, es:[di]     </span>; [ES:DI+SF_ENTRY.sf_ref_count]
<span style="color:black">DOSCODE:95F5                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:95F6                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:95F7                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:95F8                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:95F9                 </span><span style="color:navy">call    </span>ShareEnd        ; remove sharing
<span style="color:black">DOSCODE:95FC                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:95FD                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:95FE                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:95FF                 </span><span style="color:navy">pop     word ptr es:[di] </span>; [ES:DI+SF_ENTRY.sf_ref_count]
<span style="color:black">DOSCODE:9602                 </span><span style="color:navy">call    </span>LCritDisk       ; call LCritSFT
<span style="color:black">DOSCODE:9605                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9606                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:9607                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:9608                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:9609                 </span><span style="color:navy">call    </span>make_save
<span style="color:black">DOSCODE:960C                 </span><span style="color:navy">jb      short </span>make_save_retn ; bye if error
<span style="color:black">DOSCODE:960E                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:960F                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:9610                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:9611                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:9612                 </span><span style="color:navy">call    </span>ShareEnter      ; reassert the share access
<span style="color:black">DOSCODE:9615                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:9616                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:9617                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9618                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:9618 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR MakeNode
</span><span style="color:maroon">DOSCODE:9619
DOSCODE:9619 </span>makeendshare_retn<span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:9619                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:961A
DOSCODE:961A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:961A
DOSCODE:961A
DOSCODE:961A </span>NEWENTRY        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:961A                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:961E                 </span><span style="color:navy">jnb     short </span><span style="color:gray">EXISTENT
</span><span style="color:black">DOSCODE:9620                 </span><span style="color:navy">cmp     ds:</span>FAILERR<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9625                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:9626                 </span><span style="color:navy">jnz     short </span>makeendshare_retn ; User FAILed, node might exist
<span style="color:black">DOSCODE:9628                 </span><span style="color:navy">call    </span>BUILDDIR        ; Try to build dir
<span style="color:black">DOSCODE:962B                 </span><span style="color:navy">jb      short </span>makeendshare_retn ; Failed
<span style="color:black">DOSCODE:962D                 </span><span style="color:navy">call    </span>GETENT          ; Point at that free entry
<span style="color:black">DOSCODE:9630                 </span><span style="color:navy">jb      short </span>makeendshare_retn ; Failed
<span style="color:black">DOSCODE:9632                 </span><span style="color:navy">jmp     short </span><span style="color:gray">FREESPOT
</span><span style="color:black">DOSCODE:9634 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9634
DOSCODE:9634 </span><span style="color:gray">ERRRET3</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9634                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:9635
DOSCODE:9635 </span><span style="color:gray">newentry_retn</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9635                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9636 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9636
DOSCODE:9636 </span><span style="color:gray">EXISTENT</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9636                 </span><span style="color:navy">or      ah, ah          </span>; Check if file is I/O device
<span style="color:black">DOSCODE:9638                 </span><span style="color:navy">jns     short </span><span style="color:gray">NOT_DEV1
</span><span style="color:black">DOSCODE:963A                 </span><span style="color:navy">jmp     </span>DOOPEN          ; If so, proceed with open
<span style="color:black">DOSCODE:963D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:963D
DOSCODE:963D </span><span style="color:gray">NOT_DEV1</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:963D                 </span><span style="color:navy">call    </span>FREEENT         ; Free cluster chain
<span style="color:black">DOSCODE:9640                 </span><span style="color:navy">jb      short </span><span style="color:gray">newentry_retn </span>; Failed
<span style="color:black">DOSCODE:9642
DOSCODE:9642 </span><span style="color:gray">FREESPOT</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9642                 </span><span style="color:navy">test    ds:</span>ATTRIB<span style="color:navy">, </span><span style="color:green">8    </span>; attr_volume_id
<span style="color:black">DOSCODE:9647                 </span><span style="color:navy">jz      short </span><span style="color:gray">NOTVOLID
</span><span style="color:black">DOSCODE:9649                 </span><span style="color:navy">cmp     ds:</span>VOLID<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:964E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ERRRET3   </span>; Can&#039;t create a second volume ID
<span style="color:black">DOSCODE:9650
DOSCODE:9650 </span><span style="color:gray">NOTVOLID</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9650                 </span><span style="color:navy">mov     es, word ptr ds:</span>CURBUF<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:9654                 </span><span style="color:navy">mov     di, bx
</span><span style="color:black">DOSCODE:9656                 </span><span style="color:navy">mov     si, offset </span>NAME1
<span style="color:black">DOSCODE:9659                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">5
</span><span style="color:black">DOSCODE:965C                 </span><span style="color:navy">rep movsw               </span>; Move name into dir entry
<span style="color:black">DOSCODE:965E                 </span><span style="color:navy">movsb
</span><span style="color:black">DOSCODE:965F                 </span><span style="color:navy">mov     al, ds:</span>ATTRIB
<span style="color:black">DOSCODE:9662                 </span><span style="color:navy">stosb                   </span>; Attributes
<span style="color:black">DOSCODE:9663                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">5
</span><span style="color:black">DOSCODE:9665                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:9667                 </span><span style="color:navy">rep stosw               </span>; Zero pad
<span style="color:black">DOSCODE:9669                 </span><span style="color:navy">call    </span>DATE16
<span style="color:black">DOSCODE:966C                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:black">DOSCODE:966D                 </span><span style="color:navy">stosw                   </span>; dir_time
<span style="color:black">DOSCODE:966E                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:black">DOSCODE:966F                 </span><span style="color:navy">mov     es:[di-</span><span style="color:green">6</span><span style="color:navy">], ax   </span>; last access date
<span style="color:black">DOSCODE:9673                 </span><span style="color:navy">stosw                   </span>; dir_date
<span style="color:black">DOSCODE:9674                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:9676                 </span><span style="color:navy">push    di              </span>; Correct SI input value
<span style="color:black">DOSCODE:9676                                         </span>; (recomputed for new buffer)
<span style="color:black">DOSCODE:9677                 </span><span style="color:navy">stosw                   </span>; Zero dir_first and size
<span style="color:black">DOSCODE:9678                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:9679                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:967A
DOSCODE:967A </span>updnxt<span style="color:navy">:
</span><span style="color:black">DOSCODE:967A                 </span><span style="color:navy">mov     si, word ptr ds:</span>CURBUF
<span style="color:black">DOSCODE:967E                 </span><span style="color:navy">test    byte ptr es:[si+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [ES:SI+BUFFINFO.buf_flags],buf_dirty
<span style="color:black">DOSCODE:9683                 </span><span style="color:navy">jnz     short </span><span style="color:gray">yesdirty9 </span>; don&#039;t increment dirty count
<span style="color:black">DOSCODE:9685                 </span><span style="color:navy">call    </span>INC_DIRTY_COUNT
<span style="color:black">DOSCODE:9688                 </span><span style="color:navy">or      byte ptr es:[si+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; ES:SI+BUFFINFO.buf_flags],buf_dirty
<span style="color:black">DOSCODE:968D
DOSCODE:968D </span><span style="color:gray">yesdirty9</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:968D                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:9691                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; [ES:BP+DPB.DRIVE]
<span style="color:black">DOSCODE:9691                                         </span>; Sets AH value again (in AL)
<span style="color:black">DOSCODE:9695                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:9696                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:9697                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:9698                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:9699                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:black">DOSCODE:969D                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">80h </span>; [ES:DI+SF_ENTRY.sf_flags],devid_device
<span style="color:black">DOSCODE:96A2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GotADevice
</span><span style="color:black">DOSCODE:96A4                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:96A5                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:96A6                 </span><span style="color:navy">lds     bx, ds:</span>THISDPB
<span style="color:black">DOSCODE:96AA                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">7</span><span style="color:navy">], bx   </span>; [ES:DI+SF_ENTRY.sf_devptr]
<span style="color:black">DOSCODE:96AE                 </span><span style="color:navy">mov     bx, ds
</span><span style="color:black">DOSCODE:96B0                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">9</span><span style="color:navy">], bx   </span>; [ES:DI+SF_ENTRY.sf_devptr+2]
<span style="color:black">DOSCODE:96B4                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:96B5                 </span><span style="color:navy">pop     ds              </span>; need to use DS for segment later on
<span style="color:black">DOSCODE:96B6
DOSCODE:96B6 </span><span style="color:gray">GotADevice</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:96B6                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:96B7                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:96B8                 </span><span style="color:navy">call    </span>FLUSHBUF
<span style="color:black">DOSCODE:96BB                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:96BC                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:96BD                 </span><span style="color:navy">pop     si              </span>; Get SI input back
<span style="color:black">DOSCODE:96BE                 </span><span style="color:navy">mov     ah, al          </span>; Get I/O driver number back
<span style="color:black">DOSCODE:96C0                 </span><span style="color:navy">jnb     short </span>DOOPEN
<span style="color:black">DOSCODE:96C2                 </span><span style="color:navy">retn                    </span>; Failed
<span style="color:black">DOSCODE:96C2 </span>NEWENTRY        <span style="color:black">endp
DOSCODE:96C2
DOSCODE:96C3
DOSCODE:96C3 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:96C3
DOSCODE:96C3
DOSCODE:96C3 </span>DOOPEN          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:96C3                 </span><span style="color:navy">mov     dh, ah          </span>; AH to different place
<span style="color:black">DOSCODE:96C5                 </span><span style="color:navy">xor     dl, dl
</span><span style="color:black">DOSCODE:96C7                 </span><span style="color:navy">or      ah, ah
</span><span style="color:black">DOSCODE:96C9                 </span><span style="color:navy">js      short </span><span style="color:gray">DEV_SFT0
</span><span style="color:black">DOSCODE:96CB                 </span><span style="color:navy">les     di, ds:</span>THISDPB
<span style="color:black">DOSCODE:96CF                 </span><span style="color:navy">cmp     word ptr es:[di+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:di+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:96D4                 </span><span style="color:navy">jz      short </span><span style="color:gray">DEV_SFT0  </span>; FAT32
<span style="color:black">DOSCODE:96D6                 </span><span style="color:navy">inc     dl
</span><span style="color:black">DOSCODE:96D8
DOSCODE:96D8 </span><span style="color:gray">DEV_SFT0</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:96D8                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:black">DOSCODE:96DC                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">4           </span>; SF_ENTRY.sf_attr
<span style="color:black">DOSCODE:96DC                                         </span>; Skip ref_count and mode fields
<span style="color:black">DOSCODE:96DF                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">DOSCODE:96E1                 </span><span style="color:navy">or      dh, dh
</span><span style="color:black">DOSCODE:96E3                 </span><span style="color:navy">js      short </span><span style="color:gray">DEV_SFT1
</span><span style="color:black">DOSCODE:96E5                 </span><span style="color:navy">mov     ds, word ptr ds:</span>CURBUF<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:96E9                 </span><span style="color:navy">mov     al, [bx+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">]    </span>; [BX+dir_entry.dir_attr]
<span style="color:black">DOSCODE:96E9                                         </span>; If file, get attrib from dir entry
<span style="color:black">DOSCODE:96EC
DOSCODE:96EC </span><span style="color:gray">DEV_SFT1</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:96EC                 </span><span style="color:navy">stosb                   </span>; sf_attr, ES:DI -&gt; sf_flags
<span style="color:black">DOSCODE:96ED                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:96EF                 </span><span style="color:navy">mov     al, dh
</span><span style="color:black">DOSCODE:96F1                 </span><span style="color:navy">or      al, </span><span style="color:green">40h         </span>; devid_file_clean
<span style="color:black">DOSCODE:96F3                 </span><span style="color:navy">stosw                   </span>; sf_flags, ES:DI -&gt; sf_devptr
<span style="color:black">DOSCODE:96F4                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:96F5                 </span><span style="color:navy">lds     ax, [bx+</span><span style="color:#ff8000">1Ah</span><span style="color:navy">]    </span>; [BX+dir_entry.dir_first] ; Assume device
<span style="color:black">DOSCODE:96F8                 </span><span style="color:navy">or      dh, dh
</span><span style="color:black">DOSCODE:96FA                 </span><span style="color:navy">js      short </span><span style="color:gray">DEV_SFT2
</span><span style="color:black">DOSCODE:96FC                 </span><span style="color:navy">lds     ax, ss:</span>THISDPB  ; Was file
<span style="color:black">DOSCODE:9701
DOSCODE:9701 </span><span style="color:gray">DEV_SFT2</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9701                 </span><span style="color:navy">stosw                   </span>; store offset
<span style="color:black">DOSCODE:9702                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:black">DOSCODE:9704                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:9705                 </span><span style="color:navy">stosw                   </span>; store segment, ES:DI -&gt; sf_firclus
<span style="color:black">DOSCODE:9706                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:9707                 </span><span style="color:navy">add     di, </span><span style="color:green">32          </span>; SF_ENTRY.sf_chain ; first cluster (32 bit) !?
<span style="color:black">DOSCODE:970A                 </span><span style="color:navy">movsw                   </span>; first cluster, lw
<span style="color:black">DOSCODE:970B                 </span><span style="color:navy">add     si, </span><span style="color:green">0FFF8h      </span>; add si, -8
<span style="color:black">DOSCODE:970E                 </span><span style="color:navy">lodsw                   </span>; first cluster, hw
<span style="color:black">DOSCODE:970F                 </span><span style="color:navy">or      dl, dl
</span><span style="color:black">DOSCODE:9711                 </span><span style="color:navy">jz      short </span><span style="color:gray">FILE_SFT0 </span>; FAT32
<span style="color:black">DOSCODE:9713                 </span><span style="color:navy">xor     ax, ax          </span>; clear hw of first cluster (invalid)
<span style="color:black">DOSCODE:9715
DOSCODE:9715 </span><span style="color:gray">FILE_SFT0</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9715                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:9716                 </span><span style="color:navy">add     di, </span><span style="color:green">0FFDEh      </span>; add di, -34
<span style="color:black">DOSCODE:9719                 </span><span style="color:navy">movsw                   </span>; dir_time -&gt; sf_time
<span style="color:black">DOSCODE:971A                 </span><span style="color:navy">movsw                   </span>; dir_date -&gt; sf_date
<span style="color:black">DOSCODE:971B                 </span><span style="color:navy">lodsw                   </span>; skip dir_first, DS:SI -&gt; dir_size_l
<span style="color:black">DOSCODE:971C                 </span><span style="color:navy">lodsw                   </span>; dir_size_l in AX, DS:SI -&gt; dir_size_h
<span style="color:black">DOSCODE:971D                 </span><span style="color:navy">xchg    ax, cx          </span>; dir_size_l in CX
<span style="color:black">DOSCODE:971E                 </span><span style="color:navy">lodsw                   </span>; dir_size_h (size AX:CX), DS:SI -&gt; ????
<span style="color:black">DOSCODE:971F                 </span><span style="color:navy">or      dh, dh
</span><span style="color:black">DOSCODE:9721                 </span><span style="color:navy">jns     short </span><span style="color:gray">FILE_SFT1
</span><span style="color:black">DOSCODE:9723                 </span><span style="color:navy">xor     ax, ax          </span>; 0
<span style="color:black">DOSCODE:9725                 </span><span style="color:navy">mov     cx, ax          </span>; Devices are open ended
<span style="color:black">DOSCODE:9727
DOSCODE:9727 </span><span style="color:gray">FILE_SFT1</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9727                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:black">DOSCODE:9728                 </span><span style="color:navy">stosw                   </span>; Low word of sf_size
<span style="color:black">DOSCODE:9729                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:black">DOSCODE:972A                 </span><span style="color:navy">stosw                   </span>; High word of sf_size, ES:DI -&gt; sf_position
<span style="color:black">DOSCODE:972B                 </span><span style="color:navy">xor     ax, ax          </span>; 0
<span style="color:black">DOSCODE:972D                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:972E                 </span><span style="color:navy">stosw                   </span>; sf_position = 0, ES:DI -&gt; sf_cluspos
<span style="color:black">DOSCODE:972F                 </span><span style="color:navy">or      dh, dh
</span><span style="color:black">DOSCODE:9731                 </span><span style="color:navy">js      short </span><span style="color:gray">DEV_SFT3
</span><span style="color:black">DOSCODE:9733                 </span><span style="color:navy">stosw                   </span>; sf_cluspos ; 19h
<span style="color:black">DOSCODE:9734                 </span><span style="color:navy">add     di, </span><span style="color:green">0FFF0h      </span>; add di, -16
<span style="color:black">DOSCODE:9737                 </span><span style="color:navy">stosw                   </span>; sf_cluspos_h (sf_firclus in MSDOS 5.0-6.22)
<span style="color:black">DOSCODE:9738                 </span><span style="color:navy">add     di, </span><span style="color:green">14          </span>; sf_dirsec ; 27
<span style="color:black">DOSCODE:973B                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:green">10h</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_chain] ; 43
<span style="color:black">DOSCODE:973B                                         </span>; first cluster (32 bit)
<span style="color:black">DOSCODE:973F                 </span><span style="color:navy">mov     es:[di+</span><span style="color:green">1Ah</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_lstclus] ; 53
<span style="color:black">DOSCODE:9743                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:green">12h</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_chain+2] ; 45
<span style="color:black">DOSCODE:9747                 </span><span style="color:navy">mov     es:[di+</span><span style="color:green">1Ch</span><span style="color:navy">], ax </span>; [ES:DI+SF_ENTRY.sf_lstclus+2] ; 55
<span style="color:black">DOSCODE:974B                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:974C                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:974D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:974E                 </span><span style="color:navy">test    ds:</span>FastOpenFlg<span style="color:navy">, </span><span style="color:green">4 </span>; Special_Fill_Set
<span style="color:black">DOSCODE:9753                 </span><span style="color:navy">jz      short </span><span style="color:gray">Not_FastOpen
</span><span style="color:black">DOSCODE:9755                 </span><span style="color:navy">mov     si, offset </span>FastOpen_Ext_Info
<span style="color:black">DOSCODE:9758                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">1</span><span style="color:navy">]      </span>; FEI.dirsec
<span style="color:black">DOSCODE:975B                 </span><span style="color:navy">stosw                   </span>; sf_dirsec, lw
<span style="color:black">DOSCODE:975C                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">3</span><span style="color:navy">]      </span>; FEI.dirsec+2
<span style="color:black">DOSCODE:975F                 </span><span style="color:navy">stosw                   </span>; sf_dirsec, hw
<span style="color:black">DOSCODE:9760                 </span><span style="color:navy">mov     al, [si]        </span>; FEI.dirpos
<span style="color:black">DOSCODE:9762                 </span><span style="color:navy">stosb                   </span>; sf_dirpos ; 31
<span style="color:black">DOSCODE:9763                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:9764                 </span><span style="color:navy">jmp     short </span><span style="color:gray">Next_Name
</span><span style="color:black">DOSCODE:9766 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9766
DOSCODE:9766 </span><span style="color:gray">Not_FastOpen</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9766                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:9767                 </span><span style="color:navy">mov     si, word ptr ss:</span>CURBUF
<span style="color:black">DOSCODE:976C                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [SI+BUFFINFO.buf_sector]
<span style="color:black">DOSCODE:976F                 </span><span style="color:navy">stosw                   </span>; sf_dirsec, lw ; 27
<span style="color:black">DOSCODE:9770                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">8</span><span style="color:navy">]      </span>; [SI+BUFFINFO.buf_sector+2]
<span style="color:black">DOSCODE:9773                 </span><span style="color:navy">stosw                   </span>; sf_dirsec, hw ; 29
<span style="color:black">DOSCODE:9774                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:black">DOSCODE:9776                 </span><span style="color:navy">add     si, </span><span style="color:green">24          </span>; BUFINSIZ ; DS:SI-&gt; start of data in buffer
<span style="color:black">DOSCODE:9779                 </span><span style="color:navy">sub     ax, si          </span>; AX = BX relative to start of sector
<span style="color:black">DOSCODE:977B                 </span><span style="color:navy">mov     cl, </span><span style="color:green">32          </span>; dir_entry.size
<span style="color:black">DOSCODE:977D                 </span><span style="color:navy">div     cl
</span><span style="color:black">DOSCODE:977F                 </span><span style="color:navy">stosb                   </span>; sf_dirpos ; 31
<span style="color:black">DOSCODE:9780
DOSCODE:9780 </span><span style="color:gray">Next_Name</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9780                 </span><span style="color:navy">jmp     short </span><span style="color:gray">FILE_SFT2
</span><span style="color:black">DOSCODE:9782 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9782
DOSCODE:9782 </span><span style="color:gray">DEV_SFT3</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9782                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">7           </span>; SF_ENTRY.sf_name-SF_ENTRY.sf_cluspos
<span style="color:black">DOSCODE:9785
DOSCODE:9785 </span><span style="color:gray">FILE_SFT2</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9785                 </span><span style="color:navy">mov     si, bx          </span>; DS:SI points to dir_name
<span style="color:black">DOSCODE:9787                 </span><span style="color:navy">mov     cx, </span><span style="color:green">11
</span><span style="color:black">DOSCODE:978A                 </span><span style="color:navy">rep movsb               </span>; sf_name
<span style="color:black">DOSCODE:978C                 </span><span style="color:navy">pop     si              </span>; recover DS:SI -&gt; dir_first
<span style="color:black">DOSCODE:978D                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:978E                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:978F                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:9790
DOSCODE:9790 </span>doopen_retn<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9790                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9790 </span>DOOPEN          <span style="color:black">endp
DOSCODE:9790
DOSCODE:9791
DOSCODE:9791 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9791
DOSCODE:9791
DOSCODE:9791 </span>FREEENT         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9791                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:9792                 </span><span style="color:navy">lds     di, ds:</span>CURBUF
<span style="color:black">DOSCODE:9796                 </span><span style="color:navy">mov     cx, [si]        </span>; Get pointer to clusters
<span style="color:black">DOSCODE:9798                 </span><span style="color:navy">mov     ax, [si-</span><span style="color:green">6</span><span style="color:navy">]      </span>; hw of first cluster (dir_first)
<span style="color:black">DOSCODE:979B                 </span><span style="color:navy">mov     dx, [di+</span><span style="color:#ff8000">8</span><span style="color:navy">]      </span>; [DI+BUFFINFO.buf_sector+2]
<span style="color:black">DOSCODE:979E                 </span><span style="color:navy">mov     ss:</span>HIGH_SECTOR<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:97A3                 </span><span style="color:navy">mov     dx, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]      </span>; [DI+BUFFINFO.buf_sector]
<span style="color:black">DOSCODE:97A6                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:97A7                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [ES:BP+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:97AC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">freeent2
</span><span style="color:black">DOSCODE:97AE                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:97B1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">freeent1
</span><span style="color:black">DOSCODE:97B3                 </span><span style="color:navy">cmp     cx, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:97B6
DOSCODE:97B6 </span><span style="color:gray">freeent1</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:97B6                 </span><span style="color:navy">jb      short </span><span style="color:gray">RET1      </span>; Was 0 length file
<span style="color:black">DOSCODE:97B6                                         </span>; (or mucked Firclus if AX:CX=1)
<span style="color:black">DOSCODE:97B8                 </span><span style="color:navy">cmp     ax, es:[bp+</span><span style="color:#ff8000">2Fh</span><span style="color:navy">] </span>; [ES:BP+DPB.LAST_CLUSTER+2]
<span style="color:black">DOSCODE:97BC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">freeent3
</span><span style="color:black">DOSCODE:97BE                 </span><span style="color:navy">cmp     cx, es:[bp+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">] </span>; [ES:BP+DPB.LAST_CLUSTER]
<span style="color:black">DOSCODE:97C2                 </span><span style="color:navy">jmp     short </span><span style="color:gray">freeent3
</span><span style="color:black">DOSCODE:97C4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:97C4
DOSCODE:97C4 </span><span style="color:gray">freeent2</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:97C4                 </span><span style="color:navy">xor     ax, ax          </span>; 0
<span style="color:black">DOSCODE:97C6                 </span><span style="color:navy">cmp     cx, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:97C9                 </span><span style="color:navy">jb      short </span><span style="color:gray">RET1      </span>; Was 0 length file (or mucked Firclus if CX=1)
<span style="color:black">DOSCODE:97CB                 </span><span style="color:navy">cmp     cx, es:[bp+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">] </span>; [ES:BP+DPB.MAX_CLUSTER]
<span style="color:black">DOSCODE:97CF
DOSCODE:97CF </span><span style="color:gray">freeent3</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:97CF                 </span><span style="color:navy">ja      short </span><span style="color:gray">RET1      </span>; Treat like zero length file (firclus mucked)
<span style="color:black">DOSCODE:97D1                 </span><span style="color:navy">sub     bx, di
</span><span style="color:black">DOSCODE:97D3                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:97D4                 </span><span style="color:navy">push    ds:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:97D8                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:97D9                 </span><span style="color:navy">mov     bx, cx
</span><span style="color:black">DOSCODE:97DB                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:97DE                 </span><span style="color:navy">call    </span>RELEASE         ; Free any data allocated
<span style="color:black">DOSCODE:97E1                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:97E2                 </span><span style="color:navy">pop     ds:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:97E6                 </span><span style="color:navy">jb      short </span><span style="color:gray">freeent4
</span><span style="color:black">DOSCODE:97E8
DOSCODE:97E8 </span>GET_BUF_BACK<span style="color:navy">:                           </span>;
<span style="color:black">DOSCODE:97E8                 </span><span style="color:navy">mov     ds:</span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">18h </span>; Allowed_RETRY+Allowed_FAIL
<span style="color:black">DOSCODE:97ED                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">DOSCODE:97EF                 </span><span style="color:navy">call    </span>GETBUFFR
<span style="color:black">DOSCODE:97F2
DOSCODE:97F2 </span><span style="color:gray">freeent4</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:97F2                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:97F3                 </span><span style="color:navy">jb      short </span>doopen_retn
<span style="color:black">DOSCODE:97F5                 </span><span style="color:navy">call    </span>SET_BUF_AS_DIR
<span style="color:black">DOSCODE:97F8                 </span><span style="color:navy">add     bx, word ptr ds:</span>CURBUF
<span style="color:black">DOSCODE:97FC                 </span><span style="color:navy">lea     si, [bx+</span><span style="color:#ff8000">1Ah</span><span style="color:navy">]    </span>; [bx+dir_entry.dir_first] ; Get corrected SI
<span style="color:black">DOSCODE:97FF
DOSCODE:97FF </span><span style="color:gray">RET1</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:97FF                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:9800                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9800 </span>FREEENT         <span style="color:black">endp
DOSCODE:9800
DOSCODE:9801
DOSCODE:9801 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9801
DOSCODE:9801
DOSCODE:9801 </span>FNDCLUS         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9801                 </span><span style="color:navy">push    es              </span>; DX:CX = No. of clusters to skip
<span style="color:black">DOSCODE:9802                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:black">DOSCODE:9806                 </span><span style="color:navy">mov     ds:</span>CLSKIP_HW<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:980A                 </span><span style="color:navy">mov     bx, es:[di+</span><span style="color:#ff8000">37h</span><span style="color:navy">] </span>;  [ES:DI+SF_ENTRY.sf_lstclus+2]
<span style="color:black">DOSCODE:980E                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:9812                 </span><span style="color:navy">or      bx, bx
</span><span style="color:black">DOSCODE:9814                 </span><span style="color:navy">mov     dx, es:[di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_firclus] ; MSDOS 5.0-6.22
<span style="color:black">DOSCODE:9814                                         </span>; [ES:DI+SF_ENTRY.sf_cluspos_hw] ; PCDOS 7.1
<span style="color:black">DOSCODE:9818                 </span><span style="color:navy">mov     ds:</span>LASTPOS_HW<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:981C                 </span><span style="color:navy">mov     bx, es:[di+</span><span style="color:#ff8000">35h</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_lstclus]
<span style="color:black">DOSCODE:9820                 </span><span style="color:navy">mov     dx, es:[di+</span><span style="color:#ff8000">19h</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_cluspos]
<span style="color:black">DOSCODE:9824                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fndclus_1
</span><span style="color:black">DOSCODE:9826                 </span><span style="color:navy">or      bx, bx
</span><span style="color:black">DOSCODE:9828                 </span><span style="color:navy">jnz     short </span><span style="color:gray">fndclus_1
</span><span style="color:black">DOSCODE:982A                 </span><span style="color:navy">jmp     </span>NOCLUS
<span style="color:black">DOSCODE:982D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:982D
DOSCODE:982D </span><span style="color:gray">fndclus_1</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:982D                 </span><span style="color:navy">sub     cx, dx
</span><span style="color:black">DOSCODE:982F                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:9830                 </span><span style="color:navy">mov     ax, ds:</span>LASTPOS_HW
<span style="color:black">DOSCODE:9833                 </span><span style="color:navy">sbb     ds:</span>CLSKIP_HW<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:9837                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:9838                 </span><span style="color:navy">jnb     short </span><span style="color:gray">FINDIT
</span><span style="color:black">DOSCODE:983A                 </span><span style="color:navy">add     cx, dx
</span><span style="color:black">DOSCODE:983C                 </span><span style="color:navy">mov     bx, ds:</span>LASTPOS_HW
<span style="color:black">DOSCODE:9840                 </span><span style="color:navy">adc     ds:</span>CLSKIP_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:9844                 </span><span style="color:navy">xor     dx, dx          </span>; 0
<span style="color:black">DOSCODE:9846                 </span><span style="color:navy">mov     ds:</span>LASTPOS_HW<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:984A                 </span><span style="color:navy">mov     bx, es:[di+</span><span style="color:green">2Dh</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_chain+2] ; MSDOS 5.0-6.22
<span style="color:black">DOSCODE:984A                                         </span>; [ES:DI+SF_ENTRY.sf_fcluster+2] ; PCDOS 7.1
<span style="color:black">DOSCODE:984E                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:9852                 </span><span style="color:navy">mov     bx, es:[di+</span><span style="color:green">2Bh</span><span style="color:navy">] </span>; [ES:DI+SF_ENTRY.sf_chain] ; MSDOS 5.0-6.22
<span style="color:black">DOSCODE:9852                                         </span>; [ES:DI+SF_ENTRY.sf_fcluster] ; PCDOS 7.1
<span style="color:black">DOSCODE:9856
DOSCODE:9856 </span><span style="color:gray">FINDIT</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9856                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:9857                 </span><span style="color:navy">cmp     cx, ds:</span>CLSKIP_HW
<span style="color:black">DOSCODE:985B                 </span><span style="color:navy">jnz     short </span>SKPCLP
<span style="color:black">DOSCODE:985D                 </span><span style="color:navy">jcxz    short </span>RET9      ; cf=0
<span style="color:black">DOSCODE:985D </span>FNDCLUS         <span style="color:black">endp
DOSCODE:985D
DOSCODE:985F
DOSCODE:985F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:985F
DOSCODE:985F
DOSCODE:985F </span>SKPCLP          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:985F                 </span><span style="color:navy">push    ds:</span>LASTPOS_HW
<span style="color:black">DOSCODE:9863                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:9864                 </span><span style="color:navy">push    ds:</span>CLSKIP_HW
<span style="color:black">DOSCODE:9868                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:9869                 </span><span style="color:navy">call    </span>UNPACK
<span style="color:black">DOSCODE:986C                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:986D                 </span><span style="color:navy">pop     ds:</span>CLSKIP_HW
<span style="color:black">DOSCODE:9871                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:9872                 </span><span style="color:navy">pop     ds:</span>LASTPOS_HW
<span style="color:black">DOSCODE:9876                 </span><span style="color:navy">jb      short </span>fndclus_retn
<span style="color:black">DOSCODE:9878                 </span><span style="color:navy">push    ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:987C                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:987D                 </span><span style="color:navy">mov     bx, di
</span><span style="color:black">DOSCODE:987F                 </span><span style="color:navy">mov     di, ds:</span>CCONTENT_HW
<span style="color:black">DOSCODE:9883                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, di
</span><span style="color:black">DOSCODE:9887                 </span><span style="color:navy">call    </span>IsEOF
<span style="color:black">DOSCODE:988A                 </span><span style="color:navy">jb      short </span><span style="color:gray">SKPCLP2
</span><span style="color:black">DOSCODE:988C                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:988D                 </span><span style="color:navy">pop     ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9891                 </span><span style="color:navy">jmp     short </span>RET9      ; cf=0
<span style="color:black">DOSCODE:9893 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9893
DOSCODE:9893 </span><span style="color:gray">SKPCLP2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9893                 </span><span style="color:navy">add     sp, </span><span style="color:green">4
</span><span style="color:black">DOSCODE:9896                 </span><span style="color:navy">inc     dx
</span><span style="color:black">DOSCODE:9897                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SKPCLP3
</span><span style="color:black">DOSCODE:9899                 </span><span style="color:navy">inc     ds:</span>LASTPOS_HW
<span style="color:black">DOSCODE:989D
DOSCODE:989D </span><span style="color:gray">SKPCLP3</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:989D                 </span><span style="color:navy">sub     cx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:98A0                 </span><span style="color:navy">sbb     ds:</span>CLSKIP_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:98A5                 </span><span style="color:navy">jnz     short </span>SKPCLP    ; loop
<span style="color:black">DOSCODE:98A7                 </span><span style="color:navy">or      cx, cx
</span><span style="color:black">DOSCODE:98A9                 </span><span style="color:navy">jnz     short </span>SKPCLP    ; loop
<span style="color:black">DOSCODE:98AB
DOSCODE:98AB </span>RET9<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:98AB                 </span><span style="color:navy">clc                     </span>; (not necessary) ; 25/02/2024
<span style="color:black">DOSCODE:98AC                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:98AD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:98AD
DOSCODE:98AD </span>NOCLUS<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:98AD                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:98AE                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:98AF                 </span><span style="color:navy">xor     di, di
</span><span style="color:black">DOSCODE:98B1                 </span><span style="color:navy">add     cx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:98B4                 </span><span style="color:navy">adc     ds:</span>CLSKIP_HW<span style="color:navy">, di </span>; CLSKIP_HW:BX = Last cluster skipped to
<span style="color:black">DOSCODE:98B8                 </span><span style="color:navy">sub     dx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:98BB                 </span><span style="color:navy">sbb     ds:</span>LASTPOS_HW<span style="color:navy">, di </span>; LASTPOS_HW:DX = Position of last cluster
<span style="color:black">DOSCODE:98BF                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:98C0                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:98C1
DOSCODE:98C1 </span>fndclus_retn<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:98C1                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:98C1 </span>SKPCLP          <span style="color:black">endp
DOSCODE:98C1
DOSCODE:98C2
DOSCODE:98C2 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:98C2
DOSCODE:98C2
DOSCODE:98C2 </span>BUFSEC          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:98C2                 </span><span style="color:navy">push    ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:98C6                 </span><span style="color:navy">mov     dx, ds:</span>CLUSNUM_HW
<span style="color:black">DOSCODE:98CA                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:98CE                 </span><span style="color:navy">mov     dx, ds:</span>CLUSNUM
<span style="color:black">DOSCODE:98D2                 </span><span style="color:navy">mov     bl, ds:</span>SECCLUSPOS
<span style="color:black">DOSCODE:98D6                 </span><span style="color:navy">mov     ds:</span>ALLOWED<span style="color:navy">, </span><span style="color:green">38h </span>; Allowed_FAIL+Allowed_RETRY+Allowed_IGNORE
<span style="color:black">DOSCODE:98DB                 </span><span style="color:navy">call    </span>FIGREC
<span style="color:black">DOSCODE:98DE                 </span><span style="color:navy">call    </span>GETBUFFR
<span style="color:black">DOSCODE:98E1                 </span><span style="color:navy">pop     ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:98E5                 </span><span style="color:navy">jb      short </span>fndclus_retn
<span style="color:black">DOSCODE:98E7                 </span><span style="color:navy">mov     ds:</span>TRANS<span style="color:navy">, </span><span style="color:#ff8000">1     </span>; A transfer is taking place
<span style="color:black">DOSCODE:98EC                 </span><span style="color:navy">mov     si, ds:</span>NEXTADD
<span style="color:black">DOSCODE:98F0                 </span><span style="color:navy">mov     di, si
</span><span style="color:black">DOSCODE:98F2                 </span><span style="color:navy">mov     cx, ds:</span>BYTCNT1
<span style="color:black">DOSCODE:98F6                 </span><span style="color:navy">add     di, cx
</span><span style="color:black">DOSCODE:98F8                 </span><span style="color:navy">mov     ds:</span>NEXTADD<span style="color:navy">, di
</span><span style="color:black">DOSCODE:98FC                 </span><span style="color:navy">les     di, ds:</span>CURBUF
<span style="color:black">DOSCODE:9900                 </span><span style="color:navy">or      byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">8 </span>; [ES:DI+BUFFINFO.buf_flags],
<span style="color:black">DOSCODE:9900                                         </span>; buf_isDATA
<span style="color:black">DOSCODE:9905                 </span><span style="color:navy">lea     di, [di+</span><span style="color:green">24</span><span style="color:navy">]     </span>; [DI+BUFINSIZ] ; Point to buffer
<span style="color:black">DOSCODE:9908                 </span><span style="color:navy">add     di, ds:</span>BYTSECPOS
<span style="color:black">DOSCODE:990C                 </span><span style="color:navy">clc                     </span>; (not necessary!?) ; 25/02/2024
<span style="color:black">DOSCODE:990D                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:990D </span>BUFSEC          <span style="color:black">endp
DOSCODE:990D
DOSCODE:990E
DOSCODE:990E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:990E
DOSCODE:990E
DOSCODE:990E </span>BUFRD           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:990E                 </span><span style="color:navy">push    es              </span>; pre-read sector
<span style="color:black">DOSCODE:990F                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:9911                 </span><span style="color:navy">call    </span>BUFSEC
<span style="color:black">DOSCODE:9914                 </span><span style="color:navy">jnb     short </span><span style="color:gray">BUF_OK    </span>; ds=ss
<span style="color:black">DOSCODE:9916
DOSCODE:9916 </span>BUF_IO_FAIL<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9916                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:9917                 </span><span style="color:navy">jmp     short </span><span style="color:gray">RBUFPLACED </span>; ds=ss
<span style="color:black">DOSCODE:9919 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9919
DOSCODE:9919 </span><span style="color:gray">BUF_OK</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9919                 </span><span style="color:navy">mov     bx, es
</span><span style="color:black">DOSCODE:991B                 </span><span style="color:navy">mov     es, word ptr ds:</span>DMAADD<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:991F                 </span><span style="color:navy">mov     ds, bx
</span><span style="color:black">DOSCODE:9921                 </span><span style="color:navy">xchg    di, si
</span><span style="color:black">DOSCODE:9923                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:9925                 </span><span style="color:navy">rep movsw               </span>; Copy Buffer to Transfer memory.
<span style="color:black">DOSCODE:9927                 </span><span style="color:navy">adc     cx, </span><span style="color:#ff8000">0           </span>; CX=1 if odd # of bytes, else CX=0.
<span style="color:black">DOSCODE:9927                                         </span>; ! jnc short EVENRD !
<span style="color:black">DOSCODE:9927                                         </span>; ! movsb !
<span style="color:black">DOSCODE:992A                 </span><span style="color:navy">rep movsb               </span>; Copy last byte.
<span style="color:black">DOSCODE:992C
DOSCODE:992C </span>EVENRD<span style="color:navy">:                                 </span>; 25/02/2024 - Erdogan Tan
<span style="color:black">DOSCODE:992C                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:992D                 </span><span style="color:navy">lds     di, ss:</span>CURBUF
<span style="color:black">DOSCODE:9932                 </span><span style="color:navy">lea     bx, [di+</span><span style="color:green">24</span><span style="color:navy">]     </span>; [DI+BUFINSIZ]
<span style="color:black">DOSCODE:9935                 </span><span style="color:navy">sub     si, bx
</span><span style="color:black">DOSCODE:9937                 </span><span style="color:navy">call    </span>PLACEBUF
<span style="color:black">DOSCODE:993A                 </span><span style="color:navy">cmp     si, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [ES:BP+DPB.SECTOR_SIZE] ; Read Last byte?
<span style="color:black">DOSCODE:993E                 </span><span style="color:navy">jb      short </span><span style="color:gray">RBUFPLACEDC </span>; ds&lt;&gt;ss
<span style="color:black">DOSCODE:9940                 </span><span style="color:navy">mov     word ptr ss:</span>BufferQueue<span style="color:navy">, di
</span><span style="color:black">DOSCODE:9945
DOSCODE:9945 </span><span style="color:gray">RBUFPLACEDC</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9945                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:9946
DOSCODE:9946 </span><span style="color:gray">RBUFPLACED</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9946                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:9947                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:9948                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9948 </span>BUFRD           <span style="color:black">endp
DOSCODE:9948
DOSCODE:9949
DOSCODE:9949 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9949
DOSCODE:9949
DOSCODE:9949 </span>BUFWRT          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9949                 </span><span style="color:navy">add     word ptr ds:</span>SECPOS<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:994E                 </span><span style="color:navy">adc     word ptr ds:</span>SECPOS<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9953                 </span><span style="color:navy">mov     ax, word ptr ds:</span>SECPOS<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:9956                 </span><span style="color:navy">cmp     ax, ds:</span>VALSEC<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:995A                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:995C                 </span><span style="color:navy">ja      short </span><span style="color:gray">NOREAD
</span><span style="color:black">DOSCODE:995E                 </span><span style="color:navy">jb      short </span><span style="color:gray">_doread
</span><span style="color:black">DOSCODE:9960                 </span><span style="color:navy">mov     ax, word ptr ds:</span>SECPOS
<span style="color:black">DOSCODE:9963                 </span><span style="color:navy">cmp     ax, ds:</span>VALSEC   ; Has sector been written before?
<span style="color:black">DOSCODE:9967                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1           </span>; no need to read sector before buffer update
<span style="color:black">DOSCODE:9969                 </span><span style="color:navy">ja      short </span><span style="color:gray">NOREAD    </span>; Skip preread if SECPOS&gt;VALSEC
<span style="color:black">DOSCODE:996B
DOSCODE:996B </span><span style="color:gray">_doread</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:996B                 </span><span style="color:navy">xor     al, al          </span>; pre read is needed
<span style="color:black">DOSCODE:996D
DOSCODE:996D </span><span style="color:gray">NOREAD</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:996D                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:996E                 </span><span style="color:navy">call    </span>BUFSEC
<span style="color:black">DOSCODE:9971                 </span><span style="color:navy">jb      short </span>BUF_IO_FAIL ; ds=ss
<span style="color:black">DOSCODE:9973                 </span><span style="color:navy">mov     ds, word ptr ds:</span>DMAADD<span style="color:navy">+</span><span style="color:green">2 </span>;
<span style="color:black">DOSCODE:9973                                         </span>; DS:SI-&gt; Source within Transfer memory block
<span style="color:black">DOSCODE:9973                                         </span>; ES:DI-&gt; Destination within Buffer
<span style="color:black">DOSCODE:9977                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1           </span>; CX = # of whole WORDs; CF=1 if odd # of bytes
<span style="color:black">DOSCODE:9979                 </span><span style="color:navy">rep movsw
</span><span style="color:black">DOSCODE:997B                 </span><span style="color:navy">adc     cx, cx          </span>; ! jnc short EVENWRT !
<span style="color:black">DOSCODE:997B                                         </span>; ! movsb !
<span style="color:black">DOSCODE:997D                 </span><span style="color:navy">rep movsb
</span><span style="color:black">DOSCODE:997F
DOSCODE:997F </span>EVENWRT<span style="color:navy">:                                </span>; 25/02/2024 - Erdogan Tan
<span style="color:black">DOSCODE:997F                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:9980                 </span><span style="color:navy">lds     bx, ss:</span>CURBUF
<span style="color:black">DOSCODE:9985                 </span><span style="color:navy">test    byte ptr [bx+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [BX+BUFFINFO.buf_flags],buf_dirty
<span style="color:black">DOSCODE:9989                 </span><span style="color:navy">jnz     short </span><span style="color:gray">yesdirty10
</span><span style="color:black">DOSCODE:998B                 </span><span style="color:navy">inc     ss:</span>DirtyBufferCount
<span style="color:black">DOSCODE:9990                 </span><span style="color:navy">or      byte ptr [bx+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h
</span><span style="color:black">DOSCODE:9994
DOSCODE:9994 </span><span style="color:gray">yesdirty10</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9994                 </span><span style="color:navy">lea     si, [bx+</span><span style="color:green">24</span><span style="color:navy">]     </span>; [BX+BUFINSIZ]
<span style="color:black">DOSCODE:9997                 </span><span style="color:navy">sub     di, si
</span><span style="color:black">DOSCODE:9999                 </span><span style="color:navy">cmp     di, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [ES:BP+DPB.SECTOR_SIZE]
<span style="color:black">DOSCODE:999D                 </span><span style="color:navy">jb      short </span><span style="color:gray">WBUFPLACED </span>; Written last byte?
<span style="color:black">DOSCODE:999D                                         </span>; No, leave buf where it is
<span style="color:black">DOSCODE:999F                 </span><span style="color:navy">mov     word ptr ss:</span>BufferQueue<span style="color:navy">, bx </span>; Make it prime candidate for
<span style="color:black">DOSCODE:999F                                         </span>; chucking even though it is MRU.
<span style="color:black">DOSCODE:99A4
DOSCODE:99A4 </span><span style="color:gray">WBUFPLACED</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:99A4                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:99A5                 </span><span style="color:navy">mov     ax, ss
</span><span style="color:black">DOSCODE:99A7                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">DOSCODE:99A9                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:99A9 </span>BUFWRT          <span style="color:black">endp
DOSCODE:99A9
DOSCODE:99AA
DOSCODE:99AA </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:99AA
DOSCODE:99AA
DOSCODE:99AA </span>NEXTSEC         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:99AA                 </span><span style="color:navy">test    ds:</span>TRANS<span style="color:navy">, </span><span style="color:green">0FFh
</span><span style="color:black">DOSCODE:99AF                 </span><span style="color:navy">jz      short </span><span style="color:gray">CLRET
</span><span style="color:black">DOSCODE:99B1                 </span><span style="color:navy">mov     al, ds:</span>SECCLUSPOS
<span style="color:black">DOSCODE:99B4                 </span><span style="color:navy">inc     al
</span><span style="color:black">DOSCODE:99B6                 </span><span style="color:navy">cmp     al, es:[bp+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:99BA                 </span><span style="color:navy">jbe     short </span><span style="color:gray">SAVPOS
</span><span style="color:black">DOSCODE:99BC                 </span><span style="color:navy">mov     bx, ds:</span>CLUSNUM_HW
<span style="color:black">DOSCODE:99C0                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:99C4                 </span><span style="color:navy">mov     bx, ds:</span>CLUSNUM
<span style="color:black">DOSCODE:99C8                 </span><span style="color:navy">call    </span>IsEOF
<span style="color:black">DOSCODE:99CB                 </span><span style="color:navy">jnb     short </span><span style="color:gray">NONEXT
</span><span style="color:black">DOSCODE:99CD                 </span><span style="color:navy">call    </span>UNPACK
<span style="color:black">DOSCODE:99D0                 </span><span style="color:navy">jb      short </span><span style="color:gray">NONEXT
</span><span style="color:black">DOSCODE:99D2                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:99D3                 </span><span style="color:navy">mov     di, ds:</span>CCONTENT_HW
<span style="color:black">DOSCODE:99D7                 </span><span style="color:navy">mov     ds:</span>CLUSNUM_HW<span style="color:navy">, di
</span><span style="color:black">DOSCODE:99DB                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:99DC                 </span><span style="color:navy">mov     ds:</span>CLUSNUM<span style="color:navy">, di
</span><span style="color:black">DOSCODE:99E0                 </span><span style="color:navy">add     ds:</span>LASTPOS<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:99E5                 </span><span style="color:navy">adc     ds:</span>LASTPOS_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:99EA                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:99EC
DOSCODE:99EC </span><span style="color:gray">SAVPOS</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:99EC                 </span><span style="color:navy">mov     ds:</span>SECCLUSPOS<span style="color:navy">, al
</span><span style="color:black">DOSCODE:99EF
DOSCODE:99EF </span><span style="color:gray">CLRET</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:99EF                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:99F0                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:99F1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:99F1
DOSCODE:99F1 </span><span style="color:gray">NONEXT</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:99F1                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:99F2                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:99F2 </span>NEXTSEC         <span style="color:black">endp
DOSCODE:99F2
DOSCODE:99F3
DOSCODE:99F3 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:99F3
DOSCODE:99F3
DOSCODE:99F3 </span>OPTIMIZE        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:99F3                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:99F4                 </span><span style="color:navy">push    ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:99F8                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:99F9                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">4</span><span style="color:navy">]   </span>; [ES:BP+DPB.CLUSTER_MASK]
<span style="color:black">DOSCODE:99FD                 </span><span style="color:navy">inc     al              </span>; Number of sectors per cluster
<span style="color:black">DOSCODE:99FF                 </span><span style="color:navy">mov     ah, al
</span><span style="color:black">DOSCODE:9A01                 </span><span style="color:navy">sub     al, dl          </span>; AL = Num of sectors left in first cluster
<span style="color:black">DOSCODE:9A03                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">DOSCODE:9A05                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:9A07
DOSCODE:9A07 </span><span style="color:gray">OPTCLUS</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9A07                 </span><span style="color:navy">call    </span>UNPACK
<span style="color:black">DOSCODE:9A0A                 </span><span style="color:navy">jb      short </span><span style="color:gray">OP_ERR    </span>; ds=ss
<span style="color:black">DOSCODE:9A0C
DOSCODE:9A0C </span>clusgot2<span style="color:navy">:                               </span>; AL has number of sectors available
<span style="color:black">DOSCODE:9A0C                 </span><span style="color:navy">add     cl, al          </span>;  in current cluster
<span style="color:black">DOSCODE:9A0E                 </span><span style="color:navy">adc     ch, </span><span style="color:#ff8000">0           </span>; CX has number of sequential sectors
<span style="color:black">DOSCODE:9A0E                                         </span>;  found so far
<span style="color:black">DOSCODE:9A11                 </span><span style="color:navy">cmp     cx, dx          </span>; DX has number of sectors left to transfer
<span style="color:black">DOSCODE:9A13                 </span><span style="color:navy">jnb     short </span><span style="color:gray">BLKDON
</span><span style="color:black">DOSCODE:9A15                 </span><span style="color:navy">mov     al, ah          </span>; AH has number of sectors available
<span style="color:black">DOSCODE:9A15                                         </span>;  in next cluster
<span style="color:black">DOSCODE:9A17                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:9A18                 </span><span style="color:navy">xor     di, di
</span><span style="color:black">DOSCODE:9A1A                 </span><span style="color:navy">add     bx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:9A1D                 </span><span style="color:navy">adc     ds:</span>CLUSTNUM_HW<span style="color:navy">, di
</span><span style="color:black">DOSCODE:9A21                 </span><span style="color:navy">mov     di, ds:</span>CCONTENT_HW
<span style="color:black">DOSCODE:9A25                 </span><span style="color:navy">cmp     di, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9A29                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:9A2A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">clusgot3
</span><span style="color:black">DOSCODE:9A2C                 </span><span style="color:navy">cmp     di, bx
</span><span style="color:black">DOSCODE:9A2E                 </span><span style="color:navy">jz      short </span><span style="color:gray">OPTCLUS
</span><span style="color:black">DOSCODE:9A30
DOSCODE:9A30 </span><span style="color:gray">clusgot3</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9A30                 </span><span style="color:navy">sub     bx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:9A33                 </span><span style="color:navy">sbb     ds:</span>CLUSTNUM_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9A38
DOSCODE:9A38 </span><span style="color:gray">FINCLUS</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9A38                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:9A39                 </span><span style="color:navy">add     ds:</span>LASTPOS<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:9A3D                 </span><span style="color:navy">mov     bx, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9A41                 </span><span style="color:navy">adc     ds:</span>LASTPOS_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:9A45                 </span><span style="color:navy">mov     ds:</span>CLUSNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:9A49                 </span><span style="color:navy">pop     ds:</span>CLUSNUM      ; Last cluster accessed
<span style="color:black">DOSCODE:9A4D                 </span><span style="color:navy">sub     dx, cx          </span>; Number of sectors still needed
<span style="color:black">DOSCODE:9A4F                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:9A50                 </span><span style="color:navy">mov     ax, cx          </span>; CX has number of sequential sectors
<span style="color:black">DOSCODE:9A50                                         </span>;  found so far
<span style="color:black">DOSCODE:9A52                 </span><span style="color:navy">mul     word ptr es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">] </span>; [ES:BP+DPB.SECTOR_SIZE]
<span style="color:black">DOSCODE:9A56                 </span><span style="color:navy">mov     si, ds:</span>NEXTADD
<span style="color:black">DOSCODE:9A5A                 </span><span style="color:navy">add     ax, si          </span>; Adjust by size of transfer
<span style="color:black">DOSCODE:9A5C                 </span><span style="color:navy">mov     ds:</span>NEXTADD<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:9A5F                 </span><span style="color:navy">pop     ax              </span>; Number of sectors still needed
<span style="color:black">DOSCODE:9A60                 </span><span style="color:navy">pop     dx              </span>; Starting cluster, lw
<span style="color:black">DOSCODE:9A61                 </span><span style="color:navy">pop     bx              </span>; Starting cluster, hw
<span style="color:black">DOSCODE:9A62                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:9A66                 </span><span style="color:navy">sub     ds:</span>LASTPOS<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:9A6A                 </span><span style="color:navy">sbb     ds:</span>LASTPOS_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:9A6E                 </span><span style="color:navy">pop     bx              </span>; BL = sector position within cluster
<span style="color:black">DOSCODE:9A6F                 </span><span style="color:navy">call    </span>FIGREC
<span style="color:black">DOSCODE:9A72                 </span><span style="color:navy">mov     bx, si
</span><span style="color:black">DOSCODE:9A74                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:9A75                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9A76 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9A76
DOSCODE:9A76 </span><span style="color:gray">OP_ERR</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9A76                 </span><span style="color:navy">add     sp, </span><span style="color:green">6
</span><span style="color:black">DOSCODE:9A79                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:9A7A                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9A7B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9A7B
DOSCODE:9A7B </span><span style="color:gray">BLKDON</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9A7B                 </span><span style="color:navy">sub     cx, dx          </span>; Number of sectors in cluster we don&#039;t want
<span style="color:black">DOSCODE:9A7D                 </span><span style="color:navy">sub     ah, cl          </span>; Number of sectors in cluster we accepted
<span style="color:black">DOSCODE:9A7F                 </span><span style="color:navy">dec     ah              </span>; Adjust to mean position within cluster
<span style="color:black">DOSCODE:9A81                 </span><span style="color:navy">mov     ds:</span>SECCLUSPOS<span style="color:navy">, ah
</span><span style="color:black">DOSCODE:9A85                 </span><span style="color:navy">mov     cx, dx          </span>; Anyway, make the total equal to the request
<span style="color:black">DOSCODE:9A87                 </span><span style="color:navy">jmp     short </span><span style="color:gray">FINCLUS
</span><span style="color:black">DOSCODE:9A87 </span>OPTIMIZE        <span style="color:black">endp
DOSCODE:9A87
DOSCODE:9A89
DOSCODE:9A89 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9A89
DOSCODE:9A89
DOSCODE:9A89 </span>FIGREC          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9A89                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:9A8A                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:9A8B                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:9A8D                 </span><span style="color:navy">mov     cl, es:[bp+</span><span style="color:#ff8000">5</span><span style="color:navy">]   </span>; DPB.CLUSTER_SHIFT
<span style="color:black">DOSCODE:9A91                 </span><span style="color:navy">mov     ax, ss:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9A95                 </span><span style="color:navy">sub     dx, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:9A98                 </span><span style="color:navy">sbb     ax, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9A9B                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">noshift
</span><span style="color:black">DOSCODE:9A9D
DOSCODE:9A9D </span><span style="color:gray">rotleft</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9A9D                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:9A9E                 </span><span style="color:navy">rcl     dx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:9AA0                 </span><span style="color:navy">rcl     ax, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:9AA2                 </span><span style="color:navy">loop    </span><span style="color:gray">rotleft
</span><span style="color:black">DOSCODE:9AA4
DOSCODE:9AA4 </span><span style="color:gray">noshift</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9AA4                 </span><span style="color:navy">or      dl, bl
</span><span style="color:black">DOSCODE:9AA6                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; DPB.FAT_SIZE
<span style="color:black">DOSCODE:9AAB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">noshift1  </span>; not FAT32
<span style="color:black">DOSCODE:9AAD                 </span><span style="color:navy">add     dx, es:[bp+</span><span style="color:#ff8000">29h</span><span style="color:navy">] </span>; DPB.FCLUS_FSECTOR
<span style="color:black">DOSCODE:9AB1                 </span><span style="color:navy">adc     ax, es:[bp+</span><span style="color:#ff8000">2Bh</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:9AB5                 </span><span style="color:navy">jmp     short </span><span style="color:gray">noshift2
</span><span style="color:black">DOSCODE:9AB7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9AB7
DOSCODE:9AB7 </span><span style="color:gray">noshift1</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9AB7                 </span><span style="color:navy">add     dx, es:[bp+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">] </span>; DPB.FIRST_SECTOR
<span style="color:black">DOSCODE:9ABB                 </span><span style="color:navy">adc     ax, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9ABE
DOSCODE:9ABE </span><span style="color:gray">noshift2</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9ABE                 </span><span style="color:navy">mov     ss:</span>HIGH_SECTOR<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:9AC2                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:9AC3                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:9AC4
DOSCODE:9AC4 </span>figrec_retn<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9AC4                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9AC4 </span>FIGREC          <span style="color:black">endp
DOSCODE:9AC4
DOSCODE:9AC5
DOSCODE:9AC5 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9AC5
DOSCODE:9AC5
DOSCODE:9AC5 </span>callmagic       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9AC5                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:9AC6                 </span><span style="color:navy">push    ss:</span>OffsetMagicPatch
<span style="color:black">DOSCODE:9ACB                 </span><span style="color:navy">retf
</span><span style="color:black">DOSCODE:9ACB </span>callmagic       <span style="color:black">endp
DOSCODE:9ACB
DOSCODE:9ACC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9ACC </span><span style="color:gray">; START OF FUNCTION CHUNK FOR ALLOCATE
</span><span style="color:black">DOSCODE:9ACC
DOSCODE:9ACC </span><span style="color:gray">alloc_disk_full</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9ACC                 </span><span style="color:navy">jmp     </span><span style="color:gray">Disk_Full_Return
</span><span style="color:black">DOSCODE:9ACC </span><span style="color:gray">; END OF FUNCTION CHUNK FOR ALLOCATE
</span><span style="color:black">DOSCODE:9ACF
DOSCODE:9ACF </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9ACF
DOSCODE:9ACF
DOSCODE:9ACF </span>ALLOCATE        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9ACF
DOSCODE:9ACF </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:9ACC SIZE 00000003 BYTES
</span><span style="color:black">DOSCODE:9ACF
DOSCODE:9ACF                 </span><span style="color:navy">clc                     </span>; COUNT_HW:CX = Number of clusters to allocate
<span style="color:black">DOSCODE:9AD0                 </span><span style="color:navy">push    cs
</span><span style="color:black">DOSCODE:9AD1                 </span><span style="color:navy">call    </span>callmagic
<span style="color:black">DOSCODE:9AD4                 </span><span style="color:navy">jb      short </span><span style="color:gray">alloc_disk_full
</span><span style="color:black">DOSCODE:9AD6
DOSCODE:9AD6 </span>Regular_Allocate_Path<span style="color:navy">:
</span><span style="color:black">DOSCODE:9AD6                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:9AD7                 </span><span style="color:navy">xor     bx, bx          </span>; 0
<span style="color:black">DOSCODE:9AD9                 </span><span style="color:navy">push    ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9ADD                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx </span>; cluster 0
<span style="color:black">DOSCODE:9AE1                 </span><span style="color:navy">call    </span>UNPACK
<span style="color:black">DOSCODE:9AE4                 </span><span style="color:navy">mov     ds:</span>FATBYT<span style="color:navy">, di   </span>;
<span style="color:black">DOSCODE:9AE4                                         </span>; CCONTENT_HW:DI = content of FAT
<span style="color:black">DOSCODE:9AE4                                         </span>;  (for cluster 0)
<span style="color:black">DOSCODE:9AE8                 </span><span style="color:navy">mov     bx, ds:</span>CCONTENT_HW
<span style="color:black">DOSCODE:9AEC                 </span><span style="color:navy">mov     ds:</span>FATBYT_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:9AF0                 </span><span style="color:navy">pop     ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9AF4                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9AF5                 </span><span style="color:navy">jb      short </span>figrec_retn
<span style="color:black">DOSCODE:9AF7                 </span><span style="color:navy">push    ds:</span>CCOUNT_HW
<span style="color:black">DOSCODE:9AFB                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:9AFC                 </span><span style="color:navy">push    ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9B00                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:9B01                 </span><span style="color:navy">mov     dx, bx
</span><span style="color:black">DOSCODE:9B03                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:9B05                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], bx </span>; [es:bp+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:9B09                 </span><span style="color:navy">xchg    bx, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9B0D                 </span><span style="color:navy">mov     ds:</span>CLUSDATA_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:9B11                 </span><span style="color:navy">mov     bx, es:[bp+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">] </span>; [es:bp+DPB.NEXT_FREE]
<span style="color:black">DOSCODE:9B15                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ads0
</span><span style="color:black">DOSCODE:9B17                 </span><span style="color:navy">mov     bx, es:[bp+</span><span style="color:#ff8000">3Bh</span><span style="color:navy">] </span>; [es:bp+DPB.FAT32_NXTFREE+2]
<span style="color:black">DOSCODE:9B1B                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:9B1F                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9B22                 </span><span style="color:navy">mov     bx, es:[bp+</span><span style="color:#ff8000">39h</span><span style="color:navy">] </span>; [es:bp+DPB.FAT32_NXTFREE]
<span style="color:black">DOSCODE:9B26                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ads1
</span><span style="color:black">DOSCODE:9B28
DOSCODE:9B28 </span><span style="color:gray">ads0</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9B28                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:9B2B
DOSCODE:9B2B </span><span style="color:gray">ads1</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9B2B                 </span><span style="color:navy">ja      short </span><span style="color:gray">FINDFRE
</span><span style="color:black">DOSCODE:9B2D
DOSCODE:9B2D </span><span style="color:gray">ads2</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9B2D                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:9B2F                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], bx </span>; [es:bp+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:9B33                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ads3
</span><span style="color:black">DOSCODE:9B35                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">39h</span><span style="color:navy">], </span><span style="color:#ff8000">2 </span>; [es:bp+DPB.FAT32_NXTFREE]
<span style="color:black">DOSCODE:9B3B                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">3Bh</span><span style="color:navy">], bx </span>; [es:bp+DPB.FAT32_NXTFREE+2]
<span style="color:black">DOSCODE:9B3F
DOSCODE:9B3F </span><span style="color:gray">ads3</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9B3F                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx </span>; 0
<span style="color:black">DOSCODE:9B43                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">], </span><span style="color:#ff8000">2 </span>; [es:bp+DPB.NEXT_FREE]
<span style="color:black">DOSCODE:9B49                 </span><span style="color:navy">inc     bx              </span>; 1
<span style="color:black">DOSCODE:9B4A                 </span><span style="color:navy">or      es:[bp+</span><span style="color:#ff8000">18h</span><span style="color:navy">], bl </span>; [es:bp+DPB.FIRST_ACCESS]
<span style="color:black">DOSCODE:9B4E
DOSCODE:9B4E </span><span style="color:gray">FINDFRE</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9B4E                 </span><span style="color:navy">add     bx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:9B51                 </span><span style="color:navy">adc     ds:</span>CLUSTNUM_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9B56                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:bp+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:9B5B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ads4      </span>; not FAT32
<span style="color:black">DOSCODE:9B5D                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:9B5E                 </span><span style="color:navy">mov     bx, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9B62                 </span><span style="color:navy">cmp     bx, es:[bp+</span><span style="color:#ff8000">2Fh</span><span style="color:navy">] </span>; [es:bp+DPB.LAST_CLUSTER+2]
<span style="color:black">DOSCODE:9B66                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9B67                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ads5
</span><span style="color:black">DOSCODE:9B69                 </span><span style="color:navy">cmp     bx, es:[bp+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">] </span>; [es:bp+DPB.LAST_CLUSTER]
<span style="color:black">DOSCODE:9B6D                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ads5
</span><span style="color:black">DOSCODE:9B6F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9B6F
DOSCODE:9B6F </span><span style="color:gray">ads4</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9B6F                 </span><span style="color:navy">cmp     bx, es:[bp+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">] </span>; [es:bp+DPB.MAX_CLUSTER]
<span style="color:black">DOSCODE:9B73
DOSCODE:9B73 </span><span style="color:gray">ads5</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9B73                 </span><span style="color:navy">jbe     short </span><span style="color:gray">ads6
</span><span style="color:black">DOSCODE:9B75                 </span><span style="color:navy">jmp     </span><span style="color:gray">ads15
</span><span style="color:black">DOSCODE:9B78 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9B78
DOSCODE:9B78 </span><span style="color:gray">ads6</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9B78                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:9B79                 </span><span style="color:navy">push    ds:</span>CCOUNT_HW
<span style="color:black">DOSCODE:9B7D                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:9B7E                 </span><span style="color:navy">push    ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9B82                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:9B83                 </span><span style="color:navy">push    ds:</span>CLUSDATA_HW
<span style="color:black">DOSCODE:9B87                 </span><span style="color:navy">call    </span>UNPACK
<span style="color:black">DOSCODE:9B8A                 </span><span style="color:navy">pop     ds:</span>CLUSDATA_HW
<span style="color:black">DOSCODE:9B8E                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:9B8F                 </span><span style="color:navy">pop     ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9B93                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9B94                 </span><span style="color:navy">pop     ds:</span>CCOUNT_HW
<span style="color:black">DOSCODE:9B98                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:9B99                 </span><span style="color:navy">jnb     short </span><span style="color:gray">ads7
</span><span style="color:black">DOSCODE:9B9B                 </span><span style="color:navy">jmp     </span><span style="color:gray">ads13
</span><span style="color:black">DOSCODE:9B9E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9B9E
DOSCODE:9B9E </span><span style="color:gray">ads7</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9B9E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">FINDFRE
</span><span style="color:black">DOSCODE:9BA0                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">], bx </span>; [es:bp+DPB.NEXT_FREE]
<span style="color:black">DOSCODE:9BA4                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:bp+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:9BA9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ads8      </span>; not FAT32
<span style="color:black">DOSCODE:9BAB                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:9BAC                 </span><span style="color:navy">mov     bx, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9BB0                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">3Bh</span><span style="color:navy">], bx </span>; [es:bp+DPB.FAT32_NXTFREE+2]
<span style="color:black">DOSCODE:9BB4                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9BB5                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">39h</span><span style="color:navy">], bx </span>; [es:bp+DPB.FAT32_NXTFREE]
<span style="color:black">DOSCODE:9BB9
DOSCODE:9BB9 </span><span style="color:gray">ads8</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9BB9                 </span><span style="color:navy">or      byte ptr es:[bp+</span><span style="color:#ff8000">18h</span><span style="color:navy">], </span><span style="color:green">1 </span>; [es:bp+DPB.FIRST_ACCESS]
<span style="color:black">DOSCODE:9BBE                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:9BBF                 </span><span style="color:navy">push    ds:</span>CCOUNT_HW
<span style="color:black">DOSCODE:9BC3                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:9BC4                 </span><span style="color:navy">push    ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9BC8                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:9BC9                 </span><span style="color:navy">push    ds:</span>CLUSDATA_HW
<span style="color:black">DOSCODE:9BCD                 </span><span style="color:navy">xor     dx, dx          </span>; 0
<span style="color:black">DOSCODE:9BCF                 </span><span style="color:navy">mov     ds:</span>CLUSDATA_HW<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:9BD3                 </span><span style="color:navy">inc     dx              </span>; 1 ; mark this free guy as &quot;1&quot;
<span style="color:black">DOSCODE:9BD4                 </span><span style="color:navy">call    </span>PACK            ; set special &quot;temporary&quot; mark
<span style="color:black">DOSCODE:9BD7                 </span><span style="color:navy">pop     ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9BDB                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9BDC                 </span><span style="color:navy">pop     ds:</span>CLUSDATA_HW
<span style="color:black">DOSCODE:9BE0                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:9BE1                 </span><span style="color:navy">pop     ds:</span>CCOUNT_HW
<span style="color:black">DOSCODE:9BE5                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:9BE6                 </span><span style="color:navy">jb      short </span><span style="color:gray">ads13
</span><span style="color:black">DOSCODE:9BE8                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:9BE9                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:9BEB                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], ax </span>; [es:bp+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:9BEF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ads10     </span>; not FAT32
<span style="color:black">DOSCODE:9BF1                 </span><span style="color:navy">dec     ax
</span><span style="color:black">DOSCODE:9BF2                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">21h</span><span style="color:navy">], ax </span>; [es:bp+DPB.FREE_CNT+2]
<span style="color:black">DOSCODE:9BF6                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ads9
</span><span style="color:black">DOSCODE:9BF8                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], ax </span>; [es:bp+DPB.FREE_CNT]
<span style="color:black">DOSCODE:9BFC
DOSCODE:9BFC </span><span style="color:gray">ads9</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9BFC                 </span><span style="color:navy">jz      short </span><span style="color:gray">NO_ALLOC
</span><span style="color:black">DOSCODE:9BFE                 </span><span style="color:navy">add     es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], ax </span>; Reduce free count by 1
<span style="color:black">DOSCODE:9BFE                                         </span>; [es:bp+DPB.FREE_CNT]
<span style="color:black">DOSCODE:9C02                 </span><span style="color:navy">adc     es:[bp+</span><span style="color:#ff8000">21h</span><span style="color:navy">], ax </span>; [es:bp+DPB.FREE_CNT+2]
<span style="color:black">DOSCODE:9C06                 </span><span style="color:navy">jmp     short </span><span style="color:gray">NO_ALLOC
</span><span style="color:black">DOSCODE:9C08 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9C08
DOSCODE:9C08 </span><span style="color:gray">ads10</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9C08                 </span><span style="color:navy">dec     ax              </span>; 0FFFFh ; -1
<span style="color:black">DOSCODE:9C09                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], ax </span>; [es:bp+DPB.FREE_CNT]
<span style="color:black">DOSCODE:9C0D                 </span><span style="color:navy">jz      short </span><span style="color:gray">NO_ALLOC  </span>; Free count not valid
<span style="color:black">DOSCODE:9C0F                 </span><span style="color:navy">dec     word ptr es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">] </span>; [es:bp+DPB.FREE_CNT]
<span style="color:black">DOSCODE:9C0F                                         </span>; Reduce free count by 1
<span style="color:black">DOSCODE:9C13
DOSCODE:9C13 </span><span style="color:gray">NO_ALLOC</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9C13                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:9C14                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:9C15                 </span><span style="color:navy">push    ds:</span>CCOUNT_HW
<span style="color:black">DOSCODE:9C19                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:9C1A                 </span><span style="color:navy">push    ds:</span>CLUSDATA_HW
<span style="color:black">DOSCODE:9C1E                 </span><span style="color:navy">call    </span>PACK
<span style="color:black">DOSCODE:9C21                 </span><span style="color:navy">pop     ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9C25                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9C26                 </span><span style="color:navy">pop     ds:</span>CCOUNT_HW
<span style="color:black">DOSCODE:9C2A                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:9C2B                 </span><span style="color:navy">jb      short </span><span style="color:gray">ads13
</span><span style="color:black">DOSCODE:9C2D                 </span><span style="color:navy">mov     dx, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9C31                 </span><span style="color:navy">mov     ds:</span>CLUSDATA_HW<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:9C35                 </span><span style="color:navy">mov     dx, bx
</span><span style="color:black">DOSCODE:9C37                 </span><span style="color:navy">sub     cx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:9C3A                 </span><span style="color:navy">sbb     ds:</span>CCOUNT_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9C3F                 </span><span style="color:navy">cmp     cx, ds:</span>CCOUNT_HW
<span style="color:black">DOSCODE:9C43                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ads11
</span><span style="color:black">DOSCODE:9C45                 </span><span style="color:navy">jcxz    short </span><span style="color:gray">ads12
</span><span style="color:black">DOSCODE:9C47
DOSCODE:9C47 </span><span style="color:gray">ads11</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9C47                 </span><span style="color:navy">jmp     </span><span style="color:gray">FINDFRE
</span><span style="color:black">DOSCODE:9C4A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9C4A
DOSCODE:9C4A </span><span style="color:gray">ads12</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9C4A                 </span><span style="color:navy">mov     dx, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:9C4D                 </span><span style="color:navy">mov     ds:</span>CLUSDATA_HW<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:9C51                 </span><span style="color:navy">call    </span>PACK
<span style="color:black">DOSCODE:9C54
DOSCODE:9C54 </span><span style="color:gray">ads13</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9C54                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9C55                 </span><span style="color:navy">pop     ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9C59                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:9C5A                 </span><span style="color:navy">pop     ds:</span>CCOUNT_HW
<span style="color:black">DOSCODE:9C5E                 </span><span style="color:navy">jnb     short </span><span style="color:gray">ads14
</span><span style="color:black">DOSCODE:9C60
DOSCODE:9C60 </span><span style="color:gray">ads_ret</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9C60                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9C61 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9C61
DOSCODE:9C61 </span><span style="color:gray">ads14</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9C61                 </span><span style="color:navy">call    </span>UNPACK          ; Get first cluster allocated for return
<span style="color:black">DOSCODE:9C64                 </span><span style="color:navy">jb      short </span><span style="color:gray">ads_ret
</span><span style="color:black">DOSCODE:9C66                 </span><span style="color:navy">call    </span>RESTFATBYT      ; Restore correct cluster 0 value
<span style="color:black">DOSCODE:9C69                 </span><span style="color:navy">jb      short </span><span style="color:gray">ads_ret
</span><span style="color:black">DOSCODE:9C6B                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:9C6C                 </span><span style="color:navy">mov     ax, ds:</span>CCONTENT_HW
<span style="color:black">DOSCODE:9C6F                 </span><span style="color:navy">xchg    ax, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9C73                 </span><span style="color:navy">xchg    bx, di          </span>; CLUSTNUM_HW:DI = last cluster in file upon our entry
<span style="color:black">DOSCODE:9C75                 </span><span style="color:navy">or      ax, di
</span><span style="color:black">DOSCODE:9C77                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:9C78                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ads_ret   </span>; we were extending an existing file
<span style="color:black">DOSCODE:9C7A
DOSCODE:9C7A </span>dofastk<span style="color:navy">:
</span><span style="color:black">DOSCODE:9C7A                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:9C7B                 </span><span style="color:navy">mov     dx, es
</span><span style="color:black">DOSCODE:9C7D                 </span><span style="color:navy">les     di, ds:</span>THISSFT
<span style="color:black">DOSCODE:9C81                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:9C82                 </span><span style="color:navy">mov     bx, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9C86                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">], bx </span>; [es:di+SF_ENTRYT.sf_chain+2] ; 32 bit fclust, hw
<span style="color:black">DOSCODE:9C8A                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">37h</span><span style="color:navy">], bx </span>; [es:di+SF_ENTRYT.sf_lstclus+2] ; 32 bit lclust, hw
<span style="color:black">DOSCODE:9C8E                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9C8F                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">2Bh</span><span style="color:navy">], bx </span>; [es:di+SF_ENTRYT.sf_chain] ; 32 bit fcluster, lw
<span style="color:black">DOSCODE:9C93                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">35h</span><span style="color:navy">], bx </span>; [es:di+SF_ENTRYT.sf_lstclus] ; 32 bit lcluster, lw
<span style="color:black">DOSCODE:9C97                 </span><span style="color:navy">mov     es, dx
</span><span style="color:black">DOSCODE:9C99                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:9C9A                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9C9B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9C9B
DOSCODE:9C9B </span><span style="color:gray">ads15</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9C9B                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:bp+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:9CA0                 </span><span style="color:navy">jz      short </span><span style="color:gray">ads16     </span>; FAT32
<span style="color:black">DOSCODE:9CA2                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">], </span><span style="color:#ff8000">2 </span>; [es:bp+DPB.NEXT_FREE]
<span style="color:black">DOSCODE:9CA7                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ads17
</span><span style="color:black">DOSCODE:9CA9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9CA9
DOSCODE:9CA9 </span><span style="color:gray">ads16</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9CA9                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">3Bh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:bp+DPB.FAT32_NXTFREE+2]
<span style="color:black">DOSCODE:9CAE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ads17
</span><span style="color:black">DOSCODE:9CB0                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">39h</span><span style="color:navy">], </span><span style="color:#ff8000">2 </span>; [es:bp+DPB.FAT32_NXTFREE]
<span style="color:black">DOSCODE:9CB5
DOSCODE:9CB5 </span><span style="color:gray">ads17</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9CB5                 </span><span style="color:navy">jz      short </span><span style="color:gray">ads18
</span><span style="color:black">DOSCODE:9CB7                 </span><span style="color:navy">jmp     </span><span style="color:gray">ads2            </span>; start scan from front of disk
<span style="color:black">DOSCODE:9CBA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9CBA
DOSCODE:9CBA </span><span style="color:gray">ads18</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9CBA                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9CBB                 </span><span style="color:navy">mov     dx, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:black">DOSCODE:9CBE                 </span><span style="color:navy">mov     ds:</span>CLUSDATA_HW<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:9CC2                 </span><span style="color:navy">pop     ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9CC6                 </span><span style="color:navy">call    </span>RELBLKS
<span style="color:black">DOSCODE:9CC9                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:9CCA                 </span><span style="color:navy">pop     ds:</span>CLUSTERS_HW
<span style="color:black">DOSCODE:9CCE                 </span><span style="color:navy">sub     ax, cx
</span><span style="color:black">DOSCODE:9CD0                 </span><span style="color:navy">sbb     ds:</span>CLUSTERS_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9CD5                 </span><span style="color:navy">call    </span>RESTFATBYT
<span style="color:black">DOSCODE:9CD8
DOSCODE:9CD8 </span><span style="color:gray">Disk_Full_Return</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9CD8                 </span><span style="color:navy">mov     ds:</span>DISK_FULL<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:9CDD                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:9CDE                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9CDE </span>ALLOCATE        <span style="color:black">endp
DOSCODE:9CDE
DOSCODE:9CDF
DOSCODE:9CDF </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9CDF
DOSCODE:9CDF
DOSCODE:9CDF </span>RESTFATBYT      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9CDF                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:9CE0                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:9CE1                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:9CE2                 </span><span style="color:navy">xor     bx, bx          </span>; 0
<span style="color:black">DOSCODE:9CE4                 </span><span style="color:navy">push    ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9CE8                 </span><span style="color:navy">push    ds:</span>CLUSDATA_HW
<span style="color:black">DOSCODE:9CEC                 </span><span style="color:navy">push    ds:</span>CCONTENT_HW  ; (not necessary ?)
<span style="color:black">DOSCODE:9CF0                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx </span>; 0
<span style="color:black">DOSCODE:9CF4                 </span><span style="color:navy">mov     dx, ds:</span>FATBYT_HW
<span style="color:black">DOSCODE:9CF8                 </span><span style="color:navy">mov     ds:</span>CLUSDATA_HW<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:9CFC                 </span><span style="color:navy">mov     dx, ds:</span>FATBYT
<span style="color:black">DOSCODE:9D00                 </span><span style="color:navy">call    </span>PACK
<span style="color:black">DOSCODE:9D03                 </span><span style="color:navy">pop     ds:</span>CCONTENT_HW
<span style="color:black">DOSCODE:9D07                 </span><span style="color:navy">pop     ds:</span>CLUSDATA_HW
<span style="color:black">DOSCODE:9D0B                 </span><span style="color:navy">pop     ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9D0F                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:9D10                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:9D11                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9D12                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9D12 </span>RESTFATBYT      <span style="color:black">endp
DOSCODE:9D12
DOSCODE:9D13
DOSCODE:9D13 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9D13
DOSCODE:9D13
DOSCODE:9D13 </span>RELEASE         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9D13                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:9D15                 </span><span style="color:navy">mov     ds:</span>CLUSDATA_HW<span style="color:navy">, dx </span>; (dx = 0, release)
<span style="color:black">DOSCODE:9D15 </span>RELEASE         <span style="color:black">endp
DOSCODE:9D15
DOSCODE:9D19
DOSCODE:9D19 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9D19
DOSCODE:9D19
DOSCODE:9D19 </span>RELBLKS         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9D19                 </span><span style="color:navy">call    </span>UNPACK
<span style="color:black">DOSCODE:9D1C                 </span><span style="color:navy">jbe     short </span><span style="color:gray">RET12
</span><span style="color:black">DOSCODE:9D1E                 </span><span style="color:navy">mov     ax, di          </span>; CCONTENT_HW:DI= Content of FAT
<span style="color:black">DOSCODE:9D1E                                         </span>;  for given cluster (next cluster)
<span style="color:black">DOSCODE:9D20                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:9D21                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:9D22                 </span><span style="color:navy">call    </span>PACK
<span style="color:black">DOSCODE:9D25                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:9D26                 </span><span style="color:navy">mov     dx, ds:</span>CCONTENT_HW
<span style="color:black">DOSCODE:9D2A                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, dx </span>; next cluster (hw) to be released
<span style="color:black">DOSCODE:9D2E                 </span><span style="color:navy">mov     bx, ax          </span>; next cluster (lw) to be released
<span style="color:black">DOSCODE:9D30                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:9D31                 </span><span style="color:navy">jb      short </span><span style="color:gray">RET12
</span><span style="color:black">DOSCODE:9D33                 </span><span style="color:navy">or      dx, dx          </span>; 0 (delete/release) or -1 (EOF)
<span style="color:black">DOSCODE:9D35                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NO_DEALLOC </span>; Was putting EOF mark (dx = -1)
<span style="color:black">DOSCODE:9D37                 </span><span style="color:navy">cmp     dx, ds:</span>CLUSDATA_HW ; &gt; 0 ? (delete, release)
<span style="color:black">DOSCODE:9D3B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NO_DEALLOC </span>; no, EOF (allocate, -1), (dx = 0)
<span style="color:black">DOSCODE:9D3D                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; [ES:BP+DPB.FREE_CNT],-1
<span style="color:black">DOSCODE:9D3D                                         </span>; Free count valid?
<span style="color:black">DOSCODE:9D42                 </span><span style="color:navy">jz      short </span><span style="color:gray">NO_DEALLOC </span>; No (dx = 0)
<span style="color:black">DOSCODE:9D44
DOSCODE:9D44 </span><span style="color:gray">relblks_ifc</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9D44                 </span><span style="color:navy">inc     word ptr es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">] </span>; [ES:BP+DPB.FREE_CNT]
<span style="color:black">DOSCODE:9D44                                         </span>; Increase free count by 1
<span style="color:black">DOSCODE:9D48                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NO_DEALLOC2
</span><span style="color:black">DOSCODE:9D4A                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], dx </span>; [ES:BP+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:9D4E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NO_DEALLOC2 </span>; not FAT32
<span style="color:black">DOSCODE:9D50                 </span><span style="color:navy">inc     word ptr es:[bp+</span><span style="color:#ff8000">21h</span><span style="color:navy">] </span>; [ES:BP+DPB.FREE_CNT+2]
<span style="color:black">DOSCODE:9D54                 </span><span style="color:navy">jmp     short </span><span style="color:gray">NO_DEALLOC2
</span><span style="color:black">DOSCODE:9D56 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9D56
DOSCODE:9D56 </span><span style="color:gray">NO_DEALLOC</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9D56                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], dx </span>; dx is -1 or 0
<span style="color:black">DOSCODE:9D56                                         </span>;  (valid 16 bit fat size is another number)
<span style="color:black">DOSCODE:9D5A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NO_DEALLOC2 </span>; FAT (FAT16 or FAT12)
<span style="color:black">DOSCODE:9D5A                                         </span>; dx = 0, FAT32
<span style="color:black">DOSCODE:9D5C                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">21h</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; [ES:BP+DPB.FREE_CNT+2]
<span style="color:black">DOSCODE:9D61                 </span><span style="color:navy">jnz     short </span><span style="color:gray">relblks_ifc
</span><span style="color:black">DOSCODE:9D63
DOSCODE:9D63 </span><span style="color:gray">NO_DEALLOC2</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9D63                 </span><span style="color:navy">cmp     ds:</span>CLUSTNUM_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9D68                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NO_DEALLOC3
</span><span style="color:black">DOSCODE:9D6A                 </span><span style="color:navy">dec     ax              </span>; check for &quot;1&quot;
<span style="color:black">DOSCODE:9D6B                 </span><span style="color:navy">jz      short </span><span style="color:gray">RET12     </span>; is last cluster of incomplete chain
<span style="color:black">DOSCODE:9D6D
DOSCODE:9D6D </span><span style="color:gray">NO_DEALLOC3</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9D6D                 </span><span style="color:navy">call    </span>IsEOF
<span style="color:black">DOSCODE:9D70                 </span><span style="color:navy">jb      short </span>RELEASE
<span style="color:black">DOSCODE:9D72
DOSCODE:9D72 </span><span style="color:gray">RET12</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9D72                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9D72 </span>RELBLKS         <span style="color:black">endp
DOSCODE:9D72
DOSCODE:9D73 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9D73 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR GETEOF
</span><span style="color:black">DOSCODE:9D73
DOSCODE:9D73 </span><span style="color:gray">GETEOF1</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9D73                 </span><span style="color:navy">mov     di, ax
</span><span style="color:black">DOSCODE:9D75                 </span><span style="color:navy">mov     ds:</span>CLUSTERS_HW<span style="color:navy">, dx </span>; CLUSTERS_HW:DI = Cluster Count
<span style="color:black">DOSCODE:9D79                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:9D7A                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:9D7B                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9D7B </span><span style="color:gray">; END OF FUNCTION CHUNK FOR GETEOF
</span><span style="color:black">DOSCODE:9D7C
DOSCODE:9D7C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9D7C
DOSCODE:9D7C
DOSCODE:9D7C </span>GETEOF          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9D7C
DOSCODE:9D7C </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:9D73 SIZE 00000009 BYTES
</span><span style="color:black">DOSCODE:9D7C
DOSCODE:9D7C                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:9D7D                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:9D7E                 </span><span style="color:navy">xor     dx, dx          </span>; cluster count = 0
<span style="color:black">DOSCODE:9D80                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:9D82
DOSCODE:9D82 </span><span style="color:gray">GETEOF2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9D82                 </span><span style="color:navy">call    </span>UNPACK
<span style="color:black">DOSCODE:9D85                 </span><span style="color:navy">jb      short </span><span style="color:gray">GETEOF1
</span><span style="color:black">DOSCODE:9D87                 </span><span style="color:navy">inc     ax              </span>; CCONTENT_HW:DI = next cluster (cluster content)
<span style="color:black">DOSCODE:9D88                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GETEOF3
</span><span style="color:black">DOSCODE:9D8A                 </span><span style="color:navy">inc     dx
</span><span style="color:black">DOSCODE:9D8B
DOSCODE:9D8B </span><span style="color:gray">GETEOF3</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9D8B                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:9D8C                 </span><span style="color:navy">push    ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9D90                 </span><span style="color:navy">mov     bx, ds:</span>CCONTENT_HW
<span style="color:black">DOSCODE:9D94                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:9D98                 </span><span style="color:navy">mov     bx, di
</span><span style="color:black">DOSCODE:9D9A                 </span><span style="color:navy">call    </span>IsEOF
<span style="color:black">DOSCODE:9D9D                 </span><span style="color:navy">pop     ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:9DA1                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9DA2                 </span><span style="color:navy">jnb     short </span><span style="color:gray">GETEOF1   </span>; EOF
<span style="color:black">DOSCODE:9DA4                 </span><span style="color:navy">mov     bx, ds:</span>CCONTENT_HW ; not EOF
<span style="color:black">DOSCODE:9DA8                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:9DAC                 </span><span style="color:navy">mov     bx, di
</span><span style="color:black">DOSCODE:9DAE                 </span><span style="color:navy">jmp     short </span><span style="color:gray">GETEOF2   </span>; get next cluster
<span style="color:black">DOSCODE:9DAE </span>GETEOF          <span style="color:black">endp
DOSCODE:9DAE
DOSCODE:9DB0
DOSCODE:9DB0 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9DB0
DOSCODE:9DB0
DOSCODE:9DB0 </span>MAKEFCB         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9DB0                 </span><span style="color:navy">xor     dl, dl          </span>; 0
<span style="color:black">DOSCODE:9DB2                 </span><span style="color:navy">mov     ss:</span>SpaceFlag<span style="color:navy">, dl </span>; Flag--not ambiguous file name
<span style="color:black">DOSCODE:9DB7                 </span><span style="color:navy">test    al, </span><span style="color:green">2           </span>; DRVBIT
<span style="color:black">DOSCODE:9DB9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">DEFDRV
</span><span style="color:black">DOSCODE:9DBB                 </span><span style="color:navy">mov     es:[di], dl     </span>; use default drive
<span style="color:black">DOSCODE:9DBE
DOSCODE:9DBE </span><span style="color:gray">DEFDRV</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9DBE                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:9DBF                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">8
</span><span style="color:black">DOSCODE:9DC2                 </span><span style="color:navy">test    al, </span><span style="color:green">4           </span>; NAMBIT
<span style="color:black">DOSCODE:9DC4                 </span><span style="color:navy">xchg    ax, bx
</span><span style="color:black">DOSCODE:9DC5                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">DOSCODE:9DC7                 </span><span style="color:navy">jz      short </span><span style="color:gray">FILLB     </span>; go fill with blanks
<span style="color:black">DOSCODE:9DC9                 </span><span style="color:navy">add     di, cx
</span><span style="color:black">DOSCODE:9DCB                 </span><span style="color:navy">xor     cx, cx          </span>; Don&#039;t fill any
<span style="color:black">DOSCODE:9DCD
DOSCODE:9DCD </span><span style="color:gray">FILLB</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9DCD                 </span><span style="color:navy">rep stosb
</span><span style="color:black">DOSCODE:9DCF                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:9DD1                 </span><span style="color:navy">test    bl, </span><span style="color:green">8           </span>; EXTBIT
<span style="color:black">DOSCODE:9DD4                 </span><span style="color:navy">jz      short </span><span style="color:gray">FILLB2
</span><span style="color:black">DOSCODE:9DD6                 </span><span style="color:navy">add     di, cx
</span><span style="color:black">DOSCODE:9DD8                 </span><span style="color:navy">xor     cx, cx          </span>; 0
<span style="color:black">DOSCODE:9DDA
DOSCODE:9DDA </span><span style="color:gray">FILLB2</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9DDA                 </span><span style="color:navy">rep stosb
</span><span style="color:black">DOSCODE:9DDC                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:black">DOSCODE:9DDD                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:9DDE                 </span><span style="color:navy">stosw                   </span>; Initialize two words after to zero
<span style="color:black">DOSCODE:9DDF                 </span><span style="color:navy">sub     di, </span><span style="color:green">16          </span>; Point back at start
<span style="color:black">DOSCODE:9DE2                 </span><span style="color:navy">test    bl, </span><span style="color:green">1           </span>; SCANSEPARATOR
<span style="color:black">DOSCODE:9DE2                                         </span>; Scan off separators if not zero
<span style="color:black">DOSCODE:9DE5                 </span><span style="color:navy">jz      short </span><span style="color:gray">SKPSPC
</span><span style="color:black">DOSCODE:9DE7                 </span><span style="color:navy">call    </span>SCANB           ; Peel off blanks and tabs
<span style="color:black">DOSCODE:9DEA                 </span><span style="color:navy">call    </span>DELIM           ; Is it a one-time-only delimiter?
<span style="color:black">DOSCODE:9DED                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOSCAN
</span><span style="color:black">DOSCODE:9DEF                 </span><span style="color:navy">inc     si              </span>; Skip over the delimiter
<span style="color:black">DOSCODE:9DF0
DOSCODE:9DF0 </span><span style="color:gray">SKPSPC</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9DF0                 </span><span style="color:navy">call    </span>SCANB
<span style="color:black">DOSCODE:9DF3
DOSCODE:9DF3 </span><span style="color:gray">NOSCAN</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9DF3                 </span><span style="color:navy">call    </span>GETLET
<span style="color:black">DOSCODE:9DF6                 </span><span style="color:navy">jbe     short </span><span style="color:gray">NODRV     </span>; Quit if termination character
<span style="color:black">DOSCODE:9DF8                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">3Ah </span><span style="color:gray">; &#039;:&#039; </span>;
<span style="color:black">DOSCODE:9DF8                                         </span>; Check for potential drive specifier
<span style="color:black">DOSCODE:9DFB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NODRV
</span><span style="color:black">DOSCODE:9DFD                 </span><span style="color:navy">inc     si              </span>; Skip over colon
<span style="color:black">DOSCODE:9DFE                 </span><span style="color:navy">sub     al, </span><span style="color:#ff8000">40h </span><span style="color:gray">; &#039;@&#039;   </span>; Convert drive letter to drive number (A=1)
<span style="color:black">DOSCODE:9E00                 </span><span style="color:navy">jbe     short </span><span style="color:gray">BADDRV    </span>; Drive letter out of range
<span style="color:black">DOSCODE:9E02                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:9E03                 </span><span style="color:navy">call    </span>GetVisDrv
<span style="color:black">DOSCODE:9E06                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:9E07                 </span><span style="color:navy">jnb     short </span><span style="color:gray">HAVDRV
</span><span style="color:black">DOSCODE:9E09                 </span><span style="color:navy">cmp     ss:</span>DrvErr<span style="color:navy">, </span><span style="color:#ff8000">1Ah  </span>; error_not_DOS_disk
<span style="color:black">DOSCODE:9E0F                 </span><span style="color:navy">jz      short </span><span style="color:gray">HAVDRV
</span><span style="color:black">DOSCODE:9E11
DOSCODE:9E11 </span><span style="color:gray">BADDRV</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9E11                 </span><span style="color:navy">mov     dl, </span><span style="color:#ff8000">0FFh        </span>; -1
<span style="color:black">DOSCODE:9E13
DOSCODE:9E13 </span><span style="color:gray">HAVDRV</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9E13                 </span><span style="color:navy">stosb                   </span>; Put drive specifier in first byte
<span style="color:black">DOSCODE:9E14                 </span><span style="color:navy">inc     si
</span><span style="color:black">DOSCODE:9E15                 </span><span style="color:navy">dec     di              </span>; Counteract next two instructions
<span style="color:black">DOSCODE:9E16
DOSCODE:9E16 </span><span style="color:gray">NODRV</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9E16                 </span><span style="color:navy">dec     si              </span>; Back up
<span style="color:black">DOSCODE:9E17                 </span><span style="color:navy">inc     di              </span>; Skip drive byte
<span style="color:black">DOSCODE:9E17 </span>MAKEFCB         <span style="color:black">endp
DOSCODE:9E17
DOSCODE:9E18
DOSCODE:9E18 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9E18
DOSCODE:9E18
DOSCODE:9E18 </span>NORMSCAN        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9E18                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">8
</span><span style="color:black">DOSCODE:9E1B                 </span><span style="color:navy">call    </span>GETWORD         ; Get 8-letter file name
<span style="color:black">DOSCODE:9E1E                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">2Eh </span><span style="color:gray">; &#039;.&#039;
</span><span style="color:black">DOSCODE:9E21                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NODOT
</span><span style="color:black">DOSCODE:9E23                 </span><span style="color:navy">inc     si              </span>; Skip over dot if present
<span style="color:black">DOSCODE:9E24                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">3           </span>; Get 3-letter extension
<span style="color:black">DOSCODE:9E27                 </span><span style="color:navy">test    byte ptr ss:</span>DOS34_FLAG<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:green">1 </span>; (DBCS_VOLID2&gt;&gt;8)
<span style="color:black">DOSCODE:9E2D                 </span><span style="color:navy">jz      short </span><span style="color:gray">VOLOK
</span><span style="color:black">DOSCODE:9E2F                 </span><span style="color:navy">movsb
</span><span style="color:black">DOSCODE:9E30                 </span><span style="color:navy">dec     cx
</span><span style="color:black">DOSCODE:9E31
DOSCODE:9E31 </span><span style="color:gray">VOLOK</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9E31                 </span><span style="color:navy">call    </span>MUSTGETWORD
<span style="color:black">DOSCODE:9E34
DOSCODE:9E34 </span><span style="color:gray">NODOT</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9E34                 </span><span style="color:navy">mov     al, dl
</span><span style="color:black">DOSCODE:9E36                 </span><span style="color:navy">and     ss:</span>DOS34_FLAG<span style="color:navy">, </span><span style="color:green">0FEFFh </span>; ~DBCS_VOLID2
<span style="color:black">DOSCODE:9E3D                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9E3D </span>NORMSCAN        <span style="color:black">endp
DOSCODE:9E3D
DOSCODE:9E3E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9E3E </span><span style="color:gray">; START OF FUNCTION CHUNK FOR GETWORD
</span><span style="color:black">DOSCODE:9E3E
DOSCODE:9E3E </span><span style="color:gray">NONAM</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9E3E                 </span><span style="color:navy">add     di, cx
</span><span style="color:black">DOSCODE:9E40                 </span><span style="color:navy">dec     si
</span><span style="color:black">DOSCODE:9E41                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9E41 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR GETWORD
</span><span style="color:black">DOSCODE:9E42
DOSCODE:9E42 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9E42
DOSCODE:9E42
DOSCODE:9E42 </span>GETWORD         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9E42
DOSCODE:9E42 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:9E3E SIZE 00000004 BYTES
</span><span style="color:black">DOSCODE:9E42
DOSCODE:9E42                 </span><span style="color:navy">call    </span>GETLET
<span style="color:black">DOSCODE:9E45                 </span><span style="color:navy">jbe     short </span><span style="color:gray">NONAM
</span><span style="color:black">DOSCODE:9E47                 </span><span style="color:navy">dec     si
</span><span style="color:black">DOSCODE:9E47 </span>GETWORD         <span style="color:black">endp
DOSCODE:9E47
DOSCODE:9E48
DOSCODE:9E48 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9E48
DOSCODE:9E48
DOSCODE:9E48 </span>MUSTGETWORD     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9E48                 </span><span style="color:navy">call    </span>GETLET
<span style="color:black">DOSCODE:9E4B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">MustCheckCX
</span><span style="color:black">DOSCODE:9E4D                 </span><span style="color:navy">test    ss:</span>SpaceFlag<span style="color:navy">, </span><span style="color:green">0FFh
</span><span style="color:black">DOSCODE:9E53                 </span><span style="color:navy">jz      short </span><span style="color:gray">FILLNAM
</span><span style="color:black">DOSCODE:9E55                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">DOSCODE:9E57                 </span><span style="color:navy">jnz     short </span><span style="color:gray">FILLNAM
</span><span style="color:black">DOSCODE:9E59
DOSCODE:9E59 </span><span style="color:gray">MustCheckCX</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9E59                 </span><span style="color:navy">jcxz    short </span>MUSTGETWORD
<span style="color:black">DOSCODE:9E5B                 </span><span style="color:navy">dec     cx
</span><span style="color:black">DOSCODE:9E5C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2Ah </span><span style="color:gray">; &#039;*&#039;   </span>; Check for ambiguous file specifier
<span style="color:black">DOSCODE:9E5E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOSTAR
</span><span style="color:black">DOSCODE:9E60                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3Fh </span><span style="color:gray">; &#039;?&#039;
</span><span style="color:black">DOSCODE:9E62                 </span><span style="color:navy">rep stosb
</span><span style="color:black">DOSCODE:9E64
DOSCODE:9E64 </span><span style="color:gray">NOSTAR</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9E64                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:9E65                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3Fh </span><span style="color:gray">; &#039;?&#039;
</span><span style="color:black">DOSCODE:9E67                 </span><span style="color:navy">jnz     short </span>MUSTGETWORD
<span style="color:black">DOSCODE:9E69                 </span><span style="color:navy">or      dl, </span><span style="color:green">1           </span>; Flag ambiguous file name
<span style="color:black">DOSCODE:9E6C                 </span><span style="color:navy">jmp     short </span>MUSTGETWORD
<span style="color:black">DOSCODE:9E6E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9E6E
DOSCODE:9E6E </span><span style="color:gray">FILLNAM</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9E6E                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">DOSCODE:9E70                 </span><span style="color:navy">rep stosb
</span><span style="color:black">DOSCODE:9E72                 </span><span style="color:navy">dec     si
</span><span style="color:black">DOSCODE:9E73                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9E73 </span>MUSTGETWORD     <span style="color:black">endp
DOSCODE:9E73
DOSCODE:9E74
DOSCODE:9E74 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9E74
DOSCODE:9E74
DOSCODE:9E74 </span>SCANB           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9E74                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:9E75                 </span><span style="color:navy">call    </span>SPCHK
<span style="color:black">DOSCODE:9E78                 </span><span style="color:navy">jz      short </span>SCANB
<span style="color:black">DOSCODE:9E7A                 </span><span style="color:navy">dec     si
</span><span style="color:black">DOSCODE:9E7B
DOSCODE:9E7B </span>scanb_retn<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9E7B                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9E7B </span>SCANB           <span style="color:black">endp
DOSCODE:9E7B
DOSCODE:9E7C
DOSCODE:9E7C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9E7C
DOSCODE:9E7C
DOSCODE:9E7C </span>NameTrans       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9E7C                 </span><span style="color:navy">mov     ss:</span>SpaceFlag<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:9E82                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:9E83                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:9E84                 </span><span style="color:navy">mov     di, offset </span>NAME1
<span style="color:black">DOSCODE:9E87                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:9E88                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:black">DOSCODE:9E8A                 </span><span style="color:navy">mov     cx, </span><span style="color:green">11
</span><span style="color:black">DOSCODE:9E8D                 </span><span style="color:navy">rep stosb               </span>; Fill &quot;FCB&quot; at NAME1 with spaces
<span style="color:black">DOSCODE:9E8F                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:black">DOSCODE:9E90                 </span><span style="color:navy">cwd
</span><span style="color:black">DOSCODE:9E91                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:9E92                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:9E93                 </span><span style="color:navy">call    </span>NORMSCAN
<span style="color:black">DOSCODE:9E96                 </span><span style="color:navy">cmp     ss:</span>NAME1<span style="color:navy">, </span><span style="color:#ff8000">0E5h
</span><span style="color:black">DOSCODE:9E9C                 </span><span style="color:navy">jnz     short </span>scanb_retn
<span style="color:black">DOSCODE:9E9E                 </span><span style="color:navy">mov     ss:</span>NAME1<span style="color:navy">, </span><span style="color:#ff8000">5     </span>; Magic name translation
<span style="color:black">DOSCODE:9EA4                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9EA4 </span>NameTrans       <span style="color:black">endp
DOSCODE:9EA4
DOSCODE:9EA4 </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSCODE:9EA5 </span>CharType        <span style="color:navy">db  </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">,   </span><span style="color:#008040">6</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">66h </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:9EA5                 </span><span style="color:navy">db  </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">66h
</span><span style="color:gray">DOSCODE:9EA5                 </span><span style="color:navy">db </span><span style="color:#008040">0F8h</span><span style="color:navy">,</span><span style="color:#008040">0F6h</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">4Fh</span><span style="color:navy">,</span><span style="color:#008040">0F4h</span><span style="color:navy">, </span><span style="color:#008040">6Eh
</span><span style="color:gray">DOSCODE:9EA5                 </span><span style="color:navy">db </span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">44h</span><span style="color:navy">, </span><span style="color:#008040">44h</span><span style="color:navy">,</span><span style="color:#008040">0F4h
</span><span style="color:gray">DOSCODE:9EA5                 </span><span style="color:navy">db </span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh
</span><span style="color:gray">DOSCODE:9EA5                 </span><span style="color:navy">db </span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">6Fh</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">,</span><span style="color:#008040">0FFh
</span><span style="color:gray">DOSCODE:9EA5                 </span><span style="color:navy">db </span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh
</span><span style="color:gray">DOSCODE:9EA5                 </span><span style="color:navy">db </span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0FFh</span><span style="color:navy">,</span><span style="color:#008040">0F4h
</span><span style="color:black">DOSCODE:9EE4
DOSCODE:9EE4 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9EE4
DOSCODE:9EE4
DOSCODE:9EE4 </span>GETLET          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9EE4                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:9EE4 </span>GETLET          <span style="color:black">endp
DOSCODE:9EE4
DOSCODE:9EE5
DOSCODE:9EE5 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9EE5
DOSCODE:9EE5
DOSCODE:9EE5 </span>UCase           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9EE5                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:9EE6                 </span><span style="color:navy">mov     bx, offset </span>FILE_UCASE_TAB_2 ; FILE_UCASE_TAB+2
<span style="color:black">DOSCODE:9EE9
DOSCODE:9EE9 </span>gl_0<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9EE9                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">a&#039;
</span><span style="color:black">DOSCODE:9EEB                 </span><span style="color:navy">jb      short </span><span style="color:gray">gl_2      </span>; Already upper case, go check type
<span style="color:black">DOSCODE:9EED                 </span><span style="color:navy">cmp     al, &#039;</span><span style="color:green">z&#039;
</span><span style="color:black">DOSCODE:9EEF                 </span><span style="color:navy">ja      short </span><span style="color:gray">gl_1
</span><span style="color:black">DOSCODE:9EF1                 </span><span style="color:navy">sub     al, </span><span style="color:green">20h         </span>; Convert to upper case
<span style="color:black">DOSCODE:9EF3
DOSCODE:9EF3 </span><span style="color:gray">gl_1</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9EF3                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">80h
</span><span style="color:black">DOSCODE:9EF5                 </span><span style="color:navy">jb      short </span><span style="color:gray">gl_2      </span>; Not EuroChar, go check type
<span style="color:black">DOSCODE:9EF7                 </span><span style="color:navy">sub     al, </span><span style="color:#ff8000">80h         </span>; translate to upper case with this index
<span style="color:black">DOSCODE:9EF9                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:9EFA                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:9EFF                 </span><span style="color:navy">xlat                    </span>; ds as file_ucase_tab is in DOSDATA
<span style="color:black">DOSCODE:9F00                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:9F01
DOSCODE:9F01 </span><span style="color:gray">gl_2</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9F01                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:9F02                 </span><span style="color:navy">call    </span>GetCharType     ; returns type flags in AL
<span style="color:black">DOSCODE:9F05                 </span><span style="color:navy">test    al, </span><span style="color:green">1           </span>; FCHK ; test for normal character
<span style="color:black">DOSCODE:9F07                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:9F08                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9F09                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9F09 </span>UCase           <span style="color:black">endp
DOSCODE:9F09
DOSCODE:9F0A
DOSCODE:9F0A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9F0A
DOSCODE:9F0A
DOSCODE:9F0A </span>GETLET3         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9F0A                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:9F0B                 </span><span style="color:navy">jmp     short </span>gl_0
<span style="color:black">DOSCODE:9F0B </span>GETLET3         <span style="color:black">endp
DOSCODE:9F0B
DOSCODE:9F0D
DOSCODE:9F0D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9F0D
DOSCODE:9F0D
DOSCODE:9F0D </span>DELIM           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9F0D                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:9F0E                 </span><span style="color:navy">call    </span>GetCharType
<span style="color:black">DOSCODE:9F11                 </span><span style="color:navy">test    al, </span><span style="color:green">2           </span>; FDELIM
<span style="color:black">DOSCODE:9F13                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:9F14                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9F14 </span>DELIM           <span style="color:black">endp
DOSCODE:9F14
DOSCODE:9F15
DOSCODE:9F15 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9F15
DOSCODE:9F15
DOSCODE:9F15 </span>SPCHK           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9F15                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:9F16                 </span><span style="color:navy">call    </span>GetCharType
<span style="color:black">DOSCODE:9F19                 </span><span style="color:navy">test    al, </span><span style="color:green">4           </span>; FSPCHK
<span style="color:black">DOSCODE:9F1B                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:9F1C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9F1C </span>SPCHK           <span style="color:black">endp
DOSCODE:9F1C
DOSCODE:9F1D
DOSCODE:9F1D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9F1D
DOSCODE:9F1D
DOSCODE:9F1D </span>GetCharType     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9F1D                 </span><span style="color:navy">cmp     al, </span><span style="color:green">7Eh         </span>; CharType_last ; beyond end of table?
<span style="color:black">DOSCODE:9F1F                 </span><span style="color:navy">jnb     short </span><span style="color:gray">gct_90
</span><span style="color:black">DOSCODE:9F21                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:9F22                 </span><span style="color:navy">mov     bx, offset </span>CharType ; load lookup table
<span style="color:black">DOSCODE:9F25                 </span><span style="color:navy">shr     al, </span><span style="color:green">1           </span>; adjust for half-byte table entry size
<span style="color:black">DOSCODE:9F27                 </span><span style="color:navy">xlat    byte ptr cs:[bx] </span>; get flags
<span style="color:black">DOSCODE:9F29                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9F2A                 </span><span style="color:navy">jnb     short </span><span style="color:gray">gct_80    </span>; carry clear, no shift needed
<span style="color:black">DOSCODE:9F2C                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:9F2D                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4           </span>; we want high nibble, shift it down
<span style="color:black">DOSCODE:9F2F                 </span><span style="color:navy">shr     al, cl
</span><span style="color:black">DOSCODE:9F31                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:9F32
DOSCODE:9F32 </span><span style="color:gray">gct_80</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9F32                 </span><span style="color:navy">and     al, </span><span style="color:green">0Fh         </span>; clear the unused nibble
<span style="color:black">DOSCODE:9F34                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9F35 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9F35
DOSCODE:9F35 </span><span style="color:gray">gct_90</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9F35                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Fh         </span>; set all flags
<span style="color:black">DOSCODE:9F37                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9F37 </span>GetCharType     <span style="color:black">endp
DOSCODE:9F37
DOSCODE:9F38
DOSCODE:9F38 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9F38
DOSCODE:9F38
DOSCODE:9F38 </span>PATHCHRCMP      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9F38                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2Fh </span><span style="color:gray">; &#039;/&#039;
</span><span style="color:black">DOSCODE:9F3A                 </span><span style="color:navy">jbe     short </span><span style="color:gray">PathRet
</span><span style="color:black">DOSCODE:9F3C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Ch </span><span style="color:gray">; &#039;\&#039;
</span><span style="color:black">DOSCODE:9F3E                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9F3F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9F3F
DOSCODE:9F3F </span><span style="color:gray">GotFor</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9F3F                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">5Ch </span><span style="color:gray">; &#039;\&#039;
</span><span style="color:black">DOSCODE:9F41                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9F42 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9F42
DOSCODE:9F42 </span><span style="color:gray">PathRet</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9F42                 </span><span style="color:navy">jz      short </span><span style="color:gray">GotFor
</span><span style="color:black">DOSCODE:9F44                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9F44 </span>PATHCHRCMP      <span style="color:black">endp
DOSCODE:9F44
DOSCODE:9F44 </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSCODE:9F45 </span>LowInt23Addr    <span style="color:navy">dw offset </span>LowInt23      <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:9F47 </span>LowInt23_SEG    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:9F49 </span>LowInt24Addr    <span style="color:navy">dw offset </span>LowInt24      <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:9F4B </span>LowInt24_SEG    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:9F4D </span>LowInt28Addr    <span style="color:navy">dw offset </span>LowInt28      <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:9F4F </span>LowInt28_SEG    <span style="color:navy">dw </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:9F51
DOSCODE:9F51 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9F51
DOSCODE:9F51
DOSCODE:9F51 </span>DSKSTATCHK      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9F51                 </span><span style="color:navy">cmp     ss:</span>INDOS<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:9F57                 </span><span style="color:navy">jz      short </span><span style="color:gray">dskstatchk1
</span><span style="color:black">DOSCODE:9F59                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9F5A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9F5A
DOSCODE:9F5A </span><span style="color:gray">dskstatchk1</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9F5A                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:9F5B                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:9F5C                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:9F5D                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:9F5E                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:9F5F                 </span><span style="color:navy">mov     bx, ss
</span><span style="color:black">DOSCODE:9F61                 </span><span style="color:navy">mov     es, bx
</span><span style="color:black">DOSCODE:9F63                 </span><span style="color:navy">mov     ds, bx
</span><span style="color:black">DOSCODE:9F65                 </span><span style="color:navy">mov     ds:</span>DSKSTCOM<span style="color:navy">, </span><span style="color:#ff8000">5  </span>; DEVRDND
<span style="color:black">DOSCODE:9F6A                 </span><span style="color:navy">mov     ds:</span>DSKSTCALL<span style="color:navy">, </span><span style="color:green">14 </span>; DRDNDHL
<span style="color:black">DOSCODE:9F6F                 </span><span style="color:navy">mov     ds:</span>DSKSTST<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9F75                 </span><span style="color:navy">mov     bx, offset </span>DSKSTCALL
<span style="color:black">DOSCODE:9F78                 </span><span style="color:navy">lds     si, ds:</span>BCON
<span style="color:black">DOSCODE:9F7C                 </span><span style="color:navy">call    </span>DEVIOCALL2
<span style="color:black">DOSCODE:9F7F                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:9F80                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:9F81                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:9F82                 </span><span style="color:navy">test    byte ptr ds:</span>DSKSTST<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:green">2
</span><span style="color:black">DOSCODE:9F87                 </span><span style="color:navy">jz      short </span><span style="color:gray">_GotCh
</span><span style="color:black">DOSCODE:9F89                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">DOSCODE:9F8B
DOSCODE:9F8B </span><span style="color:gray">RET36</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9F8B                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:9F8C                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:9F8D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:9F8E                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9F8F                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:9F90                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:9F91                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9F92 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9F92
DOSCODE:9F92 </span><span style="color:gray">_GotCh</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9F92                 </span><span style="color:navy">mov     al, ds:</span>DSKCHRET
<span style="color:black">DOSCODE:9F95                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3           </span>; &quot;C&quot;-&quot;@&quot;
<span style="color:black">DOSCODE:9F97                 </span><span style="color:navy">jnz     short </span><span style="color:gray">RET36
</span><span style="color:black">DOSCODE:9F99                 </span><span style="color:navy">mov     ds:</span>DSKSTCOM<span style="color:navy">, </span><span style="color:#ff8000">4  </span>; DEVRD
<span style="color:black">DOSCODE:9F9E                 </span><span style="color:navy">mov     ds:</span>DSKSTCALL<span style="color:navy">, </span><span style="color:#ff8000">16h </span>; DRDWRHL
<span style="color:black">DOSCODE:9FA3                 </span><span style="color:navy">mov     ds:</span>DSKCHRET<span style="color:navy">, cl
</span><span style="color:black">DOSCODE:9FA7                 </span><span style="color:navy">mov     ds:</span>DSKSTST<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9FAD                 </span><span style="color:navy">mov     ds:</span>DSKSTCNT<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:9FB3                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:9FB4                 </span><span style="color:navy">call    </span>DEVIOCALL2      ; Eat the ^C
<span style="color:black">DOSCODE:9FB7                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:9FB8                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:9FB9                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:9FBA                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:9FBB                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:9FBC                 </span><span style="color:navy">jmp     </span>CNTCHAND
<span style="color:black">DOSCODE:9FBC </span>DSKSTATCHK      <span style="color:black">endp
DOSCODE:9FBC
DOSCODE:9FBF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9FBF </span><span style="color:gray">; START OF FUNCTION CHUNK FOR STATCHK
</span><span style="color:black">DOSCODE:9FBF
DOSCODE:9FBF </span><span style="color:gray">NOSTOP</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9FBF                 </span><span style="color:navy">cmp     al, </span><span style="color:green">16          </span>; &quot;P&quot;-&quot;@&quot;
<span style="color:black">DOSCODE:9FC1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">check_next
</span><span style="color:black">DOSCODE:9FC3                 </span><span style="color:navy">cmp     ss:</span>SCAN_FLAG<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; ALT_Q ?
<span style="color:black">DOSCODE:9FC9                 </span><span style="color:navy">jz      short </span><span style="color:gray">INCHKJ    </span>; no
<span style="color:black">DOSCODE:9FCB                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9FCC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9FCC
DOSCODE:9FCC </span><span style="color:gray">check_next</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9FCC                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3           </span>; &quot;C&quot;-&quot;@&quot;
<span style="color:black">DOSCODE:9FCE                 </span><span style="color:navy">jz      short </span><span style="color:gray">INCHKJ
</span><span style="color:black">DOSCODE:9FD0
DOSCODE:9FD0 </span><span style="color:gray">check_end</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9FD0                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:9FD1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9FD1
DOSCODE:9FD1 </span><span style="color:gray">INCHKJ</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9FD1                 </span><span style="color:navy">jmp     </span><span style="color:gray">INCHK
</span><span style="color:black">DOSCODE:9FD1 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR STATCHK
</span><span style="color:black">DOSCODE:9FD4
DOSCODE:9FD4 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:9FD4
DOSCODE:9FD4
DOSCODE:9FD4 </span>SPOOLINT        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9FD4                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:9FD5                 </span><span style="color:navy">cmp     ss:</span>IDLEINT<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9FDB                 </span><span style="color:navy">jz      short </span><span style="color:gray">POPFRET
</span><span style="color:black">DOSCODE:9FDD                 </span><span style="color:navy">cmp     ss:</span>ERRORMODE<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:9FE3                 </span><span style="color:navy">jnz     short </span><span style="color:gray">POPFRET
</span><span style="color:black">DOSCODE:9FE5                 </span><span style="color:navy">push    word ptr ss:</span>IDLEINT
<span style="color:black">DOSCODE:9FEA                 </span><span style="color:navy">cmp     ss:</span>DosHasHMA<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; Q: is dos running in HMA
<span style="color:black">DOSCODE:9FF0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">do_low_int28 </span>; Y: the int must be done from low mem
<span style="color:black">DOSCODE:9FF2                 </span><span style="color:navy">int     </span><span style="color:green">28h             </span>; DOS 2+ internal - KEYBOARD BUSY LOOP
<span style="color:black">DOSCODE:9FF4                 </span><span style="color:navy">jmp     short </span><span style="color:gray">spool_ret_addr
</span><span style="color:black">DOSCODE:9FF6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:9FF6
DOSCODE:9FF6 </span><span style="color:gray">do_low_int28</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9FF6                 </span><span style="color:navy">call    dword ptr cs:</span>LowInt28Addr ; call far [cs:LowInt28Addr]
<span style="color:black">DOSCODE:9FFB
DOSCODE:9FFB </span><span style="color:gray">spool_ret_addr</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:9FFB                 </span><span style="color:navy">pop     word ptr ss:</span>IDLEINT
<span style="color:black">DOSCODE:A000
DOSCODE:A000 </span><span style="color:gray">POPFRET</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A000                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:A001
DOSCODE:A001 </span>_RET18<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A001                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A001 </span>SPOOLINT        <span style="color:black">endp
DOSCODE:A001
DOSCODE:A002
DOSCODE:A002 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:A002
DOSCODE:A002
DOSCODE:A002 </span>STATCHK         <span style="color:black">proc far                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A002
DOSCODE:A002 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:4123 SIZE 00000088 BYTES
</span><span style="color:black">DOSCODE:A002 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:41AF SIZE 00000003 BYTES
</span><span style="color:black">DOSCODE:A002 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:41D7 SIZE 00000148 BYTES
</span><span style="color:black">DOSCODE:A002 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:9FBF SIZE 00000015 BYTES
</span><span style="color:black">DOSCODE:A002
DOSCODE:A002                 </span><span style="color:navy">call    </span>DSKSTATCHK      ; Allows ^C to be detected under
<span style="color:black">DOSCODE:A002                                         </span>; input redirection
<span style="color:black">DOSCODE:A005                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:A006                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:A008                 </span><span style="color:navy">call    </span>GET_IO_SFT
<span style="color:black">DOSCODE:A00B                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:A00C                 </span><span style="color:navy">jb      short </span>_RET18
<span style="color:black">DOSCODE:A00E                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:A010                 </span><span style="color:navy">call    </span>IOFUNC
<span style="color:black">DOSCODE:A013                 </span><span style="color:navy">jz      short </span>SPOOLINT
<span style="color:black">DOSCODE:A015                 </span><span style="color:navy">cmp     al, </span><span style="color:green">19          </span>; &#039;S&#039;-&#039;@&#039;
<span style="color:black">DOSCODE:A017                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOSTOP
</span><span style="color:black">DOSCODE:A019                 </span><span style="color:navy">cmp     ss:</span>SCAN_FLAG<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; ALT_R ?
<span style="color:black">DOSCODE:A01F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">check_end </span>; yes
<span style="color:black">DOSCODE:A021                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:A023                 </span><span style="color:navy">call    </span>IOFUNC          ; Eat Cntrl-S
<span style="color:black">DOSCODE:A026                 </span><span style="color:navy">jmp     short </span><span style="color:gray">PAUSOSTRT
</span><span style="color:black">DOSCODE:A028 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A028
DOSCODE:A028 </span><span style="color:gray">PRINT_ON_OFF</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A028                 </span><span style="color:navy">not     ss:</span>PFLAG
<span style="color:black">DOSCODE:A02D                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:A02E                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">4
</span><span style="color:black">DOSCODE:A031                 </span><span style="color:navy">call    </span>GET_IO_SFT
<span style="color:black">DOSCODE:A034                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:A035                 </span><span style="color:navy">jb      short </span>_RET18
<span style="color:black">DOSCODE:A037                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:A038                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:A039                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:A03A                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:A03B                 </span><span style="color:navy">mov     di, si
</span><span style="color:black">DOSCODE:A03D                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:green">8 </span>; [ES:DI+SF_ENTRY.sf_flags+1],(sf_net_spool&gt;&gt;8)
<span style="color:black">DOSCODE:A042                 </span><span style="color:navy">jz      short </span><span style="color:gray">NORM_PR   </span>; Not redirected, echo is OK
<span style="color:black">DOSCODE:A044                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:A045                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1126h
</span><span style="color:black">DOSCODE:A048                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - ???
<span style="color:black">DOSCODE:A048                                         </span>; Return: CF set on error, AX = error code
<span style="color:black">DOSCODE:A048                                         </span>; STACK unchanged
<span style="color:black">DOSCODE:A04A                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:A04B                 </span><span style="color:navy">jnb     short </span><span style="color:gray">NORM_PR   </span>; Echo is OK
<span style="color:black">DOSCODE:A04D                 </span><span style="color:navy">mov     ss:</span>PFLAG<span style="color:navy">, </span><span style="color:#ff8000">0     </span>; If not allowed, disable echo
<span style="color:black">DOSCODE:A053                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:A054                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1124h
</span><span style="color:black">DOSCODE:A057                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - ???
<span style="color:black">DOSCODE:A057                                         </span>; ES:DI -&gt; SFT, SS = DOS CS
<span style="color:black">DOSCODE:A059                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:A05A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">RETP6
</span><span style="color:black">DOSCODE:A05C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A05C
DOSCODE:A05C </span><span style="color:gray">NORM_PR</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A05C                 </span><span style="color:navy">cmp     ss:</span>PFLAG<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A062                 </span><span style="color:navy">jnz     short </span><span style="color:gray">PRNOPN
</span><span style="color:black">DOSCODE:A064                 </span><span style="color:navy">call    </span>DEV_CLOSE_SFT
<span style="color:black">DOSCODE:A067                 </span><span style="color:navy">jmp     short </span><span style="color:gray">RETP6
</span><span style="color:black">DOSCODE:A069 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A069
DOSCODE:A069 </span><span style="color:gray">PRNOPN</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A069                 </span><span style="color:navy">call    </span>DEV_OPEN_SFT
<span style="color:black">DOSCODE:A06C
DOSCODE:A06C </span><span style="color:gray">RETP6</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A06C                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:A06D                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:A06E
DOSCODE:A06E </span><span style="color:gray">STATCHK_RETN</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A06E                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A06F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A06F
DOSCODE:A06F </span><span style="color:gray">PAUSOLP</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A06F                 </span><span style="color:navy">call    </span>SPOOLINT
<span style="color:black">DOSCODE:A072
DOSCODE:A072 </span><span style="color:gray">PAUSOSTRT</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A072                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:A074                 </span><span style="color:navy">call    </span>IOFUNC
<span style="color:black">DOSCODE:A077                 </span><span style="color:navy">jz      short </span><span style="color:gray">PAUSOLP
</span><span style="color:black">DOSCODE:A079
DOSCODE:A079 </span><span style="color:gray">INCHK</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A079                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:A07A                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:A07C                 </span><span style="color:navy">call    </span>GET_IO_SFT
<span style="color:black">DOSCODE:A07F                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:A080                 </span><span style="color:navy">jb      short </span><span style="color:gray">STATCHK_RETN
</span><span style="color:black">DOSCODE:A082                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:A084                 </span><span style="color:navy">call    </span>IOFUNC
<span style="color:black">DOSCODE:A087                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">10h         </span>; &quot;P&quot;-&quot;@&quot;
<span style="color:black">DOSCODE:A089                 </span><span style="color:navy">jz      short </span><span style="color:gray">PRINT_ON_OFF </span>; must be CTRL_P
<span style="color:black">DOSCODE:A08B                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3           </span>; &quot;C&quot;-&quot;@&quot;
<span style="color:black">DOSCODE:A08D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">STATCHK_RETN
</span><span style="color:black">DOSCODE:A08F
DOSCODE:A08F </span>CNTCHAND<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A08F                 </span><span style="color:navy">test    byte ptr ss:</span>DOS34_FLAG<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:green">2 </span>; (CTRL_BREAK_FLAG&gt;&gt;8)
<span style="color:black">DOSCODE:A095                 </span><span style="color:navy">jnz     short </span><span style="color:gray">around_deadlock
</span><span style="color:black">DOSCODE:A097                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3           </span>; Display &quot;^C&quot;
<span style="color:black">DOSCODE:A099                 </span><span style="color:navy">call    </span>BUFOUT
<span style="color:black">DOSCODE:A09C                 </span><span style="color:navy">call    </span>CRLF
<span style="color:black">DOSCODE:A09F
DOSCODE:A09F </span><span style="color:gray">around_deadlock</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A09F                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:A0A0                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:A0A1                 </span><span style="color:navy">cmp     ds:</span>CONSWAP<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A0A6                 </span><span style="color:navy">jz      short </span><span style="color:gray">NOSWAP
</span><span style="color:black">DOSCODE:A0A8                 </span><span style="color:navy">call    </span>SWAPBACK
<span style="color:black">DOSCODE:A0AB
DOSCODE:A0AB </span><span style="color:gray">NOSWAP</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A0AB                 </span><span style="color:navy">cli                     </span>; Prepare to play with stack
<span style="color:black">DOSCODE:A0AC                 </span><span style="color:navy">mov     ss, ds:</span>USER_SS  ; User stack now restored
<span style="color:black">DOSCODE:A0B0                 </span><span style="color:navy">mov     sp, ds:</span>USER_SP
<span style="color:black">DOSCODE:A0B4                 </span><span style="color:navy">call    </span>restore_world   ; User registers now restored
<span style="color:black">DOSCODE:A0B7                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:A0B8                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:A0B9                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:A0BE                 </span><span style="color:navy">mov     ds:</span>INDOS<span style="color:navy">, </span><span style="color:#ff8000">0     </span>; Go to known state
<span style="color:black">DOSCODE:A0C3                 </span><span style="color:navy">mov     ds:</span>INDOS_FLAG<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A0C8                 </span><span style="color:navy">mov     ds:</span>ERRORMODE<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A0CD                 </span><span style="color:navy">mov     ds:</span>ConC_Spsave<span style="color:navy">, sp </span>; save his SP
<span style="color:black">DOSCODE:A0D1                 </span><span style="color:navy">add     ds:</span>ConC_Spsave<span style="color:navy">, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:A0D6                 </span><span style="color:navy">cmp     ds:</span>DosHasHMA<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; Q: is dos running in HMA
<span style="color:black">DOSCODE:A0DB                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:A0DC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">do_low_int23 </span>; Y: the int must be done from low mem
<span style="color:black">DOSCODE:A0DE                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:A0DF                 </span><span style="color:navy">int     </span><span style="color:green">23h             </span>; DOS - CONTROL &quot;C&quot; EXIT ADDRESS
<span style="color:black">DOSCODE:A0DF                                         </span>; Return: return via RETF 2 with CF set
<span style="color:black">DOSCODE:A0DF                                         </span>; DOS will abort program with errorlevel 0
<span style="color:black">DOSCODE:A0DF                                         </span>; else
<span style="color:black">DOSCODE:A0DF                                         </span>; interrupted DOS call continues
<span style="color:black">DOSCODE:A0E1                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ctrlc_ret_addr
</span><span style="color:black">DOSCODE:A0E3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A0E3
DOSCODE:A0E3 </span><span style="color:gray">do_low_int23</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A0E3                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:A0E4                 </span><span style="color:navy">call    dword ptr cs:</span>LowInt23Addr ; call far [cs:LowInt23Addr]
<span style="color:black">DOSCODE:A0E9
DOSCODE:A0E9 </span><span style="color:gray">ctrlc_ret_addr</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A0E9                 </span><span style="color:navy">cli
</span><span style="color:black">DOSCODE:A0EA                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:A0EB                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:black">DOSCODE:A0ED                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:A0F2                 </span><span style="color:navy">mov     ds:</span>TEMPSEG<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:A0F5                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:A0F6                 </span><span style="color:navy">mov     ds:</span>USER_IN_AX<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:A0F9                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:A0FA                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:A0FB                 </span><span style="color:navy">cmp     sp, ds:</span>ConC_Spsave
<span style="color:black">DOSCODE:A0FF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ctrlc_try_new </span>; current SP not the same as saved SP
<span style="color:black">DOSCODE:A101
DOSCODE:A101 </span><span style="color:gray">ctrlc_repeat</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A101                 </span><span style="color:navy">mov     ax, ds:</span>USER_IN_AX
<span style="color:black">DOSCODE:A104                 </span><span style="color:navy">mov     ds, ds:</span>TEMPSEG  ; restore ds and original sp
<span style="color:black">DOSCODE:A108
DOSCODE:A108 </span><span style="color:gray">COMMANDJ</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A108                 </span><span style="color:navy">jmp     </span>COMMAND
<span style="color:black">DOSCODE:A10B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A10B
DOSCODE:A10B </span><span style="color:gray">ctrlc_try_new</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A10B                 </span><span style="color:navy">test    al, </span><span style="color:green">1           </span>; f_Carry
<span style="color:black">DOSCODE:A10D                 </span><span style="color:navy">pop     ax              </span>; add sp,2
<span style="color:black">DOSCODE:A10E                 </span><span style="color:navy">jz      short </span><span style="color:gray">ctrlc_repeat
</span><span style="color:black">DOSCODE:A110                 </span><span style="color:navy">mov     ds, ds:</span>TEMPSEG
<span style="color:black">DOSCODE:A114
DOSCODE:A114 </span>ctrlc_abort<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A114                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4C00h       </span>; (EXIT*256) + 0
<span style="color:black">DOSCODE:A117                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:A118                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:A11D                 </span><span style="color:navy">mov     ds:</span>DidCTRLC<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; -1
<span style="color:black">DOSCODE:A122                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:A123                 </span><span style="color:navy">jmp     short </span><span style="color:gray">COMMANDJ
</span><span style="color:black">DOSCODE:A123 </span><span style="background:red">STATCHK         endp</span><span style="background:red"> ; sp-analysis failed</span>
<span style="color:black">DOSCODE:A123
</span><span style="color:maroon">DOSCODE:A125 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:A125
DOSCODE:A125 </span>DIVOV<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:A125                 </span><span style="color:navy">mov     si, offset </span>DIVMES <span style="color:gray">; &quot;\r\nDivide overflow\r\n&quot;
</span><span style="color:maroon">DOSCODE:A128                 </span><span style="color:navy">mov     bx, cs:</span>DivMesLen
<span style="color:maroon">DOSCODE:A12D                 </span><span style="color:navy">mov     ss, cs:</span>DosDSeg
<span style="color:maroon">DOSCODE:A132                 </span><span style="color:navy">mov     sp, </span><span style="color:#ff8000">7A0h        </span>; AUXSTACK
<span style="color:maroon">DOSCODE:A135                 </span><span style="color:navy">call    </span>_OUTMES
<span style="color:maroon">DOSCODE:A138                 </span><span style="color:navy">jmp     short </span>ctrlc_abort ; Use Ctrl-C abort on divide overflow
<span style="color:black">DOSCODE:A13A
DOSCODE:A13A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:A13A
DOSCODE:A13A
DOSCODE:A13A </span>_OUTMES         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A13A                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:A13B                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:A13C                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:A13D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:A13E                 </span><span style="color:navy">mov     ds:</span>DSKSTCOM<span style="color:navy">, </span><span style="color:#ff8000">8  </span>; DEVWRT
<span style="color:black">DOSCODE:A143                 </span><span style="color:navy">mov     ds:</span>DSKSTCALL<span style="color:navy">, </span><span style="color:#ff8000">16h </span>; DRDWRHL
<span style="color:black">DOSCODE:A148                 </span><span style="color:navy">mov     ds:</span>DSKSTST<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A14E                 </span><span style="color:navy">mov     ds:</span>DSKSTCNT<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:A152                 </span><span style="color:navy">mov     bx, offset </span>DSKSTCALL
<span style="color:black">DOSCODE:A155                 </span><span style="color:navy">mov     ds:</span>DEVIOBUF_PTR<span style="color:navy">, si
</span><span style="color:black">DOSCODE:A159                 </span><span style="color:navy">mov     ds:</span>DOSSEG_INIT<span style="color:navy">, cs
</span><span style="color:black">DOSCODE:A15D                 </span><span style="color:navy">lds     si, ds:</span>BCON
<span style="color:black">DOSCODE:A161                 </span><span style="color:navy">call    </span>DEVIOCALL2
<span style="color:black">DOSCODE:A164                 </span><span style="color:navy">mov     es:</span>DEVIOBUF_PTR<span style="color:navy">, offset </span>DEVIOBUF
<span style="color:black">DOSCODE:A16B                 </span><span style="color:navy">mov     es:</span>DSKSTCNT<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:A172                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A172 </span>_OUTMES         <span style="color:black">endp
DOSCODE:A172
DOSCODE:A173
DOSCODE:A173 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:A173
DOSCODE:A173
DOSCODE:A173 </span>CHARHARD        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A173                 </span><span style="color:navy">cmp     ss:</span>ERRORMODE<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; Q: are we in the middle of int 24
<span style="color:black">DOSCODE:A179                 </span><span style="color:navy">jnz     short </span><span style="color:gray">chard1    </span>; Y: allow fail
<span style="color:black">DOSCODE:A17B                 </span><span style="color:navy">or      ah, </span><span style="color:green">10h         </span>; Allowed_RETRY ; assume ctrl p
<span style="color:black">DOSCODE:A17E                 </span><span style="color:navy">test    ss:</span>PFLAG<span style="color:navy">, </span><span style="color:green">0FFh  </span>; Q: has ctrl p been pressed
<span style="color:black">DOSCODE:A184                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ctrlp     </span>; Y:
<span style="color:black">DOSCODE:A186
DOSCODE:A186 </span><span style="color:gray">chard1</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A186                 </span><span style="color:navy">or      ah, </span><span style="color:green">38h         </span>; Allowed_IGNORE+Allowed_RETRY+Allowed_FAIL
<span style="color:black">DOSCODE:A189
DOSCODE:A189 </span><span style="color:gray">ctrlp</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A189                 </span><span style="color:navy">mov     ss:</span>ALLOWED<span style="color:navy">, ah
</span><span style="color:black">DOSCODE:A18E                 </span><span style="color:navy">mov     word ptr ss:</span>EXITHOLD<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:A193                 </span><span style="color:navy">mov     word ptr ss:</span>EXITHOLD<span style="color:navy">, bp
</span><span style="color:black">DOSCODE:A198                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:A199                 </span><span style="color:navy">and     di, </span><span style="color:green">0FFh        </span>; STECODE
<span style="color:black">DOSCODE:A19D                 </span><span style="color:navy">mov     bp, ds          </span>; Device pointer is BP:SI
<span style="color:black">DOSCODE:A19F                 </span><span style="color:navy">call    near ptr </span>FATALC
<span style="color:black">DOSCODE:A1A2                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:A1A3                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A1A3 </span>CHARHARD        <span style="color:black">endp
DOSCODE:A1A3
DOSCODE:A1A4
DOSCODE:A1A4 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:A1A4
DOSCODE:A1A4
DOSCODE:A1A4 </span>HARDERR         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A1A4                 </span><span style="color:navy">xchg    ax, di          </span>; Error code in DI, count in AX
<span style="color:black">DOSCODE:A1A5                 </span><span style="color:navy">and     di, </span><span style="color:green">0FFh        </span>; STECODE
<span style="color:black">DOSCODE:A1A9                 </span><span style="color:navy">cmp     di, </span><span style="color:#ff8000">0           </span>; error_I24_write_protect
<span style="color:black">DOSCODE:A1A9                                         </span>; Write Protect Error?
<span style="color:black">DOSCODE:A1AC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NOSETWRPERR
</span><span style="color:black">DOSCODE:A1AE                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:A1AF                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; [ES:BP+DPB.DRIVE]
<span style="color:black">DOSCODE:A1B3                 </span><span style="color:navy">mov     ss:</span>WPERR<span style="color:navy">, al    </span>; Flag drive with WP error
<span style="color:black">DOSCODE:A1B7                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:A1B8
DOSCODE:A1B8 </span><span style="color:gray">NOSETWRPERR</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A1B8                 </span><span style="color:navy">sub     ax, cx          </span>; Number of sectors successfully transferred
<span style="color:black">DOSCODE:A1BA                 </span><span style="color:navy">add     dx, ax          </span>; First sector number to retry
<span style="color:black">DOSCODE:A1BC                 </span><span style="color:navy">adc     ss:</span>HIGH_SECTOR<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A1C2                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:A1C3                 </span><span style="color:navy">mul     word ptr es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">] </span>; [ES:BP+DPB.SECTOR_SIZE]
<span style="color:black">DOSCODE:A1C3                                         </span>; DX:AX = Number of bytes transferred
<span style="color:black">DOSCODE:A1C7                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:A1C8                 </span><span style="color:navy">add     bx, ax          </span>; First address for retry
<span style="color:black">DOSCODE:A1CA                 </span><span style="color:navy">xor     ah, ah          </span>; Flag disk section in error
<span style="color:black">DOSCODE:A1CC                 </span><span style="color:navy">cmp     ss:</span>HIGH_SECTOR<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A1D2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">TESTDIR
</span><span style="color:black">DOSCODE:A1D4                 </span><span style="color:navy">cmp     dx, es:[bp+</span><span style="color:#ff8000">6</span><span style="color:navy">]   </span>; [ES:BP+DPB.FIRST_FAT]
<span style="color:black">DOSCODE:A1D4                                         </span>; In reserved area?
<span style="color:black">DOSCODE:A1D8                 </span><span style="color:navy">jb      short </span><span style="color:gray">ERRINT
</span><span style="color:black">DOSCODE:A1DA
DOSCODE:A1DA </span><span style="color:gray">TESTDIR</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A1DA                 </span><span style="color:navy">inc     ah
</span><span style="color:black">DOSCODE:A1DC                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:bp+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:A1E1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">TESTDIR3  </span>; not FAT32
<span style="color:black">DOSCODE:A1E3                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:A1E4                 </span><span style="color:navy">mov     dx, ss:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:A1E9                 </span><span style="color:navy">cmp     dx, es:[bp+</span><span style="color:#ff8000">2Bh</span><span style="color:navy">] </span>; [es:bp+DPB.FCLUS_FSECTOR+2]
<span style="color:black">DOSCODE:A1ED                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:A1EE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">TESTDIR1  </span>; Err in FAT must force recomp of freespace
<span style="color:black">DOSCODE:A1F0                 </span><span style="color:navy">cmp     dx, es:[bp+</span><span style="color:#ff8000">29h</span><span style="color:navy">] </span>; [es:bp+DPB.FCLUS_FSECTOR]
<span style="color:black">DOSCODE:A1F4
DOSCODE:A1F4 </span><span style="color:gray">TESTDIR1</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A1F4                 </span><span style="color:navy">jnb     short </span><span style="color:gray">TESTDIR2
</span><span style="color:black">DOSCODE:A1F6                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; -1 ; [es:bp+DPB.FREE_CNT]
<span style="color:black">DOSCODE:A1FC                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">21h</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; -1 ; [es:bp+DPB.FREE_CNT+2]
<span style="color:black">DOSCODE:A202                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ERRINT
</span><span style="color:black">DOSCODE:A204 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A204
DOSCODE:A204 </span><span style="color:gray">TESTDIR2</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A204                 </span><span style="color:navy">inc     ah
</span><span style="color:black">DOSCODE:A206                 </span><span style="color:navy">inc     ah
</span><span style="color:black">DOSCODE:A208                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ERRINT
</span><span style="color:black">DOSCODE:A20A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A20A
DOSCODE:A20A </span><span style="color:gray">TESTDIR3</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A20A                 </span><span style="color:navy">cmp     dx, es:[bp+</span><span style="color:#ff8000">11h</span><span style="color:navy">] </span>; [ES:BP+DPB.DIR_SECTOR]
<span style="color:black">DOSCODE:A20E                 </span><span style="color:navy">jnb     short </span><span style="color:gray">TESTDIR4  </span>; not in FAT
<span style="color:black">DOSCODE:A210                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; [ES:BP+DPB.FREE_CNT],-1
<span style="color:black">DOSCODE:A216                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ERRINT
</span><span style="color:black">DOSCODE:A218 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A218
DOSCODE:A218 </span><span style="color:gray">TESTDIR4</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A218                 </span><span style="color:navy">inc     ah
</span><span style="color:black">DOSCODE:A21A                 </span><span style="color:navy">cmp     dx, es:[bp+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">] </span>; [ES:BP+DPB.FIRST_SECTOR]
<span style="color:black">DOSCODE:A21E                 </span><span style="color:navy">jb      short </span><span style="color:gray">ERRINT
</span><span style="color:black">DOSCODE:A220                 </span><span style="color:navy">inc     ah
</span><span style="color:black">DOSCODE:A222
DOSCODE:A222 </span><span style="color:gray">ERRINT</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A222                 </span><span style="color:navy">shl     ah, </span><span style="color:green">1           </span>; Make room for read/write bit
<span style="color:black">DOSCODE:A224                 </span><span style="color:navy">or      ah, ss:</span>READOP
<span style="color:black">DOSCODE:A229                 </span><span style="color:navy">or      ah, ss:</span>ALLOWED  ; Set the allowed bits
<span style="color:black">DOSCODE:A229 </span>HARDERR         <span style="color:black">endp
DOSCODE:A229
DOSCODE:A22E
DOSCODE:A22E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:A22E
DOSCODE:A22E
DOSCODE:A22E </span>FATAL           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A22E                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]   </span>; [ES:BP+DPB.DRIVE]
<span style="color:black">DOSCODE:A22E </span>FATAL           <span style="color:black">endp
DOSCODE:A22E
DOSCODE:A232
DOSCODE:A232 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:A232
DOSCODE:A232
DOSCODE:A232 </span>FATAL1          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A232                 </span><span style="color:navy">mov     word ptr ss:</span>EXITHOLD<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:A237                 </span><span style="color:navy">mov     word ptr ss:</span>EXITHOLD<span style="color:navy">, bp </span>; The only things we preserve
<span style="color:black">DOSCODE:A23C                 </span><span style="color:navy">les     si, es:[bp+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [ES:BP+DPB.DRIVER_ADDR]
<span style="color:black">DOSCODE:A240                 </span><span style="color:navy">mov     bp, es          </span>; BP:SI points to the device involved
<span style="color:black">DOSCODE:A240 </span>FATAL1          <span style="color:black">endp
DOSCODE:A240
DOSCODE:A242
DOSCODE:A242 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:A242
DOSCODE:A242
DOSCODE:A242 </span>FATALC          <span style="color:black">proc far                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A242
DOSCODE:A242 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:B40B SIZE 0000000D BYTES
</span><span style="color:black">DOSCODE:A242 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:B420 SIZE 00000022 BYTES
</span><span style="color:black">DOSCODE:A242
DOSCODE:A242                 </span><span style="color:navy">call    </span>SET_I24_EXTENDED_ERROR
<span style="color:black">DOSCODE:A245                 </span><span style="color:navy">cmp     di, </span><span style="color:#ff8000">0Ch         </span>; error_I24_gen_failure
<span style="color:black">DOSCODE:A248                 </span><span style="color:navy">jbe     short </span>NET_I24_ENTRY ; GOT_RIGHT_CODE
<span style="color:black">DOSCODE:A24A                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">0Ch         </span>; Error codes above gen_failure get
<span style="color:black">DOSCODE:A24A                                         </span>; mapped to gen_failure. Real codes
<span style="color:black">DOSCODE:A24A                                         </span>; only come via GetExtendedError
<span style="color:black">DOSCODE:A24D
DOSCODE:A24D </span>NET_I24_ENTRY<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A24D                 </span><span style="color:navy">cmp     ss:</span>ERRORMODE<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; No INT 24s if already INT 24
<span style="color:black">DOSCODE:A253                 </span><span style="color:navy">jz      short </span><span style="color:gray">NoSetFail
</span><span style="color:black">DOSCODE:A255                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:A257                 </span><span style="color:navy">jmp     short </span><span style="color:gray">FailRet
</span><span style="color:black">DOSCODE:A259 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A259
DOSCODE:A259 </span><span style="color:gray">NoSetFail</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A259                 </span><span style="color:navy">mov     ss:</span>CONTSTK<span style="color:navy">, sp
</span><span style="color:black">DOSCODE:A25E                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:A25F                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:A260                 </span><span style="color:navy">cmp     ss:</span>SFN<span style="color:navy">, </span><span style="color:green">0FFFFh  </span>; -1
<span style="color:black">DOSCODE:A266                 </span><span style="color:navy">jz      short </span><span style="color:gray">_NoFree
</span><span style="color:black">DOSCODE:A268                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:A269                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:A26A                 </span><span style="color:navy">lds     si, ss:</span>PJFN
<span style="color:black">DOSCODE:A26F                 </span><span style="color:navy">mov     byte ptr [si], </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:A272                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:A273                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:A274
DOSCODE:A274 </span><span style="color:gray">_NoFree</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A274                 </span><span style="color:navy">cli                     </span>; Prepare to play with stack
<span style="color:black">DOSCODE:A275                 </span><span style="color:navy">inc     ss:</span>ERRORMODE    ; Flag INT 24 in progress
<span style="color:black">DOSCODE:A27A                 </span><span style="color:navy">dec     ss:</span>INDOS        ; INT 24 handler might not return
<span style="color:black">DOSCODE:A27F                 </span><span style="color:navy">dec     ss:</span>INDOS_FLAG
<span style="color:black">DOSCODE:A284                 </span><span style="color:navy">test    ss:</span>EXTOPEN_ON<span style="color:navy">, </span><span style="color:green">2 </span>; EXT_OPEN_I24_OFF
<span style="color:black">DOSCODE:A28A                 </span><span style="color:navy">jz      short </span><span style="color:gray">i24yes
</span><span style="color:black">DOSCODE:A28C                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3           </span>; fake fail
<span style="color:black">DOSCODE:A28E                 </span><span style="color:navy">jmp     short </span><span style="color:gray">passi24
</span><span style="color:black">DOSCODE:A290 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A290
DOSCODE:A290 </span><span style="color:gray">i24yes</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A290                 </span><span style="color:navy">mov     ss, ss:</span>USER_SS
<span style="color:black">DOSCODE:A295                 </span><span style="color:navy">mov     sp, es:</span>USER_SP  ; User stack pointer restored
<span style="color:black">DOSCODE:A29A                 </span><span style="color:navy">cmp     es:</span>DosHasHMA<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; Q: is dos running in HMA
<span style="color:black">DOSCODE:A2A0                 </span><span style="color:navy">jnz     short </span><span style="color:gray">do_low_int24 </span>; Y: the int must be done from low mem
<span style="color:black">DOSCODE:A2A2                 </span><span style="color:navy">int     </span><span style="color:green">24h             </span>; DOS - FATAL ERROR HANDLER ADDRESS
<span style="color:black">DOSCODE:A2A2                                         </span>; Automatically called upon detection of unrecoverable I/O error.
<span style="color:black">DOSCODE:A2A4                 </span><span style="color:navy">jmp     short </span><span style="color:gray">criterr_ret_addr
</span><span style="color:black">DOSCODE:A2A6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A2A6
DOSCODE:A2A6 </span><span style="color:gray">do_low_int24</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A2A6                 </span><span style="color:navy">call    dword ptr cs:</span>LowInt24Addr ; call far [cs:LowInt24Addr]
<span style="color:black">DOSCODE:A2AB
DOSCODE:A2AB </span><span style="color:gray">criterr_ret_addr</span><span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A2AB                 </span><span style="color:navy">mov     es:</span>USER_SP<span style="color:navy">, sp  </span>; restore our stack
<span style="color:black">DOSCODE:A2B0                 </span><span style="color:navy">mov     es:</span>USER_SS<span style="color:navy">, ss
</span><span style="color:black">DOSCODE:A2B5                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:A2B6                 </span><span style="color:navy">pop     ss
</span><span style="color:black">DOSCODE:A2B7
DOSCODE:A2B7 </span><span style="color:gray">passi24</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A2B7                 </span><span style="color:navy">mov     sp, ss:</span>CONTSTK
<span style="color:black">DOSCODE:A2BC                 </span><span style="color:navy">inc     ss:</span>INDOS        ; Back in the DOS
<span style="color:black">DOSCODE:A2C1                 </span><span style="color:navy">inc     ss:</span>INDOS_FLAG
<span style="color:black">DOSCODE:A2C6                 </span><span style="color:navy">mov     ss:</span>ERRORMODE<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; Back from INT 24
<span style="color:black">DOSCODE:A2CC                 </span><span style="color:navy">sti
</span><span style="color:black">DOSCODE:A2CD
DOSCODE:A2CD </span><span style="color:gray">FailRet</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A2CD                 </span><span style="color:navy">les     bp, ss:</span>EXITHOLD
<span style="color:black">DOSCODE:A2D2                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:A2D4                 </span><span style="color:navy">jb      short </span><span style="color:gray">CheckIgnore </span>; 0 =&gt; ignore
<span style="color:black">DOSCODE:A2D6                 </span><span style="color:navy">jz      short </span><span style="color:gray">CheckRetry </span>; 1 =&gt; retry
<span style="color:black">DOSCODE:A2D8                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3           </span>; 3 =&gt; fail
<span style="color:black">DOSCODE:A2DA                 </span><span style="color:navy">jnz     short </span><span style="color:gray">DoAbort   </span>; 2, invalid =&gt; abort
<span style="color:black">DOSCODE:A2DC                 </span><span style="color:navy">test    ss:</span>ALLOWED<span style="color:navy">, </span><span style="color:green">8   </span>; Allowed_FAIL ; Can we?
<span style="color:black">DOSCODE:A2E2                 </span><span style="color:navy">jz      short </span><span style="color:gray">DoAbort   </span>; No, do abort
<span style="color:black">DOSCODE:A2E4
DOSCODE:A2E4 </span><span style="color:gray">DoFail</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A2E4                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:A2E6                 </span><span style="color:navy">test    ss:</span>EXTOPEN_ON<span style="color:navy">, </span><span style="color:green">2 </span>; EXT_OPEN_I24_OFF
<span style="color:black">DOSCODE:A2EC                 </span><span style="color:navy">jnz     short </span><span style="color:gray">CleanUp
</span><span style="color:black">DOSCODE:A2EE                 </span><span style="color:navy">inc     ss:</span>FAILERR      ; Tell everybody
<span style="color:black">DOSCODE:A2F3
DOSCODE:A2F3 </span><span style="color:gray">CleanUp</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A2F3                 </span><span style="color:navy">mov     ss:</span>WPERR<span style="color:navy">, </span><span style="color:#ff8000">0FFh  </span>; -1
<span style="color:black">DOSCODE:A2F9                 </span><span style="color:navy">cmp     ss:</span>SFN<span style="color:navy">, </span><span style="color:green">0FFFFh  </span>; -1
<span style="color:black">DOSCODE:A2FF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">CleanUp2
</span><span style="color:black">DOSCODE:A301                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A302 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A302
DOSCODE:A302 </span><span style="color:gray">CleanUp2</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A302                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:A303                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:A304                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:A305                 </span><span style="color:navy">mov     ax, ss:</span>SFN
<span style="color:black">DOSCODE:A309                 </span><span style="color:navy">lds     si, ss:</span>PJFN
<span style="color:black">DOSCODE:A30E                 </span><span style="color:navy">mov     [si], al
</span><span style="color:black">DOSCODE:A310                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:A311                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:A312                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:A313                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A314 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A314
DOSCODE:A314 </span><span style="color:gray">CheckIgnore</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A314                 </span><span style="color:navy">test    ss:</span>ALLOWED<span style="color:navy">, </span><span style="color:green">20h </span>; Allowed_IGNORE ; Can we?
<span style="color:black">DOSCODE:A31A
DOSCODE:A31A </span><span style="color:gray">CheckRI</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A31A                 </span><span style="color:navy">jz      short </span><span style="color:gray">DoFail    </span>; No, do fail
<span style="color:black">DOSCODE:A31C                 </span><span style="color:navy">jmp     short </span><span style="color:gray">CleanUp
</span><span style="color:black">DOSCODE:A31E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A31E
DOSCODE:A31E </span><span style="color:gray">CheckRetry</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A31E                 </span><span style="color:navy">test    ss:</span>ALLOWED<span style="color:navy">, </span><span style="color:green">10h </span>; Allowed_RETRY ; Can we?
<span style="color:black">DOSCODE:A324                 </span><span style="color:navy">jmp     short </span><span style="color:gray">CheckRI   </span>; No, do fail
<span style="color:black">DOSCODE:A326 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A326
DOSCODE:A326 </span><span style="color:gray">DoAbort</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A326                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:A327                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:A328                 </span><span style="color:navy">cmp     ds:</span>CONSWAP<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A32D                 </span><span style="color:navy">jz      short </span><span style="color:gray">NOSWAP2
</span><span style="color:black">DOSCODE:A32F                 </span><span style="color:navy">call    </span>SWAPBACK
<span style="color:black">DOSCODE:A332
DOSCODE:A332 </span><span style="color:gray">NOSWAP2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A332                 </span><span style="color:navy">cmp     ds:</span>fAborting<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A337                 </span><span style="color:navy">jnz     short </span><span style="color:gray">DoFail
</span><span style="color:black">DOSCODE:A339                 </span><span style="color:navy">mov     byte ptr ds:</span>EXIT_TYPE<span style="color:navy">, </span><span style="color:#ff8000">2 </span>; EXIT_HARD_ERROR
<span style="color:black">DOSCODE:A33E                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">DOSCODE:A340                 </span><span style="color:navy">jmp     </span>exit_inner
<span style="color:black">DOSCODE:A343 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A343
DOSCODE:A343 </span><span style="color:gray">reset_environment</span><span style="color:navy">:                      </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A343                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:A344                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">82h
</span><span style="color:black">DOSCODE:A346                 </span><span style="color:navy">int     </span><span style="color:green">2Ah             </span>; Microsoft Networks - END DOS CRITICAL SECTIONS 0 THROUGH 7
<span style="color:black">DOSCODE:A348                 </span><span style="color:navy">mov     ss:</span>fAborting<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:A34E                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1122h
</span><span style="color:black">DOSCODE:A351                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - PROCESS TERMINATION HOOK
<span style="color:black">DOSCODE:A351                                         </span>; SS = DOS CS
<span style="color:black">DOSCODE:A353                 </span><span style="color:navy">mov     al, </span><span style="color:green">22h
</span><span style="color:black">DOSCODE:A355                 </span><span style="color:navy">call    </span>$GET_INTERRUPT_VECTOR
<span style="color:black">DOSCODE:A358                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:A359                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:A35A                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:A35B                 </span><span style="color:navy">mov     bx, ss:</span>CurrentPDB
<span style="color:black">DOSCODE:A360                 </span><span style="color:navy">mov     ds, bx
</span><span style="color:black">DOSCODE:A362                 </span><span style="color:navy">mov     ax, ds:</span><span style="color:green">16h      </span>; [PDB.PARENT_PID]
<span style="color:black">DOSCODE:A365                 </span><span style="color:navy">cmp     ax, bx
</span><span style="color:black">DOSCODE:A367                 </span><span style="color:navy">jz      short </span><span style="color:gray">reset_return </span>; parentPDB = CurrentPDB
<span style="color:black">DOSCODE:A369                 </span><span style="color:navy">cmp     bx, cx
</span><span style="color:black">DOSCODE:A36B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">reset_return </span>; CurrentPDB &lt;&gt; ThisPDB
<span style="color:black">DOSCODE:A36D                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:A36E                 </span><span style="color:navy">cmp     byte ptr ss:</span>EXIT_TYPE<span style="color:navy">, </span><span style="color:#ff8000">3 </span>; EXIT_KEEP_PROCESS
<span style="color:black">DOSCODE:A374                 </span><span style="color:navy">jz      short </span><span style="color:gray">reset_to_parent
</span><span style="color:black">DOSCODE:A376                 </span><span style="color:navy">call    </span>arena_free_process
<span style="color:black">DOSCODE:A379                 </span><span style="color:navy">call    </span>DOS_ABORT
<span style="color:black">DOSCODE:A37C
DOSCODE:A37C </span><span style="color:gray">reset_to_parent</span><span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A37C                 </span><span style="color:navy">pop     ss:</span>CurrentPDB   ; set up process as parent
<span style="color:black">DOSCODE:A381
DOSCODE:A381 </span><span style="color:gray">reset_return</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A381                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:A382                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:A383                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh        </span>; -1
<span style="color:black">DOSCODE:A385                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:A388                 </span><span style="color:navy">call    </span>FLUSHBUF
<span style="color:black">DOSCODE:A38B                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:A38E                 </span><span style="color:navy">cli
</span><span style="color:black">DOSCODE:A38F                 </span><span style="color:navy">mov     ds:</span>INDOS<span style="color:navy">, </span><span style="color:#ff8000">0     </span>; Go to known state
<span style="color:black">DOSCODE:A394                 </span><span style="color:navy">mov     ds:</span>INDOS_FLAG<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A399                 </span><span style="color:navy">mov     ds:</span>WPERR<span style="color:navy">, </span><span style="color:#ff8000">0FFh  </span>; Forget about WP error
<span style="color:black">DOSCODE:A39E                 </span><span style="color:navy">mov     ds:</span>fAborting<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; let aborts occur
<span style="color:black">DOSCODE:A3A3                 </span><span style="color:navy">pop     word ptr ds:</span>EXITHOLD
<span style="color:black">DOSCODE:A3A7                 </span><span style="color:navy">pop     word ptr ds:</span>EXITHOLD<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:A3AB                 </span><span style="color:navy">mov     ds, ds:</span>CurrentPDB
<span style="color:black">DOSCODE:A3AF                 </span><span style="color:navy">mov     ss, word ptr ds:</span><span style="color:green">30h </span>; [PDB.USER_STACK+2]
<span style="color:black">DOSCODE:A3B3                 </span><span style="color:navy">mov     sp, ds:</span><span style="color:green">2Eh      </span>; [PDB.USER_STACK]
<span style="color:black">DOSCODE:A3B7                 </span><span style="color:navy">call    </span>restore_world
<span style="color:black">DOSCODE:A3B7 </span>FATALC          <span style="color:black">endp
DOSCODE:A3B7
</span><span style="color:maroon">DOSCODE:A3BA                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:A3BB                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:A3BC                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:maroon">DOSCODE:A3BE                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:maroon">DOSCODE:A3C3                 </span><span style="color:navy">mov     ds:</span>TEMPSEG<span style="color:navy">, ax  </span>; Save DS in TEMPSEG, not on stack.
<span style="color:maroon">DOSCODE:A3C6                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:A3C7                 </span><span style="color:navy">mov     ds:</span>USER_SP<span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:A3CA                 </span><span style="color:navy">pop     ax              </span>; suck off CS:IP of interrupt
<span style="color:maroon">DOSCODE:A3CB                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:A3CC                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:A3CD                 </span><span style="color:navy">lahf
</span><span style="color:maroon">DOSCODE:A3CE                 </span><span style="color:navy">xchg    ah, al
</span><span style="color:maroon">DOSCODE:A3D0                 </span><span style="color:navy">and     al, </span><span style="color:green">2
</span><span style="color:maroon">DOSCODE:A3D2                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0F2h
</span><span style="color:maroon">DOSCODE:A3D4                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:A3D5                 </span><span style="color:navy">push    word ptr ds:</span>EXITHOLD<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:maroon">DOSCODE:A3D9                 </span><span style="color:navy">push    word ptr ds:</span>EXITHOLD
<span style="color:maroon">DOSCODE:A3DD                 </span><span style="color:navy">mov     ax, ds:</span>USER_SP
<span style="color:maroon">DOSCODE:A3E0                 </span><span style="color:navy">mov     ds, ds:</span>TEMPSEG  ; restore ds
<span style="color:maroon">DOSCODE:A3E4                 </span><span style="color:navy">iret
</span><span style="color:black">DOSCODE:A3E5
DOSCODE:A3E5 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:A3E5
DOSCODE:A3E5
DOSCODE:A3E5 </span>SET_I24_EXTENDED_ERROR <span style="color:black">proc near        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A3E5                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:A3E6                 </span><span style="color:navy">mov     ax, offset </span>SPECIAL_VERSION ; ErrMap24End
<span style="color:black">DOSCODE:A3E6                                         </span>; size of ErrMap24
<span style="color:black">DOSCODE:A3E9                 </span><span style="color:navy">sub     ax, offset </span>ErrMap24
<span style="color:black">DOSCODE:A3EC                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:A3ED                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:A3F2                 </span><span style="color:navy">cmp     di, ax
</span><span style="color:black">DOSCODE:A3F4                 </span><span style="color:navy">mov     ax, di
</span><span style="color:black">DOSCODE:A3F6                 </span><span style="color:navy">jnb     short </span><span style="color:gray">NoTrans
</span><span style="color:black">DOSCODE:A3F8                 </span><span style="color:navy">mov     al, ds:</span>ErrMap24<span style="color:navy">[di]
</span><span style="color:black">DOSCODE:A3FC                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:A3FE
DOSCODE:A3FE </span><span style="color:gray">NoTrans</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A3FE                 </span><span style="color:navy">mov     ds:</span>EXTERR<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:A401                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:A402                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:A403                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:A404                 </span><span style="color:navy">mov     si, offset </span>ERR_TABLE_24
<span style="color:black">DOSCODE:A407                 </span><span style="color:navy">call    </span>CAL_LK
<span style="color:black">DOSCODE:A40A                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:A40B                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A40B </span>SET_I24_EXTENDED_ERROR <span style="color:black">endp
DOSCODE:A40B
DOSCODE:A40C
DOSCODE:A40C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:A40C
DOSCODE:A40C
DOSCODE:A40C </span>IsEOF           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A40C                 </span><span style="color:navy">call    </span>IsFAT32
<span style="color:black">DOSCODE:A40F                 </span><span style="color:navy">jnb     short </span><span style="color:gray">IsEOF_FAT </span>; 12 or 16 bit compare
<span style="color:black">DOSCODE:A411                 </span><span style="color:navy">cmp     ss:</span>CLUSTNUM_HW<span style="color:navy">, </span><span style="color:#ff8000">0FFFh </span>; FAT32
<span style="color:black">DOSCODE:A418                 </span><span style="color:navy">jnz     short </span><span style="color:gray">IsEOF_other1 </span>; not EOF
<span style="color:black">DOSCODE:A41A                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">0FFF8h      </span>; 32 bit compare
<span style="color:black">DOSCODE:A41D
DOSCODE:A41D </span><span style="color:gray">IsEOF_other1</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A41D                 </span><span style="color:navy">retn                    </span>; cf=0 -&gt; EOF, cf=1 -&gt; not EOF
<span style="color:black">DOSCODE:A41E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A41E
DOSCODE:A41E </span><span style="color:gray">IsEOF_FAT</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A41E                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">], </span><span style="color:#ff8000">0FF6h </span>; [es:bp+DPB.MAX_CLUSTER]
<span style="color:black">DOSCODE:A41E                                         </span>; is this 16 bit fat?
<span style="color:black">DOSCODE:A424                 </span><span style="color:navy">jnb     short </span><span style="color:gray">EOF16     </span>; yes, check for eof there
<span style="color:black">DOSCODE:A426                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">0FF0h
</span><span style="color:black">DOSCODE:A42A                 </span><span style="color:navy">jz      short </span><span style="color:gray">IsEOF_other2
</span><span style="color:black">DOSCODE:A42C                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">0FF8h       </span>; do the 12 bit compare
<span style="color:black">DOSCODE:A430
DOSCODE:A430 </span><span style="color:gray">IsEOF_other2</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A430                 </span><span style="color:navy">retn                    </span>; cf=0 -&gt; EOF, cf=1 -&gt; not EOF
<span style="color:black">DOSCODE:A431 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A431
DOSCODE:A431 </span><span style="color:gray">EOF16</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A431                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">0FFF8h      </span>; 16 bit compare
<span style="color:black">DOSCODE:A434                 </span><span style="color:navy">retn                    </span>; cf=0 -&gt; EOF, cf=1 -&gt; not EOF
<span style="color:black">DOSCODE:A434 </span>IsEOF           <span style="color:black">endp
DOSCODE:A434
DOSCODE:A435 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A435 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR UNPACK
</span><span style="color:black">DOSCODE:A435
DOSCODE:A435 </span><span style="color:gray">up_1</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A435                 </span><span style="color:navy">cmp     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:A439                 </span><span style="color:navy">jnz     short </span><span style="color:gray">up_cont
</span><span style="color:black">DOSCODE:A43B                 </span><span style="color:navy">mov     di, ds:</span>CL0FATENTRY_HW
<span style="color:black">DOSCODE:A43F                 </span><span style="color:navy">or      di, di
</span><span style="color:black">DOSCODE:A441                 </span><span style="color:navy">mov     ds:</span>CCONTENT_HW<span style="color:navy">, di
</span><span style="color:black">DOSCODE:A445                 </span><span style="color:navy">mov     di, ds:</span>CL0FATENTRY
<span style="color:black">DOSCODE:A449                 </span><span style="color:navy">jnz     short </span><span style="color:gray">unpack_retn
</span><span style="color:black">DOSCODE:A44B                 </span><span style="color:navy">or      di, di
</span><span style="color:black">DOSCODE:A44D
DOSCODE:A44D </span><span style="color:gray">unpack_retn</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A44D                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A44D </span><span style="color:gray">; END OF FUNCTION CHUNK FOR UNPACK
</span><span style="color:black">DOSCODE:A44E
DOSCODE:A44E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:A44E
DOSCODE:A44E
DOSCODE:A44E </span>UNPACK          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A44E
DOSCODE:A44E </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:A435 SIZE 00000019 BYTES
</span><span style="color:black">DOSCODE:A44E
DOSCODE:A44E                 </span><span style="color:navy">or      bx, bx
</span><span style="color:black">DOSCODE:A450                 </span><span style="color:navy">jz      short </span><span style="color:gray">up_1
</span><span style="color:black">DOSCODE:A452
DOSCODE:A452 </span><span style="color:gray">up_cont</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A452                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [ES:BP+DPB.FAT_SIZE]
<span style="color:black">DOSCODE:A457                 </span><span style="color:navy">jnz     short </span><span style="color:gray">up_fat    </span>; not FAT32
<span style="color:black">DOSCODE:A459                 </span><span style="color:navy">mov     si, es:[bp+</span><span style="color:#ff8000">2Fh</span><span style="color:navy">] </span>; [ES:BP+DPB.LAST_CLUSTER+2]
<span style="color:black">DOSCODE:A45D                 </span><span style="color:navy">cmp     ds:</span>CLUSTNUM_HW<span style="color:navy">, si
</span><span style="color:black">DOSCODE:A461                 </span><span style="color:navy">jnz     short </span><span style="color:gray">up_2
</span><span style="color:black">DOSCODE:A463                 </span><span style="color:navy">cmp     bx, es:[bp+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">] </span>; [ES:BP+DPB.LAST_CLUSTER]
<span style="color:black">DOSCODE:A467                 </span><span style="color:navy">jmp     short </span><span style="color:gray">up_2
</span><span style="color:black">DOSCODE:A469 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A469
DOSCODE:A469 </span><span style="color:gray">up_fat</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A469                 </span><span style="color:navy">cmp     bx, es:[bp+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">] </span>; [ES:BP+DPB.MAX_CLUSTER]
<span style="color:black">DOSCODE:A46D
DOSCODE:A46D </span><span style="color:gray">up_2</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A46D                 </span><span style="color:navy">ja      short </span><span style="color:gray">HURTFAT   </span>; error (&gt; cluster count)
<span style="color:black">DOSCODE:A46F                 </span><span style="color:navy">call    </span>MAPCLUSTER
<span style="color:black">DOSCODE:A472                 </span><span style="color:navy">jb      short </span>_DoContext ; (ds&lt;&gt;ss)
<span style="color:black">DOSCODE:A474                 </span><span style="color:navy">push    word ptr [di+</span><span style="color:#ff8000">2</span><span style="color:navy">] </span>; offset CLUSSAVE+2
<span style="color:black">DOSCODE:A477                 </span><span style="color:navy">pop     ss:</span>CCONTENT_HW  ; high word of cluster number
<span style="color:black">DOSCODE:A47C                 </span><span style="color:navy">mov     di, [di]        </span>; offset CLUSSAVE
<span style="color:black">DOSCODE:A47E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">High12
</span><span style="color:black">DOSCODE:A480                 </span><span style="color:navy">call    </span>IsFAT32
<span style="color:black">DOSCODE:A483                 </span><span style="color:navy">jb      short </span><span style="color:gray">up_fat32  </span>; FAT32 volume (drive)
<span style="color:black">DOSCODE:A485                 </span><span style="color:navy">mov     ss:</span>CCONTENT_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A48C                 </span><span style="color:navy">mov     si, es:[bp+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">] </span>; [ES:BP+DPB.MAX_CLUSTER]
<span style="color:black">DOSCODE:A48C                                         </span>; is this 16-bit fat?
<span style="color:black">DOSCODE:A490                 </span><span style="color:navy">cmp     si, </span><span style="color:#ff8000">0FF6h       </span>; 4096-10
<span style="color:black">DOSCODE:A494                 </span><span style="color:navy">jb      short </span><span style="color:gray">Unpack12  </span>; No, go &#039;AND&#039; off bits
<span style="color:black">DOSCODE:A496
DOSCODE:A496 </span><span style="color:gray">up_fat32</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A496                 </span><span style="color:navy">or      di, di          </span>; set zero condition code, clears carry
<span style="color:black">DOSCODE:A498                 </span><span style="color:navy">mov     si, ss
</span><span style="color:black">DOSCODE:A49A                 </span><span style="color:navy">mov     ds, si
</span><span style="color:black">DOSCODE:A49C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">up_retn
</span><span style="color:black">DOSCODE:A49E                 </span><span style="color:navy">or      ds:</span>CCONTENT_HW<span style="color:navy">, di </span>; CCONTENT_HW:di = 0 -&gt; zf = 1
<span style="color:black">DOSCODE:A4A2
DOSCODE:A4A2 </span><span style="color:gray">up_retn</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A4A2                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A4A3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A4A3
DOSCODE:A4A3 </span><span style="color:gray">High12</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A4A3                 </span><span style="color:navy">mov     ss:</span>CCONTENT_HW<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A4AA                 </span><span style="color:navy">shr     di, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:A4AC                 </span><span style="color:navy">shr     di, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:A4AE                 </span><span style="color:navy">shr     di, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:A4B0                 </span><span style="color:navy">shr     di, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:A4B2
DOSCODE:A4B2 </span><span style="color:gray">Unpack12</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A4B2                 </span><span style="color:navy">and     di, </span><span style="color:green">0FFFh
</span><span style="color:black">DOSCODE:A4B6
DOSCODE:A4B6 </span>_DoContext<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A4B6                 </span><span style="color:navy">mov     si, ss
</span><span style="color:black">DOSCODE:A4B8                 </span><span style="color:navy">mov     ds, si
</span><span style="color:black">DOSCODE:A4BA                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A4BB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A4BB
DOSCODE:A4BB </span><span style="color:gray">HURTFAT</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A4BB                 </span><span style="color:navy">call    </span>chk_set_first_access
<span style="color:black">DOSCODE:A4BE                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:A4BF                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">88h         </span>; Allowed_FAIL+80h
<span style="color:black">DOSCODE:A4C1                 </span><span style="color:navy">mov     ss:</span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">8   </span>; Allowed_FAIL
<span style="color:black">DOSCODE:A4C7                 </span><span style="color:navy">push    ss:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:A4CC                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:A4CD                 </span><span style="color:navy">call    </span>FATAL
<span style="color:black">DOSCODE:A4D0                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:A4D1                 </span><span style="color:navy">pop     ss:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:A4D6                 </span><span style="color:navy">xor     di, di
</span><span style="color:black">DOSCODE:A4D8                 </span><span style="color:navy">dec     di              </span>; 0FFFFh
<span style="color:black">DOSCODE:A4D9                 </span><span style="color:navy">mov     ss:</span>CCONTENT_HW<span style="color:navy">, di
</span><span style="color:black">DOSCODE:A4DE                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:A4E0                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:A4E1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">OKU_RET   </span>; Try to ignore bad FAT
<span style="color:black">DOSCODE:A4E3                 </span><span style="color:navy">stc                     </span>; User said FAIL
<span style="color:black">DOSCODE:A4E4
DOSCODE:A4E4 </span><span style="color:gray">OKU_RET</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A4E4                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:A4E5
DOSCODE:A4E5 </span>hurtfat_retn<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A4E5                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A4E5 </span>UNPACK          <span style="color:black">endp
DOSCODE:A4E5
DOSCODE:A4E6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A4E6 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR PACK
</span><span style="color:black">DOSCODE:A4E6
DOSCODE:A4E6 </span><span style="color:gray">p_clust_0</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A4E6                 </span><span style="color:navy">cmp     ds:</span>CLUSTNUM_HW<span style="color:navy">, bx </span>; 0
<span style="color:black">DOSCODE:A4EA                 </span><span style="color:navy">jnz     short </span><span style="color:gray">p_cont
</span><span style="color:black">DOSCODE:A4EC                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:A4ED                 </span><span style="color:navy">mov     ax, ds:</span>CLUSDATA_HW ; Cluster Data/Content (High Word)
<span style="color:black">DOSCODE:A4F0                 </span><span style="color:navy">mov     ds:</span>CL0FATENTRY_HW<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:A4F3                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:A4F4                 </span><span style="color:navy">mov     ds:</span>CL0FATENTRY<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:A4F8                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A4F8 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR PACK
</span><span style="color:black">DOSCODE:A4F9
DOSCODE:A4F9 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:A4F9
DOSCODE:A4F9
DOSCODE:A4F9 </span>PACK            <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A4F9
DOSCODE:A4F9 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:A4E6 SIZE 00000013 BYTES
</span><span style="color:black">DOSCODE:A4F9
DOSCODE:A4F9                 </span><span style="color:navy">or      bx, bx          </span>; CLUSDATA_HW:DX = cluster data/content
<span style="color:black">DOSCODE:A4F9                                         </span>; CLUSTNUM_HW:BX = cluster number (to be updated)
<span style="color:black">DOSCODE:A4F9                                         </span>; ES:BP = pointer to DPB
<span style="color:black">DOSCODE:A4F9                                         </span>;
<span style="color:black">DOSCODE:A4F9                                         </span>; are we packing cluster 0 ?
<span style="color:black">DOSCODE:A4FB                 </span><span style="color:navy">jz      short </span><span style="color:gray">p_clust_0 </span>; place value in CL0FATENTRY
<span style="color:black">DOSCODE:A4FD
DOSCODE:A4FD </span><span style="color:gray">p_cont</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A4FD                 </span><span style="color:navy">call    </span>MAPCLUSTER
<span style="color:black">DOSCODE:A500                 </span><span style="color:navy">jb      short </span>_DoContext
<span style="color:black">DOSCODE:A502                 </span><span style="color:navy">mov     si, [di]
</span><span style="color:black">DOSCODE:A504                 </span><span style="color:navy">jz      short </span><span style="color:gray">ALIGNED
</span><span style="color:black">DOSCODE:A506                 </span><span style="color:navy">add     dx, dx
</span><span style="color:black">DOSCODE:A508                 </span><span style="color:navy">add     dx, dx
</span><span style="color:black">DOSCODE:A50A                 </span><span style="color:navy">add     dx, dx
</span><span style="color:black">DOSCODE:A50C                 </span><span style="color:navy">add     dx, dx
</span><span style="color:black">DOSCODE:A50E                 </span><span style="color:navy">and     si, </span><span style="color:green">0Fh
</span><span style="color:black">DOSCODE:A511                 </span><span style="color:navy">jmp     short </span><span style="color:gray">PACKIN
</span><span style="color:black">DOSCODE:A513 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A513
DOSCODE:A513 </span><span style="color:gray">ALIGNED</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A513                 </span><span style="color:navy">call    </span>IsFAT32
<span style="color:black">DOSCODE:A516                 </span><span style="color:navy">jnb     short </span><span style="color:gray">p_fat
</span><span style="color:black">DOSCODE:A518                 </span><span style="color:navy">mov     si, ss:</span>CLUSDATA_HW
<span style="color:black">DOSCODE:A51D                 </span><span style="color:navy">xor     si, [di+</span><span style="color:#ff8000">2</span><span style="color:navy">]      </span>; hw of cluster number
<span style="color:black">DOSCODE:A51D                                         </span>; offset CLUSSAVE+2
<span style="color:black">DOSCODE:A520                 </span><span style="color:navy">and     si, </span><span style="color:green">0FFFh
</span><span style="color:black">DOSCODE:A524                 </span><span style="color:navy">xor     [di+</span><span style="color:#ff8000">2</span><span style="color:navy">], si
</span><span style="color:black">DOSCODE:A527                 </span><span style="color:navy">mov     [di], dx
</span><span style="color:black">DOSCODE:A529                 </span><span style="color:navy">jmp     short </span><span style="color:gray">PACKIN2
</span><span style="color:black">DOSCODE:A52B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A52B
DOSCODE:A52B </span><span style="color:gray">p_fat</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A52B                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">], </span><span style="color:#ff8000">0FF6h
</span><span style="color:black">DOSCODE:A531                 </span><span style="color:navy">jnb     short </span><span style="color:gray">Pack16
</span><span style="color:black">DOSCODE:A533                 </span><span style="color:navy">and     si, </span><span style="color:green">0F000h
</span><span style="color:black">DOSCODE:A537                 </span><span style="color:navy">and     dh, </span><span style="color:green">0Fh
</span><span style="color:black">DOSCODE:A53A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">PACKIN
</span><span style="color:black">DOSCODE:A53C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A53C
DOSCODE:A53C </span><span style="color:gray">Pack16</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A53C                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">DOSCODE:A53E
DOSCODE:A53E </span><span style="color:gray">PACKIN</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A53E                 </span><span style="color:navy">or      si, dx
</span><span style="color:black">DOSCODE:A540                 </span><span style="color:navy">mov     [di], si
</span><span style="color:black">DOSCODE:A542
DOSCODE:A542 </span><span style="color:gray">PACKIN2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A542                 </span><span style="color:navy">lds     si, ss:</span>CURBUF
<span style="color:black">DOSCODE:A547                 </span><span style="color:navy">test    byte ptr [si+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [SI+BUFFINFO.buf_flags],buf_dirty
<span style="color:black">DOSCODE:A54B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">yesdirty11
</span><span style="color:black">DOSCODE:A54D                 </span><span style="color:navy">inc     ss:</span>DirtyBufferCount
<span style="color:black">DOSCODE:A552                 </span><span style="color:navy">or      byte ptr [si+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [SI+BUFFINFO.buf_flags],buf_dirty
<span style="color:black">DOSCODE:A556
DOSCODE:A556 </span><span style="color:gray">yesdirty11</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A556                 </span><span style="color:navy">cmp     ss:</span>CLUSSPLIT<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A55C                 </span><span style="color:navy">mov     dx, ss
</span><span style="color:black">DOSCODE:A55E                 </span><span style="color:navy">mov     ds, dx
</span><span style="color:black">DOSCODE:A560                 </span><span style="color:navy">jz      short </span>hurtfat_retn
<span style="color:black">DOSCODE:A562                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:A563                 </span><span style="color:navy">push    ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:A567                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:A568                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:A569                 </span><span style="color:navy">mov     ax, ds:</span>CLUSSAVE
<span style="color:black">DOSCODE:A56C                 </span><span style="color:navy">add     si, </span><span style="color:green">24          </span>; BUFINSIZ
<span style="color:black">DOSCODE:A56F                 </span><span style="color:navy">mov     ds, word ptr ds:</span>CURBUF<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:A573                 </span><span style="color:navy">mov     [si], ah
</span><span style="color:black">DOSCODE:A575                 </span><span style="color:navy">lds     dx, ss:</span>CLUSSEC
<span style="color:black">DOSCODE:A57A                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:A57B                 </span><span style="color:navy">mov     ss:</span>HIGH_SECTOR<span style="color:navy">, ds
</span><span style="color:black">DOSCODE:A580                 </span><span style="color:navy">mov     si, ss
</span><span style="color:black">DOSCODE:A582                 </span><span style="color:navy">mov     ds, si
</span><span style="color:black">DOSCODE:A584                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:A587                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">DOSCODE:A589                 </span><span style="color:navy">call    </span>GETBUFFRB
<span style="color:black">DOSCODE:A58C                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:A58D                 </span><span style="color:navy">jb      short </span><span style="color:gray">POPP_RET
</span><span style="color:black">DOSCODE:A58F                 </span><span style="color:navy">lds     di, ds:</span>CURBUF
<span style="color:black">DOSCODE:A593                 </span><span style="color:navy">test    byte ptr [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [DI+BUFFINFO.buf_flags],buf_dirty
<span style="color:black">DOSCODE:A597                 </span><span style="color:navy">jnz     short </span><span style="color:gray">yesdirty12
</span><span style="color:black">DOSCODE:A599                 </span><span style="color:navy">inc     ss:</span>DirtyBufferCount
<span style="color:black">DOSCODE:A59E                 </span><span style="color:navy">or      byte ptr [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [DI+BUFFINFO.buf_flags],buf_dirty
<span style="color:black">DOSCODE:A5A2
DOSCODE:A5A2 </span><span style="color:gray">yesdirty12</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A5A2                 </span><span style="color:navy">add     di, </span><span style="color:green">23          </span>; BUFINSIZ-1
<span style="color:black">DOSCODE:A5A5                 </span><span style="color:navy">add     di, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]   </span>; [ES:BP+DPB.SECTOR_SIZE]
<span style="color:black">DOSCODE:A5A9                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:A5AA                 </span><span style="color:navy">mov     [di], al
</span><span style="color:black">DOSCODE:A5AC
DOSCODE:A5AC </span><span style="color:gray">POPP_RET</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A5AC                 </span><span style="color:navy">mov     cx, ss
</span><span style="color:black">DOSCODE:A5AE                 </span><span style="color:navy">mov     ds, cx
</span><span style="color:black">DOSCODE:A5B0                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:A5B1                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:A5B2                 </span><span style="color:navy">pop     ss:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:A5B7                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:A5B8                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A5B8 </span>PACK            <span style="color:black">endp
DOSCODE:A5B8
DOSCODE:A5B9
DOSCODE:A5B9 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:A5B9
DOSCODE:A5B9
DOSCODE:A5B9 </span>IsFAT32         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A5B9                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">1 </span>; [es:bp+DBP.FAT_SIZE]
<span style="color:black">DOSCODE:A5BE                 </span><span style="color:navy">jnb     short </span><span style="color:gray">isfat32eof_2 </span>; not FAT32
<span style="color:black">DOSCODE:A5C0                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">2Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [es:bp+DPB.LAST_CLUSTER+2]
<span style="color:black">DOSCODE:A5C5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">isfat32eof_1 </span>; FAT32
<span style="color:black">DOSCODE:A5C7                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">], </span><span style="color:green">0FFF6h </span>; [es:bp+DPB.LAST_CLUSTER]
<span style="color:black">DOSCODE:A5CC
DOSCODE:A5CC </span><span style="color:gray">isfat32eof_1</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A5CC                 </span><span style="color:navy">cmc                     </span>; cf=1 -&gt; FAT32
<span style="color:black">DOSCODE:A5CD
DOSCODE:A5CD </span><span style="color:gray">isfat32eof_2</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A5CD                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A5CD </span>IsFAT32         <span style="color:black">endp
DOSCODE:A5CD
DOSCODE:A5CE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A5CE </span><span style="color:gray">; START OF FUNCTION CHUNK FOR MAPCLUSTER
</span><span style="color:black">DOSCODE:A5CE
DOSCODE:A5CE </span><span style="color:navy">loc_A5CE:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A5CE                 </span><span style="color:navy">xchg    ax, di
</span><span style="color:black">DOSCODE:A5CF                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:black">DOSCODE:A5D0                 </span><span style="color:navy">div     cx
</span><span style="color:black">DOSCODE:A5D2                 </span><span style="color:navy">xchg    ax, di
</span><span style="color:black">DOSCODE:A5D3                 </span><span style="color:navy">div     cx
</span><span style="color:black">DOSCODE:A5D5                 </span><span style="color:navy">jmp     short loc_A637
</span><span style="color:black">DOSCODE:A5D5 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR MAPCLUSTER
</span><span style="color:black">DOSCODE:A5D7
DOSCODE:A5D7 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:A5D7
DOSCODE:A5D7
DOSCODE:A5D7 </span>MAPCLUSTER      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A5D7
DOSCODE:A5D7 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:A5CE SIZE 00000009 BYTES
</span><span style="color:black">DOSCODE:A5D7
DOSCODE:A5D7                 </span><span style="color:navy">mov     ds:</span>CLUSSPLIT<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A5DC                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:A5DD                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:A5DE                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:A5DF                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:A5E0                 </span><span style="color:navy">push    ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:A5E4                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:black">DOSCODE:A5E6                 </span><span style="color:navy">mov     dx, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:A5EA                 </span><span style="color:navy">xor     di, di
</span><span style="color:black">DOSCODE:A5EC                 </span><span style="color:navy">call    </span>IsFAT32
<span style="color:black">DOSCODE:A5EF                 </span><span style="color:navy">jnb     short loc_A5FF
</span><span style="color:black">DOSCODE:A5F1                 </span><span style="color:navy">shl     ax, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:A5F3                 </span><span style="color:navy">rcl     dx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:A5F5                 </span><span style="color:navy">rcl     di, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:A5F7                 </span><span style="color:navy">shl     ax, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:A5F9                 </span><span style="color:navy">rcl     dx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:A5FB                 </span><span style="color:navy">rcl     di, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:A5FD                 </span><span style="color:navy">jmp     short loc_A613
</span><span style="color:black">DOSCODE:A5FF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A5FF
DOSCODE:A5FF </span><span style="color:navy">loc_A5FF:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A5FF                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">], </span><span style="color:#ff8000">0FF6h
</span><span style="color:black">DOSCODE:A605                 </span><span style="color:navy">jnb     short loc_A60B
</span><span style="color:black">DOSCODE:A607                 </span><span style="color:navy">shr     dx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:A609                 </span><span style="color:navy">rcr     ax, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:A60B
DOSCODE:A60B </span><span style="color:navy">loc_A60B:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A60B                 </span><span style="color:navy">add     ax, bx
</span><span style="color:black">DOSCODE:A60D                 </span><span style="color:navy">adc     dx, ds:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:A611                 </span><span style="color:navy">adc     di, di
</span><span style="color:black">DOSCODE:A613
DOSCODE:A613 </span><span style="color:navy">loc_A613:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A613                 </span><span style="color:navy">mov     cx, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:A617                 </span><span style="color:navy">cmp     cx, </span><span style="color:green">512
</span><span style="color:black">DOSCODE:A61B                 </span><span style="color:navy">jnz     short loc_A5CE
</span><span style="color:black">DOSCODE:A61D                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:A61E                 </span><span style="color:navy">shr     di, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:A620                 </span><span style="color:navy">rcr     dx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:A622                 </span><span style="color:navy">rcr     ax, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:A624                 </span><span style="color:navy">mov     al, ah
</span><span style="color:black">DOSCODE:A626                 </span><span style="color:navy">mov     ah, dl
</span><span style="color:black">DOSCODE:A628                 </span><span style="color:navy">mov     dl, dh
</span><span style="color:black">DOSCODE:A62A                 </span><span style="color:navy">xor     dh, dh
</span><span style="color:black">DOSCODE:A62C                 </span><span style="color:navy">shr     di, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:A62E                 </span><span style="color:navy">adc     dh, dh
</span><span style="color:black">DOSCODE:A630                 </span><span style="color:navy">xchg    dx, di
</span><span style="color:black">DOSCODE:A632                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:A633                 </span><span style="color:navy">and     dx, </span><span style="color:green">1FFh
</span><span style="color:black">DOSCODE:A637
DOSCODE:A637 </span><span style="color:navy">loc_A637:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A637                 </span><span style="color:navy">add     ax, es:[bp+</span><span style="color:#ff8000">6</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:A63B                 </span><span style="color:navy">adc     di, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A63E                 </span><span style="color:navy">dec     cx
</span><span style="color:black">DOSCODE:A63F                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:A640                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:A641                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:A642                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:A643                 </span><span style="color:navy">mov     dx, ax
</span><span style="color:black">DOSCODE:A645                 </span><span style="color:navy">mov     ds:</span>HIGH_SECTOR<span style="color:navy">, di
</span><span style="color:black">DOSCODE:A649                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">DOSCODE:A64B                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:A64E                 </span><span style="color:navy">call    </span>GETBUFFRB
<span style="color:black">DOSCODE:A651                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:A652                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:A653                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:A654                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:A655                 </span><span style="color:navy">jb      short loc_A6BC
</span><span style="color:black">DOSCODE:A657                 </span><span style="color:navy">lds     si, ds:</span>CURBUF
<span style="color:black">DOSCODE:A65B                 </span><span style="color:navy">lea     di, [si+</span><span style="color:#ff8000">18h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:A65E                 </span><span style="color:navy">add     di, ax
</span><span style="color:black">DOSCODE:A660                 </span><span style="color:navy">cmp     ax, cx
</span><span style="color:black">DOSCODE:A662                 </span><span style="color:navy">jnz     short loc_A69F  </span>; ds&lt;&gt;ss
<span style="color:black">DOSCODE:A664                 </span><span style="color:navy">mov     al, [di]
</span><span style="color:black">DOSCODE:A666                 </span><span style="color:navy">mov     si, ss
</span><span style="color:black">DOSCODE:A668                 </span><span style="color:navy">mov     ds, si
</span><span style="color:black">DOSCODE:A66A                 </span><span style="color:navy">inc     ds:</span>CLUSSPLIT
<span style="color:black">DOSCODE:A66E                 </span><span style="color:navy">mov     byte ptr ds:</span>CLUSSAVE<span style="color:navy">, al
</span><span style="color:black">DOSCODE:A671                 </span><span style="color:navy">mov     word ptr ds:</span>CLUSSEC<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:A675                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:A677                 </span><span style="color:navy">add     dx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:A67A                 </span><span style="color:navy">mov     word ptr ds:</span>CLUSSEC<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, bx
</span><span style="color:black">DOSCODE:A67E                 </span><span style="color:navy">adc     bx, ax
</span><span style="color:black">DOSCODE:A680                 </span><span style="color:navy">mov     ds:</span>HIGH_SECTOR<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:A684                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:A687                 </span><span style="color:navy">call    </span>GETBUFFRB
<span style="color:black">DOSCODE:A68A                 </span><span style="color:navy">jb      short loc_A6BC
</span><span style="color:black">DOSCODE:A68C                 </span><span style="color:navy">lds     si, ds:</span>CURBUF
<span style="color:black">DOSCODE:A690                 </span><span style="color:navy">lea     di, [si+</span><span style="color:#ff8000">18h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:A693                 </span><span style="color:navy">mov     al, [di]
</span><span style="color:black">DOSCODE:A695                 </span><span style="color:navy">mov     di, ss
</span><span style="color:black">DOSCODE:A697                 </span><span style="color:navy">mov     ds, di
</span><span style="color:black">DOSCODE:A699                 </span><span style="color:navy">mov     byte ptr ds:</span>CLUSSAVE<span style="color:navy">+</span><span style="color:green">1</span><span style="color:navy">, al
</span><span style="color:black">DOSCODE:A69C                 </span><span style="color:navy">mov     di, offset </span>CLUSSAVE
<span style="color:black">DOSCODE:A69F
DOSCODE:A69F </span><span style="color:navy">loc_A69F:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A69F                 </span><span style="color:navy">pop     ss:</span>CLUSTNUM_HW  ; (ds&lt;&gt;ss)
<span style="color:black">DOSCODE:A6A4                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:A6A5                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:A6A6                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:A6A7                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:A6A9                 </span><span style="color:navy">call    </span>IsFAT32
<span style="color:black">DOSCODE:A6AC                 </span><span style="color:navy">jb      short loc_A6B8
</span><span style="color:black">DOSCODE:A6AE                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">], </span><span style="color:#ff8000">0FF6h
</span><span style="color:black">DOSCODE:A6B4                 </span><span style="color:navy">jnb     short loc_A6B8
</span><span style="color:black">DOSCODE:A6B6                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:black">DOSCODE:A6B8
DOSCODE:A6B8 </span><span style="color:navy">loc_A6B8:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A6B8                 </span><span style="color:navy">test    al, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:A6BA                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:A6BB                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A6BC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A6BC
DOSCODE:A6BC </span><span style="color:navy">loc_A6BC:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A6BC                 </span><span style="color:navy">pop     ss:</span>CLUSTNUM_HW
<span style="color:black">DOSCODE:A6C1                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:A6C2                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:A6C3                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:A6C4                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:A6C5                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A6C5 </span>MAPCLUSTER      <span style="color:black">endp
DOSCODE:A6C5
DOSCODE:A6C6
DOSCODE:A6C6 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:A6C6
DOSCODE:A6C6
DOSCODE:A6C6 </span>FATREAD_SFT     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A6C6                 </span><span style="color:navy">les     bp, es:[di+</span><span style="color:#ff8000">7</span><span style="color:navy">]   </span>; [ES:DI+SF_ENTRY.sf_devptr]
<span style="color:black">DOSCODE:A6CA
DOSCODE:A6CA </span>fatread_gotdpb<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A6CA                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:A6CE                 </span><span style="color:navy">mov     ds:</span>THISDRV<span style="color:navy">, al
</span><span style="color:black">DOSCODE:A6D1                 </span><span style="color:navy">call    </span>GOTDPB          ; Set THISDPB
<span style="color:black">DOSCODE:A6D4                 </span><span style="color:navy">call    </span>FAT_GOT_DPB
<span style="color:black">DOSCODE:A6D7
DOSCODE:A6D7 </span>fatread_sft_retn<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A6D7                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A6D7 </span>FATREAD_SFT     <span style="color:black">endp
DOSCODE:A6D7
DOSCODE:A6D8
DOSCODE:A6D8 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:A6D8
DOSCODE:A6D8
DOSCODE:A6D8 </span>FATREAD_CDS     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A6D8                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:A6D9                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:A6DA                 </span><span style="color:navy">les     bp, es:[di+</span><span style="color:#ff8000">45h</span><span style="color:navy">] </span>; [ES:DI+curdir.devptr]
<span style="color:black">DOSCODE:A6DE                 </span><span style="color:navy">call    </span>fatread_gotdpb
<span style="color:black">DOSCODE:A6E1                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:A6E2                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:A6E3                 </span><span style="color:navy">jb      short </span>fatread_sft_retn
<span style="color:black">DOSCODE:A6E5                 </span><span style="color:navy">jnz     short </span><span style="color:gray">NO_CHANGE
</span><span style="color:black">DOSCODE:A6E7                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh      </span>; -1
<span style="color:black">DOSCODE:A6EA                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:A6EB                 </span><span style="color:navy">mov     cl, ds:</span>CDSCOUNT
<span style="color:black">DOSCODE:A6EF                 </span><span style="color:navy">xor     ch, ch          </span>; CX is number of structures
<span style="color:black">DOSCODE:A6F1                 </span><span style="color:navy">lds     si, es:[di+</span><span style="color:#ff8000">45h</span><span style="color:navy">] </span>; Find all CDS with this devptr
<span style="color:black">DOSCODE:A6F5                 </span><span style="color:navy">les     di, ss:</span>CDSADDR  ; (es:di) = CDS pointer
<span style="color:black">DOSCODE:A6FA
DOSCODE:A6FA </span><span style="color:gray">frcd20</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A6FA                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">44h</span><span style="color:navy">], </span><span style="color:green">80h </span>; ES:DI+curdir.flags+1],
<span style="color:black">DOSCODE:A6FA                                         </span>; (curdir_isnet&gt;&gt;8)
<span style="color:black">DOSCODE:A6FF                 </span><span style="color:navy">jnz     short </span><span style="color:gray">frcd25
</span><span style="color:black">DOSCODE:A701                 </span><span style="color:navy">cmp     si, es:[di+</span><span style="color:#ff8000">45h</span><span style="color:navy">] </span>; [ES:DI+curdir.devptr]
<span style="color:black">DOSCODE:A705                 </span><span style="color:navy">jnz     short </span><span style="color:gray">frcd25    </span>; no match
<span style="color:black">DOSCODE:A707                 </span><span style="color:navy">mov     bx, ds
</span><span style="color:black">DOSCODE:A709                 </span><span style="color:navy">cmp     bx, es:[di+</span><span style="color:#ff8000">47h</span><span style="color:navy">] </span>; [ES:DI+curdir.devptr+2]
<span style="color:black">DOSCODE:A70D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">frcd25    </span>; CDS not for this drive
<span style="color:black">DOSCODE:A70F                 </span><span style="color:navy">test    es:[di+</span><span style="color:#ff8000">49h</span><span style="color:navy">], ax </span>; [ES:DI+curdir.ID]
<span style="color:black">DOSCODE:A70F                                         </span>; If root (0), leave root
<span style="color:black">DOSCODE:A713                 </span><span style="color:navy">jz      short </span><span style="color:gray">frcd25    </span>; = 0
<span style="color:black">DOSCODE:A715                 </span><span style="color:navy">test    es:[di+</span><span style="color:#ff8000">4Bh</span><span style="color:navy">], ax </span>; [ES:DI+curdir.ID+2]
<span style="color:black">DOSCODE:A719                 </span><span style="color:navy">jz      short </span><span style="color:gray">frcd25    </span>; leave root (= 0)
<span style="color:black">DOSCODE:A71B                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4Bh</span><span style="color:navy">], ax </span>; else invalid (-1)
<span style="color:black">DOSCODE:A71F                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">49h</span><span style="color:navy">], ax </span>; -1
<span style="color:black">DOSCODE:A723
DOSCODE:A723 </span><span style="color:gray">frcd25</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A723                 </span><span style="color:navy">add     di, </span><span style="color:green">88          </span>; add di,curdir.size
<span style="color:black">DOSCODE:A723                                         </span>; Point to next CDS
<span style="color:black">DOSCODE:A726                 </span><span style="color:navy">loop    </span><span style="color:gray">frcd20
</span><span style="color:black">DOSCODE:A728                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:A729
DOSCODE:A729 </span><span style="color:gray">NO_CHANGE</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A729                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:A72D                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:A72E                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A72E </span>FATREAD_CDS     <span style="color:black">endp
DOSCODE:A72E
DOSCODE:A72F
DOSCODE:A72F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:A72F
DOSCODE:A72F
DOSCODE:A72F </span>chk_set_first_access <span style="color:black">proc near          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A72F                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; DPB.FATSIZE
<span style="color:black">DOSCODE:A734                 </span><span style="color:navy">jnz     short </span><span style="color:gray">chk_set_fa_1 </span>; FAT (FAT12 or FAT16)
<span style="color:black">DOSCODE:A734                                         </span>; FAT32
<span style="color:black">DOSCODE:A736                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">21h</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; DPB.FREE_CNT_HW
<span style="color:black">DOSCODE:A73B                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">21h</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; High word of free cluster count
<span style="color:black">DOSCODE:A741                 </span><span style="color:navy">jnz     short </span><span style="color:gray">chk_set_fa_2
</span><span style="color:black">DOSCODE:A743
DOSCODE:A743 </span><span style="color:gray">chk_set_fa_1</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A743                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; DPB.FREE_CNT
<span style="color:black">DOSCODE:A748
DOSCODE:A748 </span><span style="color:gray">chk_set_fa_2</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A748                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; Count of free clusters, -1 if unknown
<span style="color:black">DOSCODE:A74E                 </span><span style="color:navy">jz      short </span><span style="color:gray">chk_set_fa_3
</span><span style="color:black">DOSCODE:A750                 </span><span style="color:navy">or      byte ptr es:[bp+</span><span style="color:#ff8000">18h</span><span style="color:navy">], </span><span style="color:green">1 </span>; DPB.FIRST_ACCESS
<span style="color:black">DOSCODE:A755
DOSCODE:A755 </span><span style="color:gray">chk_set_fa_3</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A755                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A755 </span>chk_set_first_access <span style="color:black">endp
DOSCODE:A755
DOSCODE:A756 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A756 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR FAT_GOT_DPB
</span><span style="color:black">DOSCODE:A756
DOSCODE:A756 </span><span style="color:gray">FATERR</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A756                 </span><span style="color:navy">call    </span>chk_set_first_access ; Err in FAT must force recalc of freespace
<span style="color:black">DOSCODE:A759                 </span><span style="color:navy">and     di, </span><span style="color:green">0FFh        </span>; STECODE
<span style="color:black">DOSCODE:A75D                 </span><span style="color:navy">mov     ds:</span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">18h </span>; [ALLOWED],Allowed_FAIL+Allowed_RETRY
<span style="color:black">DOSCODE:A762                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">1Ah         </span>; 2+Allowed_FAIL+Allowed_RETRY
<span style="color:black">DOSCODE:A762                                         </span>; (While trying to read FAT)
<span style="color:black">DOSCODE:A764                 </span><span style="color:navy">mov     al, ds:</span>THISDRV  ; Tell which drive
<span style="color:black">DOSCODE:A767                 </span><span style="color:navy">call    </span>FATAL1
<span style="color:black">DOSCODE:A76A                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:A76E                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:A770                 </span><span style="color:navy">jnz     short </span>FAT_GOT_DPB ; User said retry
<span style="color:black">DOSCODE:A772
DOSCODE:A772 </span><span style="color:gray">FATERR_fail</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A772                 </span><span style="color:navy">stc                     </span>; User said FAIL
<span style="color:black">DOSCODE:A773                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A773 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR FAT_GOT_DPB
</span><span style="color:black">DOSCODE:A774
DOSCODE:A774 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:A774
DOSCODE:A774
DOSCODE:A774 </span>FAT_GOT_DPB     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A774
DOSCODE:A774 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:A756 SIZE 0000001E BYTES
</span><span style="color:black">DOSCODE:A774
DOSCODE:A774                 </span><span style="color:navy">push    ss              </span>; SS is DOSDATA
<span style="color:black">DOSCODE:A775                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:A776                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">DOSCODE:A778                 </span><span style="color:navy">or      ax, bp
</span><span style="color:black">DOSCODE:A77A                 </span><span style="color:navy">jz      short </span><span style="color:gray">FATERR_fail
</span><span style="color:black">DOSCODE:A77C                 </span><span style="color:navy">mov     al, </span><span style="color:green">19
</span><span style="color:black">DOSCODE:A77E                 </span><span style="color:navy">mov     ah, es:[bp+</span><span style="color:#ff8000">1</span><span style="color:navy">]   </span>; [ES:BP+DPB.UNIT]
<span style="color:black">DOSCODE:A782                 </span><span style="color:navy">mov     ds:</span>DEVCALL_REQFUNC<span style="color:navy">, </span><span style="color:#ff8000">1 </span>; DEVMDCH
<span style="color:black">DOSCODE:A787                 </span><span style="color:navy">mov     word ptr ds:</span>DEVCALL_REQLEN<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:A78A                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">17h</span><span style="color:navy">] </span>; [ES:BP+DPB.MEDIA]
<span style="color:black">DOSCODE:A78E                 </span><span style="color:navy">mov     ds:</span>DEVCALL_REQSTAT<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A794                 </span><span style="color:navy">mov     ds:</span>CALLUNIT<span style="color:navy">, al </span>; [CALLMED]
<span style="color:black">DOSCODE:A797                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:A798                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:A799                 </span><span style="color:navy">mov     bx, offset </span>DEVCALL_REQLEN ; offset DEVCALL
<span style="color:black">DOSCODE:A79C                 </span><span style="color:navy">lds     si, es:[bp+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [ES:BP+DPB.DRIVER_ADDR]
<span style="color:black">DOSCODE:A7A0                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:A7A1                 </span><span style="color:navy">call    </span>DEVIOCALL2
<span style="color:black">DOSCODE:A7A4                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:A7A5                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:A7A6                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:A7A7                 </span><span style="color:navy">mov     di, ds:</span>DEVCALL_REQSTAT
<span style="color:black">DOSCODE:A7AB                 </span><span style="color:navy">or      di, di
</span><span style="color:black">DOSCODE:A7AD                 </span><span style="color:navy">js      short </span><span style="color:gray">FATERR
</span><span style="color:black">DOSCODE:A7AF                 </span><span style="color:navy">mov     ah, es:[bp+</span><span style="color:#ff8000">18h</span><span style="color:navy">] </span>; [ES:BP+DPB.FIRST_ACCESS]
<span style="color:black">DOSCODE:A7B3                 </span><span style="color:navy">mov     al, ds:</span>THISDRV  ; Use physical unit number
<span style="color:black">DOSCODE:A7B6                 </span><span style="color:navy">and     ah, </span><span style="color:green">80h         </span>; izolate (FAT) first access bit
<span style="color:black">DOSCODE:A7B9                 </span><span style="color:navy">and     byte ptr es:[bp+</span><span style="color:#ff8000">18h</span><span style="color:navy">], </span><span style="color:green">7Fh </span>; clear first access (FAT) bit 7
<span style="color:black">DOSCODE:A7BE                 </span><span style="color:navy">cmp     ds:</span>VOLCHNG_FLAG<span style="color:navy">, al
</span><span style="color:black">DOSCODE:A7C2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">CHECK_BYT
</span><span style="color:black">DOSCODE:A7C4                 </span><span style="color:navy">mov     ds:</span>VOLCHNG_FLAG<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:A7C9                 </span><span style="color:navy">jmp     </span><span style="color:gray">GOGETBPB
</span><span style="color:black">DOSCODE:A7CC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A7CC
DOSCODE:A7CC </span><span style="color:gray">CHECK_BYT</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A7CC                 </span><span style="color:navy">or      ah, ds:</span>CALLBR   ; [CALLRBYT]
<span style="color:black">DOSCODE:A7D0                 </span><span style="color:navy">js      short </span><span style="color:gray">NEWDSK
</span><span style="color:black">DOSCODE:A7D2                 </span><span style="color:navy">jz      short </span><span style="color:gray">CHKBUFFDIRT
</span><span style="color:black">DOSCODE:A7D4                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:A7D5                 </span><span style="color:navy">retn                    </span>; Media not changed (NZ)
<span style="color:black">DOSCODE:A7D6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A7D6
DOSCODE:A7D6 </span><span style="color:gray">DISK_CHNG_ERR</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A7D6                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:A7D7                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:A7D8                 </span><span style="color:navy">les     bp, es:[bp+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [ES:BP+DPB.DRIVER_ADDR]
<span style="color:black">DOSCODE:A7DC                 </span><span style="color:navy">test    byte ptr es:[bp+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">8 </span>; [es:bp+SYSDEV.ATT+1],(DEVOPCL&gt;&gt;8)
<span style="color:black">DOSCODE:A7E1                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:A7E2                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:A7E3                 </span><span style="color:navy">jz      short </span><span style="color:gray">FAIL_OPJ2
</span><span style="color:black">DOSCODE:A7E5                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:A7E6                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:A7E7                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:A7E8                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:A7E9                 </span><span style="color:navy">mov     ds:</span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">18h </span>; Allowed_FAIL+Allowed_RETRY
<span style="color:black">DOSCODE:A7EE                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:A7EF                 </span><span style="color:navy">les     di, dword ptr ds:</span>CALLVIDM ; Get volume ID pointer
<span style="color:black">DOSCODE:A7F3                 </span><span style="color:navy">mov     word ptr ds:</span>EXTERRPT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:A7F7                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:A7F8                 </span><span style="color:navy">mov     word ptr ds:</span>EXTERRPT<span style="color:navy">, di
</span><span style="color:black">DOSCODE:A7FC                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">0Fh         </span>; error_I24_wrong_disk
<span style="color:black">DOSCODE:A7FF                 </span><span style="color:navy">mov     ds:</span>READOP<span style="color:navy">, </span><span style="color:#ff8000">1    </span>; Write
<span style="color:black">DOSCODE:A804                 </span><span style="color:navy">call    </span>HARDERR
<span style="color:black">DOSCODE:A807                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:A808                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:A809                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:A80B
DOSCODE:A80B </span><span style="color:gray">FAIL_OPJ2</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A80B                 </span><span style="color:navy">jz      short </span><span style="color:gray">FAIL_OP
</span><span style="color:black">DOSCODE:A80D                 </span><span style="color:navy">jmp     </span>FAT_GOT_DPB     ; Retry
<span style="color:black">DOSCODE:A810 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A810
DOSCODE:A810 </span><span style="color:gray">CHKBUFFDIRT</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A810                 </span><span style="color:navy">cmp     ss:</span>DirtyBufferCount<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; any dirty buffers ?
<span style="color:black">DOSCODE:A816                 </span><span style="color:navy">jz      short </span><span style="color:gray">NEWDSK    </span>; no, skip the check
<span style="color:black">DOSCODE:A818                 </span><span style="color:navy">call    </span>GETCURHEAD      ; get pointer to first buffer
<span style="color:black">DOSCODE:A81B
DOSCODE:A81B </span><span style="color:gray">nbuffer</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A81B                 </span><span style="color:navy">cmp     [di+</span><span style="color:#ff8000">4</span><span style="color:navy">], al      </span>; [di+BUFFINFO.buf_ID] ; Unit OK ?
<span style="color:black">DOSCODE:A81E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">lfnxt     </span>; no
<span style="color:black">DOSCODE:A820                 </span><span style="color:navy">test    byte ptr [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; is the buffer dirty ?
<span style="color:black">DOSCODE:A824                 </span><span style="color:navy">jz      short </span><span style="color:gray">lfnxt     </span>; no, go for next buffer
<span style="color:black">DOSCODE:A826                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:A827                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:A828                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:A829                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A82A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A82A
DOSCODE:A82A </span><span style="color:gray">FAIL_OP</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A82A                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:A82B                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:A82C                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:A82D                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:A82E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A82E
DOSCODE:A82E </span><span style="color:gray">jmp_to_DISK_CHNG_ERR</span><span style="color:navy">:                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A82E                 </span><span style="color:navy">jmp     short </span><span style="color:gray">DISK_CHNG_ERR
</span><span style="color:black">DOSCODE:A830 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A830
DOSCODE:A830 </span><span style="color:gray">lfnxt</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A830                 </span><span style="color:navy">mov     di, [di]        </span>; [di+BUFFINFO.buf_next] ; get next buffer
<span style="color:black">DOSCODE:A832                 </span><span style="color:navy">cmp     ss:</span>FIRST_BUFF_ADDR<span style="color:navy">, di </span>; is this where we started ?
<span style="color:black">DOSCODE:A837                 </span><span style="color:navy">jnz     short </span><span style="color:gray">nbuffer   </span>; no, check this guy also
<span style="color:black">DOSCODE:A837                                         </span>; If no dirty buffers, assume Media changed
<span style="color:black">DOSCODE:A839
DOSCODE:A839 </span><span style="color:gray">NEWDSK</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A839                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; [ES:BP+DPB.FREE_CNT],-1
<span style="color:black">DOSCODE:A839                                         </span>; Media changed, must recompute
<span style="color:black">DOSCODE:A83F                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0 </span>; [ES:BP+DPB.FATSIZE] = 0 for FAT32 fs
<span style="color:black">DOSCODE:A844                 </span><span style="color:navy">jnz     short </span><span style="color:gray">newdsk2
</span><span style="color:black">DOSCODE:A846                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">21h</span><span style="color:navy">], </span><span style="color:green">0FFFFh </span>; [ES:BP+DPB.FREE_CNT_HW],-1
<span style="color:black">DOSCODE:A84C
DOSCODE:A84C </span><span style="color:gray">newdsk2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A84C                 </span><span style="color:navy">call    </span>GETCURHEAD
<span style="color:black">DOSCODE:A84F
DOSCODE:A84F </span><span style="color:gray">nxbuffer</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A84F                 </span><span style="color:navy">cmp     [di+</span><span style="color:#ff8000">4</span><span style="color:navy">], al      </span>; [DI+BUFFINFO.buf_ID],al ; This drive ?
<span style="color:black">DOSCODE:A852                 </span><span style="color:navy">jnz     short </span><span style="color:gray">lfnxt2
</span><span style="color:black">DOSCODE:A854                 </span><span style="color:navy">test    byte ptr [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [DI+BUFFINFO.buf_flags],buf_dirty
<span style="color:black">DOSCODE:A858                 </span><span style="color:navy">jnz     short </span><span style="color:gray">jmp_to_DISK_CHNG_ERR
</span><span style="color:black">DOSCODE:A85A                 </span><span style="color:navy">mov     word ptr [di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:#ff8000">20FFh </span>; [DI+BUFFINFO.buf_ID],
<span style="color:black">DOSCODE:A85A                                         </span>; (buf_visit*256)+0FFh ; free up
<span style="color:black">DOSCODE:A85F                 </span><span style="color:navy">call    </span>SCANPLACE
<span style="color:black">DOSCODE:A862                 </span><span style="color:navy">jmp     short </span><span style="color:gray">skpbuff
</span><span style="color:black">DOSCODE:A864 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A864
DOSCODE:A864 </span><span style="color:gray">lfnxt2</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A864                 </span><span style="color:navy">mov     di, [di]
</span><span style="color:black">DOSCODE:A866
DOSCODE:A866 </span><span style="color:gray">skpbuff</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A866                 </span><span style="color:navy">cmp     di, ss:</span>FIRST_BUFF_ADDR
<span style="color:black">DOSCODE:A86B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">nxbuffer
</span><span style="color:black">DOSCODE:A86D                 </span><span style="color:navy">cmp     ss:</span>SC_CACHE_COUNT<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; look ahead buffers ?
<span style="color:black">DOSCODE:A873                 </span><span style="color:navy">jz      short </span><span style="color:gray">GOGETBPB  </span>; no
<span style="color:black">DOSCODE:A875                 </span><span style="color:navy">cmp     al, ss:</span>CurSC_DRIVE ; same as changed drive ?
<span style="color:black">DOSCODE:A87A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GOGETBPB  </span>; no
<span style="color:black">DOSCODE:A87C                 </span><span style="color:navy">mov     ss:</span>CurSC_DRIVE<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; invalidate look ahead buffers
<span style="color:black">DOSCODE:A882
DOSCODE:A882 </span><span style="color:gray">GOGETBPB</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A882                 </span><span style="color:navy">lds     di, es:[bp+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [ES:BP+DPB.DRIVER_ADDR]
<span style="color:black">DOSCODE:A886                 </span><span style="color:navy">test    byte ptr [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">20h </span>; [DI+SYSDEV.ATT+1],(ISFATBYDEV&gt;&gt;8)
<span style="color:black">DOSCODE:A88A                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GETFREEBUF
</span><span style="color:black">DOSCODE:A88C                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:A88D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:A88E                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:#ff8000">200h </span>; DPB.SECTORSIZE ; bytes per sector
<span style="color:black">DOSCODE:A894                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:#ff8000">1 </span>; DPB.FIRST_FAT ; starting sector of FATs
<span style="color:black">DOSCODE:A89A                 </span><span style="color:navy">mov     byte ptr es:[bp+</span><span style="color:#ff8000">8</span><span style="color:navy">], </span><span style="color:#ff8000">1 </span>; DPB.FAT_COUNT ; number of FATs
<span style="color:black">DOSCODE:A89F                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">], </span><span style="color:#ff8000">3 </span>; DPB.MAX_CLUSTER ; cluster count + 1
<span style="color:black">DOSCODE:A8A5                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">1 </span>; DPB.FAT_SIZE ; FAT sectors (16 bit)
<span style="color:black">DOSCODE:A8AB                 </span><span style="color:navy">mov     ds:</span>CLUSTNUM_HW<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; high word of cluster number (for UNPACK)
<span style="color:black">DOSCODE:A8B1                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">2           </span>; Read the 1st FAT sector into CURBUF
<span style="color:black">DOSCODE:A8B4                 </span><span style="color:navy">call    </span>UNPACK
<span style="color:black">DOSCODE:A8B7
DOSCODE:A8B7 </span><span style="color:gray">FAIL_OPJ</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A8B7                 </span><span style="color:navy">jnb     short </span><span style="color:gray">unpack_ok
</span><span style="color:black">DOSCODE:A8B9                 </span><span style="color:navy">jmp     </span><span style="color:gray">FAIL_OP
</span><span style="color:black">DOSCODE:A8BC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A8BC
DOSCODE:A8BC </span><span style="color:gray">unpack_ok</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A8BC                 </span><span style="color:navy">lds     di, ds:</span>CURBUF
<span style="color:black">DOSCODE:A8C0                 </span><span style="color:navy">jmp     short </span><span style="color:gray">GOTGETBUF
</span><span style="color:black">DOSCODE:A8C2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A8C2
DOSCODE:A8C2 </span><span style="color:gray">GETFREEBUF</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A8C2                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">DOSCODE:A8C4                 </span><span style="color:navy">lds     di, ss:</span>LoMemBuff
<span style="color:black">DOSCODE:A8C9                 </span><span style="color:navy">sub     di, </span><span style="color:green">24          </span>; sub di,BUFINSIZ
<span style="color:black">DOSCODE:A8CC                 </span><span style="color:navy">cmp     ss:</span>BuffInHMA<span style="color:navy">, dl </span>; 0
<span style="color:black">DOSCODE:A8D1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">GOTGETBUF </span>; buffer is in HMA
<span style="color:black">DOSCODE:A8D1                                         </span>; use [LowMemBuff] to transfer at first
<span style="color:black">DOSCODE:A8D3                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:A8D4                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:A8D5                 </span><span style="color:navy">mov     ss:</span>HIGH_SECTOR<span style="color:navy">, dx </span>; 0
<span style="color:black">DOSCODE:A8DA                 </span><span style="color:navy">call    </span>GETCURHEAD
<span style="color:black">DOSCODE:A8DD                 </span><span style="color:navy">call    </span>BUFWRITE
<span style="color:black">DOSCODE:A8E0                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:A8E1                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:A8E2                 </span><span style="color:navy">jb      short </span><span style="color:gray">FAIL_OPJ
</span><span style="color:black">DOSCODE:A8E4
DOSCODE:A8E4 </span><span style="color:gray">GOTGETBUF</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A8E4                 </span><span style="color:navy">add     di, </span><span style="color:green">24          </span>; add di,BUFINSIZ
<span style="color:black">DOSCODE:A8E7                 </span><span style="color:navy">mov     ss:</span>CALLXAD_2<span style="color:navy">, ds </span>; [SS:CALLXAD+2]
<span style="color:black">DOSCODE:A8EC                 </span><span style="color:navy">mov     ax, ss
</span><span style="color:black">DOSCODE:A8EE                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">DOSCODE:A8F0                 </span><span style="color:navy">mov     word ptr ds:</span>CALLBR<span style="color:navy">, di </span>; [CALLXAD]
<span style="color:black">DOSCODE:A8F4                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">16h         </span>; DBPBHL
<span style="color:black">DOSCODE:A8F6                 </span><span style="color:navy">mov     ah, es:[bp+</span><span style="color:#ff8000">1</span><span style="color:navy">]   </span>; [ES:BP+DPB.UNIT]
<span style="color:black">DOSCODE:A8FA                 </span><span style="color:navy">mov     ds:</span>DEVCALL_REQFUNC<span style="color:navy">, </span><span style="color:#ff8000">2 </span>; DEVBPB
<span style="color:black">DOSCODE:A8FF                 </span><span style="color:navy">mov     word ptr ds:</span>DEVCALL_REQLEN<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:A902                 </span><span style="color:navy">mov     ds:</span>DEVCALL_REQSTAT<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A908                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">17h</span><span style="color:navy">] </span>; [ES:BP+DPB.MEDIA]
<span style="color:black">DOSCODE:A90C                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:A90D                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:A90E                 </span><span style="color:navy">mov     ds:</span>CALLUNIT<span style="color:navy">, al </span>; [CALLMED]
<span style="color:black">DOSCODE:A911                 </span><span style="color:navy">mov     bx, offset </span>DEVCALL_REQLEN ; offset DEVCALL
<span style="color:black">DOSCODE:A914                 </span><span style="color:navy">lds     si, es:[bp+</span><span style="color:#ff8000">13h</span><span style="color:navy">] </span>; [ES:BP+DPB.DRIVER_ADDR]
<span style="color:black">DOSCODE:A914                                         </span>; DS:SI Points to device header
<span style="color:black">DOSCODE:A918                 </span><span style="color:navy">pop     es              </span>; ES:BX Points to call header
<span style="color:black">DOSCODE:A919                 </span><span style="color:navy">call    </span>DEVIOCALL2
<span style="color:black">DOSCODE:A91C                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:A91D                 </span><span style="color:navy">mov     di, ss
</span><span style="color:black">DOSCODE:A91F                 </span><span style="color:navy">mov     ds, di
</span><span style="color:black">DOSCODE:A921                 </span><span style="color:navy">mov     di, ds:</span>DEVCALL_REQSTAT
<span style="color:black">DOSCODE:A925                 </span><span style="color:navy">or      di, di
</span><span style="color:black">DOSCODE:A927                 </span><span style="color:navy">jns     short </span><span style="color:gray">gotgetbuf2 </span>;
<span style="color:black">DOSCODE:A927                                         </span>; have error
<span style="color:black">DOSCODE:A929                 </span><span style="color:navy">lds     di, dword ptr ds:</span>CALLBR ; [CALLXAD] ; Buffer (data) address
<span style="color:black">DOSCODE:A92D                 </span><span style="color:navy">mov     word ptr [di-</span><span style="color:green">20</span><span style="color:navy">], </span><span style="color:#ff8000">0FFh </span>; byte BUFFINFO.buf_ID = 0FFh ; FREE
<span style="color:black">DOSCODE:A92D                                         </span>; byte BUFFINFO.buf_flags = 0
<span style="color:black">DOSCODE:A932                 </span><span style="color:navy">jmp     </span><span style="color:gray">FATERR
</span><span style="color:black">DOSCODE:A935 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A935
DOSCODE:A935 </span><span style="color:gray">gotgetbuf2</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A935                 </span><span style="color:navy">lds     si, dword ptr ds:</span>CALLBPB ; Address of the BPB (DEVCALL offset 18)
<span style="color:black">DOSCODE:A939                 </span><span style="color:navy">xor     cx, cx          </span>; 0
<span style="color:black">DOSCODE:A93B                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">], cx </span>; [ES:BP+DPB.NEXT_FREE] = 0
<span style="color:black">DOSCODE:A93B                                         </span>; recycle scanning pointer
<span style="color:black">DOSCODE:A93F                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">4152h       </span>; &#039;RA&#039; ; FAT32 extended BPB/DPB signature
<span style="color:black">DOSCODE:A942                 </span><span style="color:navy">cmp     [si+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], cx    </span>; BPB.fatsecs ; 16 bit FAT size = 0 for FAT32 fs
<span style="color:black">DOSCODE:A945                 </span><span style="color:navy">jnz     short </span><span style="color:gray">gotgetbuf3 </span>; not FAT32
<span style="color:black">DOSCODE:A947                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">39h</span><span style="color:navy">], cx </span>; clear reserved bytes (DPB.RESERVED)
<span style="color:black">DOSCODE:A94B                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">3Bh</span><span style="color:navy">], cx
</span><span style="color:black">DOSCODE:A94F                 </span><span style="color:navy">dec     cx              </span>; -1
<span style="color:black">DOSCODE:A950                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], cx </span>; (DPB.FREE_CNT) set free count to -1 (unknown)
<span style="color:black">DOSCODE:A954                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">21h</span><span style="color:navy">], cx
</span><span style="color:black">DOSCODE:A958                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4558h       </span>; &#039;XE&#039; ; FAT32 extended BPB/DPB signature
<span style="color:black">DOSCODE:A95B
DOSCODE:A95B </span><span style="color:gray">gotgetbuf3</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A95B                 </span><span style="color:navy">call    </span>$SETDPB
<span style="color:black">DOSCODE:A95E                 </span><span style="color:navy">lds     di, dword ptr ss:</span>CALLBR ; [SS:CALLXAD] ; Get back buffer pointer
<span style="color:black">DOSCODE:A963                 </span><span style="color:navy">mov     dx, es:[bp+</span><span style="color:#ff8000">25h</span><span style="color:navy">] </span>; [es:bp+DPB.FSINFO_SECTOR]
<span style="color:black">DOSCODE:A967                 </span><span style="color:navy">xor     cx, cx          </span>; 0
<span style="color:black">DOSCODE:A969                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], cx </span>; [es:bp+DPB.FAT_SIZE] ; 16 bit FAT size field
<span style="color:black">DOSCODE:A96D                 </span><span style="color:navy">jz      short </span><span style="color:gray">gotgetbuf4 </span>; FAT32 fs
<span style="color:black">DOSCODE:A96F                 </span><span style="color:navy">jmp     </span><span style="color:gray">gotgetbuf12     </span>; FAT fs
<span style="color:black">DOSCODE:A972 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A972
DOSCODE:A972 </span><span style="color:gray">gotgetbuf4</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A972                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">0FFFFh      </span>; invalid ?
<span style="color:black">DOSCODE:A975                 </span><span style="color:navy">jnz     short </span><span style="color:gray">gotgetbuf5 </span>; no
<span style="color:black">DOSCODE:A977                 </span><span style="color:navy">jmp     </span><span style="color:gray">gotgetbuf12     </span>; skip reading FSINFO sector
<span style="color:black">DOSCODE:A97A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:A97A
DOSCODE:A97A </span><span style="color:gray">gotgetbuf5</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A97A                 </span><span style="color:navy">mov     ss:</span>HIGH_SECTOR<span style="color:navy">, cx </span>; 0
<span style="color:black">DOSCODE:A97F                 </span><span style="color:navy">mov     bx, di
</span><span style="color:black">DOSCODE:A981                 </span><span style="color:navy">cmp     ss:</span>BuffInHMA<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:A987                 </span><span style="color:navy">jz      short </span><span style="color:gray">gotgetbuf6 </span>; buffer is in conventional (&lt;=640KB) memory
<span style="color:black">DOSCODE:A989                 </span><span style="color:navy">lds     bx, ss:</span>LoMemBuff ; use a buffer in conventional memory
<span style="color:black">DOSCODE:A98E                 </span><span style="color:navy">mov     di, bx
</span><span style="color:black">DOSCODE:A990
DOSCODE:A990 </span><span style="color:gray">gotgetbuf6</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A990                 </span><span style="color:navy">mov     ss:</span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">18h </span>; Allowed_FAIL+Allowed_RETRY
<span style="color:black">DOSCODE:A996                 </span><span style="color:navy">inc     cx
</span><span style="color:black">DOSCODE:A997                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:A998                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:A999                 </span><span style="color:navy">call    </span>DREAD
<span style="color:black">DOSCODE:A99C                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:A99D                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:A99E                 </span><span style="color:navy">jb      short </span><span style="color:gray">gotgetbuf11 </span>;
<span style="color:black">DOSCODE:A99E                                         </span>; ds:di = (FSINFO sector) buffer
<span style="color:black">DOSCODE:A99E                                         </span>; FSI_HeadSig = 41615252h
<span style="color:black">DOSCODE:A9A0                 </span><span style="color:navy">cmp     word ptr [di], </span><span style="color:#ff8000">5252h </span>; &#039;RR&#039; ; check if it is a valid FSINFO sector
<span style="color:black">DOSCODE:A9A4                 </span><span style="color:navy">jnz     short </span><span style="color:gray">gotgetbuf11 </span>; not valid
<span style="color:black">DOSCODE:A9A6                 </span><span style="color:navy">cmp     word ptr [di+</span><span style="color:green">2</span><span style="color:navy">], </span><span style="color:#ff8000">4161h </span>; &#039;aA&#039; ; (NASM syntax)
<span style="color:black">DOSCODE:A9AB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">gotgetbuf11
</span><span style="color:black">DOSCODE:A9AD                 </span><span style="color:navy">cmp     word ptr [di+</span><span style="color:green">484</span><span style="color:navy">], </span><span style="color:#ff8000">7272h </span>; &#039;rr&#039; ; FSI_StrucSig = 61417272h
<span style="color:black">DOSCODE:A9B3                 </span><span style="color:navy">jnz     short </span><span style="color:gray">gotgetbuf11
</span><span style="color:black">DOSCODE:A9B5                 </span><span style="color:navy">cmp     word ptr [di+</span><span style="color:green">486</span><span style="color:navy">], </span><span style="color:#ff8000">6141h </span>; &#039;Aa&#039;
<span style="color:black">DOSCODE:A9BB                 </span><span style="color:navy">jnz     short </span><span style="color:gray">gotgetbuf11 </span>; not valid
<span style="color:black">DOSCODE:A9BD                 </span><span style="color:navy">push    dx              </span>; valid
<span style="color:black">DOSCODE:A9BE                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:A9BF                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:A9C0                 </span><span style="color:navy">mov     bx, es:[bp+</span><span style="color:#ff8000">2Fh</span><span style="color:navy">] </span>; [es:bp+DPB.LASTCLUSTER+2]
<span style="color:black">DOSCODE:A9C4                 </span><span style="color:navy">mov     cx, es:[bp+</span><span style="color:#ff8000">2Dh</span><span style="color:navy">] </span>; [es:bp+DPB.LASTCLUSTER]
<span style="color:black">DOSCODE:A9C8                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:green">488</span><span style="color:navy">]    </span>; FSI_FreeCount ; bx:cx = number of clusters + 1
<span style="color:black">DOSCODE:A9CC                 </span><span style="color:navy">mov     dx, [di+</span><span style="color:green">490</span><span style="color:navy">]    </span>; FSI_FreeCount+2
<span style="color:black">DOSCODE:A9D0                 </span><span style="color:navy">cmp     dx, bx          </span>; is Free Count &gt;= (Number of Clusters + 1) ?
<span style="color:black">DOSCODE:A9D2                 </span><span style="color:navy">jnz     short </span><span style="color:gray">gotgetbuf7 </span>; if yes, it is invalid value (must be 0FFFFFFFFh)
<span style="color:black">DOSCODE:A9D4                 </span><span style="color:navy">cmp     ax, cx
</span><span style="color:black">DOSCODE:A9D6
DOSCODE:A9D6 </span><span style="color:gray">gotgetbuf7</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A9D6                 </span><span style="color:navy">jnb     short </span><span style="color:gray">gotgetbuf8 </span>; yes, invalid value (must be 0FFFFFFFFh)
<span style="color:black">DOSCODE:A9D8                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">1Fh</span><span style="color:navy">], ax </span>; no, valid free count
<span style="color:black">DOSCODE:A9D8                                         </span>; save free count into [es:bp+DPB.FREE_CNT]
<span style="color:black">DOSCODE:A9DC                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">21h</span><span style="color:navy">], dx </span>; [es:bp+DPB.FREE_CNT+2]
<span style="color:black">DOSCODE:A9E0
DOSCODE:A9E0 </span><span style="color:gray">gotgetbuf8</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A9E0                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:green">492</span><span style="color:navy">]    </span>; FSI_Nxt_Free
<span style="color:black">DOSCODE:A9E4                 </span><span style="color:navy">mov     dx, [di+</span><span style="color:green">494</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:A9E8                 </span><span style="color:navy">cmp     dx, bx          </span>; is the next free clust num &gt;= (num of clusters + 1) ?
<span style="color:black">DOSCODE:A9EA                 </span><span style="color:navy">jnz     short </span><span style="color:gray">gotgetbuf9 </span>; invalid (if dx &gt; bx)
<span style="color:black">DOSCODE:A9EC                 </span><span style="color:navy">cmp     ax, cx
</span><span style="color:black">DOSCODE:A9EE
DOSCODE:A9EE </span><span style="color:gray">gotgetbuf9</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A9EE                 </span><span style="color:navy">jnb     short </span><span style="color:gray">gotgetbuf10 </span>; invalid
<span style="color:black">DOSCODE:A9F0                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">39h</span><span style="color:navy">], ax </span>; save next free (search) cluster number
<span style="color:black">DOSCODE:A9F4                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">3Bh</span><span style="color:navy">], dx </span>; into [es:bp+DPB.FAT32_NXTFREE]
<span style="color:black">DOSCODE:A9F8                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">1Dh</span><span style="color:navy">], ax </span>; and into [es:bp+DPB.NEXT_FREE] ; low word
<span style="color:black">DOSCODE:A9FC
DOSCODE:A9FC </span><span style="color:gray">gotgetbuf10</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A9FC                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:A9FD                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:A9FE                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:A9FF
DOSCODE:A9FF </span><span style="color:gray">gotgetbuf11</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:A9FF                 </span><span style="color:navy">cmp     ss:</span>BuffInHMA<span style="color:navy">, </span><span style="color:#ff8000">0 </span>; is buffer in HMA ?
<span style="color:black">DOSCODE:AA05                 </span><span style="color:navy">jnz     short </span><span style="color:gray">gotgetbuf12 </span>; yes
<span style="color:black">DOSCODE:AA07                 </span><span style="color:navy">mov     word ptr [di-</span><span style="color:green">20</span><span style="color:navy">], </span><span style="color:#ff8000">0FFh </span>; invalidate buffer (set it as free buffer)
<span style="color:black">DOSCODE:AA0C
DOSCODE:AA0C </span><span style="color:gray">gotgetbuf12</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AA0C                 </span><span style="color:navy">cmp     ss:</span>BuffInHMA<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:AA12                 </span><span style="color:navy">jnz     short </span><span style="color:gray">gotgetbuf16
</span><span style="color:black">DOSCODE:AA14                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:AA19                 </span><span style="color:navy">jz      short </span><span style="color:gray">gotgetbuf13
</span><span style="color:black">DOSCODE:AA1B                 </span><span style="color:navy">mov     word ptr [di-</span><span style="color:green">20</span><span style="color:navy">], </span><span style="color:#ff8000">0FFh </span>; invalidate buffer (set it as free buffer)
<span style="color:black">DOSCODE:AA1B                                         </span>; di = buffer header + 4 (BUFINFO.buf_ID)
<span style="color:black">DOSCODE:AA20
DOSCODE:AA20 </span><span style="color:gray">gotgetbuf13</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AA20                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">8</span><span style="color:navy">]   </span>; [es:bp+DPB.FAT_COUNT]
<span style="color:black">DOSCODE:AA24                 </span><span style="color:navy">mov     [di-</span><span style="color:green">14</span><span style="color:navy">], al     </span>; BUFFINFO.buf_wrtcnt ; buffer header address + 10
<span style="color:black">DOSCODE:AA27                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">] </span>; [es:bp+DPB.FAT_SIZE] ; 16 bit FAT size field
<span style="color:black">DOSCODE:AA2B                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:AA2D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">gotgetbuf14 </span>; FAT (FAT12 or FAT16) fs
<span style="color:black">DOSCODE:AA2D                                         </span>; FAT32 fs
<span style="color:black">DOSCODE:AA2F                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">31h</span><span style="color:navy">] </span>; [es:bp+DPB.FAT32_SIZE] ; FAT sectors (per one FAT)
<span style="color:black">DOSCODE:AA33                 </span><span style="color:navy">mov     [di-</span><span style="color:green">13</span><span style="color:navy">], ax     </span>; BUFFINFO.buf_wrtcntinc ; # sectors between each write
<span style="color:black">DOSCODE:AA36                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">33h</span><span style="color:navy">] </span>; [es:bp+DPB.FAT32_SIZE+2]
<span style="color:black">DOSCODE:AA3A                 </span><span style="color:navy">jmp     short </span><span style="color:gray">gotgetbuf15
</span><span style="color:black">DOSCODE:AA3C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:AA3C
DOSCODE:AA3C </span><span style="color:gray">gotgetbuf14</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AA3C                 </span><span style="color:navy">mov     [di-</span><span style="color:green">13</span><span style="color:navy">], ax     </span>; BUFFINFO.buf_wrtcntinc
<span style="color:black">DOSCODE:AA3F                 </span><span style="color:navy">xor     ax, ax          </span>; 0
<span style="color:black">DOSCODE:AA41
DOSCODE:AA41 </span><span style="color:gray">gotgetbuf15</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AA41                 </span><span style="color:navy">mov     [di-</span><span style="color:green">15</span><span style="color:navy">], ax     </span>; BUFFINFO.buf_wrtcntinc+2 ; hw of sectors per FAT
<span style="color:black">DOSCODE:AA44
DOSCODE:AA44 </span><span style="color:gray">gotgetbuf16</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AA44                 </span><span style="color:navy">mov     ax, ss          </span>; SS is DOSDATA
<span style="color:black">DOSCODE:AA46                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">DOSCODE:AA48                 </span><span style="color:navy">xor     al, al          </span>; Media changed (Z), Carry clear
<span style="color:black">DOSCODE:AA4A                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:AA4A </span>FAT_GOT_DPB     <span style="color:black">endp
DOSCODE:AA4A
DOSCODE:AA4B
DOSCODE:AA4B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:AA4B
DOSCODE:AA4B
DOSCODE:AA4B </span>GETCURHEAD      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AA4B                 </span><span style="color:navy">lds     di, ss:</span>BufferQueue ; Pointer to the first buffer
<span style="color:black">DOSCODE:AA50                 </span><span style="color:navy">mov     word ptr ss:</span>LastBuffer<span style="color:navy">, </span><span style="color:green">0FFFFh </span>; -1 ; invalidate last buffer
<span style="color:black">DOSCODE:AA57                 </span><span style="color:navy">mov     ss:</span>FIRST_BUFF_ADDR<span style="color:navy">, di </span>; save first buffer address
<span style="color:black">DOSCODE:AA5C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:AA5C </span>GETCURHEAD      <span style="color:black">endp
DOSCODE:AA5C
DOSCODE:AA5D
DOSCODE:AA5D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:AA5D
DOSCODE:AA5D
DOSCODE:AA5D </span>SCANPLACE       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AA5D                 </span><span style="color:navy">push    word ptr [di]
</span><span style="color:black">DOSCODE:AA5F                 </span><span style="color:navy">call    </span>PLACEBUF
<span style="color:black">DOSCODE:AA62                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:AA63                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:AA63 </span>SCANPLACE       <span style="color:black">endp
DOSCODE:AA63
DOSCODE:AA64
DOSCODE:AA64 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:AA64
DOSCODE:AA64
DOSCODE:AA64 </span>PLACEBUF        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AA64                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:AA65                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:AA66                 </span><span style="color:navy">mov     ax, [di]
</span><span style="color:black">DOSCODE:AA68                 </span><span style="color:navy">mov     bx, word ptr ss:</span>BufferQueue
<span style="color:black">DOSCODE:AA6D                 </span><span style="color:navy">cmp     ax, bx
</span><span style="color:black">DOSCODE:AA6F                 </span><span style="color:navy">jz      short loc_AA93
</span><span style="color:black">DOSCODE:AA71                 </span><span style="color:navy">cmp     di, bx
</span><span style="color:black">DOSCODE:AA73                 </span><span style="color:navy">jnz     short loc_AA7B
</span><span style="color:black">DOSCODE:AA75                 </span><span style="color:navy">mov     word ptr ss:</span>BufferQueue<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:AA79                 </span><span style="color:navy">jmp     short loc_AA93
</span><span style="color:black">DOSCODE:AA7B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:AA7B
DOSCODE:AA7B </span><span style="color:navy">loc_AA7B:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AA7B                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:AA7C                 </span><span style="color:navy">mov     si, [di+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:AA7F                 </span><span style="color:navy">mov     [si], ax
</span><span style="color:black">DOSCODE:AA81                 </span><span style="color:navy">xchg    ax, si
</span><span style="color:black">DOSCODE:AA82                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], ax
</span><span style="color:black">DOSCODE:AA85                 </span><span style="color:navy">mov     si, [bx+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:AA88                 </span><span style="color:navy">mov     [bx+</span><span style="color:#ff8000">2</span><span style="color:navy">], di
</span><span style="color:black">DOSCODE:AA8B                 </span><span style="color:navy">mov     [si], di
</span><span style="color:black">DOSCODE:AA8D                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">2</span><span style="color:navy">], si
</span><span style="color:black">DOSCODE:AA90                 </span><span style="color:navy">mov     [di], bx
</span><span style="color:black">DOSCODE:AA92                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:AA93
DOSCODE:AA93 </span><span style="color:navy">loc_AA93:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AA93                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:AA94                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:AA95                 </span><span style="color:navy">cmp     byte ptr [di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:AA99                 </span><span style="color:navy">jnz     short locret_AAA0
</span><span style="color:black">DOSCODE:AA9B                 </span><span style="color:navy">mov     word ptr ss:</span>BufferQueue<span style="color:navy">, di
</span><span style="color:black">DOSCODE:AAA0
DOSCODE:AAA0 </span><span style="color:navy">locret_AAA0:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AAA0                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:AAA0 </span>PLACEBUF        <span style="color:black">endp
DOSCODE:AAA0
</span><span style="color:maroon">DOSCODE:AAA1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:AAA1
DOSCODE:AAA1 </span>POINTCOMP<span style="color:navy">:                              </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:AAA1                 </span><span style="color:navy">cmp     si, di
</span><span style="color:maroon">DOSCODE:AAA3                 </span><span style="color:navy">jnz     short </span>_ret_label
<span style="color:maroon">DOSCODE:AAA5                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:AAA6                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:AAA7                 </span><span style="color:navy">mov     cx, ds
</span><span style="color:maroon">DOSCODE:AAA9                 </span><span style="color:navy">mov     dx, es
</span><span style="color:maroon">DOSCODE:AAAB                 </span><span style="color:navy">cmp     cx, dx
</span><span style="color:maroon">DOSCODE:AAAD                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:AAAE                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:AAAF
DOSCODE:AAAF </span>_ret_label<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AAAF                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:AAB0
DOSCODE:AAB0 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:AAB0
DOSCODE:AAB0
DOSCODE:AAB0 </span>GETBUFFR        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AAB0                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">DOSCODE:AAB2
DOSCODE:AAB2 </span>GETBUFFRB<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AAB2                 </span><span style="color:navy">mov     ds:</span>PREREAD<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:AAB5                 </span><span style="color:navy">or      si, si
</span><span style="color:black">DOSCODE:AAB7                 </span><span style="color:navy">jz      short loc_AAE2
</span><span style="color:black">DOSCODE:AAB9                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:AABE                 </span><span style="color:navy">jnz     short loc_AAE2
</span><span style="color:black">DOSCODE:AAC0                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">23h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:AAC4                 </span><span style="color:navy">test    al, </span><span style="color:green">80h
</span><span style="color:black">DOSCODE:AAC6                 </span><span style="color:navy">jz      short loc_AAE2
</span><span style="color:black">DOSCODE:AAC8                 </span><span style="color:navy">and     ax, </span><span style="color:green">0Fh
</span><span style="color:black">DOSCODE:AACB                 </span><span style="color:navy">jz      short loc_AAE2
</span><span style="color:black">DOSCODE:AACD                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:AACE                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:black">DOSCODE:AAD0                 </span><span style="color:navy">mul     word ptr es:[bp+</span><span style="color:#ff8000">33h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:AAD4                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:black">DOSCODE:AAD5                 </span><span style="color:navy">mul     word ptr es:[bp+</span><span style="color:#ff8000">31h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:AAD9                 </span><span style="color:navy">add     cx, dx
</span><span style="color:black">DOSCODE:AADB                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:AADC                 </span><span style="color:navy">add     dx, ax
</span><span style="color:black">DOSCODE:AADE                 </span><span style="color:navy">adc     ds:</span>HIGH_SECTOR<span style="color:navy">, cx
</span><span style="color:black">DOSCODE:AAE2
DOSCODE:AAE2 </span><span style="color:navy">loc_AAE2:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AAE2                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:AAE6                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:AAE9                 </span><span style="color:navy">lds     di, ds:</span><span style="color:green">1Eh
</span><span style="color:black">DOSCODE:AAED                 </span><span style="color:navy">mov     cx, ss:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:AAF2                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:AAF5                 </span><span style="color:navy">jz      short loc_AB09
</span><span style="color:black">DOSCODE:AAF7                 </span><span style="color:navy">cmp     dx, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:AAFA                 </span><span style="color:navy">jnz     short loc_AB09
</span><span style="color:black">DOSCODE:AAFC                 </span><span style="color:navy">cmp     cx, [di+</span><span style="color:#ff8000">8</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:AAFF                 </span><span style="color:navy">jnz     short loc_AB09
</span><span style="color:black">DOSCODE:AB01                 </span><span style="color:navy">cmp     al, [di+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:AB04                 </span><span style="color:navy">jnz     short loc_AB09
</span><span style="color:black">DOSCODE:AB06                 </span><span style="color:navy">jmp     loc_AC1B
</span><span style="color:black">DOSCODE:AB09 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:AB09
DOSCODE:AB09 </span><span style="color:navy">loc_AB09:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AB09                 </span><span style="color:navy">lds     di, ss:</span>BufferQueue
<span style="color:black">DOSCODE:AB0E                 </span><span style="color:navy">mov     word ptr ss:</span>LastBuffer<span style="color:navy">, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:AB15                 </span><span style="color:navy">mov     ss:</span>FIRST_BUFF_ADDR<span style="color:navy">, di
</span><span style="color:black">DOSCODE:AB1A
DOSCODE:AB1A </span><span style="color:navy">loc_AB1A:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AB1A                 </span><span style="color:navy">cmp     dx, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:AB1D                 </span><span style="color:navy">jnz     short loc_AB2C
</span><span style="color:black">DOSCODE:AB1F                 </span><span style="color:navy">cmp     cx, [di+</span><span style="color:#ff8000">8</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:AB22                 </span><span style="color:navy">jnz     short loc_AB2C
</span><span style="color:black">DOSCODE:AB24                 </span><span style="color:navy">cmp     al, [di+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:AB27                 </span><span style="color:navy">jnz     short loc_AB2C
</span><span style="color:black">DOSCODE:AB29                 </span><span style="color:navy">jmp     loc_ABD0
</span><span style="color:black">DOSCODE:AB2C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:AB2C
DOSCODE:AB2C </span><span style="color:navy">loc_AB2C:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AB2C                 </span><span style="color:navy">cmp     byte ptr [di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:AB30                 </span><span style="color:navy">jnz     short loc_AB34
</span><span style="color:black">DOSCODE:AB32                 </span><span style="color:navy">mov     bx, di
</span><span style="color:black">DOSCODE:AB34
DOSCODE:AB34 </span><span style="color:navy">loc_AB34:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AB34                 </span><span style="color:navy">mov     di, [di]
</span><span style="color:black">DOSCODE:AB36                 </span><span style="color:navy">cmp     di, ss:</span>FIRST_BUFF_ADDR
<span style="color:black">DOSCODE:AB3B                 </span><span style="color:navy">jnz     short loc_AB1A
</span><span style="color:black">DOSCODE:AB3D                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:AB40                 </span><span style="color:navy">jz      short loc_AB46
</span><span style="color:black">DOSCODE:AB42                 </span><span style="color:navy">mov     di, bx
</span><span style="color:black">DOSCODE:AB44                 </span><span style="color:navy">jmp     short loc_AB59
</span><span style="color:black">DOSCODE:AB46 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:AB46
DOSCODE:AB46 </span><span style="color:navy">loc_AB46:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AB46                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:AB47                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:AB48                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:AB49                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:AB4A                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:AB4B                 </span><span style="color:navy">call    </span>BUFWRITE
<span style="color:black">DOSCODE:AB4E                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:AB4F                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:AB50                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:AB51                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:AB52                 </span><span style="color:navy">pop     ss:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:AB57                 </span><span style="color:navy">jb      short loc_ABB6
</span><span style="color:black">DOSCODE:AB59
DOSCODE:AB59 </span><span style="color:navy">loc_AB59:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AB59                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:AB5B                 </span><span style="color:navy">cmp     byte ptr ss:</span>PREREAD<span style="color:navy">, ah
</span><span style="color:black">DOSCODE:AB60                 </span><span style="color:navy">jnz     short loc_ABB8
</span><span style="color:black">DOSCODE:AB62                 </span><span style="color:navy">lea     bx, [di+</span><span style="color:#ff8000">18h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:AB65                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:AB68                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:AB69                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:AB6A                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:AB6B                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:AB6C                 </span><span style="color:navy">cmp     ss:</span>BuffInHMA<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:AB72                 </span><span style="color:navy">jz      short loc_AB7B
</span><span style="color:black">DOSCODE:AB74                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:AB75                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:AB76                 </span><span style="color:navy">lds     bx, ss:</span>LoMemBuff
<span style="color:black">DOSCODE:AB7B
DOSCODE:AB7B </span><span style="color:navy">loc_AB7B:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AB7B                 </span><span style="color:navy">or      si, si
</span><span style="color:black">DOSCODE:AB7D                 </span><span style="color:navy">jz      short loc_AB86
</span><span style="color:black">DOSCODE:AB7F                 </span><span style="color:navy">call    </span>FATSECRD
<span style="color:black">DOSCODE:AB82                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:AB84                 </span><span style="color:navy">jmp     short loc_AB8B
</span><span style="color:black">DOSCODE:AB86 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:AB86
DOSCODE:AB86 </span><span style="color:navy">loc_AB86:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AB86                 </span><span style="color:navy">call    </span>DREAD
<span style="color:black">DOSCODE:AB89                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:AB8B
DOSCODE:AB8B </span><span style="color:navy">loc_AB8B:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AB8B                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:AB8D                 </span><span style="color:navy">mov     cl, ss:</span>BuffInHMA
<span style="color:black">DOSCODE:AB92                 </span><span style="color:navy">jcxz    short loc_ABB2
</span><span style="color:black">DOSCODE:AB94                 </span><span style="color:navy">mov     cx, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:AB98                 </span><span style="color:navy">mov     si, bx
</span><span style="color:black">DOSCODE:AB9A                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:AB9B                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:AB9C                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:AB9D                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:AB9F                 </span><span style="color:navy">cld
</span><span style="color:black">DOSCODE:ABA0                 </span><span style="color:navy">cmp     ss:</span>DDMOVE<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:ABA6                 </span><span style="color:navy">jz      short near ptr loc_ABAA+</span><span style="color:green">1 </span>; rep movsw (skip 32bit prefix)
<span style="color:black">DOSCODE:ABA8                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:ABAA
DOSCODE:ABAA </span><span style="color:navy">loc_ABAA:                               </span><span style="color:red">; ...
</span><span style="color:black">DOSCODE:ABAA                 </span><span style="color:navy">rep movsd
</span><span style="color:black">DOSCODE:ABAD                 </span><span style="color:navy">mov     dx, es
</span><span style="color:black">DOSCODE:ABAF                 </span><span style="color:navy">mov     ds, dx
</span><span style="color:black">DOSCODE:ABB1                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:ABB2
DOSCODE:ABB2 </span><span style="color:navy">loc_ABB2:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:ABB2                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:ABB3                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:ABB4                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:ABB5                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:ABB6
DOSCODE:ABB6 </span><span style="color:navy">loc_ABB6:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:ABB6                 </span><span style="color:navy">jb      short loc_AC26
</span><span style="color:black">DOSCODE:ABB8
DOSCODE:ABB8 </span><span style="color:navy">loc_ABB8:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:ABB8                 </span><span style="color:navy">mov     cx, ss:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:ABBD                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:ABC1                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">6</span><span style="color:navy">], dx
</span><span style="color:black">DOSCODE:ABC4                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], bp
</span><span style="color:black">DOSCODE:ABC7                 </span><span style="color:navy">mov     word ptr [di+</span><span style="color:#ff8000">11h</span><span style="color:navy">], es
</span><span style="color:black">DOSCODE:ABCA                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">8</span><span style="color:navy">], cx
</span><span style="color:black">DOSCODE:ABCD                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">4</span><span style="color:navy">], ax
</span><span style="color:black">DOSCODE:ABD0
DOSCODE:ABD0 </span><span style="color:navy">loc_ABD0:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:ABD0                 </span><span style="color:navy">mov     byte ptr [di+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:ABD4                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:ABD6                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">], ax
</span><span style="color:black">DOSCODE:ABD9                 </span><span style="color:navy">or      si, si
</span><span style="color:black">DOSCODE:ABDB                 </span><span style="color:navy">jz      short loc_AC0B
</span><span style="color:black">DOSCODE:ABDD                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:ABE2                 </span><span style="color:navy">jnz     short loc_AC00
</span><span style="color:black">DOSCODE:ABE4                 </span><span style="color:navy">test    word ptr es:[bp+</span><span style="color:#ff8000">23h</span><span style="color:navy">], </span><span style="color:green">80h
</span><span style="color:black">DOSCODE:ABEA                 </span><span style="color:navy">jnz     short loc_ABF3
</span><span style="color:black">DOSCODE:ABEC                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">8</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:ABF0                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], al
</span><span style="color:black">DOSCODE:ABF3
DOSCODE:ABF3 </span><span style="color:navy">loc_ABF3:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:ABF3                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">33h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:ABF7                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">], ax
</span><span style="color:black">DOSCODE:ABFA                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">31h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:ABFE                 </span><span style="color:navy">jmp     short loc_AC0B
</span><span style="color:black">DOSCODE:AC00 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:AC00
DOSCODE:AC00 </span><span style="color:navy">loc_AC00:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AC00                 </span><span style="color:navy">mov     al, es:[bp+</span><span style="color:#ff8000">8</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:AC04                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], al
</span><span style="color:black">DOSCODE:AC07                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:AC0B
DOSCODE:AC0B </span><span style="color:navy">loc_AC0B:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AC0B                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], ax
</span><span style="color:black">DOSCODE:AC0E                 </span><span style="color:navy">call    </span>PLACEBUF
<span style="color:black">DOSCODE:AC11                 </span><span style="color:navy">mov     word ptr ss:</span>LastBuffer<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:black">DOSCODE:AC16                 </span><span style="color:navy">mov     word ptr ss:</span>LastBuffer<span style="color:navy">, di
</span><span style="color:black">DOSCODE:AC1B
DOSCODE:AC1B </span><span style="color:navy">loc_AC1B:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AC1B                 </span><span style="color:navy">mov     word ptr ss:</span>CURBUF<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:black">DOSCODE:AC20                 </span><span style="color:navy">mov     word ptr ss:</span>CURBUF<span style="color:navy">, di
</span><span style="color:black">DOSCODE:AC25                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:AC26
DOSCODE:AC26 </span><span style="color:navy">loc_AC26:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AC26                 </span><span style="color:navy">mov     ax, ss
</span><span style="color:black">DOSCODE:AC28                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">DOSCODE:AC2A
DOSCODE:AC2A </span>getbuffr_retn<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AC2A                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:AC2A </span><span style="background:red">GETBUFFR        endp</span><span style="background:red"> ; sp-analysis failed</span>
<span style="color:black">DOSCODE:AC2A
DOSCODE:AC2B
DOSCODE:AC2B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:AC2B
DOSCODE:AC2B
DOSCODE:AC2B </span>FLUSHBUF        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AC2B                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0FFh        </span>; -1
<span style="color:black">DOSCODE:AC2D                 </span><span style="color:navy">jnz     short </span><span style="color:gray">flshbuf_2
</span><span style="color:black">DOSCODE:AC2F                 </span><span style="color:navy">mov     bx, </span><span style="color:green">26
</span><span style="color:black">DOSCODE:AC32
DOSCODE:AC32 </span><span style="color:gray">flshbuf_1</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AC32                 </span><span style="color:navy">and     ss:</span>drv_flags_1<span style="color:navy">[bx], </span><span style="color:green">0F7h </span>; [ss:bx+drv_flags-1],0F7h
<span style="color:black">DOSCODE:AC32                                         </span>; clear bit 3
<span style="color:black">DOSCODE:AC38                 </span><span style="color:navy">dec     bx              </span>; backward
<span style="color:black">DOSCODE:AC39                 </span><span style="color:navy">jnz     short </span><span style="color:gray">flshbuf_1
</span><span style="color:black">DOSCODE:AC3B
DOSCODE:AC3B </span><span style="color:gray">flshbuf_2</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AC3B                 </span><span style="color:navy">call    </span>GETCURHEAD
<span style="color:black">DOSCODE:AC3E                 </span><span style="color:navy">test    byte ptr ss:</span>DOS34_FLAG<span style="color:navy">, </span><span style="color:green">4 </span>; FROM_DISK_RESET
<span style="color:black">DOSCODE:AC44                 </span><span style="color:navy">jnz     short </span><span style="color:gray">scan_buf_queue
</span><span style="color:black">DOSCODE:AC46                 </span><span style="color:navy">cmp     ss:</span>DirtyBufferCount<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:AC4C                 </span><span style="color:navy">jz      short </span><span style="color:gray">end_scan
</span><span style="color:black">DOSCODE:AC4E
DOSCODE:AC4E </span><span style="color:gray">scan_buf_queue</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AC4E                 </span><span style="color:navy">call    </span>CHECKFLUSH
<span style="color:black">DOSCODE:AC51                 </span><span style="color:navy">mov     ah, [di+</span><span style="color:#ff8000">4</span><span style="color:navy">]      </span>; [DI+BUFFINFO.buf_ID]
<span style="color:black">DOSCODE:AC54                 </span><span style="color:navy">cmp     ss:</span>WPERR<span style="color:navy">, ah
</span><span style="color:black">DOSCODE:AC59                 </span><span style="color:navy">jz      short </span><span style="color:gray">free_the_buf
</span><span style="color:black">DOSCODE:AC5B                 </span><span style="color:navy">test    byte ptr ss:</span>DOS34_FLAG<span style="color:navy">, </span><span style="color:green">4 </span>; FROM_DISK_RESET
<span style="color:black">DOSCODE:AC61                 </span><span style="color:navy">jz      short </span><span style="color:gray">flshbuf_3
</span><span style="color:black">DOSCODE:AC63
DOSCODE:AC63 </span><span style="color:gray">free_the_buf</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AC63                 </span><span style="color:navy">mov     word ptr [di+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:AC68
DOSCODE:AC68 </span><span style="color:gray">flshbuf_3</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AC68                 </span><span style="color:navy">mov     di, [di]        </span>; [DI+BUFFINFO.buf_next]
<span style="color:black">DOSCODE:AC6A                 </span><span style="color:navy">cmp     di, ss:</span>FIRST_BUFF_ADDR
<span style="color:black">DOSCODE:AC6F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">scan_buf_queue
</span><span style="color:black">DOSCODE:AC71
DOSCODE:AC71 </span><span style="color:gray">end_scan</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AC71                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:AC72                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:AC73                 </span><span style="color:navy">cmp     ds:</span>FAILERR<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:AC78                 </span><span style="color:navy">jz      short </span><span style="color:gray">flushbuf_retn
</span><span style="color:black">DOSCODE:AC7A                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:AC7B
DOSCODE:AC7B </span><span style="color:gray">flushbuf_retn</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AC7B                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:AC7B </span>FLUSHBUF        <span style="color:black">endp
DOSCODE:AC7B
DOSCODE:AC7C
DOSCODE:AC7C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:AC7C
DOSCODE:AC7C
DOSCODE:AC7C </span>CHECKFLUSH      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AC7C                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0FFh        </span>; -1
<span style="color:black">DOSCODE:AC7E                 </span><span style="color:navy">cmp     [di+</span><span style="color:#ff8000">4</span><span style="color:navy">], ah      </span>; [DI+BUFFINFO.buf_ID]
<span style="color:black">DOSCODE:AC81                 </span><span style="color:navy">jz      short </span>getbuffr_retn ; Skip free buffer, carry clear
<span style="color:black">DOSCODE:AC83                 </span><span style="color:navy">cmp     ah, al
</span><span style="color:black">DOSCODE:AC85                 </span><span style="color:navy">jz      short </span><span style="color:gray">DOBUFFER  </span>; do this buffer
<span style="color:black">DOSCODE:AC87                 </span><span style="color:navy">cmp     al, [di+</span><span style="color:#ff8000">4</span><span style="color:navy">]      </span>; [DI+BUFFINFO.buf_ID]
<span style="color:black">DOSCODE:AC8A                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:AC8B                 </span><span style="color:navy">jnz     short </span>getbuffr_retn ; Buffer not for this unit or SFT
<span style="color:black">DOSCODE:AC8D                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:AC8F                 </span><span style="color:navy">mov     bl, al
</span><span style="color:black">DOSCODE:AC91                 </span><span style="color:navy">test    ss:</span>drive_flags<span style="color:navy">[bx], </span><span style="color:green">8 </span>; bit 3
<span style="color:black">DOSCODE:AC97                 </span><span style="color:navy">jnz     short </span>getbuffr_retn
<span style="color:black">DOSCODE:AC99
DOSCODE:AC99 </span><span style="color:gray">DOBUFFER</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AC99                 </span><span style="color:navy">test    byte ptr [di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [DI+BUFFINFO.buf_flags],buf_dirty
<span style="color:black">DOSCODE:AC9D                 </span><span style="color:navy">jz      short </span>getbuffr_retn
<span style="color:black">DOSCODE:AC9F                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:ACA0                 </span><span style="color:navy">push    word ptr [di+</span><span style="color:#ff8000">4</span><span style="color:navy">] </span>; [DI+BUFFINFO.buf_ID]
<span style="color:black">DOSCODE:ACA3                 </span><span style="color:navy">call    </span>BUFWRITE
<span style="color:black">DOSCODE:ACA6                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:ACA7                 </span><span style="color:navy">jb      short </span><span style="color:gray">LEAVE_BUF </span>; Leave buffer marked free (lost)
<span style="color:black">DOSCODE:ACA9                 </span><span style="color:navy">and     ah, </span><span style="color:green">0BFh        </span>; ~buf_dirty  ; Buffer is clean, clears carry
<span style="color:black">DOSCODE:ACAC                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">4</span><span style="color:navy">], ax      </span>; [DI+BUFFINFO.buf_ID]
<span style="color:black">DOSCODE:ACAF
DOSCODE:ACAF </span><span style="color:gray">LEAVE_BUF</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:ACAF                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:ACB0
DOSCODE:ACB0 </span>checkflush_retn<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:ACB0                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:ACB0 </span>CHECKFLUSH      <span style="color:black">endp
DOSCODE:ACB0
DOSCODE:ACB1
DOSCODE:ACB1 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:ACB1
DOSCODE:ACB1
DOSCODE:ACB1 </span>BUFWRITE        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:ACB1                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:ACB4                 </span><span style="color:navy">xchg    ax, [di+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:ACB7                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:ACB9                 </span><span style="color:navy">jz      short </span>checkflush_retn
<span style="color:black">DOSCODE:ACBB                 </span><span style="color:navy">test    ah, </span><span style="color:green">40h
</span><span style="color:black">DOSCODE:ACBE                 </span><span style="color:navy">jz      short </span>checkflush_retn
<span style="color:black">DOSCODE:ACC0                 </span><span style="color:navy">call    </span>DEC_DIRTY_COUNT
<span style="color:black">DOSCODE:ACC3                 </span><span style="color:navy">cmp     al, ss:</span>WPERR
<span style="color:black">DOSCODE:ACC8                 </span><span style="color:navy">jz      short </span>checkflush_retn
<span style="color:black">DOSCODE:ACCA                 </span><span style="color:navy">les     dx, [di+</span><span style="color:#ff8000">6</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:ACCD                 </span><span style="color:navy">lea     bx, [di+</span><span style="color:#ff8000">18h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:ACD0                 </span><span style="color:navy">mov     cl, [di+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:ACD3                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:ACD5                 </span><span style="color:navy">mov     ss:</span>HIGH_SECTOR<span style="color:navy">, es
</span><span style="color:black">DOSCODE:ACDA                 </span><span style="color:navy">les     bp, [di+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:ACDD                 </span><span style="color:navy">mov     ss:</span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">18h
</span><span style="color:black">DOSCODE:ACE3                 </span><span style="color:navy">test    ah, </span><span style="color:green">8
</span><span style="color:black">DOSCODE:ACE6                 </span><span style="color:navy">jz      short loc_ACEE
</span><span style="color:black">DOSCODE:ACE8                 </span><span style="color:navy">or      ss:</span>ALLOWED<span style="color:navy">, </span><span style="color:green">20h
</span><span style="color:black">DOSCODE:ACEE
DOSCODE:ACEE </span><span style="color:navy">loc_ACEE:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:ACEE                 </span><span style="color:navy">mov     si, [di+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:ACF1                 </span><span style="color:navy">mov     ax, [di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:ACF4                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:ACF5                 </span><span style="color:navy">xor     di, di
</span><span style="color:black">DOSCODE:ACF7                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:ACF8                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:ACF9
DOSCODE:ACF9 </span><span style="color:navy">loc_ACF9:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:ACF9                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:ACFA                 </span><span style="color:navy">push    ss:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:ACFF                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:AD00                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:AD01                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:AD02                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:AD05                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:AD06                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:AD07                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:AD08                 </span><span style="color:navy">cmp     ss:</span>BuffInHMA<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:AD0E                 </span><span style="color:navy">jz      short loc_AD33
</span><span style="color:black">DOSCODE:AD10                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:AD11                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:AD12                 </span><span style="color:navy">mov     si, bx
</span><span style="color:black">DOSCODE:AD14                 </span><span style="color:navy">mov     cx, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:AD18                 </span><span style="color:navy">les     di, ss:</span>LoMemBuff
<span style="color:black">DOSCODE:AD1D                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:AD1F                 </span><span style="color:navy">mov     bx, di
</span><span style="color:black">DOSCODE:AD21                 </span><span style="color:navy">cld
</span><span style="color:black">DOSCODE:AD22                 </span><span style="color:navy">cmp     ss:</span>DDMOVE<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:AD28                 </span><span style="color:navy">jz      short near ptr loc_AD2C+</span><span style="color:green">1
</span><span style="color:black">DOSCODE:AD2A                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:AD2C
DOSCODE:AD2C </span><span style="color:navy">loc_AD2C:                               </span><span style="color:red">; ...
</span><span style="color:black">DOSCODE:AD2C                 </span><span style="color:navy">rep movsd
</span><span style="color:black">DOSCODE:AD2F                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:AD30                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:AD31                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:AD32                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:AD33
DOSCODE:AD33 </span><span style="color:navy">loc_AD33:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AD33                 </span><span style="color:navy">call    </span>DWRITE
<span style="color:black">DOSCODE:AD36                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:AD37                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:AD38                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:AD39                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:AD3A                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:AD3B                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:AD3C                 </span><span style="color:navy">pop     ss:</span>HIGH_SECTOR
<span style="color:black">DOSCODE:AD41                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:AD42                 </span><span style="color:navy">jb      short loc_AD47
</span><span style="color:black">DOSCODE:AD44                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:AD47
DOSCODE:AD47 </span><span style="color:navy">loc_AD47:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AD47                 </span><span style="color:navy">add     dx, ax
</span><span style="color:black">DOSCODE:AD49                 </span><span style="color:navy">adc     ss:</span>HIGH_SECTOR<span style="color:navy">, si
</span><span style="color:black">DOSCODE:AD4E                 </span><span style="color:navy">loop    loc_ACF9
</span><span style="color:black">DOSCODE:AD50                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:AD51                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:AD52                 </span><span style="color:navy">sub     di, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:AD55                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:AD56                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:AD56 </span>BUFWRITE        <span style="color:black">endp
DOSCODE:AD56
DOSCODE:AD57
DOSCODE:AD57 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:AD57
DOSCODE:AD57
DOSCODE:AD57 </span>null_sub        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AD57                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:AD57 </span>null_sub        <span style="color:black">endp
DOSCODE:AD57
DOSCODE:AD58
DOSCODE:AD58 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:AD58
DOSCODE:AD58
DOSCODE:AD58 </span>SET_BUF_DIRTY   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AD58                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [ES:DI+BUFFINFO.buf_flags],buf_dirty
<span style="color:black">DOSCODE:AD5D                 </span><span style="color:navy">jnz     short </span>yesdirty2
<span style="color:black">DOSCODE:AD5F                 </span><span style="color:navy">or      byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h </span>; [ES:DI+BUFFINFO.buf_flags],buf_dirty
<span style="color:black">DOSCODE:AD5F </span>SET_BUF_DIRTY   <span style="color:black">endp
DOSCODE:AD5F
DOSCODE:AD64
DOSCODE:AD64 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:AD64
DOSCODE:AD64
DOSCODE:AD64 </span>INC_DIRTY_COUNT <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AD64                 </span><span style="color:navy">inc     ss:</span>DirtyBufferCount
<span style="color:black">DOSCODE:AD69
DOSCODE:AD69 </span>yesdirty2<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AD69                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:AD69 </span>INC_DIRTY_COUNT <span style="color:black">endp
DOSCODE:AD69
DOSCODE:AD6A
DOSCODE:AD6A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:AD6A
DOSCODE:AD6A
DOSCODE:AD6A </span>DEC_DIRTY_COUNT <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AD6A                 </span><span style="color:navy">cmp     ss:</span>DirtyBufferCount<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:AD70                 </span><span style="color:navy">jz      short </span><span style="color:gray">ddcx
</span><span style="color:black">DOSCODE:AD72                 </span><span style="color:navy">dec     ss:</span>DirtyBufferCount
<span style="color:black">DOSCODE:AD77
DOSCODE:AD77 </span><span style="color:gray">ddcx</span><span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:AD77                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:AD77 </span>DEC_DIRTY_COUNT <span style="color:black">endp
DOSCODE:AD77
</span><span style="color:maroon">DOSCODE:AD78 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:AD78
DOSCODE:AD78 </span>$WAIT<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:AD78                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">DOSCODE:AD7A                 </span><span style="color:navy">xchg    ax, ss:</span>exit_code
<span style="color:maroon">DOSCODE:AD7F                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:AD82 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:AD82
DOSCODE:AD82 </span>$EXEC<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:AD82                 </span><span style="color:navy">mov     ss:</span>A20OFF_COUNT<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:AD88                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5
</span><span style="color:maroon">DOSCODE:AD8A                 </span><span style="color:navy">jnz     short </span>Exec_@f
<span style="color:maroon">DOSCODE:AD8C                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:AD8D                 </span><span style="color:navy">mov     cx, offset </span>LeaveDOS
<span style="color:maroon">DOSCODE:AD90                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:AD91
DOSCODE:AD91 </span>Exec_@f<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AD91                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">DOSCODE:AD92                 </span><span style="color:navy">mov     bp, sp
</span><span style="color:maroon">DOSCODE:AD94                 </span><span style="color:navy">sub     sp, </span><span style="color:green">29
</span><span style="color:maroon">DOSCODE:AD97                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5
</span><span style="color:maroon">DOSCODE:AD99                 </span><span style="color:navy">jbe     short </span>Exec_Check_2
<span style="color:maroon">DOSCODE:AD9B
DOSCODE:AD9B </span>Exec_Bad_Fun<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AD9B                 </span><span style="color:navy">call    </span>set_exerr_locus_unk
<span style="color:maroon">DOSCODE:AD9E                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:ADA0
DOSCODE:ADA0 </span><span style="color:navy">loc_ADA0:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:ADA0                 </span><span style="color:navy">mov     sp, bp
</span><span style="color:maroon">DOSCODE:ADA2                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSCODE:ADA3                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:maroon">DOSCODE:ADA6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:ADA6
DOSCODE:ADA6 </span><span style="color:navy">loc_ADA6:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:ADA6                 </span><span style="color:navy">call    sub_C697
</span><span style="color:maroon">DOSCODE:ADA9                 </span><span style="color:navy">jmp     loc_B1C6
</span><span style="color:maroon">DOSCODE:ADAC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:ADAC
DOSCODE:ADAC </span>Exec_Check_2<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:ADAC                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2
</span><span style="color:maroon">DOSCODE:ADAE                 </span><span style="color:navy">jz      short </span>Exec_Bad_Fun
<span style="color:maroon">DOSCODE:ADB0                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:ADB2                 </span><span style="color:navy">jz      short </span>Exec_Bad_Fun
<span style="color:maroon">DOSCODE:ADB4                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5
</span><span style="color:maroon">DOSCODE:ADB6                 </span><span style="color:navy">jz      short loc_ADA6
</span><span style="color:maroon">DOSCODE:ADB8                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">4</span><span style="color:navy">], bx
</span><span style="color:maroon">DOSCODE:ADBB                 </span><span style="color:navy">mov     word ptr [bp-</span><span style="color:green">2</span><span style="color:navy">], es
</span><span style="color:maroon">DOSCODE:ADBE                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">5</span><span style="color:navy">], al
</span><span style="color:maroon">DOSCODE:ADC1                 </span><span style="color:navy">mov     byte ptr [bp-</span><span style="color:green">6</span><span style="color:navy">], </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:ADC5                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">1Ah</span><span style="color:navy">], dx
</span><span style="color:maroon">DOSCODE:ADC8                 </span><span style="color:navy">mov     word ptr [bp-</span><span style="color:green">18h</span><span style="color:navy">], ds
</span><span style="color:maroon">DOSCODE:ADCB                 </span><span style="color:navy">mov     si, dx
</span><span style="color:maroon">DOSCODE:ADCD                 </span><span style="color:navy">call    </span>DStrLen
<span style="color:maroon">DOSCODE:ADD0                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">16h</span><span style="color:navy">], cx
</span><span style="color:maroon">DOSCODE:ADD3                 </span><span style="color:navy">mov     al, ss:</span><span style="color:green">302h
</span><span style="color:maroon">DOSCODE:ADD7                 </span><span style="color:navy">mov     ss:</span><span style="color:green">84h</span><span style="color:navy">, al
</span><span style="color:maroon">DOSCODE:ADDB                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0A0h
</span><span style="color:maroon">DOSCODE:ADDD                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">DOSCODE:ADDE                 </span><span style="color:navy">or      byte ptr ss:</span><span style="color:green">86h</span><span style="color:navy">, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:ADE4                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:ADE5                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:ADE6                 </span><span style="color:navy">call    </span>$OPEN
<span style="color:maroon">DOSCODE:ADE9                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:ADEA                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:ADEB                 </span><span style="color:navy">jnb     short loc_ADF2
</span><span style="color:maroon">DOSCODE:ADED                 </span><span style="color:navy">xor     al, al
</span><span style="color:maroon">DOSCODE:ADEF                 </span><span style="color:navy">call    </span>$OPEN
<span style="color:maroon">DOSCODE:ADF2
DOSCODE:ADF2 </span><span style="color:navy">loc_ADF2:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:ADF2                 </span><span style="color:navy">pushf
</span><span style="color:maroon">DOSCODE:ADF3                 </span><span style="color:navy">and     byte ptr ss:</span><span style="color:green">86h</span><span style="color:navy">, </span><span style="color:green">0FEh
</span><span style="color:maroon">DOSCODE:ADF9                 </span><span style="color:navy">popf
</span><span style="color:maroon">DOSCODE:ADFA                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSCODE:ADFB                 </span><span style="color:navy">jb      short loc_ADA0
</span><span style="color:maroon">DOSCODE:ADFD                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">8</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:AE00                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:maroon">DOSCODE:AE02                 </span><span style="color:navy">xor     al, al
</span><span style="color:maroon">DOSCODE:AE04                 </span><span style="color:navy">call    </span>$IOCTL
<span style="color:maroon">DOSCODE:AE07                 </span><span style="color:navy">jb      short loc_AE10
</span><span style="color:maroon">DOSCODE:AE09                 </span><span style="color:navy">test    dl, </span><span style="color:green">80h
</span><span style="color:maroon">DOSCODE:AE0C                 </span><span style="color:navy">jz      short loc_AE18
</span><span style="color:maroon">DOSCODE:AE0E                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2
</span><span style="color:maroon">DOSCODE:AE10
DOSCODE:AE10 </span><span style="color:navy">loc_AE10:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AE10                 </span><span style="color:navy">jmp     loc_AEDC
</span><span style="color:maroon">DOSCODE:AE13 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:AE13
DOSCODE:AE13 </span><span style="color:navy">loc_AE13:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AE13                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Ah
</span><span style="color:maroon">DOSCODE:AE15                 </span><span style="color:navy">jmp     loc_AEDC
</span><span style="color:maroon">DOSCODE:AE18 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:AE18
DOSCODE:AE18 </span><span style="color:navy">loc_AE18:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AE18                 </span><span style="color:navy">mov     word ptr [bp-</span><span style="color:green">12h</span><span style="color:navy">], </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:AE1D                 </span><span style="color:navy">mov     word ptr [bp-</span><span style="color:green">0Eh</span><span style="color:navy">], </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:AE22                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">5</span><span style="color:navy">], </span><span style="color:green">2
</span><span style="color:maroon">DOSCODE:AE26                 </span><span style="color:navy">jnz     short loc_AE7B
</span><span style="color:maroon">DOSCODE:AE28                 </span><span style="color:navy">lds     si, [bp-</span><span style="color:green">4</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:AE2B                 </span><span style="color:navy">mov     ax, [si]
</span><span style="color:maroon">DOSCODE:AE2D                 </span><span style="color:navy">or      ax, ax
</span><span style="color:maroon">DOSCODE:AE2F                 </span><span style="color:navy">jnz     short loc_AE3D
</span><span style="color:maroon">DOSCODE:AE31                 </span><span style="color:navy">mov     ds, word ptr ss:</span><span style="color:green">330h
</span><span style="color:maroon">DOSCODE:AE36                 </span><span style="color:navy">mov     ax, ds:</span><span style="color:green">2Ch
</span><span style="color:maroon">DOSCODE:AE39                 </span><span style="color:navy">or      ax, ax
</span><span style="color:maroon">DOSCODE:AE3B                 </span><span style="color:navy">jz      short loc_AE7B
</span><span style="color:maroon">DOSCODE:AE3D
DOSCODE:AE3D </span><span style="color:navy">loc_AE3D:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AE3D                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">DOSCODE:AE3F                 </span><span style="color:navy">xor     di, di
</span><span style="color:maroon">DOSCODE:AE41                 </span><span style="color:navy">mov     cx, </span><span style="color:green">8000h
</span><span style="color:maroon">DOSCODE:AE44                 </span><span style="color:navy">xor     al, al
</span><span style="color:maroon">DOSCODE:AE46
DOSCODE:AE46 </span><span style="color:navy">loc_AE46:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AE46                 </span><span style="color:navy">repne scasb
</span><span style="color:maroon">DOSCODE:AE48                 </span><span style="color:navy">jnz     short loc_AE13
</span><span style="color:maroon">DOSCODE:AE4A                 </span><span style="color:navy">dec     cx
</span><span style="color:maroon">DOSCODE:AE4B                 </span><span style="color:navy">js      short loc_AE13
</span><span style="color:maroon">DOSCODE:AE4D                 </span><span style="color:navy">scasb
</span><span style="color:maroon">DOSCODE:AE4E                 </span><span style="color:navy">jnz     short loc_AE46
</span><span style="color:maroon">DOSCODE:AE50                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:AE51                 </span><span style="color:navy">lea     bx, [di+</span><span style="color:#ff8000">11h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:AE54                 </span><span style="color:navy">add     bx, [bp-</span><span style="color:green">16h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:AE57                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:AE59                 </span><span style="color:navy">shr     bx, cl
</span><span style="color:maroon">DOSCODE:AE5B                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:AE5C                 </span><span style="color:navy">call    </span>$ALLOC
<span style="color:maroon">DOSCODE:AE5F                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:AE60                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:AE61                 </span><span style="color:navy">jnb     short loc_AE65
</span><span style="color:maroon">DOSCODE:AE63                 </span><span style="color:navy">jmp     short loc_AED6
</span><span style="color:maroon">DOSCODE:AE65 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:AE65
DOSCODE:AE65 </span><span style="color:navy">loc_AE65:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AE65                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">DOSCODE:AE67                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">0Eh</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:AE6A                 </span><span style="color:navy">xor     si, si
</span><span style="color:maroon">DOSCODE:AE6C                 </span><span style="color:navy">mov     di, si
</span><span style="color:maroon">DOSCODE:AE6E                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">DOSCODE:AE70                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:maroon">DOSCODE:AE71                 </span><span style="color:navy">inc     ax
</span><span style="color:maroon">DOSCODE:AE72                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:AE73                 </span><span style="color:navy">lds     si, [bp-</span><span style="color:green">1Ah</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:AE76                 </span><span style="color:navy">mov     cx, [bp-</span><span style="color:green">16h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:AE79                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">DOSCODE:AE7B
DOSCODE:AE7B </span><span style="color:navy">loc_AE7B:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AE7B                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:AE7C                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:AE7D                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1Ah
</span><span style="color:maroon">DOSCODE:AE80                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">0EC7h
</span><span style="color:maroon">DOSCODE:AE83                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:AE84                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:AE85                 </span><span style="color:navy">call    </span>ExecRead
<span style="color:maroon">DOSCODE:AE88                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:AE89                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:AE8A                 </span><span style="color:navy">jb      short loc_AEDA
</span><span style="color:maroon">DOSCODE:AE8C                 </span><span style="color:navy">or      ax, ax
</span><span style="color:maroon">DOSCODE:AE8E                 </span><span style="color:navy">jz      short loc_AEDA
</span><span style="color:maroon">DOSCODE:AE90                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">1Ah
</span><span style="color:maroon">DOSCODE:AE93                 </span><span style="color:navy">jnz     short loc_AEAE
</span><span style="color:maroon">DOSCODE:AE95                 </span><span style="color:navy">test    word ptr ds:</span><span style="color:green">0ED3h</span><span style="color:navy">, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:AE9B                 </span><span style="color:navy">jnz     short loc_AEA1
</span><span style="color:maroon">DOSCODE:AE9D                 </span><span style="color:navy">mov     byte ptr [bp-</span><span style="color:green">6</span><span style="color:navy">], </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:AEA1
DOSCODE:AEA1 </span><span style="color:navy">loc_AEA1:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AEA1                 </span><span style="color:navy">mov     ax, ds:</span><span style="color:green">0EC7h
</span><span style="color:maroon">DOSCODE:AEA4                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">5A4Dh
</span><span style="color:maroon">DOSCODE:AEA7                 </span><span style="color:navy">jz      short loc_AEB1
</span><span style="color:maroon">DOSCODE:AEA9                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">4D5Ah
</span><span style="color:maroon">DOSCODE:AEAC                 </span><span style="color:navy">jz      short loc_AEB1
</span><span style="color:maroon">DOSCODE:AEAE
DOSCODE:AEAE </span><span style="color:navy">loc_AEAE:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AEAE                 </span><span style="color:navy">jmp     loc_B0A4
</span><span style="color:maroon">DOSCODE:AEB1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:AEB1
DOSCODE:AEB1 </span><span style="color:navy">loc_AEB1:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AEB1                 </span><span style="color:navy">mov     ax, ds:</span><span style="color:green">0ECBh
</span><span style="color:maroon">DOSCODE:AEB4                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">5
</span><span style="color:maroon">DOSCODE:AEB6                 </span><span style="color:navy">shl     ax, cl
</span><span style="color:maroon">DOSCODE:AEB8                 </span><span style="color:navy">sub     ax, ds:</span><span style="color:green">0ECFh
</span><span style="color:maroon">DOSCODE:AEBC                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">0Ch</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:AEBF                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">5</span><span style="color:navy">], </span><span style="color:green">2
</span><span style="color:maroon">DOSCODE:AEC3                 </span><span style="color:navy">jz      short loc_AF0C
</span><span style="color:maroon">DOSCODE:AEC5                 </span><span style="color:navy">les     di, [bp-</span><span style="color:green">4</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:AEC8                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:AEC9                 </span><span style="color:navy">les     ax, es:[di]
</span><span style="color:maroon">DOSCODE:AECC                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">14h</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:AECF                 </span><span style="color:navy">mov     word ptr [bp-</span><span style="color:green">0Ah</span><span style="color:navy">], es
</span><span style="color:maroon">DOSCODE:AED2                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:AED3                 </span><span style="color:navy">jmp     loc_AFB8
</span><span style="color:maroon">DOSCODE:AED6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:AED6
DOSCODE:AED6 </span><span style="color:navy">loc_AED6:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AED6                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">8
</span><span style="color:maroon">DOSCODE:AED8                 </span><span style="color:navy">jmp     short loc_AEDC
</span><span style="color:maroon">DOSCODE:AEDA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:AEDA
DOSCODE:AEDA </span><span style="color:navy">loc_AEDA:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AEDA                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Bh
</span><span style="color:maroon">DOSCODE:AEDC
DOSCODE:AEDC </span><span style="color:navy">loc_AEDC:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AEDC                 </span><span style="color:navy">mov     bx, [bp-</span><span style="color:green">8</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:AEDF                 </span><span style="color:navy">call    </span>Exec_Dealloc
<span style="color:maroon">DOSCODE:AEE2                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:maroon">DOSCODE:AEE5                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:AEE6                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">DOSCODE:AEE7                 </span><span style="color:navy">call    </span>$CLOSE
<span style="color:maroon">DOSCODE:AEEA                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSCODE:AEEB                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:AEEC                 </span><span style="color:navy">jmp     loc_ADA0
</span><span style="color:maroon">DOSCODE:AEEF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:AEEF
DOSCODE:AEEF </span><span style="color:navy">loc_AEEF:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AEEF                 </span><span style="color:navy">mov     al, ss:</span><span style="color:green">302h
</span><span style="color:maroon">DOSCODE:AEF3                 </span><span style="color:navy">mov     bl, ss:</span><span style="color:green">84h
</span><span style="color:maroon">DOSCODE:AEF8                 </span><span style="color:navy">mov     ss:</span><span style="color:green">302h</span><span style="color:navy">, bl
</span><span style="color:maroon">DOSCODE:AEFD                 </span><span style="color:navy">test    bl, </span><span style="color:green">40h
</span><span style="color:maroon">DOSCODE:AF00                 </span><span style="color:navy">jnz     short loc_AED6
</span><span style="color:maroon">DOSCODE:AF02                 </span><span style="color:navy">test    al, </span><span style="color:green">40h
</span><span style="color:maroon">DOSCODE:AF04                 </span><span style="color:navy">jz      short loc_AED6
</span><span style="color:maroon">DOSCODE:AF06                 </span><span style="color:navy">mov     ax, ss:</span><span style="color:green">8Ah
</span><span style="color:maroon">DOSCODE:AF0A                 </span><span style="color:navy">jmp     short loc_AF34
</span><span style="color:maroon">DOSCODE:AF0C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:AF0C
DOSCODE:AF0C </span><span style="color:navy">loc_AF0C:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AF0C                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:maroon">DOSCODE:AF0E                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">1Dh</span><span style="color:navy">], bl
</span><span style="color:maroon">DOSCODE:AF11                 </span><span style="color:navy">cmp     ds:</span><span style="color:green">0ED5h</span><span style="color:navy">, bx
</span><span style="color:maroon">DOSCODE:AF15                 </span><span style="color:navy">jnz     short loc_AF28
</span><span style="color:maroon">DOSCODE:AF17                 </span><span style="color:navy">cmp     ds:</span><span style="color:green">0ED7h</span><span style="color:navy">, bx
</span><span style="color:maroon">DOSCODE:AF1B                 </span><span style="color:navy">jnz     short loc_AF28
</span><span style="color:maroon">DOSCODE:AF1D                 </span><span style="color:navy">inc     byte ptr [bp-</span><span style="color:green">1Dh</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:AF20                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">0FF0h
</span><span style="color:maroon">DOSCODE:AF23                 </span><span style="color:navy">jnb     short loc_AF28
</span><span style="color:maroon">DOSCODE:AF25                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">10h
</span><span style="color:maroon">DOSCODE:AF28
DOSCODE:AF28 </span><span style="color:navy">loc_AF28:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AF28                 </span><span style="color:navy">test    byte ptr ds:</span><span style="color:green">302h</span><span style="color:navy">, </span><span style="color:green">80h
</span><span style="color:maroon">DOSCODE:AF2D                 </span><span style="color:navy">jz      short loc_AF34
</span><span style="color:maroon">DOSCODE:AF2F                 </span><span style="color:navy">or      byte ptr ds:</span><span style="color:green">302h</span><span style="color:navy">, </span><span style="color:green">40h
</span><span style="color:maroon">DOSCODE:AF34
DOSCODE:AF34 </span><span style="color:navy">loc_AF34:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AF34                 </span><span style="color:navy">mov     ds:</span><span style="color:green">8Ah</span><span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:AF37                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:AF3A                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:AF3B                 </span><span style="color:navy">call    </span>$ALLOC
<span style="color:maroon">DOSCODE:AF3E                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:AF3F                 </span><span style="color:navy">mov     ax, ds:</span><span style="color:green">8Ah
</span><span style="color:maroon">DOSCODE:AF42                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">10h
</span><span style="color:maroon">DOSCODE:AF45                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">11h
</span><span style="color:maroon">DOSCODE:AF48                 </span><span style="color:navy">jb      short loc_AEEF
</span><span style="color:maroon">DOSCODE:AF4A                 </span><span style="color:navy">cmp     ax, bx
</span><span style="color:maroon">DOSCODE:AF4C                 </span><span style="color:navy">ja      short loc_AEEF
</span><span style="color:maroon">DOSCODE:AF4E                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">6</span><span style="color:navy">], </span><span style="color:green">0FFh
</span><span style="color:maroon">DOSCODE:AF52                 </span><span style="color:navy">jnz     short loc_AF6C
</span><span style="color:maroon">DOSCODE:AF54                 </span><span style="color:navy">add     ax, ds:</span><span style="color:green">0ED1h
</span><span style="color:maroon">DOSCODE:AF58                 </span><span style="color:navy">jb      short loc_AEEF
</span><span style="color:maroon">DOSCODE:AF5A                 </span><span style="color:navy">cmp     ax, bx
</span><span style="color:maroon">DOSCODE:AF5C                 </span><span style="color:navy">ja      short loc_AEEF
</span><span style="color:maroon">DOSCODE:AF5E                 </span><span style="color:navy">sub     ax, ds:</span><span style="color:green">0ED1h
</span><span style="color:maroon">DOSCODE:AF62                 </span><span style="color:navy">add     ax, ds:</span><span style="color:green">0ED3h
</span><span style="color:maroon">DOSCODE:AF66                 </span><span style="color:navy">jb      short loc_AF6C
</span><span style="color:maroon">DOSCODE:AF68                 </span><span style="color:navy">cmp     ax, bx
</span><span style="color:maroon">DOSCODE:AF6A                 </span><span style="color:navy">jbe     short loc_AF6E
</span><span style="color:maroon">DOSCODE:AF6C
DOSCODE:AF6C </span><span style="color:navy">loc_AF6C:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AF6C                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:maroon">DOSCODE:AF6E
DOSCODE:AF6E </span><span style="color:navy">loc_AF6E:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AF6E                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:AF6F                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:maroon">DOSCODE:AF71                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">10h</span><span style="color:navy">], bx
</span><span style="color:maroon">DOSCODE:AF74                 </span><span style="color:navy">call    </span>$ALLOC
<span style="color:maroon">DOSCODE:AF77                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:AF78                 </span><span style="color:navy">jnb     short loc_AF7D
</span><span style="color:maroon">DOSCODE:AF7A                 </span><span style="color:navy">jmp     loc_AEEF
</span><span style="color:maroon">DOSCODE:AF7D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:AF7D
DOSCODE:AF7D </span><span style="color:navy">loc_AF7D:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AF7D                 </span><span style="color:navy">mov     cl, ds:</span><span style="color:green">84h
</span><span style="color:maroon">DOSCODE:AF81                 </span><span style="color:navy">mov     ds:</span><span style="color:green">302h</span><span style="color:navy">, cl
</span><span style="color:maroon">DOSCODE:AF85                 </span><span style="color:navy">cmp     byte ptr [bp-</span><span style="color:green">1Dh</span><span style="color:navy">], </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:AF89                 </span><span style="color:navy">jz      short loc_AF9D
</span><span style="color:maroon">DOSCODE:AF8B                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">1000h
</span><span style="color:maroon">DOSCODE:AF8F                 </span><span style="color:navy">jnb     short loc_AF9D
</span><span style="color:maroon">DOSCODE:AF91                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:AF93                 </span><span style="color:navy">shl     bx, cl
</span><span style="color:maroon">DOSCODE:AF95                 </span><span style="color:navy">sub     bx, </span><span style="color:#ff8000">100h
</span><span style="color:maroon">DOSCODE:AF99                 </span><span style="color:navy">mov     ds:</span><span style="color:green">0ED7h</span><span style="color:navy">, bx
</span><span style="color:maroon">DOSCODE:AF9D
DOSCODE:AF9D </span><span style="color:navy">loc_AF9D:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AF9D                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">12h</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:AFA0                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">10h
</span><span style="color:maroon">DOSCODE:AFA3                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">6</span><span style="color:navy">], </span><span style="color:green">0FFh
</span><span style="color:maroon">DOSCODE:AFA7                 </span><span style="color:navy">jz      short loc_AFB2
</span><span style="color:maroon">DOSCODE:AFA9                 </span><span style="color:navy">add     ax, [bp-</span><span style="color:green">10h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:AFAC                 </span><span style="color:navy">sub     ax, [bp-</span><span style="color:green">0Ch</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:AFAF                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">10h
</span><span style="color:maroon">DOSCODE:AFB2
DOSCODE:AFB2 </span><span style="color:navy">loc_AFB2:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AFB2                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">0Ah</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:AFB5                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">14h</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:AFB8
DOSCODE:AFB8 </span><span style="color:navy">loc_AFB8:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AFB8                 </span><span style="color:navy">mov     dx, [bp-</span><span style="color:green">14h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:AFBB                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">1Ch</span><span style="color:navy">], dx
</span><span style="color:maroon">DOSCODE:AFBE                 </span><span style="color:navy">mov     dx, ds:</span><span style="color:green">0ECFh
</span><span style="color:maroon">DOSCODE:AFC2                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:AFC3                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:AFC5                 </span><span style="color:navy">shl     dx, cl
</span><span style="color:maroon">DOSCODE:AFC7                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:AFC8                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">0Ch
</span><span style="color:maroon">DOSCODE:AFCA                 </span><span style="color:navy">shr     ax, cl
</span><span style="color:maroon">DOSCODE:AFCC                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:maroon">DOSCODE:AFCE                 </span><span style="color:navy">mov     bx, [bp-</span><span style="color:green">8</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:AFD1                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:AFD2                 </span><span style="color:navy">xor     al, al
</span><span style="color:maroon">DOSCODE:AFD4                 </span><span style="color:navy">call    </span>$LSEEK
<span style="color:maroon">DOSCODE:AFD7                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:AFD8                 </span><span style="color:navy">jnb     short loc_AFDD
</span><span style="color:maroon">DOSCODE:AFDA                 </span><span style="color:navy">jmp     loc_AEDC
</span><span style="color:maroon">DOSCODE:AFDD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:AFDD
DOSCODE:AFDD </span><span style="color:navy">loc_AFDD:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AFDD                 </span><span style="color:navy">mov     bx, [bp-</span><span style="color:green">0Ch</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:AFE0                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">1000h
</span><span style="color:maroon">DOSCODE:AFE4                 </span><span style="color:navy">jb      short loc_AFE9
</span><span style="color:maroon">DOSCODE:AFE6                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">0FE0h
</span><span style="color:maroon">DOSCODE:AFE9
DOSCODE:AFE9 </span><span style="color:navy">loc_AFE9:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:AFE9                 </span><span style="color:navy">sub     [bp-</span><span style="color:green">0Ch</span><span style="color:navy">], bx
</span><span style="color:maroon">DOSCODE:AFEC                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:AFED                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:AFEF                 </span><span style="color:navy">shl     bx, cl
</span><span style="color:maroon">DOSCODE:AFF1                 </span><span style="color:navy">mov     cx, bx
</span><span style="color:maroon">DOSCODE:AFF3                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:AFF4                 </span><span style="color:navy">mov     ds, word ptr [bp-</span><span style="color:green">14h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:AFF7                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:maroon">DOSCODE:AFF9                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:AFFA                 </span><span style="color:navy">call    </span>ExecRead
<span style="color:maroon">DOSCODE:AFFD                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:AFFE                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:AFFF                 </span><span style="color:navy">jb      short loc_B049
</span><span style="color:maroon">DOSCODE:B001                 </span><span style="color:navy">cmp     cx, ax
</span><span style="color:maroon">DOSCODE:B003                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:B004                 </span><span style="color:navy">jz      short loc_B00E
</span><span style="color:maroon">DOSCODE:B006                 </span><span style="color:navy">sub     cx, ax
</span><span style="color:maroon">DOSCODE:B008                 </span><span style="color:navy">cmp     cx, </span><span style="color:#ff8000">200h
</span><span style="color:maroon">DOSCODE:B00C                 </span><span style="color:navy">jnb     short loc_B049
</span><span style="color:maroon">DOSCODE:B00E
DOSCODE:B00E </span><span style="color:navy">loc_B00E:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B00E                 </span><span style="color:navy">add     [bp-</span><span style="color:green">14h</span><span style="color:navy">], bx
</span><span style="color:maroon">DOSCODE:B011                 </span><span style="color:navy">test    word ptr [bp-</span><span style="color:green">0Ch</span><span style="color:navy">], </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:B016                 </span><span style="color:navy">jnz     short loc_AFDD
</span><span style="color:maroon">DOSCODE:B018                 </span><span style="color:navy">mov     cx, [bp-</span><span style="color:green">0Ah</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B01B                 </span><span style="color:navy">mov     ax, ds:</span><span style="color:green">0ED5h
</span><span style="color:maroon">DOSCODE:B01E                 </span><span style="color:navy">add     ax, cx
</span><span style="color:maroon">DOSCODE:B020                 </span><span style="color:navy">mov     ds:</span><span style="color:green">0EC1h</span><span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:B023                 </span><span style="color:navy">mov     ax, ds:</span><span style="color:green">0ED7h
</span><span style="color:maroon">DOSCODE:B026                 </span><span style="color:navy">mov     ds:</span><span style="color:green">0EBFh</span><span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:B029                 </span><span style="color:navy">les     ax, ds:</span><span style="color:green">0EDBh
</span><span style="color:maroon">DOSCODE:B02D                 </span><span style="color:navy">mov     ds:</span><span style="color:green">0EC3h</span><span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:B030                 </span><span style="color:navy">mov     ax, es
</span><span style="color:maroon">DOSCODE:B032                 </span><span style="color:navy">add     ax, cx
</span><span style="color:maroon">DOSCODE:B034                 </span><span style="color:navy">mov     ds:</span><span style="color:green">0EC5h</span><span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:B037                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:maroon">DOSCODE:B039                 </span><span style="color:navy">mov     dx, ds:</span><span style="color:green">0EDFh
</span><span style="color:maroon">DOSCODE:B03D                 </span><span style="color:navy">mov     bx, [bp-</span><span style="color:green">8</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B040                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:B041                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">DOSCODE:B043                 </span><span style="color:navy">call    </span>$LSEEK
<span style="color:maroon">DOSCODE:B046                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:B047                 </span><span style="color:navy">jnb     short loc_B04C
</span><span style="color:maroon">DOSCODE:B049
DOSCODE:B049 </span><span style="color:navy">loc_B049:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B049                 </span><span style="color:navy">jmp     loc_AEDA
</span><span style="color:maroon">DOSCODE:B04C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B04C
DOSCODE:B04C </span><span style="color:navy">loc_B04C:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B04C                 </span><span style="color:navy">mov     dx, ds:</span><span style="color:green">0ECDh
</span><span style="color:maroon">DOSCODE:B050
DOSCODE:B050 </span><span style="color:navy">loc_B050:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B050                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:B051                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">3BEh
</span><span style="color:maroon">DOSCODE:B054                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">18Ch
</span><span style="color:maroon">DOSCODE:B057                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:B058                 </span><span style="color:navy">call    </span>ExecRead
<span style="color:maroon">DOSCODE:B05B                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:B05C                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:B05D                 </span><span style="color:navy">jb      short loc_B049
</span><span style="color:maroon">DOSCODE:B05F                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">63h </span><span style="color:gray">; &#039;c&#039;
</span><span style="color:maroon">DOSCODE:B062                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">3BEh
</span><span style="color:maroon">DOSCODE:B065                 </span><span style="color:navy">mov     si, [bp-</span><span style="color:green">0Ah</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B068
DOSCODE:B068 </span><span style="color:navy">loc_B068:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B068                 </span><span style="color:navy">or      dx, dx
</span><span style="color:maroon">DOSCODE:B06A                 </span><span style="color:navy">jz      short loc_B082
</span><span style="color:maroon">DOSCODE:B06C                 </span><span style="color:navy">lds     bx, es:[di]
</span><span style="color:maroon">DOSCODE:B06F                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:maroon">DOSCODE:B071                 </span><span style="color:navy">add     ax, [bp-</span><span style="color:green">1Ch</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B074                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">DOSCODE:B076                 </span><span style="color:navy">add     [bx], si
</span><span style="color:maroon">DOSCODE:B078                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:B07B                 </span><span style="color:navy">dec     dx
</span><span style="color:maroon">DOSCODE:B07C                 </span><span style="color:navy">loop    loc_B068
</span><span style="color:maroon">DOSCODE:B07E                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:B07F                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:B080                 </span><span style="color:navy">jmp     short loc_B050
</span><span style="color:maroon">DOSCODE:B082 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B082
DOSCODE:B082 </span><span style="color:navy">loc_B082:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B082                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:B083                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:B084                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:B085                 </span><span style="color:navy">mov     es, word ptr [bp-</span><span style="color:green">1Ch</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B088                 </span><span style="color:navy">mov     ax, ss:</span><span style="color:green">0EC5h
</span><span style="color:maroon">DOSCODE:B08C                 </span><span style="color:navy">mov     cx, ss:</span><span style="color:green">0EC3h
</span><span style="color:maroon">DOSCODE:B091                 </span><span style="color:navy">call    word ptr ss:</span><span style="color:green">0D67h
</span><span style="color:maroon">DOSCODE:B096                 </span><span style="color:navy">call    word ptr ss:</span><span style="color:green">133Eh
</span><span style="color:maroon">DOSCODE:B09B                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:B09C                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:B09D                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:B09E                 </span><span style="color:navy">jmp     loc_B17E
</span><span style="color:maroon">DOSCODE:B0A1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B0A1
DOSCODE:B0A1 </span><span style="color:navy">loc_B0A1:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B0A1                 </span><span style="color:navy">jmp     loc_AED6
</span><span style="color:maroon">DOSCODE:B0A4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B0A4
DOSCODE:B0A4 </span><span style="color:navy">loc_B0A4:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B0A4                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">5</span><span style="color:navy">], </span><span style="color:green">2
</span><span style="color:maroon">DOSCODE:B0A8                 </span><span style="color:navy">jz      short loc_B0D7
</span><span style="color:maroon">DOSCODE:B0AA                 </span><span style="color:navy">lds     si, [bp-</span><span style="color:green">4</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B0AD                 </span><span style="color:navy">lodsw
</span><span style="color:maroon">DOSCODE:B0AE                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">14h</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:B0B1                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:B0B4                 </span><span style="color:navy">jmp     short loc_B119
</span><span style="color:maroon">DOSCODE:B0B6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B0B6
DOSCODE:B0B6 </span><span style="color:navy">loc_B0B6:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B0B6                 </span><span style="color:navy">mov     al, ss:</span><span style="color:green">302h
</span><span style="color:maroon">DOSCODE:B0BA                 </span><span style="color:navy">mov     bl, ss:</span><span style="color:green">84h
</span><span style="color:maroon">DOSCODE:B0BF                 </span><span style="color:navy">mov     ss:</span><span style="color:green">302h</span><span style="color:navy">, bl
</span><span style="color:maroon">DOSCODE:B0C4                 </span><span style="color:navy">test    bl, </span><span style="color:green">40h
</span><span style="color:maroon">DOSCODE:B0C7                 </span><span style="color:navy">jnz     short loc_B0A1
</span><span style="color:maroon">DOSCODE:B0C9                 </span><span style="color:navy">test    al, </span><span style="color:green">40h
</span><span style="color:maroon">DOSCODE:B0CB                 </span><span style="color:navy">jz      short loc_B0A1
</span><span style="color:maroon">DOSCODE:B0CD                 </span><span style="color:navy">mov     ax, [bp-</span><span style="color:green">12h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B0D0                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:maroon">DOSCODE:B0D2                 </span><span style="color:navy">call    sub_B34B
</span><span style="color:maroon">DOSCODE:B0D5                 </span><span style="color:navy">jmp     short loc_B0E5
</span><span style="color:maroon">DOSCODE:B0D7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B0D7
DOSCODE:B0D7 </span><span style="color:navy">loc_B0D7:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B0D7                 </span><span style="color:navy">test    byte ptr ss:</span><span style="color:green">302h</span><span style="color:navy">, </span><span style="color:green">80h
</span><span style="color:maroon">DOSCODE:B0DD                 </span><span style="color:navy">jz      short loc_B0E5
</span><span style="color:maroon">DOSCODE:B0DF                 </span><span style="color:navy">or      byte ptr ss:</span><span style="color:green">302h</span><span style="color:navy">, </span><span style="color:green">40h
</span><span style="color:maroon">DOSCODE:B0E5
DOSCODE:B0E5 </span><span style="color:navy">loc_B0E5:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B0E5                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:B0E8                 </span><span style="color:navy">call    </span>$ALLOC
<span style="color:maroon">DOSCODE:B0EB                 </span><span style="color:navy">or      bx, bx
</span><span style="color:maroon">DOSCODE:B0ED                 </span><span style="color:navy">jz      short loc_B0B6
</span><span style="color:maroon">DOSCODE:B0EF                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">10h</span><span style="color:navy">], bx
</span><span style="color:maroon">DOSCODE:B0F2                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:B0F3                 </span><span style="color:navy">call    </span>$ALLOC
<span style="color:maroon">DOSCODE:B0F6                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:B0F7                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">12h</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:B0FA                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">10h
</span><span style="color:maroon">DOSCODE:B0FD                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">14h</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:B100                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">DOSCODE:B102                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">1000h
</span><span style="color:maroon">DOSCODE:B106                 </span><span style="color:navy">jnb     short loc_B116
</span><span style="color:maroon">DOSCODE:B108                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:maroon">DOSCODE:B10A                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:B10C                 </span><span style="color:navy">shl     ax, cl
</span><span style="color:maroon">DOSCODE:B10E                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">200h
</span><span style="color:maroon">DOSCODE:B111                 </span><span style="color:navy">jbe     short loc_B0B6
</span><span style="color:maroon">DOSCODE:B113                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">100h
</span><span style="color:maroon">DOSCODE:B116
DOSCODE:B116 </span><span style="color:navy">loc_B116:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B116                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">100h
</span><span style="color:maroon">DOSCODE:B119
DOSCODE:B119 </span><span style="color:navy">loc_B119:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B119                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:B11A                 </span><span style="color:navy">mov     bx, [bp-</span><span style="color:green">8</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B11D                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:maroon">DOSCODE:B11F                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">DOSCODE:B121                 </span><span style="color:navy">cwd
</span><span style="color:maroon">DOSCODE:B122                 </span><span style="color:navy">call    </span>$LSEEK
<span style="color:maroon">DOSCODE:B125                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:B126                 </span><span style="color:navy">mov     ds, word ptr [bp-</span><span style="color:green">14h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B129                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:maroon">DOSCODE:B12B                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:B12C                 </span><span style="color:navy">call    </span>ExecRead
<span style="color:maroon">DOSCODE:B12F                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:B130                 </span><span style="color:navy">jnb     short loc_B135
</span><span style="color:maroon">DOSCODE:B132                 </span><span style="color:navy">jmp     loc_AEDA
</span><span style="color:maroon">DOSCODE:B135 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B135
DOSCODE:B135 </span><span style="color:navy">loc_B135:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B135                 </span><span style="color:navy">cmp     ax, si
</span><span style="color:maroon">DOSCODE:B137                 </span><span style="color:navy">jnz     short loc_B13C
</span><span style="color:maroon">DOSCODE:B139                 </span><span style="color:navy">jmp     loc_B0B6
</span><span style="color:maroon">DOSCODE:B13C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B13C
DOSCODE:B13C </span><span style="color:navy">loc_B13C:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B13C                 </span><span style="color:navy">mov     bl, ss:</span><span style="color:green">84h
</span><span style="color:maroon">DOSCODE:B141                 </span><span style="color:navy">mov     ss:</span><span style="color:green">302h</span><span style="color:navy">, bl
</span><span style="color:maroon">DOSCODE:B146                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">5</span><span style="color:navy">], </span><span style="color:green">2
</span><span style="color:maroon">DOSCODE:B14A                 </span><span style="color:navy">jnz     short loc_B17E
</span><span style="color:maroon">DOSCODE:B14C                 </span><span style="color:navy">mov     ax, [bp-</span><span style="color:green">14h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B14F                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">10h
</span><span style="color:maroon">DOSCODE:B152                 </span><span style="color:navy">mov     ss:</span><span style="color:green">0EC5h</span><span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:B156                 </span><span style="color:navy">mov     word ptr ss:</span><span style="color:green">0EC3h</span><span style="color:navy">, </span><span style="color:#ff8000">100h
</span><span style="color:maroon">DOSCODE:B15D                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">0FEh
</span><span style="color:maroon">DOSCODE:B161                 </span><span style="color:navy">cmp     si, </span><span style="color:green">0FFFEh
</span><span style="color:maroon">DOSCODE:B164                 </span><span style="color:navy">jz      short loc_B16A
</span><span style="color:maroon">DOSCODE:B166                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">100h
</span><span style="color:maroon">DOSCODE:B16A
DOSCODE:B16A </span><span style="color:navy">loc_B16A:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B16A                 </span><span style="color:navy">mov     ss:</span><span style="color:green">0EBFh</span><span style="color:navy">, si
</span><span style="color:maroon">DOSCODE:B16F                 </span><span style="color:navy">mov     ss:</span><span style="color:green">0EC1h</span><span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:B173                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">DOSCODE:B175                 </span><span style="color:navy">mov     word ptr [si], </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:B179                 </span><span style="color:navy">call    word ptr ss:</span><span style="color:green">61h
</span><span style="color:maroon">DOSCODE:B17E
DOSCODE:B17E </span><span style="color:navy">loc_B17E:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B17E                 </span><span style="color:navy">mov     bx, [bp-</span><span style="color:green">8</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B181                 </span><span style="color:navy">call    </span>Exec_Dealloc
<span style="color:maroon">DOSCODE:B184                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">DOSCODE:B185                 </span><span style="color:navy">call    </span>$CLOSE
<span style="color:maroon">DOSCODE:B188                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSCODE:B189                 </span><span style="color:navy">call    </span>Exec_Alloc
<span style="color:maroon">DOSCODE:B18C                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">5</span><span style="color:navy">], </span><span style="color:green">2
</span><span style="color:maroon">DOSCODE:B190                 </span><span style="color:navy">jz      short loc_B1CC
</span><span style="color:maroon">DOSCODE:B192                 </span><span style="color:navy">call    sub_B359
</span><span style="color:maroon">DOSCODE:B195                 </span><span style="color:navy">call    sub_B370
</span><span style="color:maroon">DOSCODE:B198                 </span><span style="color:navy">cmp     byte ptr ss:</span><span style="color:green">1322h</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:B19E                 </span><span style="color:navy">jz      short loc_B1C6
</span><span style="color:maroon">DOSCODE:B1A0                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:B1A1                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:B1A2                 </span><span style="color:navy">les     si, ss:</span><span style="color:green">1323h
</span><span style="color:maroon">DOSCODE:B1A7                 </span><span style="color:navy">cmp     byte ptr es:[si], </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:B1AB                 </span><span style="color:navy">jz      short loc_B1BE
</span><span style="color:maroon">DOSCODE:B1AD                 </span><span style="color:navy">mov     es, word ptr ss:</span><span style="color:green">330h
</span><span style="color:maroon">DOSCODE:B1B2                 </span><span style="color:navy">push    word ptr ss:</span><span style="color:green">0EBBh
</span><span style="color:maroon">DOSCODE:B1B7                 </span><span style="color:navy">pop     word ptr es:</span><span style="color:green">40h
</span><span style="color:maroon">DOSCODE:B1BC                 </span><span style="color:navy">jmp     short loc_B1C4
</span><span style="color:maroon">DOSCODE:B1BE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B1BE
DOSCODE:B1BE </span><span style="color:navy">loc_B1BE:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B1BE                 </span><span style="color:navy">mov     byte ptr ss:</span><span style="color:green">1322h</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:B1C4
DOSCODE:B1C4 </span><span style="color:navy">loc_B1C4:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B1C4                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:B1C5                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:B1C6
DOSCODE:B1C6 </span><span style="color:navy">loc_B1C6:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B1C6                 </span><span style="color:navy">mov     sp, bp
</span><span style="color:maroon">DOSCODE:B1C8                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSCODE:B1C9                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:B1CC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B1CC
DOSCODE:B1CC </span><span style="color:navy">loc_B1CC:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B1CC                 </span><span style="color:navy">mov     dx, [bp-</span><span style="color:green">12h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B1CF                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:B1D2                 </span><span style="color:navy">mov     ax, [bp-</span><span style="color:green">0Eh</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B1D5                 </span><span style="color:navy">or      ax, ax
</span><span style="color:maroon">DOSCODE:B1D7                 </span><span style="color:navy">jz      short loc_B1DE
</span><span style="color:maroon">DOSCODE:B1D9                 </span><span style="color:navy">dec     ax
</span><span style="color:maroon">DOSCODE:B1DA                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">DOSCODE:B1DC                 </span><span style="color:navy">mov     [si], dx
</span><span style="color:maroon">DOSCODE:B1DE
DOSCODE:B1DE </span><span style="color:navy">loc_B1DE:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B1DE                 </span><span style="color:navy">mov     ax, [bp-</span><span style="color:green">12h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B1E1                 </span><span style="color:navy">dec     ax
</span><span style="color:maroon">DOSCODE:B1E2                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">DOSCODE:B1E4                 </span><span style="color:navy">mov     [si], dx
</span><span style="color:maroon">DOSCODE:B1E6                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:B1E7                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:B1E8                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">8
</span><span style="color:maroon">DOSCODE:B1EB                 </span><span style="color:navy">call    sub_B359
</span><span style="color:maroon">DOSCODE:B1EE                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:B1EF                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:B1F0
DOSCODE:B1F0 </span><span style="color:navy">loc_B1F0:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B1F0                 </span><span style="color:navy">lodsb
</span><span style="color:maroon">DOSCODE:B1F1                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2Eh </span><span style="color:gray">; &#039;.&#039;
</span><span style="color:maroon">DOSCODE:B1F3                 </span><span style="color:navy">jz      short loc_B1FD
</span><span style="color:maroon">DOSCODE:B1F5                 </span><span style="color:navy">stosb
</span><span style="color:maroon">DOSCODE:B1F6                 </span><span style="color:navy">cmp     di, </span><span style="color:#ff8000">10h
</span><span style="color:maroon">DOSCODE:B1F9                 </span><span style="color:navy">jnb     short loc_B1FD
</span><span style="color:maroon">DOSCODE:B1FB                 </span><span style="color:navy">loop    loc_B1F0
</span><span style="color:maroon">DOSCODE:B1FD
DOSCODE:B1FD </span><span style="color:navy">loc_B1FD:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B1FD                 </span><span style="color:navy">xor     al, al
</span><span style="color:maroon">DOSCODE:B1FF                 </span><span style="color:navy">cmp     di, </span><span style="color:#ff8000">10h
</span><span style="color:maroon">DOSCODE:B202                 </span><span style="color:navy">jnb     short loc_B205
</span><span style="color:maroon">DOSCODE:B204                 </span><span style="color:navy">stosb
</span><span style="color:maroon">DOSCODE:B205
DOSCODE:B205 </span><span style="color:navy">loc_B205:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B205                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:B206                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:B207                 </span><span style="color:navy">call    sub_B370
</span><span style="color:maroon">DOSCODE:B20A                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:B20B                 </span><span style="color:navy">mov     si, [bp-</span><span style="color:green">10h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B20E                 </span><span style="color:navy">add     si, dx
</span><span style="color:maroon">DOSCODE:B210                 </span><span style="color:navy">call    </span>$DUP_PDB
<span style="color:maroon">DOSCODE:B213                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:B214                 </span><span style="color:navy">push    word ptr [bp-</span><span style="color:green">0Eh</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B217                 </span><span style="color:navy">pop     word ptr es:</span><span style="color:green">2Ch
</span><span style="color:maroon">DOSCODE:B21C                 </span><span style="color:navy">push    ss:</span>SPECIAL_VERSION
<span style="color:maroon">DOSCODE:B221                 </span><span style="color:navy">pop     word ptr es:</span><span style="color:green">40h
</span><span style="color:maroon">DOSCODE:B226                 </span><span style="color:navy">lds     si, [bp-</span><span style="color:green">4</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B229                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:B22A                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:B22B                 </span><span style="color:navy">lds     si, [si+</span><span style="color:#ff8000">6</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B22E                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">0Ch
</span><span style="color:maroon">DOSCODE:B231                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:B232                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">5Ch </span><span style="color:gray">; &#039;\&#039;
</span><span style="color:maroon">DOSCODE:B235                 </span><span style="color:navy">mov     bl, [si]
</span><span style="color:maroon">DOSCODE:B237                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">DOSCODE:B239                 </span><span style="color:navy">xchg    ax, cx
</span><span style="color:maroon">DOSCODE:B23A                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:B23B                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:B23C                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:B23D                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:B23E                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:B23F                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:B240                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:B241                 </span><span style="color:navy">lds     si, [si+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B244                 </span><span style="color:navy">mov     bh, [si]
</span><span style="color:maroon">DOSCODE:B246                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">DOSCODE:B248                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:B249                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:B24A                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:B24B                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:B24C                 </span><span style="color:navy">lds     si, [si+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B24F                 </span><span style="color:navy">or      cl, </span><span style="color:green">80h
</span><span style="color:maroon">DOSCODE:B252                 </span><span style="color:navy">mov     di, cx
</span><span style="color:maroon">DOSCODE:B254                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">DOSCODE:B256                 </span><span style="color:navy">dec     cl
</span><span style="color:maroon">DOSCODE:B258                 </span><span style="color:navy">mov     al, bh
</span><span style="color:maroon">DOSCODE:B25A                 </span><span style="color:navy">xor     bh, bh
</span><span style="color:maroon">DOSCODE:B25C                 </span><span style="color:navy">call    </span>GetVisDrv
<span style="color:maroon">DOSCODE:B25F                 </span><span style="color:navy">jnb     short </span>Exec_BL
<span style="color:maroon">DOSCODE:B261                 </span><span style="color:navy">mov     bh, cl
</span><span style="color:maroon">DOSCODE:B263
DOSCODE:B263 </span>Exec_BL<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B263                 </span><span style="color:navy">mov     al, bl
</span><span style="color:maroon">DOSCODE:B265                 </span><span style="color:navy">xor     bl, bl
</span><span style="color:maroon">DOSCODE:B267                 </span><span style="color:navy">call    </span>GetVisDrv
<span style="color:maroon">DOSCODE:B26A                 </span><span style="color:navy">jnb     short </span>Exec_Set_Return
<span style="color:maroon">DOSCODE:B26C                 </span><span style="color:navy">mov     bl, cl
</span><span style="color:maroon">DOSCODE:B26E
DOSCODE:B26E </span>Exec_Set_Return<span style="color:navy">:                        </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B26E                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:B271                 </span><span style="color:navy">lds     ax, [si+</span><span style="color:#ff8000">12h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B274                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:B275                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:B276                 </span><span style="color:navy">mov     es:</span><span style="color:green">0Ah</span><span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:B27A                 </span><span style="color:navy">mov     word ptr es:</span><span style="color:green">0Ch</span><span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:B27F                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">DOSCODE:B281                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">DOSCODE:B283                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:B283                 </span><span style="color:navy">pop     </span>UNPACK_OFFSET<span style="color:navy">+</span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:B287                 </span><span style="color:navy">pop     word_8A
</span><span style="color:maroon">DOSCODE:B28B                 </span><span style="color:navy">mov     word ptr ss:</span>DMAADD<span style="color:navy">, </span><span style="color:#ff8000">80h
</span><span style="color:maroon">DOSCODE:B292                 </span><span style="color:navy">mov     ds, ss:</span>CurrentPDB
<span style="color:maroon">DOSCODE:B297                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:B297                 </span><span style="color:navy">mov     word ptr ss:</span>DMAADD<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:B29C                 </span><span style="color:navy">test    byte ptr [bp-</span><span style="color:green">5</span><span style="color:navy">], </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:B2A0                 </span><span style="color:navy">jz      short </span>exec_go
<span style="color:maroon">DOSCODE:B2A2                 </span><span style="color:navy">lds     si, ss:</span>exec_init_SP
<span style="color:maroon">DOSCODE:B2A7                 </span><span style="color:navy">les     di, [bp-</span><span style="color:green">4</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B2AA                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">10h</span><span style="color:navy">], ds
</span><span style="color:maroon">DOSCODE:B2AE                 </span><span style="color:navy">dec     si
</span><span style="color:maroon">DOSCODE:B2AF                 </span><span style="color:navy">dec     si
</span><span style="color:maroon">DOSCODE:B2B0                 </span><span style="color:navy">mov     [si], bx
</span><span style="color:maroon">DOSCODE:B2B2                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], si
</span><span style="color:maroon">DOSCODE:B2B6                 </span><span style="color:navy">lds     ax, ss:</span>exec_init_IP
<span style="color:maroon">DOSCODE:B2BB                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">14h</span><span style="color:navy">], ds
</span><span style="color:maroon">DOSCODE:B2BF                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">12h</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:B2C3                 </span><span style="color:navy">mov     sp, bp
</span><span style="color:maroon">DOSCODE:B2C5                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSCODE:B2C6                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:B2C9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B2C9
DOSCODE:B2C9 </span>exec_go<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B2C9                 </span><span style="color:navy">lds     si, ss:</span>exec_init_IP
<span style="color:maroon">DOSCODE:B2CE                 </span><span style="color:navy">les     di, ss:</span>exec_init_SP
<span style="color:maroon">DOSCODE:B2D3                 </span><span style="color:navy">mov     ax, es
</span><span style="color:maroon">DOSCODE:B2D5                 </span><span style="color:navy">cmp     ss:</span>DosHasHMA<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:B2DB                 </span><span style="color:navy">jz      short </span>Xfer_To_User
<span style="color:maroon">DOSCODE:B2DD                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:B2DE                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:maroon">DOSCODE:B2E3                 </span><span style="color:navy">or      ds:</span>DOS_FLAG<span style="color:navy">, </span><span style="color:green">4
</span><span style="color:maroon">DOSCODE:B2E8                 </span><span style="color:navy">mov     ds:</span>A20OFF_PSP<span style="color:navy">, dx
</span><span style="color:maroon">DOSCODE:B2EC                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:maroon">DOSCODE:B2EE                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:B2EF                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:B2F0                 </span><span style="color:navy">mov     ax, offset </span>disa20_xfer
<span style="color:maroon">DOSCODE:B2F3                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:B2F4                 </span><span style="color:navy">mov     ax, es
</span><span style="color:maroon">DOSCODE:B2F6                 </span><span style="color:navy">retf
</span><span style="color:maroon">DOSCODE:B2F7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B2F7
DOSCODE:B2F7 </span>Xfer_To_User<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B2F7                 </span><span style="color:navy">cli
</span><span style="color:maroon">DOSCODE:B2F8                 </span><span style="color:navy">mov     ss:</span>INDOS<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:B2FE                 </span><span style="color:navy">mov     ss:</span>INDOS_FLAG<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:B304                 </span><span style="color:navy">mov     ss, ax
</span><span style="color:maroon">DOSCODE:B306                 </span><span style="color:navy">mov     sp, di
</span><span style="color:maroon">DOSCODE:B308                 </span><span style="color:navy">sti
</span><span style="color:maroon">DOSCODE:B309                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:B30A                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:B30B                 </span><span style="color:navy">mov     es, dx
</span><span style="color:maroon">DOSCODE:B30D                 </span><span style="color:navy">mov     ds, dx
</span><span style="color:maroon">DOSCODE:B30F                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:maroon">DOSCODE:B311                 </span><span style="color:navy">retf
</span><span style="color:black">DOSCODE:B312
DOSCODE:B312 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B312
DOSCODE:B312
DOSCODE:B312 </span>ExecRead        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B312                 </span><span style="color:navy">call    </span>Exec_Dealloc
<span style="color:black">DOSCODE:B315                 </span><span style="color:navy">mov     bx, [bp-</span><span style="color:green">8</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:B318                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:B319                 </span><span style="color:navy">call    </span>$READ
<span style="color:black">DOSCODE:B31C                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:B31D                 </span><span style="color:navy">call    </span>Exec_Alloc
<span style="color:black">DOSCODE:B320                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B320 </span>ExecRead        <span style="color:black">endp
DOSCODE:B320
DOSCODE:B321
DOSCODE:B321 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B321
DOSCODE:B321
DOSCODE:B321 </span>Exec_Dealloc    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B321                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:B322                 </span><span style="color:navy">sub     bx, bx
</span><span style="color:black">DOSCODE:B324                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:B327                 </span><span style="color:navy">call    sub_B33A
</span><span style="color:black">DOSCODE:B32A                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:B32B                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B32B </span>Exec_Dealloc    <span style="color:black">endp
DOSCODE:B32B
DOSCODE:B32C
DOSCODE:B32C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B32C
DOSCODE:B32C
DOSCODE:B32C </span>Exec_Alloc      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B32C                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:B32D                 </span><span style="color:navy">mov     bx, ss:</span><span style="color:green">330h
</span><span style="color:black">DOSCODE:B332                 </span><span style="color:navy">call    sub_B33A
</span><span style="color:black">DOSCODE:B335                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:B338                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:B339                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B339 </span>Exec_Alloc      <span style="color:black">endp
DOSCODE:B339
DOSCODE:B33A
DOSCODE:B33A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B33A
DOSCODE:B33A
DOSCODE:B33A </span><span style="color:navy">sub_B33A        </span><span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B33A                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:B33B                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:B33C                 </span><span style="color:navy">mov     ax, [bp-</span><span style="color:green">0Eh</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:B33F                 </span><span style="color:navy">call    sub_B34B
</span><span style="color:black">DOSCODE:B342                 </span><span style="color:navy">mov     ax, [bp-</span><span style="color:green">12h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:B345                 </span><span style="color:navy">call    sub_B34B
</span><span style="color:black">DOSCODE:B348                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:B349                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:B34A
DOSCODE:B34A </span><span style="color:navy">locret_B34A:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B34A                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B34A </span><span style="color:navy">sub_B33A        </span><span style="color:black">endp
DOSCODE:B34A
DOSCODE:B34B
DOSCODE:B34B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B34B
DOSCODE:B34B
DOSCODE:B34B </span><span style="color:navy">sub_B34B        </span><span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B34B                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:B34D                 </span><span style="color:navy">jz      short locret_B34A
</span><span style="color:black">DOSCODE:B34F                 </span><span style="color:navy">dec     ax
</span><span style="color:black">DOSCODE:B350                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:B351                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">DOSCODE:B353                 </span><span style="color:navy">mov     ds:</span><span style="color:green">1</span><span style="color:navy">, bx
</span><span style="color:black">DOSCODE:B357                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:B358                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B358 </span><span style="color:navy">sub_B34B        </span><span style="color:black">endp
DOSCODE:B358
DOSCODE:B359
DOSCODE:B359 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B359
DOSCODE:B359
DOSCODE:B359 </span><span style="color:navy">sub_B359        </span><span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B359                 </span><span style="color:navy">lds     si, [bp-</span><span style="color:green">1Ah</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:B359 </span><span style="color:navy">sub_B359        </span><span style="color:black">endp
DOSCODE:B359
DOSCODE:B35C
DOSCODE:B35C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B35C
DOSCODE:B35C
DOSCODE:B35C </span><span style="color:navy">sub_B35C        </span><span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B35C                 </span><span style="color:navy">mov     cx, si
</span><span style="color:black">DOSCODE:B35E
DOSCODE:B35E </span><span style="color:navy">loc_B35E:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B35E                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:B35F                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3Ah </span><span style="color:gray">; &#039;:&#039;
</span><span style="color:black">DOSCODE:B361                 </span><span style="color:navy">jz      short sub_B35C
</span><span style="color:black">DOSCODE:B363                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5Ch </span><span style="color:gray">; &#039;\&#039;
</span><span style="color:black">DOSCODE:B365                 </span><span style="color:navy">jz      short sub_B35C
</span><span style="color:black">DOSCODE:B367                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:B369                 </span><span style="color:navy">jnz     short loc_B35E
</span><span style="color:black">DOSCODE:B36B                 </span><span style="color:navy">sub     si, cx
</span><span style="color:black">DOSCODE:B36D                 </span><span style="color:navy">xchg    si, cx
</span><span style="color:black">DOSCODE:B36F                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B36F </span><span style="color:navy">sub_B35C        </span><span style="color:black">endp
DOSCODE:B36F
DOSCODE:B370
DOSCODE:B370 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B370
DOSCODE:B370
DOSCODE:B370 </span><span style="color:navy">sub_B370        </span><span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B370                 </span><span style="color:navy">dec     cx
</span><span style="color:black">DOSCODE:B371                 </span><span style="color:navy">mov     word ptr ss:</span><span style="color:green">0EBBh</span><span style="color:navy">, </span><span style="color:#ff8000">0A07h
</span><span style="color:black">DOSCODE:B378                 </span><span style="color:navy">les     di, ss:</span><span style="color:green">5Dh
</span><span style="color:black">DOSCODE:B37D                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">DOSCODE:B37F                 </span><span style="color:navy">or      ax, di
</span><span style="color:black">DOSCODE:B381                 </span><span style="color:navy">jz      short locret_B3AA
</span><span style="color:black">DOSCODE:B383
DOSCODE:B383 </span><span style="color:navy">loc_B383:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B383                 </span><span style="color:navy">mov     al, es:[di]
</span><span style="color:black">DOSCODE:B386                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:B388                 </span><span style="color:navy">jz      short locret_B3AA
</span><span style="color:black">DOSCODE:B38A                 </span><span style="color:navy">mov     ss:</span><span style="color:green">60Eh</span><span style="color:navy">, di
</span><span style="color:black">DOSCODE:B38F                 </span><span style="color:navy">cmp     al, cl
</span><span style="color:black">DOSCODE:B391                 </span><span style="color:navy">jnz     short loc_B3AE
</span><span style="color:black">DOSCODE:B393                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:B394                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:B395                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:B396                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:B397
DOSCODE:B397 </span><span style="color:navy">loc_B397:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B397                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:B398                 </span><span style="color:navy">call    </span>UCase
<span style="color:black">DOSCODE:B39B                 </span><span style="color:navy">scasb
</span><span style="color:black">DOSCODE:B39C                 </span><span style="color:navy">jnz     short loc_B3AB
</span><span style="color:black">DOSCODE:B39E                 </span><span style="color:navy">loop    loc_B397
</span><span style="color:black">DOSCODE:B3A0                 </span><span style="color:navy">mov     ax, es:[di]
</span><span style="color:black">DOSCODE:B3A3                 </span><span style="color:navy">mov     ss:</span><span style="color:green">0EBBh</span><span style="color:navy">, ax
</span><span style="color:black">DOSCODE:B3A7                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:B3A8                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:B3A9                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:B3AA
DOSCODE:B3AA </span><span style="color:navy">locret_B3AA:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B3AA                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B3AB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B3AB
DOSCODE:B3AB </span><span style="color:navy">loc_B3AB:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B3AB                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:B3AC                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:B3AD                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:B3AE
DOSCODE:B3AE </span><span style="color:navy">loc_B3AE:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B3AE                 </span><span style="color:navy">mov     di, ss:</span><span style="color:green">60Eh
</span><span style="color:black">DOSCODE:B3B3                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:B3B5                 </span><span style="color:navy">add     di, ax
</span><span style="color:black">DOSCODE:B3B7                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:B3BA                 </span><span style="color:navy">jmp     short loc_B383
</span><span style="color:black">DOSCODE:B3BA </span><span style="color:navy">sub_B370        </span><span style="color:black">endp
DOSCODE:B3BA
</span><span style="color:maroon">DOSCODE:B3BC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B3BC
DOSCODE:B3BC </span>$KEEP_PROCESS<span style="color:navy">:                          </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:B3BC                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:B3BD                 </span><span style="color:navy">mov     byte ptr ss:</span>EXIT_TYPE<span style="color:navy">, </span><span style="color:#ff8000">3
</span><span style="color:maroon">DOSCODE:B3C3                 </span><span style="color:navy">mov     es, ss:</span>CurrentPDB
<span style="color:maroon">DOSCODE:B3C8                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">6
</span><span style="color:maroon">DOSCODE:B3CB                 </span><span style="color:navy">jnb     short </span>Keep_Shrink
<span style="color:maroon">DOSCODE:B3CD                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">6
</span><span style="color:maroon">DOSCODE:B3D0
DOSCODE:B3D0 </span>Keep_Shrink<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B3D0                 </span><span style="color:navy">mov     bx, dx
</span><span style="color:maroon">DOSCODE:B3D2                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:B3D3                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:B3D4                 </span><span style="color:navy">call    </span>$SETBLOCK
<span style="color:maroon">DOSCODE:B3D7                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:B3D8                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:B3D9                 </span><span style="color:navy">jb      short </span>Keep_Done
<span style="color:maroon">DOSCODE:B3DB                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:maroon">DOSCODE:B3DD                 </span><span style="color:navy">add     ax, bx
</span><span style="color:maroon">DOSCODE:B3DF                 </span><span style="color:navy">mov     ds:</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:B3E2
DOSCODE:B3E2 </span>Keep_Done<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B3E2                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:B3E3                 </span><span style="color:navy">jmp     short </span>exit_inner
<span style="color:maroon">DOSCODE:B3E5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B3E5
DOSCODE:B3E5 </span>stay_resident<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B3E5                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3100h
</span><span style="color:maroon">DOSCODE:B3E8                 </span><span style="color:navy">add     dx, </span><span style="color:#ff8000">0Fh
</span><span style="color:maroon">DOSCODE:B3EB                 </span><span style="color:navy">rcr     dx, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:B3ED                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">3
</span><span style="color:maroon">DOSCODE:B3EF                 </span><span style="color:navy">shr     dx, cl
</span><span style="color:maroon">DOSCODE:B3F1                 </span><span style="color:navy">jmp     </span>COMMAND
<span style="color:maroon">DOSCODE:B3F4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B3F4
DOSCODE:B3F4 </span>$EXIT<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:B3F4                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:maroon">DOSCODE:B3F6                 </span><span style="color:navy">xchg    ah, ss:</span>DidCTRLC
<span style="color:maroon">DOSCODE:B3FB                 </span><span style="color:navy">or      ah, ah
</span><span style="color:maroon">DOSCODE:B3FD                 </span><span style="color:navy">mov     byte ptr ss:</span>EXIT_TYPE<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:B403                 </span><span style="color:navy">jz      short </span>exit_inner
<span style="color:maroon">DOSCODE:B405                 </span><span style="color:navy">mov     byte ptr ss:</span>EXIT_TYPE<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:B40B </span><span style="color:gray">; START OF FUNCTION CHUNK FOR FATALC
</span><span style="color:black">DOSCODE:B40B
DOSCODE:B40B </span>exit_inner<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B40B                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:black">DOSCODE:B40E                 </span><span style="color:navy">push    ss:</span>CurrentPDB
<span style="color:black">DOSCODE:B413                 </span><span style="color:navy">pop     word ptr [si+</span><span style="color:#ff8000">14h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:B416                 </span><span style="color:navy">jmp     short </span><span style="color:gray">abort_inner
</span><span style="color:black">DOSCODE:B416 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR FATALC
</span><span style="color:maroon">DOSCODE:B418 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B418
DOSCODE:B418 </span>$ABORT<span style="color:navy">:                                 </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:B418                 </span><span style="color:navy">xor     al, al
</span><span style="color:maroon">DOSCODE:B41A                 </span><span style="color:navy">mov     byte ptr ss:</span><span style="color:green">57Ch</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:B420 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR FATALC
</span><span style="color:black">DOSCODE:B420
DOSCODE:B420 </span><span style="color:gray">abort_inner</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B420                 </span><span style="color:navy">mov     ah, ss:</span><span style="color:green">57Ch
</span><span style="color:black">DOSCODE:B425                 </span><span style="color:navy">mov     ss:</span><span style="color:green">334h</span><span style="color:navy">, ax
</span><span style="color:black">DOSCODE:B429                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:black">DOSCODE:B42C                 </span><span style="color:navy">mov     ds, word ptr [si+</span><span style="color:#ff8000">14h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:B42F                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:B431                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">DOSCODE:B433                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:B433                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">0Ah
</span><span style="color:black">DOSCODE:B436                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">88h
</span><span style="color:black">DOSCODE:B439                 </span><span style="color:navy">movsw
</span><span style="color:black">DOSCODE:B43A                 </span><span style="color:navy">movsw
</span><span style="color:black">DOSCODE:B43B                 </span><span style="color:navy">movsw
</span><span style="color:black">DOSCODE:B43C                 </span><span style="color:navy">movsw
</span><span style="color:black">DOSCODE:B43D                 </span><span style="color:navy">movsw
</span><span style="color:black">DOSCODE:B43E                 </span><span style="color:navy">movsw
</span><span style="color:black">DOSCODE:B43F                 </span><span style="color:navy">jmp     </span><span style="color:gray">reset_environment
</span><span style="color:black">DOSCODE:B43F </span><span style="color:gray">; END OF FUNCTION CHUNK FOR FATALC
</span><span style="color:maroon">DOSCODE:B442 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B442
DOSCODE:B442 </span>RetExePatch<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:B442                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B443
DOSCODE:B443 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B443
DOSCODE:B443
DOSCODE:B443 </span><span style="color:navy">sub_B443        </span><span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B443                 </span><span style="color:navy">test    byte ptr ss:</span><span style="color:green">89h</span><span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:B449                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B449 </span><span style="color:navy">sub_B443        </span><span style="color:black">endp
DOSCODE:B449
DOSCODE:B44A
DOSCODE:B44A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B44A
DOSCODE:B44A
DOSCODE:B44A </span>arena_free_process <span style="color:black">proc near            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B44A                 </span><span style="color:navy">mov     ax, ss:</span>arena_head
<span style="color:black">DOSCODE:B44E
DOSCODE:B44E </span><span style="color:navy">loc_B44E:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B44E                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:B451                 </span><span style="color:navy">call    </span>check_signature
<span style="color:black">DOSCODE:B454
DOSCODE:B454 </span><span style="color:navy">loc_B454:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B454                 </span><span style="color:navy">jb      short </span>check_signature_ok
<span style="color:black">DOSCODE:B456                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:B457                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:B458                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:B458                 </span><span style="color:navy">cmp     word ptr byte_0+</span><span style="color:green">1</span><span style="color:navy">, bx
</span><span style="color:black">DOSCODE:B45C                 </span><span style="color:navy">jnz     short loc_B462
</span><span style="color:black">DOSCODE:B45E                 </span><span style="color:navy">mov     word ptr byte_0+</span><span style="color:green">1</span><span style="color:navy">, di
</span><span style="color:black">DOSCODE:B462
DOSCODE:B462 </span><span style="color:navy">loc_B462:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B462                 </span><span style="color:navy">cmp     byte ptr [di], </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;
</span><span style="color:black">DOSCODE:B465                 </span><span style="color:navy">jz      short loc_B46C
</span><span style="color:black">DOSCODE:B467                 </span><span style="color:navy">call    sub_B47C
</span><span style="color:black">DOSCODE:B46A                 </span><span style="color:navy">jmp     short loc_B454
</span><span style="color:black">DOSCODE:B46C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B46C
DOSCODE:B46C </span><span style="color:navy">loc_B46C:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B46C                 </span><span style="color:navy">mov     ax, ss:</span><span style="color:green">8Ch
</span><span style="color:black">DOSCODE:B470                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:B473                 </span><span style="color:navy">jz      short </span>check_signature_ok
<span style="color:black">DOSCODE:B475                 </span><span style="color:navy">mov     di, ds
</span><span style="color:black">DOSCODE:B477                 </span><span style="color:navy">cmp     di, ax
</span><span style="color:black">DOSCODE:B479                 </span><span style="color:navy">jb      short loc_B44E
</span><span style="color:black">DOSCODE:B47B                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B47B </span>arena_free_process <span style="color:black">endp
DOSCODE:B47B
DOSCODE:B47C
DOSCODE:B47C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B47C
DOSCODE:B47C
DOSCODE:B47C </span><span style="color:navy">sub_B47C        </span><span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B47C                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:black">DOSCODE:B47E                 </span><span style="color:navy">add     ax, word ptr byte_0+</span><span style="color:green">3
</span><span style="color:black">DOSCODE:B482                 </span><span style="color:navy">inc     ax
</span><span style="color:black">DOSCODE:B482 </span><span style="color:navy">sub_B47C        </span><span style="color:black">endp
DOSCODE:B482
DOSCODE:B483
DOSCODE:B483 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B483
DOSCODE:B483
DOSCODE:B483 </span>check_signature <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B483                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">DOSCODE:B485                 </span>assume es:nothing
<span style="color:black">DOSCODE:B485                 </span><span style="color:navy">cmp     byte ptr es:[di], </span><span style="color:#ff8000">4Dh </span><span style="color:gray">; &#039;M&#039;
</span><span style="color:black">DOSCODE:B489                 </span><span style="color:navy">jz      short </span>check_signature_ok
<span style="color:black">DOSCODE:B48B                 </span><span style="color:navy">cmp     byte ptr es:[di], </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;
</span><span style="color:black">DOSCODE:B48F                 </span><span style="color:navy">jz      short </span>check_signature_ok
<span style="color:black">DOSCODE:B491                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:B492
DOSCODE:B492 </span>check_signature_ok<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B492                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B492 </span>check_signature <span style="color:black">endp
DOSCODE:B492
DOSCODE:B493
DOSCODE:B493 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B493
DOSCODE:B493
DOSCODE:B493 </span><span style="color:navy">sub_B493        </span><span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B493                 </span><span style="color:navy">cmp     byte ptr [di], </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;
</span><span style="color:black">DOSCODE:B496                 </span><span style="color:navy">jz      short </span>check_signature_ok
<span style="color:black">DOSCODE:B498                 </span><span style="color:navy">call    sub_B47C
</span><span style="color:black">DOSCODE:B49B                 </span><span style="color:navy">jb      short </span>check_signature_ok
<span style="color:black">DOSCODE:B49D                 </span><span style="color:navy">cmp     es:</span><span style="color:green">1</span><span style="color:navy">, di
</span><span style="color:black">DOSCODE:B4A2                 </span><span style="color:navy">jnz     short </span>check_signature_ok
<span style="color:black">DOSCODE:B4A4                 </span><span style="color:navy">mov     cx, es:</span><span style="color:green">3
</span><span style="color:black">DOSCODE:B4A9                 </span><span style="color:navy">inc     cx
</span><span style="color:black">DOSCODE:B4AA                 </span><span style="color:navy">add     word ptr byte_0+</span><span style="color:green">3</span><span style="color:navy">, cx
</span><span style="color:black">DOSCODE:B4AE                 </span><span style="color:navy">mov     cl, es:[di]
</span><span style="color:black">DOSCODE:B4B1                 </span><span style="color:navy">mov     [di], cl
</span><span style="color:black">DOSCODE:B4B3                 </span><span style="color:navy">jmp     short sub_B493
</span><span style="color:black">DOSCODE:B4B3 </span><span style="color:navy">sub_B493        </span><span style="color:black">endp
DOSCODE:B4B3
DOSCODE:B4B5
DOSCODE:B4B5 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B4B5
DOSCODE:B4B5
DOSCODE:B4B5 </span>$ALLOC          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B4B5
DOSCODE:B4B5 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:B52B SIZE 00000024 BYTES
</span><span style="color:black">DOSCODE:B4B5 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:B54F SIZE 0000000E BYTES
</span><span style="color:black">DOSCODE:B4B5 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:B55D SIZE 00000076 BYTES
</span><span style="color:black">DOSCODE:B4B5 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:B5D3 SIZE 0000003A BYTES
</span><span style="color:black">DOSCODE:B4B5
DOSCODE:B4B5                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:B4B8                 </span><span style="color:navy">mov     ax, ss:</span>arena_head
<span style="color:black">DOSCODE:B4BC                 </span><span style="color:navy">test    ss:</span>AllocMethod<span style="color:navy">, </span><span style="color:green">0C0h
</span><span style="color:black">DOSCODE:B4C2                 </span><span style="color:navy">mov     ss:</span>START_ARENA<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:B4C6                 </span><span style="color:navy">jz      short loc_B4D5
</span><span style="color:black">DOSCODE:B4C8                 </span><span style="color:navy">call    sub_B443
</span><span style="color:black">DOSCODE:B4CB                 </span><span style="color:navy">jz      short loc_B4D5
</span><span style="color:black">DOSCODE:B4CD                 </span><span style="color:navy">mov     ax, ss:</span>UMB_HEAD
<span style="color:black">DOSCODE:B4D1                 </span><span style="color:navy">mov     ss:</span>START_ARENA<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:B4D5
DOSCODE:B4D5 </span><span style="color:navy">loc_B4D5:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B4D5                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:B4D7                 </span><span style="color:navy">mov     di, ax
</span><span style="color:black">DOSCODE:B4D9                 </span><span style="color:navy">mov     ss:</span>FirstArena<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:B4DD                 </span><span style="color:navy">mov     ss:</span>BestArena<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:B4E1                 </span><span style="color:navy">mov     ss:</span>LastArena<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:B4E5                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:B4E6
DOSCODE:B4E6 </span><span style="color:navy">loc_B4E6:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B4E6                 </span><span style="color:navy">mov     ax, ss:</span>START_ARENA
<span style="color:black">DOSCODE:B4EA                 </span><span style="color:navy">call    </span>check_signature
<span style="color:black">DOSCODE:B4ED                 </span><span style="color:navy">jb      short loc_B522
</span><span style="color:black">DOSCODE:B4EF
DOSCODE:B4EF </span><span style="color:navy">loc_B4EF:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B4EF                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:B4F0                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:B4F1                 </span>assume ds:nothing
<span style="color:black">DOSCODE:B4F1                 </span><span style="color:navy">cmp     ds:</span><span style="color:green">1</span><span style="color:navy">, di
</span><span style="color:black">DOSCODE:B4F5                 </span><span style="color:navy">jz      short loc_B55D
</span><span style="color:black">DOSCODE:B4F7
DOSCODE:B4F7 </span><span style="color:navy">loc_B4F7:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B4F7                 </span><span style="color:navy">call    sub_B443
</span><span style="color:black">DOSCODE:B4FA                 </span><span style="color:navy">jz      short loc_B518
</span><span style="color:black">DOSCODE:B4FC                 </span><span style="color:navy">test    byte ptr ss:</span><span style="color:green">302h</span><span style="color:navy">, </span><span style="color:green">80h
</span><span style="color:black">DOSCODE:B502                 </span><span style="color:navy">jz      short loc_B518
</span><span style="color:black">DOSCODE:B504                 </span><span style="color:navy">mov     ax, ss:</span><span style="color:green">8Eh
</span><span style="color:black">DOSCODE:B508                 </span><span style="color:navy">cmp     ax, ss:</span><span style="color:green">24h
</span><span style="color:black">DOSCODE:B50D                 </span><span style="color:navy">jnz     short loc_B518
</span><span style="color:black">DOSCODE:B50F                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:black">DOSCODE:B511                 </span><span style="color:navy">cmp     ax, ss:</span><span style="color:green">8Ch
</span><span style="color:black">DOSCODE:B516                 </span><span style="color:navy">jmp     short loc_B51B
</span><span style="color:black">DOSCODE:B518 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B518
DOSCODE:B518 </span><span style="color:navy">loc_B518:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B518                 </span><span style="color:navy">cmp     byte ptr [di], </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;
</span><span style="color:black">DOSCODE:B51B
DOSCODE:B51B </span><span style="color:navy">loc_B51B:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B51B                 </span><span style="color:navy">jz      short loc_B52B
</span><span style="color:black">DOSCODE:B51D                 </span><span style="color:navy">call    sub_B47C
</span><span style="color:black">DOSCODE:B520                 </span><span style="color:navy">jnb     short loc_B4EF
</span><span style="color:black">DOSCODE:B522
DOSCODE:B522 </span><span style="color:navy">loc_B522:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B522                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:B522 </span>$ALLOC          <span style="color:black">endp
DOSCODE:B522
DOSCODE:B523 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR $SETBLOCK
</span><span style="color:black">DOSCODE:B523
DOSCODE:B523 </span><span style="color:navy">loc_B523:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B523                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:B526
DOSCODE:B526 </span><span style="color:navy">loc_B526:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B526                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">7
</span><span style="color:black">DOSCODE:B528
DOSCODE:B528 </span><span style="color:navy">loc_B528:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B528                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:black">DOSCODE:B528 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR $SETBLOCK
</span><span style="color:black">DOSCODE:B52B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B52B </span><span style="color:gray">; START OF FUNCTION CHUNK FOR $ALLOC
</span><span style="color:black">DOSCODE:B52B
DOSCODE:B52B </span><span style="color:navy">loc_B52B:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B52B                 </span><span style="color:navy">cmp     word ptr ss:</span><span style="color:green">340h</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:B531                 </span><span style="color:navy">jz      short loc_B536
</span><span style="color:black">DOSCODE:B533                 </span><span style="color:navy">jmp     loc_B5BA
</span><span style="color:black">DOSCODE:B536 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B536
DOSCODE:B536 </span><span style="color:navy">loc_B536:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B536                 </span><span style="color:navy">mov     ax, ss:</span><span style="color:green">24h
</span><span style="color:black">DOSCODE:B53A                 </span><span style="color:navy">cmp     ax, ss:</span><span style="color:green">8Eh
</span><span style="color:black">DOSCODE:B53F                 </span><span style="color:navy">jz      short loc_B54F
</span><span style="color:black">DOSCODE:B541                 </span><span style="color:navy">test    byte ptr ss:</span><span style="color:green">302h</span><span style="color:navy">, </span><span style="color:green">40h
</span><span style="color:black">DOSCODE:B547                 </span><span style="color:navy">jnz     short loc_B54F
</span><span style="color:black">DOSCODE:B549                 </span><span style="color:navy">mov     ss:</span><span style="color:green">8Eh</span><span style="color:navy">, ax
</span><span style="color:black">DOSCODE:B54D                 </span><span style="color:navy">jmp     short loc_B4E6
</span><span style="color:black">DOSCODE:B54D </span><span style="color:gray">; END OF FUNCTION CHUNK FOR $ALLOC
</span><span style="color:black">DOSCODE:B54F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B54F </span><span style="color:gray">; START OF FUNCTION CHUNK FOR $SETBLOCK
</span><span style="color:black">DOSCODE:B54F </span><span style="color:gray">;   ADDITIONAL PARENT FUNCTION $ALLOC
</span><span style="color:black">DOSCODE:B54F
DOSCODE:B54F </span><span style="color:navy">loc_B54F:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B54F                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:black">DOSCODE:B552                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:B553                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], bx
</span><span style="color:black">DOSCODE:B556                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:B559                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">8
</span><span style="color:black">DOSCODE:B55B                 </span><span style="color:navy">jmp     short loc_B528
</span><span style="color:black">DOSCODE:B55B </span><span style="color:gray">; END OF FUNCTION CHUNK FOR $SETBLOCK
</span><span style="color:black">DOSCODE:B55D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B55D </span><span style="color:gray">; START OF FUNCTION CHUNK FOR $ALLOC
</span><span style="color:black">DOSCODE:B55D
DOSCODE:B55D </span><span style="color:navy">loc_B55D:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B55D                 </span><span style="color:navy">call    sub_B493
</span><span style="color:black">DOSCODE:B560                 </span><span style="color:navy">jb      short loc_B522
</span><span style="color:black">DOSCODE:B562                 </span><span style="color:navy">mov     cx, ds:</span><span style="color:green">3
</span><span style="color:black">DOSCODE:B566                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:B567                 </span><span style="color:navy">cmp     cx, dx
</span><span style="color:black">DOSCODE:B569                 </span><span style="color:navy">jbe     short loc_B56D
</span><span style="color:black">DOSCODE:B56B                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:black">DOSCODE:B56D
DOSCODE:B56D </span><span style="color:navy">loc_B56D:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B56D                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:B56E                 </span><span style="color:navy">cmp     bx, cx
</span><span style="color:black">DOSCODE:B570                 </span><span style="color:navy">ja      short loc_B4F7
</span><span style="color:black">DOSCODE:B572                 </span><span style="color:navy">cmp     word ptr ss:</span><span style="color:green">340h</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:B578                 </span><span style="color:navy">jnz     short loc_B57F
</span><span style="color:black">DOSCODE:B57A                 </span><span style="color:navy">mov     word ptr ss:</span><span style="color:green">340h</span><span style="color:navy">, ds
</span><span style="color:black">DOSCODE:B57F
DOSCODE:B57F </span><span style="color:navy">loc_B57F:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B57F                 </span><span style="color:navy">cmp     word ptr ss:</span><span style="color:green">342h</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:B585                 </span><span style="color:navy">jz      short loc_B595
</span><span style="color:black">DOSCODE:B587                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:B588                 </span><span style="color:navy">mov     es, word ptr ss:</span><span style="color:green">342h
</span><span style="color:black">DOSCODE:B58D                 </span><span style="color:navy">cmp     es:</span><span style="color:green">3</span><span style="color:navy">, cx
</span><span style="color:black">DOSCODE:B592                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:B593                 </span><span style="color:navy">jbe     short loc_B59A
</span><span style="color:black">DOSCODE:B595
DOSCODE:B595 </span><span style="color:navy">loc_B595:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B595                 </span><span style="color:navy">mov     word ptr ss:</span><span style="color:green">342h</span><span style="color:navy">, ds
</span><span style="color:black">DOSCODE:B59A
DOSCODE:B59A </span><span style="color:navy">loc_B59A:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B59A                 </span><span style="color:navy">mov     word ptr ss:</span><span style="color:green">344h</span><span style="color:navy">, ds
</span><span style="color:black">DOSCODE:B59F                 </span><span style="color:navy">jmp     loc_B4F7
</span><span style="color:black">DOSCODE:B5A2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B5A2
DOSCODE:B5A2 </span><span style="color:navy">loc_B5A2:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B5A2                 </span><span style="color:navy">mov     ds, word ptr ss:</span><span style="color:green">344h
</span><span style="color:black">DOSCODE:B5A7                 </span><span style="color:navy">mov     cx, ds:</span><span style="color:green">3
</span><span style="color:black">DOSCODE:B5AB                 </span><span style="color:navy">sub     cx, bx
</span><span style="color:black">DOSCODE:B5AD                 </span><span style="color:navy">mov     dx, ds
</span><span style="color:black">DOSCODE:B5AF                 </span><span style="color:navy">jz      short loc_B5FA
</span><span style="color:black">DOSCODE:B5B1                 </span><span style="color:navy">add     dx, cx
</span><span style="color:black">DOSCODE:B5B3                 </span><span style="color:navy">mov     es, dx
</span><span style="color:black">DOSCODE:B5B5                 </span><span style="color:navy">dec     cx
</span><span style="color:black">DOSCODE:B5B6                 </span><span style="color:navy">xchg    bx, cx
</span><span style="color:black">DOSCODE:B5B8                 </span><span style="color:navy">jmp     short loc_B5E5
</span><span style="color:black">DOSCODE:B5BA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B5BA
DOSCODE:B5BA </span><span style="color:navy">loc_B5BA:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B5BA                 </span><span style="color:navy">mov     cl, ss:</span><span style="color:green">302h
</span><span style="color:black">DOSCODE:B5BF                 </span><span style="color:navy">and     cl, </span><span style="color:green">3Fh
</span><span style="color:black">DOSCODE:B5C2                 </span><span style="color:navy">cmp     cl, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:B5C5                 </span><span style="color:navy">ja      short loc_B5A2
</span><span style="color:black">DOSCODE:B5C7                 </span><span style="color:navy">mov     ds, word ptr ss:</span><span style="color:green">340h
</span><span style="color:black">DOSCODE:B5CC                 </span><span style="color:navy">jb      short loc_B5D3
</span><span style="color:black">DOSCODE:B5CE                 </span><span style="color:navy">mov     ds, word ptr ss:</span><span style="color:green">342h
</span><span style="color:black">DOSCODE:B5CE </span><span style="color:gray">; END OF FUNCTION CHUNK FOR $ALLOC
</span><span style="color:black">DOSCODE:B5D3 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR $SETBLOCK
</span><span style="color:black">DOSCODE:B5D3 </span><span style="color:gray">;   ADDITIONAL PARENT FUNCTION $ALLOC
</span><span style="color:black">DOSCODE:B5D3
DOSCODE:B5D3 </span><span style="color:navy">loc_B5D3:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B5D3                 </span><span style="color:navy">mov     cx, ds:</span><span style="color:green">3
</span><span style="color:black">DOSCODE:B5D7                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:black">DOSCODE:B5D9                 </span><span style="color:navy">sub     cx, bx
</span><span style="color:black">DOSCODE:B5DB                 </span><span style="color:navy">mov     dx, ax
</span><span style="color:black">DOSCODE:B5DD                 </span><span style="color:navy">jz      short loc_B5FA
</span><span style="color:black">DOSCODE:B5DF                 </span><span style="color:navy">add     ax, bx
</span><span style="color:black">DOSCODE:B5E1                 </span><span style="color:navy">inc     ax
</span><span style="color:black">DOSCODE:B5E2                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">DOSCODE:B5E4                 </span><span style="color:navy">dec     cx
</span><span style="color:black">DOSCODE:B5E5
DOSCODE:B5E5 </span><span style="color:navy">loc_B5E5:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B5E5                 </span><span style="color:navy">mov     ds:</span><span style="color:green">3</span><span style="color:navy">, bx
</span><span style="color:black">DOSCODE:B5E9                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">4Dh </span><span style="color:gray">; &#039;M&#039;
</span><span style="color:black">DOSCODE:B5EB                 </span><span style="color:navy">mov     es:</span><span style="color:green">3</span><span style="color:navy">, cx
</span><span style="color:black">DOSCODE:B5F0                 </span><span style="color:navy">xchg    bl, [di]
</span><span style="color:black">DOSCODE:B5F2                 </span><span style="color:navy">mov     es:</span><span style="color:green">1</span><span style="color:navy">, di
</span><span style="color:black">DOSCODE:B5F7                 </span><span style="color:navy">mov     es:[di], bl
</span><span style="color:black">DOSCODE:B5FA
DOSCODE:B5FA </span><span style="color:navy">loc_B5FA:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B5FA                 </span><span style="color:navy">mov     ds, dx
</span><span style="color:black">DOSCODE:B5FC                 </span><span style="color:navy">mov     ax, ss:</span><span style="color:green">330h
</span><span style="color:black">DOSCODE:B600                 </span><span style="color:navy">mov     ds:</span><span style="color:green">1</span><span style="color:navy">, ax
</span><span style="color:black">DOSCODE:B603                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:black">DOSCODE:B605                 </span><span style="color:navy">inc     ax
</span><span style="color:black">DOSCODE:B606                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:B607                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:B60A
DOSCODE:B60A </span><span style="color:navy">loc_B60A:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B60A                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:black">DOSCODE:B60A </span><span style="color:gray">; END OF FUNCTION CHUNK FOR $SETBLOCK
</span><span style="color:black">DOSCODE:B60D
DOSCODE:B60D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B60D
DOSCODE:B60D
DOSCODE:B60D </span>$SETBLOCK       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B60D
DOSCODE:B60D </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:B523 SIZE 00000008 BYTES
</span><span style="color:black">DOSCODE:B60D </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:B54F SIZE 0000000E BYTES
</span><span style="color:black">DOSCODE:B60D </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:B5D3 SIZE 0000003A BYTES
</span><span style="color:black">DOSCODE:B60D
DOSCODE:B60D                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:B610                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:B613                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">DOSCODE:B615                 </span><span style="color:navy">dec     ax
</span><span style="color:black">DOSCODE:B616                 </span><span style="color:navy">call    </span>check_signature
<span style="color:black">DOSCODE:B619                 </span><span style="color:navy">jnb     short loc_B61E
</span><span style="color:black">DOSCODE:B61B
DOSCODE:B61B </span><span style="color:navy">loc_B61B:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B61B                 </span><span style="color:navy">jmp     loc_B523
</span><span style="color:black">DOSCODE:B61E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B61E
DOSCODE:B61E </span><span style="color:navy">loc_B61E:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B61E                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">DOSCODE:B620                 </span><span style="color:navy">call    sub_B493
</span><span style="color:black">DOSCODE:B623                 </span><span style="color:navy">jb      short loc_B61B
</span><span style="color:black">DOSCODE:B625                 </span><span style="color:navy">mov     cx, ds:</span><span style="color:green">3
</span><span style="color:black">DOSCODE:B629                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:B62A                 </span><span style="color:navy">cmp     bx, cx
</span><span style="color:black">DOSCODE:B62C                 </span><span style="color:navy">jbe     short loc_B5D3
</span><span style="color:black">DOSCODE:B62E                 </span><span style="color:navy">jmp     loc_B54F
</span><span style="color:black">DOSCODE:B62E </span>$SETBLOCK       <span style="color:black">endp
DOSCODE:B62E
DOSCODE:B631
DOSCODE:B631 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B631
DOSCODE:B631
DOSCODE:B631 </span>$DEALLOC        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B631                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:B634                 </span><span style="color:navy">test    ss:</span>DOS_FLAG<span style="color:navy">, </span><span style="color:green">4
</span><span style="color:black">DOSCODE:B63A                 </span><span style="color:navy">jz      short loc_B649
</span><span style="color:black">DOSCODE:B63C                 </span><span style="color:navy">cmp     ss:</span>A20OFF_COUNT<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:B642                 </span><span style="color:navy">jnz     short loc_B649
</span><span style="color:black">DOSCODE:B644                 </span><span style="color:navy">inc     ss:</span>A20OFF_COUNT
<span style="color:black">DOSCODE:B649
DOSCODE:B649 </span><span style="color:navy">loc_B649:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B649                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:B64C                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">DOSCODE:B64E                 </span><span style="color:navy">dec     ax
</span><span style="color:black">DOSCODE:B64F                 </span><span style="color:navy">call    </span>check_signature
<span style="color:black">DOSCODE:B652                 </span><span style="color:navy">jb      short loc_B65E
</span><span style="color:black">DOSCODE:B654                 </span><span style="color:navy">mov     es:</span><span style="color:green">1</span><span style="color:navy">, di
</span><span style="color:black">DOSCODE:B659                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:B65C
DOSCODE:B65C </span><span style="color:navy">loc_B65C:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B65C                 </span><span style="color:navy">jmp     short loc_B60A
</span><span style="color:black">DOSCODE:B65E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B65E
DOSCODE:B65E </span><span style="color:navy">loc_B65E:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B65E                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:B661                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">9
</span><span style="color:black">DOSCODE:B663
DOSCODE:B663 </span><span style="color:navy">loc_B663:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B663                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:black">DOSCODE:B663 </span>$DEALLOC        <span style="color:black">endp
DOSCODE:B663
</span><span style="color:maroon">DOSCODE:B666 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B666
DOSCODE:B666 </span>$ALLOCOPER<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:B666                 </span><span style="color:navy">or      al, al
</span><span style="color:maroon">DOSCODE:B668                 </span><span style="color:navy">jz      short loc_B67D
</span><span style="color:maroon">DOSCODE:B66A                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:B66C                 </span><span style="color:navy">jz      short loc_B685
</span><span style="color:maroon">DOSCODE:B66E                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2
</span><span style="color:maroon">DOSCODE:B670                 </span><span style="color:navy">jz      short loc_B696
</span><span style="color:maroon">DOSCODE:B672                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">3
</span><span style="color:maroon">DOSCODE:B674                 </span><span style="color:navy">jz      short loc_B69E
</span><span style="color:maroon">DOSCODE:B676
DOSCODE:B676 </span><span style="color:navy">loc_B676:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B676                 </span><span style="color:navy">call    </span>set_exerr_locus_mem
<span style="color:maroon">DOSCODE:B679                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:B67B                 </span><span style="color:navy">jmp     short loc_B663
</span><span style="color:maroon">DOSCODE:B67D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B67D
DOSCODE:B67D </span><span style="color:navy">loc_B67D:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B67D                 </span><span style="color:navy">mov     al, ss:</span>AllocMethod
<span style="color:maroon">DOSCODE:B681                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:maroon">DOSCODE:B683
DOSCODE:B683 </span><span style="color:navy">loc_B683:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B683                 </span><span style="color:navy">jmp     short loc_B65C
</span><span style="color:maroon">DOSCODE:B685 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B685
DOSCODE:B685 </span><span style="color:navy">loc_B685:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B685                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:B686                 </span><span style="color:navy">and     bl, </span><span style="color:green">3Fh
</span><span style="color:maroon">DOSCODE:B689                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">2
</span><span style="color:maroon">DOSCODE:B68C                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:B68D                 </span><span style="color:navy">ja      short loc_B676
</span><span style="color:maroon">DOSCODE:B68F                 </span><span style="color:navy">mov     ss:</span><span style="color:green">302h</span><span style="color:navy">, bl
</span><span style="color:maroon">DOSCODE:B694                 </span><span style="color:navy">jmp     short loc_B683
</span><span style="color:maroon">DOSCODE:B696 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B696
DOSCODE:B696 </span><span style="color:navy">loc_B696:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B696                 </span><span style="color:navy">mov     al, ss:</span><span style="color:green">89h
</span><span style="color:maroon">DOSCODE:B69A                 </span><span style="color:navy">and     al, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:B69C                 </span><span style="color:navy">jmp     short loc_B683
</span><span style="color:maroon">DOSCODE:B69E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B69E
DOSCODE:B69E </span><span style="color:navy">loc_B69E:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B69E                 </span><span style="color:navy">mov     cx, ss:</span><span style="color:green">8Ch
</span><span style="color:maroon">DOSCODE:B6A3                 </span><span style="color:navy">inc     cx
</span><span style="color:maroon">DOSCODE:B6A4                 </span><span style="color:navy">jz      short loc_B676
</span><span style="color:maroon">DOSCODE:B6A6                 </span><span style="color:navy">dec     cx
</span><span style="color:maroon">DOSCODE:B6A7                 </span><span style="color:navy">dec     bx
</span><span style="color:maroon">DOSCODE:B6A8                 </span><span style="color:navy">jz      short loc_B6C4
</span><span style="color:maroon">DOSCODE:B6AA                 </span><span style="color:navy">inc     bx
</span><span style="color:maroon">DOSCODE:B6AB                 </span><span style="color:navy">jz      short loc_B6AF
</span><span style="color:maroon">DOSCODE:B6AD                 </span><span style="color:navy">jmp     short loc_B676
</span><span style="color:maroon">DOSCODE:B6AF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B6AF
DOSCODE:B6AF </span><span style="color:navy">loc_B6AF:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B6AF                 </span><span style="color:navy">call    sub_B443
</span><span style="color:maroon">DOSCODE:B6B2                 </span><span style="color:navy">jz      short loc_B6C2
</span><span style="color:maroon">DOSCODE:B6B4                 </span><span style="color:navy">call    sub_B6D9
</span><span style="color:maroon">DOSCODE:B6B7                 </span><span style="color:navy">mov     byte ptr ds:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;
</span><span style="color:maroon">DOSCODE:B6BC                 </span><span style="color:navy">and     byte ptr ss:</span><span style="color:green">89h</span><span style="color:navy">, </span><span style="color:green">0FEh
</span><span style="color:maroon">DOSCODE:B6C2
DOSCODE:B6C2 </span><span style="color:navy">loc_B6C2:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B6C2                 </span><span style="color:navy">jmp     short loc_B683
</span><span style="color:maroon">DOSCODE:B6C4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B6C4
DOSCODE:B6C4 </span><span style="color:navy">loc_B6C4:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B6C4                 </span><span style="color:navy">call    sub_B443
</span><span style="color:maroon">DOSCODE:B6C7                 </span><span style="color:navy">jnz     short loc_B6D7
</span><span style="color:maroon">DOSCODE:B6C9                 </span><span style="color:navy">call    sub_B6D9
</span><span style="color:maroon">DOSCODE:B6CC                 </span><span style="color:navy">mov     byte ptr ds:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">4Dh </span><span style="color:gray">; &#039;M&#039;
</span><span style="color:maroon">DOSCODE:B6D1                 </span><span style="color:navy">or      byte ptr ss:</span><span style="color:green">89h</span><span style="color:navy">, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:B6D7
DOSCODE:B6D7 </span><span style="color:navy">loc_B6D7:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B6D7                 </span><span style="color:navy">jmp     short loc_B683
</span><span style="color:black">DOSCODE:B6D9
DOSCODE:B6D9 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B6D9
DOSCODE:B6D9
DOSCODE:B6D9 </span><span style="color:navy">sub_B6D9        </span><span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B6D9                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:B6DA                 </span><span style="color:navy">mov     ax, ss:</span><span style="color:green">24h
</span><span style="color:black">DOSCODE:B6DE                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">DOSCODE:B6E0                 </span><span style="color:navy">xor     di, di
</span><span style="color:black">DOSCODE:B6E2                 </span><span style="color:navy">cmp     byte ptr es:[di], </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;
</span><span style="color:black">DOSCODE:B6E6                 </span><span style="color:navy">jz      short loc_B6FE
</span><span style="color:black">DOSCODE:B6E8
DOSCODE:B6E8 </span><span style="color:navy">loc_B6E8:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B6E8                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">DOSCODE:B6EA                 </span><span style="color:navy">call    sub_B47C
</span><span style="color:black">DOSCODE:B6ED                 </span><span style="color:navy">jb      short loc_B711
</span><span style="color:black">DOSCODE:B6EF                 </span><span style="color:navy">call    sub_B443
</span><span style="color:black">DOSCODE:B6F2                 </span><span style="color:navy">jnz     short loc_B6FA
</span><span style="color:black">DOSCODE:B6F4                 </span><span style="color:navy">cmp     byte ptr es:[di], </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039;
</span><span style="color:black">DOSCODE:B6F8                 </span><span style="color:navy">jmp     short loc_B6FC
</span><span style="color:black">DOSCODE:B6FA </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B6FA
DOSCODE:B6FA </span><span style="color:navy">loc_B6FA:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B6FA                 </span><span style="color:navy">cmp     ax, cx
</span><span style="color:black">DOSCODE:B6FC
DOSCODE:B6FC </span><span style="color:navy">loc_B6FC:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B6FC                 </span><span style="color:navy">jnz     short loc_B6E8
</span><span style="color:black">DOSCODE:B6FE
DOSCODE:B6FE </span><span style="color:navy">loc_B6FE:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B6FE                 </span><span style="color:navy">call    sub_B443
</span><span style="color:black">DOSCODE:B701                 </span><span style="color:navy">jnz     short loc_B70E
</span><span style="color:black">DOSCODE:B703                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">DOSCODE:B705                 </span><span style="color:navy">call    sub_B47C
</span><span style="color:black">DOSCODE:B708                 </span><span style="color:navy">jb      short loc_B711
</span><span style="color:black">DOSCODE:B70A                 </span><span style="color:navy">cmp     ax, cx
</span><span style="color:black">DOSCODE:B70C                 </span><span style="color:navy">jnz     short loc_B711
</span><span style="color:black">DOSCODE:B70E
DOSCODE:B70E </span><span style="color:navy">loc_B70E:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B70E                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:B70F                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:B710                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B711 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B711
DOSCODE:B711 </span><span style="color:navy">loc_B711:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B711                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:B712                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:B713                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:B714                 </span><span style="color:navy">call    </span>set_exerr_locus_mem
<span style="color:black">DOSCODE:B717                 </span><span style="color:navy">jmp     loc_B526
</span><span style="color:black">DOSCODE:B717 </span><span style="color:navy">sub_B6D9        </span><span style="color:black">endp
DOSCODE:B717
DOSCODE:B717 </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSCODE:B71A </span><span style="color:navy">word_B71A       dw </span><span style="color:#008040">0B71Eh               </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:B71C </span><span style="color:navy">word_B71C       dw </span><span style="color:#008040">0B76Dh               </span><span style="color:#8080ff">; ...
</span><span style="color:olive">DOSCODE:B71E                 </span><span style="color:navy">db  </span><span style="color:#008040">0Bh
</span><span style="color:olive">DOSCODE:B71F                 </span><span style="color:navy">db </span><span style="color:#008040">0D4h
</span><span style="color:olive">DOSCODE:B720                 </span><span style="color:navy">db </span><span style="color:#008040">0B7h
</span><span style="color:olive">DOSCODE:B721                 </span><span style="color:navy">db  </span><span style="color:#008040">6Eh </span><span style="color:gray">; n
</span><span style="color:olive">DOSCODE:B722                 </span><span style="color:navy">db </span><span style="color:#008040">0B7h
</span><span style="color:olive">DOSCODE:B723                 </span><span style="color:navy">db </span><span style="color:#008040">0A5h
</span><span style="color:olive">DOSCODE:B724                 </span><span style="color:navy">db </span><span style="color:#008040">0B7h
</span><span style="color:olive">DOSCODE:B725                 </span><span style="color:navy">db </span><span style="color:#008040">0AEh
</span><span style="color:olive">DOSCODE:B726                 </span><span style="color:navy">db </span><span style="color:#008040">0B7h
</span><span style="color:olive">DOSCODE:B727                 </span><span style="color:navy">db </span><span style="color:#008040">0B5h
</span><span style="color:olive">DOSCODE:B728                 </span><span style="color:navy">db </span><span style="color:#008040">0B7h
</span><span style="color:olive">DOSCODE:B729                 </span><span style="color:navy">db </span><span style="color:#008040">0BCh
</span><span style="color:olive">DOSCODE:B72A                 </span><span style="color:navy">db </span><span style="color:#008040">0B7h
</span><span style="color:olive">DOSCODE:B72B                 </span><span style="color:navy">db  </span><span style="color:#008040">15h
</span><span style="color:olive">DOSCODE:B72C                 </span><span style="color:navy">db </span><span style="color:#008040">0B8h
</span><span style="color:olive">DOSCODE:B72D                 </span><span style="color:navy">db  </span><span style="color:#008040">39h </span><span style="color:gray">; 9
</span><span style="color:olive">DOSCODE:B72E                 </span><span style="color:navy">db </span><span style="color:#008040">0B8h
</span><span style="color:olive">DOSCODE:B72F                 </span><span style="color:navy">db  </span><span style="color:#008040">39h </span><span style="color:gray">; 9
</span><span style="color:olive">DOSCODE:B730                 </span><span style="color:navy">db </span><span style="color:#008040">0B8h
</span><span style="color:olive">DOSCODE:B731                 </span><span style="color:navy">db  </span><span style="color:#008040">39h </span><span style="color:gray">; 9
</span><span style="color:olive">DOSCODE:B732                 </span><span style="color:navy">db </span><span style="color:#008040">0B8h
</span><span style="color:olive">DOSCODE:B733                 </span><span style="color:navy">db  </span><span style="color:#008040">45h </span><span style="color:gray">; E
</span><span style="color:olive">DOSCODE:B734                 </span><span style="color:navy">db </span><span style="color:#008040">0B8h
</span><span style="color:maroon">DOSCODE:B735 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B735
DOSCODE:B735 </span>$ServerCall<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:B735                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">7
</span><span style="color:maroon">DOSCODE:B737                 </span><span style="color:navy">jb      short loc_B73D
</span><span style="color:maroon">DOSCODE:B739                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">9
</span><span style="color:maroon">DOSCODE:B73B                 </span><span style="color:navy">jbe     short loc_B757
</span><span style="color:maroon">DOSCODE:B73D
DOSCODE:B73D </span><span style="color:navy">loc_B73D:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B73D                 </span><span style="color:navy">mov     si, dx
</span><span style="color:maroon">DOSCODE:B73F                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">12h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B742                 </span><span style="color:navy">test    ss:</span>IsWin386<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:B748                 </span><span style="color:navy">jnz     short loc_B74F
</span><span style="color:maroon">DOSCODE:B74A                 </span><span style="color:navy">mov     ss:</span>USER_ID<span style="color:navy">, bx
</span><span style="color:maroon">DOSCODE:B74F
DOSCODE:B74F </span><span style="color:navy">loc_B74F:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B74F                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">14h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B752                 </span><span style="color:navy">mov     ss:</span>PROC_ID<span style="color:navy">, bx
</span><span style="color:maroon">DOSCODE:B757
DOSCODE:B757 </span><span style="color:navy">loc_B757:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B757                 </span><span style="color:navy">push    cs:word_B71C
</span><span style="color:maroon">DOSCODE:B75C                 </span><span style="color:navy">push    cs:word_B71A
</span><span style="color:maroon">DOSCODE:B761                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:B762                 </span><span style="color:navy">call    </span>TableDispatch
<span style="color:maroon">DOSCODE:B765                 </span><span style="color:navy">call    </span>set_exerr_locus_unk
<span style="color:maroon">DOSCODE:B768                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:B76A
DOSCODE:B76A </span><span style="color:navy">loc_B76A:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B76A                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:maroon">DOSCODE:B76D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B76D                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:B76E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B76E                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:maroon">DOSCODE:B770                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:B771                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:B772                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:maroon">DOSCODE:B775
DOSCODE:B775 </span><span style="color:navy">loc_B775:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B775                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:B776                 </span><span style="color:navy">call    </span>SFFromSFN
<span style="color:maroon">DOSCODE:B779                 </span><span style="color:navy">jb      short loc_B79E
</span><span style="color:maroon">DOSCODE:B77B                 </span><span style="color:navy">cmp     word ptr es:[di], </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:B77F                 </span><span style="color:navy">jz      short loc_B79A
</span><span style="color:maroon">DOSCODE:B781                 </span><span style="color:navy">cmp     word ptr es:[di], </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:B785                 </span><span style="color:navy">jz      short loc_B79A
</span><span style="color:maroon">DOSCODE:B787                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">8000h
</span><span style="color:maroon">DOSCODE:B78D                 </span><span style="color:navy">jnz     short loc_B79A
</span><span style="color:maroon">DOSCODE:B78F                 </span><span style="color:navy">mov     word ptr ds:</span>THISSFT<span style="color:navy">, di
</span><span style="color:maroon">DOSCODE:B793                 </span><span style="color:navy">mov     word ptr ds:</span>THISSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:maroon">DOSCODE:B797                 </span><span style="color:navy">call    </span>DOS_COMMIT
<span style="color:maroon">DOSCODE:B79A
DOSCODE:B79A </span><span style="color:navy">loc_B79A:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B79A                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:B79B                 </span><span style="color:navy">inc     bx
</span><span style="color:maroon">DOSCODE:B79C                 </span><span style="color:navy">jmp     short loc_B775
</span><span style="color:maroon">DOSCODE:B79E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B79E
DOSCODE:B79E </span><span style="color:navy">loc_B79E:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B79E                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:maroon">DOSCODE:B7A1                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:B7A2
DOSCODE:B7A2 </span><span style="color:navy">loc_B7A2:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B7A2                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:B7A5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B7A5                 </span><span style="color:navy">call    dword ptr ss:</span><span style="color:green">0A4h
</span><span style="color:maroon">DOSCODE:B7AA
DOSCODE:B7AA </span><span style="color:navy">loc_B7AA:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B7AA                 </span><span style="color:navy">jnb     short loc_B7A2
</span><span style="color:maroon">DOSCODE:B7AC
DOSCODE:B7AC </span><span style="color:navy">loc_B7AC:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B7AC                 </span><span style="color:navy">jmp     short loc_B76A
</span><span style="color:maroon">DOSCODE:B7AE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B7AE                 </span><span style="color:navy">call    dword ptr ss:</span><span style="color:green">9Ch
</span><span style="color:maroon">DOSCODE:B7B3                 </span><span style="color:navy">jmp     short loc_B7AA
</span><span style="color:maroon">DOSCODE:B7B5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B7B5                 </span><span style="color:navy">call    dword ptr ss:</span><span style="color:green">0A0h
</span><span style="color:maroon">DOSCODE:B7BA                 </span><span style="color:navy">jmp     short loc_B7AA
</span><span style="color:maroon">DOSCODE:B7BC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B7BC                 </span><span style="color:navy">call    dword ptr ss:</span><span style="color:green">0B4h
</span><span style="color:maroon">DOSCODE:B7C1                 </span><span style="color:navy">jb      short loc_B7AC
</span><span style="color:maroon">DOSCODE:B7C3                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:B7C6                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], bx
</span><span style="color:maroon">DOSCODE:B7C9                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">], di
</span><span style="color:maroon">DOSCODE:B7CC                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">10h</span><span style="color:navy">], es
</span><span style="color:maroon">DOSCODE:B7CF
DOSCODE:B7CF </span><span style="color:navy">loc_B7CF:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B7CF                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], cx
</span><span style="color:maroon">DOSCODE:B7D2
DOSCODE:B7D2 </span><span style="color:navy">loc_B7D2:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B7D2                 </span><span style="color:navy">jmp     short loc_B7A2
</span><span style="color:maroon">DOSCODE:B7D4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B7D4                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:B7D5                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:B7D6                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:B7D7                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:B7DA                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:B7DB                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:B7DC                 </span><span style="color:navy">call    </span>XCHGP
<span style="color:maroon">DOSCODE:B7DF                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:B7E0                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">6
</span><span style="color:maroon">DOSCODE:B7E3                 </span><span style="color:navy">rep movsw
</span><span style="color:maroon">DOSCODE:B7E5                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">DOSCODE:B7E6                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">DOSCODE:B7E7                 </span><span style="color:navy">movsw
</span><span style="color:maroon">DOSCODE:B7E8                 </span><span style="color:navy">movsw
</span><span style="color:maroon">DOSCODE:B7E9                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:B7EA                 </span><span style="color:navy">mov     ax, [si]
</span><span style="color:maroon">DOSCODE:B7EC                 </span><span style="color:navy">mov     bx, [si+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B7EF                 </span><span style="color:navy">mov     cx, [si+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B7F2                 </span><span style="color:navy">mov     dx, [si+</span><span style="color:#ff8000">6</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B7F5                 </span><span style="color:navy">mov     di, [si+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B7F8                 </span><span style="color:navy">mov     es, word ptr [si+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B7FB                 </span><span style="color:navy">push    word ptr [si+</span><span style="color:#ff8000">8</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B7FE                 </span><span style="color:navy">mov     ds, word ptr [si+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B801                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:B802                 </span><span style="color:navy">mov     ss:</span>SAVEDS<span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:B807                 </span><span style="color:navy">mov     ss:</span>SAVEBX<span style="color:navy">, bx
</span><span style="color:maroon">DOSCODE:B80C                 </span><span style="color:navy">mov     ss:</span>FSHARING<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:B812                 </span><span style="color:navy">jmp     </span>REDISP
<span style="color:maroon">DOSCODE:B815 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B815                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:B816                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:B817                 </span><span style="color:navy">mov     di, offset </span>ERRORMODE
<span style="color:maroon">DOSCODE:B81A                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">0AFAh
</span><span style="color:maroon">DOSCODE:B81D                 </span><span style="color:navy">mov     dx, offset </span>USER_IN_AX
<span style="color:maroon">DOSCODE:B820                 </span><span style="color:navy">sub     cx, di
</span><span style="color:maroon">DOSCODE:B822                 </span><span style="color:navy">sub     dx, di
</span><span style="color:maroon">DOSCODE:B824                 </span><span style="color:navy">shr     cx, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:B826                 </span><span style="color:navy">adc     cx, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:B829                 </span><span style="color:navy">add     cx, cx
</span><span style="color:maroon">DOSCODE:B82B                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:B82E                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], es
</span><span style="color:maroon">DOSCODE:B831                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">8</span><span style="color:navy">], di
</span><span style="color:maroon">DOSCODE:B834                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], dx
</span><span style="color:maroon">DOSCODE:B837                 </span><span style="color:navy">jmp     short loc_B7CF
</span><span style="color:maroon">DOSCODE:B839 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B839                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:B83A                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1125h
</span><span style="color:maroon">DOSCODE:B83D                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - REDIRECTED PRINTER MODE
<span style="color:maroon">DOSCODE:B83D                                         </span>; STACK: WORD subfunction
<span style="color:maroon">DOSCODE:B83D                                         </span>; Return: CF set on error, AX = error code
<span style="color:maroon">DOSCODE:B83D                                         </span>; STACK unchanged
<span style="color:maroon">DOSCODE:B83F                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:B840                 </span><span style="color:navy">jnb     short loc_B7D2
</span><span style="color:maroon">DOSCODE:B842                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:maroon">DOSCODE:B845 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B845                 </span><span style="color:navy">mov     ax, [si]
</span><span style="color:maroon">DOSCODE:B847                 </span><span style="color:navy">mov     ss:</span>EXTERR<span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:B84B                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B84E                 </span><span style="color:navy">mov     word ptr ss:</span>EXTERRPT<span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:B852                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B855                 </span><span style="color:navy">mov     word ptr ss:</span>EXTERRPT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:B859                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B85C                 </span><span style="color:navy">mov     word ptr ss:</span>EXTERR_ACTION<span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:B860                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:B863                 </span><span style="color:navy">mov     ss:</span>EXTERR_LOCUS<span style="color:navy">, ah
</span><span style="color:maroon">DOSCODE:B868                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B869
DOSCODE:B869 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B869
DOSCODE:B869
DOSCODE:B869 </span>pJFNFromHandle  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B869                 </span><span style="color:navy">mov     es, cs:</span>DosDSeg
<span style="color:black">DOSCODE:B86E                 </span><span style="color:navy">mov     es, es:</span>CurrentPDB
<span style="color:black">DOSCODE:B873                 </span><span style="color:navy">cmp     bx, es:</span><span style="color:green">32h
</span><span style="color:black">DOSCODE:B878                 </span><span style="color:navy">jnb     short loc_B882
</span><span style="color:black">DOSCODE:B87A                 </span><span style="color:navy">les     di, es:</span><span style="color:green">34h
</span><span style="color:black">DOSCODE:B87F                 </span><span style="color:navy">add     di, bx
</span><span style="color:black">DOSCODE:B881                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B882 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B882
DOSCODE:B882 </span><span style="color:navy">loc_B882:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B882                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:B884
DOSCODE:B884 </span><span style="color:navy">loc_B884:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B884                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:B885
DOSCODE:B885 </span><span style="color:navy">locret_B885:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B885                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B885 </span>pJFNFromHandle  <span style="color:black">endp
DOSCODE:B885
DOSCODE:B886
DOSCODE:B886 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B886
DOSCODE:B886
DOSCODE:B886 </span>SFFromHandle    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B886                 </span><span style="color:navy">call    </span>pJFNFromHandle
<span style="color:black">DOSCODE:B889                 </span><span style="color:navy">jb      short locret_B885
</span><span style="color:black">DOSCODE:B88B                 </span><span style="color:navy">cmp     byte ptr es:[di], </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:B88F                 </span><span style="color:navy">jz      short loc_B89C
</span><span style="color:black">DOSCODE:B891                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:B892                 </span><span style="color:navy">mov     bl, es:[di]
</span><span style="color:black">DOSCODE:B895                 </span><span style="color:navy">xor     bh, bh
</span><span style="color:black">DOSCODE:B897                 </span><span style="color:navy">call    </span>SFFromSFN
<span style="color:black">DOSCODE:B89A                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:B89B                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B89C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B89C
DOSCODE:B89C </span><span style="color:navy">loc_B89C:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B89C                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:B89E                 </span><span style="color:navy">jmp     short loc_B884
</span><span style="color:black">DOSCODE:B89E </span>SFFromHandle    <span style="color:black">endp
DOSCODE:B89E
DOSCODE:B8A0
DOSCODE:B8A0 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B8A0
DOSCODE:B8A0
DOSCODE:B8A0 </span>SFFromSFN       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B8A0                 </span><span style="color:navy">mov     es, cs:</span>DosDSeg
<span style="color:black">DOSCODE:B8A5                 </span><span style="color:navy">les     di, es:</span><span style="color:green">2Ah
</span><span style="color:black">DOSCODE:B8AA
DOSCODE:B8AA </span><span style="color:navy">loc_B8AA:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B8AA                 </span><span style="color:navy">cmp     bx, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:B8AE                 </span><span style="color:navy">jb      short loc_B8BE
</span><span style="color:black">DOSCODE:B8B0                 </span><span style="color:navy">sub     bx, es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:B8B4                 </span><span style="color:navy">les     di, es:[di]
</span><span style="color:black">DOSCODE:B8B7                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:B8BA                 </span><span style="color:navy">jnz     short loc_B8AA
</span><span style="color:black">DOSCODE:B8BC                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:B8BD                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B8BE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B8BE
DOSCODE:B8BE </span><span style="color:navy">loc_B8BE:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B8BE                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:B8BF                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3Bh </span><span style="color:gray">; &#039;;&#039;
</span><span style="color:black">DOSCODE:B8C2                 </span><span style="color:navy">mul     bl
</span><span style="color:black">DOSCODE:B8C4                 </span><span style="color:navy">add     di, ax
</span><span style="color:black">DOSCODE:B8C6                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:B8C7                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:B8CA                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B8CA </span>SFFromSFN       <span style="color:black">endp
DOSCODE:B8CA
DOSCODE:B8CB
DOSCODE:B8CB </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B8CB
DOSCODE:B8CB
DOSCODE:B8CB </span>JFNFree         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B8CB                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:B8CD
DOSCODE:B8CD </span><span style="color:navy">loc_B8CD:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B8CD                 </span><span style="color:navy">call    </span>pJFNFromHandle
<span style="color:black">DOSCODE:B8D0                 </span><span style="color:navy">jb      short loc_B8DB
</span><span style="color:black">DOSCODE:B8D2                 </span><span style="color:navy">cmp     byte ptr es:[di], </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:B8D6                 </span><span style="color:navy">jz      short locret_B8DD
</span><span style="color:black">DOSCODE:B8D8                 </span><span style="color:navy">inc     bx
</span><span style="color:black">DOSCODE:B8D9                 </span><span style="color:navy">jmp     short loc_B8CD
</span><span style="color:black">DOSCODE:B8DB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B8DB
DOSCODE:B8DB </span><span style="color:navy">loc_B8DB:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B8DB                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">4
</span><span style="color:black">DOSCODE:B8DD
DOSCODE:B8DD </span><span style="color:navy">locret_B8DD:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B8DD                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B8DD </span>JFNFree         <span style="color:black">endp
DOSCODE:B8DD
DOSCODE:B8DE
DOSCODE:B8DE </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B8DE
DOSCODE:B8DE
DOSCODE:B8DE </span>SFNFree         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B8DE                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:B8DF                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:B8E1
DOSCODE:B8E1 </span><span style="color:navy">loc_B8E1:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B8E1                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:B8E2                 </span><span style="color:navy">call    </span>SFFromSFN
<span style="color:black">DOSCODE:B8E5                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:B8E6                 </span><span style="color:navy">jb      short loc_B923
</span><span style="color:black">DOSCODE:B8E8                 </span><span style="color:navy">cmp     word ptr es:[di], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:B8EC                 </span><span style="color:navy">jz      short loc_B90B
</span><span style="color:black">DOSCODE:B8EE                 </span><span style="color:navy">cmp     word ptr es:[di], </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:B8F2                 </span><span style="color:navy">jz      short loc_B8F7
</span><span style="color:black">DOSCODE:B8F4
DOSCODE:B8F4 </span><span style="color:navy">loc_B8F4:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B8F4                 </span><span style="color:navy">inc     bx
</span><span style="color:black">DOSCODE:B8F5                 </span><span style="color:navy">jmp     short loc_B8E1
</span><span style="color:black">DOSCODE:B8F7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B8F7
DOSCODE:B8F7 </span><span style="color:navy">loc_B8F7:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B8F7                 </span><span style="color:navy">mov     ax, ss:</span>USER_ID
<span style="color:black">DOSCODE:B8FB                 </span><span style="color:navy">cmp     es:[di+</span><span style="color:#ff8000">2Fh</span><span style="color:navy">], ax
</span><span style="color:black">DOSCODE:B8FF                 </span><span style="color:navy">jnz     short loc_B8F4
</span><span style="color:black">DOSCODE:B901                 </span><span style="color:navy">mov     ax, ss:</span>PROC_ID
<span style="color:black">DOSCODE:B905                 </span><span style="color:navy">cmp     es:[di+</span><span style="color:#ff8000">31h</span><span style="color:navy">], ax
</span><span style="color:black">DOSCODE:B909                 </span><span style="color:navy">jnz     short loc_B8F4
</span><span style="color:black">DOSCODE:B90B
DOSCODE:B90B </span><span style="color:navy">loc_B90B:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B90B                 </span><span style="color:navy">mov     word ptr es:[di], </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:B910                 </span><span style="color:navy">mov     ax, ss:</span>USER_ID
<span style="color:black">DOSCODE:B914                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">2Fh</span><span style="color:navy">], ax
</span><span style="color:black">DOSCODE:B918                 </span><span style="color:navy">mov     ax, ss:</span>PROC_ID
<span style="color:black">DOSCODE:B91C                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">31h</span><span style="color:navy">], ax
</span><span style="color:black">DOSCODE:B920                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:B921                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:B922                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:B923 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B923
DOSCODE:B923 </span><span style="color:navy">loc_B923:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B923                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:B924                 </span><span style="color:navy">jmp     short loc_B8DB
</span><span style="color:black">DOSCODE:B924 </span>SFNFree         <span style="color:black">endp
DOSCODE:B924
DOSCODE:B926
DOSCODE:B926 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:B926
DOSCODE:B926
DOSCODE:B926 </span>$CLOSE          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B926                 </span><span style="color:navy">call    </span>CheckOwner
<span style="color:black">DOSCODE:B929                 </span><span style="color:navy">jb      short </span>CloseError
<span style="color:black">DOSCODE:B92B                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:B92C                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:B92D                 </span><span style="color:navy">mov     word ptr ds:</span>THISSFT<span style="color:navy">, di
</span><span style="color:black">DOSCODE:B931                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">5A0h</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:B935                 </span><span style="color:navy">cmp     word ptr es:[di], </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:B939                 </span><span style="color:navy">jz      short </span><span style="color:gray">FreeJFN
</span><span style="color:black">DOSCODE:B93B                 </span><span style="color:navy">mov     al, es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:B93F                 </span><span style="color:navy">and     al, </span><span style="color:green">0F0h
</span><span style="color:black">DOSCODE:B941                 </span><span style="color:navy">cmp     al, </span><span style="color:green">70h
</span><span style="color:black">DOSCODE:B943                 </span><span style="color:navy">jz      short </span><span style="color:gray">PostFree
</span><span style="color:black">DOSCODE:B945
DOSCODE:B945 </span><span style="color:gray">FreeJFN</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B945                 </span><span style="color:navy">call    </span>pJFNFromHandle
<span style="color:black">DOSCODE:B948                 </span><span style="color:navy">mov     byte ptr es:[di], </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:B94C
DOSCODE:B94C </span><span style="color:gray">PostFree</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B94C                 </span><span style="color:navy">call    </span>DOS_CLOSE
<span style="color:black">DOSCODE:B94F                 </span><span style="color:navy">jb      short </span>CloseError
<span style="color:black">DOSCODE:B951                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">3Eh </span><span style="color:gray">; &#039;&gt;&#039;
</span><span style="color:black">DOSCODE:B953
DOSCODE:B953 </span><span style="color:navy">loc_B953:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B953                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:black">DOSCODE:B956 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B956
DOSCODE:B956 </span>CloseError<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B956                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:black">DOSCODE:B956 </span>$CLOSE          <span style="color:black">endp
DOSCODE:B956
</span><span style="color:maroon">DOSCODE:B959 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B959
DOSCODE:B959 </span>$COMMIT<span style="color:navy">:                                </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:B959                 </span><span style="color:navy">call    </span>CheckOwner
<span style="color:maroon">DOSCODE:B95C                 </span><span style="color:navy">jb      short </span>CommitError
<span style="color:maroon">DOSCODE:B95E                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:B95F                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:B960                 </span><span style="color:navy">mov     word ptr ds:</span>THISSFT<span style="color:navy">, di
</span><span style="color:maroon">DOSCODE:B964                 </span><span style="color:navy">mov     word ptr ds:</span>THISSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:maroon">DOSCODE:B968                 </span><span style="color:navy">call    </span>DOS_COMMIT
<span style="color:maroon">DOSCODE:B96B                 </span><span style="color:navy">jb      short </span>CommitError
<span style="color:maroon">DOSCODE:B96D                 </span><span style="color:navy">mov     ah, </span><span style="color:green">68h
</span><span style="color:maroon">DOSCODE:B96F                 </span><span style="color:navy">jmp     short loc_B953
</span><span style="color:black">DOSCODE:B971 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:B971 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR $READ
</span><span style="color:black">DOSCODE:B971
DOSCODE:B971 </span>CommitError<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B971                 </span><span style="color:navy">jmp     short </span>CloseError
<span style="color:black">DOSCODE:B971 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR $READ
</span><span style="color:maroon">DOSCODE:B973 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B973
DOSCODE:B973 </span>$ExtHandle<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:B973                 </span><span style="color:navy">xor     bp, bp
</span><span style="color:maroon">DOSCODE:B975                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">20
</span><span style="color:maroon">DOSCODE:B978                 </span><span style="color:navy">jnb     short loc_B97D
</span><span style="color:maroon">DOSCODE:B97A                 </span><span style="color:navy">mov     bx, </span><span style="color:green">20
</span><span style="color:maroon">DOSCODE:B97D
DOSCODE:B97D </span><span style="color:navy">loc_B97D:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B97D                 </span><span style="color:navy">mov     es, ss:</span>CurrentPDB
<span style="color:maroon">DOSCODE:B982                 </span><span style="color:navy">mov     cx, word ptr es:</span>BCON
<span style="color:maroon">DOSCODE:B987                 </span><span style="color:navy">cmp     bx, cx
</span><span style="color:maroon">DOSCODE:B989                 </span><span style="color:navy">jz      short loc_B953
</span><span style="color:maroon">DOSCODE:B98B                 </span><span style="color:navy">ja      short loc_B9AB
</span><span style="color:maroon">DOSCODE:B98D                 </span><span style="color:navy">inc     bp
</span><span style="color:maroon">DOSCODE:B98E                 </span><span style="color:navy">mov     ds, es:</span>MAXSEC
<span style="color:maroon">DOSCODE:B993                 </span><span style="color:navy">mov     si, bx
</span><span style="color:maroon">DOSCODE:B995                 </span><span style="color:navy">sub     cx, bx
</span><span style="color:maroon">DOSCODE:B997
DOSCODE:B997 </span><span style="color:navy">loc_B997:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B997                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:B99A                 </span><span style="color:navy">jnz     short loc_B9D5
</span><span style="color:maroon">DOSCODE:B99C                 </span><span style="color:navy">inc     si
</span><span style="color:maroon">DOSCODE:B99D                 </span><span style="color:navy">loop    loc_B997
</span><span style="color:maroon">DOSCODE:B99F                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">14h
</span><span style="color:maroon">DOSCODE:B9A2                 </span><span style="color:navy">ja      short loc_B9AB
</span><span style="color:maroon">DOSCODE:B9A4                 </span><span style="color:navy">inc     bp
</span><span style="color:maroon">DOSCODE:B9A5                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">18h
</span><span style="color:maroon">DOSCODE:B9A8                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:B9A9                 </span><span style="color:navy">jmp     short loc_B9C6
</span><span style="color:maroon">DOSCODE:B9AB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B9AB
DOSCODE:B9AB </span><span style="color:navy">loc_B9AB:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B9AB                 </span><span style="color:navy">inc     bx
</span><span style="color:maroon">DOSCODE:B9AC                 </span><span style="color:navy">jz      short loc_BA2A
</span><span style="color:maroon">DOSCODE:B9AE                 </span><span style="color:navy">dec     bx
</span><span style="color:maroon">DOSCODE:B9AF                 </span><span style="color:navy">clc
</span><span style="color:maroon">DOSCODE:B9B0                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:B9B1                 </span><span style="color:navy">add     bx, </span><span style="color:#ff8000">0Fh
</span><span style="color:maroon">DOSCODE:B9B4                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:B9B6                 </span><span style="color:navy">rcr     bx, cl
</span><span style="color:maroon">DOSCODE:B9B8                 </span><span style="color:navy">and     bh, </span><span style="color:green">1Fh
</span><span style="color:maroon">DOSCODE:B9BB                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">DOSCODE:B9BC                 </span><span style="color:navy">call    </span>$ALLOC
<span style="color:maroon">DOSCODE:B9BF                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSCODE:B9C0                 </span><span style="color:navy">jb      short loc_BA25
</span><span style="color:maroon">DOSCODE:B9C2                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">DOSCODE:B9C4                 </span><span style="color:navy">xor     di, di
</span><span style="color:maroon">DOSCODE:B9C6
DOSCODE:B9C6 </span><span style="color:navy">loc_B9C6:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B9C6                 </span><span style="color:navy">mov     ds, word ptr ss:</span><span style="color:green">330h
</span><span style="color:maroon">DOSCODE:B9CB                 </span><span style="color:navy">test    bp, </span><span style="color:green">3
</span><span style="color:maroon">DOSCODE:B9CF                 </span><span style="color:navy">jz      short loc_B9D9
</span><span style="color:maroon">DOSCODE:B9D1                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:B9D2                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:B9D3                 </span><span style="color:navy">jmp     short loc_B9DD
</span><span style="color:maroon">DOSCODE:B9D5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B9D5
DOSCODE:B9D5 </span><span style="color:navy">loc_B9D5:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B9D5                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">4
</span><span style="color:black">DOSCODE:B9D7 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR $READ
</span><span style="color:black">DOSCODE:B9D7
DOSCODE:B9D7 </span><span style="color:navy">loc_B9D7:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:B9D7                 </span><span style="color:navy">jmp     short </span>CommitError
<span style="color:black">DOSCODE:B9D7 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR $READ
</span><span style="color:maroon">DOSCODE:B9D9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:B9D9
DOSCODE:B9D9 </span><span style="color:navy">loc_B9D9:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B9D9                 </span><span style="color:navy">mov     cx, ds:</span><span style="color:green">32h
</span><span style="color:maroon">DOSCODE:B9DD
DOSCODE:B9DD </span><span style="color:navy">loc_B9DD:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:B9DD                 </span><span style="color:navy">mov     dx, cx
</span><span style="color:maroon">DOSCODE:B9DF                 </span><span style="color:navy">lds     si, ds:</span><span style="color:green">34h
</span><span style="color:maroon">DOSCODE:B9E3                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">DOSCODE:B9E5                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:B9E6                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:B9E7                 </span><span style="color:navy">sub     cx, dx
</span><span style="color:maroon">DOSCODE:B9E9                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:B9EB                 </span><span style="color:navy">rep stosb
</span><span style="color:maroon">DOSCODE:B9ED                 </span><span style="color:navy">mov     ds, word ptr ss:</span><span style="color:green">330h
</span><span style="color:maroon">DOSCODE:B9F2                 </span><span style="color:navy">cmp     word ptr ds:</span><span style="color:green">34h</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:B9F7                 </span><span style="color:navy">jnz     short loc_BA06
</span><span style="color:maroon">DOSCODE:B9F9                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">DOSCODE:B9FA                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:B9FB                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:B9FC                 </span><span style="color:navy">mov     es, word ptr ds:</span><span style="color:green">36h
</span><span style="color:maroon">DOSCODE:BA00                 </span><span style="color:navy">call    </span>$DEALLOC
<span style="color:maroon">DOSCODE:BA03                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:BA04                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:BA05                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSCODE:BA06
DOSCODE:BA06 </span><span style="color:navy">loc_BA06:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BA06                 </span><span style="color:navy">test    bp, </span><span style="color:green">2
</span><span style="color:maroon">DOSCODE:BA0A                 </span><span style="color:navy">jz      short loc_BA14
</span><span style="color:maroon">DOSCODE:BA0C                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">34h</span><span style="color:navy">, </span><span style="color:#ff8000">18h
</span><span style="color:maroon">DOSCODE:BA12                 </span><span style="color:navy">jmp     short loc_BA1A
</span><span style="color:maroon">DOSCODE:BA14 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BA14
DOSCODE:BA14 </span><span style="color:navy">loc_BA14:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BA14                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">34h</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:BA1A
DOSCODE:BA1A </span><span style="color:navy">loc_BA1A:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BA1A                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">36h</span><span style="color:navy">, es
</span><span style="color:maroon">DOSCODE:BA1E                 </span><span style="color:navy">pop     word ptr ds:</span><span style="color:green">32h
</span><span style="color:black">DOSCODE:BA22 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR $READ
</span><span style="color:black">DOSCODE:BA22
DOSCODE:BA22 </span><span style="color:navy">loc_BA22:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BA22                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:black">DOSCODE:BA22 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR $READ
</span><span style="color:maroon">DOSCODE:BA25 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BA25
DOSCODE:BA25 </span><span style="color:navy">loc_BA25:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BA25                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:BA26                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">8
</span><span style="color:maroon">DOSCODE:BA28                 </span><span style="color:navy">jmp     short loc_B9D7
</span><span style="color:maroon">DOSCODE:BA2A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BA2A
DOSCODE:BA2A </span><span style="color:navy">loc_BA2A:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BA2A                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:BA2C </span><span style="color:gray">; START OF FUNCTION CHUNK FOR $READ
</span><span style="color:black">DOSCODE:BA2C
DOSCODE:BA2C </span><span style="color:navy">loc_BA2C:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BA2C                 </span><span style="color:navy">jmp     short loc_B9D7
</span><span style="color:black">DOSCODE:BA2C </span><span style="color:gray">; END OF FUNCTION CHUNK FOR $READ
</span><span style="color:black">DOSCODE:BA2E
DOSCODE:BA2E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:BA2E
DOSCODE:BA2E
DOSCODE:BA2E </span>$READ           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BA2E
DOSCODE:BA2E </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:B971 SIZE 00000002 BYTES
</span><span style="color:black">DOSCODE:BA2E </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:B9D7 SIZE 00000002 BYTES
</span><span style="color:black">DOSCODE:BA2E </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:BA22 SIZE 00000003 BYTES
</span><span style="color:black">DOSCODE:BA2E </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:BA2C SIZE 00000002 BYTES
</span><span style="color:black">DOSCODE:BA2E
DOSCODE:BA2E                 </span><span style="color:navy">mov     si, offset </span>DOS_READ
<span style="color:black">DOSCODE:BA31
DOSCODE:BA31 </span>ReadDO<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BA31                 </span><span style="color:navy">call    </span>pJFNFromHandle
<span style="color:black">DOSCODE:BA34                 </span><span style="color:navy">jb      short loc_BA8A
</span><span style="color:black">DOSCODE:BA36                 </span><span style="color:navy">mov     al, es:[di]
</span><span style="color:black">DOSCODE:BA39                 </span><span style="color:navy">call    </span>CheckOwner
<span style="color:black">DOSCODE:BA3C                 </span><span style="color:navy">jb      short loc_BA8A
</span><span style="color:black">DOSCODE:BA3E                 </span><span style="color:navy">mov     word ptr ss:</span>THISSFT<span style="color:navy">, di
</span><span style="color:black">DOSCODE:BA43                 </span><span style="color:navy">mov     word ptr ss:</span>THISSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:BA48                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3</span><span style="color:navy">], </span><span style="color:green">20h
</span><span style="color:black">DOSCODE:BA4D                 </span><span style="color:navy">jz      short loc_BA55
</span><span style="color:black">DOSCODE:BA4F                 </span><span style="color:navy">or      ss:</span>EXTOPEN_ON<span style="color:navy">, </span><span style="color:green">2
</span><span style="color:black">DOSCODE:BA55
DOSCODE:BA55 </span><span style="color:navy">loc_BA55:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BA55                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:black">DOSCODE:BA57                 </span><span style="color:navy">lds     bx, ss:</span>DMAADD
<span style="color:black">DOSCODE:BA5C                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:BA5D                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:BA5E                 </span><span style="color:navy">mov     bx, dx
</span><span style="color:black">DOSCODE:BA60                 </span><span style="color:navy">shr     bx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:BA62                 </span><span style="color:navy">shr     bx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:BA64                 </span><span style="color:navy">shr     bx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:BA66                 </span><span style="color:navy">shr     bx, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:BA68                 </span><span style="color:navy">add     ax, bx
</span><span style="color:black">DOSCODE:BA6A                 </span><span style="color:navy">and     dx, </span><span style="color:green">0Fh
</span><span style="color:black">DOSCODE:BA6D                 </span><span style="color:navy">mov     word ptr ss:</span>DMAADD<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:BA72                 </span><span style="color:navy">mov     word ptr ss:</span>DMAADD<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ax
</span><span style="color:black">DOSCODE:BA76                 </span><span style="color:navy">mov     ax, ss
</span><span style="color:black">DOSCODE:BA78                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">DOSCODE:BA7A                 </span><span style="color:navy">call    si </span><span style="color:gray">; </span>DOS_READ
<span style="color:black">DOSCODE:BA7C                 </span><span style="color:navy">pop     word ptr ds:</span>DMAADD<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:BA80                 </span><span style="color:navy">pop     word ptr ds:</span>DMAADD
<span style="color:black">DOSCODE:BA84                 </span><span style="color:navy">jb      short loc_BA8A
</span><span style="color:black">DOSCODE:BA86                 </span><span style="color:navy">mov     ax, cx
</span><span style="color:black">DOSCODE:BA88
DOSCODE:BA88 </span><span style="color:navy">loc_BA88:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BA88                 </span><span style="color:navy">jmp     short loc_BA22
</span><span style="color:black">DOSCODE:BA8A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BA8A
DOSCODE:BA8A </span><span style="color:navy">loc_BA8A:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BA8A                 </span><span style="color:navy">jmp     short loc_BA2C
</span><span style="color:black">DOSCODE:BA8A </span>$READ           <span style="color:black">endp
DOSCODE:BA8A
</span><span style="color:maroon">DOSCODE:BA8C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BA8C
DOSCODE:BA8C </span>$WRITE<span style="color:navy">:                                 </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:BA8C                 </span><span style="color:navy">mov     si, offset </span>DOS_WRITE
<span style="color:maroon">DOSCODE:BA8F                 </span><span style="color:navy">jmp     short </span>ReadDO
<span style="color:black">DOSCODE:BA91
DOSCODE:BA91 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:BA91
DOSCODE:BA91
DOSCODE:BA91 </span>$LSEEK          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BA91                 </span><span style="color:navy">call    </span>CheckOwner
<span style="color:black">DOSCODE:BA94
DOSCODE:BA94 </span><span style="color:navy">loc_BA94:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BA94                 </span><span style="color:navy">jb      short loc_BA8A
</span><span style="color:black">DOSCODE:BA96                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:BA98                 </span><span style="color:navy">ja      short loc_BAED
</span><span style="color:black">DOSCODE:BA9A                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:BA9C                 </span><span style="color:navy">jb      short loc_BAA8
</span><span style="color:black">DOSCODE:BA9E                 </span><span style="color:navy">ja      short loc_BABB
</span><span style="color:black">DOSCODE:BAA0                 </span><span style="color:navy">add     dx, es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:BAA4                 </span><span style="color:navy">adc     cx, es:[di+</span><span style="color:#ff8000">17h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:BAA8
DOSCODE:BAA8 </span><span style="color:navy">loc_BAA8:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BAA8                 </span><span style="color:navy">mov     ax, cx
</span><span style="color:black">DOSCODE:BAAA                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:black">DOSCODE:BAAB
DOSCODE:BAAB </span><span style="color:navy">loc_BAAB:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BAAB                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">15h</span><span style="color:navy">], ax
</span><span style="color:black">DOSCODE:BAAF                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">17h</span><span style="color:navy">], dx
</span><span style="color:black">DOSCODE:BAB3                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:black">DOSCODE:BAB6                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], dx
</span><span style="color:black">DOSCODE:BAB9                 </span><span style="color:navy">jmp     short loc_BA88
</span><span style="color:black">DOSCODE:BABB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BABB
DOSCODE:BABB </span><span style="color:navy">loc_BABB:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BABB                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:green">80h
</span><span style="color:black">DOSCODE:BAC0                 </span><span style="color:navy">jnz     short loc_BACC
</span><span style="color:black">DOSCODE:BAC2
DOSCODE:BAC2 </span><span style="color:navy">loc_BAC2:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BAC2                 </span><span style="color:navy">add     dx, es:[di+</span><span style="color:#ff8000">11h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:BAC6                 </span><span style="color:navy">adc     cx, es:[di+</span><span style="color:#ff8000">13h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:BACA                 </span><span style="color:navy">jmp     short loc_BAA8
</span><span style="color:black">DOSCODE:BACC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BACC
DOSCODE:BACC </span><span style="color:navy">loc_BACC:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BACC                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">3</span><span style="color:navy">], </span><span style="color:green">80h
</span><span style="color:black">DOSCODE:BAD1                 </span><span style="color:navy">jnz     short loc_BAC2
</span><span style="color:black">DOSCODE:BAD3                 </span><span style="color:navy">mov     ax, es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:BAD7                 </span><span style="color:navy">and     ax, </span><span style="color:green">0F0h
</span><span style="color:black">DOSCODE:BADA                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">40h </span><span style="color:gray">; &#039;@&#039;
</span><span style="color:black">DOSCODE:BADD                 </span><span style="color:navy">jz      short loc_BAE4
</span><span style="color:black">DOSCODE:BADF                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;
</span><span style="color:black">DOSCODE:BAE2                 </span><span style="color:navy">jnz     short loc_BAC2
</span><span style="color:black">DOSCODE:BAE4
DOSCODE:BAE4 </span><span style="color:navy">loc_BAE4:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BAE4                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1121h
</span><span style="color:black">DOSCODE:BAE7                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - SEEK FROM END OF REMOTE FILE
<span style="color:black">DOSCODE:BAE7                                         </span>; CX:DX = offset (in bytes) from end
<span style="color:black">DOSCODE:BAE7                                         </span>; ES:DI -&gt; SFT, SFT DPB field -&gt; DPB of drive with file
<span style="color:black">DOSCODE:BAE7                                         </span>; SS = DOS CS
<span style="color:black">DOSCODE:BAE7                                         </span>; Return: CF set on error
<span style="color:black">DOSCODE:BAE7                                         </span>; CF clear if successful, DX:AX = new file position
<span style="color:black">DOSCODE:BAE9                 </span><span style="color:navy">jnb     short loc_BAAB
</span><span style="color:black">DOSCODE:BAEB
DOSCODE:BAEB </span><span style="color:navy">loc_BAEB:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BAEB                 </span><span style="color:navy">jmp     short loc_BA8A
</span><span style="color:black">DOSCODE:BAED </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BAED
DOSCODE:BAED </span><span style="color:navy">loc_BAED:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BAED                 </span><span style="color:navy">call    </span>set_exerr_locus_unk
<span style="color:black">DOSCODE:BAF0                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:BAF2
DOSCODE:BAF2 </span><span style="color:navy">loc_BAF2:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BAF2                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:black">DOSCODE:BAF2 </span>$LSEEK          <span style="color:black">endp
DOSCODE:BAF2
</span><span style="color:maroon">DOSCODE:BAF5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BAF5
DOSCODE:BAF5 </span>$FILE_TIMES<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:BAF5                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">7
</span><span style="color:maroon">DOSCODE:BAF7                 </span><span style="color:navy">jnb     short loc_BAED
</span><span style="color:maroon">DOSCODE:BAF9                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:BAFB                 </span><span style="color:navy">jnb     short loc_BB01
</span><span style="color:maroon">DOSCODE:BAFD                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2
</span><span style="color:maroon">DOSCODE:BAFF                 </span><span style="color:navy">jnb     short loc_BAED
</span><span style="color:maroon">DOSCODE:BB01
DOSCODE:BB01 </span><span style="color:navy">loc_BB01:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BB01                 </span><span style="color:navy">call    </span>CheckOwner
<span style="color:maroon">DOSCODE:BB04                 </span><span style="color:navy">jb      short loc_BA94
</span><span style="color:maroon">DOSCODE:BB06                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:BB08                 </span><span style="color:navy">ja      short loc_BB42
</span><span style="color:maroon">DOSCODE:BB0A                 </span><span style="color:navy">or      al, al
</span><span style="color:maroon">DOSCODE:BB0C                 </span><span style="color:navy">jnz     short </span>ft_set_time
<span style="color:maroon">DOSCODE:BB0E                 </span><span style="color:navy">lds     cx, es:[di+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:BB12                 </span><span style="color:navy">mov     dx, ds
</span><span style="color:maroon">DOSCODE:BB14                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:BB17                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], cx
</span><span style="color:maroon">DOSCODE:BB1A                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], dx
</span><span style="color:maroon">DOSCODE:BB1D                 </span><span style="color:navy">jmp     short loc_BB3F
</span><span style="color:maroon">DOSCODE:BB1F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BB1F
DOSCODE:BB1F </span>ft_set_time<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BB1F                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:maroon">DOSCODE:BB22                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">], cx
</span><span style="color:maroon">DOSCODE:BB26                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], dx
</span><span style="color:maroon">DOSCODE:BB2A                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">DOSCODE:BB2C                 </span><span style="color:navy">call    dword ptr ss:</span><span style="color:green">0C8h
</span><span style="color:maroon">DOSCODE:BB31                 </span><span style="color:navy">and     word ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">0FFBFh
</span><span style="color:maroon">DOSCODE:BB36                 </span><span style="color:navy">or      word ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">4000h
</span><span style="color:maroon">DOSCODE:BB3C                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:maroon">DOSCODE:BB3F
DOSCODE:BB3F </span><span style="color:navy">loc_BB3F:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BB3F                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:BB42 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BB42
DOSCODE:BB42 </span><span style="color:navy">loc_BB42:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BB42                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">80h
</span><span style="color:maroon">DOSCODE:BB47                 </span><span style="color:navy">jnz     short loc_BB4C
</span><span style="color:maroon">DOSCODE:BB49                 </span><span style="color:navy">call    </span>IsSFTNet
<span style="color:maroon">DOSCODE:BB4C
DOSCODE:BB4C </span><span style="color:navy">loc_BB4C:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BB4C                 </span><span style="color:navy">jz      short loc_BB61
</span><span style="color:maroon">DOSCODE:BB4E                 </span><span style="color:navy">test    al, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:BB50                 </span><span style="color:navy">jnz     short loc_BB5F
</span><span style="color:maroon">DOSCODE:BB52                 </span><span style="color:navy">mov     dx, es:[di+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:BB56
DOSCODE:BB56 </span><span style="color:navy">loc_BB56:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BB56                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:BB59                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], cx
</span><span style="color:maroon">DOSCODE:BB5C                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">6</span><span style="color:navy">], dx
</span><span style="color:maroon">DOSCODE:BB5F
DOSCODE:BB5F </span><span style="color:navy">loc_BB5F:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BB5F                 </span><span style="color:navy">jmp     short loc_BB3F
</span><span style="color:maroon">DOSCODE:BB61 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BB61
DOSCODE:BB61 </span><span style="color:navy">loc_BB61:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BB61                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:BB62                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:BB63                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:BB64                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:BB65                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:BB66                 </span><span style="color:navy">call    </span>DirFromSFT
<span style="color:maroon">DOSCODE:BB69                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:BB6A                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:BB6B                 </span><span style="color:navy">jnb     short loc_BB70
</span><span style="color:maroon">DOSCODE:BB6D                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:BB6E
DOSCODE:BB6E </span><span style="color:navy">loc_BB6E:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BB6E                 </span><span style="color:navy">jmp     short loc_BAF2
</span><span style="color:maroon">DOSCODE:BB70 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BB70
DOSCODE:BB70 </span><span style="color:navy">loc_BB70:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BB70                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:BB71                 </span><span style="color:navy">test    al, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:BB73                 </span><span style="color:navy">jnz     short loc_BB89
</span><span style="color:maroon">DOSCODE:BB75                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:maroon">DOSCODE:BB77                 </span><span style="color:navy">mov     dx, es:[di+</span><span style="color:#ff8000">12h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:BB7B                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">6
</span><span style="color:maroon">DOSCODE:BB7D                 </span><span style="color:navy">jnz     short loc_BB87
</span><span style="color:maroon">DOSCODE:BB7F                 </span><span style="color:navy">mov     cx, es:[di+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:BB83                 </span><span style="color:navy">mov     dx, es:[di+</span><span style="color:#ff8000">10h</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:BB87
DOSCODE:BB87 </span><span style="color:navy">loc_BB87:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BB87                 </span><span style="color:navy">jmp     short loc_BB56
</span><span style="color:maroon">DOSCODE:BB89 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BB89
DOSCODE:BB89 </span><span style="color:navy">loc_BB89:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BB89                 </span><span style="color:navy">test    dl, </span><span style="color:green">1Fh
</span><span style="color:maroon">DOSCODE:BB8C                 </span><span style="color:navy">jnz     short loc_BB92
</span><span style="color:maroon">DOSCODE:BB8E
DOSCODE:BB8E </span><span style="color:navy">loc_BB8E:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BB8E                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Dh
</span><span style="color:maroon">DOSCODE:BB90
DOSCODE:BB90 </span><span style="color:navy">loc_BB90:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BB90                 </span><span style="color:navy">jmp     short loc_BB6E
</span><span style="color:maroon">DOSCODE:BB92 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BB92
DOSCODE:BB92 </span><span style="color:navy">loc_BB92:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BB92                 </span><span style="color:navy">test    dx, </span><span style="color:green">1E0h
</span><span style="color:maroon">DOSCODE:BB96                 </span><span style="color:navy">jz      short loc_BB8E
</span><span style="color:maroon">DOSCODE:BB98                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:BB99                 </span><span style="color:navy">and     dx, </span><span style="color:green">1E0h
</span><span style="color:maroon">DOSCODE:BB9D                 </span><span style="color:navy">cmp     dx, </span><span style="color:#ff8000">180h
</span><span style="color:maroon">DOSCODE:BBA1                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:BBA2                 </span><span style="color:navy">ja      short loc_BB8E
</span><span style="color:maroon">DOSCODE:BBA4                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5
</span><span style="color:maroon">DOSCODE:BBA6                 </span><span style="color:navy">jnz     short loc_BBAE
</span><span style="color:maroon">DOSCODE:BBA8                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">12h</span><span style="color:navy">], dx
</span><span style="color:maroon">DOSCODE:BBAC                 </span><span style="color:navy">jmp     short loc_BBCE
</span><span style="color:maroon">DOSCODE:BBAE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BBAE
DOSCODE:BBAE </span><span style="color:navy">loc_BBAE:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BBAE                 </span><span style="color:navy">mov     ax, cx
</span><span style="color:maroon">DOSCODE:BBB0                 </span><span style="color:navy">and     ax, </span><span style="color:green">0F81Fh
</span><span style="color:maroon">DOSCODE:BBB3                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">0B8h
</span><span style="color:maroon">DOSCODE:BBB6                 </span><span style="color:navy">ja      short loc_BB8E
</span><span style="color:maroon">DOSCODE:BBB8                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1Dh
</span><span style="color:maroon">DOSCODE:BBBA                 </span><span style="color:navy">ja      short loc_BB8E
</span><span style="color:maroon">DOSCODE:BBBC                 </span><span style="color:navy">mov     ax, cx
</span><span style="color:maroon">DOSCODE:BBBE                 </span><span style="color:navy">and     ax, </span><span style="color:green">7E0h
</span><span style="color:maroon">DOSCODE:BBC1                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">760h
</span><span style="color:maroon">DOSCODE:BBC4                 </span><span style="color:navy">ja      short loc_BB8E
</span><span style="color:maroon">DOSCODE:BBC6                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">10h</span><span style="color:navy">], dx
</span><span style="color:maroon">DOSCODE:BBCA                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Eh</span><span style="color:navy">], cx
</span><span style="color:maroon">DOSCODE:BBCE
DOSCODE:BBCE </span><span style="color:navy">loc_BBCE:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BBCE                 </span><span style="color:navy">test    byte ptr es:[bx+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h
</span><span style="color:maroon">DOSCODE:BBD3                 </span><span style="color:navy">jnz     short loc_BBDD
</span><span style="color:maroon">DOSCODE:BBD5                 </span><span style="color:navy">call    </span>INC_DIRTY_COUNT
<span style="color:maroon">DOSCODE:BBD8                 </span><span style="color:navy">or      byte ptr es:[bx+</span><span style="color:#ff8000">5</span><span style="color:navy">], </span><span style="color:green">40h
</span><span style="color:maroon">DOSCODE:BBDD
DOSCODE:BBDD </span><span style="color:navy">loc_BBDD:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BBDD                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:BBDE                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:BBDF                 </span><span style="color:navy">mov     di, bx
</span><span style="color:maroon">DOSCODE:BBE1                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:BBE3                 </span><span style="color:navy">call    </span>CHECKFLUSH
<span style="color:maroon">DOSCODE:BBE6                 </span><span style="color:navy">jb      short loc_BB6E
</span><span style="color:maroon">DOSCODE:BBE8
DOSCODE:BBE8 </span><span style="color:navy">loc_BBE8:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BBE8                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:BBEB </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BBEB
DOSCODE:BBEB </span>$DUP<span style="color:navy">:                                   </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:BBEB                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:maroon">DOSCODE:BBED                 </span><span style="color:navy">call    </span>JFNFree
<span style="color:maroon">DOSCODE:BBF0
DOSCODE:BBF0 </span><span style="color:navy">loc_BBF0:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BBF0                 </span><span style="color:navy">jnb     short loc_BBF5
</span><span style="color:maroon">DOSCODE:BBF2                 </span><span style="color:navy">jmp     loc_BAEB
</span><span style="color:maroon">DOSCODE:BBF5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BBF5
DOSCODE:BBF5 </span><span style="color:navy">loc_BBF5:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BBF5                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:BBF6                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:BBF7                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:BBF8                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:BBF9                 </span><span style="color:navy">xchg    ax, bx
</span><span style="color:maroon">DOSCODE:BBFA                 </span><span style="color:navy">call    </span>CheckOwner
<span style="color:maroon">DOSCODE:BBFD                 </span><span style="color:navy">jnb     short loc_BC01
</span><span style="color:maroon">DOSCODE:BBFF                 </span><span style="color:navy">jmp     short loc_BB90
</span><span style="color:maroon">DOSCODE:BC01 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BC01
DOSCODE:BC01 </span><span style="color:navy">loc_BC01:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BC01                 </span><span style="color:navy">call    </span>DOS_Dup_Direct
<span style="color:maroon">DOSCODE:BC04                 </span><span style="color:navy">call    </span>pJFNFromHandle
<span style="color:maroon">DOSCODE:BC07                 </span><span style="color:navy">mov     bl, es:[di]
</span><span style="color:maroon">DOSCODE:BC0A                 </span><span style="color:navy">mov     [si], bl
</span><span style="color:maroon">DOSCODE:BC0C                 </span><span style="color:navy">jmp     short loc_BBE8
</span><span style="color:maroon">DOSCODE:BC0E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BC0E
DOSCODE:BC0E </span>$DUP2<span style="color:navy">:                                  </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:BC0E                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:BC0F                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:BC10                 </span><span style="color:navy">mov     bx, cx
</span><span style="color:maroon">DOSCODE:BC12                 </span><span style="color:navy">call    </span>$CLOSE
<span style="color:maroon">DOSCODE:BC15                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:BC16                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:BC17                 </span><span style="color:navy">call    </span>pJFNFromHandle
<span style="color:maroon">DOSCODE:BC1A                 </span><span style="color:navy">jmp     short loc_BBF0
</span><span style="color:black">DOSCODE:BC1C
DOSCODE:BC1C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:BC1C
DOSCODE:BC1C
DOSCODE:BC1C </span>CheckOwner      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BC1C                 </span><span style="color:navy">call    </span>SFFromHandle
<span style="color:black">DOSCODE:BC1F                 </span><span style="color:navy">jb      short locret_BC40
</span><span style="color:black">DOSCODE:BC21                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:BC22                 </span><span style="color:navy">test    ss:</span>IsWin386<span style="color:navy">, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:BC28                 </span><span style="color:navy">jz      short loc_BC32
</span><span style="color:black">DOSCODE:BC2A                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:BC2C                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:BC2D                 </span><span style="color:navy">jnz     short loc_BC30
</span><span style="color:black">DOSCODE:BC2F
DOSCODE:BC2F </span><span style="color:navy">locret_BC2F:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BC2F                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:BC30 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BC30
DOSCODE:BC30 </span><span style="color:navy">loc_BC30:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BC30                 </span><span style="color:navy">jmp     short loc_BC3D
</span><span style="color:black">DOSCODE:BC32 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BC32
DOSCODE:BC32 </span><span style="color:navy">loc_BC32:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BC32                 </span><span style="color:navy">mov     ax, ss:</span>USER_ID
<span style="color:black">DOSCODE:BC36                 </span><span style="color:navy">cmp     ax, es:[di+</span><span style="color:#ff8000">2Fh</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:BC3A                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:BC3B                 </span><span style="color:navy">jz      short locret_BC2F
</span><span style="color:black">DOSCODE:BC3D
DOSCODE:BC3D </span><span style="color:navy">loc_BC3D:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BC3D                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:BC3F                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:BC40
DOSCODE:BC40 </span><span style="color:navy">locret_BC40:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BC40                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:BC40 </span>CheckOwner      <span style="color:black">endp
DOSCODE:BC40
</span><span style="color:maroon">DOSCODE:BC41 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BC41
DOSCODE:BC41 </span>$AssignOper<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:BC41                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">7
</span><span style="color:maroon">DOSCODE:BC43                 </span><span style="color:navy">jnz     short loc_BC69
</span><span style="color:maroon">DOSCODE:BC45
DOSCODE:BC45 </span><span style="color:navy">loc_BC45:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BC45                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:BC46                 </span><span style="color:navy">mov     al, dl
</span><span style="color:maroon">DOSCODE:BC48                 </span><span style="color:navy">call    </span>GetCDSFromDrv
<span style="color:maroon">DOSCODE:BC4B                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:BC4C                 </span><span style="color:navy">jb      short loc_BC64
</span><span style="color:maroon">DOSCODE:BC4E                 </span><span style="color:navy">cmp     word ptr [si+</span><span style="color:#ff8000">45h</span><span style="color:navy">], </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:BC52                 </span><span style="color:navy">jz      short loc_BC64
</span><span style="color:maroon">DOSCODE:BC54                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">7
</span><span style="color:maroon">DOSCODE:BC56                 </span><span style="color:navy">jnz     short loc_BC5E
</span><span style="color:maroon">DOSCODE:BC58                 </span><span style="color:navy">or      byte ptr [si+</span><span style="color:#ff8000">44h</span><span style="color:navy">], </span><span style="color:green">40h
</span><span style="color:maroon">DOSCODE:BC5C                 </span><span style="color:navy">jmp     short loc_BC76
</span><span style="color:maroon">DOSCODE:BC5E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BC5E
DOSCODE:BC5E </span><span style="color:navy">loc_BC5E:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BC5E                 </span><span style="color:navy">and     byte ptr [si+</span><span style="color:#ff8000">44h</span><span style="color:navy">], </span><span style="color:green">0BFh
</span><span style="color:maroon">DOSCODE:BC62                 </span><span style="color:navy">jmp     short loc_BC76
</span><span style="color:maroon">DOSCODE:BC64 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BC64
DOSCODE:BC64 </span><span style="color:navy">loc_BC64:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BC64                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">0Fh
</span><span style="color:maroon">DOSCODE:BC67                 </span><span style="color:navy">jmp     short loc_BC79
</span><span style="color:maroon">DOSCODE:BC69 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BC69
DOSCODE:BC69 </span><span style="color:navy">loc_BC69:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BC69                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">8
</span><span style="color:maroon">DOSCODE:BC6B                 </span><span style="color:navy">jz      short loc_BC45
</span><span style="color:maroon">DOSCODE:BC6D                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:BC6E                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">111Eh
</span><span style="color:maroon">DOSCODE:BC71                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - DO REDIRECTION
<span style="color:maroon">DOSCODE:BC71                                         </span>; SS = DOS CS
<span style="color:maroon">DOSCODE:BC71                                         </span>; STACK: WORD function to execute
<span style="color:maroon">DOSCODE:BC71                                         </span>; Return: CF set on error, AX = error code
<span style="color:maroon">DOSCODE:BC71                                         </span>; STACK unchanged
<span style="color:maroon">DOSCODE:BC73                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:BC74                 </span><span style="color:navy">jb      short loc_BC79
</span><span style="color:maroon">DOSCODE:BC76
DOSCODE:BC76 </span><span style="color:navy">loc_BC76:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BC76                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:BC79 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BC79
DOSCODE:BC79 </span><span style="color:navy">loc_BC79:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BC79                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:black">DOSCODE:BC7C
DOSCODE:BC7C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:BC7C
DOSCODE:BC7C
DOSCODE:BC7C </span>FIND_DPB        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BC7C                 </span><span style="color:navy">lds     si, ss:</span><span style="color:green">26h
</span><span style="color:black">DOSCODE:BC81
DOSCODE:BC81 </span><span style="color:navy">loc_BC81:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BC81                 </span><span style="color:navy">cmp     si, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:BC84                 </span><span style="color:navy">jz      short loc_BC8F
</span><span style="color:black">DOSCODE:BC86                 </span><span style="color:navy">cmp     al, [si]
</span><span style="color:black">DOSCODE:BC88                 </span><span style="color:navy">jz      short locret_BC90
</span><span style="color:black">DOSCODE:BC8A                 </span><span style="color:navy">lds     si, [si+</span><span style="color:#ff8000">19h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:BC8D                 </span><span style="color:navy">jmp     short loc_BC81
</span><span style="color:black">DOSCODE:BC8F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BC8F
DOSCODE:BC8F </span><span style="color:navy">loc_BC8F:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BC8F                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:BC90
DOSCODE:BC90 </span><span style="color:navy">locret_BC90:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BC90                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:BC90 </span>FIND_DPB        <span style="color:black">endp
DOSCODE:BC90
DOSCODE:BC91
DOSCODE:BC91 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:BC91
DOSCODE:BC91
DOSCODE:BC91 </span>InitCDS         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BC91                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:BC92                 </span><span style="color:navy">les     di, ss:</span>THISCDS
<span style="color:black">DOSCODE:BC97                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">43h</span><span style="color:navy">], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:BC9D                 </span><span style="color:navy">sub     al, </span><span style="color:#ff8000">40h </span><span style="color:gray">; &#039;@&#039;
</span><span style="color:black">DOSCODE:BC9F                 </span><span style="color:navy">cmp     ss:</span>NUMIO<span style="color:navy">, al
</span><span style="color:black">DOSCODE:BCA4                 </span><span style="color:navy">jb      short loc_BCDC
</span><span style="color:black">DOSCODE:BCA6                 </span><span style="color:navy">dec     ax
</span><span style="color:black">DOSCODE:BCA7                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:BCA8                 </span><span style="color:navy">add     al, </span><span style="color:#ff8000">41h </span><span style="color:gray">; &#039;A&#039;
</span><span style="color:black">DOSCODE:BCAA                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">3Ah </span><span style="color:gray">; &#039;:&#039;
</span><span style="color:black">DOSCODE:BCAC                 </span><span style="color:navy">mov     es:[di], ax
</span><span style="color:black">DOSCODE:BCAF                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:#ff8000">5Ch </span><span style="color:gray">; &#039;\&#039;
</span><span style="color:black">DOSCODE:BCB5                 </span><span style="color:navy">or      byte ptr es:[di+</span><span style="color:#ff8000">44h</span><span style="color:navy">], </span><span style="color:green">40h
</span><span style="color:black">DOSCODE:BCBA                 </span><span style="color:navy">sub     ax, ax
</span><span style="color:black">DOSCODE:BCBC                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">49h</span><span style="color:navy">], ax
</span><span style="color:black">DOSCODE:BCC0                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4Bh</span><span style="color:navy">], ax
</span><span style="color:black">DOSCODE:BCC4                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:BCC6                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4Fh</span><span style="color:navy">], ax
</span><span style="color:black">DOSCODE:BCCA                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:BCCB                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:BCCC                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:BCCD                 </span><span style="color:navy">call    </span>FIND_DPB
<span style="color:black">DOSCODE:BCD0                 </span><span style="color:navy">jb      short loc_BCDA
</span><span style="color:black">DOSCODE:BCD2                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">45h</span><span style="color:navy">], si
</span><span style="color:black">DOSCODE:BCD6                 </span><span style="color:navy">mov     word ptr es:[di+</span><span style="color:#ff8000">47h</span><span style="color:navy">], ds
</span><span style="color:black">DOSCODE:BCDA
DOSCODE:BCDA </span><span style="color:navy">loc_BCDA:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BCDA                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:BCDB                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:BCDC
DOSCODE:BCDC </span><span style="color:navy">loc_BCDC:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BCDC                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:BCDD
DOSCODE:BCDD </span><span style="color:navy">locret_BCDD:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BCDD                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:BCDD </span>InitCDS         <span style="color:black">endp
DOSCODE:BCDD
</span><span style="color:maroon">DOSCODE:BCDE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BCDE
DOSCODE:BCDE </span>$UserOper<span style="color:navy">:                              </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:BCDE                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:BCE0                 </span><span style="color:navy">jb      short loc_BCEF
</span><span style="color:maroon">DOSCODE:BCE2                 </span><span style="color:navy">jz      short loc_BD0E
</span><span style="color:maroon">DOSCODE:BCE4                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5
</span><span style="color:maroon">DOSCODE:BCE6                 </span><span style="color:navy">jbe     short loc_BD21
</span><span style="color:maroon">DOSCODE:BCE8                 </span><span style="color:navy">call    </span>set_exerr_locus_unk
<span style="color:maroon">DOSCODE:BCEB                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:BCED
DOSCODE:BCED </span><span style="color:navy">loc_BCED:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BCED                 </span><span style="color:navy">jmp     short loc_BC79
</span><span style="color:maroon">DOSCODE:BCEF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BCEF
DOSCODE:BCEF </span><span style="color:navy">loc_BCEF:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BCEF                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:BCF0                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:BCF1                 </span><span style="color:navy">mov     di, dx
</span><span style="color:maroon">DOSCODE:BCF3                 </span><span style="color:navy">mov     cx, ss:</span><span style="color:green">0Eh
</span><span style="color:maroon">DOSCODE:BCF8                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:BCFB                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], cx
</span><span style="color:maroon">DOSCODE:BCFE                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:BCFF                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:BD00                 </span><span style="color:navy">mov     si, offset </span>MYNAME
<span style="color:maroon">DOSCODE:BD03
DOSCODE:BD03 </span><span style="color:navy">loc_BD03:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BD03                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">0Fh
</span><span style="color:maroon">DOSCODE:BD06                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">DOSCODE:BD08                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">DOSCODE:BD0A                 </span><span style="color:navy">stosb
</span><span style="color:maroon">DOSCODE:BD0B
DOSCODE:BD0B </span><span style="color:navy">loc_BD0B:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BD0B                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:BD0E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BD0E
DOSCODE:BD0E </span><span style="color:navy">loc_BD0E:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BD0E                 </span><span style="color:navy">mov     ss:</span><span style="color:green">0Eh</span><span style="color:navy">, cx
</span><span style="color:maroon">DOSCODE:BD13                 </span><span style="color:navy">mov     si, dx
</span><span style="color:maroon">DOSCODE:BD15                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:BD16                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:BD17                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">305h
</span><span style="color:maroon">DOSCODE:BD1A                 </span><span style="color:navy">inc     byte ptr ss:</span><span style="color:green">304h
</span><span style="color:maroon">DOSCODE:BD1F                 </span><span style="color:navy">jmp     short loc_BD03
</span><span style="color:maroon">DOSCODE:BD21 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:BD21
DOSCODE:BD21 </span><span style="color:navy">loc_BD21:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:BD21                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:BD22                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">111Fh
</span><span style="color:maroon">DOSCODE:BD25                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - PRINTER SETUP
<span style="color:maroon">DOSCODE:BD25                                         </span>; STACK: WORD function
<span style="color:maroon">DOSCODE:BD25                                         </span>; Return: CF set on error, AX = error code
<span style="color:maroon">DOSCODE:BD25                                         </span>; STACK unchanged
<span style="color:maroon">DOSCODE:BD27                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:BD28                 </span><span style="color:navy">jnb     short loc_BD0B
</span><span style="color:maroon">DOSCODE:BD2A                 </span><span style="color:navy">jmp     short loc_BCED
</span><span style="color:black">DOSCODE:BD2C
DOSCODE:BD2C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:BD2C
DOSCODE:BD2C
DOSCODE:BD2C </span>GetVisDrv       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BD2C                 </span><span style="color:navy">call    </span>GETTHISDRV
<span style="color:black">DOSCODE:BD2F                 </span><span style="color:navy">jb      short locret_BCDD
</span><span style="color:black">DOSCODE:BD31                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:BD32                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:BD33                 </span><span style="color:navy">lds     si, ss:</span><span style="color:green">5A2h
</span><span style="color:black">DOSCODE:BD38                 </span><span style="color:navy">test    byte ptr [si+</span><span style="color:#ff8000">44h</span><span style="color:navy">], </span><span style="color:green">20h
</span><span style="color:black">DOSCODE:BD3C                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:BD3D                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:BD3E                 </span><span style="color:navy">jz      short locret_BCDD
</span><span style="color:black">DOSCODE:BD40                 </span><span style="color:navy">mov     ss:</span>DrvErr<span style="color:navy">, </span><span style="color:#ff8000">0Fh
</span><span style="color:black">DOSCODE:BD46                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:BD47                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:BD47 </span>GetVisDrv       <span style="color:black">endp
DOSCODE:BD47
DOSCODE:BD48
DOSCODE:BD48 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:BD48
DOSCODE:BD48
DOSCODE:BD48 </span>GETTHISDRV      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BD48                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:BD4A                 </span><span style="color:navy">jnz     short loc_BD51
</span><span style="color:black">DOSCODE:BD4C                 </span><span style="color:navy">mov     al, ss:</span>CURDRV
<span style="color:black">DOSCODE:BD50                 </span><span style="color:navy">inc     ax
</span><span style="color:black">DOSCODE:BD51
DOSCODE:BD51 </span><span style="color:navy">loc_BD51:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BD51                 </span><span style="color:navy">dec     ax
</span><span style="color:black">DOSCODE:BD52                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:BD53                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:BD54                 </span><span style="color:navy">call    </span>set_exerr_locus_disk
<span style="color:black">DOSCODE:BD57                 </span><span style="color:navy">cmp     ss:</span>FSHARING<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:BD5D                 </span><span style="color:navy">jz      short loc_BD7F
</span><span style="color:black">DOSCODE:BD5F                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:BD60                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:BD61                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:BD62                 </span><span style="color:navy">mov     word ptr ss:</span>THISCDS<span style="color:navy">, (offset dword_613 - (offset </span>SFT0_SFTable<span style="color:navy">+</span><span style="color:green">4Eh</span><span style="color:navy">))
</span><span style="color:black">DOSCODE:BD69                 </span><span style="color:navy">mov     word ptr ss:</span>THISCDS<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ss
</span><span style="color:black">DOSCODE:BD6E                 </span><span style="color:navy">add     al, </span><span style="color:#ff8000">41h </span><span style="color:gray">; &#039;A&#039;
</span><span style="color:black">DOSCODE:BD70                 </span><span style="color:navy">call    </span>InitCDS
<span style="color:black">DOSCODE:BD73                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">44h</span><span style="color:navy">], </span><span style="color:green">40h
</span><span style="color:black">DOSCODE:BD78                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:BD79                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:BD7A                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:BD7B                 </span><span style="color:navy">jz      short loc_BD8A
</span><span style="color:black">DOSCODE:BD7D                 </span><span style="color:navy">jmp     short loc_BD94
</span><span style="color:black">DOSCODE:BD7F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BD7F
DOSCODE:BD7F </span><span style="color:navy">loc_BD7F:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BD7F                 </span><span style="color:navy">call    </span>GetCDSFromDrv
<span style="color:black">DOSCODE:BD82                 </span><span style="color:navy">jb      short loc_BD8A
</span><span style="color:black">DOSCODE:BD84                 </span><span style="color:navy">test    byte ptr [si+</span><span style="color:#ff8000">44h</span><span style="color:navy">], </span><span style="color:green">40h
</span><span style="color:black">DOSCODE:BD88                 </span><span style="color:navy">jnz     short loc_BD94
</span><span style="color:black">DOSCODE:BD8A
DOSCODE:BD8A </span><span style="color:navy">loc_BD8A:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BD8A                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0Fh
</span><span style="color:black">DOSCODE:BD8C                 </span><span style="color:navy">mov     ss:</span>DrvErr<span style="color:navy">, al
</span><span style="color:black">DOSCODE:BD90                 </span><span style="color:navy">call    </span>set_exerr_locus_unk
<span style="color:black">DOSCODE:BD93                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:BD94
DOSCODE:BD94 </span><span style="color:navy">loc_BD94:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BD94                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:BD95                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:BD96                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:BD96 </span>GETTHISDRV      <span style="color:black">endp
DOSCODE:BD96
DOSCODE:BD97
DOSCODE:BD97 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:BD97
DOSCODE:BD97
DOSCODE:BD97 </span>GetCDSFromDrv   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BD97                 </span><span style="color:navy">cmp     al, ss:</span>CDSCOUNT
<span style="color:black">DOSCODE:BD9C                 </span><span style="color:navy">jnb     short loc_BDB9
</span><span style="color:black">DOSCODE:BD9E                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:BD9F                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:BDA0                 </span><span style="color:navy">lds     si, ss:</span>CDSADDR
<span style="color:black">DOSCODE:BDA5                 </span><span style="color:navy">mov     bl, </span><span style="color:green">88
</span><span style="color:black">DOSCODE:BDA7                 </span><span style="color:navy">mul     bl
</span><span style="color:black">DOSCODE:BDA9                 </span><span style="color:navy">add     si, ax
</span><span style="color:black">DOSCODE:BDAB                 </span><span style="color:navy">mov     word ptr ss:</span>THISCDS<span style="color:navy">, si
</span><span style="color:black">DOSCODE:BDB0                 </span><span style="color:navy">mov     word ptr ss:</span>THISCDS<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:black">DOSCODE:BDB5                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:BDB6                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:BDB7                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:BDB8                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:BDB9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BDB9
DOSCODE:BDB9 </span><span style="color:navy">loc_BDB9:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BDB9                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:BDBA                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:BDBA </span>GetCDSFromDrv   <span style="color:black">endp
DOSCODE:BDBA
DOSCODE:BDBB
DOSCODE:BDBB </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:BDBB
DOSCODE:BDBB </span><span style="color:gray">; Attributes: bp-based frame
</span><span style="color:black">DOSCODE:BDBB
DOSCODE:BDBB </span>TransFCB        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BDBB
DOSCODE:BDBB </span><span style="color:green">FCBTmp          </span><span style="color:navy">= byte ptr </span><span style="color:#008040">-10h
</span><span style="color:black">DOSCODE:BDBB
DOSCODE:BDBB                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:BDBC                 </span><span style="color:navy">mov     bp, sp
</span><span style="color:black">DOSCODE:BDBE                 </span><span style="color:navy">sub     sp, </span><span style="color:green">10h
</span><span style="color:black">DOSCODE:BDC1                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:BDC2                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:BDC3                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:BDC4                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:BDC5                 </span><span style="color:navy">lea     di, [bp+</span><span style="color:green">FCBTmp</span><span style="color:navy">] </span>; point to FCB temp area
<span style="color:black">DOSCODE:BDC8                 </span><span style="color:navy">mov     ss:</span>EXTFCB<span style="color:navy">, </span><span style="color:#ff8000">0    </span>; no extended FCB found
<span style="color:black">DOSCODE:BDCE                 </span><span style="color:navy">mov     ss:</span>SATTRIB<span style="color:navy">, </span><span style="color:#ff8000">0   </span>; default search attributes
<span style="color:black">DOSCODE:BDD4                 </span><span style="color:navy">call    </span>GetExtended     ; get FCB, extended or not
<span style="color:black">DOSCODE:BDD7                 </span><span style="color:navy">jz      short </span><span style="color:gray">GetDrive  </span>; not an extended FCB, get drive
<span style="color:black">DOSCODE:BDD9                 </span><span style="color:navy">mov     al, [si-</span><span style="color:green">1</span><span style="color:navy">]      </span>; get attributes
<span style="color:black">DOSCODE:BDDC                 </span><span style="color:navy">mov     ss:</span>SATTRIB<span style="color:navy">, al  </span>; store search attributes
<span style="color:black">DOSCODE:BDE0                 </span><span style="color:navy">mov     ss:</span>EXTFCB<span style="color:navy">, </span><span style="color:#ff8000">0FFh </span>; -1 ; signal extended FCB
<span style="color:black">DOSCODE:BDE6
DOSCODE:BDE6 </span><span style="color:gray">GetDrive</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BDE6                 </span><span style="color:navy">lodsb                   </span>; get drive byte
<span style="color:black">DOSCODE:BDE7                 </span><span style="color:navy">call    </span>GETTHISDRV
<span style="color:black">DOSCODE:BDEA                 </span><span style="color:navy">jb      short </span><span style="color:gray">BadPack
</span><span style="color:black">DOSCODE:BDEC                 </span><span style="color:navy">call    </span>TextFromDrive   ; convert 0-based drive to text
<span style="color:black">DOSCODE:BDEF                 </span><span style="color:navy">mov     cx, </span><span style="color:green">11
</span><span style="color:black">DOSCODE:BDF2                 </span><span style="color:navy">push    si              </span>; back over name, ext
<span style="color:black">DOSCODE:BDF3
DOSCODE:BDF3 </span><span style="color:gray">FCBScan</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BDF3                 </span><span style="color:navy">lodsb                   </span>; get a byte
<span style="color:black">DOSCODE:BDF4                 </span><span style="color:navy">call    </span>GetCharType
<span style="color:black">DOSCODE:BDF7                 </span><span style="color:navy">test    al, </span><span style="color:green">8
</span><span style="color:black">DOSCODE:BDF9                 </span><span style="color:navy">jz      short </span><span style="color:gray">BadPack
</span><span style="color:black">DOSCODE:BDFB                 </span><span style="color:navy">loop    </span><span style="color:gray">FCBScan
</span><span style="color:black">DOSCODE:BDFD                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:BDFE                 </span><span style="color:navy">mov     bx, di
</span><span style="color:black">DOSCODE:BE00                 </span><span style="color:navy">call    </span>PackName
<span style="color:black">DOSCODE:BE03                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:BE04                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:BE05                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:BE06                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:BE07                 </span><span style="color:navy">lea     si, [bp+</span><span style="color:green">FCBTmp</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:BE0A                 </span><span style="color:navy">cmp     byte ptr [bx], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:BE0D                 </span><span style="color:navy">jz      short </span><span style="color:gray">BadPack
</span><span style="color:black">DOSCODE:BE0F                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:BE10                 </span><span style="color:navy">call    </span>TransPathSet
<span style="color:black">DOSCODE:BE13                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:BE14                 </span><span style="color:navy">jnb     short </span><span style="color:gray">FCBRet
</span><span style="color:black">DOSCODE:BE16
DOSCODE:BE16 </span><span style="color:gray">BadPack</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BE16                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:BE17                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:BE19
DOSCODE:BE19 </span><span style="color:gray">FCBRet</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BE19                 </span><span style="color:navy">mov     sp, bp
</span><span style="color:black">DOSCODE:BE1B                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:BE1C
DOSCODE:BE1C </span>TransPath_retn<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BE1C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:BE1C </span>TransFCB        <span style="color:black">endp
DOSCODE:BE1C
DOSCODE:BE1D
DOSCODE:BE1D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:BE1D
DOSCODE:BE1D
DOSCODE:BE1D </span>TransPath       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BE1D                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">DOSCODE:BE1F                 </span><span style="color:navy">jmp     short </span>SetSplice
<span style="color:black">DOSCODE:BE1F </span>TransPath       <span style="color:black">endp
DOSCODE:BE1F
DOSCODE:BE21
DOSCODE:BE21 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:BE21
DOSCODE:BE21
DOSCODE:BE21 </span>TransPathSet    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BE21
DOSCODE:BE21 </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:BEF1 SIZE 000000A5 BYTES
</span><span style="color:black">DOSCODE:BE21
DOSCODE:BE21                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:BE23
DOSCODE:BE23 </span>SetSplice<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BE23                 </span><span style="color:navy">mov     ss:</span>NoSetDir<span style="color:navy">, al
</span><span style="color:black">DOSCODE:BE27                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:BE29
DOSCODE:BE29 </span>TransPathNoSet<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BE29                 </span><span style="color:navy">mov     ss:</span>FSPLICE<span style="color:navy">, al
</span><span style="color:black">DOSCODE:BE2D                 </span><span style="color:navy">mov     ss:</span>CMETA<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:BE33                 </span><span style="color:navy">mov     ss:</span>WFP_START<span style="color:navy">, di
</span><span style="color:black">DOSCODE:BE38                 </span><span style="color:navy">mov     ss:</span>CURR_DIR_END<span style="color:navy">, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:BE3F                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:BE40                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:BE41                 </span><span style="color:navy">lea     bp, [di+</span><span style="color:#ff8000">86h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:BE45                 </span><span style="color:navy">cmp     ss:</span>FSHARING<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:BE4B                 </span><span style="color:navy">jz      short </span><span style="color:gray">CheckUNC
</span><span style="color:black">DOSCODE:BE4D                 </span><span style="color:navy">call    </span>DriveFromText
<span style="color:black">DOSCODE:BE50                 </span><span style="color:navy">call    </span>GETTHISDRV
<span style="color:black">DOSCODE:BE53                 </span><span style="color:navy">jb      short </span><span style="color:gray">NoPath
</span><span style="color:black">DOSCODE:BE55                 </span><span style="color:navy">call    </span>TextFromDrive
<span style="color:black">DOSCODE:BE58                 </span><span style="color:navy">lea     bx, [di+</span><span style="color:#ff8000">1</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:BE5B                 </span><span style="color:navy">call    </span>Canonicalize
<span style="color:black">DOSCODE:BE5E                 </span><span style="color:navy">jb      short </span>TransPath_retn
<span style="color:black">DOSCODE:BE60                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:BE61                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:BE62                 </span><span style="color:navy">mov     si, ds:</span>WFP_START
<span style="color:black">DOSCODE:BE66                 </span><span style="color:navy">test    ds:</span>FSPLICE<span style="color:navy">, </span><span style="color:green">0FFh
</span><span style="color:black">DOSCODE:BE6B                 </span><span style="color:navy">jz      short </span><span style="color:gray">NoServerSplice
</span><span style="color:black">DOSCODE:BE6D                 </span><span style="color:navy">call    </span>Splice
<span style="color:black">DOSCODE:BE70
DOSCODE:BE70 </span><span style="color:gray">NoServerSplice</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BE70                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:BE71                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:BE72                 </span><span style="color:navy">les     di, ds:</span>THISCDS
<span style="color:black">DOSCODE:BE76                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:BE79                 </span><span style="color:navy">call    </span>FATREAD_CDS
<span style="color:black">DOSCODE:BE7C                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:BE7F
DOSCODE:BE7F </span><span style="color:gray">NoPath</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BE7F                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:BE81                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:BE82 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BE82
DOSCODE:BE82 </span><span style="color:gray">CheckUNC</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BE82                 </span><span style="color:navy">mov     word ptr ss:</span>THISCDS<span style="color:navy">, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:BE89                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1123h
</span><span style="color:black">DOSCODE:BE8C                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - QUALIFY REMOTE FILENAME
<span style="color:black">DOSCODE:BE8C                                         </span>; DS:SI -&gt; ASCIZ filename to canonicalize
<span style="color:black">DOSCODE:BE8C                                         </span>; ES:DI -&gt; 128-byte buffer for qualified name
<span style="color:black">DOSCODE:BE8C                                         </span>; Return: CF set if not resolved
<span style="color:black">DOSCODE:BE8E                 </span><span style="color:navy">jnb     short loc_BEB9
</span><span style="color:black">DOSCODE:BE90                 </span><span style="color:navy">call    </span>DriveFromText
<span style="color:black">DOSCODE:BE93                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:BE94                 </span><span style="color:navy">mov     ax, [si]
</span><span style="color:black">DOSCODE:BE96                 </span><span style="color:navy">call    </span>PATHCHRCMP
<span style="color:black">DOSCODE:BE99                 </span><span style="color:navy">xchg    ah, al
</span><span style="color:black">DOSCODE:BE9B                 </span><span style="color:navy">call    </span>PATHCHRCMP
<span style="color:black">DOSCODE:BE9E                 </span><span style="color:navy">jnz     short loc_BEBF
</span><span style="color:black">DOSCODE:BEA0                 </span><span style="color:navy">cmp     ah, al
</span><span style="color:black">DOSCODE:BEA2                 </span><span style="color:navy">jnz     short loc_BEBF
</span><span style="color:black">DOSCODE:BEA4                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:BEA5                 </span><span style="color:navy">movsw
</span><span style="color:black">DOSCODE:BEA6
DOSCODE:BEA6 </span><span style="color:navy">loc_BEA6:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BEA6                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:BEA7                 </span><span style="color:navy">call    </span>UCase
<span style="color:black">DOSCODE:BEAA                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:BEAC                 </span><span style="color:navy">jz      short loc_BEBC
</span><span style="color:black">DOSCODE:BEAE                 </span><span style="color:navy">call    </span>PATHCHRCMP
<span style="color:black">DOSCODE:BEB1                 </span><span style="color:navy">mov     bx, di
</span><span style="color:black">DOSCODE:BEB3                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:BEB4                 </span><span style="color:navy">jnz     short loc_BEA6
</span><span style="color:black">DOSCODE:BEB6                 </span><span style="color:navy">call    </span>Canonicalize
<span style="color:black">DOSCODE:BEB9
DOSCODE:BEB9 </span><span style="color:navy">loc_BEB9:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BEB9                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:BEBA                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:BEBB                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:BEBC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BEBC
DOSCODE:BEBC </span><span style="color:navy">loc_BEBC:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BEBC                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:BEBD                 </span><span style="color:navy">jmp     short loc_BEB9
</span><span style="color:black">DOSCODE:BEBF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BEBF
DOSCODE:BEBF </span><span style="color:navy">loc_BEBF:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BEBF                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:BEC0                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:BEC3                 </span><span style="color:navy">jnz     short loc_BEC9
</span><span style="color:black">DOSCODE:BEC5                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:BEC7                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:BEC8                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:BEC9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BEC9
DOSCODE:BEC9 </span><span style="color:navy">loc_BEC9:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BEC9                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:BECA                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:BECB                 </span><span style="color:navy">call    </span>j_CheckThisDevice
<span style="color:black">DOSCODE:BECE                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:BECF                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:BED0                 </span><span style="color:navy">jnb     short loc_BEF1
</span><span style="color:black">DOSCODE:BED2                 </span><span style="color:navy">mov     ss:</span>FSHARING<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:BED8                 </span><span style="color:navy">call    </span>GETTHISDRV
<span style="color:black">DOSCODE:BEDB                 </span><span style="color:navy">mov     ss:</span>FSHARING<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:BEE1                 </span><span style="color:navy">call    </span>TextFromDrive
<span style="color:black">DOSCODE:BEE4                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2Fh </span><span style="color:gray">; &#039;/&#039;
</span><span style="color:black">DOSCODE:BEE6                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:BEE7                 </span><span style="color:navy">call    </span>StrCpy
<span style="color:black">DOSCODE:BEEA                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:BEEB                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:BEEC                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:BEED
DOSCODE:BEED </span><span style="color:navy">locret_BEED:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BEED                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:BEED </span>TransPathSet    <span style="color:black">endp
DOSCODE:BEED
DOSCODE:BEEE </span>; [00000003 BYTES: COLLAPSED FUNCTION j_CheckThisDevice. PRESS CTRL-NUMPAD+ TO EXPAND]
<span style="color:black">DOSCODE:BEF1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BEF1 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR TransPathSet
</span><span style="color:black">DOSCODE:BEF1
DOSCODE:BEF1 </span><span style="color:navy">loc_BEF1:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BEF1                 </span><span style="color:navy">call    </span>GetVisDrv
<span style="color:black">DOSCODE:BEF4                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:BEF6                 </span><span style="color:navy">jb      short locret_BEED
</span><span style="color:black">DOSCODE:BEF8                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:BEF9                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:BEFA                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:BEFB                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:BEFC                 </span><span style="color:navy">call    </span>ValidateCDS
<span style="color:black">DOSCODE:BEFF                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:BF00                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:BF01                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:BF02                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:BF03                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:BF05                 </span><span style="color:navy">jb      short locret_BEED
</span><span style="color:black">DOSCODE:BF07                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:BF08                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:BF09                 </span><span style="color:navy">lds     si, ss:</span>THISCDS
<span style="color:black">DOSCODE:BF0E                 </span><span style="color:navy">mov     bx, di
</span><span style="color:black">DOSCODE:BF10                 </span><span style="color:navy">add     bx, [si+</span><span style="color:#ff8000">4Fh</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:BF13                 </span><span style="color:navy">lea     bp, [di+</span><span style="color:#ff8000">86h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:BF17                 </span><span style="color:navy">call    </span>FStrCpy
<span style="color:black">DOSCODE:BF1A                 </span><span style="color:navy">dec     di
</span><span style="color:black">DOSCODE:BF1B                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">5Ch </span><span style="color:gray">; &#039;\&#039;
</span><span style="color:black">DOSCODE:BF1D                 </span><span style="color:navy">cmp     es:[di-</span><span style="color:green">1</span><span style="color:navy">], al
</span><span style="color:black">DOSCODE:BF21                 </span><span style="color:navy">jz      short loc_BF24
</span><span style="color:black">DOSCODE:BF23                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:BF24
DOSCODE:BF24 </span><span style="color:navy">loc_BF24:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BF24                 </span><span style="color:navy">dec     di
</span><span style="color:black">DOSCODE:BF25                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:BF26                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:BF27                 </span><span style="color:navy">call    sub_BFFB
</span><span style="color:black">DOSCODE:BF2A                 </span><span style="color:navy">jnz     short loc_BF3D
</span><span style="color:black">DOSCODE:BF2C                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:BF2E                 </span><span style="color:navy">jz      short loc_BF40
</span><span style="color:black">DOSCODE:BF30                 </span><span style="color:navy">mov     di, bx
</span><span style="color:black">DOSCODE:BF32
DOSCODE:BF32 </span><span style="color:navy">loc_BF32:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BF32                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:BF33                 </span><span style="color:navy">call    </span>PATHCHRCMP
<span style="color:black">DOSCODE:BF36                 </span><span style="color:navy">jz      short loc_BF32
</span><span style="color:black">DOSCODE:BF38                 </span><span style="color:navy">dec     si
</span><span style="color:black">DOSCODE:BF39                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:BF3B                 </span><span style="color:navy">jz      short loc_BF40
</span><span style="color:black">DOSCODE:BF3D
DOSCODE:BF3D </span><span style="color:navy">loc_BF3D:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BF3D                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">5Ch </span><span style="color:gray">; &#039;\&#039;
</span><span style="color:black">DOSCODE:BF3F                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:BF40
DOSCODE:BF40 </span><span style="color:navy">loc_BF40:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BF40                 </span><span style="color:navy">call    </span>Canonicalize
<span style="color:black">DOSCODE:BF43                 </span><span style="color:navy">jb      short locret_BEED
</span><span style="color:black">DOSCODE:BF45                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:BF46                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:BF47                 </span><span style="color:navy">mov     di, ds:</span>WFP_START
<span style="color:black">DOSCODE:BF4B                 </span><span style="color:navy">lds     si, ds:</span>THISCDS
<span style="color:black">DOSCODE:BF4F                 </span><span style="color:navy">call    </span>PathPref
<span style="color:black">DOSCODE:BF52                 </span><span style="color:navy">jnz     short loc_BF68
</span><span style="color:black">DOSCODE:BF54                 </span><span style="color:navy">mov     al, [si-</span><span style="color:green">1</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:BF57                 </span><span style="color:navy">call    </span>PATHCHRCMP
<span style="color:black">DOSCODE:BF5A                 </span><span style="color:navy">jz      short loc_BF68
</span><span style="color:black">DOSCODE:BF5C                 </span><span style="color:navy">cmp     byte ptr es:[di], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:BF60                 </span><span style="color:navy">jz      short loc_BF68
</span><span style="color:black">DOSCODE:BF62                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:BF63                 </span><span style="color:navy">mov     ss:</span>CURR_DIR_END<span style="color:navy">, di
</span><span style="color:black">DOSCODE:BF68
DOSCODE:BF68 </span><span style="color:navy">loc_BF68:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BF68                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:BF69                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:BF6A                 </span><span style="color:navy">mov     si, ds:</span>WFP_START
<span style="color:black">DOSCODE:BF6E                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:BF70                 </span><span style="color:navy">test    ds:</span>FSPLICE<span style="color:navy">, </span><span style="color:green">0FFh
</span><span style="color:black">DOSCODE:BF75                 </span><span style="color:navy">jz      short loc_BF7A
</span><span style="color:black">DOSCODE:BF77                 </span><span style="color:navy">call    </span>Splice
<span style="color:black">DOSCODE:BF7A
DOSCODE:BF7A </span><span style="color:navy">loc_BF7A:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BF7A                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:BF7B                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:BF7C                 </span><span style="color:navy">les     di, ds:</span>THISCDS
<span style="color:black">DOSCODE:BF80                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">43h</span><span style="color:navy">], </span><span style="color:green">8000h
</span><span style="color:black">DOSCODE:BF86                 </span><span style="color:navy">jnz     short locret_BF95
</span><span style="color:black">DOSCODE:BF88                 </span><span style="color:navy">jcxz    short locret_BF95
</span><span style="color:black">DOSCODE:BF8A                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:BF8D                 </span><span style="color:navy">call    </span>FATREAD_CDS
<span style="color:black">DOSCODE:BF90                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:BF93                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:BF95
DOSCODE:BF95 </span><span style="color:navy">locret_BF95:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BF95                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:BF95 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR TransPathSet
</span><span style="color:black">DOSCODE:BF96
DOSCODE:BF96 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:BF96
DOSCODE:BF96
DOSCODE:BF96 </span>Canonicalize    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BF96                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:BF97                 </span><span style="color:navy">call    </span>PATHCHRCMP
<span style="color:black">DOSCODE:BF9A                 </span><span style="color:navy">jnz     short loc_BFA3
</span><span style="color:black">DOSCODE:BF9C                 </span><span style="color:navy">cmp     di, bp
</span><span style="color:black">DOSCODE:BF9E                 </span><span style="color:navy">jnb     short loc_BFB9
</span><span style="color:black">DOSCODE:BFA0                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:BFA1                 </span><span style="color:navy">jmp     short </span>Canonicalize
<span style="color:black">DOSCODE:BFA3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BFA3
DOSCODE:BFA3 </span><span style="color:navy">loc_BFA3:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BFA3                 </span><span style="color:navy">dec     si
</span><span style="color:black">DOSCODE:BFA4
DOSCODE:BFA4 </span><span style="color:navy">loc_BFA4:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BFA4                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:BFA6                 </span><span style="color:navy">cmp     [si], al
</span><span style="color:black">DOSCODE:BFA8                 </span><span style="color:navy">jnz     short loc_BFC4
</span><span style="color:black">DOSCODE:BFAA                 </span><span style="color:navy">cmp     byte ptr es:[di-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">3Ah </span><span style="color:gray">; &#039;:&#039;
</span><span style="color:black">DOSCODE:BFAF                 </span><span style="color:navy">jnz     short loc_BFB6
</span><span style="color:black">DOSCODE:BFB1                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">5Ch </span><span style="color:gray">; &#039;\&#039;
</span><span style="color:black">DOSCODE:BFB3                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:BFB4                 </span><span style="color:navy">mov     al, ah
</span><span style="color:black">DOSCODE:BFB6
DOSCODE:BFB6 </span><span style="color:navy">loc_BFB6:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BFB6                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:BFB7                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:BFB8                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:BFB9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BFB9
DOSCODE:BFB9 </span><span style="color:navy">loc_BFB9:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BFB9                 </span><span style="color:navy">call    </span>ScanPathChar
<span style="color:black">DOSCODE:BFBC                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:BFBE                 </span><span style="color:navy">jz      short loc_BFC2
</span><span style="color:black">DOSCODE:BFC0                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:BFC2
DOSCODE:BFC2 </span><span style="color:navy">loc_BFC2:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BFC2                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:BFC3
DOSCODE:BFC3 </span><span style="color:navy">locret_BFC3:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BFC3                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:BFC4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BFC4
DOSCODE:BFC4 </span><span style="color:navy">loc_BFC4:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BFC4                 </span><span style="color:navy">call    sub_C018
</span><span style="color:black">DOSCODE:BFC7                 </span><span style="color:navy">jb      short locret_BFC3
</span><span style="color:black">DOSCODE:BFC9                 </span><span style="color:navy">cmp     word ptr es:[di], </span><span style="color:#ff8000">2Eh </span><span style="color:gray">; &#039;.&#039;
</span><span style="color:black">DOSCODE:BFCD                 </span><span style="color:navy">jz      short loc_BFD7
</span><span style="color:black">DOSCODE:BFCF                 </span><span style="color:navy">cmp     word ptr es:[di], </span><span style="color:#ff8000">2E2Eh
</span><span style="color:black">DOSCODE:BFD4                 </span><span style="color:navy">jnz     short loc_BFE0
</span><span style="color:black">DOSCODE:BFD6                 </span><span style="color:navy">dec     di
</span><span style="color:black">DOSCODE:BFD7
DOSCODE:BFD7 </span><span style="color:navy">loc_BFD7:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BFD7                 </span><span style="color:navy">call    </span>SkipBack
<span style="color:black">DOSCODE:BFDA                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:BFDC                 </span><span style="color:navy">jb      short locret_BFC3
</span><span style="color:black">DOSCODE:BFDE                 </span><span style="color:navy">jmp     short loc_BFE2
</span><span style="color:black">DOSCODE:BFE0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:BFE0
DOSCODE:BFE0 </span><span style="color:navy">loc_BFE0:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BFE0                 </span><span style="color:navy">add     di, cx
</span><span style="color:black">DOSCODE:BFE2
DOSCODE:BFE2 </span><span style="color:navy">loc_BFE2:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BFE2                 </span><span style="color:navy">call    sub_BFFB
</span><span style="color:black">DOSCODE:BFE5                 </span><span style="color:navy">jnz     short loc_BFB9
</span><span style="color:black">DOSCODE:BFE7                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:BFE8                 </span><span style="color:navy">call    </span>PATHCHRCMP
<span style="color:black">DOSCODE:BFEB                 </span><span style="color:navy">jnz     short loc_BFA3
</span><span style="color:black">DOSCODE:BFED                 </span><span style="color:navy">cmp     di, bp
</span><span style="color:black">DOSCODE:BFEF                 </span><span style="color:navy">jnb     short loc_BFB9
</span><span style="color:black">DOSCODE:BFF1                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:BFF2
DOSCODE:BFF2 </span><span style="color:navy">loc_BFF2:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BFF2                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:BFF3                 </span><span style="color:navy">call    </span>PATHCHRCMP
<span style="color:black">DOSCODE:BFF6                 </span><span style="color:navy">jz      short loc_BFF2
</span><span style="color:black">DOSCODE:BFF8                 </span><span style="color:navy">dec     si
</span><span style="color:black">DOSCODE:BFF9                 </span><span style="color:navy">jmp     short loc_BFA4
</span><span style="color:black">DOSCODE:BFF9 </span>Canonicalize    <span style="color:black">endp
DOSCODE:BFF9
DOSCODE:BFFB
DOSCODE:BFFB </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:BFFB
DOSCODE:BFFB
DOSCODE:BFFB </span><span style="color:navy">sub_BFFB        </span><span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BFFB                 </span><span style="color:navy">mov     al, [si]
</span><span style="color:black">DOSCODE:BFFB </span><span style="color:navy">sub_BFFB        </span><span style="color:black">endp
DOSCODE:BFFB
DOSCODE:BFFD
DOSCODE:BFFD </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:BFFD
DOSCODE:BFFD
DOSCODE:BFFD </span>PathSepGotCh    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:BFFD                 </span><span style="color:navy">or      al, al
</span><span style="color:black">DOSCODE:BFFF                 </span><span style="color:navy">jz      short locret_BFC3
</span><span style="color:black">DOSCODE:C001                 </span><span style="color:navy">call    </span>PATHCHRCMP
<span style="color:black">DOSCODE:C004                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C004 </span>PathSepGotCh    <span style="color:black">endp
DOSCODE:C004
DOSCODE:C005
DOSCODE:C005 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C005
DOSCODE:C005
DOSCODE:C005 </span>SkipBack        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C005                 </span><span style="color:navy">cmp     di, bx
</span><span style="color:black">DOSCODE:C007                 </span><span style="color:navy">jb      short loc_C014
</span><span style="color:black">DOSCODE:C009                 </span><span style="color:navy">dec     di
</span><span style="color:black">DOSCODE:C00A                 </span><span style="color:navy">mov     al, es:[di]
</span><span style="color:black">DOSCODE:C00D                 </span><span style="color:navy">call    </span>PATHCHRCMP
<span style="color:black">DOSCODE:C010                 </span><span style="color:navy">jnz     short </span>SkipBack
<span style="color:black">DOSCODE:C012                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:C013                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C014 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:C014
DOSCODE:C014 </span><span style="color:navy">loc_C014:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C014                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:C016                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:C017                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C017 </span>SkipBack        <span style="color:black">endp
DOSCODE:C017
DOSCODE:C018
DOSCODE:C018 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C018
DOSCODE:C018
DOSCODE:C018 </span><span style="color:navy">sub_C018        </span><span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C018                 </span><span style="color:navy">sub     sp, </span><span style="color:green">0Eh
</span><span style="color:black">DOSCODE:C01B                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:C01C                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:C01D                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:C01E                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:C01F                 </span><span style="color:navy">push    bp
</span><span style="color:black">DOSCODE:C020                 </span><span style="color:navy">mov     bp, sp
</span><span style="color:black">DOSCODE:C022                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">2Eh </span><span style="color:gray">; &#039;.&#039;
</span><span style="color:black">DOSCODE:C024                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:C025                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:C026                 </span><span style="color:navy">cmp     al, ah
</span><span style="color:black">DOSCODE:C028                 </span><span style="color:navy">jnz     short loc_C042
</span><span style="color:black">DOSCODE:C02A                 </span><span style="color:navy">call    sub_BFFB
</span><span style="color:black">DOSCODE:C02D                 </span><span style="color:navy">jz      short loc_C03A
</span><span style="color:black">DOSCODE:C02F                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:C030                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:C031                 </span><span style="color:navy">cmp     al, ah
</span><span style="color:black">DOSCODE:C033                 </span><span style="color:navy">jnz     short loc_C08C
</span><span style="color:black">DOSCODE:C035                 </span><span style="color:navy">call    sub_BFFB
</span><span style="color:black">DOSCODE:C038                 </span><span style="color:navy">jnz     short loc_C08C
</span><span style="color:black">DOSCODE:C03A
DOSCODE:C03A </span><span style="color:navy">loc_C03A:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C03A                 </span><span style="color:navy">xor     al, al
</span><span style="color:black">DOSCODE:C03C                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:C03D                 </span><span style="color:navy">mov     [bp+</span><span style="color:#ff8000">6</span><span style="color:navy">], si
</span><span style="color:black">DOSCODE:C040                 </span><span style="color:navy">jmp     short loc_C089
</span><span style="color:black">DOSCODE:C042 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:C042
DOSCODE:C042 </span><span style="color:navy">loc_C042:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C042                 </span><span style="color:navy">mov     si, [bp+</span><span style="color:#ff8000">6</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C045                 </span><span style="color:navy">call    </span>NameTrans
<span style="color:black">DOSCODE:C048                 </span><span style="color:navy">cmp     si, [bp+</span><span style="color:#ff8000">6</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C04B                 </span><span style="color:navy">jz      short loc_C08C
</span><span style="color:black">DOSCODE:C04D                 </span><span style="color:navy">cmp     ss:</span>FSHARING<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:C053                 </span><span style="color:navy">jnz     short loc_C065
</span><span style="color:black">DOSCODE:C055                 </span><span style="color:navy">and     dl, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:C058                 </span><span style="color:navy">add     ss:</span>CMETA<span style="color:navy">, dl
</span><span style="color:black">DOSCODE:C05D                 </span><span style="color:navy">jg      short loc_C08C
</span><span style="color:black">DOSCODE:C05F                 </span><span style="color:navy">jnz     short loc_C065
</span><span style="color:black">DOSCODE:C061                 </span><span style="color:navy">or      dl, dl
</span><span style="color:black">DOSCODE:C063                 </span><span style="color:navy">jz      short loc_C094
</span><span style="color:black">DOSCODE:C065
DOSCODE:C065 </span><span style="color:navy">loc_C065:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C065                 </span><span style="color:navy">mov     [bp+</span><span style="color:#ff8000">6</span><span style="color:navy">], si
</span><span style="color:black">DOSCODE:C068                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:C069                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:C06A                 </span><span style="color:navy">mov     si, offset </span>NAME1
<span style="color:black">DOSCODE:C06D                 </span><span style="color:navy">lea     di, [bp+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C070                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:C071                 </span><span style="color:navy">call    </span>PackName
<span style="color:black">DOSCODE:C074                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:C075                 </span><span style="color:navy">call    </span>StrLen
<span style="color:black">DOSCODE:C078                 </span><span style="color:navy">dec     cx
</span><span style="color:black">DOSCODE:C079                 </span><span style="color:navy">add     cx, [bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C07C                 </span><span style="color:navy">cmp     cx, [bp+</span><span style="color:#ff8000">0</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C07F                 </span><span style="color:navy">jnb     short loc_C08C
</span><span style="color:black">DOSCODE:C081                 </span><span style="color:navy">mov     si, di
</span><span style="color:black">DOSCODE:C083                 </span><span style="color:navy">les     di, [bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C086                 </span><span style="color:navy">call    </span>FStrCpy
<span style="color:black">DOSCODE:C089
DOSCODE:C089 </span><span style="color:navy">loc_C089:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C089                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:C08A                 </span><span style="color:navy">jmp     short loc_C097
</span><span style="color:black">DOSCODE:C08C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:C08C
DOSCODE:C08C </span><span style="color:navy">loc_C08C:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C08C                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:C08D                 </span><span style="color:navy">call    </span>ScanPathChar
<span style="color:black">DOSCODE:C090                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:C092                 </span><span style="color:navy">jnz     short loc_C097
</span><span style="color:black">DOSCODE:C094
DOSCODE:C094 </span><span style="color:navy">loc_C094:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C094                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:C095                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:C097
DOSCODE:C097 </span><span style="color:navy">loc_C097:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C097                 </span><span style="color:navy">pop     bp
</span><span style="color:black">DOSCODE:C098                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:C099                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:C09A                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:C09B                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:C09C                 </span><span style="color:navy">lahf
</span><span style="color:black">DOSCODE:C09D                 </span><span style="color:navy">add     sp, </span><span style="color:green">0Eh
</span><span style="color:black">DOSCODE:C0A0                 </span><span style="color:navy">call    </span>StrLen
<span style="color:black">DOSCODE:C0A3                 </span><span style="color:navy">dec     cx
</span><span style="color:black">DOSCODE:C0A4                 </span><span style="color:navy">sahf
</span><span style="color:black">DOSCODE:C0A5                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C0A5 </span><span style="color:navy">sub_C018        </span><span style="color:black">endp
DOSCODE:C0A5
DOSCODE:C0A6
DOSCODE:C0A6 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C0A6
DOSCODE:C0A6
DOSCODE:C0A6 </span>Splice          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C0A6                 </span><span style="color:navy">test    ss:</span>SPLICES<span style="color:navy">, </span><span style="color:green">0FFh
</span><span style="color:black">DOSCODE:C0AC                 </span><span style="color:navy">jz      short </span><span style="color:gray">AllDone
</span><span style="color:black">DOSCODE:C0AE                 </span><span style="color:navy">push    word ptr ss:</span>THISCDS
<span style="color:black">DOSCODE:C0B3                 </span><span style="color:navy">push    word ptr ss:</span>THISCDS<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:C0B8                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:C0B9                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:C0BA                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:C0BB                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:C0BC                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:C0BE
DOSCODE:C0BE </span><span style="color:gray">SpliceScan</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C0BE                 </span><span style="color:navy">call    </span>GetCDSFromDrv
<span style="color:black">DOSCODE:C0C1                 </span><span style="color:navy">jb      short </span><span style="color:gray">SpliceDone
</span><span style="color:black">DOSCODE:C0C3                 </span><span style="color:navy">inc     al
</span><span style="color:black">DOSCODE:C0C5                 </span><span style="color:navy">test    word ptr [si+</span><span style="color:#ff8000">43h</span><span style="color:navy">], </span><span style="color:green">2000h
</span><span style="color:black">DOSCODE:C0CA                 </span><span style="color:navy">jz      short </span><span style="color:gray">SpliceScan
</span><span style="color:black">DOSCODE:C0CC                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:C0CD                 </span><span style="color:navy">call    </span>PathPref
<span style="color:black">DOSCODE:C0D0                 </span><span style="color:navy">jz      short </span><span style="color:gray">SpliceFound
</span><span style="color:black">DOSCODE:C0D2
DOSCODE:C0D2 </span><span style="color:gray">SpliceSkip</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C0D2                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:C0D3                 </span><span style="color:navy">jmp     short </span><span style="color:gray">SpliceScan
</span><span style="color:black">DOSCODE:C0D5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:C0D5
DOSCODE:C0D5 </span><span style="color:gray">SpliceFound</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C0D5                 </span><span style="color:navy">cmp     byte ptr es:[di], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:C0D9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SpliceDo
</span><span style="color:black">DOSCODE:C0DB                 </span><span style="color:navy">test    ss:</span>NoSetDir<span style="color:navy">, </span><span style="color:green">0FFh
</span><span style="color:black">DOSCODE:C0E1                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SpliceSkip
</span><span style="color:black">DOSCODE:C0E3
DOSCODE:C0E3 </span><span style="color:gray">SpliceDo</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C0E3                 </span><span style="color:navy">mov     si, di
</span><span style="color:black">DOSCODE:C0E5                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:C0E6                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:C0E7                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:C0E8                 </span><span style="color:navy">call    </span>TextFromDrive1
<span style="color:black">DOSCODE:C0EB                 </span><span style="color:navy">mov     ax, ss:</span>CURR_DIR_END
<span style="color:black">DOSCODE:C0EF                 </span><span style="color:navy">or      ax, ax
</span><span style="color:black">DOSCODE:C0F1                 </span><span style="color:navy">js      short </span><span style="color:gray">NoPoke
</span><span style="color:black">DOSCODE:C0F3                 </span><span style="color:navy">add     ax, di
</span><span style="color:black">DOSCODE:C0F5                 </span><span style="color:navy">sub     ax, si
</span><span style="color:black">DOSCODE:C0F7                 </span><span style="color:navy">mov     ss:</span>CURR_DIR_END<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:C0FB
DOSCODE:C0FB </span><span style="color:gray">NoPoke</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C0FB                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:C0FE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">SpliceCopy
</span><span style="color:black">DOSCODE:C100                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">5Ch </span><span style="color:gray">; &#039;\&#039;
</span><span style="color:black">DOSCODE:C102                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:C103
DOSCODE:C103 </span><span style="color:gray">SpliceCopy</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C103                 </span><span style="color:navy">call    </span>FStrCpy
<span style="color:black">DOSCODE:C106                 </span><span style="color:navy">add     sp, </span><span style="color:green">4
</span><span style="color:black">DOSCODE:C109                 </span><span style="color:navy">or      cl, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:C10C                 </span><span style="color:navy">jmp     short </span><span style="color:gray">DoSet
</span><span style="color:black">DOSCODE:C10E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:C10E
DOSCODE:C10E </span><span style="color:gray">SpliceDone</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C10E                 </span><span style="color:navy">pop     word ptr ss:</span>THISCDS<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:black">DOSCODE:C113                 </span><span style="color:navy">pop     word ptr ss:</span>THISCDS
<span style="color:black">DOSCODE:C118
DOSCODE:C118 </span><span style="color:gray">AllDone</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C118                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:C11A
DOSCODE:C11A </span><span style="color:gray">DoSet</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C11A                 </span><span style="color:navy">lds     si, ss:</span>THISCDS
<span style="color:black">DOSCODE:C11F                 </span><span style="color:navy">les     di, [si+</span><span style="color:#ff8000">45h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C122                 </span><span style="color:navy">mov     word ptr ss:</span>THISDPB<span style="color:navy">, di
</span><span style="color:black">DOSCODE:C127                 </span><span style="color:navy">mov     word ptr ss:</span>THISDPB<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:C127 </span>Splice          <span style="color:black">endp
DOSCODE:C127
DOSCODE:C12C
DOSCODE:C12C </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C12C
DOSCODE:C12C
DOSCODE:C12C </span>DrvFromTxt_ret  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C12C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C12C </span>DrvFromTxt_ret  <span style="color:black">endp
DOSCODE:C12C
</span><span style="color:maroon">DOSCODE:C12D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C12D
DOSCODE:C12D </span>$NameTrans<span style="color:navy">:                             </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:C12D                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:C12E                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:C12F                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:C130                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:C131                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:C132                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">16h
</span><span style="color:maroon">DOSCODE:C134                 </span><span style="color:navy">call    </span>SetAttrib
<span style="color:maroon">DOSCODE:C137                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">3BEh
</span><span style="color:maroon">DOSCODE:C13A                 </span><span style="color:navy">call    </span>TransPath
<span style="color:maroon">DOSCODE:C13D                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:C13E                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:C13F                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:C140                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:C141                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:C142                 </span><span style="color:navy">jnb     short loc_C147
</span><span style="color:maroon">DOSCODE:C144                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:maroon">DOSCODE:C147 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C147
DOSCODE:C147 </span><span style="color:navy">loc_C147:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C147                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">3BEh
</span><span style="color:maroon">DOSCODE:C14A                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:C14B                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:C14C                 </span><span style="color:navy">call    </span>FStrCpy
<span style="color:maroon">DOSCODE:C14F                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:black">DOSCODE:C152
DOSCODE:C152 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C152
DOSCODE:C152
DOSCODE:C152 </span>DriveFromText   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C152                 </span><span style="color:navy">xor     al, al          </span>; 0
<span style="color:black">DOSCODE:C154                 </span><span style="color:navy">cmp     byte ptr [si], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:C157                 </span><span style="color:navy">jz      short </span>DrvFromTxt_ret
<span style="color:black">DOSCODE:C159                 </span><span style="color:navy">cmp     byte ptr [si+</span><span style="color:#ff8000">1</span><span style="color:navy">], </span><span style="color:#ff8000">3Ah </span><span style="color:gray">; &#039;:&#039;
</span><span style="color:black">DOSCODE:C15D                 </span><span style="color:navy">jnz     short </span>DrvFromTxt_ret
<span style="color:black">DOSCODE:C15F                 </span><span style="color:navy">lodsw
</span><span style="color:black">DOSCODE:C160                 </span><span style="color:navy">or      al, </span><span style="color:green">20h         </span>; to lowercase
<span style="color:black">DOSCODE:C162                 </span><span style="color:navy">sub     al, </span><span style="color:green">60h
</span><span style="color:black">DOSCODE:C164                 </span><span style="color:navy">jnz     short </span>DrvFromTxt_ret ; al = drv number
<span style="color:black">DOSCODE:C166                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:C168                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C168 </span>DriveFromText   <span style="color:black">endp
DOSCODE:C168
DOSCODE:C169
DOSCODE:C169 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C169
DOSCODE:C169
DOSCODE:C169 </span>TextFromDrive   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C169                 </span><span style="color:navy">inc     al
</span><span style="color:black">DOSCODE:C16B
DOSCODE:C16B </span>TextFromDrive1<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C16B                 </span><span style="color:navy">add     al, </span><span style="color:#ff8000">40h </span><span style="color:gray">; &#039;@&#039;   </span>; &#039;A&#039;-1
<span style="color:black">DOSCODE:C16D                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">3Ah </span><span style="color:gray">; &#039;:&#039;
</span><span style="color:black">DOSCODE:C16F                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:C170
DOSCODE:C170 </span>PathPref_retn<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C170                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C170 </span>TextFromDrive   <span style="color:black">endp
DOSCODE:C170
DOSCODE:C171
DOSCODE:C171 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C171
DOSCODE:C171
DOSCODE:C171 </span>PathPref        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C171                 </span><span style="color:navy">call    </span>DStrLen
<span style="color:black">DOSCODE:C174                 </span><span style="color:navy">dec     cx
</span><span style="color:black">DOSCODE:C175                 </span><span style="color:navy">repe cmpsb
</span><span style="color:black">DOSCODE:C177                 </span><span style="color:navy">jnz     short </span>PathPref_retn
<span style="color:black">DOSCODE:C179                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:C17A                 </span><span style="color:navy">mov     al, [si-</span><span style="color:green">1</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C17D                 </span><span style="color:navy">call    </span>PATHCHRCMP
<span style="color:black">DOSCODE:C180                 </span><span style="color:navy">jz      short </span><span style="color:gray">Prefix
</span><span style="color:black">DOSCODE:C182                 </span><span style="color:navy">mov     al, es:[di]
</span><span style="color:black">DOSCODE:C185                 </span><span style="color:navy">call    </span>PathSepGotCh
<span style="color:black">DOSCODE:C188
DOSCODE:C188 </span><span style="color:gray">Prefix</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C188                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:C189                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C189 </span>PathPref        <span style="color:black">endp
DOSCODE:C189
DOSCODE:C18A
DOSCODE:C18A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C18A
DOSCODE:C18A
DOSCODE:C18A </span>ScanPathChar    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C18A                 </span><span style="color:navy">lodsb
</span><span style="color:black">DOSCODE:C18B                 </span><span style="color:navy">call    </span>PathSepGotCh
<span style="color:black">DOSCODE:C18E                 </span><span style="color:navy">jnz     short </span>ScanPathChar
<span style="color:black">DOSCODE:C190                 </span><span style="color:navy">call    </span>PATHCHRCMP
<span style="color:black">DOSCODE:C193                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C193 </span>ScanPathChar    <span style="color:black">endp
DOSCODE:C193
DOSCODE:C194
DOSCODE:C194 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C194
DOSCODE:C194
DOSCODE:C194 </span>$OPEN           <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C194                 </span><span style="color:navy">xor     ah, ah
</span><span style="color:black">DOSCODE:C196
DOSCODE:C196 </span>$Open2<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C196                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">16h         </span>; attr_hidden+attr_system+attr_directory
<span style="color:black">DOSCODE:C198                 </span><span style="color:navy">call    </span>SetAttrib
<span style="color:black">DOSCODE:C19B                 </span><span style="color:navy">mov     cx, offset </span>DOS_OPEN
<span style="color:black">DOSCODE:C19E                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:C19F
DOSCODE:C19F </span>AccessFile<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C19F                 </span><span style="color:navy">call    </span>ECritDisk
<span style="color:black">DOSCODE:C1A2                 </span><span style="color:navy">call    </span>SFNFree
<span style="color:black">DOSCODE:C1A5                 </span><span style="color:navy">call    </span>LCritDisk
<span style="color:black">DOSCODE:C1A8                 </span><span style="color:navy">jb      short </span>OpenFailJ
<span style="color:black">DOSCODE:C1AA                 </span><span style="color:navy">mov     ss:</span>SFN<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:C1AF                 </span><span style="color:navy">mov     word ptr ss:</span>THISSFT<span style="color:navy">, di
</span><span style="color:black">DOSCODE:C1B4                 </span><span style="color:navy">mov     word ptr ss:</span>THISSFT<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:C1B9                 </span><span style="color:navy">call    </span>JFNFree
<span style="color:black">DOSCODE:C1BC
DOSCODE:C1BC </span>OpenFailJ<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C1BC                 </span><span style="color:navy">jb      short </span><span style="color:gray">OpenFail
</span><span style="color:black">DOSCODE:C1BE
DOSCODE:C1BE </span>SaveJFN<span style="color:navy">:
</span><span style="color:black">DOSCODE:C1BE                 </span><span style="color:navy">mov     word ptr ss:</span>PJFN<span style="color:navy">, di
</span><span style="color:black">DOSCODE:C1C3                 </span><span style="color:navy">mov     word ptr ss:</span>PJFN<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:C1C8                 </span><span style="color:navy">mov     ss:</span>JFN<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:C1CD                 </span><span style="color:navy">mov     bx, ss:</span>SFN
<span style="color:black">DOSCODE:C1D2                 </span><span style="color:navy">mov     si, dx
</span><span style="color:black">DOSCODE:C1D4                 </span><span style="color:navy">mov     es:[di], bl
</span><span style="color:black">DOSCODE:C1D7                 </span><span style="color:navy">mov     di, offset </span>OPENBUF
<span style="color:black">DOSCODE:C1DA                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:C1DB                 </span><span style="color:navy">call    </span>TransPath
<span style="color:black">DOSCODE:C1DE                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:C1DF                 </span><span style="color:navy">lds     si, ss:</span>THISSFT
<span style="color:black">DOSCODE:C1E4                 </span><span style="color:navy">jb      short </span><span style="color:gray">OpenCleanJ
</span><span style="color:black">DOSCODE:C1E6                 </span><span style="color:navy">cmp     ss:</span>CMETA<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:C1EC                 </span><span style="color:navy">jz      short loc_C1F6
</span><span style="color:black">DOSCODE:C1EE                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:C1F0                 </span><span style="color:navy">jmp     short </span><span style="color:gray">OpenCleanJ
</span><span style="color:black">DOSCODE:C1F2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:C1F2
DOSCODE:C1F2 </span><span style="color:gray">OpenFail</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C1F2                 </span><span style="color:navy">sti
</span><span style="color:black">DOSCODE:C1F3                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:C1F4                 </span><span style="color:navy">jmp     short </span><span style="color:gray">OpenCritLeave
</span><span style="color:black">DOSCODE:C1F6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:C1F6
DOSCODE:C1F6 </span><span style="color:navy">loc_C1F6:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C1F6                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:C1F7                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:C1F9                 </span><span style="color:navy">cmp     bx, offset </span>DOS_OPEN
<span style="color:black">DOSCODE:C1FD                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], cx
</span><span style="color:black">DOSCODE:C200                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">33h</span><span style="color:navy">], cx
</span><span style="color:black">DOSCODE:C203                 </span><span style="color:navy">jnz     short loc_C20E
</span><span style="color:black">DOSCODE:C205                 </span><span style="color:navy">test    al, </span><span style="color:green">80h
</span><span style="color:black">DOSCODE:C207                 </span><span style="color:navy">jz      short loc_C20E
</span><span style="color:black">DOSCODE:C209                 </span><span style="color:navy">and     al, </span><span style="color:green">7Fh
</span><span style="color:black">DOSCODE:C20B                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1000h       </span>; bit 15 = 1 -&gt; remote file
<span style="color:black">DOSCODE:C20E
DOSCODE:C20E </span><span style="color:navy">loc_C20E:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C20E                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:C20F                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:C210                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:C211                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:C212                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:C213                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:C214                 </span><span style="color:navy">call    </span>Set_EXT_mode
<span style="color:black">DOSCODE:C217                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:C218                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:C219                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:C21A                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:C21B                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:C21C                 </span><span style="color:navy">call    bx              </span>; DOS_OPEN (or DOS_CREATE)
<span style="color:black">DOSCODE:C21E                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:C21F                 </span><span style="color:navy">lds     si, ds:</span>THISSFT
<span style="color:black">DOSCODE:C223                 </span><span style="color:navy">jb      short </span><span style="color:gray">OpenE2
</span><span style="color:black">DOSCODE:C225                 </span><span style="color:navy">mov     word ptr [si], </span><span style="color:#ff8000">1 </span>; SF_ENTRY.sf_ref_count
<span style="color:black">DOSCODE:C229                 </span><span style="color:navy">or      [si+</span><span style="color:#ff8000">5</span><span style="color:navy">], cx      </span>; SF_ENTRY.sf_flags
<span style="color:black">DOSCODE:C22C                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:C22D                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:C22E                 </span><span style="color:navy">mov     di, si
</span><span style="color:black">DOSCODE:C230                 </span><span style="color:navy">call    </span>set_sftfcb_entry ; set SFT-FCB entry
<span style="color:black">DOSCODE:C230                                         </span>; in the internal (SFT_FCB) table
<span style="color:black">DOSCODE:C230                                         </span>; (used for FCB calls only!)
<span style="color:black">DOSCODE:C233                 </span><span style="color:navy">mov     ax, ss:</span>JFN
<span style="color:black">DOSCODE:C237                 </span><span style="color:navy">call    ss:</span>ShCol        ; Call far [ss:JShare+(12*4)] ; 12 = ShCol
<span style="color:black">DOSCODE:C23C                 </span><span style="color:navy">mov     ss:</span>SFN<span style="color:navy">, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:C243                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:black">DOSCODE:C246 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:C246
DOSCODE:C246 </span><span style="color:gray">OpenE2</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C246                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">87          </span>; error_invalid_parameter
<span style="color:black">DOSCODE:C249                 </span><span style="color:navy">jnz     short </span><span style="color:gray">OpenE
</span><span style="color:black">DOSCODE:C24B                 </span><span style="color:navy">jmp     short </span><span style="color:gray">OpenCritLeave
</span><span style="color:black">DOSCODE:C24D </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:C24D
DOSCODE:C24D </span><span style="color:gray">OpenCleanJ</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C24D                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:C24E
DOSCODE:C24E </span><span style="color:gray">OpenE</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C24E                 </span><span style="color:navy">mov     word ptr [si], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:C252                 </span><span style="color:navy">lds     si, ss:</span>PJFN
<span style="color:black">DOSCODE:C257                 </span><span style="color:navy">mov     byte ptr [si], </span><span style="color:#ff8000">0FFh
</span><span style="color:black">DOSCODE:C25A
DOSCODE:C25A </span><span style="color:gray">OpenCritLeave</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C25A                 </span><span style="color:navy">mov     ss:</span>SFN<span style="color:navy">, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:C261                 </span><span style="color:navy">cmp     ss:</span>EXTERR<span style="color:navy">, </span><span style="color:green">37   </span>; error_Code_Page_Mismatched
<span style="color:black">DOSCODE:C267                 </span><span style="color:navy">jnz     short </span>NORERR
<span style="color:black">DOSCODE:C269                 </span><span style="color:navy">jmp     </span>From_GetSet
<span style="color:black">DOSCODE:C26C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:C26C
DOSCODE:C26C </span>NORERR<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C26C                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:black">DOSCODE:C26C </span>$OPEN           <span style="color:black">endp
DOSCODE:C26C
DOSCODE:C26F
DOSCODE:C26F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C26F
DOSCODE:C26F
DOSCODE:C26F </span>$CREAT          <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C26F                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:C270                 </span><span style="color:navy">mov     cx, offset </span>DOS_CREATE
<span style="color:black">DOSCODE:C270 </span>$CREAT          <span style="color:black">endp
DOSCODE:C270
DOSCODE:C273 </span><span style="color:gray">; START OF FUNCTION CHUNK FOR $CreateNewFile
</span><span style="color:black">DOSCODE:C273
DOSCODE:C273 </span><span style="color:gray">AccessSet</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C273                 </span><span style="color:navy">mov     ss:</span>SATTRIB<span style="color:navy">, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:C279                 </span><span style="color:navy">jmp     </span>AccessFile
<span style="color:black">DOSCODE:C279 </span><span style="color:gray">; END OF FUNCTION CHUNK FOR $CreateNewFile
</span><span style="color:maroon">DOSCODE:C27C </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C27C
DOSCODE:C27C </span>$CHMOD<span style="color:navy">:                                 </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:C27C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0FFh        </span>; MS-DOS 7.20 (Win98) - EXTENDED-LENGTH FILENAME OPERATIONS
<span style="color:maroon">DOSCODE:C27C                                         </span>; AX = 43FFh
<span style="color:maroon">DOSCODE:C27C                                         </span>; BP = 5053h (&#039;PS&#039;)
<span style="color:maroon">DOSCODE:C27C                                         </span>; CL = function
<span style="color:maroon">DOSCODE:C27C                                         </span>; 39h &quot;mkdir&quot; create directory
<span style="color:maroon">DOSCODE:C27C                                         </span>; DS:DX -&gt; ASCIZ pathname
<span style="color:maroon">DOSCODE:C27C                                         </span>; 56h rename file
<span style="color:maroon">DOSCODE:C27C                                         </span>; DS:DX -&gt; ASCIZ filename of existing file (no wildcards)
<span style="color:maroon">DOSCODE:C27C                                         </span>; ES:DI -&gt; ASCIZ new filename (no wildcards)
<span style="color:maroon">DOSCODE:C27C                                         </span>;
<span style="color:maroon">DOSCODE:C27C                                         </span>; ref: Ralf Brown&#039;s Interrupt List
<span style="color:maroon">DOSCODE:C27E                 </span><span style="color:navy">jnz     short </span>std_chmod
<span style="color:maroon">DOSCODE:C280                 </span><span style="color:navy">cmp     bp, </span><span style="color:#ff8000">5053h
</span><span style="color:maroon">DOSCODE:C284                 </span><span style="color:navy">jnz     short </span>chmod_x_2
<span style="color:maroon">DOSCODE:C286                 </span><span style="color:navy">mov     ah, cl
</span><span style="color:maroon">DOSCODE:C288                 </span><span style="color:navy">mov     ss:</span>PATHNAMELEN<span style="color:navy">, </span><span style="color:green">128 </span>; ((mov byte [ss:PATHNAMELEN],128)) ; Retro DOS v5.0
<span style="color:maroon">DOSCODE:C28F                 </span><span style="color:navy">cmp     cl, </span><span style="color:green">39h
</span><span style="color:maroon">DOSCODE:C292                 </span><span style="color:navy">jnz     short </span>chmod_x_1
<span style="color:maroon">DOSCODE:C294                 </span><span style="color:navy">jmp     </span>mkdir_x
<span style="color:maroon">DOSCODE:C297 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C297
DOSCODE:C297 </span>chmod_x_1<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C297                 </span><span style="color:navy">cmp     cl, </span><span style="color:green">56h
</span><span style="color:maroon">DOSCODE:C29A                 </span><span style="color:navy">jz      short </span>rename_x
<span style="color:maroon">DOSCODE:C29C
DOSCODE:C29C </span>chmod_x_2<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C29C                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:C29E                 </span><span style="color:navy">jmp     short </span>NORERR
<span style="color:maroon">DOSCODE:C2A0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C2A0
DOSCODE:C2A0 </span>std_chmod<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C2A0                 </span><span style="color:navy">mov     di, offset </span>OPENBUF
<span style="color:maroon">DOSCODE:C2A3                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:C2A4                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:C2A5                 </span><span style="color:navy">mov     si, dx
</span><span style="color:maroon">DOSCODE:C2A7                 </span><span style="color:navy">call    </span>TransPathSet
<span style="color:maroon">DOSCODE:C2AA                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:C2AB                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:C2AC                 </span><span style="color:navy">jb      short </span>NotFound
<span style="color:maroon">DOSCODE:C2AE                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:C2AF                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:C2B0                 </span><span style="color:navy">cmp     ds:</span>CMETA<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:C2B5                 </span><span style="color:navy">jnz     short </span>NotFound
<span style="color:maroon">DOSCODE:C2B7                 </span><span style="color:navy">mov     ds:</span>SATTRIB<span style="color:navy">, </span><span style="color:#ff8000">16h
</span><span style="color:maroon">DOSCODE:C2BC                 </span><span style="color:navy">sub     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:C2BE                 </span><span style="color:navy">jb      short loc_C2C9
</span><span style="color:maroon">DOSCODE:C2C0                 </span><span style="color:navy">jz      short loc_C2D7
</span><span style="color:maroon">DOSCODE:C2C2                 </span><span style="color:navy">call    </span>set_exerr_locus_unk
<span style="color:maroon">DOSCODE:C2C5                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:C2C7
DOSCODE:C2C7 </span><span style="color:navy">loc_C2C7:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C2C7                 </span><span style="color:navy">jmp     short </span>NORERR
<span style="color:maroon">DOSCODE:C2C9 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C2C9
DOSCODE:C2C9 </span><span style="color:navy">loc_C2C9:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C2C9                 </span><span style="color:navy">call    </span>GET_FILE_INFO
<span style="color:maroon">DOSCODE:C2CC                 </span><span style="color:navy">jb      short loc_C2E2
</span><span style="color:maroon">DOSCODE:C2CE                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:C2D1                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:C2D4
DOSCODE:C2D4 </span><span style="color:navy">loc_C2D4:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C2D4                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:C2D7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C2D7
DOSCODE:C2D7 </span><span style="color:navy">loc_C2D7:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C2D7                 </span><span style="color:navy">mov     ax, cx
</span><span style="color:maroon">DOSCODE:C2D9                 </span><span style="color:navy">call    </span>SET_FILE_ATTRIBUTE
<span style="color:maroon">DOSCODE:C2DC                 </span><span style="color:navy">jb      short loc_C2E2
</span><span style="color:maroon">DOSCODE:C2DE                 </span><span style="color:navy">jmp     short </span>UnLinkOK
<span style="color:maroon">DOSCODE:C2E0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C2E0
DOSCODE:C2E0 </span>NotFound<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C2E0                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">3
</span><span style="color:maroon">DOSCODE:C2E2
DOSCODE:C2E2 </span><span style="color:navy">loc_C2E2:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C2E2                 </span><span style="color:navy">jmp     short loc_C2C7
</span><span style="color:maroon">DOSCODE:C2E4 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C2E4
DOSCODE:C2E4 </span>$UNLINK<span style="color:navy">:                                </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:C2E4                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:C2E5                 </span><span style="color:navy">mov     si, dx
</span><span style="color:maroon">DOSCODE:C2E7                 </span><span style="color:navy">mov     di, offset </span>OPENBUF
<span style="color:maroon">DOSCODE:C2EA                 </span><span style="color:navy">call    </span>TransPathSet
<span style="color:maroon">DOSCODE:C2ED                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:C2EE                 </span><span style="color:navy">jb      short </span>NotFound
<span style="color:maroon">DOSCODE:C2F0                 </span><span style="color:navy">cmp     ss:</span>CMETA<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:C2F6                 </span><span style="color:navy">jnz     short </span>NotFound
<span style="color:maroon">DOSCODE:C2F8                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:C2F9                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:C2FA                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">6
</span><span style="color:maroon">DOSCODE:C2FC                 </span><span style="color:navy">call    </span>SetAttrib
<span style="color:maroon">DOSCODE:C2FF                 </span><span style="color:navy">call    </span>DOS_DELETE
<span style="color:maroon">DOSCODE:C302
DOSCODE:C302 </span>UnlinkE<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C302                 </span><span style="color:navy">jb      short loc_C2E2
</span><span style="color:maroon">DOSCODE:C304
DOSCODE:C304 </span>UnLinkOK<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C304                 </span><span style="color:navy">jmp     short loc_C2D4
</span><span style="color:maroon">DOSCODE:C306 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C306
DOSCODE:C306 </span>$RENAME<span style="color:navy">:                                </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:C306                 </span><span style="color:navy">mov     ss:</span>PATHNAMELEN<span style="color:navy">, </span><span style="color:green">67
</span><span style="color:maroon">DOSCODE:C30D
DOSCODE:C30D </span>rename_x<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C30D                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:C30E                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:C30F                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:C310                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:C311                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:C312                 </span><span style="color:navy">mov     si, di
</span><span style="color:maroon">DOSCODE:C314                 </span><span style="color:navy">mov     di, offset </span>RENBUF
<span style="color:maroon">DOSCODE:C317                 </span><span style="color:navy">call    </span>TransPathSet
<span style="color:maroon">DOSCODE:C31A                 </span><span style="color:navy">push    ss:</span>WFP_START
<span style="color:maroon">DOSCODE:C31F                 </span><span style="color:navy">pop     ss:</span>REN_WFP
<span style="color:maroon">DOSCODE:C324                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:C325                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:C326                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:C327
DOSCODE:C327 </span>epjc2<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C327                 </span><span style="color:navy">jb      short </span>NotFound
<span style="color:maroon">DOSCODE:C329                 </span><span style="color:navy">cmp     ss:</span>CMETA<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:C32F                 </span><span style="color:navy">jnz     short </span>NotFound
<span style="color:maroon">DOSCODE:C331                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:C332                 </span><span style="color:navy">mov     di, offset </span>OPENBUF
<span style="color:maroon">DOSCODE:C335                 </span><span style="color:navy">call    </span>TransPathSet
<span style="color:maroon">DOSCODE:C338                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:C339                 </span><span style="color:navy">jb      short </span>epjc2
<span style="color:maroon">DOSCODE:C33B                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:C33C                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:C33D                 </span><span style="color:navy">cmp     ds:</span>CMETA<span style="color:navy">, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:C342                 </span><span style="color:navy">jb      short </span>NotFound
<span style="color:maroon">DOSCODE:C344                 </span><span style="color:navy">les     di, ds:</span>THISCDS
<span style="color:maroon">DOSCODE:C348                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:C349                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:C34A                 </span><span style="color:navy">mov     di, offset </span>OPENBUF
<span style="color:maroon">DOSCODE:C34D                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:C34E                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:C34F                 </span><span style="color:navy">xor     al, al
</span><span style="color:maroon">DOSCODE:C351
DOSCODE:C351 </span>rnloop<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C351                 </span><span style="color:navy">call    </span>GetCDSFromDrv
<span style="color:maroon">DOSCODE:C354                 </span><span style="color:navy">jb      short </span>dorn
<span style="color:maroon">DOSCODE:C356                 </span><span style="color:navy">call    </span>StrCmp
<span style="color:maroon">DOSCODE:C359                 </span><span style="color:navy">jz      short </span>rnerr
<span style="color:maroon">DOSCODE:C35B                 </span><span style="color:navy">inc     al
</span><span style="color:maroon">DOSCODE:C35D                 </span><span style="color:navy">jmp     short </span>rnloop
<span style="color:maroon">DOSCODE:C35F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C35F
DOSCODE:C35F </span>rnerr<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C35F                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:C360                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:C361                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">10h
</span><span style="color:maroon">DOSCODE:C363                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:maroon">DOSCODE:C366 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C366
DOSCODE:C366 </span>dorn<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C366                 </span><span style="color:navy">pop     word ptr ss:</span>THISCDS<span style="color:navy">+</span><span style="color:green">2
</span><span style="color:maroon">DOSCODE:C36B                 </span><span style="color:navy">pop     word ptr ss:</span>THISCDS
<span style="color:maroon">DOSCODE:C370                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:C371                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:C372                 </span><span style="color:navy">mov     ch, </span><span style="color:#ff8000">16h
</span><span style="color:maroon">DOSCODE:C374                 </span><span style="color:navy">call    </span>SetAttrib
<span style="color:maroon">DOSCODE:C377                 </span><span style="color:navy">call    </span>DOS_RENAME
<span style="color:maroon">DOSCODE:C37A                 </span><span style="color:navy">jb      short </span>UnlinkE
<span style="color:maroon">DOSCODE:C37C                 </span><span style="color:navy">jmp     short </span>UnLinkOK
<span style="color:black">DOSCODE:C37E
DOSCODE:C37E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C37E
DOSCODE:C37E
DOSCODE:C37E </span>$CreateNewFile  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C37E
DOSCODE:C37E </span><span style="color:gray">; FUNCTION CHUNK AT DOSCODE:C273 SIZE 00000009 BYTES
</span><span style="color:black">DOSCODE:C37E
DOSCODE:C37E                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:C37F                 </span><span style="color:navy">mov     cx, offset </span>DOS_Create_New
<span style="color:black">DOSCODE:C382                 </span><span style="color:navy">jmp     </span><span style="color:gray">AccessSet
</span><span style="color:black">DOSCODE:C382 </span>$CreateNewFile  <span style="color:black">endp
DOSCODE:C382
DOSCODE:C385
DOSCODE:C385 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C385
DOSCODE:C385
DOSCODE:C385 </span>BinToAscii      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C385                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:C386                 </span><span style="color:navy">xchg    ah, al
</span><span style="color:black">DOSCODE:C388                 </span><span style="color:navy">aam     </span><span style="color:green">10h
</span><span style="color:black">DOSCODE:C38A                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">4141h       </span>; &#039;AA&#039;
<span style="color:black">DOSCODE:C38D                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:C38E                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:C38F                 </span><span style="color:navy">aam     </span><span style="color:green">10h
</span><span style="color:black">DOSCODE:C391                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">4141h
</span><span style="color:black">DOSCODE:C394                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:C395                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C395 </span>BinToAscii      <span style="color:black">endp
DOSCODE:C395
</span><span style="color:maroon">DOSCODE:C396 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C396
DOSCODE:C396 </span>$CreateTempFile<span style="color:navy">:                        </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:C396                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">DOSCODE:C397                 </span><span style="color:navy">mov     bp, sp
</span><span style="color:maroon">DOSCODE:C399                 </span><span style="color:navy">sub     sp, </span><span style="color:green">10
</span><span style="color:maroon">DOSCODE:C39C                 </span><span style="color:navy">test    cx, </span><span style="color:green">0FFD8h
</span><span style="color:maroon">DOSCODE:C3A0                 </span><span style="color:navy">jz      short </span>OKatts
<span style="color:maroon">DOSCODE:C3A2                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">5
</span><span style="color:maroon">DOSCODE:C3A5                 </span><span style="color:navy">jmp     short </span>SETTMPERR
<span style="color:maroon">DOSCODE:C3A7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C3A7
DOSCODE:C3A7 </span>OKatts<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C3A7                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">0Ah</span><span style="color:navy">], cx
</span><span style="color:maroon">DOSCODE:C3AA                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">8</span><span style="color:navy">], dx
</span><span style="color:maroon">DOSCODE:C3AD                 </span><span style="color:navy">mov     word ptr [bp-</span><span style="color:green">6</span><span style="color:navy">], ds
</span><span style="color:maroon">DOSCODE:C3B0                 </span><span style="color:navy">mov     word ptr [bp-</span><span style="color:green">2</span><span style="color:navy">], ds
</span><span style="color:maroon">DOSCODE:C3B3                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:C3B4                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:C3B5                 </span><span style="color:navy">mov     di, dx
</span><span style="color:maroon">DOSCODE:C3B7                 </span><span style="color:navy">mov     cx, di
</span><span style="color:maroon">DOSCODE:C3B9                 </span><span style="color:navy">neg     cx
</span><span style="color:maroon">DOSCODE:C3BB                 </span><span style="color:navy">or      cx, cx
</span><span style="color:maroon">DOSCODE:C3BD                 </span><span style="color:navy">jnz     short loc_C3C0
</span><span style="color:maroon">DOSCODE:C3BF                 </span><span style="color:navy">dec     cx
</span><span style="color:maroon">DOSCODE:C3C0
DOSCODE:C3C0 </span><span style="color:navy">loc_C3C0:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C3C0                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">DOSCODE:C3C2                 </span><span style="color:navy">repne scasb
</span><span style="color:maroon">DOSCODE:C3C4                 </span><span style="color:navy">dec     di
</span><span style="color:maroon">DOSCODE:C3C5                 </span><span style="color:navy">mov     al, es:[di-</span><span style="color:green">1</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:C3C9                 </span><span style="color:navy">call    </span>PATHCHRCMP
<span style="color:maroon">DOSCODE:C3CC                 </span><span style="color:navy">jz      short loc_C3D1
</span><span style="color:maroon">DOSCODE:C3CE                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">5Ch </span><span style="color:gray">; &#039;\&#039;
</span><span style="color:maroon">DOSCODE:C3D0                 </span><span style="color:navy">stosb
</span><span style="color:maroon">DOSCODE:C3D1
DOSCODE:C3D1 </span><span style="color:navy">loc_C3D1:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C3D1                 </span><span style="color:navy">mov     [bp-</span><span style="color:green">4</span><span style="color:navy">], di
</span><span style="color:maroon">DOSCODE:C3D4
DOSCODE:C3D4 </span><span style="color:navy">loc_C3D4:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C3D4                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:C3D5                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:C3D6                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">DOSCODE:C3D7                 </span><span style="color:navy">call    </span>READTIME
<span style="color:maroon">DOSCODE:C3DA                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSCODE:C3DB                 </span><span style="color:navy">les     di, [bp-</span><span style="color:green">4</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:C3DE                 </span><span style="color:navy">mov     ax, cx
</span><span style="color:maroon">DOSCODE:C3E0                 </span><span style="color:navy">call    </span>BinToAscii
<span style="color:maroon">DOSCODE:C3E3                 </span><span style="color:navy">mov     ax, dx
</span><span style="color:maroon">DOSCODE:C3E5                 </span><span style="color:navy">call    </span>BinToAscii
<span style="color:maroon">DOSCODE:C3E8                 </span><span style="color:navy">xor     al, al
</span><span style="color:maroon">DOSCODE:C3EA                 </span><span style="color:navy">stosb
</span><span style="color:maroon">DOSCODE:C3EB                 </span><span style="color:navy">lds     dx, [bp-</span><span style="color:green">8</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:C3EE                 </span><span style="color:navy">mov     cx, [bp-</span><span style="color:green">0Ah</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:C3F1                 </span><span style="color:navy">push    bp
</span><span style="color:maroon">DOSCODE:C3F2                 </span><span style="color:navy">call    </span>$CreateNewFile
<span style="color:maroon">DOSCODE:C3F5                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSCODE:C3F6                 </span><span style="color:navy">jnb     short loc_C423
</span><span style="color:maroon">DOSCODE:C3F8                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">50h </span><span style="color:gray">; &#039;P&#039;
</span><span style="color:maroon">DOSCODE:C3FA                 </span><span style="color:navy">jz      short loc_C3D4
</span><span style="color:maroon">DOSCODE:C3FC                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">5
</span><span style="color:maroon">DOSCODE:C3FE                 </span><span style="color:navy">jnz     short </span>SETTMPERR
<span style="color:maroon">DOSCODE:C400                 </span><span style="color:navy">mov     al, ss:</span><span style="color:green">324h
</span><span style="color:maroon">DOSCODE:C404                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">41h </span><span style="color:gray">; &#039;A&#039;
</span><span style="color:maroon">DOSCODE:C406                 </span><span style="color:navy">jz      short </span>SETTMPERR
<span style="color:maroon">DOSCODE:C408                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">53h </span><span style="color:gray">; &#039;S&#039;
</span><span style="color:maroon">DOSCODE:C40A                 </span><span style="color:navy">jz      short </span>SETTMPERR
<span style="color:maroon">DOSCODE:C40C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">50h </span><span style="color:gray">; &#039;P&#039;
</span><span style="color:maroon">DOSCODE:C40E                 </span><span style="color:navy">jz      short loc_C3D4
</span><span style="color:maroon">DOSCODE:C410                 </span><span style="color:navy">les     di, ss:</span><span style="color:green">5A2h
</span><span style="color:maroon">DOSCODE:C415                 </span><span style="color:navy">cmp     di, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:C418                 </span><span style="color:navy">jz      short loc_C3D4
</span><span style="color:maroon">DOSCODE:C41A                 </span><span style="color:navy">test    word ptr es:[di+</span><span style="color:#ff8000">43h</span><span style="color:navy">], </span><span style="color:green">8000h
</span><span style="color:maroon">DOSCODE:C420                 </span><span style="color:navy">jnz     short loc_C3D4
</span><span style="color:maroon">DOSCODE:C422
DOSCODE:C422 </span>SETTMPERR<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C422                 </span><span style="color:navy">stc
</span><span style="color:maroon">DOSCODE:C423
DOSCODE:C423 </span><span style="color:navy">loc_C423:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C423                 </span><span style="color:navy">mov     sp, bp
</span><span style="color:maroon">DOSCODE:C425                 </span><span style="color:navy">pop     bp
</span><span style="color:maroon">DOSCODE:C426                 </span><span style="color:navy">jb      short </span>CreateFail
<span style="color:maroon">DOSCODE:C428                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:C42B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C42B
DOSCODE:C42B </span>CreateFail<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C42B                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:black">DOSCODE:C42E
DOSCODE:C42E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C42E
DOSCODE:C42E
DOSCODE:C42E </span>SetAttrib       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C42E                 </span><span style="color:navy">cmp     byte ptr ss:</span><span style="color:green">572h</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:C434                 </span><span style="color:navy">jnz     short loc_C438
</span><span style="color:black">DOSCODE:C436                 </span><span style="color:navy">mov     cl, ch
</span><span style="color:black">DOSCODE:C438
DOSCODE:C438 </span><span style="color:navy">loc_C438:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C438                 </span><span style="color:navy">mov     ss:</span><span style="color:green">56Dh</span><span style="color:navy">, cl
</span><span style="color:black">DOSCODE:C43D                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C43D </span>SetAttrib       <span style="color:black">endp
DOSCODE:C43D
</span><span style="color:maroon">DOSCODE:C43E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C43E
DOSCODE:C43E </span>$Extended_Open<span style="color:navy">:                         </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:C43E                 </span><span style="color:navy">mov     ss:</span>EXTOPEN_FLAG<span style="color:navy">, dx
</span><span style="color:maroon">DOSCODE:C443                 </span><span style="color:navy">mov     ss:</span>EXTOPEN_IO_MODE<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:C44A                 </span><span style="color:navy">test    dh, </span><span style="color:green">0FEh
</span><span style="color:maroon">DOSCODE:C44D                 </span><span style="color:navy">jnz     short </span>ext_inval2
<span style="color:maroon">DOSCODE:C44F                 </span><span style="color:navy">mov     ah, dl
</span><span style="color:maroon">DOSCODE:C451                 </span><span style="color:navy">cmp     dl, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:C454                 </span><span style="color:navy">jz      short </span>ext_inval2
<span style="color:maroon">DOSCODE:C456                 </span><span style="color:navy">and     dl, </span><span style="color:green">0Fh
</span><span style="color:maroon">DOSCODE:C459                 </span><span style="color:navy">cmp     dl, </span><span style="color:#ff8000">2
</span><span style="color:maroon">DOSCODE:C45C                 </span><span style="color:navy">ja      short </span>ext_inval2
<span style="color:maroon">DOSCODE:C45E                 </span><span style="color:navy">and     ah, </span><span style="color:green">0F0h
</span><span style="color:maroon">DOSCODE:C461                 </span><span style="color:navy">cmp     ah, </span><span style="color:#ff8000">10h
</span><span style="color:maroon">DOSCODE:C464                 </span><span style="color:navy">ja      short </span>ext_inval2
<span style="color:maroon">DOSCODE:C466                 </span><span style="color:navy">mov     ss:</span>SAVE_ES<span style="color:navy">, es
</span><span style="color:maroon">DOSCODE:C46B                 </span><span style="color:navy">mov     ss:</span>SAVE_DI<span style="color:navy">, di
</span><span style="color:maroon">DOSCODE:C470                 </span><span style="color:navy">push    ss:</span>EXTOPEN_FLAG
<span style="color:maroon">DOSCODE:C475                 </span><span style="color:navy">pop     ss:</span>SAVE_DX
<span style="color:maroon">DOSCODE:C47A                 </span><span style="color:navy">mov     ss:</span>SAVE_CX<span style="color:navy">, cx
</span><span style="color:maroon">DOSCODE:C47F                 </span><span style="color:navy">mov     ss:</span>SAVE_BX<span style="color:navy">, bx
</span><span style="color:maroon">DOSCODE:C484                 </span><span style="color:navy">mov     ss:</span>SAVE_DS<span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:C489                 </span><span style="color:navy">mov     ss:</span>SAVE_SI<span style="color:navy">, si
</span><span style="color:maroon">DOSCODE:C48E                 </span><span style="color:navy">mov     dx, si
</span><span style="color:maroon">DOSCODE:C490                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:maroon">DOSCODE:C492                 </span><span style="color:navy">jmp     short </span>goopen2
<span style="color:maroon">DOSCODE:C494 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C494
DOSCODE:C494 </span>ext_inval2<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C494                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:C496                 </span><span style="color:navy">jmp     short </span>CreateFail
<span style="color:maroon">DOSCODE:C498 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C498
DOSCODE:C498 </span>goopen2<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C498                 </span><span style="color:navy">test    bh, </span><span style="color:green">20h
</span><span style="color:maroon">DOSCODE:C49B                 </span><span style="color:navy">jz      short loc_C4A3
</span><span style="color:maroon">DOSCODE:C49D                 </span><span style="color:navy">or      byte ptr ss:</span><span style="color:green">5F6h</span><span style="color:navy">, </span><span style="color:green">2
</span><span style="color:maroon">DOSCODE:C4A3
DOSCODE:C4A3 </span><span style="color:navy">loc_C4A3:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C4A3                 </span><span style="color:navy">or      byte ptr ss:</span><span style="color:green">5F6h</span><span style="color:navy">, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:C4A9                 </span><span style="color:navy">mov     byte ptr ss:</span><span style="color:green">5F5h</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:C4AF                 </span><span style="color:navy">cmp     byte ptr ss:</span><span style="color:green">5F4h</span><span style="color:navy">, </span><span style="color:#ff8000">10h
</span><span style="color:maroon">DOSCODE:C4B5                 </span><span style="color:navy">jnz     short loc_C4D1
</span><span style="color:maroon">DOSCODE:C4B7                 </span><span style="color:navy">call    </span>$CreateNewFile
<span style="color:maroon">DOSCODE:C4BA                 </span><span style="color:navy">jb      short locret_C4FF
</span><span style="color:maroon">DOSCODE:C4BC                 </span><span style="color:navy">cmp     byte ptr ss:</span><span style="color:green">5F6h</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:C4C2                 </span><span style="color:navy">jz      short loc_C4CE
</span><span style="color:maroon">DOSCODE:C4C4                 </span><span style="color:navy">mov     word ptr ss:</span><span style="color:green">5F4h</span><span style="color:navy">, </span><span style="color:#ff8000">2
</span><span style="color:maroon">DOSCODE:C4CB                 </span><span style="color:navy">jmp     loc_C551
</span><span style="color:maroon">DOSCODE:C4CE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C4CE
DOSCODE:C4CE </span><span style="color:navy">loc_C4CE:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C4CE                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:C4D1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C4D1
DOSCODE:C4D1 </span><span style="color:navy">loc_C4D1:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C4D1                 </span><span style="color:navy">test    byte ptr ss:</span><span style="color:green">5F4h</span><span style="color:navy">, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:C4D7                 </span><span style="color:navy">jnz     short loc_C500
</span><span style="color:maroon">DOSCODE:C4D9                 </span><span style="color:navy">call    </span>$CREAT
<span style="color:maroon">DOSCODE:C4DC                 </span><span style="color:navy">jb      short locret_C4FF
</span><span style="color:maroon">DOSCODE:C4DE                 </span><span style="color:navy">cmp     byte ptr ss:</span><span style="color:green">5F6h</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:C4E4                 </span><span style="color:navy">jz      short loc_C4CE
</span><span style="color:maroon">DOSCODE:C4E6                 </span><span style="color:navy">mov     word ptr ss:</span><span style="color:green">5F4h</span><span style="color:navy">, </span><span style="color:#ff8000">2
</span><span style="color:maroon">DOSCODE:C4ED                 </span><span style="color:navy">test    byte ptr ss:</span><span style="color:green">5F6h</span><span style="color:navy">, </span><span style="color:green">4
</span><span style="color:maroon">DOSCODE:C4F3                 </span><span style="color:navy">jnz     short loc_C551
</span><span style="color:maroon">DOSCODE:C4F5                 </span><span style="color:navy">mov     word ptr ss:</span><span style="color:green">5F4h</span><span style="color:navy">, </span><span style="color:#ff8000">3
</span><span style="color:maroon">DOSCODE:C4FC                 </span><span style="color:navy">jmp     short loc_C551
</span><span style="color:maroon">DOSCODE:C4FE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C4FE
DOSCODE:C4FE </span><span style="color:navy">loc_C4FE:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C4FE                 </span><span style="color:navy">stc
</span><span style="color:maroon">DOSCODE:C4FF
DOSCODE:C4FF </span><span style="color:navy">locret_C4FF:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C4FF                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:C500 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C500
DOSCODE:C500 </span><span style="color:navy">loc_C500:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C500                 </span><span style="color:navy">cmp     byte ptr ss:</span><span style="color:green">572h</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:C506                 </span><span style="color:navy">jz      short loc_C50A
</span><span style="color:maroon">DOSCODE:C508                 </span><span style="color:navy">mov     cl, ch
</span><span style="color:maroon">DOSCODE:C50A
DOSCODE:C50A </span><span style="color:navy">loc_C50A:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C50A                 </span><span style="color:navy">call    </span>$Open2
<span style="color:maroon">DOSCODE:C50D                 </span><span style="color:navy">jnb     short loc_C542
</span><span style="color:maroon">DOSCODE:C50F                 </span><span style="color:navy">cmp     byte ptr ss:</span><span style="color:green">5F6h</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:C515                 </span><span style="color:navy">jz      short loc_C4FE
</span><span style="color:maroon">DOSCODE:C517                 </span><span style="color:navy">cmp     ax, </span><span style="color:#ff8000">2
</span><span style="color:maroon">DOSCODE:C51A                 </span><span style="color:navy">jnz     short loc_C4FE
</span><span style="color:maroon">DOSCODE:C51C                 </span><span style="color:navy">test    word ptr ss:</span><span style="color:green">5F4h</span><span style="color:navy">, </span><span style="color:green">10h
</span><span style="color:maroon">DOSCODE:C523                 </span><span style="color:navy">jnz     short loc_C528
</span><span style="color:maroon">DOSCODE:C525
DOSCODE:C525 </span><span style="color:navy">loc_C525:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C525                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:maroon">DOSCODE:C528 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C528
DOSCODE:C528 </span><span style="color:navy">loc_C528:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C528                 </span><span style="color:navy">mov     cx, ss:</span><span style="color:green">5FFh
</span><span style="color:maroon">DOSCODE:C52D                 </span><span style="color:navy">lds     si, ss:</span><span style="color:green">603h
</span><span style="color:maroon">DOSCODE:C532                 </span><span style="color:navy">mov     dx, si
</span><span style="color:maroon">DOSCODE:C534                 </span><span style="color:navy">call    </span>$CREAT
<span style="color:maroon">DOSCODE:C537                 </span><span style="color:navy">jb      short loc_C525
</span><span style="color:maroon">DOSCODE:C539                 </span><span style="color:navy">mov     word ptr ss:</span><span style="color:green">5F4h</span><span style="color:navy">, </span><span style="color:#ff8000">2
</span><span style="color:maroon">DOSCODE:C540                 </span><span style="color:navy">jmp     short loc_C551
</span><span style="color:maroon">DOSCODE:C542 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C542
DOSCODE:C542 </span><span style="color:navy">loc_C542:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C542                 </span><span style="color:navy">cmp     byte ptr ss:</span><span style="color:green">5F6h</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:maroon">DOSCODE:C548                 </span><span style="color:navy">jz      short loc_C55F
</span><span style="color:maroon">DOSCODE:C54A                 </span><span style="color:navy">mov     word ptr ss:</span><span style="color:green">5F4h</span><span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:C551
DOSCODE:C551 </span><span style="color:navy">loc_C551:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C551                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:C552                 </span><span style="color:navy">call    </span>Get_User_Stack
<span style="color:maroon">DOSCODE:C555                 </span><span style="color:navy">mov     ax, ss:</span><span style="color:green">5F4h
</span><span style="color:maroon">DOSCODE:C559                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:C55C                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:C55D                 </span><span style="color:navy">mov     [si], ax
</span><span style="color:maroon">DOSCODE:C55F
DOSCODE:C55F </span><span style="color:navy">loc_C55F:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C55F                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:C562 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C562
DOSCODE:C562 </span>$LockOper<span style="color:navy">:                              </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:C562                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:C564                 </span><span style="color:navy">ja      short loc_C572
</span><span style="color:maroon">DOSCODE:C566                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:C567                 </span><span style="color:navy">call    </span>SFFromHandle
<span style="color:maroon">DOSCODE:C56A                 </span><span style="color:navy">jnb     short loc_C579
</span><span style="color:maroon">DOSCODE:C56C                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:C56D                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">6
</span><span style="color:maroon">DOSCODE:C56F
DOSCODE:C56F </span><span style="color:navy">loc_C56F:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C56F                 </span><span style="color:navy">jmp     </span>SYS_RET_ERR
<span style="color:maroon">DOSCODE:C572 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C572
DOSCODE:C572 </span><span style="color:navy">loc_C572:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C572                 </span><span style="color:navy">call    </span>set_exerr_locus_unk
<span style="color:maroon">DOSCODE:C575                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:C577
DOSCODE:C577 </span><span style="color:navy">loc_C577:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C577                 </span><span style="color:navy">jmp     short loc_C56F
</span><span style="color:maroon">DOSCODE:C579 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C579
DOSCODE:C579 </span><span style="color:navy">loc_C579:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C579                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:maroon">DOSCODE:C57B                 </span><span style="color:navy">mov     bp, offset </span>Lock_Buffer
<span style="color:maroon">DOSCODE:C57E                 </span><span style="color:navy">mov     [bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], dx
</span><span style="color:maroon">DOSCODE:C581                 </span><span style="color:navy">mov     [bp+</span><span style="color:#ff8000">2</span><span style="color:navy">], cx
</span><span style="color:maroon">DOSCODE:C584                 </span><span style="color:navy">pop     word ptr [bp+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:C587                 </span><span style="color:navy">mov     [bp+</span><span style="color:#ff8000">6</span><span style="color:navy">], si
</span><span style="color:maroon">DOSCODE:C58A                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:C58D                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:C58E                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:C58F                 </span><span style="color:navy">mov     dx, bp
</span><span style="color:maroon">DOSCODE:C591                 </span><span style="color:navy">test    al, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:C593                 </span><span style="color:navy">jnz     short loc_C597
</span><span style="color:maroon">DOSCODE:C595                 </span><span style="color:navy">jmp     short loc_C5B3
</span><span style="color:maroon">DOSCODE:C597 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C597
DOSCODE:C597 </span><span style="color:navy">loc_C597:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C597                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:green">80h
</span><span style="color:maroon">DOSCODE:C59C                 </span><span style="color:navy">jz      short loc_C5A5
</span><span style="color:maroon">DOSCODE:C59E                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">110Ah
</span><span style="color:maroon">DOSCODE:C5A1                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - LOCK REGION OF FILE
<span style="color:maroon">DOSCODE:C5A1                                         </span>; BX = file handle, CX:DX = starting offset, SI = high word of size
<span style="color:maroon">DOSCODE:C5A1                                         </span>; STACK: WORD low word of size, ES:DI -&gt; SFT
<span style="color:maroon">DOSCODE:C5A1                                         </span>; SFT DPB field -&gt; DPB of drive containing file, SS = DOS CS
<span style="color:maroon">DOSCODE:C5A1                                         </span>; Return: CF set error
<span style="color:maroon">DOSCODE:C5A3                 </span><span style="color:navy">jmp     short loc_C5A9
</span><span style="color:maroon">DOSCODE:C5A5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C5A5
DOSCODE:C5A5 </span><span style="color:navy">loc_C5A5:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C5A5                 </span><span style="color:navy">call    ds:</span>clr_block
<span style="color:maroon">DOSCODE:C5A9
DOSCODE:C5A9 </span><span style="color:navy">loc_C5A9:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C5A9                 </span><span style="color:navy">jnb     short loc_C5AD
</span><span style="color:maroon">DOSCODE:C5AB                 </span><span style="color:navy">jmp     short loc_C577
</span><span style="color:maroon">DOSCODE:C5AD </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C5AD
DOSCODE:C5AD </span><span style="color:navy">loc_C5AD:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C5AD                 </span><span style="color:navy">mov     ax, ds:</span>TEMP_VAR
<span style="color:maroon">DOSCODE:C5B0                 </span><span style="color:navy">jmp     </span>SYS_RET_OK
<span style="color:maroon">DOSCODE:C5B3 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C5B3
DOSCODE:C5B3 </span><span style="color:navy">loc_C5B3:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C5B3                 </span><span style="color:navy">test    byte ptr es:[di+</span><span style="color:#ff8000">6</span><span style="color:navy">], </span><span style="color:green">80h
</span><span style="color:maroon">DOSCODE:C5B8                 </span><span style="color:navy">jz      short loc_C5C1
</span><span style="color:maroon">DOSCODE:C5BA                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">110Ah
</span><span style="color:maroon">DOSCODE:C5BD                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; Multiplex - NETWORK REDIRECTOR - LOCK REGION OF FILE
<span style="color:maroon">DOSCODE:C5BD                                         </span>; BX = file handle, CX:DX = starting offset, SI = high word of size
<span style="color:maroon">DOSCODE:C5BD                                         </span>; STACK: WORD low word of size, ES:DI -&gt; SFT
<span style="color:maroon">DOSCODE:C5BD                                         </span>; SFT DPB field -&gt; DPB of drive containing file, SS = DOS CS
<span style="color:maroon">DOSCODE:C5BD                                         </span>; Return: CF set error
<span style="color:maroon">DOSCODE:C5BF                 </span><span style="color:navy">jmp     short loc_C5A9
</span><span style="color:maroon">DOSCODE:C5C1 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C5C1
DOSCODE:C5C1 </span><span style="color:navy">loc_C5C1:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C5C1                 </span><span style="color:navy">call    ds:</span>set_block
<span style="color:maroon">DOSCODE:C5C5                 </span><span style="color:navy">jmp     short loc_C5A9
</span><span style="color:black">DOSCODE:C5C7
DOSCODE:C5C7 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C5C7
DOSCODE:C5C7
DOSCODE:C5C7 </span>LOCK_CHECK      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C5C7                 </span><span style="color:navy">mov     bx, ds:</span>RetryCount ; Number retries
<span style="color:black">DOSCODE:C5CB
DOSCODE:C5CB </span><span style="color:gray">LockRetry</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C5CB                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:C5CC                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:C5CD                 </span><span style="color:navy">call    ds:</span>chk_block    ; call far [JShare+(8*4)] ; 8 = chk_block
<span style="color:black">DOSCODE:C5D1                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:C5D2                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:C5D3                 </span><span style="color:navy">jnb     short </span>lc_ret_label ; There are no locks (retnc)
<span style="color:black">DOSCODE:C5D5                 </span><span style="color:navy">call    </span>Idle            ; wait a while
<span style="color:black">DOSCODE:C5D8                 </span><span style="color:navy">dec     bx              </span>; remember a retry
<span style="color:black">DOSCODE:C5D9                 </span><span style="color:navy">jnz     short </span><span style="color:gray">LockRetry </span>; more retries left...
<span style="color:black">DOSCODE:C5DB                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:C5DC
DOSCODE:C5DC </span>lc_ret_label<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C5DC                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C5DC </span>LOCK_CHECK      <span style="color:black">endp
DOSCODE:C5DC
DOSCODE:C5DD
DOSCODE:C5DD </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C5DD
DOSCODE:C5DD
DOSCODE:C5DD </span>LOCK_VIOLATION  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C5DD                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:C5DE                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:C5DF                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:C5E0                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:C5E1                 </span><span style="color:navy">mov     ax, </span><span style="color:green">21h         </span>; error_lock_violation
<span style="color:black">DOSCODE:C5E4                 </span><span style="color:navy">mov     ds:</span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">18h </span>; Allowed_FAIL+Allowed_RETRY
<span style="color:black">DOSCODE:C5E9                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:C5ED                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">1           </span>; Fake some registers
<span style="color:black">DOSCODE:C5F0                 </span><span style="color:navy">mov     cx, di
</span><span style="color:black">DOSCODE:C5F2                 </span><span style="color:navy">xor     dx, dx          </span>; 0
<span style="color:black">DOSCODE:C5F4                 </span><span style="color:navy">cmp     es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], dx </span>; cmp [es:bp+DPB.FAT_SIZE],dx
<span style="color:black">DOSCODE:C5F8                 </span><span style="color:navy">jnz     short </span><span style="color:gray">lockv_1
</span><span style="color:black">DOSCODE:C5FA                 </span><span style="color:navy">mov     dx, es:[bp+</span><span style="color:#ff8000">2Bh</span><span style="color:navy">] </span>; [es:bp+DPB.LAST_CLUSTER+2]
<span style="color:black">DOSCODE:C5FE                 </span><span style="color:navy">mov     ds:</span>HIGH_SECTOR<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:C602                 </span><span style="color:navy">mov     dx, es:[bp+</span><span style="color:#ff8000">29h</span><span style="color:navy">] </span>; [es:bp+DPB.LAST_CLUSTER]
<span style="color:black">DOSCODE:C606                 </span><span style="color:navy">jmp     short </span><span style="color:gray">lockv_2
</span><span style="color:black">DOSCODE:C608 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:C608
DOSCODE:C608 </span><span style="color:gray">lockv_1</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C608                 </span><span style="color:navy">mov     ds:</span>HIGH_SECTOR<span style="color:navy">, dx </span>; 0
<span style="color:black">DOSCODE:C60C                 </span><span style="color:navy">mov     dx, es:[bp+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">] </span>; [ES:BP+DPB.FIRST_SECTOR]
<span style="color:black">DOSCODE:C610
DOSCODE:C610 </span><span style="color:gray">lockv_2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C610                 </span><span style="color:navy">call    </span>HARDERR
<span style="color:black">DOSCODE:C613                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:C614                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:C615                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:C616                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:C617                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:C619                 </span><span style="color:navy">jz      short </span>lc_ret_label ; 1 = retry, carry clear
<span style="color:black">DOSCODE:C61B                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:C61C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C61C </span>LOCK_VIOLATION  <span style="color:black">endp
DOSCODE:C61C
DOSCODE:C61D
DOSCODE:C61D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C61D
DOSCODE:C61D
DOSCODE:C61D </span>CheckShare      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C61D                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:C61E                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:C623                 </span><span style="color:navy">cmp     ds:</span>fShare<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:C628                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:C629                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C629 </span>CheckShare      <span style="color:black">endp
DOSCODE:C629
DOSCODE:C62A
DOSCODE:C62A </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C62A
DOSCODE:C62A
DOSCODE:C62A </span>SHARE_CHECK     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C62A                 </span><span style="color:navy">call    ds:</span>MFT_enter    ; call far [JShare+(1*4)] ; 1 = MFT_Enter
<span style="color:black">DOSCODE:C62E
DOSCODE:C62E </span>shchk_retn<span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C62E                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C62E </span>SHARE_CHECK     <span style="color:black">endp
DOSCODE:C62E
DOSCODE:C62F
DOSCODE:C62F </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C62F
DOSCODE:C62F
DOSCODE:C62F </span>SHARE_VIOLATION <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C62F                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:C630                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:C631                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:C632                 </span><span style="color:navy">mov     ds:</span>READOP<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:C637                 </span><span style="color:navy">mov     ds:</span>ALLOWED<span style="color:navy">, </span><span style="color:#ff8000">18h
</span><span style="color:black">DOSCODE:C63C                 </span><span style="color:navy">les     bp, ds:</span>THISDPB
<span style="color:black">DOSCODE:C640                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:C643                 </span><span style="color:navy">mov     cx, di
</span><span style="color:black">DOSCODE:C645                 </span><span style="color:navy">cmp     word ptr es:[bp+</span><span style="color:#ff8000">0Fh</span><span style="color:navy">], </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:C64A                 </span><span style="color:navy">jz      short loc_C658
</span><span style="color:black">DOSCODE:C64C                 </span><span style="color:navy">mov     ds:</span>HIGH_SECTOR<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:C652                 </span><span style="color:navy">mov     dx, es:[bp+</span><span style="color:#ff8000">11h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C656                 </span><span style="color:navy">jmp     short loc_C664
</span><span style="color:black">DOSCODE:C658 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:C658
DOSCODE:C658 </span><span style="color:navy">loc_C658:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C658                 </span><span style="color:navy">mov     dx, es:[bp+</span><span style="color:#ff8000">2Bh</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C65C                 </span><span style="color:navy">mov     ds:</span>HIGH_SECTOR<span style="color:navy">, dx
</span><span style="color:black">DOSCODE:C660                 </span><span style="color:navy">mov     dx, es:[bp+</span><span style="color:#ff8000">29h</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C664
DOSCODE:C664 </span><span style="color:navy">loc_C664:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C664                 </span><span style="color:navy">call    </span>HARDERR
<span style="color:black">DOSCODE:C667                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:C668                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:C669                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:C66A                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:black">DOSCODE:C66C                 </span><span style="color:navy">jz      short </span>shchk_retn
<span style="color:black">DOSCODE:C66E                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:C66F                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C66F </span>SHARE_VIOLATION <span style="color:black">endp
DOSCODE:C66F
DOSCODE:C670
DOSCODE:C670 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C670
DOSCODE:C670
DOSCODE:C670 </span>ShareEnd        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C670                 </span><span style="color:navy">call    ds:</span>MFTClose
<span style="color:black">DOSCODE:C674                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C674 </span>ShareEnd        <span style="color:black">endp
DOSCODE:C674
DOSCODE:C675
DOSCODE:C675 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C675
DOSCODE:C675
DOSCODE:C675 </span>ShareEnter      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C675                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:C676
DOSCODE:C676 </span><span style="color:navy">loc_C676:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C676                 </span><span style="color:navy">mov     cx, ds:</span><span style="color:green">1Ah
</span><span style="color:black">DOSCODE:C67A
DOSCODE:C67A </span><span style="color:navy">loc_C67A:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C67A                 </span><span style="color:navy">les     di, ds:</span><span style="color:green">59Eh
</span><span style="color:black">DOSCODE:C67E                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:C680                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:C681                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">33h</span><span style="color:navy">], ax
</span><span style="color:black">DOSCODE:C685                 </span><span style="color:navy">call    </span>SHARE_CHECK
<span style="color:black">DOSCODE:C688                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:C689                 </span><span style="color:navy">jnb     short loc_C695
</span><span style="color:black">DOSCODE:C68B                 </span><span style="color:navy">call    </span>Idle
<span style="color:black">DOSCODE:C68E                 </span><span style="color:navy">loop    loc_C67A
</span><span style="color:black">DOSCODE:C690                 </span><span style="color:navy">call    </span>SHARE_VIOLATION
<span style="color:black">DOSCODE:C693                 </span><span style="color:navy">jnb     short loc_C676
</span><span style="color:black">DOSCODE:C695
DOSCODE:C695 </span><span style="color:navy">loc_C695:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C695                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:C696                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C696 </span>ShareEnter      <span style="color:black">endp
DOSCODE:C696
DOSCODE:C697
DOSCODE:C697 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C697
DOSCODE:C697
DOSCODE:C697 </span><span style="color:navy">sub_C697        </span><span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C697                 </span><span style="color:navy">mov     si, dx
</span><span style="color:black">DOSCODE:C699                 </span><span style="color:navy">test    word ptr [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">1
</span><span style="color:black">DOSCODE:C69E                 </span><span style="color:navy">jz      short loc_C6B8
</span><span style="color:black">DOSCODE:C6A0                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">8</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C6A3                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">10h
</span><span style="color:black">DOSCODE:C6A6                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">DOSCODE:C6A8                 </span><span style="color:navy">mov     cx, [si+</span><span style="color:#ff8000">0Ah</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C6AB                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">0Ch</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C6AE                 </span><span style="color:navy">call    word ptr ss:</span><span style="color:green">0D67h
</span><span style="color:black">DOSCODE:C6B3                 </span><span style="color:navy">call    word ptr ss:</span><span style="color:green">133Eh
</span><span style="color:black">DOSCODE:C6B8
DOSCODE:C6B8 </span><span style="color:navy">loc_C6B8:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C6B8                 </span><span style="color:navy">test    word ptr [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">2
</span><span style="color:black">DOSCODE:C6BD                 </span><span style="color:navy">jnz     short loc_C6D7
</span><span style="color:black">DOSCODE:C6BF                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:C6C0                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:C6C1                 </span><span style="color:navy">lds     si, [si+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C6C4                 </span><span style="color:navy">call    sub_B35C
</span><span style="color:black">DOSCODE:C6C7                 </span><span style="color:navy">call    sub_B370
</span><span style="color:black">DOSCODE:C6CA                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:C6CB                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:C6CC                 </span><span style="color:navy">mov     es, word ptr [si+</span><span style="color:#ff8000">8</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C6CF                 </span><span style="color:navy">mov     ax, ss:</span><span style="color:green">0EBBh
</span><span style="color:black">DOSCODE:C6D3                 </span><span style="color:navy">mov     es:</span><span style="color:green">40h</span><span style="color:navy">, ax
</span><span style="color:black">DOSCODE:C6D7
DOSCODE:C6D7 </span><span style="color:navy">loc_C6D7:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C6D7                 </span><span style="color:navy">cmp     byte ptr ss:</span><span style="color:green">0D66h</span><span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:C6DD                 </span><span style="color:navy">jz      short loc_C6FF
</span><span style="color:black">DOSCODE:C6DF                 </span><span style="color:navy">mov     ax, [si+</span><span style="color:#ff8000">8</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C6E2                 </span><span style="color:navy">or      byte ptr ss:</span><span style="color:green">86h</span><span style="color:navy">, </span><span style="color:green">4
</span><span style="color:black">DOSCODE:C6E8                 </span><span style="color:navy">test    word ptr [si+</span><span style="color:#ff8000">2</span><span style="color:navy">], </span><span style="color:green">1
</span><span style="color:black">DOSCODE:C6ED                 </span><span style="color:navy">jnz     short loc_C6F6
</span><span style="color:black">DOSCODE:C6EF                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:C6F0                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:black">DOSCODE:C6F2                 </span><span style="color:navy">call    </span>IsCopyProt
<span style="color:black">DOSCODE:C6F5                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:C6F6
DOSCODE:C6F6 </span><span style="color:navy">loc_C6F6:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C6F6                 </span><span style="color:navy">inc     byte ptr ss:</span><span style="color:green">85h
</span><span style="color:black">DOSCODE:C6FB                 </span><span style="color:navy">mov     ss:</span><span style="color:green">63h</span><span style="color:navy">, ax
</span><span style="color:black">DOSCODE:C6FF
DOSCODE:C6FF </span><span style="color:navy">loc_C6FF:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C6FF                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:C701                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C701 </span><span style="color:navy">sub_C697        </span><span style="color:black">endp
DOSCODE:C701
DOSCODE:C701 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:olive">DOSCODE:C702                 </span><span style="color:navy">db </span><span style="color:#008040">0FAh
</span><span style="color:olive">DOSCODE:C703                 </span><span style="color:navy">db </span><span style="color:#008040">0E4h
</span><span style="color:olive">DOSCODE:C704                 </span><span style="color:navy">db  </span><span style="color:#008040">21h </span><span style="color:gray">; !
</span><span style="color:olive">DOSCODE:C705                 </span><span style="color:navy">db  </span><span style="color:#008040">60h </span><span style="color:gray">; `
</span><span style="color:olive">DOSCODE:C706                 </span><span style="color:navy">db  </span><span style="color:#008040">33h </span><span style="color:gray">; 3
</span><span style="color:olive">DOSCODE:C707                 </span><span style="color:navy">db </span><span style="color:#008040">0C0h
</span><span style="color:olive">DOSCODE:C708                 </span><span style="color:navy">db </span><span style="color:#008040">0E6h
</span><span style="color:olive">DOSCODE:C709                 </span><span style="color:navy">db  </span><span style="color:#008040">43h </span><span style="color:gray">; C
</span><span style="color:olive">DOSCODE:C70A                 </span><span style="color:navy">db  </span><span style="color:#008040">8Bh
</span><span style="color:olive">DOSCODE:C70B                 </span><span style="color:navy">db  </span><span style="color:#008040">16h
</span><span style="color:olive">DOSCODE:C70C                 </span><span style="color:navy">db </span><span style="color:#008040">0B0h
</span><span style="color:olive">DOSCODE:C70D                 </span><span style="color:navy">db  </span><span style="color:#008040">0Eh
</span><span style="color:olive">DOSCODE:C70E                 </span><span style="color:navy">db </span><span style="color:#008040">0E6h
</span><span style="color:olive">DOSCODE:C70F                 </span><span style="color:navy">db  </span><span style="color:#008040">37h </span><span style="color:gray">; 7
</span><span style="color:olive">DOSCODE:C710                 </span><span style="color:navy">db  </span><span style="color:#008040">33h </span><span style="color:gray">; 3
</span><span style="color:olive">DOSCODE:C711                 </span><span style="color:navy">db </span><span style="color:#008040">0C0h
</span><span style="color:olive">DOSCODE:C712                 </span><span style="color:navy">db </span><span style="color:#008040">0E6h
</span><span style="color:olive">DOSCODE:C713                 </span><span style="color:navy">db </span><span style="color:#008040">0F2h
</span><span style="color:olive">DOSCODE:C714                 </span><span style="color:navy">db  </span><span style="color:#008040">0Fh
</span><span style="color:olive">DOSCODE:C715                 </span><span style="color:navy">db  </span><span style="color:#008040">20h
</span><span style="color:olive">DOSCODE:C716                 </span><span style="color:navy">db </span><span style="color:#008040">0C0h
</span><span style="color:olive">DOSCODE:C717                 </span><span style="color:navy">db  </span><span style="color:#008040">0Fh
</span><span style="color:olive">DOSCODE:C718                 </span><span style="color:navy">db  </span><span style="color:#008040">22h </span><span style="color:gray">; &quot;
</span><span style="color:olive">DOSCODE:C719                 </span><span style="color:navy">db </span><span style="color:#008040">0C0h
</span><span style="color:olive">DOSCODE:C71A                 </span><span style="color:navy">db </span><span style="color:#008040">0EAh
</span><span style="color:olive">DOSCODE:C71B                 </span><span style="color:navy">db  </span><span style="color:#008040">66h </span><span style="color:gray">; f
</span><span style="color:olive">DOSCODE:C71C                 </span><span style="color:navy">db  </span><span style="color:#008040">50h </span><span style="color:gray">; P
</span><span style="color:olive">DOSCODE:C71D                 </span><span style="color:navy">db  </span><span style="color:#008040">51h </span><span style="color:gray">; Q
</span><span style="color:olive">DOSCODE:C71E                 </span><span style="color:navy">db  </span><span style="color:#008040">0Fh
</span><span style="color:olive">DOSCODE:C71F                 </span><span style="color:navy">db  </span><span style="color:#008040">20h
</span><span style="color:olive">DOSCODE:C720                 </span><span style="color:navy">db </span><span style="color:#008040">0C0h
</span><span style="color:olive">DOSCODE:C721                 </span><span style="color:navy">db  </span><span style="color:#008040">8Eh
</span><span style="color:olive">DOSCODE:C722                 </span><span style="color:navy">db </span><span style="color:#008040">0D3h
</span><span style="color:olive">DOSCODE:C723                 </span><span style="color:navy">db  </span><span style="color:#008040">59h </span><span style="color:gray">; Y
</span><span style="color:olive">DOSCODE:C724                 </span><span style="color:navy">db  </span><span style="color:#008040">66h </span><span style="color:gray">; f
</span><span style="color:olive">DOSCODE:C725                 </span><span style="color:navy">db  </span><span style="color:#008040">58h </span><span style="color:gray">; X
</span><span style="color:olive">DOSCODE:C726                 </span><span style="color:navy">db  </span><span style="color:#008040">93h
</span><span style="color:olive">DOSCODE:C727                 </span><span style="color:navy">db  </span><span style="color:#008040">58h </span><span style="color:gray">; X
</span><span style="color:olive">DOSCODE:C728                 </span><span style="color:navy">db  </span><span style="color:#008040">8Bh
</span><span style="color:olive">DOSCODE:C729                 </span><span style="color:navy">db </span><span style="color:#008040">0CCh
</span><span style="color:olive">DOSCODE:C72A                 </span><span style="color:navy">db </span><span style="color:#008040">0B8h
</span><span style="color:olive">DOSCODE:C72B                 </span><span style="color:navy">db  </span><span style="color:#008040">0Ch
</span><span style="color:olive">DOSCODE:C72C                 </span><span style="color:navy">db </span><span style="color:#008040">0DEh
</span><span style="color:olive">DOSCODE:C72D                 </span><span style="color:navy">db </span><span style="color:#008040">0CDh
</span><span style="color:olive">DOSCODE:C72E                 </span><span style="color:navy">db  </span><span style="color:#008040">67h </span><span style="color:gray">; g
</span><span style="color:olive">DOSCODE:C72F                 </span><span style="color:navy">db  </span><span style="color:#008040">8Bh
</span><span style="color:olive">DOSCODE:C730                 </span><span style="color:navy">db </span><span style="color:#008040">0E1h
</span><span style="color:olive">DOSCODE:C731                 </span><span style="color:navy">db </span><span style="color:#008040">0FFh
</span><span style="color:olive">DOSCODE:C732                 </span><span style="color:navy">db </span><span style="color:#008040">0E3h
</span><span style="color:olive">DOSCODE:C733                 </span><span style="color:navy">db  </span><span style="color:#008040">93h
</span><span style="color:olive">DOSCODE:C734                 </span><span style="color:navy">db  </span><span style="color:#008040">58h </span><span style="color:gray">; X
</span><span style="color:olive">DOSCODE:C735                 </span><span style="color:navy">db  </span><span style="color:#008040">8Bh
</span><span style="color:olive">DOSCODE:C736                 </span><span style="color:navy">db </span><span style="color:#008040">0CCh
</span><span style="color:olive">DOSCODE:C737                 </span><span style="color:navy">db  </span><span style="color:#008040">2Eh </span><span style="color:gray">; .
</span><span style="color:olive">DOSCODE:C738                 </span><span style="color:navy">db  </span><span style="color:#008040">66h </span><span style="color:gray">; f
</span><span style="color:olive">DOSCODE:C739                 </span><span style="color:navy">db </span><span style="color:#008040">0A3h
</span><span style="color:olive">DOSCODE:C73A                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">DOSCODE:C73B                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">DOSCODE:C73C                 </span><span style="color:navy">db  </span><span style="color:#008040">2Eh </span><span style="color:gray">; .
</span><span style="color:olive">DOSCODE:C73D                 </span><span style="color:navy">db  </span><span style="color:#008040">66h </span><span style="color:gray">; f
</span><span style="color:olive">DOSCODE:C73E                 </span><span style="color:navy">db  </span><span style="color:#008040">89h
</span><span style="color:olive">DOSCODE:C73F                 </span><span style="color:navy">db  </span><span style="color:#008040">36h </span><span style="color:gray">; 6
</span><span style="color:olive">DOSCODE:C740                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">DOSCODE:C741                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">DOSCODE:C742                 </span><span style="color:navy">db  </span><span style="color:#008040">8Bh
</span><span style="color:olive">DOSCODE:C743                 </span><span style="color:navy">db </span><span style="color:#008040">0E1h
</span><span style="color:olive">DOSCODE:C744                 </span><span style="color:navy">db  </span><span style="color:#008040">2Eh </span><span style="color:gray">; .
</span><span style="color:olive">DOSCODE:C745                 </span><span style="color:navy">db  </span><span style="color:#008040">66h </span><span style="color:gray">; f
</span><span style="color:olive">DOSCODE:C746                 </span><span style="color:navy">db </span><span style="color:#008040">0A1h
</span><span style="color:olive">DOSCODE:C747                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">DOSCODE:C748                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">DOSCODE:C749                 </span><span style="color:navy">db  </span><span style="color:#008040">2Eh </span><span style="color:gray">; .
</span><span style="color:olive">DOSCODE:C74A                 </span><span style="color:navy">db  </span><span style="color:#008040">66h </span><span style="color:gray">; f
</span><span style="color:olive">DOSCODE:C74B                 </span><span style="color:navy">db  </span><span style="color:#008040">8Bh
</span><span style="color:olive">DOSCODE:C74C                 </span><span style="color:navy">db  </span><span style="color:#008040">36h </span><span style="color:gray">; 6
</span><span style="color:olive">DOSCODE:C74D                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">DOSCODE:C74E                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">DOSCODE:C74F                 </span><span style="color:navy">db </span><span style="color:#008040">0FFh
</span><span style="color:olive">DOSCODE:C750                 </span><span style="color:navy">db </span><span style="color:#008040">0E3h
</span><span style="color:gray">DOSCODE:C751                 </span><span style="color:navy">db </span><span style="color:#008040">0FAh</span><span style="color:navy">, </span><span style="color:#008040">52h</span><span style="color:navy">, </span><span style="color:#008040">51h
</span><span style="color:gray">DOSCODE:C754                 </span><span style="color:navy">db </span><span style="color:#008040">0B8h</span><span style="color:navy">, </span><span style="color:#008040">0Ch</span><span style="color:navy">, </span><span style="color:#008040">0DEh</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">26h</span><span style="color:navy">, </span><span style="color:#008040">0FFh</span><span style="color:navy">, </span><span style="color:#008040">1Eh
</span><span style="color:gray">DOSCODE:C75B                 </span><span style="color:navy">db </span><span style="color:#008040">59h</span><span style="color:navy">, </span><span style="color:#008040">5Ah</span><span style="color:navy">, </span><span style="color:#008040">5Bh
</span><span style="color:gray">DOSCODE:C75E                 </span><span style="color:navy">db </span><span style="color:#008040">0FAh</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">50h</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">53h</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">51h</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">52h
</span><span style="color:gray">DOSCODE:C767                 </span><span style="color:navy">db </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">5Ah</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">59h</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">5Bh</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">58h</span><span style="color:navy">, </span><span style="color:#008040">5Bh
</span><span style="color:gray">DOSCODE:C770                 </span><span style="color:navy">db </span><span style="color:#008040">60h</span><span style="color:navy">, </span><span style="color:#008040">6</span><span style="color:navy">, </span><span style="color:#008040">1Eh</span><span style="color:navy">, </span><span style="color:#008040">0B8h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">8Eh</span><span style="color:navy">, </span><span style="color:#008040">0D8h
</span><span style="color:gray">DOSCODE:C778                 </span><span style="color:navy">db </span><span style="color:#008040">1Fh</span><span style="color:navy">, </span><span style="color:#008040">7</span><span style="color:navy">, </span><span style="color:#008040">61h
</span><span style="color:gray">DOSCODE:C77B                 </span><span style="color:navy">db </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">60h</span><span style="color:navy">, </span><span style="color:#008040">6</span><span style="color:navy">, </span><span style="color:#008040">1Eh
</span><span style="color:gray">DOSCODE:C77F                 </span><span style="color:navy">db </span><span style="color:#008040">1Fh</span><span style="color:navy">, </span><span style="color:#008040">7</span><span style="color:navy">, </span><span style="color:#008040">66h</span><span style="color:navy">, </span><span style="color:#008040">61h</span><span style="color:navy">, </span><span style="color:#008040">0C3h
</span><span style="color:gray">DOSCODE:C784                 </span><span style="color:navy">dw </span><span style="color:#008040">0C714h
</span><span style="color:gray">DOSCODE:C786                 </span><span style="color:navy">dw </span><span style="color:#008040">3
</span><span style="color:gray">DOSCODE:C788                 </span><span style="color:navy">dw </span><span style="color:#008040">0C717h
</span><span style="color:gray">DOSCODE:C78A                 </span><span style="color:navy">dw </span><span style="color:#008040">4
</span><span style="color:gray">DOSCODE:C78C                 </span><span style="color:navy">dw </span><span style="color:#008040">20h
</span><span style="color:gray">DOSCODE:C78E                 </span><span style="color:navy">dw </span><span style="color:#008040">0C726h
</span><span style="color:gray">DOSCODE:C790                 </span><span style="color:navy">dw </span><span style="color:#008040">4
</span><span style="color:gray">DOSCODE:C792                 </span><span style="color:navy">dw </span><span style="color:#008040">0C72Ah
</span><span style="color:gray">DOSCODE:C794                 </span><span style="color:navy">dw </span><span style="color:#008040">9
</span><span style="color:gray">DOSCODE:C796                 </span><span style="color:navy">dw </span><span style="color:#008040">80h
</span><span style="color:gray">DOSCODE:C798                 </span><span style="color:navy">dw </span><span style="color:#008040">0C751h
</span><span style="color:gray">DOSCODE:C79A                 </span><span style="color:navy">dw </span><span style="color:#008040">3
</span><span style="color:gray">DOSCODE:C79C                 </span><span style="color:navy">dw </span><span style="color:#008040">0C754h
</span><span style="color:gray">DOSCODE:C79E                 </span><span style="color:navy">dw </span><span style="color:#008040">7
</span><span style="color:gray">DOSCODE:C7A0                 </span><span style="color:navy">dw </span><span style="color:#008040">80h
</span><span style="color:gray">DOSCODE:C7A2                 </span><span style="color:navy">dw </span><span style="color:#008040">0C770h
</span><span style="color:gray">DOSCODE:C7A4                 </span><span style="color:navy">dw </span><span style="color:#008040">4
</span><span style="color:gray">DOSCODE:C7A6                 </span><span style="color:navy">dw </span><span style="color:#008040">0C778h
</span><span style="color:gray">DOSCODE:C7A8                 </span><span style="color:navy">dw </span><span style="color:#008040">3
</span><span style="color:gray">DOSCODE:C7AA                 </span><span style="color:navy">dw </span><span style="color:#008040">80h
</span><span style="color:maroon">DOSCODE:C7AC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C7AC
DOSCODE:C7AC </span>Rational386Patch<span style="color:navy">:                       </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:C7AC                 </span><span style="color:navy">cmp     word ptr es:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:green">395
</span><span style="color:maroon">DOSCODE:C7B3                 </span><span style="color:navy">jnb     short locret_C7D7
</span><span style="color:maroon">DOSCODE:C7B5                 </span><span style="color:navy">cmp     word ptr es:</span><span style="color:green">0Ch</span><span style="color:navy">, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:maroon">DOSCODE:C7BB                 </span><span style="color:navy">jnz     short locret_C7D7
</span><span style="color:maroon">DOSCODE:C7BD                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">DOSCODE:C7BE                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">18h
</span><span style="color:maroon">DOSCODE:C7C1                 </span><span style="color:navy">cmp     es:</span><span style="color:green">18h</span><span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:C7C6                 </span><span style="color:navy">jnz     short loc_C7D6
</span><span style="color:maroon">DOSCODE:C7C8                 </span><span style="color:navy">cmp     es:</span><span style="color:green">1Ch</span><span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:C7CD                 </span><span style="color:navy">jnz     short loc_C7D6
</span><span style="color:maroon">DOSCODE:C7CF                 </span><span style="color:navy">cmp     es:</span><span style="color:green">24h</span><span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:C7D4                 </span><span style="color:navy">jz      short </span>rp3Maybe
<span style="color:maroon">DOSCODE:C7D6
DOSCODE:C7D6 </span><span style="color:navy">loc_C7D6:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C7D6                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:C7D7
DOSCODE:C7D7 </span><span style="color:navy">locret_C7D7:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C7D7                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:C7D8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C7D8
DOSCODE:C7D8 </span>rp3Maybe<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C7D8                 </span><span style="color:navy">cld
</span><span style="color:maroon">DOSCODE:C7D9                 </span><span style="color:navy">pusha
</span><span style="color:maroon">DOSCODE:C7DA                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:C7DB                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:C7DC                 </span><span style="color:navy">sub     sp, </span><span style="color:green">6
</span><span style="color:maroon">DOSCODE:C7DF                 </span><span style="color:navy">mov     bp, sp
</span><span style="color:maroon">DOSCODE:C7E1                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">DOSCODE:C7E2                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:C7E3                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:C7E3                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">0
</span><span style="color:maroon">DOSCODE:C7E7                 </span><span style="color:navy">mov     [bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:C7EA                 </span><span style="color:navy">call    </span>VerifyVersion
<span style="color:maroon">DOSCODE:C7ED                 </span><span style="color:navy">jnz     short loc_C810
</span><span style="color:maroon">DOSCODE:C7EF                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4500h
</span><span style="color:maroon">DOSCODE:C7F2                 </span><span style="color:navy">mov     [bp+</span><span style="color:#ff8000">2</span><span style="color:navy">], cx
</span><span style="color:maroon">DOSCODE:C7F5                 </span><span style="color:navy">mov     es, word ptr es:</span><span style="color:green">20h
</span><span style="color:maroon">DOSCODE:C7FA                 </span><span style="color:navy">mov     si, </span><span style="color:green">0C702h
</span><span style="color:maroon">DOSCODE:C7FD                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">0Ah
</span><span style="color:maroon">DOSCODE:C800                 </span><span style="color:navy">call    </span>ScanCodeSeq
<span style="color:maroon">DOSCODE:C803                 </span><span style="color:navy">jz      short loc_C813
</span><span style="color:maroon">DOSCODE:C805                 </span><span style="color:navy">mov     si, </span><span style="color:green">0C70Ch
</span><span style="color:maroon">DOSCODE:C808                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">8
</span><span style="color:maroon">DOSCODE:C80B                 </span><span style="color:navy">call    </span>ScanCodeSeq
<span style="color:maroon">DOSCODE:C80E                 </span><span style="color:navy">jz      short loc_C813
</span><span style="color:maroon">DOSCODE:C810
DOSCODE:C810 </span><span style="color:navy">loc_C810:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C810                 </span><span style="color:navy">jmp     loc_C911
</span><span style="color:maroon">DOSCODE:C813 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C813
DOSCODE:C813 </span><span style="color:navy">loc_C813:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C813                 </span><span style="color:navy">mov     [bp+</span><span style="color:#ff8000">4</span><span style="color:navy">], di
</span><span style="color:maroon">DOSCODE:C816                 </span><span style="color:navy">cmp     word ptr [bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], </span><span style="color:#ff8000">17Dh
</span><span style="color:maroon">DOSCODE:C81B                 </span><span style="color:navy">jnb     short loc_C865
</span><span style="color:maroon">DOSCODE:C81D                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0C784h
</span><span style="color:maroon">DOSCODE:C820                 </span><span style="color:navy">call    </span>FindBadCode
<span style="color:maroon">DOSCODE:C823                 </span><span style="color:navy">jb      short loc_C865
</span><span style="color:maroon">DOSCODE:C825                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:C826                 </span><span style="color:navy">mov     di, si
</span><span style="color:maroon">DOSCODE:C828                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">3
</span><span style="color:maroon">DOSCODE:C82B                 </span><span style="color:navy">cmp     byte ptr es:[di-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">51h </span><span style="color:gray">; &#039;Q&#039;
</span><span style="color:maroon">DOSCODE:C830                 </span><span style="color:navy">jnz     short loc_C834
</span><span style="color:maroon">DOSCODE:C832                 </span><span style="color:navy">dec     di
</span><span style="color:maroon">DOSCODE:C833                 </span><span style="color:navy">inc     dx
</span><span style="color:maroon">DOSCODE:C834
DOSCODE:C834 </span><span style="color:navy">loc_C834:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C834                 </span><span style="color:navy">mov     si, </span><span style="color:green">0C71Bh
</span><span style="color:maroon">DOSCODE:C837                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">6
</span><span style="color:maroon">DOSCODE:C83A                 </span><span style="color:navy">call    </span>GenPatch
<span style="color:maroon">DOSCODE:C83D                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:C83E                 </span><span style="color:navy">cmp     byte ptr es:[di-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">59h </span><span style="color:gray">; &#039;Y&#039;
</span><span style="color:maroon">DOSCODE:C843                 </span><span style="color:navy">jnz     short loc_C84A
</span><span style="color:maroon">DOSCODE:C845                 </span><span style="color:navy">mov     byte ptr es:[di-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">90h
</span><span style="color:maroon">DOSCODE:C84A
DOSCODE:C84A </span><span style="color:navy">loc_C84A:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C84A                 </span><span style="color:navy">mov     ax, [bp+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:C84D                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">4</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:C851                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:C852                 </span><span style="color:navy">mov     si, </span><span style="color:green">0C721h
</span><span style="color:maroon">DOSCODE:C855                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">5
</span><span style="color:maroon">DOSCODE:C858                 </span><span style="color:navy">call    </span>CopyPatch
<span style="color:maroon">DOSCODE:C85B                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:C85C                 </span><span style="color:navy">add     bx, </span><span style="color:#ff8000">8
</span><span style="color:maroon">DOSCODE:C85F                 </span><span style="color:navy">call    </span>GenJump
<span style="color:maroon">DOSCODE:C862                 </span><span style="color:navy">mov     [bp+</span><span style="color:#ff8000">4</span><span style="color:navy">], di
</span><span style="color:maroon">DOSCODE:C865
DOSCODE:C865 </span><span style="color:navy">loc_C865:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C865                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0C78Eh
</span><span style="color:maroon">DOSCODE:C868                 </span><span style="color:navy">call    </span>FindBadCode
<span style="color:maroon">DOSCODE:C86B                 </span><span style="color:navy">jb      short loc_C8AF
</span><span style="color:maroon">DOSCODE:C86D                 </span><span style="color:navy">push    word ptr [bp+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:C870                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:C871                 </span><span style="color:navy">mov     di, si
</span><span style="color:maroon">DOSCODE:C873                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:C876                 </span><span style="color:navy">mov     si, </span><span style="color:green">0C733h
</span><span style="color:maroon">DOSCODE:C879                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">0Fh
</span><span style="color:maroon">DOSCODE:C87C                 </span><span style="color:navy">call    </span>GenPatch
<span style="color:maroon">DOSCODE:C87F                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:C880                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">5
</span><span style="color:maroon">DOSCODE:C883                 </span><span style="color:navy">mov     bx, [bp+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:C886                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:C887                 </span><span style="color:navy">call    </span>GenJump
<span style="color:maroon">DOSCODE:C88A                 </span><span style="color:navy">mov     si, </span><span style="color:green">0C742h
</span><span style="color:maroon">DOSCODE:C88D                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">0Fh
</span><span style="color:maroon">DOSCODE:C890                 </span><span style="color:navy">call    </span>CopyPatch
<span style="color:maroon">DOSCODE:C893                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:C894                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:C895                 </span><span style="color:navy">mov     ax, [bp+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:C898                 </span><span style="color:navy">mov     es:[si+</span><span style="color:#ff8000">7</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:C89C                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">5</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:C8A0                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:C8A3                 </span><span style="color:navy">mov     es:[si+</span><span style="color:#ff8000">0Dh</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:C8A7                 </span><span style="color:navy">mov     es:[di+</span><span style="color:#ff8000">0Bh</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:C8AB                 </span><span style="color:navy">add     word ptr [bp+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:#ff8000">8
</span><span style="color:maroon">DOSCODE:C8AF
DOSCODE:C8AF </span><span style="color:navy">loc_C8AF:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C8AF                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0C798h
</span><span style="color:maroon">DOSCODE:C8B2                 </span><span style="color:navy">call    </span>FindBadCode
<span style="color:maroon">DOSCODE:C8B5                 </span><span style="color:navy">jb      short loc_C8E3
</span><span style="color:maroon">DOSCODE:C8B7                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">9
</span><span style="color:maroon">DOSCODE:C8BA                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:C8BB                 </span><span style="color:navy">mov     si, </span><span style="color:green">0C75Bh
</span><span style="color:maroon">DOSCODE:C8BE                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">3
</span><span style="color:maroon">DOSCODE:C8C1                 </span><span style="color:navy">call    </span>ScanCodeSeq_di
<span style="color:maroon">DOSCODE:C8C4                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:C8C5                 </span><span style="color:navy">jnz     short loc_C8E3
</span><span style="color:maroon">DOSCODE:C8C7                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:C8C8                 </span><span style="color:navy">mov     di, si
</span><span style="color:maroon">DOSCODE:C8CA                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">3
</span><span style="color:maroon">DOSCODE:C8CD                 </span><span style="color:navy">mov     si, </span><span style="color:green">0C75Eh
</span><span style="color:maroon">DOSCODE:C8D0                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">9
</span><span style="color:maroon">DOSCODE:C8D3                 </span><span style="color:navy">call    </span>GenPatch
<span style="color:maroon">DOSCODE:C8D6                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:C8D7                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">3
</span><span style="color:maroon">DOSCODE:C8DA                 </span><span style="color:navy">mov     si, </span><span style="color:green">0C767h
</span><span style="color:maroon">DOSCODE:C8DD                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">9
</span><span style="color:maroon">DOSCODE:C8E0                 </span><span style="color:navy">call    </span>GenPatch
<span style="color:maroon">DOSCODE:C8E3
DOSCODE:C8E3 </span><span style="color:navy">loc_C8E3:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C8E3                 </span><span style="color:navy">cmp     word ptr [bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], </span><span style="color:#ff8000">168h
</span><span style="color:maroon">DOSCODE:C8E8                 </span><span style="color:navy">jbe     short loc_C911
</span><span style="color:maroon">DOSCODE:C8EA                 </span><span style="color:navy">mov     bx, </span><span style="color:green">0C7A2h
</span><span style="color:maroon">DOSCODE:C8ED                 </span><span style="color:navy">call    </span>FindBadCode
<span style="color:maroon">DOSCODE:C8F0                 </span><span style="color:navy">jb      short loc_C911
</span><span style="color:maroon">DOSCODE:C8F2                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:C8F3                 </span><span style="color:navy">mov     di, si
</span><span style="color:maroon">DOSCODE:C8F5                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">3
</span><span style="color:maroon">DOSCODE:C8F8                 </span><span style="color:navy">mov     si, </span><span style="color:green">0C77Bh
</span><span style="color:maroon">DOSCODE:C8FB                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:C8FE                 </span><span style="color:navy">call    </span>GenPatch
<span style="color:maroon">DOSCODE:C901                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:C902                 </span><span style="color:navy">mov     bx, [bp+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:C905                 </span><span style="color:navy">call    </span>GenJump
<span style="color:maroon">DOSCODE:C908                 </span><span style="color:navy">mov     si, </span><span style="color:green">0C77Fh
</span><span style="color:maroon">DOSCODE:C90B                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">5
</span><span style="color:maroon">DOSCODE:C90E                 </span><span style="color:navy">call    </span>CopyPatch
<span style="color:maroon">DOSCODE:C911
DOSCODE:C911 </span><span style="color:navy">loc_C911:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C911                 </span><span style="color:navy">add     sp, </span><span style="color:green">6
</span><span style="color:maroon">DOSCODE:C914                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:C915                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:C915                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:C916                 </span><span style="color:navy">popa
</span><span style="color:maroon">DOSCODE:C917                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:C918                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C919
DOSCODE:C919 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C919
DOSCODE:C919
DOSCODE:C919 </span>FindBadCode     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C919                 </span><span style="color:navy">mov     cx, [bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C91C                 </span><span style="color:navy">mov     si, [bx]
</span><span style="color:black">DOSCODE:C91E                 </span><span style="color:navy">mov     dx, [bx+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C921                 </span><span style="color:navy">call    </span>ScanCodeSeq
<span style="color:black">DOSCODE:C924                 </span><span style="color:navy">jnz     short </span>fbc_error
<span style="color:black">DOSCODE:C926                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:C927                 </span><span style="color:navy">mov     si, [bx+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C92A                 </span><span style="color:navy">mov     dx, [bx+</span><span style="color:#ff8000">6</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C92D                 </span><span style="color:navy">call    </span>ScanCodeSeq_di
<span style="color:black">DOSCODE:C930                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:C931                 </span><span style="color:navy">jnz     short </span>fbc_error
<span style="color:black">DOSCODE:C933                 </span><span style="color:navy">mov     ax, di
</span><span style="color:black">DOSCODE:C935                 </span><span style="color:navy">sub     ax, si
</span><span style="color:black">DOSCODE:C937                 </span><span style="color:navy">jb      short </span>fbc_error
<span style="color:black">DOSCODE:C939                 </span><span style="color:navy">cmp     ax, [bx+</span><span style="color:#ff8000">8</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C93C                 </span><span style="color:navy">ja      short </span>fbc_error
<span style="color:black">DOSCODE:C93E                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:C93F                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C940 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:C940
DOSCODE:C940 </span>fbc_error<span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C940                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:C941                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C941 </span>FindBadCode     <span style="color:black">endp
DOSCODE:C941
DOSCODE:C942
DOSCODE:C942 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C942
DOSCODE:C942
DOSCODE:C942 </span>GenPatch        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C942                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:C943                 </span><span style="color:navy">mov     bx, [bp+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C946                 </span><span style="color:navy">call    </span>GenJump
<span style="color:black">DOSCODE:C949                 </span><span style="color:navy">call    </span>CopyPatch
<span style="color:black">DOSCODE:C94C                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:C94D                 </span><span style="color:navy">add     bx, dx
</span><span style="color:black">DOSCODE:C94F                 </span><span style="color:navy">call    </span>GenJump
<span style="color:black">DOSCODE:C952                 </span><span style="color:navy">mov     [bp+</span><span style="color:#ff8000">4</span><span style="color:navy">], di
</span><span style="color:black">DOSCODE:C955                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C955 </span>GenPatch        <span style="color:black">endp
DOSCODE:C955
DOSCODE:C956
DOSCODE:C956 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C956
DOSCODE:C956
DOSCODE:C956 </span>CopyPatch       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C956                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:C957                 </span><span style="color:navy">mov     di, [bp+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:C95A                 </span><span style="color:navy">cld
</span><span style="color:black">DOSCODE:C95B                 </span><span style="color:navy">rep movsb
</span><span style="color:black">DOSCODE:C95D                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:C95E                 </span><span style="color:navy">mov     [bp+</span><span style="color:#ff8000">4</span><span style="color:navy">], di
</span><span style="color:black">DOSCODE:C961                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C961 </span>CopyPatch       <span style="color:black">endp
DOSCODE:C961
DOSCODE:C962
DOSCODE:C962 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C962
DOSCODE:C962
DOSCODE:C962 </span>GenJump         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C962                 </span><span style="color:navy">mov     al, </span><span style="color:green">0E9h
</span><span style="color:black">DOSCODE:C964                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:C965                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:black">DOSCODE:C967                 </span><span style="color:navy">sub     ax, di
</span><span style="color:black">DOSCODE:C969                 </span><span style="color:navy">sub     ax, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:C96C                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:C96D                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C96D </span>GenJump         <span style="color:black">endp
DOSCODE:C96D
DOSCODE:C96E
DOSCODE:C96E </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C96E
DOSCODE:C96E
DOSCODE:C96E </span>ScanCodeSeq     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C96E                 </span><span style="color:navy">mov     di, </span><span style="color:green">200h
</span><span style="color:black">DOSCODE:C971
DOSCODE:C971 </span>ScanCodeSeq_di<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C971                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:C972                 </span><span style="color:navy">sub     cx, dx
</span><span style="color:black">DOSCODE:C974                 </span><span style="color:navy">inc     cx
</span><span style="color:black">DOSCODE:C975
DOSCODE:C975 </span><span style="color:gray">scsagain</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C975                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:C976                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:C977                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:C978                 </span><span style="color:navy">mov     cx, dx
</span><span style="color:black">DOSCODE:C97A                 </span><span style="color:navy">repe cmpsb
</span><span style="color:black">DOSCODE:C97C                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:C97D                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:C97E                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:C97F                 </span><span style="color:navy">jz      short </span><span style="color:gray">scsfound
</span><span style="color:black">DOSCODE:C981                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:C982                 </span><span style="color:navy">loop    </span><span style="color:gray">scsagain
</span><span style="color:black">DOSCODE:C984
DOSCODE:C984 </span><span style="color:gray">scsfound</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C984                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:C985                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C985 </span>ScanCodeSeq     <span style="color:black">endp
DOSCODE:C985
DOSCODE:C986
DOSCODE:C986 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C986
DOSCODE:C986
DOSCODE:C986 </span>VerifyVersion   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C986                 </span><span style="color:navy">mov     si, es:</span><span style="color:green">2Ah
</span><span style="color:black">DOSCODE:C98B                 </span><span style="color:navy">mov     bl, </span><span style="color:#ff8000">0Ah
</span><span style="color:black">DOSCODE:C98D                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:C990                 </span><span style="color:navy">call    </span>VVDigit
<span style="color:black">DOSCODE:C993                 </span><span style="color:navy">jnz     short </span><span style="color:gray">vvexit
</span><span style="color:black">DOSCODE:C995                 </span><span style="color:navy">call    </span>VVDigit
<span style="color:black">DOSCODE:C998                 </span><span style="color:navy">jnz     short </span><span style="color:gray">vvexit
</span><span style="color:black">DOSCODE:C99A                 </span><span style="color:navy">cmp     byte ptr es:[si], </span><span style="color:#ff8000">2Eh </span><span style="color:gray">; &#039;.&#039;
</span><span style="color:black">DOSCODE:C99E                 </span><span style="color:navy">jnz     short </span><span style="color:gray">vvexit
</span><span style="color:black">DOSCODE:C9A0                 </span><span style="color:navy">dec     si
</span><span style="color:black">DOSCODE:C9A1                 </span><span style="color:navy">call    </span>VVDigit
<span style="color:black">DOSCODE:C9A4
DOSCODE:C9A4 </span><span style="color:gray">vvexit</span><span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C9A4                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C9A4 </span>VerifyVersion   <span style="color:black">endp
DOSCODE:C9A4
DOSCODE:C9A5
DOSCODE:C9A5 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:C9A5
DOSCODE:C9A5
DOSCODE:C9A5 </span>VVDigit         <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:C9A5                 </span><span style="color:navy">div     bl
</span><span style="color:black">DOSCODE:C9A7                 </span><span style="color:navy">add     ah, </span><span style="color:#ff8000">30h </span><span style="color:gray">; &#039;0&#039;
</span><span style="color:black">DOSCODE:C9AA                 </span><span style="color:navy">dec     si
</span><span style="color:black">DOSCODE:C9AB                 </span><span style="color:navy">cmp     es:[si+</span><span style="color:#ff8000">1</span><span style="color:navy">], ah
</span><span style="color:black">DOSCODE:C9AF                 </span><span style="color:navy">mov     ah, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:C9B1                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:C9B1 </span>VVDigit         <span style="color:black">endp
DOSCODE:C9B1
</span><span style="color:maroon">DOSCODE:C9B2 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:C9B2
DOSCODE:C9B2 </span>exepatch_start<span style="color:navy">:                         </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:C9B2                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:C9B3                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:maroon">DOSCODE:C9B5                 </span><span style="color:navy">sub     ax, dx
</span><span style="color:maroon">DOSCODE:C9B7                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">DOSCODE:C9B9                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">DOSCODE:C9BB                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">0Fh
</span><span style="color:maroon">DOSCODE:C9BE                 </span><span style="color:navy">push    di
</span><span style="color:maroon">DOSCODE:C9BF                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">10h
</span><span style="color:maroon">DOSCODE:C9C2                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:C9C4                 </span><span style="color:navy">repe scasb
</span><span style="color:maroon">DOSCODE:C9C6                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">DOSCODE:C9C7                 </span><span style="color:navy">mov     si, di
</span><span style="color:maroon">DOSCODE:C9C9                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:C9CA                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">DOSCODE:C9CB                 </span><span style="color:navy">sub     ax, dx
</span><span style="color:maroon">DOSCODE:C9CD                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">DOSCODE:C9CF
DOSCODE:C9CF </span><span style="color:navy">loc_C9CF:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C9CF                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">204h
</span><span style="color:maroon">DOSCODE:C9D2
DOSCODE:C9D2 </span><span style="color:navy">loc_C9D2:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C9D2                 </span><span style="color:navy">mov     ax, si
</span><span style="color:maroon">DOSCODE:C9D4                 </span><span style="color:navy">not     ax
</span><span style="color:maroon">DOSCODE:C9D6                 </span><span style="color:navy">shr     ax, cl
</span><span style="color:maroon">DOSCODE:C9D8                 </span><span style="color:navy">jz      short loc_C9ED
</span><span style="color:maroon">DOSCODE:C9DA                 </span><span style="color:navy">mov     dx, ds
</span><span style="color:maroon">DOSCODE:C9DC                 </span><span style="color:navy">or      si, </span><span style="color:green">0FFF0h
</span><span style="color:maroon">DOSCODE:C9DF                 </span><span style="color:navy">sub     dx, ax
</span><span style="color:maroon">DOSCODE:C9E1                 </span><span style="color:navy">jnb     short loc_C9EB
</span><span style="color:maroon">DOSCODE:C9E3                 </span><span style="color:navy">neg     dx
</span><span style="color:maroon">DOSCODE:C9E5                 </span><span style="color:navy">shl     dx, cl
</span><span style="color:maroon">DOSCODE:C9E7                 </span><span style="color:navy">sub     si, dx
</span><span style="color:maroon">DOSCODE:C9E9                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:maroon">DOSCODE:C9EB
DOSCODE:C9EB </span><span style="color:navy">loc_C9EB:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C9EB                 </span><span style="color:navy">mov     ds, dx
</span><span style="color:maroon">DOSCODE:C9ED                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:C9ED
DOSCODE:C9ED </span><span style="color:navy">loc_C9ED:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:C9ED                 </span><span style="color:navy">xchg    si, di
</span><span style="color:maroon">DOSCODE:C9EF                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:C9F0                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:C9F1                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:C9F2                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:C9F2                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:C9F3                 </span><span style="color:navy">dec     ch
</span><span style="color:maroon">DOSCODE:C9F5                 </span><span style="color:navy">jnz     short loc_C9D2
</span><span style="color:maroon">DOSCODE:C9F7                 </span><span style="color:navy">lodsb
</span><span style="color:maroon">DOSCODE:C9F8                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:maroon">DOSCODE:C9F9                 </span><span style="color:navy">dec     si
</span><span style="color:maroon">DOSCODE:C9FA                 </span><span style="color:navy">lodsw
</span><span style="color:maroon">DOSCODE:C9FB                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:maroon">DOSCODE:C9FD                 </span><span style="color:navy">inc     si
</span><span style="color:maroon">DOSCODE:C9FE                 </span><span style="color:navy">mov     al, dl
</span><span style="color:maroon">DOSCODE:CA00                 </span><span style="color:navy">and     al, </span><span style="color:green">0FEh
</span><span style="color:maroon">DOSCODE:CA02                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0B0h
</span><span style="color:maroon">DOSCODE:CA04                 </span><span style="color:navy">jnz     short loc_CA0B
</span><span style="color:maroon">DOSCODE:CA06                 </span><span style="color:navy">lodsb
</span><span style="color:maroon">DOSCODE:CA07                 </span><span style="color:navy">rep stosb
</span><span style="color:maroon">DOSCODE:CA09                 </span><span style="color:navy">jmp     short loc_CA11
</span><span style="color:maroon">DOSCODE:CA0B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:CA0B
DOSCODE:CA0B </span><span style="color:navy">loc_CA0B:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CA0B                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0B2h
</span><span style="color:maroon">DOSCODE:CA0D                 </span><span style="color:navy">jnz     short near ptr loc_CA7A+</span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:CA0F                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">DOSCODE:CA11
DOSCODE:CA11 </span><span style="color:navy">loc_CA11:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CA11                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:maroon">DOSCODE:CA12                 </span><span style="color:navy">test    al, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:CA14                 </span><span style="color:navy">jz      short loc_C9CF
</span><span style="color:maroon">DOSCODE:CA16                 </span><span style="color:navy">nop
</span><span style="color:maroon">DOSCODE:CA17                 </span><span style="color:navy">nop
</span><span style="color:maroon">DOSCODE:CA18
DOSCODE:CA18 </span>scan_patch1<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:CA18                 </span><span style="color:navy">mov     bx, es
</span><span style="color:maroon">DOSCODE:CA1A                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:maroon">DOSCODE:CA1C                 </span><span style="color:navy">sub     ax, dx
</span><span style="color:maroon">DOSCODE:CA1E                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">DOSCODE:CA20                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">DOSCODE:CA22                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">0Fh
</span><span style="color:maroon">DOSCODE:CA25                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">10h
</span><span style="color:maroon">DOSCODE:CA28                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:CA2A                 </span><span style="color:navy">repe scasb
</span><span style="color:maroon">DOSCODE:CA2C                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">DOSCODE:CA2D                 </span><span style="color:navy">mov     si, di
</span><span style="color:maroon">DOSCODE:CA2F                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:maroon">DOSCODE:CA31                 </span><span style="color:navy">sub     ax, dx
</span><span style="color:maroon">DOSCODE:CA33                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">DOSCODE:CA35                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">0Fh
</span><span style="color:maroon">DOSCODE:CA38                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:CA3A                 </span><span style="color:navy">mov     ax, si
</span><span style="color:maroon">DOSCODE:CA3C                 </span><span style="color:navy">not     ax
</span><span style="color:maroon">DOSCODE:CA3E                 </span><span style="color:navy">shr     ax, cl
</span><span style="color:maroon">DOSCODE:CA40                 </span><span style="color:navy">jz      short loc_CA4B
</span><span style="color:maroon">DOSCODE:CA42                 </span><span style="color:navy">mov     dx, ds
</span><span style="color:maroon">DOSCODE:CA44                 </span><span style="color:navy">sub     dx, ax
</span><span style="color:maroon">DOSCODE:CA46                 </span><span style="color:navy">mov     ds, dx
</span><span style="color:maroon">DOSCODE:CA48                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:CA48                 </span><span style="color:navy">or      si, </span><span style="color:green">0FFF0h
</span><span style="color:maroon">DOSCODE:CA4B
DOSCODE:CA4B </span><span style="color:navy">loc_CA4B:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CA4B                 </span><span style="color:navy">mov     ax, di
</span><span style="color:maroon">DOSCODE:CA4D                 </span><span style="color:navy">not     ax
</span><span style="color:maroon">DOSCODE:CA4F                 </span><span style="color:navy">shr     ax, cl
</span><span style="color:maroon">DOSCODE:CA51                 </span><span style="color:navy">jz      short </span>scan_patch2
<span style="color:maroon">DOSCODE:CA53                 </span><span style="color:navy">mov     dx, es
</span><span style="color:maroon">DOSCODE:CA55                 </span><span style="color:navy">sub     dx, ax
</span><span style="color:maroon">DOSCODE:CA57                 </span><span style="color:navy">mov     es, dx
</span><span style="color:maroon">DOSCODE:CA59                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:CA59                 </span><span style="color:navy">or      di, </span><span style="color:green">0FFF0h
</span><span style="color:maroon">DOSCODE:CA5C
DOSCODE:CA5C </span>scan_patch2<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CA5C                 </span><span style="color:navy">mov     bx, es
</span><span style="color:maroon">DOSCODE:CA5E                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:maroon">DOSCODE:CA60                 </span><span style="color:navy">dec     ax
</span><span style="color:maroon">DOSCODE:CA61                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">DOSCODE:CA63                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:CA63                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">DOSCODE:CA65                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">0Fh
</span><span style="color:maroon">DOSCODE:CA68                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">10h
</span><span style="color:maroon">DOSCODE:CA6B                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:CA6D                 </span><span style="color:navy">repe scasb
</span><span style="color:maroon">DOSCODE:CA6F                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">DOSCODE:CA70                 </span><span style="color:navy">mov     si, di
</span><span style="color:maroon">DOSCODE:CA72                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:maroon">DOSCODE:CA74                 </span><span style="color:navy">dec     ax
</span><span style="color:maroon">DOSCODE:CA75                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">DOSCODE:CA77                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:CA77                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">0Fh
</span><span style="color:maroon">DOSCODE:CA7A
DOSCODE:CA7A </span><span style="color:navy">loc_CA7A:                               </span><span style="color:red">; ...
</span><span style="color:maroon">DOSCODE:CA7A                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:CA7C                 </span><span style="color:navy">mov     ax, si
</span><span style="color:maroon">DOSCODE:CA7E                 </span><span style="color:navy">not     ax
</span><span style="color:maroon">DOSCODE:CA80                 </span><span style="color:navy">shr     ax, cl
</span><span style="color:maroon">DOSCODE:CA82                 </span><span style="color:navy">jz      short loc_CA8E
</span><span style="color:maroon">DOSCODE:CA84                 </span><span style="color:navy">mov     dx, ds
</span><span style="color:maroon">DOSCODE:CA86                 </span><span style="color:navy">sub     dx, ax
</span><span style="color:maroon">DOSCODE:CA88                 </span><span style="color:navy">mov     ds, dx
</span><span style="color:maroon">DOSCODE:CA8A                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:CA8A                 </span><span style="color:navy">or      si, </span><span style="color:green">0FFF0h
</span><span style="color:maroon">DOSCODE:CA8E
DOSCODE:CA8E </span><span style="color:navy">loc_CA8E:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CA8E                 </span><span style="color:navy">mov     ax, di
</span><span style="color:maroon">DOSCODE:CA90                 </span><span style="color:navy">not     ax
</span><span style="color:maroon">DOSCODE:CA92                 </span><span style="color:navy">shr     ax, cl
</span><span style="color:maroon">DOSCODE:CA94                 </span><span style="color:navy">jz      short loc_CAA0
</span><span style="color:maroon">DOSCODE:CA96                 </span><span style="color:navy">mov     dx, es
</span><span style="color:maroon">DOSCODE:CA98                 </span><span style="color:navy">sub     dx, ax
</span><span style="color:maroon">DOSCODE:CA9A                 </span><span style="color:navy">mov     es, dx
</span><span style="color:maroon">DOSCODE:CA9C                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:CA9C                 </span><span style="color:navy">or      di, </span><span style="color:green">0FFF0h
</span><span style="color:maroon">DOSCODE:CAA0
DOSCODE:CAA0 </span><span style="color:navy">loc_CAA0:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CAA0                 </span><span style="color:navy">mov     bx, es
</span><span style="color:maroon">DOSCODE:CAA2                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:maroon">DOSCODE:CAA4                 </span><span style="color:navy">dec     ax
</span><span style="color:maroon">DOSCODE:CAA5                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">DOSCODE:CAA7                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:CAA7                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">DOSCODE:CAA9                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:CAA9                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">0Fh
</span><span style="color:maroon">DOSCODE:CAAC                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">10h
</span><span style="color:maroon">DOSCODE:CAAF                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:CAB1                 </span><span style="color:navy">repe scasb
</span><span style="color:maroon">DOSCODE:CAB3                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">DOSCODE:CAB4                 </span><span style="color:navy">mov     si, di
</span><span style="color:maroon">DOSCODE:CAB6                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:maroon">DOSCODE:CAB8                 </span><span style="color:navy">dec     ax
</span><span style="color:maroon">DOSCODE:CAB9                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">DOSCODE:CABB                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:CABB                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">0Fh
</span><span style="color:maroon">DOSCODE:CABE                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:CAC0                 </span><span style="color:navy">mov     ax, si
</span><span style="color:maroon">DOSCODE:CAC2                 </span><span style="color:navy">not     ax
</span><span style="color:maroon">DOSCODE:CAC4                 </span><span style="color:navy">shr     ax, cl
</span><span style="color:maroon">DOSCODE:CAC6                 </span><span style="color:navy">jz      short loc_CAD1
</span><span style="color:maroon">DOSCODE:CAC8                 </span><span style="color:navy">mov     dx, ds
</span><span style="color:maroon">DOSCODE:CACA                 </span><span style="color:navy">sub     dx, ax
</span><span style="color:maroon">DOSCODE:CACC                 </span><span style="color:navy">mov     ds, dx
</span><span style="color:maroon">DOSCODE:CACE                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:CACE                 </span><span style="color:navy">or      si, </span><span style="color:green">0FFF0h
</span><span style="color:maroon">DOSCODE:CAD1
DOSCODE:CAD1 </span><span style="color:navy">loc_CAD1:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CAD1                 </span><span style="color:navy">mov     ax, di
</span><span style="color:maroon">DOSCODE:CAD3                 </span><span style="color:navy">not     ax
</span><span style="color:maroon">DOSCODE:CAD5                 </span><span style="color:navy">shr     ax, cl
</span><span style="color:maroon">DOSCODE:CAD7                 </span><span style="color:navy">jz      short </span>scan_com
<span style="color:maroon">DOSCODE:CAD9                 </span><span style="color:navy">mov     dx, es
</span><span style="color:maroon">DOSCODE:CADB                 </span><span style="color:navy">sub     dx, ax
</span><span style="color:maroon">DOSCODE:CADD                 </span><span style="color:navy">mov     es, dx
</span><span style="color:maroon">DOSCODE:CADF                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:CADF                 </span><span style="color:navy">or      di, </span><span style="color:green">0FFF0h
</span><span style="color:maroon">DOSCODE:CAE2
DOSCODE:CAE2 </span>scan_com<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CAE2                 </span><span style="color:navy">lodsb
</span><span style="color:maroon">DOSCODE:CAE3                 </span><span style="color:navy">mov     dl, al
</span><span style="color:maroon">DOSCODE:CAE5                 </span><span style="color:navy">dec     si
</span><span style="color:maroon">DOSCODE:CAE6                 </span><span style="color:navy">lodsw
</span><span style="color:maroon">DOSCODE:CAE7                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:maroon">DOSCODE:CAE9                 </span><span style="color:navy">inc     si
</span><span style="color:maroon">DOSCODE:CAEA                 </span><span style="color:navy">mov     al, dl
</span><span style="color:maroon">DOSCODE:CAEC                 </span><span style="color:navy">and     al, </span><span style="color:green">0FEh
</span><span style="color:maroon">DOSCODE:CAEE                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0B0h
</span><span style="color:maroon">DOSCODE:CAF0                 </span><span style="color:navy">jnz     short loc_CAF8
</span><span style="color:maroon">DOSCODE:CAF2                 </span><span style="color:navy">lodsb
</span><span style="color:maroon">DOSCODE:CAF3                 </span><span style="color:navy">rep stosb
</span><span style="color:maroon">DOSCODE:CAF5                 </span><span style="color:navy">jmp     short loc_CAFE
</span><span style="color:maroon">DOSCODE:CAF7 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:CAF7                 </span><span style="color:navy">nop
</span><span style="color:maroon">DOSCODE:CAF8
DOSCODE:CAF8 </span><span style="color:navy">loc_CAF8:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CAF8                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">0B2h
</span><span style="color:maroon">DOSCODE:CAFA                 </span><span style="color:navy">jnz     short near ptr loc_CB66+</span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:CAFC                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">DOSCODE:CAFE
DOSCODE:CAFE </span><span style="color:navy">loc_CAFE:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CAFE                 </span><span style="color:navy">mov     al, dl
</span><span style="color:maroon">DOSCODE:CB00                 </span><span style="color:navy">test    al, </span><span style="color:green">1
</span><span style="color:maroon">DOSCODE:CB02
DOSCODE:CB02 </span>ExePatch<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:CB02                 </span><span style="color:navy">call    </span>ExePackPatch
<span style="color:maroon">DOSCODE:CB05                 </span><span style="color:navy">call    ss:</span>RationalPatchPtr
<span style="color:maroon">DOSCODE:CB0A                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:CB0B
DOSCODE:CB0B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:CB0B
DOSCODE:CB0B
DOSCODE:CB0B </span>ExePackPatch    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CB0B                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:CB0C                 </span><span style="color:navy">mov     bx, es
</span><span style="color:black">DOSCODE:CB0E                 </span><span style="color:navy">cmp     bx, </span><span style="color:#ff8000">0FFFh
</span><span style="color:black">DOSCODE:CB12                 </span><span style="color:navy">jbe     short </span><span style="color:gray">ep_contep_cont
</span><span style="color:black">DOSCODE:CB14                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:CB15                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:CB16 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:CB16
DOSCODE:CB16 </span><span style="color:gray">ep_contep_cont</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CB16                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:CB17                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:CB18                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:CB19                 </span><span style="color:navy">push    cx
</span><span style="color:black">DOSCODE:CB1A                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:CB1B                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:CB1C                 </span><span style="color:navy">sub     cx, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:CB1F                 </span><span style="color:navy">jnb     short </span><span style="color:gray">epp_1
</span><span style="color:black">DOSCODE:CB21                 </span><span style="color:navy">jmp     </span><span style="color:gray">ep_notpacked
</span><span style="color:black">DOSCODE:CB24 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:CB24
DOSCODE:CB24 </span><span style="color:gray">epp_1</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CB24                 </span><span style="color:navy">mov     di, cx
</span><span style="color:black">DOSCODE:CB26                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">DOSCODE:CB28                 </span>assume es:nothing
<span style="color:black">DOSCODE:CB28                 </span><span style="color:navy">mov     ss:</span>UNPACK_OFFSET<span style="color:navy">, di
</span><span style="color:black">DOSCODE:CB2D                 </span><span style="color:navy">cmp     word ptr es:[di], </span><span style="color:#ff8000">4252h
</span><span style="color:black">DOSCODE:CB32                 </span><span style="color:navy">jz      short </span><span style="color:gray">epp_2
</span><span style="color:black">DOSCODE:CB34                 </span><span style="color:navy">jmp     </span><span style="color:gray">ep_notpacked
</span><span style="color:black">DOSCODE:CB37 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:CB37
DOSCODE:CB37 </span><span style="color:gray">epp_2</span><span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CB37                 </span><span style="color:navy">push    cs
</span><span style="color:black">DOSCODE:CB38                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:CB39                 </span>assume ds:DOSCODE
<span style="color:black">DOSCODE:CB39                 </span><span style="color:navy">add     di, </span><span style="color:green">6Ch
</span><span style="color:black">DOSCODE:CB3C                 </span><span style="color:navy">call    </span>chk_common_str
<span style="color:black">DOSCODE:CB3F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ep_chkpatch2
</span><span style="color:black">DOSCODE:CB41                 </span><span style="color:navy">mov     si, offset </span>scan_patch1
<span style="color:black">DOSCODE:CB44                 </span><span style="color:navy">mov     di, ss:</span>UNPACK_OFFSET
<span style="color:black">DOSCODE:CB49                 </span><span style="color:navy">add     di, </span><span style="color:green">28h
</span><span style="color:black">DOSCODE:CB4C                 </span><span style="color:navy">mov     cl, </span><span style="color:green">68
</span><span style="color:black">DOSCODE:CB4E                 </span><span style="color:navy">mov     bx, </span><span style="color:green">142
</span><span style="color:black">DOSCODE:CB51                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0EF4Eh
</span><span style="color:black">DOSCODE:CB54                 </span><span style="color:navy">call    </span>chk_patchsum
<span style="color:black">DOSCODE:CB57                 </span><span style="color:navy">jb      short </span><span style="color:gray">ep_done1
</span><span style="color:black">DOSCODE:CB59                 </span><span style="color:navy">mov     si, offset </span>exepatch_start
<span style="color:black">DOSCODE:CB5C                 </span><span style="color:navy">mov     cl, </span><span style="color:green">102
</span><span style="color:black">DOSCODE:CB5E                 </span><span style="color:navy">rep movsb
</span><span style="color:black">DOSCODE:CB60
DOSCODE:CB60 </span><span style="color:gray">ep_done1</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CB60                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ep_notpacked
</span><span style="color:black">DOSCODE:CB62 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:CB62                 </span><span style="color:navy">nop
</span><span style="color:black">DOSCODE:CB63
DOSCODE:CB63 </span><span style="color:gray">ep_chkpatch2</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CB63                 </span><span style="color:navy">mov     di, </span><span style="color:green">76h
</span><span style="color:black">DOSCODE:CB66
DOSCODE:CB66 </span><span style="color:navy">loc_CB66:                               </span><span style="color:red">; ...
</span><span style="color:black">DOSCODE:CB66                 </span><span style="color:navy">call    </span>chk_common_str
<span style="color:black">DOSCODE:CB69                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ep_chkpatch3
</span><span style="color:black">DOSCODE:CB6B                 </span><span style="color:navy">mov     si, offset </span>scan_patch2
<span style="color:black">DOSCODE:CB6E                 </span><span style="color:navy">mov     di, </span><span style="color:green">32h
</span><span style="color:black">DOSCODE:CB71                 </span><span style="color:navy">mov     cl, </span><span style="color:green">68
</span><span style="color:black">DOSCODE:CB73                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">8Ch
</span><span style="color:black">DOSCODE:CB76                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">78B2h
</span><span style="color:black">DOSCODE:CB79                 </span><span style="color:navy">call    </span>chk_patchsum
<span style="color:black">DOSCODE:CB7C                 </span><span style="color:navy">jnb     short </span><span style="color:gray">ep_patchcode2
</span><span style="color:black">DOSCODE:CB7E                 </span><span style="color:navy">mov     si, offset </span>scan_patch2
<span style="color:black">DOSCODE:CB81                 </span><span style="color:navy">mov     cl, </span><span style="color:green">68
</span><span style="color:black">DOSCODE:CB83                 </span><span style="color:navy">mov     bx, </span><span style="color:green">129
</span><span style="color:black">DOSCODE:CB86                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">1C47h
</span><span style="color:black">DOSCODE:CB89                 </span><span style="color:navy">call    </span>chk_patchsum
<span style="color:black">DOSCODE:CB8C                 </span><span style="color:navy">jb      short </span><span style="color:gray">ep_notpacked
</span><span style="color:black">DOSCODE:CB8E
DOSCODE:CB8E </span><span style="color:gray">ep_patchcode2</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CB8E                 </span><span style="color:navy">mov     si, offset </span>exepatch_start ; str1
<span style="color:black">DOSCODE:CB91                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:CB93                 </span><span style="color:navy">rep movsb
</span><span style="color:black">DOSCODE:CB95                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4890h
</span><span style="color:black">DOSCODE:CB98                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:CB99                 </span><span style="color:navy">inc     si
</span><span style="color:black">DOSCODE:CB9A                 </span><span style="color:navy">inc     si
</span><span style="color:black">DOSCODE:CB9B                 </span><span style="color:navy">mov     cl, </span><span style="color:green">20
</span><span style="color:black">DOSCODE:CB9D                 </span><span style="color:navy">rep movsb
</span><span style="color:black">DOSCODE:CB9F                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:CBA0                 </span><span style="color:navy">inc     si
</span><span style="color:black">DOSCODE:CBA1                 </span><span style="color:navy">inc     si
</span><span style="color:black">DOSCODE:CBA2                 </span><span style="color:navy">mov     cl, </span><span style="color:green">75
</span><span style="color:black">DOSCODE:CBA4                 </span><span style="color:navy">rep movsb
</span><span style="color:black">DOSCODE:CBA6                 </span><span style="color:navy">jmp     short </span><span style="color:gray">ep_notpacked
</span><span style="color:black">DOSCODE:CBA8 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:CBA8
DOSCODE:CBA8 </span><span style="color:gray">ep_chkpatch3</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CBA8                 </span><span style="color:navy">mov     di, </span><span style="color:green">74h
</span><span style="color:black">DOSCODE:CBAB                 </span><span style="color:navy">call    </span>chk_common_str
<span style="color:black">DOSCODE:CBAE                 </span><span style="color:navy">jnz     short </span><span style="color:gray">ep_notpacked
</span><span style="color:black">DOSCODE:CBB0                 </span><span style="color:navy">mov     si, </span><span style="color:green">0CAA0h
</span><span style="color:black">DOSCODE:CBB3                 </span><span style="color:navy">mov     di, </span><span style="color:green">32h
</span><span style="color:black">DOSCODE:CBB6                 </span><span style="color:navy">mov     cl, </span><span style="color:green">66
</span><span style="color:black">DOSCODE:CBB8                 </span><span style="color:navy">mov     bx, </span><span style="color:green">139
</span><span style="color:black">DOSCODE:CBBB                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4EDEh
</span><span style="color:black">DOSCODE:CBBE                 </span><span style="color:navy">call    </span>chk_patchsum
<span style="color:black">DOSCODE:CBC1                 </span><span style="color:navy">jb      short </span><span style="color:gray">ep_notpacked
</span><span style="color:black">DOSCODE:CBC3                 </span><span style="color:navy">mov     si, offset </span>exepatch_start ; str1
<span style="color:black">DOSCODE:CBC6                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">3
</span><span style="color:black">DOSCODE:CBC8                 </span><span style="color:navy">rep movsb
</span><span style="color:black">DOSCODE:CBCA                 </span><span style="color:navy">mov     al, </span><span style="color:green">48h
</span><span style="color:black">DOSCODE:CBCC                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:CBCD                 </span><span style="color:navy">inc     si
</span><span style="color:black">DOSCODE:CBCE                 </span><span style="color:navy">inc     si
</span><span style="color:black">DOSCODE:CBCF                 </span><span style="color:navy">mov     cl, </span><span style="color:green">20
</span><span style="color:black">DOSCODE:CBD1                 </span><span style="color:navy">rep movsb
</span><span style="color:black">DOSCODE:CBD3                 </span><span style="color:navy">stosb
</span><span style="color:black">DOSCODE:CBD4                 </span><span style="color:navy">inc     si
</span><span style="color:black">DOSCODE:CBD5                 </span><span style="color:navy">inc     si
</span><span style="color:black">DOSCODE:CBD6                 </span><span style="color:navy">mov     cl, </span><span style="color:green">75
</span><span style="color:black">DOSCODE:CBD8                 </span><span style="color:navy">rep movsb
</span><span style="color:black">DOSCODE:CBDA
DOSCODE:CBDA </span><span style="color:gray">ep_notpacked</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CBDA                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:CBDB                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:CBDC                 </span><span style="color:navy">pop     cx
</span><span style="color:black">DOSCODE:CBDD                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:CBDE                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:CBDF                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:CBE0                 </span>assume ds:nothing
<span style="color:black">DOSCODE:CBE0                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:CBE1                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:CBE1 </span>ExePackPatch    <span style="color:black">endp
DOSCODE:CBE1
DOSCODE:CBE2
DOSCODE:CBE2 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:CBE2
DOSCODE:CBE2
DOSCODE:CBE2 </span>chk_common_str  <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CBE2                 </span><span style="color:navy">mov     si, offset </span>scan_com
<span style="color:black">DOSCODE:CBE5                 </span><span style="color:navy">mov     cx, </span><span style="color:green">32
</span><span style="color:black">DOSCODE:CBE8                 </span><span style="color:navy">repe cmpsb
</span><span style="color:black">DOSCODE:CBEA                 </span><span style="color:navy">jz      short </span>ccs_done
<span style="color:black">DOSCODE:CBEC                 </span><span style="color:navy">cmp     byte ptr es:[di-</span><span style="color:green">1</span><span style="color:navy">], </span><span style="color:#ff8000">56h </span><span style="color:gray">; &#039;V&#039;
</span><span style="color:black">DOSCODE:CBF1                 </span><span style="color:navy">jnz     short </span>ccs_done
<span style="color:black">DOSCODE:CBF3                 </span><span style="color:navy">repe cmpsb
</span><span style="color:black">DOSCODE:CBF5
DOSCODE:CBF5 </span>ccs_done<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CBF5                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:CBF5 </span>chk_common_str  <span style="color:black">endp
DOSCODE:CBF5
DOSCODE:CBF6
DOSCODE:CBF6 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:CBF6
DOSCODE:CBF6
DOSCODE:CBF6 </span>chk_patchsum    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CBF6                 </span><span style="color:navy">push    di
</span><span style="color:black">DOSCODE:CBF7                 </span><span style="color:navy">repe cmpsb
</span><span style="color:black">DOSCODE:CBF9                 </span><span style="color:navy">jnz     short loc_CC14
</span><span style="color:black">DOSCODE:CBFB                 </span><span style="color:navy">mov     di, ss:</span><span style="color:green">87h
</span><span style="color:black">DOSCODE:CC00                 </span><span style="color:navy">mov     cx, bx
</span><span style="color:black">DOSCODE:CC02                 </span><span style="color:navy">mov     bx, ax
</span><span style="color:black">DOSCODE:CC04                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:CC06
DOSCODE:CC06 </span><span style="color:navy">loc_CC06:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CC06                 </span><span style="color:navy">add     ax, es:[di]
</span><span style="color:black">DOSCODE:CC09                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:CC0A                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:CC0B                 </span><span style="color:navy">loop    loc_CC06
</span><span style="color:black">DOSCODE:CC0D                 </span><span style="color:navy">pop     di
</span><span style="color:black">DOSCODE:CC0E                 </span><span style="color:navy">cmp     ax, bx
</span><span style="color:black">DOSCODE:CC10                 </span><span style="color:navy">jnz     short loc_CC14
</span><span style="color:black">DOSCODE:CC12                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:CC13                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:CC14 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:CC14
DOSCODE:CC14 </span><span style="color:navy">loc_CC14:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CC14                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:CC15                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:CC15 </span>chk_patchsum    <span style="color:black">endp
DOSCODE:CC15
DOSCODE:CC15 </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSCODE:CC16 </span>RScanPattern1   <span style="color:navy">db </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">40h</span><span style="color:navy">, </span><span style="color:#008040">0 </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:CC1E                 </span><span style="color:navy">db </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0
</span><span style="color:gray">DOSCODE:CC20 </span>RScanPattern2   <span style="color:navy">db </span><span style="color:#008040">8Bh</span><span style="color:navy">, </span><span style="color:#008040">0Eh</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">90h</span><span style="color:navy">, </span><span style="color:#008040">0E2h</span><span style="color:navy">, </span><span style="color:#008040">0FEh</span><span style="color:navy">, </span><span style="color:#008040">0E8h </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:CC28 </span>RScanPattern3   <span style="color:navy">db </span><span style="color:#008040">8Bh</span><span style="color:navy">, </span><span style="color:#008040">0Eh</span><span style="color:navy">, </span><span style="color:#008040">10h</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">0E2h</span><span style="color:navy">, </span><span style="color:#008040">0FEh</span><span style="color:navy">, </span><span style="color:#008040">0E8h </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:CC2F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:CC2F
DOSCODE:CC2F </span>RationalPatch<span style="color:navy">:                          </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:CC2F                 </span><span style="color:navy">cld
</span><span style="color:maroon">DOSCODE:CC30                 </span><span style="color:navy">pusha
</span><span style="color:maroon">DOSCODE:CC31                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:CC32                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:CC33                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">0Ah
</span><span style="color:maroon">DOSCODE:CC36                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">DOSCODE:CC37                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:CC38                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:CC38                 </span><span style="color:navy">mov     si, offset </span>RScanPattern1
<span style="color:maroon">DOSCODE:CC3B                 </span><span style="color:navy">mov     cx, </span><span style="color:green">10
</span><span style="color:maroon">DOSCODE:CC3E                 </span><span style="color:navy">repe cmpsb
</span><span style="color:maroon">DOSCODE:CC40                 </span><span style="color:navy">jnz     short </span>rpexit
<span style="color:maroon">DOSCODE:CC42                 </span><span style="color:navy">mov     ax, es:</span><span style="color:green">0
</span><span style="color:maroon">DOSCODE:CC46                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">348
</span><span style="color:maroon">DOSCODE:CC49                 </span><span style="color:navy">jb      short </span>rpexit
<span style="color:maroon">DOSCODE:CC4B                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">383
</span><span style="color:maroon">DOSCODE:CC4E                 </span><span style="color:navy">ja      short </span>rpexit
<span style="color:maroon">DOSCODE:CC50                 </span><span style="color:navy">call    </span>VerifyVersion
<span style="color:maroon">DOSCODE:CC53                 </span><span style="color:navy">jnz     short </span>rpexit
<span style="color:maroon">DOSCODE:CC55                 </span><span style="color:navy">mov     cx, es:</span><span style="color:green">16h
</span><span style="color:maroon">DOSCODE:CC5A                 </span><span style="color:navy">sub     cx, </span><span style="color:#ff8000">200h
</span><span style="color:maroon">DOSCODE:CC5E                 </span><span style="color:navy">mov     es, word ptr es:</span><span style="color:green">20h
</span><span style="color:maroon">DOSCODE:CC63                 </span><span style="color:navy">mov     si, offset </span>RScanPattern2
<span style="color:maroon">DOSCODE:CC66                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">8
</span><span style="color:maroon">DOSCODE:CC69                 </span><span style="color:navy">call    </span>ScanCodeSeq
<span style="color:maroon">DOSCODE:CC6C                 </span><span style="color:navy">jz      short </span>rpfound
<span style="color:maroon">DOSCODE:CC6E                 </span><span style="color:navy">mov     si, offset </span>RScanPattern3
<span style="color:maroon">DOSCODE:CC71                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">0Fh
</span><span style="color:maroon">DOSCODE:CC74                 </span><span style="color:navy">call    </span>ScanCodeSeq
<span style="color:maroon">DOSCODE:CC77                 </span><span style="color:navy">jnz     short </span>rpexit
<span style="color:maroon">DOSCODE:CC79
DOSCODE:CC79 </span>rpfound<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CC79                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">9Ah         </span>; far call opcode
<span style="color:maroon">DOSCODE:CC7B                 </span><span style="color:navy">stosb
</span><span style="color:maroon">DOSCODE:CC7C                 </span><span style="color:navy">mov     ax, offset </span>RatBugCode
<span style="color:maroon">DOSCODE:CC7F                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:CC80                 </span><span style="color:navy">mov     ax, ss
</span><span style="color:maroon">DOSCODE:CC82                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:CC83                 </span><span style="color:navy">mov     cx, dx
</span><span style="color:maroon">DOSCODE:CC85                 </span><span style="color:navy">sub     cx, </span><span style="color:#ff8000">6           </span>; filler (with NOPs)
<span style="color:maroon">DOSCODE:CC88                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">90h
</span><span style="color:maroon">DOSCODE:CC8A                 </span><span style="color:navy">rep stosb
</span><span style="color:maroon">DOSCODE:CC8C
DOSCODE:CC8C </span>rpexit<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CC8C                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:CC8D                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:CC8D                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:CC8E                 </span><span style="color:navy">popa
</span><span style="color:maroon">DOSCODE:CC8F                 </span><span style="color:navy">retn
</span><span style="color:maroon">DOSCODE:CC8F </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSCODE:CC90 </span>CPScanPattern   <span style="color:navy">db </span><span style="color:#008040">89h</span><span style="color:navy">, </span><span style="color:#008040">26h</span><span style="color:navy">, </span><span style="color:#008040">48h</span><span style="color:navy">, </span><span style="color:#008040">1     </span><span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:CC94                 </span><span style="color:navy">db </span><span style="color:#008040">8Ch</span><span style="color:navy">, </span><span style="color:#008040">0Eh</span><span style="color:navy">, </span><span style="color:#008040">4Ch</span><span style="color:navy">, </span><span style="color:#008040">1
</span><span style="color:gray">DOSCODE:CC98                 </span><span style="color:navy">db </span><span style="color:#008040">0C7h</span><span style="color:navy">, </span><span style="color:#008040">6</span><span style="color:navy">, </span><span style="color:#008040">4Ah</span><span style="color:navy">, </span><span style="color:#008040">1</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">1
</span><span style="color:gray">DOSCODE:CC9E                 </span><span style="color:navy">db </span><span style="color:#008040">8Ch</span><span style="color:navy">, </span><span style="color:#008040">0Eh</span><span style="color:navy">, </span><span style="color:#008040">13h</span><span style="color:navy">, </span><span style="color:#008040">1
</span><span style="color:gray">DOSCODE:CCA2                 </span><span style="color:navy">db </span><span style="color:#008040">0B8h</span><span style="color:navy">, </span><span style="color:#008040">20h</span><span style="color:navy">, </span><span style="color:#008040">1
</span><span style="color:gray">DOSCODE:CCA5                 </span><span style="color:navy">db </span><span style="color:#008040">0BEh</span><span style="color:navy">, </span><span style="color:#008040">0</span><span style="color:navy">, </span><span style="color:#008040">1
</span><span style="color:black">DOSCODE:CCA8
DOSCODE:CCA8 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:CCA8
DOSCODE:CCA8
DOSCODE:CCA8 </span>IsCopyProt      <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CCA8                 </span><span style="color:navy">cmp     word ptr ds:</span><span style="color:green">11Bh</span><span style="color:navy">, </span><span style="color:#ff8000">5343h </span>; cmp word [CPID1Offset],ID1
<span style="color:black">DOSCODE:CCAE                 </span><span style="color:navy">jnz     short </span>CP_done
<span style="color:black">DOSCODE:CCB0                 </span><span style="color:navy">cmp     word ptr ds:</span><span style="color:green">173h</span><span style="color:navy">, </span><span style="color:#ff8000">5044h </span>; cmp word [CPID2Offset],ID2
<span style="color:black">DOSCODE:CCB6                 </span><span style="color:navy">jnz     short </span>CP_done
<span style="color:black">DOSCODE:CCB8                 </span><span style="color:navy">cmp     word ptr ds:</span><span style="color:green">146h</span><span style="color:navy">, </span><span style="color:green">0F413h </span>; cmp word [CPID3Offset],ID3
<span style="color:black">DOSCODE:CCBE                 </span><span style="color:navy">jnz     short </span>CP_done
<span style="color:black">DOSCODE:CCC0                 </span><span style="color:navy">cmp     word ptr ds:</span><span style="color:green">124h</span><span style="color:navy">, </span><span style="color:green">8000h </span>; cmp word [CPID4Offset],ID4
<span style="color:black">DOSCODE:CCC6                 </span><span style="color:navy">jnz     short </span>CP_done
<span style="color:black">DOSCODE:CCC8                 </span><span style="color:navy">push    cs
</span><span style="color:black">DOSCODE:CCC9                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:CCCA                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:CCCA                 </span><span style="color:navy">mov     di, offset </span>CPScanPattern
<span style="color:black">DOSCODE:CCCD                 </span><span style="color:navy">mov     si, </span><span style="color:#ff8000">175h        </span>; CPStartOffset
<span style="color:black">DOSCODE:CCD0                 </span><span style="color:navy">mov     cx, </span><span style="color:green">24          </span>; CPSPlen
<span style="color:black">DOSCODE:CCD3                 </span><span style="color:navy">repe cmpsb
</span><span style="color:black">DOSCODE:CCD5                 </span><span style="color:navy">jnz     short </span>CP_done
<span style="color:black">DOSCODE:CCD7                 </span><span style="color:navy">mov     ss:</span>A20OFF_COUNT<span style="color:navy">, </span><span style="color:#ff8000">0Ah
</span><span style="color:black">DOSCODE:CCDD
DOSCODE:CCDD </span>CP_done<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CCDD                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:CCDD </span>IsCopyProt      <span style="color:black">endp
DOSCODE:CCDD
</span><span style="color:maroon">DOSCODE:CCDE </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:CCDE
DOSCODE:CCDE </span>initiret<span style="color:navy">:                               </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:CCDE                 </span><span style="color:navy">iret
</span><span style="color:maroon">DOSCODE:CCDE </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSCODE:CCDF </span>InitBioDataSeg  <span style="color:navy">dw </span><span style="color:#008040">70h                  </span><span style="color:#8080ff">; ...
</span><span style="color:black">DOSCODE:CCE1
DOSCODE:CCE1 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:CCE1
DOSCODE:CCE1
DOSCODE:CCE1 </span>ParaRound       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CCE1                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">0Fh
</span><span style="color:black">DOSCODE:CCE4                 </span><span style="color:navy">rcr     ax, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:CCE6                 </span><span style="color:navy">shr     ax, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:CCE8                 </span><span style="color:navy">shr     ax, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:CCEA                 </span><span style="color:navy">shr     ax, </span><span style="color:green">1
</span><span style="color:black">DOSCODE:CCEC                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:CCEC </span>ParaRound       <span style="color:black">endp
DOSCODE:CCEC
DOSCODE:CCED
DOSCODE:CCED </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:CCED
DOSCODE:CCED
DOSCODE:CCED </span>WhatCPUType     <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CCED                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:CCEE                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:CCEF                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">DOSCODE:CCF1                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:CCF3                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:CCF4                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:CCF5                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:CCF6                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:CCF7                 </span><span style="color:navy">and     ax, </span><span style="color:green">0F000h
</span><span style="color:black">DOSCODE:CCFA                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0F000h
</span><span style="color:black">DOSCODE:CCFD                 </span><span style="color:navy">jz      short loc_CD0D
</span><span style="color:black">DOSCODE:CCFF                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0F000h
</span><span style="color:black">DOSCODE:CD02                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:CD03                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:CD04                 </span><span style="color:navy">pushf
</span><span style="color:black">DOSCODE:CD05                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:CD06                 </span><span style="color:navy">and     ax, </span><span style="color:green">0F000h
</span><span style="color:black">DOSCODE:CD09                 </span><span style="color:navy">jz      short loc_CD0C
</span><span style="color:black">DOSCODE:CD0B                 </span><span style="color:navy">inc     bx
</span><span style="color:black">DOSCODE:CD0C
DOSCODE:CD0C </span><span style="color:navy">loc_CD0C:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CD0C                 </span><span style="color:navy">inc     bx
</span><span style="color:black">DOSCODE:CD0D
DOSCODE:CD0D </span><span style="color:navy">loc_CD0D:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:CD0D                 </span><span style="color:navy">mov     ax, bx
</span><span style="color:black">DOSCODE:CD0F                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:CD10                 </span><span style="color:navy">popf
</span><span style="color:black">DOSCODE:CD11                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:CD11 </span>WhatCPUType     <span style="color:black">endp
DOSCODE:CD11
</span><span style="color:maroon">DOSCODE:CD12 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:CD12
DOSCODE:CD12 </span>DOSINIT<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CD12                 </span><span style="color:navy">cli
</span><span style="color:maroon">DOSCODE:CD13                 </span><span style="color:navy">cld
</span><span style="color:maroon">DOSCODE:CD14                 </span><span style="color:navy">push    dx              </span>; top of memory (memory size in paragraphs)
<span style="color:maroon">DOSCODE:CD15                 </span><span style="color:navy">push    si              </span>; 0
<span style="color:maroon">DOSCODE:CD16                 </span><span style="color:navy">push    ds              </span>; IBMDOS.SYS loading segment
<span style="color:maroon">DOSCODE:CD17                 </span><span style="color:navy">push    di              </span>; 0
<span style="color:maroon">DOSCODE:CD18                 </span><span style="color:navy">mov     bx, es          </span>; CURRENT_DOS_LOCATION (segment)
<span style="color:maroon">DOSCODE:CD1A                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0D20Fh      </span>; MEMSTRT ; get offset of end of init code
<span style="color:maroon">DOSCODE:CD1D                 </span><span style="color:navy">add     ax, </span><span style="color:#ff8000">0Fh         </span>; round up
<span style="color:maroon">DOSCODE:CD20                 </span><span style="color:navy">and     ax, </span><span style="color:green">0FFF0h
</span><span style="color:maroon">DOSCODE:CD23                 </span><span style="color:navy">mov     si, ax          </span>; DOSDATA segment offset in IBMDOS.SYS
<span style="color:maroon">DOSCODE:CD25                 </span><span style="color:navy">push    cs
</span><span style="color:maroon">DOSCODE:CD26                 </span><span style="color:navy">pop     ds              </span>; DOSCODE segment
<span style="color:maroon">DOSCODE:CD27                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:CD27                 </span><span style="color:navy">mov     es, cs:</span>InitBioDataSeg ; BIOSDATA segment (always 0070h)
<span style="color:maroon">DOSCODE:CD2C                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:CD2C                 </span><span style="color:navy">mov     es, word ptr es:</span><span style="color:green">3 </span>; DOSDATA segment ptr
<span style="color:maroon">DOSCODE:CD31                 </span>assume es:DOSCODE
<span style="color:maroon">DOSCODE:CD31                 </span><span style="color:navy">xor     di, di          </span>; offset 0
<span style="color:maroon">DOSCODE:CD33                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">1346h       </span>; DOSDATA size (4934 bytes)
<span style="color:maroon">DOSCODE:CD36                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">DOSCODE:CD38                 </span><span style="color:navy">pop     di
</span><span style="color:maroon">DOSCODE:CD39                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:CD3A                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:CD3A                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:CD3B                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:CD3C                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:CD3D                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:CD3E                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:CD3F                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:CD3F                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:CD40                 </span><span style="color:navy">mov     ds:</span>BiosComBlockPtr<span style="color:navy">, di </span>; CURRENT_DOS_LOCATION (offset = 0)
<span style="color:maroon">DOSCODE:CD44                 </span><span style="color:navy">mov     ds:</span>BiosComBlockPtr<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, bx </span>; CURRENT_DOS_LOCATION (segment)
<span style="color:maroon">DOSCODE:CD48                 </span><span style="color:navy">mov     cs:</span>DosDSeg<span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:CD4D                 </span><span style="color:navy">mov     cs:</span>LowInt23_SEG<span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:CD52                 </span><span style="color:navy">mov     cs:</span>LowInt24_SEG<span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:CD57                 </span><span style="color:navy">mov     cs:</span>LowInt28_SEG<span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:CD5C                 </span><span style="color:navy">mov     ds:</span>ENDMEM<span style="color:navy">, dx
</span><span style="color:maroon">DOSCODE:CD60                 </span><span style="color:navy">mov     ds:</span>USER_SP<span style="color:navy">, sp
</span><span style="color:maroon">DOSCODE:CD64                 </span><span style="color:navy">mov     ds:</span>USER_SS<span style="color:navy">, ss
</span><span style="color:maroon">DOSCODE:CD68                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:CD69                 </span><span style="color:navy">pop     ss
</span><span style="color:maroon">DOSCODE:CD6A                 </span><span style="color:navy">mov     sp, offset </span>DSKSTACK <span style="color:gray">; &quot;@#IBM:12.01.2003.build_1.32#@ IBMDOS.CO&quot;...
</span><span style="color:maroon">DOSCODE:CD6D                 </span><span style="color:navy">mov     ax, offset </span>RetExePatch
<span style="color:maroon">DOSCODE:CD70                 </span><span style="color:navy">mov     ds:</span>FixExePatch<span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:CD73                 </span><span style="color:navy">mov     ds:</span>RationalPatchPtr<span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:CD76                 </span><span style="color:navy">mov     ds:</span>ChkCopyProt<span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:CD79                 </span><span style="color:navy">call    </span>WhatCPUType
<span style="color:maroon">DOSCODE:CD7C                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">2
</span><span style="color:maroon">DOSCODE:CD7E                 </span><span style="color:navy">mov     ax, offset </span>Rational386Patch
<span style="color:maroon">DOSCODE:CD81                 </span><span style="color:navy">jnb     short </span>di_set_patch
<span style="color:maroon">DOSCODE:CD83                 </span><span style="color:navy">mov     ax, offset </span>RetExePatch
<span style="color:maroon">DOSCODE:CD86
DOSCODE:CD86 </span>di_set_patch<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CD86                 </span><span style="color:navy">mov     ds:</span>Rational386PatchPtr<span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:CD89                 </span><span style="color:navy">mov     ax, cs
</span><span style="color:maroon">DOSCODE:CD8B                 </span><span style="color:navy">mov     ds:</span>TEMP_DOSLOC<span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:CD8E                 </span><span style="color:navy">mov     ds:</span>NULDEV<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:maroon">DOSCODE:CD92                 </span><span style="color:navy">mov     ds:</span>NULDEV<span style="color:navy">, si
</span><span style="color:maroon">DOSCODE:CD96                 </span><span style="color:navy">mov     ds:word_EF1, ds
</span><span style="color:maroon">DOSCODE:CD9A                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:CD9B                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">7
</span><span style="color:maroon">DOSCODE:CD9E                 </span><span style="color:navy">mov     si, offset </span>InsTBL_CONTPOS_seg
<span style="color:maroon">DOSCODE:CDA1
DOSCODE:CDA1 </span>Instance_init_loop<span style="color:navy">:                     </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CDA1                 </span><span style="color:navy">mov     word ptr [si], ds
</span><span style="color:maroon">DOSCODE:CDA3                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">6
</span><span style="color:maroon">DOSCODE:CDA6                 </span><span style="color:navy">loop    </span>Instance_init_loop
<span style="color:maroon">DOSCODE:CDA8                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">5
</span><span style="color:maroon">DOSCODE:CDAB                 </span><span style="color:navy">mov     si, offset </span>OldInstanceJunk_6
<span style="color:maroon">DOSCODE:CDAE
DOSCODE:CDAE </span>OldInstance_init_loop<span style="color:navy">:                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CDAE                 </span><span style="color:navy">mov     word ptr [si], ds
</span><span style="color:maroon">DOSCODE:CDB0                 </span><span style="color:navy">add     si, </span><span style="color:#ff8000">6
</span><span style="color:maroon">DOSCODE:CDB3                 </span><span style="color:navy">loop    </span>OldInstance_init_loop
<span style="color:maroon">DOSCODE:CDB5                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:CDB6                 </span><span style="color:navy">push    es
</span><span style="color:maroon">DOSCODE:CDB7                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:CDB8                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:CDB9                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">DOSCODE:CDBB                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">DOSCODE:CDBD                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:CDBD                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0CCDEh
</span><span style="color:maroon">DOSCODE:CDC0                 </span><span style="color:navy">mov     </span>word ptr 0:0A8h<span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:CDC3                 </span><span style="color:navy">mov     ax, cs
</span><span style="color:maroon">DOSCODE:CDC5                 </span><span style="color:navy">mov     </span>word ptr 0:0A8+2<span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:CDC8                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:CDC9                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:CDC9                 </span><span style="color:navy">call    </span>CHARINIT
<span style="color:maroon">DOSCODE:CDCC                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:CDCD                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:CDCE                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:CDCF                 </span><span style="color:navy">mov     di, offset </span>SFT0_SFTable
<span style="color:maroon">DOSCODE:CDD2                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3
</span><span style="color:maroon">DOSCODE:CDD5                 </span><span style="color:navy">stosw                   </span>; SF_ENTRY.sf_ref_count
<span style="color:maroon">DOSCODE:CDD6                 </span><span style="color:navy">dec     al
</span><span style="color:maroon">DOSCODE:CDD8                 </span><span style="color:navy">stosw                   </span>; .sf_mode
<span style="color:maroon">DOSCODE:CDD9                 </span><span style="color:navy">xor     al, al
</span><span style="color:maroon">DOSCODE:CDDB                 </span><span style="color:navy">stosb                   </span>; .sf_attr
<span style="color:maroon">DOSCODE:CDDC                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0C3h
</span><span style="color:maroon">DOSCODE:CDDE                 </span><span style="color:navy">stosw                   </span>; .sf_flags
<span style="color:maroon">DOSCODE:CDDF                 </span><span style="color:navy">mov     ax, si
</span><span style="color:maroon">DOSCODE:CDE1                 </span><span style="color:navy">stosw                   </span>; .sf_devptr
<span style="color:maroon">DOSCODE:CDE2                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:maroon">DOSCODE:CDE4                 </span><span style="color:navy">stosw                   </span>; SFT0_SFTable + 9 ; .sf_devptr_hw
<span style="color:maroon">DOSCODE:CDE5                 </span><span style="color:navy">xor     ax, ax          </span>; 0
<span style="color:maroon">DOSCODE:CDE7                 </span><span style="color:navy">add     di, </span><span style="color:green">32
</span><span style="color:maroon">DOSCODE:CDEA                 </span><span style="color:navy">stosw                   </span>; SFT0_SFTable + 43 ; .sf_position
<span style="color:maroon">DOSCODE:CDEB                 </span><span style="color:navy">stosw                   </span>; .sf_position_hw
<span style="color:maroon">DOSCODE:CDEC                 </span><span style="color:navy">add     di, -</span><span style="color:green">34         </span>; 0FFDEh
<span style="color:maroon">DOSCODE:CDEF                 </span><span style="color:navy">stosw                   </span>; SFT0_SFTable + 13 ; .sf_firclus
<span style="color:maroon">DOSCODE:CDF0                 </span><span style="color:navy">stosw                   </span>; .sf_firclus_hw
<span style="color:maroon">DOSCODE:CDF1                 </span><span style="color:navy">dec     ax              </span>; -1
<span style="color:maroon">DOSCODE:CDF2                 </span><span style="color:navy">stosw                   </span>; SFT0_SFTable + 17 ; .sf_time
<span style="color:maroon">DOSCODE:CDF3                 </span><span style="color:navy">stosw                   </span>; .sf_date
<span style="color:maroon">DOSCODE:CDF4                 </span><span style="color:navy">inc     ax              </span>; 0
<span style="color:maroon">DOSCODE:CDF5                 </span><span style="color:navy">stosw                   </span>; SFT0_SFTable + 21 ; .sf_size
<span style="color:maroon">DOSCODE:CDF6                 </span><span style="color:navy">stosw                   </span>; .sf_size_hw
<span style="color:maroon">DOSCODE:CDF7                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">7           </span>; SF_ENTRY.sf_name-SF_ENTRY.sf_cluspos
<span style="color:maroon">DOSCODE:CDF7                                         </span>; SFT0_SFTable + 32
<span style="color:maroon">DOSCODE:CDFA                 </span><span style="color:navy">add     si, </span><span style="color:green">10          </span>; SYSDEV.NAME
<span style="color:maroon">DOSCODE:CDFD                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:CE00                 </span><span style="color:navy">rep movsw
</span><span style="color:maroon">DOSCODE:CE02                 </span><span style="color:navy">mov     cl, </span><span style="color:#ff8000">3
</span><span style="color:maroon">DOSCODE:CE04                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">20h </span><span style="color:gray">; &#039; &#039;
</span><span style="color:maroon">DOSCODE:CE06                 </span><span style="color:navy">rep stosb               </span>; SFT0_SFTable + 40
<span style="color:maroon">DOSCODE:CE08                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:CE09                 </span><span style="color:navy">or      byte ptr [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">3 </span>; ISCIN|ISCOUT
<span style="color:maroon">DOSCODE:CE0D                 </span><span style="color:navy">mov     word ptr ss:</span>BCON<span style="color:navy">, si
</span><span style="color:maroon">DOSCODE:CE12                 </span><span style="color:navy">mov     word ptr ss:</span>BCON<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:CE17
DOSCODE:CE17 </span>CHAR_INIT_LOOP<span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CE17                 </span><span style="color:navy">lds     si, [si]
</span><span style="color:maroon">DOSCODE:CE19                 </span><span style="color:navy">call    </span>CHARINIT
<span style="color:maroon">DOSCODE:CE1C                 </span><span style="color:navy">test    byte ptr [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">8
</span><span style="color:maroon">DOSCODE:CE20                 </span><span style="color:navy">jz      short </span>CHAR_INIT_LOOP
<span style="color:maroon">DOSCODE:CE22                 </span><span style="color:navy">mov     word ptr ss:</span>BCLOCK<span style="color:navy">, si
</span><span style="color:maroon">DOSCODE:CE27                 </span><span style="color:navy">mov     word ptr ss:</span>BCLOCK<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:CE2C                 </span><span style="color:navy">mov     bp, </span><span style="color:#ff8000">1346h       </span>; MEMSTRT ; ES:BP points to DPB
<span style="color:maroon">DOSCODE:CE2F                 </span><span style="color:navy">mov     word ptr ss:</span>DPBHEAD<span style="color:navy">, bp
</span><span style="color:maroon">DOSCODE:CE34                 </span><span style="color:navy">mov     word ptr ss:</span>DPBHEAD<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:maroon">DOSCODE:CE39
DOSCODE:CE39 </span>PERDRV<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CE39                 </span><span style="color:navy">lds     si, [si]
</span><span style="color:maroon">DOSCODE:CE3B                 </span><span style="color:navy">cmp     si, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:CE3E                 </span><span style="color:navy">jnz     short </span>PERDRV2
<span style="color:maroon">DOSCODE:CE40                 </span><span style="color:navy">jmp     </span>CONTINIT
<span style="color:maroon">DOSCODE:CE43 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:CE43
DOSCODE:CE43 </span>PERDRV2<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CE43                 </span><span style="color:navy">call    </span>CHARINIT
<span style="color:maroon">DOSCODE:CE46                 </span><span style="color:navy">test    word ptr [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], </span><span style="color:green">8000h </span>; [SI+SYSDEV.ATT],DEVTYP
<span style="color:maroon">DOSCODE:CE4B                 </span><span style="color:navy">jnz     short </span>PERDRV
<span style="color:maroon">DOSCODE:CE4D                 </span><span style="color:navy">mov     cl, ss:</span>CALLUNIT
<span style="color:maroon">DOSCODE:CE52                 </span><span style="color:navy">xor     ch, ch
</span><span style="color:maroon">DOSCODE:CE54                 </span><span style="color:navy">mov     [si+</span><span style="color:green">10</span><span style="color:navy">], cl     </span>; [si+SYSDEV.NAME]
<span style="color:maroon">DOSCODE:CE57                 </span><span style="color:navy">mov     dl, ss:</span>NUMIO
<span style="color:maroon">DOSCODE:CE5C                 </span><span style="color:navy">xor     dh, dh
</span><span style="color:maroon">DOSCODE:CE5E                 </span><span style="color:navy">add     ss:</span>NUMIO<span style="color:navy">, cl
</span><span style="color:maroon">DOSCODE:CE63                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:CE64                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:CE65                 </span><span style="color:navy">lds     bx, dword ptr ss:</span>CALLBPB
<span style="color:maroon">DOSCODE:CE6A
DOSCODE:CE6A </span>PERUNIT<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CE6A                 </span><span style="color:navy">mov     si, [bx]        </span>; DS:SI Points to BPB
<span style="color:maroon">DOSCODE:CE6C                 </span><span style="color:navy">inc     bx
</span><span style="color:maroon">DOSCODE:CE6D                 </span><span style="color:navy">inc     bx
</span><span style="color:maroon">DOSCODE:CE6E                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">0</span><span style="color:navy">], dl   </span>; DPB.DRIVE
<span style="color:maroon">DOSCODE:CE72                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:#ff8000">1</span><span style="color:navy">], dh   </span>; DPB.UNIT
<span style="color:maroon">DOSCODE:CE76                 </span><span style="color:navy">push    bx
</span><span style="color:maroon">DOSCODE:CE77                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">DOSCODE:CE78                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:CE79                 </span><span style="color:navy">mov     dx, </span><span style="color:#ff8000">4152h       </span>; &#039;RA&#039;
<span style="color:maroon">DOSCODE:CE7C                 </span><span style="color:navy">xor     cx, cx          </span>; 0
<span style="color:maroon">DOSCODE:CE7E                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:green">29</span><span style="color:navy">], cx
</span><span style="color:maroon">DOSCODE:CE82                 </span><span style="color:navy">cmp     [si+</span><span style="color:green">11</span><span style="color:navy">], cx     </span>; BPB_FATSz16
<span style="color:maroon">DOSCODE:CE85                 </span><span style="color:navy">jnz     short </span>PERUNIT2  ; FAT (FAT12 or FAT16) -old DPB-
<span style="color:maroon">DOSCODE:CE87                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:green">57</span><span style="color:navy">], cx  </span>; FAT32 -new- DPB
<span style="color:maroon">DOSCODE:CE8B                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:green">59</span><span style="color:navy">], cx
</span><span style="color:maroon">DOSCODE:CE8F                 </span><span style="color:navy">dec     cx
</span><span style="color:maroon">DOSCODE:CE90                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:green">31</span><span style="color:navy">], cx
</span><span style="color:maroon">DOSCODE:CE94                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:green">33</span><span style="color:navy">], cx
</span><span style="color:maroon">DOSCODE:CE98                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4558h       </span>; &#039;XE&#039;
<span style="color:maroon">DOSCODE:CE9B
DOSCODE:CE9B </span>PERUNIT2<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CE9B                 </span><span style="color:navy">call    </span>$SETDPB
<span style="color:maroon">DOSCODE:CE9E                 </span><span style="color:navy">mov     ax, es:[bp+</span><span style="color:#ff8000">2</span><span style="color:navy">]
</span><span style="color:maroon">DOSCODE:CEA2                 </span><span style="color:navy">cmp     ax, ss:</span>MAXSEC
<span style="color:maroon">DOSCODE:CEA7                 </span><span style="color:navy">jbe     short </span>NOTMAX
<span style="color:maroon">DOSCODE:CEA9                 </span><span style="color:navy">mov     ss:</span>MAXSEC<span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:CEAD
DOSCODE:CEAD </span>NOTMAX<span style="color:navy">:                                 </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CEAD                 </span><span style="color:navy">mov     ax, bp
</span><span style="color:maroon">DOSCODE:CEAF                 </span><span style="color:navy">add     ax, </span><span style="color:green">61          </span>; next DPB (PCDOS 7.1 DPB size = 61)
<span style="color:maroon">DOSCODE:CEB2                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:green">25</span><span style="color:navy">], ax  </span>; DPB.NEXT_DPB offset
<span style="color:maroon">DOSCODE:CEB6                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:green">27</span><span style="color:navy">], es </span>; DPB.NEXT_DPB segment
<span style="color:maroon">DOSCODE:CEBA                 </span><span style="color:navy">mov     byte ptr es:[bp+</span><span style="color:green">24</span><span style="color:navy">], </span><span style="color:#ff8000">0FFh </span>; DPB.FIRST_ACCESS = -1
<span style="color:maroon">DOSCODE:CEBF                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:CEC0                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">DOSCODE:CEC1                 </span><span style="color:navy">pop     bx
</span><span style="color:maroon">DOSCODE:CEC2                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:maroon">DOSCODE:CEC4                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:CEC5                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:CEC6                 </span><span style="color:navy">mov     es:[bp+</span><span style="color:green">19</span><span style="color:navy">], si  </span>; DPB.DRIVER_ADDR offset
<span style="color:maroon">DOSCODE:CECA                 </span><span style="color:navy">mov     word ptr es:[bp+</span><span style="color:green">21</span><span style="color:navy">], ds </span>; DPB.DRIVER_ADDR segment
<span style="color:maroon">DOSCODE:CECE                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:CECF                 </span><span style="color:navy">push    si
</span><span style="color:maroon">DOSCODE:CED0                 </span><span style="color:navy">inc     dh
</span><span style="color:maroon">DOSCODE:CED2                 </span><span style="color:navy">inc     dl
</span><span style="color:maroon">DOSCODE:CED4                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">DOSCODE:CED6                 </span><span style="color:navy">add     bp, </span><span style="color:green">61          </span>; DPBSIZ
<span style="color:maroon">DOSCODE:CED9                 </span><span style="color:navy">loop    </span>PERUNIT
<span style="color:maroon">DOSCODE:CEDB                 </span><span style="color:navy">pop     si
</span><span style="color:maroon">DOSCODE:CEDC                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:CEDD                 </span><span style="color:navy">jmp     </span>PERDRV
<span style="color:maroon">DOSCODE:CEE0 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:CEE0
DOSCODE:CEE0 </span>CONTINIT<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CEE0                 </span><span style="color:navy">sub     bp, </span><span style="color:green">61          </span>; sub bp,DPBSIZ ; back up to last dpb
<span style="color:maroon">DOSCODE:CEE3                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:CEE6                 </span><span style="color:navy">mov     [bp+</span><span style="color:green">25</span><span style="color:navy">], ax     </span>; [bp+DPB.NEXT_DPB],-1
<span style="color:maroon">DOSCODE:CEE9                 </span><span style="color:navy">mov     [bp+</span><span style="color:green">27</span><span style="color:navy">], ax
</span><span style="color:maroon">DOSCODE:CEEC                 </span><span style="color:navy">add     bp, </span><span style="color:green">61
</span><span style="color:maroon">DOSCODE:CEEF                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:CEF0                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:CEF1                 </span><span style="color:navy">mov     ax, bp
</span><span style="color:maroon">DOSCODE:CEF3                 </span><span style="color:navy">call    </span>ParaRound
<span style="color:maroon">DOSCODE:CEF6                 </span><span style="color:navy">mov     dx, ds
</span><span style="color:maroon">DOSCODE:CEF8                 </span><span style="color:navy">add     dx, ax
</span><span style="color:maroon">DOSCODE:CEFA                 </span><span style="color:navy">mov     bx, </span><span style="color:#ff8000">0Fh
</span><span style="color:maroon">DOSCODE:CEFD                 </span><span style="color:navy">mov     cx, ds:</span>ENDMEM
<span style="color:maroon">DOSCODE:CF01                 </span><span style="color:navy">mov     ds:</span>DOSSEG_INIT<span style="color:navy">, ds </span>; [DSKCHRET+3]
<span style="color:maroon">DOSCODE:CF05                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:CF06                 </span><span style="color:navy">mov     ax, ds:</span>TEMP_DOSLOC
<span style="color:maroon">DOSCODE:CF09                 </span><span style="color:navy">mov     es, ax
</span><span style="color:maroon">DOSCODE:CF0B                 </span><span style="color:navy">mov     ds:</span>TEMP_DOSLOC<span style="color:navy">, </span><span style="color:green">0FFFFh
</span><span style="color:maroon">DOSCODE:CF11                 </span><span style="color:navy">call    </span>patch_vec_segments
<span style="color:maroon">DOSCODE:CF14                 </span><span style="color:navy">call    </span>patch_misc_segments
<span style="color:maroon">DOSCODE:CF17                 </span><span style="color:navy">mov     ds:</span>TEMP_DOSLOC<span style="color:navy">, es
</span><span style="color:maroon">DOSCODE:CF1B                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:CF1C                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">DOSCODE:CF1E                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">DOSCODE:CF20                 </span>assume ds:DOSCODE
<span style="color:maroon">DOSCODE:CF20                 </span><span style="color:navy">mov     es, ax          </span>; 0
<span style="color:maroon">DOSCODE:CF22                 </span>assume es:DOSCODE
<span style="color:maroon">DOSCODE:CF22                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">90h         </span>; INT 24h vector
<span style="color:maroon">DOSCODE:CF22                                         </span>; addr_int_fatal_abort
<span style="color:maroon">DOSCODE:CF25                 </span><span style="color:navy">mov     ax, ss:</span>TEMP_DOSLOC
<span style="color:maroon">DOSCODE:CF29                 </span><span style="color:navy">mov     [di+</span><span style="color:#ff8000">2</span><span style="color:navy">], ax      </span>; segment
<span style="color:maroon">DOSCODE:CF2C                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">82h         </span>; INTBASE+2
<span style="color:maroon">DOSCODE:CF2F                 </span><span style="color:navy">mov     </span>word ptr 0<span style="color:navy">, offset </span>DIVOV
<span style="color:maroon">DOSCODE:CF35                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">80h         </span>; INTBASE
<span style="color:maroon">DOSCODE:CF38                 </span><span style="color:navy">mov     ax, offset </span>irett
<span style="color:maroon">DOSCODE:CF3B                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">9
</span><span style="color:maroon">DOSCODE:CF3E
DOSCODE:CF3E </span>iset1<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CF3E                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:CF3F                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">DOSCODE:CF40                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">DOSCODE:CF41                 </span><span style="color:navy">loop    </span>iset1
<span style="color:maroon">DOSCODE:CF43                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">4
</span><span style="color:maroon">DOSCODE:CF46                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">6
</span><span style="color:maroon">DOSCODE:CF49
DOSCODE:CF49 </span>iset2<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CF49                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:CF4A                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">DOSCODE:CF4B                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">DOSCODE:CF4C                 </span><span style="color:navy">loop    </span>iset2
<span style="color:maroon">DOSCODE:CF4E                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">8
</span><span style="color:maroon">DOSCODE:CF51                 </span><span style="color:navy">mov     cx, </span><span style="color:green">14
</span><span style="color:maroon">DOSCODE:CF54
DOSCODE:CF54 </span>iset3<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:CF54                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:CF55                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">DOSCODE:CF56                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">DOSCODE:CF57                 </span><span style="color:navy">loop    </span>iset3
<span style="color:maroon">DOSCODE:CF59                 </span><span style="color:navy">mov     </span>word ptr 00BCh<span style="color:navy">, offset </span>INT2F ; mov word [02Fh*4],INT2F
<span style="color:maroon">DOSCODE:CF5F                 </span><span style="color:navy">mov     ax, ss:</span>TEMP_DOSLOC
<span style="color:maroon">DOSCODE:CF63                 </span><span style="color:navy">mov     </span>word ptr 00BEh<span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:CF66                 </span><span style="color:navy">mov     </span>byte ptr 00C0h<span style="color:navy">, </span><span style="color:#ff8000">0EAh </span>; mov byte [ENTRYPOINT],mi_long_jmp
<span style="color:maroon">DOSCODE:CF6B                 </span><span style="color:navy">mov     </span>word ptr 00C1h<span style="color:navy">, offset </span>CALL_ENTRY ; mov word [ENTRYPOINT+1],CALL_ENTRY
<span style="color:maroon">DOSCODE:CF71                 </span><span style="color:navy">mov     </span>word ptr 0080h<span style="color:navy">, offset </span>QUIT ; mov word [addr_int_abort],QUIT
<span style="color:maroon">DOSCODE:CF77                 </span><span style="color:navy">mov     </span>word ptr 0084h<span style="color:navy">, offset </span>COMMAND ; mov word [addr_int_command],COMMAND
<span style="color:maroon">DOSCODE:CF7D                 </span><span style="color:navy">mov     </span>word ptr 0088h<span style="color:navy">, </span><span style="color:#ff8000">100h </span>; mov word [addr_int_terminate],100h
<span style="color:maroon">DOSCODE:CF83                 </span><span style="color:navy">mov     </span>word ptr 008Ah<span style="color:navy">, dx </span>; mov word [addr_int_terminate+2],dx
<span style="color:maroon">DOSCODE:CF87                 </span><span style="color:navy">mov     </span>word ptr 0094h<span style="color:navy">, offset </span>ABSDRD ; mov word [addr_int_disk_read],ABSDRD
<span style="color:maroon">DOSCODE:CF8D                 </span><span style="color:navy">mov     </span>word ptr 0098h<span style="color:navy">, offset </span>ABSDWRT ; mov word [addr_int_disk_write],ABSDWRT
<span style="color:maroon">DOSCODE:CF93                 </span><span style="color:navy">mov     </span>word ptr 009Ch<span style="color:navy">, offset </span>stay_resident ; mov word [addr_int_keep_process],STAY_RESIDENT
<span style="color:maroon">DOSCODE:CF99                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:CF9A                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:CF9B                 </span>assume ds:nothing
<span style="color:maroon">DOSCODE:CF9B                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:CF9C                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:CF9D                 </span>assume es:nothing
<span style="color:maroon">DOSCODE:CF9D                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">DOSCODE:CF9E                 </span><span style="color:navy">inc     dx
</span><span style="color:maroon">DOSCODE:CF9F                 </span><span style="color:navy">mov     ds:</span>CurrentPDB<span style="color:navy">, dx
</span><span style="color:maroon">DOSCODE:CFA3                 </span><span style="color:navy">xor     di, di
</span><span style="color:maroon">DOSCODE:CFA5                 </span><span style="color:navy">mov     es, dx
</span><span style="color:maroon">DOSCODE:CFA7                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">DOSCODE:CFA9                 </span><span style="color:navy">mov     cx, </span><span style="color:green">128
</span><span style="color:maroon">DOSCODE:CFAC                 </span><span style="color:navy">rep stosw
</span><span style="color:maroon">DOSCODE:CFAE                 </span><span style="color:navy">mov     ax, ds:</span>ENDMEM
<span style="color:maroon">DOSCODE:CFB1                 </span><span style="color:navy">call    </span>SETMEM
<span style="color:maroon">DOSCODE:CFB4                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:CFB5                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:CFB6                 </span><span style="color:navy">mov     di, </span><span style="color:green">24          </span>; PDB.JFN_TABLE
<span style="color:maroon">DOSCODE:CFB9                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">DOSCODE:CFBB                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:CFBC                 </span><span style="color:navy">stosb
</span><span style="color:maroon">DOSCODE:CFBD                 </span><span style="color:navy">mov     al, </span><span style="color:#ff8000">0FFh
</span><span style="color:maroon">DOSCODE:CFBF                 </span><span style="color:navy">mov     cx, </span><span style="color:green">17          </span>; FILPERPROC-3
<span style="color:maroon">DOSCODE:CFC2                 </span><span style="color:navy">rep stosb
</span><span style="color:maroon">DOSCODE:CFC4                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">DOSCODE:CFC5                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:CFC6                 </span><span style="color:navy">mov     word ptr ds:</span>SFT_ADDR<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, ds
</span><span style="color:maroon">DOSCODE:CFCA                 </span><span style="color:navy">mov     si, offset </span>SysInitTable
<span style="color:maroon">DOSCODE:CFCD                 </span><span style="color:navy">mov     word ptr es:[si+</span><span style="color:#ff8000">6</span><span style="color:navy">], es </span>; [es:si+SYSI_EXT.Country_Tab+2]
<span style="color:maroon">DOSCODE:CFD1                 </span><span style="color:navy">mov     word ptr es:[si+</span><span style="color:#ff8000">2</span><span style="color:navy">], es </span>; [es:si+SYSI_EXT.SysInitVars+2]
<span style="color:maroon">DOSCODE:CFD5                 </span><span style="color:navy">mov     word ptr es:</span>BUFFHEAD<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:maroon">DOSCODE:CFDA                 </span><span style="color:navy">mov     si, offset </span>BufferQueue
<span style="color:maroon">DOSCODE:CFDD                 </span><span style="color:navy">mov     word ptr es:</span>BUFFHEAD<span style="color:navy">, si
</span><span style="color:maroon">DOSCODE:CFE2                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">DOSCODE:CFE3                 </span><span style="color:navy">mov     word ptr ds:</span>DMAADD<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, dx
</span><span style="color:maroon">DOSCODE:CFE7                 </span><span style="color:navy">mov     es:</span>arena_head<span style="color:navy">, dx
</span><span style="color:maroon">DOSCODE:CFEC                 </span><span style="color:navy">mov     ds, dx
</span><span style="color:maroon">DOSCODE:CFEE                 </span><span style="color:navy">mov     byte ptr ds:</span><span style="color:green">0</span><span style="color:navy">, </span><span style="color:#ff8000">5Ah </span><span style="color:gray">; &#039;Z&#039; </span>; [ARENA.SIGNATURE],arena_signature_end
<span style="color:maroon">DOSCODE:CFF3                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">1</span><span style="color:navy">, </span><span style="color:#ff8000">0 </span>; [ARENA.OWNER],arena_owner_system
<span style="color:maroon">DOSCODE:CFF9                 </span><span style="color:navy">mov     ax, ss:</span>ENDMEM
<span style="color:maroon">DOSCODE:CFFD                 </span><span style="color:navy">sub     ax, dx
</span><span style="color:maroon">DOSCODE:CFFF                 </span><span style="color:navy">dec     ax
</span><span style="color:maroon">DOSCODE:D000                 </span><span style="color:navy">mov     ds:</span><span style="color:green">3</span><span style="color:navy">, ax
</span><span style="color:maroon">DOSCODE:D003                 </span><span style="color:navy">mov     di, offset </span>SFT0_SFTable ; SFTABL+SFT.SFTable
<span style="color:maroon">DOSCODE:D006                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">3
</span><span style="color:maroon">DOSCODE:D009                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:D00A                 </span><span style="color:navy">mov     di, offset </span>SysInitTable
<span style="color:maroon">DOSCODE:D00D                 </span><span style="color:navy">inc     dx
</span><span style="color:maroon">DOSCODE:D00E                 </span><span style="color:navy">mov     ds, dx
</span><span style="color:maroon">DOSCODE:D010                 </span><span style="color:navy">mov     dx, offset </span>_seg_reinit
<span style="color:maroon">DOSCODE:D013                 </span><span style="color:navy">mov     cx, offset </span>exepatch_start
<span style="color:maroon">DOSCODE:D016                 </span><span style="color:navy">sub     cx, offset </span>$STARTCODE ; sub cx, 3F10h
<span style="color:maroon">DOSCODE:D016                                         </span>; cx = (doscode - exepatch) - dosinit
<span style="color:maroon">DOSCODE:D01A                 </span><span style="color:navy">mov     ax, offset </span>initiret ; SYSBUF
<span style="color:maroon">DOSCODE:D01D                 </span><span style="color:navy">sub     ax, offset </span>$STARTCODE ; sub ax, 3F10h
<span style="color:maroon">DOSCODE:D01D                                         </span>; ax = size of doscode - dosinit
<span style="color:maroon">DOSCODE:D020                 </span><span style="color:navy">mov     sp, ss:</span>USER_SP
<span style="color:maroon">DOSCODE:D025                 </span><span style="color:navy">mov     ss, ss:</span>USER_SS
<span style="color:maroon">DOSCODE:D02A                 </span><span style="color:navy">retf
</span><span style="color:black">DOSCODE:D02B
DOSCODE:D02B </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:D02B
DOSCODE:D02B
DOSCODE:D02B </span>CHARINIT        <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D02B                 </span><span style="color:navy">mov     ss:</span>DEVCALL_REQLEN<span style="color:navy">, </span><span style="color:green">25 </span>; 19h
<span style="color:black">DOSCODE:D031                 </span><span style="color:navy">mov     ss:</span>DEVCALL_REQUNIT<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:D037                 </span><span style="color:navy">mov     ss:</span>DEVCALL_REQFUNC<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:D03D                 </span><span style="color:navy">mov     ss:</span>DEVCALL_REQSTAT<span style="color:navy">, </span><span style="color:#ff8000">0
</span><span style="color:black">DOSCODE:D044                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:D045                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:D046                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:D047                 </span><span style="color:navy">mov     bx, offset </span>DEVCALL_REQLEN ; offset DEVCALL
<span style="color:black">DOSCODE:D04A                 </span><span style="color:navy">push    ss
</span><span style="color:black">DOSCODE:D04B                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:D04C                 </span><span style="color:navy">call    </span>DEVIOCALL2
<span style="color:black">DOSCODE:D04F                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:D050                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:D051                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:D052                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:D052 </span>CHARINIT        <span style="color:black">endp
DOSCODE:D052
DOSCODE:D053
DOSCODE:D053 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:D053
DOSCODE:D053
DOSCODE:D053 </span>check_XMM       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D053                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:D054                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4300h
</span><span style="color:black">DOSCODE:D057                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; - Multiplex - XMS - INSTALLATION CHECK
<span style="color:black">DOSCODE:D057                                         </span>; Return: AL = 80h XMS driver installed
<span style="color:black">DOSCODE:D057                                         </span>; AL &lt;&gt; 80h no driver
<span style="color:black">DOSCODE:D059                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">80h
</span><span style="color:black">DOSCODE:D05B                 </span><span style="color:navy">jnz     short </span><span style="color:gray">cXMM_no_driver
</span><span style="color:black">DOSCODE:D05D                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:D05E                 </span><span style="color:navy">push    dx
</span><span style="color:black">DOSCODE:D05F                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:D060                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:D061                 </span><span style="color:navy">mov     ax, </span><span style="color:#ff8000">4310h
</span><span style="color:black">DOSCODE:D064                 </span><span style="color:navy">int     </span><span style="color:green">2Fh             </span>; - Multiplex - XMS - GET DRIVER ADDRESS
<span style="color:black">DOSCODE:D064                                         </span>; Return: ES:BX -&gt; driver entry point
<span style="color:black">DOSCODE:D066                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:black">DOSCODE:D06B                 </span><span style="color:navy">mov     word ptr ds:</span>XMMcontrol<span style="color:navy">, bx
</span><span style="color:black">DOSCODE:D06F                 </span><span style="color:navy">mov     word ptr ds:</span>XMMcontrol<span style="color:navy">+</span><span style="color:green">2</span><span style="color:navy">, es
</span><span style="color:black">DOSCODE:D073
DOSCODE:D073 </span>cXMMexit<span style="color:navy">:
</span><span style="color:black">DOSCODE:D073                 </span><span style="color:navy">clc
</span><span style="color:black">DOSCODE:D074                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:D075                 </span><span style="color:navy">pop     ds
</span><span style="color:black">DOSCODE:D076                 </span><span style="color:navy">pop     dx
</span><span style="color:black">DOSCODE:D077                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:D078                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:D079                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:D07A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">DOSCODE:D07A
DOSCODE:D07A </span><span style="color:gray">cXMM_no_driver</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D07A                 </span><span style="color:navy">stc
</span><span style="color:black">DOSCODE:D07B                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:D07C                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:D07C </span>check_XMM       <span style="color:black">endp
DOSCODE:D07C
DOSCODE:D07C </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSCODE:D07D </span>num_entry       <span style="color:navy">db </span><span style="color:#008040">0                    </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:D07E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:D07E
DOSCODE:D07E </span>_seg_reinit<span style="color:navy">:                            </span><span style="color:#8080ff">; ...
</span><span style="color:maroon">DOSCODE:D07E                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:D07F                 </span><span style="color:navy">mov     ds, cs:</span>DosDSeg
<span style="color:maroon">DOSCODE:D084                 </span><span style="color:navy">call    </span>patch_misc_segments
<span style="color:maroon">DOSCODE:D087                 </span><span style="color:navy">or      ax, ax
</span><span style="color:maroon">DOSCODE:D089                 </span><span style="color:navy">jnz     short </span>patch_vec_seg
<span style="color:maroon">DOSCODE:D08B                 </span><span style="color:navy">cmp     cs:</span>num_entry<span style="color:navy">, al
</span><span style="color:maroon">DOSCODE:D090                 </span><span style="color:navy">jnz     short </span>second_entry
<span style="color:maroon">DOSCODE:D092                 </span><span style="color:navy">mov     ax, ds
</span><span style="color:maroon">DOSCODE:D094                 </span><span style="color:navy">call    </span>patch_vec_segments
<span style="color:maroon">DOSCODE:D097                 </span><span style="color:navy">call    </span>patch_offset
<span style="color:maroon">DOSCODE:D09A
DOSCODE:D09A </span>second_entry<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:D09A                 </span><span style="color:navy">mov     ax, es
</span><span style="color:maroon">DOSCODE:D09C                 </span><span style="color:navy">mov     di, offset </span>DOSINTTABLE
<span style="color:maroon">DOSCODE:D09F                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">8
</span><span style="color:maroon">DOSCODE:D0A2                 </span><span style="color:navy">push    ds
</span><span style="color:maroon">DOSCODE:D0A3                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">DOSCODE:D0A4
DOSCODE:D0A4 </span>dosinttabloop<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:D0A4                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">DOSCODE:D0A5                 </span><span style="color:navy">inc     di
</span><span style="color:maroon">DOSCODE:D0A6                 </span><span style="color:navy">stosw
</span><span style="color:maroon">DOSCODE:D0A7                 </span><span style="color:navy">loop    </span>dosinttabloop
<span style="color:maroon">DOSCODE:D0A9                 </span><span style="color:navy">cmp     ax, </span><span style="color:green">0F000h
</span><span style="color:maroon">DOSCODE:D0AC                 </span><span style="color:navy">jb      short </span>sr_done
<span style="color:maroon">DOSCODE:D0AE                 </span><span style="color:navy">call    </span>check_XMM
<span style="color:maroon">DOSCODE:D0B1                 </span><span style="color:navy">jb      short </span>sr_done
<span style="color:maroon">DOSCODE:D0B3                 </span><span style="color:navy">call    </span>patch_in_nops
<span style="color:maroon">DOSCODE:D0B6                 </span><span style="color:navy">mov     ds:</span>DosHasHMA<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:D0BB                 </span><span style="color:navy">mov     ds:</span>FixExePatch<span style="color:navy">, offset </span>ExePatch
<span style="color:maroon">DOSCODE:D0C1                 </span><span style="color:navy">mov     ds:</span>ChkCopyProt<span style="color:navy">, offset </span>IsCopyProt
<span style="color:maroon">DOSCODE:D0C7                 </span><span style="color:navy">call    </span>WhatCPUType
<span style="color:maroon">DOSCODE:D0CA                 </span><span style="color:navy">cmp     al, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:D0CC                 </span><span style="color:navy">jnz     short </span>sr_done
<span style="color:maroon">DOSCODE:D0CE                 </span><span style="color:navy">mov     ds:</span>RationalPatchPtr<span style="color:navy">, offset </span>RationalPatch
<span style="color:maroon">DOSCODE:D0D4                 </span><span style="color:navy">jmp     short </span>sr_done
<span style="color:maroon">DOSCODE:D0D6 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">DOSCODE:D0D6
DOSCODE:D0D6 </span>patch_vec_seg<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:D0D6                 </span><span style="color:navy">mov     ax, es
</span><span style="color:maroon">DOSCODE:D0D8                 </span><span style="color:navy">call    </span>patch_vec_segments
<span style="color:maroon">DOSCODE:D0DB
DOSCODE:D0DB </span>sr_done<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:maroon">DOSCODE:D0DB                 </span><span style="color:navy">mov     cs:</span>num_entry<span style="color:navy">, </span><span style="color:#ff8000">1
</span><span style="color:maroon">DOSCODE:D0E1                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">DOSCODE:D0E2                 </span><span style="color:navy">retf
</span><span style="color:black">DOSCODE:D0E3
DOSCODE:D0E3 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:D0E3
DOSCODE:D0E3
DOSCODE:D0E3 </span>patch_vec_segments <span style="color:black">proc near            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D0E3                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:D0E4                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:black">DOSCODE:D0E6                 </span><span style="color:navy">mov     es, cx
</span><span style="color:black">DOSCODE:D0E8                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:D0E8                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">82h         </span>; INTBASE+2
<span style="color:black">DOSCODE:D0EB                 </span><span style="color:navy">mov     </span>word ptr es:2<span style="color:navy">, ax
</span><span style="color:black">DOSCODE:D0EF                 </span><span style="color:navy">inc     cx
</span><span style="color:black">DOSCODE:D0F0                 </span><span style="color:navy">inc     cx
</span><span style="color:black">DOSCODE:D0F1
DOSCODE:D0F1 </span><span style="color:gray">ps_set1</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D0F1                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:D0F2                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D0F3                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D0F4                 </span><span style="color:navy">loop    </span><span style="color:gray">ps_set1
</span><span style="color:black">DOSCODE:D0F6                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">4
</span><span style="color:black">DOSCODE:D0F9                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:D0FA                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:D0FD                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4
</span><span style="color:black">DOSCODE:D100
DOSCODE:D100 </span><span style="color:gray">ps_set2</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D100                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:D101                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D102                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D103                 </span><span style="color:navy">loop    </span><span style="color:gray">ps_set2
</span><span style="color:black">DOSCODE:D105                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">4
</span><span style="color:black">DOSCODE:D108                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:D10B
DOSCODE:D10B </span><span style="color:gray">ps_set3</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D10B                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:D10C                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D10D                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D10E                 </span><span style="color:navy">loop    </span><span style="color:gray">ps_set3
</span><span style="color:black">DOSCODE:D110                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">8
</span><span style="color:black">DOSCODE:D113                 </span><span style="color:navy">mov     cx, </span><span style="color:green">14
</span><span style="color:black">DOSCODE:D116
DOSCODE:D116 </span><span style="color:gray">ps_set4</span><span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D116                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:D117                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D118                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D119                 </span><span style="color:navy">loop    </span><span style="color:gray">ps_set4
</span><span style="color:black">DOSCODE:D11B                 </span><span style="color:navy">mov     </span>word ptr es:ENTRYPOINT+3<span style="color:navy">, ax </span>; [es:0C3h]
<span style="color:black">DOSCODE:D11F                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:D120                 </span>assume es:nothing
<span style="color:black">DOSCODE:D120                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:D120 </span>patch_vec_segments <span style="color:black">endp
DOSCODE:D120
DOSCODE:D121
DOSCODE:D121 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:D121
DOSCODE:D121
DOSCODE:D121 </span>patch_misc_segments <span style="color:black">proc near           </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D121                 </span><span style="color:navy">push    bx
</span><span style="color:black">DOSCODE:D122                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:D123                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:D124                 </span><span style="color:navy">mov     ax, es
</span><span style="color:black">DOSCODE:D126                 </span><span style="color:navy">push    ds
</span><span style="color:black">DOSCODE:D127                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:D128                 </span><span style="color:navy">mov     di, offset </span>JShare
<span style="color:black">DOSCODE:D12B                 </span><span style="color:navy">mov     bx, ds:</span>TEMP_DOSLOC
<span style="color:black">DOSCODE:D12F                 </span><span style="color:navy">mov     cx, </span><span style="color:green">15
</span><span style="color:black">DOSCODE:D132
DOSCODE:D132 </span><span style="color:gray">jumptabloop</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D132                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D133                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D134                 </span><span style="color:navy">cmp     bx, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:D137                 </span><span style="color:navy">jz      short </span><span style="color:gray">share_patch
</span><span style="color:black">DOSCODE:D139                 </span><span style="color:navy">cmp     bx, es:[di]
</span><span style="color:black">DOSCODE:D13C                 </span><span style="color:navy">jnz     short </span><span style="color:gray">no_share_patch
</span><span style="color:black">DOSCODE:D13E
DOSCODE:D13E </span><span style="color:gray">share_patch</span><span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D13E                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:D13F
DOSCODE:D13F </span><span style="color:gray">no_share_patch</span><span style="color:navy">:                         </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D13F                 </span><span style="color:navy">loop    </span><span style="color:gray">jumptabloop
</span><span style="color:black">DOSCODE:D141                 </span><span style="color:navy">mov     si, offset </span>COUNTRY_CDPG
<span style="color:black">DOSCODE:D144                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">4Fh</span><span style="color:navy">], ds
</span><span style="color:black">DOSCODE:D147                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">54h</span><span style="color:navy">], ds
</span><span style="color:black">DOSCODE:D14A                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">59h</span><span style="color:navy">], ds
</span><span style="color:black">DOSCODE:D14D                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">5Eh</span><span style="color:navy">], ds
</span><span style="color:black">DOSCODE:D150                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">80h</span><span style="color:navy">], ds
</span><span style="color:black">DOSCODE:D154                 </span><span style="color:navy">mov     word ptr [si+</span><span style="color:#ff8000">63h</span><span style="color:navy">], ds
</span><span style="color:black">DOSCODE:D157                 </span><span style="color:navy">mov     si, offset </span>FastOpenTable
<span style="color:black">DOSCODE:D15A                 </span><span style="color:navy">cmp     ds:</span>TEMP_DOSLOC<span style="color:navy">, </span><span style="color:green">0FFFFh
</span><span style="color:black">DOSCODE:D15F                 </span><span style="color:navy">jz      short </span><span style="color:gray">fast_patch
</span><span style="color:black">DOSCODE:D161                 </span><span style="color:navy">mov     cx, ds:</span>TEMP_DOSLOC
<span style="color:black">DOSCODE:D165                 </span><span style="color:navy">cmp     cx, [si+</span><span style="color:#ff8000">4</span><span style="color:navy">]
</span><span style="color:black">DOSCODE:D168                 </span><span style="color:navy">jnz     short </span><span style="color:gray">no_fast_patch
</span><span style="color:black">DOSCODE:D16A
DOSCODE:D16A </span><span style="color:gray">fast_patch</span><span style="color:navy">:                             </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D16A                 </span><span style="color:navy">mov     [si+</span><span style="color:#ff8000">4</span><span style="color:navy">], ax
</span><span style="color:black">DOSCODE:D16D
DOSCODE:D16D </span><span style="color:gray">no_fast_patch</span><span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D16D                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:D16E                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:D16F                 </span><span style="color:navy">pop     bx
</span><span style="color:black">DOSCODE:D170                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:D170 </span>patch_misc_segments <span style="color:black">endp
DOSCODE:D170
DOSCODE:D171
DOSCODE:D171 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:D171
DOSCODE:D171
DOSCODE:D171 </span>patch_offset    <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D171                 </span><span style="color:navy">push    es
</span><span style="color:black">DOSCODE:D172                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">DOSCODE:D174                 </span><span style="color:navy">mov     es, ax
</span><span style="color:black">DOSCODE:D176                 </span>assume es:DOSCODE
<span style="color:black">DOSCODE:D176                 </span><span style="color:navy">mov     word ptr es:byte_0, offset </span>ldivov
<span style="color:black">DOSCODE:D17D                 </span><span style="color:navy">mov     di, </span><span style="color:#ff8000">80h
</span><span style="color:black">DOSCODE:D180                 </span><span style="color:navy">mov     ax, offset </span>lirett
<span style="color:black">DOSCODE:D183                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">2
</span><span style="color:black">DOSCODE:D186
DOSCODE:D186 </span><span style="color:gray">po_iset1</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D186                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:D187                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D188                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D189                 </span><span style="color:navy">loop    </span><span style="color:gray">po_iset1
</span><span style="color:black">DOSCODE:D18B                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">4
</span><span style="color:black">DOSCODE:D18E                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:D18F                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:D192                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">4
</span><span style="color:black">DOSCODE:D195
DOSCODE:D195 </span><span style="color:gray">po_iset2</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D195                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:D196                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D197                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D198                 </span><span style="color:navy">loop    </span><span style="color:gray">po_iset2
</span><span style="color:black">DOSCODE:D19A                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">4
</span><span style="color:black">DOSCODE:D19D                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">6
</span><span style="color:black">DOSCODE:D1A0
DOSCODE:D1A0 </span><span style="color:gray">po_iset3</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D1A0                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:D1A1                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D1A2                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D1A3                 </span><span style="color:navy">loop    </span><span style="color:gray">po_iset3
</span><span style="color:black">DOSCODE:D1A5                 </span><span style="color:navy">add     di, </span><span style="color:#ff8000">8
</span><span style="color:black">DOSCODE:D1A8                 </span><span style="color:navy">mov     cx, </span><span style="color:green">14
</span><span style="color:black">DOSCODE:D1AB
DOSCODE:D1AB </span><span style="color:gray">po_iset4</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D1AB                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:D1AC                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D1AD                 </span><span style="color:navy">inc     di
</span><span style="color:black">DOSCODE:D1AE                 </span><span style="color:navy">loop    </span><span style="color:gray">po_iset4
</span><span style="color:black">DOSCODE:D1B0                 </span><span style="color:navy">mov     </span>word ptr es:0BCh<span style="color:navy">, offset </span>lint2f
<span style="color:black">DOSCODE:D1B7                 </span><span style="color:navy">mov     </span>byte ptr es:0C0h<span style="color:navy">, </span><span style="color:green">0EAh
</span><span style="color:black">DOSCODE:D1BD                 </span><span style="color:navy">mov     </span>word ptr es:0C1h<span style="color:navy">, offset </span>lcall_entry
<span style="color:black">DOSCODE:D1C4                 </span><span style="color:navy">mov     </span>word ptr es:80h<span style="color:navy">, offset </span>lquit
<span style="color:black">DOSCODE:D1CB                 </span><span style="color:navy">mov     </span>word ptr es:84h<span style="color:navy">, offset </span>lcommand
<span style="color:black">DOSCODE:D1D2                 </span><span style="color:navy">mov     </span>word ptr es:94h<span style="color:navy">, offset </span>labsdrd
<span style="color:black">DOSCODE:D1D9                 </span><span style="color:navy">mov     </span>word ptr es:98h<span style="color:navy">, offset </span>labsdwrt
<span style="color:black">DOSCODE:D1E0                 </span><span style="color:navy">mov     </span>word ptr es:9Ch<span style="color:navy">, offset </span>lstay_resident
<span style="color:black">DOSCODE:D1E7                 </span><span style="color:navy">pop     es
</span><span style="color:black">DOSCODE:D1E8                 </span>assume es:nothing
<span style="color:black">DOSCODE:D1E8                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:D1E8 </span>patch_offset    <span style="color:black">endp
DOSCODE:D1E8
DOSCODE:D1E8 </span><span style="color:gray">; ---------------------------------------------------------------------------
DOSCODE:D1E9 </span>patch_table     <span style="color:navy">dw offset </span>ldivov        <span style="color:#8080ff">; ...
</span><span style="color:gray">DOSCODE:D1EB                 </span><span style="color:navy">dw offset </span>lquit
<span style="color:gray">DOSCODE:D1ED                 </span><span style="color:navy">dw offset </span>lcommand
<span style="color:gray">DOSCODE:D1EF                 </span><span style="color:navy">dw offset </span>labsdrd
<span style="color:gray">DOSCODE:D1F1                 </span><span style="color:navy">dw offset </span>labsdwrt
<span style="color:gray">DOSCODE:D1F3                 </span><span style="color:navy">dw offset </span>lstay_resident
<span style="color:gray">DOSCODE:D1F5                 </span><span style="color:navy">dw offset </span>lint2f
<span style="color:gray">DOSCODE:D1F7                 </span><span style="color:navy">dw offset </span>lcall_entry
<span style="color:black">DOSCODE:D1F9
DOSCODE:D1F9 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">DOSCODE:D1F9
DOSCODE:D1F9
DOSCODE:D1F9 </span>patch_in_nops   <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D1F9                 </span><span style="color:navy">push    ax
</span><span style="color:black">DOSCODE:D1FA                 </span><span style="color:navy">push    si
</span><span style="color:black">DOSCODE:D1FB                 </span><span style="color:navy">mov     si, offset </span>patch_table
<span style="color:black">DOSCODE:D1FE                 </span><span style="color:navy">mov     ax, </span><span style="color:green">9090h
</span><span style="color:black">DOSCODE:D201                 </span><span style="color:navy">mov     cx, </span><span style="color:#ff8000">8
</span><span style="color:black">DOSCODE:D204
DOSCODE:D204 </span><span style="color:gray">pin_loop</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">DOSCODE:D204                 </span><span style="color:navy">mov     di, cs:[si]
</span><span style="color:black">DOSCODE:D207                 </span><span style="color:navy">stosw
</span><span style="color:black">DOSCODE:D208                 </span><span style="color:navy">inc     si
</span><span style="color:black">DOSCODE:D209                 </span><span style="color:navy">inc     si
</span><span style="color:black">DOSCODE:D20A                 </span><span style="color:navy">loop    </span><span style="color:gray">pin_loop
</span><span style="color:black">DOSCODE:D20C                 </span><span style="color:navy">pop     si
</span><span style="color:black">DOSCODE:D20D                 </span><span style="color:navy">pop     ax
</span><span style="color:black">DOSCODE:D20E                 </span><span style="color:navy">retn
</span><span style="color:black">DOSCODE:D20E </span>patch_in_nops   <span style="color:black">endp
DOSCODE:D20E
DOSCODE:D20E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:olive">DOSCODE:D20F                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">DOSCODE:D20F </span>DOSCODE         ends
<span style="color:olive">DOSCODE:D20F
DOSCODE:D20F
DOSCODE:D20F                 </span>end
</span></body></html>
