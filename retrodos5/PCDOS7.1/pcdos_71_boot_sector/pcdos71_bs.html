<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>IDA - pcdos71_bs.i64 (BOOTSECT.DAT) C:\Users\HİTEK\Desktop\pcdos71_bs.i64</title>
</head>
<body bgcolor="#ffffff">
<span style="white-space: pre; font-family: Consolas; color: blue; background: #ffffff">

<span style="color:maroon">seg000:7C00 </span>;
<span style="color:maroon">seg000:7C00 </span>; +-------------------------------------------------------------------------+
<span style="color:maroon">seg000:7C00 </span>; |   This file has been generated by The Interactive Disassembler (IDA)    |
<span style="color:maroon">seg000:7C00 </span>; |           Copyright (c) 2018 Hex-Rays, &lt;support@hex-rays.com&gt;           |
<span style="color:maroon">seg000:7C00 </span>; |                            Freeware version                             |
<span style="color:maroon">seg000:7C00 </span>; +-------------------------------------------------------------------------+
<span style="color:maroon">seg000:7C00 </span>;
<span style="color:maroon">seg000:7C00 </span>; Input SHA256 : 2264920B57D2B9B8C3C5F28AAA7FEE11A9C30C173429C0CE2CC6C8C734F7F866
<span style="color:maroon">seg000:7C00 </span>; Input MD5    : 7636CC73FF4B44BA4E3687793130EC7D
<span style="color:maroon">seg000:7C00 </span>; Input CRC32  : 2C9C7474
<span style="color:maroon">seg000:7C00
seg000:7C00 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">seg000:7C00 </span>; File Name   : C:\Users\HİTEK\Desktop\BOOTSECT.DAT
<span style="color:maroon">seg000:7C00 </span>; Format      : Binary file
<span style="color:maroon">seg000:7C00 </span>; Base Address: 0000h Range: 0000h - 0200h Loaded length: 0200h
<span style="color:maroon">seg000:7C00
seg000:7C00                 .</span>386
<span style="color:maroon">seg000:7C00                 </span>.model flat
<span style="color:maroon">seg000:7C00
seg000:7C00 </span><span style="color:gray">; ===========================================================================
</span><span style="color:maroon">seg000:7C00
seg000:7C00 </span><span style="color:gray">; Segment type: Pure code
</span><span style="color:maroon">seg000:7C00 </span>seg000          segment byte public &#039;CODE&#039; use16
<span style="color:maroon">seg000:7C00                 </span>assume cs:seg000
<span style="color:maroon">seg000:7C00                 </span><span style="color:gray">;org 7C00h
</span><span style="color:maroon">seg000:7C00                 </span>assume es:nothing, ss:nothing, ds:nothing, fs:nothing, gs:nothing
<span style="color:maroon">seg000:7C00
seg000:7C00 </span>BS_jmpBoot<span style="color:navy">:                             </span>; Disassembled by Erdogan Tan - June 2023
<span style="color:maroon">seg000:7C00                 </span><span style="color:navy">jmp     short </span>Main
<span style="color:maroon">seg000:7C02 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">seg000:7C02                 </span><span style="color:navy">nop
</span><span style="color:maroon">seg000:7C02 </span><span style="color:gray">; ---------------------------------------------------------------------------
seg000:7C03 </span>BS_OEMName      <span style="color:navy">db &#039;IBM  &#039;              </span>; Ref: &quot;Microsoft Extensible Firmware Initiative
<span style="color:gray">seg000:7C03                                         </span>; FAT32 File System Specification&quot;
<span style="color:gray">seg000:7C03                                         </span>;             fatgen103.doc (fatgen103.pdf)
<span style="color:gray">seg000:7C03                                         </span>; &amp; PCDOS 7.1 Bootsector file:
<span style="color:gray">seg000:7C03                                         </span>;             BOOTSECT.DAT - 22/04/2008 19:41
<span style="color:gray">seg000:7C03                                         </span>; &amp; MSDOS 6.0 Boot Sector source code:
<span style="color:gray">seg000:7C03                                         </span>;             MSBOOT.ASM - 1991 (31/10/1999 18:26)
<span style="color:gray">seg000:7C08 </span>OSVersion       <span style="color:navy">db &#039;7.1&#039;
</span><span style="color:gray">seg000:7C0B </span>BPB_BytsPerSec  <span style="color:navy">dw </span><span style="color:#008040">200h
</span><span style="color:gray">seg000:7C0D </span>BPB_SecPerClus  <span style="color:navy">db </span><span style="color:#008040">8
</span><span style="color:gray">seg000:7C0E </span>BPB_RsvdSecCnt  <span style="color:navy">dw </span><span style="color:#008040">32
</span><span style="color:gray">seg000:7C10 </span>BPB_NumFATs     <span style="color:navy">db </span><span style="color:#008040">2
</span><span style="color:gray">seg000:7C11 </span>BPB_RootEntCnt  <span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">seg000:7C13 </span>BPB_TotSec16    <span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">seg000:7C15 </span>BPB_Media       <span style="color:navy">db </span><span style="color:#008040">0F8h
</span><span style="color:gray">seg000:7C16 </span>BPB_FATSz16     <span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">seg000:7C18 </span>BPB_SecPerTrk   <span style="color:navy">dw </span><span style="color:#008040">63
</span><span style="color:gray">seg000:7C1A </span>BPB_NumHeads    <span style="color:navy">dw </span><span style="color:#008040">255
</span><span style="color:gray">seg000:7C1C </span>BPB_HiddSec     <span style="color:navy">dd </span><span style="color:#008040">63
</span><span style="color:gray">seg000:7C20 </span>BPB_TotSec32    <span style="color:navy">dd </span><span style="color:#008040">8369802
</span><span style="color:gray">seg000:7C24 </span>BPB_FATSz32     <span style="color:navy">dd </span><span style="color:#008040">8166                 </span>; FAT32 Structure Starting at Offset 36
<span style="color:gray">seg000:7C28 </span>BPB_ExtFlags    <span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">seg000:7C2A </span>BPB_FSVer       <span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:gray">seg000:7C2C </span>BPB_RootClus    <span style="color:navy">dd </span><span style="color:#008040">2
</span><span style="color:gray">seg000:7C30 </span>BPB_FSInfo      <span style="color:navy">dw </span><span style="color:#008040">1
</span><span style="color:gray">seg000:7C32 </span>BPB_BkBootSec   <span style="color:navy">dw </span><span style="color:#008040">6
</span><span style="color:gray">seg000:7C34 </span>BPB_Reserved    <span style="color:navy">db </span><span style="color:#008040">12 </span><span style="color:navy">dup(  </span><span style="color:#008040">0</span><span style="color:navy">)
</span><span style="color:gray">seg000:7C40 </span>BS_DrvNum       <span style="color:navy">db </span><span style="color:#008040">80h
</span><span style="color:gray">seg000:7C41 </span>BS_Reserved1    <span style="color:navy">db </span><span style="color:#008040">0
</span><span style="color:gray">seg000:7C42 </span>BS_BootSig      <span style="color:navy">db </span><span style="color:#008040">29h
</span><span style="color:gray">seg000:7C43 </span>BS_VolID        <span style="color:navy">dd </span><span style="color:#008040">184607F9h
</span><span style="color:gray">seg000:7C47 </span>BS_VolLab       <span style="color:navy">db &#039;NO NAME    &#039;
</span><span style="color:gray">seg000:7C52 </span>BS_FilSysType   <span style="color:navy">db &#039;FAT32   &#039;
</span><span style="color:maroon">seg000:7C5A </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">seg000:7C5A
seg000:7C5A </span>Main<span style="color:navy">:                                   </span><span style="color:green">; ...
</span><span style="color:maroon">seg000:7C5A                 </span><span style="color:navy">cli
</span><span style="color:maroon">seg000:7C5B                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">seg000:7C5D                 </span><span style="color:navy">mov     ss, ax
</span><span style="color:maroon">seg000:7C5F                 </span><span style="color:navy">mov     sp, </span><span style="color:green">7BECh       </span>; STACK (BootSectorOffset-20)
<span style="color:maroon">seg000:7C62                 </span><span style="color:navy">push    ss
</span><span style="color:maroon">seg000:7C63                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">seg000:7C64                 </span><span style="color:navy">mov     bp, sp
</span><span style="color:maroon">seg000:7C66                 </span><span style="color:navy">mov     bx, </span><span style="color:green">78h         </span>; INT 1Eh ; DSK_PARMS
<span style="color:maroon">seg000:7C69                 </span><span style="color:navy">lds     si, ss:[bx]
</span><span style="color:maroon">seg000:7C6C                 </span><span style="color:navy">push    ds              </span>; Save original INT 1Eh table &amp; vector
<span style="color:maroon">seg000:7C6C                                         </span>; (*)
<span style="color:maroon">seg000:7C6D                 </span><span style="color:navy">push    si              </span>; (**)
<span style="color:maroon">seg000:7C6E                 </span><span style="color:navy">push    ss              </span>; (***)
<span style="color:maroon">seg000:7C6F                 </span><span style="color:navy">push    bx              </span>; (****)
<span style="color:maroon">seg000:7C70                 </span><span style="color:navy">mov     di, bp          </span>; 7BECh
<span style="color:maroon">seg000:7C72                 </span><span style="color:navy">mov     cx, </span><span style="color:green">16
</span><span style="color:maroon">seg000:7C75                 </span><span style="color:navy">push    di              </span>; (*****)
<span style="color:maroon">seg000:7C76                 </span><span style="color:navy">cld
</span><span style="color:maroon">seg000:7C77                 </span><span style="color:navy">rep movsb
</span><span style="color:maroon">seg000:7C79                 </span><span style="color:navy">push    es
</span><span style="color:maroon">seg000:7C7A                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">seg000:7C7B                 </span><span style="color:navy">mov     byte ptr [di-</span><span style="color:green">7</span><span style="color:navy">], </span><span style="color:green">0Fh </span>; Set the head settle time to 15ms
<span style="color:maroon">seg000:7C7B                                         </span>; because we don&#039;t have room to do a disk retry
<span style="color:maroon">seg000:7C7B                                         </span>; and then set sectors per from the value
<span style="color:maroon">seg000:7C7B                                         </span>; in the BPB
<span style="color:maroon">seg000:7C7F                 </span><span style="color:navy">mov     cx, [bp+</span><span style="color:#ff8000">2Ch</span><span style="color:navy">]    </span>; BPB_SecPerTrk
<span style="color:maroon">seg000:7C82                 </span><span style="color:navy">mov     [di-</span><span style="color:green">12</span><span style="color:navy">], cl     </span>; End of Track
<span style="color:maroon">seg000:7C85                 </span><span style="color:navy">mov     [bx+</span><span style="color:green">2</span><span style="color:navy">], ax      </span>; Place in new disk parameter table vector
<span style="color:maroon">seg000:7C88                 </span><span style="color:navy">pop     word ptr [bx]   </span>; 0:7BECh
<span style="color:maroon">seg000:7C88                                         </span>; (*****)
<span style="color:maroon">seg000:7C8A                 </span><span style="color:navy">sti
</span><span style="color:maroon">seg000:7C8B                 </span><span style="color:navy">call    </span>disk_io         ; ax = 0 ; disk reset
<span style="color:maroon">seg000:7C8E                 </span><span style="color:navy">mov     cx, [bp+</span><span style="color:#ff8000">27h</span><span style="color:navy">]    </span>; BPB_TotSec16
<span style="color:maroon">seg000:7C91                 </span><span style="color:navy">jcxz    short </span>Dir_Cont
<span style="color:maroon">seg000:7C93                 </span><span style="color:navy">mov     [bp+</span><span style="color:#ff8000">34h</span><span style="color:navy">], cx    </span>; BPB_TotSec32
<span style="color:maroon">seg000:7C96
seg000:7C96 </span>Dir_Cont<span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:maroon">seg000:7C96                 </span><span style="color:navy">mov     al, [bp+</span><span style="color:#ff8000">24h</span><span style="color:navy">]    </span>; BPB_NumFATs
<span style="color:maroon">seg000:7C99                 </span><span style="color:navy">cwd
</span><span style="color:maroon">seg000:7C9A                 </span><span style="color:navy">mov     bx, [bp+</span><span style="color:#ff8000">2Ah</span><span style="color:navy">]    </span>; BPB_FATSz16
<span style="color:maroon">seg000:7C9D                 </span><span style="color:navy">or      bx, bx
</span><span style="color:maroon">seg000:7C9F                 </span><span style="color:navy">jnz     short </span>Dir_Cont_fat
<span style="color:maroon">seg000:7CA1
seg000:7CA1 </span>Dir_Cont_fat32<span style="color:navy">:
</span><span style="color:maroon">seg000:7CA1                 </span><span style="color:navy">xchg    ax, bx
</span><span style="color:maroon">seg000:7CA2                 </span><span style="color:navy">mov     ax, [bp+</span><span style="color:#ff8000">38h</span><span style="color:navy">]    </span>; BPB_FATSz32
<span style="color:maroon">seg000:7CA5                 </span><span style="color:navy">mov     dx, [bp+</span><span style="color:#ff8000">3Ah</span><span style="color:navy">]    </span>; BPB_FATSz32+2
<span style="color:maroon">seg000:7CA8
seg000:7CA8 </span>Dir_Cont_fat<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">seg000:7CA8                 </span><span style="color:navy">call    </span>mul32           ; dx:ax = NumFats * NumFatSecs
<span style="color:maroon">seg000:7CAB                 </span><span style="color:navy">add     ax, [bp+</span><span style="color:#ff8000">30h</span><span style="color:navy">]    </span>; BPB_HiddSec
<span style="color:maroon">seg000:7CAE                 </span><span style="color:navy">adc     dx, [bp+</span><span style="color:#ff8000">32h</span><span style="color:navy">]    </span>; BPB_HiddSec+2
<span style="color:maroon">seg000:7CB1                 </span><span style="color:navy">add     ax, [bp+</span><span style="color:#ff8000">22h</span><span style="color:navy">]    </span>; BPB_RsvdSecCnt
<span style="color:maroon">seg000:7CB4                 </span><span style="color:navy">adc     dx, </span><span style="color:green">0           </span>; dx:ax = NumFats * NumFatSecs
<span style="color:maroon">seg000:7CB4                                         </span>;         + ReservedSecs + cSecHid
<span style="color:maroon">seg000:7CB7                 </span><span style="color:navy">push    dx              </span>; (5*)
<span style="color:maroon">seg000:7CB8                 </span><span style="color:navy">push    ax              </span>; (6*)
<span style="color:maroon">seg000:7CB9                 </span><span style="color:navy">stosw                   </span>; [0:7BFCh] = ax
<span style="color:maroon">seg000:7CBA                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:maroon">seg000:7CBB                 </span><span style="color:navy">stosw                   </span>; [0:7BFEh] = dx
<span style="color:maroon">seg000:7CBC                 </span><span style="color:navy">mov     ax, </span><span style="color:green">32          </span>; DIR_ENTRY_SIZE
<span style="color:maroon">seg000:7CBF                 </span><span style="color:navy">mul     word ptr [bp+</span><span style="color:#ff8000">25h</span><span style="color:navy">] </span>; BPB_RootEntCnt
<span style="color:maroon">seg000:7CC2                 </span><span style="color:navy">mov     bx, [bp+</span><span style="color:green">1Fh</span><span style="color:navy">]    </span>; BPB_BytsPerSec (= 512)
<span style="color:maroon">seg000:7CC5                 </span><span style="color:navy">dec     bx              </span>; 511
<span style="color:maroon">seg000:7CC6                 </span><span style="color:navy">add     ax, bx          </span>; add ax, 511
<span style="color:maroon">seg000:7CC8                 </span><span style="color:navy">adc     dx, </span><span style="color:green">0
</span><span style="color:maroon">seg000:7CCB                 </span><span style="color:navy">inc     bx              </span>; 512
<span style="color:maroon">seg000:7CCC                 </span><span style="color:navy">div     bx
</span><span style="color:maroon">seg000:7CCE                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:maroon">seg000:7CD0                 </span><span style="color:navy">add     [bp+</span><span style="color:green">10h</span><span style="color:navy">], ax    </span>; add [0:7BFCh], ax
<span style="color:maroon">seg000:7CD3                 </span><span style="color:navy">adc     [bp+</span><span style="color:green">12h</span><span style="color:navy">], dx    </span>; adc [0:7BFEh], dx
<span style="color:maroon">seg000:7CD6                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">seg000:7CD8                 </span><span style="color:navy">cmp     ax, [bp+</span><span style="color:#ff8000">2Ah</span><span style="color:navy">]    </span>; BPB_FATSz16
<span style="color:maroon">seg000:7CDB                 </span><span style="color:navy">jnz     short </span>not_fat32_fs
<span style="color:maroon">seg000:7CDD                 </span><span style="color:navy">mov     dx, [bp+</span><span style="color:#ff8000">42h</span><span style="color:navy">]    </span>; BPB_RootClus+2
<span style="color:maroon">seg000:7CE0                 </span><span style="color:navy">mov     ax, [bp+</span><span style="color:#ff8000">40h</span><span style="color:navy">]    </span>; BPB_RootClus
<span style="color:maroon">seg000:7CE3                 </span><span style="color:navy">mov     cx, ax
</span><span style="color:maroon">seg000:7CE5                 </span><span style="color:navy">or      cx, dx
</span><span style="color:maroon">seg000:7CE7                 </span><span style="color:navy">jcxz    short </span>not_fat32_fs
<span style="color:maroon">seg000:7CE9                 </span><span style="color:navy">call    </span>calc_dir_sector_offset ; calculate sector index/offset
<span style="color:maroon">seg000:7CE9                                         </span>;         of the root directory
<span style="color:maroon">seg000:7CEC
seg000:7CEC </span>not_fat32_fs<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">seg000:7CEC                 </span><span style="color:navy">pop     bx              </span>; (6*)
<span style="color:maroon">seg000:7CED                 </span><span style="color:navy">add     ax, bx
</span><span style="color:maroon">seg000:7CEF                 </span><span style="color:navy">pop     bx              </span>; (5*)
<span style="color:maroon">seg000:7CF0                 </span><span style="color:navy">adc     dx, bx          </span>; dx:ax = start sector # of root directory
<span style="color:maroon">seg000:7CF2                 </span><span style="color:navy">mov     bx, </span><span style="color:green">500h        </span>; DIR_OFF (buffer address)
<span style="color:maroon">seg000:7CF5                 </span><span style="color:navy">call    </span>disk_read       ; read root directory
<span style="color:maroon">seg000:7CF8                 </span><span style="color:navy">jb      short </span>Load_Failure
<span style="color:maroon">seg000:7CFA                 </span><span style="color:navy">mov     di, bx
</span><span style="color:maroon">seg000:7CFC                 </span><span style="color:navy">mov     cx, </span><span style="color:green">11
</span><span style="color:maroon">seg000:7CFF                 </span><span style="color:navy">mov     si, offset </span>IbmbioCom ; Scan for the presence of BIOS file.
<span style="color:maroon">seg000:7D02                 </span><span style="color:navy">push    cx              </span>; check if the 1st entry is &quot;IBMBIO  COM&quot;
<span style="color:maroon">seg000:7D03                 </span><span style="color:navy">repe cmpsb
</span><span style="color:maroon">seg000:7D05                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">seg000:7D06                 </span><span style="color:navy">jnz     short </span>Load_Failure ; it is not &#039;IBMBIO.COM&#039;
<span style="color:maroon">seg000:7D08                 </span><span style="color:navy">lea     di, [bx+</span><span style="color:#ff8000">20h</span><span style="color:navy">]    </span>; check if the 2nd entry is &quot;IBMDOS  COM&quot;
<span style="color:maroon">seg000:7D0B                 </span><span style="color:navy">repe cmpsb
</span><span style="color:maroon">seg000:7D0D                 </span><span style="color:navy">jz      short </span>root_dir_ok ; 1st 2 root dir entries are PCDOS bios and kernel files
<span style="color:maroon">seg000:7D0F
seg000:7D0F </span>Load_Failure<span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:maroon">seg000:7D0F                 </span><span style="color:navy">mov     si, offset </span>BootFailure <span style="color:gray">; &quot;\r\nBoot failure&quot;
</span><span style="color:maroon">seg000:7D12                 </span><span style="color:navy">lodsb
</span><span style="color:maroon">seg000:7D13
seg000:7D13 </span>write_message<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">seg000:7D13                 </span><span style="color:navy">mov     ah, </span><span style="color:green">0Eh
</span><span style="color:maroon">seg000:7D15                 </span><span style="color:navy">mov     bx, </span><span style="color:green">7
</span><span style="color:maroon">seg000:7D18                 </span><span style="color:navy">int     </span><span style="color:green">10h             </span>; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
<span style="color:maroon">seg000:7D18                                         </span>; AL = character, BH = display page (alpha modes)
<span style="color:maroon">seg000:7D18                                         </span>; BL = foreground color (graphics modes)
<span style="color:maroon">seg000:7D1A                 </span><span style="color:navy">lodsb
</span><span style="color:maroon">seg000:7D1B                 </span><span style="color:navy">or      al, al
</span><span style="color:maroon">seg000:7D1D                 </span><span style="color:navy">jnz     short </span>write_message
<span style="color:maroon">seg000:7D1F                 </span><span style="color:navy">cbw
</span><span style="color:maroon">seg000:7D20                 </span><span style="color:navy">int     </span><span style="color:green">16h             </span>; KEYBOARD -
<span style="color:maroon">seg000:7D22                 </span><span style="color:navy">pop     si              </span>; (****) ; restore INT 1Eh vector
<span style="color:maroon">seg000:7D23                 </span><span style="color:navy">pop     ds              </span>; (***)
<span style="color:maroon">seg000:7D24                 </span><span style="color:navy">pop     word ptr [si]   </span>; (**)
<span style="color:maroon">seg000:7D26                 </span><span style="color:navy">pop     word ptr [si+</span><span style="color:green">2</span><span style="color:navy">] </span>; (*)
<span style="color:maroon">seg000:7D29                 </span><span style="color:navy">int     </span><span style="color:green">19h             </span>; DISK BOOT
<span style="color:maroon">seg000:7D29                                         </span>; causes reboot of disk system
<span style="color:maroon">seg000:7D2B
seg000:7D2B </span>root_dir_ok<span style="color:navy">:                            </span><span style="color:green">; ...
</span><span style="color:maroon">seg000:7D2B                 </span><span style="color:navy">mov     dx, [bx+</span><span style="color:green">14h</span><span style="color:navy">]    </span>; High word of cluster number
<span style="color:maroon">seg000:7D2E                 </span><span style="color:navy">mov     ax, [bx+</span><span style="color:green">1Ah</span><span style="color:navy">]    </span>; Low word of cluster number
<span style="color:maroon">seg000:7D31                 </span><span style="color:navy">cmp     [bp+</span><span style="color:#ff8000">2Ah</span><span style="color:navy">], cx    </span>; BPB_FATSz16 ; cx = 0
<span style="color:maroon">seg000:7D34                 </span><span style="color:navy">jz      short </span>it_is_big_fat
<span style="color:maroon">seg000:7D36                 </span><span style="color:navy">xor     dx, dx          </span>; HW of cluster number is (must be) zero
<span style="color:maroon">seg000:7D38
seg000:7D38 </span>it_is_big_fat<span style="color:navy">:                          </span><span style="color:green">; ...
</span><span style="color:maroon">seg000:7D38                 </span><span style="color:navy">call    </span>calc_dir_sector_offset ; calculate sector index/offset
<span style="color:maroon">seg000:7D38                                         </span>;         of the file
<span style="color:maroon">seg000:7D38                                         </span>; dx:ax = sector offset from start of data
<span style="color:maroon">seg000:7D3B                 </span><span style="color:navy">add     ax, [bp+</span><span style="color:green">10h</span><span style="color:navy">]    </span>; [0:7BFCh] = start sector # of data
<span style="color:maroon">seg000:7D3E                 </span><span style="color:navy">adc     dx, [bp+</span><span style="color:green">12h</span><span style="color:navy">]    </span>; dx:ax = start sector # of the file
<span style="color:maroon">seg000:7D41                 </span><span style="color:navy">mov     bx, </span><span style="color:green">700h        </span>; [0:700h] = IBMBIO.COM loading address
<span style="color:maroon">seg000:7D44                 </span><span style="color:navy">mov     cl, </span><span style="color:green">4           </span>; load 4 sectors (MSLOAD code size)
<span style="color:maroon">seg000:7D46
seg000:7D46 </span>load_file_sector<span style="color:navy">:                       </span><span style="color:green">; ...
</span><span style="color:maroon">seg000:7D46                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">seg000:7D47                 </span><span style="color:navy">push    dx
</span><span style="color:maroon">seg000:7D48                 </span><span style="color:navy">push    cx
</span><span style="color:maroon">seg000:7D49                 </span><span style="color:navy">call    </span>disk_read
<span style="color:maroon">seg000:7D4C                 </span><span style="color:navy">pop     cx
</span><span style="color:maroon">seg000:7D4D                 </span><span style="color:navy">pop     dx
</span><span style="color:maroon">seg000:7D4E                 </span><span style="color:navy">pop     ax
</span><span style="color:maroon">seg000:7D4F                 </span><span style="color:navy">jb      short </span>Load_Failure
<span style="color:maroon">seg000:7D51                 </span><span style="color:navy">inc     ax
</span><span style="color:maroon">seg000:7D52                 </span><span style="color:navy">jnz     short </span>load_next_file_sector
<span style="color:maroon">seg000:7D54                 </span><span style="color:navy">inc     dx
</span><span style="color:maroon">seg000:7D55
seg000:7D55 </span>load_next_file_sector<span style="color:navy">:                  </span><span style="color:green">; ...
</span><span style="color:maroon">seg000:7D55                 </span><span style="color:navy">add     bx, [bp+</span><span style="color:green">1Fh</span><span style="color:navy">]    </span>; BPB_BytsPerSec
<span style="color:maroon">seg000:7D58                 </span><span style="color:navy">loop    </span>load_file_sector
<span style="color:maroon">seg000:7D5A                 </span><span style="color:navy">mov     ch, [bp+</span><span style="color:#ff8000">29h</span><span style="color:navy">]    </span>; BPB_Media
<span style="color:maroon">seg000:7D5D                 </span><span style="color:navy">mov     dl, [bp+</span><span style="color:#ff8000">54h</span><span style="color:navy">]    </span>; BS_DrvNum
<span style="color:maroon">seg000:7D60                 </span><span style="color:navy">les     bx, [bp+</span><span style="color:green">10h</span><span style="color:navy">]    </span>; start sector # of data
<span style="color:maroon">seg000:7D63                 </span><span style="color:navy">mov     ax, es          </span>; es:bx = ax:bx = dword/far ptr [0:7BFCh]
<span style="color:maroon">seg000:7D65                 </span><span style="color:navy">lds     si, [bp-</span><span style="color:green">4</span><span style="color:navy">]      </span>; ds:si = DSK_PARMS INT 1Eh table address
<span style="color:maroon">seg000:7D65                                         </span>;         also in stack [at 0:7BE8h] ; (*) (**)
<span style="color:maroon">seg000:7D68                 </span><span style="color:navy">jmp     far ptr </span><span style="background:red"><span style="color:navy">70h:0</span></span>   ; far jump to MSLOAD (IBMBIO.COM start) code
<span style="color:maroon">seg000:7D68                                         </span>;
<span style="color:maroon">seg000:7D68                                         </span>; Stack:
<span style="color:maroon">seg000:7D68                                         </span>;  ss:sp = Original INT 1Eh vector address (ss:bx)
<span style="color:maroon">seg000:7D68                                         </span>;  ss:sp+4 = Original INT 1Eh disk table addr (ds:si)
<span style="color:black">seg000:7D6D
seg000:7D6D </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">seg000:7D6D
seg000:7D6D
seg000:7D6D </span>disk_read       <span style="color:black">proc near               </span><span style="color:green">; ...
</span><span style="color:black">seg000:7D6D                 </span><span style="color:navy">test    byte ptr [bp+</span><span style="color:#ff8000">54h</span><span style="color:navy">], </span><span style="color:green">80h </span>; BS_DrvNum
<span style="color:black">seg000:7D71                 </span><span style="color:navy">jz      short </span><span style="color:gray">chs_read
</span><span style="color:black">seg000:7D73
seg000:7D73 </span>lba_read<span style="color:navy">:                               </span>; 0
<span style="color:black">seg000:7D73                 </span><span style="color:navy">xor     si, si
</span><span style="color:black">seg000:7D75                 </span><span style="color:navy">mov     cx, sp
</span><span style="color:black">seg000:7D77                 </span><span style="color:navy">push    si
</span><span style="color:black">seg000:7D78                 </span><span style="color:navy">push    si              </span>; zero dword
<span style="color:black">seg000:7D79                 </span><span style="color:navy">push    dx
</span><span style="color:black">seg000:7D7A                 </span><span style="color:navy">push    ax              </span>; disk LBA address (8 bytes)
<span style="color:black">seg000:7D7B                 </span><span style="color:navy">push    es
</span><span style="color:black">seg000:7D7C                 </span><span style="color:navy">push    bx              </span>; transfer buffer address (es:bx)
<span style="color:black">seg000:7D7D                 </span><span style="color:navy">inc     si
</span><span style="color:black">seg000:7D7E                 </span><span style="color:navy">push    si              </span>; 1 ; number of sectors to read
<span style="color:black">seg000:7D7F                 </span><span style="color:navy">mov     si, </span><span style="color:green">10h
</span><span style="color:black">seg000:7D82                 </span><span style="color:navy">push    si              </span>; Packet size (16)
<span style="color:black">seg000:7D83                 </span><span style="color:navy">mov     si, sp          </span>; LBA Packet buffer address
<span style="color:black">seg000:7D85                 </span><span style="color:navy">push    ax
</span><span style="color:black">seg000:7D86                 </span><span style="color:navy">push    dx
</span><span style="color:black">seg000:7D87                 </span><span style="color:navy">mov     ah, </span><span style="color:green">42h         </span>; LBA Read
<span style="color:black">seg000:7D89                 </span><span style="color:navy">call    </span>disk_io
<span style="color:black">seg000:7D8C                 </span><span style="color:navy">pop     dx
</span><span style="color:black">seg000:7D8D                 </span><span style="color:navy">pop     ax
</span><span style="color:black">seg000:7D8E                 </span><span style="color:navy">mov     sp, cx
</span><span style="color:black">seg000:7D90                 </span><span style="color:navy">jnb     short </span><span style="color:gray">disk_read_ok
</span><span style="color:black">seg000:7D92
seg000:7D92 </span><span style="color:gray">chs_read</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">seg000:7D92                 </span><span style="color:navy">mov     cx, [bp+</span><span style="color:#ff8000">2Ch</span><span style="color:navy">]    </span>; BPB_SecPerTrk
<span style="color:black">seg000:7D95                 </span><span style="color:navy">cmp     cx, dx
</span><span style="color:black">seg000:7D97                 </span><span style="color:navy">jb      short </span><span style="color:gray">disk_read_ok </span>; out of CHS read capacity !
<span style="color:black">seg000:7D99                 </span><span style="color:navy">div     cx
</span><span style="color:black">seg000:7D9B                 </span><span style="color:navy">inc     dx
</span><span style="color:black">seg000:7D9C                 </span><span style="color:navy">mov     ch, dl          </span>; sector
<span style="color:black">seg000:7D9E                 </span><span style="color:navy">xor     dx, dx
</span><span style="color:black">seg000:7DA0                 </span><span style="color:navy">div     word ptr [bp+</span><span style="color:#ff8000">2Eh</span><span style="color:navy">] </span>; BPB_NumHeads
<span style="color:black">seg000:7DA3                 </span><span style="color:navy">mov     dh, dl          </span>; head
<span style="color:black">seg000:7DA5                 </span><span style="color:navy">mov     cl, </span><span style="color:green">6
</span><span style="color:black">seg000:7DA7                 </span><span style="color:navy">shl     ah, cl          </span>; cylinder bits 8 and 9
<span style="color:black">seg000:7DA9                 </span><span style="color:navy">or      ah, ch          </span>; AH bits 0 to 5 are sector bits,
<span style="color:black">seg000:7DA9                                         </span>; bits 6 and 7 are cylinder bits 8 and 9
<span style="color:black">seg000:7DAB                 </span><span style="color:navy">xchg    al, ah
</span><span style="color:black">seg000:7DAD                 </span><span style="color:navy">xchg    ax, cx          </span>; CL contains sector (6 bits) number
<span style="color:black">seg000:7DAD                                         </span>; and high two bits of cylinder number
<span style="color:black">seg000:7DAD                                         </span>; CH contains low 8 bits of cylinder number
<span style="color:black">seg000:7DAE                 </span><span style="color:navy">mov     ax, </span><span style="color:green">201h        </span>; Read 1 sector
<span style="color:black">seg000:7DB1
seg000:7DB1 </span>disk_io<span style="color:navy">:                                </span><span style="color:green">; ...
</span><span style="color:black">seg000:7DB1                 </span><span style="color:navy">mov     dl, [bp+</span><span style="color:#ff8000">54h</span><span style="color:navy">]    </span>; BS_DrvNum
<span style="color:black">seg000:7DB4                 </span><span style="color:navy">push    di
</span><span style="color:black">seg000:7DB5                 </span><span style="color:navy">mov     di, </span><span style="color:green">5           </span>; retry count
<span style="color:black">seg000:7DB8
seg000:7DB8 </span><span style="color:gray">try_again</span><span style="color:navy">:                              </span><span style="color:green">; ...
</span><span style="color:black">seg000:7DB8                 </span><span style="color:navy">push    ax
</span><span style="color:black">seg000:7DB9                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; DISK - READ SECTORS INTO MEMORY
<span style="color:black">seg000:7DB9                                         </span>; AL = number of sectors to read, CH = track, CL = sector
<span style="color:black">seg000:7DB9                                         </span>; DH = head, DL = drive, ES:BX -&gt; buffer to fill
<span style="color:black">seg000:7DB9                                         </span>; Return: CF set on error, AH = status, AL = number of sectors read
<span style="color:black">seg000:7DBB                 </span><span style="color:navy">pop     ax
</span><span style="color:black">seg000:7DBC                 </span><span style="color:navy">dec     di
</span><span style="color:black">seg000:7DBD                 </span><span style="color:navy">jz      short </span><span style="color:gray">no_retry
</span><span style="color:black">seg000:7DBF                 </span><span style="color:navy">jb      short </span><span style="color:gray">try_again
</span><span style="color:black">seg000:7DC1
seg000:7DC1 </span><span style="color:gray">no_retry</span><span style="color:navy">:                               </span><span style="color:green">; ...
</span><span style="color:black">seg000:7DC1                 </span><span style="color:navy">pop     di
</span><span style="color:black">seg000:7DC2
seg000:7DC2 </span><span style="color:gray">disk_read_ok</span><span style="color:navy">:                           </span><span style="color:green">; ...
</span><span style="color:black">seg000:7DC2                 </span><span style="color:navy">retn
</span><span style="color:black">seg000:7DC2 </span>disk_read       <span style="color:black">endp
seg000:7DC2
seg000:7DC3
seg000:7DC3 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">seg000:7DC3
seg000:7DC3
seg000:7DC3 </span>calc_dir_sector_offset <span style="color:black">proc near        </span><span style="color:green">; ...
</span><span style="color:black">seg000:7DC3                 </span><span style="color:navy">xor     bx, bx
</span><span style="color:black">seg000:7DC5                 </span><span style="color:navy">sub     ax, </span><span style="color:green">2
</span><span style="color:black">seg000:7DC8                 </span><span style="color:navy">sbb     dx, bx
</span><span style="color:black">seg000:7DCA                 </span><span style="color:navy">mov     bl, [bp+</span><span style="color:#ff8000">21h</span><span style="color:navy">]    </span>; BPB_SecPerClus
<span style="color:black">seg000:7DCD
seg000:7DCD </span>mul32<span style="color:navy">:                                  </span><span style="color:green">; ...
</span><span style="color:black">seg000:7DCD                 </span><span style="color:navy">push    ax
</span><span style="color:black">seg000:7DCE                 </span><span style="color:navy">xchg    ax, dx
</span><span style="color:black">seg000:7DCF                 </span><span style="color:navy">mul     bx
</span><span style="color:black">seg000:7DD1                 </span><span style="color:navy">xchg    ax, bx
</span><span style="color:black">seg000:7DD2                 </span><span style="color:navy">pop     dx
</span><span style="color:black">seg000:7DD3                 </span><span style="color:navy">mul     dx
</span><span style="color:black">seg000:7DD5                 </span><span style="color:navy">add     dx, bx
</span><span style="color:black">seg000:7DD7                 </span><span style="color:navy">retn
</span><span style="color:black">seg000:7DD7 </span>calc_dir_sector_offset <span style="color:black">endp
seg000:7DD7
seg000:7DD7 </span><span style="color:gray">; ---------------------------------------------------------------------------
seg000:7DD8 </span>IbmbioCom       <span style="color:navy">db &#039;IBMBIO  COM&#039;        </span><span style="color:#8080ff">; ...
</span><span style="color:gray">seg000:7DE3 </span>IbmdosCom       <span style="color:navy">db &#039;IBMDOS  COM&#039;
</span><span style="color:gray">seg000:7DEE </span>BootFailure     <span style="color:navy">db </span><span style="color:green">0Dh</span><span style="color:navy">,</span><span style="color:green">0Ah              </span><span style="color:#8080ff">; ...
</span><span style="color:gray">seg000:7DEE                 </span><span style="color:navy">db &#039;Boot failure&#039;,0,0
</span><span style="color:gray">seg000:7DFE                 </span><span style="color:navy">dw </span><span style="color:#008040">0AA55h
</span><span style="color:gray">seg000:7DFE </span>seg000          ends
<span style="color:gray">seg000:7DFE
seg000:7DFE
seg000:7DFE                 </span>end
</span></body></html>
